const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-CZqF7mlb.js","assets/index-Dt56XLIi.css","assets/walletDailyLimitsService-Ddx-WU_I.js","assets/profitService-WOL_cZ8K.js","assets/reportsService-Bp1Io21u.js"])))=>i.map(i=>d[i]);
var Eo=Object.defineProperty;var Bo=(l,h,o)=>h in l?Eo(l,h,{enumerable:!0,configurable:!0,writable:!0,value:o}):l[h]=o;var Xr=(l,h,o)=>Bo(l,typeof h!="symbol"?h+"":h,o);import{c as cs,k as Mo,m as Lo,u as ds,r as a,j as e,a9 as ba,W as Vs,a7 as gs,aY as ir,C as As,d as Gt,a as Il,a8 as gt,a2 as Tl,a1 as kl,_ as us,aQ as ar,R as mt,F as fa,t as $o,S as ns,q as Ds,f as rs,g as at,a5 as Dt,h as Cs,aa as un,a0 as qs,n as Yt,U as zs,aV as Ro,a6 as vl,G as Uo,H as Al,K as _o,aZ as zo,A as Os,Y as or,ap as yl,a_ as Pl,ab as Ne,D as Jo,an as Ko,aU as Vo,v as qo,p as Yo,$ as ga,aq as Ho,ar as Go,aT as Qo,e as en,ao as Za,x as Xa,O as Zo,Q as Xo}from"./index-CZqF7mlb.js";import{C as Ye,a as ht,b as Ct,d as Ze}from"./card-C1qmEv67.js";import{B as c,b as Ol}from"./button-CbCjDAZZ.js";import{I as M}from"./input-aWZtPOBh.js";import{B as ot}from"./badge-DLQQIKAF.js";import{S as js,a as Ns,b as ws,c as Ss,d as qt,C as gn,e as Wl}from"./select-lqNE7HoC.js";import{D as ce,a as de,b as me,c as he,f as Fl,T as ec,O as tc,W as sc,C as ac,g as rc,h as nc,i as El,R as lc,P as ic,d as Ut,e as Ce}from"./dialog-DQOxWuZJ.js";import{L as V}from"./label-Crmi2fLJ.js";import{M as Ts,a as ls}from"./MasterPinDialog-BzlVDA03.js";import{walletDailyLimitsService as is}from"./walletDailyLimitsService-Ddx-WU_I.js";import{T as At,P as rr}from"./progress-BcoCTx0F.js";import{W as Ht}from"./wallet-BGeGLwOF.js";import{S as Bl}from"./star-B7nw1UHy.js";import{S as Ml}from"./square-pen-BqkzMdPd.js";import{P as os}from"./phone-ydA2MCoW.js";import{A as Ll}from"./arrow-left-DEJAe-ZO.js";import{a as cn,S as oc}from"./index.esm-CCm8abId.js";import{C as ps}from"./calendar-D9CEEhwp.js";import{C as dn}from"./chart-column-CFOETBG5.js";import{D as Xe}from"./dollar-sign-B33e1PGt.js";import{A as tn,B as bl}from"./bell-1LF753Ey.js";import{C as Ws}from"./circle-alert-DJ5SnL7V.js";import{C as pn}from"./circle-x-CmBHCxJL.js";import{C as ks}from"./circle-check-big-nMwoXPKp.js";import{a as tt,E as Pt}from"./eye-CQszSYXz.js";import{S as cc}from"./store-i3-qS-tY.js";import{A as dc}from"./arrow-right-DLnDrXUK.js";import{U as mn}from"./user-Bq1FChrk.js";import{P as mc,C as $l,D as hc,a as xc,R as uc,b as gc,M as pc}from"./MaintenanceDialog-CmZHFGZu.js";import{L as Ps}from"./lock-B9Pgb7nW.js";import{P as sn}from"./PasswordConfirmDialog-CWWxNqsk.js";import{M as Is}from"./minus-BLkoUvmu.js";import{w as fc,W as vc}from"./WalletsManagement-f_HPaos1.js";import{reportsService as Vt}from"./reportsService-Bp1Io21u.js";import{P as yc}from"./ProfileIcon-DilseZCU.js";import{a as bc,E as jc}from"./broadcastService-Ct8n3XQM.js";import{D as Nc,a as wc,b as Sc,c as Dc,d as Cc}from"./dropdown-menu-CUQQ98_a.js";import{S as an}from"./shield-V_IchM_P.js";import{G as Ic}from"./gift-DLRSPzrI.js";import{ProfitService as Ys}from"./profitService-WOL_cZ8K.js";import{R as Tc}from"./refresh-cw-Cmyd89eX.js";import"./index-rcTMWhas.js";import"./Combination-C3XbmBEy.js";import"./index-CIFcZwzE.js";import"./whatsappService-C-X9ADHr.js";import"./avatars-BkAvai_b.js";import"./key-round-BV_Z4NHS.js";import"./index-BQJ_yug6.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const nr=cs("ArrowDownLeft",[["path",{d:"M17 7 7 17",key:"15tmo1"}],["path",{d:"M17 17H7V7",key:"1org7z"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Rl=cs("ArrowRightLeft",[["path",{d:"m16 3 4 4-4 4",key:"1x1c3m"}],["path",{d:"M20 7H4",key:"zbl0bi"}],["path",{d:"m8 21-4-4 4-4",key:"h9nckh"}],["path",{d:"M4 17h16",key:"g4d7ey"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const kc=cs("Banknote",[["rect",{width:"20",height:"12",x:"2",y:"6",rx:"2",key:"9lu3g6"}],["circle",{cx:"12",cy:"12",r:"2",key:"1c9p78"}],["path",{d:"M6 12h.01M18 12h.01",key:"113zkx"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ac=cs("BookOpen",[["path",{d:"M12 7v14",key:"1akyts"}],["path",{d:"M3 18a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h5a4 4 0 0 1 4 4 4 4 0 0 1 4-4h5a1 1 0 0 1 1 1v13a1 1 0 0 1-1 1h-6a3 3 0 0 0-3 3 3 3 0 0 0-3-3z",key:"ruj8y"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ul=cs("Building",[["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",ry:"2",key:"76otgf"}],["path",{d:"M9 22v-4h6v4",key:"r93iot"}],["path",{d:"M8 6h.01",key:"1dz90k"}],["path",{d:"M16 6h.01",key:"1x0f13"}],["path",{d:"M12 6h.01",key:"1vi96p"}],["path",{d:"M12 10h.01",key:"1nrarc"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M16 10h.01",key:"1m94wz"}],["path",{d:"M16 14h.01",key:"1gbofw"}],["path",{d:"M8 10h.01",key:"19clt8"}],["path",{d:"M8 14h.01",key:"6423bh"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const lr=cs("IdCard",[["path",{d:"M16 10h2",key:"8sgtl7"}],["path",{d:"M16 14h2",key:"epxaof"}],["path",{d:"M6.17 15a3 3 0 0 1 5.66 0",key:"n6f512"}],["circle",{cx:"9",cy:"11",r:"2",key:"yxgjnd"}],["rect",{x:"2",y:"5",width:"20",height:"14",rx:"2",key:"qneu4z"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const hn=cs("Info",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const er=cs("Package",[["path",{d:"M11 21.73a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73z",key:"1a0edw"}],["path",{d:"M12 22V12",key:"d0xqtd"}],["path",{d:"m3.3 7 7.703 4.734a2 2 0 0 0 1.994 0L20.7 7",key:"yx3hmr"}],["path",{d:"m7.5 4.27 9 5.15",key:"1c824w"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const va=cs("TrendingDown",[["polyline",{points:"22 17 13.5 8.5 8.5 13.5 2 7",key:"1r2t7k"}],["polyline",{points:"16 17 22 17 22 11",key:"11uiuu"}]]),Pc=async(l={})=>{try{return(await Mo(Lo,"getLastTransactions")(l)).data}catch(h){throw console.error("Error getting last transactions:",h),h.code==="functions/unauthenticated"?new Error("يجب تسجيل الدخول للوصول إلى المعاملات"):h.code==="functions/invalid-argument"?new Error("بيانات الاستعلام غير صالحة: "+h.message):h.code==="functions/permission-denied"?new Error("ليس لديك صلاحية للوصول إلى هذه المعاملات: "+h.message):new Error("حدث خطأ أثناء جلب المعاملات: "+(h.message||"خطأ غير معروف"))}},Oc=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],Wc=({isOpen:l,onClose:h,onWalletSelect:o,onEditWallet:t,onDeleteWallet:u})=>{const{user:g}=ds(),[b,L]=a.useState([]),[y,m]=a.useState(!1),p=()=>`wallets_${(g==null?void 0:g.uid)||"default"}`,k=()=>{try{const w=p(),S=localStorage.getItem(w);if(S){const ne=JSON.parse(S);if(Array.isArray(ne)&&ne.length>0)return ne}const _="wallets_default",$=localStorage.getItem(_);if($){const ne=JSON.parse($);if(Array.isArray(ne)&&ne.length>0){localStorage.setItem(w,$);try{localStorage.removeItem(_)}catch{}return ne}}const P=Object.keys(localStorage).filter(ne=>ne.startsWith("wallets_")&&ne!==w);let q=null,re=null;for(const ne of P)try{const ue=localStorage.getItem(ne);if(!ue)continue;const Q=JSON.parse(ue);Array.isArray(Q)&&Q.length>0&&(!q||Q.length>((q==null?void 0:q.length)||0))&&(q=Q,re=ne)}catch{}if(q&&re){localStorage.setItem(w,JSON.stringify(q));try{localStorage.removeItem(re)}catch{}return q}}catch(w){console.warn("WalletsViewPage migration failed:",w)}return null},A=async(w,S)=>{const _=new Date().getMonth(),$=new Date().getFullYear(),P=S.filter(Q=>{const ee=new Date(Q.createdAt);return ee.getMonth()===_&&ee.getFullYear()===$&&Q.lineId===w}),q=Q=>{const ee=Q.type;return Q.txnType==="receive"||ee==="withdraw"||ee==="withdrawal"||ee==="receive"},re=Q=>{const ee=Q.type;return Q.txnType==="send"||ee==="send"||ee==="transfer"},ne=P.filter(q).reduce((Q,ee)=>{const Te=ee.withdrawnAmount!==void 0?ee.withdrawnAmount:ee.amount;return Q+(Te||0)},0),ue=P.filter(re).reduce((Q,ee)=>{const Te=ee.sentAmount!==void 0?ee.sentAmount:ee.amount;return Q+(Te||0)},0);return{withdrawalUsage:ne,transferUsage:ue}},B=w=>{const S=new Date().toISOString().split("T")[0],_=w.lastResetDate;if(!_)return{...w,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:S};const $=new Date(_),P=new Date;return $.getMonth()!==P.getMonth()||$.getFullYear()!==P.getFullYear()?{...w,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:S}:w};a.useEffect(()=>{if(!(g!=null&&g.uid)||!l)return;(async()=>{m(!0);try{const S=await gs.getByMerchantId(g.uid),_=await ir.getByUserId(g.uid),P=(await Promise.all(S.map(async q=>{const{withdrawalUsage:re,transferUsage:ne}=await A(q.id,_);return{id:q.id,name:q.label||"محفظة بدون اسم",phone:q.msisdn,nationalId:q.nationalId||"",isDefault:!1,monthlyWithdrawalLimit:q.withdrawLimit||2e5,monthlyTransferLimit:q.transferLimit||2e5,monthlyWithdrawalUsage:re,monthlyTransferUsage:ne,lastResetDate:new Date().toISOString().split("T")[0],walletProvider:q.walletProvider||""}}))).map(B);if(L(P),!P||P.length===0){const q=k();q&&q.length>0&&L(q.map(B))}}catch(S){console.error("Error loading wallets:",S);const _=k();_&&L(_.map($=>({...$,phone:$.phone||$.phoneNumber,monthlyWithdrawalLimit:$.monthlyWithdrawalLimit||2e5,monthlyTransferLimit:$.monthlyTransferLimit||2e5})))}finally{m(!1)}})()},[g==null?void 0:g.uid,l]);const z=w=>Oc.find(S=>S.id===w),X=(w,S)=>S>0?Math.min(w/S*100,100):0,F=w=>new Intl.NumberFormat("ar-EG").format(w);return e.jsx(ce,{open:l,onOpenChange:h,children:e.jsxs(de,{className:"max-w-6xl max-h-[90vh] overflow-y-auto",children:[e.jsx(me,{className:"pb-4",children:e.jsxs(he,{className:"flex items-center gap-2 text-lg",children:[e.jsx(Ht,{className:"h-5 w-5"}),"الاطلاع على جميع المحافظ",e.jsxs(ot,{variant:"secondary",className:"mr-2",children:[b.length," محفظة"]})]})}),y?e.jsx("div",{className:"flex justify-center items-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-600",children:"جاري تحميل المحافظ..."})]})}):b.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Ht,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"لا توجد محافظ مضافة حتى الآن"})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:b.map(w=>{const S=z(w.walletProvider||""),_=X(w.monthlyWithdrawalUsage||0,w.monthlyWithdrawalLimit),$=X(w.monthlyTransferUsage||0,w.monthlyTransferLimit);return e.jsxs(Ye,{className:"cursor-pointer hover:shadow-lg transition-shadow border-2 hover:border-blue-300",onClick:()=>o(w),children:[e.jsx(ht,{className:"pb-3",children:e.jsxs(Ct,{className:"flex items-center justify-between text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ba,{className:"h-4 w-4"}),e.jsx("span",{children:w.name})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[w.isDefault&&e.jsxs(ot,{variant:"default",className:"text-xs",children:[e.jsx(Bl,{className:"h-3 w-3 mr-1"}),"افتراضية"]}),e.jsx(c,{variant:"ghost",size:"sm",onClick:P=>{P.stopPropagation(),t==null||t(w)},className:"h-7 px-2",children:e.jsx(Ml,{className:"h-4 w-4"})}),e.jsx(c,{variant:"ghost",size:"sm",onClick:P=>{P.stopPropagation(),u==null||u(w.id)},className:"h-7 px-2 text-destructive hover:text-destructive",children:e.jsx(At,{className:"h-4 w-4"})})]})]})}),e.jsxs(Ze,{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(os,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"font-mono",children:w.phone})]}),w.nationalId&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(lr,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"font-mono",children:w.nationalId})]}),S&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Ul,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{children:S.name})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(va,{className:"h-3 w-3 text-red-500"}),"السحب الشهري"]}),e.jsxs("span",{className:"font-mono",children:[F(w.monthlyWithdrawalUsage||0)," / ",F(w.monthlyWithdrawalLimit)]})]}),e.jsx(rr,{value:_,className:"h-2"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Vs,{className:"h-3 w-3 text-green-500"}),"التحويل الشهري"]}),e.jsxs("span",{className:"font-mono",children:[F(w.monthlyTransferUsage||0)," / ",F(w.monthlyTransferLimit)]})]}),e.jsx(rr,{value:$,className:"h-2"})]}),e.jsx(c,{variant:"outline",size:"sm",className:"w-full text-xs",onClick:P=>{P.stopPropagation(),o(w)},children:"عرض التفاصيل الكاملة"})]})]},w.id)})}),e.jsx("div",{className:"flex justify-end pt-4 border-t",children:e.jsxs(c,{onClick:h,variant:"outline",children:[e.jsx(Ll,{className:"h-4 w-4 mr-2"}),"إغلاق"]})})]})})},Fc=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],Ec=({wallet:l,isOpen:h,onClose:o,onBack:t})=>{const{user:u}=ds(),[g,b]=a.useState([]),[L,y]=a.useState(!1),[m,p]=a.useState("month");if(a.useEffect(()=>{if(!l||!(u!=null&&u.uid)||!h)return;(async()=>{y(!0);try{const Oe=(await ir.getByUserId(u.uid)).filter(rt=>rt.walletId===l.id).sort((rt,nt)=>new Date(nt.createdAt).getTime()-new Date(rt.createdAt).getTime());b(Oe)}catch(ae){console.error("Error loading transactions:",ae)}finally{y(!1)}})()},[l,u==null?void 0:u.uid,h]),!l)return null;const k=K=>Fc.find(ae=>ae.id===K),A=(K,ae)=>ae>0?Math.min(K/ae*100,100):0,B=K=>new Intl.NumberFormat("ar-EG").format(K),z=K=>new Date(K).toLocaleDateString("ar-EG",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}),F=(()=>{const K=new Date;let ae;switch(m){case"week":ae=new Date(K.getTime()-7*24*60*60*1e3);break;case"month":ae=new Date(K.getFullYear(),K.getMonth(),1);break;default:return g}return g.filter(Oe=>new Date(Oe.createdAt)>=ae)})(),w=K=>{const ae=K.type,Oe=K.txnType;return ae==="withdraw"||ae==="withdrawal"||ae==="receive"||Oe==="receive"},S=K=>{const ae=K.type,Oe=K.txnType;return ae==="send"||ae==="transfer"||Oe==="send"},_=F.filter(K=>w(K)&&K.status==="completed").reduce((K,ae)=>{const Oe=ae.withdrawnAmount!==void 0?ae.withdrawnAmount:ae.amount;return K+(Oe||0)},0),$=F.filter(K=>S(K)&&K.status==="completed").reduce((K,ae)=>{const Oe=ae.sentAmount!==void 0?ae.sentAmount:ae.amount;return K+(Oe||0)},0),P=F.filter(K=>K.type==="deposit"&&K.status==="completed").reduce((K,ae)=>K+ae.amount,0),q=k(l.walletProvider||""),re=A(l.monthlyWithdrawalUsage||0,l.monthlyWithdrawalLimit),ne=A(l.monthlyTransferUsage||0,l.monthlyTransferLimit),ue=K=>{switch(K){case"withdrawal":return e.jsx(va,{className:"h-4 w-4 text-red-500"});case"transfer":return e.jsx(Vs,{className:"h-4 w-4 text-blue-500"});case"deposit":return e.jsx(Xe,{className:"h-4 w-4 text-green-500"});default:return e.jsx(tn,{className:"h-4 w-4 text-gray-500"})}},Q=K=>{switch(K){case"completed":return e.jsx(ks,{className:"h-4 w-4 text-green-500"});case"pending":return e.jsx(As,{className:"h-4 w-4 text-yellow-500"});case"failed":return e.jsx(pn,{className:"h-4 w-4 text-red-500"});default:return e.jsx(Ws,{className:"h-4 w-4 text-gray-500"})}},ee=K=>{switch(K){case"withdrawal":return"سحب";case"transfer":return"تحويل";case"deposit":return"إيداع";default:return"معاملة"}},Te=K=>{switch(K){case"completed":return"مكتملة";case"pending":return"قيد الانتظار";case"failed":return"فاشلة";default:return"غير محدد"}};return e.jsx(ce,{open:h,onOpenChange:o,children:e.jsxs(de,{className:"max-w-6xl max-h-[90vh] overflow-y-auto",children:[e.jsx(me,{className:"pb-4",children:e.jsxs(he,{className:"flex items-center gap-2 text-lg",children:[e.jsx(ba,{className:"h-5 w-5"}),"تفاصيل المحفظة: ",l.name,l.isDefault&&e.jsxs(ot,{variant:"default",className:"mr-2",children:[e.jsx(Bl,{className:"h-3 w-3 mr-1"}),"افتراضية"]})]})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-1 space-y-4",children:[e.jsxs(Ye,{children:[e.jsx(ht,{children:e.jsxs(Ct,{className:"text-sm flex items-center gap-2",children:[e.jsx(lr,{className:"h-4 w-4"}),"المعلومات الأساسية"]})}),e.jsxs(Ze,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(os,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-mono",children:l.phone})]}),l.nationalId&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(lr,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-mono",children:l.nationalId})]}),q&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Ul,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{children:q.name})]}),e.jsxs("div",{className:"text-xs text-gray-600 pr-6",children:[e.jsxs("div",{children:["المالك: ",q.ownerName]}),e.jsxs("div",{className:"font-mono",children:["الرقم القومي: ",q.nationalId]})]})]}),l.lastResetDate&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(ps,{className:"h-4 w-4 text-gray-500"}),e.jsxs("span",{children:["آخر إعادة تعيين: ",new Date(l.lastResetDate).toLocaleDateString("ar-EG")]})]})]})]}),e.jsxs(Ye,{children:[e.jsx(ht,{children:e.jsxs(Ct,{className:"text-sm flex items-center gap-2",children:[e.jsx(dn,{className:"h-4 w-4"}),"حدود الاستخدام الشهري"]})}),e.jsxs(Ze,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(va,{className:"h-3 w-3 text-red-500"}),"السحب الشهري"]}),e.jsxs("span",{className:"font-mono",children:[B(l.monthlyWithdrawalUsage||0)," / ",B(l.monthlyWithdrawalLimit)]})]}),e.jsx(rr,{value:re,className:"h-2"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["متبقي: ",B(l.monthlyWithdrawalLimit-(l.monthlyWithdrawalUsage||0))," جنيه"]})]}),e.jsx(cn,{}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Vs,{className:"h-3 w-3 text-green-500"}),"التحويل الشهري"]}),e.jsxs("span",{className:"font-mono",children:[B(l.monthlyTransferUsage||0)," / ",B(l.monthlyTransferLimit)]})]}),e.jsx(rr,{value:ne,className:"h-2"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["متبقي: ",B(l.monthlyTransferLimit-(l.monthlyTransferUsage||0))," جنيه"]})]})]})]})]}),e.jsxs("div",{className:"lg:col-span-2 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsx(Ye,{children:e.jsxs(Ze,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(va,{className:"h-5 w-5 text-red-500"})}),e.jsx("div",{className:"text-lg font-bold",children:B(_)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي السحب"})]})}),e.jsx(Ye,{children:e.jsxs(Ze,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(Vs,{className:"h-5 w-5 text-blue-500"})}),e.jsx("div",{className:"text-lg font-bold",children:B($)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي التحويل"})]})}),e.jsx(Ye,{children:e.jsxs(Ze,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(Xe,{className:"h-5 w-5 text-green-500"})}),e.jsx("div",{className:"text-lg font-bold",children:B(P)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي الإيداع"})]})})]}),e.jsxs(Ye,{children:[e.jsx(ht,{children:e.jsxs(Ct,{className:"text-sm flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(tn,{className:"h-4 w-4"}),"سجل المعاملات"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(c,{size:"sm",variant:m==="week"?"default":"outline",onClick:()=>p("week"),className:"text-xs",children:"أسبوع"}),e.jsx(c,{size:"sm",variant:m==="month"?"default":"outline",onClick:()=>p("month"),className:"text-xs",children:"شهر"}),e.jsx(c,{size:"sm",variant:m==="all"?"default":"outline",onClick:()=>p("all"),className:"text-xs",children:"الكل"})]})]})}),e.jsx(Ze,{children:L?e.jsx("div",{className:"flex justify-center items-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-600",children:"جاري تحميل المعاملات..."})]})}):F.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(tn,{className:"h-8 w-8 text-gray-400 mx-auto mb-2"}),e.jsx("p",{className:"text-gray-600",children:"لا توجد معاملات في هذه الفترة"})]}):e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:F.map(K=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[ue(K.type),e.jsxs("div",{children:[e.jsxs("div",{className:"text-sm font-medium",children:[ee(K.type)," - ",B(K.amount)," جنيه"]}),e.jsx("div",{className:"text-xs text-gray-600",children:z(K.createdAt)}),K.description&&e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:K.description})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[Q(K.status),e.jsx("span",{className:"text-xs",children:Te(K.status)})]})]},K.id))})})]})]})]}),e.jsxs("div",{className:"flex justify-between pt-4 border-t",children:[e.jsxs(c,{onClick:t,variant:"outline",children:[e.jsx(Ll,{className:"h-4 w-4 mr-2"}),"العودة للمحافظ"]}),e.jsx(c,{onClick:o,variant:"outline",children:"إغلاق"})]})]})})},rn=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],Bc=({isOpen:l,onClose:h,onWalletUpdate:o,initialEditingWallet:t})=>{const{toast:u}=Gt(),{user:g}=ds(),b=Il(),[L,y]=a.useState([]),[m,p]=a.useState(!1),[k,A]=a.useState(null),[B,z]=a.useState(""),[X,F]=a.useState(""),[w,S]=a.useState(""),[_,$]=a.useState(""),[P,q]=a.useState("200000"),[re,ne]=a.useState("200000"),[ue,Q]=a.useState("100000"),[ee,Te]=a.useState("60000"),[K,ae]=a.useState(!1),[Oe,rt]=a.useState(null),[nt,Se]=a.useState(!1),[ct,$e]=a.useState(!1),[It,Ot]=a.useState(!1),[x,R]=a.useState(null),H=()=>`wallets_${(g==null?void 0:g.uid)||"default"}`;a.useEffect(()=>{t&&(A(t),p(!0),z(t.name||""),F(t.phone||""),S(t.nationalId||""),$(t.walletProvider||""),q((t.monthlyWithdrawalLimit||2e5).toString()),ne((t.monthlyTransferLimit||2e5).toString()),Q((t.dailyWithdrawalLimit||1e5).toString()),Te((t.dailyTransferLimit||6e4).toString()),ae(!!t.isDefault))},[t]);const ve=I=>{const te=new Date,le=te.getMonth(),Ie=te.getFullYear();if(!I.lastResetDate)return{...I,monthlyWithdrawalUsage:I.monthlyWithdrawalUsage||0,monthlyTransferUsage:I.monthlyTransferUsage||0,lastResetDate:te.toISOString().split("T")[0]};const We=new Date(I.lastResetDate),ze=We.getMonth(),O=We.getFullYear();return le!==ze||Ie!==O?{...I,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:te.toISOString().split("T")[0]}:I},oe=async(I,te)=>{const le=new Date().getMonth(),Ie=new Date().getFullYear(),We=te.filter(se=>{const J=new Date(se.createdAt);return J.getMonth()===le&&J.getFullYear()===Ie&&se.lineId===I}),ze=We.filter(se=>se.txnType==="receive").reduce((se,J)=>se+(J.amount||0),0),O=We.filter(se=>se.txnType==="send").reduce((se,J)=>se+(J.amount||0),0);return{withdrawalUsage:ze,transferUsage:O}},ke=async(I,te)=>{const le=new Date,Ie=le.getDate(),We=le.getMonth(),ze=le.getFullYear(),O=te.filter(De=>{const we=new Date(De.createdAt);return we.getDate()===Ie&&we.getMonth()===We&&we.getFullYear()===ze&&De.lineId===I}),se=O.filter(De=>De.txnType==="receive").reduce((De,we)=>De+(we.amount||0),0),J=O.filter(De=>De.txnType==="send").reduce((De,we)=>De+(we.amount||0),0);return{withdrawalUsage:se,transferUsage:J}};a.useEffect(()=>{(async()=>{if(!(g!=null&&g.uid)){console.log("No user authenticated, skipping wallet loading"),Se(!1);return}console.log("Loading wallets for user:",g.uid),Se(!0);try{const{auth:te}=await us(async()=>{const{auth:J}=await import("./index-CZqF7mlb.js").then(De=>De.b0);return{auth:J}},__vite__mapDeps([0,1]));let le=0;const Ie=5;for(;!te.currentUser&&le<Ie;)console.log(`Waiting for auth state... attempt ${le+1}`),await new Promise(J=>setTimeout(J,1e3)),le++;if(!te.currentUser)throw console.error("User not authenticated in Firebase Auth after retries"),new Error("not authenticated");console.log("Firebase Auth User:",te.currentUser.uid),console.log("Context User:",g.uid),console.log("Fetching wallets from Firebase...");const We=await gs.getByMerchantId(g.uid);console.log("Fetched wallets:",We),console.log("Fetching transactions from Firebase...");const ze=await ir.getByUserId(g.uid);console.log("Fetched transactions:",ze);const se=(await Promise.all(We.map(async J=>{const{withdrawalUsage:De,transferUsage:we}=await oe(J.id,ze),{withdrawalUsage:jt,transferUsage:Be}=await ke(J.id,ze);return{id:J.id,name:J.label||"محفظة بدون اسم",phone:J.msisdn,isDefault:!1,monthlyWithdrawalLimit:J.withdrawLimit||2e5,monthlyTransferLimit:J.transferLimit||2e5,dailyWithdrawalLimit:J.dailyWithdrawLimit||1e5,dailyTransferLimit:J.dailyTransferLimit||6e4,monthlyWithdrawalUsage:De,monthlyTransferUsage:we,dailyWithdrawalUsage:jt,dailyTransferUsage:Be,lastResetDate:new Date().toISOString().split("T")[0],defaultTransferCommission:J.defaultTransferCommission!=null?Number(J.defaultTransferCommission):null,defaultWithdrawCommission:J.defaultWithdrawCommission!=null?Number(J.defaultWithdrawCommission):null}}))).map(ve);y(se),console.log("Wallets loaded successfully:",se)}catch(te){console.error("Error loading wallets:",te),console.log("تم تحميل المحافظ من البيانات المحفوظة محلياً");const le=localStorage.getItem(H());if(le){const Ie=JSON.parse(le);y(Ie.map(We=>({...We,phone:We.phone||We.phoneNumber,monthlyWithdrawalLimit:We.monthlyWithdrawalLimit||2e5,monthlyTransferLimit:We.monthlyTransferLimit||2e5})))}}finally{Se(!1)}})()},[g==null?void 0:g.uid]);const Pe=()=>{z(""),F(""),S(""),$(""),q("200000"),ne("200000"),Q("100000"),Te("60000"),ae(!1),A(null),p(!1)},Ee=async()=>{if(!B.trim()||!X.trim()||!_.trim()){u({title:"خطأ",description:"يرجى ملء جميع الحقول المطلوبة",variant:"destructive"});return}if(!(g!=null&&g.uid)){u({title:"خطأ",description:"يجب تسجيل الدخول أولاً",variant:"destructive"});return}Se(!0);try{if(k){await gs.update(k.id,{label:B.trim(),msisdn:X.trim(),withdrawLimit:parseInt(P),transferLimit:parseInt(re),dailyWithdrawLimit:parseInt(ue),dailyTransferLimit:parseInt(ee)}),await is.setLimits(k.id,{dailyTransferLimit:parseInt(ee||"0"),dailyWithdrawLimit:parseInt(ue||"0"),monthlyTransferLimit:parseInt(re||"0"),monthlyWithdrawLimit:parseInt(P||"0")});const I=L.map(te=>te.id===k.id?{...te,name:B.trim(),phone:X.trim(),nationalId:w.trim(),walletProvider:_,monthlyWithdrawalLimit:parseInt(P),monthlyTransferLimit:parseInt(re),dailyWithdrawalLimit:parseInt(ue),dailyTransferLimit:parseInt(ee)}:te);y(I),localStorage.setItem(H(),JSON.stringify(I)),u({title:"تم التحديث",description:"تم تحديث المحفظة بنجاح"})}else{const I={merchantUserId:g.uid,provider:_,msisdn:X.trim(),label:B.trim(),isActive:!0,dailyLimit:2e5,monthlyLimit:2e5,withdrawLimit:parseInt(P),transferLimit:parseInt(re),dailyTransferLimit:parseInt(ee),dailyWithdrawLimit:parseInt(ue),dailyUsage:0,monthlyUsage:0,transferUsage:0,withdrawUsage:0},te=await gs.create(I);await is.setLimits(te,{dailyTransferLimit:parseInt(ee||"0"),dailyWithdrawLimit:parseInt(ue||"0"),monthlyTransferLimit:parseInt(re||"0"),monthlyWithdrawLimit:parseInt(P||"0")});const le=new Date().toISOString().split("T")[0],Ie={id:te,name:B.trim(),phone:X.trim(),nationalId:w.trim(),walletProvider:_,isDefault:K,monthlyWithdrawalLimit:parseInt(P),monthlyTransferLimit:parseInt(re),dailyWithdrawalLimit:parseInt(ue),dailyTransferLimit:parseInt(ee),monthlyWithdrawalUsage:0,monthlyTransferUsage:0,dailyWithdrawalUsage:0,dailyTransferUsage:0,lastResetDate:le,defaultTransferCommission:null,defaultWithdrawCommission:null},We=[...L,Ie];y(We),localStorage.setItem(H(),JSON.stringify(We)),u({title:"تم الإنشاء",description:"تم إنشاء المحفظة بنجاح"})}o&&o(),Pe(),p(!1),A(null)}catch(I){console.error("Error saving wallet:",I),u({title:"خطأ",description:"حدث خطأ أثناء حفظ المحفظة",variant:"destructive"})}finally{Se(!1)}},Tt=I=>{A(I),z(I.name),F(I.phone),S(I.nationalId||""),$(I.walletProvider||""),q(I.monthlyWithdrawalLimit.toString()),ne(I.monthlyTransferLimit.toString()),ae(I.isDefault),p(!0)},Wt=async I=>{const te=L.find(le=>le.id===I);if(te!=null&&te.isDefault){u({title:"تحذير",description:"لا يمكن حذف المحفظة الافتراضية",variant:"destructive"});return}if(!(g!=null&&g.uid)){u({title:"خطأ",description:"يجب تسجيل الدخول أولاً",variant:"destructive"});return}Se(!0);try{await gs.delete(I);const le=L.filter(Ie=>Ie.id!==I);y(le),localStorage.setItem(H(),JSON.stringify(le)),o&&o(),u({title:"تم الحذف",description:"تم حذف المحفظة بنجاح"})}catch(le){console.error("Error deleting wallet:",le),u({title:"خطأ",description:"حدث خطأ أثناء حذف المحفظة",variant:"destructive"})}finally{Se(!1)}},He=I=>{const te=L.map(le=>({...le,isDefault:le.id===I}));y(te),localStorage.setItem(H(),JSON.stringify(te)),o&&o(),u({title:"تم تحديث المحفظة الافتراضية",description:"تم تعيين المحفظة كافتراضية بنجاح"})};return e.jsxs(ce,{open:l,onOpenChange:h,children:[e.jsxs(de,{className:"max-w-4xl max-h-[80vh] overflow-y-auto",children:[e.jsx(me,{className:"pb-2",children:e.jsxs(he,{className:"flex items-center gap-1 text-sm",children:[e.jsx(Ht,{className:"h-3 w-3"}),"إدارة المحافظ"]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h3",{className:"text-sm font-semibold",children:["المحافظ المتاحة (",L.length,")"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(c,{onClick:()=>Ot(!0),className:"flex items-center gap-1 h-6 px-2 text-xs",size:"sm",variant:"outline",children:[e.jsx(tt,{className:"h-3 w-3"}),"الاطلاع على المحافظ"]}),e.jsxs(c,{onClick:()=>{h(),b("/user/add-wallet")},className:"flex items-center gap-1 h-6 px-2 text-xs",size:"sm",children:[e.jsx(gt,{className:"h-3 w-3"}),"إضافة محفظة جديدة"]})]})]}),(m||k)&&e.jsxs(Ye,{className:"border-2 border-blue-200 bg-blue-50",children:[e.jsx(ht,{className:"pb-1",children:e.jsx(Ct,{className:"text-sm",children:k?"تعديل المحفظة":"إضافة محفظة جديدة"})}),e.jsxs(Ze,{className:"space-y-2 pt-1",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"شركة المحفظة"}),e.jsx("div",{className:"flex gap-1 items-center",children:e.jsxs(js,{value:_,onValueChange:$,children:[e.jsx(Ns,{className:"h-6 text-xs flex-1",children:e.jsx(ws,{placeholder:"اختر شركة المحفظة"})}),e.jsx(Ss,{children:rn.map(I=>e.jsx(qt,{value:I.id,className:"text-xs",children:e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsx("span",{children:I.name}),e.jsx("button",{type:"button",className:"h-4 w-4 p-0 ml-2 flex items-center justify-center hover:bg-blue-100 rounded",onClick:te=>{te.preventDefault(),te.stopPropagation(),rt(I.id)},children:e.jsx(hn,{className:"h-3 w-3 text-blue-500 hover:text-blue-700"})})]})},I.id))})]})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"اسم المحفظة"}),e.jsx(M,{value:B,onChange:I=>z(I.target.value),placeholder:"مثال: محفظة العمل",className:"h-6 text-xs"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"رقم الهاتف"}),e.jsxs("div",{className:"relative",children:[e.jsx(os,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(M,{value:X,onChange:I=>F(I.target.value),placeholder:"01030302038",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الرقم القومي للخط"}),e.jsxs("div",{className:"relative",children:[e.jsx(lr,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(M,{value:w,onChange:I=>S(I.target.value),placeholder:"29012345678901",maxLength:14,className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد الشهري للسحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Xe,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(M,{type:"number",value:P,onChange:I=>q(I.target.value),placeholder:"200000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد الشهري للتحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Xe,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(M,{type:"number",value:re,onChange:I=>ne(I.target.value),placeholder:"200000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد اليومي للسحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(va,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-red-400"}),e.jsx(M,{type:"number",value:ue,onChange:I=>Q(I.target.value),placeholder:"100000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد اليومي للتحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Vs,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-blue-400"}),e.jsx(M,{type:"number",value:ee,onChange:I=>Te(I.target.value),placeholder:"60000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",id:"isDefault",checked:K,onChange:I=>ae(I.target.checked),className:"rounded w-3 h-3"}),e.jsx("label",{htmlFor:"isDefault",className:"text-xs font-medium text-gray-700",children:"تعيين كمحفظة افتراضية"})]}),e.jsx("div",{className:"border-t pt-2 mt-2",children:e.jsxs("div",{className:"flex items-center gap-1 mb-2",children:[e.jsx(Tl,{className:"h-3 w-3 text-gray-600"}),e.jsx("label",{className:"text-xs font-medium text-gray-700",children:"إعدادات العمولة"})]})}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(c,{onClick:Ee,className:"flex-1 h-6 text-xs",size:"sm",children:k?"تحديث المحفظة":"إضافة المحفظة"}),e.jsx(c,{variant:"outline",onClick:Pe,className:"h-6 text-xs",size:"sm",children:"إلغاء"})]})]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2",children:L.map(I=>{var te;return e.jsxs(Ye,{className:`${I.isDefault?"border-green-300 bg-green-50":""}`,children:[e.jsx(ht,{className:"pb-1",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Ct,{className:"text-sm flex items-center gap-1",children:[e.jsx(Ht,{className:"h-3 w-3"}),I.name]}),I.isDefault&&e.jsx(ot,{variant:"default",className:"bg-green-600 text-xs px-1 py-0",children:"افتراضية"})]})}),e.jsxs(Ze,{className:"space-y-1 pt-0",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(os,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"text-xs",children:I.phone})]}),I.walletProvider&&e.jsx("div",{className:"text-xs text-blue-600 mt-1",children:((te=rn.find(le=>le.id===I.walletProvider))==null?void 0:te.name)||I.walletProvider}),e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-2 rounded-md border border-gray-200 shadow-sm space-y-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-gray-600 mb-1",children:"الحدود الشهرية"}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-red-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-red-400 to-red-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((I.monthlyWithdrawalUsage||0)/I.monthlyWithdrawalLimit*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-blue-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-400 to-blue-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((I.monthlyTransferUsage||0)/I.monthlyTransferLimit*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-xs text-red-600 font-medium",children:["متبقي سحب: ",Math.max(I.monthlyWithdrawalLimit-(I.monthlyWithdrawalUsage||0),0)," جنيه"]}),e.jsxs("div",{className:"text-xs text-blue-600 font-medium",children:["متبقي تحويل: ",Math.max(I.monthlyTransferLimit-(I.monthlyTransferUsage||0),0)," جنيه"]})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-gray-600 mb-1",children:"الحدود اليومية"}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-orange-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-orange-400 to-orange-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((I.dailyWithdrawalUsage||0)/I.dailyWithdrawalLimit*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-green-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-green-400 to-green-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((I.dailyTransferUsage||0)/I.dailyTransferLimit*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-xs text-orange-600 font-medium",children:["متبقي سحب يومي: ",Math.max(I.dailyWithdrawalLimit-(I.dailyWithdrawalUsage||0),0)," جنيه"]}),e.jsxs("div",{className:"text-xs text-green-600 font-medium",children:["متبقي تحويل يومي: ",Math.max(I.dailyTransferLimit-(I.dailyTransferUsage||0),0)," جنيه"]})]})]})]}),e.jsxs("div",{className:"flex gap-1 pt-1",children:[e.jsxs(c,{size:"sm",variant:"outline",onClick:()=>Tt(I),className:"flex-1 h-5 text-xs px-1",children:[e.jsx(Ml,{className:"h-2 w-2 mr-0.5"}),"تعديل"]}),!I.isDefault&&e.jsxs(e.Fragment,{children:[e.jsx(c,{size:"sm",variant:"outline",onClick:()=>He(I.id),className:"flex-1 h-5 text-xs px-1",children:"جعلها افتراضية"}),e.jsx(c,{size:"sm",variant:"destructive",onClick:()=>Wt(I.id),className:"h-5 px-1",children:e.jsx(At,{className:"h-2 w-2"})})]})]})]})]},I.id)})}),L.length===0&&e.jsx("div",{className:"text-center py-4 text-gray-500 text-xs",children:"لا توجد محافظ متاحة. قم بإضافة محفظة جديدة للبدء."})]}),Oe&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-800",children:"معلومات صاحب المحفظة"}),e.jsx("button",{onClick:()=>rt(null),className:"h-8 w-8 p-0 flex items-center justify-center hover:bg-gray-100 rounded-full transition-colors",children:e.jsx(kl,{className:"h-4 w-4 text-gray-500"})})]}),(()=>{const I=rn.find(te=>te.id===Oe);return I?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-center mb-6",children:e.jsx("div",{className:"bg-blue-100 p-3 rounded-lg inline-block",children:e.jsx("h4",{className:"font-bold text-blue-700 text-lg",children:I.name})})}),e.jsx("div",{className:"bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-200",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-white p-3 rounded-lg shadow-sm",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full mr-2"}),e.jsx("span",{className:"font-semibold text-gray-700",children:"اسم صاحب المحفظة:"})]}),e.jsx("p",{className:"text-gray-900 font-medium text-lg mr-4",children:I.ownerName})]}),e.jsxs("div",{className:"bg-white p-3 rounded-lg shadow-sm",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full mr-2"}),e.jsx("span",{className:"font-semibold text-gray-700",children:"الرقم القومي:"})]}),e.jsx("p",{className:"text-gray-900 font-mono text-lg mr-4 tracking-wider",children:I.nationalId})]})]})}),e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 p-3 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(hn,{className:"h-4 w-4 text-yellow-600 mr-2"}),e.jsx("span",{className:"text-sm text-yellow-800 font-medium",children:"هذه البيانات مسجلة رسمياً في النظام لهذه المحفظة"})]})})]}):null})()]})})]}),e.jsx(Ts,{open:It,onOpenChange:Ot,mode:"verify",title:"إدخال الرقم السري الرئيسي",description:"لا يمكن الاطلاع على المحافظ إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{Ot(!1),$e(!0)}}),e.jsx(Wc,{isOpen:ct,onClose:()=>$e(!1),onWalletSelect:I=>{R(I),$e(!1)},onEditWallet:I=>{b(`/user/add-wallet?edit=1&id=${I.id}`),$e(!1)},onDeleteWallet:async I=>{try{if(await gs.delete(I),y(te=>{const le=te.filter(Ie=>Ie.id!==I);try{localStorage.setItem(H(),JSON.stringify(le))}catch(Ie){console.error("Failed to update localStorage wallets after delete:",Ie)}return le}),o)try{await o()}catch(te){console.error("onWalletUpdate callback failed:",te)}}catch(te){console.error("Error deleting wallet:",te)}}}),e.jsx(Ec,{wallet:x,isOpen:!!x,onClose:()=>R(null),onBack:()=>{R(null),$e(!0)}})]})},Mc=({isOpen:l,onClose:h,transaction:o,onDelete:t})=>{if(!o)return null;const u=m=>{switch(m){case"completed":return e.jsx(ks,{className:"h-5 w-5 text-green-500"});case"pending":return e.jsx(As,{className:"h-5 w-5 text-yellow-500"});case"failed":return e.jsx(pn,{className:"h-5 w-5 text-red-500"});default:return e.jsx(As,{className:"h-5 w-5 text-gray-500"})}},g=m=>{switch(m){case"completed":return"مكتملة";case"pending":return"قيد الانتظار";case"failed":return"فاشلة";default:return"غير معروف"}},b=m=>{switch(m){case"withdraw":return"سحب";case"send":return"إرسال";case"receive":return"استقبال";default:return"تحويل"}},L=()=>{const m=!!o.senderNumber,p=!!o.senderName,k=m?"الرقم المرسل:":p?"الرقم الراسل:":"رقم المحفظة:",A=m?o.senderNumber:p?o.senderName:o.senderPhone,B=`
      <div style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 500px; margin: 0 auto; padding: 30px; background: #fff;">
        <!-- Header -->
        <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #2563eb; padding-bottom: 20px;">
          <h1 style="color: #2563eb; margin-bottom: 5px; font-size: 28px;">إيصال المعاملة</h1>
          <p style="color: #666; font-size: 16px; margin: 0;">رقم المرجع: ${o.transactionReference||o.id}</p>
          <p style="color: #888; font-size: 14px; margin: 5px 0 0 0;">${new Date().toLocaleString("ar-EG")}</p>
        </div>
        
        <!-- Shop Info -->
        <div style="background: #f8fafc; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
          <h3 style="color: #1e293b; margin: 0 0 15px 0; font-size: 18px;">معلومات المحل</h3>
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span style="font-weight: 600; color: #475569;">اسم المحل:</span>
            <span style="color: #1e293b;">${o.merchantShopName||o.shopName||"غير محدد"}</span>
          </div>
        </div>
        
        <!-- Transaction Details -->
        <div style="background: #fff; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
          <h3 style="color: #1e293b; margin: 0 0 15px 0; font-size: 18px;">تفاصيل المعاملة</h3>
          
          <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
            <span style="font-weight: 600; color: #475569;">نوع المعاملة:</span>
            <span style="color: #2563eb; font-weight: 600;">${b(o.type)}</span>
          </div>
          
          <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
            <span style="font-weight: 600; color: #475569;">الحالة:</span>
            <span style="color: ${o.status==="completed"?"#16a34a":o.status==="pending"?"#ca8a04":"#dc2626"}; font-weight: 600;">
              ${g(o.status)}
            </span>
          </div>

          ${o!=null&&o.cashierName?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الكاشير:</span>
              <span style="color: #1e293b;">${o.cashierName}</span>
            </div>
          `:""}
          
          ${o.type!=="withdraw"?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">${k}</span>
              <span style="color: #1e293b;">${A}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الرقم المستقبل:</span>
              <span style="color: #1e293b;">${o.receiverNumber||o.receiverPhone}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">المبلغ المحول:</span>
              <span style="color: #2563eb; font-weight: bold; font-size: 16px;">${o.transferredAmount||o.amount} جنيه</span>
            </div>
          `:`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">رقم المحفظة:</span>
              <span style="color: #1e293b;">${o.senderPhone}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">المبلغ المسحوب:</span>
              <span style="color: #dc2626; font-weight: bold; font-size: 16px;">${o.withdrawnAmountDetailed||o.withdrawnAmount||o.amount} جنيه</span>
            </div>
          `}
          
          ${o.commission?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">العمولة:</span>
              <span style="color: #f59e0b; font-weight: 600;">${o.commission} جنيه</span>
            </div>
          `:""}
          ${o!=null&&o.fee&&Number(o.fee)>0?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الرسوم:</span>
              <span style="color: #64748b; font-weight: 600;">${o.fee} جنيه</span>
            </div>
          `:""}
          
          <div style="display: flex; justify-content: space-between; padding: 8px 0;">
            <span style="font-weight: 600; color: #475569;">التاريخ والوقت:</span>
            <span style="color: #1e293b;">${o.createdAt.toLocaleString("ar-EG")}</span>
          </div>
        </div>
        
        <!-- Total Amount -->
        <div style="background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); border-radius: 12px; padding: 20px; margin-bottom: 20px; text-align: center;">
          <h3 style="color: white; margin: 0 0 10px 0; font-size: 16px;">إجمالي المبلغ</h3>
          <p style="color: white; font-size: 24px; font-weight: bold; margin: 0;">
            ${o.type==="withdraw"?"-":""}${o.amount} جنيه
          </p>
        </div>
        
        
        
        
        <!-- Footer -->
        <div style="text-align: center; color: #64748b; font-size: 12px; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
          <p style="margin: 0 0 5px 0;">شكراً لاستخدام خدماتنا</p>
          <p style="margin: 0;">تم إنشاء الإيصال في: ${new Date().toLocaleString("ar-EG")}</p>
        </div>
      </div>
    `,z=window.open("","_blank");z&&(z.document.write(`
        <html>
          <head>
            <title>إيصال المعاملة - ${o.transactionReference||o.id}</title>
            <meta charset="UTF-8">
            <style>
              body { 
                margin: 0; 
                padding: 20px; 
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: #f8fafc;
              }
              @media print {
                body { 
                  margin: 0; 
                  background: white;
                }
              }
            </style>
          </head>
          <body>
            ${B}
          </body>
        </html>
      `),z.document.close(),z.print())},y=()=>{window.confirm("هل أنت متأكد من حذف هذه المعاملة؟ لا يمكن التراجع عن هذا الإجراء.")&&(t(o.id),h())};return e.jsx(ce,{open:l,onOpenChange:h,children:e.jsxs(de,{className:"w-[92vw] sm:w-auto sm:max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx(me,{children:e.jsxs(he,{className:"flex items-center gap-2 text-xl",children:[e.jsx(ar,{className:"h-6 w-6 text-blue-600"}),"إيصال المعاملة المفصل"]})}),e.jsxs("div",{className:"space-y-6",children:[e.jsx(Ye,{className:"bg-gradient-to-r from-blue-50 to-indigo-50 border-blue-200",children:e.jsxs(ht,{className:"text-center pb-2",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 mb-2",children:[u(o.status),e.jsx(ot,{variant:o.status==="completed"?"default":"secondary",className:"text-sm",children:g(o.status)})]}),e.jsxs("h3",{className:"text-2xl font-bold text-blue-600",children:[o.type==="withdraw"?"-":"",o.amount," جنيه"]}),e.jsxs("p",{className:"text-sm text-gray-600",children:["رقم المرجع: ",o.transactionReference||o.id]})]})}),e.jsxs(Ye,{children:[e.jsx(ht,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(cc,{className:"h-5 w-5 text-green-600"}),e.jsx("h4",{className:"font-semibold text-lg",children:"معلومات المحل"})]})}),e.jsxs(Ze,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"اسم المحل:"}),e.jsx("span",{className:"text-gray-900",children:o.merchantShopName||o.shopName||"غير محدد"})]}),(o==null?void 0:o.cashierName)&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"الكاشير:"}),e.jsx("span",{className:"text-gray-900",children:o.cashierName})]})]})]}),e.jsxs(Ye,{children:[e.jsx(ht,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ba,{className:"h-5 w-5 text-blue-600"}),e.jsx("h4",{className:"font-semibold text-lg",children:"تفاصيل المعاملة"})]})}),e.jsx(Ze,{className:"space-y-3",children:e.jsxs("div",{className:"grid grid-cols-1 gap-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-blue-700",children:"نوع المعاملة:"}),e.jsx(ot,{variant:"outline",className:"bg-blue-100 text-blue-800",children:b(o.type)})]}),o.type!=="withdraw"?e.jsxs(e.Fragment,{children:[(()=>{const m=!!o.senderNumber,p=!!o.senderName,k=m?"الرقم المرسل:":p?"الرقم الراسل:":"رقم المحفظة:",A=m?o.senderNumber:p?o.senderName:o.senderPhone,B=m?mn:os;return e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(B,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:k})]}),e.jsx("span",{className:"text-gray-900 font-mono",children:A})]})})(),e.jsx("div",{className:"flex items-center justify-center p-2",children:e.jsx(dc,{className:"h-6 w-6 text-blue-500"})}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-green-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(mn,{className:"h-4 w-4 text-green-500"}),e.jsx("span",{className:"font-medium text-green-700",children:"الرقم المستقبل:"})]}),e.jsx("span",{className:"text-green-900 font-mono",children:o.receiverNumber||o.receiverPhone})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Xe,{className:"h-4 w-4 text-blue-500"}),e.jsx("span",{className:"font-medium text-blue-700",children:"المبلغ المحول:"})]}),e.jsxs("span",{className:"text-blue-900 font-bold text-lg",children:[o.transferredAmount||o.amount," جنيه"]})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(os,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:"رقم المحفظة:"})]}),e.jsx("span",{className:"text-gray-900 font-mono",children:o.senderPhone})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-red-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Xe,{className:"h-4 w-4 text-red-500"}),e.jsx("span",{className:"font-medium text-red-700",children:"المبلغ المسحوب:"})]}),e.jsxs("span",{className:"text-red-900 font-bold text-lg",children:[o.withdrawnAmountDetailed||o.withdrawnAmount||o.amount," جنيه"]})]})]}),o.commission&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-yellow-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-yellow-700",children:"العمولة:"}),e.jsxs("span",{className:"text-yellow-900 font-semibold",children:[o.commission," جنيه"]})]}),(o==null?void 0:o.fee)&&Number(o.fee)>0&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"الرسوم:"}),e.jsxs("span",{className:"text-gray-900 font-semibold",children:[o.fee," جنيه"]})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ps,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:"التاريخ والوقت:"})]}),e.jsx("span",{className:"text-gray-900",children:o.createdAt.toLocaleString("ar-EG")})]})]})})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs(c,{onClick:L,className:"flex-1 bg-blue-600 hover:bg-blue-700 text-white",size:"lg",children:[e.jsx(mc,{className:"h-5 w-5 mr-2"}),"طباعة الإيصال"]}),e.jsxs(c,{onClick:y,variant:"destructive",className:"flex-1",size:"lg",children:[e.jsx(At,{className:"h-5 w-5 mr-2"}),"حذف المعاملة"]})]}),e.jsx(c,{onClick:h,variant:"outline",className:"w-full",size:"lg",children:"إغلاق الإيصال"})]})]})})};function jl({open:l,onOpenChange:h,onSuccess:o,title:t,description:u,currentBalance:g,balanceLabel:b,userId:L}){const[y,m]=a.useState(""),[p,k]=a.useState(g.toString()),[A,B]=a.useState(!1),[z,X]=a.useState(""),[F,w]=a.useState(!1),S=ls.hasMasterPin(),_=async P=>{P.preventDefault(),X(""),w(!0);try{const q=parseFloat(p);if(isNaN(q)||q<0){X("يرجى إدخال مبلغ صحيح"),w(!1);return}S?ls.verifyMasterPin(y)?(o(q),h(!1),m(""),k("")):X("الرقم السري غير صحيح"):X("لم يتم تعيين رقم سري رئيسي. يرجى تعيين رقم سري رئيسي أولاً من إعدادات التطبيق")}catch{X("حدث خطأ أثناء التحقق من الرقم السري")}finally{w(!1)}},$=()=>{m(""),k(g.toString()),X(""),h(!1)};return mt.useEffect(()=>{l&&k(g.toString())},[g,l]),e.jsx(ce,{open:l,onOpenChange:$,children:e.jsxs(de,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(me,{children:e.jsxs(he,{className:"flex items-center gap-2 text-right",children:[e.jsx(Xe,{className:"h-5 w-5"}),t]})}),e.jsxs("form",{onSubmit:_,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:u}),e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg",children:[e.jsxs(V,{className:"text-sm font-medium text-gray-700",children:[b," الحالي"]}),e.jsxs("div",{className:"text-lg font-bold text-gray-900 mt-1",children:[g.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"newAmount",className:"text-right",children:"المبلغ الجديد"}),e.jsx(M,{id:"newAmount",type:"number",step:"0.01",min:"0",value:p,onChange:P=>k(P.target.value),placeholder:"أدخل المبلغ الجديد",className:"text-right",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"pin",className:"text-right",children:"الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(M,{id:"pin",type:A?"text":"password",value:y,onChange:P=>m(P.target.value),placeholder:"أدخل الرقم السري",className:"text-right pr-10",required:!0}),e.jsx(c,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>B(!A),children:A?e.jsx(Pt,{className:"h-4 w-4"}):e.jsx(tt,{className:"h-4 w-4"})})]})]}),z&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-red-600 bg-red-50 p-2 rounded",children:[e.jsx(Ws,{className:"h-4 w-4"}),z]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(c,{type:"button",variant:"outline",onClick:$,className:"flex-1",children:"إلغاء"}),e.jsx(c,{type:"submit",disabled:F||!y||!p,className:"flex-1",children:F?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"جاري التحديث..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Ps,{className:"h-4 w-4 mr-2"}),"تحديث الرصيد"]})})]})]})]})})}class ya{static getSecretKey(h){return h?`${this.SECRET_KEY_BASE}_${h}`:this.SECRET_KEY_BASE}static setSecretPin(h,o){const t=btoa(h);this.secretCache.set(this.getSecretKey(o),t)}static hasSecretPin(h){return this.secretCache.has(this.getSecretKey(h))}static verifySecretPin(h,o){const t=this.secretCache.get(this.getSecretKey(o));if(!t)return!1;try{return atob(t)===h}catch{return!1}}static clearSecretPin(h){this.secretCache.delete(this.getSecretKey(h))}}Xr(ya,"SECRET_KEY_BASE","dashboard_secret_pin"),Xr(ya,"secretCache",new Map);function Lc({open:l,onOpenChange:h,userId:o}){const[t,u]=a.useState(""),[g,b]=a.useState(""),[L,y]=a.useState(""),[m,p]=a.useState(!1),[k,A]=a.useState(!1),[B,z]=a.useState(!1),[X,F]=a.useState(""),[w,S]=a.useState(!1),{toast:_}=Gt(),$=ya.hasSecretPin(o),P=async re=>{re.preventDefault(),F(""),S(!0);try{if(!g||g.length<4){F("يجب أن يكون الرقم السري 4 أرقام على الأقل"),S(!1);return}if(g!==L){F("الرقم السري الجديد وتأكيده غير متطابقين"),S(!1);return}if($){if(!t){F("يرجى إدخال الرقم السري الحالي"),S(!1);return}if(!ya.verifySecretPin(t,o)){F("الرقم السري الحالي غير صحيح"),S(!1);return}}ya.setSecretPin(g,o),_({title:$?"تم تغيير الرقم السري":"تم تعيين الرقم السري",description:$?"تم تغيير الرقم السري بنجاح":"تم تعيين الرقم السري بنجاح"}),q()}catch{F("حدث خطأ أثناء حفظ الرقم السري")}finally{S(!1)}},q=()=>{u(""),b(""),y(""),F(""),p(!1),A(!1),z(!1),h(!1)};return e.jsx(ce,{open:l,onOpenChange:q,children:e.jsxs(de,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(me,{children:e.jsxs(he,{className:"flex items-center gap-2 text-right",children:[e.jsx(Tl,{className:"h-5 w-5"}),$?"تغيير الرقم السري":"تعيين الرقم السري"]})}),e.jsxs("form",{onSubmit:P,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:$?"أدخل الرقم السري الحالي والرقم السري الجديد لتغييره":"أدخل الرقم السري الجديد الذي تريد استخدامه في عمليات التعديل"}),$&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي"}),e.jsxs("div",{className:"relative",children:[e.jsx(M,{id:"currentPin",type:m?"text":"password",autoComplete:"off",value:t,onChange:re=>u(re.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(c,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>p(!m),children:m?e.jsx(Pt,{className:"h-4 w-4"}):e.jsx(tt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(M,{id:"newPin",type:k?"text":"password",autoComplete:"off",value:g,onChange:re=>b(re.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(c,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>A(!k),children:k?e.jsx(Pt,{className:"h-4 w-4"}):e.jsx(tt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(M,{id:"confirmPin",type:B?"text":"password",autoComplete:"off",value:L,onChange:re=>y(re.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(c,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>z(!B),children:B?e.jsx(Pt,{className:"h-4 w-4"}):e.jsx(tt,{className:"h-4 w-4"})})]})]}),X&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(Ws,{className:"h-4 w-4"}),X]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(c,{type:"submit",disabled:w,className:"flex-1",children:[e.jsx(Ps,{className:"h-4 w-4 mr-2"}),w?"جاري الحفظ...":$?"تغيير الرقم السري":"تعيين الرقم السري"]}),e.jsx(c,{type:"button",variant:"outline",onClick:q,disabled:w,children:"إلغاء"})]})]})]})})}const nn=new Map;function $c({open:l,onOpenChange:h,userId:o}){const[t,u]=a.useState(""),[g,b]=a.useState(""),[L,y]=a.useState(""),[m,p]=a.useState(!1),[k,A]=a.useState(!1),[B,z]=a.useState(!1),[X,F]=a.useState(""),[w,S]=a.useState(!1),{toast:_}=Gt(),$=o?`cash_drawer_pin_${o}`:"cash_drawer_pin",P=()=>nn.has($),q=Q=>{const ee=nn.get($);if(!ee)return!1;try{return atob(ee)===Q}catch{return!1}},re=Q=>{const ee=btoa(Q);nn.set($,ee)},ne=async Q=>{Q.preventDefault(),F(""),S(!0);try{if(!g||g.length<4){F("يجب أن يكون الرقم السري 4 أرقام على الأقل"),S(!1);return}if(g!==L){F("الرقم السري الجديد وتأكيده غير متطابقين"),S(!1);return}if(P()){if(!t){F("يرجى إدخال الرقم السري الحالي لدرج النقدية"),S(!1);return}if(!q(t)){F("الرقم السري الحالي لدرج النقدية غير صحيح"),S(!1);return}}re(g),_({title:P()?"تم تغيير رقم درج النقدية":"تم تعيين رقم درج النقدية",description:P()?"تم تغيير الرقم السري لدرج النقدية بنجاح":"تم تعيين الرقم السري لدرج النقدية بنجاح"}),ue()}catch{F("حدث خطأ أثناء حفظ الرقم السري لدرج النقدية")}finally{S(!1)}},ue=()=>{u(""),b(""),y(""),F(""),p(!1),A(!1),z(!1),h(!1)};return e.jsx(ce,{open:l,onOpenChange:ue,children:e.jsxs(de,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(me,{children:e.jsxs(he,{className:"flex items-center gap-2 text-right",children:[e.jsx(Xe,{className:"h-5 w-5 text-green-600"}),P()?"تغيير رقم درج النقدية":"تعيين رقم درج النقدية"]})}),e.jsxs("form",{onSubmit:ne,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:P()?"أدخل الرقم السري الحالي والرقم السري الجديد لدرج النقدية":"أدخل الرقم السري الجديد الذي تريد استخدامه لحماية درج النقدية"}),P()&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي لدرج النقدية"}),e.jsxs("div",{className:"relative",children:[e.jsx(M,{id:"currentPin",type:m?"text":"password",autoComplete:"off",value:t,onChange:Q=>u(Q.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(c,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>p(!m),children:m?e.jsx(Pt,{className:"h-4 w-4"}):e.jsx(tt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد لدرج النقدية"}),e.jsxs("div",{className:"relative",children:[e.jsx(M,{id:"newPin",type:k?"text":"password",autoComplete:"off",value:g,onChange:Q=>b(Q.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(c,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>A(!k),children:k?e.jsx(Pt,{className:"h-4 w-4"}):e.jsx(tt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(M,{id:"confirmPin",type:B?"text":"password",autoComplete:"off",value:L,onChange:Q=>y(Q.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(c,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>z(!B),children:B?e.jsx(Pt,{className:"h-4 w-4"}):e.jsx(tt,{className:"h-4 w-4"})})]})]}),X&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(Ws,{className:"h-4 w-4"}),X]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(c,{type:"submit",disabled:w,className:"flex-1 bg-green-600 hover:bg-green-700",children:[e.jsx(Ps,{className:"h-4 w-4 mr-2"}),w?"جاري الحفظ...":P()?"تغيير رقم درج النقدية":"تعيين رقم درج النقدية"]}),e.jsx(c,{type:"button",variant:"outline",onClick:ue,disabled:w,children:"إلغاء"})]})]}),e.jsx("div",{className:"text-xs text-gray-500 text-center mt-2",children:"💰 هذا الرقم السري خاص بحماية درج النقدية فقط"})]})})}const ln=new Map;function Rc({open:l,onOpenChange:h,userId:o}){const[t,u]=a.useState(""),[g,b]=a.useState(""),[L,y]=a.useState(""),[m,p]=a.useState(!1),[k,A]=a.useState(!1),[B,z]=a.useState(!1),[X,F]=a.useState(""),[w,S]=a.useState(!1),{toast:_}=Gt(),$=o?`wallet_total_pin_${o}`:"wallet_total_pin",P=()=>ln.has($),q=Q=>{const ee=ln.get($);if(!ee)return!1;try{return atob(ee)===Q}catch{return!1}},re=Q=>{const ee=btoa(Q);ln.set($,ee)},ne=async Q=>{Q.preventDefault(),F(""),S(!0);try{if(!g||g.length<4){F("يجب أن يكون الرقم السري 4 أرقام على الأقل"),S(!1);return}if(g!==L){F("الرقم السري الجديد وتأكيده غير متطابقين"),S(!1);return}if(P()){if(!t){F("يرجى إدخال الرقم السري الحالي لإجمالي المحفظة"),S(!1);return}if(!q(t)){F("الرقم السري الحالي لإجمالي المحفظة غير صحيح"),S(!1);return}}re(g),_({title:P()?"تم تغيير رقم إجمالي المحفظة":"تم تعيين رقم إجمالي المحفظة",description:P()?"تم تغيير الرقم السري لإجمالي المحفظة بنجاح":"تم تعيين الرقم السري لإجمالي المحفظة بنجاح"}),ue()}catch{F("حدث خطأ أثناء حفظ الرقم السري لإجمالي المحفظة")}finally{S(!1)}},ue=()=>{u(""),b(""),y(""),F(""),p(!1),A(!1),z(!1),h(!1)};return e.jsx(ce,{open:l,onOpenChange:ue,children:e.jsxs(de,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(me,{children:e.jsxs(he,{className:"flex items-center gap-2 text-right",children:[e.jsx(Ht,{className:"h-5 w-5 text-blue-600"}),P()?"تغيير رقم إجمالي المحفظة":"تعيين رقم إجمالي المحفظة"]})}),e.jsxs("form",{onSubmit:ne,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:P()?"أدخل الرقم السري الحالي والرقم السري الجديد لإجمالي المحفظة":"أدخل الرقم السري الجديد الذي تريد استخدامه لحماية إجمالي المحفظة"}),P()&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي لإجمالي المحفظة"}),e.jsxs("div",{className:"relative",children:[e.jsx(M,{id:"currentPin",type:m?"text":"password",autoComplete:"off",value:t,onChange:Q=>u(Q.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(c,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>p(!m),children:m?e.jsx(Pt,{className:"h-4 w-4"}):e.jsx(tt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد لإجمالي المحفظة"}),e.jsxs("div",{className:"relative",children:[e.jsx(M,{id:"newPin",type:k?"text":"password",autoComplete:"off",value:g,onChange:Q=>b(Q.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(c,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>A(!k),children:k?e.jsx(Pt,{className:"h-4 w-4"}):e.jsx(tt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(M,{id:"confirmPin",type:B?"text":"password",autoComplete:"off",value:L,onChange:Q=>y(Q.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(c,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>z(!B),children:B?e.jsx(Pt,{className:"h-4 w-4"}):e.jsx(tt,{className:"h-4 w-4"})})]})]}),X&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(Ws,{className:"h-4 w-4"}),X]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(c,{type:"submit",disabled:w,className:"flex-1 bg-blue-600 hover:bg-blue-700",children:[e.jsx(Ps,{className:"h-4 w-4 mr-2"}),w?"جاري الحفظ...":P()?"تغيير رقم إجمالي المحفظة":"تعيين رقم إجمالي المحفظة"]}),e.jsx(c,{type:"button",variant:"outline",onClick:ue,disabled:w,children:"إلغاء"})]})]}),e.jsx("div",{className:"text-xs text-gray-500 text-center mt-2",children:"💼 هذا الرقم السري خاص بحماية إجمالي المحفظة فقط"})]})})}function Uc({open:l,onOpenChange:h,onSuccess:o,title:t,description:u,currentBalance:g,balanceLabel:b,userId:L}){const[y,m]=a.useState(""),[p,k]=a.useState(""),[A,B]=a.useState("add"),[z,X]=a.useState(!1),[F,w]=a.useState(""),[S,_]=a.useState(!1),$=ls.hasMasterPin(),P=async ne=>{ne.preventDefault(),w(""),_(!0);try{const ue=parseFloat(p);if(isNaN(ue)||ue<=0){w("يرجى إدخال مبلغ صحيح أكبر من صفر"),_(!1);return}if(A==="subtract"&&ue>g){w("لا يمكن خصم مبلغ أكبر من الرصيد الحالي"),_(!1);return}if($)if(ls.verifyMasterPin(y)){const Q=A==="add"?ue:-ue;q(),o(Q)}else w("الرقم السري غير صحيح");else w("لم يتم تعيين رقم سري رئيسي. يرجى تعيين رقم سري رئيسي أولاً من إعدادات التطبيق")}catch{w("حدث خطأ أثناء التحقق من الرقم السري")}finally{_(!1)}},q=()=>{m(""),k(""),B("add"),w(""),h(!1)},re=()=>{const ne=parseFloat(p)||0;return A==="add"?g+ne:g-ne};return e.jsx(ce,{open:l,onOpenChange:q,children:e.jsxs(de,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(me,{children:e.jsxs(he,{className:"flex items-center gap-2 text-right",children:[A==="add"?e.jsx(gt,{className:"h-5 w-5 text-green-600"}):e.jsx(Is,{className:"h-5 w-5 text-red-600"}),t]})}),e.jsxs("form",{onSubmit:P,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:u}),e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg",children:[e.jsxs(V,{className:"text-sm font-medium text-gray-700",children:[b," الحالي"]}),e.jsxs("div",{className:"text-lg font-bold text-gray-900 mt-1",children:[g.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{className:"text-right",children:"نوع العملية"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(c,{type:"button",variant:A==="add"?"default":"outline",onClick:()=>B("add"),className:"flex-1 flex items-center gap-2",children:[e.jsx(gt,{className:"h-4 w-4"}),"إضافة"]}),e.jsxs(c,{type:"button",variant:A==="subtract"?"default":"outline",onClick:()=>B("subtract"),className:"flex-1 flex items-center gap-2",children:[e.jsx(Is,{className:"h-4 w-4"}),"خصم"]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(V,{htmlFor:"amount",className:"text-right",children:["المبلغ المراد ",A==="add"?"إضافته":"خصمه"]}),e.jsx(M,{id:"amount",type:"number",step:"0.01",min:"0.01",value:p,onChange:ne=>k(ne.target.value),placeholder:`أدخل المبلغ المراد ${A==="add"?"إضافته":"خصمه"}`,className:"text-right",required:!0})]}),p&&!isNaN(parseFloat(p))&&e.jsxs("div",{className:`p-3 rounded-lg ${A==="add"?"bg-green-50 border border-green-200":"bg-red-50 border border-red-200"}`,children:[e.jsx(V,{className:"text-sm font-medium text-gray-700",children:"الرصيد الجديد المتوقع"}),e.jsxs("div",{className:`text-lg font-bold mt-1 ${A==="add"?"text-green-700":"text-red-700"}`,children:[re().toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"pin",className:"text-right",children:"الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(M,{id:"pin",type:z?"text":"password",autoComplete:"off",value:y,onChange:ne=>m(ne.target.value),placeholder:"أدخل الرقم السري",className:"text-right pr-10",required:!0}),e.jsx(c,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>X(!z),children:z?e.jsx(Pt,{className:"h-4 w-4"}):e.jsx(tt,{className:"h-4 w-4"})})]})]}),F&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-red-600 bg-red-50 p-2 rounded",children:[e.jsx(Ws,{className:"h-4 w-4"}),F]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(c,{type:"button",variant:"outline",onClick:q,className:"flex-1",children:"إلغاء"}),e.jsx(c,{type:"submit",disabled:S||!y||!p,className:`flex-1 ${A==="add"?"bg-green-600 hover:bg-green-700":"bg-red-600 hover:bg-red-700"}`,children:S?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"جاري التحديث..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Ps,{className:"h-4 w-4 mr-2"}),A==="add"?"إضافة المبلغ":"خصم المبلغ"]})})]})]})]})})}function _c(l){return l?`readBroadcastIds_${l}`:"readBroadcastIds_guest"}function zc({className:l}){const{user:h,profile:o}=ds(),[t,u]=a.useState([]),[g,b]=a.useState(new Set);a.useState(null);const[L,y]=a.useState(!1);a.useRef(new Set),a.useRef(!1);const m=a.useRef(null),p=a.useRef(null);a.useRef(null),a.useState({position:"fixed",top:0,left:0,zIndex:1e4});const k=!1,A=a.useMemo(()=>{const S=["global"];return h!=null&&h.uid&&S.push(`user:${h.uid}`),o!=null&&o.shopId&&S.push(`shop:${o.shopId}`),S},[h==null?void 0:h.uid,o==null?void 0:o.shopId]),B=_c(h==null?void 0:h.uid);a.useEffect(()=>{try{const S=localStorage.getItem(B);if(S){const _=JSON.parse(S);Array.isArray(_)&&b(new Set(_.filter(Boolean)))}else b(new Set)}catch(S){console.warn("Failed to load read ids",S),b(new Set)}},[B]),a.useEffect(()=>{const S=bc(A,_=>{u(_)});return()=>S()},[A]),a.useEffect(()=>{},[t]),a.useEffect(()=>()=>{m.current&&clearTimeout(m.current)},[]);const z=t.reduce((S,_)=>S+(_.id&&!g.has(_.id)?1:0),0),X=S=>{if(!S||g.has(S))return;const _=new Set(g);_.add(S),b(_);try{localStorage.setItem(B,JSON.stringify(Array.from(_)))}catch{}},F=()=>{const S=t.map($=>$.id).filter(Boolean),_=new Set(g);S.forEach($=>_.add($)),b(_);try{localStorage.setItem(B,JSON.stringify(Array.from(_)))}catch{}},w=(S,_)=>{S&&window.open(S,"_blank"),_&&X(_)};return a.useEffect(()=>{},[L]),e.jsxs("div",{className:`relative inline-block ${l||""}`,ref:p,children:[e.jsxs(Nc,{onOpenChange:S=>{S&&z>0&&F()},children:[e.jsx(wc,{asChild:!0,children:e.jsx(c,{variant:"ghost",className:"relative h-8 w-8 rounded-full p-0 hover:bg-transparent focus:ring-1 focus:ring-primary focus:ring-offset-1 transition-all",title:"الإشعارات",children:e.jsxs("div",{className:"relative h-8 w-8 rounded-full bg-primary/10 flex items-center justify-center border border-border shadow-sm hover:shadow-md",children:[e.jsx(bl,{className:"h-4 w-4 text-primary"}),z>0&&e.jsx("span",{className:"absolute -top-1 -right-1 min-w-[18px] h-[18px] px-1 rounded-full bg-red-500 text-white text-[10px] font-bold flex items-center justify-center shadow",children:z})]})})}),e.jsxs(Sc,{className:"w-80",align:"end",forceMount:!0,children:[e.jsxs(Dc,{className:"flex items-center justify-between",children:[e.jsx("span",{children:"الإشعارات"}),t.length>0&&e.jsxs(c,{variant:"outline",size:"sm",className:"h-7 text-xs",onClick:F,children:[e.jsx(ks,{className:"h-3 w-3 mr-1"}),"تمييز الكل كمقروء"]})]}),e.jsx(Cc,{}),t.length===0?e.jsx("div",{className:"p-3 text-sm text-muted-foreground",children:"لا توجد إشعارات حالياً"}):e.jsx("div",{className:"max-h-64 overflow-y-auto pr-1",children:t.map(S=>{const _=S.id?!g.has(S.id):!1;return e.jsx("div",{className:`px-2 py-2 rounded-md ${_?"bg-primary/5":""}`,children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(bl,{className:`h-4 w-4 ${_?"text-primary":"text-muted-foreground"}`}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-sm font-medium",children:S.title||"إشعار"}),e.jsx("div",{className:"text-xs text-muted-foreground whitespace-pre-line",children:S.message}),S.linkUrl&&e.jsxs(c,{variant:"link",className:"px-0 h-6 text-xs",onClick:()=>w(S.linkUrl,S.id),children:["فتح الرابط ",e.jsx(jc,{className:"h-3 w-3 ml-1"})]})]}),_?e.jsx(c,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>X(S.id),title:"تمييز كمقروء",children:e.jsx(ks,{className:"h-4 w-4 text-primary"})}):e.jsx(c,{variant:"ghost",size:"icon",className:"h-6 w-6",disabled:!0,title:"مقروء",children:e.jsx(ks,{className:"h-4 w-4 text-muted-foreground"})})]})},S.id)})})]})]}),k]})}const Nl=({isOpen:l,onClose:h,onTrialStarted:o})=>{const{user:t}=ds(),[u,g]=a.useState(!1),[b,L]=a.useState(!1),[y,m]=a.useState(""),[p,k]=a.useState(24);a.useEffect(()=>{const z=async()=>{if(t!=null&&t.uid){const F=await fa.getTrialData(t.uid);L(F.hasUsedFreeTrial)}},X=async()=>{try{const F=await fa.getTrialDurationHours();k(F)}catch{}};l&&(z(),X())},[l,t]);const A=async()=>{if(t!=null&&t.uid){g(!0);try{const z=await fa.startFreeTrial(t.uid);z.success?(m(z.message),window.location.href="/user/dashboard"):m(z.message||"تعذر تفعيل التجربة المجانية")}catch{m("حدث خطأ أثناء تفعيل التجربة المجانية")}finally{g(!1)}}},B=async()=>{if(t!=null&&t.uid){g(!0);try{await $o(t.uid,ns.ZERO,t.uid),window.location.href="/user/dashboard"}catch{m("حدث خطأ أثناء تفعيل باقة الزيرو")}finally{g(!1)}}};return e.jsxs(e.Fragment,{children:[l&&e.jsx("div",{className:"fixed inset-0 z-40",style:{background:"rgba(0, 0, 0, 0.15)",backdropFilter:"blur(3px)",WebkitBackdropFilter:"blur(3px)",pointerEvents:"auto"}}),e.jsx(ce,{open:l,onOpenChange:()=>{},children:e.jsxs(de,{className:"sm:max-w-lg z-50 border-0 shadow-2xl",style:{position:"fixed",top:"50%",left:"50%",transform:"translate(-50%, -50%)",pointerEvents:"auto",background:"linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 0.95) 100%)",backdropFilter:"blur(10px)",WebkitBackdropFilter:"blur(10px)",borderRadius:"20px",border:"1px solid rgba(255, 255, 255, 0.3)"},children:[e.jsxs(me,{className:"text-center pb-0 pt-0",children:[e.jsx("div",{className:"flex justify-center mb-1",children:e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-0 rounded-full",style:{background:"linear-gradient(135deg, #f59e0b, #d97706)",filter:"blur(8px)",opacity:.3}}),e.jsx("div",{className:"relative bg-gradient-to-br from-orange-400 to-orange-600 p-2 rounded-full",children:e.jsx(an,{className:"h-12 w-12 text-white"})})]})}),e.jsx(he,{className:"text-2xl font-bold bg-gradient-to-r from-gray-800 to-gray-600 bg-clip-text text-transparent text-center mt-0 mb-0 leading-tight",children:"تفعيل الحساب مطلوب"})]}),e.jsxs("div",{className:"text-center pt-6 pb-0 px-2",children:[e.jsxs("div",{className:"bg-gradient-to-r from-orange-50 to-amber-50 rounded-xl p-6 mb-6 border border-orange-100",children:[e.jsx("p",{className:"text-gray-700 text-lg leading-relaxed font-medium",children:"حسابك في انتظار التفعيل من قبل المسؤول"}),e.jsx("p",{className:"text-sm font-semibold text-orange-700 mt-3 mb-3 bg-orange-100 p-3 rounded-lg border border-orange-200",children:"للتفعيل السريع: تواصل مع الإدارة عبر واتساب فقط على الرقم التالي"}),e.jsxs("div",{className:"bg-green-50 p-4 rounded-lg border border-green-200 mt-3",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"text-base font-bold text-green-700",children:"واتساب الإدارة:"}),e.jsx("a",{href:"https://wa.me/201000392539",target:"_blank",rel:"noopener noreferrer",className:"text-lg font-bold text-green-600 hover:text-green-700 underline",children:"01000392539"})]}),e.jsx("p",{className:"text-sm text-green-600 mt-2 text-center",children:"اضغط على الرقم للتواصل المباشر عبر واتساب"})]})]}),!b&&e.jsxs("div",{className:"bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-4 mb-4 border border-green-200",children:[e.jsxs("div",{className:"flex items-center justify-center mb-2",children:[e.jsx(an,{className:"h-5 w-5 text-green-600 ml-2"}),e.jsx("span",{className:"text-green-700 font-semibold",children:"باقة الزيرو المجانية الدائمة"})]}),e.jsx("p",{className:"text-green-600 text-sm text-center",children:"فعل باقة الزيرو الان واستمتع ب 10 عمليات سحب وتحويل يوميا"})]}),y&&e.jsx("div",{className:`rounded-xl p-4 mb-4 text-center ${y.includes("تم تفعيل")?"bg-green-50 border border-green-200 text-green-700":"bg-red-50 border border-red-200 text-red-700"}`,children:e.jsx("p",{className:"font-medium",children:y})}),e.jsxs("div",{className:"flex items-center justify-center space-x-2 text-sm text-gray-500 mb-0",children:[e.jsxs("div",{className:"flex space-x-1",children:[e.jsx("div",{className:"w-2 h-2 bg-orange-400 rounded-full animate-pulse"}),e.jsx("div",{className:"w-2 h-2 bg-orange-400 rounded-full animate-pulse",style:{animationDelay:"0.2s"}}),e.jsx("div",{className:"w-2 h-2 bg-orange-400 rounded-full animate-pulse",style:{animationDelay:"0.4s"}})]}),e.jsx("span",{className:"mr-2",children:"في انتظار التفعيل"})]})]}),e.jsxs("div",{className:"flex flex-col space-y-3 pb-2",children:[!b&&!y.includes("تم تفعيل")&&e.jsxs(e.Fragment,{children:[e.jsxs(c,{onClick:A,disabled:u,className:"w-full max-w-2xl mx-auto relative bg-gradient-to-r from-blue-600 to-indigo-600 hover:brightness-110 text-white px-10 py-4 rounded-2xl font-bold text-xl ring-2 ring-blue-300 ring-offset-1 shadow-2xl hover:shadow-3xl transition-all duration-500 transform hover:scale-110 hover:-translate-y-1 disabled:opacity-50 disabled:cursor-not-allowed overflow-hidden group focus-visible:outline-none focus-visible:ring-4 focus-visible:ring-blue-300",style:{boxShadow:"0 15px 35px rgba(59, 130, 246, 0.4), 0 5px 15px rgba(0, 0, 0, 0.1)"},children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-white/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"}),e.jsx("div",{className:"absolute -top-1 -left-1 w-3 h-3 bg-yellow-400 rounded-full animate-ping"}),e.jsx("div",{className:"absolute -top-1 -right-1 w-2 h-2 bg-green-400 rounded-full animate-pulse"}),u?e.jsxs("div",{className:"flex items-center relative z-10",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-white ml-3"}),e.jsx("span",{className:"bg-gradient-to-r from-white to-gray-100 bg-clip-text text-transparent",children:"جاري التفعيل..."})]}):e.jsxs("div",{className:"flex items-center relative z-10",children:[e.jsx(Ic,{className:"h-6 w-6 ml-3 animate-bounce"}),e.jsx("span",{className:"bg-gradient-to-r from-white to-gray-100 bg-clip-text text-transparent",children:`التجربة المجانية لمدة ${p} ${p>=3&&p<=10?"ساعات":p===2?"ساعتين":"ساعة"}`})]})]}),e.jsxs(c,{onClick:B,disabled:u,className:"w-full max-w-2xl mx-auto relative bg-gradient-to-r from-green-600 to-emerald-600 hover:brightness-110 text-white px-10 py-4 rounded-2xl font-bold text-xl ring-2 ring-emerald-300 ring-offset-1 shadow-2xl hover:shadow-3xl transition-all duration-500 transform hover:scale-110 hover:-translate-y-1 disabled:opacity-50 disabled:cursor-not-allowed overflow-hidden group focus-visible:outline-none focus-visible:ring-4 focus-visible:ring-emerald-300",style:{boxShadow:"0 15px 35px rgba(99, 102, 241, 0.4), 0 5px 15px rgba(0, 0, 0, 0.1)"},children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-white/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"}),e.jsx("div",{className:"absolute -top-1 -left-1 w-3 h-3 bg-yellow-400 rounded-full animate-ping"}),e.jsx("div",{className:"absolute -top-1 -right-1 w-2 h-2 bg-green-400 rounded-full animate-pulse"}),u?e.jsxs("div",{className:"flex items-center relative z-10",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-white ml-3"}),e.jsx("span",{className:"bg-gradient-to-r from-white to-gray-100 bg-clip-text text-transparent",children:"جاري التفعيل..."})]}):e.jsxs("div",{className:"flex items-center relative z-10",children:[e.jsx(an,{className:"h-6 w-6 ml-3 animate-bounce"}),e.jsx("span",{className:"bg-gradient-to-r from-white to-gray-100 bg-clip-text text-transparent",children:"فعّل باقة الزيرو الآن"})]})]})]}),e.jsx(c,{onClick:h,variant:"outline",className:"border-2 border-gray-300 hover:border-gray-400 text-gray-700 hover:text-gray-800 px-10 py-3 rounded-xl font-semibold text-lg transition-all duration-300 transform hover:scale-105",children:b?"فهمت":"إغلاق"})]})]})})]})};function Jc({isOpen:l,onClose:h}){const[o,t]=a.useState("0"),[u,g]=a.useState(null),[b,L]=a.useState(null),[y,m]=a.useState(!1),p=$=>{y?(t($),m(!1)):t(o==="0"?$:o+$)},k=$=>{const P=parseFloat(o);if(u===null)g(P);else if(b){const re=A(u||0,P,b);t(String(re)),g(re)}m(!0),L($)},A=($,P,q)=>{switch(q){case"+":return $+P;case"-":return $-P;case"×":return $*P;case"÷":return P===0?0:$/P;case"=":return P;default:return P}},B=()=>{const $=parseFloat(o);if(u!==null&&b){const P=A(u,$,b);t(String(P)),g(null),L(null),m(!0)}},z=()=>{t("0"),g(null),L(null),m(!1)},X=()=>{t("0")},F=()=>{y?(t("0."),m(!1)):o.indexOf(".")===-1&&t(o+".")},w=()=>{o!=="0"&&t(o.charAt(0)==="-"?o.slice(1):"-"+o)},S=()=>{const $=parseFloat(o);t(String($/100))},_=$=>{const P=$.key;$.preventDefault(),P>="0"&&P<="9"?p(P):P==="+"?k("+"):P==="-"?k("-"):P==="*"?k("×"):P==="/"?k("÷"):P==="Enter"||P==="="?B():P==="Escape"||P==="c"||P==="C"?z():P==="Backspace"?X():P==="."?F():P==="%"&&S()};return a.useEffect(()=>(l?document.addEventListener("keydown",_):document.removeEventListener("keydown",_),()=>{document.removeEventListener("keydown",_)}),[l,o,u,b,y]),e.jsx(ce,{open:l,onOpenChange:$=>!$&&h(),children:e.jsxs(de,{className:"sm:max-w-md",children:[e.jsx(me,{children:e.jsxs(he,{className:"flex items-center gap-2 text-right",children:[e.jsx($l,{className:"h-5 w-5"}),"آلة حاسبة"]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-gray-900 text-white p-4 rounded-lg text-right",children:e.jsx("div",{className:"text-3xl font-mono font-bold min-h-[3rem] flex items-center justify-end overflow-hidden",children:o})}),e.jsxs("div",{className:"grid grid-cols-4 gap-2",children:[e.jsx(c,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:z,children:"AC"}),e.jsx(c,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:X,children:"CE"}),e.jsx(c,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:S,children:"%"}),e.jsx(c,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>k("÷"),children:"÷"}),e.jsx(c,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>p("7"),children:"7"}),e.jsx(c,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>p("8"),children:"8"}),e.jsx(c,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>p("9"),children:"9"}),e.jsx(c,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>k("×"),children:"×"}),e.jsx(c,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>p("4"),children:"4"}),e.jsx(c,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>p("5"),children:"5"}),e.jsx(c,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>p("6"),children:"6"}),e.jsx(c,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>k("-"),children:"-"}),e.jsx(c,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>p("1"),children:"1"}),e.jsx(c,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>p("2"),children:"2"}),e.jsx(c,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>p("3"),children:"3"}),e.jsx(c,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>k("+"),children:"+"}),e.jsx(c,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50 col-span-2",onClick:()=>p("0"),children:"0"}),e.jsx(c,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:F,children:"."}),e.jsx(c,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:B,children:"="})]}),e.jsx(c,{variant:"outline",className:"w-full h-10 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:w,children:"+/-"})]})]})})}function Kc({isOpen:l,onClose:h}){const[o,t]=a.useState([]),[u,g]=a.useState({productName:"",price:"",wholesalePrice:"",quantity:""}),[b,L]=a.useState(!1);a.useState(null);const{toast:y}=Gt(),{user:m,profile:p}=ds(),[k,A]=a.useState([]),[B,z]=a.useState({}),[X,F]=a.useState({}),[w,S]=a.useState(0),[_,$]=a.useState(0),[P,q]=a.useState(!1),[re,ne]=a.useState(!0),[ue,Q]=a.useState(!1),[ee,Te]=a.useState(""),K=a.useMemo(()=>{const x=ee.trim().toLowerCase();return x?k.filter(R=>R.name.toLowerCase().includes(x)):k},[k,ee]);a.useEffect(()=>{l&&(m!=null&&m.uid)&&(Oe(),re||nt())},[l,m==null?void 0:m.uid,re]);const ae=async()=>{if(m!=null&&m.uid)try{const x=p==null?void 0:p.shopId;let R,H=[];if(x){const ve=Ds(rs(at,"products"),Dt("shopId","==",x),Dt("userId","==",m.uid));if(R=await Cs(ve),H=R.docs.map(oe=>({id:oe.id,name:String(oe.data().name??""),sellingPrice:Number(oe.data().sellingPrice??0),wholesalePrice:Number(oe.data().wholesalePrice??0),quantity:Number(oe.data().quantity??0)})),H.length===0){const oe=Ds(rs(at,"products"),Dt("userId","==",m.uid)),Pe=(await Cs(oe)).docs.map(Ee=>({id:Ee.id,name:String(Ee.data().name??""),sellingPrice:Number(Ee.data().sellingPrice??0),wholesalePrice:Number(Ee.data().wholesalePrice??0),quantity:Number(Ee.data().quantity??0)}));Pe.length>0&&(H=Pe,y({title:"تم استرجاع المنتجات",description:"عثرنا على منتجات محفوظة لك خارج المتجر الحالي وقمنا بعرضها."}))}}else{const ve=Ds(rs(at,"products"),Dt("userId","==",m.uid));R=await Cs(ve),H=R.docs.map(oe=>({id:oe.id,name:String(oe.data().name??""),sellingPrice:Number(oe.data().sellingPrice??0),wholesalePrice:Number(oe.data().wholesalePrice??0),quantity:Number(oe.data().quantity??0)}))}if(A(H),p!=null&&p.shopId&&H.length>0){const ve=H.filter(oe=>{const ke=((R==null?void 0:R.docs)||[]).find(Ee=>Ee.id===oe.id);return!(!!ke&&!!ke.data().shopId)});if(ve.length>0)try{await Promise.all(ve.map(oe=>qs(Yt(at,"products",oe.id),{shopId:p.shopId,updatedAt:zs()}))),y({title:"تم ترتيب المنتجات",description:"تم ربط بعض المنتجات غير المربوطة بمتجرك الحالي تلقائياً."})}catch(oe){console.warn("تعذّر ترحيل shopId لبعض المنتجات:",oe)}}}catch(x){console.error("Error loading shop products:",x)}};a.useEffect(()=>{l&&(m!=null&&m.uid)&&(ae(),nt())},[l,m==null?void 0:m.uid,p==null?void 0:p.shopId]);const Oe=()=>{if(!(m!=null&&m.uid)){console.log("No user authenticated, cannot load sales data");return}const x=new Date().toISOString().split("T")[0],R=localStorage.getItem(`salesData_${m.uid}_${x}`);t(R?JSON.parse(R):[])},rt=x=>{if(!(m!=null&&m.uid)){console.log("No user authenticated, cannot save sales data");return}const R=new Date().toISOString().split("T")[0];localStorage.setItem(`salesData_${m.uid}_${R}`,JSON.stringify(x)),t(x)},nt=async()=>{if(m!=null&&m.uid)try{const x=new Date,R=new Date(x.getFullYear(),x.getMonth(),1),H=new Date(x.getFullYear(),x.getMonth()+1,0),ve=He=>He.toISOString().split("T")[0],oe=ve(R),ke=ve(H),Pe=Ds(rs(at,"dailySales"),Dt("userId","==",m.uid),Dt("date",">=",oe),Dt("date","<=",ke)),Ee=await Cs(Pe);let Tt=0,Wt=0;if(!Ee.empty)Ee.forEach(He=>{const I=He.data(),te=Number(I.sellingPrice??0),le=Number(I.quantity??0),Ie=Number(I.profit??(Number(I.sellingPrice??0)-Number(I.wholesalePrice??0))*le);Tt+=te*le,Wt+=Ie});else{const He=Ds(rs(at,"dailySales"),Dt("userId","==",m.uid));(await Cs(He)).forEach(te=>{const le=te.data(),Ie=String(le.date??"").slice(0,10);if(Ie>=oe&&Ie<=ke){const We=Number(le.sellingPrice??0),ze=Number(le.quantity??0),O=Number(le.profit??(Number(le.sellingPrice??0)-Number(le.wholesalePrice??0))*ze);Tt+=We*ze,Wt+=O}}),(Tt>0||Wt>0)&&y({title:"تم استرجاع تقارير الشهر",description:"تم حساب التقارير باستخدام مسار احتياطي للتواريخ القديمة."})}S(Tt),$(Wt)}catch(x){console.error("Error loading monthly stats:",x)}},Se=async x=>{if(m!=null&&m.uid)try{const R=((x.price??0)-(x.wholesalePrice??0))*(x.quantity??0);await vl(rs(at,"dailySales"),{userId:m.uid,productName:x.productName,quantity:x.quantity,wholesalePrice:x.wholesalePrice??null,sellingPrice:x.price,profit:R,date:x.date,time:x.time,createdAt:zs()})}catch(R){console.error("Error saving sale:",R)}},ct=async x=>{const R=B[x.id]||"",H=parseInt(R);if(isNaN(H)||H<=0){y({title:"كمية غير صالحة",description:"أدخل كمية صحيحة للبيـع",variant:"destructive"});return}if(H>x.quantity){y({title:"كمية أكبر من المتاح",description:"الكمية المطلوب بيعها تتجاوز المخزون المتاح",variant:"destructive"});return}const ve=new Date,oe={id:Date.now().toString(),productName:x.name,price:x.sellingPrice,wholesalePrice:x.wholesalePrice,quantity:H,date:ve.toISOString().split("T")[0],time:ve.toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit"})};try{rt([...o,oe]),await Se(oe);const ke=x.quantity-H;await qs(Yt(at,"products",x.id),{quantity:ke,updatedAt:zs()}),A(Pe=>Pe.map(Ee=>Ee.id===x.id?{...Ee,quantity:ke}:Ee)),z(Pe=>({...Pe,[x.id]:""})),y({title:"تم البيع",description:`تم بيع ${H} قطعة من ${x.name}`})}catch(ke){console.error("Error selling product:",ke),y({title:"فشل البيع",description:"تعذّر تنفيذ عملية البيع",variant:"destructive"})}},$e=async x=>{const R=X[x.id]||"",H=parseInt(R);if(isNaN(H)||H<=0){y({title:"كمية غير صالحة",description:"أدخل كمية صحيحة للإضافة",variant:"destructive"});return}try{const ve=x.quantity+H;await qs(Yt(at,"products",x.id),{quantity:ve,updatedAt:zs()}),A(oe=>oe.map(ke=>ke.id===x.id?{...ke,quantity:ve}:ke)),F(oe=>({...oe,[x.id]:""})),y({title:"تمت الإضافة",description:`تمت إضافة ${H} قطعة إلى ${x.name}`})}catch(ve){console.error("Error adding pieces:",ve),y({title:"فشل الإضافة",description:"تعذّر إضافة الكمية إلى المخزون",variant:"destructive"})}},It=async x=>{if(!(!(m!=null&&m.uid)||!window.confirm(`هل تريد حذف المنتج "${x.name}"؟`)))try{await Ro(Yt(at,"products",x.id)),A(H=>H.filter(ve=>ve.id!==x.id)),y({title:"تم الحذف",description:`تم حذف المنتج ${x.name}`})}catch(H){console.error("Error deleting product:",H),y({title:"فشل الحذف",description:"تعذّر حذف المنتج",variant:"destructive"})}},Ot=async()=>{try{if(!(m!=null&&m.uid)){y({title:"خطأ",description:"غير مسجّل دخول",variant:"destructive"});return}const x=u.productName.trim(),R=parseFloat(u.price),H=parseFloat(u.wholesalePrice||"0"),ve=parseInt(u.quantity);if(!x||isNaN(R)||isNaN(ve)){y({title:"بيانات غير مكتملة",description:"أدخل اسم المنتج والسعر والكمية",variant:"destructive"});return}const oe={name:x,sellingPrice:R,wholesalePrice:isNaN(H)?0:H,quantity:isNaN(ve)?0:ve,userId:m.uid,createdAt:zs(),updatedAt:zs()};p!=null&&p.shopId&&(oe.shopId=p.shopId);const ke=await vl(rs(at,"products"),oe);A(Pe=>[{id:ke.id,name:x,sellingPrice:R,wholesalePrice:isNaN(H)?0:H,quantity:isNaN(ve)?0:ve},...Pe]),g({productName:"",price:"",wholesalePrice:"",quantity:""}),y({title:"تمت الإضافة",description:`تم إضافة المنتج ${x} بنجاح`})}catch(x){console.error("createProduct error",x),y({title:"فشل الإضافة",description:"تعذّر إضافة المنتج. حاول مجددًا",variant:"destructive"})}};return e.jsxs(ce,{open:l,onOpenChange:h,children:[e.jsxs(de,{className:"max-w-7xl md:max-w-6xl lg:max-w-7xl w-[95vw] md:w-[90vw] h-[95vh] md:h-[90vh] p-0 overflow-y-auto",children:[e.jsx(me,{className:"px-3 md:px-6 py-3 md:py-4 border-b bg-gradient-to-r from-blue-50 to-purple-50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 md:gap-3",children:[e.jsx("div",{className:"p-1.5 md:p-2 bg-blue-100 rounded-lg",children:e.jsx(dn,{className:"h-5 w-5 md:h-6 md:w-6 text-blue-600"})}),e.jsxs("div",{children:[e.jsx(he,{className:"text-lg md:text-xl font-bold text-gray-800",children:"📊 بيانات المبيعات اليومية"}),e.jsxs("p",{className:"text-xs md:text-sm text-gray-600 mt-1 hidden sm:block",children:["إدارة وتتبع مبيعات اليوم - ",new Date().toLocaleDateString("ar-EG")]})]})]}),e.jsx("div",{className:"flex items-center gap-1 md:gap-2",children:e.jsx(c,{variant:"ghost",size:"sm",onClick:h,className:"h-8 w-8 md:h-9 md:w-9",children:e.jsx(kl,{className:"h-4 w-4"})})})]})}),e.jsxs("div",{className:"flex flex-col md:flex-row h-full",dir:"rtl",children:[e.jsxs("div",{className:"w-full md:w-80 lg:w-96 bg-white/50 border-r",children:[e.jsxs("div",{className:"p-3 md:p-4 border-b bg-white/30",children:[e.jsxs("h3",{className:"font-semibold text-gray-800 mb-3 flex items-center gap-2 text-sm md:text-base",children:[e.jsx(Xe,{className:"h-4 w-4 text-green-600"}),"ملخص المبيعات"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 md:gap-3",children:[e.jsxs("div",{className:"bg-blue-50 p-2 md:p-3 rounded-lg text-center",children:[e.jsx("div",{className:"text-lg md:text-xl font-bold text-blue-600",children:ut(o.reduce((x,R)=>x+R.price*R.quantity,0))}),e.jsx("div",{className:"text-xs md:text-sm text-blue-600",children:"إجمالي المبيعات"})]}),e.jsxs("div",{className:"bg-green-50 p-2 md:p-3 rounded-lg text-center",children:[e.jsx("div",{className:"text-lg md:text-xl font-bold text-green-600",children:ut(o.reduce((x,R)=>x+(R.price-(R.wholesalePrice??0))*R.quantity,0))}),e.jsx("div",{className:"text-xs md:text-sm text-green-600",children:"إجمالي الأرباح"})]}),e.jsxs("div",{className:"bg-yellow-50 p-2 md:p-3 rounded-lg text-center",children:[e.jsx("div",{className:"text-lg md:text-xl font-bold text-yellow-600",children:Js(k.length)}),e.jsx("div",{className:"text-xs md:text-sm text-yellow-600",children:"عدد المنتجات"})]}),e.jsxs("div",{className:"bg-purple-50 p-2 md:p-3 rounded-lg text-center",children:[e.jsx("div",{className:"text-lg md:text-xl font-bold text-purple-600",children:Js(o.length)}),e.jsx("div",{className:"text-xs md:text-sm text-purple-600",children:"عدد المبيعات"})]})]}),e.jsxs("div",{className:"relative mb-2",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-1 md:gap-2 text-xs md:text-sm font-semibold text-indigo-700",children:[e.jsx(ps,{className:"h-3 w-3 md:h-4 md:w-4"}),e.jsx(dn,{className:"h-3 w-3 md:h-4 md:w-4"}),e.jsx("span",{children:"تقارير الشهر"})]}),e.jsx(c,{size:"sm",variant:"ghost",onClick:()=>Q(x=>!x),className:"h-6 w-6 p-0 rounded-full",title:ue?"إظهار التقارير":"إخفاء التقارير",children:ue?e.jsx(gn,{className:"h-4 w-4"}):e.jsx(Wl,{className:"h-4 w-4"})})]}),e.jsx("div",{className:ue?"overflow-hidden max-h-0 transition-[max-height] duration-300":"overflow-hidden transition-[max-height] duration-300 max-h-[400px]",children:e.jsxs("div",{className:re?"grid grid-cols-2 gap-2 md:gap-4 filter blur-sm pointer-events-none":"grid grid-cols-2 gap-2 md:gap-4",children:[e.jsxs("div",{className:"bg-indigo-50 p-2 md:p-3 rounded-lg text-center",children:[e.jsx("div",{className:"text-lg md:text-xl font-bold text-indigo-600",children:ut(w)}),e.jsx("div",{className:"text-xs md:text-sm text-indigo-600",children:"مبيعات الشهر"})]}),e.jsxs("div",{className:"bg-pink-50 p-2 md:p-3 rounded-lg text-center",children:[e.jsx("div",{className:"text-lg md:text-xl font-bold text-pink-600",children:ut(_)}),e.jsx("div",{className:"text-xs md:text-sm text-pink-600",children:"أرباح الشهر"})]})]})}),!ue&&re&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center rounded-lg bg-yellow-100/60",children:e.jsxs(c,{size:"sm",variant:"ghost",onClick:async()=>{try{if(await isZeroPlan()){y({title:"الخطة زيرو",description:"التقارير الشهرية غير متاحة في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}catch{}q(!0)},className:"flex items-center gap-2 bg-yellow-200/70 hover:bg-yellow-300 text-yellow-900 px-3 py-2 rounded-xl shadow-md hover:shadow-lg transition-all",title:"عرض تقارير الشهر",children:[e.jsx(tt,{className:"h-5 w-5 md:h-7 md:w-7"}),e.jsx("span",{className:"text-xs md:text-sm",children:"عرض تقارير الشهر"})]})})]})]}),e.jsx("div",{className:"p-3 md:p-4 border-b bg-white/30",children:e.jsxs("h3",{className:"font-semibold text-gray-800 mb-3 flex items-center gap-2 text-sm md:text-base",children:[e.jsx(er,{className:"h-4 w-4 text-indigo-600"}),"إحصائيات المنتجات"]})}),e.jsx("div",{className:"p-3 md:p-4 flex-1 overflow-y-auto hidden md:block",children:e.jsxs("h3",{className:"font-semibold text-gray-800 mb-3 flex items-center gap-2",children:[e.jsx(hn,{className:"h-4 w-4 text-blue-600"}),"نصائح للمبيعات"]})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto transition-all duration-300 ease-in-out scrollbar-thin scrollbar-thumb-blue-300 scrollbar-track-blue-100 hover:scrollbar-thumb-blue-400",children:e.jsxs("div",{className:"p-3 md:p-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 md:mb-6 gap-2",children:[e.jsxs("h2",{className:"text-base md:text-lg font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(Ac,{className:"h-4 w-4 md:h-5 md:w-5 text-blue-600"}),"سجل المبيعات (",o.length," عنصر)"]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs md:text-sm text-gray-600",children:[e.jsx(ps,{className:"h-3 w-3 md:h-4 md:w-4"}),e.jsx("span",{className:"hidden sm:inline",children:new Date().toLocaleDateString("ar-EG")}),e.jsx(As,{className:"h-3 w-3 md:h-4 md:w-4 ml-2"}),e.jsx("span",{children:new Date().toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit"})})]})]}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-3 md:p-4 mb-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("h3",{className:"text-sm md:text-base font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(gt,{className:"h-4 w-4 text-emerald-600"}),"إضافة منتج جديد"]}),e.jsxs(c,{size:"sm",variant:"ghost",className:"h-8",onClick:()=>L(x=>!x),children:[e.jsx(gt,{className:"h-4 w-4 text-emerald-600"}),"إضافة منتج"]})]}),b&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx(V,{htmlFor:"new-product-name",className:"text-xs md:text-sm",children:"اسم المنتج"}),e.jsx(M,{id:"new-product-name",value:u.productName,onChange:x=>g(R=>({...R,productName:x.target.value})),placeholder:"أدخل اسم المنتج"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx(V,{htmlFor:"new-product-price",className:"text-xs md:text-sm",children:"سعر البيع (ج.م)"}),e.jsx(M,{type:"number",id:"new-product-price",value:u.price,onChange:x=>g(R=>({...R,price:x.target.value})),placeholder:"0.00"})]}),e.jsxs("div",{children:[e.jsx(V,{htmlFor:"new-product-wholesale",className:"text-xs md:text-sm",children:"سعر الجملة (ج.م)"}),e.jsx(M,{type:"number",id:"new-product-wholesale",value:u.wholesalePrice||"",onChange:x=>g(R=>({...R,wholesalePrice:x.target.value})),placeholder:"0.00"})]})]}),e.jsxs("div",{children:[e.jsx(V,{htmlFor:"new-product-qty",className:"text-xs md:text-sm",children:"الكمية"}),e.jsx(M,{type:"number",id:"new-product-qty",value:u.quantity,onChange:x=>g(R=>({...R,quantity:x.target.value})),placeholder:"1"})]}),e.jsx(c,{className:"w-full md:w-auto",onClick:Ot,children:"إضافة المنتج"})]})]}),e.jsx("div",{id:"shop-products-section",className:"bg-white rounded-lg border border-gray-200 overflow-hidden mb-4",children:e.jsxs("div",{className:"mb-4",children:[e.jsxs("h3",{className:"text-sm md:text-base font-semibold text-gray-800 mb-2 flex items-center gap-2",children:[e.jsx(er,{className:"h-4 w-4 text-green-600"}),"منتجات المحل"]}),e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(M,{value:ee,onChange:x=>Te(x.target.value),placeholder:"ابحث عن منتج...",className:"h-9 w-full md:w-72 text-sm","aria-label":"البحث عن منتج من منتجات المحل"}),ee&&e.jsx(c,{variant:"ghost",size:"sm",className:"h-9",onClick:()=>Te(""),children:"مسح"})]}),e.jsx("div",{className:"overflow-x-auto border border-gray-200 rounded-lg hidden md:block",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"المنتج"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"سعر البيع"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"سعر الجملة"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"المتاح"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"بيع"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:K.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"px-3 py-3 text-center text-gray-500",children:k.length===0?"لا توجد منتجات بعد، أضف منتجاً من النموذج أعلاه":"لا توجد نتائج مطابقة للبحث"})}):K.map(x=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-3 py-2 font-medium text-gray-900",children:x.name}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:ut(x.sellingPrice)}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:ut(x.wholesalePrice)}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:Js(x.quantity)}),e.jsx("td",{className:"px-3 py-2",children:e.jsxs("div",{className:"flex items-center gap-2 flex-nowrap",children:[e.jsx(M,{value:B[x.id]||"",onChange:R=>z(H=>({...H,[x.id]:R.target.value})),type:"number",placeholder:"عدد القطع للبيع",className:"h-8 w-28 text-sm"}),e.jsx(c,{size:"sm",className:"h-8",onClick:()=>ct(x),children:"بيع"}),e.jsx(M,{value:X[x.id]||"",onChange:R=>F(H=>({...H,[x.id]:R.target.value})),type:"number",placeholder:"عدد للإضافة",className:"h-8 w-28 text-sm"}),e.jsxs("div",{className:"inline-flex items-center gap-2 flex-nowrap",children:[e.jsx(c,{size:"sm",variant:"outline",className:"h-8",onClick:()=>$e(x),children:"إضافة قطع جديدة"}),e.jsx(c,{size:"sm",variant:"destructive",className:"h-8",onClick:()=>It(x),title:"حذف المنتج",children:e.jsx(At,{className:"h-4 w-4"})})]})]})})]},x.id))})]})}),e.jsx("div",{className:"block md:hidden space-y-3",children:K.length===0?e.jsx("div",{className:"text-center text-gray-500 text-sm",children:k.length===0?"لا توجد منتجات بعد، أضف منتجاً من النموذج أعلاه":"لا توجد نتائج مطابقة للبحث"}):K.map(x=>e.jsxs("div",{className:"bg-white rounded-xl p-3 border border-gray-200 shadow-sm",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"font-semibold text-gray-900 text-sm break-words",children:x.name}),e.jsx(c,{size:"sm",variant:"destructive",className:"h-8 min-w-[44px] touch-manipulation",onClick:()=>It(x),title:"حذف المنتج",children:e.jsx(At,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-2 text-xs text-gray-700",children:[e.jsx("div",{className:"text-gray-600",children:"سعر البيع"}),e.jsx("div",{className:"text-right font-medium",children:ut(x.sellingPrice)}),e.jsx("div",{className:"text-gray-600",children:"سعر الجملة"}),e.jsx("div",{className:"text-right font-medium",children:ut(x.wholesalePrice)}),e.jsx("div",{className:"text-gray-600",children:"المتاح"}),e.jsx("div",{className:"text-right font-medium",children:Js(x.quantity)})]}),e.jsxs("div",{className:"mt-3 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(M,{value:B[x.id]||"",onChange:R=>z(H=>({...H,[x.id]:R.target.value})),type:"number",placeholder:"عدد القطع للبيع",className:"h-9 flex-1 text-sm","aria-label":`عدد القطع للبيع لـ ${x.name}`}),e.jsx(c,{size:"sm",className:"h-9 min-w-[64px]",onClick:()=>ct(x),children:"بيع"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(M,{value:X[x.id]||"",onChange:R=>F(H=>({...H,[x.id]:R.target.value})),type:"number",placeholder:"عدد للإضافة",className:"h-9 flex-1 text-sm","aria-label":`عدد القطع للإضافة لـ ${x.name}`}),e.jsx(c,{size:"sm",variant:"outline",className:"h-9 min-w-[64px]",onClick:()=>$e(x),children:"إضافة"})]})]})]},x.id))})]})}),o.length===0?e.jsxs("div",{className:"text-center py-8 md:py-12",children:[e.jsx("div",{className:"w-16 h-16 md:w-24 md:h-24 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center",children:e.jsx(er,{className:"h-8 w-8 md:h-12 md:w-12 text-gray-400"})}),e.jsx("h3",{className:"text-base md:text-lg font-medium text-gray-900 mb-2",children:"لا توجد مبيعات اليوم"}),e.jsx("p",{className:"text-sm text-gray-500",children:"ابدأ ببيع منتج من القائمة أعلاه"})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"block md:hidden",children:e.jsx("div",{className:"max-h-[70vh] overflow-y-auto space-y-3 p-3",children:o.map(x=>e.jsxs("div",{className:"bg-white rounded-xl p-4 border border-gray-200 shadow-sm",children:[e.jsx("div",{className:"mb-3",children:e.jsx("h4",{className:"font-semibold text-gray-900 text-base break-words",children:x.productName})}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-2 text-sm text-gray-700",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Xe,{className:"h-4 w-4 text-blue-600"}),e.jsx("span",{className:"text-gray-600",children:"سعر البيع"})]}),e.jsx("div",{className:"text-right font-medium",children:ut(x.price)}),typeof x.wholesalePrice=="number"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Xe,{className:"h-4 w-4 text-indigo-600"}),e.jsx("span",{className:"text-gray-600",children:"سعر الجملة"})]}),e.jsx("div",{className:"text-right font-medium",children:ut(x.wholesalePrice)})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(er,{className:"h-4 w-4 text-emerald-600"}),e.jsx("span",{className:"text-gray-600",children:"الكمية"})]}),e.jsx("div",{className:"text-right font-medium",children:Js(x.quantity)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Vs,{className:"h-4 w-4 text-purple-600"}),e.jsx("span",{className:"text-gray-600",children:"الربح"})]}),e.jsx("div",{className:"text-right font-semibold text-purple-700",children:ut(((x.price??0)-(x.wholesalePrice??0))*(x.quantity??0))}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Xe,{className:"h-4 w-4 text-green-600"}),e.jsx("span",{className:"text-gray-600",children:"الإجمالي"})]}),e.jsx("div",{className:"text-right font-bold text-green-700",children:ut(x.price*x.quantity)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ps,{className:"h-4 w-4 text-blue-600"}),e.jsx("span",{className:"text-gray-600",children:"التاريخ"})]}),e.jsx("div",{className:"text-right text-gray-600",children:wl(x.date)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(As,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"text-gray-600",children:"الوقت"})]}),e.jsx("div",{className:"text-right text-gray-600",children:x.time})]})]},x.id))})}),e.jsx("div",{className:"hidden md:block overflow-x-auto max-h-96 overflow-y-auto scrollbar-thin scrollbar-thumb-green-300 scrollbar-track-green-100 hover:scrollbar-thumb-green-400",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"المنتج"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"سعر البيع (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"سعر الجملة (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الكمية"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الإجمالي (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الربح (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"التاريخ"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الوقت"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:o.map((x,R)=>e.jsxs("tr",{className:R%2===0?"bg-white":"bg-gray-50/50",children:[e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-gray-900",children:x.productName}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:ut(x.price)}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:typeof x.wholesalePrice=="number"?ut(x.wholesalePrice):"-"}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:Js(x.quantity)}),e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-green-600",children:ut(x.price*x.quantity)}),e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-purple-600",children:ut(((x.price??0)-(x.wholesalePrice??0))*(x.quantity??0))}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-500",children:wl(x.date)}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-500",children:x.time})]},x.id))})]})})]}),e.jsxs("div",{className:"mt-4 md:mt-6 text-xs text-gray-500 text-center bg-gray-50/50 p-2 md:p-3 rounded border border-gray-200/40 space-y-1",children:[e.jsx("p",{className:"font-medium text-gray-600",children:"💰 نظام إدارة المبيعات اليومية"}),e.jsxs("p",{className:"hidden sm:block",children:["• يتم حفظ البيانات تلقائياً لليوم الحالي: ",new Date().toLocaleDateString("ar-EG")]}),e.jsx("p",{children:"• يمكنك إضافة وتعديل وحذف المنتجات حسب الحاجة"}),e.jsx("p",{className:"hidden sm:block",children:"• يتم حفظ البيانات محلياً وعلى Firebase لتعزيز الأمان"})]})]})})]})]}),e.jsx(Ts,{open:P,onOpenChange:q,mode:"verify",title:"قفل إحصائيات الشهر",description:"لا يمكن الاطلاع على تقارير الشهر إلا بإدخال الرقم السري الرئيسي",onSuccess:async()=>{try{const x=m==null?void 0:m.uid;if(x){const R=await un(x),H=(R==null?void 0:R.planType)??(R==null?void 0:R.plan)??null,ve=typeof H=="string"?H.toLowerCase():null;if(H===ns.ZERO||ve==="zero"){y({title:"الخطة زيرو",description:"التقارير الشهرية غير متاحة في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}}catch{}ne(!1),q(!1),nt()}})]})}const Js=l=>new Intl.NumberFormat("ar-EG").format(Number(l||0)),ut=l=>`${new Intl.NumberFormat("ar-EG",{minimumFractionDigits:2,maximumFractionDigits:2}).format(Number(l||0))} ج.م`,wl=l=>{try{const h=new Date(l);return isNaN(h.getTime())?new Date(`${l}T00:00:00`).toLocaleDateString("ar-EG"):h.toLocaleDateString("ar-EG")}catch{return l}};function _l({size:l=24,className:h,...o}){return e.jsxs("svg",{width:l,height:l,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",className:h,...o,children:[e.jsx("rect",{x:"5",y:"2.5",width:"14",height:"19",rx:"2.5",stroke:"currentColor",strokeWidth:"1.5"}),e.jsx("rect",{x:"7",y:"4.5",width:"10",height:"5.5",rx:"1",stroke:"currentColor",strokeWidth:"1.2"}),e.jsx("path",{d:"M9.5 11.5h5",stroke:"currentColor",strokeWidth:"1.4",strokeLinecap:"round"}),e.jsx("circle",{cx:"8.5",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"12",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"15.5",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"8.5",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"12",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"15.5",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("rect",{x:"8",y:"19",width:"9",height:"1.8",rx:"0.6",stroke:"currentColor",strokeWidth:"1"})]})}var zl="AlertDialog",[Vc,ym]=Uo(zl,[Fl]),ms=Fl(),Jl=l=>{const{__scopeAlertDialog:h,...o}=l,t=ms(h);return e.jsx(lc,{...t,...o,modal:!0})};Jl.displayName=zl;var qc="AlertDialogTrigger",Yc=a.forwardRef((l,h)=>{const{__scopeAlertDialog:o,...t}=l,u=ms(o);return e.jsx(ec,{...u,...t,ref:h})});Yc.displayName=qc;var Hc="AlertDialogPortal",Kl=l=>{const{__scopeAlertDialog:h,...o}=l,t=ms(h);return e.jsx(ic,{...t,...o})};Kl.displayName=Hc;var Gc="AlertDialogOverlay",Vl=a.forwardRef((l,h)=>{const{__scopeAlertDialog:o,...t}=l,u=ms(o);return e.jsx(tc,{...u,...t,ref:h})});Vl.displayName=Gc;var Hs="AlertDialogContent",[Qc,Zc]=Vc(Hs),Xc=zo("AlertDialogContent"),ql=a.forwardRef((l,h)=>{const{__scopeAlertDialog:o,children:t,...u}=l,g=ms(o),b=a.useRef(null),L=Al(h,b),y=a.useRef(null);return e.jsx(sc,{contentName:Hs,titleName:Yl,docsSlug:"alert-dialog",children:e.jsx(Qc,{scope:o,cancelRef:y,children:e.jsxs(ac,{role:"alertdialog",...g,...u,ref:L,onOpenAutoFocus:_o(u.onOpenAutoFocus,m=>{var p;m.preventDefault(),(p=y.current)==null||p.focus({preventScroll:!0})}),onPointerDownOutside:m=>m.preventDefault(),onInteractOutside:m=>m.preventDefault(),children:[e.jsx(Xc,{children:t}),e.jsx(td,{contentRef:b})]})})})});ql.displayName=Hs;var Yl="AlertDialogTitle",Hl=a.forwardRef((l,h)=>{const{__scopeAlertDialog:o,...t}=l,u=ms(o);return e.jsx(rc,{...u,...t,ref:h})});Hl.displayName=Yl;var Gl="AlertDialogDescription",Ql=a.forwardRef((l,h)=>{const{__scopeAlertDialog:o,...t}=l,u=ms(o);return e.jsx(nc,{...u,...t,ref:h})});Ql.displayName=Gl;var ed="AlertDialogAction",Zl=a.forwardRef((l,h)=>{const{__scopeAlertDialog:o,...t}=l,u=ms(o);return e.jsx(El,{...u,...t,ref:h})});Zl.displayName=ed;var Xl="AlertDialogCancel",ei=a.forwardRef((l,h)=>{const{__scopeAlertDialog:o,...t}=l,{cancelRef:u}=Zc(Xl,o),g=ms(o),b=Al(h,u);return e.jsx(El,{...g,...t,ref:b})});ei.displayName=Xl;var td=({contentRef:l})=>{const h=`\`${Hs}\` requires a description for the component to be accessible for screen reader users.

You can add a description to the \`${Hs}\` by passing a \`${Gl}\` component as a child, which also benefits sighted users by adding visible context to the dialog.

Alternatively, you can use your own component as a description by assigning it an \`id\` and passing the same value to the \`aria-describedby\` prop in \`${Hs}\`. If the description is confusing or duplicative for sighted users, you can use the \`@radix-ui/react-visually-hidden\` primitive as a wrapper around your description component.

For more information, see https://radix-ui.com/primitives/docs/components/alert-dialog`;return a.useEffect(()=>{var t;document.getElementById((t=l.current)==null?void 0:t.getAttribute("aria-describedby"))||console.warn(h)},[h,l]),null},sd=Jl,ad=Kl,ti=Vl,si=ql,ai=Zl,ri=ei,ni=Hl,li=Ql;const rd=sd,nd=ad,ii=a.forwardRef(({className:l,...h},o)=>e.jsx(ti,{className:Os("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",l),...h,ref:o}));ii.displayName=ti.displayName;const oi=a.forwardRef(({className:l,...h},o)=>e.jsxs(nd,{children:[e.jsx(ii,{}),e.jsx(si,{ref:o,className:Os("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",l),...h})]}));oi.displayName=si.displayName;const ci=({className:l,...h})=>e.jsx("div",{className:Os("flex flex-col space-y-2 text-center sm:text-left",l),...h});ci.displayName="AlertDialogHeader";const di=a.forwardRef(({className:l,...h},o)=>e.jsx(ni,{ref:o,className:Os("text-lg font-semibold",l),...h}));di.displayName=ni.displayName;const mi=a.forwardRef(({className:l,...h},o)=>e.jsx(li,{ref:o,className:Os("text-sm text-muted-foreground",l),...h}));mi.displayName=li.displayName;const xn=a.forwardRef(({className:l,...h},o)=>e.jsx(ai,{ref:o,className:Os(Ol(),l),...h}));xn.displayName=ai.displayName;const hi=a.forwardRef(({className:l,...h},o)=>e.jsx(ri,{ref:o,className:Os(Ol({variant:"outline"}),"mt-2 sm:mt-0",l),...h}));hi.displayName=ri.displayName;const Fe=l=>{try{return l.toLocaleString("en-US",{maximumFractionDigits:2})}catch{return String(l)}},Sl=l=>{try{return(l?new Date(l):new Date).toLocaleString("en-GB",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}catch{return new Date().toISOString()}},tr="machine_daily_opening_values",Dl="machine_daily_receipts",Cl="machine_daily_transfer_receipts",on="machine_daily_opening_snapshot";function ld({open:l,onOpenChange:h}){const{toast:o}=Gt(),{shiftUser:t}=or(),[u,g]=a.useState(""),[b,L]=a.useState(""),[y,m]=a.useState(""),[p,k]=a.useState(null),[A,B]=a.useState(null),[z,X]=a.useState(null),[F,w]=a.useState(null),[S,_]=a.useState(!1),[$,P]=a.useState(!1),[q,re]=a.useState(""),[ne,ue]=a.useState(""),[Q,ee]=a.useState(null),[Te,K]=a.useState(()=>{try{const O=localStorage.getItem(Dl),se=O?JSON.parse(O):[];return Array.isArray(se)?se:[]}catch{return[]}}),[ae,Oe]=a.useState(()=>{try{const O=localStorage.getItem(Cl),se=O?JSON.parse(O):[];return Array.isArray(se)?se:[]}catch{return[]}}),[rt,nt]=a.useState(!1),[Se,ct]=a.useState(""),[$e,It]=a.useState(""),[Ot,x]=a.useState(!1),[R,H]=a.useState(null);a.useEffect(()=>{if(l)try{const O=localStorage.getItem(tr);if(O){const J=JSON.parse(O);typeof(J==null?void 0:J.openingBase)=="number"&&k(J.openingBase),typeof(J==null?void 0:J.openingAir)=="number"&&B(J.openingAir),typeof(J==null?void 0:J.drawerCash)=="number"&&X(J.drawerCash)}const se=localStorage.getItem(on);if(se){const J=JSON.parse(se);typeof(J==null?void 0:J.openingBase)=="number"&&typeof(J==null?void 0:J.openingAir)=="number"&&w({openingBase:J.openingBase,openingAir:J.openingAir,drawerCash:J.drawerCash||0})}}catch{}},[l]),a.useEffect(()=>{try{localStorage.setItem(Dl,JSON.stringify(Te))}catch{}},[Te]),a.useEffect(()=>{try{localStorage.setItem(Cl,JSON.stringify(ae))}catch{}},[ae]);const ve=a.useMemo(()=>(t==null?void 0:t.displayName)||(t==null?void 0:t.name)||(t==null?void 0:t.username)||void 0,[t]),oe=a.useMemo(()=>ae.reduce((O,se)=>O+(se.profit||0),0),[ae]),ke=a.useMemo(()=>ae.reduce((O,se)=>O+(se.wholesalePrice||0),0),[ae]),Pe=()=>{ae.length!==0&&(Oe([]),o({title:"تم حذف الإيصالات",description:"تم مسح كل إيصالات التحويل."}))},Ee=()=>{Te.length!==0&&(K([]),o({title:"تم حذف الإيصالات",description:"تم مسح كل إيصالات الماكينة."}))},Tt=O=>{K(se=>se.filter(J=>J.id!==O)),o({title:"تم حذف الإيصال",description:"تم إزالة إيصال الماكينة المحدد."})},Wt=()=>{k(null),B(null),X(null),w(null),g(""),L(""),m("");try{localStorage.removeItem(tr),localStorage.removeItem(on)}catch{}o({title:"تم التصفير",description:"يمكنك الآن إدخال رصيد افتتاحي جديد."})},He=()=>{const O=parseFloat(u||"0"),se=parseFloat(b||"0"),J=parseFloat(y||"0");if(isNaN(O)||isNaN(se)||isNaN(J)){o({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة للرصيد الافتتاحي وفلوس الدرج.",variant:"destructive"});return}if(O<0||se<0||J<0){o({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}k(O),B(se),X(J);try{localStorage.setItem(tr,JSON.stringify({openingBase:O,openingAir:se,drawerCash:J})),localStorage.setItem(on,JSON.stringify({openingBase:O,openingAir:se,drawerCash:J})),w({openingBase:O,openingAir:se,drawerCash:J})}catch{}o({title:"تم تسجيل البيانات",description:`الافتتاحي الأساسي: ${Fe(O)}، الهواء: ${Fe(se)}، فلوس الدرج: ${Fe(J)}`})},I=()=>{if(p==null||A==null){o({title:"سجل الرصيد الافتتاحي أولاً",description:'يرجى الضغط على زر "إضافة" بعد إدخال الافتتاحي.'});return}P(!0)},te=()=>{const O=parseFloat(q||"0"),se=parseFloat(ne||"0");if(isNaN(O)||isNaN(se)){o({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة لرصيد التسليم.",variant:"destructive"});return}if(O<0||se<0){o({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}const J=(F==null?void 0:F.openingBase)??(p||0),De=(F==null?void 0:F.openingAir)??(A||0),we=J+De,Be=O+se-we;ee(Be);const Bt={id:`${Date.now()}`,openingBase:J,openingAir:De,deliveryBase:O,deliveryAir:se,netResult:Be,createdAt:new Date().toISOString(),cashierName:ve,requiredDrawerNoProfit:Be<0?Math.round(-Be*100)/100:0};K(Re=>[Bt,...Re]),o({title:"تم إنشاء إيصال تسليم",description:`الناتج النهائي: ${Fe(Be)}`})},le=()=>{const O=parseFloat(Se||"0"),se=parseFloat($e||"0");if(!Number.isFinite(O)||!Number.isFinite(se)){o({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة لسعر الجملة وسعر التجزئة.",variant:"destructive"});return}if(O<0||se<0){o({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}if(p==null||A==null){o({title:"سجل الرصيد الافتتاحي أولاً",description:'يرجى إدخال الرصيد الأساسي ورصيد الهواء ثم الضغط "إضافة".'});return}const J=Math.round((se-O)*100)/100;H({wholesalePrice:O,retailPrice:se,profit:J}),x(!0)},Ie=O=>{if(!R)return;const se={id:`transfer_${Date.now()}`,wholesalePrice:R.wholesalePrice,retailPrice:R.retailPrice,profit:R.profit,createdAt:new Date().toISOString(),cashierName:ve,deductFrom:O},J=R.wholesalePrice,De=p??0,we=A??0,jt=z??0;if(J>(O==="base"?De:we)){o({title:"رصيد غير كافٍ",description:"لا يوجد رصيد كافٍ للخصم بسعر الجملة.",variant:"destructive"});return}const Bt=O==="base"?Math.round((De-J)*100)/100:De,Re=O==="air"?Math.round((we-J)*100)/100:we,Mt=Math.round((jt+R.retailPrice)*100)/100;k(Bt),B(Re),X(Mt);try{localStorage.setItem(tr,JSON.stringify({openingBase:Bt,openingAir:Re,drawerCash:Mt}))}catch{}Oe(Qt=>[se,...Qt]),nt(!1),ct(""),It(""),H(null),x(!1),o({title:"تم تسجيل تحويل",description:`الربح الفوري: ${Fe(se.profit)} | خصم المخزون: -${Fe(J)} (${O==="base"?"الأساسي":"الهواء"}) | درج: +${Fe(R.retailPrice)}`})},We=()=>{g(""),L(""),P(!1),re(""),ue(""),ee(null)},ze=O=>{O||We(),h(O)};return e.jsxs(ce,{open:l,onOpenChange:ze,children:[e.jsxs(de,{className:"w-[92vw] sm:w-auto sm:max-w-2xl max-h-[85vh] overflow-y-auto",children:[e.jsxs(me,{className:"space-y-2",children:[e.jsx(he,{className:"flex items-center justify-between text-right",children:e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(_l,{className:"h-5 w-5 text-yellow-500"}),"يومية المكنة"]})}),e.jsx(Ut,{className:"text-right",children:'أدخل الرصيد الافتتاحي، ثم في نهاية اليوم قم بإدخال رصيد التسليم لإنشاء إيصال منظم باسم "إيصالات ماكينة".'})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-6",children:[e.jsxs(Ye,{children:[e.jsx(ht,{className:"pb-2",children:e.jsxs(Ct,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-right",children:"الرصيد الافتتاحي"}),e.jsx(c,{variant:"ghost",size:"sm",onClick:()=>_(O=>!O),className:"flex items-center gap-1",children:e.jsx(gn,{className:`h-4 w-4 transition-transform ${S?"rotate-180":""}`})})]})}),e.jsxs("div",{className:"flex items-center justify-between px-6",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(c,{variant:"outline",onClick:()=>nt(!0),disabled:p==null||A==null,className:"border-violet-300 text-violet-700",children:"تحويل"})}),p!=null&&A!=null&&e.jsxs(ot,{className:"bg-violet-100 text-violet-700 border border-violet-200",children:["تم التسجيل: أساسي ",Fe(p)," | هواء ",Fe(A)," | درج ",Fe(z??0)]})]}),e.jsxs(Ze,{className:`space-y-4 ${S?"":"hidden"}`,children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الرصيد الأساسي"}),e.jsx(M,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:u,onChange:O=>g(O.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"رصيد الهواء"}),e.jsx(M,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:b,onChange:O=>L(O.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"فلوس الدرج"}),e.jsx(M,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:y,onChange:O=>m(O.target.value),placeholder:"0.00",className:"text-right"})]})]}),e.jsxs("div",{className:"flex items-center justify-end",children:[e.jsx(c,{variant:"outline",className:"mr-2",onClick:Wt,children:"تصفير"}),e.jsx(c,{onClick:He,className:"bg-violet-600 hover:bg-violet-700",children:"إضافة"})]})]})]}),e.jsxs(Ye,{children:[e.jsx(ht,{className:"pb-2",children:e.jsxs(Ct,{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-right",children:"إيصالات تحويل"}),e.jsxs(ot,{className:"bg-green-100 text-green-700 border border-green-200",children:["ربح: ",Fe(oe)]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(c,{variant:"outline",size:"sm",onClick:Pe,className:"border-red-300 text-red-700 hover:bg-red-50",children:"حذف الإيصالات"}),e.jsx(ar,{className:"h-4 w-4 text-gray-500"})]})]})}),e.jsx(Ze,{className:"space-y-3",children:ae.length===0?e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد تحويلات مسجلة."}):e.jsx("div",{className:"space-y-3 max-h-52 overflow-y-auto pr-1",children:ae.map(O=>e.jsxs("div",{className:"rounded-lg border p-3 grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"سعر الجملة"}),e.jsx("p",{className:"text-sm",children:Fe(O.wholesalePrice)})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"سعر التجزئة"}),e.jsx("p",{className:"text-sm",children:Fe(O.retailPrice)})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"الربح الفوري"}),e.jsx("p",{className:"text-sm text-green-700",children:Fe(O.profit)}),O.deductFrom&&e.jsx("div",{className:"mt-1",children:e.jsxs("span",{className:"text-[11px] bg-violet-100 text-violet-700 border border-violet-200 rounded px-2 py-0.5",children:["الخصم من: ",O.deductFrom==="base"?"الأساسي":"الهواء"]})}),e.jsxs("div",{className:"flex items-center justify-end gap-2 text-xs text-gray-500",children:[e.jsx(ps,{className:"h-3 w-3"}),e.jsx("span",{children:Sl(O.createdAt)}),O.cashierName&&e.jsxs(e.Fragment,{children:[e.jsx(cn,{orientation:"vertical",className:"h-3"}),e.jsxs("span",{children:["الكاشير: ",O.cashierName]})]})]})]})]},O.id))})})]}),e.jsxs(Ye,{children:[e.jsx(ht,{className:"pb-2",children:e.jsx(Ct,{className:"text-right",children:"نهاية اليوم"})}),e.jsx(Ze,{className:"space-y-4",children:$?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الرصيد الأساسي الحالي"}),e.jsx(M,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:q,onChange:O=>re(O.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"رصيد الهواء الحالي"}),e.jsx(M,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:ne,onChange:O=>ue(O.target.value),placeholder:"0.00",className:"text-right"})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(c,{variant:"secondary",onClick:()=>P(!1),children:"إلغاء"}),e.jsx(c,{onClick:te,className:"bg-green-600 hover:bg-green-700",children:"تسليم"})]}),Q!=null&&e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{className:"text-right",children:e.jsxs(ot,{className:Q>=0?"bg-green-100 text-green-700 border border-green-200":"bg-red-100 text-red-700 border border-red-200",children:["الناتج النهائي: ",Fe(Q)]})}),e.jsxs("div",{className:"mt-2 flex items-center justify-end gap-2",children:[e.jsxs(ot,{className:"bg-blue-100 text-blue-700 border border-blue-200",children:["المجموع النهائي: ",Fe(parseFloat(q||"0")+parseFloat(ne||"0"))]}),e.jsxs(ot,{className:"bg-amber-100 text-amber-700 border border-amber-200",children:["مطلوب من الدرج (بدون أرباح): ",Fe(ke)]})]})]})]}):e.jsx("div",{className:"flex justify-end",children:e.jsx(c,{variant:"outline",onClick:I,className:"border-violet-300 text-violet-700",children:"تسليم يومية"})})})]}),e.jsxs(Ye,{children:[e.jsx(ht,{className:"pb-2",children:e.jsxs(Ct,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-right",children:"إيصالات ماكينة"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(c,{variant:"outline",size:"sm",onClick:Ee,className:"border-red-300 text-red-700 hover:bg-red-50",children:"حذف الإيصالات"}),e.jsx(ar,{className:"h-4 w-4 text-gray-500"})]})]})}),e.jsx(Ze,{className:"space-y-3",children:Te.length===0?e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد إيصالات حتى الآن."}):e.jsx("div",{className:"space-y-3",children:Te.map(O=>e.jsxs("div",{className:"rounded-lg border p-3 grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"الافتتاحي"}),e.jsxs("p",{className:"text-sm",children:["أساسي: ",Fe(O.openingBase)]}),e.jsxs("p",{className:"text-sm",children:["هواء: ",Fe(O.openingAir)]})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"التسليم"}),e.jsxs("p",{className:"text-sm",children:["أساسي: ",Fe(O.deliveryBase)]}),e.jsxs("p",{className:"text-sm",children:["هواء: ",Fe(O.deliveryAir)]})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("div",{className:"flex items-center justify-end",children:e.jsxs(c,{variant:"outline",size:"sm",onClick:()=>Tt(O.id),className:"border-red-300 text-red-700 hover:bg-red-50",children:[e.jsx(At,{className:"h-3 w-3 mr-1"})," حذف"]})}),e.jsx("p",{className:"text-xs text-gray-500",children:"النتيجة"}),e.jsx("p",{className:`text-sm ${O.netResult>=0?"text-green-700":"text-red-700"}`,children:Fe(O.netResult)}),e.jsxs("div",{className:"mt-1 flex items-center justify-end gap-2",children:[e.jsxs("span",{className:"text-[11px] bg-blue-100 text-blue-700 border border-blue-200 rounded px-2 py-0.5",children:["المجموع النهائي: ",Fe(O.deliveryBase+O.deliveryAir)]}),typeof O.requiredDrawerNoProfit=="number"&&e.jsxs("span",{className:"text-[11px] bg-amber-100 text-amber-700 border border-amber-200 rounded px-2 py-0.5",children:["مطلوب من الدرج (بدون أرباح): ",Fe(O.requiredDrawerNoProfit||0)]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2 text-xs text-gray-500",children:[e.jsx(ps,{className:"h-3 w-3"}),e.jsx("span",{children:Sl(O.createdAt)}),O.cashierName&&e.jsxs(e.Fragment,{children:[e.jsx(cn,{orientation:"vertical",className:"h-3"}),e.jsxs("span",{children:["الكاشير: ",O.cashierName]})]})]})]})]},O.id))})})]})]}),e.jsxs(Ce,{className:"flex items-center justify-between",children:[e.jsx(c,{variant:"outline",onClick:()=>ze(!1),children:"إغلاق"}),e.jsxs("div",{className:"text-xs text-gray-500 flex items-center gap-1",children:[e.jsx(As,{className:"h-3 w-3"}),e.jsx("span",{children:"يسجل التاريخ والوقت تلقائياً لكل إيصال"})]})]})]}),e.jsx(ce,{open:rt,onOpenChange:nt,children:e.jsxs(de,{className:"sm:max-w-sm",children:[e.jsx(me,{children:e.jsx(he,{children:"تحويل رصيد"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"سعر الجملة"}),e.jsx(M,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:Se,onChange:O=>ct(O.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"سعر التجزئة"}),e.jsx(M,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:$e,onChange:O=>It(O.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsx("div",{className:"text-right",children:e.jsxs(ot,{className:"bg-green-100 text-green-700 border border-green-200",children:["الربح الفوري: ",Fe(parseFloat($e||"0")-parseFloat(Se||"0")||0)]})})]}),e.jsxs(Ce,{className:"flex items-center justify-end gap-2",children:[e.jsx(c,{variant:"secondary",onClick:()=>nt(!1),children:"إلغاء"}),e.jsx(c,{onClick:le,className:"bg-violet-600 hover:bg-violet-700",children:"تحويل"})]})]})}),e.jsx(rd,{open:Ot,onOpenChange:x,children:e.jsxs(oi,{children:[e.jsxs(ci,{children:[e.jsx(di,{children:"اختيار مصدر الخصم"}),e.jsx(mi,{children:"هل يتم الخصم من الرصيد الأساسي أم من رصيد الهواء؟"})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2 mt-4",children:[e.jsx(hi,{onClick:()=>x(!1),children:"رجوع"}),e.jsx(xn,{onClick:()=>Ie("base"),children:"خصم من الأساسي"}),e.jsx(xn,{onClick:()=>Ie("air"),children:"خصم من الهواء"})]})]})})]})}function id(l,h=300){const[o,t]=mt.useState(l);return mt.useEffect(()=>{const u=setTimeout(()=>t(l),h);return()=>clearTimeout(u)},[l,h]),o}const od=({userId:l,transactions:h})=>{const[o,t]=a.useState(!1),[u,g]=a.useState(!1),[b,L]=a.useState(!1),[y,m]=a.useState({monthlyWithdrawalProfit:0,monthlyTransferProfit:0,lastUpdated:new Date}),{userSubscription:p}=ds();a.useEffect(()=>{l&&o&&b&&k()},[l,o,b]);const k=async()=>{if(l)try{const F=Ys.getWithdrawTransferProfits(l);m({monthlyWithdrawalProfit:F.monthlyWithdrawProfit||0,monthlyTransferProfit:F.monthlyTransferProfit||0,lastUpdated:new Date})}catch(F){console.error("Error loading profit data:",F)}},A=F=>`${F.toFixed(2)} ج.م`,B=async()=>{try{const F=(p==null?void 0:p.subscription)||null,w=(F==null?void 0:F.planType)??(F==null?void 0:F.plan)??null,S=typeof w=="string"?w.toLowerCase():null;if(w===ns.ZERO||S==="zero"||S==="0"||w===0)return!0}catch{}try{if(l){const F=await un(l),w=(F==null?void 0:F.planType)??(F==null?void 0:F.plan)??null,S=typeof w=="string"?w.toLowerCase():null;if(w===ns.ZERO||S==="zero"||S==="0"||w===0)return!0}}catch{}return!1},z=async()=>{try{if(await B()){yl({title:"الخطة زيرو",description:"عرض الأرباح الشهرية غير متاح في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}catch{}g(!0)},X=async()=>{try{if(await B()){yl({title:"الخطة زيرو",description:"عرض الأرباح الشهرية غير متاح في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"}),g(!1);return}}catch{}L(!0),t(!0),g(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(c,{size:"sm",variant:"ghost",onClick:z,className:"h-2 w-2 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded transition-all duration-300 hover:scale-110 shadow-sm hover:shadow-md",title:"عرض الأرباح الشهرية",children:e.jsx(tt,{className:"h-1.5 w-1.5"})}),e.jsx(ce,{open:o,onOpenChange:t,children:e.jsxs(de,{className:"max-w-[220px] mx-auto bg-white border border-gray-200 shadow-md rounded sm:max-w-[180px] sm:bg-gradient-to-br sm:from-purple-50 sm:to-white sm:border-2 sm:border-purple-200 sm:shadow-2xl sm:rounded-2xl",children:[e.jsx(me,{className:"text-center pb-0 border-b-0 sm:pb-2 sm:border-b sm:border-purple-200",children:e.jsxs(he,{className:"text-xs font-bold text-purple-800 flex items-center justify-center gap-0 mb-0 leading-tight tracking-tight sm:text-xs sm:gap-1 sm:mb-0 sm:leading-normal sm:tracking-normal",children:[e.jsx(ps,{className:"h-2 w-2 text-purple-600 sm:h-3 sm:w-3"}),"شهري"]})}),e.jsxs("div",{className:"space-y-0 py-0 sm:space-y-2 sm:py-2",children:[e.jsx("div",{className:"bg-yellow-50 p-0.5 rounded border border-yellow-200 sm:bg-gradient-to-r sm:from-yellow-50 sm:to-yellow-100 sm:p-2 sm:rounded-xl sm:shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-[10px] sm:text-xs font-semibold text-yellow-900",children:"أرباح فوري"}),e.jsx("span",{className:"text-[10px] sm:text-xs font-bold text-yellow-900",children:A((y.monthlyWithdrawalProfit??0)+(y.monthlyTransferProfit??0))})]})}),e.jsx("div",{className:"bg-red-50 p-0.5 rounded border border-red-200 sm:bg-gradient-to-r sm:from-red-50 sm:to-red-100 sm:p-2 sm:rounded-xl sm:shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1 sm:gap-2",children:[e.jsx(nr,{className:"h-2 w-2 text-red-600 sm:h-3 sm:w-3"}),e.jsx("span",{className:"text-[10px] sm:text-xs",children:"سحب"})]}),e.jsx("span",{className:"text-[10px] sm:text-xs font-bold text-red-700",children:A(y.monthlyWithdrawalProfit)})]})}),e.jsx("div",{className:"bg-blue-50 p-0.5 rounded border border-blue-200 sm:bg-gradient-to-r sm:from-blue-50 sm:to-blue-100 sm:p-2 sm:rounded-xl sm:shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1 sm:gap-2",children:[e.jsx(Rl,{className:"h-2 w-2 text-blue-600 sm:h-3 sm:w-3"}),e.jsx("span",{className:"text-[10px] sm:text-xs",children:"تحويل"})]}),e.jsx("span",{className:"text-[10px] sm:text-xs font-bold text-blue-700",children:A(y.monthlyTransferProfit)})]})}),e.jsx("div",{className:"bg-purple-50 p-0.5 rounded border border-purple-200 sm:bg-gradient-to-r sm:from-purple-50 sm:to-purple-100 sm:p-2 sm:rounded-xl sm:shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1 sm:gap-2",children:[e.jsx(Xe,{className:"h-2 w-2 text-purple-600 sm:h-3 sm:w-3"}),e.jsx("span",{className:"text-[10px] sm:text-xs",children:"إجمالي"})]}),e.jsx("span",{className:"text-[10px] sm:text-xs font-bold text-purple-700",children:A(y.monthlyWithdrawalProfit+y.monthlyTransferProfit)})]})})]}),!b&&e.jsx("div",{className:"absolute inset-0 bg-yellow-200/70 backdrop-blur-sm flex items-center justify-center rounded sm:rounded-2xl border border-yellow-300 pointer-events-auto",children:e.jsx(c,{size:"sm",variant:"ghost",onClick:()=>g(!0),className:"p-2 bg-yellow-300/80 text-yellow-900 hover:bg-yellow-400/90 rounded-full shadow-sm hover:shadow-md transition-all duration-300",title:"إدخال الرقم السري الرئيسي",children:e.jsx(tt,{className:"h-4 w-4"})})}),e.jsx("div",{className:"flex justify-center pt-0 border-t-0 sm:pt-2 sm:border-t sm:border-purple-200",children:e.jsx(c,{onClick:()=>t(!1),className:"bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-xl text-sm sm:bg-gradient-to-r sm:from-purple-600 sm:to-purple-700 sm:hover:from-purple-700 sm:hover:to-purple-800 sm:px-4 sm:py-1 sm:rounded-xl sm:shadow-lg sm:hover:shadow-xl sm:transition-all sm:duration-300",children:"إغلاق"})})]})}),e.jsx(Ts,{open:u,onOpenChange:g,onSuccess:X,description:"لا يمكن الاطلاع على الأرباح الشهرية إلا بإدخال الرقم السري الرئيسي"})]})},cd=l=>e.jsx(od,{...l});function dd({open:l,onOpenChange:h,onSuccess:o,userId:t}){const[u,g]=a.useState(""),[b,L]=a.useState(""),[y,m]=a.useState(!1),[p,k]=a.useState(!1),[A,B]=a.useState(""),[z,X]=a.useState(!1),{toast:F}=Gt(),w=Ys.hasProfitPin(t),S=()=>{g(""),L(""),B(""),m(!1),k(!1),h(!1)},_=async $=>{$.preventDefault(),B(""),X(!0);try{if(w){if(!Ys.verifyProfitPin(u,t)){B("الرقم السري غير صحيح"),X(!1);return}}else{if(u.length<4){B("يجب أن يكون الرقم السري 4 أرقام على الأقل"),X(!1);return}if(u!==b){B("الرقم السري غير متطابق"),X(!1);return}Ys.setProfitPin(u,t)}F({title:"نجح العملية",description:w?"تم التحقق من الرقم السري بنجاح":"تم إنشاء رقم سري الأرباح بنجاح"}),o(),S()}catch{B("حدث خطأ أثناء معالجة الرقم السري")}finally{X(!1)}};return e.jsx(ce,{open:l,onOpenChange:h,children:e.jsxs(de,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(me,{children:e.jsxs(he,{className:"flex items-center gap-2 text-lg font-semibold",children:[e.jsx(Ps,{className:"h-5 w-5 text-green-600"}),w?"أدخل رقم سري الأرباح":"إنشاء رقم سري للأرباح"]})}),e.jsxs("form",{onSubmit:_,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-gray-600 bg-blue-50 p-3 rounded-lg",children:w?"أدخل الرقم السري لعرض بيانات الأرباح":"قم بإنشاء رقم سري لحماية بيانات الأرباح. يمكنك تغييره لاحقاً من إعدادات البروفيل."}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"pin",children:w?"الرقم السري":"الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(M,{id:"pin",type:y?"text":"password",value:u,onChange:$=>g($.target.value),placeholder:w?"أدخل الرقم السري":"أدخل رقم سري جديد (4 أرقام على الأقل)",className:"pr-10",dir:"ltr",autoComplete:"off",required:!0}),e.jsx(c,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>m(!y),children:y?e.jsx(Pt,{className:"h-4 w-4"}):e.jsx(tt,{className:"h-4 w-4"})})]})]}),!w&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"confirmPin",children:"تأكيد الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(M,{id:"confirmPin",type:p?"text":"password",value:b,onChange:$=>L($.target.value),placeholder:"أعد إدخال الرقم السري",className:"pr-10",dir:"ltr",autoComplete:"off",required:!0}),e.jsx(c,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>k(!p),children:p?e.jsx(Pt,{className:"h-4 w-4"}):e.jsx(tt,{className:"h-4 w-4"})})]})]}),A&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(Ws,{className:"h-4 w-4"}),A]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(c,{type:"submit",disabled:z,className:"flex-1 bg-green-600 hover:bg-green-700",children:[e.jsx(Ps,{className:"h-4 w-4 mr-2"}),z?"جاري المعالجة...":w?"عرض الأرباح":"إنشاء وعرض الأرباح"]}),e.jsx(c,{type:"button",variant:"outline",onClick:S,disabled:z,children:"إلغاء"})]})]})]})})}const md=({userId:l,transactions:h})=>{const[o,t]=a.useState(!1),[u,g]=a.useState(!1),[b,L]=a.useState(!1),[y,m]=a.useState({dailyWithdrawalProfit:0,dailyTransferProfit:0,lastUpdated:new Date});a.useEffect(()=>{l&&o&&b&&p()},[l,o,b]);const p=async()=>{if(l)try{const z=Ys.getWithdrawTransferProfits(l);m({dailyWithdrawalProfit:z.dailyWithdrawProfit||0,dailyTransferProfit:z.dailyTransferProfit||0,lastUpdated:new Date})}catch(z){console.error("Error loading profit data:",z)}},k=z=>`${z.toFixed(2)} ج.م`,A=()=>{Ys.hasProfitPin(l),g(!0)},B=()=>{L(!0),t(!0),g(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(c,{size:"sm",variant:"ghost",onClick:A,className:"h-2 w-2 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded transition-all duration-300 hover:scale-110 shadow-sm hover:shadow-md",title:"عرض الأرباح اليومية",children:e.jsx(tt,{className:"h-1.5 w-1.5"})}),e.jsx(ce,{open:o,onOpenChange:t,children:e.jsxs(de,{className:"max-w-[220px] mx-auto bg-white border border-gray-200 shadow-md rounded sm:max-w-[180px] sm:bg-gradient-to-br sm:from-blue-50 sm:to-white sm:border-2 sm:border-blue-200 sm:shadow-2xl sm:rounded-2xl",children:[e.jsx(me,{className:"text-center pb-0 border-b-0 sm:pb-2 sm:border-b sm:border-blue-200",children:e.jsxs(he,{className:"text-xs font-bold text-blue-800 flex items-center justify-center gap-0 mb-0 leading-tight tracking-tight sm:text-sm sm:gap-1 sm:mb-0 sm:leading-normal sm:tracking-normal",children:[e.jsx(Xe,{className:"h-2 w-2 text-blue-600 sm:h-3 sm:w-3"}),"يومي"]})}),e.jsxs("div",{className:"space-y-0 py-0 sm:space-y-4 sm:py-4",children:[e.jsx("div",{className:"bg-yellow-50 p-2 rounded border border-yellow-200 sm:bg-gradient-to-r sm:from-yellow-50 sm:to-yellow-100 sm:p-4 sm:rounded-xl sm:shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-0 sm:gap-2",children:[e.jsx(Xe,{className:"h-3 w-3 text-yellow-600 sm:h-5 sm:w-5"}),e.jsx("span",{className:"font-medium text-yellow-800 text-xs sm:text-base",children:"أرباح فوري"})]}),e.jsx("span",{className:"font-bold text-sm text-yellow-900 bg-white px-0 py-0.5 rounded text-center sm:text-lg sm:px-3 sm:py-1",children:k((y.dailyWithdrawalProfit??0)+(y.dailyTransferProfit??0))})]})}),e.jsx("div",{className:"bg-red-50 p-2 rounded border border-red-200 sm:bg-gradient-to-r sm:from-red-50 sm:to-red-100 sm:p-4 sm:rounded-xl sm:shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-0 sm:gap-2",children:[e.jsx(nr,{className:"h-3 w-3 text-red-600 sm:h-5 sm:w-5"}),e.jsx("span",{className:"font-medium text-red-800 text-xs sm:text-base",children:"سحب"})]}),e.jsx("span",{className:"font-bold text-sm text-red-900 bg-white px-0 py-0.5 rounded text-center sm:text-lg sm:px-3 sm:py-1",children:k(y.dailyWithdrawalProfit)})]})}),e.jsx("div",{className:"bg-green-50 p-0.5 rounded border border-green-200 sm:bg-gradient-to-r sm:from-green-50 sm:to-green-100 sm:p-2 sm:rounded-xl sm:shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between h-4 sm:h-auto",children:[e.jsxs("div",{className:"flex items-center gap-0 sm:gap-1",children:[e.jsx(Rl,{className:"h-2 w-2 text-green-600 sm:h-3 sm:w-3"}),e.jsx("span",{className:"font-medium text-green-800 text-xs leading-tight tracking-tighter sm:font-semibold sm:text-xs sm:leading-normal sm:tracking-normal",children:"تحويل"})]}),e.jsx("span",{className:"font-bold text-xs text-green-900 bg-white px-0 py-0 rounded text-center leading-tight tracking-tighter sm:text-sm sm:px-2 sm:py-0.5 sm:leading-normal sm:tracking-normal",children:k(y.dailyTransferProfit)})]})}),e.jsx("div",{className:"bg-blue-50 p-0.5 rounded border border-blue-200 sm:bg-gradient-to-r sm:from-blue-50 sm:to-blue-100 sm:p-2 sm:rounded-xl sm:shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between h-4 sm:h-auto",children:[e.jsxs("div",{className:"flex items-center gap-0 sm:gap-1",children:[e.jsx(Xe,{className:"h-2 w-2 text-blue-600 sm:h-3 sm:w-3"}),e.jsx("span",{className:"font-medium text-blue-800 text-xs leading-tight tracking-tighter sm:font-semibold sm:text-xs sm:leading-normal sm:tracking-normal",children:"مجموع"})]}),e.jsx("span",{className:"font-bold text-xs text-blue-900 bg-white px-0 py-0 rounded text-center leading-tight tracking-tighter sm:text-sm sm:px-2 sm:py-0.5 sm:leading-normal sm:tracking-normal",children:k(y.dailyWithdrawalProfit+y.dailyTransferProfit)})]})})]}),e.jsx("div",{className:"flex justify-center pt-0 border-t-0 sm:pt-2 sm:border-t sm:border-blue-200",children:e.jsx(c,{onClick:()=>t(!1),className:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-xl text-sm sm:bg-gradient-to-r sm:from-blue-600 sm:to-blue-700 sm:hover:from-blue-700 sm:hover:to-blue-800 sm:px-4 sm:py-1 sm:rounded-xl sm:shadow-lg sm:hover:shadow-xl sm:transition-all sm:duration-300 sm:text-xs",children:"إغلاق"})})]})}),e.jsx(dd,{open:u,onOpenChange:g,onSuccess:B,userId:l})]})},hd=l=>e.jsx(md,{...l}),sr=l=>Number(l||0).toFixed(2),xd=({open:l,onOpenChange:h,userId:o})=>{const{toast:t}=Gt(),[u,g]=mt.useState([]),[b,L]=mt.useState(!1),[y,m]=mt.useState("");mt.useEffect(()=>{(async()=>{if(!(!l||!o))try{L(!0);const B=[...await Pl.getByUser(o)].sort((z,X)=>z.reportDate<X.reportDate?1:-1);g(B)}catch(A){console.error("Failed to load daily archive history:",A),t({title:"فشل تحميل الأرشيف",description:"تعذر تحميل أرشيف التقارير اليومية",variant:"destructive"})}finally{L(!1)}})()},[l,o]);const p=mt.useMemo(()=>{if(!y)return u;const k=y.trim();return u.filter(A=>A.reportDate.includes(k))},[u,y]);return e.jsx(ce,{open:l,onOpenChange:h,children:e.jsxs(de,{className:"sm:max-w-xl",children:[e.jsxs(me,{children:[e.jsx(he,{children:"أرشيف التقارير اليومية"}),e.jsx(Ut,{children:"يعرض جميع الأيام المؤرشفة مع ملخص لكل يوم."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"archive-search",children:"بحث بالتاريخ (YYYY-MM-DD)"}),e.jsx(M,{id:"archive-search",placeholder:"مثال: 2025-10-19",value:y,onChange:k=>m(k.target.value)})]}),e.jsx("div",{className:"mt-3 space-y-2 max-h-[50vh] overflow-auto",children:b?e.jsx("div",{className:"text-sm text-muted-foreground",children:"جاري التحميل..."}):p.length===0?e.jsx("div",{className:"text-sm text-muted-foreground",children:"لا توجد تقارير مؤرشفة حتى الآن"}):p.map(k=>e.jsxs("div",{className:"border rounded-md p-2 bg-gradient-to-r from-white/80 to-blue-50/70",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{className:"font-bold text-blue-800",children:k.reportDate}),e.jsxs("div",{className:"text-xs text-blue-700",children:["عدد المعاملات: ",k.totalTransactions]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-1",children:[e.jsxs("div",{className:"text-xs text-blue-800",children:["إجمالي المبالغ: ",e.jsx("span",{className:"font-semibold",children:sr(k.totalAmount)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["المسحوب: ",e.jsx("span",{className:"font-semibold",children:sr(k.totalWithdrawn)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["المرسل: ",e.jsx("span",{className:"font-semibold",children:sr(k.totalSent)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["الربح: ",e.jsx("span",{className:"font-semibold",children:sr(k.profit)})]})]})]},k.id||`${k.userId}-${k.reportDate}`))}),e.jsx(Ce,{children:e.jsx(c,{variant:"outline",onClick:()=>h(!1),children:"إغلاق"})})]})})},ud=({open:l,onOpenChange:h})=>{var dt;const{shiftUser:o,isShiftActive:t,shiftStartAt:u,setShiftUser:g,startShift:b,endShift:L}=or(),{userSubscription:y,user:m,signIn:p,profile:k}=ds(),{toast:A}=Gt(),[B,z]=a.useState((o==null?void 0:o.name)||""),[X,F]=a.useState((o==null?void 0:o.username)||""),[w,S]=a.useState(""),[_,$]=a.useState(!1),[P,q]=a.useState(null),[re,ne]=a.useState(""),[ue,Q]=a.useState("");a.useState(!1);const[ee,Te]=a.useState(null),[K,ae]=a.useState(""),[Oe,rt]=a.useState(""),[nt,Se]=a.useState(!1),[ct,$e]=a.useState(!1),[It,Ot]=a.useState({totalTransfers:0,totalWithdrawals:0}),[x,R]=a.useState(null),[H,ve]=a.useState(""),[oe,ke]=a.useState(""),[Pe,Ee]=a.useState(0),[Tt,Wt]=a.useState({}),[He,I]=a.useState(0),[te,le]=a.useState(0),[Ie,We]=a.useState({}),[ze,O]=a.useState(""),[se,J]=a.useState(!1),[De,we]=a.useState(()=>{try{const W=localStorage.getItem("cashierUsers");return W?JSON.parse(W):[]}catch{return[]}}),jt=(dt=y==null?void 0:y.subscription)==null?void 0:dt.planType,Be=jt==="yearly"?2:jt==="lifetime"?4:Number.POSITIVE_INFINITY;a.useEffect(()=>{try{localStorage.setItem("cashierUsers",JSON.stringify(De))}catch{}},[De]);const[Bt,Re]=a.useState(!1),[Mt,Qt]=a.useState(""),[Nt,Fs]=a.useState(null),[Es,Gs]=a.useState([]),[Lt,Bs]=a.useState(!1),[lt,Qs]=a.useState(null),[cr,pt]=a.useState(!1),[Zs,Ms]=a.useState(!1),ja=W=>{const xe=(o==null?void 0:o.username)===W;let ft=!1;try{ft=localStorage.getItem("lastHandoverToAdmin")==="true"}catch{}if(xe&&!(xe&&!t&&(ze==="الأدمن الرئيسي"||ft))){A({title:"لا يمكن الحذف",description:"لا يمكنك حذف مستخدم الوردية أثناء كونها نشطة أو قبل تسليمها للأدمن الرئيسي"});return}const Ft=`هل أنت متأكد من حذف المستخدم ${W}؟

هذا الإجراء لا يمكن التراجع عنه.`;window.confirm(Ft)&&(we(Y=>Y.filter(Ls=>Ls.username!==W)),xe&&g(null),A({title:"تم حذف المستخدم",description:W}))},dr=()=>{if(!B.trim()||!X.trim()||!w.trim())return;if(De.length>=Be){A({title:"وصلت الحد الأقصى للمستخدمين",description:`هذه الباقة تسمح بإضافة ${Number.isFinite(Be)?Be:"عدد غير محدود"} كاشير فقط`,variant:"destructive"});return}const W={name:B.trim(),username:X.trim(),password:w.trim()};we(xe=>[W,...xe]),z(""),F(""),S("")},Xs=()=>{$(!0),q(null),Te(null),ae(""),rt("")},xt=async()=>{try{let W=[];try{m!=null&&m.uid&&(W=await Ne.getUserTransactions(m.uid))}catch{}if(!W||W.length===0)try{const be=await Pc({merchantUserId:m==null?void 0:m.uid,limit:200});W=(be==null?void 0:be.transactions)||[]}catch{}const xe=u?new Date(u):null,ft=new Date,Je=be=>{const Ue=be.type,Zt=be.txnType;return Ue==="withdraw"||Ue==="withdrawal"||Ue==="receive"||Zt==="receive"},ye=be=>{const Ue=be.type,Zt=be.txnType;return Ue==="send"||Ue==="transfer"||Zt==="send"},Ft=be=>{if(!be)return null;if(be instanceof Date)return be;try{const Ue=new Date(be);return Number.isNaN(Ue.getTime())?null:Ue}catch{return null}},Y=be=>{const Ue=Ft(be.createdAt||be.created_at||be.timestamp);return!Ue||xe&&Ue<xe?!1:Ue<=ft},Ls=be=>be==="completed"||be==="confirmed",Ge=W.filter(be=>Ls(be.status)&&Y(be)),_t=Ge.filter(be=>Je(be)).reduce((be,Ue)=>{const Zt=Ue.withdrawnAmount??Ue.receivedAmount??Ue.amount??0;return be+(Number(Zt)||0)},0);return{totalTransfers:Ge.filter(be=>ye(be)).reduce((be,Ue)=>{const Zt=Ue.sentAmount??Ue.transferredAmount??Ue.amount??0;return be+(Number(Zt)||0)},0),totalWithdrawals:_t}}catch{return{totalTransfers:0,totalWithdrawals:0}}};a.useEffect(()=>{if(ct){try{const W=localStorage.getItem("shiftInitialReceivedDrawerFunds");W!==null&&ke(W)}catch{}try{const W=localStorage.getItem("shiftInitialReceivedWalletBalancesTotal");if(W!==null){const xe=parseFloat(W);Ee(Number.isFinite(xe)?xe:0)}}catch{}}},[ct]),a.useEffect(()=>{if(!l&&!Lt)return;(async()=>{try{const ft=((m!=null&&m.uid?await Ne.getUserTransactions(m.uid):[])||[]).filter(Je=>(Je==null?void 0:Je.type)==="report"||((Je==null?void 0:Je.title)||"").includes("إيصال تسليم وردية"));ft.sort((Je,ye)=>{const Ft=new Date(Je.createdAt||0).getTime();return new Date(ye.createdAt||0).getTime()-Ft}),Gs(ft)}catch{Gs([])}})()},[l,ct,Lt,m==null?void 0:m.uid]);const ea=async(W,xe,ft)=>{try{let Je=0,ye=0;try{const Y=parseFloat(localStorage.getItem("shiftInitialReceivedDrawerFunds")||"0");Je=Number.isFinite(Y)?Y:0}catch{}try{const Y=parseFloat(localStorage.getItem("shiftInitialReceivedWalletBalancesTotal")||"0");ye=Number.isFinite(Y)?Y:0}catch{}const Ft={id:`shift_receipt_${Date.now()}`,type:"report",senderPhone:(o==null?void 0:o.username)||"cashier",receiverPhone:ze||"admin",amount:0,status:"completed",createdAt:new Date().toISOString(),title:"إيصال تسليم وردية",cashierName:(o==null?void 0:o.name)||(o==null?void 0:o.username)||null,deficit:xe,deficitAmount:xe?ft:0,shiftStartAt:u,receivedDrawerFunds:Je,receivedWalletBalancesTotal:ye,receivedWalletBalances:Tt,deliveredDrawerFunds:He||0,deliveredWalletBalancesTotal:te||0,deliveredWalletBalances:Ie,shiftProfit:Math.round(((He||0)+(te||0)-(Je+ye))*100)/100};m!=null&&m.uid&&await Ne.saveUserTransaction(m.uid,Ft),Gs(Y=>[Ft,...Y||[]])}catch{}};return e.jsxs(e.Fragment,{children:[e.jsx(ce,{open:l,onOpenChange:h,children:e.jsxs(de,{className:"sm:max-w-md",children:[e.jsx(me,{children:e.jsx(he,{children:t?"تسليم الورديه والخروج":"إضافة مستخدم وردية"})}),t?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsx("div",{className:"text-sm",children:"المستخدم الحالي للوردية:"}),e.jsxs("div",{className:"font-semibold text-sm",children:[o==null?void 0:o.name," (",o==null?void 0:o.username,")"]})]}),e.jsx("div",{className:"text-xs text-gray-600",children:'لإنهاء الوردية والخروج، اضغط "تسليم الورديه والخروج" وسيُطلب الرقم السري.'})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-xs text-gray-600",children:'لاستكمال إضافة مستخدم جديد اضغط الزر أسفل "إضافة مستخدم جديد" لفتح النموذج.'}),De.length>0&&e.jsxs("div",{className:"mt-4 border-t pt-3",children:[e.jsx("div",{className:"text-sm font-medium mb-2",children:"المستخدمون المسجلون"}),e.jsx("div",{className:"space-y-2 max-h-48 overflow-auto",children:De.map((W,xe)=>e.jsxs("div",{className:"flex items-center justify-between rounded border px-3 py-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:W.name}),e.jsx("div",{className:"text-xs text-gray-500",children:W.username})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(c,{size:"sm",className:"w-full sm:w-auto",onClick:()=>{Fs(W),Re(!0)},children:"دخول"}),e.jsx(c,{size:"sm",className:"w-full sm:w-auto",variant:"destructive",onClick:()=>ja(W.username),children:"حذف"})]})]},xe))})]})]}),e.jsx(Ce,{className:"flex flex-wrap gap-2 justify-between",children:t?e.jsx("div",{className:"flex flex-wrap gap-2",children:e.jsx(c,{className:"w-full sm:w-auto",variant:"destructive",onClick:Xs,children:"تسليم الورديه والخروج"})}):e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(c,{className:"w-full sm:w-auto",onClick:()=>Ms(!0),children:"إضافة مستخدم جديد"}),e.jsx(c,{className:"w-full sm:w-auto",variant:"outline",onClick:()=>Bs(!0),children:"إيصالات التسليم"})]})})]})}),e.jsx(ce,{open:Zs,onOpenChange:Ms,children:e.jsxs(de,{className:"sm:max-w-md",children:[e.jsx(me,{children:e.jsx(he,{children:"إضافة مستخدم جديد"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(V,{className:"mb-1 block",children:"الاسم"}),e.jsx(M,{value:B,onChange:W=>z(W.target.value),placeholder:"أدخل الاسم"})]}),e.jsxs("div",{children:[e.jsx(V,{className:"mb-1 block",children:"اسم المستخدم"}),e.jsx(M,{value:X,onChange:W=>F(W.target.value),placeholder:"أدخل اسم المستخدم"})]}),e.jsxs("div",{children:[e.jsx(V,{className:"mb-1 block",children:"الرقم السري"}),e.jsx(M,{type:"password",autoComplete:"new-password",value:w,onChange:W=>S(W.target.value),placeholder:"أدخل الرقم السري"})]}),e.jsx("div",{className:"text-xs text-gray-500",children:"المستخدم يمكنه: التحويل، السحب، اختيار المحفظة فقط."})]}),e.jsxs(Ce,{className:"flex gap-2 justify-between",children:[e.jsx(c,{variant:"secondary",onClick:()=>{Ms(!1)},children:"إلغاء"}),e.jsx(c,{onClick:()=>{!B.trim()||!X.trim()||!w.trim()||(dr(),Ms(!1))},children:"حفظ المستخدم"})]})]})}),e.jsx(ce,{open:Lt,onOpenChange:Bs,children:e.jsxs(de,{className:"sm:max-w-lg",children:[e.jsx(me,{children:e.jsx(he,{children:"إيصالات التسليم"})}),Es.length===0?e.jsx("div",{className:"text-xs text-gray-600",children:"لا توجد إيصالات تسليم محفوظة بعد."}):e.jsx("div",{className:"space-y-2 max-h-[60vh] overflow-auto",children:Es.map(W=>e.jsxs("div",{className:"rounded border px-3 py-2 cursor-pointer hover:bg-gray-50",onClick:()=>{Qs(W),pt(!0)},children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm font-semibold",children:new Date(W.createdAt).toLocaleString("ar-EG")}),e.jsxs("div",{className:"text-xs text-gray-500",children:["إلى: ",W.receiverPhone]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-1",children:[e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مسلّمة: ",W.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مسلّمة (إجمالي): ",W.deliveredWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مستلمة: ",W.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مستلمة (إجمالي): ",W.receivedWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مسلّمة: ",W.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مسلّمة (إجمالي): ",W.deliveredWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مستلمة: ",W.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مستلمة (إجمالي): ",W.receivedWalletBalancesTotal??0]}),e.jsxs("div",{className:["text-xs",(W.shiftProfit??(W.deliveredDrawerFunds??0)+(W.deliveredWalletBalancesTotal??0)-(W.receivedDrawerFunds??0)-(W.receivedWalletBalancesTotal??0))>=0?"text-green-700":"text-red-700"].join(" "),children:["أرباح الوردية: ",W.shiftProfit??(W.deliveredDrawerFunds??0)+(W.deliveredWalletBalancesTotal??0)-(W.receivedDrawerFunds??0)-(W.receivedWalletBalancesTotal??0)]})]}),W.deficit&&e.jsxs("div",{className:"text-xs text-red-600 mt-1",children:["عجز: ",W.deficitAmount??0]})]},W.id))}),e.jsx(Ce,{className:"flex gap-2 justify-between",children:e.jsx(c,{variant:"secondary",onClick:()=>Bs(!1),children:"إغلاق"})})]})}),e.jsx(ce,{open:cr,onOpenChange:pt,children:e.jsxs(de,{className:"sm:max-w-md",children:[e.jsx(me,{children:e.jsx(he,{children:"إيصال تسليم وردية"})}),lt?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsxs("div",{className:"text-sm",children:["التاريخ: ",new Date(lt.createdAt).toLocaleString("ar-EG")]}),e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["تم التسليم إلى: ",lt.receiverPhone]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"المستلم عند الدخول"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية: ",lt.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["أرصدة المحافظ (إجمالي): ",lt.receivedWalletBalancesTotal??0]})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"المسلّم عند الخروج"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية: ",lt.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["أرصدة المحافظ (إجمالي): ",lt.deliveredWalletBalancesTotal??0]})]})]}),lt.deficit&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2 text-red-600",children:"عجز"}),e.jsxs("div",{className:"text-xs text-red-600",children:["المبلغ: ",lt.deficitAmount??0]})]}),lt.receivedWalletBalances&&Object.keys(lt.receivedWalletBalances).length>0&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"تفصيل المحافظ المستلمة"}),e.jsx("div",{className:"space-y-1",children:Object.entries(lt.receivedWalletBalances).map(([W,xe])=>e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-gray-600",children:W}),e.jsx("span",{className:"font-semibold",children:xe})]},W))})]}),lt.deliveredWalletBalances&&Object.keys(lt.deliveredWalletBalances).length>0&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"تفصيل المحافظ المسلّمة"}),e.jsx("div",{className:"space-y-1",children:Object.entries(lt.deliveredWalletBalances).map(([W,xe])=>e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-gray-600",children:W}),e.jsx("span",{className:"font-semibold",children:xe})]},W))})]})]}):e.jsx("div",{className:"text-xs text-gray-600",children:"لا يوجد تقرير محدد للعرض."}),e.jsx(Ce,{className:"flex gap-2 justify-between",children:e.jsx(c,{variant:"secondary",onClick:()=>pt(!1),children:"إغلاق"})})]})}),e.jsx(ce,{open:Bt,onOpenChange:Re,children:e.jsxs(de,{className:"sm:max-w-md",children:[e.jsx(me,{children:e.jsx(he,{children:"أدخل الرقم السري للدخول"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm",children:Nt?`${Nt.name} (${Nt.username})`:""}),e.jsx(M,{type:"password",autoComplete:"off",value:Mt,onChange:W=>Qt(W.target.value),placeholder:"أدخل الرقم السري"})]}),e.jsxs(Ce,{className:"flex gap-2 justify-between",children:[e.jsx(c,{variant:"secondary",onClick:()=>{Qt(""),Fs(null),Re(!1)},children:"إلغاء"}),e.jsx(c,{onClick:()=>{if(Nt){if(Mt.trim()!==Nt.password){A({title:"خطأ في الرقم السري",description:"الرقم السري للكاشير غير صحيح",variant:"destructive"});return}g({name:Nt.name,username:Nt.username}),Qt(""),Re(!1),h(!1),b(),J(!0)}},children:"دخول الورديه"})]})]})}),e.jsx(ce,{open:se,onOpenChange:J,children:e.jsxs(de,{className:"sm:max-w-md",children:[e.jsx(me,{children:e.jsx(he,{children:"تسجيل أرصدة البداية والنقدية"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(V,{className:"mb-1 block",children:"الفلوس النقدية المستلمة عند الدخول"}),e.jsx(M,{type:"number",value:oe,onChange:W=>ke(W.target.value),placeholder:"أدخل قيمة النقدية في الدرج عند بداية الورديه"})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(V,{className:"mb-1 block",children:"أرصدة المحافظ المستلمة (إجمالي) عند الدخول"}),e.jsx(M,{type:"number",value:Number.isFinite(Pe)?Pe:0,onChange:W=>{const xe=parseFloat(W.target.value);Ee(Number.isFinite(xe)?xe:0)},placeholder:"أدخل إجمالي أرصدة المحافظ عند بداية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"يمكن إضافة التفصيل لاحقاً إن لزم، المهم تسجيل الإجمالي."})]})]}),e.jsx(Ce,{className:"flex gap-2 justify-between",children:e.jsx(c,{onClick:()=>{const W=parseFloat(oe),xe=Pe,ft=Number.isFinite(W)&&W>=0,Je=Number.isFinite(xe)&&xe>=0;if(!ft||!Je){A({title:"يرجى إدخال قيم صحيحة",description:"أدخل قيمًا رقمية غير سالبة للنقدية ولإجمالي أرصدة المحافظ",variant:"destructive"});return}try{localStorage.setItem("shiftInitialReceivedDrawerFunds",String(W)),localStorage.setItem("shiftInitialReceivedWalletBalancesTotal",String(xe))}catch{}A({title:"تم تسجيل أرصدة البداية",description:"سُجّل إجمالي النقدية وأرصدة المحافظ لبداية الورديه"}),J(!1)},children:"تأكيد وحفظ"})})]})}),e.jsx(ce,{open:_,onOpenChange:W=>{W&&$(!0)},children:e.jsxs(de,{className:"sm:max-w-md",hideClose:!0,disableOutsideClose:!0,disableEscClose:!0,children:[e.jsx(me,{children:e.jsx(he,{children:"تسليم الورديه والخروج"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(c,{variant:P==="toUser"?"default":"secondary",onClick:()=>q("toUser"),children:"تسليم إلى مستخدم آخر"}),e.jsx(c,{variant:P==="toAdmin"?"default":"secondary",onClick:()=>q("toAdmin"),children:"تسليم إلى الأدمن الرئيسي"})]}),P==="toUser"&&e.jsxs("div",{className:"space-y-3",children:[De.length===0?e.jsx("div",{className:"text-sm text-gray-600",children:"لا يوجد مستخدمون مسجلون. قم بإضافة مستخدم أولاً."}):e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"اختر المستخدم الذي سيتسلم الورديه"}),e.jsx("div",{className:"space-y-2 max-h-40 overflow-auto",children:De.map((W,xe)=>e.jsxs("div",{className:`flex items-center justify-between rounded border px-3 py-2 cursor-pointer ${(ee==null?void 0:ee.username)===W.username?"bg-indigo-50 border-indigo-200":""}`,onClick:()=>Te(W),children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:W.name}),e.jsx("div",{className:"text-xs text-gray-500",children:W.username})]}),e.jsx("span",{className:"text-xs text-gray-400",children:"اختيار"})]},xe))})]}),e.jsxs("div",{children:[e.jsx(V,{className:"mb-1 block",children:"كلمة سر المستخدم المحدد"}),e.jsx(M,{type:"password",autoComplete:"off",value:K,onChange:W=>ae(W.target.value),placeholder:"أدخل كلمة السر"})]}),Oe&&e.jsx("div",{className:"text-xs text-red-600",children:Oe})]}),P==="toAdmin"&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm text-gray-600",children:"أدخل كلمة مرور الحساب الرئيسي لتسليم الورديه والخروج إلى الأدمن."}),e.jsx(M,{type:"password",autoComplete:"off",value:re,onChange:W=>ne(W.target.value),placeholder:"كلمة المرور"}),ue&&e.jsx("div",{className:"text-xs text-red-600",children:ue})]})]}),e.jsx(Ce,{className:"flex gap-2 justify-between",children:e.jsx(c,{disabled:nt||!P,onClick:async()=>{if(P){Se(!0);try{const W=await xt();if(P==="toUser"){if(!ee){rt("يرجى اختيار المستخدم أولاً"),Se(!1);return}if(K.trim()!==ee.password){rt("كلمة السر غير صحيحة"),Se(!1);return}L(),g({name:ee.name,username:ee.username}),b(),O(`${ee.name} (${ee.username})`);try{localStorage.setItem("lastHandoverToAdmin","false")}catch{}$(!1),q(null),Te(null),ae(""),rt(""),h(!1),Ot(W),R(null),ve(""),$e(!0)}else if(P==="toAdmin"){Q("");const xe=(m==null?void 0:m.email)||"";if(!xe){Q("لا يوجد بريد للمستخدم الرئيسي للتحقق"),Se(!1);return}const{error:ft}=await p(xe,re);if(ft){Q("كلمة المرور غير صحيحة"),Se(!1);return}L(),g(null);try{localStorage.setItem("lastHandoverToAdmin","true")}catch{}ne(""),$(!1),h(!1),O("الأدمن الرئيسي"),Ot(W),R(null),ve(""),$e(!0)}}catch{rt("حدث خطأ أثناء التسليم، حاول مرة أخرى")}finally{Se(!1)}}},children:"تأكيد التسليم"})})]})}),e.jsx(ce,{open:ct,onOpenChange:$e,children:e.jsxs(de,{className:"sm:max-w-lg",hideClose:!0,disableOutsideClose:!0,disableEscClose:!0,children:[e.jsx(me,{children:e.jsx(he,{children:"تقرير تسليم الورديه والخروج"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsxs("div",{className:"text-sm",children:["تم تسليم الورديه إلى: ",e.jsx("span",{className:"font-semibold",children:ze})]}),u&&e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["بداية الورديه: ",new Date(u).toLocaleString("ar-EG")]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نهاية الورديه: ",new Date().toLocaleString("ar-EG")]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(V,{className:"mb-1 block",children:"الفلوس النقدية المستلمة"}),e.jsx(M,{type:"number",value:oe,readOnly:!0,disabled:!0,placeholder:"قيمة مسجلة عند بداية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"قيمة غير قابلة للتعديل؛ تُسجّل عند الدخول."})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(V,{className:"mb-1 block",children:"أرصدة المحافظ المستلمة (إجمالي)"}),e.jsx(M,{type:"number",value:Pe,readOnly:!0,disabled:!0,placeholder:"إجمالي مسجل عند بداية الورديه"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(V,{className:"mb-1 block",children:"الفلوس النقدية المسلمة"}),e.jsx(M,{type:"number",value:He,onChange:W=>{const xe=parseFloat(W.target.value);I(Number.isFinite(xe)?xe:0)},placeholder:"أدخل قيمة النقدية المسلمة عند نهاية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"ادخال يدوي لقيمة النقدية المسلّمة عند نهاية الورديه"})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(V,{className:"mb-1 block",children:"أرصدة المحافظ المسلمة (إجمالي)"}),e.jsx(M,{type:"number",value:te,onChange:W=>{const xe=parseFloat(W.target.value);le(Number.isFinite(xe)?xe:0)},placeholder:"أدخل إجمالي أرصدة المحافظ المسلّمة"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"يمكنك إدخال الإجمالي يدوياً؛ التفصيل يُحفظ إن لزم"})]})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-1",children:"أرباح الوردية"}),e.jsx("div",{className:["text-sm",(He??0)+(te??0)-((parseFloat(oe||"0")||0)+(Pe??0))>=0?"text-green-700":"text-red-700"].join(" "),children:Math.round(((He??0)+(te??0)-((parseFloat(oe||"0")||0)+(Pe??0)))*100)/100}),e.jsx("div",{className:"text-xs text-gray-600",children:"محسوبة: (المسلّم − المستلم) للنقدية + المحافظ"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"هل يوجد عجز؟"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(c,{variant:x==="no"?"default":"secondary",onClick:()=>R("no"),children:"لا"}),e.jsx(c,{variant:x==="yes"?"default":"secondary",onClick:()=>R("yes"),children:"نعم"})]}),x==="yes"&&e.jsxs("div",{children:[e.jsx(V,{className:"mb-1 block",children:"مبلغ العجز"}),e.jsx(M,{type:"number",value:H,onChange:W=>ve(W.target.value),placeholder:"أدخل مبلغ العجز"})]})]})]}),e.jsx(Ce,{className:"flex gap-2 justify-between",children:e.jsx(c,{onClick:()=>{const W=x==="yes",xe=parseFloat(H)||0;(async()=>await ea(It,W,xe))(),A({title:"تم إضافة إيصال تسليم الورديه",description:"أُضيف الإيصال إلى المعاملات الأخيرة بعنوان إيصال تسليم وردية"}),$e(!1)},children:"تأكيد وحفظ الإيصال"})})]})})]})},gd=({open:l,onOpenChange:h})=>{const{shiftUser:o,endShift:t,setShiftUser:u}=or(),[g,b]=a.useState(""),[L,y]=a.useState(""),[m,p]=a.useState([]);a.useEffect(()=>{try{const A=localStorage.getItem("cashierUsers");p(A?JSON.parse(A):[])}catch{p([])}},[l]);const k=async()=>{if(y(""),!o)return;const A=m.find(B=>B.username===o.username);if(!A){y("لا يوجد مستخدم مطابق لهذه الوردية");return}if(g.trim()!==A.password){y("الرقم السري غير صحيح");return}t(),u(null),b(""),h(!1)};return e.jsx(ce,{open:l,onOpenChange:A=>{b(""),y(""),h(A)},children:e.jsxs(de,{className:"sm:max-w-md",children:[e.jsx(me,{children:e.jsx(he,{children:"بروفيل الوردية"})}),o?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"rounded-lg border p-3 bg-gradient-to-r from-blue-50 to-indigo-50",children:[e.jsx("div",{className:"text-sm font-semibold text-gray-800",children:o.name}),e.jsx("div",{className:"text-xs text-gray-600",children:o.username})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{className:"block",children:"أدخل الرقم السري لتسليم الوردية"}),e.jsx(M,{type:"password",value:g,onChange:A=>b(A.target.value),placeholder:"الرقم السري للمستخدم",dir:"ltr"}),L&&e.jsx("div",{className:"text-red-600 text-xs",children:L})]})]}):e.jsx("div",{className:"text-sm text-gray-600",children:"لا يوجد مستخدم وردية نشط حالياً"}),e.jsxs(Ce,{className:"flex justify-between",children:[e.jsx(c,{variant:"outline",onClick:()=>h(!1),children:"إغلاق"}),e.jsx(c,{onClick:k,disabled:!o,children:"تسليم الوردية"})]})]})})};class Ks{static async processTransfer(h){const{amount:o,currentCashBalance:t,currentWalletBalances:u,wallets:g,selectedWalletId:b}=h;if(o<=0)return{success:!1,newCashBalance:t,newWalletBalances:u,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(b&&!h.skipRemoteLimitsCheck)try{const p=await is.canPerformOperation(b,o,"transfer");if(!p.canPerform)return{success:!1,newCashBalance:t,newWalletBalances:u,message:p.message||"تجاوز حد التحويل المسموح",error:"LIMIT_EXCEEDED"}}catch(p){return console.error("خطأ في التحقق من حدود التحويل:",p),{success:!1,newCashBalance:t,newWalletBalances:u,message:"خطأ في التحقق من حدود التحويل",error:"LIMIT_CHECK_ERROR"}}if(o<=0)return{success:!1,newCashBalance:t,newWalletBalances:u,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(b){const p=Math.max(u[b]||0,0);if(p<o){const k=g.find(A=>A.id===b);return{success:!1,newCashBalance:t,newWalletBalances:u,message:`رصيد غير كافي في المحفظة${k?` ${k.name}`:""}. المتاح: ${p} جنيه، المطلوب: ${o} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"}}}else{const p=Ks.calculateTotalWalletBalance(u);if(p<o)return{success:!1,newCashBalance:t,newWalletBalances:u,message:`رصيد غير كافي في المحافظ. الرصيد المتاح: ${p} جنيه، المبلغ المطلوب: ${o} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"}}const L={...u};if(b){const p=L[b]||0;L[b]=p-o}else{let p=o;for(const k of g){if(p<=0)break;const A=Math.max(L[k.id]||0,0),B=Math.min(A,p);B>0&&(L[k.id]=(L[k.id]||0)-B,p-=B)}}const y=t+o;if(b)try{const p=is.updateUsage(b,o,"transfer");h.nonBlockingUsageUpdate?p.catch(k=>console.error("خطأ في تحديث استخدام المحفظة:",k)):await p}catch(p){console.error("خطأ في تحديث استخدام المحفظة:",p)}let m="تم التحويل بنجاح";if(b){const p=L[b]||0;p<0&&(m=`تم التحويل بنجاح مع تحذير: رصيد محفظة ${b} أصبح ${p} جنيه.`)}return{success:!0,newCashBalance:y,newWalletBalances:L,message:m}}static processDeposit(h){const{amount:o,currentCashBalance:t,currentWalletBalances:u,wallets:g}=h;if(o<=0)return{success:!1,newCashBalance:t,newWalletBalances:u,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};const b=this.calculateTotalWalletBalance(u);if(b<o)return{success:!1,newCashBalance:t,newWalletBalances:u,message:`رصيد غير كافي في المحافظ. الرصيد المتاح: ${b} جنيه، المبلغ المطلوب: ${o} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"};const L=t+o,y={...u};let m=o;const p=g.find(A=>A.isDefault);if(p&&y[p.id]>=m)y[p.id]-=m,m=0;else for(const A of g){if(m<=0)break;const B=y[A.id]||0;if(B>0){const z=Math.min(B,m);y[A.id]=B-z,m-=z}}const k=m>0?`تم الإيداع جزئياً. تم إيداع ${o-m} جنيه في صندوق النقدية`:`تم الإيداع بنجاح. تم إضافة ${o} جنيه إلى صندوق النقدية`;return{success:!0,newCashBalance:L,newWalletBalances:y,message:k}}static async processWithdraw(h){const{amount:o,currentCashBalance:t,currentWalletBalances:u,wallets:g,selectedWalletId:b}=h;if(o<=0)return{success:!1,newCashBalance:t,newWalletBalances:u,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(b&&!h.skipRemoteLimitsCheck)try{const p=await is.canPerformOperation(b,o,"withdraw");if(!p.canPerform)return{success:!1,newCashBalance:t,newWalletBalances:u,message:p.reason||"تم تجاوز الحد المسموح للسحب",error:"LIMIT_EXCEEDED"}}catch(p){return console.error("خطأ في التحقق من حدود السحب:",p),{success:!1,newCashBalance:t,newWalletBalances:u,message:"خطأ في التحقق من حدود السحب",error:"LIMIT_CHECK_ERROR"}}if(t<o)return{success:!1,newCashBalance:t,newWalletBalances:u,message:`رصيد غير كافي في صندوق النقدية. الرصيد المتاح: ${t} جنيه، المبلغ المطلوب: ${o} جنيه`,error:"INSUFFICIENT_CASH_BALANCE"};const L=t-o,y={...u},m=b?g.find(p=>p.id===b):g.find(p=>p.isDefault)||g[0];if(m){const p=y[m.id]||0;y[m.id]=p+o}else return{success:!1,newCashBalance:t,newWalletBalances:u,message:"لا توجد محافظ متاحة لإضافة المبلغ إليها",error:"NO_WALLETS_AVAILABLE"};if(b)try{const p=is.updateUsage(b,o,"withdraw");h.nonBlockingUsageUpdate?p.catch(k=>console.error("خطأ في تحديث استخدام المحفظة:",k)):await p}catch(p){console.error("خطأ في تحديث استخدام المحفظة:",p)}return{success:!0,newCashBalance:L,newWalletBalances:y,message:`تم السحب بنجاح. تم إضافة ${o} جنيه إلى محفظة ${(m==null?void 0:m.name)||""}`}}static validateOperation(h,o){return h<=0?{valid:!1,error:"المبلغ يجب أن يكون أكبر من الصفر"}:!o||o.length===0?{valid:!1,error:"لا توجد محافظ متاحة"}:{valid:!0}}static calculateTotalWalletBalance(h){return Object.values(h).reduce((o,t)=>o+Math.max(t,0),0)}static deductFromWalletsAddToCash(h,o,t,u){return this.processTransfer({amount:h,currentCashBalance:o,currentWalletBalances:t,wallets:u})}static deductFromWalletsAddToCashDeposit(h,o,t,u){return this.processDeposit({amount:h,currentCashBalance:o,currentWalletBalances:t,wallets:u})}static deductFromCashAddToWallets(h,o,t,u){return this.processWithdraw({amount:h,currentCashBalance:o,currentWalletBalances:t,wallets:u})}static applyTransactionResult(h,o,t){h.success&&(o(h.newCashBalance),t(h.newWalletBalances))}static validateTransaction(h,o,t,u){if(h<=0)return{isValid:!1,error:"المبلغ يجب أن يكون أكبر من الصفر"};if(o==="transfer"){const g=this.calculateTotalWalletBalance(u);if(g<h)return{isValid:!1,error:`الرصيد المتاح في المحافظ (${g} جنيه) غير كافي للمبلغ المطلوب (${h} جنيه)`}}else if(o==="withdraw"){if(t<h)return{isValid:!1,error:`الرصيد المتاح في صندوق النقدية (${t} جنيه) غير كافي للمبلغ المطلوب (${h} جنيه)`}}else if(o==="deposit"){const g=this.calculateTotalWalletBalance(u);if(g<h)return{isValid:!1,error:`الرصيد المتاح في المحافظ (${g} جنيه) غير كافي للمبلغ المطلوب (${h} جنيه)`}}return{isValid:!0}}static getDeductionPreview(h,o,t){const u=[];let g=h;for(const b of t){if(g<=0)break;const L=o[b.id]||0,y=Math.min(Math.max(L,0),g);y>0&&(u.push({walletId:b.id,walletName:b.name,currentBalance:L,deductedAmount:y,newBalance:L-y}),g-=y)}return u}}let pa=null;function pd(){const l=window;if(!pa){const h=l.AudioContext||l.webkitAudioContext;pa=new h}return pa.state==="suspended"&&pa.resume(),pa}function fd(l,h,o){const t=o/1e3,u=Math.floor(l.sampleRate*t),g=l.createBuffer(1,u,l.sampleRate),b=g.getChannelData(0);for(let p=0;p<u;p++)b[p]=(Math.random()*2-1)*.6;const L=l.createBufferSource();L.buffer=g;const y=l.createBiquadFilter();y.type="highpass",y.frequency.value=1500,y.Q.value=.7;const m=l.createGain();m.gain.setValueAtTime(1e-4,h),m.gain.exponentialRampToValueAtTime(.4,h+.015),m.gain.exponentialRampToValueAtTime(1e-4,h+t),L.connect(y),y.connect(m),m.connect(l.destination),L.start(h),L.stop(h+t+.01)}function vd(l,h,o,t,u,g="triangle"){const b=l.createOscillator(),L=l.createGain();b.type=g;const y=u/1e3;b.frequency.setValueAtTime(o,h),b.frequency.linearRampToValueAtTime(t,h+y),L.gain.setValueAtTime(1e-4,h),L.gain.exponentialRampToValueAtTime(.25,h+.02),L.gain.exponentialRampToValueAtTime(1e-4,h+y),b.connect(L),L.connect(l.destination),b.start(h),b.stop(h+y+.02)}function yd(){try{const l=pd(),h=l.currentTime;fd(l,h,90),vd(l,h+.12,1900,1100,180,"sawtooth")}catch{}}function bd(l){if(!l)return!1;const o=l.replace(/[^0-9٠-٩]/g,"").replace(/[٠-٩]/g,t=>"0123456789"["٠١٢٣٤٥٦٧٨٩".indexOf(t)]);return/^(010|011|012|015)[0-9]{8}$/.test(o)}const bm=()=>{var ul,gl,pl,fl;console.log("🔥 UserDashboardPage component is loading...");const{toast:l}=Gt(),h=async()=>{var r,i,d;const s="alkaptin678678@gmail.com",n=(i=(r=en.currentUser)==null?void 0:r.email)==null?void 0:i.toLowerCase();if(!n||n!==s){l({title:"قيد التطوير",description:"هذه الميزة غير متاحة حالياً."});return}if(!$a||!Ra||!Ua){l({title:"بيانات ناقصة",description:"أدخل رقم الموبايل، الشركة والمبلغ",variant:"destructive"});return}try{Kn(!0);const v=await((d=en.currentUser)==null?void 0:d.getIdToken()),f=await fetch("/api/topup",{method:"POST",headers:{"Content-Type":"application/json",...v?{Authorization:`Bearer ${v}`}:{}},body:JSON.stringify({phone:$a,countryCode:"EG",operator:Ra,amount:Number(Ua),useLocalAmount:!0})}),j=await f.json().catch(()=>({}));f.ok&&(j!=null&&j.success)?(l({title:"تم الشحن",description:(j==null?void 0:j.message)||"تم تنفيذ عملية الشحن بنجاح"}),La(!1),Un(""),_n(""),zn("")):l({title:"فشل الشحن",description:(j==null?void 0:j.message)||"حدث خطأ أثناء طلب الشحن",variant:"destructive"})}catch(v){console.error("Topup request error:",v),l({title:"خطأ غير متوقع",description:"تعذّر تنفيذ عملية الشحن. حاول لاحقاً.",variant:"destructive"})}finally{Kn(!1)}},{signOut:o,user:t,profile:u}=ds(),g=((t==null?void 0:t.email)||"").toLowerCase()==="vodafonecash00@gmail.com",b=Jo(),L=Il(),{isShiftActive:y,shiftUser:m}=or(),{shopName:p}=Ko(),k=Vo(),[A,B]=a.useState(!1),[z,X]=a.useState(!1);console.log("🔥 UserDashboardPage - user:",t?"exists":"null");const[F,w]=a.useState(!0),[S,_]=a.useState(!0),[$,P]=a.useState(!1),[q,re]=a.useState(!1),[ne,ue]=a.useState(""),[Q,ee]=a.useState(""),[Te,K]=a.useState(""),[ae,Oe]=a.useState([]),[rt,nt]=a.useState(!1),[Se,ct]=a.useState(null),[$e,It]=a.useState("");a.useState(!1);const[Ot,x]=a.useState(!1),[R,H]=a.useState(!1),[ve,oe]=a.useState(!1),[ke,Pe]=a.useState(""),[Ee,Tt]=a.useState(""),[Wt,He]=a.useState([]),[I,te]=a.useState(!1),[le,Ie]=a.useState(0),[We,ze]=a.useState(!1),[O,se]=a.useState(null),[J,De]=a.useState(!1),[we,jt]=a.useState(""),[Be,Bt]=a.useState(""),[Re,Mt]=a.useState(""),[Qt,Nt]=a.useState(!1),[Fs,Es]=a.useState(""),[Gs,Lt]=a.useState(""),[Bs,lt]=a.useState(""),[Qs,cr]=a.useState(""),[pt,Zs]=a.useState(null),[Ms,ja]=a.useState(!1),[dr,Xs]=a.useState(!1),[xt,ea]=a.useState(""),[dt,W]=a.useState(""),[xe,ft]=a.useState(""),Je=s=>{const n="٠١٢٣٤٥٦٧٨٩",r="۰۱۲۳۴۵۶۷۸۹";return(s||"").split("").map(i=>{const d=n.indexOf(i);if(d>-1)return String(d);const v=r.indexOf(i);return v>-1?String(v):i}).join("")},[ye,Ft]=a.useState(()=>{try{const s=localStorage.getItem("commissionMode")||localStorage.getItem("commissionMode_default");return s?s==="add":!0}catch{return!0}}),[Y,Ls]=a.useState("transfer"),[Ge,_t]=a.useState([]),[zt,be]=a.useState("all");a.useEffect(()=>{try{if(localStorage.setItem("commissionMode",ye?"add":"deduct"),t!=null&&t.uid){const s=`commissionMode_${t.uid}`;localStorage.setItem(s,ye?"add":"deduct")}}catch{}},[ye,t==null?void 0:t.uid]),a.useEffect(()=>{try{const s=t!=null&&t.uid?localStorage.getItem(`commissionMode_${t.uid}`):null,n=localStorage.getItem("commissionMode"),r=localStorage.getItem("commissionMode_default"),i=s??n??r;i&&Ft(i==="add")}catch{}},[t==null?void 0:t.uid]);const[Ue,Zt]=a.useState(!1),[xi,jd]=a.useState(null),[G,ta]=a.useState("");a.useEffect(()=>{if(!Qt)return;const s=hs(),n=parseFloat(Re||"0")||0;let r=0;if(Y==="transfer"){if((s==null?void 0:s.defaultTransferCommission)!=null){const d=Number(s.defaultTransferCommission)||0;r=Math.round(d*n/1e3*100)/100}else{const d=dt&&dt.trim()!==""?parseFloat(dt):0;r=Math.max(0,d)}const i=n+r;Lt((i||0).toString())}else{if((s==null?void 0:s.defaultWithdrawCommission)!=null){const d=Number(s.defaultWithdrawCommission)||0;r=Math.round(d*n/1e3*100)/100}else{const d=xt&&xt.trim()!==""?parseFloat(xt):Math.round(n*.01*100)/100;r=Math.max(0,d)}const i=ye?n:Math.max(0,Math.round((n-r)*100)/100);Lt((i||0).toString())}},[Qt,Re,dt,xt,G,ye,Y]);const hs=()=>{var n,r;let s=je.find(i=>i.id===G);if(!s)try{const i=localStorage.getItem(Us());if(i){const d=JSON.parse(i);if(Array.isArray(d)&&d.length>0){const f=localStorage.getItem(`selectedWallet_${(t==null?void 0:t.uid)||"default"}`)||((n=d.find(j=>j.isDefault))==null?void 0:n.id)||((r=d[0])==null?void 0:r.id);s=d.find(j=>j.id===f)}}}catch{}return s};a.useLayoutEffect(()=>{try{const s=`wallets_${(t==null?void 0:t.uid)||"default"}`;let n=localStorage.getItem(s);if(!n){const r=Object.keys(localStorage).find(i=>i.startsWith("wallets_"));r&&(n=localStorage.getItem(r)||null)}if(n){const r=JSON.parse(n);if(Array.isArray(r)&&r.length>0){Xt(r);const i=`selectedWallet_${(t==null?void 0:t.uid)||"default"}`,d=localStorage.getItem(i),v=d&&r.find(f=>f.id===d)||r.find(f=>f.isDefault)||r[0];v&&(ta(v.id),jt(v.phone))}}}catch(s){console.error("تهيئة فورية للمحافظ من التخزين المحلي فشلت:",s)}},[]),a.useEffect(()=>{console.log("🔍 selectedWallet state changed to:",G)},[G]),a.useEffect(()=>{ao()},[]),a.useEffect(()=>{no()},[]);const[je,Xt]=a.useState(()=>{try{const s=Object.keys(localStorage).find(r=>r.startsWith("wallets_")),n=s?localStorage.getItem(s):null;if(n){const r=JSON.parse(n);if(Array.isArray(r))return r}}catch{}return[]}),[ui,Nd]=a.useState(null),[gi,fn]=a.useState(!1),[pi,Na]=a.useState(!1),[fi,vi]=a.useState(null);a.useState([]),a.useState([]);const[yi,sa]=a.useState(!1),[mr,vn]=a.useState("daily"),[bi,yn]=a.useState(!1),[ji,hr]=a.useState(!1),[bn,fs]=a.useState([]),Ni=async s=>{try{const n=Ge.find(i=>i.id===s);if(!n||!t)return;const r=Ge.filter(i=>i.id!==s);_t(r);try{await Ne.removeUserTransaction(t.uid,s),await Za.permanentlyDeleteTransaction(s,t.uid)}catch(i){console.warn("تعذر الحذف النهائي من قواعد البيانات أثناء حذف الإيصال:",i)}try{const i=Qe(),d=Ke(),v=localStorage.getItem(i),f=localStorage.getItem(d);let j=v?parseFloat(v):_e,E=f?JSON.parse(f):{...fe};const T=n.amount||n.transferredAmount||n.withdrawnAmount||n.withdrawnAmountDetailed||0;if(n.type==="send"&&(n.fromWallet||G)){j-=n.commission||0;const U=n.fromWallet||G;E[U]=(E[U]||0)+T}else if(n.type==="withdraw"&&(n.fromWallet||G)){j+=T,j-=n.commission||0;const U=n.fromWallet||G;E[U]=Math.max(0,(E[U]||0)-T)}et(j),Le(E),localStorage.setItem(i,j.toString()),localStorage.setItem(d,JSON.stringify(E));const N={cashBalance:j,walletBalances:E,lastUpdated:new Date().toISOString()},D=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(D,JSON.stringify(N)),t!=null&&t.uid?Ne.updateUserData(t.uid,N).then(()=>{localStorage.removeItem(D),pe(!1)}).catch(U=>{console.warn("تعذر حفظ الأرصدة في Firebase بعد الحذف، تم الاحتفاظ محليًا:",U),pe(!0)}):pe(!0)}catch(i){console.warn("تعذر عكس تأثير الأرصدة بعد الحذف:",i)}try{const i=n.fromWallet||G,d=await is.getWalletLimits(t.uid,i);if(d){const v=n.amount||n.transferredAmount||n.withdrawnAmount||n.withdrawnAmountDetailed||0,f={...d};n.type==="send"?(f.dailyTransferUsed=Math.max(0,(d.dailyTransferUsed||0)-v),f.monthlyTransferUsed=Math.max(0,(d.monthlyTransferUsed||0)-v)):(f.dailyWithdrawUsed=Math.max(0,(d.dailyWithdrawUsed||0)-v),f.monthlyWithdrawUsed=Math.max(0,(d.monthlyWithdrawUsed||0)-v)),await is.updateWalletLimits(t.uid,i,f)}}catch(i){console.warn("تعذر تحديث حدود المحفظة بعد الحذف:",i)}try{Vt.removeTransactionEffects(n,t.uid)}catch(i){console.warn("تعذر تحديث التقارير بعد الحذف:",i)}l({title:"تم الحذف نهائيًا",description:"تم حذف الإيصال نهائيًا وعكس تأثيراته على الأرصدة والحدود والتقارير."}),Na(!1)}catch(n){console.error("خطأ أثناء حذف الإيصال:",n),l({title:"خطأ في حذف الإيصال",description:"حدث خطأ غير متوقع أثناء الحذف.",variant:"destructive"})}},wi=async s=>{try{if(!Ge.find(r=>r.id===s)||!t)return;await qs(Yt(at,"userTransactions",s),{status:"completed",confirmedAt:new Date}),_t(r=>r.map(i=>i.id===s?{...i,status:"completed"}:i)),l({title:"تم الإكمال",description:"تم وسم المعاملة كمكتملة."}),Na(!1)}catch(n){console.error("خطأ أثناء إكمال الإيصال:",n),l({title:"فشل الإكمال",description:"حدث خطأ غير متوقع أثناء تحديث الحالة.",variant:"destructive"})}},[jn,Si]=a.useState(""),Nn=id(jn,300),[wa,wn]=a.useState(""),[Sa,Sn]=a.useState(""),[xs,wd]=a.useState(""),[xr,$s]=a.useState(!1),[Dn,aa]=a.useState(!1),[Di,Da]=a.useState(!1),[vt,ur]=a.useState(null),[Ci,gr]=a.useState(!1),[Ii,Ca]=a.useState(!1),[Ti,Ia]=a.useState(!1),[ki,Ta]=a.useState(!1),[Ai,ka]=a.useState(!1),[Pi,Cn]=a.useState(!0),[ra,Oi]=a.useState(!1),[Wi,Aa]=a.useState(!1),[Fi,In]=a.useState(()=>{try{const s=t!=null&&t.uid?`dailyReportsLockEnabled_${t==null?void 0:t.uid}`:"dailyReportsLockEnabled";return(localStorage.getItem(s)??localStorage.getItem("dailyReportsLockEnabled"))==="true"}catch{return!1}}),[Ei,pr]=a.useState(!1);a.useEffect(()=>{try{const s=t!=null&&t.uid?`dailyReportsLockEnabled_${t==null?void 0:t.uid}`:"dailyReportsLockEnabled",n=localStorage.getItem(s)??localStorage.getItem("dailyReportsLockEnabled");In(n==="true")}catch{}},[t==null?void 0:t.uid]);const[Bi,Pa]=a.useState(!1),[Mi,na]=a.useState(!1),[yt,$t]=a.useState([]),[fr,Tn]=a.useState(""),[vr,kn]=a.useState(""),[yr,An]=a.useState(""),[ge,br]=a.useState(null),[Li,la]=a.useState(!1);a.useState(!1);const[$i,jr]=a.useState(!1),[Pn,Nr]=a.useState(""),[Ri,ia]=a.useState(!1),[Ui,wr]=a.useState(!1),[es,Sr]=a.useState([]),[Dr,On]=a.useState(""),[Cr,Wn]=a.useState(""),[Ir,Fn]=a.useState(""),[En,Bn]=a.useState(""),[_i,Oa]=a.useState(!1),[Tr,kr]=a.useState(null),[kt,oa]=a.useState(null),[Wa,Ar]=a.useState(""),[zi,Rs]=a.useState(!1),[Mn,Fa]=a.useState(0),[Jt,vs]=a.useState(null),[ys,Pr]=a.useState(""),[Me,Ji]=a.useState(null),ts=async s=>{try{const n=JSON.stringify(s);localStorage.setItem(Vn(),n);try{localStorage.setItem(Yn(),n)}catch{}t!=null&&t.uid&&Ne.updateUserData(t.uid,{debts:s}).catch(()=>pe(!0))}catch(n){console.error("خطأ في حفظ الديون:",n)}},Ki=async()=>{try{const s=Vn(),n=Yn(),r=localStorage.getItem(s),i=localStorage.getItem(n),d=f=>{if(!f)return null;try{const j=JSON.parse(f);return Array.isArray(j)?j.map(E=>{var T;return{...E,createdAt:(T=E.createdAt)!=null&&T.toDate?E.createdAt.toDate():new Date(E.createdAt),partialPayments:Array.isArray(E.partialPayments)?E.partialPayments.map(N=>{var D;return{amount:Number(N.amount)||0,paidAt:(D=N.paidAt)!=null&&D.toDate?N.paidAt.toDate():new Date(N.paidAt)}}):[]}}):[]}catch(j){return console.warn("فشل في تحليل ديون localStorage:",j),null}};let v=d(r);if(!v||v.length===0){const f=d(i);if(f&&f.length>0&&(v=f,$t(f),t!=null&&t.uid))try{await ts(f),localStorage.removeItem(n)}catch(j){console.warn("تعذر ترحيل الديون من المفتاح الافتراضي:",j)}}if(v&&v.length>0&&$t(v),t!=null&&t.uid)try{const f=await Xa(Yt(at,"users",t.uid));if(f.exists()){const j=f.data(),E=j.debts&&Array.isArray(j.debts)?j.debts.map(D=>{var U;return{...D,createdAt:(U=D.createdAt)!=null&&U.toDate?D.createdAt.toDate():new Date(D.createdAt),partialPayments:Array.isArray(D.partialPayments)?D.partialPayments.map(C=>{var Z;return{amount:Number(C.amount)||0,paidAt:(Z=C.paidAt)!=null&&Z.toDate?C.paidAt.toDate():new Date(C.paidAt)}}):[]}}):[],T=v&&v.length>0?v:E;$t(T);try{localStorage.setItem(s,JSON.stringify(T))}catch{}(T.length!==E.length||T.some(D=>{const U=E.find(C=>C.id===D.id);return!U||U.amount!==D.amount||U.status!==D.status||(U.paidAmount??0)!==(D.paidAmount??0)}))&&await Ne.updateUserData(t.uid,{debts:T})}else v&&v.length>0&&await Ne.saveUserData(t.uid,{debts:v})}catch(f){console.warn("تعذر تحميل الديون من Firebase، الاعتماد على المحلي:",f)}}catch(s){console.error("خطأ في تحميل الديون:",s)}},Vi=async()=>{if(t!=null&&t.uid){console.log("🔄 إعادة فحص حالة المستخدم...");try{await new Promise(n=>setTimeout(n,500));const s=await Xa(Yt(at,"users",t.uid));if(s.exists()){const r=s.data().isActive===!0,i=await fa.checkTrialValidity(t.uid),d=i.isValid&&!i.isExpired;console.log("📊 حالة المستخدم:",{isActive:r,isOnTrial:d,hoursRemaining:i.hoursRemaining}),w(r||d),te(d),Ie(i.hoursRemaining),ze(i.hasUsedTrial),H(!r&&!d),console.log("✅ تم تحديث حالة المستخدم بنجاح:",{userIsActive:r||d,isOnFreeTrial:d})}}catch(s){console.error("خطأ في إعادة فحص حالة المستخدم:",s)}}},qi=async()=>{console.log("🎉 تم بدء التجربة المجانية، إعادة فحص حالة المستخدم..."),await Vi()},Yi=async()=>{if(t!=null&&t.uid)try{De(!0);const s=await un(t.uid);se(s)}catch(s){console.error("خطأ في جلب بيانات الاشتراك:",s)}finally{De(!1)}};a.useState(!1);const[Hi,Or]=a.useState(!1),[_e,et]=a.useState(0),[fe,Le]=a.useState({}),[Gi,Ln]=a.useState(!1),[Qi,$n]=a.useState(!1),[Zi,Wr]=a.useState(!1),[Xi,Ea]=a.useState(!1),[Rn,Fr]=a.useState(""),[eo,Er]=a.useState(!1),[to,Ba]=a.useState(!1),[Br,Ma]=a.useState(""),[so,La]=a.useState(!1),[$a,Un]=a.useState(""),[Ra,_n]=a.useState(""),[Ua,zn]=a.useState(""),[Jn,Kn]=a.useState(!1),Ke=()=>`walletBalances_${(t==null?void 0:t.uid)||"default"}`,Qe=()=>`cashBalance_${(t==null?void 0:t.uid)||"default"}`,Vn=()=>`debts_${(t==null?void 0:t.uid)||"default"}`,qn=()=>`customers_${(t==null?void 0:t.uid)||"default"}`,Yn=()=>"debts_default",Hn=()=>`shopExpenses_${(t==null?void 0:t.uid)||"default"}`,ao=()=>{try{const s=localStorage.getItem(Hn());if(s){const n=JSON.parse(s);Oe(n.map(r=>({...r,createdAt:new Date(r.createdAt)})))}}catch(s){console.error("خطأ أثناء تحميل مصروفات المحل من التخزين:",s)}},ro=async s=>{try{localStorage.setItem(Hn(),JSON.stringify(s)),Oe(s)}catch(n){console.error("خطأ أثناء حفظ مصروفات المحل في التخزين:",n)}},Gn=()=>`deficiencies_${(t==null?void 0:t.uid)||"default"}`,no=()=>{try{const s=localStorage.getItem(Gn());if(s){const n=JSON.parse(s);He(n.map(r=>({...r,createdAt:new Date(r.createdAt)})))}}catch(s){console.error("خطأ أثناء تحميل النواقص من التخزين:",s)}},Mr=async s=>{try{localStorage.setItem(Gn(),JSON.stringify(s)),He(s)}catch(n){console.error("خطأ أثناء حفظ النواقص في التخزين:",n)}},lo=async s=>{try{localStorage.setItem(qn(),JSON.stringify(s)),Sr(s),t!=null&&t.uid&&await Ne.updateUserData(t.uid,{customers:s})}catch(n){console.error("خطأ أثناء حفظ العملاء في التخزين:",n)}},io=async()=>{try{if(t!=null&&t.uid){const n=await Xa(Yt(at,"users",t.uid));if(n.exists()){const r=n.data();if(r.customers&&Array.isArray(r.customers)){const i=r.customers.map(d=>{var v;return{...d,createdAt:(v=d.createdAt)!=null&&v.toDate?d.createdAt.toDate():new Date(d.createdAt)}});Sr(i);return}}}const s=localStorage.getItem(qn());if(s){const n=JSON.parse(s);Sr(n.map(r=>({...r,createdAt:new Date(r.createdAt)})))}}catch(s){console.error("خطأ أثناء تحميل العملاء من التخزين:",s)}},ca=()=>`transactions_${(t==null?void 0:t.uid)||"default"}`,da=()=>`deletedTransactions_${(t==null?void 0:t.uid)||"default"}`,Us=()=>`wallets_${(t==null?void 0:t.uid)||"default"}`,bs=()=>`selectedWallet_${(t==null?void 0:t.uid)||"default"}`,Lr=()=>{try{const s=Us(),n=localStorage.getItem(s);if(n){const r=JSON.parse(n);if(Array.isArray(r)&&r.length>0)return r}}catch(s){console.warn("loadWalletsFromLocalWithMigration failed:",s)}return null},$r=s=>{try{const n=bs(),r=localStorage.getItem(n);if(r&&s.find(i=>i.id===r))return r}catch{}return null},[Rr,_a]=a.useState(""),[wt,Qn]=a.useState(""),Kt=mt.useMemo(()=>{const s=O;if(!s)return!1;const n=qo(s),r=s.planType??s.plan??null,i=typeof r=="string"?r.toLowerCase():null,d=i==="monthly"||i==="quarterly"||i==="yearly"||i==="lifetime"||r===ns.MONTHLY||r===ns.QUARTERLY||r===ns.YEARLY||r===ns.LIFETIME;return n&&d},[O]),Ae=mt.useMemo(()=>{const s=O;if(!s)return!1;const n=s.planType??s.plan??null,r=typeof n=="string"?n.toLowerCase():null;return n===ns.ZERO||r==="zero"},[O]),oo=()=>{if(!Kt){l({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}B(!0)};a.useState(!1);const[co,mo]=a.useState(!1),[ho,xo]=a.useState(!1),[uo,go]=a.useState(!1),[po,za]=a.useState(!1),[Ja,Ur]=a.useState(""),[_r,zr]=a.useState(""),[Zn,Xn]=a.useState(!1),[fo,Ka]=a.useState(!1),[el,Jr]=a.useState(""),[tl,Kr]=a.useState(""),[sl,al]=a.useState(!1),rl=async()=>{if(t!=null&&t.uid)try{const s=`userData_${t.uid}`,n=localStorage.getItem(s);if(n){const r=JSON.parse(n);console.log("🔄 مزامنة البيانات المحلية مع Firebase...",r);const i={lastSynced:new Date().toISOString()};typeof r.cashBalance=="number"&&(i.cashBalance=r.cashBalance),r.walletBalances&&typeof r.walletBalances=="object"&&(i.walletBalances=r.walletBalances),await Ne.updateUserData(t.uid,i),localStorage.removeItem(s),pe(!1),console.log("✅ تمت المزامنة بنجاح وحذف البيانات المحلية")}else console.log("لا توجد بيانات محلية تحتاج للمزامنة")}catch(s){console.error("❌ فشل في مزامنة البيانات:",s),l({title:"فشل في المزامنة",description:"حدث خطأ أثناء مزامنة البيانات مع الخادم",variant:"destructive"})}},nl=t!=null&&t.uid?`recentTransactionsResetAt:${t.uid}`:null,Vr=mt.useMemo(()=>{if(!nl)return null;try{const s=localStorage.getItem(nl);return s?new Date(s):null}catch{return null}},[t==null?void 0:t.uid]),ll=mt.useMemo(()=>{const s=Ge||[];return Vr?s.filter(n=>new Date(n.createdAt)>=Vr):s},[Ge,Vr]),il=mt.useCallback(()=>{let s=ll;const n=Nn.trim();if(n&&(s=s.filter(r=>r.senderPhone&&r.senderPhone.includes(n)||r.receiverPhone&&r.receiverPhone.includes(n))),wa){const r=new Date(wa);s=s.filter(i=>{const d=new Date(i.createdAt);if(Sa){const[v,f]=Sa.split(":"),j=new Date(r);j.setHours(parseInt(v),parseInt(f),0,0);const E=new Date(j);return E.setHours(E.getHours()+1),d>=j&&d<E}else return d.toDateString()===r.toDateString()})}try{s=[...s].sort((r,i)=>{const d=new Date(r.createdAt||0).getTime();return new Date(i.createdAt||0).getTime()-d})}catch{}return s},[ll,Nn,wa,Sa]),[vo,Va]=a.useState(!1),[ol,qa]=a.useState(""),[yo,Ya]=a.useState(!1),[qr,Yr]=a.useState(""),[bo,pe]=a.useState(!1);je.reduce((s,n)=>s+(fe[n.id]||0),0);const jo=s=>ls.verifyMasterPin(s),Hr=s=>ls.verifyMasterPin(s),Gr=async s=>{try{const n=en.currentUser;if(!n||!n.email)return!1;const r=Zo.credential(n.email,s);return await Xo(n,r),!0}catch(n){return console.error("فشل التحقق من كلمة المرور:",n),!1}};a.useEffect(()=>{if(!(t!=null&&t.uid))return;console.log("🚀 استعادة البيانات من localStorage عند تحميل الصفحة للمستخدم:",t.uid);const s=`walletBalances_${t.uid}`,n=localStorage.getItem(s);if(n)try{const d=JSON.parse(n);console.log("📱 استعادة أرصدة المحافظ من localStorage:",d),Le(d)}catch(d){console.error("خطأ في قراءة أرصدة المحافظ من localStorage:",d)}const r=`cashBalance_${t.uid}`;let i=localStorage.getItem(r);if(!i){const d=`userCashBalance_${t.uid}`,v=localStorage.getItem(d);if(v){i=v;try{localStorage.setItem(r,v),localStorage.removeItem(d)}catch{}}}if(i){const d=parseFloat(i);console.log("💰 استعادة رصيد الدرج النقدي من localStorage:",d),et(d)}},[t==null?void 0:t.uid]);const cl=async()=>{try{if(!G)return;const s=await is.autoResetLimitsIfNeeded(G);Ji(s)}catch(s){console.error("خطأ في جلب حدود المحفظة المختارة:",s)}};a.useEffect(()=>{cl()},[G]),a.useEffect(()=>{const s=n=>{var r;(r=n==null?void 0:n.detail)!=null&&r.walletId&&n.detail.walletId===G&&cl()};return window.addEventListener("walletLimitsUpdated",s),()=>window.removeEventListener("walletLimitsUpdated",s)},[G]),a.useEffect(()=>{if(b.state){if(console.log("Location state:",b.state),b.state.openDebtDialog&&(Ae?l({title:"غير متاح",description:"الديون/الأجل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):na(!0),window.history.replaceState({},document.title)),b.state.openSalesDialog&&(Ae?l({title:"غير متاح",description:"بيانات المبيعات غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ca(!0),window.history.replaceState({},document.title)),b.state.openMaintenanceDialog&&(Ae?l({title:"غير متاح",description:"الصيانة غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ta(!0),window.history.replaceState({},document.title)),b.state.openCreditCardsDialog&&(console.log("Opening credit cards dialog"),Ae?l({title:"غير متاح",description:"كروت الائتمان غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ia(!0),window.history.replaceState({},document.title)),b.state.openShopExpensesDialog&&(Ae?l({title:"غير متاح",description:"مصروفات المحل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):ls.hasMasterPin()?re(!0):P(!0),window.history.replaceState({},document.title)),b.state.openDeficienciesDialog&&(Ae?l({title:"غير متاح",description:"النواقص غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):oe(!0),window.history.replaceState({},document.title)),b.state.openTransactionSection){const s=document.getElementById("transaction-section");s&&s.scrollIntoView({behavior:"smooth"}),b.state.transactionType&&Ls(b.state.transactionType),b.state.startNewTransaction&&(Bt(""),Mt(""),ea(""),W(""),console.log("🔒 Starting new transaction without changing wallet selection")),b.state.focusWalletSelection&&setTimeout(()=>{const n=document.querySelector('[data-testid="wallet-select"]');n&&n.focus()},500),window.history.replaceState({},document.title)}b.state.openCashierShiftModal&&(Kt?B(!0):l({title:"غير متاح",description:"وردية الكاشير متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"}),window.history.replaceState({},document.title)),b.state.openMachineDailyDialog&&(Kt?ka(!0):l({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"}),window.history.replaceState({},document.title))}},[b.state,je]),a.useEffect(()=>{var s;if(t!=null&&t.uid)try{const n=Lr();if(n&&n.length>0){Xt(n);const r=$r(n)||localStorage.getItem(bs()),i=r&&n.find(d=>d.id===r)?r:(s=n[0])==null?void 0:s.id;i&&!G&&ma(i,"localStorageHydration")}}catch(n){console.error("خطأ في تهيئة المحافظ من التخزين المحلي:",n)}},[t==null?void 0:t.uid]),a.useEffect(()=>{b.pathname==="/user/dashboard"&&sessionStorage.getItem("previousPath")==="/user/add-wallet"&&(console.log("🔄 Returned from wallet addition page - reloading wallets"),Ha(),sessionStorage.removeItem("previousPath")),sessionStorage.setItem("previousPath",b.pathname)},[b.pathname,t==null?void 0:t.uid]),a.useEffect(()=>{if(!(t!=null&&t.uid))return;console.log("🔥 Setting up real-time user activation listener for:",t.uid);const s=Yt(at,"users",t.uid),n=Yo(s,r=>{if(r.exists()){const i=r.data(),d=i.isActive===!0;console.log("🔥 Real-time user status update:",{userId:t.uid,isActive:d,subscription:i.subscription}),d&&!F?(console.log("🎉 User activated! Redirecting to dashboard..."),w(!0),H(!1),_(!1)):!d&&F&&(console.log("❌ User deactivated! Showing activation modal..."),w(!1),H(!0))}},r=>{console.error("❌ Error in real-time user listener:",r)});return()=>{console.log("🔥 Cleaning up real-time user listener"),n()}},[t==null?void 0:t.uid,F]),a.useEffect(()=>{if(!(t!=null&&t.uid))return;const s=r=>{const{userId:i}=r.detail;i===t.uid&&(console.log("🎉 Subscription activation event received for current user!"),w(!0),H(!1),_(!1),setTimeout(()=>{console.log("✅ User activation completed - data updated")},1e3))},n=r=>{const{userId:i,isActive:d}=r.detail;i===t.uid&&(console.log("🔄 User subscription update event received:",{userId:i,isActive:d}),d&&!F&&(w(!0),H(!1),_(!1),setTimeout(()=>{console.log("✅ User subscription updated - data refreshed")},1e3)))};return window.addEventListener("subscriptionActivated",s),window.addEventListener("userSubscriptionUpdated",n),()=>{window.removeEventListener("subscriptionActivated",s),window.removeEventListener("userSubscriptionUpdated",n)}},[t==null?void 0:t.uid,F]),a.useEffect(()=>{const s=n=>{var v;const r=n.target,i=(v=r==null?void 0:r.tagName)==null?void 0:v.toLowerCase();if(!(i==="input"||i==="textarea"||i==="select"||((r==null?void 0:r.isContentEditable)??!1))&&!(n.ctrlKey||n.altKey||n.metaKey)&&!n.repeat)switch(n.key){case"1":La(!0);break;case"2":gr(!0);break;case"3":Ae?l({title:"غير متاح",description:"كروت الائتمان غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ia(!0);break;case"4":Kt?B(!0):l({title:"غير متاح",description:"وردية الكاشير متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});break;case"5":Ae?l({title:"غير متاح",description:"بيانات المبيعات غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ca(!0);break;case"6":Ae?l({title:"غير متاح",description:"الديون/الأجل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):na(!0);break;case"7":Ae?l({title:"غير متاح",description:"الصيانة غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ta(!0);break;case"8":Kt?ka(!0):l({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});break;case"9":Ae?l({title:"غير متاح",description:"مصروفات المحل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):ls.hasMasterPin()?re(!0):P(!0);break}};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[Ae,Kt]),a.useEffect(()=>{console.log("🔥 useEffect loadUserData started",{user:t==null?void 0:t.uid,isCheckingActivation:S}),(async()=>{try{if(!(t!=null&&t.uid)){console.log("🔥 No user UID, setting isCheckingActivation to false"),_(!1);return}let i=!1;const d=`userData_${t==null?void 0:t.uid}`,v=localStorage.getItem(d);if(v)try{const N=JSON.parse(v);N.walletBalances&&(Le(N.walletBalances),i=!0,console.log("⚡ تحميل فوري لأرصدة المحافظ من بيانات المستخدم:",N.walletBalances))}catch(N){console.error("خطأ في قراءة بيانات المستخدم من localStorage:",N)}if(!i){const N=localStorage.getItem(Ke());if(N)try{const D=JSON.parse(N);Le(D),i=!0,console.log("⚡ تحميل فوري لأرصدة المحافظ من النسخة الاحتياطية:",D)}catch(D){console.error("خطأ في قراءة أرصدة المحافظ من localStorage:",D)}}if(!i){const D=Object.keys(localStorage).filter(U=>U.startsWith("walletBalances_backup_")).sort().reverse();for(const U of D)try{const C=localStorage.getItem(U);if(C){const Z=JSON.parse(C);Le(Z),i=!0,console.log("⚡ تحميل فوري لأرصدة المحافظ من النسخة الاحتياطية بالتوقيت:",Z);break}}catch(C){console.error("خطأ في قراءة النسخة الاحتياطية:",C);continue}}let f=localStorage.getItem(Qe());if(!f&&(t!=null&&t.uid)){const N=`userCashBalance_${t.uid}`,D=localStorage.getItem(N);if(D){f=D;try{localStorage.setItem(Qe(),D),localStorage.removeItem(N)}catch{}}}f&&(et(parseFloat(f)),console.log("⚡ تحميل فوري لرصيد الدرج النقدي من localStorage:",f));try{const N=await Xa(Yt(at,"users",t.uid));if(N.exists()){const U=N.data().isActive===!0,C=await fa.checkTrialValidity(t.uid),Z=C.isValid&&!C.isExpired;w(U||Z),te(Z),Ie(C.hoursRemaining),ze(C.hasUsedTrial),H(!U&&!Z),console.log("📊 حالة المستخدم:",{isActive:U,isOnTrial:Z,hoursRemaining:C.hoursRemaining,hasUsedTrial:C.hasUsedTrial})}else w(!1),H(!0)}catch(N){console.error("خطأ في فحص حالة تفعيل المستخدم:",N),w(!1),H(!0)}finally{_(!1)}console.log("🔄 بدء تحميل بيانات المستخدم من Firebase...",{userId:t==null?void 0:t.uid});const j=localStorage.getItem(d);let E=!1;if(j)try{const N=JSON.parse(j),D=new Date(N.lastUpdated);(new Date().getTime()-D.getTime())/(1e3*60)<1&&(E=!0,console.log("⚡ توجد تغييرات محلية حديثة (أقل من دقيقة)، تجنب إعادة التحميل من Firebase"),N.walletBalances&&Le(N.walletBalances),N.cashBalance!==void 0&&et(N.cashBalance))}catch(N){console.error("خطأ في قراءة البيانات المحلية:",N)}if(j&&!E)try{const N=JSON.parse(j),D=new Date(N.lastUpdated);(new Date().getTime()-D.getTime())/(1e3*60)>10&&(console.log("🗑️ حذف البيانات المحلية القديمة (أكثر من 10 دقائق)"),localStorage.removeItem(d))}catch(N){console.error("خطأ في حذف البيانات المحلية القديمة:",N)}if(!E&&(t!=null&&t.uid)){const N=await Ne.getUserData(t.uid);if(console.log("📥 البيانات المحملة من Firebase:",N),N){if(N.walletBalances!==void 0&&Object.keys(fe).length===0)console.log("👛 تحميل أرصدة المحافظ:",N.walletBalances),Le(N.walletBalances),localStorage.setItem(Ke(),JSON.stringify(N.walletBalances));else{const D=localStorage.getItem(Ke());if(D)try{const U=JSON.parse(D);console.log("📱 استعادة أرصدة المحافظ من localStorage:",U),Le(U),t!=null&&t.uid?await Ne.updateUserData(t.uid,{walletBalances:U,lastUpdated:new Date().toISOString()}):pe(!0)}catch(U){console.error("خطأ في قراءة أرصدة المحافظ من localStorage:",U);const C={};Le(C),localStorage.setItem(Ke(),JSON.stringify(C)),t!=null&&t.uid?await Ne.updateUserData(t.uid,{walletBalances:C,lastUpdated:new Date().toISOString()}):pe(!0)}else{console.log("⚠️ لا توجد أرصدة محافظ في Firebase أو localStorage، إنشاء أرصدة افتراضية");const U={};Le(U),localStorage.setItem(Ke(),JSON.stringify(U)),t!=null&&t.uid?await Ne.updateUserData(t.uid,{walletBalances:U,lastUpdated:new Date().toISOString()}):pe(!0)}}N.cashBalance!==void 0&&_e===0?(console.log("💰 تحميل رصيد الدرج النقدي:",N.cashBalance),et(N.cashBalance),localStorage.setItem(Qe(),N.cashBalance.toString())):(console.log("⚠️ لا يوجد رصيد درج نقدي، استخدام القيمة الافتراضية: 0"),et(0),localStorage.setItem(Qe(),"0"));try{const D=t!=null&&t.uid?await Za.getDeletedTransactionsByUser(t.uid):[];if(D&&D.length>0)fs(D),console.log("🗑️ تم تحميل المعاملات المحذوفة من Firebase:",D.length);else{const U=localStorage.getItem(da());if(U)try{const C=JSON.parse(U);fs(C),console.log("🗑️ تم تحميل المعاملات المحذوفة من localStorage:",C.length)}catch(C){console.error("خطأ في قراءة المعاملات المحذوفة من localStorage:",C)}}}catch(D){console.error("خطأ في تحميل المعاملات المحذوفة من Firebase:",D);const U=localStorage.getItem(da());if(U)try{const C=JSON.parse(U);fs(C),console.log("🗑️ تم تحميل المعاملات المحذوفة من localStorage (fallback):",C.length)}catch(C){console.error("خطأ في قراءة المعاملات المحذوفة من localStorage:",C)}}}else{console.log("⚠️ لا توجد بيانات مستخدم في Firebase، محاولة استعادة من localStorage");const D=localStorage.getItem(Ke());if(D)try{const C=JSON.parse(D);console.log("📱 استعادة أرصدة المحافظ من localStorage:",C),Le(C)}catch(C){console.error("خطأ في قراءة أرصدة المحافظ من localStorage:",C)}let U=localStorage.getItem(Qe());if(!U&&(t!=null&&t.uid)){const C=`userCashBalance_${t.uid}`,Z=localStorage.getItem(C);if(Z){U=Z;try{localStorage.setItem(Qe(),Z),localStorage.removeItem(C)}catch{}}}U&&(et(parseFloat(U)),console.log("💰 استعادة رصيد الدرج النقدي من localStorage:",U));try{const C=t!=null&&t.uid?await Za.getDeletedTransactionsByUser(t.uid):[];if(C&&C.length>0)fs(C),console.log("🗑️ تم تحميل المعاملات المحذوفة من Firebase:",C.length);else{const Z=localStorage.getItem(da());if(Z)try{const Ve=JSON.parse(Z);fs(Ve),console.log("🗑️ تم تحميل المعاملات المحذوفة من localStorage:",Ve.length)}catch(Ve){console.error("خطأ في قراءة المعاملات المحذوفة من localStorage:",Ve)}}}catch(C){console.error("خطأ في تحميل المعاملات المحذوفة من Firebase:",C);const Z=localStorage.getItem(da());if(Z)try{const Ve=JSON.parse(Z);fs(Ve),console.log("🗑️ تم تحميل المعاملات المحذوفة من localStorage (fallback):",Ve.length)}catch(Ve){console.error("خطأ في قراءة المعاملات المحذوفة من localStorage:",Ve)}}}}console.log("🔄 بدء تحميل المحافظ من Firebase...");try{const N=await gs.getByMerchantId((t==null?void 0:t.uid)||"");if(N&&N.length>0){console.log("✅ تم العثور على محافظ في Firebase:",N.length);const D=N.map(Z=>({id:Z.id,name:Z.label||"محفظة بدون اسم",phone:Z.msisdn,isDefault:!1,monthlyWithdrawalLimit:Z.monthlyWithdrawalLimit??Z.withdrawLimit??2e5,monthlyTransferLimit:Z.monthlyTransferLimit??Z.transferLimit??2e5,defaultTransferCommission:Z.defaultTransferCommission!=null?Number(Z.defaultTransferCommission):null,defaultWithdrawCommission:Z.defaultWithdrawCommission!=null?Number(Z.defaultWithdrawCommission):null}));Xt(D),localStorage.setItem(Us(),JSON.stringify(D));const U=localStorage.getItem(bs());let C=null;U&&D.find(Z=>Z.id===U)?C=D.find(Z=>Z.id===U):C=D[0],C&&(ta(C.id),jt(C.phone)),console.log("🔄 تم تحديث المحافظ من Firebase وحفظها في localStorage")}else{console.log("⚠️ لا توجد محافظ في Firebase، محاولة التحميل من localStorage...");const D=Lr();if(D&&D.length>0)try{console.log("📱 تم العثور على محافظ محلية بعد الهجرة:",D.length),Xt(D);const U=$r(D)||localStorage.getItem(bs());let C=null;U&&D.find(Z=>Z.id===U)?C=D.find(Z=>Z.id===U):C=D.find(Z=>Z.isDefault)||D[0],C&&(ta(C.id),jt(C.phone))}catch(U){console.error("خطأ في معالجة المحافظ بعد الهجرة:",U)}else console.log("⚠️ لا توجد محافظ محلية، لن نقوم بإنشاء محافظ افتراضية."),Xt([])}}catch(N){console.error("خطأ في تحميل المحافظ من Firebase:",N);const D=Lr();if(D&&D.length>0)try{console.log("📱 استخدام المحافظ من localStorage بعد الهجرة:",D.length),Xt(D);const U=$r(D)||localStorage.getItem(bs());let C=null;U&&D.find(Z=>Z.id===U)?C=D.find(Z=>Z.id===U):C=D.find(Z=>Z.isDefault)||D[0],C&&(ta(C.id),jt(C.phone))}catch(U){console.error("خطأ في قراءة المحافظ من localStorage بعد الهجرة:",U),Xt([])}else console.log("⚠️ لا توجد محافظ محلية، لن يتم إنشاء محافظ افتراضية"),Xt([])}const T=t!=null&&t.uid?await Ne.getUserTransactions(t.uid):[];if(T&&T.length>0){console.log("📊 تم تحميل المعاملات من Firebase:",T.length);const N=T.map(C=>({...C,createdAt:new Date(C.createdAt),senderPhone:C.senderMsisdn||C.senderPhone||"",receiverPhone:C.receiverMsisdn||C.receiverPhone||"",type:C.txnType==="send"?"send":C.txnType==="receive"?"withdraw":C.type||"withdraw",status:C.status==="confirmed"?"completed":C.status||"completed"})),D=bn.map(C=>C.id||C.originalTransactionId),U=N.filter(C=>!D.includes(C.id));console.log("✅ تم فلترة المعاملات المحذوفة:",{total:T.length,deleted:D.length,active:U.length}),_t(U)}await rl()}catch(i){console.error("خطأ في تحميل بيانات المستخدم من Firebase:",i);let d=localStorage.getItem(Qe());if(!d&&(t!=null&&t.uid)){const f=`userCashBalance_${t.uid}`,j=localStorage.getItem(f);if(j){d=j;try{localStorage.setItem(Qe(),j),localStorage.removeItem(f)}catch{}}}d&&et(parseFloat(d));const v=localStorage.getItem(Ke());if(v)try{const f=JSON.parse(v);Le(f),console.log("📱 تم استعادة أرصدة المحافظ من localStorage:",f)}catch(f){console.error("خطأ في قراءة أرصدة المحافظ من localStorage:",f)}}})().then(async()=>{await n(),await r()});const n=async()=>{try{for(const i of je)await fc.autoResetLimitsIfNeeded(i.phone)}catch(i){console.error("خطأ في التصفير التلقائي للحدود:",i)}},r=async()=>{try{const i=Vt.getReportsData(t==null?void 0:t.uid);if((i.lastDailyResetDate?Vt.shouldResetDailyReports(i.lastDailyResetDate):!1)&&(t!=null&&t.uid)&&i.lastDailyResetDate){const f=new Date(i.lastDailyResetDate),j=f.toDateString();let E=Ge.filter(st=>new Date(st.createdAt).toDateString()===j&&st.status==="completed");const T=Vt.filterVisibleTransactions(E,"daily",t==null?void 0:t.uid),N=T.length,D=T.reduce((st,St)=>st+St.amount,0),U=T.filter(ha).reduce((st,St)=>{const bt=St.withdrawnAmount!==void 0?St.withdrawnAmount:St.amount;return st+bt},0),C=T.filter(xa).reduce((st,St)=>{const bt=St.sentAmount!==void 0?St.sentAmount:St.amount;return st+bt},0),Z=T.reduce((st,St)=>st+Vt.calculateTransactionProfit(St),0),Ve=new Date(f).toISOString().slice(0,10);await Pl.add({userId:t.uid,reportDate:Ve,totalTransactions:N,totalAmount:Number(D.toFixed(2)),totalWithdrawn:Number(U.toFixed(2)),totalSent:Number(C.toFixed(2)),profit:Number(Z.toFixed(2)),walletId:null}),l({title:"تم أرشفة تقارير اليوم",description:Ve})}const v=Vt.autoResetReportsIfNeeded(t==null?void 0:t.uid);(v.dailyReset||v.monthlyReset)&&console.log("تم التصفير التلقائي:",v)}catch(i){console.error("خطأ في التصفير التلقائي للتقارير:",i)}};Yi(),Ki(),io(),console.log("🔥 useEffect loadUserData completed")},[t==null?void 0:t.uid]);const Ha=async()=>{var s;if(t!=null&&t.uid)try{const n=await gs.getByMerchantId(t.uid);if(n&&n.length>0){const r=n.map(i=>({id:i.id,name:i.label||"محفظة بدون اسم",phone:i.msisdn,isDefault:!1,monthlyWithdrawalLimit:i.monthlyWithdrawalLimit??i.withdrawLimit??2e5,monthlyTransferLimit:i.monthlyTransferLimit??i.transferLimit??2e5,defaultTransferCommission:i.defaultTransferCommission!=null?Number(i.defaultTransferCommission):void 0,defaultWithdrawCommission:i.defaultWithdrawCommission!=null?Number(i.defaultWithdrawCommission):void 0}));if(Xt(r),localStorage.setItem(Us(),JSON.stringify(r)),t!=null&&t.uid){const i=localStorage.getItem(bs());if(!!(G&&r.find(v=>v.id===G)))console.log("🔒 Preserving current wallet selection:",G);else{const f=(i&&r.find(j=>j.id===i)?i:null)||((s=r[0])==null?void 0:s.id);f&&(console.log("🔄 Fixing invalid wallet selection:",f),ma(f))}}console.log("🔄 تم تحديث المحافظ من Firebase:",r.length)}}catch(n){console.error("خطأ في تحميل المحافظ من Firebase:",n)}};a.useEffect(()=>{const s=b.pathname;sessionStorage.getItem("previousPath")==="/user/add-wallet"&&s==="/user/dashboard"&&(console.log("🔄 Returning from add wallet page - reloading wallets"),console.log("🔒 Current wallet before add-wallet return reload:",G),Ha(),sessionStorage.removeItem("previousPath")),sessionStorage.setItem("previousPath",s)},[b.pathname,t==null?void 0:t.uid]),a.useEffect(()=>{const s=()=>{console.log("🔄 Window focused - reloading wallets"),console.log("🔒 Current wallet before focus reload:",G),Ha().then(()=>{console.log("🔒 Wallet preserved after focus reload:",G)})};return window.addEventListener("focus",s),()=>{window.removeEventListener("focus",s)}},[t==null?void 0:t.uid,G,je]);const ma=(s,n="unknown")=>{console.log(`🎯 setWalletSelection called from ${n} with walletId:`,s),console.log("🔍 Previous selectedWallet:",G),ta(s);const r=je.find(i=>i.id===s);r&&(jt(r.phone),console.log("✅ Wallet set successfully:",s,"Phone:",r.phone)),t!=null&&t.uid&&(localStorage.setItem(bs(),s),console.log("💾 Saved wallet to localStorage:",s))},No=s=>{if(s==="__add_wallet"){L("/user/add-wallet");return}if(s==="__view_wallets"){Xs(!0);return}ma(s,"handleWalletChange")},dl=s=>{console.log("🔄 handleTransactionTypeChange called with type:",s),console.log("🔍 Current selectedWallet before change:",G),console.log("🔍 Available wallets count:",je.length),Ls(s),Bt(""),Mt(""),ea(""),W(""),console.log("✅ Transaction type changed to:",s,"- Wallet selection preserved:",G),setTimeout(()=>{const n=document.getElementById("transaction-section");n&&n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})},100)},wo=s=>{vi((r=>({id:r.id,type:r.type==="send"?"transfer":"withdraw",sender_msisdn:r.senderPhone,receiver_msisdn:r.receiverPhone,amount:r.amount,commission:r.commission||0,fee:(r==null?void 0:r.fee)??0,status:r.status==="failed"?"failed":r.status==="completed"?"completed":"pending",createdAt:new Date(r.createdAt).toISOString(),updatedAt:new Date(r.createdAt).toISOString(),shopName:p??(u==null?void 0:u.shopName)??(t==null?void 0:t.displayName)??"المحل",cashierName:(r==null?void 0:r.cashierName)??null,commissionMode:(r==null?void 0:r.commissionMode)??(r.type==="send"||ye?"add":"deduct"),totalCharged:(r==null?void 0:r.totalCharged)??(r.type==="send"?Number(r.amount||0)+Number(r.commission||0)+Number((r==null?void 0:r.fee)||0):ye?Number(r.amount||0)+Number(r.commission||0):Number(r.amount||0))}))(s)),Na(!0)},So=async s=>{if(!(t!=null&&t.uid)){l({title:"خطأ في المصادقة",description:"يجب تسجيل الدخول أولاً لحذف المعاملات",variant:"destructive"});return}const n=Ge.find(r=>r.id===s);if(!n){l({title:"خطأ في الحذف",description:"لم يتم العثور على المعاملة المطلوب حذفها",variant:"destructive"});return}try{console.log("🗑️ بدء عملية حذف المعاملة:",s),console.log("🔄 حذف المعاملة نهائياً من Firebase...",{transactionId:n.id,userId:t.uid,transactionData:n}),await Ne.removeUserTransaction(t.uid,n.id),console.log("✅ تم حذف المعاملة نهائياً من Firebase userTransactions");try{await Za.saveDeletedTransaction({...n,userId:t.uid,originalTransactionId:n.id,deletedAt:new Date().toISOString()}),console.log("✅ تم حفظ المعاملة في سجل المحذوفات مع تاريخ الحذف")}catch(d){console.warn("⚠️ فشل في حفظ المعاملة في سجل المحذوفات، لكن الحذف من Firebase نجح:",d)}const r=[...bn,n],i=Ge.filter(d=>d.id!==s);fs(r),_t(i),fn(!1),localStorage.setItem(da(),JSON.stringify(r)),localStorage.setItem(ca(),JSON.stringify(i)),console.log("✅ تم تحديث البيانات المحلية بنجاح بعد الحذف من Firebase");try{let d=localStorage.getItem(Qe());if(!d&&(t!=null&&t.uid)){const E=`userCashBalance_${t.uid}`,T=localStorage.getItem(E);if(T){d=T;try{localStorage.setItem(Qe(),T),localStorage.removeItem(E)}catch{}}}const v=localStorage.getItem(Ke());let f=d?parseFloat(d):0,j=v?JSON.parse(v):{};if(n.type==="send"){const E=n.commission||0;f-=E;const T=n.fromWallet||Object.keys(j)[0];if(T){const N=j[T]||0;j[T]=N+n.amount}}else if(n.type==="withdraw"){const E=n.commission||0;f+=n.amount,f-=E;const T=n.fromWallet||Object.keys(j)[0];if(T){const N=j[T]||0;j[T]=Math.max(0,N-n.amount)}}localStorage.setItem(Qe(),f.toString()),localStorage.setItem(Ke(),JSON.stringify(j))}catch(d){console.warn("فشل عكس تأثير الأرصدة محليًا بعد الحذف:",d)}try{const d=n.fromWallet;if(d){const{walletDailyLimitsService:v}=await us(async()=>{const{walletDailyLimitsService:j}=await import("./walletDailyLimitsService-Ddx-WU_I.js");return{walletDailyLimitsService:j}},__vite__mapDeps([2,0,1])),f=await v.getWalletLimits(d);if(f){const j=n.type==="send",E={updatedAt:(await us(async()=>{const{serverTimestamp:C}=await import("./index-CZqF7mlb.js").then(Z=>Z.a$);return{serverTimestamp:C}},__vite__mapDeps([0,1]))).serverTimestamp()};j?(E.dailyTransferUsed=Math.max(0,(f.dailyTransferUsed||0)-n.amount),E.monthlyTransferUsed=Math.max(0,(f.monthlyTransferUsed||0)-n.amount)):(E.dailyWithdrawUsed=Math.max(0,(f.dailyWithdrawUsed||0)-n.amount),E.monthlyWithdrawUsed=Math.max(0,(f.monthlyWithdrawUsed||0)-n.amount));const{doc:T,setDoc:N}=await us(async()=>{const{doc:C,setDoc:Z}=await import("./index-CZqF7mlb.js").then(Ve=>Ve.a$);return{doc:C,setDoc:Z}},__vite__mapDeps([0,1])),{db:D}=await us(async()=>{const{db:C}=await import("./index-CZqF7mlb.js").then(Z=>Z.b0);return{db:C}},__vite__mapDeps([0,1])),U=T(D,"walletLimits",d);await N(U,E,{merge:!0})}}}catch(d){console.warn("فشل استرجاع حدود المحفظة بعد الحذف:",d)}try{const{ProfitService:d}=await us(async()=>{const{ProfitService:T}=await import("./profitService-WOL_cZ8K.js");return{ProfitService:T}},__vite__mapDeps([3,4])),{ReportsService:v}=await us(async()=>{const{ReportsService:T}=await import("./reportsService-Bp1Io21u.js");return{ReportsService:T}},[]),j={txnType:n.type==="send"?"send":"receive",amount:n.amount,commission:n.commission||0,createdAt:n.createdAt,status:"confirmed"},E=d.calculateProfitFromTransaction(j);E>0&&d.addProfit(-E,t.uid);try{v.removeTransactionEffects(n,t.uid)}catch{}}catch(d){console.warn("فشل تحديث الأرباح/التقارير بعد الحذف:",d)}l({title:"تم حذف المعاملة نهائياً",description:"تم حذف المعاملة نهائياً من النظام. يمكنك العثور عليها في قائمة المحذوفات"})}catch(r){console.error("❌ خطأ في حذف المعاملة من Firebase:",r);let i="فشل في حذف المعاملة من الخادم. يرجى المحاولة مرة أخرى";r instanceof Error&&(r.message.includes("network")||r.message.includes("offline")?i="مشكلة في الاتصال بالإنترنت. تحقق من الاتصال وحاول مرة أخرى":r.message.includes("permission")||r.message.includes("unauthorized")?i="ليس لديك صلاحية لحذف هذه المعاملة":r.message.includes("not-found")&&(i="المعاملة غير موجودة أو تم حذفها مسبقاً")),l({title:"خطأ في الحذف",description:i,variant:"destructive"})}},ha=s=>{const n=s.type,r=s.txnType;return n==="withdraw"||n==="withdrawal"||n==="receive"||r==="receive"},xa=s=>{const n=s.type,r=s.txnType;return n==="send"||n==="transfer"||r==="send"},Ga=(s,n)=>{const r=new Date().toDateString();let i=Ge.filter(T=>new Date(T.createdAt).toDateString()===r&&T.status==="completed");xs&&xs.trim()!==""&&(i=i.filter(T=>T.senderPhone&&T.senderPhone.includes(xs)||T.receiverPhone&&T.receiverPhone.includes(xs)));const d=Vt.filterVisibleTransactions(i,"daily",t==null?void 0:t.uid),v=d.length,f=d.reduce((T,N)=>T+N.amount,0),j=d.filter(ha).reduce((T,N)=>{const D=N.withdrawnAmount!==void 0?N.withdrawnAmount:N.amount;return T+D},0),E=d.filter(xa).reduce((T,N)=>{const D=N.sentAmount!==void 0?N.sentAmount:N.amount;return T+D},0);return{totalTransactions:v,totalAmount:f,totalWithdrawn:j,totalSent:E}},ua=s=>{const n=new Date().getMonth(),r=new Date().getFullYear();let i=Ge.filter(T=>{const N=new Date(T.createdAt);return N.getMonth()===n&&N.getFullYear()===r&&T.status==="completed"});xs&&xs.trim()!==""&&(i=i.filter(T=>T.senderPhone&&T.senderPhone.includes(xs)||T.receiverPhone&&T.receiverPhone.includes(xs)));const d=Vt.filterVisibleTransactions(i,"monthly",t==null?void 0:t.uid),v=d.length,f=d.reduce((T,N)=>T+N.amount,0),j=d.filter(ha).reduce((T,N)=>{const D=N.withdrawnAmount!==void 0?N.withdrawnAmount:N.amount;return T+D},0),E=d.filter(xa).reduce((T,N)=>{const D=N.sentAmount!==void 0?N.sentAmount:N.amount;return T+D},0);return{totalTransactions:v,totalAmount:f,totalWithdrawn:j,totalSent:E}},ml=s=>{const n=new Date().getMonth(),r=new Date().getFullYear(),i=Ge.filter(f=>{const j=new Date(f.createdAt);return j.getMonth()===n&&j.getFullYear()===r&&f.status==="completed"&&f.fromWallet===s}),d=i.filter(ha).reduce((f,j)=>{const E=j.withdrawnAmount||j.amount;return f+E},0),v=i.filter(xa).reduce((f,j)=>{const E=j.sentAmount||j.amount;return f+E},0);return{totalWithdrawn:d,totalTransferred:v}},Do=s=>{const n=new Date,r=n.getDate(),i=n.getMonth(),d=n.getFullYear(),v=Ge.filter(E=>{const T=new Date(E.createdAt);return T.getDate()===r&&T.getMonth()===i&&T.getFullYear()===d&&E.status==="completed"&&E.fromWallet===s}),f=v.filter(ha).reduce((E,T)=>{const N=T.withdrawnAmount||T.amount;return E+N},0),j=v.filter(xa).reduce((E,T)=>{const N=T.sentAmount||T.amount;return E+N},0);return{totalWithdrawn:f,totalTransferred:j}};ua(),a.useEffect(()=>{const s=localStorage.getItem(ca());if(s){const r=JSON.parse(s).map(i=>({...i,createdAt:new Date(i.createdAt)}));_t(r)}},[]),a.useEffect(()=>{Ge.length>0&&localStorage.setItem(ca(),JSON.stringify(Ge))},[Ge]);const hl=async()=>{yd(),console.log("🔄 بدء عملية التحويل/السحب"),console.log("📊 البيانات المدخلة:",{senderPhone:we,receiverPhone:Be,amount:Re,transactionType:Y});const s=()=>{Y==="transfer"?$s(!0):aa(!0)},n=()=>{Y==="transfer"?$s(!1):aa(!1)};if(s(),!we||!Re){console.log("❌ خطأ: بيانات ناقصة"),l({title:"خطأ في البيانات",description:"يرجى ملء جميع الحقول المطلوبة",variant:"destructive"}),n();return}if(Y==="transfer"&&!Be&&!g){console.log("❌ خطأ: رقم المستقبل مفقود"),l({title:"خطأ في البيانات",description:"يرجى إدخال رقم المستقبل",variant:"destructive"}),n();return}if(Y==="transfer"&&!g&&!bd(Be)){l({title:"رقم المستقبل غير صالح",description:"اكتب رقم صحيح مكون من 11 رقم ويبدأ بـ 015 أو 010 أو 012 أو 011",variant:"destructive"}),n();return}const r=parseFloat(Re);if(console.log("💰 المبلغ المحول:",r),r<=0){console.log("❌ خطأ: مبلغ غير صحيح"),l({title:"خطأ في المبلغ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"}),n();return}if(Ae)try{const ie=new Date,qe=ie.getFullYear(),Et=String(ie.getMonth()+1).padStart(2,"0"),it=String(ie.getDate()).padStart(2,"0"),as=`zeroPlanDailyConfirmCount:${(t==null?void 0:t.uid)||"default"}:${qe}-${Et}-${it}`,Rt=localStorage.getItem(as);if((Rt&&parseInt(Rt,10)||0)>=10){l({title:"حد التأكيد اليومي",description:"باقة زيرو تسمح بـ 10 تأكيدات تحويل/سحب يومياً فقط.",variant:"destructive"}),n();return}}catch(ie){console.warn("فشل قراءة عداد تأكيدات باقة زيرو من التخزين المحلي:",ie)}const i=je.find(ie=>ie.id===G);if(!i){l({title:"خطأ في المحفظة",description:"يرجى اختيار محفظة صحيحة",variant:"destructive"}),n();return}const d=ml(G);if(console.log("📈 فحص الحدود الشهرية للمحفظة المختارة"),console.log("📊 الإحصائيات الشهرية للمحفظة:",{walletId:G,walletName:i.name,currentWithdrawn:d.totalWithdrawn,currentTransferred:d.totalTransferred,withdrawalLimit:i.monthlyWithdrawalLimit,transferLimit:i.monthlyTransferLimit}),Y==="withdraw"){if(console.log("🏧 فحص حد السحب الشهري للمحفظة"),console.log(`💸 المسحوب حالياً من المحفظة: ${d.totalWithdrawn}, المبلغ الجديد: ${r}, الحد الأقصى: ${i.monthlyWithdrawalLimit}`),d.totalWithdrawn+r>i.monthlyWithdrawalLimit){console.log("❌ تجاوز حد السحب الشهري للمحفظة"),l({title:"تجاوز حد السحب الشهري",description:`لا يمكن سحب أكثر من ${i.monthlyWithdrawalLimit} جنيه شهرياً من محفظة ${i.name}`,variant:"destructive"}),n();return}}else if(console.log("💸 فحص حد التحويل الشهري للمحفظة"),console.log(`📤 المحول حالياً من المحفظة: ${d.totalTransferred}, المبلغ الجديد: ${r}, الحد الأقصى: ${i.monthlyTransferLimit}`),d.totalTransferred+r>i.monthlyTransferLimit){console.log("❌ تجاوز حد التحويل الشهري للمحفظة"),l({title:"تجاوز حد التحويل الشهري",description:`لا يمكن تحويل أكثر من ${i.monthlyTransferLimit} جنيه شهرياً من محفظة ${i.name}`,variant:"destructive"}),n();return}const v=(u==null?void 0:u.shopName)||(t==null?void 0:t.displayName)||"محل كاشي لينك",f={id:Date.now().toString(),type:Y==="transfer"?"send":Y==="deposit"?"deposit":"withdraw",senderPhone:we,receiverPhone:Y==="transfer"?Be:we,amount:r,status:"completed",createdAt:new Date,withdrawnAmount:Y==="withdraw"?r:void 0,sentAmount:Y==="transfer"?r:void 0,depositedAmount:void 0,fromWallet:G,senderNumber:we,senderName:we,shopName:(i==null?void 0:i.name)||"المحفظة الرئيسية",transferredAmount:Y==="transfer"?r:void 0,receiverNumber:Y==="transfer"?Be:void 0,withdrawnAmountDetailed:Y==="withdraw"?r:void 0,depositedAmountDetailed:void 0,merchantShopName:v,transactionReference:`TXN-${Date.now()}`,commission:0,notes:Y==="transfer"?`تحويل من ${we} إلى ${Be}`:`سحب نقدي من محفظة ${we}`};y&&(m!=null&&m.name||m!=null&&m.username)&&(f.cashierName=(m==null?void 0:m.name)||(m==null?void 0:m.username));const j=Ks.validateTransaction(r,Y,_e,fe);if(!j.isValid){l({title:"خطأ في العملية",description:j.error,variant:"destructive"}),n();return}j.warning&&l({title:"تحذير",description:j.warning,variant:"destructive"});let E;if(Y==="transfer")if((i==null?void 0:i.defaultTransferCommission)!=null){const ie=Number(i.defaultTransferCommission)||0;E=Math.round(ie*r/1e3*100)/100}else dt&&dt.trim()!==""?E=Math.max(0,parseFloat(dt)):E=0;else if((i==null?void 0:i.defaultWithdrawCommission)!=null){const ie=Number(i.defaultWithdrawCommission)||0;E=Math.round(ie*r/1e3*100)/100}else xt&&xt.trim()!==""?E=Math.max(0,parseFloat(xt)):E=Math.round(r*.01*100)/100;if(f.commission=E,Y!=="transfer"&&!ye&&E>=r){l({title:"خطأ في العمولة",description:"العمولة أكبر من أو تساوي المبلغ المدخل",variant:"destructive"}),n();return}const T=Y==="transfer"||ye?r:Math.round((r-E)*100)/100;f.amount=T,f.withdrawnAmount=Y==="withdraw"?T:void 0,f.sentAmount=Y==="transfer"?T:void 0,f.transferredAmount=Y==="transfer"?T:void 0,f.withdrawnAmountDetailed=Y==="withdraw"?T:void 0;let N;const D=Y==="transfer"&&!!pt,U=Y==="withdraw"&&!!pt,C=D||U;let Z=null;const Ve=Je(we||"").replace(/\D/g,""),st=Je(Be||"").replace(/\D/g,""),St=Y==="transfer"&&(Ve.startsWith("010")&&(st.startsWith("011")||st.startsWith("012")||st.startsWith("015"))||Ve.startsWith("012")&&st.startsWith("010")||Ve.startsWith("011")&&st.startsWith("010")||Ve.startsWith("015")&&st.startsWith("010")),bt=St?Math.max(0,parseFloat(xe||"0")):0,Zr=Math.round(E*100)/100;if(f.commission=Zr,St&&!C&&bt<=0){l({title:"خطأ",description:"أدخل رسوم التحويل لعمليات 010 → 011/012/015 أو 012 → 010 أو 011 → 010 أو 015 → 010",variant:"destructive"}),n();return}if(Y==="transfer"&&!C){const ie=Number(fe[G]||0),qe=Number(T)+Number(bt);if(ie<qe){l({title:"رصيد المحفظة غير كافٍ",description:`الرصيد الحالي ${ie} لا يكفي لخصم ${qe}`,variant:"destructive"}),n();return}}if(C)if(D){const ie=Ks.validateTransaction(T,"transfer",_e,fe);ie.isValid?N={success:!0,newCashBalance:_e,newWalletBalances:fe}:N={success:!1,newCashBalance:_e,newWalletBalances:fe,message:ie.error||"رصيد غير كافٍ للتحويل المؤجل",error:"INSUFFICIENT_WALLET_BALANCE"}}else N={success:!0,newCashBalance:_e,newWalletBalances:fe};else Y==="transfer"?N=await Ks.processTransfer({amount:T,currentCashBalance:_e,currentWalletBalances:fe,wallets:je,selectedWalletId:G,skipRemoteLimitsCheck:!0,nonBlockingUsageUpdate:!0}):N=await Ks.processWithdraw({amount:T,currentCashBalance:_e,currentWalletBalances:fe,wallets:je,selectedWalletId:G,skipRemoteLimitsCheck:!0,nonBlockingUsageUpdate:!0});if(!N.success){l({title:"فشل في العملية",description:N.error||N.message,variant:"destructive"}),n();return}let _s=C?_e:N.newCashBalance,ss=C?fe:N.newWalletBalances;if(!C&&Y==="transfer"&&bt>0){const ie=Number(ss[G]||0);ss={...ss,[G]:Math.round((ie-Number(bt))*100)/100}}if(C&&U){const ie=je.find(it=>it.id===G)??je.find(it=>it.isDefault)??je[0],qe=(ie==null?void 0:ie.id)||G;if(qe!==G)try{ma(qe)}catch{}const Et=Number(fe[qe]||0);ss={...fe,[qe]:Math.round((Et+Number(T))*100)/100};try{const it=`walletEffectsAppliedOnCreation_${(t==null?void 0:t.uid)||"default"}`,as=localStorage.getItem(it),Rt=as?JSON.parse(as):[];f!=null&&f.id&&!Rt.includes(f.id)&&(Rt.push(f.id),localStorage.setItem(it,JSON.stringify(Rt)))}catch{}}if(C&&D){const ie=je.find(it=>it.id===G)??je.find(it=>it.isDefault)??je[0],qe=(ie==null?void 0:ie.id)||G;if(qe!==G)try{ma(qe)}catch{}const Et=Number(fe[qe]||0);ss={...fe,[qe]:Math.round((Et-Number(T)-Number(bt))*100)/100}}if((D||U)&&pt&&!Ms){const ie={id:`DEBT-${Date.now()}`,debtorName:pt.debtorName,amount:pt.amount,reason:pt.notes||"",customerId:pt.customerId,mobile:pt.mobile,status:"pending",createdAt:new Date};Z=ie.id;const qe=[ie,...yt];$t(qe);try{await ts(qe)}catch(Et){console.error("⚠️ فشل حفظ الدين المؤجل محلياً:",Et)}l({title:"تم إضافة الدين",description:"أضيف إلى إيصالات الديون حتى يتم السداد",variant:"default"})}if(!C){const ie=Math.max(0,Number(E))+Math.max(0,Number(bt));ie>0&&(_s=Math.round((_s+ie)*100)/100,console.log(`💰 تم إضافة عمولة/رسوم ${ie} جنيه لدرج النقدية`))}if(console.log("⚡ تحديث الواجهة فوراً..."),et(_s),Le(ss),C&&(f.status="pending"),_t(ie=>[f,...ie]),Ae)try{const ie=new Date,qe=ie.getFullYear(),Et=String(ie.getMonth()+1).padStart(2,"0"),it=String(ie.getDate()).padStart(2,"0"),as=`zeroPlanDailyConfirmCount:${(t==null?void 0:t.uid)||"default"}:${qe}-${Et}-${it}`,Rt=localStorage.getItem(as),Qa=Rt&&parseInt(Rt,10)||0;localStorage.setItem(as,String(Qa+1))}catch{}if(localStorage.setItem(Qe(),_s.toString()),localStorage.setItem(Ke(),JSON.stringify(ss)),(async()=>{try{console.log("🔄 بدء حفظ المعاملة في Firebase في الخلفية...");const ie={shopId:(u==null?void 0:u.shopId)||(t==null?void 0:t.uid)||"default-shop",lineId:G||"default-line",merchantUserId:(t==null?void 0:t.uid)||null,provider:"vodafone_cash",txnType:Y==="transfer"?"send":"receive",amount:T,commission:Zr,fee:bt,profit:0,senderMsisdn:we,receiverMsisdn:Y==="transfer"?Be:we,note:Y==="transfer"?`تحويل من ${we} إلى ${Be}`:`سحب ${T} جنيه من ${(i==null?void 0:i.name)||"المحفظة الرئيسية"}`,status:C?"pending":"confirmed",linkedDebtId:Z||void 0,createdBy:(t==null?void 0:t.uid)||null,walletEffectAppliedOnCreation:!!(C&&U)},qe={...ie,status:C?"pending":"completed",commissionMode:Y==="transfer"||ye?"add":"deduct",totalCharged:Y==="transfer"?T+Zr+bt:ye?T+E:T,walletEffectAppliedOnCreation:!!(C&&U),createdAt:new Date},{ProfitService:Et}=await us(async()=>{const{ProfitService:Qa}=await import("./profitService-WOL_cZ8K.js");return{ProfitService:Qa}},__vite__mapDeps([3,4])),it=Et.calculateProfitFromTransaction(qe);it>0&&(Et.addProfit(it,t==null?void 0:t.uid),console.log("✅ تم إضافة الربح:",it,"جنيه")),await Promise.all([...t!=null&&t.uid?[Ne.updateUserData(t.uid,{cashBalance:_s,walletBalances:ss,lastUpdated:new Date().toISOString()})]:[],ir.create(ie),...t!=null&&t.uid?[Ne.saveUserTransaction(t.uid,{...qe,transactionType:Y,fromWallet:G,toWallet:Y==="transfer"?D?null:"cash":null,cashierName:y&&((m==null?void 0:m.name)||(m==null?void 0:m.username))||"الحساب الرئيسي",linkedDebtId:Z||void 0,description:`${Y==="transfer"?"تحويل":"سحب"} ${T} من ${G} ${Y==="transfer"?D?"":"إلى الدرج النقدي":""} — عمولة: ${E} (${Y==="transfer"||ye?"مضافة":"مخصومة"})${bt>0?` — رسوم: ${bt}`:""}${C?" — دين مؤجل (قيد المراجعة)":""}`})]:[]]),console.log("✅ تم حفظ جميع البيانات في Firebase بنجاح");const as=`userData_${t==null?void 0:t.uid}`,Rt={cashBalance:_s,walletBalances:ss,lastUpdated:new Date().toISOString()};localStorage.setItem(as,JSON.stringify(Rt))}catch(ie){console.error("❌ خطأ في حفظ المعاملة في Firebase (في الخلفية):",ie),l({title:"تحذير",description:"تم تنفيذ العملية محلياً، لكن فشلت المزامنة مع الخادم. ستتم المحاولة مرة أخرى تلقائياً.",variant:"destructive"})}})(),Y==="transfer"){$s(!0);const ie=Number(r)+Number(E)+Math.max(0,Number(bt));ur({type:"transfer",amount:Math.max(0,Math.round(ie*100)/100)}),Da(!0),setTimeout(()=>{$s(!1)},2e3)}else{aa(!0);const ie=ye?Number(r):Math.max(0,Math.round((Number(r)-Number(E))*100)/100);ur({type:"withdraw",amount:Math.max(0,Math.round(ie*100)/100)}),Da(!0),setTimeout(()=>{aa(!1)},2e3)}Bt(""),Mt(""),Zs(null),Es(""),Lt(""),lt(""),ja(!1)},Qr=mt.useMemo(()=>new Intl.DateTimeFormat("ar-EG"),[]),Co=mt.useMemo(()=>new Intl.DateTimeFormat("ar-EG",{hour:"2-digit",minute:"2-digit"}),[]),Io=mt.useMemo(()=>{try{return yt.reduce((s,n)=>{const r=Number(n.paidAmount||0),i=Math.max(0,Number(n.amount||0)-r);return s+i},0)}catch{return 0}},[yt]),xl=mt.useMemo(()=>il().filter(n=>zt==="all"?!0:zt==="send"?n.type==="send":zt==="receive"?n.type==="receive":zt==="withdraw"?n.type==="withdraw":zt!=="deleted"),[il,zt]),To=()=>{if(mr==="daily"){const s=Vt.resetReportsManually("daily",Ge,t==null?void 0:t.uid);sa(!1),l({title:"تم تصفير المعاملات اليومية",description:`تم إخفاء ${s.length} معاملة من تقارير اليوم (الحدود لم تتأثر)`})}else{const s=Vt.resetReportsManually("monthly",Ge,t==null?void 0:t.uid);sa(!1),l({title:"تم تصفير المعاملات الشهرية",description:`تم إخفاء ${s.length} معاملة من تقارير الشهر (الحدود لم تتأثر)`})}},ko=()=>mr==="daily"?"تصفير المعاملات اليومية":"تصفير المعاملات الشهرية",Ao=()=>mr==="daily"?"أدخل كلمة مرور تسجيل الدخول لتصفير جميع معاملات اليوم":"أدخل كلمة مرور تسجيل الدخول لتصفير جميع معاملات الشهر",Po=s=>{Qn(s),Wr(!0)},Oo=s=>{et(s),localStorage.setItem(Qe(),s.toString()),Ln(!1),l({title:"تم تحديث الرصيد النقدي",description:`تم تحديث الرصيد النقدي إلى ${s} جنيه`})},Wo=async s=>{var f;if(!wt){console.warn("لا يوجد معرف محفظة محدد لتعديل الرصيد");return}const n={...fe,[wt]:s};Le(n);const r=new Date().toISOString(),i={walletBalances:n,lastUpdated:r},d=`userData_${t==null?void 0:t.uid}`;try{localStorage.setItem(d,JSON.stringify(i)),localStorage.setItem(Ke(),JSON.stringify(n)),localStorage.setItem(`walletBalances_backup_${r}`,JSON.stringify(n))}catch{}try{t!=null&&t.uid&&await Ne.updateUserData(t.uid,i)}catch(j){console.error("خطأ أثناء حفظ رصيد المحفظة في Firebase:",j)}$n(!1);const v=((f=je.find(j=>j.id===wt))==null?void 0:f.name)||"المحفظة";l({title:"تم تحديث رصيد المحفظة",description:`تم تحديث رصيد ${v} إلى ${s.toLocaleString()} جنيه`})},Fo=async s=>{var n;if(console.log("💰 بدء تحديث رصيد المحفظة"),console.log("📊 معرف المحفظة المحررة:",wt),console.log("💵 المبلغ المضاف/المخصوم:",s),wt){const r=fe[wt]||0;console.log("💰 الرصيد الحالي:",r);const i=r+s;console.log("💰 الرصيد الجديد:",i);const d={...fe,[wt]:i};console.log("📊 الأرصدة المحدثة:",d),Le(d);const v=new Date().toISOString(),f={walletBalances:d,lastUpdated:v},j=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(j,JSON.stringify(f)),localStorage.setItem(Ke(),JSON.stringify(d)),localStorage.setItem(`walletBalances_backup_${v}`,JSON.stringify(d));try{if(t!=null&&t.uid){console.log("🔄 حفظ البيانات في Firebase...");try{await Ne.updateUserData(t.uid,f),console.log("✅ تم حفظ الأرصدة في Firebase بنجاح"),setTimeout(()=>{localStorage.removeItem(j),console.log("🧹 تم حذف النسخة المحلية المؤقتة بعد دقيقة واحدة")},6e4)}catch(D){console.error("❌ فشل في حفظ البيانات في Firebase:",D),pe(!0)}}else console.log("⚠️ المستخدم غير مسجل دخول، حفظ في localStorage"),localStorage.setItem(Ke(),JSON.stringify(d));const E=((n=je.find(D=>D.id===wt))==null?void 0:n.name)||"المحفظة",T=s>0?"إضافة":"خصم",N=Math.abs(s);l({title:`تم ${T} مبلغ ${T==="إضافة"?"إلى":"من"} رصيد المحفظة`,description:`تم ${T} ${N} جنيه ${T==="إضافة"?"إلى":"من"} رصيد ${E}. الرصيد الجديد: ${i.toLocaleString()} جنيه`})}catch(E){if(console.error("❌ فشل في حفظ البيانات في Firebase:",E),localStorage.setItem(Ke(),JSON.stringify(d)),t!=null&&t.uid){const T=`userData_${t.uid}`,N={walletBalances:d,lastUpdated:new Date().toISOString()};localStorage.setItem(T,JSON.stringify(N)),pe(!0)}l({title:"تم حفظ البيانات محلياً",description:"تم حفظ التغييرات محلياً وسيتم مزامنتها مع الخادم لاحقاً",variant:"default"})}}else console.log("❌ لا يوجد معرف محفظة للتحرير");setTimeout(()=>{const i=Object.keys(localStorage).filter(d=>d.startsWith("walletBalances_backup_")).sort();i.length>5&&i.slice(0,i.length-5).forEach(v=>{localStorage.removeItem(v),console.log("🗑️ حذف النسخة الاحتياطية القديمة:",v)})},5e3),Wr(!1),Qn("")};return console.log("🔥 UserDashboardPage - Render conditions:",{isCheckingActivation:S,isUserActive:F,showActivationModal:R}),!S&&!F?(console.log("🔥 UserDashboardPage - Showing activation modal"),e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center",children:e.jsx(Nl,{isOpen:!0,onClose:()=>{}})})):S?(console.log("🔥 UserDashboardPage - Showing loading screen"),e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center",children:e.jsx("div",{className:"text-center",children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"w-3 h-3 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 animate-bounce",style:{animationDelay:"0ms"}}),e.jsx("span",{className:"w-3 h-3 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 animate-bounce",style:{animationDelay:"150ms"}}),e.jsx("span",{className:"w-3 h-3 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 animate-bounce",style:{animationDelay:"300ms"}})]})})})):(console.log("🔥 UserDashboardPage - Rendering main dashboard"),e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-gray-50 via-blue-50/30 to-indigo-50/20 px-2 sm:px-4 py-2 sm:py-4 relative overflow-hidden",children:[e.jsxs("div",{className:"absolute inset-0 overflow-hidden pointer-events-none",children:[e.jsx("div",{className:"absolute top-10 sm:top-20 left-2 sm:left-10 w-32 sm:w-72 h-32 sm:h-72 bg-blue-400/8 rounded-full blur-3xl"}),e.jsx("div",{className:"absolute bottom-10 sm:bottom-20 right-2 sm:right-10 w-40 sm:w-96 h-40 sm:h-96 bg-purple-400/8 rounded-full blur-3xl",style:{animationDelay:"2s"}}),e.jsx("div",{className:"absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-36 sm:w-80 h-36 sm:h-80 bg-indigo-400/5 rounded-full blur-3xl",style:{animationDelay:"4s"}})]}),e.jsxs("div",{className:"max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-3 sm:gap-6 relative z-10",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-2 sm:space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 sm:grid-cols-2 sm:gap-3 fade-in-up",children:[!ra&&e.jsxs(Ye,{className:"bg-gradient-to-br from-purple-50 via-purple-25 to-white border border-purple-200/60 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 group relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-purple-500/5 to-purple-600/3 opacity-0 group-hover:opacity-100 transition-opacity duration-300"}),e.jsx("div",{className:"absolute top-0 right-0 w-20 sm:w-32 h-20 sm:h-32 bg-gradient-to-br from-purple-300/15 to-transparent rounded-full -translate-y-8 sm:-translate-y-16 translate-x-8 sm:translate-x-16 group-hover:scale-110 transition-transform duration-300"}),e.jsx(ht,{className:"pb-2 sm:pb-1 lg:pb-1 px-3 sm:px-3 lg:px-2 pt-3 sm:pt-2 lg:pt-1 relative z-10",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Ct,{className:"text-xs font-bold text-purple-800 flex items-center gap-1.5 sm:gap-1",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"w-2.5 sm:w-2 h-2.5 sm:h-2 bg-gradient-to-r from-purple-500 to-purple-600 rounded-full shadow-sm"}),e.jsx("div",{className:"absolute inset-0 w-2.5 sm:w-2 h-2.5 sm:h-2 bg-purple-400 rounded-full opacity-60 animate-pulse"})]}),e.jsx("span",{className:"text-xs",children:"الشهر"})]}),e.jsxs("div",{className:"flex items-center gap-1 sm:gap-1",children:[e.jsx("div",{className:"hidden"}),e.jsx(c,{size:"sm",variant:"ghost",onClick:()=>{vn("monthly"),sa(!0)},className:"h-7 w-7 sm:h-6 sm:w-6 p-0 bg-gradient-to-r from-purple-100 to-purple-200 text-purple-700 hover:from-purple-200 hover:to-purple-300 hover:text-purple-800 rounded-lg sm:rounded-md transition-all duration-300 hover:scale-105 shadow-sm hover:shadow-md",title:"تصفير معاملات الشهر",children:e.jsx(At,{className:"h-3 w-3 sm:h-2.5 sm:w-2.5"})}),e.jsx("div",{className:"p-1.5 sm:p-1 bg-gradient-to-r from-purple-100 to-purple-200 rounded-lg sm:rounded-md",children:e.jsx(ga,{className:"h-3 w-3 sm:h-2.5 sm:w-2.5 text-purple-600"})})]})]})}),!ra&&e.jsxs(Ze,{className:"space-y-0.5 sm:space-y-1 lg:space-y-0 pt-0 px-2 sm:px-3 lg:px-2 pb-1.5 sm:pb-2 lg:pb-1 relative z-10",children:[e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-purple-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-purple-700",children:"عدد المعاملات:"}),e.jsx("span",{className:"font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:ua().totalTransactions})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-purple-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-purple-700",children:"إجمالي المبالغ:"}),e.jsx("span",{className:"font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:ua().totalAmount.toFixed(2)})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-purple-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-purple-700",children:"المسحوب:"}),e.jsx("span",{className:"font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:ua().totalWithdrawn.toFixed(2)})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-purple-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-purple-700",children:"المرسل:"}),e.jsx("span",{className:"font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:ua().totalSent.toFixed(2)})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-purple-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-purple-700",children:"الأرباح:"}),e.jsx(cd,{userId:t==null?void 0:t.uid,transactions:Ge})]})]}),Pi&&e.jsx("div",{className:"absolute inset-0 z-20 bg-yellow-100/60 backdrop-blur-sm rounded-xl border border-yellow-300/70 flex items-center justify-center p-0 pointer-events-auto",children:e.jsxs(c,{size:"sm",variant:"ghost",onClick:async()=>{if(Ae){l({title:"غير متاح",description:"تقارير الشهر غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"});return}Aa(!0)},className:"px-2.5 py-1 rounded-full bg-gradient-to-r from-yellow-300 to-yellow-400 text-black hover:from-yellow-400 hover:to-yellow-500 shadow-md flex items-center gap-1 text-[11px] font-semibold",title:"عرض تقارير الشهر (يتطلب الرقم السري)",children:[e.jsx("span",{children:"عرض تقارير الشهر"}),e.jsx(tt,{className:"h-2.5 w-2.5"})]})})]}),e.jsx(Ts,{open:Wi,onOpenChange:Aa,mode:"verify",title:"الرقم السري لفتح تقارير الشهر",description:"لا يمكن الاطلاع على إحصائيات الشهر إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{if(Ae){l({title:"غير متاح",description:"تقارير الشهر غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}),Aa(!1),Cn(!0);return}Cn(!1),Aa(!1)},userId:t==null?void 0:t.uid}),e.jsxs(Ye,{className:"bg-gradient-to-br from-blue-50 via-blue-25 to-white border border-blue-200/60 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 group relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/5 to-blue-600/3 opacity-0 group-hover:opacity-100 transition-opacity duration-300"}),e.jsx("div",{className:"absolute top-0 right-0 w-20 sm:w-32 h-20 sm:h-32 bg-gradient-to-br from-blue-300/15 to-transparent rounded-full -translate-y-8 sm:-translate-y-16 translate-x-8 sm:translate-x-16 group-hover:scale-110 transition-transform duration-300"}),e.jsx(ht,{className:"pb-2 sm:pb-3 lg:pb-1 px-3 sm:px-4 lg:px-2 pt-3 sm:pt-4 lg:pt-1 relative z-10",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Ct,{className:"text-sm sm:text-base font-bold text-blue-800 flex items-center gap-1.5 sm:gap-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"w-2.5 sm:w-3 h-2.5 sm:h-3 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full shadow-sm"}),e.jsx("div",{className:"absolute inset-0 w-2.5 sm:w-3 h-2.5 sm:h-3 bg-blue-400 rounded-full opacity-60 animate-pulse"})]}),e.jsx("span",{className:"text-xs sm:text-sm",children:"اليوم"})]}),e.jsxs("div",{className:"flex items-center gap-1 sm:gap-1.5",children:[e.jsx(c,{size:"sm",variant:"ghost",onClick:()=>{vn("daily"),sa(!0)},className:"h-7 w-7 sm:h-8 sm:w-8 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded-lg transition-all duration-300 hover:scale-105 shadow-sm hover:shadow-md",title:"تصفير معاملات اليوم",children:e.jsx(At,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"})}),e.jsx(c,{size:"sm",variant:"ghost",onClick:()=>hr(!0),className:"h-7 w-7 sm:h-8 sm:w-8 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded-lg transition-all duration-300 hover:scale-105 shadow-sm hover:shadow-md",title:"أرشيف التقارير اليومية",children:e.jsx(hc,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"})}),e.jsx(c,{size:"sm",variant:"ghost",onClick:()=>Oi(s=>!s),className:"h-7 w-7 sm:h-8 sm:w-8 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded-lg transition-all duration-300 hover:scale-105 shadow-sm hover:shadow-md",title:ra?"توسيع اليوم والشهر":"طي اليوم والشهر",children:ra?e.jsx(gn,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"}):e.jsx(Wl,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"})}),e.jsx("div",{className:"p-1.5 sm:p-2 bg-gradient-to-r from-blue-100 to-blue-200 rounded-lg",children:e.jsx(ga,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5 text-blue-600"})})]})]})}),!ra&&e.jsxs(Ze,{className:"space-y-0 pt-0 px-2 pb-1 relative z-10",children:[e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-blue-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-blue-700",children:"عدد المعاملات:"}),e.jsx("span",{className:"font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:Ga().totalTransactions})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-blue-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-blue-700",children:"إجمالي المبالغ:"}),e.jsx("span",{className:"font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:Ga().totalAmount.toFixed(2)})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-blue-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-blue-700",children:"المسحوب:"}),e.jsx("span",{className:"font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:Ga().totalWithdrawn.toFixed(2)})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-blue-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-blue-700",children:"المرسل:"}),e.jsx("span",{className:"font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:Ga().totalSent.toFixed(2)})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-blue-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-blue-700",children:"الأرباح:"}),e.jsx(hd,{userId:t==null?void 0:t.uid})]})]}),Fi&&e.jsx("div",{className:"absolute inset-0 z-20 bg-yellow-100/60 backdrop-blur-sm rounded-xl border border-yellow-300/70 flex items-center justify-center p-0 pointer-events-auto",children:e.jsxs(c,{size:"sm",variant:"ghost",onClick:()=>pr(!0),className:"px-2.5 py-1 rounded-full bg-gradient-to-r from-yellow-300 to-yellow-400 text-black hover:from-yellow-400 hover:to-yellow-500 shadow-md flex items-center gap-1 text-[11px] font-semibold",title:"عرض تقارير اليوم (يتطلب الرقم السري)",children:[e.jsx("span",{children:"عرض تقارير اليوم"}),e.jsx(tt,{className:"h-2.5 w-2.5"})]})})]}),e.jsx(Ts,{open:Ei,onOpenChange:pr,mode:"verify",title:"الرقم السري لفتح تقارير اليوم",description:"لا يمكن الاطلاع على تقارير اليوم إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{In(!1),pr(!1)},userId:t==null?void 0:t.uid})]}),e.jsxs(Ye,{className:"bg-white border-2 border-gray-200/50 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 group relative overflow-hidden   transform fade-in-up mb-6",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-emerald-500/5 via-blue-500/5 to-emerald-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-200"}),e.jsx("div",{className:"absolute top-0 left-0 w-40 h-40 bg-gradient-to-br from-emerald-300/10 to-transparent rounded-full -translate-y-20 -translate-x-20 group-hover:scale-150 transition-transform duration-200"}),e.jsx("div",{className:"absolute bottom-0 right-0 w-40 h-40 bg-gradient-to-br from-blue-300/10 to-transparent rounded-full translate-y-20 translate-x-20 group-hover:scale-150 transition-transform duration-200"}),e.jsx(Ze,{className:"p-3 relative z-10",children:e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"bg-emerald-50 border-2 border-emerald-200/50 p-1 rounded-xl shadow-lg hover:shadow-md transition-all duration-200 group/cash relative overflow-hidden ",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-emerald-500/10 to-transparent opacity-0 group-hover/cash:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex items-center justify-between relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-emerald-100 to-emerald-200 rounded-lg shadow-sm",children:e.jsx(Xe,{className:"h-1.5 w-1.5 text-emerald-600"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] font-bold text-emerald-800",children:"الفلوس النقدية"}),e.jsxs("span",{className:"text-[10px] font-extrabold text-emerald-700 bg-gradient-to-r from-emerald-100 to-emerald-200 px-1 py-0.5 rounded-lg shadow-sm",children:[_e.toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(c,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-green-100 to-green-200 text-green-700 hover:from-green-200 hover:to-green-300 hover:text-green-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>za(!0),children:e.jsx(gt,{className:"h-2 w-2"})}),e.jsx(c,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800 rounded-xl transition-all duration-300  hover:rotate-12 shadow-md hover:shadow-lg",onClick:()=>Ya(!0),children:e.jsx(At,{className:"h-2 w-2"})})]})]})]}),e.jsxs("div",{className:"bg-blue-50 border-2 border-blue-200/50 p-1 rounded-xl shadow-lg hover:shadow-md transition-all duration-200 group/wallet relative overflow-hidden ",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/10 to-transparent opacity-0 group-hover/wallet:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex items-center justify-between relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-blue-100 to-blue-200 rounded-lg shadow-sm",children:e.jsx(Ht,{className:"h-1.5 w-1.5 text-blue-600"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] font-bold text-blue-800",children:"الأرصدة علي المحافظ"}),e.jsxs("span",{className:"text-[10px] font-extrabold text-blue-700 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-lg shadow-sm",children:[Object.values(fe).reduce((s,n)=>s+n,0).toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(c,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-green-100 to-green-200 text-green-700 hover:from-green-200 hover:to-green-300 hover:text-green-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>Ka(!0),title:"إضافة أموال لإجمالي المحفظة",children:e.jsx(gt,{className:"h-2 w-2"})}),e.jsx(c,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800 rounded-xl transition-all duration-300  hover:rotate-12 shadow-md hover:shadow-lg",onClick:()=>{Va(!0),qa("")},title:"تصفير إجمالي المحفظة",children:e.jsx(At,{className:"h-2 w-2"})})]})]})]}),e.jsxs("div",{className:"col-span-2 sm:col-span-1 bg-indigo-50 border-2 border-indigo-200/50 p-1 rounded-xl shadow-lg hover:shadow-md transition-all duration-200 group/selwallet relative overflow-hidden ",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-indigo-500/10 to-transparent opacity-0 group-hover/selwallet:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex items-center justify-between relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-indigo-100 to-indigo-200 rounded-lg shadow-sm",children:e.jsx(Ht,{className:"h-1.5 w-1.5 text-indigo-600"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] font-bold text-indigo-800",children:"رصيد المحفظه"}),e.jsxs("span",{className:"text-[10px] font-extrabold text-indigo-700 bg-gradient-to-r from-indigo-100 to-indigo-200 px-1 py-0.5 rounded-lg shadow-sm",children:[(G&&fe[G]||0).toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(c,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-green-100 to-green-200 text-green-700 hover:from-green-200 hover:to-green-300 hover:text-green-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>{if(!G){l({title:"اختر محفظة",description:"يرجى اختيار محفظة من اختيار المحافظ بالأعلى أولاً",variant:"destructive"});return}Po(G)},title:"إضافة/خصم إلى رصيد المحفظة المختارة",children:e.jsx(gt,{className:"h-2 w-2"})}),e.jsx(c,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800 rounded-xl transition-all duration-300  hover:rotate-12 shadow-md hover:shadow-lg",onClick:()=>{if(!G){l({title:"اختر محفظة",description:"يرجى اختيار محفظة لتصفير رصيدها فقط",variant:"destructive"});return}Ea(!0)},title:"تصفير رصيد المحفظة المختارة",children:e.jsx(At,{className:"h-2 w-2"})})]})]})]})]})})]}),e.jsxs(Ye,{className:"bg-gradient-to-br from-gray-50 via-white to-slate-50 border border-gray-200/60 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 group relative overflow-hidden fade-in-up",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-gray-500/5 to-slate-600/3 opacity-0 group-hover:opacity-100 transition-opacity duration-300"}),e.jsxs(ht,{className:"pb-2 px-4 pt-4 relative z-10",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Ct,{className:"text-sm font-bold flex items-center gap-2 text-gray-800",children:[!k&&e.jsx("div",{className:"p-1.5 sm:p-2 bg-gradient-to-r from-gray-100 to-slate-200 rounded-lg",children:e.jsx(ga,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5 text-gray-600"})}),e.jsx("span",{className:"bg-gradient-to-r from-gray-600 to-slate-600 bg-clip-text text-transparent",children:"المعاملات الأخيرة"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[!k&&e.jsxs("div",{className:"flex items-center gap-0.5 bg-gray-50 rounded px-1 py-0.5 border border-gray-200 hover:border-blue-300 transition-all duration-200 group relative overflow-hidden max-w-[140px] md:max-w-[220px]",children:[e.jsx(oc,{className:"h-2 w-2 text-gray-400 group-hover:text-blue-600 transition-colors"}),e.jsx(M,{placeholder:"بحث...",value:jn,onChange:s=>Si(s.target.value),className:"h-3 text-[8px] border-0 bg-transparent focus:ring-0 focus:outline-none text-gray-700 placeholder:text-gray-400"})]}),!k&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-green-600 mb-1",children:"شحن"}),e.jsx(c,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-green-50 text-green-600 hover:bg-green-100 border border-green-200 ring-3 ring-green-300 transition-all duration-200 hover:scale-105",onClick:()=>{l({title:"قيد التطوير",description:"هذه الميزة غير متاحة حالياً."})},title:"شحن الرصيد",children:e.jsx(ba,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"حاسبة"}),e.jsx(c,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105",onClick:()=>gr(!0),title:"آلة حاسبة",children:e.jsx($l,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"كروت"}),e.jsx(c,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105",onClick:()=>{Ae?l({title:"غير متاح",description:"كروت الائتمان غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ia(!0)},title:"كروت الائتمان",children:e.jsx(ba,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-blue-600 mb-1",children:"الوردية"}),e.jsx(c,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-blue-50 text-blue-600 hover:bg-blue-100 border border-blue-200 ring-3 ring-blue-300 transition-all duration-200 hover:scale-105",onClick:oo,title:y&&(m!=null&&m.name||m!=null&&m.username)?`بروفيل الوردية: ${(m==null?void 0:m.name)||(m==null?void 0:m.username)}`:"وردية الكاشير",children:e.jsx(mn,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"المبيعات"}),e.jsx(c,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105",onClick:()=>{Ae?l({title:"غير متاح",description:"بيانات المبيعات غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ca(!0)},title:"بيانات المبيعات",children:e.jsx(xc,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsxs("div",{className:"flex items-center gap-1 mb-1",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600",children:"الديون"}),yt.filter(s=>s.status==="pending").length>0&&e.jsx("span",{className:"h-4 w-4 rounded-full bg-red-600 text-white text-[10px] flex items-center justify-center ring-2 ring-white",children:yt.filter(s=>s.status==="pending").length})]}),e.jsx(c,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105",onClick:()=>{Ae?l({title:"غير متاح",description:"إدارة الديون/الأجل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):na(!0)},title:"الديون",children:e.jsx(Ho,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-amber-700 mb-1",children:"الصيانة"}),e.jsx(c,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-amber-50 text-amber-700 hover:bg-amber-100 border border-amber-200 ring-3 ring-amber-300 transition-all duration-200 hover:scale-105",onClick:()=>{Ae?l({title:"غير متاح",description:"الصيانة غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ta(!0)},title:"الصيانة",children:e.jsx(Go,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-yellow-500 mb-1",children:"المكنة"}),e.jsx(c,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-violet-50 text-violet-700 hover:bg-violet-100 border border-violet-200 ring-3 ring-violet-300 transition-all duration-200 hover:scale-105",onClick:()=>{Kt?ka(!0):l({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"})},title:"يومية المكنة",children:e.jsx(_l,{className:"h-5 w-5 text-yellow-500"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-orange-600 mb-1",children:"مصروفات"}),e.jsx(c,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-orange-50 text-orange-600 hover:bg-orange-100 border border-orange-200 ring-3 ring-orange-300 transition-all duration-200 hover:scale-105",onClick:()=>{Ae?l({title:"غير متاح",description:"مصروفات المحل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):ls.hasMasterPin()?re(!0):P(!0)},title:"مصروفات المحل",children:e.jsx(ar,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-rose-600 mb-1",children:"النواقص"}),e.jsx(c,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-rose-50 text-rose-600 hover:bg-rose-100 border border-rose-200 ring-3 ring-rose-300 transition-all duration-200 hover:scale-105",onClick:()=>{Ae?l({title:"غير متاح",description:"النواقص غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):oe(!0)},title:"النواقص",children:e.jsx(Qo,{className:"h-5 w-5"})})]})]})]})]}),!k&&e.jsx("div",{className:"mt-2 w-full",children:e.jsxs("div",{className:"flex items-center justify-center gap-3 bg-gray-50 rounded-md p-3 border border-gray-200",children:[e.jsx(c,{variant:"ghost",size:"sm",className:`h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${zt==="send"?"bg-green-600 text-white border-green-600":"text-green-700 border-green-300 hover:bg-green-50"}`,onClick:()=>be("send"),title:"تصفية التحويل",children:"التحويل"}),e.jsx(c,{variant:"ghost",size:"sm",className:`h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${zt==="withdraw"?"bg-red-600 text-white border-red-600":"text-red-700 border-red-300 hover:bg-red-50"}`,onClick:()=>be("withdraw"),title:"تصفية السحب",children:"السحب"}),e.jsx(c,{variant:"ghost",size:"sm",className:`h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${zt==="all"?"bg-green-600 text-white border-green-600":"text-green-700 border-green-300 hover:bg-green-50"}`,onClick:()=>be("all"),title:"عرض الكل",children:"الكل"}),e.jsxs("div",{className:"relative ml-1",children:[e.jsxs(c,{variant:"ghost",size:"sm",className:"h-8 px-3 text-[12px] rounded-full border bg-red-50 text-red-700 border-red-300 hover:bg-red-100",onClick:()=>Er(!0),title:"تصفير المعاملات الأخيرة",children:[e.jsx(At,{className:"h-3.5 w-3.5 mr-1"}),"تصفير"]}),(t==null?void 0:t.uid)&&localStorage.getItem(`recentTransactionsResetAt:${t.uid}`)&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 h-2 w-2 rounded-full bg-red-500 ring-2 ring-white"})]})]})})]}),e.jsx(Ze,{className:"space-y-2 pt-0 px-4 pb-4 relative z-10",children:xl.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(ga,{className:"h-12 w-12 mx-auto mb-2 text-gray-300"}),e.jsx("p",{className:"text-sm",children:"لا توجد معاملات حتى الآن"})]}):e.jsx("div",{className:"max-h-[210px] overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400 transition-colors",children:e.jsx("div",{className:"space-y-2 pr-2",children:xl.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gradient-to-r from-white/70 to-gray-50/70 rounded-lg hover:from-white/90 hover:to-gray-50/90 transition-all duration-300 border border-gray-100/60 cursor-pointer hover:shadow-sm",onClick:()=>wo(s),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[s.status==="completed"&&e.jsx(ks,{className:"h-4 w-4 text-green-500"}),s.status==="pending"&&e.jsx(As,{className:"h-4 w-4 text-yellow-500"}),s.status==="failed"&&e.jsx(pn,{className:"h-4 w-4 text-red-500"})]}),e.jsxs("div",{children:[(()=>{const n=(s==null?void 0:s.type)==="report"||((s==null?void 0:s.title)||"").includes("إيصال تسليم وردية");return e.jsx("p",{className:"font-medium text-sm text-gray-800",children:n?"إيصال تسليم وردية":(s.type==="send"?"تحويل":"سحب")+` - ${s.amount.toLocaleString()} جنيه`})})(),e.jsxs("p",{className:"text-[10px] text-gray-700",children:["تمت بواسطة: ",(s==null?void 0:s.cashierName)??"الحساب الرئيسي"]}),(()=>{const n=(s==null?void 0:s.type)==="report"||((s==null?void 0:s.title)||"").includes("إيصال تسليم وردية");return e.jsx("p",{className:"text-xs text-gray-500",children:n?`تم التسليم إلى: ${s.receiverPhone}`:`من ${s.senderPhone}${s.type==="send"?` إلى ${s.receiverPhone}`:""}`})})(),e.jsxs("p",{className:"text-xs text-gray-400",children:[Qr.format(s.createdAt instanceof Date?s.createdAt:new Date(s.createdAt))," - ",Co.format(s.createdAt instanceof Date?s.createdAt:new Date(s.createdAt))]})]})]}),e.jsx(ot,{variant:s.status==="completed"?"default":s.status==="pending"?"secondary":"destructive",className:"text-xs",children:s.status==="completed"?"مكتمل":s.status==="pending"?"قيد المعالجة":"فشل"})]},s.id))})})})]})]}),e.jsx(uc,{isOpen:pi,onClose:()=>Na(!1),transaction:fi,onPrint:()=>window.print(),onDelete:Ni,onComplete:wi}),e.jsxs("div",{className:"space-y-1 fade-in-right w-full lg:w-5/6 mx-auto",children:[e.jsxs(Ye,{id:"transaction-section",className:"bg-gradient-to-br from-white via-blue-50/30 to-indigo-50/50 border border-blue-200/40 rounded-lg shadow-lg hover:shadow-lg transition-all duration-200 group relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/5 via-indigo-500/3 to-purple-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-200"}),e.jsx("div",{className:"absolute top-0 right-0 w-32 h-32 sm:w-28 sm:h-28 lg:w-20 lg:h-20 bg-gradient-to-bl from-blue-400/10 to-transparent rounded-full  "}),e.jsx("div",{className:"absolute bottom-0 left-0 w-24 h-24 bg-gradient-to-tr from-indigo-400/10 to-transparent rounded-full  ",style:{animationDelay:"1s"}}),e.jsx(ht,{className:"pb-0.5 px-3 pt-1 lg:pt-0.5 lg:pb-0.5 lg:px-2 relative z-10",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Ct,{className:"text-sm font-bold flex items-center gap-2 text-gray-800",children:[e.jsxs("div",{className:"relative",children:[e.jsx(ks,{className:"h-1 w-1 text-emerald-500 "}),e.jsx("div",{className:"absolute inset-0 h-1 w-1 bg-emerald-400 rounded-full opacity-20 "})]}),e.jsx("span",{className:"bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent",children:"إجراء معاملة جديدة"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[I&&e.jsx("div",{className:"hidden md:flex items-center gap-1 bg-gradient-to-r from-emerald-50 to-green-50 hover:from-emerald-100 hover:to-green-100 border border-emerald-200 text-emerald-800 text-sm transition-all duration-300 hover:scale-105 h-9 px-3 rounded-xl shadow-sm",children:e.jsxs("span",{className:"text-sm font-semibold whitespace-nowrap",children:["تجربة: ",le," ",le>=3&&le<=10?"ساعات":le===2?"ساعتين":"ساعة"]})}),e.jsxs("div",{className:"hidden md:flex items-center gap-2 bg-gradient-to-r from-gray-50 to-slate-50 hover:from-gray-100 hover:to-slate-100 border border-gray-200 transition-all duration-300 hover:scale-105 h-9 px-3 rounded-xl shadow-sm",children:[e.jsx(zc,{}),e.jsx(yc,{})]})]}),bo&&e.jsxs(c,{variant:"outline",size:"sm",className:"hidden flex items-center gap-1.5 sm:gap-2 bg-gradient-to-r from-cyan-50 to-blue-50 hover:from-cyan-100 hover:to-blue-100 border-cyan-200 text-cyan-800 text-xs sm:text-sm transition-all duration-300 hover:scale-105 hover:shadow-lg h-10 sm:h-12 px-4 sm:px-5 rounded-xl min-w-[44px] touch-manipulation",onClick:rl,title:"مزامنة البيانات المحفوظة محلياً مع الخادم",children:[e.jsx(Tc,{className:"h-3.5 w-3.5 sm:h-4 sm:w-4 animate-spin"}),e.jsx("span",{className:"text-xs sm:text-sm font-semibold whitespace-nowrap",children:"مزامنة"})]})]})}),e.jsxs(Ze,{className:"space-y-1 px-2 pb-2 relative z-10",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-0.5 p-0.5 bg-gradient-to-r from-gray-50 to-slate-50 rounded-xl border border-gray-200/50 fade-in-up w-full lg:w-5/6 mx-auto ",children:[e.jsxs(c,{variant:Y==="transfer"?"default":"ghost",onClick:()=>dl("transfer"),className:`text-xs font-semibold transition-all duration-300 hover:scale-105 h-7 rounded-lg px-2 ${Y==="transfer"?"bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg hover:shadow-md hover:from-blue-600 hover:to-indigo-700":"text-gray-600 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 hover:text-blue-700 hover:border-blue-200"}`,children:[e.jsx(ga,{className:"h-1 w-1 mr-1"}),"تحويل"]}),e.jsxs(c,{variant:Y==="withdraw"?"default":"ghost",onClick:()=>dl("withdraw"),className:`text-xs font-semibold transition-all duration-300 hover:scale-105 h-7 rounded-lg px-2 ${Y==="withdraw"?"bg-gradient-to-r from-emerald-500 to-green-600 text-white shadow-lg hover:shadow-md hover:from-emerald-600 hover:to-green-700":"text-gray-600 hover:bg-gradient-to-r hover:from-emerald-50 hover:to-green-50 hover:text-emerald-700 hover:border-emerald-200"}`,children:[e.jsx(nr,{className:"h-1 w-1 mr-1"}),"سحب"]})]}),e.jsxs("div",{className:"fade-in-up",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("label",{className:"text-sm font-semibold text-gray-700 block flex items-center gap-2",children:[e.jsx(Ht,{className:"h-1 w-1 text-blue-600"}),"اختيار المحفظة"]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsxs(c,{variant:"ghost",size:"sm",className:"h-6 rounded-md px-2 text-[10px] bg-emerald-50 text-emerald-700 hover:bg-emerald-100 border border-emerald-200",onClick:()=>L("/user/add-wallet"),title:"إضافة محفظة",children:[e.jsx(gt,{className:"h-3 w-3 mr-1"}),"إضافة محفظة"]}),e.jsxs(c,{variant:"ghost",size:"sm",className:"h-6 rounded-md px-2 text-[10px] bg-indigo-50 text-indigo-700 hover:bg-indigo-100 border border-indigo-200",onClick:()=>Xs(!0),title:"المحافظ",children:[e.jsx(Ht,{className:"h-3 w-3 mr-1"}),"المحافظ"]})]})]}),je.length>0?e.jsxs(js,{value:G,onValueChange:No,children:[e.jsx(Ns,{"data-testid":"wallet-select",className:"w-full h-12 text-sm bg-gradient-to-r from-white to-gray-50 border-2 border-gray-200 hover:border-blue-400 focus:border-blue-500 rounded-xl transition-all duration-300 hover:shadow-md focus:shadow-lg",children:e.jsx(ws,{placeholder:"اختر محفظة للمعاملة",className:"text-gray-600"})}),e.jsx(Ss,{className:"rounded-xl border-2 border-gray-200 shadow-md max-h-[220px] overflow-y-auto z-50 ",children:e.jsx("div",{className:"max-h-[180px] overflow-y-auto pr-1",children:je.map(s=>e.jsx(qt,{value:s.id,className:"rounded-lg hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 transition-all duration-200",children:e.jsxs("div",{className:"flex items-center gap-1 py-1 w-full justify-between",children:[e.jsx("div",{className:"p-1 bg-gradient-to-r from-blue-100 to-indigo-100 rounded-lg",children:e.jsx(Ht,{className:"h-1 w-1 text-blue-600"})}),e.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-sm font-medium text-gray-800",children:s.name}),e.jsxs("span",{className:"text-[10px] text-gray-500",children:["(",s.phone,")"]})]}),s.isDefault&&e.jsx(ot,{variant:"secondary",className:"text-[10px] bg-gradient-to-r from-emerald-100 to-green-100 text-emerald-700 border-emerald-200",children:"افتراضي"})]}),e.jsx("div",{className:"ml-auto flex flex-col items-end gap-1"})]})},s.id))})})]}):e.jsx("div",{className:"rounded-xl border-2 border-dashed border-gray-200 bg-gray-50 px-3 py-3 text-xs text-gray-600",children:"لا توجد محافظ حتى الآن. اضغط “إضافة محفظة” لإضافة أول محفظة."})]}),e.jsx(ce,{open:dr,onOpenChange:Xs,children:e.jsxs(de,{className:"sm:max-w-3xl w-[95vw] sm:w-auto max-h-[80vh] overflow-y-auto",children:[e.jsx(me,{children:e.jsx(he,{children:"عرض المحافظ"})}),e.jsx("div",{className:"mt-2",children:e.jsx(vc,{showAddButton:!1,showUsageBars:!1,showLimitCards:!1,showEditButton:!0})})]})}),G&&je.length>0&&(()=>{const s=je.find(st=>st.id===G),n=ml(G),r=Do(G),i=(Me==null?void 0:Me.monthlyWithdrawLimit)??(s==null?void 0:s.monthlyWithdrawalLimit)??2e5,d=(Me==null?void 0:Me.monthlyTransferLimit)??(s==null?void 0:s.monthlyTransferLimit)??2e5,v=n.totalWithdrawn??(Me==null?void 0:Me.monthlyWithdrawUsed)??0,f=n.totalTransferred??(Me==null?void 0:Me.monthlyTransferUsed)??0,j=(Me==null?void 0:Me.dailyWithdrawLimit)??1e5,E=(Me==null?void 0:Me.dailyTransferLimit)??6e4,T=r.totalWithdrawn??(Me==null?void 0:Me.dailyWithdrawUsed)??0,N=r.totalTransferred??(Me==null?void 0:Me.dailyTransferUsed)??0,D=parseFloat(Re||"0")||0,U=v+(Y==="withdraw"?D:0),C=f+(Y==="transfer"?D:0),Z=T+(Y==="withdraw"?D:0),Ve=N+(Y==="transfer"?D:0);return s?e.jsxs("div",{className:"fade-in-up mb-2 space-y-2",children:[e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-1 rounded-md border border-gray-200 shadow-sm hover:shadow-md transition-all duration-300",children:[e.jsxs("div",{className:"text-[10px] text-gray-600 font-medium mb-1 text-center",children:["الحدود الشهرية: ",s.name]}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-red-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-red-400 to-red-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(U/Math.max(i,1)*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-blue-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-400 to-blue-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(C/Math.max(d,1)*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-[10px] text-red-600 font-medium",children:["متبقي سحب: ",Math.max(i-U,0).toLocaleString("en-US")," جنيه"]}),e.jsxs("div",{className:"text-[10px] text-blue-600 font-medium",children:["متبقي تحويل: ",Math.max(d-C,0).toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-1 rounded-md border border-gray-200 shadow-sm hover:shadow-md transition-all duration-300",children:[e.jsxs("div",{className:"text-[10px] text-gray-600 font-medium mb-1 text-center",children:["الحدود اليومية: ",s.name]}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-orange-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-orange-400 to-orange-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(Z/Math.max(j,1)*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-green-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-green-400 to-green-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(Ve/Math.max(E,1)*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-[10px] text-orange-600 font-medium",children:["متبقي سحب يومي: ",Math.max(j-Z,0).toLocaleString("en-US")," جنيه"]}),e.jsxs("div",{className:"text-[10px] text-green-600 font-medium",children:["متبقي تحويل يومي: ",Math.max(E-Ve,0).toLocaleString("en-US")," جنيه"]})]})]})]}):null})(),Y==="transfer"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المرسل"}),e.jsxs("div",{className:"relative",children:[e.jsx(os,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(M,{value:we,onChange:s=>jt(s.target.value),onKeyDown:s=>{if(s.key==="Enter"){const n=document.getElementById("receiverPhoneInput");if(n)n.focus();else{const r=document.getElementById("amountInput");r==null||r.focus()}}},placeholder:"01030302038",className:"pl-10 h-10 text-sm transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]})]}),!g&&e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المستقبل"}),e.jsxs("div",{className:"relative",children:[e.jsx(os,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(M,{id:"receiverPhoneInput",value:Be,onChange:s=>{Bt(s.target.value),xr&&$s(!1)},onKeyDown:s=>{if(s.key==="Enter"){const n=document.getElementById("amountInput");n==null||n.focus()}},inputMode:"numeric",maxLength:11,placeholder:"أدخل رقم المستقبل",className:"pl-10 h-10 text-sm transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المستقبل"}),e.jsxs("div",{className:"relative",children:[e.jsx(os,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(M,{value:G&&((ul=je.find(s=>s.id===G))==null?void 0:ul.phone)||"",readOnly:!0,placeholder:"اختر محفظة أولاً",className:"pl-10 h-10 text-sm bg-gray-50 transition-all duration-300"})]})]}),Y==="transfer"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"المبلغ (جنيه)"}),e.jsxs("div",{className:"relative flex items-center gap-2",children:[e.jsx(Xe,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(M,{id:"amountInput",value:Re,onChange:s=>{Mt(s.target.value),xr&&$s(!1)},onKeyDown:s=>{if(s.key==="Enter"){const n=document.getElementById("transferCommissionInput");if(n)n.focus();else{const r=document.getElementById("quickDebtButton");r==null||r.focus()}}},placeholder:"أدخل المبلغ",type:"number",className:"pl-10 h-10 text-sm transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),pt?e.jsxs("div",{className:"mt-2 text-xs text-green-700 bg-green-50 border border-green-200 rounded px-2 py-1 flex items-center gap-2",children:[e.jsxs("span",{children:["تم إدخال تفاصيل الأجل لـ ",pt.debtorName," بمبلغ ",pt.amount," جنيه"]}),e.jsx(c,{type:"button",variant:"ghost",size:"sm",className:"h-6 px-2",onClick:()=>Zs(null),children:"إلغاء"})]}):null]}),(()=>{if(g)return null;const s=hs();return s&&s.defaultTransferCommission!=null?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة التحويل (تلقائية)"}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["سيتم تطبيق عمولة التحويل الافتراضية لكل ألف: ",s==null?void 0:s.defaultTransferCommission," جنيه لكل ألف"]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(c,{id:"quickDebtButton",type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const r=hs(),i=(r==null?void 0:r.defaultTransferCommission)!=null?Number(r.defaultTransferCommission):0,d=parseFloat(Re||"0")||0,v=Math.round((i||0)*d/1e3*100)/100,f=d+v;Lt((f||0).toString()),Ae?l({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):Nt(!0)},children:"أجل"}),e.jsx(c,{type:"button",variant:"outline",size:"icon",className:"hidden",title:ye?"العمولة تُضاف":"العمولة تُخصم",children:ye?e.jsx(gt,{className:"h-4 w-4 text-green-600"}):e.jsx(Is,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"hidden",children:ye?"العمولة تُضاف":"العمولة تُخصم"})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة التحويل على العملية (جنيه)"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(Xe,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-orange-500"}),e.jsx(M,{id:"transferCommissionInput",value:dt,onChange:r=>W(r.target.value),placeholder:"أدخل عمولة التحويل",type:"number",className:"pl-10 h-10 text-sm transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),e.jsx(c,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const r=hs(),i=parseFloat(Re||"0")||0;let d=0;if((r==null?void 0:r.defaultTransferCommission)!=null){const f=Number(r.defaultTransferCommission)||0;d=Math.round(f*i/1e3*100)/100}else{const f=dt&&dt.trim()!==""?parseFloat(dt):0;d=Math.max(0,f)}const v=i+d;Lt((v||0).toString()),Ae?l({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):Nt(!0)},children:"أجل"}),e.jsx(c,{type:"button",variant:"outline",size:"icon",className:"hidden",title:ye?"العمولة تُضاف":"العمولة تُخصم",children:ye?e.jsx(gt,{className:"h-4 w-4 text-green-600"}):e.jsx(Is,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"hidden",children:ye?"العمولة تُضاف":"العمولة تُخصم"})]}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"يمكنك إدخال عمولة العملية الإجمالية (اختياري)"})]})})(),(()=>{const s=Je(we||"").replace(/\D/g,""),n=Je(Be||"").replace(/\D/g,"");return Y==="transfer"&&(s.startsWith("010")&&(n.startsWith("011")||n.startsWith("012")||n.startsWith("015"))||s.startsWith("012")&&n.startsWith("010")||s.startsWith("011")&&n.startsWith("010")||s.startsWith("015")&&n.startsWith("010"))?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رسوم التحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Xe,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-orange-500"}),e.jsx(M,{id:"transferExtraFeeInput",value:xe,onChange:i=>ft(i.target.value),placeholder:"أدخل رسوم التحويل",type:"number",className:"pl-10 h-10 text-sm transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),e.jsx("div",{className:"hidden",children:"تُخصم من المحفظة وتضاف للدرج — لعمليات 010 → 011/012/015 أو 012 → 010 أو 011 → 010 أو 015 → 010"})]}):null})(),e.jsx(c,{onClick:hl,className:"w-full font-medium h-10 text-sm btn-bounce hover-glow transition-all duration-300 bg-blue-600 hover:bg-blue-700 text-white",children:xr?"تم التحويل بنجاح":"تأكيد التحويل"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"مبلغ السحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(nr,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-green-500"}),e.jsx(M,{id:"amountInput",value:Re,onChange:s=>{Mt(s.target.value),Dn&&aa(!1)},onKeyDown:s=>{if(s.key==="Enter"){const n=document.getElementById("manualWithdrawCommissionInput");if(n)n.focus();else{const r=document.getElementById("withdrawSubmitButton");r==null||r.focus()}}},placeholder:"أدخل مبلغ السحب",type:"number",className:"pl-10 h-10 text-sm transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]})]}),(()=>{const s=hs();return s&&s.defaultWithdrawCommission!=null?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة السحب (تلقائية)"}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["سيتم تطبيق عمولة السحب الافتراضية لكل ألف: ",s==null?void 0:s.defaultWithdrawCommission," جنيه لكل ألف"]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(c,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const r=hs(),i=parseFloat(Re||"0")||0,d=(r==null?void 0:r.defaultWithdrawCommission)!=null&&Number(r.defaultWithdrawCommission)||0,v=Math.round(d*i/1e3*100)/100,f=ye?i+v:i;Lt((f||0).toString()),Ae?l({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):Nt(!0)},children:"أجل"}),e.jsx(c,{type:"button",variant:"outline",size:"icon",className:"h-8 w-8",onClick:()=>Ft(r=>!r),title:ye?"العمولة تُضاف إلى الدين":"العمولة تُخصم من الدين",children:ye?e.jsx(gt,{className:"h-4 w-4"}):e.jsx(Is,{className:"h-4 w-4"})}),e.jsx("span",{className:"text-xs text-gray-600",children:ye?"العمولة تُضاف":"العمولة تُخصم"})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة السحب على العملية (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Xe,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-orange-500"}),e.jsx(M,{id:"manualWithdrawCommissionInput",value:xt,onChange:r=>ea(r.target.value),onKeyDown:r=>{if(r.key==="Enter"){const i=document.getElementById("withdrawSubmitButton");i==null||i.focus()}},placeholder:"أدخل العمولة المطلوبة",type:"number",className:"pl-10 h-10 text-sm transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"أدخل العمولة الإجمالية لإتمام عملية السحب"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(c,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const r=hs(),i=parseFloat(Re||"0")||0;let d=0;if((r==null?void 0:r.defaultWithdrawCommission)!=null){const f=Number(r.defaultWithdrawCommission)||0;d=Math.round(f*i/1e3*100)/100}else{const f=xt&&xt.trim()!==""?parseFloat(xt):Math.round(i*.01*100)/100;d=Math.max(0,f)}const v=ye?i+d:i;Lt((v||0).toString()),Ae?l({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):Nt(!0)},children:"أجل"}),e.jsx(c,{type:"button",variant:"outline",size:"icon",title:ye?"العمولة تُضاف":"العمولة تُخصم",onClick:()=>Ft(r=>!r),children:ye?e.jsx(gt,{className:"h-4 w-4 text-green-600"}):e.jsx(Is,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"text-xs text-gray-600",children:ye?"العمولة تُضاف":"العمولة تُخصم"})]})]})})(),e.jsx(c,{id:"withdrawSubmitButton",onClick:hl,className:"w-full font-medium h-10 text-sm btn-bounce hover-glow transition-all duration-300 bg-green-600 hover:bg-green-700 text-white",children:Dn?"تم السحب بنجاح":"تأكيد السحب"})]}),e.jsx(ce,{open:Qt,onOpenChange:Nt,children:e.jsxs(de,{children:[e.jsxs(me,{children:[e.jsx(he,{children:"تحويل مؤجل"}),e.jsx(Ut,{children:"أدخل بيانات صاحب الدين والمبلغ والملاحظات ثم اضغط حفظ"})]}),e.jsxs("div",{className:"space-y-3",children:[es&&es.length>0?e.jsxs("div",{children:[e.jsx(V,{children:"اختيار عميل"}),e.jsxs(js,{value:Qs,onValueChange:s=>{cr(s);const n=es.find(r=>r.id===s);n&&Es(n.name)},children:[e.jsx(Ns,{className:"w-full",children:e.jsx(ws,{placeholder:"اختر عميل"})}),e.jsx(Ss,{children:es.map(s=>e.jsxs(qt,{value:s.id,children:[s.name,s.mobile?` — ${s.mobile}`:""]},s.id))})]})]}):e.jsx("div",{className:"text-xs text-gray-500",children:"لا يوجد عملاء مُسجلين حالياً. يمكنك إضافة عميل من نافذة الديون."}),e.jsxs("div",{children:[e.jsx(V,{htmlFor:"quickDebtName",children:"اسم صاحب الدين"}),e.jsx(M,{id:"quickDebtName",value:Fs,onChange:s=>Es(s.target.value),placeholder:"اكتب الاسم"})]}),e.jsxs("div",{children:[e.jsx(V,{htmlFor:"quickDebtAmount",children:"المبلغ (محسوب تلقائياً)"}),e.jsx(M,{id:"quickDebtAmount",type:"number",value:Gs,readOnly:!0,placeholder:"المبلغ + عمولة التحويل"})]}),e.jsxs("div",{children:[e.jsx(V,{htmlFor:"quickDebtNotes",children:"ملاحظات"}),e.jsx(M,{id:"quickDebtNotes",value:Bs,onChange:s=>lt(s.target.value),placeholder:"اكتب ملاحظات (اختياري)"})]})]}),e.jsx(Ce,{children:e.jsx(c,{type:"button",onClick:()=>{const s=hs(),n=parseFloat((Re||"").toString())||0;let r=0;if(Y==="transfer")if((s==null?void 0:s.defaultTransferCommission)!=null){const v=Number(s.defaultTransferCommission)||0;r=Math.round(v*n/1e3*100)/100}else{const v=dt&&dt.trim()!==""?parseFloat(dt):0;r=Math.max(0,v)}else if((s==null?void 0:s.defaultWithdrawCommission)!=null){const v=Number(s.defaultWithdrawCommission)||0;r=Math.round(v*n/1e3*100)/100}else{const v=xt&&xt.trim()!==""?parseFloat(xt):Math.round(n*.01*100)/100;r=Math.max(0,v)}let i=0;if(Y==="withdraw"?i=ye?n:Math.max(0,Math.round((n-r)*100)/100):i=Math.max(0,Math.round((n+r)*100)/100),!Fs||isNaN(i)||i<=0){l({title:"خطأ في بيانات الأجل",description:"يرجى إدخال الاسم والمبلغ بشكل صحيح",variant:"destructive"});return}const d=es.find(v=>v.id===Qs);Zs({debtorName:Fs,amount:i,notes:Bs,customerId:Qs||void 0,mobile:d==null?void 0:d.mobile}),ja(!1),Nt(!1),l({title:"تم حفظ بيانات الأجل",description:"سيتم إضافة الدين عند تأكيد العملية",variant:"default"})},children:"حفظ"})})]})})]})]}),e.jsx(Ye,{className:"bg-gradient-to-br from-red-50 to-red-100 border-red-200 fade-in-up card-float",children:e.jsxs(Ze,{className:"p-3 text-center",children:[e.jsx("div",{className:"text-red-600 font-medium text-[10px] mb-1",children:"⚠️ تحذير من التحويل"}),e.jsx("div",{className:"text-[10px] text-red-700",children:"لا يمكن إلغاء أي عملية بعد تأكيدها للمحافظة على الأمان"})]})})]})]}),e.jsx(Bc,{isOpen:Ue,onClose:()=>Zt(!1),initialEditingWallet:xi,onWalletUpdate:async()=>{try{await Ha()}catch(s){console.error("Error reloading wallets after update:",s)}}}),e.jsx(Mc,{isOpen:gi,onClose:()=>fn(!1),transaction:ui,onDelete:So}),e.jsx(sn,{open:yi,onOpenChange:sa,onSuccess:To,title:ko(),description:Ao()}),e.jsx(sn,{open:ji,onOpenChange:hr,onSuccess:()=>{hr(!1),yn(!0)},title:"حماية أرشيف التقارير اليومية",description:"أدخل كلمة مرور تسجيل الدخول للوصول إلى الأرشيف"}),e.jsx(xd,{open:bi,onOpenChange:yn,userId:t==null?void 0:t.uid}),e.jsx(jl,{open:Gi,onOpenChange:Ln,onSuccess:Oo,title:"تعديل الرصيد النقدي في الدرج",description:"أدخل الرقم السري والمبلغ الجديد لتعديل الرصيد النقدي في الدرج",currentBalance:_e,balanceLabel:"الرصيد النقدي",userId:t==null?void 0:t.uid}),e.jsx(jl,{open:Qi,onOpenChange:$n,onSuccess:Wo,title:"تعديل رصيد المحفظة",description:"أدخل الرقم السري والمبلغ الجديد لتعديل رصيد المحفظة",currentBalance:wt&&fe[wt]||0,balanceLabel:`رصيد ${((gl=je.find(s=>s.id===wt))==null?void 0:gl.name)||"المحفظة"}`,userId:t==null?void 0:t.uid}),e.jsx(Uc,{open:Zi,onOpenChange:Wr,onSuccess:Fo,title:"إضافة أو خصم مبلغ من رصيد المحفظة",description:"أدخل الرقم السري والمبلغ المراد إضافته أو خصمه من رصيد المحفظة",currentBalance:wt&&fe[wt]||0,balanceLabel:`رصيد ${((pl=je.find(s=>s.id===wt))==null?void 0:pl.name)||"المحفظة"}`,userId:t==null?void 0:t.uid}),e.jsx(Lc,{open:co,onOpenChange:mo,userId:t==null?void 0:t.uid}),e.jsx($c,{open:ho,onOpenChange:xo,userId:t==null?void 0:t.uid}),e.jsx(Rc,{open:uo,onOpenChange:go}),e.jsx(ce,{open:to,onOpenChange:Ba,children:e.jsxs(de,{className:"sm:max-w-md",children:[e.jsx(me,{children:e.jsx(he,{className:"text-right",children:"تعديل الدرج النقدية"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(V,{htmlFor:"amount",className:"text-right block",children:"المبلغ"}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx(M,{id:"amount",type:"number",placeholder:"أدخل المبلغ",value:Br,onChange:s=>Ma(s.target.value),className:"text-right flex-1",dir:"rtl",min:"0"}),e.jsxs("div",{className:"flex gap-1",children:[e.jsxs(c,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white px-3 py-2",onClick:()=>{if(!Hr(Rr)){l({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}const s=parseFloat(Br);if(isNaN(s)||s<=0){l({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const n=_e+s;et(n);const r={cashBalance:n,lastUpdated:new Date().toISOString()},i=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(i,JSON.stringify(r)),t!=null&&t.uid?Ne.updateUserData(t.uid,r).then(()=>{console.log("✅ تم حفظ رصيد الدرج النقدي في Firebase بنجاح"),localStorage.removeItem(i),pe(!1)}).catch(d=>{console.error("❌ خطأ في حفظ الرصيد في Firebase:",d),pe(!0)}):pe(!0),l({title:"تم بنجاح",description:`تم إضافة ${s} جنيه إلى الدرج النقدية وحفظه في السحابة`}),Ba(!1),Ma(""),_a("")},children:[e.jsx(gt,{className:"h-1 w-1 mr-1"}),"إضافة"]}),e.jsxs(c,{type:"button",size:"sm",className:"bg-red-600 hover:bg-red-700 text-white px-3 py-2",onClick:()=>{if(!Hr(Rr)){l({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}const s=parseFloat(Br);if(isNaN(s)||s<=0){l({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const n=_e-s;et(n);const r={cashBalance:n,lastUpdated:new Date().toISOString()},i=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(i,JSON.stringify(r)),t!=null&&t.uid?Ne.updateUserData(t.uid,r).then(()=>{console.log("✅ تم حفظ رصيد الدرج النقدي في Firebase بنجاح"),localStorage.removeItem(i),pe(!1)}).catch(d=>{console.error("❌ خطأ في حفظ الرصيد في Firebase:",d),pe(!0)}):pe(!0),l({title:"تم بنجاح",description:`تم خصم ${s} جنيه من الدرج النقدية وحفظه في السحابة`}),Ba(!1),Ma(""),_a("")},children:[e.jsx(Is,{className:"h-1 w-1 mr-1"}),"خصم"]})]})]}),e.jsxs("p",{className:"text-[10px] text-gray-500 text-right",children:["الرصيد الحالي: ",_e.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(V,{htmlFor:"pin",className:"text-right block",children:"الرقم السري"}),e.jsx(M,{id:"pin",type:"password",placeholder:"أدخل الرقم السري",value:Rr,onChange:s=>_a(s.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsx(Ce,{className:"flex gap-2",children:e.jsx(c,{variant:"outline",onClick:()=>{Ba(!1),Ma(""),_a("")},children:"إلغاء"})})]})}),e.jsx(ce,{open:vo,onOpenChange:Va,children:e.jsxs(de,{className:"sm:max-w-md",children:[e.jsx(me,{children:e.jsx(he,{className:"text-right text-red-600",children:"تصفير إجمالي المحفظة"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-red-50 rounded-lg border border-red-200",children:[e.jsx("p",{className:"text-red-800 font-medium mb-2",children:"تحذير!"}),e.jsx("p",{className:"text-red-700 text-sm",children:"سيتم تصفير جميع أرصدة المحافظ إلى صفر. هذا الإجراء لا يمكن التراجع عنه."}),e.jsxs("p",{className:"text-red-600 text-sm mt-2",children:["الرصيد الحالي: ",Object.values(fe).reduce((s,n)=>s+n,0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(V,{htmlFor:"resetWalletTotalPin",className:"text-right block",children:"كلمة مرور تسجيل الدخول"}),e.jsx(M,{id:"resetWalletTotalPin",type:"password",placeholder:"أدخل كلمة مرور تسجيل الدخول",value:ol,onChange:s=>qa(s.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsxs(Ce,{className:"flex gap-2",children:[e.jsx(c,{variant:"outline",onClick:()=>{Va(!1),qa("")},children:"إلغاء"}),e.jsx(c,{variant:"destructive",onClick:async()=>{if(!await Gr(ol)){l({title:"خطأ",description:"كلمة المرور غير صحيحة",variant:"destructive"});return}try{const n={};Object.keys(fe).forEach(v=>{n[v]=0}),Le(n),localStorage.setItem(Ke(),JSON.stringify(n)),Va(!1),qa("");const r=new Date().toISOString(),i={walletBalances:n,lastUpdated:r},d=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(d,JSON.stringify(i)),t!=null&&t.uid?Ne.updateUserData(t.uid,i).then(()=>{localStorage.removeItem(d),pe(!1)}).catch(v=>{console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",v),pe(!0),l({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):pe(!0),setTimeout(()=>{Le({...n})},100)}catch(n){console.error("خطأ في تصفير أرصدة المحافظ:",n),l({title:"خطأ",description:"حدث خطأ أثناء تصفير المحافظ",variant:"destructive"})}},children:"تصفير المحفظة"})]})]})}),e.jsx(ce,{open:Xi,onOpenChange:Ea,children:e.jsxs(de,{className:"sm:max-w-md",children:[e.jsx(me,{children:e.jsx(he,{className:"text-right text-red-600",children:"تصفير رصيد المحفظة المختارة"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-red-50 rounded-lg border border-red-200",children:[e.jsx("p",{className:"text-red-800 font-medium mb-2",children:"تحذير!"}),e.jsx("p",{className:"text-red-700 text-sm",children:"سيتم تصفير رصيد المحفظة المحددة إلى صفر. هذا الإجراء لا يمكن التراجع عنه."}),e.jsxs("p",{className:"text-red-600 text-sm mt-2",children:["المحفظة: ",((fl=je.find(s=>s.id===G))==null?void 0:fl.name)||G]}),e.jsxs("p",{className:"text-red-600 text-sm",children:["الرصيد الحالي: ",(G&&fe[G]?fe[G]:0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(V,{htmlFor:"resetSelectedWalletPin",className:"text-right block",children:"كلمة مرور تسجيل الدخول"}),e.jsx(M,{id:"resetSelectedWalletPin",type:"password",autoComplete:"off",placeholder:"أدخل كلمة مرور تسجيل الدخول",value:Rn,onChange:s=>Fr(s.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsxs(Ce,{className:"flex gap-2",children:[e.jsx(c,{variant:"outline",onClick:()=>{Ea(!1),Fr("")},children:"إلغاء"}),e.jsx(c,{variant:"destructive",onClick:async()=>{var n;if(!G){l({title:"اختر محفظة",description:"يرجى اختيار محفظة أولاً",variant:"destructive"});return}if(!await Gr(Rn)){l({title:"خطأ",description:"كلمة المرور غير صحيحة",variant:"destructive"});return}try{const r={...fe};r[G]=0,Le(r),localStorage.setItem(Ke(),JSON.stringify(r)),Ea(!1),Fr("");const i=new Date().toISOString(),d={walletBalances:r,lastUpdated:i},v=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(v,JSON.stringify(d)),t!=null&&t.uid?Ne.updateUserData(t.uid,d).then(()=>{localStorage.removeItem(v),pe(!1)}).catch(f=>{console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",f),pe(!0),l({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):pe(!0),l({title:"تم التصفير بنجاح",description:`تم تصفير رصيد المحفظة ${((n=je.find(f=>f.id===G))==null?void 0:n.name)||G}`})}catch(r){console.error("خطأ في تصفير رصيد المحفظة المختارة:",r),l({title:"خطأ",description:"حدث خطأ أثناء تصفير رصيد المحفظة المختارة",variant:"destructive"})}},children:"تصفير المحفظة"})]})]})}),e.jsx(ce,{open:fo,onOpenChange:Ka,children:e.jsxs(de,{className:"sm:max-w-md",children:[e.jsx(me,{children:e.jsxs(he,{className:"text-right text-green-600 flex items-center gap-2 justify-end",children:[e.jsx(gt,{className:"h-4 w-4"}),"إضافة أموال لإجمالي المحفظة"]})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-green-50 rounded-lg border border-green-200",children:[e.jsx("p",{className:"text-green-800 font-medium mb-2",children:"إضافة أموال"}),e.jsx("p",{className:"text-green-700 text-sm",children:"سيتم إضافة المبلغ المحدد إلى إجمالي المحفظة بشكل متناسب على جميع المحافظ."}),e.jsxs("p",{className:"text-green-600 text-sm mt-2",children:["الرصيد الحالي: ",Object.values(fe).reduce((s,n)=>s+n,0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"addWalletTotalAmount",className:"text-right block",children:"المبلغ المراد إضافته"}),e.jsx(M,{id:"addWalletTotalAmount",type:"number",placeholder:"أدخل المبلغ",value:el,onChange:s=>Jr(s.target.value),className:"text-right",dir:"rtl"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"addWalletTotalPin",className:"text-right block",children:"الرقم السري للتأكيد"}),e.jsx(M,{id:"addWalletTotalPin",type:"password",autoComplete:"off",placeholder:"أدخل الرقم السري",value:tl,onChange:s=>Kr(s.target.value),className:"text-right",dir:"rtl"})]})]})]}),e.jsxs(Ce,{className:"flex gap-2",children:[e.jsx(c,{variant:"outline",onClick:()=>{Ka(!1),Jr(""),Kr("")},children:"إلغاء"}),e.jsx(c,{variant:"default",className:"bg-green-600 hover:bg-green-700",disabled:sl,onClick:async()=>{const s=parseFloat(el);if(!s||s<=0){l({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}if(!jo(tl)){l({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}al(!0);try{const n=Object.values(fe).reduce((r,i)=>r+i,0);if(n===0){const r=Object.keys(fe),i=s/r.length,d={};r.forEach(v=>{d[v]=i}),Le(d),localStorage.setItem(Ke(),JSON.stringify(d)),t!=null&&t.uid?await Ne.updateUserData(t.uid,{walletBalances:d,lastUpdated:new Date().toISOString()}):pe(!0)}else{const r={};Object.entries(fe).forEach(([i,d])=>{const v=d/n,f=s*v;r[i]=d+f}),Le(r),localStorage.setItem(Ke(),JSON.stringify(r)),t!=null&&t.uid?await Ne.updateUserData(t.uid,{walletBalances:r,lastUpdated:new Date().toISOString()}):pe(!0)}setTimeout(()=>{Le(r=>({...r}))},100),Ka(!1),Jr(""),Kr("")}catch(n){console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",n),l({title:"خطأ",description:"حدث خطأ أثناء حفظ البيانات",variant:"destructive"})}finally{al(!1)}},children:sl?"جاري الإضافة...":"إضافة الأموال"})]})]})}),e.jsx(ce,{open:yo,onOpenChange:Ya,children:e.jsxs(de,{className:"sm:max-w-[425px]",children:[e.jsx(me,{children:e.jsxs(he,{className:"text-red-600 flex items-center gap-2",children:[e.jsx(At,{className:"h-1 w-1"}),"تصفير الرصيد النقدي"]})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-3",children:e.jsx("p",{className:"text-sm text-red-700",children:"⚠️ تحذير: سيتم تصفير الرصيد النقدي في الدرج إلى صفر. هذا الإجراء لا يمكن التراجع عنه."})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(V,{htmlFor:"resetCashPin",children:"كلمة مرور تسجيل الدخول"}),e.jsx(M,{id:"resetCashPin",type:"password",autoComplete:"off",placeholder:"أدخل كلمة مرور تسجيل الدخول",value:qr,onChange:s=>Yr(s.target.value)})]})]}),e.jsxs(Ce,{children:[e.jsx(c,{variant:"outline",onClick:()=>{Ya(!1),Yr("")},children:"إلغاء"}),e.jsx(c,{variant:"destructive",onClick:async()=>{if(!qr){l({title:"خطأ",description:"يرجى إدخال كلمة المرور",variant:"destructive"});return}if(!await Gr(qr)){l({title:"خطأ",description:"كلمة المرور غير صحيحة",variant:"destructive"});return}try{et(0),Ya(!1),Yr("");const n={cashBalance:0,lastUpdated:new Date().toISOString()};localStorage.setItem(Qe(),"0");const r=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(r,JSON.stringify(n)),t!=null&&t.uid?Ne.updateUserData(t.uid,n).then(()=>{localStorage.removeItem(r),pe(!1)}).catch(i=>{console.error("خطأ في حفظ الرصيد في Firebase:",i),pe(!0),l({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):pe(!0)}catch(n){console.error("خطأ في تصفير الرصيد النقدي:",n),l({title:"خطأ",description:"حدث خطأ أثناء تصفير الرصيد النقدي",variant:"destructive"})}},children:"تصفير الرصيد"})]})]})}),e.jsx(ce,{open:po,onOpenChange:za,children:e.jsxs(de,{className:"sm:max-w-[425px]",children:[e.jsx(me,{children:e.jsxs(he,{className:"text-green-600 flex items-center gap-2",children:[e.jsx(gt,{className:"h-4 w-4"}),"إضافة أموال للدرج"]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-3",children:e.jsx("p",{className:"text-sm text-green-700",children:"💰 سيتم إضافة المبلغ المحدد إلى الرصيد النقدي في الدرج"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"addCashAmount",children:"المبلغ المراد إضافته"}),e.jsx(M,{id:"addCashAmount",type:"number",placeholder:"أدخل المبلغ",value:Ja,onChange:s=>Ur(s.target.value),min:"0",step:"0.01"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"addCashPin",children:"الرقم السري لدرج النقدية"}),e.jsx(M,{id:"addCashPin",type:"password",placeholder:"أدخل الرقم السري",value:_r,onChange:s=>zr(s.target.value)})]})]}),e.jsxs(Ce,{children:[e.jsx(c,{variant:"outline",onClick:()=>{za(!1),Ur(""),zr("")},children:"إلغاء"}),e.jsx(c,{variant:"default",className:"bg-green-600 hover:bg-green-700",disabled:Zn,onClick:async()=>{if(!Ja||parseFloat(Ja)<=0){l({title:"خطأ",description:"يرجى إدخال مبلغ صحيح أكبر من صفر",variant:"destructive"});return}if(!_r){l({title:"خطأ",description:"يرجى إدخال الرقم السري",variant:"destructive"});return}if(!Hr(_r)){l({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}Xn(!0);try{const s=parseFloat(Ja),n=_e+s;et(n),localStorage.setItem(Qe(),n.toString());const r={cashBalance:n,lastUpdated:new Date().toISOString()},i=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(i,JSON.stringify(r)),t!=null&&t.uid?(await Ne.updateUserData(t.uid,r),localStorage.removeItem(i),pe(!1)):pe(!0),za(!1),Ur(""),zr("")}catch(s){console.error("خطأ في حفظ الرصيد في Firebase:",s),et(_e),localStorage.setItem("cashBalance",_e.toString()),l({title:"خطأ",description:"حدث خطأ أثناء حفظ البيانات، يرجى المحاولة مرة أخرى",variant:"destructive"})}finally{Xn(!1)}},children:Zn?"جاري الإضافة...":"إضافة الأموال"})]})]})}),e.jsx(ce,{open:Hi,onOpenChange:Or,children:e.jsxs(de,{className:"sm:max-w-md",children:[e.jsx(me,{children:e.jsx(he,{className:"text-right",children:"اختيار التاريخ والوقت للبحث"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(V,{htmlFor:"search-date",className:"text-right block",children:"التاريخ"}),e.jsx(M,{id:"search-date",type:"date",value:wa,onChange:s=>wn(s.target.value),className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(V,{htmlFor:"search-time",className:"text-right block",children:"الوقت (اختياري)"}),e.jsx(M,{id:"search-time",type:"time",value:Sa,onChange:s=>Sn(s.target.value),className:"text-right",placeholder:"اختر الوقت للبحث في ساعة محددة"}),e.jsx("p",{className:"text-[10px] text-gray-500 text-right",children:"إذا لم تختر وقتاً محدداً، سيتم البحث في كامل اليوم"})]})]}),e.jsxs(Ce,{className:"flex justify-between",children:[e.jsx(c,{variant:"outline",onClick:()=>{wn(""),Sn(""),Or(!1)},children:"مسح"}),e.jsx(c,{onClick:()=>Or(!1),children:"تطبيق"})]})]})}),e.jsx(Nl,{isOpen:R&&!S,onClose:()=>H(!1),onTrialStarted:qi}),e.jsx(Jc,{isOpen:Ci,onClose:()=>gr(!1)}),e.jsx(Kc,{isOpen:Ii,onClose:()=>Ca(!1)}),e.jsx(gc,{isOpen:Ti,onClose:()=>Ia(!1)}),e.jsx(pc,{open:ki,onOpenChange:Ta}),e.jsx(ld,{open:Ai,onOpenChange:s=>{if(s&&!Kt){l({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});return}ka(s)}}),e.jsx(ud,{open:A,onOpenChange:s=>{if(s&&!Kt){l({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}B(s)}}),e.jsx(gd,{open:z,onOpenChange:s=>{if(s&&!Kt){l({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}X(s)}}),e.jsx(ce,{open:so,onOpenChange:s=>{if(s){l({title:"قيد التطوير",description:"هذه الميزة غير متاحة حالياً."});return}La(!1)},children:e.jsxs(de,{dir:"rtl",className:"sm:max-w-md w-[95vw] sm:w-auto rounded-2xl border border-emerald-200 shadow-xl bg-gradient-to-br from-white via-green-50 to-emerald-50 backdrop-blur-md data-[state=open]:animate-in data-[state=open]:fade-in-0 data-[state=open]:zoom-in-90 data-[state=open]:slide-in-from-bottom-8 duration-300",children:[e.jsxs(me,{children:[e.jsx(he,{className:"text-right text-green-700",children:"شحن رصيد الموبايل"}),e.jsx(Ut,{className:"text-right text-gray-600",children:"أدخل البيانات ثم اضغط تأكيد"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx(V,{htmlFor:"topupPhone",className:"text-right block",children:"رقم الموبايل"}),e.jsx(M,{id:"topupPhone",value:$a,onChange:s=>Un(s.target.value),placeholder:"010xxxxxxx",className:"text-right"})]}),e.jsxs("div",{children:[e.jsx(V,{className:"text-right block",children:"شركة التشغيل"}),e.jsxs(js,{value:Ra,onValueChange:_n,children:[e.jsx(Ns,{className:"text-right",children:e.jsx(ws,{placeholder:"اختر الشركة"})}),e.jsxs(Ss,{children:[e.jsx(qt,{value:"vodafone",children:"فودافون"}),e.jsx(qt,{value:"orange",children:"أورنج"}),e.jsx(qt,{value:"etisalat",children:"اتصالات"}),e.jsx(qt,{value:"we",children:"WE"})]})]})]}),e.jsxs("div",{children:[e.jsx(V,{htmlFor:"topupAmount",className:"text-right block",children:"المبلغ بالجنيه"}),e.jsx(M,{id:"topupAmount",type:"number",value:Ua,onChange:s=>zn(s.target.value?Number(s.target.value):""),placeholder:"50",className:"text-right"})]})]}),e.jsxs(Ce,{className:"flex gap-2 justify-between",children:[e.jsx(c,{variant:"outline",onClick:()=>La(!1),className:"border-gray-300",children:"إلغاء"}),e.jsx(c,{onClick:h,disabled:Jn||!$a||!Ra||!Ua,className:"bg-emerald-600 hover:bg-emerald-700 text-white",children:Jn?"جارٍ التنفيذ...":"تأكيد الشحن"})]})]})}),e.jsx(Ts,{open:Mi,onOpenChange:na,mode:"verify",title:"الرقم السري الرئيسي لفتح الديون",description:"أدخل الرقم السري الرئيسي لفتح صفحة الديون",onSuccess:()=>{na(!1),Pa(!0)}}),e.jsx(sn,{open:eo,onOpenChange:Er,title:"تأكيد كلمة المرور لتصفير المعاملات الأخيرة",description:"لن يتم حذف الإيصالات؛ سنبدأ القائمة من الآن.",onSuccess:()=>{try{t!=null&&t.uid&&(localStorage.setItem(`recentTransactionsResetAt:${t.uid}`,new Date().toISOString()),l({title:"تم التصفير",description:"تم بدء قائمة المعاملات من الآن."}))}catch{}Er(!1)}}),e.jsx(Ts,{open:q,onOpenChange:re,mode:"verify",title:"الرقم السري لفتح مصروفات المحل",description:"أدخل الرقم السري الرئيسي لفتح نافذة مصروفات المحل",onSuccess:()=>{re(!1),P(!0)}}),e.jsx(ce,{open:Bi,onOpenChange:Pa,children:e.jsxs(de,{className:"sm:max-w-[425px]",children:[e.jsxs(me,{className:"flex items-center justify-between",children:[e.jsx(he,{className:"text-right",children:"إدارة الديون"}),e.jsxs("div",{className:"flex items-center gap-1 text-orange-700",children:[e.jsx(kc,{className:"h-4 w-4"}),e.jsxs("span",{className:"text-xs font-bold",children:[Io," جنيه"]})]})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(V,{htmlFor:"debtorName",className:"text-right col-span-1",children:"اسم المديون"}),e.jsx(M,{id:"debtorName",value:fr,onChange:s=>Tn(s.target.value),className:"col-span-3 text-right",placeholder:"أدخل اسم المديون"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(V,{htmlFor:"debtAmount",className:"text-right col-span-1",children:"المبلغ"}),e.jsx(M,{id:"debtAmount",type:"number",value:vr,onChange:s=>kn(s.target.value),className:"col-span-3 text-right",placeholder:"أدخل المبلغ"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(V,{htmlFor:"debtReason",className:"text-right col-span-1",children:"سبب الدين"}),e.jsx(M,{id:"debtReason",value:yr,onChange:s=>An(s.target.value),className:"col-span-3 text-right",placeholder:"أدخل سبب الدين"})]})]}),e.jsx(Ce,{children:e.jsx(c,{onClick:()=>{if(fr&&vr&&yr){const s={id:Date.now().toString(),debtorName:fr,amount:parseFloat(vr),reason:yr,status:"pending",createdAt:new Date,paidAmount:0,partialPayments:[]};kr(s),Oa(!0)}else l({title:"بيانات غير مكتملة",description:"يرجى إدخال الاسم والمبلغ والسبب",variant:"destructive"})},className:"bg-orange-500 hover:bg-orange-600",children:"حفظ"})}),e.jsx("div",{className:"mt-2",children:e.jsx(c,{variant:"outline",className:"w-full",onClick:()=>ia(!0),children:"إيصالات الديون"})}),e.jsx("div",{className:"mt-2",children:e.jsx(c,{variant:"outline",className:"w-full",onClick:()=>wr(!0),children:"إضافة عميل"})})]})}),e.jsx(ce,{open:Ri,onOpenChange:ia,children:e.jsxs(de,{className:"sm:max-w-[520px]",children:[e.jsxs(me,{children:[e.jsx(he,{className:"text-right",children:"إيصالات الديون"}),e.jsx(Ut,{className:"text-right",children:"اختر دينًا لعرض إيصاله بالتفصيل"})]}),yt.length>0?e.jsx("div",{className:"max-h-64 overflow-y-auto space-y-2",children:yt.map(s=>e.jsx("div",{onClick:()=>{br(s),la(!0),ia(!1),Pa(!1)},className:"p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium",children:s.debtorName}),e.jsx("p",{className:"text-sm text-gray-600",children:s.reason}),e.jsx("p",{className:"text-sm text-gray-500",children:Qr.format(s.createdAt instanceof Date?s.createdAt:new Date(s.createdAt))})]}),e.jsxs("div",{className:"text-left",children:[e.jsxs("p",{className:"font-bold text-lg",children:[s.amount," جنيه"]}),e.jsx(ot,{variant:s.status==="paid"?"default":"secondary",className:s.status==="paid"?"bg-green-500":"bg-yellow-500",children:s.status==="paid"?"مدفوع":"قيد المراجعة"})]})]})},s.id))}):e.jsx("div",{className:"text-center text-sm text-gray-500",children:"لا توجد ديون مسجلة"}),e.jsxs(Ce,{className:"flex justify-between mt-3",children:[e.jsx(c,{variant:"destructive",onClick:async()=>{try{if(!yt||yt.length===0){l({title:"لا توجد ديون",description:"القائمة فارغة بالفعل."});return}if(!window.confirm("هل تريد حذف كل إيصالات الديون؟ هذا الإجراء لا يمكن التراجع عنه."))return;const n=[];$t(n),br(null),await ts(n),l({title:"تم حذف كل إيصالات الديون",description:"تم تفريغ القائمة بالكامل."}),ia(!1)}catch(s){console.error("تعذر حذف كل إيصالات الديون:",s),l({title:"فشل الحذف",description:"حدث خطأ أثناء الحذف، حاول مرة أخرى.",variant:"destructive"})}},children:"حذف كل الإيصالات"}),e.jsx(c,{variant:"outline",onClick:()=>ia(!1),children:"إغلاق"})]})]})}),e.jsx(ce,{open:Ui,onOpenChange:wr,children:e.jsxs(de,{className:"sm:max-w-[480px]",children:[e.jsxs(me,{children:[e.jsx(he,{className:"text-right",children:"إضافة عميل"}),e.jsx(Ut,{className:"text-right",children:"أدخل بيانات العميل ثم يمكنك تسجيل مبلغ دين عليه"})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(V,{htmlFor:"customerName",className:"text-right col-span-1",children:"اسم العميل"}),e.jsx(M,{id:"customerName",value:Dr,onChange:s=>On(s.target.value),className:"col-span-3 text-right",placeholder:"اكتب اسم العميل"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(V,{htmlFor:"customerMobile",className:"text-right col-span-1",children:"رقم الموبايل"}),e.jsx(M,{id:"customerMobile",value:Cr,onChange:s=>Wn(s.target.value),className:"col-span-3 text-right",placeholder:"اكتب رقم الموبايل"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(c,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{if(!Dr||!Cr){l({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم العميل ورقم الموبايل",variant:"destructive"});return}const s={id:Date.now().toString(),name:Dr.trim(),mobile:Cr.trim(),createdAt:new Date},n=[s,...es];await lo(n),On(""),Wn(""),l({title:"تمت إضافة العميل",description:`تم إضافة ${s.name}`})},children:"إضافة"})}),e.jsxs("div",{className:"border-t pt-4 space-y-3",children:[e.jsx(V,{className:"text-right block",children:"إضافة مبلغ على عميل"}),es.length>0?e.jsxs("div",{className:"space-y-3",children:[e.jsxs(js,{value:Ir,onValueChange:Fn,children:[e.jsx(Ns,{className:"w-full",children:e.jsx(ws,{placeholder:"اختر عميل"})}),e.jsx(Ss,{children:es.map(s=>e.jsxs(qt,{value:s.id,children:[s.name," — ",s.mobile]},s.id))})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(V,{htmlFor:"customerDebtAmount",className:"text-right col-span-1",children:"المبلغ"}),e.jsx(M,{id:"customerDebtAmount",type:"number",value:En,onChange:s=>Bn(s.target.value),className:"col-span-3 text-right",placeholder:"أدخل المبلغ"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(c,{className:"bg-orange-600 hover:bg-orange-700",onClick:async()=>{const s=parseFloat(En);if(!Ir){l({title:"اختر عميل",description:"يرجى اختيار عميل أولاً",variant:"destructive"});return}if(isNaN(s)||s<=0){l({title:"قيمة غير صحيحة",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const n=es.find(d=>d.id===Ir);if(!n)return;const r={id:Date.now().toString(),debtorName:n.name,customerId:n.id,mobile:n.mobile,amount:Number(s.toFixed(2)),reason:"دين عميل",status:"pending",createdAt:new Date,paidAmount:0,partialPayments:[]},i=[...yt,r];$t(i),await ts(i),Fn(""),Bn(""),l({title:"تم تسجيل المبلغ على العميل",description:`تمت إضافة ${r.amount} جنيه للعميل ${n.name}`})},children:"إضافة المبلغ"})})]}):e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد عملاء مسجلين. أضف عميلًا أولاً."})]})]}),e.jsx(Ce,{className:"flex justify-end",children:e.jsx(c,{variant:"outline",onClick:()=>wr(!1),children:"إغلاق"})})]})}),e.jsx(ce,{open:$,onOpenChange:P,children:e.jsxs(de,{className:"sm:max-w-[520px]",children:[e.jsxs(me,{children:[e.jsx(he,{className:"text-right",children:"مصروفات المحل"}),e.jsx(Ut,{className:"text-right",children:"أدخل تفاصيل المصروف ثم اختر مصدر الخصم."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(V,{htmlFor:"expenseName",className:"text-right col-span-1",children:"اسم المصروف"}),e.jsx(M,{id:"expenseName",value:ne,onChange:s=>ue(s.target.value),className:"col-span-3 text-right",placeholder:"مثال: كهرباء، صيانة، مشتريات"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(V,{htmlFor:"expenseAmount",className:"text-right col-span-1",children:"تمن المصروف"}),e.jsx(M,{id:"expenseAmount",type:"number",value:Q,onChange:s=>ee(s.target.value),className:"col-span-3 text-right",placeholder:"0.00"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(V,{htmlFor:"expenseNotes",className:"text-right col-span-1",children:"ملاحظات"}),e.jsx(M,{id:"expenseNotes",value:Te,onChange:s=>K(s.target.value),className:"col-span-3 text-right",placeholder:"معلومات إضافية إن وجدت"})]})]}),e.jsxs(Ce,{className:"flex justify-between",children:[e.jsx(c,{className:"bg-orange-600 hover:bg-orange-700",onClick:()=>{if(!ne||!Q){l({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم المصروف وقيمته",variant:"destructive"});return}nt(!0)},children:"إضافة مصروف"}),e.jsx(c,{variant:"outline",onClick:()=>x(!0),children:"إيصالات المصاريف"})]})]})}),e.jsx(ce,{open:Ot,onOpenChange:x,children:e.jsxs(de,{className:"sm:max-w-[420px]",dir:"rtl",children:[e.jsxs(me,{children:[e.jsx(he,{className:"text-right",children:"إيصالات المصاريف"}),e.jsx(Ut,{className:"text-right",children:"آخر المصاريف المسجلة"})]}),ae.length>0?e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:ae.map(s=>e.jsx("div",{className:"p-2 border rounded-lg bg-white hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium text-sm",children:s.name}),e.jsx("p",{className:"text-[11px] text-gray-600",children:s.notes||"بدون ملاحظات"}),e.jsx("p",{className:"text-[10px] text-gray-500",children:new Date(s.createdAt).toLocaleString("ar-EG")})]}),e.jsxs("div",{className:"text-left",children:[e.jsxs("p",{className:"font-bold text-sm",children:[s.amount," جنيه"]}),e.jsx(ot,{variant:"secondary",className:s.source==="cash"?"bg-blue-100 text-blue-700":"bg-purple-100 text-purple-700",children:s.source==="cash"?"من النقدية":`من المحفظة${s.walletId?` (${s.walletId})`:""}`})]})]})},s.id))}):e.jsx("p",{className:"text-sm text-gray-500 text-center",children:"لا توجد مصاريف مسجلة بعد"})]})}),e.jsx(ce,{open:rt,onOpenChange:nt,children:e.jsxs(de,{className:"sm:max-w-[480px]",children:[e.jsx(me,{children:e.jsx(he,{className:"text-right",children:"اختيار مصدر خصم المصروف"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600 text-right",children:"اختر هل تريد خصم مبلغ المصروف من الرصيد النقدي في الدرج أم من إحدى المحافظ."}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsx(c,{variant:Se==="cash"?"default":"outline",className:Se==="cash"?"bg-blue-600 hover:bg-blue-700 text-white":"",onClick:()=>ct("cash"),children:"الفلوس النقدية"}),e.jsx(c,{variant:Se==="wallet"?"default":"outline",className:Se==="wallet"?"bg-purple-600 hover:bg-purple-700 text-white":"",onClick:()=>ct("wallet"),children:"أرصدة المحافظ"})]}),Se==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{className:"text-right block",children:"اختر المحفظة للخصم"}),e.jsxs(js,{value:$e,onValueChange:It,children:[e.jsx(Ns,{className:"w-full",children:e.jsx(ws,{placeholder:"اختر محفظة"})}),e.jsx(Ss,{children:je.map(s=>e.jsx(qt,{value:s.id,children:s.phone||s.name||s.id},s.id))})]})]})]}),e.jsxs(Ce,{className:"flex justify-between",children:[e.jsx(c,{variant:"outline",onClick:()=>{nt(!1),ct(null),It("")},children:"إلغاء"}),e.jsx(c,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{const s=Number(Q);if(isNaN(s)||s<=0){l({title:"قيمة غير صحيحة",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}if(!Se){l({title:"اختر مصدر الخصم",description:"يرجى اختيار النقدية أو المحفظة",variant:"destructive"});return}try{if(Se==="cash"){const i=Number((_e-s).toFixed(2));et(i),localStorage.setItem(Qe(),i.toString());const d={cashBalance:i,lastUpdated:new Date().toISOString()},v=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(v,JSON.stringify(d)),t!=null&&t.uid?(await Ne.updateUserData(t.uid,d),localStorage.removeItem(v),pe(!1)):pe(!0)}else if(Se==="wallet"){if(!$e){l({title:"اختر محفظة",description:"يرجى اختيار محفظة للخصم",variant:"destructive"});return}const i=fe[$e]||0,d=Number((i-s).toFixed(2)),v={...fe,[$e]:d};Le(v);const f=new Date().toISOString(),j={walletBalances:v,lastUpdated:f},E=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(E,JSON.stringify(j)),localStorage.setItem(Ke(),JSON.stringify(v)),localStorage.setItem(`walletBalances_backup_${f}`,JSON.stringify(v)),t!=null&&t.uid&&await Ne.updateUserData(t.uid,j)}}catch(i){console.error("خطأ أثناء تحديث الأرصدة عند حفظ المصروف:",i)}const n={id:Date.now().toString(),name:ne,amount:s,notes:Te,source:Se,walletId:Se==="wallet"?$e:void 0,createdAt:new Date},r=[...ae,n];await ro(r),ue(""),ee(""),K(""),ct(null),It(""),nt(!1),P(!0),x(!0),l({title:"تم إضافة المصروف",description:Se==="cash"?"تم الخصم من النقدية":"تم الخصم من أرصدة المحافظ"})},children:"تأكيد الخصم"})]})]})}),e.jsx(ce,{open:ve,onOpenChange:oe,children:e.jsxs(de,{className:"sm:max-w-[520px]",children:[e.jsxs(me,{children:[e.jsx(he,{className:"text-right",children:"النواقص"}),e.jsx(Ut,{className:"text-right",children:"سجل العناصر الناقصة التي تحتاج شراء وتابع حالتها."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(V,{htmlFor:"deficiencyName",className:"text-right col-span-1",children:"اسم العنصر"}),e.jsx(M,{id:"deficiencyName",value:ke,onChange:s=>Pe(s.target.value),className:"col-span-3 text-right",placeholder:"مثال: سكر، زيت، مناديل"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(V,{htmlFor:"deficiencyQuantity",className:"text-right col-span-1",children:"الكمية"}),e.jsx(M,{id:"deficiencyQuantity",type:"number",value:Ee,onChange:s=>Tt(s.target.value),className:"col-span-3 text-right",placeholder:"1"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(c,{className:"bg-rose-600 hover:bg-rose-700",onClick:()=>{if(Ae){l({title:"غير متاح",description:"النواقص غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"});return}const s=parseInt(Ee||"1",10);if(!ke){l({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم العنصر",variant:"destructive"});return}if(isNaN(s)||s<=0){l({title:"كمية غير صحيحة",description:"يرجى إدخال كمية صحيحة",variant:"destructive"});return}const n={id:Date.now().toString(),name:ke,quantity:s,status:"pending",createdAt:new Date};He(r=>{const i=[...r,n];return Mr(i),i}),Pe(""),Tt(""),l({title:"تمت الإضافة",description:"تمت إضافة العنصر إلى قائمة النواقص"})},children:"إضافة للنواقص"})}),Wt.length>0?e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:Wt.map(s=>e.jsx("div",{className:"p-2 border rounded-lg bg-white hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium text-sm",children:s.name}),e.jsxs("p",{className:"text-[11px] text-gray-600",children:["الكمية: ",s.quantity]}),e.jsx("p",{className:"text-[10px] text-gray-500",children:new Date(s.createdAt).toLocaleString("ar-EG")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ot,{variant:"secondary",className:s.status==="pending"?"bg-rose-100 text-rose-700":"bg-green-100 text-green-700",children:s.status==="pending"?"قيد الشراء":"تم الشراء"}),e.jsx(c,{variant:"outline",className:s.status==="pending"?"text-green-700 border-green-300 hover:bg-green-50":"text-rose-700 border-rose-300 hover:bg-rose-50",onClick:()=>{He(n=>{const r=n.map(i=>i.id===s.id?{...i,status:i.status==="pending"?"purchased":"pending"}:i);return Mr(r),r})},title:s.status==="pending"?"تم الشراء":"إلغاء الشراء",children:s.status==="pending"?"تم الشراء":"إلغاء الشراء"}),e.jsx(c,{variant:"outline",className:"text-red-700 border-red-300 hover:bg-red-50",onClick:()=>{He(n=>{const r=n.filter(i=>i.id!==s.id);return Mr(r),r})},title:"حذف",children:"حذف"})]})]})},s.id))}):e.jsx("p",{className:"text-sm text-gray-500 text-center",children:"لا توجد عناصر مسجلة في النواقص"})]}),e.jsx(Ce,{className:"flex justify-end",children:e.jsx(c,{variant:"outline",onClick:()=>oe(!1),children:"إغلاق"})})]})}),e.jsx(ce,{open:_i,onOpenChange:Oa,children:e.jsxs(de,{className:"sm:max-w-[480px]",children:[e.jsx(me,{children:e.jsx(he,{className:"text-right",children:"اختيار مصدر خصم الدين"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600 text-right",children:"اختر هل تريد خصم مبلغ الدين من الرصيد النقدي في الدرج أم من إحدى المحافظ أو تسجيله بدون خصم."}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsx(c,{variant:kt==="cash"?"default":"outline",className:kt==="cash"?"bg-blue-600 hover:bg-blue-700 text-white":"",onClick:()=>oa("cash"),children:"الفلوس النقدية"}),e.jsx(c,{variant:kt==="wallet"?"default":"outline",className:kt==="wallet"?"bg-purple-600 hover:bg-purple-700 text-white":"",onClick:()=>oa("wallet"),children:"أرصدة المحافظ"}),e.jsx(c,{variant:kt==="none"?"default":"outline",className:kt==="none"?"bg-gray-600 hover:bg-gray-700 text-white":"",onClick:()=>oa("none"),children:"بدون خصم"})]}),kt==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{className:"text-right block",children:"اختر المحفظة للخصم"}),e.jsxs(js,{value:Wa,onValueChange:Ar,children:[e.jsx(Ns,{className:"w-full",children:e.jsx(ws,{placeholder:"اختر محفظة"})}),e.jsx(Ss,{children:je.map(s=>e.jsx(qt,{value:s.id,children:s.phone||s.name||s.id},s.id))})]})]})]}),e.jsxs(Ce,{className:"flex justify-between",children:[e.jsx(c,{variant:"outline",onClick:()=>{Oa(!1),kr(null),oa(null),Ar("")},children:"إلغاء"}),e.jsx(c,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{if(!Tr)return;const s=Number(Tr.amount);if(!kt){l({title:"اختر مصدر الخصم",description:"يرجى اختيار النقدية أو المحفظة",variant:"destructive"});return}try{if(kt==="cash"){const r=Number((_e-s).toFixed(2));et(r),localStorage.setItem(Qe(),r.toString());const i=new Date().toISOString(),d={cashBalance:r,lastUpdated:i},v=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(v,JSON.stringify(d)),t!=null&&t.uid?await Ne.updateUserData(t.uid,d).then(()=>{localStorage.removeItem(v),pe(!1)}).catch(()=>{pe(!0)}):pe(!0)}else if(kt==="wallet"){if(!Wa){l({title:"اختر محفظة",description:"يرجى اختيار محفظة للخصم",variant:"destructive"});return}const r=fe[Wa]||0,i=Number((r-s).toFixed(2)),d={...fe,[Wa]:i};Le(d);const v=new Date().toISOString(),f={walletBalances:d,lastUpdated:v},j=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(j,JSON.stringify(f)),localStorage.setItem(Ke(),JSON.stringify(d)),localStorage.setItem(`walletBalances_backup_${v}`,JSON.stringify(d)),t!=null&&t.uid&&await Ne.updateUserData(t.uid,f)}}catch(r){console.error("خطأ أثناء تحديث الأرصدة عند حفظ الدين:",r)}const n=[...yt,Tr];$t(n),await ts(n),Tn(""),kn(""),An(""),Pa(!1),Oa(!1),kr(null),oa(null),Ar(""),l(kt==="none"?{title:"تم حفظ الدين بدون خصم",description:"لم يتم الخصم من الدرج أو المحافظ"}:{title:"تم حفظ الدين وخصم المبلغ",description:kt==="cash"?`تم خصم ${s} من الرصيد النقدي`:`تم خصم ${s} من رصيد المحفظة`})},children:"تأكيد الخصم وحفظ الدين"})]})]})}),e.jsx(ce,{open:Li,onOpenChange:la,children:e.jsxs(de,{className:"sm:max-w-[425px] z-[60]",children:[e.jsx(me,{children:e.jsx(he,{className:"text-right",children:"إيصال الدين"})}),ge&&e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"text-center border-b pb-4",children:[e.jsx("h2",{className:"text-xl font-bold",children:"إيصال دين"}),e.jsx("p",{className:"text-sm text-gray-500",children:Qr.format(ge.createdAt instanceof Date?ge.createdAt:new Date(ge.createdAt))})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"اسم المديون:"}),e.jsx("span",{children:ge.debtorName})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"المبلغ:"}),e.jsxs("span",{className:"font-bold text-lg",children:[ge.amount," جنيه"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"سبب الدين:"}),e.jsx("span",{children:ge.reason})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"الحالة:"}),e.jsx(ot,{variant:ge.status==="paid"?"default":"secondary",className:ge.status==="paid"?"bg-green-500":"bg-yellow-500",children:ge.status==="paid"?"مدفوع":"مؤجل"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"المبلغ المتبقي:"}),e.jsxs("span",{className:"font-bold text-lg",children:[Math.max(0,Number(ge.amount||0)-Number(ge.paidAmount||0))," جنيه"]})]}),ge.paidAmount?e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"إجمالي المدفوع:"}),e.jsxs("span",{className:"text-green-700",children:[ge.paidAmount," جنيه"]})]}):null,e.jsxs("div",{className:"mt-3 p-3 border rounded-lg bg-gray-50",children:[$i?e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"partialAmount",className:"text-right block",children:"المبلغ المراد دفعه"}),e.jsx(M,{id:"partialAmount",type:"number",value:Pn,onChange:s=>Nr(s.target.value),className:"text-right",placeholder:"أدخل المبلغ"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(c,{variant:"outline",onClick:()=>{jr(!1),Nr("")},children:"إلغاء"}),e.jsx(c,{className:"bg-blue-600 hover:bg-blue-700",onClick:async()=>{const s=parseFloat(Pn);if(!ge||isNaN(s)||s<=0){l({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const n=Math.max(0,Number(ge.amount||0)-Number(ge.paidAmount||0));if(s>n){l({title:"مبلغ زائد",description:"المبلغ المدفوع أكبر من المتبقي",variant:"destructive"});return}const r=Number(((ge.paidAmount||0)+s).toFixed(2)),i=r>=Number(ge.amount||0),d={...ge,amount:Number(ge.amount||0),paidAmount:r,status:i?"paid":"pending",partialPayments:[...ge.partialPayments||[],{amount:s,paidAt:new Date}]},v=yt.map(f=>f.id===ge.id?d:f);$t(v),br(d),await ts(v);try{d.status==="paid"&&(t!=null&&t.uid)&&(async()=>{const f=Ds(rs(at,"userTransactions"),Dt("userId","==",t.uid),Dt("linkedDebtId","==",ge.id),Dt("status","==","pending")),j=await Cs(f);await Promise.allSettled(j.docs.map(E=>qs(E.ref,{status:"completed",confirmedAt:new Date})))})().catch(f=>console.error("تعذر تحديث حالة المعاملات المرتبطة بالدين:",f))}catch(f){console.error("تعذر تجهيز تحديث حالة المعاملات المرتبطة:",f)}try{const f=ca(),j=localStorage.getItem(f);if(j){const T=(JSON.parse(j)||[]).map(N=>(N==null?void 0:N.linkedDebtId)===ge.id&&(N==null?void 0:N.status)==="pending"?{...N,status:"completed",confirmedAt:new Date}:N);localStorage.setItem(f,JSON.stringify(T)),_t(N=>N.map(D=>(D==null?void 0:D.linkedDebtId)===ge.id&&(D==null?void 0:D.status)==="pending"?{...D,status:"completed",confirmedAt:new Date}:D))}}catch(f){console.warn("فشل تحديث حالة المعاملات المرتبطة محلياً بعد سداد الدين:",f)}Fa(s),vs("cash"),Rs(!0),jr(!1),Nr(""),l({title:"تم تسجيل دفع جزء",description:`تم دفع ${s} جنيه بتاريخ ${new Date().toLocaleString("ar-EG")}`})},children:"دفع"})]})]}):e.jsx(c,{variant:"outline",className:"w-full",onClick:()=>jr(!0),children:"دفع جزء"}),ge.partialPayments&&ge.partialPayments.length>0&&e.jsxs("div",{className:"mt-3 text-xs text-gray-600",children:[e.jsx("p",{className:"font-medium mb-1",children:"سجل الدفعات الجزئية:"}),e.jsx("div",{className:"space-y-1 max-h-24 overflow-y-auto",children:ge.partialPayments.map((s,n)=>e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{children:["دفع: ",s.amount," جنيه"]}),e.jsx("span",{children:new Date(s.paidAt).toLocaleString("ar-EG")})]},n))})]})]})]})]}),e.jsxs(Ce,{className:"flex gap-2 justify-center",children:[e.jsx(c,{onClick:async()=>{if(ge){const s=yt.map(n=>n.id===ge.id?{...n,status:"pending"}:n);$t(s),await ts(s),la(!1),l({title:"تم تحديث حالة الدين",description:"تم تعيين الدين كمؤجل"})}},variant:"outline",className:"bg-yellow-500 hover:bg-yellow-600 text-white",children:"مؤجل"}),e.jsx(c,{onClick:async()=>{if(ge){const n=Math.max(0,Number(ge.amount||0)-Number(ge.paidAmount||0)),r=yt.map(i=>i.id===ge.id?{...i,amount:Number(i.amount||0),paidAmount:Number(((i.paidAmount||0)+n).toFixed(2)),status:"paid",partialPayments:[...i.partialPayments||[],...n>0?[{amount:n,paidAt:new Date}]:[]]}:i);$t(r),n>0&&(Fa(n),vs("cash"),Rs(!0)),await ts(r);try{t!=null&&t.uid&&(ge!=null&&ge.id)&&(async()=>{const i=Ds(rs(at,"userTransactions"),Dt("userId","==",t.uid),Dt("linkedDebtId","==",ge.id),Dt("status","==","pending")),d=await Cs(i);await Promise.allSettled(d.docs.map(v=>qs(v.ref,{status:"completed",confirmedAt:new Date})))})().catch(i=>console.error("تعذر تحديث حالة المعاملات المرتبطة بالدين:",i))}catch(i){console.error("تعذر تجهيز تحديث حالة المعاملات المرتبطة:",i)}try{const i=ca(),d=localStorage.getItem(i);if(d){const f=(JSON.parse(d)||[]).map(j=>(j==null?void 0:j.linkedDebtId)===ge.id&&(j==null?void 0:j.status)==="pending"?{...j,status:"completed",confirmedAt:new Date}:j);localStorage.setItem(i,JSON.stringify(f)),_t(j=>j.map(E=>(E==null?void 0:E.linkedDebtId)===ge.id&&(E==null?void 0:E.status)==="pending"?{...E,status:"completed",confirmedAt:new Date}:E))}}catch(i){console.warn("فشل تحديث حالة المعاملات المرتبطة محلياً بعد سداد الدين:",i)}la(!1),l({title:"تم تحديث حالة الدين",description:"تم تعيين الدين كمدفوع"})}},className:"bg-green-500 hover:bg-green-600",children:"مدفوع"}),e.jsx(c,{onClick:async()=>{if(ge){const s=yt.filter(n=>n.id!==ge.id);$t(s),await ts(s),la(!1),l({title:"تم حذف الدين",description:"تم حذف الدين بنجاح"})}},variant:"destructive",children:"حذف"})]})]})}),e.jsx(ce,{open:zi,onOpenChange:Rs,children:e.jsxs(de,{className:"sm:max-w-[425px]",children:[e.jsxs(me,{children:[e.jsx(he,{className:"text-right",children:"اختيار إضافة مبلغ السداد"}),e.jsx(Ut,{className:"text-right",children:"هل تريد إضافة مبلغ السداد إلى الفلوس النقدية أم إلى إحدى المحافظ؟"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(c,{variant:Jt==="cash"?"default":"outline",className:Jt==="cash"?"bg-blue-600 text-white":"",onClick:()=>vs("cash"),children:"الفلوس النقدية"}),e.jsx(c,{variant:Jt==="wallet"?"default":"outline",className:Jt==="wallet"?"bg-blue-600 text-white":"",onClick:()=>vs("wallet"),children:"أرصدة المحافظ"}),e.jsx(c,{variant:Jt==="none"?"default":"outline",className:Jt==="none"?"bg-gray-600 text-white":"",onClick:()=>vs("none"),children:"بدون إضافة"})]}),Jt==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-right",children:"اختر المحفظة"}),e.jsxs("select",{className:"w-full border rounded p-2 text-right",value:ys,onChange:s=>Pr(s.target.value),children:[e.jsx("option",{value:"",children:"— اختر محفظة —"}),je&&je.length>0?je.map(s=>e.jsx("option",{value:s.id,children:s.phone||s.name||s.id},s.id)):Object.keys(fe||{}).map(s=>{var n,r,i,d,v,f;return e.jsx("option",{value:s,children:((n=je.find(j=>j.id===s))==null?void 0:n.phone)||((i=(r=JSON.parse(localStorage.getItem(Us())||"[]"))==null?void 0:r.find(j=>j.id===s))==null?void 0:i.phone)||((v=(d=JSON.parse(localStorage.getItem(Us())||"[]"))==null?void 0:d.find(j=>j.id===s))==null?void 0:v.name)||((f=je.find(j=>j.id===s))==null?void 0:f.name)||s},s)})]})]}),e.jsxs("div",{className:"text-right text-sm text-gray-600",children:["المبلغ المراد إضافته: ",e.jsxs("span",{className:"font-bold",children:[Mn," جنيه"]})]})]}),e.jsxs(Ce,{className:"flex justify-end",children:[e.jsx(c,{variant:"outline",onClick:()=>{Rs(!1),Fa(0),vs(null),Pr("")},children:"إلغاء"}),e.jsx(c,{onClick:async()=>{var s,n;try{const r=Mn;if(!r||r<=0){Rs(!1);return}if(Jt==="cash"){const i=_e+r;et(i),localStorage.setItem(Qe(),i.toString());const d={cashBalance:i,lastUpdated:new Date().toISOString()},v=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(v,JSON.stringify(d)),t!=null&&t.uid?(Ne.updateUserData(t.uid,d).catch(()=>pe(!0)),localStorage.removeItem(v),pe(!1)):pe(!0),l({title:"تمت إضافة مبلغ السداد",description:`تمت إضافة ${r} جنيه إلى الفلوس النقدية`})}else if(Jt==="wallet"){if(!ys){l({title:"اختر محفظة أولاً",description:"يرجى اختيار المحفظة لإضافة مبلغ السداد إليها",variant:"destructive"});return}const i={...fe,[ys]:(fe[ys]||0)+r};Le(i);const d=(_e||0)-r;et(d),localStorage.setItem(Qe(),d.toString());const v=new Date().toISOString(),f={walletBalances:i,cashBalance:d,lastUpdated:v},j=`userData_${t==null?void 0:t.uid}`;if(localStorage.setItem(j,JSON.stringify(f)),localStorage.setItem(Ke(),JSON.stringify(i)),localStorage.setItem(`walletBalances_backup_${v}`,JSON.stringify(i)),t!=null&&t.uid){Ne.updateUserData(t.uid,f).catch(()=>pe(!0));try{localStorage.removeItem(j)}catch{}pe(!1)}else pe(!0);l({title:"تمت إضافة مبلغ السداد",description:`تمت إضافة ${r} جنيه إلى المحفظة ${((s=je.find(E=>E.id===ys))==null?void 0:s.phone)||((n=je.find(E=>E.id===ys))==null?void 0:n.name)||ys} وتم خصم نفس المبلغ من درج النقدية`})}else if(Jt==="none"){const i=(_e||0)-r;et(i),localStorage.setItem(Qe(),i.toString());const d={cashBalance:i,lastUpdated:new Date().toISOString()},v=`userData_${t==null?void 0:t.uid}`;if(localStorage.setItem(v,JSON.stringify(d)),t!=null&&t.uid){Ne.updateUserData(t.uid,d).catch(()=>pe(!0));try{localStorage.removeItem(v)}catch{}pe(!1)}else pe(!0);l({title:"تم تسجيل السداد",description:`تم خصم ${r} جنيه من درج النقدية بدون إضافة للمحافظ`})}else{l({title:"اختر مصدر الإضافة",description:"يرجى اختيار إضافة المبلغ إلى النقدية أو المحفظة",variant:"destructive"});return}}catch(r){console.error("خطأ أثناء إضافة مبلغ السداد:",r),l({title:"حدث خطأ",description:"تعذر إضافة مبلغ السداد، حاول مرة أخرى",variant:"destructive"})}finally{Rs(!1),Fa(0),vs(null),Pr("")}},className:"bg-green-600 hover:bg-green-700",children:"تأكيد الإضافة"})]})]})}),e.jsx(ce,{open:Di,onOpenChange:Da,children:e.jsxs(de,{hideClose:!0,className:"sm:max-w-[420px] w-[90vw] rounded-2xl bg-gradient-to-br from-white via-indigo-50 to-blue-50 shadow-2xl border border-indigo-100",children:[e.jsxs(me,{children:[e.jsx(he,{className:"text-right text-2xl font-bold",children:(vt==null?void 0:vt.type)==="transfer"?"مبلغ يجب استلامه":"مبلغ يجب تسليمه"}),e.jsx(Ut,{className:"text-right text-gray-600",children:(vt==null?void 0:vt.type)==="transfer"?"هذا هو المبلغ الواجب استلامه من العميل بعد التأكيد.":"هذا هو المبلغ الواجب تسليمه للعميل بعد التأكيد."})]}),e.jsxs("div",{className:"py-4 flex flex-col items-center gap-2",children:[e.jsxs("div",{className:"text-4xl font-extrabold text-blue-700 tracking-wider",children:[vt==null?void 0:vt.amount," جنيه"]}),e.jsx("div",{className:"text-sm text-gray-500 text-right w-full",children:(vt==null?void 0:vt.type)==="transfer"?"المبلغ المعروض شامل عمولة التحويل.":ye?"العمولة مضافة ولا تؤثر على قيمة التسليم.":"العمولة مخصومة من المبلغ المسلّم للعميل."})]}),e.jsx(Ce,{className:"flex justify-end gap-2",children:e.jsx(c,{onClick:()=>{Da(!1),ur(null)},className:"bg-green-600 hover:bg-green-700 text-white",children:(vt==null?void 0:vt.type)==="transfer"?"تم الاستلام":"تم التسليم"})})]})})]}))};export{bm as default};
