import{Q as d}from"./index-CtI5CTI7.js";const i={async syncReportsDataFromFirebase(e){try{if(!e)return null;const a=await d.getUserData(e),l=a==null?void 0:a.reportsData;if(!l)return null;const t=`reportsData_${e}`,r=s=>{if(!s)return null;try{return s!=null&&s.toDate?s.toDate():new Date(s)}catch{return null}},n={lastDailyResetDate:r(l.lastDailyResetDate),lastMonthlyResetDate:r(l.lastMonthlyResetDate),hiddenDailyTransactionIds:Array.isArray(l.hiddenDailyTransactionIds)?l.hiddenDailyTransactionIds:[],hiddenMonthlyTransactionIds:Array.isArray(l.hiddenMonthlyTransactionIds)?l.hiddenMonthlyTransactionIds:[],dailyProfit:Number(l.dailyProfit??0),monthlyProfit:Number(l.monthlyProfit??0),lastDailyProfitResetDate:r(l.lastDailyProfitResetDate),lastMonthlyProfitResetDate:r(l.lastMonthlyProfitResetDate)};try{localStorage.setItem(t,JSON.stringify(n))}catch{}return n}catch(a){return console.warn("تعذر مزامنة بيانات التقارير من Firebase:",a),null}},shouldResetDailyReports:e=>{if(!e)return!0;const a=new Date,l=new Date(e);return a.toDateString()!==l.toDateString()},shouldResetMonthlyReports:e=>{if(!e)return!0;const a=new Date,l=new Date(e),t=a.getDate()===1,r=a.getMonth()!==l.getMonth()||a.getFullYear()!==l.getFullYear();return t&&r},autoResetReportsIfNeeded:e=>{try{const a=e?`reportsData_${e}`:"reportsData",l=localStorage.getItem(a);let t={lastDailyResetDate:null,lastMonthlyResetDate:null,hiddenDailyTransactionIds:[],hiddenMonthlyTransactionIds:[],dailyProfit:0,monthlyProfit:0,lastDailyProfitResetDate:null,lastMonthlyProfitResetDate:null};if(l){const s=JSON.parse(l);t={lastDailyResetDate:s.lastDailyResetDate?new Date(s.lastDailyResetDate):null,lastMonthlyResetDate:s.lastMonthlyResetDate?new Date(s.lastMonthlyResetDate):null,hiddenDailyTransactionIds:s.hiddenDailyTransactionIds||[],hiddenMonthlyTransactionIds:s.hiddenMonthlyTransactionIds||[],dailyProfit:s.dailyProfit||0,monthlyProfit:s.monthlyProfit||0,lastDailyProfitResetDate:s.lastDailyProfitResetDate?new Date(s.lastDailyProfitResetDate):null,lastMonthlyProfitResetDate:s.lastMonthlyProfitResetDate?new Date(s.lastMonthlyProfitResetDate):null}}else if(e){const s=localStorage.getItem("reportsData");if(s)try{const o=JSON.parse(s);t={lastDailyResetDate:o.lastDailyResetDate?new Date(o.lastDailyResetDate):null,lastMonthlyResetDate:o.lastMonthlyResetDate?new Date(o.lastMonthlyResetDate):null,hiddenDailyTransactionIds:o.hiddenDailyTransactionIds||[],hiddenMonthlyTransactionIds:o.hiddenMonthlyTransactionIds||[],dailyProfit:o.dailyProfit||0,monthlyProfit:o.monthlyProfit||0,lastDailyProfitResetDate:o.lastDailyProfitResetDate?new Date(o.lastDailyProfitResetDate):null,lastMonthlyProfitResetDate:o.lastMonthlyProfitResetDate?new Date(o.lastMonthlyProfitResetDate):null},localStorage.setItem(a,JSON.stringify(t))}catch(o){console.error("خطأ في مهاجرة بيانات التقارير القديمة:",o)}}let r=!1,n=!1;if(t.lastDailyResetDate?i.shouldResetDailyReports(t.lastDailyResetDate)&&(t.hiddenDailyTransactionIds=[],t.lastDailyResetDate=new Date,r=!0,console.log("تم تصفير التقارير اليومية تلقائياً")):t.lastDailyResetDate=new Date,t.lastDailyProfitResetDate?i.shouldResetDailyReports(t.lastDailyProfitResetDate)&&(t.dailyProfit=0,t.lastDailyProfitResetDate=new Date,console.log("تم تصفير الأرباح اليومية تلقائياً")):t.lastDailyProfitResetDate=new Date,t.lastMonthlyResetDate?i.shouldResetMonthlyReports(t.lastMonthlyResetDate)&&(t.hiddenMonthlyTransactionIds=[],t.lastMonthlyResetDate=new Date,n=!0,console.log("تم تصفير التقارير الشهرية تلقائياً")):t.lastMonthlyResetDate=new Date,t.lastMonthlyProfitResetDate?i.shouldResetMonthlyReports(t.lastMonthlyProfitResetDate)&&(t.monthlyProfit=0,t.lastMonthlyProfitResetDate=new Date,console.log("تم تصفير الأرباح الشهرية تلقائياً")):t.lastMonthlyProfitResetDate=new Date,localStorage.setItem(a,JSON.stringify(t)),e)try{d.updateUserData(e,{reportsData:{...t}})}catch(s){console.warn("تعذر تحديث بيانات التقارير في Firebase بعد التصفير التلقائي:",s)}return{dailyReset:r,monthlyReset:n}}catch(a){return console.error("خطأ في التصفير التلقائي للتقارير:",a),{dailyReset:!1,monthlyReset:!1}}},resetReportsManually:(e,a,l)=>{try{const t=l?`reportsData_${l}`:"reportsData",r=localStorage.getItem(t);let n={lastDailyResetDate:null,lastMonthlyResetDate:null,hiddenDailyTransactionIds:[],hiddenMonthlyTransactionIds:[],dailyProfit:0,monthlyProfit:0,lastDailyProfitResetDate:null,lastMonthlyProfitResetDate:null};if(r){const o=JSON.parse(r);n={lastDailyResetDate:o.lastDailyResetDate?new Date(o.lastDailyResetDate):null,lastMonthlyResetDate:o.lastMonthlyResetDate?new Date(o.lastMonthlyResetDate):null,hiddenDailyTransactionIds:o.hiddenDailyTransactionIds||[],hiddenMonthlyTransactionIds:o.hiddenMonthlyTransactionIds||[],dailyProfit:o.dailyProfit||0,monthlyProfit:o.monthlyProfit||0,lastDailyProfitResetDate:o.lastDailyProfitResetDate?new Date(o.lastDailyProfitResetDate):null,lastMonthlyProfitResetDate:o.lastMonthlyProfitResetDate?new Date(o.lastMonthlyProfitResetDate):null}}let s=[];if(e==="daily"){const o=new Date().toDateString();s=a.filter(D=>new Date(D.createdAt).toDateString()===o).map(D=>D.id),n.hiddenDailyTransactionIds=[...new Set([...n.hiddenDailyTransactionIds,...s])],n.lastDailyResetDate=new Date,n.dailyProfit=0,n.lastDailyProfitResetDate=new Date}else{const o=new Date().getMonth(),D=new Date().getFullYear();s=a.filter(y=>{const h=new Date(y.createdAt);return h.getMonth()===o&&h.getFullYear()===D}).map(y=>y.id),n.hiddenMonthlyTransactionIds=[...new Set([...n.hiddenMonthlyTransactionIds,...s])],n.lastMonthlyResetDate=new Date,n.monthlyProfit=0,n.lastMonthlyProfitResetDate=new Date}if(localStorage.setItem(t,JSON.stringify(n)),l)try{d.updateUserData(l,{reportsData:{...n}})}catch(o){console.warn("تعذر تحديث بيانات التقارير في Firebase بعد التصفير اليدوي:",o)}return console.log(`تم تصفير التقارير ${e==="daily"?"اليومية":"الشهرية"} يدوياً`),s}catch(t){return console.error("خطأ في التصفير اليدوي للتقارير:",t),[]}},getReportsData:e=>{try{const a=e?`reportsData_${e}`:"reportsData",l=localStorage.getItem(a);if(!l)return{lastDailyResetDate:null,lastMonthlyResetDate:null,hiddenDailyTransactionIds:[],hiddenMonthlyTransactionIds:[],dailyProfit:0,monthlyProfit:0,lastDailyProfitResetDate:null,lastMonthlyProfitResetDate:null};const t=JSON.parse(l);return{lastDailyResetDate:t.lastDailyResetDate?new Date(t.lastDailyResetDate):null,lastMonthlyResetDate:t.lastMonthlyResetDate?new Date(t.lastMonthlyResetDate):null,hiddenDailyTransactionIds:t.hiddenDailyTransactionIds||[],hiddenMonthlyTransactionIds:t.hiddenMonthlyTransactionIds||[],dailyProfit:t.dailyProfit||0,monthlyProfit:t.monthlyProfit||0,lastDailyProfitResetDate:t.lastDailyProfitResetDate?new Date(t.lastDailyProfitResetDate):null,lastMonthlyProfitResetDate:t.lastMonthlyProfitResetDate?new Date(t.lastMonthlyProfitResetDate):null}}catch(a){return console.error("خطأ في قراءة بيانات التقارير:",a),{lastDailyResetDate:null,lastMonthlyResetDate:null,hiddenDailyTransactionIds:[],hiddenMonthlyTransactionIds:[],dailyProfit:0,monthlyProfit:0,lastDailyProfitResetDate:null,lastMonthlyProfitResetDate:null}}},filterVisibleTransactions:(e,a,l)=>{try{const t=i.getReportsData(l),r=a==="daily"?t.hiddenDailyTransactionIds:t.hiddenMonthlyTransactionIds;return e.filter(n=>!r.includes(n.id))}catch(t){return console.error("خطأ في تصفية المعاملات:",t),e}},addProfit:(e,a,l)=>{try{const t=l?`reportsData_${l}`:"reportsData",r=i.getReportsData(l);if(a==="daily"?r.dailyProfit+=e:r.monthlyProfit+=e,localStorage.setItem(t,JSON.stringify(r)),l)try{d.updateUserData(l,{reportsData:{...r}})}catch(n){console.warn("تعذر مزامنة أرباح التقارير مع Firebase:",n)}}catch(t){console.error("خطأ في إضافة الربح:",t)}},getProfits:e=>{try{const a=i.getReportsData(e);return{dailyProfit:a.dailyProfit,monthlyProfit:a.monthlyProfit}}catch(a){return console.error("خطأ في قراءة الأرباح:",a),{dailyProfit:0,monthlyProfit:0}}},removeTransactionEffects:(e,a)=>{try{const l=a?`reportsData_${a}`:"reportsData",t=i.getReportsData(a),r=new Date(e.createdAt),n=new Date,s=n.getMonth(),o=n.getFullYear(),D=i.calculateTransactionProfit(e);if(r.toDateString()===n.toDateString()&&((t.hiddenDailyTransactionIds||[]).includes(e.id)||(t.dailyProfit=Math.round((t.dailyProfit-D)*100)/100,t.dailyProfit<0&&(t.dailyProfit=0))),r.getMonth()===s&&r.getFullYear()===o&&((t.hiddenMonthlyTransactionIds||[]).includes(e.id)||(t.monthlyProfit=Math.round((t.monthlyProfit-D)*100)/100,t.monthlyProfit<0&&(t.monthlyProfit=0))),localStorage.setItem(l,JSON.stringify(t)),a)try{d.updateUserData(a,{reportsData:{...t}})}catch(y){console.warn("تعذر مزامنة خصم تأثيرات المعاملة مع Firebase:",y)}}catch(l){console.error("خطأ في خصم تأثيرات المعاملة من التقارير:",l)}},calculateTransactionProfit:e=>e.commission!==void 0?e.commission:e.type==="withdraw"||e.type==="receive"||e.type==="send"?Math.round(e.amount*.01*100)/100:0},f=i;export{f as ReportsService,i as reportsService};
