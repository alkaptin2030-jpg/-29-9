import{ab as J,n as L,g as T,x as Q,U as w,y as W,a0 as X,r as h,d as Z,u as I,j as a}from"./index-HhP_bO8J.js";import{B as P}from"./button-CC2dY4LR.js";import{I as E}from"./input-B-86tNwf.js";import{L as D}from"./label-BYg_wuWa.js";import{D as ee,a as te,b as ae,c as re}from"./dialog-B9qCgl_q.js";import{S as se}from"./shield-C6XL-5Hv.js";import{E as S,a as F}from"./eye-Dl9aNr3Q.js";import{C as ne}from"./circle-alert-C0NFq_Ow.js";import{L as ie}from"./lock-BfVwYvPb.js";const $="master_pin";let u=new Map;function d(n){return n?`${$}_${n}`:$}async function le(n){try{const t=await J.getUserData(n),e=(t==null?void 0:t.security)&&t.security.masterPin||(t==null?void 0:t.masterPin)||null;return typeof e=="string"&&e.length>0?e:null}catch{try{const t=L(T,"users",n),e=await Q(t);if(e.exists()){const r=e.data(),s=(r==null?void 0:r.security)&&r.security.masterPin||(r==null?void 0:r.masterPin)||null;return typeof s=="string"&&s.length>0?s:null}}catch{}return null}}function ce(n){try{const t=localStorage.getItem(d(n));return t&&t.length>0?t:null}catch{return null}}async function Y(n,t){try{const e={security:{masterPin:t||null,masterPinUpdatedAt:w()},updatedAt:w()};await W(L(T,"users",n),e,{merge:!0})}catch{try{await X(L(T,"users",n),{security:{masterPin:t||null,masterPinUpdatedAt:w()},updatedAt:w()})}catch{}}}function A(n,t){try{const e=d(n);t?localStorage.setItem(e,t):localStorage.removeItem(e)}catch{}}class g{static async hasMasterPin(t){const e=d(t);if(u.has(e)){const s=u.get(e);return s!==""&&s!=null}const r=ce(t);if(r)return u.set(e,r),!0;if(t){const s=await le(t);if(s)return u.set(e,s),A(t,s),!0}return!1}static async createMasterPin(t,e){try{if(!t||t.length<4)return!1;const r=btoa(t),s=d(e);return u.set(s,r),A(e,r),e&&await Y(e,r),!0}catch(r){return console.error("Error creating master PIN:",r),!1}}static async verifyMasterPin(t,e){try{const r=d(e);if(!await this.hasMasterPin(e))return!1;const s=u.get(r);return s?atob(s)===t:!1}catch(r){return console.error("Error verifying master PIN:",r),!1}}static async changeMasterPin(t,e,r){try{return await this.verifyMasterPin(t,r)?await this.createMasterPin(e,r):!1}catch(s){return console.error("Error changing master PIN:",s),!1}}static async deleteMasterPin(t){try{const e=d(t);return u.delete(e),A(t,null),t&&await Y(t,null),!0}catch(e){return console.error("Error deleting master PIN:",e),!1}}static async getMasterPin(t){try{const e=d(t);if(!await this.hasMasterPin(t))return null;const r=u.get(e);return r?atob(r):null}catch(e){return console.error("Error getting master PIN:",e),null}}}const xe=({open:n,onOpenChange:t,onSuccess:e,title:r="الرقم السري الرئيسي",description:s="رقم سري موحد لإدارة جميع عناصر الموقع",mode:i="verify"})=>{const[p,_]=h.useState(""),[o,U]=h.useState(""),[N,z]=h.useState(""),[j,B]=h.useState(!1),[b,R]=h.useState(!1),[M,H]=h.useState(!1),[K,l]=h.useState(""),[O,c]=h.useState(!1),{toast:k}=Z(),{user:C}=I(),m=C==null?void 0:C.uid,[y,q]=h.useState(!1);h.useEffect(()=>{let f=!0;return n&&(async()=>{try{const V=await g.hasMasterPin(m);f&&q(V)}catch{}})(),()=>{f=!1}},[m,n]);const G=async f=>{f.preventDefault(),l(""),c(!0);try{if(i==="verify"){if(!p){l("يرجى إدخال الرقم السري الرئيسي"),c(!1);return}if(!await g.verifyMasterPin(p,m)){l("الرقم السري غير صحيح"),c(!1);return}k({title:"تم التأكيد",description:"تم التحقق من الرقم السري بنجاح"}),e==null||e(),x()}else if(i==="create"){if(!o||o.length<4){l("يجب أن يكون الرقم السري الجديد 4 أرقام على الأقل"),c(!1);return}if(o!==N){l("الرقم السري الجديد وتأكيده غير متطابقين"),c(!1);return}if(!await g.createMasterPin(o,m)){l("تعذر إنشاء الرقم السري الرئيسي"),c(!1);return}k({title:"تم تعيين الرقم السري الرئيسي",description:"تم تعيين الرقم السري الرئيسي بنجاح"}),e==null||e(),x()}else if(i==="change"){if(y){if(!p){l("يرجى إدخال الرقم السري الحالي"),c(!1);return}if(!await g.verifyMasterPin(p,m)){l("الرقم السري الحالي غير صحيح"),c(!1);return}}if(!o||o.length<4){l("يجب أن يكون الرقم السري الجديد 4 أرقام على الأقل"),c(!1);return}if(o!==N){l("الرقم السري الجديد وتأكيده غير متطابقين"),c(!1);return}if(!(y?await g.changeMasterPin(p,o,m):await g.createMasterPin(o,m))){l("تعذر تغيير الرقم السري الرئيسي"),c(!1);return}k({title:y?"تم تغيير الرقم السري الرئيسي":"تم تعيين الرقم السري الرئيسي",description:y?"تم تغيير الرقم السري الرئيسي بنجاح":"تم تعيين الرقم السري الرئيسي بنجاح"}),e==null||e(),x()}}catch{l("حدث خطأ أثناء معالجة الرقم السري")}finally{c(!1)}},x=()=>{_(""),U(""),z(""),l(""),B(!1),R(!1),H(!1),t(!1)};return a.jsx(ee,{open:n,onOpenChange:x,children:a.jsxs(te,{className:"sm:max-w-md",dir:"rtl",children:[a.jsx(ae,{children:a.jsxs(re,{className:"flex items-center gap-2 text-center justify-center",children:[a.jsx(se,{className:"h-5 w-5 text-blue-600"}),r]})}),a.jsx("div",{className:"text-center text-sm text-gray-600 mb-4",children:s}),a.jsxs("form",{onSubmit:G,className:"space-y-4",children:[(i==="verify"||i==="change"&&y)&&a.jsxs("div",{className:"space-y-2",children:[a.jsx(D,{htmlFor:"currentPin",className:"text-right block",children:i==="verify"?"الرقم السري الرئيسي":"الرقم السري الحالي"}),a.jsxs("div",{className:"relative",children:[a.jsx(E,{id:"currentPin",type:j?"text":"password",autoComplete:"off",value:p,onChange:f=>_(f.target.value),placeholder:i==="verify"?"أدخل الرقم السري الرئيسي":"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),a.jsx(P,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>B(!j),children:j?a.jsx(S,{className:"h-4 w-4"}):a.jsx(F,{className:"h-4 w-4"})})]})]}),(i==="create"||i==="change")&&a.jsxs("div",{className:"space-y-2",children:[a.jsx(D,{htmlFor:"newPin",className:"text-right block",children:i==="create"?"الرقم السري الرئيسي الجديد":"الرقم السري الجديد"}),a.jsxs("div",{className:"relative",children:[a.jsx(E,{id:"newPin",type:b?"text":"password",autoComplete:"off",value:o,onChange:f=>U(f.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),a.jsx(P,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>R(!b),children:b?a.jsx(S,{className:"h-4 w-4"}):a.jsx(F,{className:"h-4 w-4"})})]})]}),(i==="create"||i==="change")&&a.jsxs("div",{className:"space-y-2",children:[a.jsx(D,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),a.jsxs("div",{className:"relative",children:[a.jsx(E,{id:"confirmPin",type:M?"text":"password",autoComplete:"off",value:N,onChange:f=>z(f.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),a.jsx(P,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>H(!M),children:M?a.jsx(S,{className:"h-4 w-4"}):a.jsx(F,{className:"h-4 w-4"})})]})]}),K&&a.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm bg-red-50 p-3 rounded-lg",children:[a.jsx(ne,{className:"h-4 w-4"}),K]}),a.jsxs("div",{className:"flex gap-3 pt-4",children:[a.jsx(P,{type:"button",variant:"outline",onClick:x,className:"flex-1",children:"إلغاء"}),a.jsx(P,{type:"submit",disabled:O,className:"flex-1 bg-blue-600 hover:bg-blue-700",children:O?a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"جاري المعالجة..."]}):a.jsxs(a.Fragment,{children:[a.jsx(ie,{className:"h-4 w-4 mr-2"}),i==="verify"?"تحقق":i==="create"?"إنشاء":"تغيير"]})})]})]})]})})};export{xe as M,g as a};
