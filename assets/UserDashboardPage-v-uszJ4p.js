const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-Bp5r4OnK.js","./index-Bu1U7Yvm.css","./dailyOperationCountService-DCVfuVar.js","./walletDailyLimitsService-DOXQzrXL.js","./profitService-vyye6JvC.js"])))=>i.map(i=>d[i]);
var cd=Object.defineProperty;var dd=(n,d,o)=>d in n?cd(n,d,{enumerable:!0,configurable:!0,writable:!0,value:o}):n[d]=o;var Vn=(n,d,o)=>dd(n,typeof d!="symbol"?d+"":d,o);import{J as Ks,h as md,i as hd,u as _s,r as i,c as gs,j as e,aq as er,B as m,a8 as Ia,ao as Es,b8 as Kr,b9 as bl,C as Js,a as Fl,p as mt,ap as Zt,I as R,ai as Ml,ax as Ll,a9 as rt,b2 as $r,U as Zn,A as ud,R as _e,E as Kt,n as pa,aN as ha,v as Ge,f as de,H as qs,s as ct,K as ra,q as Bt,e as et,an as Le,g as es,a0 as wl,_ as Rl,w as ua,k as xa,F as Ha,y as xd,z as Os,ab as tr,l as jl,ar as si,O as na,ay as Ce,aJ as Ga,a5 as Bl,a1 as pd,a4 as gd,ba as fd,Y as ga,bb as $l,aE as Ul,aD as Nl,bc as zl,aI as ql,ac as yd,D as vd,ah as bd,af as Ja,aH as wd,b5 as Sl,M as jd,aG as Fr,d as Dl,ad as Cl,bd as Il,aT as Nd,be as Sd}from"./index-Bp5r4OnK.js";import{C as nt,a as $t,b as rs,d as dt}from"./card-CJtgt22j.js";import{B as Wt}from"./badge-IWmtCyaI.js";import{S as Xs,a as ea,b as ta,c as sa,d as Is,e as Qa,f as Br}from"./select-DPek_62f.js";import{D as me,a as he,b as ue,c as xe,f as Dd,e as us,d as ze,g as Vl,R as Cd,P as Id,W as Ad,C as Td,T as Pd,h as kd,i as Jl,O as Od,j as Ed}from"./dialog-vGJZIRWz.js";import{L as Z}from"./label-C3jr878i.js";import{M as xs,a as Xt,P as Al}from"./MasterPinDialog-DbZV4-13.js";import{walletDailyLimitsService as Ts}from"./walletDailyLimitsService-DOXQzrXL.js";import{T as Jt,P as Ur}from"./progress-B3e3D7e5.js";import{W as Ws}from"./wallet-BPYvdDw5.js";import{S as Kl,a as Wd}from"./star-BZRqKiE8.js";import{S as Yl}from"./square-pen-GobuzbWN.js";import{P as Vs}from"./phone-Cau7Hos_.js";import{A as Hl}from"./arrow-left-B3Ptn-mB.js";import{a as Xn,S as _d}from"./separator-B15LeTHE.js";import{C as ia}from"./calendar-BE6Gk0b2.js";import{C as zr}from"./chart-column-DsDq-qRS.js";import{D as yt}from"./dollar-sign-DkUN5Chr.js";import{A as Mr,P as Fd}from"./ProfileIcon-DuylvAq7.js";import{C as fa}from"./circle-alert-BXqkrPlH.js";import{C as qr}from"./circle-x-CIaKJihT.js";import{C as la}from"./circle-check-big-zmjL59L_.js";import{f as As,P as Md,C as Gl,a as ai,A as Vr,b as Ld,R as Rd,c as Bd,M as $d}from"./MaintenanceDialog-Bx9h42pi.js";import{S as Ud}from"./store-DX34ZFOO.js";import{r as Qt,P as aa}from"./profitService-vyye6JvC.js";import{a as zd,E as qd}from"./broadcastService-BS2xcw61.js";import{B as Tl,T as Vd}from"./textarea-DZlBmBlN.js";import{D as Jd,a as Kd,b as Yd,c as Hd,d as Gd}from"./dropdown-menu-DHvHQpSY.js";import{S as Jn}from"./shield-UNnwisJ-.js";import{G as Qd}from"./gift-yxGuh7p5.js";import{W as Zd}from"./WalletsManagement-tNELPHtz.js";import{P as Xd,w as em}from"./walletSelectionPinService-Cd1Y260o.js";import{D as tm}from"./download-CMHEMId1.js";import{R as sm}from"./refresh-cw-B6lEDDjR.js";import"./Combination-DQtlRcvV.js";import"./index-cB24D-Zw.js";import"./avatars-CQGTrUQX.js";import"./whatsappService-DizfJqtU.js";import"./index-T7xh4Z1V.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const am=Ks("Award",[["path",{d:"m15.477 12.89 1.515 8.526a.5.5 0 0 1-.81.47l-3.58-2.687a1 1 0 0 0-1.197 0l-3.586 2.686a.5.5 0 0 1-.81-.469l1.514-8.526",key:"1yiouv"}],["circle",{cx:"12",cy:"8",r:"6",key:"1vp47v"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Pl=Ks("Banknote",[["rect",{width:"20",height:"12",x:"2",y:"6",rx:"2",key:"9lu3g6"}],["circle",{cx:"12",cy:"12",r:"2",key:"1c9p78"}],["path",{d:"M6 12h.01M18 12h.01",key:"113zkx"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const rm=Ks("BookOpen",[["path",{d:"M12 7v14",key:"1akyts"}],["path",{d:"M3 18a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h5a4 4 0 0 1 4 4 4 4 0 0 1 4-4h5a1 1 0 0 1 1 1v13a1 1 0 0 1-1 1h-6a3 3 0 0 0-3 3 3 3 0 0 0-3-3z",key:"ruj8y"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ql=Ks("Building",[["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",ry:"2",key:"76otgf"}],["path",{d:"M9 22v-4h6v4",key:"r93iot"}],["path",{d:"M8 6h.01",key:"1dz90k"}],["path",{d:"M16 6h.01",key:"1x0f13"}],["path",{d:"M12 6h.01",key:"1vi96p"}],["path",{d:"M12 10h.01",key:"1nrarc"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M16 10h.01",key:"1m94wz"}],["path",{d:"M16 14h.01",key:"1gbofw"}],["path",{d:"M8 10h.01",key:"19clt8"}],["path",{d:"M8 14h.01",key:"6423bh"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Jr=Ks("IdCard",[["path",{d:"M16 10h2",key:"8sgtl7"}],["path",{d:"M16 14h2",key:"epxaof"}],["path",{d:"M6.17 15a3 3 0 0 1 5.66 0",key:"n6f512"}],["circle",{cx:"9",cy:"11",r:"2",key:"yxgjnd"}],["rect",{x:"2",y:"5",width:"20",height:"14",rx:"2",key:"qneu4z"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ei=Ks("Info",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Kn=Ks("ListChecks",[["path",{d:"m3 17 2 2 4-4",key:"1jhpwq"}],["path",{d:"m3 7 2 2 4-4",key:"1obspn"}],["path",{d:"M13 6h8",key:"15sg57"}],["path",{d:"M13 12h8",key:"h98zly"}],["path",{d:"M13 18h8",key:"oe0vm4"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ya=Ks("Package",[["path",{d:"M11 21.73a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73z",key:"1a0edw"}],["path",{d:"M12 22V12",key:"d0xqtd"}],["path",{d:"m3.3 7 7.703 4.734a2 2 0 0 0 1.994 0L20.7 7",key:"yx3hmr"}],["path",{d:"m7.5 4.27 9 5.15",key:"1c824w"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Za=Ks("TrendingDown",[["polyline",{points:"22 17 13.5 8.5 8.5 13.5 2 7",key:"1r2t7k"}],["polyline",{points:"16 17 22 17 22 11",key:"11uiuu"}]]),nm=async(n={})=>{try{return(await md(hd,"getLastTransactions")(n)).data}catch(d){throw console.error("Error getting last transactions:",d),d.code==="functions/unauthenticated"?new Error("يجب تسجيل الدخول للوصول إلى المعاملات"):d.code==="functions/invalid-argument"?new Error("بيانات الاستعلام غير صالحة: "+d.message):d.code==="functions/permission-denied"?new Error("ليس لديك صلاحية للوصول إلى هذه المعاملات: "+d.message):new Error("حدث خطأ أثناء جلب المعاملات: "+(d.message||"خطأ غير معروف"))}},im=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],lm=({isOpen:n,onClose:d,onWalletSelect:o,onEditWallet:p,onDeleteWallet:f})=>{const{user:j}=_s(),[s,A]=i.useState([]),[O,b]=i.useState(!1),{toast:I}=gs(),N=async(C,L)=>{const q=new Date().getMonth(),X=new Date().getFullYear(),z=L.filter(ee=>{const V=new Date(ee.createdAt);return V.getMonth()===q&&V.getFullYear()===X&&ee.lineId===C}),F=ee=>{const V=ee.type;return ee.txnType==="receive"||V==="withdraw"||V==="withdrawal"||V==="receive"},fe=ee=>{const V=ee.type;return ee.txnType==="send"||V==="send"||V==="transfer"},te=z.filter(F).reduce((ee,V)=>{const le=V.withdrawnAmount!==void 0?V.withdrawnAmount:V.amount;return ee+(le||0)},0),Pe=z.filter(fe).reduce((ee,V)=>{const le=V.sentAmount!==void 0?V.sentAmount:V.amount;return ee+(le||0)},0);return{withdrawalUsage:te,transferUsage:Pe}},g=C=>{const L=new Date().toISOString().split("T")[0],q=C.lastResetDate;if(!q)return{...C,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:L};const X=new Date(q),z=new Date;return X.getMonth()!==z.getMonth()||X.getFullYear()!==z.getFullYear()?{...C,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:L}:C};i.useEffect(()=>{if(!(j!=null&&j.uid)||!n)return;(async()=>{b(!0);try{const L=await Es.getByMerchantId(j.uid),q=await Kr.getByUserId(j.uid),z=(await Promise.all(L.map(async F=>{const{withdrawalUsage:fe,transferUsage:te}=await N(F.id,q);return{id:F.id,name:F.label||"محفظة بدون اسم",phone:F.msisdn,nationalId:F.nationalId||"",isDefault:!1,monthlyWithdrawalLimit:F.withdrawLimit||2e5,monthlyTransferLimit:F.transferLimit||2e5,monthlyWithdrawalUsage:fe,monthlyTransferUsage:te,lastResetDate:new Date().toISOString().split("T")[0],walletProvider:F.walletProvider||""}}))).map(g);A(z)}catch(L){console.error("Error loading wallets:",L),I({title:"فشل جلب بيانات المحافظ",description:"قد تكون المشكلة بسبب الصلاحيات أو الاتصال. سيتم عرض البيانات المحلية إن وُجدت. جرّب تسجيل الدخول مجددًا أو افتح صفحة اختبار المصادقة من القائمة.",variant:"destructive"})}finally{b(!1)}})()},[j==null?void 0:j.uid,n]);const P=C=>im.find(L=>L.id===C),k=(C,L)=>L>0?Math.min(C/L*100,100):0,U=C=>new Intl.NumberFormat("ar-EG").format(C);return e.jsx(me,{open:n,onOpenChange:d,children:e.jsxs(he,{className:"max-w-6xl max-h-[90vh] overflow-y-auto",children:[e.jsx(ue,{className:"pb-4",children:e.jsxs(xe,{className:"flex items-center gap-2 text-lg",children:[e.jsx(Ws,{className:"h-5 w-5"}),"الاطلاع على جميع المحافظ",e.jsxs(Wt,{variant:"secondary",className:"mr-2",children:[s.length," محفظة"]})]})}),O?e.jsx("div",{className:"flex justify-center items-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-600",children:"جاري تحميل المحافظ..."})]})}):s.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Ws,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"لا توجد محافظ مضافة حتى الآن"})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:s.map(C=>{const L=P(C.walletProvider||""),q=k(C.monthlyWithdrawalUsage||0,C.monthlyWithdrawalLimit),X=k(C.monthlyTransferUsage||0,C.monthlyTransferLimit);return e.jsxs(nt,{className:"cursor-pointer hover:shadow-lg transition-shadow border-2 hover:border-blue-300",onClick:()=>o(C),children:[e.jsx($t,{className:"pb-3",children:e.jsxs(rs,{className:"flex items-center justify-between text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(er,{className:"h-4 w-4"}),e.jsx("span",{children:C.name})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[C.isDefault&&e.jsxs(Wt,{variant:"default",className:"text-xs",children:[e.jsx(Kl,{className:"h-3 w-3 mr-1"}),"افتراضية"]}),e.jsx(m,{variant:"ghost",size:"sm",onClick:z=>{z.stopPropagation(),p==null||p(C)},className:"h-7 px-2",children:e.jsx(Yl,{className:"h-4 w-4"})}),e.jsx(m,{variant:"ghost",size:"sm",onClick:z=>{z.stopPropagation(),f==null||f(C.id)},className:"h-7 px-2 text-destructive hover:text-destructive",children:e.jsx(Jt,{className:"h-4 w-4"})})]})]})}),e.jsxs(dt,{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Vs,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"font-mono",children:C.phone})]}),C.nationalId&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Jr,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"font-mono",children:C.nationalId})]}),L&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Ql,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{children:L.name})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Za,{className:"h-3 w-3 text-red-500"}),"السحب الشهري"]}),e.jsxs("span",{className:"font-mono",children:[U(C.monthlyWithdrawalUsage||0)," / ",U(C.monthlyWithdrawalLimit)]})]}),e.jsx(Ur,{value:q,className:"h-2"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Ia,{className:"h-3 w-3 text-green-500"}),"التحويل الشهري"]}),e.jsxs("span",{className:"font-mono",children:[U(C.monthlyTransferUsage||0)," / ",U(C.monthlyTransferLimit)]})]}),e.jsx(Ur,{value:X,className:"h-2"})]}),e.jsx(m,{variant:"outline",size:"sm",className:"w-full text-xs",onClick:z=>{z.stopPropagation(),o(C)},children:"عرض التفاصيل الكاملة"})]})]},C.id)})}),e.jsx("div",{className:"flex justify-end pt-4 border-t",children:e.jsxs(m,{onClick:d,variant:"outline",children:[e.jsx(Hl,{className:"h-4 w-4 mr-2"}),"إغلاق"]})})]})})},om=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],cm=({wallet:n,isOpen:d,onClose:o,onBack:p})=>{const{user:f}=_s(),[j,s]=i.useState([]),[A,O]=i.useState(!1),[b,I]=i.useState("month"),{toast:N}=gs();if(i.useEffect(()=>{if(!n||!(f!=null&&f.uid)||!d)return;(async()=>{O(!0);try{const Se=(await Kr.getByUserId(f.uid)).filter(H=>H.walletId===n.id).sort((H,ie)=>new Date(ie.createdAt).getTime()-new Date(H.createdAt).getTime());s(Se)}catch(ae){console.error("Error loading transactions:",ae),N({title:"فشل جلب معاملات المحفظة",description:"قد تكون المشكلة بسبب صلاحيات Firestore أو الاتصال. تم عرض ما أمكن محليًا. جرّب تسجيل الدخول مجددًا أو صفحة اختبار المصادقة.",variant:"destructive"})}finally{O(!1)}})()},[n,f==null?void 0:f.uid,d]),!n)return null;const g=J=>om.find(ae=>ae.id===J),P=(J,ae)=>ae>0?Math.min(J/ae*100,100):0,k=J=>new Intl.NumberFormat("ar-EG").format(J),U=J=>new Date(J).toLocaleDateString("ar-EG",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}),L=(()=>{const J=new Date;let ae;switch(b){case"week":ae=new Date(J.getTime()-7*24*60*60*1e3);break;case"month":ae=new Date(J.getFullYear(),J.getMonth(),1);break;default:return j}return j.filter(Se=>new Date(Se.createdAt)>=ae)})(),q=J=>{const ae=J.type,Se=J.txnType;return ae==="withdraw"||ae==="withdrawal"||ae==="receive"||Se==="receive"},X=J=>{const ae=J.type,Se=J.txnType;return ae==="send"||ae==="transfer"||Se==="send"},z=L.filter(J=>q(J)&&J.status==="completed").reduce((J,ae)=>{const Se=ae.withdrawnAmount!==void 0?ae.withdrawnAmount:ae.amount;return J+(Se||0)},0),F=L.filter(J=>X(J)&&J.status==="completed").reduce((J,ae)=>{const Se=ae.sentAmount!==void 0?ae.sentAmount:ae.amount;return J+(Se||0)},0),fe=L.filter(J=>J.type==="deposit"&&J.status==="completed").reduce((J,ae)=>J+ae.amount,0),te=L.filter(J=>J.status==="completed"),Pe=te.length,ee=te.reduce((J,ae)=>{if(q(ae)){const Se=ae.withdrawnAmount??ae.receivedAmount??ae.amount??0;return J+bl(Number(Se)||0,"receive")}if(X(ae)){const Se=ae.sentAmount??ae.transferredAmount??ae.amount??0;return J+bl(Number(Se)||0,"send")}return J},0),V=g(n.walletProvider||""),le=P(n.monthlyWithdrawalUsage||0,n.monthlyWithdrawalLimit),be=P(n.monthlyTransferUsage||0,n.monthlyTransferLimit),ke=J=>{switch(J){case"withdrawal":return e.jsx(Za,{className:"h-4 w-4 text-red-500"});case"transfer":return e.jsx(Ia,{className:"h-4 w-4 text-blue-500"});case"deposit":return e.jsx(yt,{className:"h-4 w-4 text-green-500"});default:return e.jsx(Mr,{className:"h-4 w-4 text-gray-500"})}},ge=J=>{switch(J){case"completed":return e.jsx(la,{className:"h-4 w-4 text-green-500"});case"pending":return e.jsx(Js,{className:"h-4 w-4 text-yellow-500"});case"failed":return e.jsx(qr,{className:"h-4 w-4 text-red-500"});default:return e.jsx(fa,{className:"h-4 w-4 text-gray-500"})}},Fe=J=>{switch(J){case"withdrawal":return"سحب";case"transfer":return"تحويل";case"deposit":return"إيداع";default:return"معاملة"}},Oe=J=>{switch(J){case"completed":return"مكتملة";case"pending":return"قيد الانتظار";case"failed":return"فاشلة";default:return"غير محدد"}};return e.jsx(me,{open:d,onOpenChange:o,children:e.jsxs(he,{className:"max-w-6xl max-h-[90vh] overflow-y-auto",children:[e.jsx(ue,{className:"pb-4",children:e.jsxs(xe,{className:"flex items-center gap-2 text-lg",children:[e.jsx(er,{className:"h-5 w-5"}),"تفاصيل المحفظة: ",n.name,n.isDefault&&e.jsxs(Wt,{variant:"default",className:"mr-2",children:[e.jsx(Kl,{className:"h-3 w-3 mr-1"}),"افتراضية"]})]})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-1 space-y-4",children:[e.jsxs(nt,{children:[e.jsx($t,{children:e.jsxs(rs,{className:"text-sm flex items-center gap-2",children:[e.jsx(Jr,{className:"h-4 w-4"}),"المعلومات الأساسية"]})}),e.jsxs(dt,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Vs,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-mono",children:n.phone})]}),n.nationalId&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Jr,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-mono",children:n.nationalId})]}),V&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Ql,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{children:V.name})]}),e.jsxs("div",{className:"text-xs text-gray-600 pr-6",children:[e.jsxs("div",{children:["المالك: ",V.ownerName]}),e.jsxs("div",{className:"font-mono",children:["الرقم القومي: ",V.nationalId]})]})]}),n.lastResetDate&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(ia,{className:"h-4 w-4 text-gray-500"}),e.jsxs("span",{children:["آخر إعادة تعيين: ",new Date(n.lastResetDate).toLocaleDateString("ar-EG")]})]})]})]}),e.jsxs(nt,{children:[e.jsx($t,{children:e.jsxs(rs,{className:"text-sm flex items-center gap-2",children:[e.jsx(zr,{className:"h-4 w-4"}),"حدود الاستخدام الشهري"]})}),e.jsxs(dt,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Za,{className:"h-3 w-3 text-red-500"}),"السحب الشهري"]}),e.jsxs("span",{className:"font-mono",children:[k(n.monthlyWithdrawalUsage||0)," / ",k(n.monthlyWithdrawalLimit)]})]}),e.jsx(Ur,{value:le,className:"h-2"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["متبقي: ",k(n.monthlyWithdrawalLimit-(n.monthlyWithdrawalUsage||0))," جنيه"]})]}),e.jsx(Xn,{}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Ia,{className:"h-3 w-3 text-green-500"}),"التحويل الشهري"]}),e.jsxs("span",{className:"font-mono",children:[k(n.monthlyTransferUsage||0)," / ",k(n.monthlyTransferLimit)]})]}),e.jsx(Ur,{value:be,className:"h-2"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["متبقي: ",k(n.monthlyTransferLimit-(n.monthlyTransferUsage||0))," جنيه"]})]})]})]})]}),e.jsxs("div",{className:"lg:col-span-2 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-5 gap-4",children:[e.jsx(nt,{children:e.jsxs(dt,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(Za,{className:"h-5 w-5 text-red-500"})}),e.jsx("div",{className:"text-lg font-bold",children:k(z)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي السحب"})]})}),e.jsx(nt,{children:e.jsxs(dt,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(Ia,{className:"h-5 w-5 text-blue-500"})}),e.jsx("div",{className:"text-lg font-bold",children:k(F)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي التحويل"})]})}),e.jsx(nt,{children:e.jsxs(dt,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(yt,{className:"h-5 w-5 text-green-500"})}),e.jsx("div",{className:"text-lg font-bold",children:k(fe)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي الإيداع"})]})}),e.jsx(nt,{children:e.jsxs(dt,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(zr,{className:"h-5 w-5 text-emerald-600"})}),e.jsx("div",{className:"text-lg font-bold",children:k(ee)}),e.jsx("div",{className:"text-xs text-gray-600",children:"أرباح الفترة"})]})}),e.jsx(nt,{children:e.jsxs(dt,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(Mr,{className:"h-5 w-5 text-purple-600"})}),e.jsx("div",{className:"text-lg font-bold",children:k(Pe)}),e.jsx("div",{className:"text-xs text-gray-600",children:"عدد العمليات"})]})})]}),e.jsxs(nt,{children:[e.jsx($t,{children:e.jsxs(rs,{className:"text-sm flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(Mr,{className:"h-4 w-4"}),"سجل المعاملات"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(m,{size:"sm",variant:b==="week"?"default":"outline",onClick:()=>I("week"),className:"text-xs",children:"أسبوع"}),e.jsx(m,{size:"sm",variant:b==="month"?"default":"outline",onClick:()=>I("month"),className:"text-xs",children:"شهر"}),e.jsx(m,{size:"sm",variant:b==="all"?"default":"outline",onClick:()=>I("all"),className:"text-xs",children:"الكل"})]})]})}),e.jsx(dt,{children:A?e.jsx("div",{className:"flex justify-center items-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-600",children:"جاري تحميل المعاملات..."})]})}):L.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Mr,{className:"h-8 w-8 text-gray-400 mx-auto mb-2"}),e.jsx("p",{className:"text-gray-600",children:"لا توجد معاملات في هذه الفترة"})]}):e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:L.map(J=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[ke(J.type),e.jsxs("div",{children:[e.jsxs("div",{className:"text-sm font-medium",children:[Fe(J.type)," - ",k(J.amount)," جنيه"]}),e.jsx("div",{className:"text-xs text-gray-600",children:U(J.createdAt)}),J.description&&e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:J.description})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[ge(J.status),e.jsx("span",{className:"text-xs",children:Oe(J.status)})]})]},J.id))})})]})]})]}),e.jsxs("div",{className:"flex justify-between pt-4 border-t",children:[e.jsxs(m,{onClick:p,variant:"outline",children:[e.jsx(Hl,{className:"h-4 w-4 mr-2"}),"العودة للمحافظ"]}),e.jsx(m,{onClick:o,variant:"outline",children:"إغلاق"})]})]})})},Yn=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],dm=({isOpen:n,onClose:d,onWalletUpdate:o,initialEditingWallet:p})=>{const{toast:f}=gs(),{user:j}=_s(),s=Fl(),[A,O]=i.useState([]),[b,I]=i.useState(!1),[N,g]=i.useState(null),[P,k]=i.useState(""),[U,C]=i.useState(""),[L,q]=i.useState(""),[X,z]=i.useState(""),[F,fe]=i.useState("200000"),[te,Pe]=i.useState("200000"),[ee,V]=i.useState("100000"),[le,be]=i.useState("60000"),[ke,ge]=i.useState(!1),[Fe,Oe]=i.useState(null),[J,ae]=i.useState(!1),[Se,H]=i.useState(!1),[ie,Re]=i.useState(!1),[_t,vt]=i.useState(null),xt=()=>`wallets_${(j==null?void 0:j.uid)||"default"}`;i.useEffect(()=>{p&&(g(p),I(!0),k(p.name||""),C(p.phone||""),q(p.nationalId||""),z(p.walletProvider||""),fe((p.monthlyWithdrawalLimit||2e5).toString()),Pe((p.monthlyTransferLimit||2e5).toString()),V((p.dailyWithdrawalLimit||1e5).toString()),be((p.dailyTransferLimit||6e4).toString()),ge(!!p.isDefault))},[p]);const Be=E=>{const ne=new Date,Ee=ne.getMonth(),He=ne.getFullYear();if(!E.lastResetDate)return{...E,monthlyWithdrawalUsage:E.monthlyWithdrawalUsage||0,monthlyTransferUsage:E.monthlyTransferUsage||0,lastResetDate:ne.toISOString().split("T")[0]};const jt=new Date(E.lastResetDate),Nt=jt.getMonth(),ts=jt.getFullYear();return Ee!==Nt||He!==ts?{...E,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:ne.toISOString().split("T")[0]}:E},bt=async(E,ne)=>{const Ee=new Date().getMonth(),He=new Date().getFullYear(),jt=ne.filter($e=>{const Me=new Date($e.createdAt);return Me.getMonth()===Ee&&Me.getFullYear()===He&&$e.lineId===E}),Nt=jt.filter($e=>$e.txnType==="receive").reduce(($e,Me)=>$e+(Me.amount||0),0),ts=jt.filter($e=>$e.txnType==="send").reduce(($e,Me)=>$e+(Me.amount||0),0);return{withdrawalUsage:Nt,transferUsage:ts}},wt=async(E,ne)=>{const Ee=new Date,He=Ee.getDate(),jt=Ee.getMonth(),Nt=Ee.getFullYear(),ts=ne.filter(tt=>{const st=new Date(tt.createdAt);return st.getDate()===He&&st.getMonth()===jt&&st.getFullYear()===Nt&&tt.lineId===E}),$e=ts.filter(tt=>tt.txnType==="receive").reduce((tt,st)=>tt+(st.amount||0),0),Me=ts.filter(tt=>tt.txnType==="send").reduce((tt,st)=>tt+(st.amount||0),0);return{withdrawalUsage:$e,transferUsage:Me}};i.useEffect(()=>{(async()=>{if(!(j!=null&&j.uid)){console.log("No user authenticated, skipping wallet loading"),ae(!1);return}console.log("Loading wallets for user:",j.uid),ae(!0);try{const{auth:ne}=await rt(async()=>{const{auth:Me}=await import("./index-Bp5r4OnK.js").then(tt=>tt.bg);return{auth:Me}},__vite__mapDeps([0,1]),import.meta.url);let Ee=0;const He=5;for(;!ne.currentUser&&Ee<He;)console.log(`Waiting for auth state... attempt ${Ee+1}`),await new Promise(Me=>setTimeout(Me,1e3)),Ee++;if(!ne.currentUser)throw console.error("User not authenticated in Firebase Auth after retries"),new Error("not authenticated");console.log("Firebase Auth User:",ne.currentUser.uid),console.log("Context User:",j.uid),console.log("Fetching wallets from Firebase...");const jt=await Es.getByMerchantId(j.uid);console.log("Fetched wallets:",jt),console.log("Fetching transactions from Firebase...");const Nt=await Kr.getByUserId(j.uid);console.log("Fetched transactions:",Nt);const $e=(await Promise.all(jt.map(async Me=>{const{withdrawalUsage:tt,transferUsage:st}=await bt(Me.id,Nt),{withdrawalUsage:Ut,transferUsage:It}=await wt(Me.id,Nt);return{id:Me.id,name:Me.label||"محفظة بدون اسم",phone:Me.msisdn,isDefault:!1,monthlyWithdrawalLimit:Me.withdrawLimit||2e5,monthlyTransferLimit:Me.transferLimit||2e5,dailyWithdrawalLimit:Me.dailyWithdrawLimit||1e5,dailyTransferLimit:Me.dailyTransferLimit||6e4,monthlyWithdrawalUsage:tt,monthlyTransferUsage:st,dailyWithdrawalUsage:Ut,dailyTransferUsage:It,lastResetDate:new Date().toISOString().split("T")[0],defaultTransferCommission:Me.defaultTransferCommission!=null?Number(Me.defaultTransferCommission):null,defaultWithdrawCommission:Me.defaultWithdrawCommission!=null?Number(Me.defaultWithdrawCommission):null}}))).map(Be);O($e),console.log("Wallets loaded successfully:",$e)}catch(ne){console.error("Error loading wallets:",ne),O([])}finally{ae(!1)}})()},[j==null?void 0:j.uid]);const Ft=()=>{k(""),C(""),q(""),z(""),fe("200000"),Pe("200000"),V("100000"),be("60000"),ge(!1),g(null),I(!1)},Ye=async()=>{if(!P.trim()||!U.trim()||!X.trim()){f({title:"خطأ",description:"يرجى ملء جميع الحقول المطلوبة",variant:"destructive"});return}if(!(j!=null&&j.uid)){f({title:"خطأ",description:"يجب تسجيل الدخول أولاً",variant:"destructive"});return}ae(!0);try{if(N){await Es.update(N.id,{label:P.trim(),msisdn:U.trim(),withdrawLimit:parseInt(F),transferLimit:parseInt(te),dailyWithdrawLimit:parseInt(ee),dailyTransferLimit:parseInt(le)}),await Ts.setLimits(N.id,{dailyTransferLimit:parseInt(le||"0"),dailyWithdrawLimit:parseInt(ee||"0"),monthlyTransferLimit:parseInt(te||"0"),monthlyWithdrawLimit:parseInt(F||"0")});const E=A.map(ne=>ne.id===N.id?{...ne,name:P.trim(),phone:U.trim(),nationalId:L.trim(),walletProvider:X,monthlyWithdrawalLimit:parseInt(F),monthlyTransferLimit:parseInt(te),dailyWithdrawalLimit:parseInt(ee),dailyTransferLimit:parseInt(le)}:ne);O(E),localStorage.setItem(xt(),JSON.stringify(E)),f({title:"تم التحديث",description:"تم تحديث المحفظة بنجاح"})}else{const E={merchantUserId:j.uid,provider:X,msisdn:U.trim(),label:P.trim(),isActive:!0,dailyLimit:2e5,monthlyLimit:2e5,withdrawLimit:parseInt(F),transferLimit:parseInt(te),dailyTransferLimit:parseInt(le),dailyWithdrawLimit:parseInt(ee),dailyUsage:0,monthlyUsage:0,transferUsage:0,withdrawUsage:0},ne=await Es.create(E);await Ts.setLimits(ne,{dailyTransferLimit:parseInt(le||"0"),dailyWithdrawLimit:parseInt(ee||"0"),monthlyTransferLimit:parseInt(te||"0"),monthlyWithdrawLimit:parseInt(F||"0")});const Ee=new Date().toISOString().split("T")[0],He={id:ne,name:P.trim(),phone:U.trim(),nationalId:L.trim(),walletProvider:X,isDefault:ke,monthlyWithdrawalLimit:parseInt(F),monthlyTransferLimit:parseInt(te),dailyWithdrawalLimit:parseInt(ee),dailyTransferLimit:parseInt(le),monthlyWithdrawalUsage:0,monthlyTransferUsage:0,dailyWithdrawalUsage:0,dailyTransferUsage:0,lastResetDate:Ee,defaultTransferCommission:null,defaultWithdrawCommission:null},jt=[...A,He];O(jt),localStorage.setItem(xt(),JSON.stringify(jt)),f({title:"تم الإنشاء",description:"تم إنشاء المحفظة بنجاح"})}o&&o(),Ft(),I(!1),g(null)}catch(E){console.error("Error saving wallet:",E),f({title:"خطأ",description:"حدث خطأ أثناء حفظ المحفظة",variant:"destructive"})}finally{ae(!1)}},pt=E=>{g(E),k(E.name),C(E.phone),q(E.nationalId||""),z(E.walletProvider||""),fe(E.monthlyWithdrawalLimit.toString()),Pe(E.monthlyTransferLimit.toString()),ge(E.isDefault),I(!0)},qe=async E=>{const ne=A.find(Ee=>Ee.id===E);if(ne!=null&&ne.isDefault){f({title:"تحذير",description:"لا يمكن حذف المحفظة الافتراضية",variant:"destructive"});return}if(!(j!=null&&j.uid)){f({title:"خطأ",description:"يجب تسجيل الدخول أولاً",variant:"destructive"});return}ae(!0);try{await Es.delete(E);const Ee=A.filter(He=>He.id!==E);O(Ee),localStorage.setItem(xt(),JSON.stringify(Ee)),o&&o(),f({title:"تم الحذف",description:"تم حذف المحفظة بنجاح"})}catch(Ee){console.error("Error deleting wallet:",Ee),f({title:"خطأ",description:"حدث خطأ أثناء حذف المحفظة",variant:"destructive"})}finally{ae(!1)}},Pt=E=>{const ne=A.map(Ee=>({...Ee,isDefault:Ee.id===E}));O(ne),localStorage.setItem(xt(),JSON.stringify(ne)),o&&o(),f({title:"تم تحديث المحفظة الافتراضية",description:"تم تعيين المحفظة كافتراضية بنجاح"})};return e.jsxs(me,{open:n,onOpenChange:d,children:[e.jsxs(he,{className:"max-w-4xl max-h-[80vh] overflow-y-auto",children:[e.jsx(ue,{className:"pb-2",children:e.jsxs(xe,{className:"flex items-center gap-1 text-sm",children:[e.jsx(Ws,{className:"h-3 w-3"}),"إدارة المحافظ"]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h3",{className:"text-sm font-semibold",children:["المحافظ المتاحة (",A.length,")"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(m,{onClick:()=>{Re(!0)},className:"flex items-center gap-1 h-6 px-2 text-xs",size:"sm",variant:"outline",children:[e.jsx(mt,{className:"h-3 w-3"}),"الاطلاع على المحافظ"]}),e.jsxs(m,{onClick:()=>{d(),s("/user/add-wallet")},className:"flex items-center gap-1 h-6 px-2 text-xs",size:"sm",children:[e.jsx(Zt,{className:"h-3 w-3"}),"إضافة محفظة جديدة"]})]})]}),(b||N)&&e.jsxs(nt,{className:"border-2 border-blue-200 bg-blue-50",children:[e.jsx($t,{className:"pb-1",children:e.jsx(rs,{className:"text-sm",children:N?"تعديل المحفظة":"إضافة محفظة جديدة"})}),e.jsxs(dt,{className:"space-y-2 pt-1",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"شركة المحفظة"}),e.jsx("div",{className:"flex gap-1 items-center",children:e.jsxs(Xs,{value:X,onValueChange:z,children:[e.jsx(ea,{className:"h-6 text-xs flex-1",children:e.jsx(ta,{placeholder:"اختر شركة المحفظة"})}),e.jsx(sa,{children:Yn.map(E=>e.jsx(Is,{value:E.id,className:"text-xs",children:e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsx("span",{children:E.name}),e.jsx("button",{type:"button",className:"h-4 w-4 p-0 ml-2 flex items-center justify-center hover:bg-blue-100 rounded",onClick:ne=>{ne.preventDefault(),ne.stopPropagation(),Oe(E.id)},children:e.jsx(ei,{className:"h-3 w-3 text-blue-500 hover:text-blue-700"})})]})},E.id))})]})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"اسم المحفظة"}),e.jsx(R,{value:P,onChange:E=>k(E.target.value),placeholder:"مثال: محفظة العمل",className:"h-6 text-xs"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"رقم الهاتف"}),e.jsxs("div",{className:"relative",children:[e.jsx(Vs,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(R,{value:U,onChange:E=>C(E.target.value),placeholder:"01030302038",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الرقم القومي للخط"}),e.jsxs("div",{className:"relative",children:[e.jsx(Jr,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(R,{value:L,onChange:E=>q(E.target.value),placeholder:"29012345678901",maxLength:14,className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد الشهري للسحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(yt,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(R,{type:"number",value:F,onChange:E=>fe(E.target.value),placeholder:"200000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد الشهري للتحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(yt,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(R,{type:"number",value:te,onChange:E=>Pe(E.target.value),placeholder:"200000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد اليومي للسحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Za,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-red-400"}),e.jsx(R,{type:"number",value:ee,onChange:E=>V(E.target.value),placeholder:"100000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد اليومي للتحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Ia,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-blue-400"}),e.jsx(R,{type:"number",value:le,onChange:E=>be(E.target.value),placeholder:"60000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",id:"isDefault",checked:ke,onChange:E=>ge(E.target.checked),className:"rounded w-3 h-3"}),e.jsx("label",{htmlFor:"isDefault",className:"text-xs font-medium text-gray-700",children:"تعيين كمحفظة افتراضية"})]}),e.jsx("div",{className:"border-t pt-2 mt-2",children:e.jsxs("div",{className:"flex items-center gap-1 mb-2",children:[e.jsx(Ml,{className:"h-3 w-3 text-gray-600"}),e.jsx("label",{className:"text-xs font-medium text-gray-700",children:"إعدادات العمولة"})]})}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(m,{onClick:Ye,className:"flex-1 h-6 text-xs",size:"sm",children:N?"تحديث المحفظة":"إضافة المحفظة"}),e.jsx(m,{variant:"outline",onClick:Ft,className:"h-6 text-xs",size:"sm",children:"إلغاء"})]})]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2",children:A.map(E=>{var ne;return e.jsxs(nt,{className:`${E.isDefault?"border-green-300 bg-green-50":""}`,children:[e.jsx($t,{className:"pb-1",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(rs,{className:"text-sm flex items-center gap-1",children:[e.jsx(Ws,{className:"h-3 w-3"}),E.name]}),E.isDefault&&e.jsx(Wt,{variant:"default",className:"bg-green-600 text-xs px-1 py-0",children:"افتراضية"})]})}),e.jsxs(dt,{className:"space-y-1 pt-0",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Vs,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"text-xs",children:E.phone})]}),E.walletProvider&&e.jsx("div",{className:"text-xs text-blue-600 mt-1",children:((ne=Yn.find(Ee=>Ee.id===E.walletProvider))==null?void 0:ne.name)||E.walletProvider}),e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-2 rounded-md border border-gray-200 shadow-sm space-y-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-gray-600 mb-1",children:"الحدود الشهرية"}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-red-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-red-400 to-red-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((E.monthlyWithdrawalUsage||0)/E.monthlyWithdrawalLimit*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-blue-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-400 to-blue-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((E.monthlyTransferUsage||0)/E.monthlyTransferLimit*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-xs text-red-600 font-medium",children:["متبقي سحب: ",Math.max(E.monthlyWithdrawalLimit-(E.monthlyWithdrawalUsage||0),0)," جنيه"]}),e.jsxs("div",{className:"text-xs text-blue-600 font-medium",children:["متبقي تحويل: ",Math.max(E.monthlyTransferLimit-(E.monthlyTransferUsage||0),0)," جنيه"]})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-gray-600 mb-1",children:"الحدود اليومية"}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-orange-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-orange-400 to-orange-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((E.dailyWithdrawalUsage||0)/E.dailyWithdrawalLimit*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-green-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-green-400 to-green-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((E.dailyTransferUsage||0)/E.dailyTransferLimit*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-xs text-orange-600 font-medium",children:["متبقي سحب يومي: ",Math.max(E.dailyWithdrawalLimit-(E.dailyWithdrawalUsage||0),0)," جنيه"]}),e.jsxs("div",{className:"text-xs text-green-600 font-medium",children:["متبقي تحويل يومي: ",Math.max(E.dailyTransferLimit-(E.dailyTransferUsage||0),0)," جنيه"]})]})]})]}),e.jsxs("div",{className:"flex gap-1 pt-1",children:[e.jsxs(m,{size:"sm",variant:"outline",onClick:()=>pt(E),className:"flex-1 h-5 text-xs px-1",children:[e.jsx(Yl,{className:"h-2 w-2 mr-0.5"}),"تعديل"]}),!E.isDefault&&e.jsxs(e.Fragment,{children:[e.jsx(m,{size:"sm",variant:"outline",onClick:()=>Pt(E.id),className:"flex-1 h-5 text-xs px-1",children:"جعلها افتراضية"}),e.jsx(m,{size:"sm",variant:"destructive",onClick:()=>qe(E.id),className:"h-5 px-1",children:e.jsx(Jt,{className:"h-2 w-2"})})]})]})]})]},E.id)})}),A.length===0&&e.jsx("div",{className:"text-center py-4 text-gray-500 text-xs",children:"لا توجد محافظ متاحة. قم بإضافة محفظة جديدة للبدء."})]}),Fe&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-800",children:"معلومات صاحب المحفظة"}),e.jsx("button",{onClick:()=>Oe(null),className:"h-8 w-8 p-0 flex items-center justify-center hover:bg-gray-100 rounded-full transition-colors",children:e.jsx(Ll,{className:"h-4 w-4 text-gray-500"})})]}),(()=>{const E=Yn.find(ne=>ne.id===Fe);return E?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-center mb-6",children:e.jsx("div",{className:"bg-blue-100 p-3 rounded-lg inline-block",children:e.jsx("h4",{className:"font-bold text-blue-700 text-lg",children:E.name})})}),e.jsx("div",{className:"bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-200",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-white p-3 rounded-lg shadow-sm",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full mr-2"}),e.jsx("span",{className:"font-semibold text-gray-700",children:"اسم صاحب المحفظة:"})]}),e.jsx("p",{className:"text-gray-900 font-medium text-lg mr-4",children:E.ownerName})]}),e.jsxs("div",{className:"bg-white p-3 rounded-lg shadow-sm",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full mr-2"}),e.jsx("span",{className:"font-semibold text-gray-700",children:"الرقم القومي:"})]}),e.jsx("p",{className:"text-gray-900 font-mono text-lg mr-4 tracking-wider",children:E.nationalId})]})]})}),e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 p-3 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(ei,{className:"h-4 w-4 text-yellow-600 mr-2"}),e.jsx("span",{className:"text-sm text-yellow-800 font-medium",children:"هذه البيانات مسجلة رسمياً في النظام لهذه المحفظة"})]})})]}):null})()]})})]}),e.jsx(xs,{open:ie,onOpenChange:Re,mode:"verify",title:"إدخال الرقم السري الرئيسي",description:"لا يمكن الاطلاع على المحافظ إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{Re(!1),H(!0)}}),e.jsx(lm,{isOpen:Se,onClose:()=>H(!1),onWalletSelect:E=>{vt(E),H(!1)},onEditWallet:E=>{s(`/user/add-wallet?edit=1&id=${E.id}`),H(!1)},onDeleteWallet:async E=>{try{if(await Es.delete(E),O(ne=>{const Ee=ne.filter(He=>He.id!==E);try{localStorage.setItem(xt(),JSON.stringify(Ee))}catch(He){console.error("Failed to update localStorage wallets after delete:",He)}return Ee}),o)try{await o()}catch(ne){console.error("onWalletUpdate callback failed:",ne)}}catch(ne){console.error("Error deleting wallet:",ne)}}}),e.jsx(cm,{wallet:_t,isOpen:!!_t,onClose:()=>vt(null),onBack:()=>{vt(null),H(!0)}})]})},mm=({isOpen:n,onClose:d,transaction:o,onDelete:p})=>{if(!o)return null;const f=b=>{switch(b){case"completed":return e.jsx(la,{className:"h-5 w-5 text-green-500"});case"pending":return e.jsx(Js,{className:"h-5 w-5 text-yellow-500"});case"failed":return e.jsx(qr,{className:"h-5 w-5 text-red-500"});default:return e.jsx(Js,{className:"h-5 w-5 text-gray-500"})}},j=b=>{switch(b){case"completed":return"مكتملة";case"pending":return"قيد الانتظار";case"failed":return"فاشلة";default:return"غير معروف"}},s=b=>{switch(b){case"withdraw":return"سحب";case"send":return"إرسال";case"receive":return"استقبال";default:return"تحويل"}},A=()=>{const b=!!o.senderNumber,I=!!o.senderName,N=b?"الرقم المرسل:":I?"الرقم الراسل:":"رقم المحفظة:",g=b?o.senderNumber:I?o.senderName:o.senderPhone,P=`
      <div style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 500px; margin: 0 auto; padding: 30px; background: #fff;">
        <!-- Header -->
        <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #2563eb; padding-bottom: 20px;">
          <h1 style="color: #2563eb; margin-bottom: 5px; font-size: 28px;">إيصال المعاملة</h1>
          <p style="color: #666; font-size: 16px; margin: 0;">رقم المرجع: ${o.transactionReference||o.id}</p>
          <p style="color: #888; font-size: 14px; margin: 5px 0 0 0;">${new Date().toLocaleString("ar-EG")}</p>
        </div>
        
        <!-- Shop Info -->
        <div style="background: #f8fafc; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
          <h3 style="color: #1e293b; margin: 0 0 15px 0; font-size: 18px;">معلومات المحل</h3>
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span style="font-weight: 600; color: #475569;">اسم المحل:</span>
            <span style="color: #1e293b;">${o.merchantShopName||o.shopName||"غير محدد"}</span>
          </div>
        </div>
        
        <!-- Transaction Details -->
        <div style="background: #fff; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
          <h3 style="color: #1e293b; margin: 0 0 15px 0; font-size: 18px;">تفاصيل المعاملة</h3>
          
          <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
            <span style="font-weight: 600; color: #475569;">نوع المعاملة:</span>
            <span style="color: #2563eb; font-weight: 600;">${s(o.type)}</span>
          </div>
          
          <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
            <span style="font-weight: 600; color: #475569;">الحالة:</span>
            <span style="color: ${o.status==="completed"?"#16a34a":o.status==="pending"?"#ca8a04":"#dc2626"}; font-weight: 600;">
              ${j(o.status)}
            </span>
          </div>

          ${o!=null&&o.cashierName?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الكاشير:</span>
              <span style="color: #1e293b;">${o.cashierName}</span>
            </div>
          `:""}
          
          ${o.type!=="withdraw"?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">${N}</span>
              <span style="color: #1e293b;">${g}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الرقم المستقبل:</span>
              <span style="color: #1e293b;">${o.receiverNumber||o.receiverPhone}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">المبلغ المحول:</span>
              <span style="color: #2563eb; font-weight: bold; font-size: 16px;">${As(o.transferredAmount||o.amount)} جنيه</span>
            </div>
          `:`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">رقم المحفظة:</span>
              <span style="color: #1e293b;">${o.senderPhone}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">المبلغ المسحوب:</span>
              <span style="color: #dc2626; font-weight: bold; font-size: 16px;">${As(o.withdrawnAmountDetailed||o.withdrawnAmount||o.amount)} جنيه</span>
            </div>
          `}
          
          ${o.commission?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">العمولة:</span>
              <span style="color: #f59e0b; font-weight: 600;">${As(o.commission||0)} جنيه</span>
            </div>
          `:""}
          ${o!=null&&o.fee&&Number(o.fee)>0?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الرسوم:</span>
              <span style="color: #64748b; font-weight: 600;">${As(o.fee||0)} جنيه</span>
            </div>
          `:""}
          
          <div style="display: flex; justify-content: space-between; padding: 8px 0;">
            <span style="font-weight: 600; color: #475569;">التاريخ والوقت:</span>
            <span style="color: #1e293b;">${o.createdAt.toLocaleString("ar-EG")}</span>
          </div>
        </div>
        
        <!-- Total Amount -->
        <div style="background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); border-radius: 12px; padding: 20px; margin-bottom: 20px; text-align: center;">
          <h3 style="color: white; margin: 0 0 10px 0; font-size: 16px;">إجمالي المبلغ</h3>
          <p style="color: white; font-size: 24px; font-weight: bold; margin: 0;">
            ${o.type==="withdraw"?"-":""}${As(o.amount)} جنيه
          </p>
        </div>
        
        
        
        
        <!-- Footer -->
        <div style="text-align: center; color: #64748b; font-size: 12px; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
          <p style="margin: 0 0 5px 0;">شكراً لاستخدام خدماتنا</p>
          <p style="margin: 0;">تم إنشاء الإيصال في: ${new Date().toLocaleString("ar-EG")}</p>
        </div>
      </div>
    `,k=window.open("","_blank");k&&(k.document.write(`
        <html>
          <head>
            <title>إيصال المعاملة - ${o.transactionReference||o.id}</title>
            <meta charset="UTF-8">
            <style>
              body { 
                margin: 0; 
                padding: 20px; 
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: #f8fafc;
              }
              @media print {
                body { 
                  margin: 0; 
                  background: white;
                }
              }
            </style>
          </head>
          <body>
            ${P}
          </body>
        </html>
      `),k.document.close(),k.print())},O=()=>{window.confirm("هل أنت متأكد من حذف هذه المعاملة؟ لا يمكن التراجع عن هذا الإجراء.")&&(p(o.id),d())};return e.jsx(me,{open:n,onOpenChange:d,children:e.jsxs(he,{className:"w-[92vw] sm:w-auto sm:max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx(ue,{children:e.jsxs(xe,{className:"flex items-center gap-2 text-xl",children:[e.jsx($r,{className:"h-6 w-6 text-blue-600"}),"إيصال المعاملة المفصل"]})}),e.jsxs("div",{className:"space-y-6",children:[e.jsx(nt,{className:"bg-gradient-to-r from-blue-50 to-indigo-50 border-blue-200",children:e.jsxs($t,{className:"text-center pb-2",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 mb-2",children:[f(o.status),e.jsx(Wt,{variant:o.status==="completed"?"default":"secondary",className:"text-sm",children:j(o.status)})]}),e.jsxs("h3",{className:"text-2xl font-bold text-blue-600",children:[o.type==="withdraw"?"-":"",As(o.amount)," جنيه"]}),e.jsxs("p",{className:"text-sm text-gray-600",children:["رقم المرجع: ",o.transactionReference||o.id]})]})}),e.jsxs(nt,{children:[e.jsx($t,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ud,{className:"h-5 w-5 text-green-600"}),e.jsx("h4",{className:"font-semibold text-lg",children:"معلومات المحل"})]})}),e.jsxs(dt,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"اسم المحل:"}),e.jsx("span",{className:"text-gray-900",children:o.merchantShopName||o.shopName||"غير محدد"})]}),(o==null?void 0:o.cashierName)&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"الكاشير:"}),e.jsx("span",{className:"text-gray-900",children:o.cashierName})]})]})]}),e.jsxs(nt,{children:[e.jsx($t,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(er,{className:"h-5 w-5 text-blue-600"}),e.jsx("h4",{className:"font-semibold text-lg",children:"تفاصيل المعاملة"})]})}),e.jsx(dt,{className:"space-y-3",children:e.jsxs("div",{className:"grid grid-cols-1 gap-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-blue-700",children:"نوع المعاملة:"}),e.jsx(Wt,{variant:"outline",className:"bg-blue-100 text-blue-800",children:s(o.type)})]}),o.type!=="withdraw"?e.jsxs(e.Fragment,{children:[(()=>{const b=!!o.senderNumber,I=!!o.senderName,N=b?"الرقم المرسل:":I?"الرقم الراسل:":"رقم المحفظة:",g=b?o.senderNumber:I?o.senderName:o.senderPhone,P=b?Zn:Vs;return e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(P,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:N})]}),e.jsx("span",{className:"text-gray-900 font-mono",children:g})]})})(),e.jsx("div",{className:"flex items-center justify-center p-2",children:e.jsx(ud,{className:"h-6 w-6 text-blue-500"})}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-green-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Zn,{className:"h-4 w-4 text-green-500"}),e.jsx("span",{className:"font-medium text-green-700",children:"الرقم المستقبل:"})]}),e.jsx("span",{className:"text-green-900 font-mono",children:o.receiverNumber||o.receiverPhone})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(yt,{className:"h-4 w-4 text-blue-500"}),e.jsx("span",{className:"font-medium text-blue-700",children:"المبلغ المحول:"})]}),e.jsxs("span",{className:"text-blue-900 font-bold text-lg",children:[As(o.transferredAmount||o.amount)," جنيه"]})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Vs,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:"رقم المحفظة:"})]}),e.jsx("span",{className:"text-gray-900 font-mono",children:o.senderPhone})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-red-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(yt,{className:"h-4 w-4 text-red-500"}),e.jsx("span",{className:"font-medium text-red-700",children:"المبلغ المسحوب:"})]}),e.jsxs("span",{className:"text-red-900 font-bold text-lg",children:[As(o.withdrawnAmountDetailed||o.withdrawnAmount||o.amount)," جنيه"]})]})]}),o.commission&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-yellow-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-yellow-700",children:"العمولة:"}),e.jsxs("span",{className:"text-yellow-900 font-semibold",children:[o.commission," جنيه"]})]}),(o==null?void 0:o.fee)&&Number(o.fee)>0&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"الرسوم:"}),e.jsxs("span",{className:"text-gray-900 font-semibold",children:[o.fee," جنيه"]})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ia,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:"التاريخ والوقت:"})]}),e.jsx("span",{className:"text-gray-900",children:o.createdAt.toLocaleString("ar-EG")})]})]})})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs(m,{onClick:A,className:"flex-1 bg-blue-600 hover:bg-blue-700 text-white",size:"lg",children:[e.jsx(Md,{className:"h-5 w-5 mr-2"}),"طباعة الإيصال"]}),e.jsxs(m,{onClick:O,variant:"destructive",className:"flex-1",size:"lg",children:[e.jsx(Jt,{className:"h-5 w-5 mr-2"}),"حذف المعاملة"]})]}),e.jsx(m,{onClick:d,variant:"outline",className:"w-full",size:"lg",children:"إغلاق الإيصال"})]})]})})};function kl({open:n,onOpenChange:d,onSuccess:o,title:p,description:f,currentBalance:j,balanceLabel:s,userId:A}){const[O,b]=i.useState(""),[I,N]=i.useState(j.toString()),[g,P]=i.useState(!1),[k,U]=i.useState(""),[C,L]=i.useState(!1),q=async z=>{z.preventDefault(),U(""),L(!0);try{const F=parseFloat(I);if(isNaN(F)||F<0){U("يرجى إدخال مبلغ صحيح"),L(!1);return}await Xt.hasMasterPin(A)?await Xt.verifyMasterPin(O,A)?(o(F),d(!1),b(""),N("")):U("الرقم السري غير صحيح"):U("لم يتم تعيين رقم سري رئيسي. يرجى تعيين رقم سري رئيسي أولاً من إعدادات التطبيق")}catch{U("حدث خطأ أثناء التحقق من الرقم السري")}finally{L(!1)}},X=()=>{b(""),N(j.toString()),U(""),d(!1)};return _e.useEffect(()=>{n&&N(j.toString())},[j,n]),e.jsx(me,{open:n,onOpenChange:X,children:e.jsxs(he,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ue,{children:e.jsxs(xe,{className:"flex items-center gap-2 text-right",children:[e.jsx(yt,{className:"h-5 w-5"}),p]})}),e.jsxs("form",{onSubmit:q,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:f}),e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg",children:[e.jsxs(Z,{className:"text-sm font-medium text-gray-700",children:[s," الحالي"]}),e.jsxs("div",{className:"text-lg font-bold text-gray-900 mt-1",children:[j.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"newAmount",className:"text-right",children:"المبلغ الجديد"}),e.jsx(R,{id:"newAmount",type:"number",step:"0.01",min:"0",value:I,onChange:z=>N(z.target.value),placeholder:"أدخل المبلغ الجديد",className:"text-right",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"pin",className:"text-right",children:"الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"pin",type:g?"text":"password",value:O,onChange:z=>b(z.target.value),placeholder:"أدخل الرقم السري",className:"text-right pr-10",required:!0}),e.jsx(m,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>P(!g),children:g?e.jsx(Kt,{className:"h-4 w-4"}):e.jsx(mt,{className:"h-4 w-4"})})]})]}),k&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-red-600 bg-red-50 p-2 rounded",children:[e.jsx(fa,{className:"h-4 w-4"}),k]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(m,{type:"button",variant:"outline",onClick:X,className:"flex-1",children:"إلغاء"}),e.jsx(m,{type:"submit",disabled:C||!O||!I,className:"flex-1",children:C?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"جاري التحديث..."]}):e.jsxs(e.Fragment,{children:[e.jsx(pa,{className:"h-4 w-4 mr-2"}),"تحديث الرصيد"]})})]})]})]})})}class Xa{static getSecretKey(d){return d?`${this.SECRET_KEY_BASE}_${d}`:this.SECRET_KEY_BASE}static setSecretPin(d,o){const p=btoa(d);this.secretCache.set(this.getSecretKey(o),p)}static hasSecretPin(d){return this.secretCache.has(this.getSecretKey(d))}static verifySecretPin(d,o){const p=this.secretCache.get(this.getSecretKey(o));if(!p)return!1;try{return atob(p)===d}catch{return!1}}static clearSecretPin(d){this.secretCache.delete(this.getSecretKey(d))}}Vn(Xa,"SECRET_KEY_BASE","dashboard_secret_pin"),Vn(Xa,"secretCache",new Map);function hm({open:n,onOpenChange:d,userId:o}){const[p,f]=i.useState(""),[j,s]=i.useState(""),[A,O]=i.useState(""),[b,I]=i.useState(!1),[N,g]=i.useState(!1),[P,k]=i.useState(!1),[U,C]=i.useState(""),[L,q]=i.useState(!1),{toast:X}=gs(),z=Xa.hasSecretPin(o),F=async te=>{te.preventDefault(),C(""),q(!0);try{if(!j||j.length<4){C("يجب أن يكون الرقم السري 4 أرقام على الأقل"),q(!1);return}if(j!==A){C("الرقم السري الجديد وتأكيده غير متطابقين"),q(!1);return}if(z){if(!p){C("يرجى إدخال الرقم السري الحالي"),q(!1);return}if(!Xa.verifySecretPin(p,o)){C("الرقم السري الحالي غير صحيح"),q(!1);return}}Xa.setSecretPin(j,o),X({title:z?"تم تغيير الرقم السري":"تم تعيين الرقم السري",description:z?"تم تغيير الرقم السري بنجاح":"تم تعيين الرقم السري بنجاح"}),fe()}catch{C("حدث خطأ أثناء حفظ الرقم السري")}finally{q(!1)}},fe=()=>{f(""),s(""),O(""),C(""),I(!1),g(!1),k(!1),d(!1)};return e.jsx(me,{open:n,onOpenChange:fe,children:e.jsxs(he,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ue,{children:e.jsxs(xe,{className:"flex items-center gap-2 text-right",children:[e.jsx(Ml,{className:"h-5 w-5"}),z?"تغيير الرقم السري":"تعيين الرقم السري"]})}),e.jsxs("form",{onSubmit:F,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:z?"أدخل الرقم السري الحالي والرقم السري الجديد لتغييره":"أدخل الرقم السري الجديد الذي تريد استخدامه في عمليات التعديل"}),z&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"currentPin",type:b?"text":"password",autoComplete:"off",value:p,onChange:te=>f(te.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(m,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>I(!b),children:b?e.jsx(Kt,{className:"h-4 w-4"}):e.jsx(mt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"newPin",type:N?"text":"password",autoComplete:"off",value:j,onChange:te=>s(te.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(m,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>g(!N),children:N?e.jsx(Kt,{className:"h-4 w-4"}):e.jsx(mt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"confirmPin",type:P?"text":"password",autoComplete:"off",value:A,onChange:te=>O(te.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(m,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>k(!P),children:P?e.jsx(Kt,{className:"h-4 w-4"}):e.jsx(mt,{className:"h-4 w-4"})})]})]}),U&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(fa,{className:"h-4 w-4"}),U]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(m,{type:"submit",disabled:L,className:"flex-1",children:[e.jsx(pa,{className:"h-4 w-4 mr-2"}),L?"جاري الحفظ...":z?"تغيير الرقم السري":"تعيين الرقم السري"]}),e.jsx(m,{type:"button",variant:"outline",onClick:fe,disabled:L,children:"إلغاء"})]})]})]})})}const Hn=new Map;function um({open:n,onOpenChange:d,userId:o}){const[p,f]=i.useState(""),[j,s]=i.useState(""),[A,O]=i.useState(""),[b,I]=i.useState(!1),[N,g]=i.useState(!1),[P,k]=i.useState(!1),[U,C]=i.useState(""),[L,q]=i.useState(!1),{toast:X}=gs(),z=o?`cash_drawer_pin_${o}`:"cash_drawer_pin",F=()=>Hn.has(z),fe=V=>{const le=Hn.get(z);if(!le)return!1;try{return atob(le)===V}catch{return!1}},te=V=>{const le=btoa(V);Hn.set(z,le)},Pe=async V=>{V.preventDefault(),C(""),q(!0);try{if(!j||j.length<4){C("يجب أن يكون الرقم السري 4 أرقام على الأقل"),q(!1);return}if(j!==A){C("الرقم السري الجديد وتأكيده غير متطابقين"),q(!1);return}if(F()){if(!p){C("يرجى إدخال الرقم السري الحالي لدرج النقدية"),q(!1);return}if(!fe(p)){C("الرقم السري الحالي لدرج النقدية غير صحيح"),q(!1);return}}te(j),X({title:F()?"تم تغيير رقم درج النقدية":"تم تعيين رقم درج النقدية",description:F()?"تم تغيير الرقم السري لدرج النقدية بنجاح":"تم تعيين الرقم السري لدرج النقدية بنجاح"}),ee()}catch{C("حدث خطأ أثناء حفظ الرقم السري لدرج النقدية")}finally{q(!1)}},ee=()=>{f(""),s(""),O(""),C(""),I(!1),g(!1),k(!1),d(!1)};return e.jsx(me,{open:n,onOpenChange:ee,children:e.jsxs(he,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ue,{children:e.jsxs(xe,{className:"flex items-center gap-2 text-right",children:[e.jsx(yt,{className:"h-5 w-5 text-green-600"}),F()?"تغيير رقم درج النقدية":"تعيين رقم درج النقدية"]})}),e.jsxs("form",{onSubmit:Pe,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:F()?"أدخل الرقم السري الحالي والرقم السري الجديد لدرج النقدية":"أدخل الرقم السري الجديد الذي تريد استخدامه لحماية درج النقدية"}),F()&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي لدرج النقدية"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"currentPin",type:b?"text":"password",autoComplete:"off",value:p,onChange:V=>f(V.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(m,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>I(!b),children:b?e.jsx(Kt,{className:"h-4 w-4"}):e.jsx(mt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد لدرج النقدية"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"newPin",type:N?"text":"password",autoComplete:"off",value:j,onChange:V=>s(V.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(m,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>g(!N),children:N?e.jsx(Kt,{className:"h-4 w-4"}):e.jsx(mt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"confirmPin",type:P?"text":"password",autoComplete:"off",value:A,onChange:V=>O(V.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(m,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>k(!P),children:P?e.jsx(Kt,{className:"h-4 w-4"}):e.jsx(mt,{className:"h-4 w-4"})})]})]}),U&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(fa,{className:"h-4 w-4"}),U]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(m,{type:"submit",disabled:L,className:"flex-1 bg-green-600 hover:bg-green-700",children:[e.jsx(pa,{className:"h-4 w-4 mr-2"}),L?"جاري الحفظ...":F()?"تغيير رقم درج النقدية":"تعيين رقم درج النقدية"]}),e.jsx(m,{type:"button",variant:"outline",onClick:ee,disabled:L,children:"إلغاء"})]})]}),e.jsx("div",{className:"text-xs text-gray-500 text-center mt-2",children:"💰 هذا الرقم السري خاص بحماية درج النقدية فقط"})]})})}const Gn=new Map;function xm({open:n,onOpenChange:d,userId:o}){const[p,f]=i.useState(""),[j,s]=i.useState(""),[A,O]=i.useState(""),[b,I]=i.useState(!1),[N,g]=i.useState(!1),[P,k]=i.useState(!1),[U,C]=i.useState(""),[L,q]=i.useState(!1),{toast:X}=gs(),z=o?`wallet_total_pin_${o}`:"wallet_total_pin",F=()=>Gn.has(z),fe=V=>{const le=Gn.get(z);if(!le)return!1;try{return atob(le)===V}catch{return!1}},te=V=>{const le=btoa(V);Gn.set(z,le)},Pe=async V=>{V.preventDefault(),C(""),q(!0);try{if(!j||j.length<4){C("يجب أن يكون الرقم السري 4 أرقام على الأقل"),q(!1);return}if(j!==A){C("الرقم السري الجديد وتأكيده غير متطابقين"),q(!1);return}if(F()){if(!p){C("يرجى إدخال الرقم السري الحالي لإجمالي المحفظة"),q(!1);return}if(!fe(p)){C("الرقم السري الحالي لإجمالي المحفظة غير صحيح"),q(!1);return}}te(j),X({title:F()?"تم تغيير رقم إجمالي المحفظة":"تم تعيين رقم إجمالي المحفظة",description:F()?"تم تغيير الرقم السري لإجمالي المحفظة بنجاح":"تم تعيين الرقم السري لإجمالي المحفظة بنجاح"}),ee()}catch{C("حدث خطأ أثناء حفظ الرقم السري لإجمالي المحفظة")}finally{q(!1)}},ee=()=>{f(""),s(""),O(""),C(""),I(!1),g(!1),k(!1),d(!1)};return e.jsx(me,{open:n,onOpenChange:ee,children:e.jsxs(he,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ue,{children:e.jsxs(xe,{className:"flex items-center gap-2 text-right",children:[e.jsx(Ws,{className:"h-5 w-5 text-blue-600"}),F()?"تغيير رقم إجمالي المحفظة":"تعيين رقم إجمالي المحفظة"]})}),e.jsxs("form",{onSubmit:Pe,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:F()?"أدخل الرقم السري الحالي والرقم السري الجديد لإجمالي المحفظة":"أدخل الرقم السري الجديد الذي تريد استخدامه لحماية إجمالي المحفظة"}),F()&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي لإجمالي المحفظة"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"currentPin",type:b?"text":"password",autoComplete:"off",value:p,onChange:V=>f(V.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(m,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>I(!b),children:b?e.jsx(Kt,{className:"h-4 w-4"}):e.jsx(mt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد لإجمالي المحفظة"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"newPin",type:N?"text":"password",autoComplete:"off",value:j,onChange:V=>s(V.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(m,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>g(!N),children:N?e.jsx(Kt,{className:"h-4 w-4"}):e.jsx(mt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"confirmPin",type:P?"text":"password",autoComplete:"off",value:A,onChange:V=>O(V.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(m,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>k(!P),children:P?e.jsx(Kt,{className:"h-4 w-4"}):e.jsx(mt,{className:"h-4 w-4"})})]})]}),U&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(fa,{className:"h-4 w-4"}),U]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(m,{type:"submit",disabled:L,className:"flex-1 bg-blue-600 hover:bg-blue-700",children:[e.jsx(pa,{className:"h-4 w-4 mr-2"}),L?"جاري الحفظ...":F()?"تغيير رقم إجمالي المحفظة":"تعيين رقم إجمالي المحفظة"]}),e.jsx(m,{type:"button",variant:"outline",onClick:ee,disabled:L,children:"إلغاء"})]})]}),e.jsx("div",{className:"text-xs text-gray-500 text-center mt-2",children:"💼 هذا الرقم السري خاص بحماية إجمالي المحفظة فقط"})]})})}function pm({open:n,onOpenChange:d,onSuccess:o,title:p,description:f,currentBalance:j,balanceLabel:s,userId:A}){const[O,b]=i.useState(""),[I,N]=i.useState(""),[g,P]=i.useState("add"),[k,U]=i.useState(!1),[C,L]=i.useState(""),[q,X]=i.useState(!1),[z,F]=i.useState(!1);i.useEffect(()=>{let ee=!0;return(async()=>{const V=await Xt.hasMasterPin(A);ee&&F(V)})(),()=>{ee=!1}},[A,n]);const fe=async ee=>{ee.preventDefault(),L(""),X(!0);try{const V=parseFloat(I);if(isNaN(V)||V<=0){L("يرجى إدخال مبلغ صحيح أكبر من صفر"),X(!1);return}if(g==="subtract"&&V>j){L("لا يمكن خصم مبلغ أكبر من الرصيد الحالي"),X(!1);return}if(z)if(await Xt.verifyMasterPin(O,A)){const be=g==="add"?V:-V;te(),o(be)}else L("الرقم السري غير صحيح");else L("لم يتم تعيين الرقم السري الرئيسي. يرجى تعيينه من إعدادات البروفيل أولاً")}catch{L("حدث خطأ أثناء التحقق من الرقم السري")}finally{X(!1)}},te=()=>{b(""),N(""),P("add"),L(""),d(!1)},Pe=()=>{const ee=parseFloat(I)||0;return g==="add"?j+ee:j-ee};return e.jsx(me,{open:n,onOpenChange:te,children:e.jsxs(he,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ue,{children:e.jsxs(xe,{className:"flex items-center gap-2 text-right",children:[g==="add"?e.jsx(Zt,{className:"h-5 w-5 text-green-600"}):e.jsx(ha,{className:"h-5 w-5 text-red-600"}),p]})}),e.jsxs("form",{onSubmit:fe,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:f}),e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg",children:[e.jsxs(Z,{className:"text-sm font-medium text-gray-700",children:[s," الحالي"]}),e.jsxs("div",{className:"text-lg font-bold text-gray-900 mt-1",children:[j.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{className:"text-right",children:"نوع العملية"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(m,{type:"button",variant:g==="add"?"default":"outline",onClick:()=>P("add"),className:"flex-1 flex items-center gap-2",children:[e.jsx(Zt,{className:"h-4 w-4"}),"إضافة"]}),e.jsxs(m,{type:"button",variant:g==="subtract"?"default":"outline",onClick:()=>P("subtract"),className:"flex-1 flex items-center gap-2",children:[e.jsx(ha,{className:"h-4 w-4"}),"خصم"]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(Z,{htmlFor:"amount",className:"text-right",children:["المبلغ المراد ",g==="add"?"إضافته":"خصمه"]}),e.jsx(R,{id:"amount",type:"number",step:"0.01",min:"0.01",value:I,onChange:ee=>N(ee.target.value),placeholder:`أدخل المبلغ المراد ${g==="add"?"إضافته":"خصمه"}`,className:"text-right",required:!0})]}),I&&!isNaN(parseFloat(I))&&e.jsxs("div",{className:`p-3 rounded-lg ${g==="add"?"bg-green-50 border border-green-200":"bg-red-50 border border-red-200"}`,children:[e.jsx(Z,{className:"text-sm font-medium text-gray-700",children:"الرصيد الجديد المتوقع"}),e.jsxs("div",{className:`text-lg font-bold mt-1 ${g==="add"?"text-green-700":"text-red-700"}`,children:[Pe().toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"pin",className:"text-right",children:"الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"pin",type:k?"text":"password",autoComplete:"off",value:O,onChange:ee=>b(ee.target.value),placeholder:"أدخل الرقم السري",className:"text-right pr-10",required:!0}),e.jsx(m,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>U(!k),children:k?e.jsx(Kt,{className:"h-4 w-4"}):e.jsx(mt,{className:"h-4 w-4"})})]})]}),C&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-red-600 bg-red-50 p-2 rounded",children:[e.jsx(fa,{className:"h-4 w-4"}),C]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(m,{type:"button",variant:"outline",onClick:te,className:"flex-1",children:"إلغاء"}),e.jsx(m,{type:"submit",disabled:q||!O||!I,className:`flex-1 ${g==="add"?"bg-green-600 hover:bg-green-700":"bg-red-600 hover:bg-red-700"}`,children:q?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"جاري التحديث..."]}):e.jsxs(e.Fragment,{children:[e.jsx(pa,{className:"h-4 w-4 mr-2"}),g==="add"?"إضافة المبلغ":"خصم المبلغ"]})})]})]})]})})}const Ol={BASE_URL:"./",DEV:!1,MODE:"production",PROD:!0,SSR:!1,VITE_APP_VERSION:"0.0.0",VITE_DEV_MODE:"true",VITE_ENABLE_OFFLINE_PERSISTENCE:"false",VITE_FIREBASE_API_KEY:"AIzaSyA33RTf43u2QE2OsK1RepQHSKrSet9ZI0s",VITE_FIREBASE_APP_ID:"1:483702062341:web:b1ff06ad175cb7ae428b6c",VITE_FIREBASE_AUTH_DOMAIN:"voda-c6abd.firebaseapp.com",VITE_FIREBASE_AUTH_EMULATOR_URL:"http://localhost:9099",VITE_FIREBASE_FIRESTORE_EMULATOR_HOST:"localhost:8080",VITE_FIREBASE_FUNCTIONS_EMULATOR_HOST:"localhost:5001",VITE_FIREBASE_MEASUREMENT_ID:"G-CV6QGH7G7P",VITE_FIREBASE_MESSAGING_SENDER_ID:"483702062341",VITE_FIREBASE_PROJECT_ID:"voda-c6abd",VITE_FIREBASE_STORAGE_BUCKET:"voda-c6abd.appspot.com",VITE_FORCE_HASH_ROUTER:"true",VITE_SHOP_ID:"demo-shop-001",VITE_SHOP_NAME:"محل كاشي لينك التجريبي",VITE_SHOW_ENV_BANNER:"true",VITE_USE_EMULATORS:"false",VITE_USE_FIREBASE_EMULATOR:"false"},Zs=n=>typeof n=="string"&&n.trim().length>0,gm={getCurrentMonthId(){const n=new Date;return`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,"0")}`},async getWalletUsage(n){try{if(!Zs(n))return console.error("Error getting wallet usage: invalid walletId",n),null;const d=Ge(de,"walletLimits",n),o=await ra(d);if(o.exists()){const f=o.data();return{walletId:n,used_transfer:f.monthlyTransferUsed??f.used_transfer??0,used_withdraw:f.monthlyWithdrawUsed??f.used_withdraw??0,monthly_limit:f.monthlyLimit??f.monthlyTransferLimit??f.monthlyWithdrawLimit??2e5,last_reset:f.lastMonthlyReset??f.last_reset??null,updatedAt:f.updatedAt||wl.now()}}const p={walletId:n,used_transfer:0,used_withdraw:0,monthly_limit:2e5,last_reset:null,updatedAt:wl.now()};return await qs(d,{monthlyTransferUsed:0,monthlyWithdrawUsed:0,monthlyTransferLimit:2e5,monthlyWithdrawLimit:2e5,lastMonthlyReset:null,updatedAt:ct()}),p}catch(d){return console.error("Error getting wallet usage:",d),null}},shouldResetLimits(n){const d=new Date,o=d.getDate();if(!n)return!0;if(o===1){const p=n.toDate(),f=d.getMonth(),j=d.getFullYear();return p.getMonth()!==f||p.getFullYear()!==j}return!1},async autoResetLimitsIfNeeded(n){try{if(!Zs(n))return console.error("خطأ في التصفير التلقائي للحدود: walletId غير صالح",n),!1;typeof import.meta<"u";const d=await this.getWalletUsage(n);return d&&this.shouldResetLimits(d.last_reset)?(console.log(`🔄 تصفير تلقائي للحدود للمحفظة ${n} - اليوم الأول من الشهر`),await this.resetWalletUsage(n)):!1}catch(d){return console.error("خطأ في التصفير التلقائي للحدود:",d),!1}},async resetWalletUsage(n){try{if(!Zs(n))return console.error("خطأ في تصفير استخدام المحفظة: walletId غير صالح",n),!1;const d=Ge(de,"walletLimits",n);return await qs(d,{monthlyTransferUsed:0,monthlyWithdrawUsed:0,lastMonthlyReset:ct(),updatedAt:ct()},{merge:!0}),console.log(`🔄 تم تصفير استخدام المحفظة ${n} بنجاح`),!0}catch(d){return console.error("خطأ في تصفير استخدام المحفظة:",d),!1}},async calculateUsageFromTransactions(n){var d,o;try{if(!Zs(n))return console.error("خطأ في حساب الاستخدام من المعاملات: walletId غير صالح",n),{used_transfer:0,used_withdraw:0};const p=Ge(de,"walletLimits",n),f=await ra(p),j=f.exists()?((d=f.data())==null?void 0:d.lastMonthlyReset)??((o=f.data())==null?void 0:o.last_reset)??null:null,s=Bt(et(de,"tx"),Le("uid","==",n),...j?[Le("createdAt",">=",j)]:[]),A=await es(s);let O=0,b=0;return A.forEach(I=>{const N=I.data();N.status==="completed"&&(N.type==="transfer"?O+=N.amount:N.type==="withdraw"&&(b+=N.amount))}),{used_transfer:O,used_withdraw:b}}catch(p){return console.error("خطأ في حساب الاستخدام من المعاملات:",p),{used_transfer:0,used_withdraw:0}}},async getWalletUsageWithRefresh(n){try{if(!Zs(n))return console.error("خطأ في الحصول على الاستخدام مع التحديث: walletId غير صالح",n),null;typeof import.meta<"u";const d=await this.getWalletUsage(n);if(!d)return null;const o=await this.calculateUsageFromTransactions(n);if(d.used_transfer!==o.used_transfer||d.used_withdraw!==o.used_withdraw){const p=Ge(de,"walletLimits",n);return await qs(p,{monthlyTransferUsed:o.used_transfer,monthlyWithdrawUsed:o.used_withdraw,updatedAt:ct()},{merge:!0}),await this.getWalletUsage(n)}return d}catch(d){return console.error("خطأ في الحصول على الاستخدام مع التحديث:",d),null}},calculateRemaining(n){return{remainingTransfer:Math.max(0,n.monthly_limit-n.used_transfer),remainingWithdraw:Math.max(0,n.monthly_limit-n.used_withdraw)}},async canPerformOperation(n,d,o){try{if(!Zs(n))return console.error("Error checking operation limits: invalid walletId",n),{canPerform:!1,message:"walletId غير صالح"};const p=await this.getWalletUsageWithRefresh(n);if(!p)return{canPerform:!1,message:"لا يمكن العثور على بيانات الاستخدام للمحفظة"};const f=this.calculateRemaining(p);return o==="transfer"&&d>f.remainingTransfer?{canPerform:!1,message:`تجاوز حد التحويل المسموح. المتبقي: ${f.remainingTransfer.toLocaleString()} ج.م من أصل ${p.monthly_limit.toLocaleString()} ج.م`,remaining:f.remainingTransfer}:o==="withdraw"&&d>f.remainingWithdraw?{canPerform:!1,message:`تجاوز حد السحب المسموح. المتبقي: ${f.remainingWithdraw.toLocaleString()} ج.م من أصل ${p.monthly_limit.toLocaleString()} ج.م`,remaining:f.remainingWithdraw}:{canPerform:!0}}catch(p){return console.error("Error checking operation limits:",p),{canPerform:!1,message:"خطأ في التحقق من الحدود"}}},async updateUsage(n,d,o){try{if(!Zs(n))throw new Error("walletId غير صالح");const p=await this.getWalletUsageWithRefresh(n);if(!p)throw new Error("لا يمكن العثور على بيانات الاستخدام للمحفظة");const f=await this.canPerformOperation(n,d,o);if(!f.canPerform)throw new Error(f.message||"لا يمكن إجراء العملية");const j=o==="transfer"?p.used_transfer+d:p.used_transfer,s=o==="withdraw"?p.used_withdraw+d:p.used_withdraw,A=Ge(de,"walletLimits",p.walletId);await qs(A,{monthlyTransferUsed:j,monthlyWithdrawUsed:s,updatedAt:ct()},{merge:!0});const O=await this.getWalletUsageWithRefresh(n);if(!O)throw new Error("فشل في قراءة البيانات المحدثة");return O}catch(p){throw console.error("Error updating wallet usage:",p),p}},async resetWalletUsageManually(n){try{if(!Zs(n))throw new Error("walletId غير صالح");const d=Ge(de,"walletLimits",n),o={walletId:n,used_transfer:0,used_withdraw:0,monthly_limit:0,last_reset:null,updatedAt:new Date};return qs(d,{monthlyTransferUsed:0,monthlyWithdrawUsed:0,lastMonthlyReset:ct(),updatedAt:ct()},{merge:!0}).catch(p=>{console.error("خطأ في حفظ تصفير الاستخدام في Firebase:",p)}),console.log(`✅ تم تصفير استخدام المحفظة ${n} بنجاح`),o}catch(d){throw console.error("Error resetting wallet usage:",d),d}},async getAllWalletsUsage(n){try{const o=(await Es.getByMerchantId(n)).map(f=>this.getWalletUsageWithRefresh(f.id));return(await Promise.all(o)).filter(f=>f!==null)}catch(d){return console.error("Error getting all wallets usage:",d),[]}}};function fm(n){return n?`readBroadcastIds_${n}`:"readBroadcastIds_guest"}function ym({className:n}){const{user:d,profile:o,isSubscriptionActive:p}=_s(),f=Rl(),[j,s]=i.useState([]),[A,O]=i.useState(new Set),[b,I]=i.useState(!1),[N,g]=i.useState(""),[P,k]=i.useState(!1),[U,C]=i.useState(null),[L,q]=i.useState("none"),[X,z]=i.useState(null),[F,fe]=i.useState(!1);i.useRef(new Set),i.useRef(!1);const te=i.useRef(null),Pe=i.useRef(null);i.useRef(null);const[ee,V]=i.useState({position:"fixed",top:0,left:0,zIndex:1e4}),le=!1,be=i.useMemo(()=>{const H=["global"];return d!=null&&d.uid&&H.push(`user:${d.uid}`),o!=null&&o.shopId&&H.push(`shop:${o.shopId}`),H},[d==null?void 0:d.uid,o==null?void 0:o.shopId]),ke=fm(d==null?void 0:d.uid),ge=i.useMemo(()=>{var Re;const H=(Re=f==null?void 0:f.pathname)==null?void 0:Re.includes("/user/pending-approval");return!!(d!=null&&d.uid)&&!H},[d==null?void 0:d.uid,f==null?void 0:f.pathname]);i.useEffect(()=>{try{const H=localStorage.getItem(ke);if(H){const ie=JSON.parse(H);Array.isArray(ie)&&O(new Set(ie.filter(Boolean)))}else O(new Set)}catch(H){console.warn("Failed to load read ids",H),O(new Set)}},[ke]),i.useEffect(()=>{if(!ge){s([]);return}const H=zd(be,ie=>{s(ie)});return()=>H()},[be,ge]),i.useEffect(()=>{},[j]),i.useEffect(()=>()=>{te.current&&clearTimeout(te.current)},[]);const Fe=j.reduce((H,ie)=>H+(ie.id&&!A.has(ie.id)?1:0),0),Oe=H=>{if(!H||A.has(H))return;const ie=new Set(A);ie.add(H),O(ie);try{localStorage.setItem(ke,JSON.stringify(Array.from(ie)))}catch{}},J=()=>{const H=j.map(Re=>Re.id).filter(Boolean),ie=new Set(A);H.forEach(Re=>ie.add(Re)),O(ie);try{localStorage.setItem(ke,JSON.stringify(Array.from(ie)))}catch{}},ae=(H,ie)=>{H&&window.open(H,"_blank"),ie&&Oe(ie)};i.useEffect(()=>{},[F]);const Se=async()=>{if(!(d!=null&&d.uid)){alert("يرجى تسجيل الدخول لإرسال الطلب.");return}const H=N.trim();if(!H){alert("يرجى كتابة سبب طلب التحدث.");return}try{k(!0),C(null);const ie=o!=null&&o.fullName&&o.fullName.trim()?o.fullName.trim():d.email?d.email.split("@")[0]:"مستخدم",Re=(o==null?void 0:o.phone)||null;await xa(et(de,"waiting_list"),{userId:d.uid,name:ie,phone:Re,reason:H,status:"pending",createdAt:ct()}),C("تم إرسال طلبك إلى قائمة الانتظار بنجاح ✅"),g(""),setTimeout(()=>I(!1),900)}catch(ie){console.error("فشل إرسال طلب قائمة الانتظار:",ie),alert("حدث خطأ أثناء إرسال الطلب. حاول مرة أخرى.")}finally{k(!1)}};return i.useEffect(()=>{if(!(d!=null&&d.uid)){q("none");return}let H=null;try{const ie=Bt(et(de,"waiting_list"),Le("userId","==",d.uid));H=ua(ie,Re=>{const _t=Re.docs.map(Be=>({id:Be.id,...Be.data()})).sort((Be,bt)=>{var Ye,pt,qe,Pt,E,ne;const wt=((pt=(Ye=Be==null?void 0:Be.createdAt)==null?void 0:Ye.toMillis)==null?void 0:pt.call(Ye))??((qe=Be==null?void 0:Be.createdAt)==null?void 0:qe.seconds)*1e3??0;return(((E=(Pt=bt==null?void 0:bt.createdAt)==null?void 0:Pt.toMillis)==null?void 0:E.call(Pt))??((ne=bt==null?void 0:bt.createdAt)==null?void 0:ne.seconds)*1e3??0)-wt});if(_t.length===0){q("none");return}const vt=_t[0],xt=(vt==null?void 0:vt.contacted)===!0||(vt==null?void 0:vt.status)==="contacted";q(xt?"contacted":"pending")})}catch(ie){console.warn("⚠️ فشل الاشتراك في waiting_list للمستخدم:",ie),q("none")}return()=>{H&&H()}},[d==null?void 0:d.uid]),ge?e.jsxs("div",{className:`relative inline-flex items-center gap-2 ${n||""}`,ref:Pe,children:[e.jsxs(Jd,{onOpenChange:H=>{H&&Fe>0&&J()},children:[e.jsx(Kd,{asChild:!0,children:e.jsx(m,{variant:"ghost",className:"relative h-8 w-8 rounded-full p-0 hover:bg-transparent focus:ring-1 focus:ring-primary focus:ring-offset-1 transition-all",title:"الإشعارات",children:e.jsxs("div",{className:"relative h-8 w-8 rounded-full bg-primary/10 flex items-center justify-center border border-border shadow-sm hover:shadow-md",children:[e.jsx(Tl,{className:"h-4 w-4 text-primary"}),Fe>0&&e.jsx("span",{className:"absolute -top-1 -right-1 min-w-[18px] h-[18px] px-1 rounded-full bg-red-500 text-white text-[10px] font-bold flex items-center justify-center shadow",children:Fe})]})})}),e.jsxs(Yd,{className:"w-80",align:"end",forceMount:!0,children:[e.jsxs(Hd,{className:"flex items-center justify-between",children:[e.jsx("span",{children:"الإشعارات"}),j.length>0&&e.jsxs(m,{variant:"outline",size:"sm",className:"h-7 text-xs",onClick:J,children:[e.jsx(la,{className:"h-3 w-3 mr-1"}),"تمييز الكل كمقروء"]})]}),e.jsx(Gd,{}),j.length===0?e.jsx("div",{className:"p-3 text-sm text-muted-foreground",children:"لا توجد إشعارات حالياً"}):e.jsx("div",{className:"max-h-64 overflow-y-auto pr-1",children:j.map(H=>{const ie=H.id?!A.has(H.id):!1;return e.jsx("div",{className:`px-2 py-2 rounded-md ${ie?"bg-primary/5":""}`,children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(Tl,{className:`h-4 w-4 ${ie?"text-primary":"text-muted-foreground"}`}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-sm font-medium",children:H.title||"إشعار"}),e.jsx("div",{className:"text-xs text-muted-foreground whitespace-pre-line",children:H.message}),H.linkUrl&&e.jsxs(m,{variant:"link",className:"px-0 h-6 text-xs",onClick:()=>ae(H.linkUrl,H.id),children:["فتح الرابط ",e.jsx(qd,{className:"h-3 w-3 ml-1"})]})]}),ie?e.jsx(m,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>Oe(H.id),title:"تمييز كمقروء",children:e.jsx(la,{className:"h-4 w-4 text-primary"})}):e.jsx(m,{variant:"ghost",size:"icon",className:"h-6 w-6",disabled:!0,title:"مقروء",children:e.jsx(la,{className:"h-4 w-4 text-muted-foreground"})})]})},H.id)})})]})]}),e.jsxs(me,{open:b,onOpenChange:I,children:[e.jsx(Dd,{asChild:!0,children:e.jsx(m,{variant:"ghost",size:"icon",className:"h-8 w-8 rounded-full hover:bg-transparent focus:ring-1 focus:ring-primary/60 focus:ring-offset-1",title:"قائمة الانتظار",children:e.jsx(Js,{className:`h-4 w-4 ${L==="pending"?"text-red-600":L==="contacted"?"text-green-600":"text-muted-foreground"}`})})}),e.jsxs(he,{className:"max-w-md border border-purple-200/50 shadow-xl bg-gradient-to-br from-purple-50 to-blue-50",children:[e.jsxs(ue,{children:[e.jsx(xe,{children:"طلب التحدث"}),e.jsx(us,{children:"يرجى كتابة سبب طلب التحدث ليصل للإدارة في قسم قائمة الانتظار."})]}),e.jsxs("div",{className:"grid gap-3",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"سبب الطلب"}),e.jsx(Vd,{value:N,onChange:H=>g(H.target.value),placeholder:"اكتب سبب طلب التحدث هنا...",className:"min-h-[120px] text-right"}),U&&e.jsx("div",{className:"text-sm text-green-700 bg-green-50 border border-green-200 rounded-md p-2",children:U})]}),e.jsxs(ze,{children:[e.jsx(m,{variant:"outline",onClick:()=>I(!1),disabled:P,children:"إلغاء"}),e.jsx(m,{onClick:Se,disabled:P,className:"bg-gradient-to-r from-green-600 to-emerald-600 text-white",children:P?"جارٍ الإرسال...":"إرسال"})]})]})]}),le]}):null}const El=({isOpen:n,onClose:d,onTrialStarted:o})=>{const{user:p}=_s(),[f,j]=i.useState(!1),[s,A]=i.useState(!1),[O,b]=i.useState(""),[I,N]=i.useState(24);i.useEffect(()=>{const k=async()=>{if(p!=null&&p.uid){const C=await Ha.getTrialData(p.uid);A(C.hasUsedFreeTrial)}},U=async()=>{try{const C=await Ha.getTrialDurationHours();N(C)}catch{}};n&&(k(),U())},[n,p]);const g=async()=>{if(p!=null&&p.uid){j(!0);try{const k=await Ha.startFreeTrial(p.uid);k.success?(b(k.message),window.location.href="/user/dashboard"):b(k.message||"تعذر تفعيل التجربة المجانية")}catch{b("حدث خطأ أثناء تفعيل التجربة المجانية")}finally{j(!1)}}},P=async()=>{if(p!=null&&p.uid){j(!0);try{await xd(p.uid,Os.ZERO,p.uid),window.location.href="/user/dashboard"}catch{b("حدث خطأ أثناء تفعيل باقة الزيرو")}finally{j(!1)}}};return e.jsxs(e.Fragment,{children:[n&&e.jsx("div",{className:"fixed inset-0 z-40",style:{background:"rgba(0, 0, 0, 0.15)",pointerEvents:"auto"}}),e.jsx(me,{open:n,onOpenChange:()=>{},children:e.jsxs(he,{className:"sm:max-w-lg z-50 border-0 shadow-2xl",style:{position:"fixed",top:"50%",left:"50%",transform:"translate(-50%, -50%)",pointerEvents:"auto",background:"linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 0.95) 100%)",borderRadius:"20px",border:"1px solid rgba(255, 255, 255, 0.3)"},children:[e.jsxs(ue,{className:"text-center pb-0 pt-0",children:[e.jsx("div",{className:"flex justify-center mb-1",children:e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-0 rounded-full",style:{background:"linear-gradient(135deg, #f59e0b, #d97706)",filter:"blur(8px)",opacity:.3}}),e.jsx("div",{className:"relative bg-gradient-to-br from-orange-400 to-orange-600 p-2 rounded-full",children:e.jsx(Jn,{className:"h-12 w-12 text-white"})})]})}),e.jsx(xe,{className:"text-2xl font-bold bg-gradient-to-r from-gray-800 to-gray-600 bg-clip-text text-transparent text-center mt-0 mb-0 leading-tight",children:"تفعيل الحساب مطلوب"})]}),e.jsxs("div",{className:"text-center pt-6 pb-0 px-2",children:[e.jsxs("div",{className:"bg-gradient-to-r from-orange-50 to-amber-50 rounded-xl p-6 mb-6 border border-orange-100",children:[e.jsx("p",{className:"text-gray-700 text-lg leading-relaxed font-medium",children:"حسابك في انتظار التفعيل من قبل المسؤول"}),e.jsx("p",{className:"text-sm font-semibold text-orange-700 mt-3 mb-3 bg-orange-100 p-3 rounded-lg border border-orange-200",children:"للتفعيل السريع: تواصل مع الإدارة عبر واتساب فقط على الرقم التالي"}),e.jsxs("div",{className:"bg-green-50 p-4 rounded-lg border border-green-200 mt-3",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"text-base font-bold text-green-700",children:"واتساب الإدارة:"}),e.jsx("a",{href:"https://wa.me/201000392539",target:"_blank",rel:"noopener noreferrer",className:"text-lg font-bold text-green-600 hover:text-green-700 underline",children:"01000392539"})]}),e.jsx("p",{className:"text-sm text-green-600 mt-2 text-center",children:"اضغط على الرقم للتواصل المباشر عبر واتساب"})]})]}),!s&&e.jsxs("div",{className:"bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-4 mb-4 border border-green-200",children:[e.jsxs("div",{className:"flex items-center justify-center mb-2",children:[e.jsx(Jn,{className:"h-5 w-5 text-green-600 ml-2"}),e.jsx("span",{className:"text-green-700 font-semibold",children:"باقة الزيرو المجانية الدائمة"})]}),e.jsx("p",{className:"text-green-600 text-sm text-center",children:"فعل باقة الزيرو الان واستمتع ب 10 عمليات سحب وتحويل يوميا"})]}),O&&e.jsx("div",{className:`rounded-xl p-4 mb-4 text-center ${O.includes("تم تفعيل")?"bg-green-50 border border-green-200 text-green-700":"bg-red-50 border border-red-200 text-red-700"}`,children:e.jsx("p",{className:"font-medium",children:O})}),e.jsxs("div",{className:"flex items-center justify-center space-x-2 text-sm text-gray-500 mb-0",children:[e.jsxs("div",{className:"flex space-x-1",children:[e.jsx("div",{className:"w-2 h-2 bg-orange-400 rounded-full animate-pulse"}),e.jsx("div",{className:"w-2 h-2 bg-orange-400 rounded-full animate-pulse",style:{animationDelay:"0.2s"}}),e.jsx("div",{className:"w-2 h-2 bg-orange-400 rounded-full animate-pulse",style:{animationDelay:"0.4s"}})]}),e.jsx("span",{className:"mr-2",children:"في انتظار التفعيل"})]})]}),e.jsxs("div",{className:"flex flex-col space-y-3 pb-2",children:[!s&&!O.includes("تم تفعيل")&&e.jsxs(e.Fragment,{children:[e.jsxs(m,{onClick:g,disabled:f,className:"w-full max-w-2xl mx-auto relative bg-gradient-to-r from-blue-600 to-indigo-600 hover:brightness-110 text-white px-10 py-4 rounded-2xl font-bold text-xl ring-2 ring-blue-300 ring-offset-1 shadow-2xl hover:shadow-3xl transition-all duration-500 transform hover:scale-110 hover:-translate-y-1 disabled:opacity-50 disabled:cursor-not-allowed overflow-hidden group focus-visible:outline-none focus-visible:ring-4 focus-visible:ring-blue-300",style:{boxShadow:"0 15px 35px rgba(59, 130, 246, 0.4), 0 5px 15px rgba(0, 0, 0, 0.1)"},children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-white/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"}),e.jsx("div",{className:"absolute -top-1 -left-1 w-3 h-3 bg-yellow-400 rounded-full animate-ping"}),e.jsx("div",{className:"absolute -top-1 -right-1 w-2 h-2 bg-green-400 rounded-full animate-pulse"}),f?e.jsxs("div",{className:"flex items-center relative z-10",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-white ml-3"}),e.jsx("span",{className:"bg-gradient-to-r from-white to-gray-100 bg-clip-text text-transparent",children:"جاري التفعيل..."})]}):e.jsxs("div",{className:"flex items-center relative z-10",children:[e.jsx(Qd,{className:"h-6 w-6 ml-3 animate-bounce"}),e.jsx("span",{className:"bg-gradient-to-r from-white to-gray-100 bg-clip-text text-transparent",children:`التجربة المجانية لمدة ${I} ${I>=3&&I<=10?"ساعات":I===2?"ساعتين":"ساعة"}`})]})]}),e.jsxs(m,{onClick:P,disabled:f,className:"w-full max-w-2xl mx-auto relative bg-gradient-to-r from-green-600 to-emerald-600 hover:brightness-110 text-white px-10 py-4 rounded-2xl font-bold text-xl ring-2 ring-emerald-300 ring-offset-1 shadow-2xl hover:shadow-3xl transition-all duration-500 transform hover:scale-110 hover:-translate-y-1 disabled:opacity-50 disabled:cursor-not-allowed overflow-hidden group focus-visible:outline-none focus-visible:ring-4 focus-visible:ring-emerald-300",style:{boxShadow:"0 15px 35px rgba(99, 102, 241, 0.4), 0 5px 15px rgba(0, 0, 0, 0.1)"},children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-white/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"}),e.jsx("div",{className:"absolute -top-1 -left-1 w-3 h-3 bg-yellow-400 rounded-full animate-ping"}),e.jsx("div",{className:"absolute -top-1 -right-1 w-2 h-2 bg-green-400 rounded-full animate-pulse"}),f?e.jsxs("div",{className:"flex items-center relative z-10",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-white ml-3"}),e.jsx("span",{className:"bg-gradient-to-r from-white to-gray-100 bg-clip-text text-transparent",children:"جاري التفعيل..."})]}):e.jsxs("div",{className:"flex items-center relative z-10",children:[e.jsx(Jn,{className:"h-6 w-6 ml-3 animate-bounce"}),e.jsx("span",{className:"bg-gradient-to-r from-white to-gray-100 bg-clip-text text-transparent",children:"فعّل باقة الزيرو الآن"})]})]})]}),e.jsx(m,{onClick:d,variant:"outline",className:"border-2 border-gray-300 hover:border-gray-400 text-gray-700 hover:text-gray-800 px-10 py-3 rounded-xl font-semibold text-lg transition-all duration-300 transform hover:scale-105",children:s?"فهمت":"إغلاق"})]})]})})]})};function vm({isOpen:n,onClose:d}){const[o,p]=i.useState("0"),[f,j]=i.useState(null),[s,A]=i.useState(null),[O,b]=i.useState(!1),I=z=>{O?(p(z),b(!1)):p(o==="0"?z:o+z)},N=z=>{const F=parseFloat(o);if(f===null)j(F);else if(s){const te=g(f||0,F,s);p(String(te)),j(te)}b(!0),A(z)},g=(z,F,fe)=>{switch(fe){case"+":return z+F;case"-":return z-F;case"×":return z*F;case"÷":return F===0?0:z/F;case"=":return F;default:return F}},P=()=>{const z=parseFloat(o);if(f!==null&&s){const F=g(f,z,s);p(String(F)),j(null),A(null),b(!0)}},k=()=>{p("0"),j(null),A(null),b(!1)},U=()=>{p("0")},C=()=>{O?(p("0."),b(!1)):o.indexOf(".")===-1&&p(o+".")},L=()=>{o!=="0"&&p(o.charAt(0)==="-"?o.slice(1):"-"+o)},q=()=>{const z=parseFloat(o);p(String(z/100))},X=z=>{const F=z.key;z.preventDefault(),F>="0"&&F<="9"?I(F):F==="+"?N("+"):F==="-"?N("-"):F==="*"?N("×"):F==="/"?N("÷"):F==="Enter"||F==="="?P():F==="Escape"||F==="c"||F==="C"?k():F==="Backspace"?U():F==="."?C():F==="%"&&q()};return i.useEffect(()=>(n?document.addEventListener("keydown",X):document.removeEventListener("keydown",X),()=>{document.removeEventListener("keydown",X)}),[n,o,f,s,O]),e.jsx(me,{open:n,onOpenChange:z=>!z&&d(),children:e.jsxs(he,{className:"sm:max-w-md",children:[e.jsx(ue,{children:e.jsxs(xe,{className:"flex items-center gap-2 text-right",children:[e.jsx(Gl,{className:"h-5 w-5"}),"آلة حاسبة"]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-gray-900 text-white p-4 rounded-lg text-right",children:e.jsx("div",{className:"text-3xl font-mono font-bold min-h-[3rem] flex items-center justify-end overflow-hidden",children:o})}),e.jsxs("div",{className:"grid grid-cols-4 gap-2",children:[e.jsx(m,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:k,children:"AC"}),e.jsx(m,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:U,children:"CE"}),e.jsx(m,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:q,children:"%"}),e.jsx(m,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>N("÷"),children:"÷"}),e.jsx(m,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>I("7"),children:"7"}),e.jsx(m,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>I("8"),children:"8"}),e.jsx(m,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>I("9"),children:"9"}),e.jsx(m,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>N("×"),children:"×"}),e.jsx(m,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>I("4"),children:"4"}),e.jsx(m,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>I("5"),children:"5"}),e.jsx(m,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>I("6"),children:"6"}),e.jsx(m,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>N("-"),children:"-"}),e.jsx(m,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>I("1"),children:"1"}),e.jsx(m,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>I("2"),children:"2"}),e.jsx(m,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>I("3"),children:"3"}),e.jsx(m,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>N("+"),children:"+"}),e.jsx(m,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50 col-span-2",onClick:()=>I("0"),children:"0"}),e.jsx(m,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:C,children:"."}),e.jsx(m,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:P,children:"="})]}),e.jsx(m,{variant:"outline",className:"w-full h-10 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:L,children:"+/-"})]})]})})}function bm({isOpen:n,onClose:d,initialBarcode:o}){const[p,f]=i.useState([]),[j,s]=i.useState({productName:"",price:"",wholesalePrice:"",quantity:"",barcode:"",serialNumber:""}),[A,O]=i.useState(!1),[b,I]=i.useState(null),{toast:N}=gs(),{user:g,profile:P}=_s(),{isShiftActive:k,shiftUser:U}=tr(),[C,L]=i.useState([]),[q,X]=i.useState({}),[z,F]=i.useState({}),[fe,te]=i.useState({}),[Pe,ee]=i.useState(""),[V,le]=i.useState(!1),[be,ke]=i.useState({}),[ge,Fe]=i.useState(!1),[Oe,J]=i.useState(!0),[ae,Se]=i.useState(!1),H=_e.useRef(""),ie=_e.useRef(0),[Re,_t]=i.useState(0),[vt,xt]=i.useState(0),[Be,bt]=i.useState(!1),[wt,Ft]=i.useState(!0),[Ye,pt]=i.useState(!1),[qe,Pt]=i.useState(!0),[E,ne]=i.useState(!0),[Ee,He]=i.useState({}),[jt,Nt]=i.useState(!1),[ts,$e]=i.useState("التحقق قبل العملية"),[Me,tt]=i.useState("أدخل الرقم السري الرئيسي للمتابعة"),st=_e.useRef(null),Ut=(u,_,M)=>{$e(u),tt(_),st.current=M,Nt(!0)},[It,Yt]=i.useState(""),W=i.useMemo(()=>{const u=It.trim().toLowerCase();return u?C.filter(_=>_.name.toLowerCase().includes(u)):C},[C,It]);i.useEffect(()=>{n&&(g!=null&&g.uid)&&(it(),wt||St())},[n,g==null?void 0:g.uid,wt]),i.useEffect(()=>{if(!n)return;const u=_=>{const M=Date.now();if(_.key==="Enter"){const Y=(H.current||"").trim();H.current="",Y&&gt(Y);return}_.key.length===1&&(M-(ie.current||0)>100&&(H.current=""),H.current+=_.key,ie.current=M)};return window.addEventListener("keydown",u),()=>window.removeEventListener("keydown",u)},[n,C]),i.useEffect(()=>{n&&o&&gt(o)},[n,o]);const ye=async()=>{if(g!=null&&g.uid)try{const u=P==null?void 0:P.shopId;let _,M=[];if(u){const Y=Bt(et(de,"products"),Le("shopId","==",u),Le("userId","==",g.uid));if(_=await es(Y),M=_.docs.map(Q=>({id:Q.id,name:String(Q.data().name??""),sellingPrice:Number(Q.data().sellingPrice??0),wholesalePrice:Number(Q.data().wholesalePrice??0),quantity:Number(Q.data().quantity??0),barcode:String(Q.data().barcode??""),serialNumber:String(Q.data().serialNumber??"")})),M.length===0){const Q=Bt(et(de,"products"),Le("userId","==",g.uid)),S=(await es(Q)).docs.map(B=>({id:B.id,name:String(B.data().name??""),sellingPrice:Number(B.data().sellingPrice??0),wholesalePrice:Number(B.data().wholesalePrice??0),quantity:Number(B.data().quantity??0),barcode:String(B.data().barcode??""),serialNumber:String(B.data().serialNumber??"")}));S.length>0&&(M=S,N({title:"تم استرجاع المنتجات",description:"عثرنا على منتجات محفوظة لك خارج المتجر الحالي وقمنا بعرضها."}))}}else{const Y=Bt(et(de,"products"),Le("userId","==",g.uid));_=await es(Y),M=_.docs.map(Q=>({id:Q.id,name:String(Q.data().name??""),sellingPrice:Number(Q.data().sellingPrice??0),wholesalePrice:Number(Q.data().wholesalePrice??0),quantity:Number(Q.data().quantity??0),barcode:String(Q.data().barcode??""),serialNumber:String(Q.data().serialNumber??"")}))}if(L(M),P!=null&&P.shopId&&M.length>0){const Y=M.filter(Q=>{const we=((_==null?void 0:_.docs)||[]).find(B=>B.id===Q.id);return!(!!we&&!!we.data().shopId)});if(Y.length>0)try{await Promise.all(Y.map(Q=>na(Ge(de,"products",Q.id),{shopId:P.shopId,updatedAt:ct()}))),N({title:"تم ترتيب المنتجات",description:"تم ربط بعض المنتجات غير المربوطة بمتجرك الحالي تلقائياً."})}catch(Q){console.warn("تعذّر ترحيل shopId لبعض المنتجات:",Q)}}}catch(u){console.error("Error loading shop products:",u)}};i.useEffect(()=>{n&&(g!=null&&g.uid)&&(ye(),St(),it(),Ct())},[n,g==null?void 0:g.uid,P==null?void 0:P.shopId]);const oe=()=>{const u=new Date,_=u.getFullYear(),M=String(u.getMonth()+1).padStart(2,"0"),Y=String(u.getDate()).padStart(2,"0");return`${_}-${M}-${Y}`},it=()=>{if(!(g!=null&&g.uid)){console.log("No user authenticated, cannot load sales data");return}const u=`salesData_all_${g.uid}`,_=localStorage.getItem(u);if(_)try{f(JSON.parse(_));return}catch{}const M=oe(),Y=`salesData_${g.uid}_${M}`,Q=localStorage.getItem(Y);if(Q){const se=JSON.parse(Q);f(se);try{localStorage.setItem(u,JSON.stringify(se))}catch{}return}const we=new Date().toISOString().split("T")[0],S=`salesData_${g.uid}_${we}`,B=localStorage.getItem(S);if(B){const se=JSON.parse(B);f(se);try{localStorage.setItem(Y,B),localStorage.setItem(u,B)}catch{}return}f([])},ht=u=>{if(!(g!=null&&g.uid)){console.log("No user authenticated, cannot save sales data");return}const _=oe(),M=`salesData_${g.uid}_${_}`,Y=`salesData_all_${g.uid}`;localStorage.setItem(M,JSON.stringify(u));try{const Q=localStorage.getItem(Y),we=Q?JSON.parse(Q):[],S={};[...Array.isArray(we)?we:[],...u].forEach(B=>{S[B.id]=B}),localStorage.setItem(Y,JSON.stringify(Object.values(S)))}catch{}f(u)},St=async()=>{if(g!=null&&g.uid)try{const u=new Date,_=new Date(u.getFullYear(),u.getMonth(),1),M=new Date(u.getFullYear(),u.getMonth()+1,0),Y=Ue=>Ue.toISOString().split("T")[0],Q=Y(_),we=Y(M),S=Bt(et(de,"dailySales"),Le("userId","==",g.uid),Le("date",">=",Q),Le("date","<=",we)),B=await es(S);let se=0,pe=0;if(!B.empty)B.forEach(Ue=>{const Ve=Ue.data(),Ie=Number(Ve.sellingPrice??0),ut=Number(Ve.quantity??0),ss=Number(Ve.profit??(Number(Ve.sellingPrice??0)-Number(Ve.wholesalePrice??0))*ut);se+=Ie*ut,pe+=ss});else{const Ue=Bt(et(de,"dailySales"),Le("userId","==",g.uid));(await es(Ue)).forEach(Ie=>{const ut=Ie.data(),ss=String(ut.date??"").slice(0,10);if(ss>=Q&&ss<=we){const Mt=Number(ut.sellingPrice??0),ns=Number(ut.quantity??0),je=Number(ut.profit??(Number(ut.sellingPrice??0)-Number(ut.wholesalePrice??0))*ns);se+=Mt*ns,pe+=je}}),(se>0||pe>0)&&N({title:"تم استرجاع تقارير الشهر",description:"تم حساب التقارير باستخدام مسار احتياطي للتواريخ القديمة."})}_t(se),xt(pe)}catch(u){console.error("Error loading monthly stats:",u)}},Dt=async u=>{if(!(g!=null&&g.uid))return null;try{const _=((u.price??0)-(u.wholesalePrice??0))*(u.quantity??0),M=k&&U?"cashier":"admin",Y=M==="cashier"?(U==null?void 0:U.name)||"كاشير":(P==null?void 0:P.fullName)||(g==null?void 0:g.displayName)||"الحساب الرئيسي",Q=M==="cashier"&&(U==null?void 0:U.username)||null;return(await xa(et(de,"dailySales"),{userId:g.uid,clientId:u.id,productName:u.productName,quantity:u.quantity,wholesalePrice:u.wholesalePrice??null,sellingPrice:u.price,profit:_,date:u.date,time:u.time,performedByType:M,performedByName:Y,performedByUsername:Q,serialNumber:u.serialNumber??null,barcode:u.barcode??null,createdAt:ct()})).id}catch(_){return console.error("Error saving sale:",_),null}},Ht=()=>`cashBalance_${(g==null?void 0:g.uid)||"default"}`,Ct=async()=>{if(!(g!=null&&g.uid))return;const u=p.filter(_=>!_.firestoreId);if(u.length!==0)for(const _ of u)try{const M=Bt(et(de,"dailySales"),Le("userId","==",g.uid),Le("clientId","==",_.id),jl(1)),Y=await es(M);if(!Y.empty){const we=Y.docs[0].id,S=p.map(B=>B.id===_.id?{...B,firestoreId:we}:B);ht(S);continue}const Q=await Dt(_);if(Q){const we=p.map(S=>S.id===_.id?{...S,firestoreId:Q}:S);ht(we)}}catch{}},Ns=async u=>{try{if(g!=null&&g.uid)try{const se=et(de,"deficiencies"),pe=await xa(se,{shopId:(P==null?void 0:P.shopId)||g.uid||"default-shop",name:u,quantity:1,status:"pending",createdAt:ct()});try{const Ue=`deficiencies_${(P==null?void 0:P.shopId)||(g==null?void 0:g.uid)||"default-shop"}`,Ve=localStorage.getItem(Ue),Ie=Ve?JSON.parse(Ve):[],ut=Array.isArray(Ie)?Ie:[],ss=ut.some(je=>String((je==null?void 0:je.id)||"")===pe.id),Mt={id:pe.id,name:u,quantity:1,status:"pending",createdAt:new Date().toISOString()},ns=ss?ut:[...ut,Mt];localStorage.setItem(Ue,JSON.stringify(ns))}catch{}N({title:"تمت الإضافة للنواقص",description:`المنتج ${u} نفد من المخزون وتمت إضافته للنواقص`});return}catch(se){console.warn("Failed to add deficiency to Firestore, falling back to local storage:",se)}const _=`deficiencies_${(P==null?void 0:P.shopId)||(g==null?void 0:g.uid)||"default-shop"}`,M=localStorage.getItem(_),Y=M?JSON.parse(M):[],Q=Array.isArray(Y)?Y:[];if(Q.some(se=>String((se==null?void 0:se.name)||"").trim()===u&&String((se==null?void 0:se.status)||"pending")==="pending"))return;const S={id:Date.now().toString(),name:u,quantity:1,status:"pending",createdAt:new Date().toISOString()},B=[...Q,S];localStorage.setItem(_,JSON.stringify(B)),N({title:"تمت الإضافة للنواقص",description:`المنتج ${u} نفد من المخزون وتمت إضافته للنواقص`})}catch(_){console.error("Error adding deficiency for out-of-stock:",_)}},fs=async u=>{const _=q[u.id]||"",M=parseInt(_);if(isNaN(M)||M<=0){N({title:"كمية غير صالحة",description:"أدخل كمية صحيحة للبيـع",variant:"destructive"});return}if(M>u.quantity){N({title:"كمية أكبر من المتاح",description:"الكمية المطلوب بيعها تتجاوز المخزون المتاح",variant:"destructive"});return}const Y=new Date,Q=k&&U?"cashier":"admin",we=Q==="cashier"?(U==null?void 0:U.name)||"كاشير":(P==null?void 0:P.fullName)||(g==null?void 0:g.displayName)||"الحساب الرئيسي",S=Q==="cashier"&&(U==null?void 0:U.username)||null,B=(u.serialNumber||"").trim(),se=Ee[u.id]||"",pe=parseFloat(se),Ue=!isNaN(pe)&&pe>0?pe:u.sellingPrice,Ve={id:Date.now().toString(),productName:u.name,price:Ue,wholesalePrice:u.wholesalePrice,quantity:M,date:Y.toISOString().split("T")[0],time:Y.toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit"}),performedByType:Q,performedByName:we,performedByUsername:S,serialNumber:B||void 0,barcode:u.barcode};try{const Ie=await Dt(Ve),ut=Ie?{...Ve,firestoreId:Ie}:Ve;ht([...p,ut]);const ss=u.quantity-M;await na(Ge(de,"products",u.id),{quantity:ss,updatedAt:ct()}),L(Mt=>Mt.map(ns=>ns.id===u.id?{...ns,quantity:ss}:ns)),X(Mt=>({...Mt,[u.id]:""})),He(Mt=>({...Mt,[u.id]:""})),ss===0&&Ns(u.name);try{const Mt=Ue*M,ns=Ht(),je=localStorage.getItem(ns),as=(je?parseFloat(je):0)+Mt;localStorage.setItem(ns,as.toString());const Yr=`userData_${g==null?void 0:g.uid}`,ya={cashBalance:as,lastUpdated:new Date().toISOString()};localStorage.setItem(Yr,JSON.stringify(ya)),g!=null&&g.uid&&Ce.updateUserData(g.uid,ya).catch(()=>{})}catch(Mt){console.warn("تعذر تحديث رصيد الدرج النقدي بعد البيع:",Mt)}N({title:"تم البيع",description:`تم بيع ${M} قطعة من ${u.name}`})}catch(Ie){console.error("Error selling product:",Ie),N({title:"فشل البيع",description:"تعذّر تنفيذ عملية البيع",variant:"destructive"})}},Ss=async u=>{if(!(g!=null&&g.uid))return;if(k){N({title:"غير مسموح في وضع الكاشير",description:"لا يمكن حذف إيصالات البيع أثناء الورديه",variant:"destructive"});return}window.confirm(`هل تريد حذف إيصال بيع للمنتج "${u.productName}"؟ سيتم عكس المخزون والرصيد.`)&&Ut("تأكيد حذف إيصال بيع","أدخل الرقم السري الرئيسي لحذف الإيصال وعكس الآثار",async()=>{try{try{const M=(u.price??0)*(u.quantity??0),Y=Ht(),Q=localStorage.getItem(Y),S=(Q?parseFloat(Q):0)-M;localStorage.setItem(Y,S.toString());const B=`userData_${g==null?void 0:g.uid}`,se={cashBalance:S,lastUpdated:new Date().toISOString()};localStorage.setItem(B,JSON.stringify(se)),g!=null&&g.uid&&Ce.updateUserData(g.uid,se).catch(()=>{})}catch(M){console.warn("تعذر عكس رصيد الدرج النقدي عند حذف الإيصال:",M)}try{const M=C.find(Y=>u.barcode&&Y.barcode===u.barcode||Y.name===u.productName);if(M){const Y=(M.quantity||0)+(u.quantity||0);await na(Ge(de,"products",M.id),{quantity:Y,updatedAt:ct()}),L(Q=>Q.map(we=>we.id===M.id?{...we,quantity:Y}:we))}}catch(M){console.warn("تعذر عكس المخزون عند حذف الإيصال:",M)}try{if(u.firestoreId)await Ga(Ge(de,"dailySales",u.firestoreId));else{const M=Bt(et(de,"dailySales"),Le("userId","==",g.uid),Le("date","==",u.date),Le("productName","==",u.productName),jl(5)),Y=await es(M);if(!Y.empty){const Q=Y.docs.find(we=>{const S=we.data();return Number((S==null?void 0:S.sellingPrice)??0)===Number(u.price??0)&&Number((S==null?void 0:S.quantity)??0)===Number(u.quantity??0)&&String((S==null?void 0:S.time)??"")===String(u.time??"")})||Y.docs[0];Q&&await Ga(Q.ref)}}}catch(M){console.warn("تعذر حذف سجل البيع من Firestore:",M)}try{const M=oe(),Y=`salesData_${g.uid}_${M}`,Q=`salesData_all_${g.uid}`,we=p.filter(pe=>pe.id!==u.id);localStorage.setItem(Y,JSON.stringify(we));const S=localStorage.getItem(Q),B=S?JSON.parse(S):[],se=(Array.isArray(B)?B:[]).filter(pe=>(pe==null?void 0:pe.id)!==u.id);localStorage.setItem(Q,JSON.stringify(se)),f(we)}catch(M){console.warn("تعذر تحديث التخزين المحلي بعد الحذف:",M)}try{wt||await St()}catch{}N({title:"تم حذف الإيصال",description:`تم حذف إيصال بيع للمنتج ${u.productName} وتم عكس الآثار`})}catch(M){console.error("Error deleting sale:",M),N({title:"فشل حذف الإيصال",description:"تعذّر حذف إيصال البيع",variant:"destructive"})}})},Je=async u=>{try{X(_=>({..._,[u.id]:"1"})),await fs(u)}catch(_){console.error("Error selling by barcode:",_)}},Fs=async u=>{if(k){N({title:"غير مسموح في وضع الكاشير",description:"لا يمكن إضافة قطع أثناء الورديه",variant:"destructive"});return}const _=z[u.id]||"",M=parseInt(_);if(isNaN(M)||M<=0){N({title:"كمية غير صالحة",description:"أدخل كمية صحيحة للإضافة",variant:"destructive"});return}Ut("تأكيد إضافة قطع","لا يمكن إضافة قطع إلا بإدخال الرقم السري الرئيسي",async()=>{try{const Y=u.quantity+M;await na(Ge(de,"products",u.id),{quantity:Y,updatedAt:ct()}),L(Q=>Q.map(we=>we.id===u.id?{...we,quantity:Y}:we)),F(Q=>({...Q,[u.id]:""})),N({title:"تمت الإضافة",description:`تمت إضافة ${M} قطعة إلى ${u.name}`})}catch(Y){console.error("Error adding pieces:",Y),N({title:"فشل الإضافة",description:"تعذّر إضافة الكمية إلى المخزون",variant:"destructive"})}})},zt=async u=>{if(!(g!=null&&g.uid))return;if(k){N({title:"غير مسموح في وضع الكاشير",description:"لا يمكن حذف المنتجات أثناء الورديه",variant:"destructive"});return}window.confirm(`هل تريد حذف المنتج "${u.name}"؟`)&&Ut("تأكيد حذف منتج","لا يمكن حذف المنتجات إلا بإدخال الرقم السري الرئيسي",async()=>{try{await Ga(Ge(de,"products",u.id)),L(M=>M.filter(Y=>Y.id!==u.id)),N({title:"تم الحذف",description:`تم حذف المنتج ${u.name}`})}catch(M){console.error("Error deleting product:",M),N({title:"فشل الحذف",description:"تعذّر حذف المنتج",variant:"destructive"})}})},Ps=async()=>{try{if(!(g!=null&&g.uid)){N({title:"خطأ",description:"غير مسجّل دخول",variant:"destructive"});return}if(k){N({title:"غير مسموح في وضع الكاشير",description:"لا يمكن إضافة منتجات أثناء الورديه",variant:"destructive"});return}const u=j.productName.trim(),_=parseFloat(j.price),M=parseFloat(j.wholesalePrice||"0"),Y=parseInt(j.quantity);if(!u||isNaN(_)||isNaN(Y)){N({title:"بيانات غير مكتملة",description:"أدخل اسم المنتج والسعر والكمية",variant:"destructive"});return}const Q={name:u,sellingPrice:_,wholesalePrice:isNaN(M)?0:M,quantity:isNaN(Y)?0:Y,userId:g.uid,createdAt:ct(),updatedAt:ct()},we=(j.barcode||"").trim();we&&(Q.barcode=we);const S=(j.serialNumber||"").trim();S&&(Q.serialNumber=S),P!=null&&P.shopId&&(Q.shopId=P.shopId);const B=await xa(et(de,"products"),Q);L(se=>[{id:B.id,name:u,sellingPrice:_,wholesalePrice:isNaN(M)?0:M,quantity:isNaN(Y)?0:Y,barcode:(j.barcode||"").trim()||"",serialNumber:(j.serialNumber||"").trim()||""},...se]),s({productName:"",price:"",wholesalePrice:"",quantity:"",barcode:"",serialNumber:""}),N({title:"تمت الإضافة",description:`تم إضافة المنتج ${u} بنجاح`})}catch(u){console.error("createProduct error",u),N({title:"فشل الإضافة",description:"تعذّر إضافة المنتج. حاول مجددًا",variant:"destructive"})}},gt=async u=>{const _=(u||"").trim();if(!_)return;const M=C.find(Y=>(Y.barcode||"")===_);if(!M){N({title:"باركود غير معروف",description:"لم يتم العثور على منتج بهذا الباركود"});return}await Je(M)},ys=()=>{const u=Object.entries(be).map(([se,pe])=>{const Ue=Number(pe),Ve=C.find(Ie=>Ie.id===se);return!Ve||!Ue||Ue<=0?null:{name:Ve.name,qty:Ue,price:Ve.sellingPrice,total:Ue*Ve.sellingPrice}}).filter(Boolean);if(u.length===0){N({title:"لم يتم اختيار منتجات",description:"فعّل وضع الفاتورة واختر منتجات وكميات للطباعة"});return}const _=(P==null?void 0:P.shopName)||(g==null?void 0:g.displayName)||"المحل",M=(P==null?void 0:P.phone)||(g==null?void 0:g.phoneNumber)||"",Y=u.reduce((se,pe)=>se+pe.total,0),Q=new Date().toLocaleString("ar-EG"),we=u.map(se=>`
        <tr>
          <td style="border:1px solid #ddd;padding:6px">${se.name}</td>
          <td style="border:1px solid #ddd;padding:6px;text-align:center">${se.qty}</td>
          <td style="border:1px solid #ddd;padding:6px;text-align:center">${Et(se.price)}</td>
          <td style="border:1px solid #ddd;padding:6px;text-align:center;font-weight:bold;color:#0a7">${Et(se.total)}</td>
        </tr>
      `).join(""),S=`
      <html>
        <head>
          <meta charset="utf-8" />
          <title>فاتورة</title>
          <style>
            body { font-family: Tahoma, Arial, sans-serif; direction: rtl; }
            .header { text-align: center; margin-bottom: 12px; }
            .header h2 { margin: 0; }
            .meta { text-align: center; color: #555; margin-bottom: 8px; }
            table { width: 100%; border-collapse: collapse; }
            .total { text-align: left; font-weight: bold; margin-top: 10px; }
          </style>
        </head>
        <body>
          <div class="header">
            <h2>${_}</h2>
            ${M?`<div class="meta">رقم التليفون: ${M}</div>`:""}
            <div class="meta">التاريخ: ${Q}</div>
          </div>
          <table>
            <thead>
              <tr>
                <th style="border:1px solid #ddd;padding:6px">المنتج</th>
                <th style="border:1px solid #ddd;padding:6px">الكمية</th>
                <th style="border:1px solid #ddd;padding:6px">السعر</th>
                <th style="border:1px solid #ddd;padding:6px">الإجمالي</th>
              </tr>
            </thead>
            <tbody>
              ${we}
            </tbody>
          </table>
          <div class="total">الإجمالي الكلي: ${Et(Y)}</div>
        </body>
      </html>
    `,B=window.open("","_blank");B&&(B.document.write(S),B.document.close(),B.focus(),B.print(),B.close())};return e.jsxs(me,{open:n,onOpenChange:d,children:[e.jsxs(he,{className:"max-w-none w-[100vw] md:w-[100vw] lg:w-[100vw] max-h-[85vh] md:h-[100dvh] md:max-h-[100dvh] p-0 overflow-y-auto",children:[e.jsx(ue,{className:"px-3 md:px-6 py-3 md:py-4 border-b bg-gradient-to-r from-blue-50 to-purple-50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 md:gap-3",children:[e.jsx("div",{className:"p-1.5 md:p-2 bg-blue-100 rounded-lg",children:e.jsx(zr,{className:"h-5 w-5 md:h-6 md:w-6 text-blue-600"})}),e.jsxs("div",{children:[e.jsx(xe,{className:"text-lg md:text-xl font-bold text-gray-800",children:"📊 بيانات المبيعات اليومية"}),e.jsxs("p",{className:"text-xs md:text-sm text-gray-600 mt-1 hidden sm:block",children:["إدارة وتتبع مبيعات اليوم - ",new Date().toLocaleDateString("ar-EG")]})]})]}),e.jsxs("div",{className:"flex items-center gap-1 md:gap-2",children:[e.jsx(m,{variant:"outline",size:"sm",onClick:()=>Ct(),className:"text-xs md:text-sm",children:"استرجاع الإيصالات"}),e.jsx(m,{variant:"ghost",size:"sm",onClick:d,className:"h-8 w-8 md:h-9 md:w-9",children:e.jsx(Ll,{className:"h-4 w-4"})})]})]})}),e.jsxs("div",{className:"flex flex-col md:flex-row h-full",dir:"rtl",children:[e.jsxs("div",{className:"w-full md:w-72 lg:w-80 bg-white/50 border-r",children:[e.jsxs("div",{className:"p-3 md:p-4 border-b bg-white/30",children:[e.jsxs("h3",{className:"font-semibold text-gray-800 mb-3 flex items-center gap-2 text-sm md:text-base",children:[e.jsx(yt,{className:"h-4 w-4 text-green-600"}),"ملخص المبيعات"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 md:gap-3",children:[e.jsxs("div",{className:"bg-blue-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-blue-600",children:Et(p.reduce((u,_)=>u+_.price*_.quantity,0))}),e.jsx("div",{className:"text-xs md:text-sm text-blue-600",children:"إجمالي المبيعات"})]}),e.jsxs("div",{className:"relative bg-green-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsxs("div",{className:Oe?"filter blur-sm pointer-events-none":"",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-green-600",children:Et(p.reduce((u,_)=>u+(_.price-(_.wholesalePrice??0))*_.quantity,0))}),e.jsx("div",{className:"text-xs md:text-sm text-green-600",children:"إجمالي الأرباح"})]}),Oe&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx(m,{size:"sm",variant:"ghost",onClick:()=>Se(!0),className:"bg-white/80 hover:bg-white text-green-700 border border-green-200",children:"عرض الأرباح"})})]}),e.jsxs("div",{className:"bg-yellow-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-yellow-600",children:Da(C.length)}),e.jsx("div",{className:"text-xs md:text-sm text-yellow-600",children:"عدد المنتجات"})]}),e.jsxs("div",{className:"bg-purple-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-purple-600",children:Da(p.length)}),e.jsx("div",{className:"text-xs md:text-sm text-purple-600",children:"عدد المبيعات"})]})]}),e.jsxs("div",{className:"relative mb-2",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-1 md:gap-2 text-xs md:text-sm font-semibold text-indigo-700",children:[e.jsx(ia,{className:"h-3 w-3 md:h-4 md:w-4"}),e.jsx(zr,{className:"h-3 w-3 md:h-4 md:w-4"}),e.jsx("span",{children:"تقارير الشهر"})]}),e.jsx(m,{size:"sm",variant:"ghost",onClick:()=>pt(u=>!u),className:"h-6 w-6 p-0 rounded-full",title:Ye?"إظهار التقارير":"إخفاء التقارير",children:Ye?e.jsx(Qa,{className:"h-4 w-4"}):e.jsx(Br,{className:"h-4 w-4"})})]}),e.jsx("div",{className:Ye?"overflow-hidden max-h-0 transition-[max-height] duration-300":"overflow-hidden transition-[max-height] duration-300 max-h-[400px]",children:e.jsxs("div",{className:wt?"grid grid-cols-2 gap-2 md:gap-4 filter blur-sm pointer-events-none":"grid grid-cols-2 gap-2 md:gap-4",children:[e.jsxs("div",{className:"bg-indigo-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-indigo-600",children:Et(Re)}),e.jsx("div",{className:"text-xs md:text-sm text-indigo-600",children:"مبيعات الشهر"})]}),e.jsxs("div",{className:"bg-pink-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-pink-600",children:Et(vt)}),e.jsx("div",{className:"text-xs md:text-sm text-pink-600",children:"أرباح الشهر"})]})]})}),!Ye&&wt&&e.jsx("div",{className:"absolute left-0 right-0 top-7 md:top-10 bottom-0 flex items-center justify-center rounded-lg bg-yellow-100/60",children:e.jsxs(m,{size:"sm",variant:"ghost",onClick:async()=>{try{if(await isZeroPlan()){N({title:"الخطة زيرو",description:"التقارير الشهرية غير متاحة في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}catch{}bt(!0)},className:"flex items-center gap-2 bg-yellow-200/70 hover:bg-yellow-300 text-yellow-900 px-3 py-2 rounded-xl shadow-md hover:shadow-lg transition-all btn-monthly-reports",title:"عرض تقارير الشهر",children:[e.jsx(mt,{className:"h-5 w-5 md:h-7 md:w-7"}),e.jsx("span",{className:"text-xs md:text-sm",children:"عرض تقارير الشهر"})]})})]})]}),e.jsxs("div",{className:"p-3 md:p-4 border-b bg-white/30",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("h3",{className:"font-semibold text-gray-800 flex items-center gap-2 text-sm md:text-base",children:[e.jsx(Ya,{className:"h-4 w-4 text-indigo-600"}),"إحصائيات المنتجات"]}),e.jsx(m,{size:"sm",variant:"ghost",onClick:()=>Pt(u=>!u),className:"h-6 w-6 p-0 rounded-full",title:qe?"إظهار القسم":"إخفاء القسم",children:qe?e.jsx(Qa,{className:"h-4 w-4"}):e.jsx(Br,{className:"h-4 w-4"})})]}),e.jsx("div",{className:qe?"overflow-hidden max-h-0 transition-[max-height] duration-300":"overflow-hidden transition-[max-height] duration-300 max-h-[400px]"})]}),e.jsxs("div",{className:"p-3 md:p-4 flex-1 hidden md:block",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("h3",{className:"font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(ei,{className:"h-4 w-4 text-blue-600"}),"نصائح للمبيعات"]}),e.jsx(m,{size:"sm",variant:"ghost",onClick:()=>ne(u=>!u),className:"h-6 w-6 p-0 rounded-full",title:E?"إظهار القسم":"إخفاء القسم",children:E?e.jsx(Qa,{className:"h-4 w-4"}):e.jsx(Br,{className:"h-4 w-4"})})]}),e.jsx("div",{className:E?"overflow-hidden max-h-0 transition-[max-height] duration-300":"overflow-hidden transition-[max-height] duration-300 max-h-[400px]"})]})]}),e.jsx("div",{className:"flex-1 overflow-y-visible transition-all duration-300 ease-in-out",children:e.jsxs("div",{className:"p-3 md:p-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 md:mb-6 gap-2",children:[e.jsxs("h2",{className:"text-base md:text-lg font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(rm,{className:"h-4 w-4 md:h-5 md:w-5 text-blue-600"}),"سجل المبيعات (",p.length," عنصر)"]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs md:text-sm text-gray-600",children:[e.jsx(ia,{className:"h-3 w-3 md:h-4 md:w-4"}),e.jsx("span",{className:"hidden sm:inline",children:new Date().toLocaleDateString("ar-EG")}),e.jsx(Js,{className:"h-3 w-3 md:h-4 md:w-4 ml-2"}),e.jsx("span",{children:new Date().toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit"})})]})]}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-3 md:p-4 mb-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("h3",{className:"text-sm md:text-base font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(Zt,{className:"h-4 w-4 text-emerald-600"}),"إضافة منتج جديد"]}),e.jsxs(m,{size:"sm",variant:"ghost",className:"h-8",onClick:()=>{if(k){N({title:"غير مسموح في وضع الكاشير",description:"لا يمكن إضافة منتج أثناء الورديه",variant:"destructive"});return}Ut("فتح نموذج إضافة منتج","أدخل الرقم السري الرئيسي لفتح نموذج الإضافة",()=>O(!0))},children:[e.jsx(Zt,{className:"h-4 w-4 text-emerald-600"}),"إضافة منتج"]})]}),A&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx(Z,{htmlFor:"new-product-name",className:"text-xs md:text-sm",children:"اسم المنتج"}),e.jsx(R,{id:"new-product-name",value:j.productName,onChange:u=>s(_=>({..._,productName:u.target.value})),placeholder:"أدخل اسم المنتج"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx(Z,{htmlFor:"new-product-price",className:"text-xs md:text-sm",children:"سعر البيع (ج.م)"}),e.jsx(R,{type:"number",id:"new-product-price",value:j.price,onChange:u=>s(_=>({..._,price:u.target.value})),placeholder:"0.00"})]}),e.jsxs("div",{children:[e.jsx(Z,{htmlFor:"new-product-wholesale",className:"text-xs md:text-sm",children:"سعر الجملة (ج.م)"}),e.jsx(R,{type:"number",id:"new-product-wholesale",value:j.wholesalePrice||"",onChange:u=>s(_=>({..._,wholesalePrice:u.target.value})),placeholder:"0.00"})]})]}),e.jsxs("div",{children:[e.jsx(Z,{htmlFor:"new-product-qty",className:"text-xs md:text-sm",children:"الكمية"}),e.jsx(R,{type:"number",id:"new-product-qty",value:j.quantity,onChange:u=>s(_=>({..._,quantity:u.target.value})),placeholder:"1"})]}),e.jsxs("div",{children:[e.jsx(Z,{htmlFor:"new-product-barcode",className:"text-xs md:text-sm",children:"باركود المنتج (اختياري)"}),e.jsx(R,{id:"new-product-barcode",value:j.barcode||"",onChange:u=>s(_=>({..._,barcode:u.target.value})),placeholder:"أدخل/امسح الباركود"})]}),e.jsxs("div",{children:[e.jsx(Z,{htmlFor:"new-product-serial",className:"text-xs md:text-sm",children:"سيريال الجهاز (اختياري)"}),e.jsx(R,{id:"new-product-serial",value:j.serialNumber||"",onChange:u=>s(_=>({..._,serialNumber:u.target.value})),placeholder:"أدخل سيريال الجهاز"})]}),e.jsx(m,{className:"h-9 w-full md:w-auto",onClick:Ps,children:"إضافة المنتج"})]})]}),e.jsx("div",{id:"shop-products-section",className:"bg-white rounded-lg border border-gray-200 overflow-hidden mb-4",children:e.jsxs("div",{className:"mb-4",children:[e.jsxs("h3",{className:"text-sm md:text-base font-semibold text-gray-800 mb-2 flex items-center gap-2",children:[e.jsx(Ya,{className:"h-4 w-4 text-green-600"}),"منتجات المحل"]}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(m,{variant:V?"default":"outline",size:"sm",onClick:()=>le(u=>!u),children:V?"وضع الفاتورة: مفعل":"تفعيل وضع الفاتورة"}),e.jsx(m,{size:"sm",className:"bg-indigo-600 hover:bg-indigo-700 text-white",disabled:Object.keys(be).filter(u=>(be[u]||0)>0).length===0,onClick:ys,children:"طباعة فاتورة"})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(R,{value:It,onChange:u=>Yt(u.target.value),placeholder:"ابحث عن منتج...",className:"h-9 w-full md:w-72 text-sm","aria-label":"البحث عن منتج من منتجات المحل"}),e.jsx(R,{value:Pe,onChange:u=>ee(u.target.value),onKeyDown:async u=>{if(u.key!=="Enter")return;const _=Pe.trim();_&&(await gt(_),ee(""))},placeholder:"مرّر ماسح الباركود هنا (اختياري)",className:"h-9 w-full md:w-64 text-sm","aria-label":"مسح الباركود لإضافة المنتج تلقائياً"}),It&&e.jsx(m,{variant:"ghost",size:"sm",className:"h-9",onClick:()=>Yt(""),children:"مسح"})]}),e.jsx("div",{className:"overflow-x-auto border border-gray-200 rounded-lg hidden md:block",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"المنتج"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"سعر البيع"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("span",{children:"سعر الجملة"}),e.jsx(m,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>Fe(u=>!u),"aria-label":ge?"إخفاء سعر الجملة":"إظهار سعر الجملة",children:ge?e.jsx(Kt,{className:"h-4 w-4"}):e.jsx(mt,{className:"h-4 w-4"})})]})}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"المتاح"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"بيع"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:W.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"px-3 py-3 text-center text-gray-500",children:C.length===0?"لا توجد منتجات بعد، أضف منتجاً من النموذج أعلاه":"لا توجد نتائج مطابقة للبحث"})}):W.map(u=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-3 py-2 font-medium text-gray-900",children:u.name}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:Et(u.sellingPrice)}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:e.jsx("span",{className:ge?"":"blur-sm select-none",children:Et(u.wholesalePrice)})}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:Da(u.quantity)}),e.jsx("td",{className:"px-3 py-2",children:e.jsxs("div",{className:"flex items-center gap-2 flex-nowrap",children:[e.jsx(R,{value:q[u.id]||"",onChange:_=>X(M=>({...M,[u.id]:_.target.value})),type:"number",placeholder:"عدد القطع للبيع",className:"h-8 w-28 text-sm"}),e.jsx(R,{value:Ee[u.id]||"",onChange:_=>He(M=>({...M,[u.id]:_.target.value})),type:"number",placeholder:"سعر بيع اختياري",className:"h-8 w-32 text-sm","aria-label":`سعر بيع اختياري لـ ${u.name}`}),e.jsx(m,{size:"sm",className:"h-8 min-w-[64px]",onClick:()=>fs(u),children:"بيع"}),V&&e.jsx(R,{value:be[u.id]??"",onChange:_=>{const M=parseInt(_.target.value||"0");ke(Y=>({...Y,[u.id]:isNaN(M)?0:M}))},type:"number",placeholder:"كمية للفاتورة",className:"h-8 w-24 text-sm"}),e.jsx(R,{value:z[u.id]||"",onChange:_=>F(M=>({...M,[u.id]:_.target.value})),type:"number",placeholder:"عدد للإضافة",className:"h-8 w-28 text-sm",disabled:k}),e.jsxs("div",{className:"inline-flex items-center gap-2 flex-nowrap",children:[e.jsx(m,{size:"sm",variant:"outline",className:"h-8 whitespace-nowrap",onClick:()=>Fs(u),disabled:k,title:k?"غير مسموح في وضع الكاشير":void 0,children:"إضافة قطع جديدة"}),e.jsx(m,{size:"sm",variant:"destructive",className:"h-8",onClick:()=>zt(u),title:"حذف المنتج",disabled:k,children:e.jsx(Jt,{className:"h-4 w-4"})})]})]})})]},u.id))})]})}),e.jsx("div",{className:"block md:hidden space-y-3",children:W.length===0?e.jsx("div",{className:"text-center text-gray-500 text-sm",children:C.length===0?"لا توجد منتجات بعد، أضف منتجاً من النموذج أعلاه":"لا توجد نتائج مطابقة للبحث"}):W.map(u=>e.jsxs("div",{className:"bg-white rounded-xl p-3 border border-gray-200 shadow-sm",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"font-semibold text-gray-900 text-sm break-words",children:u.name}),e.jsx(m,{size:"sm",variant:"destructive",className:"h-8 min-w-[44px] touch-manipulation",onClick:()=>zt(u),title:"حذف المنتج",disabled:k,children:e.jsx(Jt,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-2 text-xs text-gray-700",children:[e.jsx("div",{className:"text-gray-600",children:"سعر البيع"}),e.jsx("div",{className:"text-right font-medium",children:Et(u.sellingPrice)}),e.jsxs("div",{className:"text-gray-600 inline-flex items-center gap-1",children:[e.jsx("span",{children:"سعر الجملة"}),e.jsx(m,{variant:"ghost",size:"icon",className:"h-5 w-5",onClick:()=>Fe(_=>!_),"aria-label":ge?"إخفاء سعر الجملة":"إظهار سعر الجملة",children:ge?e.jsx(Kt,{className:"h-4 w-4"}):e.jsx(mt,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"text-right font-medium",children:e.jsx("span",{className:ge?"":"blur-sm select-none",children:Et(u.wholesalePrice)})}),e.jsx("div",{className:"text-gray-600",children:"المتاح"}),e.jsx("div",{className:"text-right font-medium",children:Da(u.quantity)})]}),e.jsxs("div",{className:"mt-3 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(R,{value:q[u.id]||"",onChange:_=>X(M=>({...M,[u.id]:_.target.value})),type:"number",placeholder:"عدد القطع للبيع",className:"h-9 flex-1 text-sm","aria-label":`عدد القطع للبيع لـ ${u.name}`}),e.jsx(R,{value:Ee[u.id]||"",onChange:_=>He(M=>({...M,[u.id]:_.target.value})),type:"number",placeholder:"سعر بيع اختياري",className:"h-9 w-28 text-sm","aria-label":`سعر بيع اختياري لـ ${u.name}`}),e.jsx(m,{size:"sm",className:"h-9 min-w-[64px]",onClick:()=>fs(u),children:"بيع"})]}),V&&e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(R,{value:be[u.id]??"",onChange:_=>{const M=parseInt(_.target.value||"0");ke(Y=>({...Y,[u.id]:isNaN(M)?0:M}))},type:"number",placeholder:"كمية للفاتورة",className:"h-9 flex-1 text-sm","aria-label":`كمية للفاتورة لـ ${u.name}`})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(R,{value:z[u.id]||"",onChange:_=>F(M=>({...M,[u.id]:_.target.value})),type:"number",placeholder:"عدد للإضافة",className:"h-9 flex-1 text-sm","aria-label":`عدد القطع للإضافة لـ ${u.name}`,disabled:k}),e.jsx(m,{size:"sm",variant:"outline",className:"h-9 min-w-[64px]",onClick:()=>Fs(u),disabled:k,title:k?"غير مسموح في وضع الكاشير":void 0,children:"إضافة"})]})]})]},u.id))})]})}),p.length===0?e.jsxs("div",{className:"text-center py-8 md:py-12",children:[e.jsx("div",{className:"w-16 h-16 md:w-24 md:h-24 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center",children:e.jsx(Ya,{className:"h-8 w-8 md:h-12 md:w-12 text-gray-400"})}),e.jsx("h3",{className:"text-base md:text-lg font-medium text-gray-900 mb-2",children:"لا توجد مبيعات اليوم"}),e.jsx("p",{className:"text-sm text-gray-500",children:"ابدأ ببيع منتج من القائمة أعلاه"})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"block md:hidden",children:e.jsx("div",{className:"max-h-[70vh] overflow-y-auto space-y-3 p-3",children:p.map(u=>e.jsxs("div",{className:"bg-white rounded-xl p-4 border border-gray-200 shadow-sm",children:[e.jsx("div",{className:"mb-3",children:e.jsx("h4",{className:"font-semibold text-gray-900 text-base break-words",children:u.productName})}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-2 text-sm text-gray-700",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(yt,{className:"h-4 w-4 text-blue-600"}),e.jsx("span",{className:"text-gray-600",children:"سعر البيع"})]}),e.jsx("div",{className:"text-right font-medium",children:Et(u.price)}),typeof u.wholesalePrice=="number"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(yt,{className:"h-4 w-4 text-indigo-600"}),e.jsxs("span",{className:"text-gray-600 inline-flex items-center gap-1",children:["سعر الجملة",e.jsx(m,{variant:"ghost",size:"icon",className:"h-5 w-5",onClick:()=>Fe(_=>!_),"aria-label":ge?"إخفاء سعر الجملة":"إظهار سعر الجملة",children:ge?e.jsx(Kt,{className:"h-4 w-4"}):e.jsx(mt,{className:"h-4 w-4"})})]})]}),e.jsx("div",{className:"text-right font-medium",children:e.jsx("span",{className:ge?"":"blur-sm select-none",children:Et(u.wholesalePrice)})})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ya,{className:"h-4 w-4 text-emerald-600"}),e.jsx("span",{className:"text-gray-600",children:"الكمية"})]}),e.jsx("div",{className:"text-right font-medium",children:Da(u.quantity)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ia,{className:"h-4 w-4 text-purple-600"}),e.jsx("span",{className:"text-gray-600",children:"الربح"})]}),e.jsx("div",{className:"text-right font-semibold text-purple-700",children:Et(((u.price??0)-(u.wholesalePrice??0))*(u.quantity??0))}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(yt,{className:"h-4 w-4 text-green-600"}),e.jsx("span",{className:"text-gray-600",children:"الإجمالي"})]}),e.jsx("div",{className:"text-right font-bold text-green-700",children:Et(u.price*u.quantity)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(am,{className:"h-4 w-4 text-amber-600"}),e.jsx("span",{className:"text-gray-600",children:"المنفذ"})]}),e.jsx("div",{className:"text-right text-gray-700",children:u.performedByName??"-"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ia,{className:"h-4 w-4 text-blue-600"}),e.jsx("span",{className:"text-gray-600",children:"التاريخ"})]}),e.jsx("div",{className:"text-right text-gray-600",children:Wl(u.date)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Js,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"text-gray-600",children:"الوقت"})]}),e.jsx("div",{className:"text-right text-gray-600",children:u.time})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-end gap-2",children:[e.jsx(m,{size:"sm",variant:"outline",onClick:()=>Ss(u),disabled:k,title:k?"غير مسموح في وضع الكاشير":"مرتجع",className:"h-8 border-red-300 text-red-600 hover:bg-red-50",children:"مرتجع"}),e.jsxs(m,{size:"sm",variant:"destructive",onClick:()=>Ss(u),disabled:k,title:k?"غير مسموح في وضع الكاشير":"حذف الإيصال",className:"h-8",children:[e.jsx(Jt,{className:"h-4 w-4"}),e.jsx("span",{className:"ml-1",children:"حذف الإيصال"})]})]})]},u.id))})}),e.jsx("div",{className:"hidden md:block overflow-x-auto max-h-96 overflow-y-auto scrollbar-thin scrollbar-thumb-green-300 scrollbar-track-green-100 hover:scrollbar-thumb-green-400",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"المنتج"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"سعر البيع (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("span",{children:"سعر الجملة (ج.م)"}),e.jsx(m,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>Fe(u=>!u),"aria-label":ge?"إخفاء سعر الجملة":"إظهار سعر الجملة",children:ge?e.jsx(Kt,{className:"h-4 w-4"}):e.jsx(mt,{className:"h-4 w-4"})})]})}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الكمية"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الإجمالي (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الربح (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"التاريخ"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الوقت"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"المنفذ"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"إجراءات"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:p.map((u,_)=>e.jsxs("tr",{className:_%2===0?"bg-white":"bg-gray-50/50",children:[e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-gray-900",children:u.productName}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:Et(u.price)}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:typeof u.wholesalePrice=="number"?e.jsx("span",{className:ge?"":"blur-sm select-none",children:Et(u.wholesalePrice)}):"-"}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:Da(u.quantity)}),e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-green-600",children:Et(u.price*u.quantity)}),e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-purple-600",children:Et(((u.price??0)-(u.wholesalePrice??0))*(u.quantity??0))}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-500",children:Wl(u.date)}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-500",children:u.time}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:u.performedByName??"-"}),e.jsx("td",{className:"px-4 py-3 text-sm text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(m,{size:"sm",variant:"outline",onClick:()=>Ss(u),disabled:k,title:k?"غير مسموح في وضع الكاشير":"مرتجع",className:"h-8 border-red-300 text-red-600 hover:bg-red-50",children:"مرتجع"}),e.jsx(m,{size:"sm",variant:"destructive",onClick:()=>Ss(u),disabled:k,title:k?"غير مسموح في وضع الكاشير":"حذف الإيصال",className:"h-8",children:e.jsx(Jt,{className:"h-4 w-4"})})]})})]},u.id))})]})})]}),e.jsxs("div",{className:"mt-4 md:mt-6 text-xs text-gray-500 text-center bg-gray-50/50 p-2 md:p-3 rounded border border-gray-200/40 space-y-1",children:[e.jsx("p",{className:"font-medium text-gray-600",children:"💰 نظام إدارة المبيعات اليومية"}),e.jsxs("p",{className:"hidden sm:block",children:["• يتم حفظ البيانات تلقائياً لليوم الحالي: ",new Date().toLocaleDateString("ar-EG")]}),e.jsx("p",{children:"• يمكنك إضافة وتعديل وحذف المنتجات حسب الحاجة"}),e.jsx("p",{className:"hidden sm:block",children:"• يتم حفظ البيانات محلياً وعلى Firebase لتعزيز الأمان"})]})]})})]})]}),e.jsx(xs,{open:ae,onOpenChange:Se,mode:"verify",title:"قفل إجمالي الأرباح",description:"أدخل الرقم السري الرئيسي لعرض إجمالي الأرباح",onSuccess:()=>{J(!1),Se(!1)}}),e.jsx(xs,{open:Be,onOpenChange:bt,mode:"verify",title:"قفل إحصائيات الشهر",description:"لا يمكن الاطلاع على تقارير الشهر إلا بإدخال الرقم السري الرئيسي",onSuccess:async()=>{try{const u=g==null?void 0:g.uid;if(u){const _=await si(u),M=(_==null?void 0:_.planType)??(_==null?void 0:_.plan)??null,Y=typeof M=="string"?M.toLowerCase():null;if(M===Os.ZERO||Y==="zero"){N({title:"الخطة زيرو",description:"التقارير الشهرية غير متاحة في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}}catch{}Ft(!1),bt(!1),St()}}),e.jsx(xs,{open:jt,onOpenChange:Nt,mode:"verify",title:ts,description:Me,onSuccess:()=>{const u=st.current;st.current=null,Nt(!1),u&&u()}})]})}const Da=n=>new Intl.NumberFormat("ar-EG").format(Number(n||0)),Et=n=>`${new Intl.NumberFormat("ar-EG",{minimumFractionDigits:2,maximumFractionDigits:2}).format(Number(n||0))} ج.م`,Wl=n=>{try{const d=new Date(n);return isNaN(d.getTime())?new Date(`${n}T00:00:00`).toLocaleDateString("ar-EG"):d.toLocaleDateString("ar-EG")}catch{return n}},wm=({open:n,onOpenChange:d,userId:o,cashBalance:p,walletBalances:f,transactions:j})=>{const[s,A]=_e.useState(0),[O,b]=_e.useState(0),[I,N]=_e.useState(0),[g,P]=_e.useState(0),[k,U]=_e.useState(p||0),[C,L]=_e.useState(!1),[q,X]=_e.useState(null),{toast:z}=gs(),F=ee=>`${new Intl.NumberFormat("ar-EG").format(Number(ee||0))} جنيه`;_e.useEffect(()=>{const ee=async()=>{try{if(!o){A(0);return}const be=new Date,ke=be.getFullYear(),ge=String(be.getMonth()+1).padStart(2,"0"),Fe=String(be.getDate()).padStart(2,"0"),Oe=`${ke}-${ge}-${Fe}`,J=Bt(et(de,"dailySales"),Le("userId","==",o),Le("date","==",Oe)),ae=await es(J);let Se=0;ae.forEach(H=>{const ie=H.data(),Re=Number(ie.sellingPrice??0),_t=Number(ie.quantity??0);Re>0&&_t>0&&(Se+=Re*_t)}),A(Se)}catch(be){console.warn("فشل تحميل مبيعات الإكسسوار لليوم:",be)}},V=()=>{try{if(!Array.isArray(j)||j.length===0||!o){b(0);return}const be=Qt.filterVisibleTransactions(j,"daily",o),ke=new Date().toDateString(),ge=be.reduce((Fe,Oe)=>{const J=String(Oe.status||"confirmed").toLowerCase();if(new Date(Oe.createdAt).toDateString()!==ke||J!=="completed"&&J!=="confirmed")return Fe;const Se=(Oe.type||Oe.txnType||"").toLowerCase(),H=String(Oe.toWallet||"").toLowerCase(),ie=Number(Oe.amount||0);return(Se==="send"||Se==="transfer")&&H==="cash"&&ie>0?Fe+ie:Fe},0);b(ge)}catch(be){console.warn("فشل حساب فلوس فوري لليوم:",be)}},le=async()=>{try{if(!o){N(0),P(0);return}const be=await Ce.getUserData(o),ke=new Date().toISOString().slice(0,10),ge=(be==null?void 0:be.dailyReceipts)||{};ge!=null&&ge.date&&String(ge.date).slice(0,10)===ke?(N(Number(ge.accessory||0)),P(Number(ge.fawry||0))):(N(0),P(0)),U(Number((be==null?void 0:be.cashBalance)||p||0))}catch{N(0),P(0)}};n&&(ee(),V(),le())},[n,o,j,p]);const fe=Math.max(0,Number(s)-Number(I)),te=Math.max(0,Number(O)-Number(g)),Pe=async ee=>{if(!o)return;const V=new Date().toISOString().slice(0,10);try{const le=ee==="accessory"?fe:te;if(le<=0){z({title:"لا يوجد مبلغ لتأكيد استلامه",variant:"default"});return}const be=Math.max(0,Number(k)-le);U(be),ee==="accessory"?N(ke=>ke+le):P(ke=>ke+le),await Ce.updateUserData(o,{cashBalance:be,dailyReceipts:{date:V,accessory:ee==="accessory"?I+le:I,fawry:ee==="fawry"?g+le:g}});try{localStorage.setItem(`cashBalance_${o}`,String(be))}catch{}z({title:"تم الاستلام",description:`تم خصم ${le.toFixed(2)} من الدرج وتصفير البند المختار`})}catch{z({title:"خطأ",description:"تعذر تنفيذ عملية تم الاستلام",variant:"destructive"})}};return e.jsx(me,{open:n,onOpenChange:d,children:e.jsxs(he,{className:"sm:max-w-lg animate-in fade-in-90 zoom-in-95 slide-in-from-top-4",dir:"rtl",children:[e.jsx(ue,{children:e.jsxs(xe,{className:"flex items-center gap-2 text-right",children:[e.jsx(yt,{className:"h-5 w-5 text-emerald-600"}),"تفاصيل الفلوس النقدية"]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between bg-amber-50 border border-amber-200 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-amber-800 font-bold text-sm",children:[e.jsx(yt,{className:"h-4 w-4"}),"مجموع الفلوس النقدية (الدرج)"]}),e.jsx("div",{className:"text-amber-700 font-extrabold text-sm",children:F(k)})]}),e.jsxs("div",{className:"flex items-center justify-between bg-blue-50 border border-blue-200 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-blue-800 font-bold text-sm",children:[e.jsx(Ya,{className:"h-4 w-4"}),"فلوس الإكسسوار (اليوم)"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-blue-700 font-extrabold text-sm",children:F(fe)}),e.jsx(m,{size:"sm",variant:"ghost",className:"h-6 px-2 rounded-lg bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800",onClick:()=>{X("accessory"),L(!0)},children:"تم الاستلام"})]})]}),e.jsxs("div",{className:"flex items-center justify-between bg-indigo-50 border border-indigo-200 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-indigo-800 font-bold text-sm",children:[e.jsx(ai,{className:"h-4 w-4"}),"فلوس فوري إلى الدرج (اليوم)"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-indigo-700 font-extrabold text-sm",children:F(te)}),e.jsx(m,{size:"sm",variant:"ghost",className:"h-6 px-2 rounded-lg bg-gradient-to-r from-indigo-100 to-indigo-200 text-indigo-700 hover:from-indigo-200 hover:to-indigo-300 hover:text-indigo-800",onClick:()=>{X("fawry"),L(!0)},children:"تم الاستلام"})]})]})]}),e.jsx(xs,{open:C,onOpenChange:L,mode:"verify",title:"تأكيد الرقم السري لعملية تم الاستلام",description:"يرجى إدخال الرقم السري الرئيسي لتأكيد استلام المبلغ",onSuccess:()=>{q&&(Pe(q),X(null)),L(!1)}})]})})};function Zl({size:n=24,className:d,...o}){return e.jsxs("svg",{width:n,height:n,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",className:d,...o,children:[e.jsx("rect",{x:"5",y:"2.5",width:"14",height:"19",rx:"2.5",stroke:"currentColor",strokeWidth:"1.5"}),e.jsx("rect",{x:"7",y:"4.5",width:"10",height:"5.5",rx:"1",stroke:"currentColor",strokeWidth:"1.2"}),e.jsx("path",{d:"M9.5 11.5h5",stroke:"currentColor",strokeWidth:"1.4",strokeLinecap:"round"}),e.jsx("circle",{cx:"8.5",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"12",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"15.5",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"8.5",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"12",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"15.5",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("rect",{x:"8",y:"19",width:"9",height:"1.8",rx:"0.6",stroke:"currentColor",strokeWidth:"1"})]})}var Xl="AlertDialog",[jm]=pd(Xl,[Vl]),Ys=Vl(),eo=n=>{const{__scopeAlertDialog:d,...o}=n,p=Ys(d);return e.jsx(Cd,{...p,...o,modal:!0})};eo.displayName=Xl;var Nm="AlertDialogTrigger",Sm=i.forwardRef((n,d)=>{const{__scopeAlertDialog:o,...p}=n,f=Ys(o);return e.jsx(Ed,{...f,...p,ref:d})});Sm.displayName=Nm;var Dm="AlertDialogPortal",to=n=>{const{__scopeAlertDialog:d,...o}=n,p=Ys(d);return e.jsx(Id,{...p,...o})};to.displayName=Dm;var Cm="AlertDialogOverlay",so=i.forwardRef((n,d)=>{const{__scopeAlertDialog:o,...p}=n,f=Ys(o);return e.jsx(Od,{...f,...p,ref:d})});so.displayName=Cm;var Aa="AlertDialogContent",[Im,Am]=jm(Aa),Tm=fd("AlertDialogContent"),ao=i.forwardRef((n,d)=>{const{__scopeAlertDialog:o,children:p,...f}=n,j=Ys(o),s=i.useRef(null),A=Bl(d,s),O=i.useRef(null);return e.jsx(Ad,{contentName:Aa,titleName:ro,docsSlug:"alert-dialog",children:e.jsx(Im,{scope:o,cancelRef:O,children:e.jsxs(Td,{role:"alertdialog",...j,...f,ref:A,onOpenAutoFocus:gd(f.onOpenAutoFocus,b=>{var I;b.preventDefault(),(I=O.current)==null||I.focus({preventScroll:!0})}),onPointerDownOutside:b=>b.preventDefault(),onInteractOutside:b=>b.preventDefault(),children:[e.jsx(Tm,{children:p}),e.jsx(km,{contentRef:s})]})})})});ao.displayName=Aa;var ro="AlertDialogTitle",no=i.forwardRef((n,d)=>{const{__scopeAlertDialog:o,...p}=n,f=Ys(o);return e.jsx(Pd,{...f,...p,ref:d})});no.displayName=ro;var io="AlertDialogDescription",lo=i.forwardRef((n,d)=>{const{__scopeAlertDialog:o,...p}=n,f=Ys(o);return e.jsx(kd,{...f,...p,ref:d})});lo.displayName=io;var Pm="AlertDialogAction",oo=i.forwardRef((n,d)=>{const{__scopeAlertDialog:o,...p}=n,f=Ys(o);return e.jsx(Jl,{...f,...p,ref:d})});oo.displayName=Pm;var co="AlertDialogCancel",mo=i.forwardRef((n,d)=>{const{__scopeAlertDialog:o,...p}=n,{cancelRef:f}=Am(co,o),j=Ys(o),s=Bl(d,f);return e.jsx(Jl,{...j,...p,ref:s})});mo.displayName=co;var km=({contentRef:n})=>{const d=`\`${Aa}\` requires a description for the component to be accessible for screen reader users.

You can add a description to the \`${Aa}\` by passing a \`${io}\` component as a child, which also benefits sighted users by adding visible context to the dialog.

Alternatively, you can use your own component as a description by assigning it an \`id\` and passing the same value to the \`aria-describedby\` prop in \`${Aa}\`. If the description is confusing or duplicative for sighted users, you can use the \`@radix-ui/react-visually-hidden\` primitive as a wrapper around your description component.

For more information, see https://radix-ui.com/primitives/docs/components/alert-dialog`;return i.useEffect(()=>{var p;document.getElementById((p=n.current)==null?void 0:p.getAttribute("aria-describedby"))||console.warn(d)},[d,n]),null},Om=eo,Em=to,ho=so,uo=ao,xo=oo,po=mo,go=no,fo=lo;const Wm=Om,_m=Em,yo=i.forwardRef(({className:n,...d},o)=>e.jsx(ho,{className:ga("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",n),...d,ref:o}));yo.displayName=ho.displayName;const vo=i.forwardRef(({className:n,...d},o)=>e.jsxs(_m,{children:[e.jsx(yo,{}),e.jsx(uo,{ref:o,className:ga("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",n),...d})]}));vo.displayName=uo.displayName;const bo=({className:n,...d})=>e.jsx("div",{className:ga("flex flex-col space-y-2 text-center sm:text-left",n),...d});bo.displayName="AlertDialogHeader";const wo=i.forwardRef(({className:n,...d},o)=>e.jsx(go,{ref:o,className:ga("text-lg font-semibold",n),...d}));wo.displayName=go.displayName;const jo=i.forwardRef(({className:n,...d},o)=>e.jsx(fo,{ref:o,className:ga("text-sm text-muted-foreground",n),...d}));jo.displayName=fo.displayName;const ti=i.forwardRef(({className:n,...d},o)=>e.jsx(xo,{ref:o,className:ga($l(),n),...d}));ti.displayName=xo.displayName;const No=i.forwardRef(({className:n,...d},o)=>e.jsx(po,{ref:o,className:ga($l({variant:"outline"}),"mt-2 sm:mt-0",n),...d}));No.displayName=po.displayName;const at=n=>{try{return n.toLocaleString("en-US",{maximumFractionDigits:2})}catch{return String(n)}},_l=n=>{try{return(n?new Date(n):new Date).toLocaleString("en-GB",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}catch{return new Date().toISOString()}},Lr="machine_daily_opening_values",Qn="machine_daily_opening_snapshot";function Fm({open:n,onOpenChange:d}){const{toast:o}=gs(),{shiftUser:p}=tr(),{shopId:f,shopName:j}=Ul();i.useEffect(()=>{try{if(n){const W=document.body.style.overflow;document.body.setAttribute("data-prev-overflow",W),document.body.style.overflow="hidden"}else{const W=document.body.getAttribute("data-prev-overflow")||"";document.body.style.overflow=W,document.body.removeAttribute("data-prev-overflow")}}catch{}return()=>{try{const W=document.body.getAttribute("data-prev-overflow")||"";document.body.style.overflow=W,document.body.removeAttribute("data-prev-overflow")}catch{}}},[n]);const[s,A]=i.useState(""),[O,b]=i.useState(""),[I,N]=i.useState(""),[g,P]=i.useState(null),[k,U]=i.useState(null),[C,L]=i.useState(null),[q,X]=i.useState(null),[z,F]=i.useState(!1),[fe,te]=i.useState(!1),[Pe,ee]=i.useState(""),[V,le]=i.useState(""),[be,ke]=i.useState(null),[ge,Fe]=i.useState([]),[Oe,J]=i.useState([]),[ae,Se]=i.useState(!1),[H,ie]=i.useState(""),[Re,_t]=i.useState(""),[vt,xt]=i.useState(!1),[Be,bt]=i.useState(null),[wt,Ft]=i.useState([]),[Ye,pt]=i.useState(null),[qe,Pt]=i.useState("");i.useEffect(()=>{if(n)try{const W=localStorage.getItem(Lr);if(W){const oe=JSON.parse(W);typeof(oe==null?void 0:oe.openingBase)=="number"&&P(oe.openingBase),typeof(oe==null?void 0:oe.openingAir)=="number"&&U(oe.openingAir),typeof(oe==null?void 0:oe.drawerCash)=="number"&&L(oe.drawerCash)}const ye=localStorage.getItem(Qn);if(ye){const oe=JSON.parse(ye);typeof(oe==null?void 0:oe.openingBase)=="number"&&typeof(oe==null?void 0:oe.openingAir)=="number"&&X({openingBase:oe.openingBase,openingAir:oe.openingAir,drawerCash:oe.drawerCash||0})}}catch{}},[n]),i.useEffect(()=>{(async()=>{try{if(!n||!f)return;const{getDocs:W,query:ye}=await rt(async()=>{const{getDocs:St,query:Dt}=await import("./index-Bp5r4OnK.js").then(Ht=>Ht.bf);return{getDocs:St,query:Dt}},__vite__mapDeps([0,1]),import.meta.url),oe=et(de,"shops",f,"machines"),ht=(await W(ye(oe))).docs.map(St=>({id:St.id,name:String(St.data().name||"ماكينة")}));Ft(ht),!Ye&&ht.length>0&&pt(ht[0].id)}catch(W){console.error("Load machines error:",W)}})()},[n,f]);const E=i.useMemo(()=>(p==null?void 0:p.displayName)||(p==null?void 0:p.name)||(p==null?void 0:p.username)||void 0,[p]),ne=i.useMemo(()=>Oe.reduce((W,ye)=>W+(ye.profit||0),0),[Oe]),Ee=i.useMemo(()=>Oe.reduce((W,ye)=>W+(ye.wholesalePrice||0),0),[Oe]),He=()=>{Oe.length!==0&&(J([]),o({title:"تم حذف الإيصالات",description:"تم مسح كل إيصالات التحويل."}))},jt=()=>{ge.length!==0&&(Fe([]),o({title:"تم حذف الإيصالات",description:"تم مسح كل إيصالات الماكينة."}))},Nt=W=>{Fe(ye=>ye.filter(oe=>oe.id!==W)),o({title:"تم حذف الإيصال",description:"تم إزالة إيصال الماكينة المحدد."})},ts=()=>{P(null),U(null),L(null),X(null),A(""),b(""),N("");try{localStorage.removeItem(Lr),localStorage.removeItem(Qn)}catch{}o({title:"تم التصفير",description:"يمكنك الآن إدخال رصيد افتتاحي جديد."})},$e=async()=>{var it;const W=parseFloat(s||"0"),ye=parseFloat(O||"0"),oe=parseFloat(I||"0");if(isNaN(W)||isNaN(ye)||isNaN(oe)){o({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة للرصيد الافتتاحي وفلوس الدرج.",variant:"destructive"});return}if(W<0||ye<0||oe<0){o({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}P(W),U(ye),L(oe);try{if(localStorage.setItem(Lr,JSON.stringify({openingBase:W,openingAir:ye,drawerCash:oe})),localStorage.setItem(Qn,JSON.stringify({openingBase:W,openingAir:ye,drawerCash:oe})),X({openingBase:W,openingAir:ye,drawerCash:oe}),f&&Ye){const ht=Ge(de,"shops",f,"machines",Ye);await qs(ht,{name:((it=wt.find(St=>St.id===Ye))==null?void 0:it.name)||"ماكينة",openingBase:W,openingAir:ye,drawerCash:oe,cashierName:E,shopName:j||null,updatedAt:ct()},{merge:!0})}}catch{}o({title:"تم تسجيل البيانات",description:`الافتتاحي الأساسي: ${at(W)}، الهواء: ${at(ye)}، فلوس الدرج: ${at(oe)}`})},Me=()=>{if(g==null||k==null){o({title:"سجل الرصيد الافتتاحي أولاً",description:'يرجى الضغط على زر "إضافة" بعد إدخال الافتتاحي.'});return}te(!0)},tt=()=>{const W=parseFloat(Pe||"0"),ye=parseFloat(V||"0");if(isNaN(W)||isNaN(ye)){o({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة لرصيد التسليم.",variant:"destructive"});return}if(W<0||ye<0){o({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}const oe=(q==null?void 0:q.openingBase)??(g||0),it=(q==null?void 0:q.openingAir)??(k||0),ht=oe+it,Dt=W+ye-ht;ke(Dt);const Ht={id:`${Date.now()}`,openingBase:oe,openingAir:it,deliveryBase:W,deliveryAir:ye,netResult:Dt,createdAt:new Date().toISOString(),cashierName:E,requiredDrawerNoProfit:Dt<0?Math.round(-Dt*100)/100:0};(async()=>{try{f&&Ye&&(await xa(et(de,"shops",f,"machines",Ye,"deliveries"),{cashierName:E,openingBase:oe,openingAir:it,deliveryBase:W,deliveryAir:ye,netResult:Dt,createdAt:ct()}),await qs(Ge(de,"shops",f,"machines",Ye),{lastDeliveryAt:ct(),updatedAt:ct()},{merge:!0}))}catch(Ct){console.error("Persist delivery error:",Ct)}})(),Fe(Ct=>[Ht,...Ct]),o({title:"تم إنشاء إيصال تسليم",description:`الناتج النهائي: ${at(Dt)}`})},st=()=>{const W=parseFloat(H||"0"),ye=parseFloat(Re||"0");if(!Number.isFinite(W)||!Number.isFinite(ye)){o({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة لسعر الجملة وسعر التجزئة.",variant:"destructive"});return}if(W<0||ye<0){o({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}if(g==null||k==null){o({title:"سجل الرصيد الافتتاحي أولاً",description:'يرجى إدخال الرصيد الأساسي ورصيد الهواء ثم الضغط "إضافة".'});return}const oe=Math.round((ye-W)*100)/100;bt({wholesalePrice:W,retailPrice:ye,profit:oe}),xt(!0)},Ut=async W=>{if(!Be)return;const ye={id:`transfer_${Date.now()}`,wholesalePrice:Be.wholesalePrice,retailPrice:Be.retailPrice,profit:Be.profit,createdAt:new Date().toISOString(),cashierName:E,deductFrom:W},oe=Be.wholesalePrice,it=g??0,ht=k??0,St=C??0;if(oe>(W==="base"?it:ht)){o({title:"رصيد غير كافٍ",description:"لا يوجد رصيد كافٍ للخصم بسعر الجملة.",variant:"destructive"});return}const Ht=W==="base"?Math.round((it-oe)*100)/100:it,Ct=W==="air"?Math.round((ht-oe)*100)/100:ht,Ns=Math.round((St+Be.retailPrice)*100)/100;P(Ht),U(Ct),L(Ns);try{if(localStorage.setItem(Lr,JSON.stringify({openingBase:Ht,openingAir:Ct,drawerCash:Ns})),f&&Ye){const fs=Ge(de,"shops",f,"machines",Ye);await qs(fs,{openingBase:Ht,openingAir:Ct,drawerCash:Ns,cashierName:E,updatedAt:ct()},{merge:!0}),await xa(et(de,"shops",f,"machines",Ye,"transfers"),{wholesalePrice:Be.wholesalePrice,retailPrice:Be.retailPrice,profit:Be.profit,deductFrom:W,cashierName:E,createdAt:ct()})}}catch{}J(fs=>[ye,...fs]),Se(!1),ie(""),_t(""),bt(null),xt(!1),o({title:"تم تسجيل تحويل",description:`الربح الفوري: ${at(ye.profit)} | خصم المخزون: -${at(oe)} (${W==="base"?"الأساسي":"الهواء"}) | درج: +${at(Be.retailPrice)}`})},It=()=>{A(""),b(""),te(!1),ee(""),le(""),ke(null)},Yt=W=>{W||It(),d(W)};return e.jsxs(me,{open:n,onOpenChange:Yt,children:[e.jsxs(he,{className:"w-[92vw] sm:w-[80vw] sm:max-w-4xl sm:h-[90vh] sm:overflow-hidden",children:[e.jsxs(ue,{className:"space-y-2",children:[e.jsx(xe,{className:"flex items-center justify-between text-right",children:e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(Zl,{className:"h-5 w-5 text-yellow-500"}),"يومية المكنة"]})}),e.jsx(us,{className:"text-right",children:'أدخل الرصيد الافتتاحي، ثم في نهاية اليوم قم بإدخال رصيد التسليم لإنشاء إيصال منظم باسم "إيصالات ماكينة".'})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-6",children:[e.jsxs(nt,{children:[e.jsx($t,{className:"pb-2",children:e.jsx(rs,{className:"flex items-center justify-between",children:e.jsx("span",{className:"text-right",children:"اختيار ماكينة"})})}),e.jsx(dt,{className:"space-y-3",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 items-end",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الماكينة الحالية"}),e.jsxs(Xs,{value:Ye??"",onValueChange:W=>pt(W),children:[e.jsx(ea,{className:"text-right",children:e.jsx(ta,{placeholder:"اختر ماكينة"})}),e.jsx(sa,{children:wt.map(W=>e.jsx(Is,{value:W.id,children:W.name},W.id))})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-2",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"إنشاء ماكينة جديدة"}),e.jsx(R,{value:qe,onChange:W=>Pt(W.target.value),placeholder:"اسم الماكينة",className:"text-right"})]}),e.jsx("div",{className:"flex justify-end md:justify-start",children:e.jsx(m,{onClick:async()=>{try{if(!f){o({title:"لا يوجد محل",description:"يرجى التأكد من تحميل بيانات المحل.",variant:"destructive"});return}const W=(qe||"").trim();if(!W){o({title:"اسم الماكينة مطلوب",description:"أدخل اسم للماكينة الجديدة.",variant:"destructive"});return}const ye=await xa(et(de,"shops",f,"machines"),{name:W,shopId:f,createdAt:ct(),updatedAt:ct(),isActive:!0}),oe={id:ye.id,name:W};Ft(it=>[oe,...it]),pt(ye.id),Pt(""),o({title:"تم إنشاء ماكينة",description:`تمت إضافة ${W}`})}catch(W){console.error("Create machine error:",W),o({title:"خطأ في الإنشاء",description:"تعذر إنشاء الماكينة.",variant:"destructive"})}},className:"bg-violet-600 hover:bg-violet-700",children:"إضافة"})})]})]})})]}),e.jsxs(nt,{children:[e.jsx($t,{className:"pb-2",children:e.jsxs(rs,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-right",children:"الرصيد الافتتاحي"}),e.jsx(m,{variant:"ghost",size:"sm",onClick:()=>F(W=>!W),className:"flex items-center gap-1",children:e.jsx(Qa,{className:`h-4 w-4 transition-transform ${z?"rotate-180":""}`})})]})}),e.jsxs("div",{className:"flex items-center justify-between px-6",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(m,{variant:"outline",onClick:()=>Se(!0),disabled:g==null||k==null,className:"border-violet-300 text-violet-700",children:"تحويل"})}),g!=null&&k!=null&&e.jsxs(Wt,{className:"bg-violet-100 text-violet-700 border border-violet-200",children:["تم التسجيل: أساسي ",at(g)," | هواء ",at(k)," | درج ",at(C??0)]})]}),e.jsxs(dt,{className:`space-y-4 ${z?"":"hidden"}`,children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الرصيد الأساسي"}),e.jsx(R,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:s,onChange:W=>A(W.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"رصيد الهواء"}),e.jsx(R,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:O,onChange:W=>b(W.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"فلوس الدرج"}),e.jsx(R,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:I,onChange:W=>N(W.target.value),placeholder:"0.00",className:"text-right"})]})]}),e.jsxs("div",{className:"flex items-center justify-end",children:[e.jsx(m,{variant:"outline",className:"mr-2",onClick:ts,children:"تصفير"}),e.jsx(m,{onClick:$e,className:"bg-violet-600 hover:bg-violet-700",children:"إضافة"})]})]})]}),e.jsxs(nt,{children:[e.jsx($t,{className:"pb-2",children:e.jsxs(rs,{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-right",children:"إيصالات تحويل"}),e.jsxs(Wt,{className:"bg-green-100 text-green-700 border border-green-200",children:["ربح: ",at(ne)]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(m,{variant:"outline",size:"sm",onClick:He,className:"border-red-300 text-red-700 hover:bg-red-50",children:"حذف الإيصالات"}),e.jsx($r,{className:"h-4 w-4 text-gray-500"})]})]})}),e.jsx(dt,{className:"space-y-3",children:Oe.length===0?e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد تحويلات مسجلة."}):e.jsx("div",{className:"space-y-3 max-h-52 overflow-y-auto pr-1",children:Oe.map(W=>e.jsxs("div",{className:"rounded-lg border p-3 grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"سعر الجملة"}),e.jsx("p",{className:"text-sm",children:at(W.wholesalePrice)})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"سعر التجزئة"}),e.jsx("p",{className:"text-sm",children:at(W.retailPrice)})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"الربح الفوري"}),e.jsx("p",{className:"text-sm text-green-700",children:at(W.profit)}),W.deductFrom&&e.jsx("div",{className:"mt-1",children:e.jsxs("span",{className:"text-[11px] bg-violet-100 text-violet-700 border border-violet-200 rounded px-2 py-0.5",children:["الخصم من: ",W.deductFrom==="base"?"الأساسي":"الهواء"]})}),e.jsxs("div",{className:"flex items-center justify-end gap-2 text-xs text-gray-500",children:[e.jsx(ia,{className:"h-3 w-3"}),e.jsx("span",{children:_l(W.createdAt)}),W.cashierName&&e.jsxs(e.Fragment,{children:[e.jsx(Xn,{orientation:"vertical",className:"h-3"}),e.jsxs("span",{children:["الكاشير: ",W.cashierName]})]})]})]})]},W.id))})})]}),e.jsxs(nt,{children:[e.jsx($t,{className:"pb-2",children:e.jsx(rs,{className:"text-right",children:"نهاية اليوم"})}),e.jsx(dt,{className:"space-y-4",children:fe?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الرصيد الأساسي الحالي"}),e.jsx(R,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:Pe,onChange:W=>ee(W.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"رصيد الهواء الحالي"}),e.jsx(R,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:V,onChange:W=>le(W.target.value),placeholder:"0.00",className:"text-right"})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(m,{variant:"secondary",onClick:()=>te(!1),children:"إلغاء"}),e.jsx(m,{onClick:tt,className:"bg-green-600 hover:bg-green-700",children:"تسليم"})]}),be!=null&&e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{className:"text-right",children:e.jsxs(Wt,{className:be>=0?"bg-green-100 text-green-700 border border-green-200":"bg-red-100 text-red-700 border border-red-200",children:["الناتج النهائي: ",at(be)]})}),e.jsxs("div",{className:"mt-2 flex items-center justify-end gap-2",children:[e.jsxs(Wt,{className:"bg-blue-100 text-blue-700 border border-blue-200",children:["المجموع النهائي: ",at(parseFloat(Pe||"0")+parseFloat(V||"0"))]}),e.jsxs(Wt,{className:"bg-amber-100 text-amber-700 border border-amber-200",children:["مطلوب من الدرج (بدون أرباح): ",at(Ee)]})]})]})]}):e.jsx("div",{className:"flex justify-end",children:e.jsx(m,{variant:"outline",onClick:Me,className:"border-violet-300 text-violet-700",children:"تسليم يومية"})})})]}),e.jsxs(nt,{children:[e.jsx($t,{className:"pb-2",children:e.jsxs(rs,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-right",children:"إيصالات ماكينة"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(m,{variant:"outline",size:"sm",onClick:jt,className:"border-red-300 text-red-700 hover:bg-red-50",children:"حذف الإيصالات"}),e.jsx($r,{className:"h-4 w-4 text-gray-500"})]})]})}),e.jsx(dt,{className:"space-y-3",children:ge.length===0?e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد إيصالات حتى الآن."}):e.jsx("div",{className:"space-y-3",children:ge.map(W=>e.jsxs("div",{className:"rounded-lg border p-3 grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"الافتتاحي"}),e.jsxs("p",{className:"text-sm",children:["أساسي: ",at(W.openingBase)]}),e.jsxs("p",{className:"text-sm",children:["هواء: ",at(W.openingAir)]})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"التسليم"}),e.jsxs("p",{className:"text-sm",children:["أساسي: ",at(W.deliveryBase)]}),e.jsxs("p",{className:"text-sm",children:["هواء: ",at(W.deliveryAir)]})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("div",{className:"flex items-center justify-end",children:e.jsxs(m,{variant:"outline",size:"sm",onClick:()=>Nt(W.id),className:"border-red-300 text-red-700 hover:bg-red-50",children:[e.jsx(Jt,{className:"h-3 w-3 mr-1"})," حذف"]})}),e.jsx("p",{className:"text-xs text-gray-500",children:"النتيجة"}),e.jsx("p",{className:`text-sm ${W.netResult>=0?"text-green-700":"text-red-700"}`,children:at(W.netResult)}),e.jsxs("div",{className:"mt-1 flex items-center justify-end gap-2",children:[e.jsxs("span",{className:"text-[11px] bg-blue-100 text-blue-700 border border-blue-200 rounded px-2 py-0.5",children:["المجموع النهائي: ",at(W.deliveryBase+W.deliveryAir)]}),typeof W.requiredDrawerNoProfit=="number"&&e.jsxs("span",{className:"text-[11px] bg-amber-100 text-amber-700 border border-amber-200 rounded px-2 py-0.5",children:["مطلوب من الدرج (بدون أرباح): ",at(W.requiredDrawerNoProfit||0)]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2 text-xs text-gray-500",children:[e.jsx(ia,{className:"h-3 w-3"}),e.jsx("span",{children:_l(W.createdAt)}),W.cashierName&&e.jsxs(e.Fragment,{children:[e.jsx(Xn,{orientation:"vertical",className:"h-3"}),e.jsxs("span",{children:["الكاشير: ",W.cashierName]})]})]})]})]},W.id))})})]})]}),e.jsxs(ze,{className:"flex items-center justify-between",children:[e.jsx(m,{variant:"outline",onClick:()=>Yt(!1),children:"إغلاق"}),e.jsxs("div",{className:"text-xs text-gray-500 flex items-center gap-1",children:[e.jsx(Js,{className:"h-3 w-3"}),e.jsx("span",{children:"يسجل التاريخ والوقت تلقائياً لكل إيصال"})]})]})]}),e.jsx(me,{open:ae,onOpenChange:Se,children:e.jsxs(he,{className:"sm:max-w-sm",children:[e.jsx(ue,{children:e.jsx(xe,{children:"تحويل رصيد"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"سعر الجملة"}),e.jsx(R,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:H,onChange:W=>ie(W.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"سعر التجزئة"}),e.jsx(R,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:Re,onChange:W=>_t(W.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsx("div",{className:"text-right",children:e.jsxs(Wt,{className:"bg-green-100 text-green-700 border border-green-200",children:["الربح الفوري: ",at(parseFloat(Re||"0")-parseFloat(H||"0")||0)]})})]}),e.jsxs(ze,{className:"flex items-center justify-end gap-2",children:[e.jsx(m,{variant:"secondary",onClick:()=>Se(!1),children:"إلغاء"}),e.jsx(m,{onClick:st,className:"bg-violet-600 hover:bg-violet-700",children:"تحويل"})]})]})}),e.jsx(Wm,{open:vt,onOpenChange:xt,children:e.jsxs(vo,{children:[e.jsxs(bo,{children:[e.jsx(wo,{children:"اختيار مصدر الخصم"}),e.jsx(jo,{children:"هل يتم الخصم من الرصيد الأساسي أم من رصيد الهواء؟"})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2 mt-4",children:[e.jsx(No,{onClick:()=>xt(!1),children:"رجوع"}),e.jsx(ti,{onClick:()=>Ut("base"),children:"خصم من الأساسي"}),e.jsx(ti,{onClick:()=>Ut("air"),children:"خصم من الهواء"})]})]})})]})}function Mm(n,d=300){const[o,p]=_e.useState(n);return _e.useEffect(()=>{const f=setTimeout(()=>p(n),d);return()=>clearTimeout(f)},[n,d]),o}const Lm=({userId:n,transactions:d})=>{const[o,p]=i.useState(!1),[f,j]=i.useState(!1),[s,A]=i.useState(!1),[O,b]=i.useState({monthlyWithdrawalProfit:0,monthlyTransferProfit:0,lastUpdated:new Date}),{userSubscription:I}=_s();i.useEffect(()=>{n&&o&&s&&N()},[n,o,s]);const N=async()=>{if(n)try{if(Array.isArray(d)&&d.length>0){const L=new Date,q=L.getMonth(),X=L.getFullYear(),z=Qt.filterVisibleTransactions(d,"monthly",n);let F=0,fe=0;z.forEach(te=>{const Pe=new Date(te.createdAt),ee=String(te.status||"confirmed").toLowerCase();if(Pe.getMonth()!==q||Pe.getFullYear()!==X||ee!=="completed"&&ee!=="confirmed")return;const V=(te.type||te.txnType||"").toLowerCase(),le={type:V==="withdrawal"?"withdraw":V,amount:Number(te.amount||0),commission:te.commission};le.type==="withdraw"?F+=aa.calculateProfitFromTransaction(le):(le.type==="send"||le.type==="receive"||le.type==="transfer")&&(fe+=aa.calculateProfitFromTransaction(le))}),b({monthlyWithdrawalProfit:Math.round(F*100)/100,monthlyTransferProfit:Math.round(fe*100)/100,lastUpdated:new Date});return}const C=aa.getWithdrawTransferProfits(n);b({monthlyWithdrawalProfit:C.monthlyWithdrawProfit||0,monthlyTransferProfit:C.monthlyTransferProfit||0,lastUpdated:new Date})}catch(C){console.error("Error loading profit data:",C)}},g=C=>`${C.toFixed(2)} ج.م`,P=async()=>{try{const C=(I==null?void 0:I.subscription)||null,L=(C==null?void 0:C.planType)??(C==null?void 0:C.plan)??null,q=typeof L=="string"?L.toLowerCase():null;if(L===Os.ZERO||q==="zero"||q==="0"||L===0)return!0}catch{}try{if(n){const C=await si(n),L=(C==null?void 0:C.planType)??(C==null?void 0:C.plan)??null,q=typeof L=="string"?L.toLowerCase():null;if(L===Os.ZERO||q==="zero"||q==="0"||L===0)return!0}}catch{}return!1},k=async()=>{try{if(await P()){Nl({title:"الخطة زيرو",description:"عرض الأرباح الشهرية غير متاح في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}catch{}j(!0)},U=async()=>{try{if(await P()){Nl({title:"الخطة زيرو",description:"عرض الأرباح الشهرية غير متاح في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"}),j(!1);return}}catch{}A(!0),p(!0),j(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(m,{size:"sm",variant:"ghost",onClick:k,className:"h-2 w-2 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded transition-all duration-300 hover:scale-110 shadow-sm hover:shadow-md",title:"عرض الأرباح الشهرية",children:e.jsx(mt,{className:"h-1.5 w-1.5"})}),e.jsx(me,{open:o,onOpenChange:p,children:e.jsxs(he,{className:"max-w-[220px] mx-auto bg-white border border-gray-200 shadow-md rounded sm:max-w-[180px] sm:bg-gradient-to-br sm:from-purple-50 sm:to-white sm:border-2 sm:border-purple-200 sm:shadow-2xl sm:rounded-2xl",children:[e.jsx(ue,{className:"text-center pb-0 border-b-0 sm:pb-2 sm:border-b sm:border-purple-200",children:e.jsxs(xe,{className:"text-xs font-bold text-purple-800 flex items-center justify-center gap-0 mb-0 leading-tight tracking-tight sm:text-xs sm:gap-1 sm:mb-0 sm:leading-normal sm:tracking-normal",children:[e.jsx(ia,{className:"h-2 w-2 text-purple-600 sm:h-3 sm:w-3"}),"شهري"]})}),e.jsx("div",{className:"py-0 sm:py-3",children:e.jsxs("div",{className:"rounded-xl border border-purple-300 bg-white overflow-hidden",children:[e.jsx("div",{className:"p-2 sm:p-3 bg-red-50 border-b border-purple-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Vr,{className:"h-3 w-3 text-red-600"}),e.jsx("span",{className:"font-medium text-red-800 text-xs",children:"سحب"})]}),e.jsx("span",{className:"font-bold text-sm text-red-900 bg-white px-2 py-0.5 rounded",children:g(O.monthlyWithdrawalProfit)})]})}),e.jsx("div",{className:"p-2 sm:p-3 bg-blue-50 border-b border-purple-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ai,{className:"h-3 w-3 text-blue-600"}),e.jsx("span",{className:"font-medium text-blue-800 text-xs",children:"تحويل"})]}),e.jsx("span",{className:"font-bold text-sm text-blue-900 bg-white px-2 py-0.5 rounded",children:g(O.monthlyTransferProfit)})]})}),e.jsx("div",{className:"p-2 sm:p-3 bg-purple-50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(yt,{className:"h-3 w-3 text-purple-600"}),e.jsx("span",{className:"font-medium text-purple-800 text-xs",children:"إجمالي"})]}),e.jsx("span",{className:"font-bold text-sm text-purple-900 bg-white px-2 py-0.5 rounded",children:g(O.monthlyWithdrawalProfit+O.monthlyTransferProfit)})]})})]})}),!s&&e.jsx("div",{className:"absolute inset-0 bg-yellow-200/70 backdrop-blur-sm flex items-center justify-center rounded sm:rounded-2xl border border-yellow-300 pointer-events-auto",children:e.jsx(m,{size:"sm",variant:"ghost",onClick:()=>j(!0),className:"p-2 bg-yellow-300/80 text-yellow-900 hover:bg-yellow-400/90 rounded-full shadow-sm hover:shadow-md transition-all duration-300",title:"إدخال الرقم السري الرئيسي",children:e.jsx(mt,{className:"h-4 w-4"})})}),e.jsx("div",{className:"flex justify-center pt-0 border-t-0 sm:pt-2 sm:border-t sm:border-purple-200",children:e.jsx(m,{onClick:()=>p(!1),className:"bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-xl text-sm sm:bg-gradient-to-r sm:from-purple-600 sm:to-purple-700 sm:hover:from-purple-700 sm:hover:to-purple-800 sm:px-4 sm:py-1 sm:rounded-xl sm:shadow-lg sm:hover:shadow-xl sm:transition-all sm:duration-300",children:"إغلاق"})})]})}),e.jsx(xs,{open:f,onOpenChange:j,onSuccess:U,description:"لا يمكن الاطلاع على الأرباح الشهرية إلا بإدخال الرقم السري الرئيسي"})]})},Rm=n=>e.jsx(Lm,{...n});function Bm({open:n,onOpenChange:d,onSuccess:o,userId:p}){const[f,j]=i.useState(""),[s,A]=i.useState(""),[O,b]=i.useState(!1),[I,N]=i.useState(!1),[g,P]=i.useState(""),[k,U]=i.useState(!1),[C,L]=i.useState(!1),{toast:q}=gs();i.useEffect(()=>{let F=!0;return(async()=>{const fe=await Xt.hasMasterPin(p);F&&L(fe)})(),()=>{F=!1}},[p,n]);const X=()=>{j(""),A(""),P(""),b(!1),N(!1),d(!1)},z=async F=>{F.preventDefault(),P(""),U(!0);try{if(C){if(!await Xt.verifyMasterPin(f,p)){P("الرقم السري غير صحيح"),U(!1);return}}else{if(f.length<4){P("يجب أن يكون الرقم السري 4 أرقام على الأقل"),U(!1);return}if(f!==s){P("الرقم السري غير متطابق"),U(!1);return}if(!await Xt.createMasterPin(f,p)){P("تعذر إنشاء الرقم السري الرئيسي"),U(!1);return}}q({title:"نجح العملية",description:C?"تم التحقق من الرقم السري الرئيسي بنجاح":"تم إنشاء الرقم السري الرئيسي بنجاح"}),o(),X()}catch{P("حدث خطأ أثناء معالجة الرقم السري")}finally{U(!1)}};return e.jsx(me,{open:n,onOpenChange:d,children:e.jsxs(he,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ue,{children:e.jsxs(xe,{className:"flex items-center gap-2 text-lg font-semibold",children:[e.jsx(pa,{className:"h-5 w-5 text-green-600"}),C?"أدخل الرقم السري الرئيسي":"إنشاء الرقم السري الرئيسي"]})}),e.jsxs("form",{onSubmit:z,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-gray-600 bg-blue-50 p-3 rounded-lg",children:C?"أدخل الرقم السري الرئيسي لعرض بيانات الأرباح":"قم بإنشاء الرقم السري الرئيسي لحماية بيانات الأرباح. يمكنك تغييره لاحقاً من إعدادات البروفيل."}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"pin",children:C?"الرقم السري الرئيسي":"الرقم السري الرئيسي الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"pin",type:O?"text":"password",value:f,onChange:F=>j(F.target.value),placeholder:C?"أدخل الرقم السري":"أدخل رقم سري جديد (4 أرقام على الأقل)",className:"pr-10",dir:"ltr",autoComplete:"off",required:!0}),e.jsx(m,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>b(!O),children:O?e.jsx(Kt,{className:"h-4 w-4"}):e.jsx(mt,{className:"h-4 w-4"})})]})]}),!C&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"confirmPin",children:"تأكيد الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"confirmPin",type:I?"text":"password",value:s,onChange:F=>A(F.target.value),placeholder:"أعد إدخال الرقم السري",className:"pr-10",dir:"ltr",autoComplete:"off",required:!0}),e.jsx(m,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>N(!I),children:I?e.jsx(Kt,{className:"h-4 w-4"}):e.jsx(mt,{className:"h-4 w-4"})})]})]}),g&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(fa,{className:"h-4 w-4"}),g]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(m,{type:"submit",disabled:k,className:"flex-1 bg-green-600 hover:bg-green-700",children:[e.jsx(pa,{className:"h-4 w-4 mr-2"}),k?"جاري المعالجة...":C?"عرض الأرباح":"إنشاء وعرض الأرباح"]}),e.jsx(m,{type:"button",variant:"outline",onClick:X,disabled:k,children:"إلغاء"})]})]})]})})}const $m=({userId:n,transactions:d})=>{const[o,p]=i.useState(!1),[f,j]=i.useState(!1),[s,A]=i.useState(!1),[O,b]=i.useState({dailyWithdrawalProfit:0,dailyTransferProfit:0,lastUpdated:new Date});i.useEffect(()=>{n&&o&&s&&I()},[n,o,s]);const I=async()=>{if(n)try{if(Array.isArray(d)&&d.length>0){const U=new Date,C=Qt.filterVisibleTransactions(d,"daily",n);let L=0,q=0;C.forEach(X=>{const z=new Date(X.createdAt),F=String(X.status||"confirmed").toLowerCase();if(z.toDateString()!==U.toDateString()||F!=="completed"&&F!=="confirmed")return;const fe=(X.type||X.txnType||"").toLowerCase(),te={type:fe==="withdrawal"?"withdraw":fe,amount:Number(X.amount||0),commission:X.commission};te.type==="withdraw"?L+=aa.calculateProfitFromTransaction(te):(te.type==="send"||te.type==="receive"||te.type==="transfer")&&(q+=aa.calculateProfitFromTransaction(te))}),b({dailyWithdrawalProfit:Math.round(L*100)/100,dailyTransferProfit:Math.round(q*100)/100,lastUpdated:new Date});try{aa.updateProfitsFromTransactions(d,n)}catch{}return}const k=aa.getWithdrawTransferProfits(n);b({dailyWithdrawalProfit:k.dailyWithdrawProfit||0,dailyTransferProfit:k.dailyTransferProfit||0,lastUpdated:new Date})}catch(k){console.error("Error loading profit data:",k)}},N=k=>`${k.toFixed(2)} ج.م`,g=()=>{aa.hasProfitPin(n),j(!0)},P=()=>{A(!0),p(!0),j(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(m,{size:"sm",variant:"ghost",onClick:g,className:"h-2 w-2 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded transition-all duration-300 hover:scale-110 shadow-sm hover:shadow-md",title:"عرض الأرباح اليومية",children:e.jsx(mt,{className:"h-1.5 w-1.5"})}),e.jsx(me,{open:o,onOpenChange:p,children:e.jsxs(he,{className:"max-w-[220px] mx-auto bg-white border border-gray-200 shadow-md rounded sm:max-w-[180px] sm:bg-gradient-to-br sm:from-blue-50 sm:to-white sm:border-2 sm:border-blue-200 sm:shadow-2xl sm:rounded-2xl",children:[e.jsx(ue,{className:"text-center pb-0 border-b-0 sm:pb-2 sm:border-b sm:border-blue-200",children:e.jsxs(xe,{className:"text-xs font-bold text-blue-800 flex items-center justify-center gap-0 mb-0 leading-tight tracking-tight sm:text-sm sm:gap-1 sm:mb-0 sm:leading-normal sm:tracking-normal",children:[e.jsx(yt,{className:"h-2 w-2 text-blue-600 sm:h-3 sm:w-3"}),"يومي"]})}),e.jsx("div",{className:"py-0 sm:py-3",children:e.jsxs("div",{className:"rounded-xl border border-blue-300 bg-white overflow-hidden",children:[e.jsx("div",{className:"p-2 sm:p-3 bg-red-50 border-b border-blue-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Vr,{className:"h-3 w-3 text-red-600"}),e.jsx("span",{className:"font-medium text-red-800 text-xs",children:"سحب"})]}),e.jsx("span",{className:"font-bold text-sm text-red-900 bg-white px-2 py-0.5 rounded",children:N(O.dailyWithdrawalProfit)})]})}),e.jsx("div",{className:"p-2 sm:p-3 bg-green-50 border-b border-blue-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ai,{className:"h-3 w-3 text-green-600"}),e.jsx("span",{className:"font-medium text-green-800 text-xs",children:"تحويل"})]}),e.jsx("span",{className:"font-bold text-sm text-green-900 bg-white px-2 py-0.5 rounded",children:N(O.dailyTransferProfit)})]})}),e.jsx("div",{className:"p-2 sm:p-3 bg-blue-50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(yt,{className:"h-3 w-3 text-blue-600"}),e.jsx("span",{className:"font-medium text-blue-800 text-xs",children:"إجمالي"})]}),e.jsx("span",{className:"font-bold text-sm text-blue-900 bg-white px-2 py-0.5 rounded",children:N(O.dailyWithdrawalProfit+O.dailyTransferProfit)})]})})]})}),e.jsx("div",{className:"flex justify-center pt-0 border-t-0 sm:pt-2 sm:border-t sm:border-blue-200",children:e.jsx(m,{onClick:()=>p(!1),className:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-xl text-sm sm:bg-gradient-to-r sm:from-blue-600 sm:to-blue-700 sm:hover:from-blue-700 sm:hover:to-blue-800 sm:px-4 sm:py-1 sm:rounded-xl sm:shadow-lg sm:hover:shadow-xl sm:transition-all sm:duration-300 sm:text-xs",children:"إغلاق"})})]})}),e.jsx(Bm,{open:f,onOpenChange:j,onSuccess:P,userId:n})]})},Um=n=>e.jsx($m,{...n}),Rr=n=>Number(n||0).toFixed(2),zm=({open:n,onOpenChange:d,userId:o})=>{const{toast:p}=gs(),[f,j]=_e.useState([]),[s,A]=_e.useState(!1),[O,b]=_e.useState("");_e.useEffect(()=>{(async()=>{if(!(!n||!o))try{A(!0);const P=[...await zl.getByUser(o)].sort((k,U)=>k.reportDate<U.reportDate?1:-1);j(P)}catch(g){console.error("Failed to load daily archive history:",g),p({title:"فشل تحميل الأرشيف",description:"تعذر تحميل أرشيف التقارير اليومية",variant:"destructive"})}finally{A(!1)}})()},[n,o]);const I=_e.useMemo(()=>{if(!O)return f;const N=O.trim();return f.filter(g=>g.reportDate.includes(N))},[f,O]);return e.jsx(me,{open:n,onOpenChange:d,children:e.jsxs(he,{className:"sm:max-w-xl",children:[e.jsxs(ue,{children:[e.jsx(xe,{children:"أرشيف التقارير اليومية"}),e.jsx(us,{children:"يعرض جميع الأيام المؤرشفة مع ملخص لكل يوم."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"archive-search",children:"بحث بالتاريخ (YYYY-MM-DD)"}),e.jsx(R,{id:"archive-search",placeholder:"مثال: 2025-10-19",value:O,onChange:N=>b(N.target.value)})]}),e.jsx("div",{className:"mt-3 space-y-2 max-h-[50vh] overflow-auto",children:s?e.jsx("div",{className:"text-sm text-muted-foreground",children:"جاري التحميل..."}):I.length===0?e.jsx("div",{className:"text-sm text-muted-foreground",children:"لا توجد تقارير مؤرشفة حتى الآن"}):I.map(N=>e.jsxs("div",{className:"border rounded-md p-2 bg-gradient-to-r from-white/80 to-blue-50/70",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{className:"font-bold text-blue-800",children:N.reportDate}),e.jsxs("div",{className:"text-xs text-blue-700",children:["عدد المعاملات: ",N.totalTransactions]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-1",children:[e.jsxs("div",{className:"text-xs text-blue-800",children:["إجمالي المبالغ: ",e.jsx("span",{className:"font-semibold",children:Rr(N.totalAmount)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["المسحوب: ",e.jsx("span",{className:"font-semibold",children:Rr(N.totalWithdrawn)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["المرسل: ",e.jsx("span",{className:"font-semibold",children:Rr(N.totalSent)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["الربح: ",e.jsx("span",{className:"font-semibold",children:Rr(N.profit)})]})]})]},N.id||`${N.userId}-${N.reportDate}`))}),e.jsx(ze,{children:e.jsx(m,{variant:"outline",onClick:()=>d(!1),children:"إغلاق"})})]})})},qm=({open:n,onOpenChange:d})=>{var we;const{shiftUser:o,isShiftActive:p,shiftStartAt:f,setShiftUser:j,startShift:s,endShift:A}=tr(),{userSubscription:O,user:b,signIn:I,profile:N}=_s(),{toast:g}=gs(),[P,k]=i.useState((o==null?void 0:o.name)||""),[U,C]=i.useState((o==null?void 0:o.username)||""),[L,q]=i.useState(""),[X,z]=i.useState(!1),[F,fe]=i.useState(null),[te,Pe]=i.useState(""),[ee,V]=i.useState(""),[le,be]=i.useState(!1),[ke,ge]=i.useState(null),[Fe,Oe]=i.useState(""),[J,ae]=i.useState(""),[Se,H]=i.useState(!1),[ie,Re]=i.useState(!1),[_t,vt]=i.useState({totalTransfers:0,totalWithdrawals:0}),[xt,Be]=i.useState(null),[bt,wt]=i.useState(""),[Ft,Ye]=i.useState(""),[pt,qe]=i.useState(0),[Pt,E]=i.useState({}),[ne,Ee]=i.useState(0),[He,jt]=i.useState(0),[Nt,ts]=i.useState({}),[$e,Me]=i.useState(""),[tt,st]=i.useState(!1),Ut=()=>`cashierUsers_${(b==null?void 0:b.uid)||"default"}`,[It,Yt]=i.useState(()=>{try{let S=localStorage.getItem(Ut());if(!S){const B=localStorage.getItem("cashierUsers");B&&(S=B)}return S?JSON.parse(S):[]}catch{return[]}});i.useEffect(()=>{(async()=>{try{if(!(b!=null&&b.uid))return;const S=Ge(de,"profiles",b.uid,"cashierUsers","list"),B=await ra(S);if(B.exists()){const se=B.data(),pe=Array.isArray(se==null?void 0:se.users)?se.users:[];pe&&pe.length>0&&Yt(pe)}}catch{}})()},[b==null?void 0:b.uid]),i.useEffect(()=>{if(!(b!=null&&b.uid))return;const S=Ge(de,"profiles",b.uid,"cashierUsers","list"),B=ua(S,se=>{try{if(se.exists()){const pe=se.data(),Ue=Array.isArray(pe==null?void 0:pe.users)?pe.users:[];if(Ue&&Ue.length>0)Yt(Ue);else try{const Ve=localStorage.getItem(Ut()),Ie=Ve?JSON.parse(Ve):[];Yt(Ie)}catch{Yt([])}}}catch{}},se=>{console.warn("cashierUsers realtime subscription error:",se)});return()=>B()},[b==null?void 0:b.uid]);const W=(we=O==null?void 0:O.subscription)==null?void 0:we.planType,ye=W==="yearly"?2:W==="lifetime"?4:Number.POSITIVE_INFINITY;i.useEffect(()=>{try{localStorage.setItem(Ut(),JSON.stringify(It));try{localStorage.removeItem("cashierUsers")}catch{}}catch{}(async()=>{try{if(!(b!=null&&b.uid))return;const S=Ge(de,"profiles",b.uid,"cashierUsers","list");await qs(S,{users:It},{merge:!0})}catch{}})()},[It]);const[oe,it]=i.useState(!1),[ht,St]=i.useState(""),[Dt,Ht]=i.useState(null),[Ct,Ns]=i.useState([]),[fs,Ss]=i.useState(!1),[Je,Fs]=i.useState(null),[zt,Ps]=i.useState(!1),[gt,ys]=i.useState(!1),u=S=>{const B=(o==null?void 0:o.username)===S;let se=!1;try{se=localStorage.getItem("lastHandoverToAdmin")==="true"}catch{}if(B&&!(B&&!p&&($e==="الأدمن الرئيسي"||se))){g({title:"لا يمكن الحذف",description:"لا يمكنك حذف مستخدم الوردية أثناء كونها نشطة أو قبل تسليمها للأدمن الرئيسي"});return}const Ve=`هل أنت متأكد من حذف المستخدم ${S}؟

هذا الإجراء لا يمكن التراجع عنه.`;window.confirm(Ve)&&(Yt(Ie=>Ie.filter(ut=>ut.username!==S)),B&&j(null),g({title:"تم حذف المستخدم",description:S}))},_=()=>{if(!P.trim()||!U.trim()||!L.trim())return;if(It.length>=ye){g({title:"وصلت الحد الأقصى للمستخدمين",description:`هذه الباقة تسمح بإضافة ${Number.isFinite(ye)?ye:"عدد غير محدود"} كاشير فقط`,variant:"destructive"});return}const S={name:P.trim(),username:U.trim(),password:L.trim()};Yt(B=>[S,...B]),k(""),C(""),q("")},M=()=>{z(!0),fe(null),ge(null),Oe(""),ae("")},Y=async()=>{try{let S=[];try{b!=null&&b.uid&&(S=await Ce.getUserTransactions(b.uid))}catch{}if(!S||S.length===0)try{const je=await nm({merchantUserId:b==null?void 0:b.uid,limit:200});S=(je==null?void 0:je.transactions)||[]}catch{}const B=f?new Date(f):null,se=new Date,pe=je=>{const lt=je.type,as=je.txnType;return lt==="withdraw"||lt==="withdrawal"||lt==="receive"||as==="receive"},Ue=je=>{const lt=je.type,as=je.txnType;return lt==="send"||lt==="transfer"||as==="send"},Ve=je=>{if(!je)return null;if(je instanceof Date)return je;try{const lt=new Date(je);return Number.isNaN(lt.getTime())?null:lt}catch{return null}},Ie=je=>{const lt=Ve(je.createdAt||je.created_at||je.timestamp);return!lt||B&&lt<B?!1:lt<=se},ut=je=>je==="completed"||je==="confirmed",ss=S.filter(je=>ut(je.status)&&Ie(je)),Mt=ss.filter(je=>pe(je)).reduce((je,lt)=>{const as=lt.withdrawnAmount??lt.receivedAmount??lt.amount??0;return je+(Number(as)||0)},0);return{totalTransfers:ss.filter(je=>Ue(je)).reduce((je,lt)=>{const as=lt.sentAmount??lt.transferredAmount??lt.amount??0;return je+(Number(as)||0)},0),totalWithdrawals:Mt}}catch{return{totalTransfers:0,totalWithdrawals:0}}};i.useEffect(()=>{if(ie){try{const S=localStorage.getItem("shiftInitialReceivedDrawerFunds");S!==null&&Ye(S)}catch{}try{const S=localStorage.getItem("shiftInitialReceivedWalletBalancesTotal");if(S!==null){const B=parseFloat(S);qe(Number.isFinite(B)?B:0)}}catch{}}},[ie]),i.useEffect(()=>{if(!n&&!fs)return;(async()=>{try{const se=((b!=null&&b.uid?await Ce.getUserTransactions(b.uid):[])||[]).filter(pe=>(pe==null?void 0:pe.type)==="report"||((pe==null?void 0:pe.title)||"").includes("إيصال تسليم وردية"));se.sort((pe,Ue)=>{const Ve=new Date(pe.createdAt||0).getTime();return new Date(Ue.createdAt||0).getTime()-Ve}),Ns(se)}catch{Ns([])}})()},[n,ie,fs,b==null?void 0:b.uid]);const Q=async(S,B,se)=>{try{let pe=0,Ue=0;try{const Ie=parseFloat(localStorage.getItem("shiftInitialReceivedDrawerFunds")||"0");pe=Number.isFinite(Ie)?Ie:0}catch{}try{const Ie=parseFloat(localStorage.getItem("shiftInitialReceivedWalletBalancesTotal")||"0");Ue=Number.isFinite(Ie)?Ie:0}catch{}const Ve={id:`shift_receipt_${Date.now()}`,type:"report",senderPhone:(o==null?void 0:o.username)||"cashier",receiverPhone:$e||"admin",amount:0,status:"completed",createdAt:new Date().toISOString(),title:"إيصال تسليم وردية",cashierName:(o==null?void 0:o.name)||(o==null?void 0:o.username)||null,deficit:B,deficitAmount:B?se:0,shiftStartAt:f,receivedDrawerFunds:pe,receivedWalletBalancesTotal:Ue,receivedWalletBalances:Pt,deliveredDrawerFunds:ne||0,deliveredWalletBalancesTotal:He||0,deliveredWalletBalances:Nt,shiftProfit:Math.round(((ne||0)+(He||0)-(pe+Ue))*100)/100};b!=null&&b.uid&&await Ce.saveUserTransaction(b.uid,Ve),Ns(Ie=>[Ve,...Ie||[]])}catch{}};return e.jsxs(e.Fragment,{children:[e.jsx(me,{open:n,onOpenChange:d,children:e.jsxs(he,{className:"sm:max-w-md",children:[e.jsx(ue,{children:e.jsx(xe,{children:p?"تسليم الورديه والخروج":"إضافة مستخدم وردية"})}),p?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsx("div",{className:"text-sm",children:"المستخدم الحالي للوردية:"}),e.jsxs("div",{className:"font-semibold text-sm",children:[o==null?void 0:o.name," (",o==null?void 0:o.username,")"]})]}),e.jsx("div",{className:"text-xs text-gray-600",children:'لإنهاء الوردية والخروج، اضغط "تسليم الورديه والخروج" وسيُطلب الرقم السري.'})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-xs text-gray-600",children:'لاستكمال إضافة مستخدم جديد اضغط الزر أسفل "إضافة مستخدم جديد" لفتح النموذج.'}),It.length>0&&e.jsxs("div",{className:"mt-4 border-t pt-3",children:[e.jsx("div",{className:"text-sm font-medium mb-2",children:"المستخدمون المسجلون"}),e.jsx("div",{className:"space-y-2 max-h-48 overflow-auto",children:It.map((S,B)=>e.jsxs("div",{className:"flex items-center justify-between rounded border px-3 py-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:S.name}),e.jsx("div",{className:"text-xs text-gray-500",children:S.username})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(m,{size:"sm",className:"w-full sm:w-auto",onClick:()=>{Ht(S),it(!0)},children:"دخول"}),e.jsx(m,{size:"sm",className:"w-full sm:w-auto",variant:"destructive",onClick:()=>u(S.username),children:"حذف"})]})]},B))})]})]}),e.jsx(ze,{className:"flex flex-wrap gap-2 justify-between",children:p?e.jsx("div",{className:"flex flex-wrap gap-2",children:e.jsx(m,{className:"w-full sm:w-auto",variant:"destructive",onClick:M,children:"تسليم الورديه والخروج"})}):e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(m,{className:"w-full sm:w-auto",onClick:()=>ys(!0),children:"إضافة مستخدم جديد"}),e.jsx(m,{className:"w-full sm:w-auto",variant:"outline",onClick:()=>Ss(!0),children:"إيصالات التسليم"})]})})]})}),e.jsx(me,{open:gt,onOpenChange:ys,children:e.jsxs(he,{className:"sm:max-w-md",children:[e.jsx(ue,{children:e.jsx(xe,{children:"إضافة مستخدم جديد"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(Z,{className:"mb-1 block",children:"الاسم"}),e.jsx(R,{value:P,onChange:S=>k(S.target.value),placeholder:"أدخل الاسم"})]}),e.jsxs("div",{children:[e.jsx(Z,{className:"mb-1 block",children:"اسم المستخدم"}),e.jsx(R,{value:U,onChange:S=>C(S.target.value),placeholder:"أدخل اسم المستخدم"})]}),e.jsxs("div",{children:[e.jsx(Z,{className:"mb-1 block",children:"الرقم السري"}),e.jsx(R,{type:"password",autoComplete:"new-password",value:L,onChange:S=>q(S.target.value),placeholder:"أدخل الرقم السري"})]}),e.jsx("div",{className:"text-xs text-gray-500",children:"المستخدم يمكنه: التحويل، السحب، اختيار المحفظة فقط."})]}),e.jsxs(ze,{className:"flex gap-2 justify-between",children:[e.jsx(m,{variant:"secondary",onClick:()=>{ys(!1)},children:"إلغاء"}),e.jsx(m,{onClick:()=>{!P.trim()||!U.trim()||!L.trim()||(_(),ys(!1))},children:"حفظ المستخدم"})]})]})}),e.jsx(me,{open:fs,onOpenChange:Ss,children:e.jsxs(he,{className:"sm:max-w-lg",children:[e.jsx(ue,{children:e.jsx(xe,{children:"إيصالات التسليم"})}),Ct.length===0?e.jsx("div",{className:"text-xs text-gray-600",children:"لا توجد إيصالات تسليم محفوظة بعد."}):e.jsx("div",{className:"space-y-2 max-h-[60vh] overflow-auto",children:Ct.map(S=>e.jsxs("div",{className:"rounded border px-3 py-2 cursor-pointer hover:bg-gray-50",onClick:()=>{Fs(S),Ps(!0)},children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm font-semibold",children:new Date(S.createdAt).toLocaleString("ar-EG")}),e.jsxs("div",{className:"text-xs text-gray-500",children:["إلى: ",S.receiverPhone]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-1",children:[e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مسلّمة: ",S.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مسلّمة (إجمالي): ",S.deliveredWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مستلمة: ",S.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مستلمة (إجمالي): ",S.receivedWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مسلّمة: ",S.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مسلّمة (إجمالي): ",S.deliveredWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مستلمة: ",S.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مستلمة (إجمالي): ",S.receivedWalletBalancesTotal??0]}),e.jsxs("div",{className:["text-xs",(S.shiftProfit??(S.deliveredDrawerFunds??0)+(S.deliveredWalletBalancesTotal??0)-(S.receivedDrawerFunds??0)-(S.receivedWalletBalancesTotal??0))>=0?"text-green-700":"text-red-700"].join(" "),children:["أرباح الوردية: ",S.shiftProfit??(S.deliveredDrawerFunds??0)+(S.deliveredWalletBalancesTotal??0)-(S.receivedDrawerFunds??0)-(S.receivedWalletBalancesTotal??0)]})]}),S.deficit&&e.jsxs("div",{className:"text-xs text-red-600 mt-1",children:["عجز: ",S.deficitAmount??0]})]},S.id))}),e.jsx(ze,{className:"flex gap-2 justify-between",children:e.jsx(m,{variant:"secondary",onClick:()=>Ss(!1),children:"إغلاق"})})]})}),e.jsx(me,{open:zt,onOpenChange:Ps,children:e.jsxs(he,{className:"sm:max-w-md",children:[e.jsx(ue,{children:e.jsx(xe,{children:"إيصال تسليم وردية"})}),Je?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsxs("div",{className:"text-sm",children:["التاريخ: ",new Date(Je.createdAt).toLocaleString("ar-EG")]}),e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["تم التسليم إلى: ",Je.receiverPhone]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"المستلم عند الدخول"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية: ",Je.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["أرصدة المحافظ (إجمالي): ",Je.receivedWalletBalancesTotal??0]})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"المسلّم عند الخروج"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية: ",Je.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["أرصدة المحافظ (إجمالي): ",Je.deliveredWalletBalancesTotal??0]})]})]}),Je.deficit&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2 text-red-600",children:"عجز"}),e.jsxs("div",{className:"text-xs text-red-600",children:["المبلغ: ",Je.deficitAmount??0]})]}),Je.receivedWalletBalances&&Object.keys(Je.receivedWalletBalances).length>0&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"تفصيل المحافظ المستلمة"}),e.jsx("div",{className:"space-y-1",children:Object.entries(Je.receivedWalletBalances).map(([S,B])=>e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-gray-600",children:S}),e.jsx("span",{className:"font-semibold",children:B})]},S))})]}),Je.deliveredWalletBalances&&Object.keys(Je.deliveredWalletBalances).length>0&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"تفصيل المحافظ المسلّمة"}),e.jsx("div",{className:"space-y-1",children:Object.entries(Je.deliveredWalletBalances).map(([S,B])=>e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-gray-600",children:S}),e.jsx("span",{className:"font-semibold",children:B})]},S))})]})]}):e.jsx("div",{className:"text-xs text-gray-600",children:"لا يوجد تقرير محدد للعرض."}),e.jsx(ze,{className:"flex gap-2 justify-between",children:e.jsx(m,{variant:"secondary",onClick:()=>Ps(!1),children:"إغلاق"})})]})}),e.jsx(me,{open:oe,onOpenChange:it,children:e.jsxs(he,{className:"sm:max-w-md",children:[e.jsx(ue,{children:e.jsx(xe,{children:"أدخل الرقم السري للدخول"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm",children:Dt?`${Dt.name} (${Dt.username})`:""}),e.jsx(R,{type:"password",autoComplete:"off",value:ht,onChange:S=>St(S.target.value),placeholder:"أدخل الرقم السري"})]}),e.jsxs(ze,{className:"flex gap-2 justify-between",children:[e.jsx(m,{variant:"secondary",onClick:()=>{St(""),Ht(null),it(!1)},children:"إلغاء"}),e.jsx(m,{onClick:()=>{if(Dt){if(ht.trim()!==Dt.password){g({title:"خطأ في الرقم السري",description:"الرقم السري للكاشير غير صحيح",variant:"destructive"});return}j({name:Dt.name,username:Dt.username}),St(""),it(!1),d(!1),s(),st(!0)}},children:"دخول الورديه"})]})]})}),e.jsx(me,{open:tt,onOpenChange:st,children:e.jsxs(he,{className:"sm:max-w-md",children:[e.jsx(ue,{children:e.jsx(xe,{children:"تسجيل أرصدة البداية والنقدية"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(Z,{className:"mb-1 block",children:"الفلوس النقدية المستلمة عند الدخول"}),e.jsx(R,{type:"number",value:Ft,onChange:S=>Ye(S.target.value),placeholder:"أدخل قيمة النقدية في الدرج عند بداية الورديه"})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(Z,{className:"mb-1 block",children:"أرصدة المحافظ المستلمة (إجمالي) عند الدخول"}),e.jsx(R,{type:"number",value:Number.isFinite(pt)?pt:0,onChange:S=>{const B=parseFloat(S.target.value);qe(Number.isFinite(B)?B:0)},placeholder:"أدخل إجمالي أرصدة المحافظ عند بداية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"يمكن إضافة التفصيل لاحقاً إن لزم، المهم تسجيل الإجمالي."})]})]}),e.jsx(ze,{className:"flex gap-2 justify-between",children:e.jsx(m,{onClick:()=>{const S=parseFloat(Ft),B=pt,se=Number.isFinite(S)&&S>=0,pe=Number.isFinite(B)&&B>=0;if(!se||!pe){g({title:"يرجى إدخال قيم صحيحة",description:"أدخل قيمًا رقمية غير سالبة للنقدية ولإجمالي أرصدة المحافظ",variant:"destructive"});return}try{localStorage.setItem("shiftInitialReceivedDrawerFunds",String(S)),localStorage.setItem("shiftInitialReceivedWalletBalancesTotal",String(B))}catch{}g({title:"تم تسجيل أرصدة البداية",description:"سُجّل إجمالي النقدية وأرصدة المحافظ لبداية الورديه"}),st(!1)},children:"تأكيد وحفظ"})})]})}),e.jsx(me,{open:X,onOpenChange:S=>{S&&z(!0)},children:e.jsxs(he,{className:"sm:max-w-md",hideClose:!0,disableOutsideClose:!0,disableEscClose:!0,children:[e.jsx(ue,{children:e.jsx(xe,{children:"تسليم الورديه والخروج"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(m,{variant:F==="toUser"?"default":"secondary",onClick:()=>fe("toUser"),children:"تسليم إلى مستخدم آخر"}),e.jsx(m,{variant:F==="toAdmin"?"default":"secondary",onClick:()=>fe("toAdmin"),children:"تسليم إلى الأدمن الرئيسي"})]}),F==="toUser"&&e.jsxs("div",{className:"space-y-3",children:[It.length===0?e.jsx("div",{className:"text-sm text-gray-600",children:"لا يوجد مستخدمون مسجلون. قم بإضافة مستخدم أولاً."}):e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"اختر المستخدم الذي سيتسلم الورديه"}),e.jsx("div",{className:"space-y-2 max-h-40 overflow-auto",children:It.map((S,B)=>e.jsxs("div",{className:`flex items-center justify-between rounded border px-3 py-2 cursor-pointer ${(ke==null?void 0:ke.username)===S.username?"bg-indigo-50 border-indigo-200":""}`,onClick:()=>ge(S),children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:S.name}),e.jsx("div",{className:"text-xs text-gray-500",children:S.username})]}),e.jsx("span",{className:"text-xs text-gray-400",children:"اختيار"})]},B))})]}),e.jsxs("div",{children:[e.jsx(Z,{className:"mb-1 block",children:"كلمة سر المستخدم المحدد"}),e.jsx(R,{type:"password",autoComplete:"off",value:Fe,onChange:S=>Oe(S.target.value),placeholder:"أدخل كلمة السر"})]}),J&&e.jsx("div",{className:"text-xs text-red-600",children:J})]}),F==="toAdmin"&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm text-gray-600",children:"أدخل كلمة مرور الحساب الرئيسي لتسليم الورديه والخروج إلى الأدمن."}),e.jsx(R,{type:"password",autoComplete:"off",value:te,onChange:S=>Pe(S.target.value),placeholder:"كلمة المرور"}),ee&&e.jsx("div",{className:"text-xs text-red-600",children:ee})]})]}),e.jsx(ze,{className:"flex gap-2 justify-between",children:e.jsx(m,{disabled:Se||!F,onClick:async()=>{if(F){H(!0);try{const S=await Y();if(F==="toUser"){if(!ke){ae("يرجى اختيار المستخدم أولاً"),H(!1);return}if(Fe.trim()!==ke.password){ae("كلمة السر غير صحيحة"),H(!1);return}A(),j({name:ke.name,username:ke.username}),s(),Me(`${ke.name} (${ke.username})`);try{localStorage.setItem("lastHandoverToAdmin","false")}catch{}z(!1),fe(null),ge(null),Oe(""),ae(""),d(!1),vt(S),Be(null),wt(""),Re(!0)}else if(F==="toAdmin"){V("");const B=(b==null?void 0:b.email)||"";if(!B){V("لا يوجد بريد للمستخدم الرئيسي للتحقق"),H(!1);return}const{error:se}=await I(B,te);if(se){V("كلمة المرور غير صحيحة"),H(!1);return}A(),j(null);try{localStorage.setItem("lastHandoverToAdmin","true")}catch{}Pe(""),z(!1),d(!1),Me("الأدمن الرئيسي"),vt(S),Be(null),wt(""),Re(!0)}}catch{ae("حدث خطأ أثناء التسليم، حاول مرة أخرى")}finally{H(!1)}}},children:"تأكيد التسليم"})})]})}),e.jsx(me,{open:ie,onOpenChange:Re,children:e.jsxs(he,{className:"sm:max-w-lg",hideClose:!0,disableOutsideClose:!0,disableEscClose:!0,children:[e.jsx(ue,{children:e.jsx(xe,{children:"تقرير تسليم الورديه والخروج"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsxs("div",{className:"text-sm",children:["تم تسليم الورديه إلى: ",e.jsx("span",{className:"font-semibold",children:$e})]}),f&&e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["بداية الورديه: ",new Date(f).toLocaleString("ar-EG")]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نهاية الورديه: ",new Date().toLocaleString("ar-EG")]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(Z,{className:"mb-1 block",children:"الفلوس النقدية المستلمة"}),e.jsx(R,{type:"number",value:Ft,readOnly:!0,disabled:!0,placeholder:"قيمة مسجلة عند بداية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"قيمة غير قابلة للتعديل؛ تُسجّل عند الدخول."})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(Z,{className:"mb-1 block",children:"أرصدة المحافظ المستلمة (إجمالي)"}),e.jsx(R,{type:"number",value:pt,readOnly:!0,disabled:!0,placeholder:"إجمالي مسجل عند بداية الورديه"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(Z,{className:"mb-1 block",children:"الفلوس النقدية المسلمة"}),e.jsx(R,{type:"number",value:ne,onChange:S=>{const B=parseFloat(S.target.value);Ee(Number.isFinite(B)?B:0)},placeholder:"أدخل قيمة النقدية المسلمة عند نهاية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"ادخال يدوي لقيمة النقدية المسلّمة عند نهاية الورديه"})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(Z,{className:"mb-1 block",children:"أرصدة المحافظ المسلمة (إجمالي)"}),e.jsx(R,{type:"number",value:He,onChange:S=>{const B=parseFloat(S.target.value);jt(Number.isFinite(B)?B:0)},placeholder:"أدخل إجمالي أرصدة المحافظ المسلّمة"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"يمكنك إدخال الإجمالي يدوياً؛ التفصيل يُحفظ إن لزم"})]})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-1",children:"أرباح الوردية"}),e.jsx("div",{className:["text-sm",(ne??0)+(He??0)-((parseFloat(Ft||"0")||0)+(pt??0))>=0?"text-green-700":"text-red-700"].join(" "),children:Math.round(((ne??0)+(He??0)-((parseFloat(Ft||"0")||0)+(pt??0)))*100)/100}),e.jsx("div",{className:"text-xs text-gray-600",children:"محسوبة: (المسلّم − المستلم) للنقدية + المحافظ"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"هل يوجد عجز؟"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(m,{variant:xt==="no"?"default":"secondary",onClick:()=>Be("no"),children:"لا"}),e.jsx(m,{variant:xt==="yes"?"default":"secondary",onClick:()=>Be("yes"),children:"نعم"})]}),xt==="yes"&&e.jsxs("div",{children:[e.jsx(Z,{className:"mb-1 block",children:"مبلغ العجز"}),e.jsx(R,{type:"number",value:bt,onChange:S=>wt(S.target.value),placeholder:"أدخل مبلغ العجز"})]})]})]}),e.jsx(ze,{className:"flex gap-2 justify-between",children:e.jsx(m,{onClick:()=>{const S=xt==="yes",B=parseFloat(bt)||0;(async()=>await Q(_t,S,B))(),g({title:"تم إضافة إيصال تسليم الورديه",description:"أُضيف الإيصال إلى المعاملات الأخيرة بعنوان إيصال تسليم وردية"}),Re(!1)},children:"تأكيد وحفظ الإيصال"})})]})})]})},Vm=({open:n,onOpenChange:d})=>{const{shiftUser:o,endShift:p,setShiftUser:f}=tr(),[j,s]=i.useState(""),[A,O]=i.useState(""),[b,I]=i.useState([]),{user:N}=_s();i.useEffect(()=>{(async()=>{try{if(N!=null&&N.uid){const P=Ge(de,"profiles",N.uid,"cashierUsers","list"),k=await ra(P);if(k.exists()){const U=k.data(),C=Array.isArray(U==null?void 0:U.users)?U.users:[];if(C&&C.length>0){I(C);return}}}}catch{}try{const P=`cashierUsers_${(N==null?void 0:N.uid)||"default"}`;let k=localStorage.getItem(P);if(!k){const U=localStorage.getItem("cashierUsers");U&&(k=U)}I(k?JSON.parse(k):[])}catch{I([])}})()},[n,N==null?void 0:N.uid]),i.useEffect(()=>{if(!n||!(N!=null&&N.uid))return;const P=Ge(de,"profiles",N.uid,"cashierUsers","list"),k=ua(P,U=>{if(U.exists()){const C=U.data(),L=Array.isArray(C==null?void 0:C.users)?C.users:[];if(L&&L.length>0)I(L);else try{const q=`cashierUsers_${(N==null?void 0:N.uid)||"default"}`;let X=localStorage.getItem(q);if(!X){const z=localStorage.getItem("cashierUsers");z&&(X=z)}I(X?JSON.parse(X):[])}catch{I([])}}},U=>{console.warn("ShiftProfileDialog cashierUsers snapshot error:",U)});return()=>k()},[n,N==null?void 0:N.uid]);const g=async()=>{if(O(""),!o)return;const P=b.find(k=>k.username===o.username);if(!P){O("لا يوجد مستخدم مطابق لهذه الوردية");return}if(j.trim()!==P.password){O("الرقم السري غير صحيح");return}p(),f(null),s(""),d(!1)};return e.jsx(me,{open:n,onOpenChange:P=>{s(""),O(""),d(P)},children:e.jsxs(he,{className:"sm:max-w-md",children:[e.jsx(ue,{children:e.jsx(xe,{children:"بروفيل الوردية"})}),o?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"rounded-lg border p-3 bg-gradient-to-r from-blue-50 to-indigo-50",children:[e.jsx("div",{className:"text-sm font-semibold text-gray-800",children:o.name}),e.jsx("div",{className:"text-xs text-gray-600",children:o.username})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{className:"block",children:"أدخل الرقم السري لتسليم الوردية"}),e.jsx(R,{type:"password",value:j,onChange:P=>s(P.target.value),placeholder:"الرقم السري للمستخدم",dir:"ltr"}),A&&e.jsx("div",{className:"text-red-600 text-xs",children:A})]})]}):e.jsx("div",{className:"text-sm text-gray-600",children:"لا يوجد مستخدم وردية نشط حالياً"}),e.jsxs(ze,{className:"flex justify-between",children:[e.jsx(m,{variant:"outline",onClick:()=>d(!1),children:"إغلاق"}),e.jsx(m,{onClick:g,disabled:!o,children:"تسليم الوردية"})]})]})})},Jm=({open:n,onOpenChange:d})=>e.jsx(me,{open:n,onOpenChange:d,children:e.jsxs(he,{className:"sm:max-w-lg rounded-2xl",children:[e.jsxs(ue,{children:[e.jsxs(xe,{className:"text-right flex items-center gap-2 justify-end",children:[e.jsx(Kn,{className:"w-5 h-5"}),"سجل التغييرات الأخيرة"]}),e.jsx(us,{className:"text-right",children:"هذه أبرز التحسينات التي تمت مؤخرًا في الواجهة."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(ql,{className:"w-5 h-5 text-amber-600 mt-1"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold",children:"تحسين نافذة تعديل المديونية"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"استبدال نافذة الإدخال القديمة (prompt) بحوار أنيق لإدخال المبلغ مع تأكيد."})]})]}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Wd,{className:"w-5 h-5 text-violet-600 mt-1"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold",children:"تحديث شاشة التحميل"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:'تغيير النص إلى "صلي علي النبي" مع خط عربي جميل ونبض لطيف.'})]})]}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Kn,{className:"w-5 h-5 text-green-600 mt-1"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold",children:"بطاقات الأرباح وعدد العمليات"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"إضافة بطاقات عرض أرباح الفترة الحالية وعدد العمليات في تفاصيل المحفظة."})]})]}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Kn,{className:"w-5 h-5 text-blue-600 mt-1"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold",children:"إصلاح تمرير نافذة اليومية"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"منع تمرير الصفحة الخلفية عند فتح نافذة اليومية لراحة الاستخدام."})]})]})]}),e.jsx("div",{className:"flex justify-end gap-2 mt-6",children:e.jsx(m,{variant:"secondary",onClick:()=>d(!1),children:"إغلاق"})})]})});class Ca{static async processTransfer(d){const{amount:o,currentCashBalance:p,currentWalletBalances:f,wallets:j,selectedWalletId:s}=d;if(o<=0)return{success:!1,newCashBalance:p,newWalletBalances:f,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(s&&!d.skipRemoteLimitsCheck)try{const I=await Ts.canPerformOperation(s,o,"transfer");if(!I.canPerform)return{success:!1,newCashBalance:p,newWalletBalances:f,message:I.message||"تم تجاوز الحد الأقصى",error:"LIMIT_EXCEEDED"}}catch(I){return console.error("خطأ في التحقق من حدود التحويل:",I),{success:!1,newCashBalance:p,newWalletBalances:f,message:"خطأ في التحقق من حدود التحويل",error:"LIMIT_CHECK_ERROR"}}if(o<=0)return{success:!1,newCashBalance:p,newWalletBalances:f,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(s){const I=Math.max(f[s]||0,0);if(I<o){const N=j.find(g=>g.id===s);return{success:!1,newCashBalance:p,newWalletBalances:f,message:`رصيد غير كافي في المحفظة${N?` ${N.name}`:""}. المتاح: ${I} جنيه، المطلوب: ${o} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"}}}else{const I=Ca.calculateTotalWalletBalance(f);if(I<o)return{success:!1,newCashBalance:p,newWalletBalances:f,message:`رصيد غير كافي في المحافظ. الرصيد المتاح: ${I} جنيه، المبلغ المطلوب: ${o} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"}}const A={...f};if(s){const I=A[s]||0;A[s]=I-o}else{let I=o;for(const N of j){if(I<=0)break;const g=Math.max(A[N.id]||0,0),P=Math.min(g,I);P>0&&(A[N.id]=(A[N.id]||0)-P,I-=P)}}const O=p+o;if(s)try{const I=Ts.updateUsage(s,o,"transfer");d.nonBlockingUsageUpdate?I.catch(N=>console.error("خطأ في تحديث استخدام المحفظة:",N)):await I}catch(I){console.error("خطأ في تحديث استخدام المحفظة:",I)}let b="تم التحويل بنجاح";if(s){const I=A[s]||0;I<0&&(b=`تم التحويل بنجاح مع تحذير: رصيد محفظة ${s} أصبح ${I} جنيه.`)}return{success:!0,newCashBalance:O,newWalletBalances:A,message:b}}static processDeposit(d){const{amount:o,currentCashBalance:p,currentWalletBalances:f,wallets:j}=d;if(o<=0)return{success:!1,newCashBalance:p,newWalletBalances:f,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};const s=this.calculateTotalWalletBalance(f);if(s<o)return{success:!1,newCashBalance:p,newWalletBalances:f,message:`رصيد غير كافي في المحافظ. الرصيد المتاح: ${s} جنيه، المبلغ المطلوب: ${o} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"};const A=p+o,O={...f};let b=o;const I=j.find(g=>g.isDefault);if(I&&O[I.id]>=b)O[I.id]-=b,b=0;else for(const g of j){if(b<=0)break;const P=O[g.id]||0;if(P>0){const k=Math.min(P,b);O[g.id]=P-k,b-=k}}const N=b>0?`تم الإيداع جزئياً. تم إيداع ${o-b} جنيه في صندوق النقدية`:`تم الإيداع بنجاح. تم إضافة ${o} جنيه إلى صندوق النقدية`;return{success:!0,newCashBalance:A,newWalletBalances:O,message:N}}static async processWithdraw(d){const{amount:o,currentCashBalance:p,currentWalletBalances:f,wallets:j,selectedWalletId:s}=d;if(o<=0)return{success:!1,newCashBalance:p,newWalletBalances:f,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(s&&!d.skipRemoteLimitsCheck)try{const I=await Ts.canPerformOperation(s,o,"withdraw");if(!I.canPerform)return{success:!1,newCashBalance:p,newWalletBalances:f,message:I.message||"تم تجاوز الحد الأقصى",error:"LIMIT_EXCEEDED"}}catch(I){return console.error("خطأ في التحقق من حدود السحب:",I),{success:!1,newCashBalance:p,newWalletBalances:f,message:"خطأ في التحقق من حدود السحب",error:"LIMIT_CHECK_ERROR"}}if(p<o)return{success:!1,newCashBalance:p,newWalletBalances:f,message:`رصيد غير كافي في صندوق النقدية. الرصيد المتاح: ${p} جنيه، المبلغ المطلوب: ${o} جنيه`,error:"INSUFFICIENT_CASH_BALANCE"};const A=p-o,O={...f},b=s?j.find(I=>I.id===s):j.find(I=>I.isDefault)||j[0];if(b){const I=O[b.id]||0;O[b.id]=I+o}else return{success:!1,newCashBalance:p,newWalletBalances:f,message:"لا توجد محافظ متاحة لإضافة المبلغ إليها",error:"NO_WALLETS_AVAILABLE"};if(s)try{const I=Ts.updateUsage(s,o,"withdraw");d.nonBlockingUsageUpdate?I.catch(N=>console.error("خطأ في تحديث استخدام المحفظة:",N)):await I}catch(I){console.error("خطأ في تحديث استخدام المحفظة:",I)}return{success:!0,newCashBalance:A,newWalletBalances:O,message:`تم السحب بنجاح. تم إضافة ${o} جنيه إلى محفظة ${(b==null?void 0:b.name)||""}`}}static validateOperation(d,o){return d<=0?{valid:!1,error:"المبلغ يجب أن يكون أكبر من الصفر"}:!o||o.length===0?{valid:!1,error:"لا توجد محافظ متاحة"}:{valid:!0}}static calculateTotalWalletBalance(d){return Object.values(d).reduce((o,p)=>o+Math.max(p,0),0)}static deductFromWalletsAddToCash(d,o,p,f){return this.processTransfer({amount:d,currentCashBalance:o,currentWalletBalances:p,wallets:f})}static deductFromWalletsAddToCashDeposit(d,o,p,f){return this.processDeposit({amount:d,currentCashBalance:o,currentWalletBalances:p,wallets:f})}static deductFromCashAddToWallets(d,o,p,f){return this.processWithdraw({amount:d,currentCashBalance:o,currentWalletBalances:p,wallets:f})}static applyTransactionResult(d,o,p){d.success&&(o(d.newCashBalance),p(d.newWalletBalances))}static validateTransaction(d,o,p,f){if(d<=0)return{isValid:!1,error:"المبلغ يجب أن يكون أكبر من الصفر"};if(o==="transfer"){const j=this.calculateTotalWalletBalance(f);if(j<d)return{isValid:!1,error:`الرصيد المتاح في المحافظ (${j} جنيه) غير كافي للمبلغ المطلوب (${d} جنيه)`}}else if(o==="withdraw"){if(p<d)return{isValid:!1,error:`الرصيد المتاح في صندوق النقدية (${p} جنيه) غير كافي للمبلغ المطلوب (${d} جنيه)`}}else if(o==="deposit"){const j=this.calculateTotalWalletBalance(f);if(j<d)return{isValid:!1,error:`الرصيد المتاح في المحافظ (${j} جنيه) غير كافي للمبلغ المطلوب (${d} جنيه)`}}return{isValid:!0}}static getDeductionPreview(d,o,p){const f=[];let j=d;for(const s of p){if(j<=0)break;const A=o[s.id]||0,O=Math.min(Math.max(A,0),j);O>0&&(f.push({walletId:s.id,walletName:s.name,currentBalance:A,deductedAmount:O,newBalance:A-O}),j-=O)}return f}}let Ka=null;function Km(){const n=window;if(!Ka){const d=n.AudioContext||n.webkitAudioContext;Ka=new d}return Ka.state==="suspended"&&Ka.resume(),Ka}function Ym(n,d,o){const p=o/1e3,f=Math.floor(n.sampleRate*p),j=n.createBuffer(1,f,n.sampleRate),s=j.getChannelData(0);for(let I=0;I<f;I++)s[I]=(Math.random()*2-1)*.6;const A=n.createBufferSource();A.buffer=j;const O=n.createBiquadFilter();O.type="highpass",O.frequency.value=1500,O.Q.value=.7;const b=n.createGain();b.gain.setValueAtTime(1e-4,d),b.gain.exponentialRampToValueAtTime(.4,d+.015),b.gain.exponentialRampToValueAtTime(1e-4,d+p),A.connect(O),O.connect(b),b.connect(n.destination),A.start(d),A.stop(d+p+.01)}function Hm(n,d,o,p,f,j="triangle"){const s=n.createOscillator(),A=n.createGain();s.type=j;const O=f/1e3;s.frequency.setValueAtTime(o,d),s.frequency.linearRampToValueAtTime(p,d+O),A.gain.setValueAtTime(1e-4,d),A.gain.exponentialRampToValueAtTime(.25,d+.02),A.gain.exponentialRampToValueAtTime(1e-4,d+O),s.connect(A),A.connect(n.destination),s.start(d),s.stop(d+O+.02)}function Gm(){try{const n=Km(),d=n.currentTime;Ym(n,d,90),Hm(n,d+.12,1900,1100,180,"sawtooth")}catch{}}function Qm(n){if(!n)return!1;const o=n.replace(/[^0-9٠-٩]/g,"").replace(/[٠-٩]/g,p=>"0123456789"["٠١٢٣٤٥٦٧٨٩".indexOf(p)]);return/^(010|011|012|015)[0-9]{8}$/.test(o)}function Zm({userId:n}){const[d,o]=_e.useState(null),[p,f]=_e.useState("");return null}const tu=()=>{var xl,pl,gl,fl,yl;console.log("🔥 UserDashboardPage component is loading...");const{toast:n}=gs(),d=i.useRef(null),[o,p]=i.useState(0),f=async()=>{var a,l,c;const t="alkaptin678678@gmail.com",r=(l=(a=Dl.currentUser)==null?void 0:a.email)==null?void 0:l.toLowerCase();if(!r||r!==t){n({title:"قيد التطوير",description:"هذه الميزة غير متاحة حالياً."});return}if(!yr||!vr||!br){n({title:"بيانات ناقصة",description:"أدخل رقم الموبايل، الشركة والمبلغ",variant:"destructive"});return}try{Ki(!0);const h=await((c=Dl.currentUser)==null?void 0:c.getIdToken()),x=await fetch("/api/topup",{method:"POST",headers:{"Content-Type":"application/json",...h?{Authorization:`Bearer ${h}`}:{}},body:JSON.stringify({phone:yr,countryCode:"EG",operator:vr,amount:Number(br),useLocalAmount:!0})}),v=await x.json().catch(()=>({}));x.ok&&(v!=null&&v.success)?(n({title:"تم الشحن",description:(v==null?void 0:v.message)||"تم تنفيذ عملية الشحن بنجاح"}),Tn(!1),zi(""),qi(""),Vi("")):n({title:"فشل الشحن",description:(v==null?void 0:v.message)||"حدث خطأ أثناء طلب الشحن",variant:"destructive"})}catch(h){console.error("Topup request error:",h),n({title:"خطأ غير متوقع",description:"تعذّر تنفيذ عملية الشحن. حاول لاحقاً.",variant:"destructive"})}finally{Ki(!1)}},{signOut:j,user:s,profile:A}=_s(),O=((s==null?void 0:s.email)||"").toLowerCase()==="vodafonecash00@gmail.com",b=Rl(),I=Fl(),{isShiftActive:N,shiftUser:g}=tr(),{shopName:P}=Ul(),k=yd();(()=>{try{return!!window.electronAPI||typeof navigator<"u"&&navigator.userAgent.toLowerCase().includes("electron")||typeof window<"u"&&window.location&&window.location.protocol==="file:"}catch{return!1}})();const[U,C]=i.useState(!1),[L,q]=i.useState(!1),[X,z]=i.useState(!1),[F,fe]=i.useState([]),[te,Pe]=i.useState(()=>{try{return localStorage.getItem("cashySelectedDevice")||null}catch{return null}}),ee=t=>!!(t&&F.some(r=>r.id===t));async function V(){const t=window.electronAPI,r=te||"";if(!t||typeof t.sendUssd!="function")return null;if(!r)return n({title:"الجهاز غير محدد",description:"اتصل بالموبايل أولاً ثم اختر الجهاز من القائمة",variant:"destructive"}),null;if(ee(r))return r;try{const h=F.find(x=>x&&x.id&&!String(x.id).includes(":"));if(h&&h.id)return Pe(h.id),h.id}catch{}const a=r.includes(":")?r.split(":").slice(0,2).join(":"):"";if(a&&typeof t.connectWifi=="function"){try{await t.connectWifi(a)}catch{}if(await new Promise(h=>setTimeout(h,250)),ee(r))return r}const l=r.split(":")[0],c=F.find(h=>(h.id.startsWith(l)||h.id.includes(l))&&h.id.includes(":"));if(c!=null&&c.id){const h=c.id.split(":").slice(0,2).join(":");if(!ee(c.id)&&typeof t.connectWifi=="function"){try{await t.connectWifi(h)}catch{}await new Promise(x=>setTimeout(x,250))}if(ee(c.id))return Pe(c.id),c.id}return n({title:"الجهاز غير متصل",description:"فعّل Wireless debugging أو استخدم اتصال Wi‑Fi ثم أعد المحاولة",variant:"destructive"}),null}i.useEffect(()=>{const t=window.electronAPI;t&&typeof t.onAdbDevices=="function"&&t.onAdbDevices(r=>{var c;const a=Array.isArray(r)?r:[];fe(a);const l=(()=>{try{return localStorage.getItem("cashySelectedDevice")||""}catch{return""}})();l&&a.some(h=>h.id===l)?Pe(l):(c=a[0])!=null&&c.id?Pe(h=>h||a[0].id):Pe(null)})},[]);function le(t,r){try{const a=qt==null?void 0:qt(),l=(a==null?void 0:a.phone)||"";if(!l){n({title:"يجب اختيار محفظة",description:"اختر محفظة المُرسل أولاً",variant:"destructive"});return}Sd(l,t,r),n({title:"تم إرسال كود التحويل",description:"تم تنفيذ الاتصال مباشرة على الهاتف"}),oa(!1),ba(!1)}catch(a){const l=(a==null?void 0:a.message)||"تعذر إرسال الكود — تحقق من البيانات";throw n({title:"فشل الإرسال",description:l,variant:"destructive"}),a}}const be=async()=>{var a;if(!os||!os.receiver||!os.amount){n({title:"بيانات غير مكتملة",description:"تأكد من إدخال رقم المستقبل والمبلغ قبل الإرسال",variant:"destructive"});return}const t=String(os.receiver),r=Math.round(Number(os.amount));ca(!0);try{if((a=Cl)!=null&&a.isNativePlatform&&Cl.getPlatform()==="android"){const c=qt==null?void 0:qt(),h=(c==null?void 0:c.phone)||"";if(!h){n({title:"يجب اختيار محفظة",description:"اختر محفظة المُرسل أولاً",variant:"destructive"}),ca(!1);return}const x=Il(h,t,r);if(!x){n({title:"رقم غير مدعوم",description:"تحقق من بداية الرقم 010/011/012/015",variant:"destructive"}),ca(!1);return}Nd(x),n({title:"تم إرسال كود التحويل",description:"تم تنفيذ الاتصال مباشرة على الهاتف"}),oa(!1),ba(!1);return}const l=window.electronAPI;if(l&&typeof l.sendUssd=="function"&&te){const c=qt==null?void 0:qt(),h=(c==null?void 0:c.phone)||"";if(!h){n({title:"يجب اختيار محفظة",description:"اختر محفظة المُرسل أولاً",variant:"destructive"}),ca(!1);return}const x=await V();if(!x){ca(!1);return}const v=Il(h,t,r);if(!v){n({title:"رقم غير مدعوم",description:"تحقق من بداية الرقم 010/011/012/015",variant:"destructive"}),ca(!1);return}try{const w=typeof l.pickSimAutomatically=="function"?await l.pickSimAutomatically(x,h):{deviceId:x,slot:0},y=`${w.deviceId}:sim${w.slot}`;Yo(y),await l.sendUssd(y,v)}catch{try{await l.sendUssd(x,v)}catch(y){const D=x.includes(":")?x.split(":").slice(0,2).join(":"):"";if(D&&typeof l.connectWifi=="function")await l.connectWifi(D),await l.sendUssd(x,v);else throw y}}n({title:"تم إرسال كود التحويل",description:"تم التنفيذ بنجاح"}),oa(!1),ba(!0)}else le(t,r)}catch(l){const c=l&&l.message?l.message:"حدث خطأ غير متوقع أثناء الإرسال";n({title:"خطأ أثناء الإرسال",description:`الجهاز: ${wi||te||"غير معروف"} — ${c}`,variant:"destructive"})}finally{ca(!1)}},ke=async(t,r)=>{const a=window.electronAPI;try{if(a&&typeof a.enterPin=="function"&&t){await a.enterPin(t,r),ba(!1);return}const l=String((A==null?void 0:A.bridgeLink)||"").trim(),c=String((A==null?void 0:A.bridgeDeviceId)||"").trim()||void 0;if(!l){n({title:"الرابط غير مُعدّ",description:"احفظ رابط الجسر أولاً",variant:"destructive"});return}const h=String((os==null?void 0:os.receiver)||zt||"").replace(/\D/g,""),x=Math.max(1,Math.round(Number((os==null?void 0:os.amount)||gt||0))||0),v=String(r||"").replace(/\D/g,""),y=(D=>{let T=(D||"").trim();return T=T.replace(/\/+$/,""),/^https?:\/\//i.test(T)||(T=`https://${T}`),T})(l);ba(!1)}catch(l){const c=(l==null?void 0:l.message)||"حدث خطأ أثناء إدخال الرقم السري";n({title:"فشل الإدخال",description:c,variant:"destructive"})}};console.log("🔥 UserDashboardPage - user:",s?"exists":"null");const[ge,Fe]=i.useState(!0),[Oe,J]=i.useState(!0),[ae,Se]=i.useState(!1),[H,ie]=i.useState(!1),[Re,_t]=i.useState(""),[vt,xt]=i.useState(""),[Be,bt]=i.useState(""),[wt,Ft]=i.useState([]),[Ye,pt]=i.useState(!1),[qe,Pt]=i.useState(null),[E,ne]=i.useState(""),[Ee,He]=i.useState(!1),[jt,Nt]=i.useState(!1),[ts,$e]=i.useState(!1),[Me,tt]=i.useState(!1),[st,Ut]=i.useState(""),[It,Yt]=i.useState(""),[W,ye]=i.useState([]),[oe,it]=i.useState(!1),[ht,St]=i.useState(0),[Dt,Ht]=i.useState(!1),[Ct,Ns]=i.useState(null),[fs,Ss]=i.useState(!1),[Je,Fs]=i.useState(""),[zt,Ps]=i.useState(""),[gt,ys]=i.useState(""),[u,_]=i.useState(""),[M,Y]=i.useState(!1),[Q,we]=i.useState(""),[S,B]=i.useState(""),[se,pe]=i.useState(""),[Ue,Ve]=i.useState(""),[Ie,ut]=i.useState(null),[ss,Mt]=i.useState(!1),[ns,je]=i.useState(!1),[lt,as]=i.useState(!1),[Yr,ya]=i.useState(!1),[ri,Hr]=i.useState(null),[is,Gr]=i.useState(""),[ls,Qr]=i.useState(""),[ni,So]=i.useState(""),[Do,sr]=i.useState(!1),[Xm,eh]=i.useState(null),[vs,ii]=i.useState(null),ar=t=>{const r="٠١٢٣٤٥٦٧٨٩",a="۰۱۲۳۴۵۶۷۸۹";return(t||"").split("").map(l=>{const c=r.indexOf(l);if(c>-1)return String(c);const h=a.indexOf(l);return h>-1?String(h):l}).join("")},[Ke,Zr]=i.useState(()=>{try{const t=localStorage.getItem("commissionMode")||localStorage.getItem("commissionMode_default");return t?t==="add":!0}catch{return!0}}),[re,li]=i.useState("transfer"),[Qe,Hs]=i.useState([]),[Ms,Xr]=i.useState("all");i.useEffect(()=>{try{if(localStorage.setItem("commissionMode",Ke?"add":"deduct"),s!=null&&s.uid){const t=`commissionMode_${s.uid}`;localStorage.setItem(t,Ke?"add":"deduct")}}catch{}},[Ke,s==null?void 0:s.uid]),i.useEffect(()=>{try{const t=s!=null&&s.uid?localStorage.getItem(`commissionMode_${s.uid}`):null,r=localStorage.getItem("commissionMode"),a=localStorage.getItem("commissionMode_default"),l=t??r??a;l&&Zr(l==="add")}catch{}},[s==null?void 0:s.uid]);const[en,Ta]=i.useState(!1),[Co,Io]=i.useState(null),rr=_e.useRef(""),oi=_e.useRef(0);i.useEffect(()=>{const t=r=>{var l;if(en)return;try{const c=document.activeElement;if(c){const h=(l=c.tagName)==null?void 0:l.toLowerCase();if(h==="input"||h==="textarea"||h==="select"||h==="button"||c.isContentEditable===!0)return}}catch{}const a=Date.now();if(r.key==="Enter"){const c=(rr.current||"").trim();rr.current="",c&&(Io(c),Ta(!0));return}r.key.length===1&&(a-(oi.current||0)>100&&(rr.current=""),rr.current+=r.key,oi.current=a)};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[en]);const[Ao,To]=i.useState(!1),[Po,th]=i.useState(null),[G,tn]=i.useState("");i.useEffect(()=>{if(!M)return;const t=qt(),r=parseFloat(gt||"0")||0;let a=0;if(re==="transfer"){if((t==null?void 0:t.defaultTransferCommission)!=null){const c=Number(t.defaultTransferCommission)||0;a=Math.round(c*r/1e3*100)/100}else{const c=ls&&ls.trim()!==""?parseFloat(ls):0;a=Math.max(0,c)}const l=r+a;B((l||0).toString())}else{if((t==null?void 0:t.defaultWithdrawCommission)!=null){const c=Number(t.defaultWithdrawCommission)||0;a=Math.round(c*r/1e3*100)/100}else{const c=is&&is.trim()!==""?parseFloat(is):Math.round(r*.01*100)/100;a=Math.max(0,c)}const l=Ke?r:Math.max(0,Math.round((r-a)*100)/100);B((l||0).toString())}},[M,gt,ls,is,G,Ke,re]);const qt=()=>{var r,a;let t=Ae.find(l=>l.id===G);if(!t)try{const l=localStorage.getItem(En());if(l){const c=JSON.parse(l);if(Array.isArray(c)&&c.length>0){const x=localStorage.getItem(`selectedWallet_${(s==null?void 0:s.uid)||"default"}`)||((r=c.find(v=>v.isDefault))==null?void 0:r.id)||((a=c[0])==null?void 0:a.id);t=c.find(v=>v.id===x)}}}catch{}return t};i.useLayoutEffect(()=>{try{const t=`wallets_${(s==null?void 0:s.uid)||"default"}`;let r=localStorage.getItem(t);if(!r){const a=Object.keys(localStorage).find(l=>l.startsWith("wallets_"));a&&(r=localStorage.getItem(a)||null)}if(r){const a=JSON.parse(r);if(Array.isArray(a)&&a.length>0){Pa(a);const l=`selectedWallet_${(s==null?void 0:s.uid)||"default"}`,c=localStorage.getItem(l),h=c&&a.find(x=>x.id===c)||a.find(x=>x.isDefault)||a[0];h&&(tn(h.id),Fs(h.phone))}}}catch(t){console.error("تهيئة فورية للمحافظ من التخزين المحلي فشلت:",t)}},[]),i.useEffect(()=>{console.log("🔍 selectedWallet state changed to:",G)},[G]),i.useEffect(()=>{Hi()},[s==null?void 0:s.uid]),i.useEffect(()=>{kc()},[]);const[Ae,Pa]=i.useState(()=>{try{const t=Object.keys(localStorage).find(a=>a.startsWith("wallets_")),r=t?localStorage.getItem(t):null;if(r){const a=JSON.parse(r);if(Array.isArray(a))return a}}catch{}return[]}),[ci,ko]=i.useState(""),di=(()=>{const t=ci.replace(/\D/g,"");return t?Ae.filter(r=>(r.phone||"").replace(/\D/g,"").includes(t)):Ae})(),[Oo,sh]=i.useState(null),[Eo,mi]=i.useState(!1),[Wo,nr]=i.useState(!1),[_o,Fo]=i.useState(null),[ah,Mo]=i.useState([]),[rh,nh]=i.useState([]),[Lo,ka]=i.useState(!1),[sn,hi]=i.useState("daily"),[Ro,ui]=i.useState(!1),[Bo,an]=i.useState(!1),[xi,Oa]=i.useState([]),$o=async t=>{try{if(!s)return;const r=Ds(),a=ms(),l=localStorage.getItem(r),c=localStorage.getItem(a);let h=l?parseFloat(l):ot,x=c?JSON.parse(c):{...Te};const v=t.amount||t.transferredAmount||t.withdrawnAmount||t.withdrawnAmountDetailed||0;if(t.type==="send"&&(t.fromWallet||G)){h-=t.commission||0;const D=t.fromWallet||G;x[D]=(x[D]||0)+v}else if(t.type==="withdraw"&&(t.fromWallet||G)){h+=v,h-=t.commission||0;const D=t.fromWallet||G;x[D]=Math.max(0,(x[D]||0)-v)}Gt(h),Vt(x),localStorage.setItem(r,h.toString()),localStorage.setItem(a,JSON.stringify(x));const w={cashBalance:h,walletBalances:x,lastUpdated:new Date().toISOString()},y=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(y,JSON.stringify(w));try{await Ce.updateUserData(s.uid,w),localStorage.removeItem(y),Ne(!1)}catch(D){console.warn("تعذر حفظ الأرصدة في Firebase بعد الحذف (مزامنة تلقائية):",D),Ne(!0)}try{const D=t.fromWallet||G,T=await Ts.getWalletLimits(s.uid,D);if(T){const $={...T};t.type==="send"?($.dailyTransferUsed=Math.max(0,(T.dailyTransferUsed||0)-v),$.monthlyTransferUsed=Math.max(0,(T.monthlyTransferUsed||0)-v)):($.dailyWithdrawUsed=Math.max(0,(T.dailyWithdrawUsed||0)-v),$.monthlyWithdrawUsed=Math.max(0,(T.monthlyWithdrawUsed||0)-v)),await Ts.updateWalletLimits(s.uid,D,$)}}catch(D){console.warn("تعذر تحديث حدود المحفظة بعد الحذف (مزامنة):",D)}try{Qt.removeTransactionEffects(t,s.uid)}catch(D){console.warn("تعذر تحديث التقارير بعد الحذف (مزامنة):",D)}}catch(r){console.warn("خطأ أثناء تطبيق تأثيرات الحذف محليًا:",r)}},Uo=async t=>{try{const r=Qe.find(l=>l.id===t);if(!r||!s)return;const a=Qe.filter(l=>l.id!==t);Hs(a);try{await Ce.removeUserTransaction(s.uid,t),await Fr.permanentlyDeleteTransaction(t,s.uid)}catch(l){console.warn("تعذر الحذف النهائي من قواعد البيانات أثناء حذف الإيصال:",l)}try{const l=Ds(),c=ms(),h=localStorage.getItem(l),x=localStorage.getItem(c);let v=h?parseFloat(h):ot,w=x?JSON.parse(x):{...Te};const y=r.amount||r.transferredAmount||r.withdrawnAmount||r.withdrawnAmountDetailed||0;if(r.type==="send"&&(r.fromWallet||G)){v-=r.commission||0;const $=r.fromWallet||G;w[$]=(w[$]||0)+y}else if(r.type==="withdraw"&&(r.fromWallet||G)){v+=y,v-=r.commission||0;const $=r.fromWallet||G;w[$]=Math.max(0,(w[$]||0)-y)}Gt(v),Vt(w),localStorage.setItem(l,v.toString()),localStorage.setItem(c,JSON.stringify(w));const D={cashBalance:v,walletBalances:w,lastUpdated:new Date().toISOString()},T=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(T,JSON.stringify(D)),s!=null&&s.uid?Ce.updateUserData(s.uid,D).then(()=>{localStorage.removeItem(T),Ne(!1)}).catch($=>{console.warn("تعذر حفظ الأرصدة في Firebase بعد الحذف، تم الاحتفاظ محليًا:",$),Ne(!0)}):Ne(!0)}catch(l){console.warn("تعذر عكس تأثير الأرصدة بعد الحذف:",l)}try{const l=r.fromWallet||G,c=await Ts.getWalletLimits(s.uid,l);if(c){const h=r.amount||r.transferredAmount||r.withdrawnAmount||r.withdrawnAmountDetailed||0,x={...c};r.type==="send"?(x.dailyTransferUsed=Math.max(0,(c.dailyTransferUsed||0)-h),x.monthlyTransferUsed=Math.max(0,(c.monthlyTransferUsed||0)-h)):(x.dailyWithdrawUsed=Math.max(0,(c.dailyWithdrawUsed||0)-h),x.monthlyWithdrawUsed=Math.max(0,(c.monthlyWithdrawUsed||0)-h)),await Ts.updateWalletLimits(s.uid,l,x)}}catch(l){console.warn("تعذر تحديث حدود المحفظة بعد الحذف:",l)}try{Qt.removeTransactionEffects(r,s.uid)}catch(l){console.warn("تعذر تحديث التقارير بعد الحذف:",l)}n({title:"تم الحذف نهائيًا",description:"تم حذف الإيصال نهائيًا وعكس تأثيراته على الأرصدة والحدود والتقارير."}),nr(!1)}catch(r){console.error("خطأ أثناء حذف الإيصال:",r),n({title:"خطأ في حذف الإيصال",description:"حدث خطأ غير متوقع أثناء الحذف.",variant:"destructive"})}},zo=async t=>{var r;try{const a=Qe.find(l=>l.id===t);if(!a||!s)return;try{if(((r=Ct==null?void 0:Ct.subscription)==null?void 0:r.planType)===Os.ZERO){const{dailyOperationCountService:c}=await rt(async()=>{const{dailyOperationCountService:v}=await import("./dailyOperationCountService-DCVfuVar.js");return{dailyOperationCountService:v}},__vite__mapDeps([2,0,1]),import.meta.url),h=a.type==="send"?"transfer":"withdraw";if(!(await c.checkAndIncrement(s.uid,h,5)).allowed){n({title:"تم بلوغ حد باقة الزيرو",description:"مسموح بحد أقصى 5 تأكيدات يوميًا للتحويل/السحب. جرّب غدًا أو قم بالترقية.",variant:"destructive"});return}}}catch(l){console.warn("تعذر التحقق من حد التأكيد اليومي:",l)}await na(Ge(de,"userTransactions",t),{status:"completed",confirmedAt:new Date}),Hs(l=>l.map(c=>c.id===t?{...c,status:"completed"}:c)),n({title:"تم الإكمال",description:"تم وسم المعاملة كمكتملة."}),nr(!1)}catch(a){console.error("خطأ أثناء إكمال الإيصال:",a),n({title:"فشل الإكمال",description:"حدث خطأ غير متوقع أثناء تحديث الحالة.",variant:"destructive"})}};i.useEffect(()=>{if(s)try{const t=Bt(et(de,"deletedTransactions"),Le("userId","==",s.uid)),r=ua(t,a=>{a.docChanges().forEach(l=>{if(l.type!=="added")return;const c=l.doc.data(),h=c==null?void 0:c.originalTransactionId;h&&Hs(x=>{const v=x.find(y=>y.id===h);return v?((async()=>await $o(v))(),x.filter(y=>y.id!==h)):x})})},a=>{console.warn("فشل الاشتراك في deletedTransactions:",a)});return()=>r()}catch(t){console.warn("تعذر إنشاء مستمع deletedTransactions:",t)}},[s==null?void 0:s.uid]),i.useEffect(()=>{if(s)try{const t=Ge(de,"users",s.uid),r=ua(t,async a=>{if(!a.exists())return;const l=a.data();if(l!=null&&l.reportsData)try{await Qt.syncReportsDataFromFirebase(s.uid),Mo(qa())}catch(c){console.warn("تعذر مزامنة reportsData من السحابة:",c)}},a=>{console.warn("فشل الاشتراك في users.reportsData:",a)});return()=>r()}catch(t){console.warn("تعذر إنشاء مستمع users.reportsData:",t)}},[s==null?void 0:s.uid]);const[pi,qo]=i.useState(""),gi=Mm(pi,300),[ir,fi]=i.useState(""),[lr,yi]=i.useState(""),[Ls,ih]=i.useState(""),[rn,va]=i.useState(!1),[vi,Ea]=i.useState(!1),[Vo,oa]=i.useState(!1),[Lt,nn]=i.useState(null),[os,Jo]=i.useState(null),[bi,ca]=i.useState(!1),[Ko,ba]=i.useState(!1),[wi,Yo]=i.useState(""),[Ho,ln]=i.useState(!1),[Go,or]=i.useState(!1),[Qo,cr]=i.useState(!1),[Zo,dr]=i.useState(!1),[Xo,ji]=i.useState(!0),[Wa,ec]=i.useState(!1),[tc,mr]=i.useState(!1),[sc,Ni]=i.useState(()=>{try{const t=s!=null&&s.uid?`dailyReportsLockEnabled_${s==null?void 0:s.uid}`:"dailyReportsLockEnabled";return(localStorage.getItem(t)??localStorage.getItem("dailyReportsLockEnabled"))==="true"}catch{return!1}}),[ac,on]=i.useState(!1);i.useEffect(()=>{try{const t=s!=null&&s.uid?`dailyReportsLockEnabled_${s==null?void 0:s.uid}`:"dailyReportsLockEnabled",r=localStorage.getItem(t)??localStorage.getItem("dailyReportsLockEnabled");Ni(r==="true")}catch{}},[s==null?void 0:s.uid]);const[rc,wa]=i.useState(!1),[nc,cn]=i.useState(!1),[ic,Si]=i.useState(()=>{try{const t=s==null?void 0:s.uid,r=t?`debtsPinRequired_${t}`:"debtsPinRequired";return(localStorage.getItem(r)??localStorage.getItem("debtsPinRequired"))==="true"}catch{return!1}}),[lc,Di]=i.useState(!1),[Ci,oc]=i.useState(null),[kt,cs]=i.useState([]),[dn,Ii]=i.useState(""),[mn,Ai]=i.useState(""),[hn,Ti]=i.useState(""),[ce,_a]=i.useState(null),[cc,Gs]=i.useState(!1),[dc,Fa]=i.useState(!1),[da,Pi]=i.useState(null),[ki,un]=i.useState(""),[hr,Oi]=i.useState(null),[lh,oh]=i.useState(!1),[mc,xn]=i.useState(!1),[Ei,pn]=i.useState(""),[hc,Ma]=i.useState(!1),gn=async()=>{if(Ze){n({title:"غير متاح",description:"إدارة الديون/الأجل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"});return}try{const t=await Xt.hasMasterPin(s==null?void 0:s.uid);ic&&t?cn(!0):wa(!0)}catch{wa(!0)}};i.useEffect(()=>{try{const t=s==null?void 0:s.uid,r=t?`debtsPinRequired_${t}`:"debtsPinRequired",a=localStorage.getItem(r)??localStorage.getItem("debtsPinRequired");(a==="true"||a==="false")&&Si(a==="true")}catch{}},[s==null?void 0:s.uid]);const[uc,fn]=i.useState(!1),[Rs,yn]=i.useState([]),[vn,Wi]=i.useState(""),[bn,_i]=i.useState(""),[wn,Fi]=i.useState(""),[Mi,Li]=i.useState(""),[xc,La]=i.useState(!1),[ja,jn]=i.useState(null),[ds,Ra]=i.useState(null),[ur,Nn]=i.useState(""),[pc,Na]=i.useState(!1),[Ri,xr]=i.useState(0),[ps,Qs]=i.useState(null),[ma,Sn]=i.useState(""),[We,gc]=i.useState(null),bs=async t=>{try{const r=JSON.stringify(t);localStorage.setItem(wr(),r);try{localStorage.setItem(Yi(),r)}catch{}try{localStorage.setItem(Pn(),Date.now().toString())}catch{}s!=null&&s.uid&&Ce.updateUserData(s.uid,{debts:t}).then(()=>{try{localStorage.removeItem(`debts_unsynced_${s.uid}`)}catch{}}).catch(()=>{Ne(!0);try{localStorage.setItem(`debts_unsynced_${s.uid}`,"true")}catch{}})}catch(r){console.error("خطأ في حفظ الديون:",r)}},fc=async()=>{try{const t=wr(),r=Yi(),a=Pn(),l=localStorage.getItem(t),c=localStorage.getItem(r),h=localStorage.getItem(a),x=h?Number(h):0,v=y=>{if(!y)return null;try{const D=JSON.parse(y);return Array.isArray(D)?D.map(T=>{var $;return{...T,createdAt:($=T.createdAt)!=null&&$.toDate?T.createdAt.toDate():new Date(T.createdAt),partialPayments:Array.isArray(T.partialPayments)?T.partialPayments.map(K=>{var De;return{amount:Number(K.amount)||0,paidAt:(De=K.paidAt)!=null&&De.toDate?K.paidAt.toDate():new Date(K.paidAt)}}):[]}}):[]}catch(D){return console.warn("فشل في تحليل ديون localStorage:",D),null}};let w=v(l);if(!w||w.length===0){const y=v(c);if(y&&y.length>0&&(w=y,cs(y),s!=null&&s.uid))try{await bs(y),localStorage.removeItem(r)}catch(D){console.warn("تعذر ترحيل الديون من المفتاح الافتراضي:",D)}}if(w&&w.length>0&&cs(w),s!=null&&s.uid)try{const y=`debts_unsynced_${s.uid}`,D=localStorage.getItem(y)==="true",T=await ra(Ge(de,"users",s.uid));if(T.exists()){const $=T.data(),K=$.debts&&Array.isArray($.debts)?$.debts.map(Tt=>{var Xe;return{...Tt,createdAt:(Xe=Tt.createdAt)!=null&&Xe.toDate?Tt.createdAt.toDate():new Date(Tt.createdAt),partialPayments:Array.isArray(Tt.partialPayments)?Tt.partialPayments.map(ws=>{var $s;return{amount:Number(ws.amount)||0,paidAt:($s=ws.paidAt)!=null&&$s.toDate?ws.paidAt.toDate():new Date(ws.paidAt)}}):[]}}):[],De=x&&Date.now()-x<12e4,Ot=D||De?w||[]:K&&K.length>0?K:w||[];cs(Ot);try{localStorage.setItem(t,JSON.stringify(Ot))}catch{}((K==null?void 0:K.length)||0)===0&&((Ot==null?void 0:Ot.length)||0)>0&&await Ce.updateUserData(s.uid,{debts:Ot})}else w&&w.length>0&&await Ce.saveUserData(s.uid,{debts:w})}catch(y){console.warn("تعذر تحميل الديون من Firebase، الاعتماد على المحلي:",y)}}catch(t){console.error("خطأ في تحميل الديون:",t)}};i.useEffect(()=>{try{window.exportDebts=()=>{try{return JSON.stringify(kt||[])}catch{return"[]"}},window.importDebts=async t=>{try{const r=JSON.parse(t);if(!Array.isArray(r))throw new Error("صيغة غير صحيحة — يجب أن تكون مصفوفة");return await bs(r),{ok:!0,count:r.length}}catch(r){return console.error("فشل استيراد الديون:",r),{ok:!1,error:String(r)}}},window.fixWalletsForCurrentUser=async t=>{try{if(!(s!=null&&s.uid))throw new Error("يجب تسجيل الدخول أولاً");return await(await rt(async()=>{const{merchantWalletService:a}=await import("./index-Bp5r4OnK.js").then(l=>l.bh);return{merchantWalletService:a}},__vite__mapDeps([0,1]),import.meta.url)).merchantWalletService.reassignByMsisdns(t,s.uid)}catch(r){return console.error("فشل إصلاح المحافظ للمستخدم الحالي:",r),{updated:0,failed:(t==null?void 0:t.length)||0,error:String(r)}}}}catch{}},[kt,s==null?void 0:s.uid]),i.useEffect(()=>{if(!(s!=null&&s.uid))return;const t=Ge(de,"users",s.uid),r=ua(t,a=>{if(!a.exists())return;const l=a.data(),c=Array.isArray(l==null?void 0:l.debts)?l.debts:[],h=`debts_unsynced_${s.uid}`,x=localStorage.getItem(h)==="true",v=localStorage.getItem(Pn()),w=v?Number(v):0,y=w&&Date.now()-w<12e4;if(!(x||y))try{const D=c.map(T=>{var $;return{...T,createdAt:($=T.createdAt)!=null&&$.toDate?T.createdAt.toDate():new Date(T.createdAt),partialPayments:Array.isArray(T.partialPayments)?T.partialPayments.map(K=>{var De;return{amount:Number(K.amount)||0,paidAt:(De=K.paidAt)!=null&&De.toDate?K.paidAt.toDate():new Date(K.paidAt)}}):[]}});cs(D);try{localStorage.setItem(wr(),JSON.stringify(D))}catch{}}catch(D){console.warn("تعذر تحليل الديون من التحديثات الحية:",D)}},a=>{console.warn("خطأ في الاشتراك الحي لديون المستخدم:",a)});return()=>r()},[s==null?void 0:s.uid]);const yc=async()=>{if(s!=null&&s.uid){console.log("🔄 إعادة فحص حالة المستخدم...");try{await new Promise(r=>setTimeout(r,500));const t=await ra(Ge(de,"users",s.uid));if(t.exists()){const a=t.data().isActive===!0,l=await Ha.checkTrialValidity(s.uid),c=l.isValid&&!l.isExpired;console.log("📊 حالة المستخدم:",{isActive:a,isOnTrial:c,hoursRemaining:l.hoursRemaining}),Fe(a||c),it(c),St(l.hoursRemaining),Ht(l.hasUsedTrial),$e(!a&&!c),console.log("✅ تم تحديث حالة المستخدم بنجاح:",{userIsActive:a||c,isOnFreeTrial:c})}}catch(t){console.error("خطأ في إعادة فحص حالة المستخدم:",t)}}},vc=async()=>{console.log("🎉 تم بدء التجربة المجانية، إعادة فحص حالة المستخدم..."),await yc()},bc=async()=>{if(s!=null&&s.uid)try{Ss(!0);const t=await si(s.uid);Ns(t)}catch(t){console.error("خطأ في جلب بيانات الاشتراك:",t)}finally{Ss(!1)}},[ch,dh]=i.useState(!1),[wc,Dn]=i.useState(!1),[ot,Gt]=i.useState(0),[Te,Vt]=i.useState({}),[jc,Bi]=i.useState(!1),[Nc,$i]=i.useState(!1),[Sc,Cn]=i.useState(!1),[Dc,pr]=i.useState(!1),[Ui,In]=i.useState(""),[Cc,Ba]=i.useState(!1),[Ic,gr]=i.useState(!1),[An,fr]=i.useState(""),[Ac,Tn]=i.useState(!1),[yr,zi]=i.useState(""),[vr,qi]=i.useState(""),[br,Vi]=i.useState(""),[Ji,Ki]=i.useState(!1),ms=()=>`walletBalances_${(s==null?void 0:s.uid)||"default"}`,Ds=()=>`cashBalance_${(s==null?void 0:s.uid)||"default"}`,wr=()=>`debts_${(s==null?void 0:s.uid)||"default"}`,Tc=()=>`customers_${(s==null?void 0:s.uid)||"default"}`,Yi=()=>"debts_default",Pn=()=>`debts_last_write_${(s==null?void 0:s.uid)||"default"}`,kn=()=>`shopExpenses_${(A==null?void 0:A.shopId)||(s==null?void 0:s.uid)||"default"}`,Hi=()=>{try{const t=localStorage.getItem(kn());if(t){const r=JSON.parse(t);Ft(r.map(a=>({...a,createdAt:new Date(a.createdAt)})))}}catch(t){console.error("خطأ أثناء تحميل مصروفات المحل من التخزين:",t)}},Gi=async t=>{try{localStorage.setItem(kn(),JSON.stringify(t)),Ft(t)}catch(r){console.error("خطأ أثناء حفظ مصروفات المحل في التخزين:",r)}},Pc=async t=>{try{const r=wt.filter(a=>a.id!==t);await Gi(r);try{if(s!=null&&s.uid&&t){const{doc:a,deleteDoc:l}=await rt(async()=>{const{doc:x,deleteDoc:v}=await import("./index-Bp5r4OnK.js").then(w=>w.bf);return{doc:x,deleteDoc:v}},__vite__mapDeps([0,1]),import.meta.url),{db:c}=await rt(async()=>{const{db:x}=await import("./index-Bp5r4OnK.js").then(v=>v.bg);return{db:x}},__vite__mapDeps([0,1]),import.meta.url),h=a(c,"shop_expenses",t);await l(h)}}catch(a){console.warn("تعذر حذف المصروف من السحابة الآن، تم الحذف محليًا وسيبقى مخزّنًا دون هذا الإيصال:",a)}n({title:"تم الحذف",description:"تم حذف إيصال المصروف نهائيًا."})}catch(r){console.error("خطأ أثناء الحذف النهائي لإيصال المصروف:",r),n({title:"فشل الحذف",description:"تعذر حذف الإيصال. حاول مرة أخرى.",variant:"destructive"})}};_e.useEffect(()=>{let t;return(async()=>{try{if(!(s!=null&&s.uid)){Hi();return}const{collection:r,query:a,where:l,onSnapshot:c}=await rt(async()=>{const{collection:w,query:y,where:D,onSnapshot:T}=await import("./index-Bp5r4OnK.js").then($=>$.bf);return{collection:w,query:y,where:D,onSnapshot:T}},__vite__mapDeps([0,1]),import.meta.url),{db:h}=await rt(async()=>{const{db:w}=await import("./index-Bp5r4OnK.js").then(y=>y.bg);return{db:w}},__vite__mapDeps([0,1]),import.meta.url),x=A==null?void 0:A.shopId,v=x?a(r(h,"shop_expenses"),l("shopId","==",x)):a(r(h,"shop_expenses"),l("userId","==",s.uid));t=c(v,async w=>{const D=w.docs.map(T=>{var De;const $=T.data(),K=(De=$.createdAt)!=null&&De.toDate?$.createdAt.toDate():$.createdAt?new Date($.createdAt):new Date;return{id:T.id,name:String($.name||""),amount:Number($.amount||0),notes:$.notes?String($.notes):void 0,source:$.source==="wallet"?"wallet":"cash",walletId:$.walletId?String($.walletId):void 0,createdAt:K}}).sort((T,$)=>$.createdAt.getTime()-T.createdAt.getTime());Ft(D);try{localStorage.setItem(kn(),JSON.stringify(D))}catch{}})}catch(r){console.error("خطأ في مزامنة مصروفات المحل من Firestore:",r)}})(),()=>t==null?void 0:t()},[s==null?void 0:s.uid,A==null?void 0:A.shopId]);const jr=()=>`deficiencies_${(A==null?void 0:A.shopId)||(s==null?void 0:s.uid)||"default-shop"}`,kc=()=>{try{const t=jr(),r=`deficiencies_${(s==null?void 0:s.uid)||"default"}`;if(r!==t){const l=localStorage.getItem(r),c=localStorage.getItem(t);if(l)try{const h=JSON.parse(l)||[],x=c?JSON.parse(c):[],v=Array.isArray(x)?[...x]:[],w=(y,D)=>y.some(T=>(T==null?void 0:T.id)&&(D==null?void 0:D.id)&&String(T.id)===String(D.id)||String((T==null?void 0:T.name)||"")===String((D==null?void 0:D.name)||"")&&String((T==null?void 0:T.status)||"pending")===String((D==null?void 0:D.status)||"pending"));if(Array.isArray(h))for(const y of h)w(v,y)||v.push(y);localStorage.setItem(t,JSON.stringify(v));try{localStorage.removeItem(r)}catch{}}catch{}}const a=localStorage.getItem(t);if(a){const l=JSON.parse(a);ye(l.map(c=>({...c,createdAt:new Date(c.createdAt)})))}}catch(t){console.error("خطأ أثناء تحميل النواقص من التخزين:",t)}},On=async t=>{try{localStorage.setItem(jr(),JSON.stringify(t)),ye(t)}catch(r){console.error("خطأ أثناء حفظ النواقص في التخزين:",r)}};_e.useEffect(()=>{let t;return(async()=>{try{if(!(s!=null&&s.uid))return;const{collection:r,query:a,where:l,orderBy:c,onSnapshot:h}=await rt(async()=>{const{collection:y,query:D,where:T,orderBy:$,onSnapshot:K}=await import("./index-Bp5r4OnK.js").then(De=>De.bf);return{collection:y,query:D,where:T,orderBy:$,onSnapshot:K}},__vite__mapDeps([0,1]),import.meta.url),{db:x}=await rt(async()=>{const{db:y}=await import("./index-Bp5r4OnK.js").then(D=>D.bg);return{db:y}},__vite__mapDeps([0,1]),import.meta.url),v=(A==null?void 0:A.shopId)||s.uid||"default-shop",w=a(r(x,"deficiencies"),l("shopId","==",v),c("createdAt","desc"));t=h(w,async y=>{const D=y.docs.map(T=>{var De;const $=T.data(),K=(De=$.createdAt)!=null&&De.toDate?$.createdAt.toDate():$.createdAt?new Date($.createdAt):new Date;return{id:T.id,name:String($.name||""),quantity:Number($.quantity||1),status:$.status==="purchased"?"purchased":"pending",createdAt:K}});ye(D);try{localStorage.setItem(jr(),JSON.stringify(D))}catch{}},y=>{console.warn("فشل الاشتراك في النواقص من Firestore:",y)})}catch(r){console.warn("فشل إعداد مزامنة النواقص من Firestore:",r)}})(),()=>{try{t&&t()}catch{}}},[s==null?void 0:s.uid,A==null?void 0:A.shopId]);const Oc=async t=>{try{localStorage.setItem(Tc(),JSON.stringify(t)),yn(t),s!=null&&s.uid&&await Ce.updateUserData(s.uid,{customers:t})}catch(r){console.error("خطأ أثناء حفظ العملاء في التخزين:",r)}},Ec=async()=>{try{if(s!=null&&s.uid){const t=await ra(Ge(de,"users",s.uid));if(t.exists()){const r=t.data();if(r.customers&&Array.isArray(r.customers)){const a=r.customers.map(l=>{var c;return{...l,createdAt:(c=l.createdAt)!=null&&c.toDate?l.createdAt.toDate():new Date(l.createdAt)}});yn(a);return}}}yn([])}catch(t){console.error("خطأ أثناء تحميل العملاء من Firestore:",t)}},Nr=()=>`transactions_${(s==null?void 0:s.uid)||"default"}`,En=()=>`wallets_${(s==null?void 0:s.uid)||"default"}`,Wn=()=>`selectedWallet_${(s==null?void 0:s.uid)||"default"}`,[_n,Sr]=i.useState(""),[hs,Qi]=i.useState(""),ks=_e.useMemo(()=>{const t=Ct;if(!t)return!1;const r=vd(t),a=t.planType??t.plan??null,l=typeof a=="string"?a.toLowerCase():null,c=l==="monthly"||l==="quarterly"||l==="yearly"||l==="lifetime"||a===Os.MONTHLY||a===Os.QUARTERLY||a===Os.YEARLY||a===Os.LIFETIME;return r&&c},[Ct]),Ze=_e.useMemo(()=>{const t=Ct;if(!t)return!1;const r=t.planType??t.plan??null,a=typeof r=="string"?r.toLowerCase():null;return r===Os.ZERO||a==="zero"},[Ct]),Wc=()=>{if(!ks){n({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}C(!0)},[mh,hh]=i.useState(!1),[_c,Fc]=i.useState(!1),[Mc,Lc]=i.useState(!1),[Rc,Bc]=i.useState(!1),[$c,Dr]=i.useState(!1),[Cr,Fn]=i.useState(""),[Mn,Ln]=i.useState(""),[Zi,Xi]=i.useState(!1),[Uc,el]=i.useState(!1),[uh,xh]=i.useState(!1),[zc,Ir]=i.useState(!1),[tl,Rn]=i.useState(""),[sl,Bn]=i.useState(""),[al,rl]=i.useState(!1),nl=async()=>{if(s!=null&&s.uid)try{const t=`userData_${s.uid}`,r=localStorage.getItem(t),a=`debts_unsynced_${s.uid}`,l=localStorage.getItem(wr()),c=localStorage.getItem(a)==="true";if(r){const h=JSON.parse(r);console.log("🔄 مزامنة البيانات المحلية مع Firebase...",h);const x={lastSynced:new Date().toISOString()};typeof h.cashBalance=="number"&&(x.cashBalance=h.cashBalance),h.walletBalances&&typeof h.walletBalances=="object"&&(x.walletBalances=h.walletBalances),await Ce.updateUserData(s.uid,x),localStorage.removeItem(t),Ne(!1),console.log("✅ تمت المزامنة بنجاح وحذف البيانات المحلية")}else console.log("لا توجد بيانات محلية تحتاج للمزامنة");if(c&&l)try{const h=JSON.parse(l)||[];await Ce.updateUserData(s.uid,{debts:h});try{localStorage.removeItem(a)}catch{}Ne(!1),console.log("✅ تمت مزامنة الديون مع Firebase")}catch(h){console.error("❌ فشل مزامنة الديون:",h),Ne(!0)}}catch(t){console.error("❌ فشل في مزامنة البيانات:",t),n({title:"فشل في المزامنة",description:"حدث خطأ أثناء مزامنة البيانات مع الخادم",variant:"destructive"})}},[Sa,Ar]=i.useState({keepLastCount:20,intervalDays:7,lastResetAt:null});i.useEffect(()=>{(async()=>{if(s!=null&&s.uid)try{const r=await Ce.getUserData(s.uid),a=(r==null?void 0:r.recentReset)||{},l=Number(a==null?void 0:a.keepLastCount)>0?Number(a.keepLastCount):20,c=Number(a==null?void 0:a.intervalDays)>0?Number(a.intervalDays):7,h=y=>y instanceof Date?y:typeof(y==null?void 0:y.toDate)=="function"?y.toDate():y?new Date(String(y)):null,x=a!=null&&a.lastResetAt?h(a.lastResetAt):null,v=new Date;!x||v.getTime()-x.getTime()>=c*24*60*60*1e3?(await Ce.updateUserData(s.uid,{recentReset:{keepLastCount:l,intervalDays:c,lastResetAt:v}}),Ar({keepLastCount:l,intervalDays:c,lastResetAt:v})):Ar({keepLastCount:l,intervalDays:c,lastResetAt:x})}catch{Ar({keepLastCount:20,intervalDays:7,lastResetAt:null})}})()},[s==null?void 0:s.uid]);const il=_e.useMemo(()=>{const t=Qe||[],r=Sa.keepLastCount??20;return[...t].sort((l,c)=>{const h=x=>x instanceof Date?x:typeof(x==null?void 0:x.toDate)=="function"?x.toDate():new Date(String(x));return h(c.createdAt).getTime()-h(l.createdAt).getTime()}).slice(0,r)},[Qe,Sa.keepLastCount]),qc=_e.useMemo(()=>Math.max(0,((Qe==null?void 0:Qe.length)||0)-(Sa.keepLastCount||20)),[Qe==null?void 0:Qe.length,Sa.keepLastCount]),ll=_e.useCallback(()=>{let t=il;const r=gi.trim();if(r&&(t=t.filter(a=>a.senderPhone&&a.senderPhone.includes(r)||a.receiverPhone&&a.receiverPhone.includes(r))),ir){const a=new Date(ir);t=t.filter(l=>{const c=new Date(l.createdAt);if(lr){const[h,x]=lr.split(":"),v=new Date(a);v.setHours(parseInt(h),parseInt(x),0,0);const w=new Date(v);return w.setHours(w.getHours()+1),c>=v&&c<w}else return c.toDateString()===a.toDateString()})}try{t=[...t].sort((a,l)=>{const c=new Date(a.createdAt||0).getTime();return new Date(l.createdAt||0).getTime()-c})}catch{}return t},[il,gi,ir,lr]),[Vc,Tr]=i.useState(!1),[ol,Pr]=i.useState(""),[Jc,kr]=i.useState(!1),[$n,Un]=i.useState(""),[Kc,Ne]=i.useState(!1);Ae.reduce((t,r)=>t+(Te[r.id]||0),0);const Yc=async t=>await Xt.verifyMasterPin(t,s==null?void 0:s.uid),zn=async t=>await Xt.verifyMasterPin(t,s==null?void 0:s.uid);i.useEffect(()=>{if(!(s!=null&&s.uid))return;console.log("🚀 استعادة البيانات من localStorage عند تحميل الصفحة للمستخدم:",s.uid);const t=`walletBalances_${s.uid}`,r=localStorage.getItem(t);if(r)try{const c=JSON.parse(r);console.log("📱 استعادة أرصدة المحافظ من localStorage:",c),Vt(c)}catch(c){console.error("خطأ في قراءة أرصدة المحافظ من localStorage:",c)}const a=`cashBalance_${s.uid}`;let l=localStorage.getItem(a);if(!l){const c=`userCashBalance_${s.uid}`,h=localStorage.getItem(c);if(h){l=h;try{localStorage.setItem(a,h),localStorage.removeItem(c)}catch{}}}if(l){const c=parseFloat(l);console.log("💰 استعادة رصيد الدرج النقدي من localStorage:",c),Gt(c)}},[s==null?void 0:s.uid]);const cl=async()=>{try{if(!G)return;const t=await Ts.autoResetLimitsIfNeeded(G);gc(t)}catch(t){console.error("خطأ في جلب حدود المحفظة المختارة:",t)}};i.useEffect(()=>{cl()},[G]),i.useEffect(()=>{const t=r=>{var a;(a=r==null?void 0:r.detail)!=null&&a.walletId&&r.detail.walletId===G&&cl()};return window.addEventListener("walletLimitsUpdated",t),()=>window.removeEventListener("walletLimitsUpdated",t)},[G]),i.useEffect(()=>{if(b.state){if(console.log("Location state:",b.state),b.state.openDebtDialog&&(gn(),window.history.replaceState({},document.title)),b.state.openSalesDialog&&(Ze?n({title:"غير متاح",description:"بيانات المبيعات غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ta(!0),window.history.replaceState({},document.title)),b.state.openMaintenanceDialog&&(Ze?n({title:"غير متاح",description:"الصيانة غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):cr(!0),window.history.replaceState({},document.title)),b.state.openCreditCardsDialog&&(console.log("Opening credit cards dialog"),Ze?n({title:"غير متاح",description:"كروت الائتمان غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):or(!0),window.history.replaceState({},document.title)),b.state.openShopExpensesDialog&&(Ze?n({title:"غير متاح",description:"مصروفات المحل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Xt.hasMasterPin()?ie(!0):Se(!0),window.history.replaceState({},document.title)),b.state.openDeficienciesDialog&&(Ze?n({title:"غير متاح",description:"النواقص غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):tt(!0),window.history.replaceState({},document.title)),b.state.openTransactionSection){const t=document.getElementById("transaction-section");t&&t.scrollIntoView({behavior:"smooth"}),b.state.transactionType&&li(b.state.transactionType),b.state.startNewTransaction&&(Ps(""),ys(""),Gr(""),Qr(""),console.log("🔒 Starting new transaction without changing wallet selection")),b.state.focusWalletSelection&&setTimeout(()=>{const r=document.querySelector('[data-testid="wallet-select"]');r&&r.focus()},500),window.history.replaceState({},document.title)}b.state.openCashierShiftModal&&(ks?C(!0):n({title:"غير متاح",description:"وردية الكاشير متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"}),window.history.replaceState({},document.title)),b.state.openMachineDailyDialog&&(ks?dr(!0):n({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"}),window.history.replaceState({},document.title))}},[b.state,Ae]),i.useEffect(()=>{b.pathname==="/user/dashboard"&&sessionStorage.getItem("previousPath")==="/user/add-wallet"&&(console.log("🔄 Returned from wallet addition page - reloading wallets"),Or(),sessionStorage.removeItem("previousPath")),sessionStorage.setItem("previousPath",b.pathname)},[b.pathname,s==null?void 0:s.uid]),i.useEffect(()=>{if(!(s!=null&&s.uid))return;console.log("🔥 Setting up real-time user activation listener for:",s.uid);const t=Ge(de,"users",s.uid),r=ua(t,a=>{if(a.exists()){const l=a.data(),c=l.isActive===!0;console.log("🔥 Real-time user status update:",{userId:s.uid,isActive:c,subscription:l.subscription}),c&&!ge?(console.log("🎉 User activated! Redirecting to dashboard..."),Fe(!0),$e(!1),J(!1)):!c&&ge&&(console.log("❌ User deactivated! Showing activation modal..."),Fe(!1),$e(!0))}},a=>{console.error("❌ Error in real-time user listener:",a)});return()=>{console.log("🔥 Cleaning up real-time user listener"),r()}},[s==null?void 0:s.uid,ge]),i.useEffect(()=>{if(!(s!=null&&s.uid))return;const t=a=>{const{userId:l}=a.detail;l===s.uid&&(console.log("🎉 Subscription activation event received for current user!"),Fe(!0),$e(!1),J(!1),setTimeout(()=>{console.log("✅ User activation completed - data updated")},1e3))},r=a=>{const{userId:l,isActive:c}=a.detail;l===s.uid&&(console.log("🔄 User subscription update event received:",{userId:l,isActive:c}),c&&!ge&&(Fe(!0),$e(!1),J(!1),setTimeout(()=>{console.log("✅ User subscription updated - data refreshed")},1e3)))};return window.addEventListener("subscriptionActivated",t),window.addEventListener("userSubscriptionUpdated",r),()=>{window.removeEventListener("subscriptionActivated",t),window.removeEventListener("userSubscriptionUpdated",r)}},[s==null?void 0:s.uid,ge]),i.useEffect(()=>{const t=r=>{var h;const a=r.target,l=(h=a==null?void 0:a.tagName)==null?void 0:h.toLowerCase();if(!(l==="input"||l==="textarea"||l==="select"||((a==null?void 0:a.isContentEditable)??!1))&&!(r.ctrlKey||r.altKey||r.metaKey)&&!r.repeat){if(Ze&&r.key>="1"&&r.key<="9"){r.preventDefault();return}switch(r.key){case"1":break;case"2":ln(!0);break;case"3":Ze?n({title:"غير متاح",description:"كروت الائتمان غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):or(!0);break;case"4":ks?C(!0):n({title:"غير متاح",description:"وردية الكاشير متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});break;case"5":Ze?n({title:"غير متاح",description:"بيانات المبيعات غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ta(!0);break;case"6":gn();break;case"7":Ze?n({title:"غير متاح",description:"الصيانة غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):cr(!0);break;case"8":ks?dr(!0):n({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});break;case"9":Ze?n({title:"غير متاح",description:"مصروفات المحل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Xt.hasMasterPin()?ie(!0):Se(!0);break}}};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[Ze,ks]),i.useEffect(()=>{console.log("🔥 useEffect loadUserData started",{user:s==null?void 0:s.uid,isCheckingActivation:Oe}),(async()=>{try{if(!(s!=null&&s.uid)){console.log("🔥 No user UID, setting isCheckingActivation to false"),J(!1);return}try{const h=await ra(Ge(de,"users",s.uid));if(h.exists()){const v=h.data().isActive===!0,w=await Ha.checkTrialValidity(s.uid),y=w.isValid&&!w.isExpired;Fe(v||y),it(y),St(w.hoursRemaining),Ht(w.hasUsedTrial),$e(!v&&!y),console.log("📊 حالة المستخدم:",{isActive:v,isOnTrial:y,hoursRemaining:w.hoursRemaining,hasUsedTrial:w.hasUsedTrial})}else Fe(!1),$e(!0)}catch(h){console.error("خطأ في فحص حالة تفعيل المستخدم:",h),Fe(!1),$e(!0)}finally{J(!1)}if(console.log("🔄 بدء تحميل بيانات المستخدم من Firebase...",{userId:s==null?void 0:s.uid}),s!=null&&s.uid){const h=await Ce.getUserData(s.uid);if(console.log("📥 البيانات المحملة من Firebase:",h),h){const x=(h==null?void 0:h.walletBalances)||{};console.log("🏛️ اعتماد Firebase كمصدر الحقيقة لأرصدة المحافظ"),Vt(x),(h==null?void 0:h.cashBalance)!==void 0&&(console.log("💰 تحميل رصيد الدرج النقدي من Firebase:",h.cashBalance),Gt(h.cashBalance));try{const v=s!=null&&s.uid?await Fr.getDeletedTransactionsByUser(s.uid):[];Oa(v||[]),console.log("🗑️ تم تحميل المعاملات المحذوفة من Firebase:",(v==null?void 0:v.length)||0)}catch(v){console.error("خطأ في تحميل المعاملات المحذوفة من Firebase:",v),Oa([])}}else{console.log("⚠️ لا توجد بيانات مستخدم في Firebase، سيتم استخدام قيم افتراضية بدون localStorage"),Vt({});try{const x=s!=null&&s.uid?await Fr.getDeletedTransactionsByUser(s.uid):[];Oa(x||[])}catch{Oa([])}}}console.log("🔄 بدء تحميل المحافظ من Firebase...");try{const h=await Es.getByMerchantId((s==null?void 0:s.uid)||"");if(h&&h.length>0){console.log("✅ تم العثور على محافظ في Firebase:",h.length);const x=h.map(y=>({id:y.id,name:y.label||"محفظة بدون اسم",phone:y.msisdn,isDefault:!1,monthlyWithdrawalLimit:y.monthlyWithdrawalLimit??y.withdrawLimit??2e5,monthlyTransferLimit:y.monthlyTransferLimit??y.transferLimit??2e5,defaultTransferCommission:y.defaultTransferCommission!=null?Number(y.defaultTransferCommission):null,defaultWithdrawCommission:y.defaultWithdrawCommission!=null?Number(y.defaultWithdrawCommission):null}));Pa(x);const v=localStorage.getItem(Wn());let w=null;v&&x.find(y=>y.id===v)?w=x.find(y=>y.id===v):w=x[0],w&&(tn(w.id),Fs(w.phone)),console.log("🔄 تم تحديث المحافظ من Firebase وحفظها في localStorage")}else console.log("⚠️ لا توجد محافظ في Firebase. سيتم عرض قائمة فارغة بدون أي استرجاع محلي."),Pa([])}catch(h){console.error("خطأ في تحميل المحافظ من Firebase:",h),Pa([])}const c=s!=null&&s.uid?await Ce.getUserTransactions(s.uid):[];if(c&&c.length>0){console.log("📊 تم تحميل المعاملات من Firebase:",c.length);const h=c.map(w=>({...w,createdAt:new Date(w.createdAt),senderPhone:w.senderMsisdn||w.senderPhone||"",receiverPhone:w.receiverMsisdn||w.receiverPhone||"",type:w.txnType==="send"?"send":w.txnType==="receive"?"withdraw":w.type||"withdraw",status:w.status==="confirmed"?"completed":w.status||"completed"})),x=xi.map(w=>w.id||w.originalTransactionId),v=h.filter(w=>!x.includes(w.id));console.log("✅ تم فلترة المعاملات المحذوفة:",{total:c.length,deleted:x.length,active:v.length});{const w=T=>{var $;return String((T==null?void 0:T.reference)||(T==null?void 0:T.transactionReference)||(($=T==null?void 0:T.receipt)==null?void 0:$.reference)||(T==null?void 0:T.id))},y=new Map;for(const T of v){const $=w(T),K=y.get($);if(!K)y.set($,T);else{const De=()=>{if((T==null?void 0:T.status)==="completed"&&(K==null?void 0:K.status)!=="completed")return T;if((K==null?void 0:K.status)==="completed"&&(T==null?void 0:T.status)!=="completed")return K;const At=new Date((T==null?void 0:T.createdAt)||0).getTime(),Ot=new Date((K==null?void 0:K.createdAt)||0).getTime();return At>=Ot?T:K};y.set($,De())}}const D=Array.from(y.values());Hs(D);try{localStorage.setItem(Nr(),JSON.stringify(D))}catch(T){console.warn("تعذر حفظ المعاملات في التخزين المحلي بعد التحميل من Firebase:",T)}}}await nl()}catch(c){console.error("خطأ في تحميل بيانات المستخدم من Firebase:",c)}})().then(async()=>{await l(),await r(),await a()});const r=async()=>{try{if(!(s!=null&&s.uid))return;const c=await Es.getByMerchantId(s.uid);await Promise.all(c.map(h=>gm.autoResetLimitsIfNeeded(h.id)))}catch(c){console.error("خطأ في التصفير التلقائي للحدود:",c)}},a=async()=>{try{await Qt.syncReportsDataFromFirebase(s==null?void 0:s.uid);const c=Qt.getReportsData(s==null?void 0:s.uid);if((c.lastDailyResetDate?Qt.shouldResetDailyReports(c.lastDailyResetDate):!1)&&(s!=null&&s.uid)&&c.lastDailyResetDate){const v=new Date(c.lastDailyResetDate),w=v.toDateString();let y=Qe.filter(Tt=>new Date(Tt.createdAt).toDateString()===w&&Tt.status==="completed");const D=Qt.filterVisibleTransactions(y,"daily",s==null?void 0:s.uid),T=D.length,$=D.reduce((Tt,Xe)=>Tt+Xe.amount,0),K=D.filter(Ua).reduce((Tt,Xe)=>{const ws=Xe.withdrawnAmount!==void 0?Xe.withdrawnAmount:Xe.amount;return Tt+ws},0),De=D.filter(za).reduce((Tt,Xe)=>{const ws=Xe.sentAmount!==void 0?Xe.sentAmount:Xe.amount;return Tt+ws},0),At=D.reduce((Tt,Xe)=>Tt+Qt.calculateTransactionProfit(Xe),0),Ot=new Date(v).toISOString().slice(0,10);await zl.add({userId:s.uid,reportDate:Ot,totalTransactions:T,totalAmount:Number($.toFixed(2)),totalWithdrawn:Number(K.toFixed(2)),totalSent:Number(De.toFixed(2)),profit:Number(At.toFixed(2)),walletId:null})}const x=Qt.autoResetReportsIfNeeded(s==null?void 0:s.uid);(x.dailyReset||x.monthlyReset)&&console.log("تم التصفير التلقائي:",x)}catch(c){console.error("خطأ في التصفير التلقائي للتقارير:",c)}},l=async()=>{try{if(!(s!=null&&s.uid))return;const c=new Date;if(c.getDate()!==1)return;const h=`${c.getFullYear()}-${c.getMonth()+1}`,x=`lastMonthlyDbCleanup:${s.uid}`;if(localStorage.getItem(x)===h)return;const w=new Date(c.getFullYear(),c.getMonth(),1,0,0,0,0),y=$=>$ instanceof Date?$:typeof($==null?void 0:$.toDate)=="function"?$.toDate():new Date(String($));let D=[];try{const $=Bt(et(de,"userTransactions"),Le("userId","==",s.uid),Le("createdAt","<",w));D=(await es($)).docs}catch{const $=Bt(et(de,"userTransactions"),Le("userId","==",s.uid));D=(await es($)).docs.filter(De=>{var At;return y((At=De.data())==null?void 0:At.createdAt)<w})}await Promise.allSettled(D.map($=>Ga($.ref)));let T=[];try{const $=Bt(et(de,"transactions"),Le("userId","==",s.uid),Le("createdAt","<",w));T=(await es($)).docs}catch{const $=Bt(et(de,"transactions"),Le("userId","==",s.uid));T=(await es($)).docs.filter(De=>{var At;return y((At=De.data())==null?void 0:At.createdAt)<w})}await Promise.allSettled(T.map($=>Ga($.ref)));try{localStorage.setItem(x,h)}catch{}console.log("✅ تم تنظيف قاعدة البيانات شهريًا (Firebase فقط):",{userTransactionsDeleted:D.length,globalTransactionsDeleted:T.length,monthStart:w})}catch(c){console.error("فشل التنظيف الشهري التلقائي لقاعدة البيانات:",c)}};bc(),fc(),Ec(),console.log("🔥 useEffect loadUserData completed")},[s==null?void 0:s.uid]);const Or=async()=>{var t;if(s!=null&&s.uid)try{const r=await Es.getByMerchantId(s.uid);if(r&&r.length>0){const a=r.map(l=>({id:l.id,name:l.label||"محفظة بدون اسم",phone:l.msisdn,isDefault:!1,monthlyWithdrawalLimit:l.monthlyWithdrawalLimit??l.withdrawLimit??2e5,monthlyTransferLimit:l.monthlyTransferLimit??l.transferLimit??2e5,defaultTransferCommission:l.defaultTransferCommission!=null?Number(l.defaultTransferCommission):void 0,defaultWithdrawCommission:l.defaultWithdrawCommission!=null?Number(l.defaultWithdrawCommission):void 0}));if(Pa(a),s!=null&&s.uid){const l=localStorage.getItem(Wn());if(!!(G&&a.find(h=>h.id===G)))console.log("🔒 Preserving current wallet selection:",G);else{const x=(l&&a.find(v=>v.id===l)?l:null)||((t=a[0])==null?void 0:t.id);x&&(console.log("🔄 Fixing invalid wallet selection:",x),$a(x))}}console.log("🔄 تم تحديث المحافظ من Firebase:",a.length)}}catch(r){console.error("خطأ في تحميل المحافظ من Firebase:",r)}};i.useEffect(()=>{const t=b.pathname;sessionStorage.getItem("previousPath")==="/user/add-wallet"&&t==="/user/dashboard"&&(console.log("🔄 Returning from add wallet page - reloading wallets"),console.log("🔒 Current wallet before add-wallet return reload:",G),Or(),sessionStorage.removeItem("previousPath")),sessionStorage.setItem("previousPath",t)},[b.pathname,s==null?void 0:s.uid]),i.useEffect(()=>{const t=()=>{console.log("🔄 Window focused - reloading wallets"),console.log("🔒 Current wallet before focus reload:",G),Or().then(()=>{console.log("🔒 Wallet preserved after focus reload:",G)})};return window.addEventListener("focus",t),()=>{window.removeEventListener("focus",t)}},[s==null?void 0:s.uid,G,Ae]);const $a=(t,r="unknown")=>{console.log(`🎯 setWalletSelection called from ${r} with walletId:`,t),console.log("🔍 Previous selectedWallet:",G),tn(t);const a=Ae.find(l=>l.id===t);a&&(Fs(a.phone),console.log("✅ Wallet set successfully:",t,"Phone:",a.phone)),s!=null&&s.uid&&(localStorage.setItem(Wn(),t),console.log("💾 Saved wallet to localStorage:",t))},Hc=t=>{if(t==="__add_wallet"){I("/user/add-wallet");return}if(t==="__view_wallets"){as(!0);return}em.isEnabled(s==null?void 0:s.uid)?(Hr(t),ya(!0)):$a(t,"walletSelectionNoPin")},Er=t=>{console.log("🔄 handleTransactionTypeChange called with type:",t),console.log("🔍 Current selectedWallet before change:",G),console.log("🔍 Available wallets count:",Ae.length),li(t),Ps(""),ys(""),Gr(""),Qr(""),console.log("✅ Transaction type changed to:",t,"- Wallet selection preserved:",G),setTimeout(()=>{const r=document.getElementById("transaction-section");r&&r.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})},100)};i.useEffect(()=>{const t=r=>{const a=r.target;if(!!a&&(a.tagName==="INPUT"||a.tagName==="TEXTAREA"||a.tagName==="SELECT"||a.isContentEditable)||(r.key==="ArrowLeft"?(r.preventDefault(),Er("withdraw")):r.key==="ArrowRight"&&(r.preventDefault(),Er("transfer"))),r.key==="Enter"){const c=re==="transfer"?"transferSubmitButton":"withdrawSubmitButton",h=document.getElementById(c);h&&!h.disabled&&(r.preventDefault(),h.click())}};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[re]);const dl=t=>{Fo((a=>({id:a.id,type:a.type==="send"?"transfer":"withdraw",sender_msisdn:a.senderPhone,receiver_msisdn:a.receiverPhone,amount:a.amount,commission:a.commission||0,fee:(a==null?void 0:a.fee)??0,status:a.status==="failed"?"failed":a.status==="completed"?"completed":"pending",createdAt:new Date(a.createdAt).toISOString(),updatedAt:new Date(a.createdAt).toISOString(),shopName:P??(A==null?void 0:A.shopName)??(s==null?void 0:s.displayName)??"المحل",cashierName:(a==null?void 0:a.cashierName)??null,commissionMode:(a==null?void 0:a.commissionMode)??(a.type==="send"||Ke?"add":"deduct"),totalCharged:(a==null?void 0:a.totalCharged)??(a.type==="send"?Number(a.amount||0)+Number(a.commission||0)+Number((a==null?void 0:a.fee)||0):Ke?Number(a.amount||0)+Number(a.commission||0):Number(a.amount||0)),note:(a==null?void 0:a.note)??(a==null?void 0:a.notes)??void 0}))(t)),nr(!0)},Gc=async t=>{if(!(s!=null&&s.uid)){n({title:"خطأ في المصادقة",description:"يجب تسجيل الدخول أولاً لحذف المعاملات",variant:"destructive"});return}const r=Qe.find(a=>a.id===t);if(!r){n({title:"خطأ في الحذف",description:"لم يتم العثور على المعاملة المطلوب حذفها",variant:"destructive"});return}try{console.log("🗑️ بدء عملية حذف المعاملة:",t),console.log("🔄 حذف المعاملة نهائياً من Firebase...",{transactionId:r.id,userId:s.uid,transactionData:r}),await Ce.removeUserTransaction(s.uid,r.id),console.log("✅ تم حذف المعاملة نهائياً من Firebase userTransactions");try{await Fr.saveDeletedTransaction({...r,userId:s.uid,originalTransactionId:r.id,deletedAt:new Date().toISOString()}),console.log("✅ تم حفظ المعاملة في سجل المحذوفات مع تاريخ الحذف")}catch(c){console.warn("⚠️ فشل في حفظ المعاملة في سجل المحذوفات، لكن الحذف من Firebase نجح:",c)}const a=[...xi,r],l=Qe.filter(c=>c.id!==t);Oa(a),Hs(l),mi(!1),console.log("✅ تم تحديث الحالة بعد الحذف من Firebase (بدون نسخ محلية)");try{const c=r.fromWallet;if(c){const{walletDailyLimitsService:h}=await rt(async()=>{const{walletDailyLimitsService:v}=await import("./walletDailyLimitsService-DOXQzrXL.js");return{walletDailyLimitsService:v}},__vite__mapDeps([3,0,1]),import.meta.url),x=await h.getWalletLimits(c);if(x){const v=r.type==="send",w={updatedAt:(await rt(async()=>{const{serverTimestamp:K}=await import("./index-Bp5r4OnK.js").then(De=>De.bf);return{serverTimestamp:K}},__vite__mapDeps([0,1]),import.meta.url)).serverTimestamp()};v?(w.dailyTransferUsed=Math.max(0,(x.dailyTransferUsed||0)-r.amount),w.monthlyTransferUsed=Math.max(0,(x.monthlyTransferUsed||0)-r.amount)):(w.dailyWithdrawUsed=Math.max(0,(x.dailyWithdrawUsed||0)-r.amount),w.monthlyWithdrawUsed=Math.max(0,(x.monthlyWithdrawUsed||0)-r.amount));const{doc:y,setDoc:D}=await rt(async()=>{const{doc:K,setDoc:De}=await import("./index-Bp5r4OnK.js").then(At=>At.bf);return{doc:K,setDoc:De}},__vite__mapDeps([0,1]),import.meta.url),{db:T}=await rt(async()=>{const{db:K}=await import("./index-Bp5r4OnK.js").then(De=>De.bg);return{db:K}},__vite__mapDeps([0,1]),import.meta.url),$=y(T,"walletLimits",c);await D($,w,{merge:!0})}}}catch(c){console.warn("فشل استرجاع حدود المحفظة بعد الحذف:",c)}try{const{ProfitService:c}=await rt(async()=>{const{ProfitService:y}=await import("./profitService-vyye6JvC.js").then(D=>D.p);return{ProfitService:y}},__vite__mapDeps([4,0,1]),import.meta.url),{ReportsService:h}=await rt(async()=>{const{ReportsService:y}=await import("./profitService-vyye6JvC.js").then(D=>D.a);return{ReportsService:y}},__vite__mapDeps([4,0,1]),import.meta.url),v={txnType:r.type==="send"?"send":"receive",amount:r.amount,commission:r.commission||0,createdAt:r.createdAt,status:"confirmed"},w=c.calculateProfitFromTransaction(v);w>0&&c.addProfit(-w,s.uid);try{h.removeTransactionEffects(r,s.uid)}catch{}}catch(c){console.warn("فشل تحديث الأرباح/التقارير بعد الحذف:",c)}n({title:"تم حذف المعاملة نهائياً",description:"تم حذف المعاملة نهائياً من النظام. يمكنك العثور عليها في قائمة المحذوفات"})}catch(a){console.error("❌ خطأ في حذف المعاملة من Firebase:",a);let l="فشل في حذف المعاملة من الخادم. يرجى المحاولة مرة أخرى";a instanceof Error&&(a.message.includes("network")||a.message.includes("offline")?l="مشكلة في الاتصال بالإنترنت. تحقق من الاتصال وحاول مرة أخرى":a.message.includes("permission")||a.message.includes("unauthorized")?l="ليس لديك صلاحية لحذف هذه المعاملة":a.message.includes("not-found")&&(l="المعاملة غير موجودة أو تم حذفها مسبقاً")),n({title:"خطأ في الحذف",description:l,variant:"destructive"})}},Ua=t=>{const r=t.type,a=t.txnType;return r==="withdraw"||r==="withdrawal"||r==="receive"||a==="receive"},za=t=>{const r=t.type,a=t.txnType;return r==="send"||r==="transfer"||a==="send"},qa=(t,r)=>{const a=new Date().toDateString();let l=Qe.filter(y=>new Date(y.createdAt).toDateString()===a&&y.status==="completed");Ls&&Ls.trim()!==""&&(l=l.filter(y=>y.senderPhone&&y.senderPhone.includes(Ls)||y.receiverPhone&&y.receiverPhone.includes(Ls)));const c=Qt.filterVisibleTransactions(l,"daily",s==null?void 0:s.uid),h=c.length,x=c.reduce((y,D)=>y+D.amount,0),v=c.filter(Ua).reduce((y,D)=>{const T=D.withdrawnAmount!==void 0?D.withdrawnAmount:D.amount;return y+T},0),w=c.filter(za).reduce((y,D)=>{const T=D.sentAmount!==void 0?D.sentAmount:D.amount;return y+T},0);return{totalTransactions:h,totalAmount:x,totalWithdrawn:v,totalSent:w}},Va=t=>{const r=new Date().getMonth(),a=new Date().getFullYear();let l=Qe.filter(y=>{const D=new Date(y.createdAt);return D.getMonth()===r&&D.getFullYear()===a&&y.status==="completed"});Ls&&Ls.trim()!==""&&(l=l.filter(y=>y.senderPhone&&y.senderPhone.includes(Ls)||y.receiverPhone&&y.receiverPhone.includes(Ls)));const c=Qt.filterVisibleTransactions(l,"monthly",s==null?void 0:s.uid),h=c.length,x=c.reduce((y,D)=>y+D.amount,0),v=c.filter(Ua).reduce((y,D)=>{const T=D.withdrawnAmount!==void 0?D.withdrawnAmount:D.amount;return y+T},0),w=c.filter(za).reduce((y,D)=>{const T=D.sentAmount!==void 0?D.sentAmount:D.amount;return y+T},0);return{totalTransactions:h,totalAmount:x,totalWithdrawn:v,totalSent:w}},Qc=t=>{const r=new Date().getMonth(),a=new Date().getFullYear(),l=Qe.filter(x=>{const v=new Date(x.createdAt);return v.getMonth()===r&&v.getFullYear()===a&&x.status==="completed"&&x.fromWallet===t}),c=l.filter(Ua).reduce((x,v)=>{const w=v.withdrawnAmount||v.amount;return x+w},0),h=l.filter(za).reduce((x,v)=>{const w=v.sentAmount||v.amount;return x+w},0);return{totalWithdrawn:c,totalTransferred:h}},Zc=t=>{const r=new Date,a=r.getDate(),l=r.getMonth(),c=r.getFullYear(),h=Qe.filter(w=>{const y=new Date(w.createdAt);return y.getDate()===a&&y.getMonth()===l&&y.getFullYear()===c&&w.status==="completed"&&w.fromWallet===t}),x=h.filter(Ua).reduce((w,y)=>{const D=y.withdrawnAmount||y.amount;return w+D},0),v=h.filter(za).reduce((w,y)=>{const D=y.sentAmount||y.amount;return w+D},0);return{totalWithdrawn:x,totalTransferred:v}},ml=_e.useMemo(()=>Va(),[Qe,G,Ls]);ml.totalWithdrawn,ml.totalSent;const Bs=_e.useMemo(()=>Qc(G),[Qe,G]);i.useEffect(()=>{try{if(!G||Ae.length===0)return;const t=Ae.find(K=>K.id===G);if(!t)return;const r=(We==null?void 0:We.monthlyWithdrawLimit)??(t==null?void 0:t.monthlyWithdrawalLimit)??2e5,a=(We==null?void 0:We.monthlyTransferLimit)??(t==null?void 0:t.monthlyTransferLimit)??2e5,l=parseFloat(gt||"0")||0,c=(Bs==null?void 0:Bs.totalWithdrawn)??(We==null?void 0:We.monthlyWithdrawUsed)??0,h=(Bs==null?void 0:Bs.totalTransferred)??(We==null?void 0:We.monthlyTransferUsed)??0,x=c+(re==="withdraw"?l:0),v=h+(re==="transfer"?l:0),w=.85,y=Math.floor(Math.max(r,1)*w),D=Math.floor(Math.max(a,1)*w),T=(()=>{const K=new Date;return`${K.getFullYear()}-${String(K.getMonth()+1).padStart(2,"0")}`})(),$=`monthlyLimitWarnShown:${G}:${T}`;if(x>=y){const K=`${$}:withdraw`;if(!(localStorage.getItem(K)==="true")){ii({type:"withdraw",used:x,limit:r,walletName:t.name}),sr(!0);try{localStorage.setItem(K,"true")}catch{}return}}if(v>=D){const K=`${$}:transfer`;if(!(localStorage.getItem(K)==="true")){ii({type:"transfer",used:v,limit:a,walletName:t.name}),sr(!0);try{localStorage.setItem(K,"true")}catch{}return}}}catch{}},[G,Ae,We,Bs,re,gt]);const hl=async()=>{Gm(),console.log("🔄 بدء عملية التحويل/السحب"),console.log("📊 البيانات المدخلة:",{senderPhone:Je,receiverPhone:zt,amount:gt,transactionType:re});const t=()=>{re==="transfer"?va(!0):Ea(!0)},r=()=>{re==="transfer"?va(!1):Ea(!1)};if(t(),!Je||!gt){console.log("❌ خطأ: بيانات ناقصة"),n({title:"خطأ في البيانات",description:"يرجى ملء جميع الحقول المطلوبة",variant:"destructive"}),r();return}if(re==="transfer"&&!zt&&!O){console.log("❌ خطأ: رقم المستقبل مفقود"),n({title:"خطأ في البيانات",description:"يرجى إدخال رقم المستقبل",variant:"destructive"}),r();return}if(re==="transfer"&&!O&&!Qm(zt)){n({title:"رقم المستقبل غير صالح",description:"اكتب رقم صحيح مكون من 11 رقم ويبدأ بـ 015 أو 010 أو 012 أو 011",variant:"destructive"}),r();return}const a=parseFloat(gt);if(console.log("💰 المبلغ المحول:",a),a<=0){console.log("❌ خطأ: مبلغ غير صحيح"),n({title:"خطأ في المبلغ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"}),r();return}if(Ze)try{const ve=new Date,ft=ve.getFullYear(),js=String(ve.getMonth()+1).padStart(2,"0"),Rt=String(ve.getDate()).padStart(2,"0"),zs=`zeroPlanDailyConfirmCount:${(s==null?void 0:s.uid)||"default"}:${ft}-${js}-${Rt}`,Cs=localStorage.getItem(zs);if((Cs&&parseInt(Cs,10)||0)>=10){n({title:"حد التأكيد اليومي",description:"باقة زيرو تسمح بـ 10 تأكيدات تحويل/سحب يومياً فقط.",variant:"destructive"}),r();return}}catch(ve){console.warn("فشل قراءة عداد تأكيدات باقة زيرو من التخزين المحلي:",ve)}const l=Ae.find(ve=>ve.id===G);if(!l){n({title:"خطأ في المحفظة",description:"يرجى اختيار محفظة صحيحة",variant:"destructive"}),r();return}const c=Bs;if(console.log("📈 فحص الحدود الشهرية للمحفظة المختارة"),console.log("📊 الإحصائيات الشهرية للمحفظة:",{walletId:G,walletName:l.name,currentWithdrawn:c.totalWithdrawn,currentTransferred:c.totalTransferred,withdrawalLimit:l.monthlyWithdrawalLimit,transferLimit:l.monthlyTransferLimit}),re==="withdraw"){if(console.log("🏧 فحص حد السحب الشهري للمحفظة"),console.log(`💸 المسحوب حالياً من المحفظة: ${c.totalWithdrawn}, المبلغ الجديد: ${a}, الحد الأقصى: ${l.monthlyWithdrawalLimit}`),c.totalWithdrawn+a>l.monthlyWithdrawalLimit){console.log("❌ تجاوز حد السحب الشهري للمحفظة"),n({title:"تجاوز حد السحب الشهري",description:`لا يمكن سحب أكثر من ${l.monthlyWithdrawalLimit} جنيه شهرياً من محفظة ${l.name}`,variant:"destructive"}),r();return}}else if(console.log("💸 فحص حد التحويل الشهري للمحفظة"),console.log(`📤 المحول حالياً من المحفظة: ${c.totalTransferred}, المبلغ الجديد: ${a}, الحد الأقصى: ${l.monthlyTransferLimit}`),c.totalTransferred+a>l.monthlyTransferLimit){console.log("❌ تجاوز حد التحويل الشهري للمحفظة"),n({title:"تجاوز حد التحويل الشهري",description:`لا يمكن تحويل أكثر من ${l.monthlyTransferLimit} جنيه شهرياً من محفظة ${l.name}`,variant:"destructive"}),r();return}const h=(A==null?void 0:A.shopName)||(s==null?void 0:s.displayName)||"محل كاشي لينك",x={id:Date.now().toString(),type:re==="transfer"?"send":re==="deposit"?"deposit":"withdraw",senderPhone:Je,receiverPhone:re==="transfer"?zt:Je,amount:a,status:"completed",createdAt:new Date,withdrawnAmount:re==="withdraw"?a:void 0,sentAmount:re==="transfer"?a:void 0,depositedAmount:void 0,fromWallet:G,senderNumber:Je,senderName:Je,shopName:(l==null?void 0:l.name)||"المحفظة الرئيسية",transferredAmount:re==="transfer"?a:void 0,receiverNumber:re==="transfer"?zt:void 0,withdrawnAmountDetailed:re==="withdraw"?a:void 0,depositedAmountDetailed:void 0,merchantShopName:h,transactionReference:`TXN-${Date.now()}`,commission:0,notes:re==="transfer"?void 0:u&&u.trim()!==""?u.trim():void 0};N&&(g!=null&&g.name||g!=null&&g.username)&&(x.cashierName=(g==null?void 0:g.name)||(g==null?void 0:g.username));const v=Ca.validateTransaction(a,re,ot,Te);if(!v.isValid){n({title:"خطأ في العملية",description:v.error,variant:"destructive"}),r();return}v.warning&&n({title:"تحذير",description:v.warning,variant:"destructive"});let w;if(re==="transfer")if((l==null?void 0:l.defaultTransferCommission)!=null){const ve=Number(l.defaultTransferCommission)||0;w=Math.round(ve*a/1e3*100)/100}else ls&&ls.trim()!==""?w=Math.max(0,parseFloat(ls)):w=0;else if((l==null?void 0:l.defaultWithdrawCommission)!=null){const ve=Number(l.defaultWithdrawCommission)||0;w=Math.round(ve*a/1e3*100)/100}else is&&is.trim()!==""?w=Math.max(0,parseFloat(is)):w=Math.round(a*.01*100)/100;if(x.commission=w,re!=="transfer"&&!Ke&&w>=a){n({title:"خطأ في العمولة",description:"العمولة أكبر من أو تساوي المبلغ المدخل",variant:"destructive"}),r();return}const y=re==="transfer"||Ke?a:Math.round((a-w)*100)/100;x.amount=y,x.withdrawnAmount=re==="withdraw"?y:void 0,x.sentAmount=re==="transfer"?y:void 0,x.transferredAmount=re==="transfer"?y:void 0,x.withdrawnAmountDetailed=re==="withdraw"?y:void 0;let D;const T=re==="transfer"&&!!Ie,$=re==="withdraw"&&!!Ie,K=T||$;let De=null;const At=ar(Je||"").replace(/\D/g,""),Ot=ar(zt||"").replace(/\D/g,""),Tt=re==="transfer"&&(At.startsWith("010")&&(Ot.startsWith("011")||Ot.startsWith("012")||Ot.startsWith("015"))||At.startsWith("012")&&Ot.startsWith("010")||At.startsWith("011")&&Ot.startsWith("010")||At.startsWith("015")&&Ot.startsWith("010")),Xe=Tt?Math.max(0,parseFloat(ni||"0")):0,ws=Math.round(w*100)/100;if(x.commission=ws,Tt&&!K&&Xe<=0){n({title:"خطأ",description:"أدخل رسوم التحويل لعمليات 010 → 011/012/015 أو 012 → 010 أو 011 → 010 أو 015 → 010",variant:"destructive"}),r();return}if(re==="transfer"&&!K){const ve=Number(Te[G]||0),ft=Number(y)+Number(Xe);if(ve<ft){n({title:"رصيد المحفظة غير كافٍ",description:`الرصيد الحالي ${ve} لا يكفي لخصم ${ft}`,variant:"destructive"}),r();return}}if(K)if(T){const ve=Ca.validateTransaction(y,"transfer",ot,Te);ve.isValid?D={success:!0,newCashBalance:ot,newWalletBalances:Te}:D={success:!1,newCashBalance:ot,newWalletBalances:Te,message:ve.error||"رصيد غير كافٍ للتحويل المؤجل",error:"INSUFFICIENT_WALLET_BALANCE"}}else D={success:!0,newCashBalance:ot,newWalletBalances:Te};else re==="transfer"?D=await Ca.processTransfer({amount:y,currentCashBalance:ot,currentWalletBalances:Te,wallets:Ae,selectedWalletId:G,skipRemoteLimitsCheck:!1,nonBlockingUsageUpdate:!0}):D=await Ca.processWithdraw({amount:y,currentCashBalance:ot,currentWalletBalances:Te,wallets:Ae,selectedWalletId:G,skipRemoteLimitsCheck:!1,nonBlockingUsageUpdate:!0});if(!D.success){n({title:"فشل في العملية",description:D.error||D.message,variant:"destructive"}),r();return}let $s=K?ot:D.newCashBalance,Us=K?Te:D.newWalletBalances;if(!K&&re==="transfer"&&Xe>0){const ve=Number(Us[G]||0);Us={...Us,[G]:Math.round((ve-Number(Xe))*100)/100}}if(K&&$){const ve=Ae.find(Rt=>Rt.id===G)??Ae.find(Rt=>Rt.isDefault)??Ae[0],ft=(ve==null?void 0:ve.id)||G;if(ft!==G)try{$a(ft)}catch{}const js=Number(Te[ft]||0);Us={...Te,[ft]:Math.round((js+Number(y))*100)/100};try{const Rt=`walletEffectsAppliedOnCreation_${(s==null?void 0:s.uid)||"default"}`,zs=localStorage.getItem(Rt),Cs=zs?JSON.parse(zs):[];x!=null&&x.id&&!Cs.includes(x.id)&&(Cs.push(x.id),localStorage.setItem(Rt,JSON.stringify(Cs)))}catch{}}if(K&&T){const ve=Ae.find(Rt=>Rt.id===G)??Ae.find(Rt=>Rt.isDefault)??Ae[0],ft=(ve==null?void 0:ve.id)||G;if(ft!==G)try{$a(ft)}catch{}const js=Number(Te[ft]||0);Us={...Te,[ft]:Math.round((js-Number(y)-Number(Xe))*100)/100}}if((T||$)&&Ie&&!ss){const ve={id:`DEBT-${Date.now()}`,debtorName:Ie.debtorName,amount:Ie.amount,reason:Ie.notes||"",customerId:Ie.customerId,mobile:Ie.mobile,status:"pending",createdAt:new Date};De=ve.id;const ft=[ve,...kt];cs(ft);try{await bs(ft)}catch(js){console.error("⚠️ فشل حفظ الدين المؤجل محلياً:",js)}n({title:"تم إضافة الدين",description:"أضيف إلى إيصالات الديون حتى يتم السداد",variant:"default"})}if(!K){const ve=Math.max(0,Number(w))+Math.max(0,Number(Xe));ve>0&&($s=Math.round(($s+ve)*100)/100,console.log(`💰 تم إضافة عمولة/رسوم ${ve} جنيه لدرج النقدية`))}console.log("⚡ تحديث الواجهة فوراً بدون حجب باستخدام startTransition...");const vl=[x,...Qe];_e.startTransition(()=>{Gt($s),Vt(Us),K&&(x.status="pending"),Hs(vl)});try{localStorage.setItem(Nr(),JSON.stringify(vl))}catch(ve){console.warn("تعذر حفظ المعاملات في التخزين المحلي بعد إنشاء معاملة جديدة:",ve)}if(Ze)try{const ve=new Date,ft=ve.getFullYear(),js=String(ve.getMonth()+1).padStart(2,"0"),Rt=String(ve.getDate()).padStart(2,"0"),zs=`zeroPlanDailyConfirmCount:${(s==null?void 0:s.uid)||"default"}:${ft}-${js}-${Rt}`,Cs=localStorage.getItem(zs),_r=Cs&&parseInt(Cs,10)||0;localStorage.setItem(zs,String(_r+1))}catch{}if(setTimeout(()=>{try{localStorage.setItem(Ds(),$s.toString()),localStorage.setItem(ms(),JSON.stringify(Us))}catch{}},0),(async()=>{try{console.log("🔄 بدء حفظ المعاملة في Firebase في الخلفية...");const ve={shopId:(A==null?void 0:A.shopId)||(s==null?void 0:s.uid)||"default-shop",lineId:G||"default-line",merchantUserId:(s==null?void 0:s.uid)||null,provider:"vodafone_cash",txnType:re==="transfer"?"send":"receive",amount:y,commission:ws,fee:Xe,profit:0,senderMsisdn:Je,receiverMsisdn:re==="transfer"?zt:Je,note:re==="transfer"?void 0:u&&u.trim()!==""?u.trim():void 0,status:K?"pending":"confirmed",linkedDebtId:De||void 0,createdBy:(s==null?void 0:s.uid)||null,walletEffectAppliedOnCreation:!!(K&&$)},ft={...ve,status:K?"pending":"completed",commissionMode:re==="transfer"||Ke?"add":"deduct",totalCharged:re==="transfer"?y+ws+Xe:Ke?y+w:y,walletEffectAppliedOnCreation:!!(K&&$),createdAt:new Date},{ProfitService:js}=await rt(async()=>{const{ProfitService:ld}=await import("./profitService-vyye6JvC.js").then(od=>od.p);return{ProfitService:ld}},__vite__mapDeps([4,0,1]),import.meta.url),Rt=js.calculateProfitFromTransaction(ft);Rt>0&&(js.addProfit(Rt,s==null?void 0:s.uid),console.log("✅ تم إضافة الربح:",Rt,"جنيه"));const zs=await Kr.create(ve);await Promise.all([...s!=null&&s.uid?[Ce.updateUserData(s.uid,{cashBalance:$s,walletBalances:Us,lastUpdated:new Date().toISOString()})]:[],...s!=null&&s.uid?[Ce.saveUserTransaction(s.uid,{...ft,transactionType:re,fromWallet:G,toWallet:re==="transfer"?T?null:"cash":null,cashierName:N&&((g==null?void 0:g.name)||(g==null?void 0:g.username))||"الحساب الرئيسي",linkedDebtId:De||void 0,transactionId:zs,description:`${re==="transfer"?"تحويل":"سحب"} ${y} من ${G} ${re==="transfer"?T?"":"إلى الدرج النقدي":""} — عمولة: ${w} (${re==="transfer"||Ke?"مضافة":"مخصومة"})${Xe>0?` — رسوم: ${Xe}`:""}${K?" — دين مؤجل (قيد المراجعة)":""}`})]:[]]),console.log("✅ تم حفظ جميع البيانات في Firebase بنجاح");const Cs=`userData_${s==null?void 0:s.uid}`,_r={cashBalance:$s,walletBalances:Us,lastUpdated:new Date().toISOString()};localStorage.setItem(Cs,JSON.stringify(_r))}catch(ve){console.error("❌ خطأ في حفظ المعاملة في Firebase (في الخلفية):",ve),n({title:"تحذير",description:"تم تنفيذ العملية محلياً، لكن فشلت المزامنة مع الخادم. ستتم المحاولة مرة أخرى تلقائياً.",variant:"destructive"})}})(),re==="transfer"){va(!0);const ve=Number(a)+Number(w)+Math.max(0,Number(Xe));nn({type:"transfer",amount:Math.max(0,Math.round(ve*100)/100)}),Jo({receiver:zt,amount:a}),oa(!0),setTimeout(()=>{va(!1)},2e3)}else{Ea(!0);const ve=Ke?Number(a):Math.max(0,Math.round((Number(a)-Number(w))*100)/100);nn({type:"withdraw",amount:Math.max(0,Math.round(ve*100)/100)}),oa(!0),setTimeout(()=>{Ea(!1)},2e3)}Ps(""),ys(""),_(""),ut(null),we(""),B(""),pe(""),Mt(!1)},Wr=_e.useMemo(()=>new Intl.DateTimeFormat("ar-EG"),[]),ul=_e.useMemo(()=>new Intl.DateTimeFormat("ar-EG",{hour:"2-digit",minute:"2-digit"}),[]),Xc=_e.useMemo(()=>{try{return kt.reduce((t,r)=>{const a=Number(r.paidAmount||0),l=Math.max(0,Number(r.amount||0)-a);return t+l},0)}catch{return 0}},[kt]),qn=_e.useMemo(()=>ll().filter(r=>Ms==="all"?!0:Ms==="send"?r.type==="send":Ms==="receive"?r.type==="receive":Ms==="withdraw"?r.type==="withdraw":Ms!=="deleted"),[ll,Ms]),ed=()=>{if(sn==="daily"){const t=Qt.resetReportsManually("daily",Qe,s==null?void 0:s.uid);ka(!1),n({title:"تم تصفير المعاملات اليومية",description:`تم إخفاء ${t.length} معاملة من تقارير اليوم (الحدود لم تتأثر)`})}else{const t=Qt.resetReportsManually("monthly",Qe,s==null?void 0:s.uid);ka(!1),n({title:"تم تصفير المعاملات الشهرية",description:`تم إخفاء ${t.length} معاملة من تقارير الشهر (الحدود لم تتأثر)`})}},td=()=>sn==="daily"?"تصفير المعاملات اليومية":"تصفير المعاملات الشهرية",sd=()=>sn==="daily"?"أدخل الرقم السري الرئيسي لتصفير جميع معاملات اليوم":"أدخل الرقم السري الرئيسي لتصفير جميع معاملات الشهر",ad=t=>{Qi(t),Cn(!0)},rd=t=>{Gt(t),localStorage.setItem(Ds(),t.toString()),Bi(!1),n({title:"تم تحديث الرصيد النقدي",description:`تم تحديث الرصيد النقدي إلى ${t} جنيه`})},nd=async t=>{var x;if(!hs){console.warn("لا يوجد معرف محفظة محدد لتعديل الرصيد");return}const r={...Te,[hs]:t};Vt(r);const a=new Date().toISOString(),l={walletBalances:r,lastUpdated:a},c=`userData_${s==null?void 0:s.uid}`;try{localStorage.setItem(c,JSON.stringify(l)),localStorage.setItem(ms(),JSON.stringify(r)),localStorage.setItem(`walletBalances_backup_${a}`,JSON.stringify(r))}catch{}try{s!=null&&s.uid&&await Ce.updateUserData(s.uid,l)}catch(v){console.error("خطأ أثناء حفظ رصيد المحفظة في Firebase:",v)}$i(!1);const h=((x=Ae.find(v=>v.id===hs))==null?void 0:x.name)||"المحفظة";n({title:"تم تحديث رصيد المحفظة",description:`تم تحديث رصيد ${h} إلى ${t.toLocaleString()} جنيه`})},id=async t=>{var r;if(console.log("💰 بدء تحديث رصيد المحفظة"),console.log("📊 معرف المحفظة المحررة:",hs),console.log("💵 المبلغ المضاف/المخصوم:",t),hs){const a=Te[hs]||0;console.log("💰 الرصيد الحالي:",a);const l=a+t;console.log("💰 الرصيد الجديد:",l);const c={...Te,[hs]:l};console.log("📊 الأرصدة المحدثة:",c),Vt(c);const h=new Date().toISOString(),x={walletBalances:c,lastUpdated:h},v=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(v,JSON.stringify(x)),localStorage.setItem(ms(),JSON.stringify(c)),localStorage.setItem(`walletBalances_backup_${h}`,JSON.stringify(c));try{if(s!=null&&s.uid){console.log("🔄 حفظ البيانات في Firebase...");try{await Ce.updateUserData(s.uid,x),console.log("✅ تم حفظ الأرصدة في Firebase بنجاح"),setTimeout(()=>{localStorage.removeItem(v),console.log("🧹 تم حذف النسخة المحلية المؤقتة بعد دقيقة واحدة")},6e4)}catch(T){console.error("❌ فشل في حفظ البيانات في Firebase:",T),Ne(!0)}}else console.log("⚠️ المستخدم غير مسجل دخول، حفظ في localStorage"),localStorage.setItem(ms(),JSON.stringify(c));const w=((r=Ae.find(T=>T.id===hs))==null?void 0:r.name)||"المحفظة",y=t>0?"إضافة":"خصم",D=Math.abs(t);n({title:`تم ${y} مبلغ ${y==="إضافة"?"إلى":"من"} رصيد المحفظة`,description:`تم ${y} ${D} جنيه ${y==="إضافة"?"إلى":"من"} رصيد ${w}. الرصيد الجديد: ${l.toLocaleString()} جنيه`})}catch(w){if(console.error("❌ فشل في حفظ البيانات في Firebase:",w),localStorage.setItem(ms(),JSON.stringify(c)),s!=null&&s.uid){const y=`userData_${s.uid}`,D={walletBalances:c,lastUpdated:new Date().toISOString()};localStorage.setItem(y,JSON.stringify(D)),Ne(!0)}n({title:"تم حفظ البيانات محلياً",description:"تم حفظ التغييرات محلياً وسيتم مزامنتها مع الخادم لاحقاً",variant:"default"})}}else console.log("❌ لا يوجد معرف محفظة للتحرير");setTimeout(()=>{const l=Object.keys(localStorage).filter(c=>c.startsWith("walletBalances_backup_")).sort();l.length>5&&l.slice(0,l.length-5).forEach(h=>{localStorage.removeItem(h),console.log("🗑️ حذف النسخة الاحتياطية القديمة:",h)})},5e3),Cn(!1),Qi("")};return console.log("🔥 UserDashboardPage - Render conditions:",{isCheckingActivation:Oe,isUserActive:ge,showActivationModal:ts}),!Oe&&!ge?(console.log("🔥 UserDashboardPage - Showing activation modal"),e.jsx("div",{className:"user-dashboard min-h-screen bg-background flex items-center justify-center",children:e.jsx(El,{isOpen:!0,onClose:()=>{}})})):Oe?(console.log("🔥 UserDashboardPage - Showing loading screen"),e.jsx(bd,{})):(console.log("🔥 UserDashboardPage - Rendering main dashboard"),e.jsxs("div",{className:"user-dashboard min-h-screen px-2 sm:px-4 py-2 sm:py-4 relative bg-gray-50 bg-[radial-gradient(140%_140%_at_10%_10%,#f3f4f6_0%,#e5e7eb_45%,#d1d5db_100%)]",children:[e.jsx(Zm,{userId:s==null?void 0:s.uid}),e.jsxs("div",{className:"max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-3 sm:gap-6 relative z-10",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-2 sm:space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 sm:grid-cols-2 sm:gap-3 fade-in-up",children:[!Wa&&e.jsxs(nt,{className:"monthly-stats-card bg-gradient-to-br from-purple-50 via-purple-25 to-white border border-purple-200/60 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 group relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-purple-500/5 to-purple-600/3 opacity-0 group-hover:opacity-100 transition-opacity duration-300"}),e.jsx("div",{className:"absolute top-0 right-0 w-20 sm:w-32 h-20 sm:h-32 bg-gradient-to-br from-purple-300/15 to-transparent rounded-full -translate-y-8 sm:-translate-y-16 translate-x-8 sm:translate-x-16 group-hover:scale-110 transition-transform duration-300"}),e.jsx($t,{className:"monthly-stats-header pb-2 sm:pb-1 lg:pb-1 px-3 sm:px-3 lg:px-2 pt-3 sm:pt-2 lg:pt-1 relative z-10",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(rs,{className:"text-xs font-bold text-purple-800 flex items-center gap-1.5 sm:gap-1",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"w-2.5 sm:w-2 h-2.5 sm:h-2 bg-gradient-to-r from-purple-500 to-purple-600 rounded-full shadow-sm"}),e.jsx("div",{className:"absolute inset-0 w-2.5 sm:w-2 h-2.5 sm:h-2 bg-purple-400 rounded-full opacity-60 animate-pulse"})]}),e.jsx("span",{className:"text-xs",children:"الشهر"})]}),e.jsxs("div",{className:"flex items-center gap-1 sm:gap-1",children:[e.jsx("div",{className:"hidden"}),e.jsx(m,{size:"sm",variant:"ghost",onClick:()=>{hi("monthly"),ka(!0)},className:"monthly-stat-action h-7 w-7 sm:h-6 sm:w-6 p-0 bg-gradient-to-r from-purple-100 to-purple-200 text-purple-700 hover:from-purple-200 hover:to-purple-300 hover:text-purple-800 rounded-lg sm:rounded-md transition-all duration-300 hover:scale-105 shadow-sm hover:shadow-md",title:"تصفير معاملات الشهر",children:e.jsx(Jt,{className:"h-3 w-3 sm:h-2.5 sm:w-2.5"})}),e.jsx("div",{className:"monthly-stat-action p-1.5 sm:p-1 bg-gradient-to-r from-purple-100 to-purple-200 rounded-lg sm:rounded-md",children:e.jsx(Ja,{className:"h-3 w-3 sm:h-2.5 sm:w-2.5 text-purple-600"})})]})]})}),!Wa&&e.jsxs(dt,{className:"space-y-0.5 sm:space-y-1 lg:space-y-0 pt-0 px-2 sm:px-3 lg:px-2 pb-1.5 sm:pb-2 lg:pb-1 relative z-10",children:[e.jsxs("div",{className:"stat-row stat-row--monthly flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-purple-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"stat-label stat-label--monthly text-xs font-semibold text-purple-700",children:"عدد المعاملات:"}),e.jsx("span",{className:"stat-value stat-value--monthly font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:Va().totalTransactions})]}),e.jsxs("div",{className:"stat-row stat-row--monthly flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-purple-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"stat-label stat-label--monthly text-xs font-semibold text-purple-700",children:"إجمالي المبالغ:"}),e.jsx("span",{className:"stat-value stat-value--monthly font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:Va().totalAmount.toFixed(2)})]}),e.jsxs("div",{className:"stat-row stat-row--monthly flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-purple-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"stat-label stat-label--monthly text-xs font-semibold text-purple-700",children:"المسحوب:"}),e.jsx("span",{className:"stat-value stat-value--monthly font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:Va().totalWithdrawn.toFixed(2)})]}),e.jsxs("div",{className:"stat-row stat-row--monthly flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-purple-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"stat-label stat-label--monthly text-xs font-semibold text-purple-700",children:"المرسل:"}),e.jsx("span",{className:"stat-value stat-value--monthly font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:Va().totalSent.toFixed(2)})]}),e.jsxs("div",{className:"stat-row stat-row--monthly flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-purple-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"stat-label stat-label--monthly text-xs font-semibold text-purple-700",children:"الأرباح:"}),e.jsx(Rm,{userId:s==null?void 0:s.uid,transactions:Qe})]})]}),Xo&&e.jsx("div",{className:"monthly-overlay absolute inset-0 z-20 bg-yellow-100/60 backdrop-blur-sm rounded-xl border border-yellow-300/70 flex items-center justify-center p-0 pointer-events-auto",children:e.jsxs(m,{size:"sm",variant:"ghost",onClick:async()=>{if(Ze){n({title:"غير متاح",description:"تقارير الشهر غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"});return}mr(!0)},className:"px-2.5 py-1 rounded-full bg-gradient-to-r from-yellow-500 to-yellow-600 text-black hover:from-yellow-600 hover:to-yellow-700 shadow-md flex items-center gap-1 text-[11px] font-semibold",title:"عرض تقارير الشهر (يتطلب الرقم السري)",children:[e.jsx("span",{children:"عرض تقارير الشهر"}),e.jsx(mt,{className:"h-2.5 w-2.5"})]})})]}),e.jsx(xs,{open:tc,onOpenChange:mr,mode:"verify",title:"الرقم السري لفتح تقارير الشهر",description:"لا يمكن الاطلاع على إحصائيات الشهر إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{if(Ze){n({title:"غير متاح",description:"تقارير الشهر غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}),mr(!1),ji(!0);return}ji(!1),mr(!1)},userId:s==null?void 0:s.uid}),e.jsxs(nt,{className:"daily-stats-card bg-gradient-to-br from-blue-50 via-blue-25 to-white border border-blue-200/60 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 group relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/5 to-blue-600/3 opacity-0 group-hover:opacity-100 transition-opacity duration-300"}),e.jsx("div",{className:"absolute top-0 right-0 w-20 sm:w-32 h-20 sm:h-32 bg-gradient-to-br from-blue-300/15 to-transparent rounded-full -translate-y-8 sm:-translate-y-16 translate-x-8 sm:translate-x-16 group-hover:scale-110 transition-transform duration-300"}),e.jsx($t,{className:"daily-stats-header pb-2 sm:pb-3 lg:pb-1 px-3 sm:px-4 lg:px-2 pt-3 sm:pt-4 lg:pt-1 relative z-10",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(rs,{className:"text-sm sm:text-base font-bold text-blue-800 flex items-center gap-1.5 sm:gap-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"w-2.5 sm:w-3 h-2.5 sm:h-3 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full shadow-sm"}),e.jsx("div",{className:"absolute inset-0 w-2.5 sm:w-3 h-2.5 sm:h-3 bg-blue-400 rounded-full opacity-60 animate-pulse"})]}),e.jsx("span",{className:"text-xs sm:text-sm",children:"اليوم"})]}),e.jsxs("div",{className:"flex items-center gap-1 sm:gap-1.5",children:[e.jsx(m,{size:"sm",variant:"ghost",onClick:()=>{hi("daily"),ka(!0)},className:"daily-stat-action h-7 w-7 sm:h-8 sm:w-8 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded-lg transition-all duration-300 hover:scale-105 shadow-sm hover:shadow-md",title:"تصفير معاملات اليوم",children:e.jsx(Jt,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"})}),e.jsx(m,{size:"sm",variant:"ghost",onClick:()=>an(!0),className:"daily-stat-action h-7 w-7 sm:h-8 sm:w-8 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded-lg transition-all duration-300 hover:scale-105 shadow-sm hover:shadow-md",title:"أرشيف التقارير اليومية",children:e.jsx(tm,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"})}),e.jsx(m,{size:"sm",variant:"ghost",onClick:()=>ec(t=>!t),className:"daily-stat-action h-7 w-7 sm:h-8 sm:w-8 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded-lg transition-all duration-300 hover:scale-105 shadow-sm hover:shadow-md",title:Wa?"توسيع اليوم والشهر":"طي اليوم والشهر",children:Wa?e.jsx(Qa,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"}):e.jsx(Br,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"})}),e.jsx("div",{className:"p-1.5 sm:p-2 bg-gradient-to-r from-blue-100 to-blue-200 rounded-lg",children:e.jsx(Ja,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5 text-blue-600"})})]})]})}),!Wa&&e.jsxs(dt,{className:"space-y-0 pt-0 px-2 pb-1 relative z-10",children:[e.jsxs("div",{className:"stat-row flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-blue-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"stat-label text-xs font-semibold text-blue-700",children:"عدد المعاملات:"}),e.jsx("span",{className:"stat-value font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:qa().totalTransactions})]}),e.jsxs("div",{className:"stat-row flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-blue-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"stat-label text-xs font-semibold text-blue-700",children:"إجمالي المبالغ:"}),e.jsx("span",{className:"stat-value font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:qa().totalAmount.toFixed(2)})]}),e.jsxs("div",{className:"stat-row flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-blue-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"stat-label text-xs font-semibold text-blue-700",children:"المسحوب:"}),e.jsx("span",{className:"stat-value font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:qa().totalWithdrawn.toFixed(2)})]}),e.jsxs("div",{className:"stat-row flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from_gray-100 to-blue-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"stat-label text-xs font-semibold text-blue-700",children:"المرسل:"}),e.jsx("span",{className:"stat-value font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:qa().totalSent.toFixed(2)})]}),e.jsxs("div",{className:"stat-row flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-blue-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"stat-label text-xs font-semibold text-blue-700",children:"الأرباح:"}),e.jsx(Um,{userId:s==null?void 0:s.uid})]})]}),sc&&e.jsx("div",{className:"absolute inset-0 z-20 bg-yellow-100/60 backdrop-blur-sm rounded-xl border border-yellow-300/70 flex items-center justify-center p-0 pointer-events-auto",children:e.jsxs(m,{size:"sm",variant:"ghost",onClick:()=>on(!0),className:"px-2.5 py-1 rounded-full bg-gradient-to-r from-yellow-300 to-yellow-400 text-black hover:from-yellow-400 hover:to-yellow-500 shadow-md flex items-center gap-1 text-[11px] font-semibold",title:"عرض تقارير اليوم (يتطلب الرقم السري)",children:[e.jsx("span",{children:"عرض تقارير اليوم"}),e.jsx(mt,{className:"h-2.5 w-2.5"})]})})]}),e.jsx(xs,{open:ac,onOpenChange:on,mode:"verify",title:"الرقم السري لفتح تقارير اليوم",description:"لا يمكن الاطلاع على تقارير اليوم إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{Ni(!1),on(!1)},userId:s==null?void 0:s.uid})]}),e.jsxs(nt,{className:"balance-bar bg-white border-2 border-gray-200/50 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 group relative overflow-hidden   transform fade-in-up mb-6",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-emerald-500/5 via-blue-500/5 to-emerald-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-200"}),e.jsx("div",{className:"absolute top-0 left-0 w-40 h-40 bg-gradient-to-br from-emerald-300/10 to-transparent rounded-full -translate-y-20 -translate-x-20 group-hover:scale-150 transition-transform duration-200"}),e.jsx("div",{className:"absolute bottom-0 right-0 w-40 h-40 bg-gradient-to-br from-blue-300/10 to-transparent rounded-full translate-y-20 translate-x-20 group-hover:scale-150 transition-transform duration-200"}),e.jsx(dt,{className:"p-3 relative z-10",children:e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"bg-emerald-50 border-2 border-emerald-200/50 p-1 rounded-xl shadow-lg hover:shadow-md transition-all duration-200 group/cash relative overflow-hidden ",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-emerald-500/10 to-transparent opacity-0 group-hover/cash:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex items-center justify-between relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-emerald-100 to-emerald-200 rounded-lg shadow-sm",children:e.jsx(yt,{className:"h-1.5 w-1.5 text-emerald-600"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] font-bold text-emerald-800",children:"الفلوس النقدية"}),e.jsxs("span",{className:"text-[10px] font-extrabold text-emerald-700 bg-gradient-to-r from-emerald-100 to-emerald-200 px-1 py-0.5 rounded-lg shadow-sm",children:[ot.toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(m,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-green-100 to-green-200 text-green-700 hover:from-green-200 hover:to-green-300 hover:text-green-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>Dr(!0),children:e.jsx(Zt,{className:"h-2 w-2"})}),e.jsx(m,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-emerald-100 to-emerald-200 text-emerald-700 hover:from-emerald-200 hover:to-emerald-300 hover:text-emerald-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>el(!0),title:"تفاصيل الفلوس النقدية",children:e.jsx(Pl,{className:"h-2 w-2"})}),e.jsx(m,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800 rounded-xl transition-all duration-300  hover:rotate-12 shadow-md hover:shadow-lg",onClick:()=>kr(!0),children:e.jsx(Jt,{className:"h-2 w-2"})})]})]})]}),e.jsxs("div",{className:"bg-blue-50 border-2 border-blue-200/50 p-1 rounded-xl shadow-lg hover:shadow-md transition-all duration-200 group/wallet relative overflow-hidden ",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/10 to-transparent opacity-0 group-hover/wallet:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex items-center justify-between relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-blue-100 to-blue-200 rounded-lg shadow-sm",children:e.jsx(Ws,{className:"h-1.5 w-1.5 text-blue-600"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] font-bold text-blue-800",children:"الأرصدة علي المحافظ"}),e.jsxs("span",{className:"text-[10px] font-extrabold text-blue-700 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-lg shadow-sm",children:[Object.values(Te).reduce((t,r)=>t+r,0).toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(m,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-green-100 to-green-200 text-green-700 hover:from-green-200 hover:to-green-300 hover:text-green-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>Ir(!0),title:"إضافة أموال لإجمالي المحفظة",children:e.jsx(Zt,{className:"h-2 w-2"})}),e.jsx(m,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800 rounded-xl transition-all duration-300  hover:rotate-12 shadow-md hover:shadow-lg",onClick:()=>{Tr(!0),Pr("")},title:"تصفير إجمالي المحفظة",children:e.jsx(Jt,{className:"h-2 w-2"})})]})]})]}),e.jsxs("div",{className:"col-span-2 sm:col-span-1 bg-indigo-50 border-2 border-indigo-200/50 p-1 rounded-xl shadow-lg hover:shadow-md transition-all duration-200 group/selwallet relative overflow-hidden ",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-indigo-500/10 to-transparent opacity-0 group-hover/selwallet:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex items-center justify-between relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-indigo-100 to-indigo-200 rounded-lg shadow-sm",children:e.jsx(Ws,{className:"h-1.5 w-1.5 text-indigo-600"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] font-bold text-indigo-800",children:"رصيد المحفظه"}),e.jsxs("span",{className:"text-[10px] font-extrabold text-indigo-700 bg-gradient-to-r from-indigo-100 to-indigo-200 px-1 py-0.5 rounded-lg shadow-sm",children:[(G&&Te[G]||0).toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(m,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-green-100 to-green-200 text-green-700 hover:from-green-200 hover:to-green-300 hover:text-green-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>{if(!G){n({title:"اختر محفظة",description:"يرجى اختيار محفظة من اختيار المحافظ بالأعلى أولاً",variant:"destructive"});return}ad(G)},title:"إضافة/خصم إلى رصيد المحفظة المختارة",children:e.jsx(Zt,{className:"h-2 w-2"})}),e.jsx(m,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800 rounded-xl transition-all duration-300  hover:rotate-12 shadow-md hover:shadow-lg",onClick:()=>{if(!G){n({title:"اختر محفظة",description:"يرجى اختيار محفظة لتصفير رصيدها فقط",variant:"destructive"});return}pr(!0)},title:"تصفير رصيد المحفظة المختارة",children:e.jsx(Jt,{className:"h-2 w-2"})})]})]})]})]})})]}),e.jsxs(nt,{className:"bg-gradient-to-br from-gray-50 via-white to-slate-50 border border-gray-200/60 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 group relative overflow-hidden fade-in-up",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-gray-500/5 to-slate-600/3 opacity-0 group-hover:opacity-100 transition-opacity duration-300"}),e.jsxs($t,{className:`pb-2 px-4 pt-4 relative z-10 ${k?"sticky top-0 z-20 bg-white/90 backdrop-blur supports-[backdrop-filter]:bg-white/60":""}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(rs,{className:"text-sm font-bold flex items-center gap-2 text-gray-800",children:[!k&&e.jsx("div",{className:"p-1.5 sm:p-2 bg-gradient-to-r from-gray-100 to-slate-200 rounded-lg",children:e.jsx(Ja,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5 text-gray-600"})}),e.jsx("span",{className:"bg-gradient-to-r from-gray-600 to-slate-600 bg-clip-text text-transparent",children:"المعاملات الأخيرة"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[!k&&e.jsxs("div",{className:"flex items-center gap-0.5 bg-gray-50 rounded px-1 py-0.5 border border-gray-200 hover:border-blue-300 transition-all duration-200 group relative overflow-hidden max-w-[140px] md:max-w-[220px]",children:[e.jsx(_d,{className:"h-2 w-2 text-gray-400 group-hover:text-blue-600 transition-colors"}),e.jsx(R,{placeholder:"بحث...",value:pi,onChange:t=>qo(t.target.value),className:"h-3 text-[8px] border-0 bg-transparent focus:ring-0 focus:outline-none text-gray-700 placeholder:text-gray-400"})]}),!k&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-green-600 mb-1",children:"شحن"}),e.jsx(m,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-green-50 text-green-600 hover:bg-green-100 border border-green-200 ring-3 ring-green-300 transition-all duration-200 hover:scale-105 active:bg-green-600 active:text-white active:border-green-600",onClick:()=>{n({title:"قيد التطوير",description:"هذه الميزة غير متاحة حالياً."})},title:"شحن الرصيد",children:e.jsx(er,{className:"h-5 w-5 text-green-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"حاسبة"}),e.jsx(m,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>ln(!0),title:"آلة حاسبة",children:e.jsx(Gl,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"كروت"}),e.jsx(m,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>{Ze?n({title:"غير متاح",description:"كروت الائتمان غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):or(!0)},title:"كروت الائتمان",children:e.jsx(er,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-blue-600 mb-1",children:"الوردية"}),e.jsx(m,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-blue-50 text-blue-600 hover:bg-blue-100 border border-blue-200 ring-3 ring-blue-300 transition-all duration-200 hover:scale-105 active:bg-blue-600 active:text-white active:border-blue-600",onClick:Wc,title:N&&(g!=null&&g.name||g!=null&&g.username)?`بروفيل الوردية: ${(g==null?void 0:g.name)||(g==null?void 0:g.username)}`:"وردية الكاشير",children:e.jsx(Zn,{className:"h-5 w-5 text-blue-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"المبيعات"}),e.jsx(m,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>{Ze?n({title:"غير متاح",description:"بيانات المبيعات غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ta(!0)},title:"بيانات المبيعات",children:e.jsx(Ld,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600",children:"الديون"}),kt.filter(t=>t.status==="pending").length>0&&e.jsx("span",{className:"h-4 w-4 rounded-full bg-red-600 text-white text-[10px] flex items-center justify-center ring-2 ring-white",children:kt.filter(t=>t.status==="pending").length})]}),e.jsx(m,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>{gn()},title:"الديون",children:e.jsx(wd,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-amber-700 mb-1",children:"الصيانة"}),e.jsx(m,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-amber-50 text-amber-700 hover:bg-amber-100 border border-amber-200 ring-3 ring-amber-300 transition-all duration-200 hover:scale-105 active:bg-amber-600 active:text-white active:border-amber-600",onClick:()=>{Ze?n({title:"غير متاح",description:"الصيانة غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):cr(!0)},title:"الصيانة",children:e.jsx(ql,{className:"h-5 w-5 text-amber-700"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-yellow-500 mb-1",children:"المكنة"}),e.jsx(m,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-violet-50 text-violet-700 hover:bg-violet-100 border border-violet-200 ring-3 ring-violet-300 transition-all duration-200 hover:scale-105 active:bg-violet-700 active:text-white active:border-violet-700",onClick:()=>{ks?dr(!0):n({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"})},title:"يومية المكنة",children:e.jsx(Zl,{className:"h-5 w-5 text-yellow-500"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-orange-600 mb-1",children:"مصروفات"}),e.jsx(m,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-orange-50 text-orange-600 hover:bg-orange-100 border border-orange-200 ring-3 ring-orange-300 transition-all duration-200 hover:scale-105 active:bg-orange-600 active:text-white active:border-orange-600",onClick:()=>{Ze?n({title:"غير متاح",description:"مصروفات المحل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Xt.hasMasterPin()?ie(!0):Se(!0)},title:"مصروفات المحل",children:e.jsx($r,{className:"h-5 w-5 text-orange-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-rose-600 mb-1",children:"النواقص"}),e.jsx(m,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-rose-50 text-rose-600 hover:bg-rose-100 border border-rose-200 ring-3 ring-rose-300 transition-all duration-200 hover:scale-105 active:bg-rose-600 active:text-white active:border-rose-600",onClick:()=>{Ze?n({title:"غير متاح",description:"النواقص غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):tt(!0)},title:"النواقص",children:e.jsx(Sl,{className:"h-5 w-5 text-rose-600"})})]})]})]})]}),!k&&e.jsx("div",{className:"mt-2 w-full",children:e.jsxs("div",{className:"filters-bar flex items-center justify-center gap-3 bg-gray-50 rounded-md p-3 border border-gray-200",children:[e.jsx(m,{variant:"ghost",size:"sm",className:`btn-filter-send h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${Ms==="send"?"bg-green-600 text-white border-green-600":"text-green-700 border-green-300 hover:bg-green-50"}`,onClick:()=>Xr("send"),title:"تصفية التحويل",children:"التحويل"}),e.jsx(m,{variant:"ghost",size:"sm",className:`btn-filter-withdraw h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${Ms==="withdraw"?"bg-red-600 text-white border-red-600":"text-red-700 border-red-300 hover:bg-red-50"}`,onClick:()=>Xr("withdraw"),title:"تصفية السحب",children:"السحب"}),e.jsx(m,{variant:"ghost",size:"sm",className:`btn-filter-all h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${Ms==="all"?"bg-green-600 text-white border-green-600":"text-green-700 border-green-300 hover:bg-green-50"}`,onClick:()=>Xr("all"),title:"عرض الكل",children:"الكل"}),e.jsxs("div",{className:"relative ml-1",children:[e.jsxs(m,{variant:"ghost",size:"sm",className:"h-8 px-3 text-[12px] rounded-full border bg-red-50 text-red-700 border-red-300 hover:bg-red-100",onClick:()=>Ba(!0),title:"تصفير المعاملات الأخيرة",children:[e.jsx(Jt,{className:"h-3.5 w-3.5 mr-1"}),"تصفير"]}),qc>0&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 h-2 w-2 rounded-full bg-red-500 ring-2 ring-white"})]})]})})]}),!1,e.jsxs(dt,{className:"space-y-2 pt-0 px-4 pb-4 relative z-10",children:[qn.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(Ja,{className:"h-12 w-12 mx-auto mb-2 text-gray-300"}),e.jsx("p",{className:"text-sm",children:"لا توجد معاملات حتى الآن"})]}):k?e.jsx("div",{className:"overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400 transition-colors max-h-[310px]",children:e.jsx("div",{className:"space-y-2 pr-2",children:qn.map(t=>e.jsxs("div",{className:"receipts-row flex items-center justify-between p-3 rounded-lg border cursor-pointer transition-all duration-200",onClick:()=>dl(t),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[t.status==="completed"&&e.jsx(la,{className:`h-4 w-4 ${t.type==="withdraw"?"text-red-500":"text-green-500"}`}),t.status==="pending"&&e.jsx(Js,{className:"h-4 w-4 text-yellow-500"}),t.status==="failed"&&e.jsx(qr,{className:"h-4 w-4 text-red-500"})]}),e.jsxs("div",{children:[(()=>{const r=(t==null?void 0:t.type)==="report"||((t==null?void 0:t.title)||"").includes("إيصال تسليم وردية");return e.jsx("p",{className:`font-medium text-sm ${r?"text-gray-800":t.type==="send"?"text-green-700":"text-red-700"}`,children:r?"إيصال تسليم وردية":(t.type==="send"?"تحويل":"سحب")+` - ${As(t.amount)} جنيه`})})(),e.jsxs("p",{className:"text-[10px] text-gray-700",children:["تمت بواسطة: ",(t==null?void 0:t.cashierName)??"الحساب الرئيسي"]}),(()=>{const r=(t==null?void 0:t.type)==="report"||((t==null?void 0:t.title)||"").includes("إيصال تسليم وردية");return e.jsx("p",{className:`text-xs ${r?"text-gray-500":t.type==="send"?"text-green-600":"text-red-500"}`,children:r?`تم التسليم إلى: ${t.receiverPhone}`:`من ${t.senderPhone}${t.type==="send"?` إلى ${t.receiverPhone}`:""}`})})(),e.jsxs("p",{className:"text-xs text-gray-400",children:[Wr.format(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt))," - ",ul.format(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt))]})]})]}),e.jsx(Wt,{variant:t.status==="completed"?"default":t.status==="pending"?"secondary":"destructive",className:`text-xs ${t.status==="completed"?t.type==="withdraw"?"bg-red-100 text-red-700 border-red-300":t.type==="send"?"bg-green-100 text-green-700 border-green-300":"":""}`,children:t.status==="completed"?"مكتمل":t.status==="pending"?"قيد المعالجة":"فشل"})]},t.id))})}):e.jsx("div",{className:"overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400 transition-colors max-h-[calc(100dvh-300px)]",children:e.jsx("div",{className:"space-y-2 pr-2",children:qn.map(t=>e.jsxs("div",{className:"receipts-row flex items-center justify-between p-3 rounded-lg border cursor-pointer transition-all duration-200",onClick:()=>dl(t),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[t.status==="completed"&&e.jsx(la,{className:`h-4 w-4 ${t.type==="withdraw"?"text-red-500":"text-green-500"}`}),t.status==="pending"&&e.jsx(Js,{className:"h-4 w-4 text-yellow-500"}),t.status==="failed"&&e.jsx(qr,{className:"h-4 w-4 text-red-500"})]}),e.jsxs("div",{children:[(()=>{const r=(t==null?void 0:t.type)==="report"||((t==null?void 0:t.title)||"").includes("إيصال تسليم وردية");return e.jsx("p",{className:`font-medium text-sm ${r?"text-gray-800":t.type==="send"?"text-green-700":"text-red-700"}`,children:r?"إيصال تسليم وردية":(t.type==="send"?"تحويل":"سحب")+` - ${As(t.amount)} جنيه`})})(),e.jsxs("p",{className:"text-[10px] text-gray-700",children:["تمت بواسطة: ",(t==null?void 0:t.cashierName)??"الحساب الرئيسي"]}),(()=>{const r=(t==null?void 0:t.type)==="report"||((t==null?void 0:t.title)||"").includes("إيصال تسليم وردية");return e.jsx("p",{className:`text-xs ${r?"text-gray-500":t.type==="send"?"text-green-600":"text-red-500"}`,children:r?`تم التسليم إلى: ${t.receiverPhone}`:`من ${t.senderPhone}${t.type==="send"?` إلى ${t.receiverPhone}`:""}`})})(),e.jsxs("p",{className:"text-xs text-gray-400",children:[Wr.format(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt))," - ",ul.format(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt))]})]})]}),e.jsx(Wt,{variant:t.status==="completed"?"default":t.status==="pending"?"secondary":"destructive",className:`text-xs ${t.status==="completed"?t.type==="withdraw"?"bg-red-100 text-red-700 border-red-300":t.type==="send"?"bg-green-100 text-green-700 border-green-300":"":""}`,children:t.status==="completed"?"مكتمل":t.status==="pending"?"قيد المعالجة":"فشل"})]},t.id))})}),k&&e.jsxs("div",{className:"mt-2 flex justify-end",children:[e.jsxs(m,{variant:"ghost",size:"sm",className:"h-7 px-2 text-[11px] rounded-full border bg-red-50 text-red-700 border-red-300 hover:bg-red-100",onClick:()=>Ba(!0),title:"تصفير المعاملات الأخيرة",children:[e.jsx(Jt,{className:"h-3 w-3 mr-1"}),"تصفير"]}),(s==null?void 0:s.uid)&&localStorage.getItem(`recentTransactionsResetAt:${s.uid}`)&&e.jsx("span",{className:"inline-block h-1.5 w-1.5 rounded-full bg-red-500 ml-1 align-middle"})]})]})]})]}),e.jsx(Rd,{isOpen:Wo,onClose:()=>nr(!1),transaction:_o,onPrint:()=>window.print(),onDelete:Uo,onComplete:zo}),e.jsxs("div",{className:"space-y-1 fade-in-right w-full lg:w-[92%] xl:w-[95%] mx-auto",children:[e.jsxs(nt,{id:"transaction-section",className:"bg-gradient-to-br from-white via-blue-50/30 to-indigo-50/50 border border-blue-200/40 rounded-lg shadow-lg hover:shadow-lg transition-all duration-200 group relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/5 via-indigo-500/3 to-purple-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-200"}),e.jsx("div",{className:"absolute top-0 right-0 w-32 h-32 sm:w-28 sm:h-28 lg:w-20 lg:h-20 bg-gradient-to-bl from-blue-400/10 to-transparent rounded-full  "}),e.jsx("div",{className:"absolute bottom-0 left-0 w-24 h-24 bg-gradient-to-tr from-indigo-400/10 to-transparent rounded-full  ",style:{animationDelay:"1s"}}),e.jsx($t,{className:"sticky top-0 z-20 bg-white/80 backdrop-blur supports-[backdrop-filter]:bg-white/60 pb-0.5 px-3 pt-1 lg:pt-0.5 lg:pb-0.5 lg:px-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(rs,{className:"text-sm font-bold flex items-center gap-2 text-gray-800",children:[e.jsxs("div",{className:"relative",children:[e.jsx(la,{className:"h-1 w-1 text-emerald-500 "}),e.jsx("div",{className:"absolute inset-0 h-1 w-1 bg-emerald-400 rounded-full opacity-20 "})]}),e.jsx("span",{className:"bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent",children:"إجراء معاملة جديدة"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[oe&&e.jsx("div",{className:"hidden md:flex items-center gap-1 bg-gradient-to-r from-emerald-50 to-green-50 hover:from-emerald-100 hover:to-green-100 border border-emerald-200 text-emerald-800 text-sm transition-all duration-300 hover:scale-105 h-9 px-3 rounded-xl shadow-sm",children:e.jsxs("span",{className:"text-sm font-semibold whitespace-nowrap",children:["تجربة: ",ht," ",ht>=3&&ht<=10?"ساعات":ht===2?"ساعتين":"ساعة"]})}),e.jsxs("div",{className:"top-icons-bar hidden md:flex items-center gap-2 bg-gradient-to-r from-gray-50 to-slate-50 hover:from-gray-100 hover:to-slate-100 border border-gray-200 transition-all duration-300 hover:scale-105 h-9 px-3 rounded-xl shadow-sm",children:[e.jsx(ym,{}),e.jsx(Fd,{})]})]}),Kc&&e.jsxs(m,{variant:"outline",size:"sm",className:"hidden flex items-center gap-1.5 sm:gap-2 bg-gradient-to-r from-cyan-50 to-blue-50 hover:from-cyan-100 hover:to-blue-100 border-cyan-200 text-cyan-800 text-xs sm:text-sm transition-all duration-300 hover:scale-105 hover:shadow-lg h-10 sm:h-12 px-4 sm:px-5 rounded-xl min-w-[44px] touch-manipulation",onClick:nl,title:"مزامنة البيانات المحفوظة محلياً مع الخادم",children:[e.jsx(sm,{className:"h-3.5 w-3.5 sm:h-4 sm:w-4 animate-spin"}),e.jsx("span",{className:"text-xs sm:text-sm font-semibold whitespace-nowrap",children:"مزامنة"})]})]})}),e.jsxs(dt,{ref:d,className:"space-y-1 px-2 pb-2 relative z-10 transition-transform duration-200 ease-out will-change-transform",style:{transform:o?`translateY(${o}px)`:void 0},onFocusCapture:t=>{const r=t.target;if(!((r==null?void 0:r.id)==="transferExtraFeeInput")){p(0);return}const l=document.getElementById("transferSubmitButton");if(l){const c=l.getBoundingClientRect(),h=window.innerHeight;if(c.bottom>h){const x=c.bottom-h,v=Math.min(x,220);p(-v)}else p(0)}else p(0)},onBlurCapture:t=>{t.currentTarget.contains(t.relatedTarget)||p(0)},children:[e.jsxs("div",{className:"transaction-type-tabs grid grid-cols-2 gap-0.5 p-0.5 bg-gradient-to-r from-gray-50 to-slate-50 rounded-xl border border-gray-200/50 fade-in-up w-full lg:w-[92%] xl:w-[95%] mx-auto ",children:[e.jsxs(m,{variant:re==="transfer"?"default":"ghost",onClick:()=>Er("transfer"),className:`text-xs font-semibold transition-all duration-300 hover:scale-105 h-7 rounded-lg px-2 ${re==="transfer"?"bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg hover:shadow-md hover:from-blue-600 hover:to-indigo-700":"text-gray-600 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 hover:text-blue-700 hover:border-blue-200"}`,children:[e.jsx(Ja,{className:"h-1 w-1 mr-1"}),"تحويل"]}),e.jsxs(m,{variant:re==="withdraw"?"default":"ghost",onClick:()=>Er("withdraw"),className:`text-xs font-semibold transition-all duration-300 hover:scale-105 h-7 rounded-lg px-2 ${re==="withdraw"?"bg-gradient-to-r from-emerald-500 to-green-600 text-white shadow-lg hover:shadow-md hover:from-emerald-600 hover:to-green-700":"text-gray-600 hover:bg-gradient-to-r hover:from-emerald-50 hover:to-green-50 hover:text-emerald-700 hover:border-emerald-200"}`,children:[e.jsx(Vr,{className:"h-1 w-1 mr-1"}),"سحب"]})]}),e.jsxs("div",{className:"fade-in-up",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("label",{className:"text-sm font-semibold text-gray-700 block flex items-center gap-2",children:[e.jsx(Ws,{className:"h-1 w-1 text-blue-600"}),"اختيار المحفظة"]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsxs(m,{variant:"ghost",size:"sm",className:"h-6 rounded-md px-2 text-[10px] bg-emerald-50 text-emerald-700 hover:bg-emerald-100 border border-emerald-200",onClick:()=>I("/user/add-wallet"),title:"إضافة محفظة",children:[e.jsx(Zt,{className:"h-3 w-3 mr-1"}),"إضافة محفظة"]}),e.jsxs(m,{variant:"ghost",size:"sm",className:"h-6 rounded-md px-2 text-[10px] bg-indigo-50 text-indigo-700 hover:bg-indigo-100 border border-indigo-200",onClick:()=>{as(!0)},title:"المحافظ",children:[e.jsx(Ws,{className:"h-3 w-3 mr-1"}),"المحافظ"]})]})]}),Ae.length>0?e.jsxs(Xs,{value:G,onValueChange:Hc,children:[e.jsx(ea,{"data-testid":"wallet-select",className:"selected-number-card w-full h-12 text-sm bg-gradient-to-r from-white to-gray-50 border-2 border-gray-200 hover:border-blue-400 focus:border-blue-500 rounded-xl transition-all duration-300 hover:shadow-md focus:shadow-lg",children:e.jsx(ta,{placeholder:"اختر محفظة للمعاملة",className:"text-gray-600"})}),e.jsxs(sa,{className:"rounded-xl border-2 border-gray-200 shadow-md z-[9999]",children:[e.jsx("div",{"data-fixed-header":"true",className:"sticky top-0 z-10 bg-white p-2 border-b border-gray-200",children:e.jsx(R,{value:ci,onChange:t=>ko(t.target.value),placeholder:"ابحث برقم المحفظة",className:"h-6 text-xs"})}),e.jsx("div",{className:"pr-1",children:di.length===0?e.jsx("div",{className:"text-xs text-gray-500 p-2",children:"لا توجد نتائج مطابقة"}):di.map(t=>e.jsx(Is,{value:t.id,className:"rounded-lg hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 transition-all duration-200",children:e.jsxs("div",{className:"flex items-center gap-1 py-1 w-full justify-between",children:[e.jsx("div",{className:"p-1 bg-gradient-to-r from-blue-100 to-indigo-100 rounded-lg",children:e.jsx(Ws,{className:"h-1 w-1 text-blue-600"})}),e.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"text-sm font-medium text-gray-800",children:t.name}),e.jsxs("span",{className:"text-sm font-semibold text-red-600",children:["(",t.phone,")"]})]}),t.isDefault&&e.jsx(Wt,{variant:"secondary",className:"text-[10px] bg-gradient-to-r from-emerald-100 to-green-100 text-emerald-700 border-emerald-200",children:"افتراضي"})]}),e.jsx("div",{className:"ml-auto flex flex-col items-end gap-1"})]})},t.id))})]})]}):e.jsx("div",{className:"rounded-xl border-2 border-dashed border-gray-200 bg-gray-50 px-3 py-3 text-xs text-gray-600",children:"لا توجد محافظ حتى الآن. اضغط “إضافة محفظة” لإضافة أول محفظة."})]}),e.jsx(me,{open:ns,onOpenChange:je,children:e.jsxs(he,{className:"sm:max-w-3xl w-[95vw] sm:w-auto max-h-[80vh] overflow-y-auto",children:[e.jsx(ue,{children:e.jsx(xe,{children:"عرض المحافظ"})}),e.jsx("div",{className:"mt-2",children:e.jsx(Zd,{showAddButton:!1,showUsageBars:!1,showLimitCards:!1,showEditButton:!0})})]})}),e.jsx(xs,{open:lt,onOpenChange:as,mode:"verify",title:"الرقم السري لفتح المحافظ",description:"أدخل الرقم السري الرئيسي لعرض وإدارة المحافظ",onSuccess:()=>{as(!1),je(!0)},userId:s==null?void 0:s.uid}),e.jsx(xs,{open:Yr,onOpenChange:t=>{ya(t),t||Hr(null)},mode:"verify",title:"تأكيد تغيير المحفظة",description:"أدخل الرقم السري الرئيسي لتغيير المحفظة المختارة",onSuccess:()=>{ri&&($a(ri,"walletSelectionPin"),Hr(null)),ya(!1)},userId:s==null?void 0:s.uid}),e.jsx(me,{open:Do,onOpenChange:sr,children:e.jsxs(he,{className:"sm:max-w-md",children:[e.jsx(ue,{children:e.jsxs(xe,{className:"flex items-center gap-2 text-red-700",children:[e.jsx(Sl,{className:"h-5 w-5 text-red-600"}),"تحذير حد شهري للمحفظة"]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"p-3 rounded-md border bg-red-50 border-red-200",children:[e.jsxs("p",{className:"text-sm text-red-800",children:["المحفظة: ",e.jsx("span",{className:"font-semibold",children:(vs==null?void 0:vs.walletName)||""})]}),e.jsxs("p",{className:"text-sm text-red-800",children:["الاستخدام الشهري (",(vs==null?void 0:vs.type)==="withdraw"?"سحب":"تحويل","):",e.jsxs("span",{className:"font-mono",children:[" ",Number((vs==null?void 0:vs.used)||0).toLocaleString("en-US")," "]})," جنيه"]}),e.jsxs("p",{className:"text-sm text-red-800",children:["الحد الشهري: ",e.jsx("span",{className:"font-mono",children:Number((vs==null?void 0:vs.limit)||0).toLocaleString("en-US")})," جنيه"]}),e.jsx("p",{className:"text-sm font-semibold text-red-900 mt-1",children:"تم الوصول إلى 85% من الحد الشهري — يرجى الحذر قبل الاستمرار."})]}),e.jsx("div",{className:"flex justify-end gap-2",children:e.jsx(m,{variant:"outline",onClick:()=>sr(!1),children:"حسناً"})})]})]})}),G&&Ae.length>0&&(()=>{const t=Ae.find(Ot=>Ot.id===G),r=Bs,a=Zc(G),l=(We==null?void 0:We.monthlyWithdrawLimit)??(t==null?void 0:t.monthlyWithdrawalLimit)??2e5,c=(We==null?void 0:We.monthlyTransferLimit)??(t==null?void 0:t.monthlyTransferLimit)??2e5,h=r.totalWithdrawn??(We==null?void 0:We.monthlyWithdrawUsed)??0,x=r.totalTransferred??(We==null?void 0:We.monthlyTransferUsed)??0,v=(We==null?void 0:We.dailyWithdrawLimit)??1e5,w=(We==null?void 0:We.dailyTransferLimit)??6e4,y=a.totalWithdrawn??(We==null?void 0:We.dailyWithdrawUsed)??0,D=a.totalTransferred??(We==null?void 0:We.dailyTransferUsed)??0,T=parseFloat(gt||"0")||0,$=h+(re==="withdraw"?T:0),K=x+(re==="transfer"?T:0),De=y+(re==="withdraw"?T:0),At=D+(re==="transfer"?T:0);return t?e.jsxs("div",{className:"fade-in-up mb-2 space-y-2",children:[e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-1 rounded-md border border-gray-200 shadow-sm hover:shadow-md transition-all duration-300",children:[e.jsxs("div",{className:"text-[10px] text-gray-600 font-medium mb-1 text-center",children:["الحدود الشهرية: ",t.name]}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-red-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-red-400 to-red-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min($/Math.max(l,1)*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-blue-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-400 to-blue-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(K/Math.max(c,1)*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-[10px] text-red-600 font-medium",children:["متبقي سحب: ",Math.max(l-$,0).toLocaleString("en-US")," جنيه"]}),e.jsxs("div",{className:"text-[10px] text-blue-600 font-medium",children:["متبقي تحويل: ",Math.max(c-K,0).toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-1 rounded-md border border-gray-200 shadow-sm hover:shadow-md transition-all duration-300",children:[e.jsxs("div",{className:"text-[10px] text-gray-600 font-medium mb-1 text-center",children:["الحدود اليومية: ",t.name]}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-orange-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-orange-400 to-orange-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(De/Math.max(v,1)*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-green-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-green-400 to-green-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(At/Math.max(w,1)*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-[10px] text-orange-600 font-medium",children:["متبقي سحب يومي: ",Math.max(v-De,0).toLocaleString("en-US")," جنيه"]}),e.jsxs("div",{className:"text-[10px] text-green-600 font-medium",children:["متبقي تحويل يومي: ",Math.max(w-At,0).toLocaleString("en-US")," جنيه"]})]})]})]}):null})(),re==="transfer"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المرسل"}),e.jsxs("div",{className:"relative",children:[e.jsx(Vs,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(R,{value:Je,onChange:t=>Fs(t.target.value),onKeyDown:t=>{if(t.key==="Enter"){const r=document.getElementById("receiverPhoneInput");if(r)r.focus();else{const a=document.getElementById("amountInput");a==null||a.focus()}}},placeholder:"01030302038",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]})]}),!O&&e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المستقبل"}),e.jsxs("div",{className:"relative",children:[e.jsx(Vs,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(R,{id:"receiverPhoneInput",value:zt,onChange:t=>{Ps(t.target.value),rn&&va(!1)},onKeyDown:t=>{if(t.key==="Enter"){const r=document.getElementById("amountInput");r==null||r.focus()}},inputMode:"numeric",maxLength:11,placeholder:"أدخل رقم المستقبل",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المستقبل"}),e.jsxs("div",{className:"relative",children:[e.jsx(Vs,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(R,{value:G&&((xl=Ae.find(t=>t.id===G))==null?void 0:xl.phone)||"",readOnly:!0,placeholder:"اختر محفظة أولاً",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base bg-gray-50 transition-all duration-300"})]})]}),re==="transfer"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"المبلغ (جنيه)"}),e.jsxs("div",{className:"relative flex items-center gap-2",children:[e.jsx(yt,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(R,{id:"amountInput",value:gt,onChange:t=>{ys(t.target.value),rn&&va(!1)},onKeyDown:t=>{if(t.key==="Enter"){const r=document.getElementById("transferCommissionInput");if(r)r.focus();else{const a=document.getElementById("quickDebtButton");a==null||a.focus()}}},placeholder:"أدخل المبلغ",type:"number",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),Ie?e.jsxs("div",{className:"mt-2 text-xs text-green-700 bg-green-50 border border-green-200 rounded px-2 py-1 flex items-center gap-2",children:[e.jsxs("span",{children:["تم إدخال تفاصيل الأجل لـ ",Ie.debtorName," بمبلغ ",Ie.amount," جنيه"]}),e.jsx(m,{type:"button",variant:"ghost",size:"sm",className:"h-6 px-2",onClick:()=>ut(null),children:"إلغاء"})]}):null]}),(()=>{if(O)return null;const t=qt();return t&&t.defaultTransferCommission!=null?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة التحويل (تلقائية)"}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["سيتم تطبيق عمولة التحويل الافتراضية لكل ألف: ",t==null?void 0:t.defaultTransferCommission," جنيه لكل ألف"]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(m,{id:"quickDebtButton",type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const a=qt(),l=(a==null?void 0:a.defaultTransferCommission)!=null?Number(a.defaultTransferCommission):0,c=parseFloat(gt||"0")||0,h=Math.round((l||0)*c/1e3*100)/100,x=c+h;B((x||0).toString()),Ze?n({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):Y(!0)},children:"أجل"}),e.jsx(m,{type:"button",variant:"outline",size:"icon",className:"hidden",title:Ke?"العمولة تُضاف":"العمولة تُخصم",children:Ke?e.jsx(Zt,{className:"h-4 w-4 text-green-600"}):e.jsx(ha,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"hidden",children:Ke?"العمولة تُضاف":"العمولة تُخصم"})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة التحويل على العملية (جنيه)"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(yt,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-orange-500"}),e.jsx(R,{id:"transferCommissionInput",value:ls,onChange:a=>Qr(a.target.value),placeholder:"أدخل عمولة التحويل",type:"number",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),e.jsx(m,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const a=qt(),l=parseFloat(gt||"0")||0;let c=0;if((a==null?void 0:a.defaultTransferCommission)!=null){const x=Number(a.defaultTransferCommission)||0;c=Math.round(x*l/1e3*100)/100}else{const x=ls&&ls.trim()!==""?parseFloat(ls):0;c=Math.max(0,x)}const h=l+c;B((h||0).toString()),Ze?n({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):Y(!0)},children:"أجل"}),e.jsx(m,{type:"button",variant:"outline",size:"icon",className:"hidden",title:Ke?"العمولة تُضاف":"العمولة تُخصم",children:Ke?e.jsx(Zt,{className:"h-4 w-4 text-green-600"}):e.jsx(ha,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"hidden",children:Ke?"العمولة تُضاف":"العمولة تُخصم"})]}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"يمكنك إدخال عمولة العملية الإجمالية (اختياري)"})]})})(),(()=>{const t=ar(Je||"").replace(/\D/g,""),r=ar(zt||"").replace(/\D/g,"");return re==="transfer"&&(t.startsWith("010")&&(r.startsWith("011")||r.startsWith("012")||r.startsWith("015"))||t.startsWith("012")&&r.startsWith("010")||t.startsWith("011")&&r.startsWith("010")||t.startsWith("015")&&r.startsWith("010"))?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رسوم التحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(yt,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-orange-500"}),e.jsx(R,{id:"transferExtraFeeInput",value:ni,onChange:l=>So(l.target.value),placeholder:"أدخل رسوم التحويل",type:"number",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),e.jsx("div",{className:"hidden",children:"تُخصم من المحفظة وتضاف للدرج — لعمليات 010 → 011/012/015 أو 012 → 010 أو 011 → 010 أو 015 → 010"})]}):null})(),e.jsx("div",{className:"sticky bottom-0 z-10 pt-2 bg-white/80 backdrop-blur supports-[backdrop-filter]:bg-white/60",children:e.jsx(m,{id:"transferSubmitButton",onClick:hl,className:"btn-transfer-confirm w-full font-medium h-11 lg:h-12 text-sm lg:text-base btn-bounce hover-glow transition-all duration-300 text-white",children:rn?"تم التحويل بنجاح":"تأكيد التحويل"})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"مبلغ السحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Vr,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-green-500"}),e.jsx(R,{id:"amountInput",value:gt,onChange:t=>{ys(t.target.value),vi&&Ea(!1)},onKeyDown:t=>{if(t.key==="Enter"){const r=document.getElementById("manualWithdrawCommissionInput");if(r)r.focus();else{const a=document.getElementById("withdrawSubmitButton");a==null||a.focus()}}},placeholder:"أدخل مبلغ السحب",type:"number",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]})]}),(()=>{const t=qt();return t&&t.defaultWithdrawCommission!=null?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة السحب (تلقائية)"}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["سيتم تطبيق عمولة السحب الافتراضية لكل ألف: ",t==null?void 0:t.defaultWithdrawCommission," جنيه لكل ألف"]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(m,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const a=qt(),l=parseFloat(gt||"0")||0,c=(a==null?void 0:a.defaultWithdrawCommission)!=null&&Number(a.defaultWithdrawCommission)||0,h=Math.round(c*l/1e3*100)/100,x=Ke?l+h:l;B((x||0).toString()),Ze?n({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):Y(!0)},children:"أجل"}),e.jsx(m,{type:"button",variant:"outline",size:"icon",className:"h-8 w-8",onClick:()=>Zr(a=>!a),title:Ke?"العمولة تُضاف إلى الدين":"العمولة تُخصم من الدين",children:Ke?e.jsx(Zt,{className:"h-4 w-4"}):e.jsx(ha,{className:"h-4 w-4"})}),e.jsx("span",{className:"text-xs text-gray-600",children:Ke?"العمولة تُضاف":"العمولة تُخصم"})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة السحب على العملية (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(yt,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-orange-500"}),e.jsx(R,{id:"manualWithdrawCommissionInput",value:is,onChange:a=>Gr(a.target.value),onKeyDown:a=>{if(a.key==="Enter"){const l=document.getElementById("withdrawSubmitButton");l==null||l.focus()}},placeholder:"أدخل العمولة المطلوبة",type:"number",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"أدخل العمولة الإجمالية لإتمام عملية السحب"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(m,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const a=qt(),l=parseFloat(gt||"0")||0;let c=0;if((a==null?void 0:a.defaultWithdrawCommission)!=null){const x=Number(a.defaultWithdrawCommission)||0;c=Math.round(x*l/1e3*100)/100}else{const x=is&&is.trim()!==""?parseFloat(is):Math.round(l*.01*100)/100;c=Math.max(0,x)}const h=Ke?l+c:l;B((h||0).toString()),Ze?n({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):Y(!0)},children:"أجل"}),e.jsx(m,{type:"button",variant:"outline",size:"icon",title:Ke?"العمولة تُضاف":"العمولة تُخصم",onClick:()=>Zr(a=>!a),children:Ke?e.jsx(Zt,{className:"h-4 w-4 text-green-600"}):e.jsx(ha,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"text-xs text-gray-600",children:Ke?"العمولة تُضاف":"العمولة تُخصم"})]})]})})(),(A==null?void 0:A.showWithdrawNote)&&e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"ملاحظة السحب (اختياري)"}),e.jsxs("div",{className:"relative",children:[e.jsx(jd,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(R,{id:"withdrawNoteInput",value:u,onChange:t=>_(t.target.value),onKeyDown:t=>{if(t.key==="Enter"){const r=document.getElementById("withdrawSubmitButton");r==null||r.focus()}},placeholder:"أدخل ملاحظة للسحب (اختياري)",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]})]}),e.jsx("div",{className:"sticky bottom-0 z-10 pt-2 bg-white/80 backdrop-blur supports-[backdrop-filter]:bg-white/60",children:e.jsx(m,{id:"withdrawSubmitButton",onClick:hl,className:"w-full font-medium h-11 lg:h-12 text-sm lg:text-base btn-bounce hover-glow transition-all duration-300 bg-green-600 hover:bg-green-700 text-white",children:vi?"تم السحب بنجاح":"تأكيد السحب"})})]}),e.jsx(me,{open:M,onOpenChange:Y,children:e.jsxs(he,{children:[e.jsxs(ue,{children:[e.jsx(xe,{children:"تحويل مؤجل"}),e.jsx(us,{children:"أدخل بيانات صاحب الدين والمبلغ والملاحظات ثم اضغط حفظ"})]}),e.jsxs("div",{className:"space-y-3",children:[Rs&&Rs.length>0?e.jsxs("div",{children:[e.jsx(Z,{children:"اختيار عميل"}),e.jsxs(Xs,{value:Ue,onValueChange:t=>{Ve(t);const r=Rs.find(a=>a.id===t);r&&we(r.name)},children:[e.jsx(ea,{className:"w-full",children:e.jsx(ta,{placeholder:"اختر عميل"})}),e.jsx(sa,{children:Rs.map(t=>e.jsxs(Is,{value:t.id,children:[t.name,t.mobile?` — ${t.mobile}`:""]},t.id))})]})]}):e.jsx("div",{className:"text-xs text-gray-500",children:"لا يوجد عملاء مُسجلين حالياً. يمكنك إضافة عميل من نافذة الديون."}),e.jsxs("div",{children:[e.jsx(Z,{htmlFor:"quickDebtName",children:"اسم صاحب الدين"}),e.jsx(R,{id:"quickDebtName",value:Q,onChange:t=>we(t.target.value),placeholder:"اكتب الاسم"})]}),e.jsxs("div",{children:[e.jsx(Z,{htmlFor:"quickDebtAmount",children:"المبلغ (محسوب تلقائياً)"}),e.jsx(R,{id:"quickDebtAmount",type:"number",value:S,readOnly:!0,placeholder:"المبلغ + عمولة التحويل"})]}),e.jsxs("div",{children:[e.jsx(Z,{htmlFor:"quickDebtNotes",children:"ملاحظات"}),e.jsx(R,{id:"quickDebtNotes",value:se,onChange:t=>pe(t.target.value),placeholder:"اكتب ملاحظات (اختياري)"})]})]}),e.jsx(ze,{children:e.jsx(m,{type:"button",onClick:()=>{const t=qt(),r=parseFloat((gt||"").toString())||0;let a=0;if(re==="transfer")if((t==null?void 0:t.defaultTransferCommission)!=null){const h=Number(t.defaultTransferCommission)||0;a=Math.round(h*r/1e3*100)/100}else{const h=ls&&ls.trim()!==""?parseFloat(ls):0;a=Math.max(0,h)}else if((t==null?void 0:t.defaultWithdrawCommission)!=null){const h=Number(t.defaultWithdrawCommission)||0;a=Math.round(h*r/1e3*100)/100}else{const h=is&&is.trim()!==""?parseFloat(is):Math.round(r*.01*100)/100;a=Math.max(0,h)}let l=0;if(re==="withdraw"?l=Ke?r:Math.max(0,Math.round((r-a)*100)/100):l=Math.max(0,Math.round((r+a)*100)/100),!Q||isNaN(l)||l<=0){n({title:"خطأ في بيانات الأجل",description:"يرجى إدخال الاسم والمبلغ بشكل صحيح",variant:"destructive"});return}const c=Rs.find(h=>h.id===Ue);ut({debtorName:Q,amount:l,notes:se,customerId:Ue||void 0,mobile:c==null?void 0:c.mobile}),Mt(!1),Y(!1),n({title:"تم حفظ بيانات الأجل",description:"سيتم إضافة الدين عند تأكيد العملية",variant:"default"})},children:"حفظ"})})]})})]})]}),e.jsx(nt,{className:"bg-gradient-to-br from-red-50 to-red-100 border-red-200 fade-in-up card-float",children:e.jsxs(dt,{className:"p-3 text-center",children:[e.jsx("div",{className:"text-red-600 font-medium text-[10px] mb-1",children:"⚠️ تحذير من التحويل"}),e.jsx("div",{className:"text-[10px] text-red-700",children:"لا يمكن إلغاء أي عملية بعد تأكيدها للمحافظة على الأمان"})]})})]})]}),e.jsx(dm,{isOpen:Ao,onClose:()=>To(!1),initialEditingWallet:Po,onWalletUpdate:async()=>{try{await Or()}catch(t){console.error("Error reloading wallets after update:",t)}}}),e.jsx(mm,{isOpen:Eo,onClose:()=>mi(!1),transaction:Oo,onDelete:Gc}),e.jsx(xs,{open:Lo,onOpenChange:ka,onSuccess:ed,title:td(),description:sd(),mode:"verify"}),e.jsx(Al,{open:Bo,onOpenChange:an,onSuccess:()=>{an(!1),ui(!0)},title:"حماية أرشيف التقارير اليومية",description:"أدخل كلمة مرور تسجيل الدخول للوصول إلى الأرشيف"}),e.jsx(zm,{open:Ro,onOpenChange:ui,userId:s==null?void 0:s.uid}),e.jsx(kl,{open:jc,onOpenChange:Bi,onSuccess:rd,title:"تعديل الرصيد النقدي في الدرج",description:"أدخل الرقم السري والمبلغ الجديد لتعديل الرصيد النقدي في الدرج",currentBalance:ot,balanceLabel:"الرصيد النقدي",userId:s==null?void 0:s.uid}),e.jsx(kl,{open:Nc,onOpenChange:$i,onSuccess:nd,title:"تعديل رصيد المحفظة",description:"أدخل الرقم السري والمبلغ الجديد لتعديل رصيد المحفظة",currentBalance:hs&&Te[hs]||0,balanceLabel:`رصيد ${((pl=Ae.find(t=>t.id===hs))==null?void 0:pl.name)||"المحفظة"}`,userId:s==null?void 0:s.uid}),e.jsx(pm,{open:Sc,onOpenChange:Cn,onSuccess:id,title:"إضافة أو خصم مبلغ من رصيد المحفظة",description:"أدخل الرقم السري والمبلغ المراد إضافته أو خصمه من رصيد المحفظة",currentBalance:hs&&Te[hs]||0,balanceLabel:`رصيد ${((gl=Ae.find(t=>t.id===hs))==null?void 0:gl.name)||"المحفظة"}`,userId:s==null?void 0:s.uid}),e.jsx(hm,{open:_c,onOpenChange:Fc,userId:s==null?void 0:s.uid}),e.jsx(um,{open:Mc,onOpenChange:Lc,userId:s==null?void 0:s.uid}),e.jsx(xm,{open:Rc,onOpenChange:Bc}),e.jsx(me,{open:Ic,onOpenChange:gr,children:e.jsxs(he,{className:"sm:max-w-md",children:[e.jsx(ue,{children:e.jsx(xe,{className:"text-right",children:"تعديل الدرج النقدية"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(Z,{htmlFor:"amount",className:"text-right block",children:"المبلغ"}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx(R,{id:"amount",type:"number",placeholder:"أدخل المبلغ",value:An,onChange:t=>fr(t.target.value),className:"text-right flex-1",dir:"rtl",min:"0"}),e.jsxs("div",{className:"flex gap-1",children:[e.jsxs(m,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white px-3 py-2",onClick:async()=>{if(!await zn(_n)){n({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}const t=parseFloat(An);if(isNaN(t)||t<=0){n({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const r=ot+t;Gt(r);const a={cashBalance:r,lastUpdated:new Date().toISOString()},l=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(l,JSON.stringify(a)),s!=null&&s.uid?Ce.updateUserData(s.uid,a).then(()=>{console.log("✅ تم حفظ رصيد الدرج النقدي في Firebase بنجاح"),localStorage.removeItem(l),Ne(!1)}).catch(c=>{console.error("❌ خطأ في حفظ الرصيد في Firebase:",c),Ne(!0)}):Ne(!0),n({title:"تم بنجاح",description:`تم إضافة ${t} جنيه إلى الدرج النقدية وحفظه في السحابة`}),gr(!1),fr(""),Sr("")},children:[e.jsx(Zt,{className:"h-1 w-1 mr-1"}),"إضافة"]}),e.jsxs(m,{type:"button",size:"sm",className:"bg-red-600 hover:bg-red-700 text-white px-3 py-2",onClick:async()=>{if(!await zn(_n)){n({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}const t=parseFloat(An);if(isNaN(t)||t<=0){n({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const r=ot-t;Gt(r);const a={cashBalance:r,lastUpdated:new Date().toISOString()},l=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(l,JSON.stringify(a)),s!=null&&s.uid?Ce.updateUserData(s.uid,a).then(()=>{console.log("✅ تم حفظ رصيد الدرج النقدي في Firebase بنجاح"),localStorage.removeItem(l),Ne(!1)}).catch(c=>{console.error("❌ خطأ في حفظ الرصيد في Firebase:",c),Ne(!0)}):Ne(!0),n({title:"تم بنجاح",description:`تم خصم ${t} جنيه من الدرج النقدية وحفظه في السحابة`}),gr(!1),fr(""),Sr("")},children:[e.jsx(ha,{className:"h-1 w-1 mr-1"}),"خصم"]})]})]}),e.jsxs("p",{className:"text-[10px] text-gray-500 text-right",children:["الرصيد الحالي: ",ot.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(Z,{htmlFor:"pin",className:"text-right block",children:"الرقم السري"}),e.jsx(R,{id:"pin",type:"password",placeholder:"أدخل الرقم السري",value:_n,onChange:t=>Sr(t.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsx(ze,{className:"flex gap-2",children:e.jsx(m,{variant:"outline",onClick:()=>{gr(!1),fr(""),Sr("")},children:"إلغاء"})})]})}),e.jsx(me,{open:Vc,onOpenChange:Tr,children:e.jsxs(he,{className:"sm:max-w-md",children:[e.jsx(ue,{children:e.jsx(xe,{className:"text-right text-red-600",children:"تصفير إجمالي المحفظة"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-red-50 rounded-lg border border-red-200",children:[e.jsx("p",{className:"text-red-800 font-medium mb-2",children:"تحذير!"}),e.jsx("p",{className:"text-red-700 text-sm",children:"سيتم تصفير جميع أرصدة المحافظ إلى صفر. هذا الإجراء لا يمكن التراجع عنه."}),e.jsxs("p",{className:"text-red-600 text-sm mt-2",children:["الرصيد الحالي: ",Object.values(Te).reduce((t,r)=>t+r,0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(Z,{htmlFor:"resetWalletTotalPin",className:"text-right block",children:"الرقم السري الرئيسي"}),e.jsx(R,{id:"resetWalletTotalPin",type:"password",placeholder:"أدخل الرقم السري الرئيسي",value:ol,onChange:t=>Pr(t.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsxs(ze,{className:"flex gap-2",children:[e.jsx(m,{variant:"outline",onClick:()=>{Tr(!1),Pr("")},children:"إلغاء"}),e.jsx(m,{variant:"destructive",onClick:async()=>{if(!await Xt.verifyMasterPin(ol,s==null?void 0:s.uid)){n({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}try{const r={};Object.keys(Te).forEach(h=>{r[h]=0}),Vt(r),localStorage.setItem(ms(),JSON.stringify(r)),Tr(!1),Pr("");const a=new Date().toISOString(),l={walletBalances:r,lastUpdated:a},c=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(c,JSON.stringify(l)),s!=null&&s.uid?Ce.updateUserData(s.uid,l).then(()=>{localStorage.removeItem(c),Ne(!1)}).catch(h=>{console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",h),Ne(!0),n({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):Ne(!0),setTimeout(()=>{Vt({...r})},100)}catch(r){console.error("خطأ في تصفير أرصدة المحافظ:",r),n({title:"خطأ",description:"حدث خطأ أثناء تصفير المحافظ",variant:"destructive"})}},children:"تصفير المحفظة"})]})]})}),e.jsx(me,{open:Dc,onOpenChange:pr,children:e.jsxs(he,{className:"sm:max-w-md",children:[e.jsx(ue,{children:e.jsx(xe,{className:"text-right text-red-600",children:"تصفير رصيد المحفظة المختارة"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-red-50 rounded-lg border border-red-200",children:[e.jsx("p",{className:"text-red-800 font-medium mb-2",children:"تحذير!"}),e.jsx("p",{className:"text-red-700 text-sm",children:"سيتم تصفير رصيد المحفظة المحددة إلى صفر. هذا الإجراء لا يمكن التراجع عنه."}),e.jsxs("p",{className:"text-red-600 text-sm mt-2",children:["المحفظة: ",((fl=Ae.find(t=>t.id===G))==null?void 0:fl.name)||G]}),e.jsxs("p",{className:"text-red-600 text-sm",children:["الرصيد الحالي: ",(G&&Te[G]?Te[G]:0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(Z,{htmlFor:"resetSelectedWalletPin",className:"text-right block",children:"الرقم السري الرئيسي"}),e.jsx(R,{id:"resetSelectedWalletPin",type:"password",autoComplete:"off",placeholder:"أدخل الرقم السري الرئيسي",value:Ui,onChange:t=>In(t.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsxs(ze,{className:"flex gap-2",children:[e.jsx(m,{variant:"outline",onClick:()=>{pr(!1),In("")},children:"إلغاء"}),e.jsx(m,{variant:"destructive",onClick:async()=>{var r;if(!G){n({title:"اختر محفظة",description:"يرجى اختيار محفظة أولاً",variant:"destructive"});return}if(!await Xt.verifyMasterPin(Ui,s==null?void 0:s.uid)){n({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}try{const a={...Te};a[G]=0,Vt(a),localStorage.setItem(ms(),JSON.stringify(a)),pr(!1),In("");const l=new Date().toISOString(),c={walletBalances:a,lastUpdated:l},h=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(h,JSON.stringify(c)),s!=null&&s.uid?Ce.updateUserData(s.uid,c).then(()=>{localStorage.removeItem(h),Ne(!1)}).catch(x=>{console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",x),Ne(!0),n({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):Ne(!0),n({title:"تم التصفير بنجاح",description:`تم تصفير رصيد المحفظة ${((r=Ae.find(x=>x.id===G))==null?void 0:r.name)||G}`})}catch(a){console.error("خطأ في تصفير رصيد المحفظة المختارة:",a),n({title:"خطأ",description:"حدث خطأ أثناء تصفير رصيد المحفظة المختارة",variant:"destructive"})}},children:"تصفير المحفظة"})]})]})}),e.jsx(me,{open:zc,onOpenChange:Ir,children:e.jsxs(he,{className:"sm:max-w-md",children:[e.jsx(ue,{children:e.jsxs(xe,{className:"text-right text-green-600 flex items-center gap-2 justify-end",children:[e.jsx(Zt,{className:"h-4 w-4"}),"إضافة أموال لإجمالي المحفظة"]})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-green-50 rounded-lg border border-green-200",children:[e.jsx("p",{className:"text-green-800 font-medium mb-2",children:"إضافة أموال"}),e.jsx("p",{className:"text-green-700 text-sm",children:"سيتم إضافة المبلغ المحدد إلى إجمالي المحفظة بشكل متناسب على جميع المحافظ."}),e.jsxs("p",{className:"text-green-600 text-sm mt-2",children:["الرصيد الحالي: ",Object.values(Te).reduce((t,r)=>t+r,0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"addWalletTotalAmount",className:"text-right block",children:"المبلغ المراد إضافته"}),e.jsx(R,{id:"addWalletTotalAmount",type:"number",placeholder:"أدخل المبلغ",value:tl,onChange:t=>Rn(t.target.value),className:"text-right",dir:"rtl"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"addWalletTotalPin",className:"text-right block",children:"الرقم السري للتأكيد"}),e.jsx(R,{id:"addWalletTotalPin",type:"password",autoComplete:"off",placeholder:"أدخل الرقم السري",value:sl,onChange:t=>Bn(t.target.value),className:"text-right",dir:"rtl"})]})]})]}),e.jsxs(ze,{className:"flex gap-2",children:[e.jsx(m,{variant:"outline",onClick:()=>{Ir(!1),Rn(""),Bn("")},children:"إلغاء"}),e.jsx(m,{variant:"default",className:"bg-green-600 hover:bg-green-700",disabled:al,onClick:async()=>{const t=parseFloat(tl);if(!t||t<=0){n({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}if(!await Yc(sl)){n({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}rl(!0);try{const r=Object.values(Te).reduce((a,l)=>a+l,0);if(r===0){const a=Object.keys(Te),l=t/a.length,c={};a.forEach(h=>{c[h]=l}),Vt(c),localStorage.setItem(ms(),JSON.stringify(c)),s!=null&&s.uid?await Ce.updateUserData(s.uid,{walletBalances:c,lastUpdated:new Date().toISOString()}):Ne(!0)}else{const a={};Object.entries(Te).forEach(([l,c])=>{const h=c/r,x=t*h;a[l]=c+x}),Vt(a),localStorage.setItem(ms(),JSON.stringify(a)),s!=null&&s.uid?await Ce.updateUserData(s.uid,{walletBalances:a,lastUpdated:new Date().toISOString()}):Ne(!0)}setTimeout(()=>{Vt(a=>({...a}))},100),Ir(!1),Rn(""),Bn("")}catch(r){console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",r),n({title:"خطأ",description:"حدث خطأ أثناء حفظ البيانات",variant:"destructive"})}finally{rl(!1)}},children:al?"جاري الإضافة...":"إضافة الأموال"})]})]})}),e.jsx(me,{open:Jc,onOpenChange:kr,children:e.jsxs(he,{className:"sm:max-w-[425px]",children:[e.jsx(ue,{children:e.jsxs(xe,{className:"text-red-600 flex items-center gap-2",children:[e.jsx(Jt,{className:"h-1 w-1"}),"تصفير الرصيد النقدي"]})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-3",children:e.jsx("p",{className:"text-sm text-red-700",children:"⚠️ تحذير: سيتم تصفير الرصيد النقدي في الدرج إلى صفر. هذا الإجراء لا يمكن التراجع عنه."})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(Z,{htmlFor:"resetCashPin",children:"الرقم السري الرئيسي"}),e.jsx(R,{id:"resetCashPin",type:"password",autoComplete:"off",placeholder:"أدخل الرقم السري الرئيسي",value:$n,onChange:t=>Un(t.target.value)})]})]}),e.jsxs(ze,{children:[e.jsx(m,{variant:"outline",onClick:()=>{kr(!1),Un("")},children:"إلغاء"}),e.jsx(m,{variant:"destructive",onClick:async()=>{if(!$n){n({title:"خطأ",description:"يرجى إدخال الرقم السري",variant:"destructive"});return}if(!await Xt.verifyMasterPin($n,s==null?void 0:s.uid)){n({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}try{Gt(0),kr(!1),Un("");const r={cashBalance:0,lastUpdated:new Date().toISOString()};localStorage.setItem(Ds(),"0");const a=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(a,JSON.stringify(r)),s!=null&&s.uid?Ce.updateUserData(s.uid,r).then(()=>{localStorage.removeItem(a),Ne(!1)}).catch(l=>{console.error("خطأ في حفظ الرصيد في Firebase:",l),Ne(!0),n({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):Ne(!0)}catch(r){console.error("خطأ في تصفير الرصيد النقدي:",r),n({title:"خطأ",description:"حدث خطأ أثناء تصفير الرصيد النقدي",variant:"destructive"})}},children:"تصفير الرصيد"})]})]})}),e.jsx(wm,{open:Uc,onOpenChange:el,userId:s==null?void 0:s.uid,cashBalance:ot,walletBalances:Te,transactions:Qe}),e.jsx(me,{open:$c,onOpenChange:Dr,children:e.jsxs(he,{className:"sm:max-w-[425px]",children:[e.jsx(ue,{children:e.jsxs(xe,{className:"text-green-600 flex items-center gap-2",children:[e.jsx(Zt,{className:"h-4 w-4"}),"إضافة أموال للدرج"]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-3",children:e.jsx("p",{className:"text-sm text-green-700",children:"💰 سيتم إضافة المبلغ المحدد إلى الرصيد النقدي في الدرج"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"addCashAmount",children:"المبلغ المراد إضافته"}),e.jsx(R,{id:"addCashAmount",type:"number",placeholder:"أدخل المبلغ",value:Cr,onChange:t=>Fn(t.target.value),min:"0",step:"0.01"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"addCashPin",children:"الرقم السري لدرج النقدية"}),e.jsx(R,{id:"addCashPin",type:"password",placeholder:"أدخل الرقم السري",value:Mn,onChange:t=>Ln(t.target.value)})]})]}),e.jsxs(ze,{children:[e.jsx(m,{variant:"outline",onClick:()=>{Dr(!1),Fn(""),Ln("")},children:"إلغاء"}),e.jsx(m,{variant:"default",className:"bg-green-600 hover:bg-green-700",disabled:Zi,onClick:async()=>{if(!Cr||parseFloat(Cr)<=0){n({title:"خطأ",description:"يرجى إدخال مبلغ صحيح أكبر من صفر",variant:"destructive"});return}if(!Mn){n({title:"خطأ",description:"يرجى إدخال الرقم السري",variant:"destructive"});return}if(!await zn(Mn)){n({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}Xi(!0);try{const t=parseFloat(Cr),r=ot+t;Gt(r),localStorage.setItem(Ds(),r.toString());const a={cashBalance:r,lastUpdated:new Date().toISOString()},l=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(l,JSON.stringify(a)),s!=null&&s.uid?(await Ce.updateUserData(s.uid,a),localStorage.removeItem(l),Ne(!1)):Ne(!0),Dr(!1),Fn(""),Ln("")}catch(t){console.error("خطأ في حفظ الرصيد في Firebase:",t),Gt(ot),localStorage.setItem("cashBalance",ot.toString()),n({title:"خطأ",description:"حدث خطأ أثناء حفظ البيانات، يرجى المحاولة مرة أخرى",variant:"destructive"})}finally{Xi(!1)}},children:Zi?"جاري الإضافة...":"إضافة الأموال"})]})]})}),e.jsx(me,{open:wc,onOpenChange:Dn,children:e.jsxs(he,{className:"sm:max-w-md",children:[e.jsx(ue,{children:e.jsx(xe,{className:"text-right",children:"اختيار التاريخ والوقت للبحث"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(Z,{htmlFor:"search-date",className:"text-right block",children:"التاريخ"}),e.jsx(R,{id:"search-date",type:"date",value:ir,onChange:t=>fi(t.target.value),className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(Z,{htmlFor:"search-time",className:"text-right block",children:"الوقت (اختياري)"}),e.jsx(R,{id:"search-time",type:"time",value:lr,onChange:t=>yi(t.target.value),className:"text-right",placeholder:"اختر الوقت للبحث في ساعة محددة"}),e.jsx("p",{className:"text-[10px] text-gray-500 text-right",children:"إذا لم تختر وقتاً محدداً، سيتم البحث في كامل اليوم"})]})]}),e.jsxs(ze,{className:"flex justify-between",children:[e.jsx(m,{variant:"outline",onClick:()=>{fi(""),yi(""),Dn(!1)},children:"مسح"}),e.jsx(m,{onClick:()=>Dn(!1),children:"تطبيق"})]})]})}),e.jsx(El,{isOpen:ts&&!Oe,onClose:()=>$e(!1),onTrialStarted:vc}),e.jsx(vm,{isOpen:Ho,onClose:()=>ln(!1)}),e.jsx(bm,{isOpen:en,onClose:()=>Ta(!1),initialBarcode:Co}),e.jsx(Bd,{isOpen:Go,onClose:()=>or(!1)}),e.jsx($d,{open:Qo,onOpenChange:cr}),e.jsx(Fm,{open:Zo,onOpenChange:t=>{if(t&&!ks){n({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});return}dr(t)}}),e.jsx(qm,{open:U,onOpenChange:t=>{if(t&&!ks){n({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}C(t)}}),e.jsx(Vm,{open:L,onOpenChange:t=>{if(t&&!ks){n({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}q(t)}}),e.jsx(me,{open:Ac,onOpenChange:t=>{if(t){n({title:"قيد التطوير",description:"هذه الميزة غير متاحة حالياً."});return}Tn(!1)},children:e.jsxs(he,{dir:"rtl",className:"sm:max-w-md w-[95vw] sm:w-auto rounded-2xl border border-emerald-200 shadow-xl bg-gradient-to-br from-white via-green-50 to-emerald-50 backdrop-blur-md data-[state=open]:animate-in data-[state=open]:fade-in-0 data-[state=open]:zoom-in-90 data-[state=open]:slide-in-from-bottom-8 duration-300",children:[e.jsxs(ue,{children:[e.jsx(xe,{className:"text-right text-green-700",children:"شحن رصيد الموبايل"}),e.jsx(us,{className:"text-right text-gray-600",children:"أدخل البيانات ثم اضغط تأكيد"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx(Z,{htmlFor:"topupPhone",className:"text-right block",children:"رقم الموبايل"}),e.jsx(R,{id:"topupPhone",value:yr,onChange:t=>zi(t.target.value),placeholder:"010xxxxxxx",className:"text-right"})]}),e.jsxs("div",{children:[e.jsx(Z,{className:"text-right block",children:"شركة التشغيل"}),e.jsxs(Xs,{value:vr,onValueChange:qi,children:[e.jsx(ea,{className:"text-right",children:e.jsx(ta,{placeholder:"اختر الشركة"})}),e.jsxs(sa,{children:[e.jsx(Is,{value:"vodafone",children:"فودافون"}),e.jsx(Is,{value:"orange",children:"أورنج"}),e.jsx(Is,{value:"etisalat",children:"اتصالات"}),e.jsx(Is,{value:"we",children:"WE"})]})]})]}),e.jsxs("div",{children:[e.jsx(Z,{htmlFor:"topupAmount",className:"text-right block",children:"المبلغ بالجنيه"}),e.jsx(R,{id:"topupAmount",type:"number",value:br,onChange:t=>Vi(t.target.value?Number(t.target.value):""),placeholder:"50",className:"text-right"})]})]}),e.jsxs(ze,{className:"flex gap-2 justify-between",children:[e.jsx(m,{variant:"outline",onClick:()=>Tn(!1),className:"border-gray-300",children:"إلغاء"}),e.jsx(m,{onClick:f,disabled:Ji||!yr||!vr||!br,className:"bg-emerald-600 hover:bg-emerald-700 text-white",children:Ji?"جارٍ التنفيذ...":"تأكيد الشحن"})]})]})}),e.jsx(xs,{open:nc,onOpenChange:cn,mode:"verify",title:"الرقم السري الرئيسي لفتح الديون",description:"أدخل الرقم السري الرئيسي لفتح صفحة الديون",onSuccess:()=>{cn(!1),wa(!0)}}),e.jsx(xs,{open:lc,onOpenChange:Di,mode:"verify",title:"تأكيد تغيير طلب الرقم السري للديون",description:"أدخل الرقم السري الرئيسي لتفعيل أو إلغاء طلب الرقم السري عند فتح الديون",onSuccess:async()=>{if(Ci!==null){const t=Ci;Si(t);try{const r=s==null?void 0:s.uid,a=r?`debtsPinRequired_${r}`:"debtsPinRequired";localStorage.setItem(a,String(t)),r&&await Ce.updateUserData(r,{debtsPinRequired:t})}catch{}n({title:t?"تم تفعيل طلب الرقم السري للديون":"تم إلغاء طلب الرقم السري للديون",description:t?"سيُطلب الرقم السري الرئيسي عند فتح نافذة الديون.":"يمكن فتح نافذة الديون بدون طلب الرقم السري."})}oc(null),Di(!1)}}),e.jsx(Al,{open:Cc,onOpenChange:Ba,title:"تأكيد كلمة المرور لتصفير المعاملات الأخيرة",description:"سيتم حذف كل المعاملات السابقة نهائيًا من حسابك وFirebase.",onSuccess:async()=>{try{if(!(s!=null&&s.uid)){Ba(!1);return}const t=new Date,r=l=>l instanceof Date?l:typeof(l==null?void 0:l.toDate)=="function"?l.toDate():new Date(String(l)),a=Qe.filter(l=>r(l.createdAt)<t);await Ce.updateUserData(s.uid,{recentReset:{keepLastCount:Sa.keepLastCount??20,intervalDays:Sa.intervalDays??7,lastResetAt:t}}),Ar(l=>({...l,lastResetAt:t})),n({title:"تم إخفاء المعاملات السابقة",description:"تم إخفاء كل الإيصالات الأقدم من وقت التصفير من العرض بدون التأثير على تقارير اليوم/الشهر أو الحدود."})}catch(t){console.error("فشل تنفيذ التصفير النهائي:",t),n({title:"فشل التصفير",description:"تحقق من الاتصال ثم أعد المحاولة.",variant:"destructive"})}finally{Ba(!1)}}}),e.jsx(xs,{open:H,onOpenChange:ie,mode:"verify",title:"الرقم السري لفتح مصروفات المحل",description:"أدخل الرقم السري الرئيسي لفتح نافذة مصروفات المحل",onSuccess:()=>{ie(!1),Se(!0)}}),e.jsx(me,{open:rc,onOpenChange:wa,children:e.jsxs(he,{className:"sm:max-w-[425px]",children:[e.jsxs(ue,{className:"flex items-center justify-between",children:[e.jsx(xe,{className:"text-right",children:"إدارة الديون"}),e.jsxs("div",{className:"flex items-center gap-1 text-orange-700",children:[e.jsx(Pl,{className:"h-4 w-4"}),e.jsxs("span",{className:"text-xs font-bold",children:[Xc," جنيه"]})]})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Z,{htmlFor:"debtorName",className:"text-right col-span-1",children:"اسم المديون"}),e.jsx(R,{id:"debtorName",value:dn,onChange:t=>Ii(t.target.value),className:"col-span-3 text-right",placeholder:"أدخل اسم المديون"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Z,{htmlFor:"debtAmount",className:"text-right col-span-1",children:"المبلغ"}),e.jsx(R,{id:"debtAmount",type:"number",value:mn,onChange:t=>Ai(t.target.value),className:"col-span-3 text-right",placeholder:"أدخل المبلغ"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Z,{htmlFor:"debtReason",className:"text-right col-span-1",children:"سبب الدين"}),e.jsx(R,{id:"debtReason",value:hn,onChange:t=>Ti(t.target.value),className:"col-span-3 text-right",placeholder:"أدخل سبب الدين"})]})]}),e.jsx(ze,{children:e.jsx(m,{onClick:()=>{if(dn&&mn&&hn){const t={id:Date.now().toString(),debtorName:dn,amount:parseFloat(mn),reason:hn,status:"pending",createdAt:new Date,paidAmount:0,partialPayments:[]};jn(t),La(!0)}else n({title:"بيانات غير مكتملة",description:"يرجى إدخال الاسم والمبلغ والسبب",variant:"destructive"})},className:"bg-orange-500 hover:bg-orange-600",children:"حفظ"})}),e.jsx("div",{className:"mt-2",children:e.jsx(m,{variant:"outline",className:"w-full",onClick:()=>Ma(!0),children:"إيصالات الديون"})}),e.jsx("div",{className:"mt-2",children:e.jsx(m,{variant:"outline",className:"w-full",onClick:()=>fn(!0),children:"إضافة عميل"})})]})}),e.jsx(me,{open:hc,onOpenChange:Ma,children:e.jsxs(he,{className:"sm:max-w-[520px]",children:[e.jsxs(ue,{children:[e.jsx(xe,{className:"text-right",children:"إيصالات الديون"}),e.jsx(us,{className:"text-right",children:"اختر دينًا لعرض إيصاله بالتفصيل"})]}),kt.length>0?e.jsx("div",{className:"max-h-64 overflow-y-auto space-y-2",children:kt.map(t=>e.jsx("div",{onClick:()=>{_a(t),Gs(!0),Ma(!1),wa(!1)},className:"p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium",children:t.debtorName}),e.jsx("p",{className:"text-sm text-gray-600",children:t.reason}),e.jsx("p",{className:"text-sm text-gray-500",children:Wr.format(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt))})]}),e.jsxs("div",{className:"text-left",children:[e.jsxs("p",{className:"font-bold text-lg",children:[t.amount," جنيه"]}),e.jsx(Wt,{variant:t.status==="paid"?"default":"secondary",className:t.status==="paid"?"bg-green-500":"bg-yellow-500",children:t.status==="paid"?"مدفوع":"قيد المراجعة"})]})]})},t.id))}):e.jsx("div",{className:"text-center text-sm text-gray-500",children:"لا توجد ديون مسجلة"}),e.jsxs(ze,{className:"flex justify-between mt-3",children:[e.jsx(m,{variant:"destructive",onClick:async()=>{try{if(!kt||kt.length===0){n({title:"لا توجد ديون",description:"القائمة فارغة بالفعل."});return}if(!window.confirm("هل تريد حذف كل إيصالات الديون؟ هذا الإجراء لا يمكن التراجع عنه."))return;const r=[];cs(r),_a(null),await bs(r),n({title:"تم حذف كل إيصالات الديون",description:"تم تفريغ القائمة بالكامل."}),Ma(!1)}catch(t){console.error("تعذر حذف كل إيصالات الديون:",t),n({title:"فشل الحذف",description:"حدث خطأ أثناء الحذف، حاول مرة أخرى.",variant:"destructive"})}},children:"حذف كل الإيصالات"}),e.jsx(m,{variant:"outline",onClick:()=>Ma(!1),children:"إغلاق"})]})]})}),e.jsx(me,{open:uc,onOpenChange:fn,children:e.jsxs(he,{className:"sm:max-w-[480px]",children:[e.jsxs(ue,{children:[e.jsx(xe,{className:"text-right",children:"إضافة عميل"}),e.jsx(us,{className:"text-right",children:"أدخل بيانات العميل ثم يمكنك تسجيل مبلغ دين عليه"})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Z,{htmlFor:"customerName",className:"text-right col-span-1",children:"اسم العميل"}),e.jsx(R,{id:"customerName",value:vn,onChange:t=>Wi(t.target.value),className:"col-span-3 text-right",placeholder:"اكتب اسم العميل"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Z,{htmlFor:"customerMobile",className:"text-right col-span-1",children:"رقم الموبايل"}),e.jsx(R,{id:"customerMobile",value:bn,onChange:t=>_i(t.target.value),className:"col-span-3 text-right",placeholder:"اكتب رقم الموبايل"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(m,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{if(!vn||!bn){n({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم العميل ورقم الموبايل",variant:"destructive"});return}const t={id:Date.now().toString(),name:vn.trim(),mobile:bn.trim(),createdAt:new Date},r=[t,...Rs];await Oc(r),Wi(""),_i(""),n({title:"تمت إضافة العميل",description:`تم إضافة ${t.name}`})},children:"إضافة"})}),e.jsxs("div",{className:"border-t pt-4 space-y-3",children:[e.jsx(Z,{className:"text-right block",children:"إضافة مبلغ على عميل"}),Rs.length>0?e.jsxs("div",{className:"space-y-3",children:[e.jsxs(Xs,{value:wn,onValueChange:Fi,children:[e.jsx(ea,{className:"w-full",children:e.jsx(ta,{placeholder:"اختر عميل"})}),e.jsx(sa,{children:Rs.map(t=>e.jsxs(Is,{value:t.id,children:[t.name," — ",t.mobile]},t.id))})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Z,{htmlFor:"customerDebtAmount",className:"text-right col-span-1",children:"المبلغ"}),e.jsx(R,{id:"customerDebtAmount",type:"number",value:Mi,onChange:t=>Li(t.target.value),className:"col-span-3 text-right",placeholder:"أدخل المبلغ"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(m,{className:"bg-orange-600 hover:bg-orange-700",onClick:async()=>{const t=parseFloat(Mi);if(!wn){n({title:"اختر عميل",description:"يرجى اختيار عميل أولاً",variant:"destructive"});return}if(isNaN(t)||t<=0){n({title:"قيمة غير صحيحة",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const r=Rs.find(c=>c.id===wn);if(!r)return;const a={id:Date.now().toString(),debtorName:r.name,customerId:r.id,mobile:r.mobile,amount:Number(t.toFixed(2)),reason:"دين عميل",status:"pending",createdAt:new Date,paidAmount:0,partialPayments:[]},l=[...kt,a];cs(l),await bs(l),Fi(""),Li(""),n({title:"تم تسجيل المبلغ على العميل",description:`تمت إضافة ${a.amount} جنيه للعميل ${r.name}`})},children:"إضافة المبلغ"})})]}):e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد عملاء مسجلين. أضف عميلًا أولاً."})]})]}),e.jsx(ze,{className:"flex justify-end",children:e.jsx(m,{variant:"outline",onClick:()=>fn(!1),children:"إغلاق"})})]})}),e.jsx(me,{open:ae,onOpenChange:Se,children:e.jsxs(he,{className:"sm:max-w-[520px]",children:[e.jsxs(ue,{children:[e.jsx(xe,{className:"text-right",children:"مصروفات المحل"}),e.jsx(us,{className:"text-right",children:"أدخل تفاصيل المصروف ثم اختر مصدر الخصم."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Z,{htmlFor:"expenseName",className:"text-right col-span-1",children:"اسم المصروف"}),e.jsx(R,{id:"expenseName",value:Re,onChange:t=>_t(t.target.value),className:"col-span-3 text-right",placeholder:"مثال: كهرباء، صيانة، مشتريات"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Z,{htmlFor:"expenseAmount",className:"text-right col-span-1",children:"تمن المصروف"}),e.jsx(R,{id:"expenseAmount",type:"number",value:vt,onChange:t=>xt(t.target.value),className:"col-span-3 text-right",placeholder:"0.00"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Z,{htmlFor:"expenseNotes",className:"text-right col-span-1",children:"ملاحظات"}),e.jsx(R,{id:"expenseNotes",value:Be,onChange:t=>bt(t.target.value),className:"col-span-3 text-right",placeholder:"معلومات إضافية إن وجدت"})]})]}),e.jsxs(ze,{className:"flex justify-between",children:[e.jsx(m,{className:"bg-orange-600 hover:bg-orange-700",onClick:()=>{if(!Re||!vt){n({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم المصروف وقيمته",variant:"destructive"});return}pt(!0)},children:"إضافة مصروف"}),e.jsx(m,{variant:"outline",onClick:()=>Nt(!0),children:"إيصالات المصاريف"})]})]})}),e.jsx(me,{open:jt,onOpenChange:Nt,children:e.jsxs(he,{className:"sm:max-w-[420px]",dir:"rtl",children:[e.jsxs(ue,{children:[e.jsx(xe,{className:"text-right",children:"إيصالات المصاريف"}),e.jsx(us,{className:"text-right",children:"آخر المصاريف المسجلة"})]}),wt.length>0?e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:wt.map(t=>e.jsx("div",{className:"p-2 border rounded-lg bg-white hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium text-sm",children:t.name}),e.jsx("p",{className:"text-[11px] text-gray-600",children:t.notes||"بدون ملاحظات"}),e.jsx("p",{className:"text-[10px] text-gray-500",children:new Date(t.createdAt).toLocaleString("ar-EG")})]}),e.jsxs("div",{className:"text-left flex items-start gap-2",children:[e.jsxs("div",{className:"text-left",children:[e.jsxs("p",{className:"font-bold text-sm",children:[t.amount," جنيه"]}),e.jsx(Wt,{variant:"secondary",className:t.source==="cash"?"bg-blue-100 text-blue-700":"bg-purple-100 text-purple-700",children:t.source==="cash"?"من النقدية":`من المحفظة${t.walletId?` (${t.walletId})`:""}`})]}),e.jsxs(m,{variant:"destructive",size:"sm",className:"shrink-0",onClick:()=>Pc(t.id),title:"حذف نهائي",children:[e.jsx(Jt,{className:"w-4 h-4 ml-1"}),"حذف"]})]})]})},t.id))}):e.jsx("p",{className:"text-sm text-gray-500 text-center",children:"لا توجد مصاريف مسجلة بعد"})]})}),e.jsx(me,{open:Ye,onOpenChange:pt,children:e.jsxs(he,{className:"sm:max-w-[480px]",children:[e.jsx(ue,{children:e.jsx(xe,{className:"text-right",children:"اختيار مصدر خصم المصروف"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600 text-right",children:"اختر هل تريد خصم مبلغ المصروف من الرصيد النقدي في الدرج أم من إحدى المحافظ."}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsx(m,{variant:qe==="cash"?"default":"outline",className:qe==="cash"?"bg-blue-600 hover:bg-blue-700 text-white":"",onClick:()=>Pt("cash"),children:"الفلوس النقدية"}),e.jsx(m,{variant:qe==="wallet"?"default":"outline",className:qe==="wallet"?"bg-purple-600 hover:bg-purple-700 text-white":"",onClick:()=>Pt("wallet"),children:"أرصدة المحافظ"}),e.jsx(m,{variant:qe==="fawry"?"default":"outline",className:qe==="fawry"?"bg-amber-600 hover:bg-amber-700 text-white":"",onClick:()=>Pt("fawry"),children:"فوري"})]}),qe==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{className:"text-right block",children:"اختر المحفظة للخصم"}),e.jsxs(Xs,{value:E,onValueChange:ne,children:[e.jsx(ea,{className:"w-full",children:e.jsx(ta,{placeholder:"اختر محفظة"})}),e.jsx(sa,{children:Ae.map(t=>e.jsx(Is,{value:t.id,children:t.phone||t.name||t.id},t.id))})]})]})]}),e.jsxs(ze,{className:"flex justify-between",children:[e.jsx(m,{variant:"outline",onClick:()=>{pt(!1),Pt(null),ne("")},children:"إلغاء"}),e.jsx(m,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{const t=Number(vt);if(isNaN(t)||t<=0){n({title:"قيمة غير صحيحة",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}if(!qe){n({title:"اختر مصدر الخصم",description:"يرجى اختيار النقدية أو المحفظة",variant:"destructive"});return}try{if(qe==="cash"){const c=Number((ot-t).toFixed(2));Gt(c),localStorage.setItem(Ds(),c.toString());const h={cashBalance:c,lastUpdated:new Date().toISOString()},x=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(x,JSON.stringify(h)),s!=null&&s.uid?(await Ce.updateUserData(s.uid,h),localStorage.removeItem(x),Ne(!1)):Ne(!0)}else if(qe==="wallet"){if(!E){n({title:"اختر محفظة",description:"يرجى اختيار محفظة للخصم",variant:"destructive"});return}const c=Te[E]||0,h=Number((c-t).toFixed(2)),x={...Te,[E]:h};Vt(x);const v=new Date().toISOString(),w={walletBalances:x,lastUpdated:v},y=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(y,JSON.stringify(w)),localStorage.setItem(ms(),JSON.stringify(x)),localStorage.setItem(`walletBalances_backup_${v}`,JSON.stringify(x)),s!=null&&s.uid&&await Ce.updateUserData(s.uid,w)}}catch(c){console.error("خطأ أثناء تحديث الأرصدة عند حفظ المصروف:",c)}let r=Date.now().toString();try{if(s!=null&&s.uid){const{addDoc:c,collection:h,serverTimestamp:x}=await rt(async()=>{const{addDoc:y,collection:D,serverTimestamp:T}=await import("./index-Bp5r4OnK.js").then($=>$.bf);return{addDoc:y,collection:D,serverTimestamp:T}},__vite__mapDeps([0,1]),import.meta.url),{db:v}=await rt(async()=>{const{db:y}=await import("./index-Bp5r4OnK.js").then(D=>D.bg);return{db:y}},__vite__mapDeps([0,1]),import.meta.url);r=(await c(h(v,"shop_expenses"),{userId:s.uid,shopId:(A==null?void 0:A.shopId)||s.uid||"default-shop",name:Re,amount:t,notes:Be||"",source:qe,walletId:qe==="wallet"?E:null,createdAt:x()})).id}}catch(c){console.error("خطأ أثناء حفظ المصروف في Firestore:",c)}const a={id:r,name:Re,amount:t,notes:Be,source:qe,walletId:qe==="wallet"?E:void 0,createdAt:new Date},l=[...wt,a];await Gi(l),_t(""),xt(""),bt(""),Pt(null),ne(""),pt(!1),Se(!0),Nt(!0),n({title:"تم إضافة المصروف",description:qe==="cash"?"تم الخصم من النقدية":qe==="wallet"?"تم الخصم من أرصدة المحافظ":"تم تسجيل الدفع عبر فوري"})},children:"تأكيد الخصم"})]})]})}),e.jsx(me,{open:Me,onOpenChange:tt,children:e.jsxs(he,{className:"sm:max-w-[520px]",children:[e.jsxs(ue,{children:[e.jsx(xe,{className:"text-right",children:"النواقص"}),e.jsx(us,{className:"text-right",children:"سجل العناصر الناقصة التي تحتاج شراء وتابع حالتها."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Z,{htmlFor:"deficiencyName",className:"text-right col-span-1",children:"اسم العنصر"}),e.jsx(R,{id:"deficiencyName",value:st,onChange:t=>Ut(t.target.value),className:"col-span-3 text-right",placeholder:"مثال: سكر، زيت، مناديل"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Z,{htmlFor:"deficiencyQuantity",className:"text-right col-span-1",children:"الكمية"}),e.jsx(R,{id:"deficiencyQuantity",type:"number",value:It,onChange:t=>Yt(t.target.value),className:"col-span-3 text-right",placeholder:"1"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(m,{className:"bg-rose-600 hover:bg-rose-700",onClick:()=>{if(Ze){n({title:"غير متاح",description:"النواقص غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"});return}const t=parseInt(It||"1",10);if(!st){n({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم العنصر",variant:"destructive"});return}if(isNaN(t)||t<=0){n({title:"كمية غير صحيحة",description:"يرجى إدخال كمية صحيحة",variant:"destructive"});return}(async()=>{if(s!=null&&s.uid)try{const{collection:a,addDoc:l,serverTimestamp:c}=await rt(async()=>{const{collection:v,addDoc:w,serverTimestamp:y}=await import("./index-Bp5r4OnK.js").then(D=>D.bf);return{collection:v,addDoc:w,serverTimestamp:y}},__vite__mapDeps([0,1]),import.meta.url),{db:h}=await rt(async()=>{const{db:v}=await import("./index-Bp5r4OnK.js").then(w=>w.bg);return{db:v}},__vite__mapDeps([0,1]),import.meta.url),x=await l(a(h,"deficiencies"),{userId:s.uid,shopId:(A==null?void 0:A.shopId)||s.uid||"default-shop",name:st,quantity:t,status:"pending",createdAt:c()});try{const v=jr(),w=localStorage.getItem(v),y=w?JSON.parse(w):[],D=Array.isArray(y)?y:[],T=D.some(De=>String((De==null?void 0:De.id)||"")===x.id),$={id:x.id,name:st,quantity:t,status:"pending",createdAt:new Date().toISOString()},K=T?D:[...D,$];localStorage.setItem(v,JSON.stringify(K))}catch{}Ut(""),Yt(""),n({title:"تمت الإضافة",description:"تمت إضافة العنصر إلى قائمة النواقص"});return}catch(a){console.warn("فشل حفظ النواقص إلى Firestore، سيُستخدم التخزين المحلي:",a)}const r={id:Date.now().toString(),name:st,quantity:t,status:"pending",createdAt:new Date};ye(a=>{const l=[...a,r];return On(l),l}),Ut(""),Yt(""),n({title:"تمت الإضافة",description:"تمت إضافة العنصر إلى قائمة النواقص"})})()},children:"إضافة للنواقص"})}),W.length>0?e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:W.map(t=>e.jsx("div",{className:"p-2 border rounded-lg bg-white hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium text-sm",children:t.name}),e.jsxs("p",{className:"text-[11px] text-gray-600",children:["الكمية: ",t.quantity]}),e.jsx("p",{className:"text-[10px] text-gray-500",children:new Date(t.createdAt).toLocaleString("ar-EG")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Wt,{variant:"secondary",className:t.status==="pending"?"bg-rose-100 text-rose-700":"bg-green-100 text-green-700",children:t.status==="pending"?"قيد الشراء":"تم الشراء"}),e.jsx(m,{variant:"outline",className:t.status==="pending"?"text-green-700 border-green-300 hover:bg-green-50":"text-rose-700 border-rose-300 hover:bg-rose-50",onClick:()=>{(async()=>{const r=t.status==="pending"?"purchased":"pending";if(s!=null&&s.uid)try{const{doc:a,updateDoc:l,serverTimestamp:c}=await rt(async()=>{const{doc:x,updateDoc:v,serverTimestamp:w}=await import("./index-Bp5r4OnK.js").then(y=>y.bf);return{doc:x,updateDoc:v,serverTimestamp:w}},__vite__mapDeps([0,1]),import.meta.url),{db:h}=await rt(async()=>{const{db:x}=await import("./index-Bp5r4OnK.js").then(v=>v.bg);return{db:x}},__vite__mapDeps([0,1]),import.meta.url);await l(a(h,"deficiencies",t.id),{status:r,updatedAt:c()});return}catch(a){console.warn("فشل تحديث حالة النواقص على Firestore، استخدام التخزين المحلي:",a)}ye(a=>{const l=a.map(c=>c.id===t.id?{...c,status:r}:c);return On(l),l})})()},title:t.status==="pending"?"تم الشراء":"إلغاء الشراء",children:t.status==="pending"?"تم الشراء":"إلغاء الشراء"}),e.jsx(m,{variant:"outline",className:"text-red-700 border-red-300 hover:bg-red-50",onClick:()=>{(async()=>{if(s!=null&&s.uid)try{const{doc:r,deleteDoc:a}=await rt(async()=>{const{doc:c,deleteDoc:h}=await import("./index-Bp5r4OnK.js").then(x=>x.bf);return{doc:c,deleteDoc:h}},__vite__mapDeps([0,1]),import.meta.url),{db:l}=await rt(async()=>{const{db:c}=await import("./index-Bp5r4OnK.js").then(h=>h.bg);return{db:c}},__vite__mapDeps([0,1]),import.meta.url);await a(r(l,"deficiencies",t.id));return}catch(r){console.warn("فشل حذف عنصر النواقص من Firestore، استخدام التخزين المحلي:",r)}ye(r=>{const a=r.filter(l=>l.id!==t.id);return On(a),a})})()},title:"حذف",children:"حذف"})]})]})},t.id))}):e.jsx("p",{className:"text-sm text-gray-500 text-center",children:"لا توجد عناصر مسجلة في النواقص"})]}),e.jsx(ze,{className:"flex justify-end",children:e.jsx(m,{variant:"outline",onClick:()=>tt(!1),children:"إغلاق"})})]})}),e.jsx(me,{open:xc,onOpenChange:La,children:e.jsxs(he,{className:"sm:max-w-[480px]",children:[e.jsx(ue,{children:e.jsx(xe,{className:"text-right",children:"اختيار مصدر خصم الدين"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600 text-right",children:"اختر هل تريد خصم مبلغ الدين من الرصيد النقدي في الدرج أم من إحدى المحافظ أو تسجيله بدون خصم."}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsx(m,{variant:ds==="cash"?"default":"outline",className:ds==="cash"?"bg-blue-600 hover:bg-blue-700 text-white":"",onClick:()=>Ra("cash"),children:"الفلوس النقدية"}),e.jsx(m,{variant:ds==="wallet"?"default":"outline",className:ds==="wallet"?"bg-purple-600 hover:bg-purple-700 text-white":"",onClick:()=>Ra("wallet"),children:"أرصدة المحافظ"}),e.jsx(m,{variant:ds==="none"?"default":"outline",className:ds==="none"?"bg-gray-600 hover:bg-gray-700 text-white":"",onClick:()=>Ra("none"),children:"بدون خصم"})]}),ds==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{className:"text-right block",children:"اختر المحفظة للخصم"}),e.jsxs(Xs,{value:ur,onValueChange:Nn,children:[e.jsx(ea,{className:"w-full",children:e.jsx(ta,{placeholder:"اختر محفظة"})}),e.jsx(sa,{children:Ae.map(t=>e.jsx(Is,{value:t.id,children:t.phone||t.name||t.id},t.id))})]})]})]}),e.jsxs(ze,{className:"flex justify-between",children:[e.jsx(m,{variant:"outline",onClick:()=>{La(!1),jn(null),Ra(null),Nn("")},children:"إلغاء"}),e.jsx(m,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{const t=!!hr&&!ja,r=Number(t?hr.delta:(ja==null?void 0:ja.amount)||0);if(!ds){n({title:"اختر مصدر الخصم",description:"يرجى اختيار النقدية أو المحفظة",variant:"destructive"});return}try{if(ds==="cash"){const a=Number((ot-r).toFixed(2));Gt(a),localStorage.setItem(Ds(),a.toString());const l=new Date().toISOString(),c={cashBalance:a,lastUpdated:l},h=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(h,JSON.stringify(c)),s!=null&&s.uid?await Ce.updateUserData(s.uid,c).then(()=>{localStorage.removeItem(h),Ne(!1)}).catch(()=>{Ne(!0)}):Ne(!0)}else if(ds==="wallet"){if(!ur){n({title:"اختر محفظة",description:"يرجى اختيار محفظة للخصم",variant:"destructive"});return}const a=Te[ur]||0,l=Number((a-r).toFixed(2)),c={...Te,[ur]:l};Vt(c);const h=new Date().toISOString(),x={walletBalances:c,lastUpdated:h},v=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(v,JSON.stringify(x)),localStorage.setItem(ms(),JSON.stringify(c)),localStorage.setItem(`walletBalances_backup_${h}`,JSON.stringify(c)),s!=null&&s.uid&&await Ce.updateUserData(s.uid,x)}}catch(a){console.error("خطأ أثناء تحديث الأرصدة عند حفظ/تعديل الدين:",a)}if(t){if(!ce)return;const a=Number(ce.amount||0),l=Number(ce.paidAmount||0),c=Number(hr.delta||0);if(hr.type==="decrease"){const h=Math.max(l,a-c);if(h===a)n({title:"لا يمكن الإنقاص أكثر",description:"المبلغ لا يمكن أن يقل عن المدفوع."});else{const x=l>=h,v={...ce,amount:Number(h.toFixed(2)),status:x?"paid":"pending"},w=kt.map(y=>y.id===ce.id?v:y);cs(w),_a(v),await bs(w);try{x&&(s!=null&&s.uid)&&(async()=>{const y=Bt(et(de,"userTransactions"),Le("userId","==",s.uid),Le("linkedDebtId","==",ce.id),Le("status","==","pending")),D=await es(y);await Promise.allSettled(D.docs.map(T=>na(T.ref,{status:"completed",confirmedAt:new Date})))})().catch(y=>console.error("تعذر تحديث حالة المعاملات المرتبطة بالدين بعد الإنقاص:",y))}catch(y){console.error("تعذر تجهيز تحديث حالة المعاملات المرتبطة بعد الإنقاص:",y)}n({title:"تم إنقاص المبلغ",description:`المبلغ الجديد: ${h} جنيه`})}}else{const h=a+c,x=l>=h,v={...ce,amount:Number(h.toFixed(2)),status:x?"paid":"pending"},w=kt.map(y=>y.id===ce.id?v:y);cs(w),_a(v),await bs(w),n({title:"تم زيادة المبلغ",description:`المبلغ الجديد: ${h} جنيه`})}}else if(ja){const a=[...kt,ja];cs(a),await bs(a)}Ii(""),Ai(""),Ti(""),wa(!1),La(!1),jn(null),Oi(null),Ra(null),Nn(""),n({title:t?"تم تطبيق الخصم وتعديل الدين":ds==="none"?"تم حفظ الدين بدون خصم":"تم حفظ الدين وخصم المبلغ",description:ds==="none"?"لم يتم الخصم من الدرج أو المحافظ":ds==="cash"?`تم خصم ${r} من الرصيد النقدي`:`تم خصم ${r} من رصيد المحفظة`})},children:"تأكيد الخصم"})]})]})}),e.jsx(me,{open:cc,onOpenChange:Gs,children:e.jsxs(he,{className:"sm:max-w-[425px]",children:[e.jsx(ue,{children:e.jsx(xe,{className:"text-right",children:"إيصال الدين"})}),ce&&e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"text-center border-b pb-4",children:[e.jsx("h2",{className:"text-xl font-bold",children:"إيصال دين"}),e.jsx("p",{className:"text-sm text-gray-500",children:Wr.format(ce.createdAt instanceof Date?ce.createdAt:new Date(ce.createdAt))})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"اسم المديون:"}),e.jsx("span",{children:ce.debtorName})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"font-medium",children:"المبلغ:"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(m,{variant:"outline",className:"h-8 w-8 p-0","aria-label":"إنقاص الدين",onClick:()=>{Pi("decrease"),un(""),Gs(!1),Fa(!0)},children:"−"}),e.jsxs("span",{className:"font-bold text-lg",children:[ce.amount," جنيه"]}),e.jsx(m,{variant:"outline",className:"h-8 w-8 p-0","aria-label":"زيادة الدين",onClick:()=>{Pi("increase"),un(""),Gs(!1),Fa(!0)},children:"+"})]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"سبب الدين:"}),e.jsx("span",{children:ce.reason})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"الحالة:"}),e.jsx(Wt,{variant:ce.status==="paid"?"default":"secondary",className:ce.status==="paid"?"bg-green-500":"bg-yellow-500",children:ce.status==="paid"?"مدفوع":"مؤجل"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"المبلغ المتبقي:"}),e.jsxs("span",{className:"font-bold text-lg",children:[Math.max(0,Number(ce.amount||0)-Number(ce.paidAmount||0))," جنيه"]})]}),ce.paidAmount?e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"إجمالي المدفوع:"}),e.jsxs("span",{className:"text-green-700",children:[ce.paidAmount," جنيه"]})]}):null,e.jsxs("div",{className:"mt-3 p-3 border rounded-lg bg-gray-50",children:[mc?e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"partialAmount",className:"text-right block",children:"المبلغ المراد دفعه"}),e.jsx(R,{id:"partialAmount",type:"number",value:Ei,onChange:t=>pn(t.target.value),className:"text-right",placeholder:"أدخل المبلغ"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(m,{variant:"outline",onClick:()=>{xn(!1),pn("")},children:"إلغاء"}),e.jsx(m,{className:"bg-blue-600 hover:bg-blue-700",onClick:async()=>{const t=parseFloat(Ei);if(!ce||isNaN(t)||t<=0){n({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const r=Math.max(0,Number(ce.amount||0)-Number(ce.paidAmount||0));if(t>r){n({title:"مبلغ زائد",description:"المبلغ المدفوع أكبر من المتبقي",variant:"destructive"});return}const a=Number(((ce.paidAmount||0)+t).toFixed(2)),l=a>=Number(ce.amount||0),c={...ce,amount:Number(ce.amount||0),paidAmount:a,status:l?"paid":"pending",partialPayments:[...ce.partialPayments||[],{amount:t,paidAt:new Date}]},h=kt.map(x=>x.id===ce.id?c:x);cs(h),_a(c),await bs(h);try{c.status==="paid"&&(s!=null&&s.uid)&&(async()=>{const x=Bt(et(de,"userTransactions"),Le("userId","==",s.uid),Le("linkedDebtId","==",ce.id),Le("status","==","pending")),v=await es(x);await Promise.allSettled(v.docs.map(w=>na(w.ref,{status:"completed",confirmedAt:new Date})))})().catch(x=>console.error("تعذر تحديث حالة المعاملات المرتبطة بالدين:",x))}catch(x){console.error("تعذر تجهيز تحديث حالة المعاملات المرتبطة:",x)}try{const x=Nr(),v=localStorage.getItem(x);if(v){const y=(JSON.parse(v)||[]).map(D=>(D==null?void 0:D.linkedDebtId)===ce.id&&(D==null?void 0:D.status)==="pending"?{...D,status:"completed",confirmedAt:new Date}:D);localStorage.setItem(x,JSON.stringify(y)),Hs(D=>D.map(T=>(T==null?void 0:T.linkedDebtId)===ce.id&&(T==null?void 0:T.status)==="pending"?{...T,status:"completed",confirmedAt:new Date}:T))}}catch(x){console.warn("فشل تحديث حالة المعاملات المرتبطة محلياً بعد سداد الدين:",x)}xr(t),Qs("cash"),Na(!0),xn(!1),pn(""),n({title:"تم تسجيل دفع جزء",description:`تم دفع ${t} جنيه بتاريخ ${new Date().toLocaleString("ar-EG")}`})},children:"دفع"})]})]}):e.jsx(m,{variant:"outline",className:"w-full",onClick:()=>xn(!0),children:"دفع جزء"}),ce.partialPayments&&ce.partialPayments.length>0&&e.jsxs("div",{className:"mt-3 text-xs text-gray-600",children:[e.jsx("p",{className:"font-medium mb-1",children:"سجل الدفعات الجزئية:"}),e.jsx("div",{className:"space-y-1 max-h-24 overflow-y-auto",children:ce.partialPayments.map((t,r)=>e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{children:["دفع: ",t.amount," جنيه"]}),e.jsx("span",{children:new Date(t.paidAt).toLocaleString("ar-EG")})]},r))})]})]})]})]}),e.jsxs(ze,{className:"flex gap-2 justify-center",children:[e.jsx(m,{onClick:async()=>{if(ce){const t=kt.map(r=>r.id===ce.id?{...r,status:"pending"}:r);cs(t),await bs(t),Gs(!1),n({title:"تم تحديث حالة الدين",description:"تم تعيين الدين كمؤجل"})}},variant:"outline",className:"bg-yellow-500 hover:bg-yellow-600 text-white",children:"مؤجل"}),e.jsx(m,{onClick:async()=>{if(ce){const r=Math.max(0,Number(ce.amount||0)-Number(ce.paidAmount||0)),a=kt.map(l=>l.id===ce.id?{...l,amount:Number(l.amount||0),paidAmount:Number(((l.paidAmount||0)+r).toFixed(2)),status:"paid",partialPayments:[...l.partialPayments||[],...r>0?[{amount:r,paidAt:new Date}]:[]]}:l);cs(a),r>0&&(xr(r),Qs("cash"),Na(!0)),await bs(a);try{s!=null&&s.uid&&(ce!=null&&ce.id)&&(async()=>{const l=Bt(et(de,"userTransactions"),Le("userId","==",s.uid),Le("linkedDebtId","==",ce.id),Le("status","==","pending")),c=await es(l);await Promise.allSettled(c.docs.map(h=>na(h.ref,{status:"completed",confirmedAt:new Date})))})().catch(l=>console.error("تعذر تحديث حالة المعاملات المرتبطة بالدين:",l))}catch(l){console.error("تعذر تجهيز تحديث حالة المعاملات المرتبطة:",l)}try{const l=Nr(),c=localStorage.getItem(l);if(c){const x=(JSON.parse(c)||[]).map(v=>(v==null?void 0:v.linkedDebtId)===ce.id&&(v==null?void 0:v.status)==="pending"?{...v,status:"completed",confirmedAt:new Date}:v);localStorage.setItem(l,JSON.stringify(x)),Hs(v=>v.map(w=>(w==null?void 0:w.linkedDebtId)===ce.id&&(w==null?void 0:w.status)==="pending"?{...w,status:"completed",confirmedAt:new Date}:w))}}catch(l){console.warn("فشل تحديث حالة المعاملات المرتبطة محلياً بعد سداد الدين:",l)}Gs(!1),n({title:"تم تحديث حالة الدين",description:"تم تعيين الدين كمدفوع"})}},className:"bg-green-500 hover:bg-green-600",children:"مدفوع"}),e.jsx(m,{onClick:async()=>{if(ce){const t=kt.filter(r=>r.id!==ce.id);cs(t),await bs(t),Gs(!1),n({title:"تم حذف الدين",description:"تم حذف الدين بنجاح"})}},variant:"destructive",children:"حذف"})]})]})}),e.jsx(me,{open:dc,onOpenChange:Fa,children:e.jsxs(he,{className:"sm:max-w-md rounded-2xl shadow-elegant border border-gray-200",children:[e.jsxs(ue,{children:[e.jsx(xe,{className:`text-right ${da==="decrease"?"text-red-600":"text-green-600"}`,children:da==="decrease"?"إنقاص مبلغ الدين":da==="increase"?"زيادة مبلغ الدين":"تعديل مبلغ الدين"}),e.jsxs(us,{className:"text-right",children:["أدخل المبلغ ثم اضغط تأكيد لإتمام ",da==="decrease"?"الإنقاص":"الزيادة","."]})]}),e.jsxs("div",{className:"grid gap-4 py-2",children:[e.jsx(Z,{htmlFor:"debtAdjustAmount",className:"text-right",children:"المبلغ (جنيه)"}),e.jsx(R,{id:"debtAdjustAmount",type:"number",placeholder:"0.00",value:ki,onChange:t=>un(t.target.value)}),ce&&e.jsxs("div",{className:"text-right text-sm text-muted-foreground",children:["المبلغ الحالي: ",e.jsx("span",{className:"font-semibold",children:Number(ce.amount||0).toFixed(2)})," جنيه"]})]}),e.jsxs(ze,{className:"flex gap-2",children:[e.jsx(m,{variant:"secondary",onClick:()=>{Fa(!1),Gs(!0)},children:"إلغاء"}),e.jsx(m,{className:da==="decrease"?"bg-red-600 hover:bg-red-700":"bg-green-600 hover:bg-green-700",onClick:async()=>{try{if(!ce||!da)return;const t=Number(parseFloat(ki||"0").toFixed(2));if(!t||isNaN(t)||t<=0){n({title:"قيمة غير صالحة",description:"يرجى إدخال مبلغ أكبر من صفر",variant:"destructive"});return}Oi({debtId:ce.id,delta:t,type:da}),Fa(!1),La(!0)}catch(t){console.error("فشل تجهيز تعديل مبلغ الدين:",t),n({title:"خطأ",description:"تعذّر تجهيز تعديل مبلغ الدين",variant:"destructive"})}},children:"تأكيد"})]})]})}),e.jsx(me,{open:pc,onOpenChange:Na,children:e.jsxs(he,{className:"sm:max-w-[425px]",children:[e.jsxs(ue,{children:[e.jsx(xe,{className:"text-right",children:"اختيار إضافة مبلغ السداد"}),e.jsx(us,{className:"text-right",children:"هل تريد إضافة مبلغ السداد إلى الفلوس النقدية أم إلى إحدى المحافظ؟"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(m,{variant:ps==="cash"?"default":"outline",className:ps==="cash"?"bg-blue-600 text-white":"",onClick:()=>Qs("cash"),children:"الفلوس النقدية"}),e.jsx(m,{variant:ps==="wallet"?"default":"outline",className:ps==="wallet"?"bg-blue-600 text-white":"",onClick:()=>Qs("wallet"),children:"أرصدة المحافظ"}),e.jsx(m,{variant:ps==="fawry"?"default":"outline",className:ps==="fawry"?"bg-amber-600 text-white":"",onClick:()=>Qs("fawry"),children:"فوري"}),e.jsx(m,{variant:ps==="none"?"default":"outline",className:ps==="none"?"bg-gray-600 text-white":"",onClick:()=>Qs("none"),children:"بدون إضافة"})]}),ps==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-right",children:"اختر المحفظة"}),e.jsxs("select",{className:"w-full border rounded p-2 text-right",value:ma,onChange:t=>Sn(t.target.value),children:[e.jsx("option",{value:"",children:"— اختر محفظة —"}),Ae&&Ae.length>0?Ae.map(t=>e.jsx("option",{value:t.id,children:t.phone||t.name||t.id},t.id)):Object.keys(Te||{}).map(t=>{var r,a,l,c,h,x;return e.jsx("option",{value:t,children:((r=Ae.find(v=>v.id===t))==null?void 0:r.phone)||((l=(a=JSON.parse(localStorage.getItem(En())||"[]"))==null?void 0:a.find(v=>v.id===t))==null?void 0:l.phone)||((h=(c=JSON.parse(localStorage.getItem(En())||"[]"))==null?void 0:c.find(v=>v.id===t))==null?void 0:h.name)||((x=Ae.find(v=>v.id===t))==null?void 0:x.name)||t},t)})]})]}),e.jsxs("div",{className:"text-right text-sm text-gray-600",children:["المبلغ المراد إضافته: ",e.jsxs("span",{className:"font-bold",children:[Ri," جنيه"]})]})]}),e.jsxs(ze,{className:"flex justify-end",children:[e.jsx(m,{variant:"outline",onClick:()=>{Na(!1),xr(0),Qs(null),Sn("")},children:"إلغاء"}),e.jsx(m,{onClick:async()=>{var t,r;try{const a=Ri;if(!a||a<=0){Na(!1);return}if(ps==="cash"){const l=ot+a;Gt(l),localStorage.setItem(Ds(),l.toString());const c={cashBalance:l,lastUpdated:new Date().toISOString()},h=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(h,JSON.stringify(c)),s!=null&&s.uid?(Ce.updateUserData(s.uid,c).catch(()=>Ne(!0)),localStorage.removeItem(h),Ne(!1)):Ne(!0),n({title:"تمت إضافة مبلغ السداد",description:`تمت إضافة ${a} جنيه إلى الفلوس النقدية`})}else if(ps==="wallet"){if(!ma){n({title:"اختر محفظة أولاً",description:"يرجى اختيار المحفظة لإضافة مبلغ السداد إليها",variant:"destructive"});return}const l={...Te,[ma]:(Te[ma]||0)+a};Vt(l);const c=(ot||0)-a;Gt(c),localStorage.setItem(Ds(),c.toString());const h=new Date().toISOString(),x={walletBalances:l,cashBalance:c,lastUpdated:h},v=`userData_${s==null?void 0:s.uid}`;if(localStorage.setItem(v,JSON.stringify(x)),localStorage.setItem(ms(),JSON.stringify(l)),localStorage.setItem(`walletBalances_backup_${h}`,JSON.stringify(l)),s!=null&&s.uid){Ce.updateUserData(s.uid,x).catch(()=>Ne(!0));try{localStorage.removeItem(v)}catch{}Ne(!1)}else Ne(!0);n({title:"تمت إضافة مبلغ السداد",description:`تمت إضافة ${a} جنيه إلى المحفظة ${((t=Ae.find(w=>w.id===ma))==null?void 0:t.phone)||((r=Ae.find(w=>w.id===ma))==null?void 0:r.name)||ma} وتم خصم نفس المبلغ من درج النقدية`})}else if(ps==="none"){const l=(ot||0)-a;Gt(l),localStorage.setItem(Ds(),l.toString());const c={cashBalance:l,lastUpdated:new Date().toISOString()},h=`userData_${s==null?void 0:s.uid}`;if(localStorage.setItem(h,JSON.stringify(c)),s!=null&&s.uid){Ce.updateUserData(s.uid,c).catch(()=>Ne(!0));try{localStorage.removeItem(h)}catch{}Ne(!1)}else Ne(!0);n({title:"تم تسجيل السداد",description:`تم خصم ${a} جنيه من درج النقدية بدون إضافة للمحافظ`})}else if(ps==="fawry")n({title:"تم تسجيل سداد عبر فوري",description:`تم تسجيل ${a} جنيه كسداد عبر فوري بدون تعديل الأرصدة`});else{n({title:"اختر مصدر الإضافة",description:"يرجى اختيار إضافة المبلغ إلى النقدية أو المحفظة",variant:"destructive"});return}}catch(a){console.error("خطأ أثناء إضافة مبلغ السداد:",a),n({title:"حدث خطأ",description:"تعذر إضافة مبلغ السداد، حاول مرة أخرى",variant:"destructive"})}finally{Na(!1),xr(0),Qs(null),Sn("")}},className:"bg-green-600 hover:bg-green-700",children:"تأكيد الإضافة"})]})]})}),e.jsx(me,{open:Vo,onOpenChange:oa,children:e.jsxs(he,{hideClose:!0,className:"post-confirm-card sm:max-w-[420px] w-[90vw] rounded-2xl bg-gradient-to-br from-white via-indigo-50 to-blue-50 shadow-2xl border border-indigo-100",children:[e.jsxs(ue,{children:[e.jsx(xe,{className:"text-right text-2xl font-bold",children:(Lt==null?void 0:Lt.type)==="transfer"?"مبلغ يجب استلامه":"مبلغ يجب تسليمه"}),e.jsx(us,{className:"text-right text-gray-600",children:(Lt==null?void 0:Lt.type)==="transfer"?"هذا هو المبلغ الواجب استلامه من العميل بعد التأكيد.":"هذا هو المبلغ الواجب تسليمه للعميل بعد التأكيد."})]}),e.jsxs("div",{className:"py-3 flex flex-col items-center gap-1.5",children:[e.jsxs("div",{className:"text-xl sm:text-2xl font-bold text-blue-700 tracking-wide",children:[As((Lt==null?void 0:Lt.amount)||0)," جنيه"]}),e.jsx("div",{className:"text-sm text-gray-500 text-right w-full",children:(Lt==null?void 0:Lt.type)==="transfer"?"المبلغ المعروض شامل عمولة التحويل.":Ke?"العمولة مضافة ولا تؤثر على قيمة التسليم.":"العمولة مخصومة من المبلغ المسلّم للعميل."})]}),e.jsxs(ze,{className:"flex justify-end gap-2",children:[(Lt==null?void 0:Lt.type)==="transfer"&&e.jsx(m,{variant:"outline",id:"sendCodeBtn",onClick:be,disabled:bi,className:"btn-transfer-confirm",children:bi?"جارٍ الإرسال...":"إرسال كود التحويل"}),e.jsx(m,{onClick:()=>{oa(!1),nn(null)},className:"bg-green-600 hover:bg-green-700 text-white",children:(Lt==null?void 0:Lt.type)==="transfer"?"تم الاستلام":"تم التسليم"})]})]})}),e.jsx(Xd,{open:Ko,onClose:()=>ba(!1),onSubmit:ke,deviceId:wi||te||"",recipientMsisdn:String(re==="transfer"?(os==null?void 0:os.receiver)||zt||"":((yl=Ae.find(t=>t.id===G))==null?void 0:yl.phone)||"").replace(/\D/g,"")}),e.jsx(Jm,{open:X,onOpenChange:z}),!1]}))};export{tu as default};
