const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-Drf-Kel-.js","assets/index-CUGoRur3.css","assets/walletDailyLimitsService-CGHLknt6.js","assets/profitService-WOL_cZ8K.js","assets/reportsService-Bp1Io21u.js"])))=>i.map(i=>d[i]);
var vo=Object.defineProperty;var yo=(l,d,t)=>d in l?vo(l,d,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[d]=t;var Rr=(l,d,t)=>yo(l,typeof d!="symbol"?d+"":d,t);import{c as _t,h as jo,f as bo,u as es,r as a,j as e,a6 as za,K as Ms,a4 as ns,aX as Ja,C as ys,d as zt,a as hl,a5 as xt,Y as xl,X as ul,_ as rs,aB as $a,R as ot,F as aa,l as No,S as Gt,a0 as ra,a2 as ps,k as ut,a1 as Pt,aq as na,a7 as en,W as la,i as Ht,J as ea,aU as wo,a3 as sl,z as So,A as gl,E as Do,aY as Co,v as bs,Q as Ka,an as al,aZ as pl,a8 as je,x as Io,ak as To,aF as ko,m as Ao,o as Po,V as ta,ao as Oo,ap as Wo,aE as Fo,am as Fa,p as Ba,g as Bo,G as Eo,H as Mo}from"./index-Drf-Kel-.js";import{C as _e,a as ct,b as Nt,d as Ye}from"./card-B-oThBGQ.js";import{B as o,b as fl}from"./button-BeXYwqdJ.js";import{I as $}from"./input-BS89kG9l.js";import{B as rt}from"./badge-UZez9OVE.js";import{S as Ps,a as Os,b as Ws,c as Fs,d as Bs,C as tn,e as vl}from"./select-D1NXV2xv.js";import{D as ie,a as oe,b as ce,c as de,f as yl,T as Lo,O as $o,W as Ro,C as Uo,g as _o,h as zo,i as jl,R as Jo,P as Ko,d as Rt,e as Ne}from"./dialog-BnpzTiyj.js";import{L as H}from"./label-LMuypoA6.js";import{M as vs,a as ls}from"./MasterPinDialog-RsfCUjbM.js";import{walletDailyLimitsService as Zt}from"./walletDailyLimitsService-CGHLknt6.js";import{T as It,P as Ra}from"./progress-DQxfmnh7.js";import{W as Ut}from"./wallet-CAoLqm49.js";import{S as bl}from"./star-Sfa5Snz5.js";import{S as Nl}from"./square-pen-BRFFPzTP.js";import{P as Xt}from"./phone-CCrFfxFB.js";import{A as wl}from"./arrow-left-Cyn2rWTx.js";import{a as Hr,S as Vo}from"./separator-DRqor3jV.js";import{C as is}from"./calendar-DYQ_aN-h.js";import{C as Gr}from"./chart-column-BdRZdk4W.js";import{D as Ze}from"./dollar-sign-Cd9rZkui.js";import{A as Ur,B as _r}from"./bell-DHsYGnX_.js";import{C as Ns}from"./circle-alert-QaHEPkjm.js";import{C as sn}from"./circle-x-C9dwYXo5.js";import{C as Qt}from"./circle-check-big-Byeak2Hh.js";import{a as Xe,E as Tt}from"./eye-DCMRqakt.js";import{S as qo}from"./store-WAgApPwn.js";import{A as Yo}from"./arrow-right-BVwBu5je.js";import{U as Qr}from"./user-8v5sbkXa.js";import{P as Ho,C as Sl,a as Go,R as Qo,b as Zo,M as Xo}from"./MaintenanceDialog-BIQPFR_D.js";import{L as js}from"./lock-D5jTNF9R.js";import{P as zr}from"./PasswordConfirmDialog-BMypOgjX.js";import{M as fs}from"./minus-BVp8pEWk.js";import{w as ec,W as tc}from"./WalletsManagement-BhasvqIk.js";import{reportsService as $t}from"./reportsService-Bp1Io21u.js";import{P as sc}from"./ProfileIcon-Br7HbrJq.js";import{a as ac,E as rl}from"./broadcastService-xL5_ZkOC.js";import{D as rc,a as nc,b as lc,c as ic,d as nl}from"./dropdown-menu-C--56y90.js";import{S as Jr}from"./shield-DmIh40Jt.js";import{G as oc}from"./gift-cQxml-yP.js";import{ProfitService as Ls}from"./profitService-WOL_cZ8K.js";import{R as cc}from"./refresh-cw-CTl5kzEl.js";import"./index-CexbHjis.js";import"./Combination-CwHaGt6n.js";import"./index-D3Q9cnmm.js";import"./check-Cq7Xk3YP.js";import"./avatars-IzZoD8tB.js";import"./key-round-C4s0TQ3W.js";import"./index-BoPwWMJr.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ua=_t("ArrowDownLeft",[["path",{d:"M17 7 7 17",key:"15tmo1"}],["path",{d:"M17 17H7V7",key:"1org7z"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Dl=_t("ArrowRightLeft",[["path",{d:"m16 3 4 4-4 4",key:"1x1c3m"}],["path",{d:"M20 7H4",key:"zbl0bi"}],["path",{d:"m8 21-4-4 4-4",key:"h9nckh"}],["path",{d:"M4 17h16",key:"g4d7ey"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const dc=_t("Banknote",[["rect",{width:"20",height:"12",x:"2",y:"6",rx:"2",key:"9lu3g6"}],["circle",{cx:"12",cy:"12",r:"2",key:"1c9p78"}],["path",{d:"M6 12h.01M18 12h.01",key:"113zkx"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const mc=_t("BookOpen",[["path",{d:"M12 7v14",key:"1akyts"}],["path",{d:"M3 18a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h5a4 4 0 0 1 4 4 4 4 0 0 1 4-4h5a1 1 0 0 1 1 1v13a1 1 0 0 1-1 1h-6a3 3 0 0 0-3 3 3 3 0 0 0-3-3z",key:"ruj8y"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Cl=_t("Building",[["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",ry:"2",key:"76otgf"}],["path",{d:"M9 22v-4h6v4",key:"r93iot"}],["path",{d:"M8 6h.01",key:"1dz90k"}],["path",{d:"M16 6h.01",key:"1x0f13"}],["path",{d:"M12 6h.01",key:"1vi96p"}],["path",{d:"M12 10h.01",key:"1nrarc"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M16 10h.01",key:"1m94wz"}],["path",{d:"M16 14h.01",key:"1gbofw"}],["path",{d:"M8 10h.01",key:"19clt8"}],["path",{d:"M8 14h.01",key:"6423bh"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const hc=_t("Download",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"7 10 12 15 17 10",key:"2ggqvy"}],["line",{x1:"12",x2:"12",y1:"15",y2:"3",key:"1vk2je"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _a=_t("IdCard",[["path",{d:"M16 10h2",key:"8sgtl7"}],["path",{d:"M16 14h2",key:"epxaof"}],["path",{d:"M6.17 15a3 3 0 0 1 5.66 0",key:"n6f512"}],["circle",{cx:"9",cy:"11",r:"2",key:"yxgjnd"}],["rect",{x:"2",y:"5",width:"20",height:"14",rx:"2",key:"qneu4z"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Zr=_t("Info",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ea=_t("Package",[["path",{d:"M11 21.73a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73z",key:"1a0edw"}],["path",{d:"M12 22V12",key:"d0xqtd"}],["path",{d:"m3.3 7 7.703 4.734a2 2 0 0 0 1.994 0L20.7 7",key:"yx3hmr"}],["path",{d:"m7.5 4.27 9 5.15",key:"1c824w"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ia=_t("TrendingDown",[["polyline",{points:"22 17 13.5 8.5 8.5 13.5 2 7",key:"1r2t7k"}],["polyline",{points:"16 17 22 17 22 11",key:"11uiuu"}]]),xc=async(l={})=>{try{return(await jo(bo,"getLastTransactions")(l)).data}catch(d){throw console.error("Error getting last transactions:",d),d.code==="functions/unauthenticated"?new Error("يجب تسجيل الدخول للوصول إلى المعاملات"):d.code==="functions/invalid-argument"?new Error("بيانات الاستعلام غير صالحة: "+d.message):d.code==="functions/permission-denied"?new Error("ليس لديك صلاحية للوصول إلى هذه المعاملات: "+d.message):new Error("حدث خطأ أثناء جلب المعاملات: "+(d.message||"خطأ غير معروف"))}},uc=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],gc=({isOpen:l,onClose:d,onWalletSelect:t,onEditWallet:m,onDeleteWallet:f})=>{const{user:h}=es(),[C,M]=a.useState([]),[u,x]=a.useState(!1),p=()=>`wallets_${(h==null?void 0:h.uid)||"default"}`,P=()=>{try{const D=p(),_=localStorage.getItem(D);if(_){const ne=JSON.parse(_);if(Array.isArray(ne)&&ne.length>0)return ne}const te="wallets_default",j=localStorage.getItem(te);if(j){const ne=JSON.parse(j);if(Array.isArray(ne)&&ne.length>0){localStorage.setItem(D,j);try{localStorage.removeItem(te)}catch{}return ne}}const N=Object.keys(localStorage).filter(ne=>ne.startsWith("wallets_")&&ne!==D);let J=null,le=null;for(const ne of N)try{const he=localStorage.getItem(ne);if(!he)continue;const Q=JSON.parse(he);Array.isArray(Q)&&Q.length>0&&(!J||Q.length>((J==null?void 0:J.length)||0))&&(J=Q,le=ne)}catch{}if(J&&le){localStorage.setItem(D,JSON.stringify(J));try{localStorage.removeItem(le)}catch{}return J}}catch(D){console.warn("WalletsViewPage migration failed:",D)}return null},k=async(D,_)=>{const te=new Date().getMonth(),j=new Date().getFullYear(),N=_.filter(Q=>{const Z=new Date(Q.createdAt);return Z.getMonth()===te&&Z.getFullYear()===j&&Q.lineId===D}),J=Q=>{const Z=Q.type;return Q.txnType==="receive"||Z==="withdraw"||Z==="withdrawal"||Z==="receive"},le=Q=>{const Z=Q.type;return Q.txnType==="send"||Z==="send"||Z==="transfer"},ne=N.filter(J).reduce((Q,Z)=>{const we=Z.withdrawnAmount!==void 0?Z.withdrawnAmount:Z.amount;return Q+(we||0)},0),he=N.filter(le).reduce((Q,Z)=>{const we=Z.sentAmount!==void 0?Z.sentAmount:Z.amount;return Q+(we||0)},0);return{withdrawalUsage:ne,transferUsage:he}},E=D=>{const _=new Date().toISOString().split("T")[0],te=D.lastResetDate;if(!te)return{...D,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:_};const j=new Date(te),N=new Date;return j.getMonth()!==N.getMonth()||j.getFullYear()!==N.getFullYear()?{...D,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:_}:D};a.useEffect(()=>{if(!(h!=null&&h.uid)||!l)return;(async()=>{x(!0);try{const _=await ns.getByMerchantId(h.uid),te=await Ja.getByUserId(h.uid),N=(await Promise.all(_.map(async J=>{const{withdrawalUsage:le,transferUsage:ne}=await k(J.id,te);return{id:J.id,name:J.label||"محفظة بدون اسم",phone:J.msisdn,nationalId:J.nationalId||"",isDefault:!1,monthlyWithdrawalLimit:J.withdrawLimit||2e5,monthlyTransferLimit:J.transferLimit||2e5,monthlyWithdrawalUsage:le,monthlyTransferUsage:ne,lastResetDate:new Date().toISOString().split("T")[0],walletProvider:J.walletProvider||""}}))).map(E);if(M(N),!N||N.length===0){const J=P();J&&J.length>0&&M(J.map(E))}}catch(_){console.error("Error loading wallets:",_);const te=P();te&&M(te.map(j=>({...j,phone:j.phone||j.phoneNumber,monthlyWithdrawalLimit:j.monthlyWithdrawalLimit||2e5,monthlyTransferLimit:j.monthlyTransferLimit||2e5})))}finally{x(!1)}})()},[h==null?void 0:h.uid,l]);const K=D=>uc.find(_=>_.id===D),q=(D,_)=>_>0?Math.min(D/_*100,100):0,W=D=>new Intl.NumberFormat("ar-EG").format(D);return e.jsx(ie,{open:l,onOpenChange:d,children:e.jsxs(oe,{className:"max-w-6xl max-h-[90vh] overflow-y-auto",children:[e.jsx(ce,{className:"pb-4",children:e.jsxs(de,{className:"flex items-center gap-2 text-lg",children:[e.jsx(Ut,{className:"h-5 w-5"}),"الاطلاع على جميع المحافظ",e.jsxs(rt,{variant:"secondary",className:"mr-2",children:[C.length," محفظة"]})]})}),u?e.jsx("div",{className:"flex justify-center items-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-600",children:"جاري تحميل المحافظ..."})]})}):C.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Ut,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"لا توجد محافظ مضافة حتى الآن"})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:C.map(D=>{const _=K(D.walletProvider||""),te=q(D.monthlyWithdrawalUsage||0,D.monthlyWithdrawalLimit),j=q(D.monthlyTransferUsage||0,D.monthlyTransferLimit);return e.jsxs(_e,{className:"cursor-pointer hover:shadow-lg transition-shadow border-2 hover:border-blue-300",onClick:()=>t(D),children:[e.jsx(ct,{className:"pb-3",children:e.jsxs(Nt,{className:"flex items-center justify-between text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(za,{className:"h-4 w-4"}),e.jsx("span",{children:D.name})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[D.isDefault&&e.jsxs(rt,{variant:"default",className:"text-xs",children:[e.jsx(bl,{className:"h-3 w-3 mr-1"}),"افتراضية"]}),e.jsx(o,{variant:"ghost",size:"sm",onClick:N=>{N.stopPropagation(),m==null||m(D)},className:"h-7 px-2",children:e.jsx(Nl,{className:"h-4 w-4"})}),e.jsx(o,{variant:"ghost",size:"sm",onClick:N=>{N.stopPropagation(),f==null||f(D.id)},className:"h-7 px-2 text-destructive hover:text-destructive",children:e.jsx(It,{className:"h-4 w-4"})})]})]})}),e.jsxs(Ye,{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Xt,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"font-mono",children:D.phone})]}),D.nationalId&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(_a,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"font-mono",children:D.nationalId})]}),_&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Cl,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{children:_.name})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(ia,{className:"h-3 w-3 text-red-500"}),"السحب الشهري"]}),e.jsxs("span",{className:"font-mono",children:[W(D.monthlyWithdrawalUsage||0)," / ",W(D.monthlyWithdrawalLimit)]})]}),e.jsx(Ra,{value:te,className:"h-2"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Ms,{className:"h-3 w-3 text-green-500"}),"التحويل الشهري"]}),e.jsxs("span",{className:"font-mono",children:[W(D.monthlyTransferUsage||0)," / ",W(D.monthlyTransferLimit)]})]}),e.jsx(Ra,{value:j,className:"h-2"})]}),e.jsx(o,{variant:"outline",size:"sm",className:"w-full text-xs",onClick:N=>{N.stopPropagation(),t(D)},children:"عرض التفاصيل الكاملة"})]})]},D.id)})}),e.jsx("div",{className:"flex justify-end pt-4 border-t",children:e.jsxs(o,{onClick:d,variant:"outline",children:[e.jsx(wl,{className:"h-4 w-4 mr-2"}),"إغلاق"]})})]})})},pc=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],fc=({wallet:l,isOpen:d,onClose:t,onBack:m})=>{const{user:f}=es(),[h,C]=a.useState([]),[M,u]=a.useState(!1),[x,p]=a.useState("month");if(a.useEffect(()=>{if(!l||!(f!=null&&f.uid)||!d)return;(async()=>{u(!0);try{const We=(await Ja.getByUserId(f.uid)).filter(ze=>ze.walletId===l.id).sort((ze,Ie)=>new Date(Ie.createdAt).getTime()-new Date(ze.createdAt).getTime());C(We)}catch(se){console.error("Error loading transactions:",se)}finally{u(!1)}})()},[l,f==null?void 0:f.uid,d]),!l)return null;const P=V=>pc.find(se=>se.id===V),k=(V,se)=>se>0?Math.min(V/se*100,100):0,E=V=>new Intl.NumberFormat("ar-EG").format(V),K=V=>new Date(V).toLocaleDateString("ar-EG",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}),W=(()=>{const V=new Date;let se;switch(x){case"week":se=new Date(V.getTime()-7*24*60*60*1e3);break;case"month":se=new Date(V.getFullYear(),V.getMonth(),1);break;default:return h}return h.filter(We=>new Date(We.createdAt)>=se)})(),D=V=>{const se=V.type,We=V.txnType;return se==="withdraw"||se==="withdrawal"||se==="receive"||We==="receive"},_=V=>{const se=V.type,We=V.txnType;return se==="send"||se==="transfer"||We==="send"},te=W.filter(V=>D(V)&&V.status==="completed").reduce((V,se)=>{const We=se.withdrawnAmount!==void 0?se.withdrawnAmount:se.amount;return V+(We||0)},0),j=W.filter(V=>_(V)&&V.status==="completed").reduce((V,se)=>{const We=se.sentAmount!==void 0?se.sentAmount:se.amount;return V+(We||0)},0),N=W.filter(V=>V.type==="deposit"&&V.status==="completed").reduce((V,se)=>V+se.amount,0),J=P(l.walletProvider||""),le=k(l.monthlyWithdrawalUsage||0,l.monthlyWithdrawalLimit),ne=k(l.monthlyTransferUsage||0,l.monthlyTransferLimit),he=V=>{switch(V){case"withdrawal":return e.jsx(ia,{className:"h-4 w-4 text-red-500"});case"transfer":return e.jsx(Ms,{className:"h-4 w-4 text-blue-500"});case"deposit":return e.jsx(Ze,{className:"h-4 w-4 text-green-500"});default:return e.jsx(Ur,{className:"h-4 w-4 text-gray-500"})}},Q=V=>{switch(V){case"completed":return e.jsx(Qt,{className:"h-4 w-4 text-green-500"});case"pending":return e.jsx(ys,{className:"h-4 w-4 text-yellow-500"});case"failed":return e.jsx(sn,{className:"h-4 w-4 text-red-500"});default:return e.jsx(Ns,{className:"h-4 w-4 text-gray-500"})}},Z=V=>{switch(V){case"withdrawal":return"سحب";case"transfer":return"تحويل";case"deposit":return"إيداع";default:return"معاملة"}},we=V=>{switch(V){case"completed":return"مكتملة";case"pending":return"قيد الانتظار";case"failed":return"فاشلة";default:return"غير محدد"}};return e.jsx(ie,{open:d,onOpenChange:t,children:e.jsxs(oe,{className:"max-w-6xl max-h-[90vh] overflow-y-auto",children:[e.jsx(ce,{className:"pb-4",children:e.jsxs(de,{className:"flex items-center gap-2 text-lg",children:[e.jsx(za,{className:"h-5 w-5"}),"تفاصيل المحفظة: ",l.name,l.isDefault&&e.jsxs(rt,{variant:"default",className:"mr-2",children:[e.jsx(bl,{className:"h-3 w-3 mr-1"}),"افتراضية"]})]})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-1 space-y-4",children:[e.jsxs(_e,{children:[e.jsx(ct,{children:e.jsxs(Nt,{className:"text-sm flex items-center gap-2",children:[e.jsx(_a,{className:"h-4 w-4"}),"المعلومات الأساسية"]})}),e.jsxs(Ye,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Xt,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-mono",children:l.phone})]}),l.nationalId&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(_a,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-mono",children:l.nationalId})]}),J&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Cl,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{children:J.name})]}),e.jsxs("div",{className:"text-xs text-gray-600 pr-6",children:[e.jsxs("div",{children:["المالك: ",J.ownerName]}),e.jsxs("div",{className:"font-mono",children:["الرقم القومي: ",J.nationalId]})]})]}),l.lastResetDate&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(is,{className:"h-4 w-4 text-gray-500"}),e.jsxs("span",{children:["آخر إعادة تعيين: ",new Date(l.lastResetDate).toLocaleDateString("ar-EG")]})]})]})]}),e.jsxs(_e,{children:[e.jsx(ct,{children:e.jsxs(Nt,{className:"text-sm flex items-center gap-2",children:[e.jsx(Gr,{className:"h-4 w-4"}),"حدود الاستخدام الشهري"]})}),e.jsxs(Ye,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(ia,{className:"h-3 w-3 text-red-500"}),"السحب الشهري"]}),e.jsxs("span",{className:"font-mono",children:[E(l.monthlyWithdrawalUsage||0)," / ",E(l.monthlyWithdrawalLimit)]})]}),e.jsx(Ra,{value:le,className:"h-2"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["متبقي: ",E(l.monthlyWithdrawalLimit-(l.monthlyWithdrawalUsage||0))," جنيه"]})]}),e.jsx(Hr,{}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Ms,{className:"h-3 w-3 text-green-500"}),"التحويل الشهري"]}),e.jsxs("span",{className:"font-mono",children:[E(l.monthlyTransferUsage||0)," / ",E(l.monthlyTransferLimit)]})]}),e.jsx(Ra,{value:ne,className:"h-2"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["متبقي: ",E(l.monthlyTransferLimit-(l.monthlyTransferUsage||0))," جنيه"]})]})]})]})]}),e.jsxs("div",{className:"lg:col-span-2 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsx(_e,{children:e.jsxs(Ye,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(ia,{className:"h-5 w-5 text-red-500"})}),e.jsx("div",{className:"text-lg font-bold",children:E(te)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي السحب"})]})}),e.jsx(_e,{children:e.jsxs(Ye,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(Ms,{className:"h-5 w-5 text-blue-500"})}),e.jsx("div",{className:"text-lg font-bold",children:E(j)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي التحويل"})]})}),e.jsx(_e,{children:e.jsxs(Ye,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(Ze,{className:"h-5 w-5 text-green-500"})}),e.jsx("div",{className:"text-lg font-bold",children:E(N)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي الإيداع"})]})})]}),e.jsxs(_e,{children:[e.jsx(ct,{children:e.jsxs(Nt,{className:"text-sm flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(Ur,{className:"h-4 w-4"}),"سجل المعاملات"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(o,{size:"sm",variant:x==="week"?"default":"outline",onClick:()=>p("week"),className:"text-xs",children:"أسبوع"}),e.jsx(o,{size:"sm",variant:x==="month"?"default":"outline",onClick:()=>p("month"),className:"text-xs",children:"شهر"}),e.jsx(o,{size:"sm",variant:x==="all"?"default":"outline",onClick:()=>p("all"),className:"text-xs",children:"الكل"})]})]})}),e.jsx(Ye,{children:M?e.jsx("div",{className:"flex justify-center items-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-600",children:"جاري تحميل المعاملات..."})]})}):W.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Ur,{className:"h-8 w-8 text-gray-400 mx-auto mb-2"}),e.jsx("p",{className:"text-gray-600",children:"لا توجد معاملات في هذه الفترة"})]}):e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:W.map(V=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[he(V.type),e.jsxs("div",{children:[e.jsxs("div",{className:"text-sm font-medium",children:[Z(V.type)," - ",E(V.amount)," جنيه"]}),e.jsx("div",{className:"text-xs text-gray-600",children:K(V.createdAt)}),V.description&&e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:V.description})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[Q(V.status),e.jsx("span",{className:"text-xs",children:we(V.status)})]})]},V.id))})})]})]})]}),e.jsxs("div",{className:"flex justify-between pt-4 border-t",children:[e.jsxs(o,{onClick:m,variant:"outline",children:[e.jsx(wl,{className:"h-4 w-4 mr-2"}),"العودة للمحافظ"]}),e.jsx(o,{onClick:t,variant:"outline",children:"إغلاق"})]})]})})},Kr=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],vc=({isOpen:l,onClose:d,onWalletUpdate:t,initialEditingWallet:m})=>{const{toast:f}=zt(),{user:h}=es(),C=hl(),[M,u]=a.useState([]),[x,p]=a.useState(!1),[P,k]=a.useState(null),[E,K]=a.useState(""),[q,W]=a.useState(""),[D,_]=a.useState(""),[te,j]=a.useState(""),[N,J]=a.useState("200000"),[le,ne]=a.useState("200000"),[he,Q]=a.useState("100000"),[Z,we]=a.useState("60000"),[V,se]=a.useState(!1),[We,ze]=a.useState(null),[Ie,Te]=a.useState(!1),[st,Je]=a.useState(!1),[Ot,jt]=a.useState(!1),[g,R]=a.useState(null),re=()=>`wallets_${(h==null?void 0:h.uid)||"default"}`;a.useEffect(()=>{m&&(k(m),p(!0),K(m.name||""),W(m.phone||""),_(m.nationalId||""),j(m.walletProvider||""),J((m.monthlyWithdrawalLimit||2e5).toString()),ne((m.monthlyTransferLimit||2e5).toString()),Q((m.dailyWithdrawalLimit||1e5).toString()),we((m.dailyTransferLimit||6e4).toString()),se(!!m.isDefault))},[m]);const xe=I=>{const X=new Date,fe=X.getMonth(),ke=X.getFullYear();if(!I.lastResetDate)return{...I,monthlyWithdrawalUsage:I.monthlyWithdrawalUsage||0,monthlyTransferUsage:I.monthlyTransferUsage||0,lastResetDate:X.toISOString().split("T")[0]};const Ae=new Date(I.lastResetDate),Ke=Ae.getMonth(),B=Ae.getFullYear();return fe!==Ke||ke!==B?{...I,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:X.toISOString().split("T")[0]}:I},De=async(I,X)=>{const fe=new Date().getMonth(),ke=new Date().getFullYear(),Ae=X.filter(ee=>{const z=new Date(ee.createdAt);return z.getMonth()===fe&&z.getFullYear()===ke&&ee.lineId===I}),Ke=Ae.filter(ee=>ee.txnType==="receive").reduce((ee,z)=>ee+(z.amount||0),0),B=Ae.filter(ee=>ee.txnType==="send").reduce((ee,z)=>ee+(z.amount||0),0);return{withdrawalUsage:Ke,transferUsage:B}},Le=async(I,X)=>{const fe=new Date,ke=fe.getDate(),Ae=fe.getMonth(),Ke=fe.getFullYear(),B=X.filter(pe=>{const Pe=new Date(pe.createdAt);return Pe.getDate()===ke&&Pe.getMonth()===Ae&&Pe.getFullYear()===Ke&&pe.lineId===I}),ee=B.filter(pe=>pe.txnType==="receive").reduce((pe,Pe)=>pe+(Pe.amount||0),0),z=B.filter(pe=>pe.txnType==="send").reduce((pe,Pe)=>pe+(Pe.amount||0),0);return{withdrawalUsage:ee,transferUsage:z}};a.useEffect(()=>{(async()=>{if(!(h!=null&&h.uid)){console.log("No user authenticated, skipping wallet loading"),Te(!1);return}console.log("Loading wallets for user:",h.uid),Te(!0);try{const{auth:X}=await rs(async()=>{const{auth:z}=await import("./index-Drf-Kel-.js").then(pe=>pe.a$);return{auth:z}},__vite__mapDeps([0,1]));let fe=0;const ke=5;for(;!X.currentUser&&fe<ke;)console.log(`Waiting for auth state... attempt ${fe+1}`),await new Promise(z=>setTimeout(z,1e3)),fe++;if(!X.currentUser)throw console.error("User not authenticated in Firebase Auth after retries"),new Error("not authenticated");console.log("Firebase Auth User:",X.currentUser.uid),console.log("Context User:",h.uid),console.log("Fetching wallets from Firebase...");const Ae=await ns.getByMerchantId(h.uid);console.log("Fetched wallets:",Ae),console.log("Fetching transactions from Firebase...");const Ke=await Ja.getByUserId(h.uid);console.log("Fetched transactions:",Ke);const ee=(await Promise.all(Ae.map(async z=>{const{withdrawalUsage:pe,transferUsage:Pe}=await De(z.id,Ke),{withdrawalUsage:nt,transferUsage:lt}=await Le(z.id,Ke);return{id:z.id,name:z.label||"محفظة بدون اسم",phone:z.msisdn,isDefault:!1,monthlyWithdrawalLimit:z.withdrawLimit||2e5,monthlyTransferLimit:z.transferLimit||2e5,dailyWithdrawalLimit:z.dailyWithdrawLimit||1e5,dailyTransferLimit:z.dailyTransferLimit||6e4,monthlyWithdrawalUsage:pe,monthlyTransferUsage:Pe,dailyWithdrawalUsage:nt,dailyTransferUsage:lt,lastResetDate:new Date().toISOString().split("T")[0],defaultTransferCommission:z.defaultTransferCommission!=null?Number(z.defaultTransferCommission):null,defaultWithdrawCommission:z.defaultWithdrawCommission!=null?Number(z.defaultWithdrawCommission):null}}))).map(xe);u(ee),console.log("Wallets loaded successfully:",ee)}catch(X){console.error("Error loading wallets:",X),console.log("تم تحميل المحافظ من البيانات المحفوظة محلياً");const fe=localStorage.getItem(re());if(fe){const ke=JSON.parse(fe);u(ke.map(Ae=>({...Ae,phone:Ae.phone||Ae.phoneNumber,monthlyWithdrawalLimit:Ae.monthlyWithdrawalLimit||2e5,monthlyTransferLimit:Ae.monthlyTransferLimit||2e5})))}}finally{Te(!1)}})()},[h==null?void 0:h.uid]);const $e=()=>{K(""),W(""),_(""),j(""),J("200000"),ne("200000"),Q("100000"),we("60000"),se(!1),k(null),p(!1)},gt=async()=>{if(!E.trim()||!q.trim()||!te.trim()){f({title:"خطأ",description:"يرجى ملء جميع الحقول المطلوبة",variant:"destructive"});return}if(!(h!=null&&h.uid)){f({title:"خطأ",description:"يجب تسجيل الدخول أولاً",variant:"destructive"});return}Te(!0);try{if(P){await ns.update(P.id,{label:E.trim(),msisdn:q.trim(),withdrawLimit:parseInt(N),transferLimit:parseInt(le),dailyWithdrawLimit:parseInt(he),dailyTransferLimit:parseInt(Z)}),await Zt.setLimits(P.id,{dailyTransferLimit:parseInt(Z||"0"),dailyWithdrawLimit:parseInt(he||"0"),monthlyTransferLimit:parseInt(le||"0"),monthlyWithdrawLimit:parseInt(N||"0")});const I=M.map(X=>X.id===P.id?{...X,name:E.trim(),phone:q.trim(),nationalId:D.trim(),walletProvider:te,monthlyWithdrawalLimit:parseInt(N),monthlyTransferLimit:parseInt(le),dailyWithdrawalLimit:parseInt(he),dailyTransferLimit:parseInt(Z)}:X);u(I),localStorage.setItem(re(),JSON.stringify(I)),f({title:"تم التحديث",description:"تم تحديث المحفظة بنجاح"})}else{const I={merchantUserId:h.uid,provider:te,msisdn:q.trim(),label:E.trim(),isActive:!0,dailyLimit:2e5,monthlyLimit:2e5,withdrawLimit:parseInt(N),transferLimit:parseInt(le),dailyTransferLimit:parseInt(Z),dailyWithdrawLimit:parseInt(he),dailyUsage:0,monthlyUsage:0,transferUsage:0,withdrawUsage:0},X=await ns.create(I);await Zt.setLimits(X,{dailyTransferLimit:parseInt(Z||"0"),dailyWithdrawLimit:parseInt(he||"0"),monthlyTransferLimit:parseInt(le||"0"),monthlyWithdrawLimit:parseInt(N||"0")});const fe=new Date().toISOString().split("T")[0],ke={id:X,name:E.trim(),phone:q.trim(),nationalId:D.trim(),walletProvider:te,isDefault:V,monthlyWithdrawalLimit:parseInt(N),monthlyTransferLimit:parseInt(le),dailyWithdrawalLimit:parseInt(he),dailyTransferLimit:parseInt(Z),monthlyWithdrawalUsage:0,monthlyTransferUsage:0,dailyWithdrawalUsage:0,dailyTransferUsage:0,lastResetDate:fe,defaultTransferCommission:null,defaultWithdrawCommission:null},Ae=[...M,ke];u(Ae),localStorage.setItem(re(),JSON.stringify(Ae)),f({title:"تم الإنشاء",description:"تم إنشاء المحفظة بنجاح"})}t&&t(),$e(),p(!1),k(null)}catch(I){console.error("Error saving wallet:",I),f({title:"خطأ",description:"حدث خطأ أثناء حفظ المحفظة",variant:"destructive"})}finally{Te(!1)}},Wt=I=>{k(I),K(I.name),W(I.phone),_(I.nationalId||""),j(I.walletProvider||""),J(I.monthlyWithdrawalLimit.toString()),ne(I.monthlyTransferLimit.toString()),se(I.isDefault),p(!0)},wt=async I=>{const X=M.find(fe=>fe.id===I);if(X!=null&&X.isDefault){f({title:"تحذير",description:"لا يمكن حذف المحفظة الافتراضية",variant:"destructive"});return}if(!(h!=null&&h.uid)){f({title:"خطأ",description:"يجب تسجيل الدخول أولاً",variant:"destructive"});return}Te(!0);try{await ns.delete(I);const fe=M.filter(ke=>ke.id!==I);u(fe),localStorage.setItem(re(),JSON.stringify(fe)),t&&t(),f({title:"تم الحذف",description:"تم حذف المحفظة بنجاح"})}catch(fe){console.error("Error deleting wallet:",fe),f({title:"خطأ",description:"حدث خطأ أثناء حذف المحفظة",variant:"destructive"})}finally{Te(!1)}},pt=I=>{const X=M.map(fe=>({...fe,isDefault:fe.id===I}));u(X),localStorage.setItem(re(),JSON.stringify(X)),t&&t(),f({title:"تم تحديث المحفظة الافتراضية",description:"تم تعيين المحفظة كافتراضية بنجاح"})};return e.jsxs(ie,{open:l,onOpenChange:d,children:[e.jsxs(oe,{className:"max-w-4xl max-h-[80vh] overflow-y-auto",children:[e.jsx(ce,{className:"pb-2",children:e.jsxs(de,{className:"flex items-center gap-1 text-sm",children:[e.jsx(Ut,{className:"h-3 w-3"}),"إدارة المحافظ"]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h3",{className:"text-sm font-semibold",children:["المحافظ المتاحة (",M.length,")"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(o,{onClick:()=>jt(!0),className:"flex items-center gap-1 h-6 px-2 text-xs",size:"sm",variant:"outline",children:[e.jsx(Xe,{className:"h-3 w-3"}),"الاطلاع على المحافظ"]}),e.jsxs(o,{onClick:()=>{d(),C("/user/add-wallet")},className:"flex items-center gap-1 h-6 px-2 text-xs",size:"sm",children:[e.jsx(xt,{className:"h-3 w-3"}),"إضافة محفظة جديدة"]})]})]}),(x||P)&&e.jsxs(_e,{className:"border-2 border-blue-200 bg-blue-50",children:[e.jsx(ct,{className:"pb-1",children:e.jsx(Nt,{className:"text-sm",children:P?"تعديل المحفظة":"إضافة محفظة جديدة"})}),e.jsxs(Ye,{className:"space-y-2 pt-1",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"شركة المحفظة"}),e.jsx("div",{className:"flex gap-1 items-center",children:e.jsxs(Ps,{value:te,onValueChange:j,children:[e.jsx(Os,{className:"h-6 text-xs flex-1",children:e.jsx(Ws,{placeholder:"اختر شركة المحفظة"})}),e.jsx(Fs,{children:Kr.map(I=>e.jsx(Bs,{value:I.id,className:"text-xs",children:e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsx("span",{children:I.name}),e.jsx("button",{type:"button",className:"h-4 w-4 p-0 ml-2 flex items-center justify-center hover:bg-blue-100 rounded",onClick:X=>{X.preventDefault(),X.stopPropagation(),ze(I.id)},children:e.jsx(Zr,{className:"h-3 w-3 text-blue-500 hover:text-blue-700"})})]})},I.id))})]})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"اسم المحفظة"}),e.jsx($,{value:E,onChange:I=>K(I.target.value),placeholder:"مثال: محفظة العمل",className:"h-6 text-xs"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"رقم الهاتف"}),e.jsxs("div",{className:"relative",children:[e.jsx(Xt,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx($,{value:q,onChange:I=>W(I.target.value),placeholder:"01030302038",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الرقم القومي للخط"}),e.jsxs("div",{className:"relative",children:[e.jsx(_a,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx($,{value:D,onChange:I=>_(I.target.value),placeholder:"29012345678901",maxLength:14,className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد الشهري للسحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Ze,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx($,{type:"number",value:N,onChange:I=>J(I.target.value),placeholder:"200000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد الشهري للتحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Ze,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx($,{type:"number",value:le,onChange:I=>ne(I.target.value),placeholder:"200000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد اليومي للسحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(ia,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-red-400"}),e.jsx($,{type:"number",value:he,onChange:I=>Q(I.target.value),placeholder:"100000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد اليومي للتحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Ms,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-blue-400"}),e.jsx($,{type:"number",value:Z,onChange:I=>we(I.target.value),placeholder:"60000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",id:"isDefault",checked:V,onChange:I=>se(I.target.checked),className:"rounded w-3 h-3"}),e.jsx("label",{htmlFor:"isDefault",className:"text-xs font-medium text-gray-700",children:"تعيين كمحفظة افتراضية"})]}),e.jsx("div",{className:"border-t pt-2 mt-2",children:e.jsxs("div",{className:"flex items-center gap-1 mb-2",children:[e.jsx(xl,{className:"h-3 w-3 text-gray-600"}),e.jsx("label",{className:"text-xs font-medium text-gray-700",children:"إعدادات العمولة"})]})}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(o,{onClick:gt,className:"flex-1 h-6 text-xs",size:"sm",children:P?"تحديث المحفظة":"إضافة المحفظة"}),e.jsx(o,{variant:"outline",onClick:$e,className:"h-6 text-xs",size:"sm",children:"إلغاء"})]})]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2",children:M.map(I=>{var X;return e.jsxs(_e,{className:`${I.isDefault?"border-green-300 bg-green-50":""}`,children:[e.jsx(ct,{className:"pb-1",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Nt,{className:"text-sm flex items-center gap-1",children:[e.jsx(Ut,{className:"h-3 w-3"}),I.name]}),I.isDefault&&e.jsx(rt,{variant:"default",className:"bg-green-600 text-xs px-1 py-0",children:"افتراضية"})]})}),e.jsxs(Ye,{className:"space-y-1 pt-0",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Xt,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"text-xs",children:I.phone})]}),I.walletProvider&&e.jsx("div",{className:"text-xs text-blue-600 mt-1",children:((X=Kr.find(fe=>fe.id===I.walletProvider))==null?void 0:X.name)||I.walletProvider}),e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-2 rounded-md border border-gray-200 shadow-sm space-y-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-gray-600 mb-1",children:"الحدود الشهرية"}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-red-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-red-400 to-red-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((I.monthlyWithdrawalUsage||0)/I.monthlyWithdrawalLimit*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-blue-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-400 to-blue-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((I.monthlyTransferUsage||0)/I.monthlyTransferLimit*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-xs text-red-600 font-medium",children:["متبقي سحب: ",Math.max(I.monthlyWithdrawalLimit-(I.monthlyWithdrawalUsage||0),0)," جنيه"]}),e.jsxs("div",{className:"text-xs text-blue-600 font-medium",children:["متبقي تحويل: ",Math.max(I.monthlyTransferLimit-(I.monthlyTransferUsage||0),0)," جنيه"]})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-gray-600 mb-1",children:"الحدود اليومية"}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-orange-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-orange-400 to-orange-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((I.dailyWithdrawalUsage||0)/I.dailyWithdrawalLimit*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-green-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-green-400 to-green-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((I.dailyTransferUsage||0)/I.dailyTransferLimit*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-xs text-orange-600 font-medium",children:["متبقي سحب يومي: ",Math.max(I.dailyWithdrawalLimit-(I.dailyWithdrawalUsage||0),0)," جنيه"]}),e.jsxs("div",{className:"text-xs text-green-600 font-medium",children:["متبقي تحويل يومي: ",Math.max(I.dailyTransferLimit-(I.dailyTransferUsage||0),0)," جنيه"]})]})]})]}),e.jsxs("div",{className:"flex gap-1 pt-1",children:[e.jsxs(o,{size:"sm",variant:"outline",onClick:()=>Wt(I),className:"flex-1 h-5 text-xs px-1",children:[e.jsx(Nl,{className:"h-2 w-2 mr-0.5"}),"تعديل"]}),!I.isDefault&&e.jsxs(e.Fragment,{children:[e.jsx(o,{size:"sm",variant:"outline",onClick:()=>pt(I.id),className:"flex-1 h-5 text-xs px-1",children:"جعلها افتراضية"}),e.jsx(o,{size:"sm",variant:"destructive",onClick:()=>wt(I.id),className:"h-5 px-1",children:e.jsx(It,{className:"h-2 w-2"})})]})]})]})]},I.id)})}),M.length===0&&e.jsx("div",{className:"text-center py-4 text-gray-500 text-xs",children:"لا توجد محافظ متاحة. قم بإضافة محفظة جديدة للبدء."})]}),We&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-800",children:"معلومات صاحب المحفظة"}),e.jsx("button",{onClick:()=>ze(null),className:"h-8 w-8 p-0 flex items-center justify-center hover:bg-gray-100 rounded-full transition-colors",children:e.jsx(ul,{className:"h-4 w-4 text-gray-500"})})]}),(()=>{const I=Kr.find(X=>X.id===We);return I?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-center mb-6",children:e.jsx("div",{className:"bg-blue-100 p-3 rounded-lg inline-block",children:e.jsx("h4",{className:"font-bold text-blue-700 text-lg",children:I.name})})}),e.jsx("div",{className:"bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-200",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-white p-3 rounded-lg shadow-sm",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full mr-2"}),e.jsx("span",{className:"font-semibold text-gray-700",children:"اسم صاحب المحفظة:"})]}),e.jsx("p",{className:"text-gray-900 font-medium text-lg mr-4",children:I.ownerName})]}),e.jsxs("div",{className:"bg-white p-3 rounded-lg shadow-sm",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full mr-2"}),e.jsx("span",{className:"font-semibold text-gray-700",children:"الرقم القومي:"})]}),e.jsx("p",{className:"text-gray-900 font-mono text-lg mr-4 tracking-wider",children:I.nationalId})]})]})}),e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 p-3 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(Zr,{className:"h-4 w-4 text-yellow-600 mr-2"}),e.jsx("span",{className:"text-sm text-yellow-800 font-medium",children:"هذه البيانات مسجلة رسمياً في النظام لهذه المحفظة"})]})})]}):null})()]})})]}),e.jsx(vs,{open:Ot,onOpenChange:jt,mode:"verify",title:"إدخال الرقم السري الرئيسي",description:"لا يمكن الاطلاع على المحافظ إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{jt(!1),Je(!0)}}),e.jsx(gc,{isOpen:st,onClose:()=>Je(!1),onWalletSelect:I=>{R(I),Je(!1)},onEditWallet:I=>{C(`/user/add-wallet?edit=1&id=${I.id}`),Je(!1)},onDeleteWallet:async I=>{try{if(await ns.delete(I),u(X=>{const fe=X.filter(ke=>ke.id!==I);try{localStorage.setItem(re(),JSON.stringify(fe))}catch(ke){console.error("Failed to update localStorage wallets after delete:",ke)}return fe}),t)try{await t()}catch(X){console.error("onWalletUpdate callback failed:",X)}}catch(X){console.error("Error deleting wallet:",X)}}}),e.jsx(fc,{wallet:g,isOpen:!!g,onClose:()=>R(null),onBack:()=>{R(null),Je(!0)}})]})},yc=({isOpen:l,onClose:d,transaction:t,onDelete:m})=>{if(!t)return null;const f=x=>{switch(x){case"completed":return e.jsx(Qt,{className:"h-5 w-5 text-green-500"});case"pending":return e.jsx(ys,{className:"h-5 w-5 text-yellow-500"});case"failed":return e.jsx(sn,{className:"h-5 w-5 text-red-500"});default:return e.jsx(ys,{className:"h-5 w-5 text-gray-500"})}},h=x=>{switch(x){case"completed":return"مكتملة";case"pending":return"قيد الانتظار";case"failed":return"فاشلة";default:return"غير معروف"}},C=x=>{switch(x){case"withdraw":return"سحب";case"send":return"إرسال";case"receive":return"استقبال";default:return"تحويل"}},M=()=>{const x=!!t.senderNumber,p=!!t.senderName,P=x?"الرقم المرسل:":p?"الرقم الراسل:":"رقم المحفظة:",k=x?t.senderNumber:p?t.senderName:t.senderPhone,E=`
      <div style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 500px; margin: 0 auto; padding: 30px; background: #fff;">
        <!-- Header -->
        <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #2563eb; padding-bottom: 20px;">
          <h1 style="color: #2563eb; margin-bottom: 5px; font-size: 28px;">إيصال المعاملة</h1>
          <p style="color: #666; font-size: 16px; margin: 0;">رقم المرجع: ${t.transactionReference||t.id}</p>
          <p style="color: #888; font-size: 14px; margin: 5px 0 0 0;">${new Date().toLocaleString("ar-EG")}</p>
        </div>
        
        <!-- Shop Info -->
        <div style="background: #f8fafc; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
          <h3 style="color: #1e293b; margin: 0 0 15px 0; font-size: 18px;">معلومات المحل</h3>
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span style="font-weight: 600; color: #475569;">اسم المحل:</span>
            <span style="color: #1e293b;">${t.merchantShopName||t.shopName||"غير محدد"}</span>
          </div>
        </div>
        
        <!-- Transaction Details -->
        <div style="background: #fff; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
          <h3 style="color: #1e293b; margin: 0 0 15px 0; font-size: 18px;">تفاصيل المعاملة</h3>
          
          <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
            <span style="font-weight: 600; color: #475569;">نوع المعاملة:</span>
            <span style="color: #2563eb; font-weight: 600;">${C(t.type)}</span>
          </div>
          
          <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
            <span style="font-weight: 600; color: #475569;">الحالة:</span>
            <span style="color: ${t.status==="completed"?"#16a34a":t.status==="pending"?"#ca8a04":"#dc2626"}; font-weight: 600;">
              ${h(t.status)}
            </span>
          </div>

          ${t!=null&&t.cashierName?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الكاشير:</span>
              <span style="color: #1e293b;">${t.cashierName}</span>
            </div>
          `:""}
          
          ${t.type!=="withdraw"?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">${P}</span>
              <span style="color: #1e293b;">${k}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الرقم المستقبل:</span>
              <span style="color: #1e293b;">${t.receiverNumber||t.receiverPhone}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">المبلغ المحول:</span>
              <span style="color: #2563eb; font-weight: bold; font-size: 16px;">${t.transferredAmount||t.amount} جنيه</span>
            </div>
          `:`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">رقم المحفظة:</span>
              <span style="color: #1e293b;">${t.senderPhone}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">المبلغ المسحوب:</span>
              <span style="color: #dc2626; font-weight: bold; font-size: 16px;">${t.withdrawnAmountDetailed||t.withdrawnAmount||t.amount} جنيه</span>
            </div>
          `}
          
          ${t.commission?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">العمولة:</span>
              <span style="color: #f59e0b; font-weight: 600;">${t.commission} جنيه</span>
            </div>
          `:""}
          
          <div style="display: flex; justify-content: space-between; padding: 8px 0;">
            <span style="font-weight: 600; color: #475569;">التاريخ والوقت:</span>
            <span style="color: #1e293b;">${t.createdAt.toLocaleString("ar-EG")}</span>
          </div>
        </div>
        
        <!-- Total Amount -->
        <div style="background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); border-radius: 12px; padding: 20px; margin-bottom: 20px; text-align: center;">
          <h3 style="color: white; margin: 0 0 10px 0; font-size: 16px;">إجمالي المبلغ</h3>
          <p style="color: white; font-size: 24px; font-weight: bold; margin: 0;">
            ${t.type==="withdraw"?"-":""}${t.amount} جنيه
          </p>
        </div>
        
        
        
        
        <!-- Footer -->
        <div style="text-align: center; color: #64748b; font-size: 12px; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
          <p style="margin: 0 0 5px 0;">شكراً لاستخدام خدماتنا</p>
          <p style="margin: 0;">تم إنشاء الإيصال في: ${new Date().toLocaleString("ar-EG")}</p>
        </div>
      </div>
    `,K=window.open("","_blank");K&&(K.document.write(`
        <html>
          <head>
            <title>إيصال المعاملة - ${t.transactionReference||t.id}</title>
            <meta charset="UTF-8">
            <style>
              body { 
                margin: 0; 
                padding: 20px; 
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: #f8fafc;
              }
              @media print {
                body { 
                  margin: 0; 
                  background: white;
                }
              }
            </style>
          </head>
          <body>
            ${E}
          </body>
        </html>
      `),K.document.close(),K.print())},u=()=>{window.confirm("هل أنت متأكد من حذف هذه المعاملة؟ لا يمكن التراجع عن هذا الإجراء.")&&(m(t.id),d())};return e.jsx(ie,{open:l,onOpenChange:d,children:e.jsxs(oe,{className:"w-[92vw] sm:w-auto sm:max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx(ce,{children:e.jsxs(de,{className:"flex items-center gap-2 text-xl",children:[e.jsx($a,{className:"h-6 w-6 text-blue-600"}),"إيصال المعاملة المفصل"]})}),e.jsxs("div",{className:"space-y-6",children:[e.jsx(_e,{className:"bg-gradient-to-r from-blue-50 to-indigo-50 border-blue-200",children:e.jsxs(ct,{className:"text-center pb-2",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 mb-2",children:[f(t.status),e.jsx(rt,{variant:t.status==="completed"?"default":"secondary",className:"text-sm",children:h(t.status)})]}),e.jsxs("h3",{className:"text-2xl font-bold text-blue-600",children:[t.type==="withdraw"?"-":"",t.amount," جنيه"]}),e.jsxs("p",{className:"text-sm text-gray-600",children:["رقم المرجع: ",t.transactionReference||t.id]})]})}),e.jsxs(_e,{children:[e.jsx(ct,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(qo,{className:"h-5 w-5 text-green-600"}),e.jsx("h4",{className:"font-semibold text-lg",children:"معلومات المحل"})]})}),e.jsxs(Ye,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"اسم المحل:"}),e.jsx("span",{className:"text-gray-900",children:t.merchantShopName||t.shopName||"غير محدد"})]}),(t==null?void 0:t.cashierName)&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"الكاشير:"}),e.jsx("span",{className:"text-gray-900",children:t.cashierName})]})]})]}),e.jsxs(_e,{children:[e.jsx(ct,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(za,{className:"h-5 w-5 text-blue-600"}),e.jsx("h4",{className:"font-semibold text-lg",children:"تفاصيل المعاملة"})]})}),e.jsx(Ye,{className:"space-y-3",children:e.jsxs("div",{className:"grid grid-cols-1 gap-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-blue-700",children:"نوع المعاملة:"}),e.jsx(rt,{variant:"outline",className:"bg-blue-100 text-blue-800",children:C(t.type)})]}),t.type!=="withdraw"?e.jsxs(e.Fragment,{children:[(()=>{const x=!!t.senderNumber,p=!!t.senderName,P=x?"الرقم المرسل:":p?"الرقم الراسل:":"رقم المحفظة:",k=x?t.senderNumber:p?t.senderName:t.senderPhone,E=x?Qr:Xt;return e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(E,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:P})]}),e.jsx("span",{className:"text-gray-900 font-mono",children:k})]})})(),e.jsx("div",{className:"flex items-center justify-center p-2",children:e.jsx(Yo,{className:"h-6 w-6 text-blue-500"})}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-green-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Qr,{className:"h-4 w-4 text-green-500"}),e.jsx("span",{className:"font-medium text-green-700",children:"الرقم المستقبل:"})]}),e.jsx("span",{className:"text-green-900 font-mono",children:t.receiverNumber||t.receiverPhone})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ze,{className:"h-4 w-4 text-blue-500"}),e.jsx("span",{className:"font-medium text-blue-700",children:"المبلغ المحول:"})]}),e.jsxs("span",{className:"text-blue-900 font-bold text-lg",children:[t.transferredAmount||t.amount," جنيه"]})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Xt,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:"رقم المحفظة:"})]}),e.jsx("span",{className:"text-gray-900 font-mono",children:t.senderPhone})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-red-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ze,{className:"h-4 w-4 text-red-500"}),e.jsx("span",{className:"font-medium text-red-700",children:"المبلغ المسحوب:"})]}),e.jsxs("span",{className:"text-red-900 font-bold text-lg",children:[t.withdrawnAmountDetailed||t.withdrawnAmount||t.amount," جنيه"]})]})]}),t.commission&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-yellow-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-yellow-700",children:"العمولة:"}),e.jsxs("span",{className:"text-yellow-900 font-semibold",children:[t.commission," جنيه"]})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(is,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:"التاريخ والوقت:"})]}),e.jsx("span",{className:"text-gray-900",children:t.createdAt.toLocaleString("ar-EG")})]})]})})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs(o,{onClick:M,className:"flex-1 bg-blue-600 hover:bg-blue-700 text-white",size:"lg",children:[e.jsx(Ho,{className:"h-5 w-5 mr-2"}),"طباعة الإيصال"]}),e.jsxs(o,{onClick:u,variant:"destructive",className:"flex-1",size:"lg",children:[e.jsx(It,{className:"h-5 w-5 mr-2"}),"حذف المعاملة"]})]}),e.jsx(o,{onClick:d,variant:"outline",className:"w-full",size:"lg",children:"إغلاق الإيصال"})]})]})})};function ll({open:l,onOpenChange:d,onSuccess:t,title:m,description:f,currentBalance:h,balanceLabel:C,userId:M}){const[u,x]=a.useState(""),[p,P]=a.useState(h.toString()),[k,E]=a.useState(!1),[K,q]=a.useState(""),[W,D]=a.useState(!1),_=ls.hasMasterPin(),te=async N=>{N.preventDefault(),q(""),D(!0);try{const J=parseFloat(p);if(isNaN(J)||J<0){q("يرجى إدخال مبلغ صحيح"),D(!1);return}_?ls.verifyMasterPin(u)?(t(J),d(!1),x(""),P("")):q("الرقم السري غير صحيح"):q("لم يتم تعيين رقم سري رئيسي. يرجى تعيين رقم سري رئيسي أولاً من إعدادات التطبيق")}catch{q("حدث خطأ أثناء التحقق من الرقم السري")}finally{D(!1)}},j=()=>{x(""),P(h.toString()),q(""),d(!1)};return ot.useEffect(()=>{l&&P(h.toString())},[h,l]),e.jsx(ie,{open:l,onOpenChange:j,children:e.jsxs(oe,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ce,{children:e.jsxs(de,{className:"flex items-center gap-2 text-right",children:[e.jsx(Ze,{className:"h-5 w-5"}),m]})}),e.jsxs("form",{onSubmit:te,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:f}),e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg",children:[e.jsxs(H,{className:"text-sm font-medium text-gray-700",children:[C," الحالي"]}),e.jsxs("div",{className:"text-lg font-bold text-gray-900 mt-1",children:[h.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"newAmount",className:"text-right",children:"المبلغ الجديد"}),e.jsx($,{id:"newAmount",type:"number",step:"0.01",min:"0",value:p,onChange:N=>P(N.target.value),placeholder:"أدخل المبلغ الجديد",className:"text-right",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"pin",className:"text-right",children:"الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx($,{id:"pin",type:k?"text":"password",value:u,onChange:N=>x(N.target.value),placeholder:"أدخل الرقم السري",className:"text-right pr-10",required:!0}),e.jsx(o,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>E(!k),children:k?e.jsx(Tt,{className:"h-4 w-4"}):e.jsx(Xe,{className:"h-4 w-4"})})]})]}),K&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-red-600 bg-red-50 p-2 rounded",children:[e.jsx(Ns,{className:"h-4 w-4"}),K]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(o,{type:"button",variant:"outline",onClick:j,className:"flex-1",children:"إلغاء"}),e.jsx(o,{type:"submit",disabled:W||!u||!p,className:"flex-1",children:W?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"جاري التحديث..."]}):e.jsxs(e.Fragment,{children:[e.jsx(js,{className:"h-4 w-4 mr-2"}),"تحديث الرصيد"]})})]})]})]})})}class oa{static getSecretKey(d){return d?`${this.SECRET_KEY_BASE}_${d}`:this.SECRET_KEY_BASE}static setSecretPin(d,t){const m=btoa(d);this.secretCache.set(this.getSecretKey(t),m)}static hasSecretPin(d){return this.secretCache.has(this.getSecretKey(d))}static verifySecretPin(d,t){const m=this.secretCache.get(this.getSecretKey(t));if(!m)return!1;try{return atob(m)===d}catch{return!1}}static clearSecretPin(d){this.secretCache.delete(this.getSecretKey(d))}}Rr(oa,"SECRET_KEY_BASE","dashboard_secret_pin"),Rr(oa,"secretCache",new Map);function jc({open:l,onOpenChange:d,userId:t}){const[m,f]=a.useState(""),[h,C]=a.useState(""),[M,u]=a.useState(""),[x,p]=a.useState(!1),[P,k]=a.useState(!1),[E,K]=a.useState(!1),[q,W]=a.useState(""),[D,_]=a.useState(!1),{toast:te}=zt(),j=oa.hasSecretPin(t),N=async le=>{le.preventDefault(),W(""),_(!0);try{if(!h||h.length<4){W("يجب أن يكون الرقم السري 4 أرقام على الأقل"),_(!1);return}if(h!==M){W("الرقم السري الجديد وتأكيده غير متطابقين"),_(!1);return}if(j){if(!m){W("يرجى إدخال الرقم السري الحالي"),_(!1);return}if(!oa.verifySecretPin(m,t)){W("الرقم السري الحالي غير صحيح"),_(!1);return}}oa.setSecretPin(h,t),te({title:j?"تم تغيير الرقم السري":"تم تعيين الرقم السري",description:j?"تم تغيير الرقم السري بنجاح":"تم تعيين الرقم السري بنجاح"}),J()}catch{W("حدث خطأ أثناء حفظ الرقم السري")}finally{_(!1)}},J=()=>{f(""),C(""),u(""),W(""),p(!1),k(!1),K(!1),d(!1)};return e.jsx(ie,{open:l,onOpenChange:J,children:e.jsxs(oe,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ce,{children:e.jsxs(de,{className:"flex items-center gap-2 text-right",children:[e.jsx(xl,{className:"h-5 w-5"}),j?"تغيير الرقم السري":"تعيين الرقم السري"]})}),e.jsxs("form",{onSubmit:N,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:j?"أدخل الرقم السري الحالي والرقم السري الجديد لتغييره":"أدخل الرقم السري الجديد الذي تريد استخدامه في عمليات التعديل"}),j&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي"}),e.jsxs("div",{className:"relative",children:[e.jsx($,{id:"currentPin",type:x?"text":"password",autoComplete:"off",value:m,onChange:le=>f(le.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(o,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>p(!x),children:x?e.jsx(Tt,{className:"h-4 w-4"}):e.jsx(Xe,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx($,{id:"newPin",type:P?"text":"password",autoComplete:"off",value:h,onChange:le=>C(le.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(o,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>k(!P),children:P?e.jsx(Tt,{className:"h-4 w-4"}):e.jsx(Xe,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx($,{id:"confirmPin",type:E?"text":"password",autoComplete:"off",value:M,onChange:le=>u(le.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(o,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>K(!E),children:E?e.jsx(Tt,{className:"h-4 w-4"}):e.jsx(Xe,{className:"h-4 w-4"})})]})]}),q&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(Ns,{className:"h-4 w-4"}),q]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(o,{type:"submit",disabled:D,className:"flex-1",children:[e.jsx(js,{className:"h-4 w-4 mr-2"}),D?"جاري الحفظ...":j?"تغيير الرقم السري":"تعيين الرقم السري"]}),e.jsx(o,{type:"button",variant:"outline",onClick:J,disabled:D,children:"إلغاء"})]})]})]})})}const Vr=new Map;function bc({open:l,onOpenChange:d,userId:t}){const[m,f]=a.useState(""),[h,C]=a.useState(""),[M,u]=a.useState(""),[x,p]=a.useState(!1),[P,k]=a.useState(!1),[E,K]=a.useState(!1),[q,W]=a.useState(""),[D,_]=a.useState(!1),{toast:te}=zt(),j=t?`cash_drawer_pin_${t}`:"cash_drawer_pin",N=()=>Vr.has(j),J=Q=>{const Z=Vr.get(j);if(!Z)return!1;try{return atob(Z)===Q}catch{return!1}},le=Q=>{const Z=btoa(Q);Vr.set(j,Z)},ne=async Q=>{Q.preventDefault(),W(""),_(!0);try{if(!h||h.length<4){W("يجب أن يكون الرقم السري 4 أرقام على الأقل"),_(!1);return}if(h!==M){W("الرقم السري الجديد وتأكيده غير متطابقين"),_(!1);return}if(N()){if(!m){W("يرجى إدخال الرقم السري الحالي لدرج النقدية"),_(!1);return}if(!J(m)){W("الرقم السري الحالي لدرج النقدية غير صحيح"),_(!1);return}}le(h),te({title:N()?"تم تغيير رقم درج النقدية":"تم تعيين رقم درج النقدية",description:N()?"تم تغيير الرقم السري لدرج النقدية بنجاح":"تم تعيين الرقم السري لدرج النقدية بنجاح"}),he()}catch{W("حدث خطأ أثناء حفظ الرقم السري لدرج النقدية")}finally{_(!1)}},he=()=>{f(""),C(""),u(""),W(""),p(!1),k(!1),K(!1),d(!1)};return e.jsx(ie,{open:l,onOpenChange:he,children:e.jsxs(oe,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ce,{children:e.jsxs(de,{className:"flex items-center gap-2 text-right",children:[e.jsx(Ze,{className:"h-5 w-5 text-green-600"}),N()?"تغيير رقم درج النقدية":"تعيين رقم درج النقدية"]})}),e.jsxs("form",{onSubmit:ne,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:N()?"أدخل الرقم السري الحالي والرقم السري الجديد لدرج النقدية":"أدخل الرقم السري الجديد الذي تريد استخدامه لحماية درج النقدية"}),N()&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي لدرج النقدية"}),e.jsxs("div",{className:"relative",children:[e.jsx($,{id:"currentPin",type:x?"text":"password",autoComplete:"off",value:m,onChange:Q=>f(Q.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(o,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>p(!x),children:x?e.jsx(Tt,{className:"h-4 w-4"}):e.jsx(Xe,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد لدرج النقدية"}),e.jsxs("div",{className:"relative",children:[e.jsx($,{id:"newPin",type:P?"text":"password",autoComplete:"off",value:h,onChange:Q=>C(Q.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(o,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>k(!P),children:P?e.jsx(Tt,{className:"h-4 w-4"}):e.jsx(Xe,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx($,{id:"confirmPin",type:E?"text":"password",autoComplete:"off",value:M,onChange:Q=>u(Q.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(o,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>K(!E),children:E?e.jsx(Tt,{className:"h-4 w-4"}):e.jsx(Xe,{className:"h-4 w-4"})})]})]}),q&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(Ns,{className:"h-4 w-4"}),q]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(o,{type:"submit",disabled:D,className:"flex-1 bg-green-600 hover:bg-green-700",children:[e.jsx(js,{className:"h-4 w-4 mr-2"}),D?"جاري الحفظ...":N()?"تغيير رقم درج النقدية":"تعيين رقم درج النقدية"]}),e.jsx(o,{type:"button",variant:"outline",onClick:he,disabled:D,children:"إلغاء"})]})]}),e.jsx("div",{className:"text-xs text-gray-500 text-center mt-2",children:"💰 هذا الرقم السري خاص بحماية درج النقدية فقط"})]})})}const qr=new Map;function Nc({open:l,onOpenChange:d,userId:t}){const[m,f]=a.useState(""),[h,C]=a.useState(""),[M,u]=a.useState(""),[x,p]=a.useState(!1),[P,k]=a.useState(!1),[E,K]=a.useState(!1),[q,W]=a.useState(""),[D,_]=a.useState(!1),{toast:te}=zt(),j=t?`wallet_total_pin_${t}`:"wallet_total_pin",N=()=>qr.has(j),J=Q=>{const Z=qr.get(j);if(!Z)return!1;try{return atob(Z)===Q}catch{return!1}},le=Q=>{const Z=btoa(Q);qr.set(j,Z)},ne=async Q=>{Q.preventDefault(),W(""),_(!0);try{if(!h||h.length<4){W("يجب أن يكون الرقم السري 4 أرقام على الأقل"),_(!1);return}if(h!==M){W("الرقم السري الجديد وتأكيده غير متطابقين"),_(!1);return}if(N()){if(!m){W("يرجى إدخال الرقم السري الحالي لإجمالي المحفظة"),_(!1);return}if(!J(m)){W("الرقم السري الحالي لإجمالي المحفظة غير صحيح"),_(!1);return}}le(h),te({title:N()?"تم تغيير رقم إجمالي المحفظة":"تم تعيين رقم إجمالي المحفظة",description:N()?"تم تغيير الرقم السري لإجمالي المحفظة بنجاح":"تم تعيين الرقم السري لإجمالي المحفظة بنجاح"}),he()}catch{W("حدث خطأ أثناء حفظ الرقم السري لإجمالي المحفظة")}finally{_(!1)}},he=()=>{f(""),C(""),u(""),W(""),p(!1),k(!1),K(!1),d(!1)};return e.jsx(ie,{open:l,onOpenChange:he,children:e.jsxs(oe,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ce,{children:e.jsxs(de,{className:"flex items-center gap-2 text-right",children:[e.jsx(Ut,{className:"h-5 w-5 text-blue-600"}),N()?"تغيير رقم إجمالي المحفظة":"تعيين رقم إجمالي المحفظة"]})}),e.jsxs("form",{onSubmit:ne,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:N()?"أدخل الرقم السري الحالي والرقم السري الجديد لإجمالي المحفظة":"أدخل الرقم السري الجديد الذي تريد استخدامه لحماية إجمالي المحفظة"}),N()&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي لإجمالي المحفظة"}),e.jsxs("div",{className:"relative",children:[e.jsx($,{id:"currentPin",type:x?"text":"password",autoComplete:"off",value:m,onChange:Q=>f(Q.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(o,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>p(!x),children:x?e.jsx(Tt,{className:"h-4 w-4"}):e.jsx(Xe,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد لإجمالي المحفظة"}),e.jsxs("div",{className:"relative",children:[e.jsx($,{id:"newPin",type:P?"text":"password",autoComplete:"off",value:h,onChange:Q=>C(Q.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(o,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>k(!P),children:P?e.jsx(Tt,{className:"h-4 w-4"}):e.jsx(Xe,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx($,{id:"confirmPin",type:E?"text":"password",autoComplete:"off",value:M,onChange:Q=>u(Q.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(o,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>K(!E),children:E?e.jsx(Tt,{className:"h-4 w-4"}):e.jsx(Xe,{className:"h-4 w-4"})})]})]}),q&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(Ns,{className:"h-4 w-4"}),q]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(o,{type:"submit",disabled:D,className:"flex-1 bg-blue-600 hover:bg-blue-700",children:[e.jsx(js,{className:"h-4 w-4 mr-2"}),D?"جاري الحفظ...":N()?"تغيير رقم إجمالي المحفظة":"تعيين رقم إجمالي المحفظة"]}),e.jsx(o,{type:"button",variant:"outline",onClick:he,disabled:D,children:"إلغاء"})]})]}),e.jsx("div",{className:"text-xs text-gray-500 text-center mt-2",children:"💼 هذا الرقم السري خاص بحماية إجمالي المحفظة فقط"})]})})}function wc({open:l,onOpenChange:d,onSuccess:t,title:m,description:f,currentBalance:h,balanceLabel:C,userId:M}){const[u,x]=a.useState(""),[p,P]=a.useState(""),[k,E]=a.useState("add"),[K,q]=a.useState(!1),[W,D]=a.useState(""),[_,te]=a.useState(!1),j=ls.hasMasterPin(),N=async ne=>{ne.preventDefault(),D(""),te(!0);try{const he=parseFloat(p);if(isNaN(he)||he<=0){D("يرجى إدخال مبلغ صحيح أكبر من صفر"),te(!1);return}if(k==="subtract"&&he>h){D("لا يمكن خصم مبلغ أكبر من الرصيد الحالي"),te(!1);return}if(j)if(ls.verifyMasterPin(u)){const Q=k==="add"?he:-he;J(),t(Q)}else D("الرقم السري غير صحيح");else D("لم يتم تعيين رقم سري رئيسي. يرجى تعيين رقم سري رئيسي أولاً من إعدادات التطبيق")}catch{D("حدث خطأ أثناء التحقق من الرقم السري")}finally{te(!1)}},J=()=>{x(""),P(""),E("add"),D(""),d(!1)},le=()=>{const ne=parseFloat(p)||0;return k==="add"?h+ne:h-ne};return e.jsx(ie,{open:l,onOpenChange:J,children:e.jsxs(oe,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ce,{children:e.jsxs(de,{className:"flex items-center gap-2 text-right",children:[k==="add"?e.jsx(xt,{className:"h-5 w-5 text-green-600"}):e.jsx(fs,{className:"h-5 w-5 text-red-600"}),m]})}),e.jsxs("form",{onSubmit:N,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:f}),e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg",children:[e.jsxs(H,{className:"text-sm font-medium text-gray-700",children:[C," الحالي"]}),e.jsxs("div",{className:"text-lg font-bold text-gray-900 mt-1",children:[h.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{className:"text-right",children:"نوع العملية"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(o,{type:"button",variant:k==="add"?"default":"outline",onClick:()=>E("add"),className:"flex-1 flex items-center gap-2",children:[e.jsx(xt,{className:"h-4 w-4"}),"إضافة"]}),e.jsxs(o,{type:"button",variant:k==="subtract"?"default":"outline",onClick:()=>E("subtract"),className:"flex-1 flex items-center gap-2",children:[e.jsx(fs,{className:"h-4 w-4"}),"خصم"]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(H,{htmlFor:"amount",className:"text-right",children:["المبلغ المراد ",k==="add"?"إضافته":"خصمه"]}),e.jsx($,{id:"amount",type:"number",step:"0.01",min:"0.01",value:p,onChange:ne=>P(ne.target.value),placeholder:`أدخل المبلغ المراد ${k==="add"?"إضافته":"خصمه"}`,className:"text-right",required:!0})]}),p&&!isNaN(parseFloat(p))&&e.jsxs("div",{className:`p-3 rounded-lg ${k==="add"?"bg-green-50 border border-green-200":"bg-red-50 border border-red-200"}`,children:[e.jsx(H,{className:"text-sm font-medium text-gray-700",children:"الرصيد الجديد المتوقع"}),e.jsxs("div",{className:`text-lg font-bold mt-1 ${k==="add"?"text-green-700":"text-red-700"}`,children:[le().toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"pin",className:"text-right",children:"الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx($,{id:"pin",type:K?"text":"password",autoComplete:"off",value:u,onChange:ne=>x(ne.target.value),placeholder:"أدخل الرقم السري",className:"text-right pr-10",required:!0}),e.jsx(o,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>q(!K),children:K?e.jsx(Tt,{className:"h-4 w-4"}):e.jsx(Xe,{className:"h-4 w-4"})})]})]}),W&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-red-600 bg-red-50 p-2 rounded",children:[e.jsx(Ns,{className:"h-4 w-4"}),W]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(o,{type:"button",variant:"outline",onClick:J,className:"flex-1",children:"إلغاء"}),e.jsx(o,{type:"submit",disabled:_||!u||!p,className:`flex-1 ${k==="add"?"bg-green-600 hover:bg-green-700":"bg-red-600 hover:bg-red-700"}`,children:_?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"جاري التحديث..."]}):e.jsxs(e.Fragment,{children:[e.jsx(js,{className:"h-4 w-4 mr-2"}),k==="add"?"إضافة المبلغ":"خصم المبلغ"]})})]})]})]})})}function Sc(l){return l?`readBroadcastIds_${l}`:"readBroadcastIds_guest"}function Dc({className:l}){const{user:d,profile:t}=es(),[m,f]=a.useState([]),[h,C]=a.useState(new Set);a.useState(null);const[M,u]=a.useState(!1);a.useRef(new Set),a.useRef(!1);const x=a.useRef(null),p=a.useRef(null);a.useRef(null),a.useState({position:"fixed",top:0,left:0,zIndex:1e4});const P=!1,k=a.useMemo(()=>{const j=["global"];return d!=null&&d.uid&&j.push(`user:${d.uid}`),t!=null&&t.shopId&&j.push(`shop:${t.shopId}`),j},[d==null?void 0:d.uid,t==null?void 0:t.shopId]),E=Sc(d==null?void 0:d.uid);a.useEffect(()=>{try{const j=localStorage.getItem(E);if(j){const N=JSON.parse(j);Array.isArray(N)&&C(new Set(N.filter(Boolean)))}else C(new Set)}catch(j){console.warn("Failed to load read ids",j),C(new Set)}},[E]),a.useEffect(()=>{const j=ac(k,N=>{f(N)});return()=>j()},[k]),a.useEffect(()=>{},[m]),a.useEffect(()=>()=>{x.current&&clearTimeout(x.current)},[]);const K=m.reduce((j,N)=>j+(N.id&&!h.has(N.id)?1:0),0),q=m.slice(0,4),W=m.slice(4),D=j=>{if(!j||h.has(j))return;const N=new Set(h);N.add(j),C(N);try{localStorage.setItem(E,JSON.stringify(Array.from(N)))}catch{}},_=()=>{const j=m.map(J=>J.id).filter(Boolean),N=new Set(h);j.forEach(J=>N.add(J)),C(N);try{localStorage.setItem(E,JSON.stringify(Array.from(N)))}catch{}},te=(j,N)=>{j&&window.open(j,"_blank"),N&&D(N)};return a.useEffect(()=>{},[M]),e.jsxs("div",{className:`relative inline-block ${l||""}`,ref:p,children:[e.jsxs(rc,{children:[e.jsx(nc,{asChild:!0,children:e.jsx(o,{variant:"ghost",className:"relative h-8 w-8 rounded-full p-0 hover:bg-transparent focus:ring-1 focus:ring-primary focus:ring-offset-1 transition-all",title:"الإشعارات",children:e.jsxs("div",{className:"relative h-8 w-8 rounded-full bg-primary/10 flex items-center justify-center border border-border shadow-sm hover:shadow-md",children:[e.jsx(_r,{className:"h-4 w-4 text-primary"}),K>0&&e.jsx("span",{className:"absolute -top-1 -right-1 min-w-[18px] h-[18px] px-1 rounded-full bg-red-500 text-white text-[10px] font-bold flex items-center justify-center shadow",children:K})]})})}),e.jsxs(lc,{className:"w-80",align:"end",forceMount:!0,children:[e.jsxs(ic,{className:"flex items-center justify-between",children:[e.jsx("span",{children:"الإشعارات"}),m.length>0&&e.jsxs(o,{variant:"outline",size:"sm",className:"h-7 text-xs",onClick:_,children:[e.jsx(Qt,{className:"h-3 w-3 mr-1"}),"تمييز الكل كمقروء"]})]}),e.jsx(nl,{}),m.length===0?e.jsx("div",{className:"p-3 text-sm text-muted-foreground",children:"لا توجد إشعارات حالياً"}):e.jsxs(e.Fragment,{children:[q.map(j=>{const N=j.id?!h.has(j.id):!1;return e.jsx("div",{className:`px-2 py-2 rounded-md ${N?"bg-primary/5":""}`,children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(_r,{className:`h-4 w-4 ${N?"text-primary":"text-muted-foreground"}`}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-sm font-medium",children:j.title||"إشعار"}),e.jsx("div",{className:"text-xs text-muted-foreground whitespace-pre-line",children:j.message}),j.linkUrl&&e.jsxs(o,{variant:"link",className:"px-0 h-6 text-xs",onClick:()=>te(j.linkUrl,j.id),children:["فتح الرابط ",e.jsx(rl,{className:"h-3 w-3 ml-1"})]})]}),N?e.jsx(o,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>D(j.id),title:"تمييز كمقروء",children:e.jsx(Qt,{className:"h-4 w-4 text-primary"})}):e.jsx(o,{variant:"ghost",size:"icon",className:"h-6 w-6",disabled:!0,title:"مقروء",children:e.jsx(Qt,{className:"h-4 w-4 text-muted-foreground"})})]})},j.id)}),W.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(nl,{}),e.jsx("div",{className:"max-h-64 overflow-y-auto pr-1",children:W.map(j=>{const N=j.id?!h.has(j.id):!1;return e.jsx("div",{className:`px-2 py-2 rounded-md ${N?"bg-primary/5":""}`,children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(_r,{className:`h-4 w-4 ${N?"text-primary":"text-muted-foreground"}`}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-sm font-medium",children:j.title||"إشعار"}),e.jsx("div",{className:"text-xs text-muted-foreground whitespace-pre-line",children:j.message}),j.linkUrl&&e.jsxs(o,{variant:"link",className:"px-0 h-6 text-xs",onClick:()=>te(j.linkUrl,j.id),children:["فتح الرابط ",e.jsx(rl,{className:"h-3 w-3 ml-1"})]})]}),N?e.jsx(o,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>D(j.id),title:"تمييز كمقروء",children:e.jsx(Qt,{className:"h-4 w-4 text-primary"})}):e.jsx(o,{variant:"ghost",size:"icon",className:"h-6 w-6",disabled:!0,title:"مقروء",children:e.jsx(Qt,{className:"h-4 w-4 text-muted-foreground"})})]})},j.id)})})]})]})]})]}),P]})}const il=({isOpen:l,onClose:d,onTrialStarted:t})=>{const{user:m}=es(),[f,h]=a.useState(!1),[C,M]=a.useState(!1),[u,x]=a.useState(""),[p,P]=a.useState(24);a.useEffect(()=>{const K=async()=>{if(m!=null&&m.uid){const W=await aa.getTrialData(m.uid);M(W.hasUsedFreeTrial)}},q=async()=>{try{const W=await aa.getTrialDurationHours();P(W)}catch{}};l&&(K(),q())},[l,m]);const k=async()=>{if(m!=null&&m.uid){h(!0);try{const K=await aa.startFreeTrial(m.uid);K.success?(x(K.message),window.location.href="/user/dashboard"):x(K.message||"تعذر تفعيل التجربة المجانية")}catch{x("حدث خطأ أثناء تفعيل التجربة المجانية")}finally{h(!1)}}},E=async()=>{if(m!=null&&m.uid){h(!0);try{await No(m.uid,Gt.ZERO,m.uid),window.location.href="/user/dashboard"}catch{x("حدث خطأ أثناء تفعيل باقة الزيرو")}finally{h(!1)}}};return e.jsxs(e.Fragment,{children:[l&&e.jsx("div",{className:"fixed inset-0 z-40",style:{background:"rgba(0, 0, 0, 0.15)",backdropFilter:"blur(3px)",WebkitBackdropFilter:"blur(3px)",pointerEvents:"auto"}}),e.jsx(ie,{open:l,onOpenChange:()=>{},children:e.jsxs(oe,{className:"sm:max-w-lg z-50 border-0 shadow-2xl",style:{position:"fixed",top:"50%",left:"50%",transform:"translate(-50%, -50%)",pointerEvents:"auto",background:"linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 0.95) 100%)",backdropFilter:"blur(10px)",WebkitBackdropFilter:"blur(10px)",borderRadius:"20px",border:"1px solid rgba(255, 255, 255, 0.3)"},children:[e.jsxs(ce,{className:"text-center pb-0 pt-0",children:[e.jsx("div",{className:"flex justify-center mb-1",children:e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-0 rounded-full",style:{background:"linear-gradient(135deg, #f59e0b, #d97706)",filter:"blur(8px)",opacity:.3}}),e.jsx("div",{className:"relative bg-gradient-to-br from-orange-400 to-orange-600 p-2 rounded-full",children:e.jsx(Jr,{className:"h-12 w-12 text-white"})})]})}),e.jsx(de,{className:"text-2xl font-bold bg-gradient-to-r from-gray-800 to-gray-600 bg-clip-text text-transparent text-center mt-0 mb-0 leading-tight",children:"تفعيل الحساب مطلوب"})]}),e.jsxs("div",{className:"text-center pt-6 pb-0 px-2",children:[e.jsxs("div",{className:"bg-gradient-to-r from-orange-50 to-amber-50 rounded-xl p-6 mb-6 border border-orange-100",children:[e.jsx("p",{className:"text-gray-700 text-lg leading-relaxed font-medium",children:"حسابك في انتظار التفعيل من قبل المسؤول"}),e.jsx("p",{className:"text-sm font-semibold text-orange-700 mt-3 mb-3 bg-orange-100 p-3 rounded-lg border border-orange-200",children:"للتفعيل السريع: تواصل مع الإدارة عبر واتساب فقط على الرقم التالي"}),e.jsxs("div",{className:"bg-green-50 p-4 rounded-lg border border-green-200 mt-3",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"text-base font-bold text-green-700",children:"واتساب الإدارة:"}),e.jsx("a",{href:"https://wa.me/201000392539",target:"_blank",rel:"noopener noreferrer",className:"text-lg font-bold text-green-600 hover:text-green-700 underline",children:"01000392539"})]}),e.jsx("p",{className:"text-sm text-green-600 mt-2 text-center",children:"اضغط على الرقم للتواصل المباشر عبر واتساب"})]})]}),!C&&e.jsxs("div",{className:"bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-4 mb-4 border border-green-200",children:[e.jsxs("div",{className:"flex items-center justify-center mb-2",children:[e.jsx(Jr,{className:"h-5 w-5 text-green-600 ml-2"}),e.jsx("span",{className:"text-green-700 font-semibold",children:"باقة الزيرو المجانية الدائمة"})]}),e.jsx("p",{className:"text-green-600 text-sm text-center",children:"فعل باقة الزيرو الان واستمتع ب 10 عمليات سحب وتحويل يوميا"})]}),u&&e.jsx("div",{className:`rounded-xl p-4 mb-4 text-center ${u.includes("تم تفعيل")?"bg-green-50 border border-green-200 text-green-700":"bg-red-50 border border-red-200 text-red-700"}`,children:e.jsx("p",{className:"font-medium",children:u})}),e.jsxs("div",{className:"flex items-center justify-center space-x-2 text-sm text-gray-500 mb-0",children:[e.jsxs("div",{className:"flex space-x-1",children:[e.jsx("div",{className:"w-2 h-2 bg-orange-400 rounded-full animate-pulse"}),e.jsx("div",{className:"w-2 h-2 bg-orange-400 rounded-full animate-pulse",style:{animationDelay:"0.2s"}}),e.jsx("div",{className:"w-2 h-2 bg-orange-400 rounded-full animate-pulse",style:{animationDelay:"0.4s"}})]}),e.jsx("span",{className:"mr-2",children:"في انتظار التفعيل"})]})]}),e.jsxs("div",{className:"flex flex-col space-y-3 pb-2",children:[!C&&!u.includes("تم تفعيل")&&e.jsxs(e.Fragment,{children:[e.jsxs(o,{onClick:k,disabled:f,className:"w-full max-w-2xl mx-auto relative bg-gradient-to-r from-blue-600 to-indigo-600 hover:brightness-110 text-white px-10 py-4 rounded-2xl font-bold text-xl ring-2 ring-blue-300 ring-offset-1 shadow-2xl hover:shadow-3xl transition-all duration-500 transform hover:scale-110 hover:-translate-y-1 disabled:opacity-50 disabled:cursor-not-allowed overflow-hidden group focus-visible:outline-none focus-visible:ring-4 focus-visible:ring-blue-300",style:{boxShadow:"0 15px 35px rgba(59, 130, 246, 0.4), 0 5px 15px rgba(0, 0, 0, 0.1)"},children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-white/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"}),e.jsx("div",{className:"absolute -top-1 -left-1 w-3 h-3 bg-yellow-400 rounded-full animate-ping"}),e.jsx("div",{className:"absolute -top-1 -right-1 w-2 h-2 bg-green-400 rounded-full animate-pulse"}),f?e.jsxs("div",{className:"flex items-center relative z-10",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-white ml-3"}),e.jsx("span",{className:"bg-gradient-to-r from-white to-gray-100 bg-clip-text text-transparent",children:"جاري التفعيل..."})]}):e.jsxs("div",{className:"flex items-center relative z-10",children:[e.jsx(oc,{className:"h-6 w-6 ml-3 animate-bounce"}),e.jsx("span",{className:"bg-gradient-to-r from-white to-gray-100 bg-clip-text text-transparent",children:`التجربة المجانية لمدة ${p} ${p>=3&&p<=10?"ساعات":p===2?"ساعتين":"ساعة"}`})]})]}),e.jsxs(o,{onClick:E,disabled:f,className:"w-full max-w-2xl mx-auto relative bg-gradient-to-r from-green-600 to-emerald-600 hover:brightness-110 text-white px-10 py-4 rounded-2xl font-bold text-xl ring-2 ring-emerald-300 ring-offset-1 shadow-2xl hover:shadow-3xl transition-all duration-500 transform hover:scale-110 hover:-translate-y-1 disabled:opacity-50 disabled:cursor-not-allowed overflow-hidden group focus-visible:outline-none focus-visible:ring-4 focus-visible:ring-emerald-300",style:{boxShadow:"0 15px 35px rgba(99, 102, 241, 0.4), 0 5px 15px rgba(0, 0, 0, 0.1)"},children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-white/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"}),e.jsx("div",{className:"absolute -top-1 -left-1 w-3 h-3 bg-yellow-400 rounded-full animate-ping"}),e.jsx("div",{className:"absolute -top-1 -right-1 w-2 h-2 bg-green-400 rounded-full animate-pulse"}),f?e.jsxs("div",{className:"flex items-center relative z-10",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-white ml-3"}),e.jsx("span",{className:"bg-gradient-to-r from-white to-gray-100 bg-clip-text text-transparent",children:"جاري التفعيل..."})]}):e.jsxs("div",{className:"flex items-center relative z-10",children:[e.jsx(Jr,{className:"h-6 w-6 ml-3 animate-bounce"}),e.jsx("span",{className:"bg-gradient-to-r from-white to-gray-100 bg-clip-text text-transparent",children:"فعّل باقة الزيرو الآن"})]})]})]}),e.jsx(o,{onClick:d,variant:"outline",className:"border-2 border-gray-300 hover:border-gray-400 text-gray-700 hover:text-gray-800 px-10 py-3 rounded-xl font-semibold text-lg transition-all duration-300 transform hover:scale-105",children:C?"فهمت":"إغلاق"})]})]})})]})};function Cc({isOpen:l,onClose:d}){const[t,m]=a.useState("0"),[f,h]=a.useState(null),[C,M]=a.useState(null),[u,x]=a.useState(!1),p=j=>{u?(m(j),x(!1)):m(t==="0"?j:t+j)},P=j=>{const N=parseFloat(t);if(f===null)h(N);else if(C){const le=k(f||0,N,C);m(String(le)),h(le)}x(!0),M(j)},k=(j,N,J)=>{switch(J){case"+":return j+N;case"-":return j-N;case"×":return j*N;case"÷":return N===0?0:j/N;case"=":return N;default:return N}},E=()=>{const j=parseFloat(t);if(f!==null&&C){const N=k(f,j,C);m(String(N)),h(null),M(null),x(!0)}},K=()=>{m("0"),h(null),M(null),x(!1)},q=()=>{m("0")},W=()=>{u?(m("0."),x(!1)):t.indexOf(".")===-1&&m(t+".")},D=()=>{t!=="0"&&m(t.charAt(0)==="-"?t.slice(1):"-"+t)},_=()=>{const j=parseFloat(t);m(String(j/100))},te=j=>{const N=j.key;j.preventDefault(),N>="0"&&N<="9"?p(N):N==="+"?P("+"):N==="-"?P("-"):N==="*"?P("×"):N==="/"?P("÷"):N==="Enter"||N==="="?E():N==="Escape"||N==="c"||N==="C"?K():N==="Backspace"?q():N==="."?W():N==="%"&&_()};return a.useEffect(()=>(l?document.addEventListener("keydown",te):document.removeEventListener("keydown",te),()=>{document.removeEventListener("keydown",te)}),[l,t,f,C,u]),e.jsx(ie,{open:l,onOpenChange:j=>!j&&d(),children:e.jsxs(oe,{className:"sm:max-w-md",children:[e.jsx(ce,{children:e.jsxs(de,{className:"flex items-center gap-2 text-right",children:[e.jsx(Sl,{className:"h-5 w-5"}),"آلة حاسبة"]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-gray-900 text-white p-4 rounded-lg text-right",children:e.jsx("div",{className:"text-3xl font-mono font-bold min-h-[3rem] flex items-center justify-end overflow-hidden",children:t})}),e.jsxs("div",{className:"grid grid-cols-4 gap-2",children:[e.jsx(o,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:K,children:"AC"}),e.jsx(o,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:q,children:"CE"}),e.jsx(o,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:_,children:"%"}),e.jsx(o,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>P("÷"),children:"÷"}),e.jsx(o,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>p("7"),children:"7"}),e.jsx(o,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>p("8"),children:"8"}),e.jsx(o,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>p("9"),children:"9"}),e.jsx(o,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>P("×"),children:"×"}),e.jsx(o,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>p("4"),children:"4"}),e.jsx(o,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>p("5"),children:"5"}),e.jsx(o,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>p("6"),children:"6"}),e.jsx(o,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>P("-"),children:"-"}),e.jsx(o,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>p("1"),children:"1"}),e.jsx(o,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>p("2"),children:"2"}),e.jsx(o,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>p("3"),children:"3"}),e.jsx(o,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>P("+"),children:"+"}),e.jsx(o,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50 col-span-2",onClick:()=>p("0"),children:"0"}),e.jsx(o,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:W,children:"."}),e.jsx(o,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:E,children:"="})]}),e.jsx(o,{variant:"outline",className:"w-full h-10 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:D,children:"+/-"})]})]})})}function Ic({isOpen:l,onClose:d}){const[t,m]=a.useState([]),[f,h]=a.useState({productName:"",price:"",wholesalePrice:"",quantity:""}),[C,M]=a.useState(!1);a.useState(null);const{toast:u}=zt(),{user:x,profile:p}=es(),[P,k]=a.useState([]),[E,K]=a.useState({}),[q,W]=a.useState({}),[D,_]=a.useState(0),[te,j]=a.useState(0),[N,J]=a.useState(!1),[le,ne]=a.useState(!0),[he,Q]=a.useState(!1),[Z,we]=a.useState(""),V=a.useMemo(()=>{const g=Z.trim().toLowerCase();return g?P.filter(R=>R.name.toLowerCase().includes(g)):P},[P,Z]);a.useEffect(()=>{l&&(x!=null&&x.uid)&&(We(),le||Ie())},[l,x==null?void 0:x.uid,le]);const se=async()=>{if(x!=null&&x.uid)try{const g=p==null?void 0:p.shopId;let R;if(g){const xe=ra(ps(ut,"products"),Pt("shopId","==",g),Pt("userId","==",x.uid));R=await na(xe)}else{const xe=ra(ps(ut,"products"),Pt("userId","==",x.uid));R=await na(xe)}const re=R.docs.map(xe=>({id:xe.id,name:String(xe.data().name??""),sellingPrice:Number(xe.data().sellingPrice??0),wholesalePrice:Number(xe.data().wholesalePrice??0),quantity:Number(xe.data().quantity??0)}));k(re)}catch(g){console.error("Error loading shop products:",g)}};a.useEffect(()=>{l&&(x!=null&&x.uid)&&(se(),Ie())},[l,x==null?void 0:x.uid,p==null?void 0:p.shopId]);const We=()=>{if(!(x!=null&&x.uid)){console.log("No user authenticated, cannot load sales data");return}const g=new Date().toISOString().split("T")[0],R=localStorage.getItem(`salesData_${x.uid}_${g}`);m(R?JSON.parse(R):[])},ze=g=>{if(!(x!=null&&x.uid)){console.log("No user authenticated, cannot save sales data");return}const R=new Date().toISOString().split("T")[0];localStorage.setItem(`salesData_${x.uid}_${R}`,JSON.stringify(g)),m(g)},Ie=async()=>{if(x!=null&&x.uid)try{const g=new Date,R=new Date(g.getFullYear(),g.getMonth(),1),re=new Date(g.getFullYear(),g.getMonth()+1,0),xe=pt=>pt.toISOString().split("T")[0],De=xe(R),Le=xe(re),$e=ra(ps(ut,"dailySales"),Pt("userId","==",x.uid),Pt("date",">=",De),Pt("date","<=",Le)),gt=await na($e);let Wt=0,wt=0;gt.forEach(pt=>{const I=pt.data(),X=Number(I.sellingPrice??0),fe=Number(I.quantity??0),ke=Number(I.profit??(Number(I.sellingPrice??0)-Number(I.wholesalePrice??0))*fe);Wt+=X*fe,wt+=ke}),_(Wt),j(wt)}catch(g){console.error("Error loading monthly stats:",g)}},Te=async g=>{if(x!=null&&x.uid)try{const R=((g.price??0)-(g.wholesalePrice??0))*(g.quantity??0);await sl(ps(ut,"dailySales"),{userId:x.uid,productName:g.productName,quantity:g.quantity,wholesalePrice:g.wholesalePrice??null,sellingPrice:g.price,profit:R,date:g.date,time:g.time,createdAt:ea()})}catch(R){console.error("Error saving sale:",R)}},st=async g=>{const R=E[g.id]||"",re=parseInt(R);if(isNaN(re)||re<=0){u({title:"كمية غير صالحة",description:"أدخل كمية صحيحة للبيـع",variant:"destructive"});return}if(re>g.quantity){u({title:"كمية أكبر من المتاح",description:"الكمية المطلوب بيعها تتجاوز المخزون المتاح",variant:"destructive"});return}const xe=new Date,De={id:Date.now().toString(),productName:g.name,price:g.sellingPrice,wholesalePrice:g.wholesalePrice,quantity:re,date:xe.toISOString().split("T")[0],time:xe.toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit"})};try{ze([...t,De]),await Te(De);const Le=g.quantity-re;await la(Ht(ut,"products",g.id),{quantity:Le,updatedAt:ea()}),k($e=>$e.map(gt=>gt.id===g.id?{...gt,quantity:Le}:gt)),K($e=>({...$e,[g.id]:""})),u({title:"تم البيع",description:`تم بيع ${re} قطعة من ${g.name}`})}catch(Le){console.error("Error selling product:",Le),u({title:"فشل البيع",description:"تعذّر تنفيذ عملية البيع",variant:"destructive"})}},Je=async g=>{const R=q[g.id]||"",re=parseInt(R);if(isNaN(re)||re<=0){u({title:"كمية غير صالحة",description:"أدخل كمية صحيحة للإضافة",variant:"destructive"});return}try{const xe=g.quantity+re;await la(Ht(ut,"products",g.id),{quantity:xe,updatedAt:ea()}),k(De=>De.map(Le=>Le.id===g.id?{...Le,quantity:xe}:Le)),W(De=>({...De,[g.id]:""})),u({title:"تمت الإضافة",description:`تمت إضافة ${re} قطعة إلى ${g.name}`})}catch(xe){console.error("Error adding pieces:",xe),u({title:"فشل الإضافة",description:"تعذّر إضافة الكمية إلى المخزون",variant:"destructive"})}},Ot=async g=>{if(!(!(x!=null&&x.uid)||!window.confirm(`هل تريد حذف المنتج "${g.name}"؟`)))try{await wo(Ht(ut,"products",g.id)),k(re=>re.filter(xe=>xe.id!==g.id)),u({title:"تم الحذف",description:`تم حذف المنتج ${g.name}`})}catch(re){console.error("Error deleting product:",re),u({title:"فشل الحذف",description:"تعذّر حذف المنتج",variant:"destructive"})}},jt=async()=>{try{if(!(x!=null&&x.uid)){u({title:"خطأ",description:"غير مسجّل دخول",variant:"destructive"});return}const g=f.productName.trim(),R=parseFloat(f.price),re=parseFloat(f.wholesalePrice||"0"),xe=parseInt(f.quantity);if(!g||isNaN(R)||isNaN(xe)){u({title:"بيانات غير مكتملة",description:"أدخل اسم المنتج والسعر والكمية",variant:"destructive"});return}const De={name:g,sellingPrice:R,wholesalePrice:isNaN(re)?0:re,quantity:isNaN(xe)?0:xe,userId:x.uid,createdAt:ea(),updatedAt:ea()};p!=null&&p.shopId&&(De.shopId=p.shopId);const Le=await sl(ps(ut,"products"),De);k($e=>[{id:Le.id,name:g,sellingPrice:R,wholesalePrice:isNaN(re)?0:re,quantity:isNaN(xe)?0:xe},...$e]),h({productName:"",price:"",wholesalePrice:"",quantity:""}),u({title:"تمت الإضافة",description:`تم إضافة المنتج ${g} بنجاح`})}catch(g){console.error("createProduct error",g),u({title:"فشل الإضافة",description:"تعذّر إضافة المنتج. حاول مجددًا",variant:"destructive"})}};return e.jsxs(ie,{open:l,onOpenChange:d,children:[e.jsxs(oe,{className:"max-w-7xl md:max-w-6xl lg:max-w-7xl w-[95vw] md:w-[90vw] h-[95vh] md:h-[90vh] p-0 overflow-y-auto",children:[e.jsx(ce,{className:"px-3 md:px-6 py-3 md:py-4 border-b bg-gradient-to-r from-blue-50 to-purple-50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 md:gap-3",children:[e.jsx("div",{className:"p-1.5 md:p-2 bg-blue-100 rounded-lg",children:e.jsx(Gr,{className:"h-5 w-5 md:h-6 md:w-6 text-blue-600"})}),e.jsxs("div",{children:[e.jsx(de,{className:"text-lg md:text-xl font-bold text-gray-800",children:"📊 بيانات المبيعات اليومية"}),e.jsxs("p",{className:"text-xs md:text-sm text-gray-600 mt-1 hidden sm:block",children:["إدارة وتتبع مبيعات اليوم - ",new Date().toLocaleDateString("ar-EG")]})]})]}),e.jsx("div",{className:"flex items-center gap-1 md:gap-2",children:e.jsx(o,{variant:"ghost",size:"sm",onClick:d,className:"h-8 w-8 md:h-9 md:w-9",children:e.jsx(ul,{className:"h-4 w-4"})})})]})}),e.jsxs("div",{className:"flex flex-col md:flex-row h-full",dir:"rtl",children:[e.jsxs("div",{className:"w-full md:w-80 lg:w-96 bg-white/50 border-r",children:[e.jsxs("div",{className:"p-3 md:p-4 border-b bg-white/30",children:[e.jsxs("h3",{className:"font-semibold text-gray-800 mb-3 flex items-center gap-2 text-sm md:text-base",children:[e.jsx(Ze,{className:"h-4 w-4 text-green-600"}),"ملخص المبيعات"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 md:gap-3",children:[e.jsxs("div",{className:"bg-blue-50 p-2 md:p-3 rounded-lg text-center",children:[e.jsx("div",{className:"text-lg md:text-xl font-bold text-blue-600",children:ht(t.reduce((g,R)=>g+R.price*R.quantity,0))}),e.jsx("div",{className:"text-xs md:text-sm text-blue-600",children:"إجمالي المبيعات"})]}),e.jsxs("div",{className:"bg-green-50 p-2 md:p-3 rounded-lg text-center",children:[e.jsx("div",{className:"text-lg md:text-xl font-bold text-green-600",children:ht(t.reduce((g,R)=>g+(R.price-(R.wholesalePrice??0))*R.quantity,0))}),e.jsx("div",{className:"text-xs md:text-sm text-green-600",children:"إجمالي الأرباح"})]}),e.jsxs("div",{className:"bg-yellow-50 p-2 md:p-3 rounded-lg text-center",children:[e.jsx("div",{className:"text-lg md:text-xl font-bold text-yellow-600",children:As(P.length)}),e.jsx("div",{className:"text-xs md:text-sm text-yellow-600",children:"عدد المنتجات"})]}),e.jsxs("div",{className:"bg-purple-50 p-2 md:p-3 rounded-lg text-center",children:[e.jsx("div",{className:"text-lg md:text-xl font-bold text-purple-600",children:As(t.length)}),e.jsx("div",{className:"text-xs md:text-sm text-purple-600",children:"عدد المبيعات"})]})]}),e.jsxs("div",{className:"relative mb-2",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-1 md:gap-2 text-xs md:text-sm font-semibold text-indigo-700",children:[e.jsx(is,{className:"h-3 w-3 md:h-4 md:w-4"}),e.jsx(Gr,{className:"h-3 w-3 md:h-4 md:w-4"}),e.jsx("span",{children:"تقارير الشهر"})]}),e.jsx(o,{size:"sm",variant:"ghost",onClick:()=>Q(g=>!g),className:"h-6 w-6 p-0 rounded-full",title:he?"إظهار التقارير":"إخفاء التقارير",children:he?e.jsx(tn,{className:"h-4 w-4"}):e.jsx(vl,{className:"h-4 w-4"})})]}),e.jsx("div",{className:he?"overflow-hidden max-h-0 transition-[max-height] duration-300":"overflow-hidden transition-[max-height] duration-300 max-h-[400px]",children:e.jsxs("div",{className:le?"grid grid-cols-2 gap-2 md:gap-4 filter blur-sm pointer-events-none":"grid grid-cols-2 gap-2 md:gap-4",children:[e.jsxs("div",{className:"bg-indigo-50 p-2 md:p-3 rounded-lg text-center",children:[e.jsx("div",{className:"text-lg md:text-xl font-bold text-indigo-600",children:ht(D)}),e.jsx("div",{className:"text-xs md:text-sm text-indigo-600",children:"مبيعات الشهر"})]}),e.jsxs("div",{className:"bg-pink-50 p-2 md:p-3 rounded-lg text-center",children:[e.jsx("div",{className:"text-lg md:text-xl font-bold text-pink-600",children:ht(te)}),e.jsx("div",{className:"text-xs md:text-sm text-pink-600",children:"أرباح الشهر"})]})]})}),!he&&le&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center rounded-lg bg-yellow-100/60",children:e.jsxs(o,{size:"sm",variant:"ghost",onClick:async()=>{try{if(await isZeroPlan()){u({title:"الخطة زيرو",description:"التقارير الشهرية غير متاحة في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}catch{}J(!0)},className:"flex items-center gap-2 bg-yellow-200/70 hover:bg-yellow-300 text-yellow-900 px-3 py-2 rounded-xl shadow-md hover:shadow-lg transition-all",title:"عرض تقارير الشهر",children:[e.jsx(Xe,{className:"h-5 w-5 md:h-7 md:w-7"}),e.jsx("span",{className:"text-xs md:text-sm",children:"عرض تقارير الشهر"})]})})]})]}),e.jsx("div",{className:"p-3 md:p-4 border-b bg-white/30",children:e.jsxs("h3",{className:"font-semibold text-gray-800 mb-3 flex items-center gap-2 text-sm md:text-base",children:[e.jsx(Ea,{className:"h-4 w-4 text-indigo-600"}),"إحصائيات المنتجات"]})}),e.jsx("div",{className:"p-3 md:p-4 flex-1 overflow-y-auto hidden md:block",children:e.jsxs("h3",{className:"font-semibold text-gray-800 mb-3 flex items-center gap-2",children:[e.jsx(Zr,{className:"h-4 w-4 text-blue-600"}),"نصائح للمبيعات"]})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto transition-all duration-300 ease-in-out scrollbar-thin scrollbar-thumb-blue-300 scrollbar-track-blue-100 hover:scrollbar-thumb-blue-400",children:e.jsxs("div",{className:"p-3 md:p-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 md:mb-6 gap-2",children:[e.jsxs("h2",{className:"text-base md:text-lg font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(mc,{className:"h-4 w-4 md:h-5 md:w-5 text-blue-600"}),"سجل المبيعات (",t.length," عنصر)"]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs md:text-sm text-gray-600",children:[e.jsx(is,{className:"h-3 w-3 md:h-4 md:w-4"}),e.jsx("span",{className:"hidden sm:inline",children:new Date().toLocaleDateString("ar-EG")}),e.jsx(ys,{className:"h-3 w-3 md:h-4 md:w-4 ml-2"}),e.jsx("span",{children:new Date().toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit"})})]})]}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-3 md:p-4 mb-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("h3",{className:"text-sm md:text-base font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(xt,{className:"h-4 w-4 text-emerald-600"}),"إضافة منتج جديد"]}),e.jsxs(o,{size:"sm",variant:"ghost",className:"h-8",onClick:()=>M(g=>!g),children:[e.jsx(xt,{className:"h-4 w-4 text-emerald-600"}),"إضافة منتج"]})]}),C&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx(H,{htmlFor:"new-product-name",className:"text-xs md:text-sm",children:"اسم المنتج"}),e.jsx($,{id:"new-product-name",value:f.productName,onChange:g=>h(R=>({...R,productName:g.target.value})),placeholder:"أدخل اسم المنتج"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx(H,{htmlFor:"new-product-price",className:"text-xs md:text-sm",children:"سعر البيع (ج.م)"}),e.jsx($,{type:"number",id:"new-product-price",value:f.price,onChange:g=>h(R=>({...R,price:g.target.value})),placeholder:"0.00"})]}),e.jsxs("div",{children:[e.jsx(H,{htmlFor:"new-product-wholesale",className:"text-xs md:text-sm",children:"سعر الجملة (ج.م)"}),e.jsx($,{type:"number",id:"new-product-wholesale",value:f.wholesalePrice||"",onChange:g=>h(R=>({...R,wholesalePrice:g.target.value})),placeholder:"0.00"})]})]}),e.jsxs("div",{children:[e.jsx(H,{htmlFor:"new-product-qty",className:"text-xs md:text-sm",children:"الكمية"}),e.jsx($,{type:"number",id:"new-product-qty",value:f.quantity,onChange:g=>h(R=>({...R,quantity:g.target.value})),placeholder:"1"})]}),e.jsx(o,{className:"w-full md:w-auto",onClick:jt,children:"إضافة المنتج"})]})]}),e.jsx("div",{id:"shop-products-section",className:"bg-white rounded-lg border border-gray-200 overflow-hidden mb-4",children:e.jsxs("div",{className:"mb-4",children:[e.jsxs("h3",{className:"text-sm md:text-base font-semibold text-gray-800 mb-2 flex items-center gap-2",children:[e.jsx(Ea,{className:"h-4 w-4 text-green-600"}),"منتجات المحل"]}),e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx($,{value:Z,onChange:g=>we(g.target.value),placeholder:"ابحث عن منتج...",className:"h-9 w-full md:w-72 text-sm","aria-label":"البحث عن منتج من منتجات المحل"}),Z&&e.jsx(o,{variant:"ghost",size:"sm",className:"h-9",onClick:()=>we(""),children:"مسح"})]}),e.jsx("div",{className:"overflow-x-auto border border-gray-200 rounded-lg hidden md:block",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"المنتج"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"سعر البيع"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"سعر الجملة"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"المتاح"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"بيع"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:V.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"px-3 py-3 text-center text-gray-500",children:P.length===0?"لا توجد منتجات بعد، أضف منتجاً من النموذج أعلاه":"لا توجد نتائج مطابقة للبحث"})}):V.map(g=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-3 py-2 font-medium text-gray-900",children:g.name}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:ht(g.sellingPrice)}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:ht(g.wholesalePrice)}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:As(g.quantity)}),e.jsx("td",{className:"px-3 py-2",children:e.jsxs("div",{className:"flex items-center gap-2 flex-nowrap",children:[e.jsx($,{value:E[g.id]||"",onChange:R=>K(re=>({...re,[g.id]:R.target.value})),type:"number",placeholder:"عدد القطع للبيع",className:"h-8 w-28 text-sm"}),e.jsx(o,{size:"sm",className:"h-8",onClick:()=>st(g),children:"بيع"}),e.jsx($,{value:q[g.id]||"",onChange:R=>W(re=>({...re,[g.id]:R.target.value})),type:"number",placeholder:"عدد للإضافة",className:"h-8 w-28 text-sm"}),e.jsxs("div",{className:"inline-flex items-center gap-2 flex-nowrap",children:[e.jsx(o,{size:"sm",variant:"outline",className:"h-8",onClick:()=>Je(g),children:"إضافة قطع جديدة"}),e.jsx(o,{size:"sm",variant:"destructive",className:"h-8",onClick:()=>Ot(g),title:"حذف المنتج",children:e.jsx(It,{className:"h-4 w-4"})})]})]})})]},g.id))})]})}),e.jsx("div",{className:"block md:hidden space-y-3",children:V.length===0?e.jsx("div",{className:"text-center text-gray-500 text-sm",children:P.length===0?"لا توجد منتجات بعد، أضف منتجاً من النموذج أعلاه":"لا توجد نتائج مطابقة للبحث"}):V.map(g=>e.jsxs("div",{className:"bg-white rounded-xl p-3 border border-gray-200 shadow-sm",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"font-semibold text-gray-900 text-sm break-words",children:g.name}),e.jsx(o,{size:"sm",variant:"destructive",className:"h-8 min-w-[44px] touch-manipulation",onClick:()=>Ot(g),title:"حذف المنتج",children:e.jsx(It,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-2 text-xs text-gray-700",children:[e.jsx("div",{className:"text-gray-600",children:"سعر البيع"}),e.jsx("div",{className:"text-right font-medium",children:ht(g.sellingPrice)}),e.jsx("div",{className:"text-gray-600",children:"سعر الجملة"}),e.jsx("div",{className:"text-right font-medium",children:ht(g.wholesalePrice)}),e.jsx("div",{className:"text-gray-600",children:"المتاح"}),e.jsx("div",{className:"text-right font-medium",children:As(g.quantity)})]}),e.jsxs("div",{className:"mt-3 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx($,{value:E[g.id]||"",onChange:R=>K(re=>({...re,[g.id]:R.target.value})),type:"number",placeholder:"عدد القطع للبيع",className:"h-9 flex-1 text-sm","aria-label":`عدد القطع للبيع لـ ${g.name}`}),e.jsx(o,{size:"sm",className:"h-9 min-w-[64px]",onClick:()=>st(g),children:"بيع"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx($,{value:q[g.id]||"",onChange:R=>W(re=>({...re,[g.id]:R.target.value})),type:"number",placeholder:"عدد للإضافة",className:"h-9 flex-1 text-sm","aria-label":`عدد القطع للإضافة لـ ${g.name}`}),e.jsx(o,{size:"sm",variant:"outline",className:"h-9 min-w-[64px]",onClick:()=>Je(g),children:"إضافة"})]})]})]},g.id))})]})}),t.length===0?e.jsxs("div",{className:"text-center py-8 md:py-12",children:[e.jsx("div",{className:"w-16 h-16 md:w-24 md:h-24 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center",children:e.jsx(Ea,{className:"h-8 w-8 md:h-12 md:w-12 text-gray-400"})}),e.jsx("h3",{className:"text-base md:text-lg font-medium text-gray-900 mb-2",children:"لا توجد مبيعات اليوم"}),e.jsx("p",{className:"text-sm text-gray-500",children:"ابدأ ببيع منتج من القائمة أعلاه"})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"block md:hidden",children:e.jsx("div",{className:"max-h-[70vh] overflow-y-auto space-y-3 p-3",children:t.map(g=>e.jsxs("div",{className:"bg-white rounded-xl p-4 border border-gray-200 shadow-sm",children:[e.jsx("div",{className:"mb-3",children:e.jsx("h4",{className:"font-semibold text-gray-900 text-base break-words",children:g.productName})}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-2 text-sm text-gray-700",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ze,{className:"h-4 w-4 text-blue-600"}),e.jsx("span",{className:"text-gray-600",children:"سعر البيع"})]}),e.jsx("div",{className:"text-right font-medium",children:ht(g.price)}),typeof g.wholesalePrice=="number"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ze,{className:"h-4 w-4 text-indigo-600"}),e.jsx("span",{className:"text-gray-600",children:"سعر الجملة"})]}),e.jsx("div",{className:"text-right font-medium",children:ht(g.wholesalePrice)})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ea,{className:"h-4 w-4 text-emerald-600"}),e.jsx("span",{className:"text-gray-600",children:"الكمية"})]}),e.jsx("div",{className:"text-right font-medium",children:As(g.quantity)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ms,{className:"h-4 w-4 text-purple-600"}),e.jsx("span",{className:"text-gray-600",children:"الربح"})]}),e.jsx("div",{className:"text-right font-semibold text-purple-700",children:ht(((g.price??0)-(g.wholesalePrice??0))*(g.quantity??0))}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ze,{className:"h-4 w-4 text-green-600"}),e.jsx("span",{className:"text-gray-600",children:"الإجمالي"})]}),e.jsx("div",{className:"text-right font-bold text-green-700",children:ht(g.price*g.quantity)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(is,{className:"h-4 w-4 text-blue-600"}),e.jsx("span",{className:"text-gray-600",children:"التاريخ"})]}),e.jsx("div",{className:"text-right text-gray-600",children:ol(g.date)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ys,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"text-gray-600",children:"الوقت"})]}),e.jsx("div",{className:"text-right text-gray-600",children:g.time})]})]},g.id))})}),e.jsx("div",{className:"hidden md:block overflow-x-auto max-h-96 overflow-y-auto scrollbar-thin scrollbar-thumb-green-300 scrollbar-track-green-100 hover:scrollbar-thumb-green-400",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"المنتج"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"سعر البيع (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"سعر الجملة (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الكمية"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الإجمالي (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الربح (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"التاريخ"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الوقت"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:t.map((g,R)=>e.jsxs("tr",{className:R%2===0?"bg-white":"bg-gray-50/50",children:[e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-gray-900",children:g.productName}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:ht(g.price)}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:typeof g.wholesalePrice=="number"?ht(g.wholesalePrice):"-"}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:As(g.quantity)}),e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-green-600",children:ht(g.price*g.quantity)}),e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-purple-600",children:ht(((g.price??0)-(g.wholesalePrice??0))*(g.quantity??0))}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-500",children:ol(g.date)}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-500",children:g.time})]},g.id))})]})})]}),e.jsxs("div",{className:"mt-4 md:mt-6 text-xs text-gray-500 text-center bg-gray-50/50 p-2 md:p-3 rounded border border-gray-200/40 space-y-1",children:[e.jsx("p",{className:"font-medium text-gray-600",children:"💰 نظام إدارة المبيعات اليومية"}),e.jsxs("p",{className:"hidden sm:block",children:["• يتم حفظ البيانات تلقائياً لليوم الحالي: ",new Date().toLocaleDateString("ar-EG")]}),e.jsx("p",{children:"• يمكنك إضافة وتعديل وحذف المنتجات حسب الحاجة"}),e.jsx("p",{className:"hidden sm:block",children:"• يتم حفظ البيانات محلياً وعلى Firebase لتعزيز الأمان"})]})]})})]})]}),e.jsx(vs,{open:N,onOpenChange:J,mode:"verify",title:"قفل إحصائيات الشهر",description:"لا يمكن الاطلاع على تقارير الشهر إلا بإدخال الرقم السري الرئيسي",onSuccess:async()=>{try{const g=x==null?void 0:x.uid;if(g){const R=await en(g),re=(R==null?void 0:R.planType)??(R==null?void 0:R.plan)??null,xe=typeof re=="string"?re.toLowerCase():null;if(re===Gt.ZERO||xe==="zero"){u({title:"الخطة زيرو",description:"التقارير الشهرية غير متاحة في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}}catch{}ne(!1),J(!1),Ie()}})]})}const As=l=>new Intl.NumberFormat("ar-EG").format(Number(l||0)),ht=l=>`${new Intl.NumberFormat("ar-EG",{minimumFractionDigits:2,maximumFractionDigits:2}).format(Number(l||0))} ج.م`,ol=l=>{try{const d=new Date(l);return isNaN(d.getTime())?new Date(`${l}T00:00:00`).toLocaleDateString("ar-EG"):d.toLocaleDateString("ar-EG")}catch{return l}};function Il({size:l=24,className:d,...t}){return e.jsxs("svg",{width:l,height:l,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",className:d,...t,children:[e.jsx("rect",{x:"5",y:"2.5",width:"14",height:"19",rx:"2.5",stroke:"currentColor",strokeWidth:"1.5"}),e.jsx("rect",{x:"7",y:"4.5",width:"10",height:"5.5",rx:"1",stroke:"currentColor",strokeWidth:"1.2"}),e.jsx("path",{d:"M9.5 11.5h5",stroke:"currentColor",strokeWidth:"1.4",strokeLinecap:"round"}),e.jsx("circle",{cx:"8.5",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"12",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"15.5",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"8.5",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"12",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"15.5",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("rect",{x:"8",y:"19",width:"9",height:"1.8",rx:"0.6",stroke:"currentColor",strokeWidth:"1"})]})}var Tl="AlertDialog",[Tc,em]=So(Tl,[yl]),ts=yl(),kl=l=>{const{__scopeAlertDialog:d,...t}=l,m=ts(d);return e.jsx(Jo,{...m,...t,modal:!0})};kl.displayName=Tl;var kc="AlertDialogTrigger",Ac=a.forwardRef((l,d)=>{const{__scopeAlertDialog:t,...m}=l,f=ts(t);return e.jsx(Lo,{...f,...m,ref:d})});Ac.displayName=kc;var Pc="AlertDialogPortal",Al=l=>{const{__scopeAlertDialog:d,...t}=l,m=ts(d);return e.jsx(Ko,{...m,...t})};Al.displayName=Pc;var Oc="AlertDialogOverlay",Pl=a.forwardRef((l,d)=>{const{__scopeAlertDialog:t,...m}=l,f=ts(t);return e.jsx($o,{...f,...m,ref:d})});Pl.displayName=Oc;var $s="AlertDialogContent",[Wc,Fc]=Tc($s),Bc=Co("AlertDialogContent"),Ol=a.forwardRef((l,d)=>{const{__scopeAlertDialog:t,children:m,...f}=l,h=ts(t),C=a.useRef(null),M=gl(d,C),u=a.useRef(null);return e.jsx(Ro,{contentName:$s,titleName:Wl,docsSlug:"alert-dialog",children:e.jsx(Wc,{scope:t,cancelRef:u,children:e.jsxs(Uo,{role:"alertdialog",...h,...f,ref:M,onOpenAutoFocus:Do(f.onOpenAutoFocus,x=>{var p;x.preventDefault(),(p=u.current)==null||p.focus({preventScroll:!0})}),onPointerDownOutside:x=>x.preventDefault(),onInteractOutside:x=>x.preventDefault(),children:[e.jsx(Bc,{children:m}),e.jsx(Mc,{contentRef:C})]})})})});Ol.displayName=$s;var Wl="AlertDialogTitle",Fl=a.forwardRef((l,d)=>{const{__scopeAlertDialog:t,...m}=l,f=ts(t);return e.jsx(_o,{...f,...m,ref:d})});Fl.displayName=Wl;var Bl="AlertDialogDescription",El=a.forwardRef((l,d)=>{const{__scopeAlertDialog:t,...m}=l,f=ts(t);return e.jsx(zo,{...f,...m,ref:d})});El.displayName=Bl;var Ec="AlertDialogAction",Ml=a.forwardRef((l,d)=>{const{__scopeAlertDialog:t,...m}=l,f=ts(t);return e.jsx(jl,{...f,...m,ref:d})});Ml.displayName=Ec;var Ll="AlertDialogCancel",$l=a.forwardRef((l,d)=>{const{__scopeAlertDialog:t,...m}=l,{cancelRef:f}=Fc(Ll,t),h=ts(t),C=gl(d,f);return e.jsx(jl,{...h,...m,ref:C})});$l.displayName=Ll;var Mc=({contentRef:l})=>{const d=`\`${$s}\` requires a description for the component to be accessible for screen reader users.

You can add a description to the \`${$s}\` by passing a \`${Bl}\` component as a child, which also benefits sighted users by adding visible context to the dialog.

Alternatively, you can use your own component as a description by assigning it an \`id\` and passing the same value to the \`aria-describedby\` prop in \`${$s}\`. If the description is confusing or duplicative for sighted users, you can use the \`@radix-ui/react-visually-hidden\` primitive as a wrapper around your description component.

For more information, see https://radix-ui.com/primitives/docs/components/alert-dialog`;return a.useEffect(()=>{var m;document.getElementById((m=l.current)==null?void 0:m.getAttribute("aria-describedby"))||console.warn(d)},[d,l]),null},Lc=kl,$c=Al,Rl=Pl,Ul=Ol,_l=Ml,zl=$l,Jl=Fl,Kl=El;const Rc=Lc,Uc=$c,Vl=a.forwardRef(({className:l,...d},t)=>e.jsx(Rl,{className:bs("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",l),...d,ref:t}));Vl.displayName=Rl.displayName;const ql=a.forwardRef(({className:l,...d},t)=>e.jsxs(Uc,{children:[e.jsx(Vl,{}),e.jsx(Ul,{ref:t,className:bs("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",l),...d})]}));ql.displayName=Ul.displayName;const Yl=({className:l,...d})=>e.jsx("div",{className:bs("flex flex-col space-y-2 text-center sm:text-left",l),...d});Yl.displayName="AlertDialogHeader";const Hl=a.forwardRef(({className:l,...d},t)=>e.jsx(Jl,{ref:t,className:bs("text-lg font-semibold",l),...d}));Hl.displayName=Jl.displayName;const Gl=a.forwardRef(({className:l,...d},t)=>e.jsx(Kl,{ref:t,className:bs("text-sm text-muted-foreground",l),...d}));Gl.displayName=Kl.displayName;const Xr=a.forwardRef(({className:l,...d},t)=>e.jsx(_l,{ref:t,className:bs(fl(),l),...d}));Xr.displayName=_l.displayName;const Ql=a.forwardRef(({className:l,...d},t)=>e.jsx(zl,{ref:t,className:bs(fl({variant:"outline"}),"mt-2 sm:mt-0",l),...d}));Ql.displayName=zl.displayName;const Oe=l=>{try{return l.toLocaleString("en-US",{maximumFractionDigits:2})}catch{return String(l)}},cl=l=>{try{return(l?new Date(l):new Date).toLocaleString("en-GB",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}catch{return new Date().toISOString()}},Ma="machine_daily_opening_values",dl="machine_daily_receipts",ml="machine_daily_transfer_receipts",Yr="machine_daily_opening_snapshot";function _c({open:l,onOpenChange:d}){const{toast:t}=zt(),{shiftUser:m}=Ka(),[f,h]=a.useState(""),[C,M]=a.useState(""),[u,x]=a.useState(""),[p,P]=a.useState(null),[k,E]=a.useState(null),[K,q]=a.useState(null),[W,D]=a.useState(null),[_,te]=a.useState(!1),[j,N]=a.useState(!1),[J,le]=a.useState(""),[ne,he]=a.useState(""),[Q,Z]=a.useState(null),[we,V]=a.useState(()=>{try{const B=localStorage.getItem(dl),ee=B?JSON.parse(B):[];return Array.isArray(ee)?ee:[]}catch{return[]}}),[se,We]=a.useState(()=>{try{const B=localStorage.getItem(ml),ee=B?JSON.parse(B):[];return Array.isArray(ee)?ee:[]}catch{return[]}}),[ze,Ie]=a.useState(!1),[Te,st]=a.useState(""),[Je,Ot]=a.useState(""),[jt,g]=a.useState(!1),[R,re]=a.useState(null);a.useEffect(()=>{if(l)try{const B=localStorage.getItem(Ma);if(B){const z=JSON.parse(B);typeof(z==null?void 0:z.openingBase)=="number"&&P(z.openingBase),typeof(z==null?void 0:z.openingAir)=="number"&&E(z.openingAir),typeof(z==null?void 0:z.drawerCash)=="number"&&q(z.drawerCash)}const ee=localStorage.getItem(Yr);if(ee){const z=JSON.parse(ee);typeof(z==null?void 0:z.openingBase)=="number"&&typeof(z==null?void 0:z.openingAir)=="number"&&D({openingBase:z.openingBase,openingAir:z.openingAir,drawerCash:z.drawerCash||0})}}catch{}},[l]),a.useEffect(()=>{try{localStorage.setItem(dl,JSON.stringify(we))}catch{}},[we]),a.useEffect(()=>{try{localStorage.setItem(ml,JSON.stringify(se))}catch{}},[se]);const xe=a.useMemo(()=>(m==null?void 0:m.displayName)||(m==null?void 0:m.name)||(m==null?void 0:m.username)||void 0,[m]),De=a.useMemo(()=>se.reduce((B,ee)=>B+(ee.profit||0),0),[se]),Le=a.useMemo(()=>se.reduce((B,ee)=>B+(ee.wholesalePrice||0),0),[se]),$e=()=>{se.length!==0&&(We([]),t({title:"تم حذف الإيصالات",description:"تم مسح كل إيصالات التحويل."}))},gt=()=>{we.length!==0&&(V([]),t({title:"تم حذف الإيصالات",description:"تم مسح كل إيصالات الماكينة."}))},Wt=B=>{V(ee=>ee.filter(z=>z.id!==B)),t({title:"تم حذف الإيصال",description:"تم إزالة إيصال الماكينة المحدد."})},wt=()=>{P(null),E(null),q(null),D(null),h(""),M(""),x("");try{localStorage.removeItem(Ma),localStorage.removeItem(Yr)}catch{}t({title:"تم التصفير",description:"يمكنك الآن إدخال رصيد افتتاحي جديد."})},pt=()=>{const B=parseFloat(f||"0"),ee=parseFloat(C||"0"),z=parseFloat(u||"0");if(isNaN(B)||isNaN(ee)||isNaN(z)){t({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة للرصيد الافتتاحي وفلوس الدرج.",variant:"destructive"});return}if(B<0||ee<0||z<0){t({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}P(B),E(ee),q(z);try{localStorage.setItem(Ma,JSON.stringify({openingBase:B,openingAir:ee,drawerCash:z})),localStorage.setItem(Yr,JSON.stringify({openingBase:B,openingAir:ee,drawerCash:z})),D({openingBase:B,openingAir:ee,drawerCash:z})}catch{}t({title:"تم تسجيل البيانات",description:`الافتتاحي الأساسي: ${Oe(B)}، الهواء: ${Oe(ee)}، فلوس الدرج: ${Oe(z)}`})},I=()=>{if(p==null||k==null){t({title:"سجل الرصيد الافتتاحي أولاً",description:'يرجى الضغط على زر "إضافة" بعد إدخال الافتتاحي.'});return}N(!0)},X=()=>{const B=parseFloat(J||"0"),ee=parseFloat(ne||"0");if(isNaN(B)||isNaN(ee)){t({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة لرصيد التسليم.",variant:"destructive"});return}if(B<0||ee<0){t({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}const z=(W==null?void 0:W.openingBase)??(p||0),pe=(W==null?void 0:W.openingAir)??(k||0),Pe=z+pe,lt=B+ee-Pe;Z(lt);const He={id:`${Date.now()}`,openingBase:z,openingAir:pe,deliveryBase:B,deliveryAir:ee,netResult:lt,createdAt:new Date().toISOString(),cashierName:xe,requiredDrawerNoProfit:lt<0?Math.round(-lt*100)/100:0};V(ft=>[He,...ft]),t({title:"تم إنشاء إيصال تسليم",description:`الناتج النهائي: ${Oe(lt)}`})},fe=()=>{const B=parseFloat(Te||"0"),ee=parseFloat(Je||"0");if(!Number.isFinite(B)||!Number.isFinite(ee)){t({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة لسعر الجملة وسعر التجزئة.",variant:"destructive"});return}if(B<0||ee<0){t({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}if(p==null||k==null){t({title:"سجل الرصيد الافتتاحي أولاً",description:'يرجى إدخال الرصيد الأساسي ورصيد الهواء ثم الضغط "إضافة".'});return}const z=Math.round((ee-B)*100)/100;re({wholesalePrice:B,retailPrice:ee,profit:z}),g(!0)},ke=B=>{if(!R)return;const ee={id:`transfer_${Date.now()}`,wholesalePrice:R.wholesalePrice,retailPrice:R.retailPrice,profit:R.profit,createdAt:new Date().toISOString(),cashierName:xe,deductFrom:B},z=R.wholesalePrice,pe=p??0,Pe=k??0,nt=K??0;if(z>(B==="base"?pe:Pe)){t({title:"رصيد غير كافٍ",description:"لا يوجد رصيد كافٍ للخصم بسعر الجملة.",variant:"destructive"});return}const He=B==="base"?Math.round((pe-z)*100)/100:pe,ft=B==="air"?Math.round((Pe-z)*100)/100:Pe,Jt=Math.round((nt+R.retailPrice)*100)/100;P(He),E(ft),q(Jt);try{localStorage.setItem(Ma,JSON.stringify({openingBase:He,openingAir:ft,drawerCash:Jt}))}catch{}We(kt=>[ee,...kt]),Ie(!1),st(""),Ot(""),re(null),g(!1),t({title:"تم تسجيل تحويل",description:`الربح الفوري: ${Oe(ee.profit)} | خصم المخزون: -${Oe(z)} (${B==="base"?"الأساسي":"الهواء"}) | درج: +${Oe(R.retailPrice)}`})},Ae=()=>{h(""),M(""),N(!1),le(""),he(""),Z(null)},Ke=B=>{B||Ae(),d(B)};return e.jsxs(ie,{open:l,onOpenChange:Ke,children:[e.jsxs(oe,{className:"w-[92vw] sm:w-auto sm:max-w-2xl max-h-[85vh] overflow-y-auto",children:[e.jsxs(ce,{className:"space-y-2",children:[e.jsx(de,{className:"flex items-center justify-between text-right",children:e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(Il,{className:"h-5 w-5 text-yellow-500"}),"يومية المكنة"]})}),e.jsx(Rt,{className:"text-right",children:'أدخل الرصيد الافتتاحي، ثم في نهاية اليوم قم بإدخال رصيد التسليم لإنشاء إيصال منظم باسم "إيصالات ماكينة".'})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-6",children:[e.jsxs(_e,{children:[e.jsx(ct,{className:"pb-2",children:e.jsxs(Nt,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-right",children:"الرصيد الافتتاحي"}),e.jsx(o,{variant:"ghost",size:"sm",onClick:()=>te(B=>!B),className:"flex items-center gap-1",children:e.jsx(tn,{className:`h-4 w-4 transition-transform ${_?"rotate-180":""}`})})]})}),e.jsxs("div",{className:"flex items-center justify-between px-6",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(o,{variant:"outline",onClick:()=>Ie(!0),disabled:p==null||k==null,className:"border-violet-300 text-violet-700",children:"تحويل"})}),p!=null&&k!=null&&e.jsxs(rt,{className:"bg-violet-100 text-violet-700 border border-violet-200",children:["تم التسجيل: أساسي ",Oe(p)," | هواء ",Oe(k)," | درج ",Oe(K??0)]})]}),e.jsxs(Ye,{className:`space-y-4 ${_?"":"hidden"}`,children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الرصيد الأساسي"}),e.jsx($,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:f,onChange:B=>h(B.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"رصيد الهواء"}),e.jsx($,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:C,onChange:B=>M(B.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"فلوس الدرج"}),e.jsx($,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:u,onChange:B=>x(B.target.value),placeholder:"0.00",className:"text-right"})]})]}),e.jsxs("div",{className:"flex items-center justify-end",children:[e.jsx(o,{variant:"outline",className:"mr-2",onClick:wt,children:"تصفير"}),e.jsx(o,{onClick:pt,className:"bg-violet-600 hover:bg-violet-700",children:"إضافة"})]})]})]}),e.jsxs(_e,{children:[e.jsx(ct,{className:"pb-2",children:e.jsxs(Nt,{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-right",children:"إيصالات تحويل"}),e.jsxs(rt,{className:"bg-green-100 text-green-700 border border-green-200",children:["ربح: ",Oe(De)]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(o,{variant:"outline",size:"sm",onClick:$e,className:"border-red-300 text-red-700 hover:bg-red-50",children:"حذف الإيصالات"}),e.jsx($a,{className:"h-4 w-4 text-gray-500"})]})]})}),e.jsx(Ye,{className:"space-y-3",children:se.length===0?e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد تحويلات مسجلة."}):e.jsx("div",{className:"space-y-3 max-h-52 overflow-y-auto pr-1",children:se.map(B=>e.jsxs("div",{className:"rounded-lg border p-3 grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"سعر الجملة"}),e.jsx("p",{className:"text-sm",children:Oe(B.wholesalePrice)})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"سعر التجزئة"}),e.jsx("p",{className:"text-sm",children:Oe(B.retailPrice)})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"الربح الفوري"}),e.jsx("p",{className:"text-sm text-green-700",children:Oe(B.profit)}),B.deductFrom&&e.jsx("div",{className:"mt-1",children:e.jsxs("span",{className:"text-[11px] bg-violet-100 text-violet-700 border border-violet-200 rounded px-2 py-0.5",children:["الخصم من: ",B.deductFrom==="base"?"الأساسي":"الهواء"]})}),e.jsxs("div",{className:"flex items-center justify-end gap-2 text-xs text-gray-500",children:[e.jsx(is,{className:"h-3 w-3"}),e.jsx("span",{children:cl(B.createdAt)}),B.cashierName&&e.jsxs(e.Fragment,{children:[e.jsx(Hr,{orientation:"vertical",className:"h-3"}),e.jsxs("span",{children:["الكاشير: ",B.cashierName]})]})]})]})]},B.id))})})]}),e.jsxs(_e,{children:[e.jsx(ct,{className:"pb-2",children:e.jsx(Nt,{className:"text-right",children:"نهاية اليوم"})}),e.jsx(Ye,{className:"space-y-4",children:j?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الرصيد الأساسي الحالي"}),e.jsx($,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:J,onChange:B=>le(B.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"رصيد الهواء الحالي"}),e.jsx($,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:ne,onChange:B=>he(B.target.value),placeholder:"0.00",className:"text-right"})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(o,{variant:"secondary",onClick:()=>N(!1),children:"إلغاء"}),e.jsx(o,{onClick:X,className:"bg-green-600 hover:bg-green-700",children:"تسليم"})]}),Q!=null&&e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{className:"text-right",children:e.jsxs(rt,{className:Q>=0?"bg-green-100 text-green-700 border border-green-200":"bg-red-100 text-red-700 border border-red-200",children:["الناتج النهائي: ",Oe(Q)]})}),e.jsxs("div",{className:"mt-2 flex items-center justify-end gap-2",children:[e.jsxs(rt,{className:"bg-blue-100 text-blue-700 border border-blue-200",children:["المجموع النهائي: ",Oe(parseFloat(J||"0")+parseFloat(ne||"0"))]}),e.jsxs(rt,{className:"bg-amber-100 text-amber-700 border border-amber-200",children:["مطلوب من الدرج (بدون أرباح): ",Oe(Le)]})]})]})]}):e.jsx("div",{className:"flex justify-end",children:e.jsx(o,{variant:"outline",onClick:I,className:"border-violet-300 text-violet-700",children:"تسليم يومية"})})})]}),e.jsxs(_e,{children:[e.jsx(ct,{className:"pb-2",children:e.jsxs(Nt,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-right",children:"إيصالات ماكينة"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(o,{variant:"outline",size:"sm",onClick:gt,className:"border-red-300 text-red-700 hover:bg-red-50",children:"حذف الإيصالات"}),e.jsx($a,{className:"h-4 w-4 text-gray-500"})]})]})}),e.jsx(Ye,{className:"space-y-3",children:we.length===0?e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد إيصالات حتى الآن."}):e.jsx("div",{className:"space-y-3",children:we.map(B=>e.jsxs("div",{className:"rounded-lg border p-3 grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"الافتتاحي"}),e.jsxs("p",{className:"text-sm",children:["أساسي: ",Oe(B.openingBase)]}),e.jsxs("p",{className:"text-sm",children:["هواء: ",Oe(B.openingAir)]})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"التسليم"}),e.jsxs("p",{className:"text-sm",children:["أساسي: ",Oe(B.deliveryBase)]}),e.jsxs("p",{className:"text-sm",children:["هواء: ",Oe(B.deliveryAir)]})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("div",{className:"flex items-center justify-end",children:e.jsxs(o,{variant:"outline",size:"sm",onClick:()=>Wt(B.id),className:"border-red-300 text-red-700 hover:bg-red-50",children:[e.jsx(It,{className:"h-3 w-3 mr-1"})," حذف"]})}),e.jsx("p",{className:"text-xs text-gray-500",children:"النتيجة"}),e.jsx("p",{className:`text-sm ${B.netResult>=0?"text-green-700":"text-red-700"}`,children:Oe(B.netResult)}),e.jsxs("div",{className:"mt-1 flex items-center justify-end gap-2",children:[e.jsxs("span",{className:"text-[11px] bg-blue-100 text-blue-700 border border-blue-200 rounded px-2 py-0.5",children:["المجموع النهائي: ",Oe(B.deliveryBase+B.deliveryAir)]}),typeof B.requiredDrawerNoProfit=="number"&&e.jsxs("span",{className:"text-[11px] bg-amber-100 text-amber-700 border border-amber-200 rounded px-2 py-0.5",children:["مطلوب من الدرج (بدون أرباح): ",Oe(B.requiredDrawerNoProfit||0)]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2 text-xs text-gray-500",children:[e.jsx(is,{className:"h-3 w-3"}),e.jsx("span",{children:cl(B.createdAt)}),B.cashierName&&e.jsxs(e.Fragment,{children:[e.jsx(Hr,{orientation:"vertical",className:"h-3"}),e.jsxs("span",{children:["الكاشير: ",B.cashierName]})]})]})]})]},B.id))})})]})]}),e.jsxs(Ne,{className:"flex items-center justify-between",children:[e.jsx(o,{variant:"outline",onClick:()=>Ke(!1),children:"إغلاق"}),e.jsxs("div",{className:"text-xs text-gray-500 flex items-center gap-1",children:[e.jsx(ys,{className:"h-3 w-3"}),e.jsx("span",{children:"يسجل التاريخ والوقت تلقائياً لكل إيصال"})]})]})]}),e.jsx(ie,{open:ze,onOpenChange:Ie,children:e.jsxs(oe,{className:"sm:max-w-sm",children:[e.jsx(ce,{children:e.jsx(de,{children:"تحويل رصيد"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"سعر الجملة"}),e.jsx($,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:Te,onChange:B=>st(B.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"سعر التجزئة"}),e.jsx($,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:Je,onChange:B=>Ot(B.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsx("div",{className:"text-right",children:e.jsxs(rt,{className:"bg-green-100 text-green-700 border border-green-200",children:["الربح الفوري: ",Oe(parseFloat(Je||"0")-parseFloat(Te||"0")||0)]})})]}),e.jsxs(Ne,{className:"flex items-center justify-end gap-2",children:[e.jsx(o,{variant:"secondary",onClick:()=>Ie(!1),children:"إلغاء"}),e.jsx(o,{onClick:fe,className:"bg-violet-600 hover:bg-violet-700",children:"تحويل"})]})]})}),e.jsx(Rc,{open:jt,onOpenChange:g,children:e.jsxs(ql,{children:[e.jsxs(Yl,{children:[e.jsx(Hl,{children:"اختيار مصدر الخصم"}),e.jsx(Gl,{children:"هل يتم الخصم من الرصيد الأساسي أم من رصيد الهواء؟"})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2 mt-4",children:[e.jsx(Ql,{onClick:()=>g(!1),children:"رجوع"}),e.jsx(Xr,{onClick:()=>ke("base"),children:"خصم من الأساسي"}),e.jsx(Xr,{onClick:()=>ke("air"),children:"خصم من الهواء"})]})]})})]})}function zc(l,d=300){const[t,m]=ot.useState(l);return ot.useEffect(()=>{const f=setTimeout(()=>m(l),d);return()=>clearTimeout(f)},[l,d]),t}const Jc=({userId:l,transactions:d})=>{const[t,m]=a.useState(!1),[f,h]=a.useState(!1),[C,M]=a.useState(!1),[u,x]=a.useState({monthlyWithdrawalProfit:0,monthlyTransferProfit:0,lastUpdated:new Date}),{userSubscription:p}=es();a.useEffect(()=>{l&&t&&C&&P()},[l,t,C]);const P=async()=>{if(l)try{const W=Ls.getWithdrawTransferProfits(l);x({monthlyWithdrawalProfit:W.monthlyWithdrawProfit||0,monthlyTransferProfit:W.monthlyTransferProfit||0,lastUpdated:new Date})}catch(W){console.error("Error loading profit data:",W)}},k=W=>`${W.toFixed(2)} ج.م`,E=async()=>{try{const W=(p==null?void 0:p.subscription)||null,D=(W==null?void 0:W.planType)??(W==null?void 0:W.plan)??null,_=typeof D=="string"?D.toLowerCase():null;if(D===Gt.ZERO||_==="zero"||_==="0"||D===0)return!0}catch{}try{if(l){const W=await en(l),D=(W==null?void 0:W.planType)??(W==null?void 0:W.plan)??null,_=typeof D=="string"?D.toLowerCase():null;if(D===Gt.ZERO||_==="zero"||_==="0"||D===0)return!0}}catch{}return!1},K=async()=>{try{if(await E()){al({title:"الخطة زيرو",description:"عرض الأرباح الشهرية غير متاح في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}catch{}h(!0)},q=async()=>{try{if(await E()){al({title:"الخطة زيرو",description:"عرض الأرباح الشهرية غير متاح في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"}),h(!1);return}}catch{}M(!0),m(!0),h(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(o,{size:"sm",variant:"ghost",onClick:K,className:"h-2 w-2 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded transition-all duration-300 hover:scale-110 shadow-sm hover:shadow-md",title:"عرض الأرباح الشهرية",children:e.jsx(Xe,{className:"h-1.5 w-1.5"})}),e.jsx(ie,{open:t,onOpenChange:m,children:e.jsxs(oe,{className:"max-w-[220px] mx-auto bg-white border border-gray-200 shadow-md rounded sm:max-w-[180px] sm:bg-gradient-to-br sm:from-purple-50 sm:to-white sm:border-2 sm:border-purple-200 sm:shadow-2xl sm:rounded-2xl",children:[e.jsx(ce,{className:"text-center pb-0 border-b-0 sm:pb-2 sm:border-b sm:border-purple-200",children:e.jsxs(de,{className:"text-xs font-bold text-purple-800 flex items-center justify-center gap-0 mb-0 leading-tight tracking-tight sm:text-xs sm:gap-1 sm:mb-0 sm:leading-normal sm:tracking-normal",children:[e.jsx(is,{className:"h-2 w-2 text-purple-600 sm:h-3 sm:w-3"}),"شهري"]})}),e.jsxs("div",{className:"space-y-0 py-0 sm:space-y-2 sm:py-2",children:[e.jsx("div",{className:"bg-yellow-50 p-0.5 rounded border border-yellow-200 sm:bg-gradient-to-r sm:from-yellow-50 sm:to-yellow-100 sm:p-2 sm:rounded-xl sm:shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-[10px] sm:text-xs font-semibold text-yellow-900",children:"أرباح فوري"}),e.jsx("span",{className:"text-[10px] sm:text-xs font-bold text-yellow-900",children:k((u.monthlyWithdrawalProfit??0)+(u.monthlyTransferProfit??0))})]})}),e.jsx("div",{className:"bg-red-50 p-0.5 rounded border border-red-200 sm:bg-gradient-to-r sm:from-red-50 sm:to-red-100 sm:p-2 sm:rounded-xl sm:shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1 sm:gap-2",children:[e.jsx(Ua,{className:"h-2 w-2 text-red-600 sm:h-3 sm:w-3"}),e.jsx("span",{className:"text-[10px] sm:text-xs",children:"سحب"})]}),e.jsx("span",{className:"text-[10px] sm:text-xs font-bold text-red-700",children:k(u.monthlyWithdrawalProfit)})]})}),e.jsx("div",{className:"bg-blue-50 p-0.5 rounded border border-blue-200 sm:bg-gradient-to-r sm:from-blue-50 sm:to-blue-100 sm:p-2 sm:rounded-xl sm:shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1 sm:gap-2",children:[e.jsx(Dl,{className:"h-2 w-2 text-blue-600 sm:h-3 sm:w-3"}),e.jsx("span",{className:"text-[10px] sm:text-xs",children:"تحويل"})]}),e.jsx("span",{className:"text-[10px] sm:text-xs font-bold text-blue-700",children:k(u.monthlyTransferProfit)})]})}),e.jsx("div",{className:"bg-purple-50 p-0.5 rounded border border-purple-200 sm:bg-gradient-to-r sm:from-purple-50 sm:to-purple-100 sm:p-2 sm:rounded-xl sm:shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1 sm:gap-2",children:[e.jsx(Ze,{className:"h-2 w-2 text-purple-600 sm:h-3 sm:w-3"}),e.jsx("span",{className:"text-[10px] sm:text-xs",children:"إجمالي"})]}),e.jsx("span",{className:"text-[10px] sm:text-xs font-bold text-purple-700",children:k(u.monthlyWithdrawalProfit+u.monthlyTransferProfit)})]})})]}),!C&&e.jsx("div",{className:"absolute inset-0 bg-yellow-200/70 backdrop-blur-sm flex items-center justify-center rounded sm:rounded-2xl border border-yellow-300 pointer-events-auto",children:e.jsx(o,{size:"sm",variant:"ghost",onClick:()=>h(!0),className:"p-2 bg-yellow-300/80 text-yellow-900 hover:bg-yellow-400/90 rounded-full shadow-sm hover:shadow-md transition-all duration-300",title:"إدخال الرقم السري الرئيسي",children:e.jsx(Xe,{className:"h-4 w-4"})})}),e.jsx("div",{className:"flex justify-center pt-0 border-t-0 sm:pt-2 sm:border-t sm:border-purple-200",children:e.jsx(o,{onClick:()=>m(!1),className:"bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-xl text-sm sm:bg-gradient-to-r sm:from-purple-600 sm:to-purple-700 sm:hover:from-purple-700 sm:hover:to-purple-800 sm:px-4 sm:py-1 sm:rounded-xl sm:shadow-lg sm:hover:shadow-xl sm:transition-all sm:duration-300",children:"إغلاق"})})]})}),e.jsx(vs,{open:f,onOpenChange:h,onSuccess:q,description:"لا يمكن الاطلاع على الأرباح الشهرية إلا بإدخال الرقم السري الرئيسي"})]})},Kc=l=>e.jsx(Jc,{...l});function Vc({open:l,onOpenChange:d,onSuccess:t,userId:m}){const[f,h]=a.useState(""),[C,M]=a.useState(""),[u,x]=a.useState(!1),[p,P]=a.useState(!1),[k,E]=a.useState(""),[K,q]=a.useState(!1),{toast:W}=zt(),D=Ls.hasProfitPin(m),_=()=>{h(""),M(""),E(""),x(!1),P(!1),d(!1)},te=async j=>{j.preventDefault(),E(""),q(!0);try{if(D){if(!Ls.verifyProfitPin(f,m)){E("الرقم السري غير صحيح"),q(!1);return}}else{if(f.length<4){E("يجب أن يكون الرقم السري 4 أرقام على الأقل"),q(!1);return}if(f!==C){E("الرقم السري غير متطابق"),q(!1);return}Ls.setProfitPin(f,m)}W({title:"نجح العملية",description:D?"تم التحقق من الرقم السري بنجاح":"تم إنشاء رقم سري الأرباح بنجاح"}),t(),_()}catch{E("حدث خطأ أثناء معالجة الرقم السري")}finally{q(!1)}};return e.jsx(ie,{open:l,onOpenChange:d,children:e.jsxs(oe,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ce,{children:e.jsxs(de,{className:"flex items-center gap-2 text-lg font-semibold",children:[e.jsx(js,{className:"h-5 w-5 text-green-600"}),D?"أدخل رقم سري الأرباح":"إنشاء رقم سري للأرباح"]})}),e.jsxs("form",{onSubmit:te,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-gray-600 bg-blue-50 p-3 rounded-lg",children:D?"أدخل الرقم السري لعرض بيانات الأرباح":"قم بإنشاء رقم سري لحماية بيانات الأرباح. يمكنك تغييره لاحقاً من إعدادات البروفيل."}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"pin",children:D?"الرقم السري":"الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx($,{id:"pin",type:u?"text":"password",value:f,onChange:j=>h(j.target.value),placeholder:D?"أدخل الرقم السري":"أدخل رقم سري جديد (4 أرقام على الأقل)",className:"pr-10",dir:"ltr",autoComplete:"off",required:!0}),e.jsx(o,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>x(!u),children:u?e.jsx(Tt,{className:"h-4 w-4"}):e.jsx(Xe,{className:"h-4 w-4"})})]})]}),!D&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"confirmPin",children:"تأكيد الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx($,{id:"confirmPin",type:p?"text":"password",value:C,onChange:j=>M(j.target.value),placeholder:"أعد إدخال الرقم السري",className:"pr-10",dir:"ltr",autoComplete:"off",required:!0}),e.jsx(o,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>P(!p),children:p?e.jsx(Tt,{className:"h-4 w-4"}):e.jsx(Xe,{className:"h-4 w-4"})})]})]}),k&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(Ns,{className:"h-4 w-4"}),k]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(o,{type:"submit",disabled:K,className:"flex-1 bg-green-600 hover:bg-green-700",children:[e.jsx(js,{className:"h-4 w-4 mr-2"}),K?"جاري المعالجة...":D?"عرض الأرباح":"إنشاء وعرض الأرباح"]}),e.jsx(o,{type:"button",variant:"outline",onClick:_,disabled:K,children:"إلغاء"})]})]})]})})}const qc=({userId:l,transactions:d})=>{const[t,m]=a.useState(!1),[f,h]=a.useState(!1),[C,M]=a.useState(!1),[u,x]=a.useState({dailyWithdrawalProfit:0,dailyTransferProfit:0,lastUpdated:new Date});a.useEffect(()=>{l&&t&&C&&p()},[l,t,C]);const p=async()=>{if(l)try{const K=Ls.getWithdrawTransferProfits(l);x({dailyWithdrawalProfit:K.dailyWithdrawProfit||0,dailyTransferProfit:K.dailyTransferProfit||0,lastUpdated:new Date})}catch(K){console.error("Error loading profit data:",K)}},P=K=>`${K.toFixed(2)} ج.م`,k=()=>{Ls.hasProfitPin(l),h(!0)},E=()=>{M(!0),m(!0),h(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(o,{size:"sm",variant:"ghost",onClick:k,className:"h-2 w-2 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded transition-all duration-300 hover:scale-110 shadow-sm hover:shadow-md",title:"عرض الأرباح اليومية",children:e.jsx(Xe,{className:"h-1.5 w-1.5"})}),e.jsx(ie,{open:t,onOpenChange:m,children:e.jsxs(oe,{className:"max-w-[220px] mx-auto bg-white border border-gray-200 shadow-md rounded sm:max-w-[180px] sm:bg-gradient-to-br sm:from-blue-50 sm:to-white sm:border-2 sm:border-blue-200 sm:shadow-2xl sm:rounded-2xl",children:[e.jsx(ce,{className:"text-center pb-0 border-b-0 sm:pb-2 sm:border-b sm:border-blue-200",children:e.jsxs(de,{className:"text-xs font-bold text-blue-800 flex items-center justify-center gap-0 mb-0 leading-tight tracking-tight sm:text-sm sm:gap-1 sm:mb-0 sm:leading-normal sm:tracking-normal",children:[e.jsx(Ze,{className:"h-2 w-2 text-blue-600 sm:h-3 sm:w-3"}),"يومي"]})}),e.jsxs("div",{className:"space-y-0 py-0 sm:space-y-4 sm:py-4",children:[e.jsx("div",{className:"bg-yellow-50 p-2 rounded border border-yellow-200 sm:bg-gradient-to-r sm:from-yellow-50 sm:to-yellow-100 sm:p-4 sm:rounded-xl sm:shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-0 sm:gap-2",children:[e.jsx(Ze,{className:"h-3 w-3 text-yellow-600 sm:h-5 sm:w-5"}),e.jsx("span",{className:"font-medium text-yellow-800 text-xs sm:text-base",children:"أرباح فوري"})]}),e.jsx("span",{className:"font-bold text-sm text-yellow-900 bg-white px-0 py-0.5 rounded text-center sm:text-lg sm:px-3 sm:py-1",children:P((u.dailyWithdrawalProfit??0)+(u.dailyTransferProfit??0))})]})}),e.jsx("div",{className:"bg-red-50 p-2 rounded border border-red-200 sm:bg-gradient-to-r sm:from-red-50 sm:to-red-100 sm:p-4 sm:rounded-xl sm:shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-0 sm:gap-2",children:[e.jsx(Ua,{className:"h-3 w-3 text-red-600 sm:h-5 sm:w-5"}),e.jsx("span",{className:"font-medium text-red-800 text-xs sm:text-base",children:"سحب"})]}),e.jsx("span",{className:"font-bold text-sm text-red-900 bg-white px-0 py-0.5 rounded text-center sm:text-lg sm:px-3 sm:py-1",children:P(u.dailyWithdrawalProfit)})]})}),e.jsx("div",{className:"bg-green-50 p-0.5 rounded border border-green-200 sm:bg-gradient-to-r sm:from-green-50 sm:to-green-100 sm:p-2 sm:rounded-xl sm:shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between h-4 sm:h-auto",children:[e.jsxs("div",{className:"flex items-center gap-0 sm:gap-1",children:[e.jsx(Dl,{className:"h-2 w-2 text-green-600 sm:h-3 sm:w-3"}),e.jsx("span",{className:"font-medium text-green-800 text-xs leading-tight tracking-tighter sm:font-semibold sm:text-xs sm:leading-normal sm:tracking-normal",children:"تحويل"})]}),e.jsx("span",{className:"font-bold text-xs text-green-900 bg-white px-0 py-0 rounded text-center leading-tight tracking-tighter sm:text-sm sm:px-2 sm:py-0.5 sm:leading-normal sm:tracking-normal",children:P(u.dailyTransferProfit)})]})}),e.jsx("div",{className:"bg-blue-50 p-0.5 rounded border border-blue-200 sm:bg-gradient-to-r sm:from-blue-50 sm:to-blue-100 sm:p-2 sm:rounded-xl sm:shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between h-4 sm:h-auto",children:[e.jsxs("div",{className:"flex items-center gap-0 sm:gap-1",children:[e.jsx(Ze,{className:"h-2 w-2 text-blue-600 sm:h-3 sm:w-3"}),e.jsx("span",{className:"font-medium text-blue-800 text-xs leading-tight tracking-tighter sm:font-semibold sm:text-xs sm:leading-normal sm:tracking-normal",children:"مجموع"})]}),e.jsx("span",{className:"font-bold text-xs text-blue-900 bg-white px-0 py-0 rounded text-center leading-tight tracking-tighter sm:text-sm sm:px-2 sm:py-0.5 sm:leading-normal sm:tracking-normal",children:P(u.dailyWithdrawalProfit+u.dailyTransferProfit)})]})})]}),e.jsx("div",{className:"flex justify-center pt-0 border-t-0 sm:pt-2 sm:border-t sm:border-blue-200",children:e.jsx(o,{onClick:()=>m(!1),className:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-xl text-sm sm:bg-gradient-to-r sm:from-blue-600 sm:to-blue-700 sm:hover:from-blue-700 sm:hover:to-blue-800 sm:px-4 sm:py-1 sm:rounded-xl sm:shadow-lg sm:hover:shadow-xl sm:transition-all sm:duration-300 sm:text-xs",children:"إغلاق"})})]})}),e.jsx(Vc,{open:f,onOpenChange:h,onSuccess:E,userId:l})]})},Yc=l=>e.jsx(qc,{...l}),La=l=>Number(l||0).toFixed(2),Hc=({open:l,onOpenChange:d,userId:t})=>{const{toast:m}=zt(),[f,h]=ot.useState([]),[C,M]=ot.useState(!1),[u,x]=ot.useState("");ot.useEffect(()=>{(async()=>{if(!(!l||!t))try{M(!0);const E=[...await pl.getByUser(t)].sort((K,q)=>K.reportDate<q.reportDate?1:-1);h(E)}catch(k){console.error("Failed to load daily archive history:",k),m({title:"فشل تحميل الأرشيف",description:"تعذر تحميل أرشيف التقارير اليومية",variant:"destructive"})}finally{M(!1)}})()},[l,t]);const p=ot.useMemo(()=>{if(!u)return f;const P=u.trim();return f.filter(k=>k.reportDate.includes(P))},[f,u]);return e.jsx(ie,{open:l,onOpenChange:d,children:e.jsxs(oe,{className:"sm:max-w-xl",children:[e.jsxs(ce,{children:[e.jsx(de,{children:"أرشيف التقارير اليومية"}),e.jsx(Rt,{children:"يعرض جميع الأيام المؤرشفة مع ملخص لكل يوم."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"archive-search",children:"بحث بالتاريخ (YYYY-MM-DD)"}),e.jsx($,{id:"archive-search",placeholder:"مثال: 2025-10-19",value:u,onChange:P=>x(P.target.value)})]}),e.jsx("div",{className:"mt-3 space-y-2 max-h-[50vh] overflow-auto",children:C?e.jsx("div",{className:"text-sm text-muted-foreground",children:"جاري التحميل..."}):p.length===0?e.jsx("div",{className:"text-sm text-muted-foreground",children:"لا توجد تقارير مؤرشفة حتى الآن"}):p.map(P=>e.jsxs("div",{className:"border rounded-md p-2 bg-gradient-to-r from-white/80 to-blue-50/70",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{className:"font-bold text-blue-800",children:P.reportDate}),e.jsxs("div",{className:"text-xs text-blue-700",children:["عدد المعاملات: ",P.totalTransactions]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-1",children:[e.jsxs("div",{className:"text-xs text-blue-800",children:["إجمالي المبالغ: ",e.jsx("span",{className:"font-semibold",children:La(P.totalAmount)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["المسحوب: ",e.jsx("span",{className:"font-semibold",children:La(P.totalWithdrawn)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["المرسل: ",e.jsx("span",{className:"font-semibold",children:La(P.totalSent)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["الربح: ",e.jsx("span",{className:"font-semibold",children:La(P.profit)})]})]})]},P.id||`${P.userId}-${P.reportDate}`))}),e.jsx(Ne,{children:e.jsx(o,{variant:"outline",onClick:()=>d(!1),children:"إغلاق"})})]})})},Gc=({open:l,onOpenChange:d})=>{var Cs;const{shiftUser:t,isShiftActive:m,shiftStartAt:f,setShiftUser:h,startShift:C,endShift:M}=Ka(),{userSubscription:u,user:x,signIn:p,profile:P}=es(),{toast:k}=zt(),[E,K]=a.useState((t==null?void 0:t.name)||""),[q,W]=a.useState((t==null?void 0:t.username)||""),[D,_]=a.useState(""),[te,j]=a.useState(!1),[N,J]=a.useState(null),[le,ne]=a.useState(""),[he,Q]=a.useState("");a.useState(!1);const[Z,we]=a.useState(null),[V,se]=a.useState(""),[We,ze]=a.useState(""),[Ie,Te]=a.useState(!1),[st,Je]=a.useState(!1),[Ot,jt]=a.useState({totalTransfers:0,totalWithdrawals:0}),[g,R]=a.useState(null),[re,xe]=a.useState(""),[De,Le]=a.useState(""),[$e,gt]=a.useState(0),[Wt,wt]=a.useState({}),[pt,I]=a.useState(0),[X,fe]=a.useState(0),[ke,Ae]=a.useState({}),[Ke,B]=a.useState(""),[ee,z]=a.useState(!1),[pe,Pe]=a.useState(()=>{try{const b=localStorage.getItem("cashierUsers");return b?JSON.parse(b):[]}catch{return[]}}),nt=(Cs=u==null?void 0:u.subscription)==null?void 0:Cs.planType,lt=nt==="yearly"?2:nt==="lifetime"?4:Number.POSITIVE_INFINITY;a.useEffect(()=>{try{localStorage.setItem("cashierUsers",JSON.stringify(pe))}catch{}},[pe]);const[He,ft]=a.useState(!1),[Jt,kt]=a.useState(""),[Ft,ws]=a.useState(null),[ca,Bt]=a.useState([]),[Ss,Ds]=a.useState(!1),[et,Va]=a.useState(null),[St,os]=a.useState(!1),[qa,cs]=a.useState(!1),Ya=b=>{const me=(t==null?void 0:t.username)===b;let G=!1;try{G=localStorage.getItem("lastHandoverToAdmin")==="true"}catch{}if(me&&!(me&&!m&&(Ke==="الأدمن الرئيسي"||G))){k({title:"لا يمكن الحذف",description:"لا يمكنك حذف مستخدم الوردية أثناء كونها نشطة أو قبل تسليمها للأدمن الرئيسي"});return}const it=`هل أنت متأكد من حذف المستخدم ${b}؟

هذا الإجراء لا يمكن التراجع عنه.`;window.confirm(it)&&(Pe(Re=>Re.filter(ds=>ds.username!==b)),me&&h(null),k({title:"تم حذف المستخدم",description:b}))},Rs=()=>{if(!E.trim()||!q.trim()||!D.trim())return;if(pe.length>=lt){k({title:"وصلت الحد الأقصى للمستخدمين",description:`هذه الباقة تسمح بإضافة ${Number.isFinite(lt)?lt:"عدد غير محدود"} كاشير فقط`,variant:"destructive"});return}const b={name:E.trim(),username:q.trim(),password:D.trim()};Pe(me=>[b,...me]),K(""),W(""),_("")},dt=()=>{j(!0),J(null),we(null),se(""),ze("")},Us=async()=>{try{let b=[];try{x!=null&&x.uid&&(b=await je.getUserTransactions(x.uid))}catch{}if(!b||b.length===0)try{const be=await xc({merchantUserId:x==null?void 0:x.uid,limit:200});b=(be==null?void 0:be.transactions)||[]}catch{}const me=f?new Date(f):null,G=new Date,Ge=be=>{const U=be.type,Dt=be.txnType;return U==="withdraw"||U==="withdrawal"||U==="receive"||Dt==="receive"},Se=be=>{const U=be.type,Dt=be.txnType;return U==="send"||U==="transfer"||Dt==="send"},it=be=>{if(!be)return null;if(be instanceof Date)return be;try{const U=new Date(be);return Number.isNaN(U.getTime())?null:U}catch{return null}},Re=be=>{const U=it(be.createdAt||be.created_at||be.timestamp);return!U||me&&U<me?!1:U<=G},ds=be=>be==="completed"||be==="confirmed",da=b.filter(be=>ds(be.status)&&Re(be)),Ha=da.filter(be=>Ge(be)).reduce((be,U)=>{const Dt=U.withdrawnAmount??U.receivedAmount??U.amount??0;return be+(Number(Dt)||0)},0);return{totalTransfers:da.filter(be=>Se(be)).reduce((be,U)=>{const Dt=U.sentAmount??U.transferredAmount??U.amount??0;return be+(Number(Dt)||0)},0),totalWithdrawals:Ha}}catch{return{totalTransfers:0,totalWithdrawals:0}}};a.useEffect(()=>{if(st){try{const b=localStorage.getItem("shiftInitialReceivedDrawerFunds");b!==null&&Le(b)}catch{}try{const b=localStorage.getItem("shiftInitialReceivedWalletBalancesTotal");if(b!==null){const me=parseFloat(b);gt(Number.isFinite(me)?me:0)}}catch{}}},[st]),a.useEffect(()=>{if(!l&&!Ss)return;(async()=>{try{const G=((x!=null&&x.uid?await je.getUserTransactions(x.uid):[])||[]).filter(Ge=>(Ge==null?void 0:Ge.type)==="report"||((Ge==null?void 0:Ge.title)||"").includes("إيصال تسليم وردية"));G.sort((Ge,Se)=>{const it=new Date(Ge.createdAt||0).getTime();return new Date(Se.createdAt||0).getTime()-it}),Bt(G)}catch{Bt([])}})()},[l,st,Ss,x==null?void 0:x.uid]);const mt=async(b,me,G)=>{try{let Ge=0,Se=0;try{const Re=parseFloat(localStorage.getItem("shiftInitialReceivedDrawerFunds")||"0");Ge=Number.isFinite(Re)?Re:0}catch{}try{const Re=parseFloat(localStorage.getItem("shiftInitialReceivedWalletBalancesTotal")||"0");Se=Number.isFinite(Re)?Re:0}catch{}const it={id:`shift_receipt_${Date.now()}`,type:"report",senderPhone:(t==null?void 0:t.username)||"cashier",receiverPhone:Ke||"admin",amount:0,status:"completed",createdAt:new Date().toISOString(),title:"إيصال تسليم وردية",cashierName:(t==null?void 0:t.name)||(t==null?void 0:t.username)||null,deficit:me,deficitAmount:me?G:0,shiftStartAt:f,receivedDrawerFunds:Ge,receivedWalletBalancesTotal:Se,receivedWalletBalances:Wt,deliveredDrawerFunds:pt||0,deliveredWalletBalancesTotal:X||0,deliveredWalletBalances:ke,shiftProfit:Math.round(((pt||0)+(X||0)-(Ge+Se))*100)/100};x!=null&&x.uid&&await je.saveUserTransaction(x.uid,it),Bt(Re=>[it,...Re||[]])}catch{}};return e.jsxs(e.Fragment,{children:[e.jsx(ie,{open:l,onOpenChange:d,children:e.jsxs(oe,{className:"sm:max-w-md",children:[e.jsx(ce,{children:e.jsx(de,{children:m?"تسليم الورديه والخروج":"إضافة مستخدم وردية"})}),m?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsx("div",{className:"text-sm",children:"المستخدم الحالي للوردية:"}),e.jsxs("div",{className:"font-semibold text-sm",children:[t==null?void 0:t.name," (",t==null?void 0:t.username,")"]})]}),e.jsx("div",{className:"text-xs text-gray-600",children:'لإنهاء الوردية والخروج، اضغط "تسليم الورديه والخروج" وسيُطلب الرقم السري.'})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-xs text-gray-600",children:'لاستكمال إضافة مستخدم جديد اضغط الزر أسفل "إضافة مستخدم جديد" لفتح النموذج.'}),pe.length>0&&e.jsxs("div",{className:"mt-4 border-t pt-3",children:[e.jsx("div",{className:"text-sm font-medium mb-2",children:"المستخدمون المسجلون"}),e.jsx("div",{className:"space-y-2 max-h-48 overflow-auto",children:pe.map((b,me)=>e.jsxs("div",{className:"flex items-center justify-between rounded border px-3 py-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:b.name}),e.jsx("div",{className:"text-xs text-gray-500",children:b.username})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(o,{size:"sm",className:"w-full sm:w-auto",onClick:()=>{ws(b),ft(!0)},children:"دخول"}),e.jsx(o,{size:"sm",className:"w-full sm:w-auto",variant:"destructive",onClick:()=>Ya(b.username),children:"حذف"})]})]},me))})]})]}),e.jsx(Ne,{className:"flex flex-wrap gap-2 justify-between",children:m?e.jsx("div",{className:"flex flex-wrap gap-2",children:e.jsx(o,{className:"w-full sm:w-auto",variant:"destructive",onClick:dt,children:"تسليم الورديه والخروج"})}):e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(o,{className:"w-full sm:w-auto",onClick:()=>cs(!0),children:"إضافة مستخدم جديد"}),e.jsx(o,{className:"w-full sm:w-auto",variant:"outline",onClick:()=>Ds(!0),children:"إيصالات التسليم"})]})})]})}),e.jsx(ie,{open:qa,onOpenChange:cs,children:e.jsxs(oe,{className:"sm:max-w-md",children:[e.jsx(ce,{children:e.jsx(de,{children:"إضافة مستخدم جديد"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(H,{className:"mb-1 block",children:"الاسم"}),e.jsx($,{value:E,onChange:b=>K(b.target.value),placeholder:"أدخل الاسم"})]}),e.jsxs("div",{children:[e.jsx(H,{className:"mb-1 block",children:"اسم المستخدم"}),e.jsx($,{value:q,onChange:b=>W(b.target.value),placeholder:"أدخل اسم المستخدم"})]}),e.jsxs("div",{children:[e.jsx(H,{className:"mb-1 block",children:"الرقم السري"}),e.jsx($,{type:"password",autoComplete:"new-password",value:D,onChange:b=>_(b.target.value),placeholder:"أدخل الرقم السري"})]}),e.jsx("div",{className:"text-xs text-gray-500",children:"المستخدم يمكنه: التحويل، السحب، اختيار المحفظة فقط."})]}),e.jsxs(Ne,{className:"flex gap-2 justify-between",children:[e.jsx(o,{variant:"secondary",onClick:()=>{cs(!1)},children:"إلغاء"}),e.jsx(o,{onClick:()=>{!E.trim()||!q.trim()||!D.trim()||(Rs(),cs(!1))},children:"حفظ المستخدم"})]})]})}),e.jsx(ie,{open:Ss,onOpenChange:Ds,children:e.jsxs(oe,{className:"sm:max-w-lg",children:[e.jsx(ce,{children:e.jsx(de,{children:"إيصالات التسليم"})}),ca.length===0?e.jsx("div",{className:"text-xs text-gray-600",children:"لا توجد إيصالات تسليم محفوظة بعد."}):e.jsx("div",{className:"space-y-2 max-h-[60vh] overflow-auto",children:ca.map(b=>e.jsxs("div",{className:"rounded border px-3 py-2 cursor-pointer hover:bg-gray-50",onClick:()=>{Va(b),os(!0)},children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm font-semibold",children:new Date(b.createdAt).toLocaleString("ar-EG")}),e.jsxs("div",{className:"text-xs text-gray-500",children:["إلى: ",b.receiverPhone]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-1",children:[e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مسلّمة: ",b.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مسلّمة (إجمالي): ",b.deliveredWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مستلمة: ",b.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مستلمة (إجمالي): ",b.receivedWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مسلّمة: ",b.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مسلّمة (إجمالي): ",b.deliveredWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مستلمة: ",b.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مستلمة (إجمالي): ",b.receivedWalletBalancesTotal??0]}),e.jsxs("div",{className:["text-xs",(b.shiftProfit??(b.deliveredDrawerFunds??0)+(b.deliveredWalletBalancesTotal??0)-(b.receivedDrawerFunds??0)-(b.receivedWalletBalancesTotal??0))>=0?"text-green-700":"text-red-700"].join(" "),children:["أرباح الوردية: ",b.shiftProfit??(b.deliveredDrawerFunds??0)+(b.deliveredWalletBalancesTotal??0)-(b.receivedDrawerFunds??0)-(b.receivedWalletBalancesTotal??0)]})]}),b.deficit&&e.jsxs("div",{className:"text-xs text-red-600 mt-1",children:["عجز: ",b.deficitAmount??0]})]},b.id))}),e.jsx(Ne,{className:"flex gap-2 justify-between",children:e.jsx(o,{variant:"secondary",onClick:()=>Ds(!1),children:"إغلاق"})})]})}),e.jsx(ie,{open:St,onOpenChange:os,children:e.jsxs(oe,{className:"sm:max-w-md",children:[e.jsx(ce,{children:e.jsx(de,{children:"إيصال تسليم وردية"})}),et?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsxs("div",{className:"text-sm",children:["التاريخ: ",new Date(et.createdAt).toLocaleString("ar-EG")]}),e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["تم التسليم إلى: ",et.receiverPhone]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"المستلم عند الدخول"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية: ",et.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["أرصدة المحافظ (إجمالي): ",et.receivedWalletBalancesTotal??0]})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"المسلّم عند الخروج"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية: ",et.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["أرصدة المحافظ (إجمالي): ",et.deliveredWalletBalancesTotal??0]})]})]}),et.deficit&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2 text-red-600",children:"عجز"}),e.jsxs("div",{className:"text-xs text-red-600",children:["المبلغ: ",et.deficitAmount??0]})]}),et.receivedWalletBalances&&Object.keys(et.receivedWalletBalances).length>0&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"تفصيل المحافظ المستلمة"}),e.jsx("div",{className:"space-y-1",children:Object.entries(et.receivedWalletBalances).map(([b,me])=>e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-gray-600",children:b}),e.jsx("span",{className:"font-semibold",children:me})]},b))})]}),et.deliveredWalletBalances&&Object.keys(et.deliveredWalletBalances).length>0&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"تفصيل المحافظ المسلّمة"}),e.jsx("div",{className:"space-y-1",children:Object.entries(et.deliveredWalletBalances).map(([b,me])=>e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-gray-600",children:b}),e.jsx("span",{className:"font-semibold",children:me})]},b))})]})]}):e.jsx("div",{className:"text-xs text-gray-600",children:"لا يوجد تقرير محدد للعرض."}),e.jsx(Ne,{className:"flex gap-2 justify-between",children:e.jsx(o,{variant:"secondary",onClick:()=>os(!1),children:"إغلاق"})})]})}),e.jsx(ie,{open:He,onOpenChange:ft,children:e.jsxs(oe,{className:"sm:max-w-md",children:[e.jsx(ce,{children:e.jsx(de,{children:"أدخل الرقم السري للدخول"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm",children:Ft?`${Ft.name} (${Ft.username})`:""}),e.jsx($,{type:"password",autoComplete:"off",value:Jt,onChange:b=>kt(b.target.value),placeholder:"أدخل الرقم السري"})]}),e.jsxs(Ne,{className:"flex gap-2 justify-between",children:[e.jsx(o,{variant:"secondary",onClick:()=>{kt(""),ws(null),ft(!1)},children:"إلغاء"}),e.jsx(o,{onClick:()=>{if(Ft){if(Jt.trim()!==Ft.password){k({title:"خطأ في الرقم السري",description:"الرقم السري للكاشير غير صحيح",variant:"destructive"});return}h({name:Ft.name,username:Ft.username}),kt(""),ft(!1),d(!1),C(),z(!0)}},children:"دخول الورديه"})]})]})}),e.jsx(ie,{open:ee,onOpenChange:z,children:e.jsxs(oe,{className:"sm:max-w-md",children:[e.jsx(ce,{children:e.jsx(de,{children:"تسجيل أرصدة البداية والنقدية"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(H,{className:"mb-1 block",children:"الفلوس النقدية المستلمة عند الدخول"}),e.jsx($,{type:"number",value:De,onChange:b=>Le(b.target.value),placeholder:"أدخل قيمة النقدية في الدرج عند بداية الورديه"})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(H,{className:"mb-1 block",children:"أرصدة المحافظ المستلمة (إجمالي) عند الدخول"}),e.jsx($,{type:"number",value:Number.isFinite($e)?$e:0,onChange:b=>{const me=parseFloat(b.target.value);gt(Number.isFinite(me)?me:0)},placeholder:"أدخل إجمالي أرصدة المحافظ عند بداية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"يمكن إضافة التفصيل لاحقاً إن لزم، المهم تسجيل الإجمالي."})]})]}),e.jsx(Ne,{className:"flex gap-2 justify-between",children:e.jsx(o,{onClick:()=>{const b=parseFloat(De),me=$e,G=Number.isFinite(b)&&b>=0,Ge=Number.isFinite(me)&&me>=0;if(!G||!Ge){k({title:"يرجى إدخال قيم صحيحة",description:"أدخل قيمًا رقمية غير سالبة للنقدية ولإجمالي أرصدة المحافظ",variant:"destructive"});return}try{localStorage.setItem("shiftInitialReceivedDrawerFunds",String(b)),localStorage.setItem("shiftInitialReceivedWalletBalancesTotal",String(me))}catch{}k({title:"تم تسجيل أرصدة البداية",description:"سُجّل إجمالي النقدية وأرصدة المحافظ لبداية الورديه"}),z(!1)},children:"تأكيد وحفظ"})})]})}),e.jsx(ie,{open:te,onOpenChange:b=>{b&&j(!0)},children:e.jsxs(oe,{className:"sm:max-w-md",hideClose:!0,disableOutsideClose:!0,disableEscClose:!0,children:[e.jsx(ce,{children:e.jsx(de,{children:"تسليم الورديه والخروج"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(o,{variant:N==="toUser"?"default":"secondary",onClick:()=>J("toUser"),children:"تسليم إلى مستخدم آخر"}),e.jsx(o,{variant:N==="toAdmin"?"default":"secondary",onClick:()=>J("toAdmin"),children:"تسليم إلى الأدمن الرئيسي"})]}),N==="toUser"&&e.jsxs("div",{className:"space-y-3",children:[pe.length===0?e.jsx("div",{className:"text-sm text-gray-600",children:"لا يوجد مستخدمون مسجلون. قم بإضافة مستخدم أولاً."}):e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"اختر المستخدم الذي سيتسلم الورديه"}),e.jsx("div",{className:"space-y-2 max-h-40 overflow-auto",children:pe.map((b,me)=>e.jsxs("div",{className:`flex items-center justify-between rounded border px-3 py-2 cursor-pointer ${(Z==null?void 0:Z.username)===b.username?"bg-indigo-50 border-indigo-200":""}`,onClick:()=>we(b),children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:b.name}),e.jsx("div",{className:"text-xs text-gray-500",children:b.username})]}),e.jsx("span",{className:"text-xs text-gray-400",children:"اختيار"})]},me))})]}),e.jsxs("div",{children:[e.jsx(H,{className:"mb-1 block",children:"كلمة سر المستخدم المحدد"}),e.jsx($,{type:"password",autoComplete:"off",value:V,onChange:b=>se(b.target.value),placeholder:"أدخل كلمة السر"})]}),We&&e.jsx("div",{className:"text-xs text-red-600",children:We})]}),N==="toAdmin"&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm text-gray-600",children:"أدخل كلمة مرور الحساب الرئيسي لتسليم الورديه والخروج إلى الأدمن."}),e.jsx($,{type:"password",autoComplete:"off",value:le,onChange:b=>ne(b.target.value),placeholder:"كلمة المرور"}),he&&e.jsx("div",{className:"text-xs text-red-600",children:he})]})]}),e.jsx(Ne,{className:"flex gap-2 justify-between",children:e.jsx(o,{disabled:Ie||!N,onClick:async()=>{if(N){Te(!0);try{const b=await Us();if(N==="toUser"){if(!Z){ze("يرجى اختيار المستخدم أولاً"),Te(!1);return}if(V.trim()!==Z.password){ze("كلمة السر غير صحيحة"),Te(!1);return}M(),h({name:Z.name,username:Z.username}),C(),B(`${Z.name} (${Z.username})`);try{localStorage.setItem("lastHandoverToAdmin","false")}catch{}j(!1),J(null),we(null),se(""),ze(""),d(!1),jt(b),R(null),xe(""),Je(!0)}else if(N==="toAdmin"){Q("");const me=(x==null?void 0:x.email)||"";if(!me){Q("لا يوجد بريد للمستخدم الرئيسي للتحقق"),Te(!1);return}const{error:G}=await p(me,le);if(G){Q("كلمة المرور غير صحيحة"),Te(!1);return}M(),h(null);try{localStorage.setItem("lastHandoverToAdmin","true")}catch{}ne(""),j(!1),d(!1),B("الأدمن الرئيسي"),jt(b),R(null),xe(""),Je(!0)}}catch{ze("حدث خطأ أثناء التسليم، حاول مرة أخرى")}finally{Te(!1)}}},children:"تأكيد التسليم"})})]})}),e.jsx(ie,{open:st,onOpenChange:Je,children:e.jsxs(oe,{className:"sm:max-w-lg",hideClose:!0,disableOutsideClose:!0,disableEscClose:!0,children:[e.jsx(ce,{children:e.jsx(de,{children:"تقرير تسليم الورديه والخروج"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsxs("div",{className:"text-sm",children:["تم تسليم الورديه إلى: ",e.jsx("span",{className:"font-semibold",children:Ke})]}),f&&e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["بداية الورديه: ",new Date(f).toLocaleString("ar-EG")]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نهاية الورديه: ",new Date().toLocaleString("ar-EG")]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(H,{className:"mb-1 block",children:"الفلوس النقدية المستلمة"}),e.jsx($,{type:"number",value:De,readOnly:!0,disabled:!0,placeholder:"قيمة مسجلة عند بداية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"قيمة غير قابلة للتعديل؛ تُسجّل عند الدخول."})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(H,{className:"mb-1 block",children:"أرصدة المحافظ المستلمة (إجمالي)"}),e.jsx($,{type:"number",value:$e,readOnly:!0,disabled:!0,placeholder:"إجمالي مسجل عند بداية الورديه"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(H,{className:"mb-1 block",children:"الفلوس النقدية المسلمة"}),e.jsx($,{type:"number",value:pt,onChange:b=>{const me=parseFloat(b.target.value);I(Number.isFinite(me)?me:0)},placeholder:"أدخل قيمة النقدية المسلمة عند نهاية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"ادخال يدوي لقيمة النقدية المسلّمة عند نهاية الورديه"})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(H,{className:"mb-1 block",children:"أرصدة المحافظ المسلمة (إجمالي)"}),e.jsx($,{type:"number",value:X,onChange:b=>{const me=parseFloat(b.target.value);fe(Number.isFinite(me)?me:0)},placeholder:"أدخل إجمالي أرصدة المحافظ المسلّمة"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"يمكنك إدخال الإجمالي يدوياً؛ التفصيل يُحفظ إن لزم"})]})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-1",children:"أرباح الوردية"}),e.jsx("div",{className:["text-sm",(pt??0)+(X??0)-((parseFloat(De||"0")||0)+($e??0))>=0?"text-green-700":"text-red-700"].join(" "),children:Math.round(((pt??0)+(X??0)-((parseFloat(De||"0")||0)+($e??0)))*100)/100}),e.jsx("div",{className:"text-xs text-gray-600",children:"محسوبة: (المسلّم − المستلم) للنقدية + المحافظ"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"هل يوجد عجز؟"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(o,{variant:g==="no"?"default":"secondary",onClick:()=>R("no"),children:"لا"}),e.jsx(o,{variant:g==="yes"?"default":"secondary",onClick:()=>R("yes"),children:"نعم"})]}),g==="yes"&&e.jsxs("div",{children:[e.jsx(H,{className:"mb-1 block",children:"مبلغ العجز"}),e.jsx($,{type:"number",value:re,onChange:b=>xe(b.target.value),placeholder:"أدخل مبلغ العجز"})]})]})]}),e.jsx(Ne,{className:"flex gap-2 justify-between",children:e.jsx(o,{onClick:()=>{const b=g==="yes",me=parseFloat(re)||0;(async()=>await mt(Ot,b,me))(),k({title:"تم إضافة إيصال تسليم الورديه",description:"أُضيف الإيصال إلى المعاملات الأخيرة بعنوان إيصال تسليم وردية"}),Je(!1)},children:"تأكيد وحفظ الإيصال"})})]})})]})},Qc=({open:l,onOpenChange:d})=>{const{shiftUser:t,endShift:m,setShiftUser:f}=Ka(),[h,C]=a.useState(""),[M,u]=a.useState(""),[x,p]=a.useState([]);a.useEffect(()=>{try{const k=localStorage.getItem("cashierUsers");p(k?JSON.parse(k):[])}catch{p([])}},[l]);const P=async()=>{if(u(""),!t)return;const k=x.find(E=>E.username===t.username);if(!k){u("لا يوجد مستخدم مطابق لهذه الوردية");return}if(h.trim()!==k.password){u("الرقم السري غير صحيح");return}m(),f(null),C(""),d(!1)};return e.jsx(ie,{open:l,onOpenChange:k=>{C(""),u(""),d(k)},children:e.jsxs(oe,{className:"sm:max-w-md",children:[e.jsx(ce,{children:e.jsx(de,{children:"بروفيل الوردية"})}),t?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"rounded-lg border p-3 bg-gradient-to-r from-blue-50 to-indigo-50",children:[e.jsx("div",{className:"text-sm font-semibold text-gray-800",children:t.name}),e.jsx("div",{className:"text-xs text-gray-600",children:t.username})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{className:"block",children:"أدخل الرقم السري لتسليم الوردية"}),e.jsx($,{type:"password",value:h,onChange:k=>C(k.target.value),placeholder:"الرقم السري للمستخدم",dir:"ltr"}),M&&e.jsx("div",{className:"text-red-600 text-xs",children:M})]})]}):e.jsx("div",{className:"text-sm text-gray-600",children:"لا يوجد مستخدم وردية نشط حالياً"}),e.jsxs(Ne,{className:"flex justify-between",children:[e.jsx(o,{variant:"outline",onClick:()=>d(!1),children:"إغلاق"}),e.jsx(o,{onClick:P,disabled:!t,children:"تسليم الوردية"})]})]})})};class Es{static async processTransfer(d){const{amount:t,currentCashBalance:m,currentWalletBalances:f,wallets:h,selectedWalletId:C}=d;if(t<=0)return{success:!1,newCashBalance:m,newWalletBalances:f,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(C&&!d.skipRemoteLimitsCheck)try{const p=await Zt.canPerformOperation(C,t,"transfer");if(!p.canPerform)return{success:!1,newCashBalance:m,newWalletBalances:f,message:p.message||"تجاوز حد التحويل المسموح",error:"LIMIT_EXCEEDED"}}catch(p){return console.error("خطأ في التحقق من حدود التحويل:",p),{success:!1,newCashBalance:m,newWalletBalances:f,message:"خطأ في التحقق من حدود التحويل",error:"LIMIT_CHECK_ERROR"}}if(t<=0)return{success:!1,newCashBalance:m,newWalletBalances:f,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(C){const p=Math.max(f[C]||0,0);if(p<t){const P=h.find(k=>k.id===C);return{success:!1,newCashBalance:m,newWalletBalances:f,message:`رصيد غير كافي في المحفظة${P?` ${P.name}`:""}. المتاح: ${p} جنيه، المطلوب: ${t} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"}}}else{const p=Es.calculateTotalWalletBalance(f);if(p<t)return{success:!1,newCashBalance:m,newWalletBalances:f,message:`رصيد غير كافي في المحافظ. الرصيد المتاح: ${p} جنيه، المبلغ المطلوب: ${t} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"}}const M={...f};if(C){const p=M[C]||0;M[C]=p-t}else{let p=t;for(const P of h){if(p<=0)break;const k=Math.max(M[P.id]||0,0),E=Math.min(k,p);E>0&&(M[P.id]=(M[P.id]||0)-E,p-=E)}}const u=m+t;if(C)try{const p=Zt.updateUsage(C,t,"transfer");d.nonBlockingUsageUpdate?p.catch(P=>console.error("خطأ في تحديث استخدام المحفظة:",P)):await p}catch(p){console.error("خطأ في تحديث استخدام المحفظة:",p)}let x="تم التحويل بنجاح";if(C){const p=M[C]||0;p<0&&(x=`تم التحويل بنجاح مع تحذير: رصيد محفظة ${C} أصبح ${p} جنيه.`)}return{success:!0,newCashBalance:u,newWalletBalances:M,message:x}}static processDeposit(d){const{amount:t,currentCashBalance:m,currentWalletBalances:f,wallets:h}=d;if(t<=0)return{success:!1,newCashBalance:m,newWalletBalances:f,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};const C=this.calculateTotalWalletBalance(f);if(C<t)return{success:!1,newCashBalance:m,newWalletBalances:f,message:`رصيد غير كافي في المحافظ. الرصيد المتاح: ${C} جنيه، المبلغ المطلوب: ${t} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"};const M=m+t,u={...f};let x=t;const p=h.find(k=>k.isDefault);if(p&&u[p.id]>=x)u[p.id]-=x,x=0;else for(const k of h){if(x<=0)break;const E=u[k.id]||0;if(E>0){const K=Math.min(E,x);u[k.id]=E-K,x-=K}}const P=x>0?`تم الإيداع جزئياً. تم إيداع ${t-x} جنيه في صندوق النقدية`:`تم الإيداع بنجاح. تم إضافة ${t} جنيه إلى صندوق النقدية`;return{success:!0,newCashBalance:M,newWalletBalances:u,message:P}}static async processWithdraw(d){const{amount:t,currentCashBalance:m,currentWalletBalances:f,wallets:h,selectedWalletId:C}=d;if(t<=0)return{success:!1,newCashBalance:m,newWalletBalances:f,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(C&&!d.skipRemoteLimitsCheck)try{const p=await Zt.canPerformOperation(C,t,"withdraw");if(!p.canPerform)return{success:!1,newCashBalance:m,newWalletBalances:f,message:p.reason||"تم تجاوز الحد المسموح للسحب",error:"LIMIT_EXCEEDED"}}catch(p){return console.error("خطأ في التحقق من حدود السحب:",p),{success:!1,newCashBalance:m,newWalletBalances:f,message:"خطأ في التحقق من حدود السحب",error:"LIMIT_CHECK_ERROR"}}if(m<t)return{success:!1,newCashBalance:m,newWalletBalances:f,message:`رصيد غير كافي في صندوق النقدية. الرصيد المتاح: ${m} جنيه، المبلغ المطلوب: ${t} جنيه`,error:"INSUFFICIENT_CASH_BALANCE"};const M=m-t,u={...f},x=C?h.find(p=>p.id===C):h.find(p=>p.isDefault)||h[0];if(x){const p=u[x.id]||0;u[x.id]=p+t}else return{success:!1,newCashBalance:m,newWalletBalances:f,message:"لا توجد محافظ متاحة لإضافة المبلغ إليها",error:"NO_WALLETS_AVAILABLE"};if(C)try{const p=Zt.updateUsage(C,t,"withdraw");d.nonBlockingUsageUpdate?p.catch(P=>console.error("خطأ في تحديث استخدام المحفظة:",P)):await p}catch(p){console.error("خطأ في تحديث استخدام المحفظة:",p)}return{success:!0,newCashBalance:M,newWalletBalances:u,message:`تم السحب بنجاح. تم إضافة ${t} جنيه إلى محفظة ${(x==null?void 0:x.name)||""}`}}static validateOperation(d,t){return d<=0?{valid:!1,error:"المبلغ يجب أن يكون أكبر من الصفر"}:!t||t.length===0?{valid:!1,error:"لا توجد محافظ متاحة"}:{valid:!0}}static calculateTotalWalletBalance(d){return Object.values(d).reduce((t,m)=>t+Math.max(m,0),0)}static deductFromWalletsAddToCash(d,t,m,f){return this.processTransfer({amount:d,currentCashBalance:t,currentWalletBalances:m,wallets:f})}static deductFromWalletsAddToCashDeposit(d,t,m,f){return this.processDeposit({amount:d,currentCashBalance:t,currentWalletBalances:m,wallets:f})}static deductFromCashAddToWallets(d,t,m,f){return this.processWithdraw({amount:d,currentCashBalance:t,currentWalletBalances:m,wallets:f})}static applyTransactionResult(d,t,m){d.success&&(t(d.newCashBalance),m(d.newWalletBalances))}static validateTransaction(d,t,m,f){if(d<=0)return{isValid:!1,error:"المبلغ يجب أن يكون أكبر من الصفر"};if(t==="transfer"){const h=this.calculateTotalWalletBalance(f);if(h<d)return{isValid:!1,error:`الرصيد المتاح في المحافظ (${h} جنيه) غير كافي للمبلغ المطلوب (${d} جنيه)`}}else if(t==="withdraw"){if(m<d)return{isValid:!1,error:`الرصيد المتاح في صندوق النقدية (${m} جنيه) غير كافي للمبلغ المطلوب (${d} جنيه)`}}else if(t==="deposit"){const h=this.calculateTotalWalletBalance(f);if(h<d)return{isValid:!1,error:`الرصيد المتاح في المحافظ (${h} جنيه) غير كافي للمبلغ المطلوب (${d} جنيه)`}}return{isValid:!0}}static getDeductionPreview(d,t,m){const f=[];let h=d;for(const C of m){if(h<=0)break;const M=t[C.id]||0,u=Math.min(Math.max(M,0),h);u>0&&(f.push({walletId:C.id,walletName:C.name,currentBalance:M,deductedAmount:u,newBalance:M-u}),h-=u)}return f}}let sa=null;function Zc(){const l=window;if(!sa){const d=l.AudioContext||l.webkitAudioContext;sa=new d}return sa.state==="suspended"&&sa.resume(),sa}function Xc(l,d,t){const m=t/1e3,f=Math.floor(l.sampleRate*m),h=l.createBuffer(1,f,l.sampleRate),C=h.getChannelData(0);for(let p=0;p<f;p++)C[p]=(Math.random()*2-1)*.6;const M=l.createBufferSource();M.buffer=h;const u=l.createBiquadFilter();u.type="highpass",u.frequency.value=1500,u.Q.value=.7;const x=l.createGain();x.gain.setValueAtTime(1e-4,d),x.gain.exponentialRampToValueAtTime(.4,d+.015),x.gain.exponentialRampToValueAtTime(1e-4,d+m),M.connect(u),u.connect(x),x.connect(l.destination),M.start(d),M.stop(d+m+.01)}function ed(l,d,t,m,f,h="triangle"){const C=l.createOscillator(),M=l.createGain();C.type=h;const u=f/1e3;C.frequency.setValueAtTime(t,d),C.frequency.linearRampToValueAtTime(m,d+u),M.gain.setValueAtTime(1e-4,d),M.gain.exponentialRampToValueAtTime(.25,d+.02),M.gain.exponentialRampToValueAtTime(1e-4,d+u),C.connect(M),M.connect(l.destination),C.start(d),C.stop(d+u+.02)}function td(){try{const l=Zc(),d=l.currentTime;Xc(l,d,90),ed(l,d+.12,1900,1100,180,"sawtooth")}catch{}}function sd(l){if(!l)return!1;const t=l.replace(/[^0-9٠-٩]/g,"").replace(/[٠-٩]/g,m=>"0123456789"["٠١٢٣٤٥٦٧٨٩".indexOf(m)]);return/^(010|011|012|015)[0-9]{8}$/.test(t)}const tm=()=>{var Zn,Xn,el,tl;console.log("🔥 UserDashboardPage component is loading...");const{toast:l}=zt(),{signOut:d,user:t,profile:m}=es(),f=((t==null?void 0:t.email)||"").toLowerCase()==="vodafonecash00@gmail.com",h=Io(),C=hl(),{isShiftActive:M,shiftUser:u}=Ka(),{shopName:x}=To(),p=ko(),[P,k]=a.useState(!1),[E,K]=a.useState(!1);console.log("🔥 UserDashboardPage - user:",t?"exists":"null");const[q,W]=a.useState(!0),[D,_]=a.useState(!0),[te,j]=a.useState(!1),[N,J]=a.useState(!1),[le,ne]=a.useState(""),[he,Q]=a.useState(""),[Z,we]=a.useState(""),[V,se]=a.useState([]),[We,ze]=a.useState(!1),[Ie,Te]=a.useState(null),[st,Je]=a.useState("");a.useState(!1);const[Ot,jt]=a.useState(!1),[g,R]=a.useState(!1),[re,xe]=a.useState(!1),[De,Le]=a.useState(""),[$e,gt]=a.useState(""),[Wt,wt]=a.useState([]),[pt,I]=a.useState(!1),[X,fe]=a.useState(0),[ke,Ae]=a.useState(!1),[Ke,B]=a.useState(null),[ee,z]=a.useState(!1),[pe,Pe]=a.useState(""),[nt,lt]=a.useState(""),[He,ft]=a.useState(""),[Jt,kt]=a.useState(!1),[Ft,ws]=a.useState(""),[ca,Bt]=a.useState(""),[Ss,Ds]=a.useState(""),[et,Va]=a.useState(""),[St,os]=a.useState(null),[qa,cs]=a.useState(!1),[Ya,Rs]=a.useState(!1),[dt,Us]=a.useState(""),[mt,Cs]=a.useState(""),[b,me]=a.useState(()=>{try{const s=localStorage.getItem("commissionMode")||localStorage.getItem("commissionMode_default");return s?s==="add":!0}catch{return!0}}),[G,Ge]=a.useState("transfer"),[Se,it]=a.useState([]),[Re,ds]=a.useState("all");a.useEffect(()=>{try{if(localStorage.setItem("commissionMode",b?"add":"deduct"),t!=null&&t.uid){const s=`commissionMode_${t.uid}`;localStorage.setItem(s,b?"add":"deduct")}}catch{}},[b,t==null?void 0:t.uid]),a.useEffect(()=>{try{const s=t!=null&&t.uid?localStorage.getItem(`commissionMode_${t.uid}`):null,n=localStorage.getItem("commissionMode"),r=localStorage.getItem("commissionMode_default"),i=s??n??r;i&&me(i==="add")}catch{}},[t==null?void 0:t.uid]);const[da,Ha]=a.useState(!1),[an,be]=a.useState(null),[U,Dt]=a.useState("");a.useEffect(()=>{if(!Jt)return;const s=ss(),n=parseFloat(He||"0")||0;let r=0;if(G==="transfer"){if((s==null?void 0:s.defaultTransferCommission)!=null){const c=Number(s.defaultTransferCommission)||0;r=Math.round(c*n/1e3*100)/100}else{const c=mt&&mt.trim()!==""?parseFloat(mt):0;r=Math.max(0,c)}const i=n+r;Bt((i||0).toString())}else{if((s==null?void 0:s.defaultWithdrawCommission)!=null){const c=Number(s.defaultWithdrawCommission)||0;r=Math.round(c*n/1e3*100)/100}else{const c=dt&&dt.trim()!==""?parseFloat(dt):Math.round(n*.01*100)/100;r=Math.max(0,c)}const i=b?n:Math.max(0,Math.round((n-r)*100)/100);Bt((i||0).toString())}},[Jt,He,mt,dt,U,b,G]);const ss=()=>{var n,r;let s=ye.find(i=>i.id===U);if(!s)try{const i=localStorage.getItem(ks());if(i){const c=JSON.parse(i);if(Array.isArray(c)&&c.length>0){const v=localStorage.getItem(`selectedWallet_${(t==null?void 0:t.uid)||"default"}`)||((n=c.find(S=>S.isDefault))==null?void 0:n.id)||((r=c[0])==null?void 0:r.id);s=c.find(S=>S.id===v)}}}catch{}return s};a.useLayoutEffect(()=>{try{const s=`wallets_${(t==null?void 0:t.uid)||"default"}`;let n=localStorage.getItem(s);if(!n){const r=Object.keys(localStorage).find(i=>i.startsWith("wallets_"));r&&(n=localStorage.getItem(r)||null)}if(n){const r=JSON.parse(n);if(Array.isArray(r)&&r.length>0){Kt(r);const i=`selectedWallet_${(t==null?void 0:t.uid)||"default"}`,c=localStorage.getItem(i),y=c&&r.find(v=>v.id===c)||r.find(v=>v.isDefault)||r[0];y&&(Dt(y.id),Pe(y.phone))}}}catch(s){console.error("تهيئة فورية للمحافظ من التخزين المحلي فشلت:",s)}},[]),a.useEffect(()=>{console.log("🔍 selectedWallet state changed to:",U)},[U]),a.useEffect(()=>{Ri()},[]),a.useEffect(()=>{_i()},[]);const[ye,Kt]=a.useState(()=>{try{const s=Object.keys(localStorage).find(r=>r.startsWith("wallets_")),n=s?localStorage.getItem(s):null;if(n){const r=JSON.parse(n);if(Array.isArray(r))return r}}catch{}return[]}),[Zl,ad]=a.useState(null),[Xl,rn]=a.useState(!1),[ei,ma]=a.useState(!1),[ti,si]=a.useState(null);a.useState([]),a.useState([]);const[ai,_s]=a.useState(!1),[Ga,nn]=a.useState("daily"),[ri,ln]=a.useState(!1),[ni,Qa]=a.useState(!1),[on,ms]=a.useState([]),li=async s=>{try{const n=Se.find(i=>i.id===s);if(!n||!t)return;const r=Se.filter(i=>i.id!==s);it(r);try{await je.removeUserTransaction(t.uid,s),await Fa.permanentlyDeleteTransaction(s,t.uid)}catch(i){console.warn("تعذر الحذف النهائي من قواعد البيانات أثناء حذف الإيصال:",i)}try{const i=Ve(),c=Ue(),y=localStorage.getItem(i),v=localStorage.getItem(c);let S=y?parseFloat(y):Ee,O=v?JSON.parse(v):{...ve};const A=n.amount||n.transferredAmount||n.withdrawnAmount||n.withdrawnAmountDetailed||0;if(n.type==="send"&&(n.fromWallet||U)){S-=n.commission||0;const L=n.fromWallet||U;O[L]=(O[L]||0)+A}else if(n.type==="withdraw"&&(n.fromWallet||U)){S+=A,S-=n.commission||0;const L=n.fromWallet||U;O[L]=Math.max(0,(O[L]||0)-A)}Qe(S),Be(O),localStorage.setItem(i,S.toString()),localStorage.setItem(c,JSON.stringify(O));const w={cashBalance:S,walletBalances:O,lastUpdated:new Date().toISOString()},F=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(F,JSON.stringify(w)),t!=null&&t.uid?je.updateUserData(t.uid,w).then(()=>{localStorage.removeItem(F),ge(!1)}).catch(L=>{console.warn("تعذر حفظ الأرصدة في Firebase بعد الحذف، تم الاحتفاظ محليًا:",L),ge(!0)}):ge(!0)}catch(i){console.warn("تعذر عكس تأثير الأرصدة بعد الحذف:",i)}try{const i=n.fromWallet||U,c=await Zt.getWalletLimits(t.uid,i);if(c){const y=n.amount||n.transferredAmount||n.withdrawnAmount||n.withdrawnAmountDetailed||0,v={...c};n.type==="send"?(v.dailyTransferUsed=Math.max(0,(c.dailyTransferUsed||0)-y),v.monthlyTransferUsed=Math.max(0,(c.monthlyTransferUsed||0)-y)):(v.dailyWithdrawUsed=Math.max(0,(c.dailyWithdrawUsed||0)-y),v.monthlyWithdrawUsed=Math.max(0,(c.monthlyWithdrawUsed||0)-y)),await Zt.updateWalletLimits(t.uid,i,v)}}catch(i){console.warn("تعذر تحديث حدود المحفظة بعد الحذف:",i)}try{$t.removeTransactionEffects(n,t.uid)}catch(i){console.warn("تعذر تحديث التقارير بعد الحذف:",i)}l({title:"تم الحذف نهائيًا",description:"تم حذف الإيصال نهائيًا وعكس تأثيراته على الأرصدة والحدود والتقارير."}),ma(!1)}catch(n){console.error("خطأ أثناء حذف الإيصال:",n),l({title:"خطأ في حذف الإيصال",description:"حدث خطأ غير متوقع أثناء الحذف.",variant:"destructive"})}},ii=async s=>{try{if(!Se.find(r=>r.id===s)||!t)return;await la(Ht(ut,"userTransactions",s),{status:"completed",confirmedAt:new Date}),it(r=>r.map(i=>i.id===s?{...i,status:"completed"}:i)),l({title:"تم الإكمال",description:"تم وسم المعاملة كمكتملة."}),ma(!1)}catch(n){console.error("خطأ أثناء إكمال الإيصال:",n),l({title:"فشل الإكمال",description:"حدث خطأ غير متوقع أثناء تحديث الحالة.",variant:"destructive"})}},[cn,oi]=a.useState(""),dn=zc(cn,300),[ha,mn]=a.useState(""),[xa,hn]=a.useState(""),[as,rd]=a.useState(""),[Za,Is]=a.useState(!1),[xn,zs]=a.useState(!1),[ci,ua]=a.useState(!1),[vt,Xa]=a.useState(null),[di,un]=a.useState(!1),[mi,er]=a.useState(!1),[hi,tr]=a.useState(!1),[xi,sr]=a.useState(!1),[ui,ar]=a.useState(!1),[gi,gn]=a.useState(!0),[Js,pi]=a.useState(!1),[fi,ga]=a.useState(!1),[vi,pn]=a.useState(()=>{try{const s=t!=null&&t.uid?`dailyReportsLockEnabled_${t==null?void 0:t.uid}`:"dailyReportsLockEnabled";return(localStorage.getItem(s)??localStorage.getItem("dailyReportsLockEnabled"))==="true"}catch{return!1}}),[yi,rr]=a.useState(!1);a.useEffect(()=>{try{const s=t!=null&&t.uid?`dailyReportsLockEnabled_${t==null?void 0:t.uid}`:"dailyReportsLockEnabled",n=localStorage.getItem(s)??localStorage.getItem("dailyReportsLockEnabled");pn(n==="true")}catch{}},[t==null?void 0:t.uid]);const[ji,pa]=a.useState(!1),[bi,fa]=a.useState(!1),[yt,Et]=a.useState([]),[nr,fn]=a.useState(""),[lr,vn]=a.useState(""),[ir,yn]=a.useState(""),[ue,or]=a.useState(null),[Ni,Ks]=a.useState(!1);a.useState(!1);const[wi,cr]=a.useState(!1),[jn,dr]=a.useState(""),[Si,Vs]=a.useState(!1),[Di,mr]=a.useState(!1),[Vt,hr]=a.useState([]),[xr,bn]=a.useState(""),[ur,Nn]=a.useState(""),[gr,wn]=a.useState(""),[Sn,Dn]=a.useState(""),[Ci,va]=a.useState(!1),[pr,fr]=a.useState(null),[Ct,qs]=a.useState(null),[ya,vr]=a.useState(""),[Ii,Ts]=a.useState(!1),[Cn,ja]=a.useState(0),[Lt,hs]=a.useState(null),[xs,yr]=a.useState(""),[Fe,Ti]=a.useState(null),qt=async s=>{try{const n=JSON.stringify(s);localStorage.setItem(An(),n);try{localStorage.setItem(On(),n)}catch{}t!=null&&t.uid&&je.updateUserData(t.uid,{debts:s}).catch(()=>ge(!0))}catch(n){console.error("خطأ في حفظ الديون:",n)}},ki=async()=>{try{const s=An(),n=On(),r=localStorage.getItem(s),i=localStorage.getItem(n),c=v=>{if(!v)return null;try{const S=JSON.parse(v);return Array.isArray(S)?S.map(O=>{var A;return{...O,createdAt:(A=O.createdAt)!=null&&A.toDate?O.createdAt.toDate():new Date(O.createdAt),partialPayments:Array.isArray(O.partialPayments)?O.partialPayments.map(w=>{var F;return{amount:Number(w.amount)||0,paidAt:(F=w.paidAt)!=null&&F.toDate?w.paidAt.toDate():new Date(w.paidAt)}}):[]}}):[]}catch(S){return console.warn("فشل في تحليل ديون localStorage:",S),null}};let y=c(r);if(!y||y.length===0){const v=c(i);if(v&&v.length>0&&(y=v,Et(v),t!=null&&t.uid))try{await qt(v),localStorage.removeItem(n)}catch(S){console.warn("تعذر ترحيل الديون من المفتاح الافتراضي:",S)}}if(y&&y.length>0&&Et(y),t!=null&&t.uid)try{const v=await Ba(Ht(ut,"users",t.uid));if(v.exists()){const S=v.data(),O=S.debts&&Array.isArray(S.debts)?S.debts.map(L=>{var T;return{...L,createdAt:(T=L.createdAt)!=null&&T.toDate?L.createdAt.toDate():new Date(L.createdAt),partialPayments:Array.isArray(L.partialPayments)?L.partialPayments.map(Y=>{var Ce;return{amount:Number(Y.amount)||0,paidAt:(Ce=Y.paidAt)!=null&&Ce.toDate?Y.paidAt.toDate():new Date(Y.paidAt)}}):[]}}):[],A=new Map;for(const L of O)A.set(L.id,L);for(const L of y||[])A.set(L.id,L);const w=Array.from(A.values());Et(w);try{localStorage.setItem(s,JSON.stringify(w))}catch{}(w.length!==O.length||w.some(L=>{const T=O.find(Y=>Y.id===L.id);return!T||T.amount!==L.amount||T.status!==L.status||(T.paidAmount??0)!==(L.paidAmount??0)}))&&await je.updateUserData(t.uid,{debts:w})}else y&&y.length>0&&await je.saveUserData(t.uid,{debts:y})}catch(v){console.warn("تعذر تحميل الديون من Firebase، الاعتماد على المحلي:",v)}}catch(s){console.error("خطأ في تحميل الديون:",s)}},Ai=async()=>{if(t!=null&&t.uid){console.log("🔄 إعادة فحص حالة المستخدم...");try{await new Promise(n=>setTimeout(n,500));const s=await Ba(Ht(ut,"users",t.uid));if(s.exists()){const r=s.data().isActive===!0,i=await aa.checkTrialValidity(t.uid),c=i.isValid&&!i.isExpired;console.log("📊 حالة المستخدم:",{isActive:r,isOnTrial:c,hoursRemaining:i.hoursRemaining}),W(r||c),I(c),fe(i.hoursRemaining),Ae(i.hasUsedTrial),R(!r&&!c),console.log("✅ تم تحديث حالة المستخدم بنجاح:",{userIsActive:r||c,isOnFreeTrial:c})}}catch(s){console.error("خطأ في إعادة فحص حالة المستخدم:",s)}}},Pi=async()=>{console.log("🎉 تم بدء التجربة المجانية، إعادة فحص حالة المستخدم..."),await Ai()},Oi=async()=>{if(t!=null&&t.uid)try{z(!0);const s=await en(t.uid);B(s)}catch(s){console.error("خطأ في جلب بيانات الاشتراك:",s)}finally{z(!1)}};a.useState(!1);const[Wi,jr]=a.useState(!1),[Ee,Qe]=a.useState(0),[ve,Be]=a.useState({}),[Fi,In]=a.useState(!1),[Bi,Tn]=a.useState(!1),[Ei,br]=a.useState(!1),[Mi,ba]=a.useState(!1),[kn,Nr]=a.useState(""),[Li,wr]=a.useState(!1),[$i,Na]=a.useState(!1),[Sr,wa]=a.useState(""),Ue=()=>`walletBalances_${(t==null?void 0:t.uid)||"default"}`,Ve=()=>`cashBalance_${(t==null?void 0:t.uid)||"default"}`,An=()=>`debts_${(t==null?void 0:t.uid)||"default"}`,Pn=()=>`customers_${(t==null?void 0:t.uid)||"default"}`,On=()=>"debts_default",Wn=()=>`shopExpenses_${(t==null?void 0:t.uid)||"default"}`,Ri=()=>{try{const s=localStorage.getItem(Wn());if(s){const n=JSON.parse(s);se(n.map(r=>({...r,createdAt:new Date(r.createdAt)})))}}catch(s){console.error("خطأ أثناء تحميل مصروفات المحل من التخزين:",s)}},Ui=async s=>{try{localStorage.setItem(Wn(),JSON.stringify(s)),se(s)}catch(n){console.error("خطأ أثناء حفظ مصروفات المحل في التخزين:",n)}},Fn=()=>`deficiencies_${(t==null?void 0:t.uid)||"default"}`,_i=()=>{try{const s=localStorage.getItem(Fn());if(s){const n=JSON.parse(s);wt(n.map(r=>({...r,createdAt:new Date(r.createdAt)})))}}catch(s){console.error("خطأ أثناء تحميل النواقص من التخزين:",s)}},Dr=async s=>{try{localStorage.setItem(Fn(),JSON.stringify(s)),wt(s)}catch(n){console.error("خطأ أثناء حفظ النواقص في التخزين:",n)}},zi=async s=>{try{localStorage.setItem(Pn(),JSON.stringify(s)),hr(s),t!=null&&t.uid&&await je.updateUserData(t.uid,{customers:s})}catch(n){console.error("خطأ أثناء حفظ العملاء في التخزين:",n)}},Ji=async()=>{try{if(t!=null&&t.uid){const n=await Ba(Ht(ut,"users",t.uid));if(n.exists()){const r=n.data();if(r.customers&&Array.isArray(r.customers)){const i=r.customers.map(c=>{var y;return{...c,createdAt:(y=c.createdAt)!=null&&y.toDate?c.createdAt.toDate():new Date(c.createdAt)}});hr(i);return}}}const s=localStorage.getItem(Pn());if(s){const n=JSON.parse(s);hr(n.map(r=>({...r,createdAt:new Date(r.createdAt)})))}}catch(s){console.error("خطأ أثناء تحميل العملاء من التخزين:",s)}},Ys=()=>`transactions_${(t==null?void 0:t.uid)||"default"}`,Hs=()=>`deletedTransactions_${(t==null?void 0:t.uid)||"default"}`,ks=()=>`wallets_${(t==null?void 0:t.uid)||"default"}`,us=()=>`selectedWallet_${(t==null?void 0:t.uid)||"default"}`,Cr=()=>{try{const s=ks(),n=localStorage.getItem(s);if(n){const r=JSON.parse(n);if(Array.isArray(r)&&r.length>0)return r}}catch(s){console.warn("loadWalletsFromLocalWithMigration failed:",s)}return null},Ir=s=>{try{const n=us(),r=localStorage.getItem(n);if(r&&s.find(i=>i.id===r))return r}catch{}return null},[Tr,Sa]=a.useState(""),[bt,Bn]=a.useState(""),gs=ot.useMemo(()=>{const s=Ke;if(!s)return!1;const n=Ao(s),r=s.planType??s.plan??null,i=typeof r=="string"?r.toLowerCase():null,c=i==="monthly"||i==="quarterly"||i==="yearly"||i==="lifetime"||r===Gt.MONTHLY||r===Gt.QUARTERLY||r===Gt.YEARLY||r===Gt.LIFETIME;return n&&c},[Ke]),qe=ot.useMemo(()=>{const s=Ke;if(!s)return!1;const n=s.planType??s.plan??null,r=typeof n=="string"?n.toLowerCase():null;return n===Gt.ZERO||r==="zero"},[Ke]),Ki=()=>{if(!gs){l({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}k(!0)};a.useState(!1);const[Vi,qi]=a.useState(!1),[Yi,Hi]=a.useState(!1),[Gi,Qi]=a.useState(!1),[Zi,Da]=a.useState(!1),[Ca,kr]=a.useState(""),[Ar,Pr]=a.useState(""),[En,Mn]=a.useState(!1),[Xi,Ia]=a.useState(!1),[Ln,Or]=a.useState(""),[$n,Wr]=a.useState(""),[Rn,Un]=a.useState(!1),_n=async()=>{if(t!=null&&t.uid)try{const s=`userData_${t.uid}`,n=localStorage.getItem(s);if(n){const r=JSON.parse(n);console.log("🔄 مزامنة البيانات المحلية مع Firebase...",r);const i={lastSynced:new Date().toISOString()};typeof r.cashBalance=="number"&&(i.cashBalance=r.cashBalance),r.walletBalances&&typeof r.walletBalances=="object"&&(i.walletBalances=r.walletBalances),await je.updateUserData(t.uid,i),localStorage.removeItem(s),ge(!1),console.log("✅ تمت المزامنة بنجاح وحذف البيانات المحلية")}else console.log("لا توجد بيانات محلية تحتاج للمزامنة")}catch(s){console.error("❌ فشل في مزامنة البيانات:",s),l({title:"فشل في المزامنة",description:"حدث خطأ أثناء مزامنة البيانات مع الخادم",variant:"destructive"})}},zn=t!=null&&t.uid?`recentTransactionsResetAt:${t.uid}`:null,Fr=ot.useMemo(()=>{if(!zn)return null;try{const s=localStorage.getItem(zn);return s?new Date(s):null}catch{return null}},[t==null?void 0:t.uid]),Jn=ot.useMemo(()=>{const s=Se||[];return Fr?s.filter(n=>new Date(n.createdAt)>=Fr):s},[Se,Fr]),Kn=ot.useCallback(()=>{let s=Jn;const n=dn.trim();if(n&&(s=s.filter(r=>r.senderPhone&&r.senderPhone.includes(n)||r.receiverPhone&&r.receiverPhone.includes(n))),ha){const r=new Date(ha);s=s.filter(i=>{const c=new Date(i.createdAt);if(xa){const[y,v]=xa.split(":"),S=new Date(r);S.setHours(parseInt(y),parseInt(v),0,0);const O=new Date(S);return O.setHours(O.getHours()+1),c>=S&&c<O}else return c.toDateString()===r.toDateString()})}try{s=[...s].sort((r,i)=>{const c=new Date(r.createdAt||0).getTime();return new Date(i.createdAt||0).getTime()-c})}catch{}return s},[Jn,dn,ha,xa]),[eo,Ta]=a.useState(!1),[Vn,ka]=a.useState(""),[to,Aa]=a.useState(!1),[Br,Er]=a.useState(""),[so,ge]=a.useState(!1);ye.reduce((s,n)=>s+(ve[n.id]||0),0);const ao=s=>ls.verifyMasterPin(s),Mr=s=>ls.verifyMasterPin(s),Lr=async s=>{try{const n=Bo.currentUser;if(!n||!n.email)return!1;const r=Eo.credential(n.email,s);return await Mo(n,r),!0}catch(n){return console.error("فشل التحقق من كلمة المرور:",n),!1}};a.useEffect(()=>{if(!(t!=null&&t.uid))return;console.log("🚀 استعادة البيانات من localStorage عند تحميل الصفحة للمستخدم:",t.uid);const s=`walletBalances_${t.uid}`,n=localStorage.getItem(s);if(n)try{const c=JSON.parse(n);console.log("📱 استعادة أرصدة المحافظ من localStorage:",c),Be(c)}catch(c){console.error("خطأ في قراءة أرصدة المحافظ من localStorage:",c)}const r=`cashBalance_${t.uid}`;let i=localStorage.getItem(r);if(!i){const c=`userCashBalance_${t.uid}`,y=localStorage.getItem(c);if(y){i=y;try{localStorage.setItem(r,y),localStorage.removeItem(c)}catch{}}}if(i){const c=parseFloat(i);console.log("💰 استعادة رصيد الدرج النقدي من localStorage:",c),Qe(c)}},[t==null?void 0:t.uid]);const qn=async()=>{try{if(!U)return;const s=await Zt.autoResetLimitsIfNeeded(U);Ti(s)}catch(s){console.error("خطأ في جلب حدود المحفظة المختارة:",s)}};a.useEffect(()=>{qn()},[U]),a.useEffect(()=>{const s=n=>{var r;(r=n==null?void 0:n.detail)!=null&&r.walletId&&n.detail.walletId===U&&qn()};return window.addEventListener("walletLimitsUpdated",s),()=>window.removeEventListener("walletLimitsUpdated",s)},[U]),a.useEffect(()=>{if(h.state){if(console.log("Location state:",h.state),h.state.openDebtDialog&&(qe?l({title:"غير متاح",description:"الديون/الأجل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):fa(!0),window.history.replaceState({},document.title)),h.state.openSalesDialog&&(qe?l({title:"غير متاح",description:"بيانات المبيعات غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):er(!0),window.history.replaceState({},document.title)),h.state.openMaintenanceDialog&&(qe?l({title:"غير متاح",description:"الصيانة غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):sr(!0),window.history.replaceState({},document.title)),h.state.openCreditCardsDialog&&(console.log("Opening credit cards dialog"),qe?l({title:"غير متاح",description:"كروت الائتمان غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):tr(!0),window.history.replaceState({},document.title)),h.state.openShopExpensesDialog&&(qe?l({title:"غير متاح",description:"مصروفات المحل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):ls.hasMasterPin()?J(!0):j(!0),window.history.replaceState({},document.title)),h.state.openDeficienciesDialog&&(qe?l({title:"غير متاح",description:"النواقص غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):xe(!0),window.history.replaceState({},document.title)),h.state.openTransactionSection){const s=document.getElementById("transaction-section");s&&s.scrollIntoView({behavior:"smooth"}),h.state.transactionType&&Ge(h.state.transactionType),h.state.startNewTransaction&&(lt(""),ft(""),Us(""),Cs(""),console.log("🔒 Starting new transaction without changing wallet selection")),h.state.focusWalletSelection&&setTimeout(()=>{const n=document.querySelector('[data-testid="wallet-select"]');n&&n.focus()},500),window.history.replaceState({},document.title)}h.state.openCashierShiftModal&&(gs?k(!0):l({title:"غير متاح",description:"وردية الكاشير متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"}),window.history.replaceState({},document.title)),h.state.openMachineDailyDialog&&(gs?ar(!0):l({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"}),window.history.replaceState({},document.title))}},[h.state,ye]),a.useEffect(()=>{var s;if(t!=null&&t.uid)try{const n=Cr();if(n&&n.length>0){Kt(n);const r=Ir(n)||localStorage.getItem(us()),i=r&&n.find(c=>c.id===r)?r:(s=n[0])==null?void 0:s.id;i&&!U&&Gs(i,"localStorageHydration")}}catch(n){console.error("خطأ في تهيئة المحافظ من التخزين المحلي:",n)}},[t==null?void 0:t.uid]),a.useEffect(()=>{h.pathname==="/user/dashboard"&&sessionStorage.getItem("previousPath")==="/user/add-wallet"&&(console.log("🔄 Returned from wallet addition page - reloading wallets"),Pa(),sessionStorage.removeItem("previousPath")),sessionStorage.setItem("previousPath",h.pathname)},[h.pathname,t==null?void 0:t.uid]),a.useEffect(()=>{if(!(t!=null&&t.uid))return;console.log("🔥 Setting up real-time user activation listener for:",t.uid);const s=Ht(ut,"users",t.uid),n=Po(s,r=>{if(r.exists()){const i=r.data(),c=i.isActive===!0;console.log("🔥 Real-time user status update:",{userId:t.uid,isActive:c,subscription:i.subscription}),c&&!q?(console.log("🎉 User activated! Redirecting to dashboard..."),W(!0),R(!1),_(!1)):!c&&q&&(console.log("❌ User deactivated! Showing activation modal..."),W(!1),R(!0))}},r=>{console.error("❌ Error in real-time user listener:",r)});return()=>{console.log("🔥 Cleaning up real-time user listener"),n()}},[t==null?void 0:t.uid,q]),a.useEffect(()=>{if(!(t!=null&&t.uid))return;const s=r=>{const{userId:i}=r.detail;i===t.uid&&(console.log("🎉 Subscription activation event received for current user!"),W(!0),R(!1),_(!1),setTimeout(()=>{console.log("✅ User activation completed - data updated")},1e3))},n=r=>{const{userId:i,isActive:c}=r.detail;i===t.uid&&(console.log("🔄 User subscription update event received:",{userId:i,isActive:c}),c&&!q&&(W(!0),R(!1),_(!1),setTimeout(()=>{console.log("✅ User subscription updated - data refreshed")},1e3)))};return window.addEventListener("subscriptionActivated",s),window.addEventListener("userSubscriptionUpdated",n),()=>{window.removeEventListener("subscriptionActivated",s),window.removeEventListener("userSubscriptionUpdated",n)}},[t==null?void 0:t.uid,q]),a.useEffect(()=>{console.log("🔥 useEffect loadUserData started",{user:t==null?void 0:t.uid,isCheckingActivation:D}),(async()=>{try{if(!(t!=null&&t.uid)){console.log("🔥 No user UID, setting isCheckingActivation to false"),_(!1);return}let i=!1;const c=`userData_${t==null?void 0:t.uid}`,y=localStorage.getItem(c);if(y)try{const w=JSON.parse(y);w.walletBalances&&(Be(w.walletBalances),i=!0,console.log("⚡ تحميل فوري لأرصدة المحافظ من بيانات المستخدم:",w.walletBalances))}catch(w){console.error("خطأ في قراءة بيانات المستخدم من localStorage:",w)}if(!i){const w=localStorage.getItem(Ue());if(w)try{const F=JSON.parse(w);Be(F),i=!0,console.log("⚡ تحميل فوري لأرصدة المحافظ من النسخة الاحتياطية:",F)}catch(F){console.error("خطأ في قراءة أرصدة المحافظ من localStorage:",F)}}if(!i){const F=Object.keys(localStorage).filter(L=>L.startsWith("walletBalances_backup_")).sort().reverse();for(const L of F)try{const T=localStorage.getItem(L);if(T){const Y=JSON.parse(T);Be(Y),i=!0,console.log("⚡ تحميل فوري لأرصدة المحافظ من النسخة الاحتياطية بالتوقيت:",Y);break}}catch(T){console.error("خطأ في قراءة النسخة الاحتياطية:",T);continue}}let v=localStorage.getItem(Ve());if(!v&&(t!=null&&t.uid)){const w=`userCashBalance_${t.uid}`,F=localStorage.getItem(w);if(F){v=F;try{localStorage.setItem(Ve(),F),localStorage.removeItem(w)}catch{}}}v&&(Qe(parseFloat(v)),console.log("⚡ تحميل فوري لرصيد الدرج النقدي من localStorage:",v));try{const w=await Ba(Ht(ut,"users",t.uid));if(w.exists()){const L=w.data().isActive===!0,T=await aa.checkTrialValidity(t.uid),Y=T.isValid&&!T.isExpired;W(L||Y),I(Y),fe(T.hoursRemaining),Ae(T.hasUsedTrial),R(!L&&!Y),console.log("📊 حالة المستخدم:",{isActive:L,isOnTrial:Y,hoursRemaining:T.hoursRemaining,hasUsedTrial:T.hasUsedTrial})}else W(!1),R(!0)}catch(w){console.error("خطأ في فحص حالة تفعيل المستخدم:",w),W(!1),R(!0)}finally{_(!1)}console.log("🔄 بدء تحميل بيانات المستخدم من Firebase...",{userId:t==null?void 0:t.uid});const S=localStorage.getItem(c);let O=!1;if(S)try{const w=JSON.parse(S),F=new Date(w.lastUpdated);(new Date().getTime()-F.getTime())/(1e3*60)<1&&(O=!0,console.log("⚡ توجد تغييرات محلية حديثة (أقل من دقيقة)، تجنب إعادة التحميل من Firebase"),w.walletBalances&&Be(w.walletBalances),w.cashBalance!==void 0&&Qe(w.cashBalance))}catch(w){console.error("خطأ في قراءة البيانات المحلية:",w)}if(S&&!O)try{const w=JSON.parse(S),F=new Date(w.lastUpdated);(new Date().getTime()-F.getTime())/(1e3*60)>10&&(console.log("🗑️ حذف البيانات المحلية القديمة (أكثر من 10 دقائق)"),localStorage.removeItem(c))}catch(w){console.error("خطأ في حذف البيانات المحلية القديمة:",w)}if(!O&&(t!=null&&t.uid)){const w=await je.getUserData(t.uid);if(console.log("📥 البيانات المحملة من Firebase:",w),w){if(w.walletBalances!==void 0&&Object.keys(ve).length===0)console.log("👛 تحميل أرصدة المحافظ:",w.walletBalances),Be(w.walletBalances),localStorage.setItem(Ue(),JSON.stringify(w.walletBalances));else{const F=localStorage.getItem(Ue());if(F)try{const L=JSON.parse(F);console.log("📱 استعادة أرصدة المحافظ من localStorage:",L),Be(L),t!=null&&t.uid?await je.updateUserData(t.uid,{walletBalances:L,lastUpdated:new Date().toISOString()}):ge(!0)}catch(L){console.error("خطأ في قراءة أرصدة المحافظ من localStorage:",L);const T={};Be(T),localStorage.setItem(Ue(),JSON.stringify(T)),t!=null&&t.uid?await je.updateUserData(t.uid,{walletBalances:T,lastUpdated:new Date().toISOString()}):ge(!0)}else{console.log("⚠️ لا توجد أرصدة محافظ في Firebase أو localStorage، إنشاء أرصدة افتراضية");const L={};Be(L),localStorage.setItem(Ue(),JSON.stringify(L)),t!=null&&t.uid?await je.updateUserData(t.uid,{walletBalances:L,lastUpdated:new Date().toISOString()}):ge(!0)}}w.cashBalance!==void 0&&Ee===0?(console.log("💰 تحميل رصيد الدرج النقدي:",w.cashBalance),Qe(w.cashBalance),localStorage.setItem(Ve(),w.cashBalance.toString())):(console.log("⚠️ لا يوجد رصيد درج نقدي، استخدام القيمة الافتراضية: 0"),Qe(0),localStorage.setItem(Ve(),"0"));try{const F=t!=null&&t.uid?await Fa.getDeletedTransactionsByUser(t.uid):[];if(F&&F.length>0)ms(F),console.log("🗑️ تم تحميل المعاملات المحذوفة من Firebase:",F.length);else{const L=localStorage.getItem(Hs());if(L)try{const T=JSON.parse(L);ms(T),console.log("🗑️ تم تحميل المعاملات المحذوفة من localStorage:",T.length)}catch(T){console.error("خطأ في قراءة المعاملات المحذوفة من localStorage:",T)}}}catch(F){console.error("خطأ في تحميل المعاملات المحذوفة من Firebase:",F);const L=localStorage.getItem(Hs());if(L)try{const T=JSON.parse(L);ms(T),console.log("🗑️ تم تحميل المعاملات المحذوفة من localStorage (fallback):",T.length)}catch(T){console.error("خطأ في قراءة المعاملات المحذوفة من localStorage:",T)}}}else{console.log("⚠️ لا توجد بيانات مستخدم في Firebase، محاولة استعادة من localStorage");const F=localStorage.getItem(Ue());if(F)try{const T=JSON.parse(F);console.log("📱 استعادة أرصدة المحافظ من localStorage:",T),Be(T)}catch(T){console.error("خطأ في قراءة أرصدة المحافظ من localStorage:",T)}let L=localStorage.getItem(Ve());if(!L&&(t!=null&&t.uid)){const T=`userCashBalance_${t.uid}`,Y=localStorage.getItem(T);if(Y){L=Y;try{localStorage.setItem(Ve(),Y),localStorage.removeItem(T)}catch{}}}L&&(Qe(parseFloat(L)),console.log("💰 استعادة رصيد الدرج النقدي من localStorage:",L));try{const T=t!=null&&t.uid?await Fa.getDeletedTransactionsByUser(t.uid):[];if(T&&T.length>0)ms(T),console.log("🗑️ تم تحميل المعاملات المحذوفة من Firebase:",T.length);else{const Y=localStorage.getItem(Hs());if(Y)try{const Ce=JSON.parse(Y);ms(Ce),console.log("🗑️ تم تحميل المعاملات المحذوفة من localStorage:",Ce.length)}catch(Ce){console.error("خطأ في قراءة المعاملات المحذوفة من localStorage:",Ce)}}}catch(T){console.error("خطأ في تحميل المعاملات المحذوفة من Firebase:",T);const Y=localStorage.getItem(Hs());if(Y)try{const Ce=JSON.parse(Y);ms(Ce),console.log("🗑️ تم تحميل المعاملات المحذوفة من localStorage (fallback):",Ce.length)}catch(Ce){console.error("خطأ في قراءة المعاملات المحذوفة من localStorage:",Ce)}}}}console.log("🔄 بدء تحميل المحافظ من Firebase...");try{const w=await ns.getByMerchantId((t==null?void 0:t.uid)||"");if(w&&w.length>0){console.log("✅ تم العثور على محافظ في Firebase:",w.length);const F=w.map(Y=>({id:Y.id,name:Y.label||"محفظة بدون اسم",phone:Y.msisdn,isDefault:!1,monthlyWithdrawalLimit:Y.monthlyWithdrawalLimit??Y.withdrawLimit??2e5,monthlyTransferLimit:Y.monthlyTransferLimit??Y.transferLimit??2e5,defaultTransferCommission:Y.defaultTransferCommission!=null?Number(Y.defaultTransferCommission):null,defaultWithdrawCommission:Y.defaultWithdrawCommission!=null?Number(Y.defaultWithdrawCommission):null}));Kt(F),localStorage.setItem(ks(),JSON.stringify(F));const L=localStorage.getItem(us());let T=null;L&&F.find(Y=>Y.id===L)?T=F.find(Y=>Y.id===L):T=F[0],T&&(Dt(T.id),Pe(T.phone)),console.log("🔄 تم تحديث المحافظ من Firebase وحفظها في localStorage")}else{console.log("⚠️ لا توجد محافظ في Firebase، محاولة التحميل من localStorage...");const F=Cr();if(F&&F.length>0)try{console.log("📱 تم العثور على محافظ محلية بعد الهجرة:",F.length),Kt(F);const L=Ir(F)||localStorage.getItem(us());let T=null;L&&F.find(Y=>Y.id===L)?T=F.find(Y=>Y.id===L):T=F.find(Y=>Y.isDefault)||F[0],T&&(Dt(T.id),Pe(T.phone))}catch(L){console.error("خطأ في معالجة المحافظ بعد الهجرة:",L)}else console.log("⚠️ لا توجد محافظ محلية، لن نقوم بإنشاء محافظ افتراضية."),Kt([])}}catch(w){console.error("خطأ في تحميل المحافظ من Firebase:",w);const F=Cr();if(F&&F.length>0)try{console.log("📱 استخدام المحافظ من localStorage بعد الهجرة:",F.length),Kt(F);const L=Ir(F)||localStorage.getItem(us());let T=null;L&&F.find(Y=>Y.id===L)?T=F.find(Y=>Y.id===L):T=F.find(Y=>Y.isDefault)||F[0],T&&(Dt(T.id),Pe(T.phone))}catch(L){console.error("خطأ في قراءة المحافظ من localStorage بعد الهجرة:",L),Kt([])}else console.log("⚠️ لا توجد محافظ محلية، لن يتم إنشاء محافظ افتراضية"),Kt([])}const A=t!=null&&t.uid?await je.getUserTransactions(t.uid):[];if(A&&A.length>0){console.log("📊 تم تحميل المعاملات من Firebase:",A.length);const w=A.map(T=>({...T,createdAt:new Date(T.createdAt),senderPhone:T.senderMsisdn||T.senderPhone||"",receiverPhone:T.receiverMsisdn||T.receiverPhone||"",type:T.txnType==="send"?"send":T.txnType==="receive"?"withdraw":T.type||"withdraw",status:T.status==="confirmed"?"completed":T.status||"completed"})),F=on.map(T=>T.id||T.originalTransactionId),L=w.filter(T=>!F.includes(T.id));console.log("✅ تم فلترة المعاملات المحذوفة:",{total:A.length,deleted:F.length,active:L.length}),it(L)}await _n()}catch(i){console.error("خطأ في تحميل بيانات المستخدم من Firebase:",i);let c=localStorage.getItem(Ve());if(!c&&(t!=null&&t.uid)){const v=`userCashBalance_${t.uid}`,S=localStorage.getItem(v);if(S){c=S;try{localStorage.setItem(Ve(),S),localStorage.removeItem(v)}catch{}}}c&&Qe(parseFloat(c));const y=localStorage.getItem(Ue());if(y)try{const v=JSON.parse(y);Be(v),console.log("📱 تم استعادة أرصدة المحافظ من localStorage:",v)}catch(v){console.error("خطأ في قراءة أرصدة المحافظ من localStorage:",v)}}})().then(async()=>{await n(),await r()});const n=async()=>{try{for(const i of ye)await ec.autoResetLimitsIfNeeded(i.phone)}catch(i){console.error("خطأ في التصفير التلقائي للحدود:",i)}},r=async()=>{try{const i=$t.getReportsData(t==null?void 0:t.uid);if((i.lastDailyResetDate?$t.shouldResetDailyReports(i.lastDailyResetDate):!1)&&(t!=null&&t.uid)&&i.lastDailyResetDate){const v=new Date(i.lastDailyResetDate),S=v.toDateString();let O=Se.filter(tt=>new Date(tt.createdAt).toDateString()===S&&tt.status==="completed");const A=$t.filterVisibleTransactions(O,"daily",t==null?void 0:t.uid),w=A.length,F=A.reduce((tt,ae)=>tt+ae.amount,0),L=A.filter(Qs).reduce((tt,ae)=>{const Me=ae.withdrawnAmount!==void 0?ae.withdrawnAmount:ae.amount;return tt+Me},0),T=A.filter(Zs).reduce((tt,ae)=>{const Me=ae.sentAmount!==void 0?ae.sentAmount:ae.amount;return tt+Me},0),Y=A.reduce((tt,ae)=>tt+$t.calculateTransactionProfit(ae),0),Ce=new Date(v).toISOString().slice(0,10);await pl.add({userId:t.uid,reportDate:Ce,totalTransactions:w,totalAmount:Number(F.toFixed(2)),totalWithdrawn:Number(L.toFixed(2)),totalSent:Number(T.toFixed(2)),profit:Number(Y.toFixed(2)),walletId:null}),l({title:"تم أرشفة تقارير اليوم",description:Ce})}const y=$t.autoResetReportsIfNeeded(t==null?void 0:t.uid);(y.dailyReset||y.monthlyReset)&&console.log("تم التصفير التلقائي:",y)}catch(i){console.error("خطأ في التصفير التلقائي للتقارير:",i)}};Oi(),ki(),Ji(),console.log("🔥 useEffect loadUserData completed")},[t==null?void 0:t.uid]);const Pa=async()=>{var s;if(t!=null&&t.uid)try{const n=await ns.getByMerchantId(t.uid);if(n&&n.length>0){const r=n.map(i=>({id:i.id,name:i.label||"محفظة بدون اسم",phone:i.msisdn,isDefault:!1,monthlyWithdrawalLimit:i.monthlyWithdrawalLimit??i.withdrawLimit??2e5,monthlyTransferLimit:i.monthlyTransferLimit??i.transferLimit??2e5,defaultTransferCommission:i.defaultTransferCommission!=null?Number(i.defaultTransferCommission):void 0,defaultWithdrawCommission:i.defaultWithdrawCommission!=null?Number(i.defaultWithdrawCommission):void 0}));if(Kt(r),localStorage.setItem(ks(),JSON.stringify(r)),t!=null&&t.uid){const i=localStorage.getItem(us());if(!!(U&&r.find(y=>y.id===U)))console.log("🔒 Preserving current wallet selection:",U);else{const v=(i&&r.find(S=>S.id===i)?i:null)||((s=r[0])==null?void 0:s.id);v&&(console.log("🔄 Fixing invalid wallet selection:",v),Gs(v))}}console.log("🔄 تم تحديث المحافظ من Firebase:",r.length)}}catch(n){console.error("خطأ في تحميل المحافظ من Firebase:",n)}};a.useEffect(()=>{const s=h.pathname;sessionStorage.getItem("previousPath")==="/user/add-wallet"&&s==="/user/dashboard"&&(console.log("🔄 Returning from add wallet page - reloading wallets"),console.log("🔒 Current wallet before add-wallet return reload:",U),Pa(),sessionStorage.removeItem("previousPath")),sessionStorage.setItem("previousPath",s)},[h.pathname,t==null?void 0:t.uid]),a.useEffect(()=>{const s=()=>{console.log("🔄 Window focused - reloading wallets"),console.log("🔒 Current wallet before focus reload:",U),Pa().then(()=>{console.log("🔒 Wallet preserved after focus reload:",U)})};return window.addEventListener("focus",s),()=>{window.removeEventListener("focus",s)}},[t==null?void 0:t.uid,U,ye]);const Gs=(s,n="unknown")=>{console.log(`🎯 setWalletSelection called from ${n} with walletId:`,s),console.log("🔍 Previous selectedWallet:",U),Dt(s);const r=ye.find(i=>i.id===s);r&&(Pe(r.phone),console.log("✅ Wallet set successfully:",s,"Phone:",r.phone)),t!=null&&t.uid&&(localStorage.setItem(us(),s),console.log("💾 Saved wallet to localStorage:",s))},ro=s=>{if(s==="__add_wallet"){C("/user/add-wallet");return}if(s==="__view_wallets"){Rs(!0);return}Gs(s,"handleWalletChange")},Yn=s=>{console.log("🔄 handleTransactionTypeChange called with type:",s),console.log("🔍 Current selectedWallet before change:",U),console.log("🔍 Available wallets count:",ye.length),Ge(s),lt(""),ft(""),Us(""),Cs(""),console.log("✅ Transaction type changed to:",s,"- Wallet selection preserved:",U),setTimeout(()=>{const n=document.getElementById("transaction-section");n&&n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})},100)},no=s=>{si((r=>({id:r.id,type:r.type==="send"?"transfer":"withdraw",sender_msisdn:r.senderPhone,receiver_msisdn:r.receiverPhone,amount:r.amount,commission:r.commission||0,status:r.status==="failed"?"failed":r.status==="completed"?"completed":"pending",createdAt:new Date(r.createdAt).toISOString(),updatedAt:new Date(r.createdAt).toISOString(),shopName:x??(m==null?void 0:m.shopName)??(t==null?void 0:t.displayName)??"المحل",cashierName:(r==null?void 0:r.cashierName)??null,commissionMode:(r==null?void 0:r.commissionMode)??(r.type==="send"||b?"add":"deduct"),totalCharged:(r==null?void 0:r.totalCharged)??(r.type==="send"||b?Number(r.amount||0)+Number(r.commission||0):Number(r.amount||0))}))(s)),ma(!0)},lo=async s=>{if(!(t!=null&&t.uid)){l({title:"خطأ في المصادقة",description:"يجب تسجيل الدخول أولاً لحذف المعاملات",variant:"destructive"});return}const n=Se.find(r=>r.id===s);if(!n){l({title:"خطأ في الحذف",description:"لم يتم العثور على المعاملة المطلوب حذفها",variant:"destructive"});return}try{console.log("🗑️ بدء عملية حذف المعاملة:",s),console.log("🔄 حذف المعاملة نهائياً من Firebase...",{transactionId:n.id,userId:t.uid,transactionData:n}),await je.removeUserTransaction(t.uid,n.id),console.log("✅ تم حذف المعاملة نهائياً من Firebase userTransactions");try{await Fa.saveDeletedTransaction({...n,userId:t.uid,originalTransactionId:n.id,deletedAt:new Date().toISOString()}),console.log("✅ تم حفظ المعاملة في سجل المحذوفات مع تاريخ الحذف")}catch(c){console.warn("⚠️ فشل في حفظ المعاملة في سجل المحذوفات، لكن الحذف من Firebase نجح:",c)}const r=[...on,n],i=Se.filter(c=>c.id!==s);ms(r),it(i),rn(!1),localStorage.setItem(Hs(),JSON.stringify(r)),localStorage.setItem(Ys(),JSON.stringify(i)),console.log("✅ تم تحديث البيانات المحلية بنجاح بعد الحذف من Firebase");try{let c=localStorage.getItem(Ve());if(!c&&(t!=null&&t.uid)){const O=`userCashBalance_${t.uid}`,A=localStorage.getItem(O);if(A){c=A;try{localStorage.setItem(Ve(),A),localStorage.removeItem(O)}catch{}}}const y=localStorage.getItem(Ue());let v=c?parseFloat(c):0,S=y?JSON.parse(y):{};if(n.type==="send"){const O=n.commission||0;v-=O;const A=n.fromWallet||Object.keys(S)[0];if(A){const w=S[A]||0;S[A]=w+n.amount}}else if(n.type==="withdraw"){const O=n.commission||0;v+=n.amount,v-=O;const A=n.fromWallet||Object.keys(S)[0];if(A){const w=S[A]||0;S[A]=Math.max(0,w-n.amount)}}localStorage.setItem(Ve(),v.toString()),localStorage.setItem(Ue(),JSON.stringify(S))}catch(c){console.warn("فشل عكس تأثير الأرصدة محليًا بعد الحذف:",c)}try{const c=n.fromWallet;if(c){const{walletDailyLimitsService:y}=await rs(async()=>{const{walletDailyLimitsService:S}=await import("./walletDailyLimitsService-CGHLknt6.js");return{walletDailyLimitsService:S}},__vite__mapDeps([2,0,1])),v=await y.getWalletLimits(c);if(v){const S=n.type==="send",O={updatedAt:(await rs(async()=>{const{serverTimestamp:T}=await import("./index-Drf-Kel-.js").then(Y=>Y.a_);return{serverTimestamp:T}},__vite__mapDeps([0,1]))).serverTimestamp()};S?(O.dailyTransferUsed=Math.max(0,(v.dailyTransferUsed||0)-n.amount),O.monthlyTransferUsed=Math.max(0,(v.monthlyTransferUsed||0)-n.amount)):(O.dailyWithdrawUsed=Math.max(0,(v.dailyWithdrawUsed||0)-n.amount),O.monthlyWithdrawUsed=Math.max(0,(v.monthlyWithdrawUsed||0)-n.amount));const{doc:A,setDoc:w}=await rs(async()=>{const{doc:T,setDoc:Y}=await import("./index-Drf-Kel-.js").then(Ce=>Ce.a_);return{doc:T,setDoc:Y}},__vite__mapDeps([0,1])),{db:F}=await rs(async()=>{const{db:T}=await import("./index-Drf-Kel-.js").then(Y=>Y.a$);return{db:T}},__vite__mapDeps([0,1])),L=A(F,"walletLimits",c);await w(L,O,{merge:!0})}}}catch(c){console.warn("فشل استرجاع حدود المحفظة بعد الحذف:",c)}try{const{ProfitService:c}=await rs(async()=>{const{ProfitService:A}=await import("./profitService-WOL_cZ8K.js");return{ProfitService:A}},__vite__mapDeps([3,4])),{ReportsService:y}=await rs(async()=>{const{ReportsService:A}=await import("./reportsService-Bp1Io21u.js");return{ReportsService:A}},[]),S={txnType:n.type==="send"?"send":"receive",amount:n.amount,commission:n.commission||0,createdAt:n.createdAt,status:"confirmed"},O=c.calculateProfitFromTransaction(S);O>0&&c.addProfit(-O,t.uid);try{y.removeTransactionEffects(n,t.uid)}catch{}}catch(c){console.warn("فشل تحديث الأرباح/التقارير بعد الحذف:",c)}l({title:"تم حذف المعاملة نهائياً",description:"تم حذف المعاملة نهائياً من النظام. يمكنك العثور عليها في قائمة المحذوفات"})}catch(r){console.error("❌ خطأ في حذف المعاملة من Firebase:",r);let i="فشل في حذف المعاملة من الخادم. يرجى المحاولة مرة أخرى";r instanceof Error&&(r.message.includes("network")||r.message.includes("offline")?i="مشكلة في الاتصال بالإنترنت. تحقق من الاتصال وحاول مرة أخرى":r.message.includes("permission")||r.message.includes("unauthorized")?i="ليس لديك صلاحية لحذف هذه المعاملة":r.message.includes("not-found")&&(i="المعاملة غير موجودة أو تم حذفها مسبقاً")),l({title:"خطأ في الحذف",description:i,variant:"destructive"})}},Qs=s=>{const n=s.type,r=s.txnType;return n==="withdraw"||n==="withdrawal"||n==="receive"||r==="receive"},Zs=s=>{const n=s.type,r=s.txnType;return n==="send"||n==="transfer"||r==="send"},Oa=(s,n)=>{const r=new Date().toDateString();let i=Se.filter(A=>new Date(A.createdAt).toDateString()===r&&A.status==="completed");as&&as.trim()!==""&&(i=i.filter(A=>A.senderPhone&&A.senderPhone.includes(as)||A.receiverPhone&&A.receiverPhone.includes(as)));const c=$t.filterVisibleTransactions(i,"daily",t==null?void 0:t.uid),y=c.length,v=c.reduce((A,w)=>A+w.amount,0),S=c.filter(Qs).reduce((A,w)=>{const F=w.withdrawnAmount!==void 0?w.withdrawnAmount:w.amount;return A+F},0),O=c.filter(Zs).reduce((A,w)=>{const F=w.sentAmount!==void 0?w.sentAmount:w.amount;return A+F},0);return{totalTransactions:y,totalAmount:v,totalWithdrawn:S,totalSent:O}},Xs=s=>{const n=new Date().getMonth(),r=new Date().getFullYear();let i=Se.filter(A=>{const w=new Date(A.createdAt);return w.getMonth()===n&&w.getFullYear()===r&&A.status==="completed"});as&&as.trim()!==""&&(i=i.filter(A=>A.senderPhone&&A.senderPhone.includes(as)||A.receiverPhone&&A.receiverPhone.includes(as)));const c=$t.filterVisibleTransactions(i,"monthly",t==null?void 0:t.uid),y=c.length,v=c.reduce((A,w)=>A+w.amount,0),S=c.filter(Qs).reduce((A,w)=>{const F=w.withdrawnAmount!==void 0?w.withdrawnAmount:w.amount;return A+F},0),O=c.filter(Zs).reduce((A,w)=>{const F=w.sentAmount!==void 0?w.sentAmount:w.amount;return A+F},0);return{totalTransactions:y,totalAmount:v,totalWithdrawn:S,totalSent:O}},Hn=s=>{const n=new Date().getMonth(),r=new Date().getFullYear(),i=Se.filter(v=>{const S=new Date(v.createdAt);return S.getMonth()===n&&S.getFullYear()===r&&v.status==="completed"&&v.fromWallet===s}),c=i.filter(Qs).reduce((v,S)=>{const O=S.withdrawnAmount||S.amount;return v+O},0),y=i.filter(Zs).reduce((v,S)=>{const O=S.sentAmount||S.amount;return v+O},0);return{totalWithdrawn:c,totalTransferred:y}},io=s=>{const n=new Date,r=n.getDate(),i=n.getMonth(),c=n.getFullYear(),y=Se.filter(O=>{const A=new Date(O.createdAt);return A.getDate()===r&&A.getMonth()===i&&A.getFullYear()===c&&O.status==="completed"&&O.fromWallet===s}),v=y.filter(Qs).reduce((O,A)=>{const w=A.withdrawnAmount||A.amount;return O+w},0),S=y.filter(Zs).reduce((O,A)=>{const w=A.sentAmount||A.amount;return O+w},0);return{totalWithdrawn:v,totalTransferred:S}};Xs(),a.useEffect(()=>{const s=localStorage.getItem(Ys());if(s){const r=JSON.parse(s).map(i=>({...i,createdAt:new Date(i.createdAt)}));it(r)}},[]),a.useEffect(()=>{Se.length>0&&localStorage.setItem(Ys(),JSON.stringify(Se))},[Se]);const Gn=async()=>{td(),console.log("🔄 بدء عملية التحويل/السحب"),console.log("📊 البيانات المدخلة:",{senderPhone:pe,receiverPhone:nt,amount:He,transactionType:G});const s=()=>{G==="transfer"?Is(!0):zs(!0)},n=()=>{G==="transfer"?Is(!1):zs(!1)};if(s(),!pe||!He){console.log("❌ خطأ: بيانات ناقصة"),l({title:"خطأ في البيانات",description:"يرجى ملء جميع الحقول المطلوبة",variant:"destructive"}),n();return}if(G==="transfer"&&!nt&&!f){console.log("❌ خطأ: رقم المستقبل مفقود"),l({title:"خطأ في البيانات",description:"يرجى إدخال رقم المستقبل",variant:"destructive"}),n();return}if(G==="transfer"&&!f&&!sd(nt)){l({title:"رقم المستقبل غير صالح",description:"اكتب رقم صحيح مكون من 11 رقم ويبدأ بـ 015 أو 010 أو 012 أو 011",variant:"destructive"}),n();return}const r=parseFloat(He);if(console.log("💰 المبلغ المحول:",r),r<=0){console.log("❌ خطأ: مبلغ غير صحيح"),l({title:"خطأ في المبلغ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"}),n();return}if(qe)try{const ae=new Date,Me=ae.getFullYear(),At=String(ae.getMonth()+1).padStart(2,"0"),at=String(ae.getDate()).padStart(2,"0"),Yt=`zeroPlanDailyConfirmCount:${(t==null?void 0:t.uid)||"default"}:${Me}-${At}-${at}`,Mt=localStorage.getItem(Yt);if((Mt&&parseInt(Mt,10)||0)>=10){l({title:"حد التأكيد اليومي",description:"باقة زيرو تسمح بـ 10 تأكيدات تحويل/سحب يومياً فقط.",variant:"destructive"}),n();return}}catch(ae){console.warn("فشل قراءة عداد تأكيدات باقة زيرو من التخزين المحلي:",ae)}const i=ye.find(ae=>ae.id===U);if(!i){l({title:"خطأ في المحفظة",description:"يرجى اختيار محفظة صحيحة",variant:"destructive"}),n();return}const c=Hn(U);if(console.log("📈 فحص الحدود الشهرية للمحفظة المختارة"),console.log("📊 الإحصائيات الشهرية للمحفظة:",{walletId:U,walletName:i.name,currentWithdrawn:c.totalWithdrawn,currentTransferred:c.totalTransferred,withdrawalLimit:i.monthlyWithdrawalLimit,transferLimit:i.monthlyTransferLimit}),G==="withdraw"){if(console.log("🏧 فحص حد السحب الشهري للمحفظة"),console.log(`💸 المسحوب حالياً من المحفظة: ${c.totalWithdrawn}, المبلغ الجديد: ${r}, الحد الأقصى: ${i.monthlyWithdrawalLimit}`),c.totalWithdrawn+r>i.monthlyWithdrawalLimit){console.log("❌ تجاوز حد السحب الشهري للمحفظة"),l({title:"تجاوز حد السحب الشهري",description:`لا يمكن سحب أكثر من ${i.monthlyWithdrawalLimit} جنيه شهرياً من محفظة ${i.name}`,variant:"destructive"}),n();return}}else if(console.log("💸 فحص حد التحويل الشهري للمحفظة"),console.log(`📤 المحول حالياً من المحفظة: ${c.totalTransferred}, المبلغ الجديد: ${r}, الحد الأقصى: ${i.monthlyTransferLimit}`),c.totalTransferred+r>i.monthlyTransferLimit){console.log("❌ تجاوز حد التحويل الشهري للمحفظة"),l({title:"تجاوز حد التحويل الشهري",description:`لا يمكن تحويل أكثر من ${i.monthlyTransferLimit} جنيه شهرياً من محفظة ${i.name}`,variant:"destructive"}),n();return}const y=(m==null?void 0:m.shopName)||(t==null?void 0:t.displayName)||"محل كاشي لينك",v={id:Date.now().toString(),type:G==="transfer"?"send":G==="deposit"?"deposit":"withdraw",senderPhone:pe,receiverPhone:G==="transfer"?nt:pe,amount:r,status:"completed",createdAt:new Date,withdrawnAmount:G==="withdraw"?r:void 0,sentAmount:G==="transfer"?r:void 0,depositedAmount:void 0,fromWallet:U,senderNumber:pe,senderName:pe,shopName:(i==null?void 0:i.name)||"المحفظة الرئيسية",transferredAmount:G==="transfer"?r:void 0,receiverNumber:G==="transfer"?nt:void 0,withdrawnAmountDetailed:G==="withdraw"?r:void 0,depositedAmountDetailed:void 0,merchantShopName:y,transactionReference:`TXN-${Date.now()}`,commission:0,notes:G==="transfer"?`تحويل من ${pe} إلى ${nt}`:`سحب نقدي من محفظة ${pe}`};M&&(u!=null&&u.name||u!=null&&u.username)&&(v.cashierName=(u==null?void 0:u.name)||(u==null?void 0:u.username));const S=Es.validateTransaction(r,G,Ee,ve);if(!S.isValid){l({title:"خطأ في العملية",description:S.error,variant:"destructive"}),n();return}S.warning&&l({title:"تحذير",description:S.warning,variant:"destructive"});let O;if(G==="transfer")if((i==null?void 0:i.defaultTransferCommission)!=null){const ae=Number(i.defaultTransferCommission)||0;O=Math.round(ae*r/1e3*100)/100}else mt&&mt.trim()!==""?O=Math.max(0,parseFloat(mt)):O=0;else if((i==null?void 0:i.defaultWithdrawCommission)!=null){const ae=Number(i.defaultWithdrawCommission)||0;O=Math.round(ae*r/1e3*100)/100}else dt&&dt.trim()!==""?O=Math.max(0,parseFloat(dt)):O=Math.round(r*.01*100)/100;if(v.commission=O,G!=="transfer"&&!b&&O>=r){l({title:"خطأ في العمولة",description:"العمولة أكبر من أو تساوي المبلغ المدخل",variant:"destructive"}),n();return}const A=G==="transfer"||b?r:Math.round((r-O)*100)/100;v.amount=A,v.withdrawnAmount=G==="withdraw"?A:void 0,v.sentAmount=G==="transfer"?A:void 0,v.transferredAmount=G==="transfer"?A:void 0,v.withdrawnAmountDetailed=G==="withdraw"?A:void 0;let w;const F=G==="transfer"&&!!St,L=G==="withdraw"&&!!St,T=F||L;let Y=null;if(T)if(F){const ae=Es.validateTransaction(A,"transfer",Ee,ve);ae.isValid?w={success:!0,newCashBalance:Ee,newWalletBalances:ve}:w={success:!1,newCashBalance:Ee,newWalletBalances:ve,message:ae.error||"رصيد غير كافٍ للتحويل المؤجل",error:"INSUFFICIENT_WALLET_BALANCE"}}else w={success:!0,newCashBalance:Ee,newWalletBalances:ve};else G==="transfer"?w=await Es.processTransfer({amount:A,currentCashBalance:Ee,currentWalletBalances:ve,wallets:ye,selectedWalletId:U,skipRemoteLimitsCheck:!0,nonBlockingUsageUpdate:!0}):w=await Es.processWithdraw({amount:A,currentCashBalance:Ee,currentWalletBalances:ve,wallets:ye,selectedWalletId:U,skipRemoteLimitsCheck:!0,nonBlockingUsageUpdate:!0});if(!w.success){l({title:"فشل في العملية",description:w.error||w.message,variant:"destructive"}),n();return}let Ce=T?Ee:w.newCashBalance,tt=T?ve:w.newWalletBalances;if(T&&L){const ae=ye.find(at=>at.id===U)??ye.find(at=>at.isDefault)??ye[0],Me=(ae==null?void 0:ae.id)||U;if(Me!==U)try{Gs(Me)}catch{}const At=Number(ve[Me]||0);tt={...ve,[Me]:Math.round((At+Number(A))*100)/100};try{const at=`walletEffectsAppliedOnCreation_${(t==null?void 0:t.uid)||"default"}`,Yt=localStorage.getItem(at),Mt=Yt?JSON.parse(Yt):[];v!=null&&v.id&&!Mt.includes(v.id)&&(Mt.push(v.id),localStorage.setItem(at,JSON.stringify(Mt)))}catch{}}if(T&&F){const ae=ye.find(at=>at.id===U)??ye.find(at=>at.isDefault)??ye[0],Me=(ae==null?void 0:ae.id)||U;if(Me!==U)try{Gs(Me)}catch{}const At=Number(ve[Me]||0);tt={...ve,[Me]:Math.round((At-Number(A))*100)/100}}if((F||L)&&St&&!qa){const ae={id:`DEBT-${Date.now()}`,debtorName:St.debtorName,amount:St.amount,reason:St.notes||"",customerId:St.customerId,mobile:St.mobile,status:"pending",createdAt:new Date};Y=ae.id;const Me=[ae,...yt];Et(Me);try{await qt(Me)}catch(At){console.error("⚠️ فشل حفظ الدين المؤجل محلياً:",At)}l({title:"تم إضافة الدين",description:"أضيف إلى إيصالات الديون حتى يتم السداد",variant:"default"})}if(O>0&&!T&&(Ce+=O,console.log(`💰 تم إضافة عمولة ${O} جنيه لدرج النقدية`)),console.log("⚡ تحديث الواجهة فوراً..."),Qe(Ce),Be(tt),T&&(v.status="pending"),it(ae=>[v,...ae]),qe)try{const ae=new Date,Me=ae.getFullYear(),At=String(ae.getMonth()+1).padStart(2,"0"),at=String(ae.getDate()).padStart(2,"0"),Yt=`zeroPlanDailyConfirmCount:${(t==null?void 0:t.uid)||"default"}:${Me}-${At}-${at}`,Mt=localStorage.getItem(Yt),Wa=Mt&&parseInt(Mt,10)||0;localStorage.setItem(Yt,String(Wa+1))}catch{}if(localStorage.setItem(Ve(),Ce.toString()),localStorage.setItem(Ue(),JSON.stringify(tt)),(async()=>{try{console.log("🔄 بدء حفظ المعاملة في Firebase في الخلفية...");const ae={shopId:(m==null?void 0:m.shopId)||(t==null?void 0:t.uid)||"default-shop",lineId:U||"default-line",merchantUserId:(t==null?void 0:t.uid)||null,provider:"vodafone_cash",txnType:G==="transfer"?"send":"receive",amount:A,commission:O,profit:0,senderMsisdn:pe,receiverMsisdn:G==="transfer"?nt:pe,note:G==="transfer"?`تحويل من ${pe} إلى ${nt}`:`سحب ${A} جنيه من ${(i==null?void 0:i.name)||"المحفظة الرئيسية"}`,status:T?"pending":"confirmed",linkedDebtId:Y||void 0,createdBy:(t==null?void 0:t.uid)||null,walletEffectAppliedOnCreation:!!(T&&L)},Me={...ae,status:T?"pending":"completed",commissionMode:G==="transfer"||b?"add":"deduct",totalCharged:G==="transfer"||b?A+O:A,walletEffectAppliedOnCreation:!!(T&&L),createdAt:new Date},{ProfitService:At}=await rs(async()=>{const{ProfitService:Wa}=await import("./profitService-WOL_cZ8K.js");return{ProfitService:Wa}},__vite__mapDeps([3,4])),at=At.calculateProfitFromTransaction(Me);at>0&&(At.addProfit(at,t==null?void 0:t.uid),console.log("✅ تم إضافة الربح:",at,"جنيه")),await Promise.all([...t!=null&&t.uid?[je.updateUserData(t.uid,{cashBalance:Ce,walletBalances:tt,lastUpdated:new Date().toISOString()})]:[],Ja.create(ae),...t!=null&&t.uid?[je.saveUserTransaction(t.uid,{...Me,transactionType:G,fromWallet:U,toWallet:G==="transfer"?F?null:"cash":null,cashierName:M&&((u==null?void 0:u.name)||(u==null?void 0:u.username))||"الحساب الرئيسي",linkedDebtId:Y||void 0,description:`${G==="transfer"?"تحويل":"سحب"} ${A} من ${U} ${G==="transfer"?F?"":"إلى الدرج النقدي":""} — عمولة: ${O} (${G==="transfer"||b?"مضافة":"مخصومة"})${T?" — دين مؤجل (قيد المراجعة)":""}`})]:[]]),console.log("✅ تم حفظ جميع البيانات في Firebase بنجاح");const Yt=`userData_${t==null?void 0:t.uid}`,Mt={cashBalance:Ce,walletBalances:tt,lastUpdated:new Date().toISOString()};localStorage.setItem(Yt,JSON.stringify(Mt))}catch(ae){console.error("❌ خطأ في حفظ المعاملة في Firebase (في الخلفية):",ae),l({title:"تحذير",description:"تم تنفيذ العملية محلياً، لكن فشلت المزامنة مع الخادم. ستتم المحاولة مرة أخرى تلقائياً.",variant:"destructive"})}})(),G==="transfer"){Is(!0);const ae=Number(r)+Number(O);Xa({type:"transfer",amount:Math.max(0,Math.round(ae*100)/100)}),ua(!0),setTimeout(()=>{Is(!1)},2e3)}else{zs(!0);const ae=b?Number(r):Math.max(0,Math.round((Number(r)-Number(O))*100)/100);Xa({type:"withdraw",amount:Math.max(0,Math.round(ae*100)/100)}),ua(!0),setTimeout(()=>{zs(!1)},2e3)}lt(""),ft(""),os(null),ws(""),Bt(""),Ds(""),cs(!1)},$r=ot.useMemo(()=>new Intl.DateTimeFormat("ar-EG"),[]),oo=ot.useMemo(()=>new Intl.DateTimeFormat("ar-EG",{hour:"2-digit",minute:"2-digit"}),[]),co=ot.useMemo(()=>{try{return yt.reduce((s,n)=>{const r=Number(n.paidAmount||0),i=Math.max(0,Number(n.amount||0)-r);return s+i},0)}catch{return 0}},[yt]),Qn=ot.useMemo(()=>Kn().filter(n=>Re==="all"?!0:Re==="send"?n.type==="send":Re==="receive"?n.type==="receive":Re==="withdraw"?n.type==="withdraw":Re!=="deleted"),[Kn,Re]),mo=()=>{if(Ga==="daily"){const s=$t.resetReportsManually("daily",Se,t==null?void 0:t.uid);_s(!1),l({title:"تم تصفير المعاملات اليومية",description:`تم إخفاء ${s.length} معاملة من تقارير اليوم (الحدود لم تتأثر)`})}else{const s=$t.resetReportsManually("monthly",Se,t==null?void 0:t.uid);_s(!1),l({title:"تم تصفير المعاملات الشهرية",description:`تم إخفاء ${s.length} معاملة من تقارير الشهر (الحدود لم تتأثر)`})}},ho=()=>Ga==="daily"?"تصفير المعاملات اليومية":"تصفير المعاملات الشهرية",xo=()=>Ga==="daily"?"أدخل كلمة مرور تسجيل الدخول لتصفير جميع معاملات اليوم":"أدخل كلمة مرور تسجيل الدخول لتصفير جميع معاملات الشهر",uo=s=>{Bn(s),br(!0)},go=s=>{Qe(s),localStorage.setItem(Ve(),s.toString()),In(!1),l({title:"تم تحديث الرصيد النقدي",description:`تم تحديث الرصيد النقدي إلى ${s} جنيه`})},po=async s=>{var v;if(!bt){console.warn("لا يوجد معرف محفظة محدد لتعديل الرصيد");return}const n={...ve,[bt]:s};Be(n);const r=new Date().toISOString(),i={walletBalances:n,lastUpdated:r},c=`userData_${t==null?void 0:t.uid}`;try{localStorage.setItem(c,JSON.stringify(i)),localStorage.setItem(Ue(),JSON.stringify(n)),localStorage.setItem(`walletBalances_backup_${r}`,JSON.stringify(n))}catch{}try{t!=null&&t.uid&&await je.updateUserData(t.uid,i)}catch(S){console.error("خطأ أثناء حفظ رصيد المحفظة في Firebase:",S)}Tn(!1);const y=((v=ye.find(S=>S.id===bt))==null?void 0:v.name)||"المحفظة";l({title:"تم تحديث رصيد المحفظة",description:`تم تحديث رصيد ${y} إلى ${s.toLocaleString()} جنيه`})},fo=async s=>{var n;if(console.log("💰 بدء تحديث رصيد المحفظة"),console.log("📊 معرف المحفظة المحررة:",bt),console.log("💵 المبلغ المضاف/المخصوم:",s),bt){const r=ve[bt]||0;console.log("💰 الرصيد الحالي:",r);const i=r+s;console.log("💰 الرصيد الجديد:",i);const c={...ve,[bt]:i};console.log("📊 الأرصدة المحدثة:",c),Be(c);const y=new Date().toISOString(),v={walletBalances:c,lastUpdated:y},S=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(S,JSON.stringify(v)),localStorage.setItem(Ue(),JSON.stringify(c)),localStorage.setItem(`walletBalances_backup_${y}`,JSON.stringify(c));try{if(t!=null&&t.uid){console.log("🔄 حفظ البيانات في Firebase...");try{await je.updateUserData(t.uid,v),console.log("✅ تم حفظ الأرصدة في Firebase بنجاح"),setTimeout(()=>{localStorage.removeItem(S),console.log("🧹 تم حذف النسخة المحلية المؤقتة بعد دقيقة واحدة")},6e4)}catch(F){console.error("❌ فشل في حفظ البيانات في Firebase:",F),ge(!0)}}else console.log("⚠️ المستخدم غير مسجل دخول، حفظ في localStorage"),localStorage.setItem(Ue(),JSON.stringify(c));const O=((n=ye.find(F=>F.id===bt))==null?void 0:n.name)||"المحفظة",A=s>0?"إضافة":"خصم",w=Math.abs(s);l({title:`تم ${A} مبلغ ${A==="إضافة"?"إلى":"من"} رصيد المحفظة`,description:`تم ${A} ${w} جنيه ${A==="إضافة"?"إلى":"من"} رصيد ${O}. الرصيد الجديد: ${i.toLocaleString()} جنيه`})}catch(O){if(console.error("❌ فشل في حفظ البيانات في Firebase:",O),localStorage.setItem(Ue(),JSON.stringify(c)),t!=null&&t.uid){const A=`userData_${t.uid}`,w={walletBalances:c,lastUpdated:new Date().toISOString()};localStorage.setItem(A,JSON.stringify(w)),ge(!0)}l({title:"تم حفظ البيانات محلياً",description:"تم حفظ التغييرات محلياً وسيتم مزامنتها مع الخادم لاحقاً",variant:"default"})}}else console.log("❌ لا يوجد معرف محفظة للتحرير");setTimeout(()=>{const i=Object.keys(localStorage).filter(c=>c.startsWith("walletBalances_backup_")).sort();i.length>5&&i.slice(0,i.length-5).forEach(y=>{localStorage.removeItem(y),console.log("🗑️ حذف النسخة الاحتياطية القديمة:",y)})},5e3),br(!1),Bn("")};return console.log("🔥 UserDashboardPage - Render conditions:",{isCheckingActivation:D,isUserActive:q,showActivationModal:g}),!D&&!q?(console.log("🔥 UserDashboardPage - Showing activation modal"),e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center",children:e.jsx(il,{isOpen:!0,onClose:()=>{}})})):D?(console.log("🔥 UserDashboardPage - Showing loading screen"),e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center",children:e.jsx("div",{className:"text-center",children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"w-3 h-3 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 animate-bounce",style:{animationDelay:"0ms"}}),e.jsx("span",{className:"w-3 h-3 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 animate-bounce",style:{animationDelay:"150ms"}}),e.jsx("span",{className:"w-3 h-3 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 animate-bounce",style:{animationDelay:"300ms"}})]})})})):(console.log("🔥 UserDashboardPage - Rendering main dashboard"),e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-gray-50 via-blue-50/30 to-indigo-50/20 px-2 sm:px-4 py-2 sm:py-4 relative overflow-hidden",children:[e.jsxs("div",{className:"absolute inset-0 overflow-hidden pointer-events-none",children:[e.jsx("div",{className:"absolute top-10 sm:top-20 left-2 sm:left-10 w-32 sm:w-72 h-32 sm:h-72 bg-blue-400/8 rounded-full blur-3xl"}),e.jsx("div",{className:"absolute bottom-10 sm:bottom-20 right-2 sm:right-10 w-40 sm:w-96 h-40 sm:h-96 bg-purple-400/8 rounded-full blur-3xl",style:{animationDelay:"2s"}}),e.jsx("div",{className:"absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-36 sm:w-80 h-36 sm:h-80 bg-indigo-400/5 rounded-full blur-3xl",style:{animationDelay:"4s"}})]}),e.jsxs("div",{className:"max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-3 sm:gap-6 relative z-10",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-2 sm:space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 sm:grid-cols-2 sm:gap-3 fade-in-up",children:[!Js&&e.jsxs(_e,{className:"bg-gradient-to-br from-purple-50 via-purple-25 to-white border border-purple-200/60 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 group relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-purple-500/5 to-purple-600/3 opacity-0 group-hover:opacity-100 transition-opacity duration-300"}),e.jsx("div",{className:"absolute top-0 right-0 w-20 sm:w-32 h-20 sm:h-32 bg-gradient-to-br from-purple-300/15 to-transparent rounded-full -translate-y-8 sm:-translate-y-16 translate-x-8 sm:translate-x-16 group-hover:scale-110 transition-transform duration-300"}),e.jsx(ct,{className:"pb-2 sm:pb-1 lg:pb-1 px-3 sm:px-3 lg:px-2 pt-3 sm:pt-2 lg:pt-1 relative z-10",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Nt,{className:"text-xs font-bold text-purple-800 flex items-center gap-1.5 sm:gap-1",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"w-2.5 sm:w-2 h-2.5 sm:h-2 bg-gradient-to-r from-purple-500 to-purple-600 rounded-full shadow-sm"}),e.jsx("div",{className:"absolute inset-0 w-2.5 sm:w-2 h-2.5 sm:h-2 bg-purple-400 rounded-full opacity-60 animate-pulse"})]}),e.jsx("span",{className:"text-xs",children:"الشهر"})]}),e.jsxs("div",{className:"flex items-center gap-1 sm:gap-1",children:[e.jsx("div",{className:"hidden"}),e.jsx(o,{size:"sm",variant:"ghost",onClick:()=>{nn("monthly"),_s(!0)},className:"h-7 w-7 sm:h-6 sm:w-6 p-0 bg-gradient-to-r from-purple-100 to-purple-200 text-purple-700 hover:from-purple-200 hover:to-purple-300 hover:text-purple-800 rounded-lg sm:rounded-md transition-all duration-300 hover:scale-105 shadow-sm hover:shadow-md",title:"تصفير معاملات الشهر",children:e.jsx(It,{className:"h-3 w-3 sm:h-2.5 sm:w-2.5"})}),e.jsx("div",{className:"p-1.5 sm:p-1 bg-gradient-to-r from-purple-100 to-purple-200 rounded-lg sm:rounded-md",children:e.jsx(ta,{className:"h-3 w-3 sm:h-2.5 sm:w-2.5 text-purple-600"})})]})]})}),!Js&&e.jsxs(Ye,{className:"space-y-0.5 sm:space-y-1 lg:space-y-0 pt-0 px-2 sm:px-3 lg:px-2 pb-1.5 sm:pb-2 lg:pb-1 relative z-10",children:[e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-purple-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-purple-700",children:"عدد المعاملات:"}),e.jsx("span",{className:"font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:Xs().totalTransactions})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-purple-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-purple-700",children:"إجمالي المبالغ:"}),e.jsx("span",{className:"font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:Xs().totalAmount.toFixed(2)})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-purple-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-purple-700",children:"المسحوب:"}),e.jsx("span",{className:"font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:Xs().totalWithdrawn.toFixed(2)})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-purple-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-purple-700",children:"المرسل:"}),e.jsx("span",{className:"font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:Xs().totalSent.toFixed(2)})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-purple-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-purple-700",children:"الأرباح:"}),e.jsx(Kc,{userId:t==null?void 0:t.uid,transactions:Se})]})]}),gi&&e.jsx("div",{className:"absolute inset-0 z-20 bg-yellow-100/60 backdrop-blur-sm rounded-xl border border-yellow-300/70 flex items-center justify-center p-0 pointer-events-auto",children:e.jsxs(o,{size:"sm",variant:"ghost",onClick:async()=>{if(qe){l({title:"غير متاح",description:"تقارير الشهر غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"});return}ga(!0)},className:"px-2.5 py-1 rounded-full bg-gradient-to-r from-yellow-300 to-yellow-400 text-black hover:from-yellow-400 hover:to-yellow-500 shadow-md flex items-center gap-1 text-[11px] font-semibold",title:"عرض تقارير الشهر (يتطلب الرقم السري)",children:[e.jsx("span",{children:"عرض تقارير الشهر"}),e.jsx(Xe,{className:"h-2.5 w-2.5"})]})})]}),e.jsx(vs,{open:fi,onOpenChange:ga,mode:"verify",title:"الرقم السري لفتح تقارير الشهر",description:"لا يمكن الاطلاع على إحصائيات الشهر إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{if(qe){l({title:"غير متاح",description:"تقارير الشهر غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}),ga(!1),gn(!0);return}gn(!1),ga(!1)},userId:t==null?void 0:t.uid}),e.jsxs(_e,{className:"bg-gradient-to-br from-blue-50 via-blue-25 to-white border border-blue-200/60 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 group relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/5 to-blue-600/3 opacity-0 group-hover:opacity-100 transition-opacity duration-300"}),e.jsx("div",{className:"absolute top-0 right-0 w-20 sm:w-32 h-20 sm:h-32 bg-gradient-to-br from-blue-300/15 to-transparent rounded-full -translate-y-8 sm:-translate-y-16 translate-x-8 sm:translate-x-16 group-hover:scale-110 transition-transform duration-300"}),e.jsx(ct,{className:"pb-2 sm:pb-3 lg:pb-1 px-3 sm:px-4 lg:px-2 pt-3 sm:pt-4 lg:pt-1 relative z-10",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Nt,{className:"text-sm sm:text-base font-bold text-blue-800 flex items-center gap-1.5 sm:gap-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"w-2.5 sm:w-3 h-2.5 sm:h-3 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full shadow-sm"}),e.jsx("div",{className:"absolute inset-0 w-2.5 sm:w-3 h-2.5 sm:h-3 bg-blue-400 rounded-full opacity-60 animate-pulse"})]}),e.jsx("span",{className:"text-xs sm:text-sm",children:"اليوم"})]}),e.jsxs("div",{className:"flex items-center gap-1 sm:gap-1.5",children:[e.jsx(o,{size:"sm",variant:"ghost",onClick:()=>{nn("daily"),_s(!0)},className:"h-7 w-7 sm:h-8 sm:w-8 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded-lg transition-all duration-300 hover:scale-105 shadow-sm hover:shadow-md",title:"تصفير معاملات اليوم",children:e.jsx(It,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"})}),e.jsx(o,{size:"sm",variant:"ghost",onClick:()=>Qa(!0),className:"h-7 w-7 sm:h-8 sm:w-8 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded-lg transition-all duration-300 hover:scale-105 shadow-sm hover:shadow-md",title:"أرشيف التقارير اليومية",children:e.jsx(hc,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"})}),e.jsx(o,{size:"sm",variant:"ghost",onClick:()=>pi(s=>!s),className:"h-7 w-7 sm:h-8 sm:w-8 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded-lg transition-all duration-300 hover:scale-105 shadow-sm hover:shadow-md",title:Js?"توسيع اليوم والشهر":"طي اليوم والشهر",children:Js?e.jsx(tn,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"}):e.jsx(vl,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"})}),e.jsx("div",{className:"p-1.5 sm:p-2 bg-gradient-to-r from-blue-100 to-blue-200 rounded-lg",children:e.jsx(ta,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5 text-blue-600"})})]})]})}),!Js&&e.jsxs(Ye,{className:"space-y-0 pt-0 px-2 pb-1 relative z-10",children:[e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-blue-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-blue-700",children:"عدد المعاملات:"}),e.jsx("span",{className:"font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:Oa().totalTransactions})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-blue-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-blue-700",children:"إجمالي المبالغ:"}),e.jsx("span",{className:"font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:Oa().totalAmount.toFixed(2)})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-blue-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-blue-700",children:"المسحوب:"}),e.jsx("span",{className:"font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:Oa().totalWithdrawn.toFixed(2)})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-blue-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-blue-700",children:"المرسل:"}),e.jsx("span",{className:"font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:Oa().totalSent.toFixed(2)})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-blue-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-blue-700",children:"الأرباح:"}),e.jsx(Yc,{userId:t==null?void 0:t.uid})]})]}),vi&&e.jsx("div",{className:"absolute inset-0 z-20 bg-yellow-100/60 backdrop-blur-sm rounded-xl border border-yellow-300/70 flex items-center justify-center p-0 pointer-events-auto",children:e.jsxs(o,{size:"sm",variant:"ghost",onClick:()=>rr(!0),className:"px-2.5 py-1 rounded-full bg-gradient-to-r from-yellow-300 to-yellow-400 text-black hover:from-yellow-400 hover:to-yellow-500 shadow-md flex items-center gap-1 text-[11px] font-semibold",title:"عرض تقارير اليوم (يتطلب الرقم السري)",children:[e.jsx("span",{children:"عرض تقارير اليوم"}),e.jsx(Xe,{className:"h-2.5 w-2.5"})]})})]}),e.jsx(vs,{open:yi,onOpenChange:rr,mode:"verify",title:"الرقم السري لفتح تقارير اليوم",description:"لا يمكن الاطلاع على تقارير اليوم إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{pn(!1),rr(!1)},userId:t==null?void 0:t.uid})]}),e.jsxs(_e,{className:"bg-white border-2 border-gray-200/50 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 group relative overflow-hidden   transform fade-in-up mb-6",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-emerald-500/5 via-blue-500/5 to-emerald-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-200"}),e.jsx("div",{className:"absolute top-0 left-0 w-40 h-40 bg-gradient-to-br from-emerald-300/10 to-transparent rounded-full -translate-y-20 -translate-x-20 group-hover:scale-150 transition-transform duration-200"}),e.jsx("div",{className:"absolute bottom-0 right-0 w-40 h-40 bg-gradient-to-br from-blue-300/10 to-transparent rounded-full translate-y-20 translate-x-20 group-hover:scale-150 transition-transform duration-200"}),e.jsx(Ye,{className:"p-3 relative z-10",children:e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"bg-emerald-50 border-2 border-emerald-200/50 p-1 rounded-xl shadow-lg hover:shadow-md transition-all duration-200 group/cash relative overflow-hidden ",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-emerald-500/10 to-transparent opacity-0 group-hover/cash:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex items-center justify-between relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-emerald-100 to-emerald-200 rounded-lg shadow-sm",children:e.jsx(Ze,{className:"h-1.5 w-1.5 text-emerald-600"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] font-bold text-emerald-800",children:"الفلوس النقدية"}),e.jsxs("span",{className:"text-[10px] font-extrabold text-emerald-700 bg-gradient-to-r from-emerald-100 to-emerald-200 px-1 py-0.5 rounded-lg shadow-sm",children:[Ee.toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(o,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-green-100 to-green-200 text-green-700 hover:from-green-200 hover:to-green-300 hover:text-green-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>Da(!0),children:e.jsx(xt,{className:"h-2 w-2"})}),e.jsx(o,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800 rounded-xl transition-all duration-300  hover:rotate-12 shadow-md hover:shadow-lg",onClick:()=>Aa(!0),children:e.jsx(It,{className:"h-2 w-2"})})]})]})]}),e.jsxs("div",{className:"bg-blue-50 border-2 border-blue-200/50 p-1 rounded-xl shadow-lg hover:shadow-md transition-all duration-200 group/wallet relative overflow-hidden ",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/10 to-transparent opacity-0 group-hover/wallet:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex items-center justify-between relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-blue-100 to-blue-200 rounded-lg shadow-sm",children:e.jsx(Ut,{className:"h-1.5 w-1.5 text-blue-600"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] font-bold text-blue-800",children:"الأرصدة علي المحافظ"}),e.jsxs("span",{className:"text-[10px] font-extrabold text-blue-700 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-lg shadow-sm",children:[Object.values(ve).reduce((s,n)=>s+n,0).toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(o,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-green-100 to-green-200 text-green-700 hover:from-green-200 hover:to-green-300 hover:text-green-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>Ia(!0),title:"إضافة أموال لإجمالي المحفظة",children:e.jsx(xt,{className:"h-2 w-2"})}),e.jsx(o,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800 rounded-xl transition-all duration-300  hover:rotate-12 shadow-md hover:shadow-lg",onClick:()=>{Ta(!0),ka("")},title:"تصفير إجمالي المحفظة",children:e.jsx(It,{className:"h-2 w-2"})})]})]})]}),e.jsxs("div",{className:"col-span-2 sm:col-span-1 bg-indigo-50 border-2 border-indigo-200/50 p-1 rounded-xl shadow-lg hover:shadow-md transition-all duration-200 group/selwallet relative overflow-hidden ",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-indigo-500/10 to-transparent opacity-0 group-hover/selwallet:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex items-center justify-between relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-indigo-100 to-indigo-200 rounded-lg shadow-sm",children:e.jsx(Ut,{className:"h-1.5 w-1.5 text-indigo-600"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] font-bold text-indigo-800",children:"رصيد المحفظه"}),e.jsxs("span",{className:"text-[10px] font-extrabold text-indigo-700 bg-gradient-to-r from-indigo-100 to-indigo-200 px-1 py-0.5 rounded-lg shadow-sm",children:[(U&&ve[U]||0).toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(o,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-green-100 to-green-200 text-green-700 hover:from-green-200 hover:to-green-300 hover:text-green-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>{if(!U){l({title:"اختر محفظة",description:"يرجى اختيار محفظة من اختيار المحافظ بالأعلى أولاً",variant:"destructive"});return}uo(U)},title:"إضافة/خصم إلى رصيد المحفظة المختارة",children:e.jsx(xt,{className:"h-2 w-2"})}),e.jsx(o,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800 rounded-xl transition-all duration-300  hover:rotate-12 shadow-md hover:shadow-lg",onClick:()=>{if(!U){l({title:"اختر محفظة",description:"يرجى اختيار محفظة لتصفير رصيدها فقط",variant:"destructive"});return}ba(!0)},title:"تصفير رصيد المحفظة المختارة",children:e.jsx(It,{className:"h-2 w-2"})})]})]})]})]})})]}),e.jsxs(_e,{className:"bg-gradient-to-br from-gray-50 via-white to-slate-50 border border-gray-200/60 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 group relative overflow-hidden fade-in-up",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-gray-500/5 to-slate-600/3 opacity-0 group-hover:opacity-100 transition-opacity duration-300"}),e.jsxs(ct,{className:"pb-2 px-4 pt-4 relative z-10",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Nt,{className:"text-sm font-bold flex items-center gap-2 text-gray-800",children:[!p&&e.jsx("div",{className:"p-1.5 sm:p-2 bg-gradient-to-r from-gray-100 to-slate-200 rounded-lg",children:e.jsx(ta,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5 text-gray-600"})}),e.jsx("span",{className:"bg-gradient-to-r from-gray-600 to-slate-600 bg-clip-text text-transparent",children:"المعاملات الأخيرة"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[!p&&e.jsxs("div",{className:"flex items-center gap-0.5 bg-gray-50 rounded px-1 py-0.5 border border-gray-200 hover:border-blue-300 transition-all duration-200 group relative overflow-hidden max-w-[140px] md:max-w-[220px]",children:[e.jsx(Vo,{className:"h-2 w-2 text-gray-400 group-hover:text-blue-600 transition-colors"}),e.jsx($,{placeholder:"بحث...",value:cn,onChange:s=>oi(s.target.value),className:"h-3 text-[8px] border-0 bg-transparent focus:ring-0 focus:outline-none text-gray-700 placeholder:text-gray-400"})]}),!p&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"حاسبة"}),e.jsx(o,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105",onClick:()=>un(!0),title:"آلة حاسبة",children:e.jsx(Sl,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"كروت"}),e.jsx(o,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105",onClick:()=>{qe?l({title:"غير متاح",description:"كروت الائتمان غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):tr(!0)},title:"كروت الائتمان",children:e.jsx(za,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-blue-600 mb-1",children:"الوردية"}),e.jsx(o,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-blue-50 text-blue-600 hover:bg-blue-100 border border-blue-200 ring-3 ring-blue-300 transition-all duration-200 hover:scale-105",onClick:Ki,title:M&&(u!=null&&u.name||u!=null&&u.username)?`بروفيل الوردية: ${(u==null?void 0:u.name)||(u==null?void 0:u.username)}`:"وردية الكاشير",children:e.jsx(Qr,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"المبيعات"}),e.jsx(o,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105",onClick:()=>{qe?l({title:"غير متاح",description:"بيانات المبيعات غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):er(!0)},title:"بيانات المبيعات",children:e.jsx(Go,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsxs("div",{className:"flex items-center gap-1 mb-1",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600",children:"الديون"}),yt.filter(s=>s.status==="pending").length>0&&e.jsx("span",{className:"h-4 w-4 rounded-full bg-red-600 text-white text-[10px] flex items-center justify-center ring-2 ring-white",children:yt.filter(s=>s.status==="pending").length})]}),e.jsx(o,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105",onClick:()=>{qe?l({title:"غير متاح",description:"إدارة الديون/الأجل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):fa(!0)},title:"الديون",children:e.jsx(Oo,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-amber-700 mb-1",children:"الصيانة"}),e.jsx(o,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-amber-50 text-amber-700 hover:bg-amber-100 border border-amber-200 ring-3 ring-amber-300 transition-all duration-200 hover:scale-105",onClick:()=>{qe?l({title:"غير متاح",description:"الصيانة غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):sr(!0)},title:"الصيانة",children:e.jsx(Wo,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-yellow-500 mb-1",children:"المكنة"}),e.jsx(o,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-violet-50 text-violet-700 hover:bg-violet-100 border border-violet-200 ring-3 ring-violet-300 transition-all duration-200 hover:scale-105",onClick:()=>{gs?ar(!0):l({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"})},title:"يومية المكنة",children:e.jsx(Il,{className:"h-5 w-5 text-yellow-500"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-orange-600 mb-1",children:"مصروفات"}),e.jsx(o,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-orange-50 text-orange-600 hover:bg-orange-100 border border-orange-200 ring-3 ring-orange-300 transition-all duration-200 hover:scale-105",onClick:()=>{qe?l({title:"غير متاح",description:"مصروفات المحل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):ls.hasMasterPin()?J(!0):j(!0)},title:"مصروفات المحل",children:e.jsx($a,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-rose-600 mb-1",children:"النواقص"}),e.jsx(o,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-rose-50 text-rose-600 hover:bg-rose-100 border border-rose-200 ring-3 ring-rose-300 transition-all duration-200 hover:scale-105",onClick:()=>{qe?l({title:"غير متاح",description:"النواقص غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):xe(!0)},title:"النواقص",children:e.jsx(Fo,{className:"h-5 w-5"})})]})]})]})]}),!p&&e.jsx("div",{className:"mt-2 w-full",children:e.jsxs("div",{className:"flex items-center justify-center gap-3 bg-gray-50 rounded-md p-3 border border-gray-200",children:[e.jsx(o,{variant:"ghost",size:"sm",className:`h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${Re==="send"?"bg-green-600 text-white border-green-600":"text-green-700 border-green-300 hover:bg-green-50"}`,onClick:()=>ds("send"),title:"تصفية التحويل",children:"التحويل"}),e.jsx(o,{variant:"ghost",size:"sm",className:`h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${Re==="withdraw"?"bg-red-600 text-white border-red-600":"text-red-700 border-red-300 hover:bg-red-50"}`,onClick:()=>ds("withdraw"),title:"تصفية السحب",children:"السحب"}),e.jsx(o,{variant:"ghost",size:"sm",className:`h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${Re==="all"?"bg-green-600 text-white border-green-600":"text-green-700 border-green-300 hover:bg-green-50"}`,onClick:()=>ds("all"),title:"عرض الكل",children:"الكل"}),e.jsxs("div",{className:"relative ml-1",children:[e.jsxs(o,{variant:"ghost",size:"sm",className:"h-8 px-3 text-[12px] rounded-full border bg-red-50 text-red-700 border-red-300 hover:bg-red-100",onClick:()=>wr(!0),title:"تصفير المعاملات الأخيرة",children:[e.jsx(It,{className:"h-3.5 w-3.5 mr-1"}),"تصفير"]}),(t==null?void 0:t.uid)&&localStorage.getItem(`recentTransactionsResetAt:${t.uid}`)&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 h-2 w-2 rounded-full bg-red-500 ring-2 ring-white"})]})]})})]}),e.jsx(Ye,{className:"space-y-2 pt-0 px-4 pb-4 relative z-10",children:Qn.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(ta,{className:"h-12 w-12 mx-auto mb-2 text-gray-300"}),e.jsx("p",{className:"text-sm",children:"لا توجد معاملات حتى الآن"})]}):e.jsx("div",{className:"max-h-[210px] overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400 transition-colors",children:e.jsx("div",{className:"space-y-2 pr-2",children:Qn.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gradient-to-r from-white/70 to-gray-50/70 rounded-lg hover:from-white/90 hover:to-gray-50/90 transition-all duration-300 border border-gray-100/60 cursor-pointer hover:shadow-sm",onClick:()=>no(s),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[s.status==="completed"&&e.jsx(Qt,{className:"h-4 w-4 text-green-500"}),s.status==="pending"&&e.jsx(ys,{className:"h-4 w-4 text-yellow-500"}),s.status==="failed"&&e.jsx(sn,{className:"h-4 w-4 text-red-500"})]}),e.jsxs("div",{children:[(()=>{const n=(s==null?void 0:s.type)==="report"||((s==null?void 0:s.title)||"").includes("إيصال تسليم وردية");return e.jsx("p",{className:"font-medium text-sm text-gray-800",children:n?"إيصال تسليم وردية":(s.type==="send"?"تحويل":"سحب")+` - ${s.amount.toLocaleString()} جنيه`})})(),e.jsxs("p",{className:"text-[10px] text-gray-700",children:["تمت بواسطة: ",(s==null?void 0:s.cashierName)??"الحساب الرئيسي"]}),(()=>{const n=(s==null?void 0:s.type)==="report"||((s==null?void 0:s.title)||"").includes("إيصال تسليم وردية");return e.jsx("p",{className:"text-xs text-gray-500",children:n?`تم التسليم إلى: ${s.receiverPhone}`:`من ${s.senderPhone}${s.type==="send"?` إلى ${s.receiverPhone}`:""}`})})(),e.jsxs("p",{className:"text-xs text-gray-400",children:[$r.format(s.createdAt instanceof Date?s.createdAt:new Date(s.createdAt))," - ",oo.format(s.createdAt instanceof Date?s.createdAt:new Date(s.createdAt))]})]})]}),e.jsx(rt,{variant:s.status==="completed"?"default":s.status==="pending"?"secondary":"destructive",className:"text-xs",children:s.status==="completed"?"مكتمل":s.status==="pending"?"قيد المعالجة":"فشل"})]},s.id))})})})]})]}),e.jsx(Qo,{isOpen:ei,onClose:()=>ma(!1),transaction:ti,onPrint:()=>window.print(),onDelete:li,onComplete:ii}),e.jsxs("div",{className:"space-y-1 fade-in-right w-full lg:w-5/6 mx-auto",children:[e.jsxs(_e,{id:"transaction-section",className:"bg-gradient-to-br from-white via-blue-50/30 to-indigo-50/50 border border-blue-200/40 rounded-lg shadow-lg hover:shadow-lg transition-all duration-200 group relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/5 via-indigo-500/3 to-purple-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-200"}),e.jsx("div",{className:"absolute top-0 right-0 w-32 h-32 sm:w-28 sm:h-28 lg:w-20 lg:h-20 bg-gradient-to-bl from-blue-400/10 to-transparent rounded-full  "}),e.jsx("div",{className:"absolute bottom-0 left-0 w-24 h-24 bg-gradient-to-tr from-indigo-400/10 to-transparent rounded-full  ",style:{animationDelay:"1s"}}),e.jsx(ct,{className:"pb-0.5 px-3 pt-1 lg:pt-0.5 lg:pb-0.5 lg:px-2 relative z-10",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Nt,{className:"text-sm font-bold flex items-center gap-2 text-gray-800",children:[e.jsxs("div",{className:"relative",children:[e.jsx(Qt,{className:"h-1 w-1 text-emerald-500 "}),e.jsx("div",{className:"absolute inset-0 h-1 w-1 bg-emerald-400 rounded-full opacity-20 "})]}),e.jsx("span",{className:"bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent",children:"إجراء معاملة جديدة"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[pt&&e.jsx("div",{className:"hidden md:flex items-center gap-1 bg-gradient-to-r from-emerald-50 to-green-50 hover:from-emerald-100 hover:to-green-100 border border-emerald-200 text-emerald-800 text-sm transition-all duration-300 hover:scale-105 h-9 px-3 rounded-xl shadow-sm",children:e.jsxs("span",{className:"text-sm font-semibold whitespace-nowrap",children:["تجربة: ",X," ",X>=3&&X<=10?"ساعات":X===2?"ساعتين":"ساعة"]})}),e.jsxs("div",{className:"hidden md:flex items-center gap-2 bg-gradient-to-r from-gray-50 to-slate-50 hover:from-gray-100 hover:to-slate-100 border border-gray-200 transition-all duration-300 hover:scale-105 h-9 px-3 rounded-xl shadow-sm",children:[e.jsx(Dc,{}),e.jsx(sc,{})]})]}),so&&e.jsxs(o,{variant:"outline",size:"sm",className:"hidden flex items-center gap-1.5 sm:gap-2 bg-gradient-to-r from-cyan-50 to-blue-50 hover:from-cyan-100 hover:to-blue-100 border-cyan-200 text-cyan-800 text-xs sm:text-sm transition-all duration-300 hover:scale-105 hover:shadow-lg h-10 sm:h-12 px-4 sm:px-5 rounded-xl min-w-[44px] touch-manipulation",onClick:_n,title:"مزامنة البيانات المحفوظة محلياً مع الخادم",children:[e.jsx(cc,{className:"h-3.5 w-3.5 sm:h-4 sm:w-4 animate-spin"}),e.jsx("span",{className:"text-xs sm:text-sm font-semibold whitespace-nowrap",children:"مزامنة"})]})]})}),e.jsxs(Ye,{className:"space-y-1 px-2 pb-2 relative z-10",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-0.5 p-0.5 bg-gradient-to-r from-gray-50 to-slate-50 rounded-xl border border-gray-200/50 fade-in-up w-full lg:w-5/6 mx-auto ",children:[e.jsxs(o,{variant:G==="transfer"?"default":"ghost",onClick:()=>Yn("transfer"),className:`text-xs font-semibold transition-all duration-300 hover:scale-105 h-7 rounded-lg px-2 ${G==="transfer"?"bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg hover:shadow-md hover:from-blue-600 hover:to-indigo-700":"text-gray-600 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 hover:text-blue-700 hover:border-blue-200"}`,children:[e.jsx(ta,{className:"h-1 w-1 mr-1"}),"تحويل"]}),e.jsxs(o,{variant:G==="withdraw"?"default":"ghost",onClick:()=>Yn("withdraw"),className:`text-xs font-semibold transition-all duration-300 hover:scale-105 h-7 rounded-lg px-2 ${G==="withdraw"?"bg-gradient-to-r from-emerald-500 to-green-600 text-white shadow-lg hover:shadow-md hover:from-emerald-600 hover:to-green-700":"text-gray-600 hover:bg-gradient-to-r hover:from-emerald-50 hover:to-green-50 hover:text-emerald-700 hover:border-emerald-200"}`,children:[e.jsx(Ua,{className:"h-1 w-1 mr-1"}),"سحب"]})]}),e.jsxs("div",{className:"fade-in-up",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("label",{className:"text-sm font-semibold text-gray-700 block flex items-center gap-2",children:[e.jsx(Ut,{className:"h-1 w-1 text-blue-600"}),"اختيار المحفظة"]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsxs(o,{variant:"ghost",size:"sm",className:"h-6 rounded-md px-2 text-[10px] bg-emerald-50 text-emerald-700 hover:bg-emerald-100 border border-emerald-200",onClick:()=>C("/user/add-wallet"),title:"إضافة محفظة",children:[e.jsx(xt,{className:"h-3 w-3 mr-1"}),"إضافة محفظة"]}),e.jsxs(o,{variant:"ghost",size:"sm",className:"h-6 rounded-md px-2 text-[10px] bg-indigo-50 text-indigo-700 hover:bg-indigo-100 border border-indigo-200",onClick:()=>Rs(!0),title:"المحافظ",children:[e.jsx(Ut,{className:"h-3 w-3 mr-1"}),"المحافظ"]})]})]}),ye.length>0?e.jsxs(Ps,{value:U,onValueChange:ro,children:[e.jsx(Os,{"data-testid":"wallet-select",className:"w-full h-12 text-sm bg-gradient-to-r from-white to-gray-50 border-2 border-gray-200 hover:border-blue-400 focus:border-blue-500 rounded-xl transition-all duration-300 hover:shadow-md focus:shadow-lg",children:e.jsx(Ws,{placeholder:"اختر محفظة للمعاملة",className:"text-gray-600"})}),e.jsx(Fs,{className:"rounded-xl border-2 border-gray-200 shadow-md max-h-[220px] overflow-y-auto z-50 ",children:e.jsx("div",{className:"max-h-[180px] overflow-y-auto pr-1",children:ye.map(s=>e.jsx(Bs,{value:s.id,className:"rounded-lg hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 transition-all duration-200",children:e.jsxs("div",{className:"flex items-center gap-1 py-1 w-full justify-between",children:[e.jsx("div",{className:"p-1 bg-gradient-to-r from-blue-100 to-indigo-100 rounded-lg",children:e.jsx(Ut,{className:"h-1 w-1 text-blue-600"})}),e.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-sm font-medium text-gray-800",children:s.name}),e.jsxs("span",{className:"text-[10px] text-gray-500",children:["(",s.phone,")"]})]}),s.isDefault&&e.jsx(rt,{variant:"secondary",className:"text-[10px] bg-gradient-to-r from-emerald-100 to-green-100 text-emerald-700 border-emerald-200",children:"افتراضي"})]}),e.jsx("div",{className:"ml-auto flex flex-col items-end gap-1"})]})},s.id))})})]}):e.jsx("div",{className:"rounded-xl border-2 border-dashed border-gray-200 bg-gray-50 px-3 py-3 text-xs text-gray-600",children:"لا توجد محافظ حتى الآن. اضغط “إضافة محفظة” لإضافة أول محفظة."})]}),e.jsx(ie,{open:Ya,onOpenChange:Rs,children:e.jsxs(oe,{className:"sm:max-w-3xl w-[95vw] sm:w-auto max-h-[80vh] overflow-y-auto",children:[e.jsx(ce,{children:e.jsx(de,{children:"عرض المحافظ"})}),e.jsx("div",{className:"mt-2",children:e.jsx(tc,{showAddButton:!1,showUsageBars:!1,showLimitCards:!1,showEditButton:!0})})]})}),U&&ye.length>0&&(()=>{const s=ye.find(tt=>tt.id===U),n=Hn(U),r=io(U),i=(Fe==null?void 0:Fe.monthlyWithdrawLimit)??(s==null?void 0:s.monthlyWithdrawalLimit)??2e5,c=(Fe==null?void 0:Fe.monthlyTransferLimit)??(s==null?void 0:s.monthlyTransferLimit)??2e5,y=n.totalWithdrawn??(Fe==null?void 0:Fe.monthlyWithdrawUsed)??0,v=n.totalTransferred??(Fe==null?void 0:Fe.monthlyTransferUsed)??0,S=(Fe==null?void 0:Fe.dailyWithdrawLimit)??1e5,O=(Fe==null?void 0:Fe.dailyTransferLimit)??6e4,A=r.totalWithdrawn??(Fe==null?void 0:Fe.dailyWithdrawUsed)??0,w=r.totalTransferred??(Fe==null?void 0:Fe.dailyTransferUsed)??0,F=parseFloat(He||"0")||0,L=y+(G==="withdraw"?F:0),T=v+(G==="transfer"?F:0),Y=A+(G==="withdraw"?F:0),Ce=w+(G==="transfer"?F:0);return s?e.jsxs("div",{className:"fade-in-up mb-2 space-y-2",children:[e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-1 rounded-md border border-gray-200 shadow-sm hover:shadow-md transition-all duration-300",children:[e.jsxs("div",{className:"text-[10px] text-gray-600 font-medium mb-1 text-center",children:["الحدود الشهرية: ",s.name]}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-red-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-red-400 to-red-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(L/Math.max(i,1)*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-blue-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-400 to-blue-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(T/Math.max(c,1)*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-[10px] text-red-600 font-medium",children:["متبقي سحب: ",Math.max(i-L,0).toLocaleString("en-US")," جنيه"]}),e.jsxs("div",{className:"text-[10px] text-blue-600 font-medium",children:["متبقي تحويل: ",Math.max(c-T,0).toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-1 rounded-md border border-gray-200 shadow-sm hover:shadow-md transition-all duration-300",children:[e.jsxs("div",{className:"text-[10px] text-gray-600 font-medium mb-1 text-center",children:["الحدود اليومية: ",s.name]}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-orange-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-orange-400 to-orange-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(Y/Math.max(S,1)*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-green-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-green-400 to-green-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(Ce/Math.max(O,1)*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-[10px] text-orange-600 font-medium",children:["متبقي سحب يومي: ",Math.max(S-Y,0).toLocaleString("en-US")," جنيه"]}),e.jsxs("div",{className:"text-[10px] text-green-600 font-medium",children:["متبقي تحويل يومي: ",Math.max(O-Ce,0).toLocaleString("en-US")," جنيه"]})]})]})]}):null})(),G==="transfer"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المرسل"}),e.jsxs("div",{className:"relative",children:[e.jsx(Xt,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx($,{value:pe,onChange:s=>Pe(s.target.value),onKeyDown:s=>{if(s.key==="Enter"){const n=document.getElementById("receiverPhoneInput");if(n)n.focus();else{const r=document.getElementById("amountInput");r==null||r.focus()}}},placeholder:"01030302038",className:"pl-10 h-10 text-sm transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]})]}),!f&&e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المستقبل"}),e.jsxs("div",{className:"relative",children:[e.jsx(Xt,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx($,{id:"receiverPhoneInput",value:nt,onChange:s=>{lt(s.target.value),Za&&Is(!1)},onKeyDown:s=>{if(s.key==="Enter"){const n=document.getElementById("amountInput");n==null||n.focus()}},inputMode:"numeric",maxLength:11,placeholder:"أدخل رقم المستقبل",className:"pl-10 h-10 text-sm transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المستقبل"}),e.jsxs("div",{className:"relative",children:[e.jsx(Xt,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx($,{value:U&&((Zn=ye.find(s=>s.id===U))==null?void 0:Zn.phone)||"",readOnly:!0,placeholder:"اختر محفظة أولاً",className:"pl-10 h-10 text-sm bg-gray-50 transition-all duration-300"})]})]}),G==="transfer"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"المبلغ (جنيه)"}),e.jsxs("div",{className:"relative flex items-center gap-2",children:[e.jsx(Ze,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx($,{id:"amountInput",value:He,onChange:s=>{ft(s.target.value),Za&&Is(!1)},onKeyDown:s=>{if(s.key==="Enter"){const n=document.getElementById("transferCommissionInput");if(n)n.focus();else{const r=document.getElementById("quickDebtButton");r==null||r.focus()}}},placeholder:"أدخل المبلغ",type:"number",className:"pl-10 h-10 text-sm transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),St?e.jsxs("div",{className:"mt-2 text-xs text-green-700 bg-green-50 border border-green-200 rounded px-2 py-1 flex items-center gap-2",children:[e.jsxs("span",{children:["تم إدخال تفاصيل الأجل لـ ",St.debtorName," بمبلغ ",St.amount," جنيه"]}),e.jsx(o,{type:"button",variant:"ghost",size:"sm",className:"h-6 px-2",onClick:()=>os(null),children:"إلغاء"})]}):null]}),(()=>{if(f)return null;const s=ss();return s&&s.defaultTransferCommission!=null?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة التحويل (تلقائية)"}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["سيتم تطبيق عمولة التحويل الافتراضية لكل ألف: ",s==null?void 0:s.defaultTransferCommission," جنيه لكل ألف"]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(o,{id:"quickDebtButton",type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const r=ss(),i=(r==null?void 0:r.defaultTransferCommission)!=null?Number(r.defaultTransferCommission):0,c=parseFloat(He||"0")||0,y=Math.round((i||0)*c/1e3*100)/100,v=c+y;Bt((v||0).toString()),qe?l({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):kt(!0)},children:"أجل"}),e.jsx(o,{type:"button",variant:"outline",size:"icon",className:"hidden",title:b?"العمولة تُضاف":"العمولة تُخصم",children:b?e.jsx(xt,{className:"h-4 w-4 text-green-600"}):e.jsx(fs,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"hidden",children:b?"العمولة تُضاف":"العمولة تُخصم"})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة التحويل على العملية (جنيه)"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(Ze,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-orange-500"}),e.jsx($,{id:"transferCommissionInput",value:mt,onChange:r=>Cs(r.target.value),placeholder:"أدخل عمولة التحويل",type:"number",className:"pl-10 h-10 text-sm transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),e.jsx(o,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const r=ss(),i=parseFloat(He||"0")||0;let c=0;if((r==null?void 0:r.defaultTransferCommission)!=null){const v=Number(r.defaultTransferCommission)||0;c=Math.round(v*i/1e3*100)/100}else{const v=mt&&mt.trim()!==""?parseFloat(mt):0;c=Math.max(0,v)}const y=i+c;Bt((y||0).toString()),qe?l({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):kt(!0)},children:"أجل"}),e.jsx(o,{type:"button",variant:"outline",size:"icon",className:"hidden",title:b?"العمولة تُضاف":"العمولة تُخصم",children:b?e.jsx(xt,{className:"h-4 w-4 text-green-600"}):e.jsx(fs,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"hidden",children:b?"العمولة تُضاف":"العمولة تُخصم"})]}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"يمكنك إدخال عمولة العملية الإجمالية (اختياري)"})]})})(),e.jsx(o,{onClick:Gn,className:"w-full font-medium h-10 text-sm btn-bounce hover-glow transition-all duration-300 bg-blue-600 hover:bg-blue-700 text-white",children:Za?"تم التحويل بنجاح":"تأكيد التحويل"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"مبلغ السحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Ua,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-green-500"}),e.jsx($,{id:"amountInput",value:He,onChange:s=>{ft(s.target.value),xn&&zs(!1)},onKeyDown:s=>{if(s.key==="Enter"){const n=document.getElementById("manualWithdrawCommissionInput");if(n)n.focus();else{const r=document.getElementById("withdrawSubmitButton");r==null||r.focus()}}},placeholder:"أدخل مبلغ السحب",type:"number",className:"pl-10 h-10 text-sm transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]})]}),(()=>{const s=ss();return s&&s.defaultWithdrawCommission!=null?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة السحب (تلقائية)"}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["سيتم تطبيق عمولة السحب الافتراضية لكل ألف: ",s==null?void 0:s.defaultWithdrawCommission," جنيه لكل ألف"]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(o,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const r=ss(),i=parseFloat(He||"0")||0,c=(r==null?void 0:r.defaultWithdrawCommission)!=null&&Number(r.defaultWithdrawCommission)||0,y=Math.round(c*i/1e3*100)/100,v=b?i+y:i;Bt((v||0).toString()),qe?l({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):kt(!0)},children:"أجل"}),e.jsx(o,{type:"button",variant:"outline",size:"icon",className:"h-8 w-8",onClick:()=>me(r=>!r),title:b?"العمولة تُضاف إلى الدين":"العمولة تُخصم من الدين",children:b?e.jsx(xt,{className:"h-4 w-4"}):e.jsx(fs,{className:"h-4 w-4"})}),e.jsx("span",{className:"text-xs text-gray-600",children:b?"العمولة تُضاف":"العمولة تُخصم"})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة السحب على العملية (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Ze,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-orange-500"}),e.jsx($,{id:"manualWithdrawCommissionInput",value:dt,onChange:r=>Us(r.target.value),onKeyDown:r=>{if(r.key==="Enter"){const i=document.getElementById("withdrawSubmitButton");i==null||i.focus()}},placeholder:"أدخل العمولة المطلوبة",type:"number",className:"pl-10 h-10 text-sm transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"أدخل العمولة الإجمالية لإتمام عملية السحب"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(o,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const r=ss(),i=parseFloat(He||"0")||0;let c=0;if((r==null?void 0:r.defaultWithdrawCommission)!=null){const v=Number(r.defaultWithdrawCommission)||0;c=Math.round(v*i/1e3*100)/100}else{const v=dt&&dt.trim()!==""?parseFloat(dt):Math.round(i*.01*100)/100;c=Math.max(0,v)}const y=b?i+c:i;Bt((y||0).toString()),qe?l({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):kt(!0)},children:"أجل"}),e.jsx(o,{type:"button",variant:"outline",size:"icon",title:b?"العمولة تُضاف":"العمولة تُخصم",onClick:()=>me(r=>!r),children:b?e.jsx(xt,{className:"h-4 w-4 text-green-600"}):e.jsx(fs,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"text-xs text-gray-600",children:b?"العمولة تُضاف":"العمولة تُخصم"})]})]})})(),e.jsx(o,{id:"withdrawSubmitButton",onClick:Gn,className:"w-full font-medium h-10 text-sm btn-bounce hover-glow transition-all duration-300 bg-green-600 hover:bg-green-700 text-white",children:xn?"تم السحب بنجاح":"تأكيد السحب"})]}),e.jsx(ie,{open:Jt,onOpenChange:kt,children:e.jsxs(oe,{children:[e.jsxs(ce,{children:[e.jsx(de,{children:"تحويل مؤجل"}),e.jsx(Rt,{children:"أدخل بيانات صاحب الدين والمبلغ والملاحظات ثم اضغط حفظ"})]}),e.jsxs("div",{className:"space-y-3",children:[Vt&&Vt.length>0?e.jsxs("div",{children:[e.jsx(H,{children:"اختيار عميل"}),e.jsxs(Ps,{value:et,onValueChange:s=>{Va(s);const n=Vt.find(r=>r.id===s);n&&ws(n.name)},children:[e.jsx(Os,{className:"w-full",children:e.jsx(Ws,{placeholder:"اختر عميل"})}),e.jsx(Fs,{children:Vt.map(s=>e.jsxs(Bs,{value:s.id,children:[s.name,s.mobile?` — ${s.mobile}`:""]},s.id))})]})]}):e.jsx("div",{className:"text-xs text-gray-500",children:"لا يوجد عملاء مُسجلين حالياً. يمكنك إضافة عميل من نافذة الديون."}),e.jsxs("div",{children:[e.jsx(H,{htmlFor:"quickDebtName",children:"اسم صاحب الدين"}),e.jsx($,{id:"quickDebtName",value:Ft,onChange:s=>ws(s.target.value),placeholder:"اكتب الاسم"})]}),e.jsxs("div",{children:[e.jsx(H,{htmlFor:"quickDebtAmount",children:"المبلغ (محسوب تلقائياً)"}),e.jsx($,{id:"quickDebtAmount",type:"number",value:ca,readOnly:!0,placeholder:"المبلغ + عمولة التحويل"})]}),e.jsxs("div",{children:[e.jsx(H,{htmlFor:"quickDebtNotes",children:"ملاحظات"}),e.jsx($,{id:"quickDebtNotes",value:Ss,onChange:s=>Ds(s.target.value),placeholder:"اكتب ملاحظات (اختياري)"})]})]}),e.jsx(Ne,{children:e.jsx(o,{type:"button",onClick:()=>{const s=ss(),n=parseFloat((He||"").toString())||0;let r=0;if(G==="transfer")if((s==null?void 0:s.defaultTransferCommission)!=null){const y=Number(s.defaultTransferCommission)||0;r=Math.round(y*n/1e3*100)/100}else{const y=mt&&mt.trim()!==""?parseFloat(mt):0;r=Math.max(0,y)}else if((s==null?void 0:s.defaultWithdrawCommission)!=null){const y=Number(s.defaultWithdrawCommission)||0;r=Math.round(y*n/1e3*100)/100}else{const y=dt&&dt.trim()!==""?parseFloat(dt):Math.round(n*.01*100)/100;r=Math.max(0,y)}let i=0;if(G==="withdraw"?i=b?n:Math.max(0,Math.round((n-r)*100)/100):i=Math.max(0,Math.round((n+r)*100)/100),!Ft||isNaN(i)||i<=0){l({title:"خطأ في بيانات الأجل",description:"يرجى إدخال الاسم والمبلغ بشكل صحيح",variant:"destructive"});return}const c=Vt.find(y=>y.id===et);os({debtorName:Ft,amount:i,notes:Ss,customerId:et||void 0,mobile:c==null?void 0:c.mobile}),cs(!1),kt(!1),l({title:"تم حفظ بيانات الأجل",description:"سيتم إضافة الدين عند تأكيد العملية",variant:"default"})},children:"حفظ"})})]})})]})]}),e.jsx(_e,{className:"bg-gradient-to-br from-red-50 to-red-100 border-red-200 fade-in-up card-float",children:e.jsxs(Ye,{className:"p-3 text-center",children:[e.jsx("div",{className:"text-red-600 font-medium text-[10px] mb-1",children:"⚠️ تحذير من التحويل"}),e.jsx("div",{className:"text-[10px] text-red-700",children:"لا يمكن إلغاء أي عملية بعد تأكيدها للمحافظة على الأمان"})]})})]})]}),e.jsx(vc,{isOpen:da,onClose:()=>Ha(!1),initialEditingWallet:an,onWalletUpdate:async()=>{try{await Pa()}catch(s){console.error("Error reloading wallets after update:",s)}}}),e.jsx(yc,{isOpen:Xl,onClose:()=>rn(!1),transaction:Zl,onDelete:lo}),e.jsx(zr,{open:ai,onOpenChange:_s,onSuccess:mo,title:ho(),description:xo()}),e.jsx(zr,{open:ni,onOpenChange:Qa,onSuccess:()=>{Qa(!1),ln(!0)},title:"حماية أرشيف التقارير اليومية",description:"أدخل كلمة مرور تسجيل الدخول للوصول إلى الأرشيف"}),e.jsx(Hc,{open:ri,onOpenChange:ln,userId:t==null?void 0:t.uid}),e.jsx(ll,{open:Fi,onOpenChange:In,onSuccess:go,title:"تعديل الرصيد النقدي في الدرج",description:"أدخل الرقم السري والمبلغ الجديد لتعديل الرصيد النقدي في الدرج",currentBalance:Ee,balanceLabel:"الرصيد النقدي",userId:t==null?void 0:t.uid}),e.jsx(ll,{open:Bi,onOpenChange:Tn,onSuccess:po,title:"تعديل رصيد المحفظة",description:"أدخل الرقم السري والمبلغ الجديد لتعديل رصيد المحفظة",currentBalance:bt&&ve[bt]||0,balanceLabel:`رصيد ${((Xn=ye.find(s=>s.id===bt))==null?void 0:Xn.name)||"المحفظة"}`,userId:t==null?void 0:t.uid}),e.jsx(wc,{open:Ei,onOpenChange:br,onSuccess:fo,title:"إضافة أو خصم مبلغ من رصيد المحفظة",description:"أدخل الرقم السري والمبلغ المراد إضافته أو خصمه من رصيد المحفظة",currentBalance:bt&&ve[bt]||0,balanceLabel:`رصيد ${((el=ye.find(s=>s.id===bt))==null?void 0:el.name)||"المحفظة"}`,userId:t==null?void 0:t.uid}),e.jsx(jc,{open:Vi,onOpenChange:qi,userId:t==null?void 0:t.uid}),e.jsx(bc,{open:Yi,onOpenChange:Hi,userId:t==null?void 0:t.uid}),e.jsx(Nc,{open:Gi,onOpenChange:Qi}),e.jsx(ie,{open:$i,onOpenChange:Na,children:e.jsxs(oe,{className:"sm:max-w-md",children:[e.jsx(ce,{children:e.jsx(de,{className:"text-right",children:"تعديل الدرج النقدية"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(H,{htmlFor:"amount",className:"text-right block",children:"المبلغ"}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx($,{id:"amount",type:"number",placeholder:"أدخل المبلغ",value:Sr,onChange:s=>wa(s.target.value),className:"text-right flex-1",dir:"rtl",min:"0"}),e.jsxs("div",{className:"flex gap-1",children:[e.jsxs(o,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white px-3 py-2",onClick:()=>{if(!Mr(Tr)){l({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}const s=parseFloat(Sr);if(isNaN(s)||s<=0){l({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const n=Ee+s;Qe(n);const r={cashBalance:n,lastUpdated:new Date().toISOString()},i=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(i,JSON.stringify(r)),t!=null&&t.uid?je.updateUserData(t.uid,r).then(()=>{console.log("✅ تم حفظ رصيد الدرج النقدي في Firebase بنجاح"),localStorage.removeItem(i),ge(!1)}).catch(c=>{console.error("❌ خطأ في حفظ الرصيد في Firebase:",c),ge(!0)}):ge(!0),l({title:"تم بنجاح",description:`تم إضافة ${s} جنيه إلى الدرج النقدية وحفظه في السحابة`}),Na(!1),wa(""),Sa("")},children:[e.jsx(xt,{className:"h-1 w-1 mr-1"}),"إضافة"]}),e.jsxs(o,{type:"button",size:"sm",className:"bg-red-600 hover:bg-red-700 text-white px-3 py-2",onClick:()=>{if(!Mr(Tr)){l({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}const s=parseFloat(Sr);if(isNaN(s)||s<=0){l({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const n=Ee-s;Qe(n);const r={cashBalance:n,lastUpdated:new Date().toISOString()},i=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(i,JSON.stringify(r)),t!=null&&t.uid?je.updateUserData(t.uid,r).then(()=>{console.log("✅ تم حفظ رصيد الدرج النقدي في Firebase بنجاح"),localStorage.removeItem(i),ge(!1)}).catch(c=>{console.error("❌ خطأ في حفظ الرصيد في Firebase:",c),ge(!0)}):ge(!0),l({title:"تم بنجاح",description:`تم خصم ${s} جنيه من الدرج النقدية وحفظه في السحابة`}),Na(!1),wa(""),Sa("")},children:[e.jsx(fs,{className:"h-1 w-1 mr-1"}),"خصم"]})]})]}),e.jsxs("p",{className:"text-[10px] text-gray-500 text-right",children:["الرصيد الحالي: ",Ee.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(H,{htmlFor:"pin",className:"text-right block",children:"الرقم السري"}),e.jsx($,{id:"pin",type:"password",placeholder:"أدخل الرقم السري",value:Tr,onChange:s=>Sa(s.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsx(Ne,{className:"flex gap-2",children:e.jsx(o,{variant:"outline",onClick:()=>{Na(!1),wa(""),Sa("")},children:"إلغاء"})})]})}),e.jsx(ie,{open:eo,onOpenChange:Ta,children:e.jsxs(oe,{className:"sm:max-w-md",children:[e.jsx(ce,{children:e.jsx(de,{className:"text-right text-red-600",children:"تصفير إجمالي المحفظة"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-red-50 rounded-lg border border-red-200",children:[e.jsx("p",{className:"text-red-800 font-medium mb-2",children:"تحذير!"}),e.jsx("p",{className:"text-red-700 text-sm",children:"سيتم تصفير جميع أرصدة المحافظ إلى صفر. هذا الإجراء لا يمكن التراجع عنه."}),e.jsxs("p",{className:"text-red-600 text-sm mt-2",children:["الرصيد الحالي: ",Object.values(ve).reduce((s,n)=>s+n,0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(H,{htmlFor:"resetWalletTotalPin",className:"text-right block",children:"كلمة مرور تسجيل الدخول"}),e.jsx($,{id:"resetWalletTotalPin",type:"password",placeholder:"أدخل كلمة مرور تسجيل الدخول",value:Vn,onChange:s=>ka(s.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsxs(Ne,{className:"flex gap-2",children:[e.jsx(o,{variant:"outline",onClick:()=>{Ta(!1),ka("")},children:"إلغاء"}),e.jsx(o,{variant:"destructive",onClick:async()=>{if(!await Lr(Vn)){l({title:"خطأ",description:"كلمة المرور غير صحيحة",variant:"destructive"});return}try{const n={};Object.keys(ve).forEach(y=>{n[y]=0}),Be(n),localStorage.setItem(Ue(),JSON.stringify(n)),Ta(!1),ka("");const r=new Date().toISOString(),i={walletBalances:n,lastUpdated:r},c=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(c,JSON.stringify(i)),t!=null&&t.uid?je.updateUserData(t.uid,i).then(()=>{localStorage.removeItem(c),ge(!1)}).catch(y=>{console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",y),ge(!0),l({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):ge(!0),setTimeout(()=>{Be({...n})},100)}catch(n){console.error("خطأ في تصفير أرصدة المحافظ:",n),l({title:"خطأ",description:"حدث خطأ أثناء تصفير المحافظ",variant:"destructive"})}},children:"تصفير المحفظة"})]})]})}),e.jsx(ie,{open:Mi,onOpenChange:ba,children:e.jsxs(oe,{className:"sm:max-w-md",children:[e.jsx(ce,{children:e.jsx(de,{className:"text-right text-red-600",children:"تصفير رصيد المحفظة المختارة"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-red-50 rounded-lg border border-red-200",children:[e.jsx("p",{className:"text-red-800 font-medium mb-2",children:"تحذير!"}),e.jsx("p",{className:"text-red-700 text-sm",children:"سيتم تصفير رصيد المحفظة المحددة إلى صفر. هذا الإجراء لا يمكن التراجع عنه."}),e.jsxs("p",{className:"text-red-600 text-sm mt-2",children:["المحفظة: ",((tl=ye.find(s=>s.id===U))==null?void 0:tl.name)||U]}),e.jsxs("p",{className:"text-red-600 text-sm",children:["الرصيد الحالي: ",(U&&ve[U]?ve[U]:0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(H,{htmlFor:"resetSelectedWalletPin",className:"text-right block",children:"كلمة مرور تسجيل الدخول"}),e.jsx($,{id:"resetSelectedWalletPin",type:"password",autoComplete:"off",placeholder:"أدخل كلمة مرور تسجيل الدخول",value:kn,onChange:s=>Nr(s.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsxs(Ne,{className:"flex gap-2",children:[e.jsx(o,{variant:"outline",onClick:()=>{ba(!1),Nr("")},children:"إلغاء"}),e.jsx(o,{variant:"destructive",onClick:async()=>{var n;if(!U){l({title:"اختر محفظة",description:"يرجى اختيار محفظة أولاً",variant:"destructive"});return}if(!await Lr(kn)){l({title:"خطأ",description:"كلمة المرور غير صحيحة",variant:"destructive"});return}try{const r={...ve};r[U]=0,Be(r),localStorage.setItem(Ue(),JSON.stringify(r)),ba(!1),Nr("");const i=new Date().toISOString(),c={walletBalances:r,lastUpdated:i},y=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(y,JSON.stringify(c)),t!=null&&t.uid?je.updateUserData(t.uid,c).then(()=>{localStorage.removeItem(y),ge(!1)}).catch(v=>{console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",v),ge(!0),l({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):ge(!0),l({title:"تم التصفير بنجاح",description:`تم تصفير رصيد المحفظة ${((n=ye.find(v=>v.id===U))==null?void 0:n.name)||U}`})}catch(r){console.error("خطأ في تصفير رصيد المحفظة المختارة:",r),l({title:"خطأ",description:"حدث خطأ أثناء تصفير رصيد المحفظة المختارة",variant:"destructive"})}},children:"تصفير المحفظة"})]})]})}),e.jsx(ie,{open:Xi,onOpenChange:Ia,children:e.jsxs(oe,{className:"sm:max-w-md",children:[e.jsx(ce,{children:e.jsxs(de,{className:"text-right text-green-600 flex items-center gap-2 justify-end",children:[e.jsx(xt,{className:"h-4 w-4"}),"إضافة أموال لإجمالي المحفظة"]})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-green-50 rounded-lg border border-green-200",children:[e.jsx("p",{className:"text-green-800 font-medium mb-2",children:"إضافة أموال"}),e.jsx("p",{className:"text-green-700 text-sm",children:"سيتم إضافة المبلغ المحدد إلى إجمالي المحفظة بشكل متناسب على جميع المحافظ."}),e.jsxs("p",{className:"text-green-600 text-sm mt-2",children:["الرصيد الحالي: ",Object.values(ve).reduce((s,n)=>s+n,0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"addWalletTotalAmount",className:"text-right block",children:"المبلغ المراد إضافته"}),e.jsx($,{id:"addWalletTotalAmount",type:"number",placeholder:"أدخل المبلغ",value:Ln,onChange:s=>Or(s.target.value),className:"text-right",dir:"rtl"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"addWalletTotalPin",className:"text-right block",children:"الرقم السري للتأكيد"}),e.jsx($,{id:"addWalletTotalPin",type:"password",autoComplete:"off",placeholder:"أدخل الرقم السري",value:$n,onChange:s=>Wr(s.target.value),className:"text-right",dir:"rtl"})]})]})]}),e.jsxs(Ne,{className:"flex gap-2",children:[e.jsx(o,{variant:"outline",onClick:()=>{Ia(!1),Or(""),Wr("")},children:"إلغاء"}),e.jsx(o,{variant:"default",className:"bg-green-600 hover:bg-green-700",disabled:Rn,onClick:async()=>{const s=parseFloat(Ln);if(!s||s<=0){l({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}if(!ao($n)){l({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}Un(!0);try{const n=Object.values(ve).reduce((r,i)=>r+i,0);if(n===0){const r=Object.keys(ve),i=s/r.length,c={};r.forEach(y=>{c[y]=i}),Be(c),localStorage.setItem(Ue(),JSON.stringify(c)),t!=null&&t.uid?await je.updateUserData(t.uid,{walletBalances:c,lastUpdated:new Date().toISOString()}):ge(!0)}else{const r={};Object.entries(ve).forEach(([i,c])=>{const y=c/n,v=s*y;r[i]=c+v}),Be(r),localStorage.setItem(Ue(),JSON.stringify(r)),t!=null&&t.uid?await je.updateUserData(t.uid,{walletBalances:r,lastUpdated:new Date().toISOString()}):ge(!0)}setTimeout(()=>{Be(r=>({...r}))},100),Ia(!1),Or(""),Wr("")}catch(n){console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",n),l({title:"خطأ",description:"حدث خطأ أثناء حفظ البيانات",variant:"destructive"})}finally{Un(!1)}},children:Rn?"جاري الإضافة...":"إضافة الأموال"})]})]})}),e.jsx(ie,{open:to,onOpenChange:Aa,children:e.jsxs(oe,{className:"sm:max-w-[425px]",children:[e.jsx(ce,{children:e.jsxs(de,{className:"text-red-600 flex items-center gap-2",children:[e.jsx(It,{className:"h-1 w-1"}),"تصفير الرصيد النقدي"]})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-3",children:e.jsx("p",{className:"text-sm text-red-700",children:"⚠️ تحذير: سيتم تصفير الرصيد النقدي في الدرج إلى صفر. هذا الإجراء لا يمكن التراجع عنه."})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(H,{htmlFor:"resetCashPin",children:"كلمة مرور تسجيل الدخول"}),e.jsx($,{id:"resetCashPin",type:"password",autoComplete:"off",placeholder:"أدخل كلمة مرور تسجيل الدخول",value:Br,onChange:s=>Er(s.target.value)})]})]}),e.jsxs(Ne,{children:[e.jsx(o,{variant:"outline",onClick:()=>{Aa(!1),Er("")},children:"إلغاء"}),e.jsx(o,{variant:"destructive",onClick:async()=>{if(!Br){l({title:"خطأ",description:"يرجى إدخال كلمة المرور",variant:"destructive"});return}if(!await Lr(Br)){l({title:"خطأ",description:"كلمة المرور غير صحيحة",variant:"destructive"});return}try{Qe(0),Aa(!1),Er("");const n={cashBalance:0,lastUpdated:new Date().toISOString()};localStorage.setItem(Ve(),"0");const r=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(r,JSON.stringify(n)),t!=null&&t.uid?je.updateUserData(t.uid,n).then(()=>{localStorage.removeItem(r),ge(!1)}).catch(i=>{console.error("خطأ في حفظ الرصيد في Firebase:",i),ge(!0),l({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):ge(!0)}catch(n){console.error("خطأ في تصفير الرصيد النقدي:",n),l({title:"خطأ",description:"حدث خطأ أثناء تصفير الرصيد النقدي",variant:"destructive"})}},children:"تصفير الرصيد"})]})]})}),e.jsx(ie,{open:Zi,onOpenChange:Da,children:e.jsxs(oe,{className:"sm:max-w-[425px]",children:[e.jsx(ce,{children:e.jsxs(de,{className:"text-green-600 flex items-center gap-2",children:[e.jsx(xt,{className:"h-4 w-4"}),"إضافة أموال للدرج"]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-3",children:e.jsx("p",{className:"text-sm text-green-700",children:"💰 سيتم إضافة المبلغ المحدد إلى الرصيد النقدي في الدرج"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"addCashAmount",children:"المبلغ المراد إضافته"}),e.jsx($,{id:"addCashAmount",type:"number",placeholder:"أدخل المبلغ",value:Ca,onChange:s=>kr(s.target.value),min:"0",step:"0.01"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"addCashPin",children:"الرقم السري لدرج النقدية"}),e.jsx($,{id:"addCashPin",type:"password",placeholder:"أدخل الرقم السري",value:Ar,onChange:s=>Pr(s.target.value)})]})]}),e.jsxs(Ne,{children:[e.jsx(o,{variant:"outline",onClick:()=>{Da(!1),kr(""),Pr("")},children:"إلغاء"}),e.jsx(o,{variant:"default",className:"bg-green-600 hover:bg-green-700",disabled:En,onClick:async()=>{if(!Ca||parseFloat(Ca)<=0){l({title:"خطأ",description:"يرجى إدخال مبلغ صحيح أكبر من صفر",variant:"destructive"});return}if(!Ar){l({title:"خطأ",description:"يرجى إدخال الرقم السري",variant:"destructive"});return}if(!Mr(Ar)){l({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}Mn(!0);try{const s=parseFloat(Ca),n=Ee+s;Qe(n),localStorage.setItem(Ve(),n.toString());const r={cashBalance:n,lastUpdated:new Date().toISOString()},i=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(i,JSON.stringify(r)),t!=null&&t.uid?(await je.updateUserData(t.uid,r),localStorage.removeItem(i),ge(!1)):ge(!0),Da(!1),kr(""),Pr("")}catch(s){console.error("خطأ في حفظ الرصيد في Firebase:",s),Qe(Ee),localStorage.setItem("cashBalance",Ee.toString()),l({title:"خطأ",description:"حدث خطأ أثناء حفظ البيانات، يرجى المحاولة مرة أخرى",variant:"destructive"})}finally{Mn(!1)}},children:En?"جاري الإضافة...":"إضافة الأموال"})]})]})}),e.jsx(ie,{open:Wi,onOpenChange:jr,children:e.jsxs(oe,{className:"sm:max-w-md",children:[e.jsx(ce,{children:e.jsx(de,{className:"text-right",children:"اختيار التاريخ والوقت للبحث"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(H,{htmlFor:"search-date",className:"text-right block",children:"التاريخ"}),e.jsx($,{id:"search-date",type:"date",value:ha,onChange:s=>mn(s.target.value),className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(H,{htmlFor:"search-time",className:"text-right block",children:"الوقت (اختياري)"}),e.jsx($,{id:"search-time",type:"time",value:xa,onChange:s=>hn(s.target.value),className:"text-right",placeholder:"اختر الوقت للبحث في ساعة محددة"}),e.jsx("p",{className:"text-[10px] text-gray-500 text-right",children:"إذا لم تختر وقتاً محدداً، سيتم البحث في كامل اليوم"})]})]}),e.jsxs(Ne,{className:"flex justify-between",children:[e.jsx(o,{variant:"outline",onClick:()=>{mn(""),hn(""),jr(!1)},children:"مسح"}),e.jsx(o,{onClick:()=>jr(!1),children:"تطبيق"})]})]})}),e.jsx(il,{isOpen:g&&!D,onClose:()=>R(!1),onTrialStarted:Pi}),e.jsx(Cc,{isOpen:di,onClose:()=>un(!1)}),e.jsx(Ic,{isOpen:mi,onClose:()=>er(!1)}),e.jsx(Zo,{isOpen:hi,onClose:()=>tr(!1)}),e.jsx(Xo,{open:xi,onOpenChange:sr}),e.jsx(_c,{open:ui,onOpenChange:s=>{if(s&&!gs){l({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});return}ar(s)}}),e.jsx(Gc,{open:P,onOpenChange:s=>{if(s&&!gs){l({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}k(s)}}),e.jsx(Qc,{open:E,onOpenChange:s=>{if(s&&!gs){l({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}K(s)}}),e.jsx(vs,{open:bi,onOpenChange:fa,mode:"verify",title:"الرقم السري الرئيسي لفتح الديون",description:"أدخل الرقم السري الرئيسي لفتح صفحة الديون",onSuccess:()=>{fa(!1),pa(!0)}}),e.jsx(zr,{open:Li,onOpenChange:wr,title:"تأكيد كلمة المرور لتصفير المعاملات الأخيرة",description:"لن يتم حذف الإيصالات؛ سنبدأ القائمة من الآن.",onSuccess:()=>{try{t!=null&&t.uid&&(localStorage.setItem(`recentTransactionsResetAt:${t.uid}`,new Date().toISOString()),l({title:"تم التصفير",description:"تم بدء قائمة المعاملات من الآن."}))}catch{}wr(!1)}}),e.jsx(vs,{open:N,onOpenChange:J,mode:"verify",title:"الرقم السري لفتح مصروفات المحل",description:"أدخل الرقم السري الرئيسي لفتح نافذة مصروفات المحل",onSuccess:()=>{J(!1),j(!0)}}),e.jsx(ie,{open:ji,onOpenChange:pa,children:e.jsxs(oe,{className:"sm:max-w-[425px]",children:[e.jsxs(ce,{className:"flex items-center justify-between",children:[e.jsx(de,{className:"text-right",children:"إدارة الديون"}),e.jsxs("div",{className:"flex items-center gap-1 text-orange-700",children:[e.jsx(dc,{className:"h-4 w-4"}),e.jsxs("span",{className:"text-xs font-bold",children:[co," جنيه"]})]})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(H,{htmlFor:"debtorName",className:"text-right col-span-1",children:"اسم المديون"}),e.jsx($,{id:"debtorName",value:nr,onChange:s=>fn(s.target.value),className:"col-span-3 text-right",placeholder:"أدخل اسم المديون"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(H,{htmlFor:"debtAmount",className:"text-right col-span-1",children:"المبلغ"}),e.jsx($,{id:"debtAmount",type:"number",value:lr,onChange:s=>vn(s.target.value),className:"col-span-3 text-right",placeholder:"أدخل المبلغ"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(H,{htmlFor:"debtReason",className:"text-right col-span-1",children:"سبب الدين"}),e.jsx($,{id:"debtReason",value:ir,onChange:s=>yn(s.target.value),className:"col-span-3 text-right",placeholder:"أدخل سبب الدين"})]})]}),e.jsx(Ne,{children:e.jsx(o,{onClick:()=>{if(nr&&lr&&ir){const s={id:Date.now().toString(),debtorName:nr,amount:parseFloat(lr),reason:ir,status:"pending",createdAt:new Date,paidAmount:0,partialPayments:[]};fr(s),va(!0)}else l({title:"بيانات غير مكتملة",description:"يرجى إدخال الاسم والمبلغ والسبب",variant:"destructive"})},className:"bg-orange-500 hover:bg-orange-600",children:"حفظ"})}),e.jsx("div",{className:"mt-2",children:e.jsx(o,{variant:"outline",className:"w-full",onClick:()=>Vs(!0),children:"إيصالات الديون"})}),e.jsx("div",{className:"mt-2",children:e.jsx(o,{variant:"outline",className:"w-full",onClick:()=>mr(!0),children:"إضافة عميل"})})]})}),e.jsx(ie,{open:Si,onOpenChange:Vs,children:e.jsxs(oe,{className:"sm:max-w-[520px]",children:[e.jsxs(ce,{children:[e.jsx(de,{className:"text-right",children:"إيصالات الديون"}),e.jsx(Rt,{className:"text-right",children:"اختر دينًا لعرض إيصاله بالتفصيل"})]}),yt.length>0?e.jsx("div",{className:"max-h-64 overflow-y-auto space-y-2",children:yt.map(s=>e.jsx("div",{onClick:()=>{or(s),Ks(!0),Vs(!1),pa(!1)},className:"p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium",children:s.debtorName}),e.jsx("p",{className:"text-sm text-gray-600",children:s.reason}),e.jsx("p",{className:"text-sm text-gray-500",children:$r.format(s.createdAt instanceof Date?s.createdAt:new Date(s.createdAt))})]}),e.jsxs("div",{className:"text-left",children:[e.jsxs("p",{className:"font-bold text-lg",children:[s.amount," جنيه"]}),e.jsx(rt,{variant:s.status==="paid"?"default":"secondary",className:s.status==="paid"?"bg-green-500":"bg-yellow-500",children:s.status==="paid"?"مدفوع":"قيد المراجعة"})]})]})},s.id))}):e.jsx("div",{className:"text-center text-sm text-gray-500",children:"لا توجد ديون مسجلة"}),e.jsxs(Ne,{className:"flex justify-between mt-3",children:[e.jsx(o,{variant:"destructive",onClick:async()=>{try{if(!yt||yt.length===0){l({title:"لا توجد ديون",description:"القائمة فارغة بالفعل."});return}if(!window.confirm("هل تريد حذف كل إيصالات الديون؟ هذا الإجراء لا يمكن التراجع عنه."))return;const n=[];Et(n),or(null),await qt(n),l({title:"تم حذف كل إيصالات الديون",description:"تم تفريغ القائمة بالكامل."}),Vs(!1)}catch(s){console.error("تعذر حذف كل إيصالات الديون:",s),l({title:"فشل الحذف",description:"حدث خطأ أثناء الحذف، حاول مرة أخرى.",variant:"destructive"})}},children:"حذف كل الإيصالات"}),e.jsx(o,{variant:"outline",onClick:()=>Vs(!1),children:"إغلاق"})]})]})}),e.jsx(ie,{open:Di,onOpenChange:mr,children:e.jsxs(oe,{className:"sm:max-w-[480px]",children:[e.jsxs(ce,{children:[e.jsx(de,{className:"text-right",children:"إضافة عميل"}),e.jsx(Rt,{className:"text-right",children:"أدخل بيانات العميل ثم يمكنك تسجيل مبلغ دين عليه"})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(H,{htmlFor:"customerName",className:"text-right col-span-1",children:"اسم العميل"}),e.jsx($,{id:"customerName",value:xr,onChange:s=>bn(s.target.value),className:"col-span-3 text-right",placeholder:"اكتب اسم العميل"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(H,{htmlFor:"customerMobile",className:"text-right col-span-1",children:"رقم الموبايل"}),e.jsx($,{id:"customerMobile",value:ur,onChange:s=>Nn(s.target.value),className:"col-span-3 text-right",placeholder:"اكتب رقم الموبايل"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(o,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{if(!xr||!ur){l({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم العميل ورقم الموبايل",variant:"destructive"});return}const s={id:Date.now().toString(),name:xr.trim(),mobile:ur.trim(),createdAt:new Date},n=[s,...Vt];await zi(n),bn(""),Nn(""),l({title:"تمت إضافة العميل",description:`تم إضافة ${s.name}`})},children:"إضافة"})}),e.jsxs("div",{className:"border-t pt-4 space-y-3",children:[e.jsx(H,{className:"text-right block",children:"إضافة مبلغ على عميل"}),Vt.length>0?e.jsxs("div",{className:"space-y-3",children:[e.jsxs(Ps,{value:gr,onValueChange:wn,children:[e.jsx(Os,{className:"w-full",children:e.jsx(Ws,{placeholder:"اختر عميل"})}),e.jsx(Fs,{children:Vt.map(s=>e.jsxs(Bs,{value:s.id,children:[s.name," — ",s.mobile]},s.id))})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(H,{htmlFor:"customerDebtAmount",className:"text-right col-span-1",children:"المبلغ"}),e.jsx($,{id:"customerDebtAmount",type:"number",value:Sn,onChange:s=>Dn(s.target.value),className:"col-span-3 text-right",placeholder:"أدخل المبلغ"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(o,{className:"bg-orange-600 hover:bg-orange-700",onClick:async()=>{const s=parseFloat(Sn);if(!gr){l({title:"اختر عميل",description:"يرجى اختيار عميل أولاً",variant:"destructive"});return}if(isNaN(s)||s<=0){l({title:"قيمة غير صحيحة",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const n=Vt.find(c=>c.id===gr);if(!n)return;const r={id:Date.now().toString(),debtorName:n.name,customerId:n.id,mobile:n.mobile,amount:Number(s.toFixed(2)),reason:"دين عميل",status:"pending",createdAt:new Date,paidAmount:0,partialPayments:[]},i=[...yt,r];Et(i),await qt(i),wn(""),Dn(""),l({title:"تم تسجيل المبلغ على العميل",description:`تمت إضافة ${r.amount} جنيه للعميل ${n.name}`})},children:"إضافة المبلغ"})})]}):e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد عملاء مسجلين. أضف عميلًا أولاً."})]})]}),e.jsx(Ne,{className:"flex justify-end",children:e.jsx(o,{variant:"outline",onClick:()=>mr(!1),children:"إغلاق"})})]})}),e.jsx(ie,{open:te,onOpenChange:j,children:e.jsxs(oe,{className:"sm:max-w-[520px]",children:[e.jsxs(ce,{children:[e.jsx(de,{className:"text-right",children:"مصروفات المحل"}),e.jsx(Rt,{className:"text-right",children:"أدخل تفاصيل المصروف ثم اختر مصدر الخصم."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(H,{htmlFor:"expenseName",className:"text-right col-span-1",children:"اسم المصروف"}),e.jsx($,{id:"expenseName",value:le,onChange:s=>ne(s.target.value),className:"col-span-3 text-right",placeholder:"مثال: كهرباء، صيانة، مشتريات"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(H,{htmlFor:"expenseAmount",className:"text-right col-span-1",children:"تمن المصروف"}),e.jsx($,{id:"expenseAmount",type:"number",value:he,onChange:s=>Q(s.target.value),className:"col-span-3 text-right",placeholder:"0.00"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(H,{htmlFor:"expenseNotes",className:"text-right col-span-1",children:"ملاحظات"}),e.jsx($,{id:"expenseNotes",value:Z,onChange:s=>we(s.target.value),className:"col-span-3 text-right",placeholder:"معلومات إضافية إن وجدت"})]})]}),e.jsxs(Ne,{className:"flex justify-between",children:[e.jsx(o,{className:"bg-orange-600 hover:bg-orange-700",onClick:()=>{if(!le||!he){l({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم المصروف وقيمته",variant:"destructive"});return}ze(!0)},children:"إضافة مصروف"}),e.jsx(o,{variant:"outline",onClick:()=>jt(!0),children:"إيصالات المصاريف"})]})]})}),e.jsx(ie,{open:Ot,onOpenChange:jt,children:e.jsxs(oe,{className:"sm:max-w-[420px]",dir:"rtl",children:[e.jsxs(ce,{children:[e.jsx(de,{className:"text-right",children:"إيصالات المصاريف"}),e.jsx(Rt,{className:"text-right",children:"آخر المصاريف المسجلة"})]}),V.length>0?e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:V.map(s=>e.jsx("div",{className:"p-2 border rounded-lg bg-white hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium text-sm",children:s.name}),e.jsx("p",{className:"text-[11px] text-gray-600",children:s.notes||"بدون ملاحظات"}),e.jsx("p",{className:"text-[10px] text-gray-500",children:new Date(s.createdAt).toLocaleString("ar-EG")})]}),e.jsxs("div",{className:"text-left",children:[e.jsxs("p",{className:"font-bold text-sm",children:[s.amount," جنيه"]}),e.jsx(rt,{variant:"secondary",className:s.source==="cash"?"bg-blue-100 text-blue-700":"bg-purple-100 text-purple-700",children:s.source==="cash"?"من النقدية":`من المحفظة${s.walletId?` (${s.walletId})`:""}`})]})]})},s.id))}):e.jsx("p",{className:"text-sm text-gray-500 text-center",children:"لا توجد مصاريف مسجلة بعد"})]})}),e.jsx(ie,{open:We,onOpenChange:ze,children:e.jsxs(oe,{className:"sm:max-w-[480px]",children:[e.jsx(ce,{children:e.jsx(de,{className:"text-right",children:"اختيار مصدر خصم المصروف"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600 text-right",children:"اختر هل تريد خصم مبلغ المصروف من الرصيد النقدي في الدرج أم من إحدى المحافظ."}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsx(o,{variant:Ie==="cash"?"default":"outline",className:Ie==="cash"?"bg-blue-600 hover:bg-blue-700 text-white":"",onClick:()=>Te("cash"),children:"الفلوس النقدية"}),e.jsx(o,{variant:Ie==="wallet"?"default":"outline",className:Ie==="wallet"?"bg-purple-600 hover:bg-purple-700 text-white":"",onClick:()=>Te("wallet"),children:"أرصدة المحافظ"})]}),Ie==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{className:"text-right block",children:"اختر المحفظة للخصم"}),e.jsxs(Ps,{value:st,onValueChange:Je,children:[e.jsx(Os,{className:"w-full",children:e.jsx(Ws,{placeholder:"اختر محفظة"})}),e.jsx(Fs,{children:ye.map(s=>e.jsx(Bs,{value:s.id,children:s.phone||s.name||s.id},s.id))})]})]})]}),e.jsxs(Ne,{className:"flex justify-between",children:[e.jsx(o,{variant:"outline",onClick:()=>{ze(!1),Te(null),Je("")},children:"إلغاء"}),e.jsx(o,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{const s=Number(he);if(isNaN(s)||s<=0){l({title:"قيمة غير صحيحة",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}if(!Ie){l({title:"اختر مصدر الخصم",description:"يرجى اختيار النقدية أو المحفظة",variant:"destructive"});return}try{if(Ie==="cash"){const i=Number((Ee-s).toFixed(2));Qe(i),localStorage.setItem(Ve(),i.toString());const c={cashBalance:i,lastUpdated:new Date().toISOString()},y=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(y,JSON.stringify(c)),t!=null&&t.uid?(await je.updateUserData(t.uid,c),localStorage.removeItem(y),ge(!1)):ge(!0)}else if(Ie==="wallet"){if(!st){l({title:"اختر محفظة",description:"يرجى اختيار محفظة للخصم",variant:"destructive"});return}const i=ve[st]||0,c=Number((i-s).toFixed(2)),y={...ve,[st]:c};Be(y);const v=new Date().toISOString(),S={walletBalances:y,lastUpdated:v},O=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(O,JSON.stringify(S)),localStorage.setItem(Ue(),JSON.stringify(y)),localStorage.setItem(`walletBalances_backup_${v}`,JSON.stringify(y)),t!=null&&t.uid&&await je.updateUserData(t.uid,S)}}catch(i){console.error("خطأ أثناء تحديث الأرصدة عند حفظ المصروف:",i)}const n={id:Date.now().toString(),name:le,amount:s,notes:Z,source:Ie,walletId:Ie==="wallet"?st:void 0,createdAt:new Date},r=[...V,n];await Ui(r),ne(""),Q(""),we(""),Te(null),Je(""),ze(!1),j(!0),jt(!0),l({title:"تم إضافة المصروف",description:Ie==="cash"?"تم الخصم من النقدية":"تم الخصم من أرصدة المحافظ"})},children:"تأكيد الخصم"})]})]})}),e.jsx(ie,{open:re,onOpenChange:xe,children:e.jsxs(oe,{className:"sm:max-w-[520px]",children:[e.jsxs(ce,{children:[e.jsx(de,{className:"text-right",children:"النواقص"}),e.jsx(Rt,{className:"text-right",children:"سجل العناصر الناقصة التي تحتاج شراء وتابع حالتها."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(H,{htmlFor:"deficiencyName",className:"text-right col-span-1",children:"اسم العنصر"}),e.jsx($,{id:"deficiencyName",value:De,onChange:s=>Le(s.target.value),className:"col-span-3 text-right",placeholder:"مثال: سكر، زيت، مناديل"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(H,{htmlFor:"deficiencyQuantity",className:"text-right col-span-1",children:"الكمية"}),e.jsx($,{id:"deficiencyQuantity",type:"number",value:$e,onChange:s=>gt(s.target.value),className:"col-span-3 text-right",placeholder:"1"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(o,{className:"bg-rose-600 hover:bg-rose-700",onClick:()=>{if(qe){l({title:"غير متاح",description:"النواقص غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"});return}const s=parseInt($e||"1",10);if(!De){l({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم العنصر",variant:"destructive"});return}if(isNaN(s)||s<=0){l({title:"كمية غير صحيحة",description:"يرجى إدخال كمية صحيحة",variant:"destructive"});return}const n={id:Date.now().toString(),name:De,quantity:s,status:"pending",createdAt:new Date};wt(r=>{const i=[...r,n];return Dr(i),i}),Le(""),gt(""),l({title:"تمت الإضافة",description:"تمت إضافة العنصر إلى قائمة النواقص"})},children:"إضافة للنواقص"})}),Wt.length>0?e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:Wt.map(s=>e.jsx("div",{className:"p-2 border rounded-lg bg-white hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium text-sm",children:s.name}),e.jsxs("p",{className:"text-[11px] text-gray-600",children:["الكمية: ",s.quantity]}),e.jsx("p",{className:"text-[10px] text-gray-500",children:new Date(s.createdAt).toLocaleString("ar-EG")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(rt,{variant:"secondary",className:s.status==="pending"?"bg-rose-100 text-rose-700":"bg-green-100 text-green-700",children:s.status==="pending"?"قيد الشراء":"تم الشراء"}),e.jsx(o,{variant:"outline",className:s.status==="pending"?"text-green-700 border-green-300 hover:bg-green-50":"text-rose-700 border-rose-300 hover:bg-rose-50",onClick:()=>{wt(n=>{const r=n.map(i=>i.id===s.id?{...i,status:i.status==="pending"?"purchased":"pending"}:i);return Dr(r),r})},title:s.status==="pending"?"تم الشراء":"إلغاء الشراء",children:s.status==="pending"?"تم الشراء":"إلغاء الشراء"}),e.jsx(o,{variant:"outline",className:"text-red-700 border-red-300 hover:bg-red-50",onClick:()=>{wt(n=>{const r=n.filter(i=>i.id!==s.id);return Dr(r),r})},title:"حذف",children:"حذف"})]})]})},s.id))}):e.jsx("p",{className:"text-sm text-gray-500 text-center",children:"لا توجد عناصر مسجلة في النواقص"})]}),e.jsx(Ne,{className:"flex justify-end",children:e.jsx(o,{variant:"outline",onClick:()=>xe(!1),children:"إغلاق"})})]})}),e.jsx(ie,{open:Ci,onOpenChange:va,children:e.jsxs(oe,{className:"sm:max-w-[480px]",children:[e.jsx(ce,{children:e.jsx(de,{className:"text-right",children:"اختيار مصدر خصم الدين"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600 text-right",children:"اختر هل تريد خصم مبلغ الدين من الرصيد النقدي في الدرج أم من إحدى المحافظ أو تسجيله بدون خصم."}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsx(o,{variant:Ct==="cash"?"default":"outline",className:Ct==="cash"?"bg-blue-600 hover:bg-blue-700 text-white":"",onClick:()=>qs("cash"),children:"الفلوس النقدية"}),e.jsx(o,{variant:Ct==="wallet"?"default":"outline",className:Ct==="wallet"?"bg-purple-600 hover:bg-purple-700 text-white":"",onClick:()=>qs("wallet"),children:"أرصدة المحافظ"}),e.jsx(o,{variant:Ct==="none"?"default":"outline",className:Ct==="none"?"bg-gray-600 hover:bg-gray-700 text-white":"",onClick:()=>qs("none"),children:"بدون خصم"})]}),Ct==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{className:"text-right block",children:"اختر المحفظة للخصم"}),e.jsxs(Ps,{value:ya,onValueChange:vr,children:[e.jsx(Os,{className:"w-full",children:e.jsx(Ws,{placeholder:"اختر محفظة"})}),e.jsx(Fs,{children:ye.map(s=>e.jsx(Bs,{value:s.id,children:s.phone||s.name||s.id},s.id))})]})]})]}),e.jsxs(Ne,{className:"flex justify-between",children:[e.jsx(o,{variant:"outline",onClick:()=>{va(!1),fr(null),qs(null),vr("")},children:"إلغاء"}),e.jsx(o,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{if(!pr)return;const s=Number(pr.amount);if(!Ct){l({title:"اختر مصدر الخصم",description:"يرجى اختيار النقدية أو المحفظة",variant:"destructive"});return}try{if(Ct==="cash"){const r=Number((Ee-s).toFixed(2));Qe(r),localStorage.setItem(Ve(),r.toString());const i=new Date().toISOString(),c={cashBalance:r,lastUpdated:i},y=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(y,JSON.stringify(c)),t!=null&&t.uid?await je.updateUserData(t.uid,c).then(()=>{localStorage.removeItem(y),ge(!1)}).catch(()=>{ge(!0)}):ge(!0)}else if(Ct==="wallet"){if(!ya){l({title:"اختر محفظة",description:"يرجى اختيار محفظة للخصم",variant:"destructive"});return}const r=ve[ya]||0,i=Number((r-s).toFixed(2)),c={...ve,[ya]:i};Be(c);const y=new Date().toISOString(),v={walletBalances:c,lastUpdated:y},S=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(S,JSON.stringify(v)),localStorage.setItem(Ue(),JSON.stringify(c)),localStorage.setItem(`walletBalances_backup_${y}`,JSON.stringify(c)),t!=null&&t.uid&&await je.updateUserData(t.uid,v)}}catch(r){console.error("خطأ أثناء تحديث الأرصدة عند حفظ الدين:",r)}const n=[...yt,pr];Et(n),await qt(n),fn(""),vn(""),yn(""),pa(!1),va(!1),fr(null),qs(null),vr(""),l(Ct==="none"?{title:"تم حفظ الدين بدون خصم",description:"لم يتم الخصم من الدرج أو المحافظ"}:{title:"تم حفظ الدين وخصم المبلغ",description:Ct==="cash"?`تم خصم ${s} من الرصيد النقدي`:`تم خصم ${s} من رصيد المحفظة`})},children:"تأكيد الخصم وحفظ الدين"})]})]})}),e.jsx(ie,{open:Ni,onOpenChange:Ks,children:e.jsxs(oe,{className:"sm:max-w-[425px] z-[60]",children:[e.jsx(ce,{children:e.jsx(de,{className:"text-right",children:"إيصال الدين"})}),ue&&e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"text-center border-b pb-4",children:[e.jsx("h2",{className:"text-xl font-bold",children:"إيصال دين"}),e.jsx("p",{className:"text-sm text-gray-500",children:$r.format(ue.createdAt instanceof Date?ue.createdAt:new Date(ue.createdAt))})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"اسم المديون:"}),e.jsx("span",{children:ue.debtorName})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"المبلغ:"}),e.jsxs("span",{className:"font-bold text-lg",children:[ue.amount," جنيه"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"سبب الدين:"}),e.jsx("span",{children:ue.reason})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"الحالة:"}),e.jsx(rt,{variant:ue.status==="paid"?"default":"secondary",className:ue.status==="paid"?"bg-green-500":"bg-yellow-500",children:ue.status==="paid"?"مدفوع":"مؤجل"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"المبلغ المتبقي:"}),e.jsxs("span",{className:"font-bold text-lg",children:[Math.max(0,Number(ue.amount||0)-Number(ue.paidAmount||0))," جنيه"]})]}),ue.paidAmount?e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"إجمالي المدفوع:"}),e.jsxs("span",{className:"text-green-700",children:[ue.paidAmount," جنيه"]})]}):null,e.jsxs("div",{className:"mt-3 p-3 border rounded-lg bg-gray-50",children:[wi?e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"partialAmount",className:"text-right block",children:"المبلغ المراد دفعه"}),e.jsx($,{id:"partialAmount",type:"number",value:jn,onChange:s=>dr(s.target.value),className:"text-right",placeholder:"أدخل المبلغ"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(o,{variant:"outline",onClick:()=>{cr(!1),dr("")},children:"إلغاء"}),e.jsx(o,{className:"bg-blue-600 hover:bg-blue-700",onClick:async()=>{const s=parseFloat(jn);if(!ue||isNaN(s)||s<=0){l({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const n=Math.max(0,Number(ue.amount||0)-Number(ue.paidAmount||0));if(s>n){l({title:"مبلغ زائد",description:"المبلغ المدفوع أكبر من المتبقي",variant:"destructive"});return}const r=Number(((ue.paidAmount||0)+s).toFixed(2)),i=r>=Number(ue.amount||0),c={...ue,amount:Number(ue.amount||0),paidAmount:r,status:i?"paid":"pending",partialPayments:[...ue.partialPayments||[],{amount:s,paidAt:new Date}]},y=yt.map(v=>v.id===ue.id?c:v);Et(y),or(c),await qt(y);try{c.status==="paid"&&(t!=null&&t.uid)&&(async()=>{const v=ra(ps(ut,"userTransactions"),Pt("userId","==",t.uid),Pt("linkedDebtId","==",ue.id),Pt("status","==","pending")),S=await na(v);await Promise.allSettled(S.docs.map(O=>la(O.ref,{status:"completed",confirmedAt:new Date})))})().catch(v=>console.error("تعذر تحديث حالة المعاملات المرتبطة بالدين:",v))}catch(v){console.error("تعذر تجهيز تحديث حالة المعاملات المرتبطة:",v)}try{const v=Ys(),S=localStorage.getItem(v);if(S){const A=(JSON.parse(S)||[]).map(w=>(w==null?void 0:w.linkedDebtId)===ue.id&&(w==null?void 0:w.status)==="pending"?{...w,status:"completed",confirmedAt:new Date}:w);localStorage.setItem(v,JSON.stringify(A)),it(w=>w.map(F=>(F==null?void 0:F.linkedDebtId)===ue.id&&(F==null?void 0:F.status)==="pending"?{...F,status:"completed",confirmedAt:new Date}:F))}}catch(v){console.warn("فشل تحديث حالة المعاملات المرتبطة محلياً بعد سداد الدين:",v)}ja(s),hs("cash"),Ts(!0),cr(!1),dr(""),l({title:"تم تسجيل دفع جزء",description:`تم دفع ${s} جنيه بتاريخ ${new Date().toLocaleString("ar-EG")}`})},children:"دفع"})]})]}):e.jsx(o,{variant:"outline",className:"w-full",onClick:()=>cr(!0),children:"دفع جزء"}),ue.partialPayments&&ue.partialPayments.length>0&&e.jsxs("div",{className:"mt-3 text-xs text-gray-600",children:[e.jsx("p",{className:"font-medium mb-1",children:"سجل الدفعات الجزئية:"}),e.jsx("div",{className:"space-y-1 max-h-24 overflow-y-auto",children:ue.partialPayments.map((s,n)=>e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{children:["دفع: ",s.amount," جنيه"]}),e.jsx("span",{children:new Date(s.paidAt).toLocaleString("ar-EG")})]},n))})]})]})]})]}),e.jsxs(Ne,{className:"flex gap-2 justify-center",children:[e.jsx(o,{onClick:async()=>{if(ue){const s=yt.map(n=>n.id===ue.id?{...n,status:"pending"}:n);Et(s),await qt(s),Ks(!1),l({title:"تم تحديث حالة الدين",description:"تم تعيين الدين كمؤجل"})}},variant:"outline",className:"bg-yellow-500 hover:bg-yellow-600 text-white",children:"مؤجل"}),e.jsx(o,{onClick:async()=>{if(ue){const n=Math.max(0,Number(ue.amount||0)-Number(ue.paidAmount||0)),r=yt.map(i=>i.id===ue.id?{...i,amount:Number(i.amount||0),paidAmount:Number(((i.paidAmount||0)+n).toFixed(2)),status:"paid",partialPayments:[...i.partialPayments||[],...n>0?[{amount:n,paidAt:new Date}]:[]]}:i);Et(r),n>0&&(ja(n),hs("cash"),Ts(!0)),await qt(r);try{t!=null&&t.uid&&(ue!=null&&ue.id)&&(async()=>{const i=ra(ps(ut,"userTransactions"),Pt("userId","==",t.uid),Pt("linkedDebtId","==",ue.id),Pt("status","==","pending")),c=await na(i);await Promise.allSettled(c.docs.map(y=>la(y.ref,{status:"completed",confirmedAt:new Date})))})().catch(i=>console.error("تعذر تحديث حالة المعاملات المرتبطة بالدين:",i))}catch(i){console.error("تعذر تجهيز تحديث حالة المعاملات المرتبطة:",i)}try{const i=Ys(),c=localStorage.getItem(i);if(c){const v=(JSON.parse(c)||[]).map(S=>(S==null?void 0:S.linkedDebtId)===ue.id&&(S==null?void 0:S.status)==="pending"?{...S,status:"completed",confirmedAt:new Date}:S);localStorage.setItem(i,JSON.stringify(v)),it(S=>S.map(O=>(O==null?void 0:O.linkedDebtId)===ue.id&&(O==null?void 0:O.status)==="pending"?{...O,status:"completed",confirmedAt:new Date}:O))}}catch(i){console.warn("فشل تحديث حالة المعاملات المرتبطة محلياً بعد سداد الدين:",i)}Ks(!1),l({title:"تم تحديث حالة الدين",description:"تم تعيين الدين كمدفوع"})}},className:"bg-green-500 hover:bg-green-600",children:"مدفوع"}),e.jsx(o,{onClick:async()=>{if(ue){const s=yt.filter(n=>n.id!==ue.id);Et(s),await qt(s),Ks(!1),l({title:"تم حذف الدين",description:"تم حذف الدين بنجاح"})}},variant:"destructive",children:"حذف"})]})]})}),e.jsx(ie,{open:Ii,onOpenChange:Ts,children:e.jsxs(oe,{className:"sm:max-w-[425px]",children:[e.jsxs(ce,{children:[e.jsx(de,{className:"text-right",children:"اختيار إضافة مبلغ السداد"}),e.jsx(Rt,{className:"text-right",children:"هل تريد إضافة مبلغ السداد إلى الفلوس النقدية أم إلى إحدى المحافظ؟"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(o,{variant:Lt==="cash"?"default":"outline",className:Lt==="cash"?"bg-blue-600 text-white":"",onClick:()=>hs("cash"),children:"الفلوس النقدية"}),e.jsx(o,{variant:Lt==="wallet"?"default":"outline",className:Lt==="wallet"?"bg-blue-600 text-white":"",onClick:()=>hs("wallet"),children:"أرصدة المحافظ"}),e.jsx(o,{variant:Lt==="none"?"default":"outline",className:Lt==="none"?"bg-gray-600 text-white":"",onClick:()=>hs("none"),children:"بدون إضافة"})]}),Lt==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-right",children:"اختر المحفظة"}),e.jsxs("select",{className:"w-full border rounded p-2 text-right",value:xs,onChange:s=>yr(s.target.value),children:[e.jsx("option",{value:"",children:"— اختر محفظة —"}),ye&&ye.length>0?ye.map(s=>e.jsx("option",{value:s.id,children:s.phone||s.name||s.id},s.id)):Object.keys(ve||{}).map(s=>{var n,r,i,c,y,v;return e.jsx("option",{value:s,children:((n=ye.find(S=>S.id===s))==null?void 0:n.phone)||((i=(r=JSON.parse(localStorage.getItem(ks())||"[]"))==null?void 0:r.find(S=>S.id===s))==null?void 0:i.phone)||((y=(c=JSON.parse(localStorage.getItem(ks())||"[]"))==null?void 0:c.find(S=>S.id===s))==null?void 0:y.name)||((v=ye.find(S=>S.id===s))==null?void 0:v.name)||s},s)})]})]}),e.jsxs("div",{className:"text-right text-sm text-gray-600",children:["المبلغ المراد إضافته: ",e.jsxs("span",{className:"font-bold",children:[Cn," جنيه"]})]})]}),e.jsxs(Ne,{className:"flex justify-end",children:[e.jsx(o,{variant:"outline",onClick:()=>{Ts(!1),ja(0),hs(null),yr("")},children:"إلغاء"}),e.jsx(o,{onClick:async()=>{var s,n;try{const r=Cn;if(!r||r<=0){Ts(!1);return}if(Lt==="cash"){const i=Ee+r;Qe(i),localStorage.setItem(Ve(),i.toString());const c={cashBalance:i,lastUpdated:new Date().toISOString()},y=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(y,JSON.stringify(c)),t!=null&&t.uid?(je.updateUserData(t.uid,c).catch(()=>ge(!0)),localStorage.removeItem(y),ge(!1)):ge(!0),l({title:"تمت إضافة مبلغ السداد",description:`تمت إضافة ${r} جنيه إلى الفلوس النقدية`})}else if(Lt==="wallet"){if(!xs){l({title:"اختر محفظة أولاً",description:"يرجى اختيار المحفظة لإضافة مبلغ السداد إليها",variant:"destructive"});return}const i={...ve,[xs]:(ve[xs]||0)+r};Be(i);const c=(Ee||0)-r;Qe(c),localStorage.setItem(Ve(),c.toString());const y=new Date().toISOString(),v={walletBalances:i,cashBalance:c,lastUpdated:y},S=`userData_${t==null?void 0:t.uid}`;if(localStorage.setItem(S,JSON.stringify(v)),localStorage.setItem(Ue(),JSON.stringify(i)),localStorage.setItem(`walletBalances_backup_${y}`,JSON.stringify(i)),t!=null&&t.uid){je.updateUserData(t.uid,v).catch(()=>ge(!0));try{localStorage.removeItem(S)}catch{}ge(!1)}else ge(!0);l({title:"تمت إضافة مبلغ السداد",description:`تمت إضافة ${r} جنيه إلى المحفظة ${((s=ye.find(O=>O.id===xs))==null?void 0:s.phone)||((n=ye.find(O=>O.id===xs))==null?void 0:n.name)||xs} وتم خصم نفس المبلغ من درج النقدية`})}else if(Lt==="none"){const i=(Ee||0)-r;Qe(i),localStorage.setItem(Ve(),i.toString());const c={cashBalance:i,lastUpdated:new Date().toISOString()},y=`userData_${t==null?void 0:t.uid}`;if(localStorage.setItem(y,JSON.stringify(c)),t!=null&&t.uid){je.updateUserData(t.uid,c).catch(()=>ge(!0));try{localStorage.removeItem(y)}catch{}ge(!1)}else ge(!0);l({title:"تم تسجيل السداد",description:`تم خصم ${r} جنيه من درج النقدية بدون إضافة للمحافظ`})}else{l({title:"اختر مصدر الإضافة",description:"يرجى اختيار إضافة المبلغ إلى النقدية أو المحفظة",variant:"destructive"});return}}catch(r){console.error("خطأ أثناء إضافة مبلغ السداد:",r),l({title:"حدث خطأ",description:"تعذر إضافة مبلغ السداد، حاول مرة أخرى",variant:"destructive"})}finally{Ts(!1),ja(0),hs(null),yr("")}},className:"bg-green-600 hover:bg-green-700",children:"تأكيد الإضافة"})]})]})}),e.jsx(ie,{open:ci,onOpenChange:ua,children:e.jsxs(oe,{hideClose:!0,className:"sm:max-w-[420px] w-[90vw] rounded-2xl bg-gradient-to-br from-white via-indigo-50 to-blue-50 shadow-2xl border border-indigo-100",children:[e.jsxs(ce,{children:[e.jsx(de,{className:"text-right text-2xl font-bold",children:(vt==null?void 0:vt.type)==="transfer"?"مبلغ يجب استلامه":"مبلغ يجب تسليمه"}),e.jsx(Rt,{className:"text-right text-gray-600",children:(vt==null?void 0:vt.type)==="transfer"?"هذا هو المبلغ الواجب استلامه من العميل بعد التأكيد.":"هذا هو المبلغ الواجب تسليمه للعميل بعد التأكيد."})]}),e.jsxs("div",{className:"py-4 flex flex-col items-center gap-2",children:[e.jsxs("div",{className:"text-4xl font-extrabold text-blue-700 tracking-wider",children:[vt==null?void 0:vt.amount," جنيه"]}),e.jsx("div",{className:"text-sm text-gray-500 text-right w-full",children:(vt==null?void 0:vt.type)==="transfer"?"المبلغ المعروض شامل عمولة التحويل.":b?"العمولة مضافة ولا تؤثر على قيمة التسليم.":"العمولة مخصومة من المبلغ المسلّم للعميل."})]}),e.jsx(Ne,{className:"flex justify-end gap-2",children:e.jsx(o,{onClick:()=>{ua(!1),Xa(null)},className:"bg-green-600 hover:bg-green-700 text-white",children:(vt==null?void 0:vt.type)==="transfer"?"تم الاستلام":"تم التسليم"})})]})})]}))};export{tm as default};
