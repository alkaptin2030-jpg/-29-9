const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-CimEj1on.js","assets/index-qYnlXcqU.css","assets/walletDailyLimitsService-BqIuU0I5.js","assets/profitService-WOL_cZ8K.js","assets/reportsService-Bp1Io21u.js"])))=>i.map(i=>d[i]);
var Ko=Object.defineProperty;var qo=(l,u,o)=>u in l?Ko(l,u,{enumerable:!0,configurable:!0,writable:!0,value:o}):l[u]=o;var an=(l,u,o)=>qo(l,typeof u!="symbol"?u+"":u,o);import{c as Gt,Q as Vo,U as Yo,u as ds,r as a,j as e,a7 as ba,K as Vs,a5 as ps,aY as or,C as Os,d as Qt,a as Wl,a6 as vt,a0 as Fl,$ as El,_ as xs,aR as rr,R as He,F as ga,n as Ho,S as ls,W as ya,q as Is,f as ns,g as ot,a3 as It,h as ks,a8 as vn,Z as Ys,k as Yt,J as Js,aV as Go,a4 as Sl,B as Qo,D as Bl,H as Zo,aZ as Xo,x as Fs,an as Dl,a_ as Ll,a9 as Se,z as ec,al as tc,aU as sc,p as ac,m as rc,Y as xa,ao as nc,ap as lc,aT as ic,e as rn,am as Xa,t as er,aO as oc,aP as cc}from"./index-CimEj1on.js";import{C as qe,a as gt,b as kt,d as Ge}from"./card-C03rjQZd.js";import{B as d,b as Ml}from"./button-BdjWSNzG.js";import{I as R}from"./input-ltQLkBW9.js";import{B as mt}from"./badge-C0klVrIE.js";import{S as ws,a as Ss,b as Ds,c as Cs,d as Vt,C as bn,e as $l}from"./select-CiawprGc.js";import{D as ie,a as oe,b as ce,c as de,f as Rl,T as dc,O as mc,W as hc,C as uc,g as xc,h as pc,i as Ul,R as gc,P as fc,d as Rt,e as Ce}from"./dialog-BV04mDgY.js";import{L as V}from"./label-CyoiX7VE.js";import{M as As,a as is}from"./MasterPinDialog-BBY_nu-E.js";import{walletDailyLimitsService as os}from"./walletDailyLimitsService-BqIuU0I5.js";import{T as Ot,P as nr}from"./progress-BeKu7Cn-.js";import{W as Ht}from"./wallet-CLwkzWyh.js";import{S as _l}from"./star-Bttc7oDm.js";import{S as zl}from"./square-pen-ChHFNUWP.js";import{P as cs}from"./phone-BrKI88gh.js";import{A as Jl}from"./arrow-left-DePqcBiJ.js";import{a as un,S as vc}from"./index.esm-DtXOp1JF.js";import{C as gs}from"./calendar-DgbedGGs.js";import{C as xn}from"./chart-column-CeLWnqVw.js";import{D as Qe}from"./dollar-sign-CLJy3IbH.js";import{A as nn,B as Cl}from"./bell-B6ZwTn3p.js";import{C as Es}from"./circle-alert-C5oo2V2M.js";import{C as yn}from"./circle-x-DH246GNY.js";import{C as Ps}from"./circle-check-big-CW2796JV.js";import{a as rt,E as Wt}from"./eye-1gMGYrBb.js";import{S as bc}from"./store-BG2AWimS.js";import{A as yc}from"./arrow-right-wnHMPMrq.js";import{U as pn}from"./user-BMeIMF8a.js";import{c as jc,C as Kl,D as Nc,a as wc,R as Sc,P as ln,b as Dc,M as Cc}from"./PasswordConfirmDialog-DfibJPFc.js";import{L as Ws}from"./lock-fdnhpjOE.js";import{M as Ts}from"./minus-CR8-jt5x.js";import{w as Ic,W as kc}from"./WalletsManagement-Csth6Jnt.js";import{reportsService as qt}from"./reportsService-Bp1Io21u.js";import{P as Tc}from"./ProfileIcon-C9PC_zm2.js";import{a as Ac,E as Pc}from"./broadcastService-DNzf4spD.js";import{D as Oc,a as Wc,b as Fc,c as Ec,d as Bc}from"./dropdown-menu-8JXOSSbL.js";import{S as on}from"./shield-CSzx6zLT.js";import{G as Lc}from"./gift-Cywda3OK.js";import{ProfitService as Hs}from"./profitService-WOL_cZ8K.js";import{R as Mc}from"./refresh-cw-C7hIuv4k.js";import"./index-Bu4sbXMs.js";import"./Combination-DbbQWOnF.js";import"./index-CuOYxezB.js";import"./whatsappService-Mp_sewEL.js";import"./avatars-cIWENqcm.js";import"./index-ClmrRHWk.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const lr=Gt("ArrowDownLeft",[["path",{d:"M17 7 7 17",key:"15tmo1"}],["path",{d:"M17 17H7V7",key:"1org7z"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ql=Gt("ArrowRightLeft",[["path",{d:"m16 3 4 4-4 4",key:"1x1c3m"}],["path",{d:"M20 7H4",key:"zbl0bi"}],["path",{d:"m8 21-4-4 4-4",key:"h9nckh"}],["path",{d:"M4 17h16",key:"g4d7ey"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $c=Gt("Award",[["path",{d:"m15.477 12.89 1.515 8.526a.5.5 0 0 1-.81.47l-3.58-2.687a1 1 0 0 0-1.197 0l-3.586 2.686a.5.5 0 0 1-.81-.469l1.514-8.526",key:"1yiouv"}],["circle",{cx:"12",cy:"8",r:"6",key:"1vp47v"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Rc=Gt("Banknote",[["rect",{width:"20",height:"12",x:"2",y:"6",rx:"2",key:"9lu3g6"}],["circle",{cx:"12",cy:"12",r:"2",key:"1c9p78"}],["path",{d:"M6 12h.01M18 12h.01",key:"113zkx"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Uc=Gt("BookOpen",[["path",{d:"M12 7v14",key:"1akyts"}],["path",{d:"M3 18a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h5a4 4 0 0 1 4 4 4 4 0 0 1 4-4h5a1 1 0 0 1 1 1v13a1 1 0 0 1-1 1h-6a3 3 0 0 0-3 3 3 3 0 0 0-3-3z",key:"ruj8y"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Vl=Gt("Building",[["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",ry:"2",key:"76otgf"}],["path",{d:"M9 22v-4h6v4",key:"r93iot"}],["path",{d:"M8 6h.01",key:"1dz90k"}],["path",{d:"M16 6h.01",key:"1x0f13"}],["path",{d:"M12 6h.01",key:"1vi96p"}],["path",{d:"M12 10h.01",key:"1nrarc"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M16 10h.01",key:"1m94wz"}],["path",{d:"M16 14h.01",key:"1gbofw"}],["path",{d:"M8 10h.01",key:"19clt8"}],["path",{d:"M8 14h.01",key:"6423bh"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ir=Gt("IdCard",[["path",{d:"M16 10h2",key:"8sgtl7"}],["path",{d:"M16 14h2",key:"epxaof"}],["path",{d:"M6.17 15a3 3 0 0 1 5.66 0",key:"n6f512"}],["circle",{cx:"9",cy:"11",r:"2",key:"yxgjnd"}],["rect",{x:"2",y:"5",width:"20",height:"14",rx:"2",key:"qneu4z"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const gn=Gt("Info",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const tr=Gt("Package",[["path",{d:"M11 21.73a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73z",key:"1a0edw"}],["path",{d:"M12 22V12",key:"d0xqtd"}],["path",{d:"m3.3 7 7.703 4.734a2 2 0 0 0 1.994 0L20.7 7",key:"yx3hmr"}],["path",{d:"m7.5 4.27 9 5.15",key:"1c824w"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fa=Gt("TrendingDown",[["polyline",{points:"22 17 13.5 8.5 8.5 13.5 2 7",key:"1r2t7k"}],["polyline",{points:"16 17 22 17 22 11",key:"11uiuu"}]]),_c=async(l={})=>{try{return(await Vo(Yo,"getLastTransactions")(l)).data}catch(u){throw console.error("Error getting last transactions:",u),u.code==="functions/unauthenticated"?new Error("يجب تسجيل الدخول للوصول إلى المعاملات"):u.code==="functions/invalid-argument"?new Error("بيانات الاستعلام غير صالحة: "+u.message):u.code==="functions/permission-denied"?new Error("ليس لديك صلاحية للوصول إلى هذه المعاملات: "+u.message):new Error("حدث خطأ أثناء جلب المعاملات: "+(u.message||"خطأ غير معروف"))}},zc=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],Jc=({isOpen:l,onClose:u,onWalletSelect:o,onEditWallet:x,onDeleteWallet:y})=>{const{user:g}=ds(),[t,$]=a.useState([]),[D,p]=a.useState(!1),h=()=>`wallets_${(g==null?void 0:g.uid)||"default"}`,N=()=>{try{const T=h(),k=localStorage.getItem(T);if(k){const se=JSON.parse(k);if(Array.isArray(se)&&se.length>0)return se}const K="wallets_default",U=localStorage.getItem(K);if(U){const se=JSON.parse(U);if(Array.isArray(se)&&se.length>0){localStorage.setItem(T,U);try{localStorage.removeItem(K)}catch{}return se}}const O=Object.keys(localStorage).filter(se=>se.startsWith("wallets_")&&se!==T);let q=null,ue=null;for(const se of O)try{const ve=localStorage.getItem(se);if(!ve)continue;const Y=JSON.parse(ve);Array.isArray(Y)&&Y.length>0&&(!q||Y.length>((q==null?void 0:q.length)||0))&&(q=Y,ue=se)}catch{}if(q&&ue){localStorage.setItem(T,JSON.stringify(q));try{localStorage.removeItem(ue)}catch{}return q}}catch(T){console.warn("WalletsViewPage migration failed:",T)}return null},b=async(T,k)=>{const K=new Date().getMonth(),U=new Date().getFullYear(),O=k.filter(Y=>{const ee=new Date(Y.createdAt);return ee.getMonth()===K&&ee.getFullYear()===U&&Y.lineId===T}),q=Y=>{const ee=Y.type;return Y.txnType==="receive"||ee==="withdraw"||ee==="withdrawal"||ee==="receive"},ue=Y=>{const ee=Y.type;return Y.txnType==="send"||ee==="send"||ee==="transfer"},se=O.filter(q).reduce((Y,ee)=>{const Te=ee.withdrawnAmount!==void 0?ee.withdrawnAmount:ee.amount;return Y+(Te||0)},0),ve=O.filter(ue).reduce((Y,ee)=>{const Te=ee.sentAmount!==void 0?ee.sentAmount:ee.amount;return Y+(Te||0)},0);return{withdrawalUsage:se,transferUsage:ve}},E=T=>{const k=new Date().toISOString().split("T")[0],K=T.lastResetDate;if(!K)return{...T,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:k};const U=new Date(K),O=new Date;return U.getMonth()!==O.getMonth()||U.getFullYear()!==O.getFullYear()?{...T,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:k}:T};a.useEffect(()=>{if(!(g!=null&&g.uid)||!l)return;(async()=>{p(!0);try{const k=await ps.getByMerchantId(g.uid),K=await or.getByUserId(g.uid),O=(await Promise.all(k.map(async q=>{const{withdrawalUsage:ue,transferUsage:se}=await b(q.id,K);return{id:q.id,name:q.label||"محفظة بدون اسم",phone:q.msisdn,nationalId:q.nationalId||"",isDefault:!1,monthlyWithdrawalLimit:q.withdrawLimit||2e5,monthlyTransferLimit:q.transferLimit||2e5,monthlyWithdrawalUsage:ue,monthlyTransferUsage:se,lastResetDate:new Date().toISOString().split("T")[0],walletProvider:q.walletProvider||""}}))).map(E);if($(O),!O||O.length===0){const q=N();q&&q.length>0&&$(q.map(E))}}catch(k){console.error("Error loading wallets:",k);const K=N();K&&$(K.map(U=>({...U,phone:U.phone||U.phoneNumber,monthlyWithdrawalLimit:U.monthlyWithdrawalLimit||2e5,monthlyTransferLimit:U.monthlyTransferLimit||2e5})))}finally{p(!1)}})()},[g==null?void 0:g.uid,l]);const z=T=>zc.find(k=>k.id===T),Z=(T,k)=>k>0?Math.min(T/k*100,100):0,L=T=>new Intl.NumberFormat("ar-EG").format(T);return e.jsx(ie,{open:l,onOpenChange:u,children:e.jsxs(oe,{className:"max-w-6xl max-h-[90vh] overflow-y-auto",children:[e.jsx(ce,{className:"pb-4",children:e.jsxs(de,{className:"flex items-center gap-2 text-lg",children:[e.jsx(Ht,{className:"h-5 w-5"}),"الاطلاع على جميع المحافظ",e.jsxs(mt,{variant:"secondary",className:"mr-2",children:[t.length," محفظة"]})]})}),D?e.jsx("div",{className:"flex justify-center items-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-600",children:"جاري تحميل المحافظ..."})]})}):t.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Ht,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"لا توجد محافظ مضافة حتى الآن"})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:t.map(T=>{const k=z(T.walletProvider||""),K=Z(T.monthlyWithdrawalUsage||0,T.monthlyWithdrawalLimit),U=Z(T.monthlyTransferUsage||0,T.monthlyTransferLimit);return e.jsxs(qe,{className:"cursor-pointer hover:shadow-lg transition-shadow border-2 hover:border-blue-300",onClick:()=>o(T),children:[e.jsx(gt,{className:"pb-3",children:e.jsxs(kt,{className:"flex items-center justify-between text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ba,{className:"h-4 w-4"}),e.jsx("span",{children:T.name})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[T.isDefault&&e.jsxs(mt,{variant:"default",className:"text-xs",children:[e.jsx(_l,{className:"h-3 w-3 mr-1"}),"افتراضية"]}),e.jsx(d,{variant:"ghost",size:"sm",onClick:O=>{O.stopPropagation(),x==null||x(T)},className:"h-7 px-2",children:e.jsx(zl,{className:"h-4 w-4"})}),e.jsx(d,{variant:"ghost",size:"sm",onClick:O=>{O.stopPropagation(),y==null||y(T.id)},className:"h-7 px-2 text-destructive hover:text-destructive",children:e.jsx(Ot,{className:"h-4 w-4"})})]})]})}),e.jsxs(Ge,{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(cs,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"font-mono",children:T.phone})]}),T.nationalId&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(ir,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"font-mono",children:T.nationalId})]}),k&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Vl,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{children:k.name})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(fa,{className:"h-3 w-3 text-red-500"}),"السحب الشهري"]}),e.jsxs("span",{className:"font-mono",children:[L(T.monthlyWithdrawalUsage||0)," / ",L(T.monthlyWithdrawalLimit)]})]}),e.jsx(nr,{value:K,className:"h-2"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Vs,{className:"h-3 w-3 text-green-500"}),"التحويل الشهري"]}),e.jsxs("span",{className:"font-mono",children:[L(T.monthlyTransferUsage||0)," / ",L(T.monthlyTransferLimit)]})]}),e.jsx(nr,{value:U,className:"h-2"})]}),e.jsx(d,{variant:"outline",size:"sm",className:"w-full text-xs",onClick:O=>{O.stopPropagation(),o(T)},children:"عرض التفاصيل الكاملة"})]})]},T.id)})}),e.jsx("div",{className:"flex justify-end pt-4 border-t",children:e.jsxs(d,{onClick:u,variant:"outline",children:[e.jsx(Jl,{className:"h-4 w-4 mr-2"}),"إغلاق"]})})]})})},Kc=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],qc=({wallet:l,isOpen:u,onClose:o,onBack:x})=>{const{user:y}=ds(),[g,t]=a.useState([]),[$,D]=a.useState(!1),[p,h]=a.useState("month");if(a.useEffect(()=>{if(!l||!(y!=null&&y.uid)||!u)return;(async()=>{D(!0);try{const Fe=(await or.getByUserId(y.uid)).filter(nt=>nt.walletId===l.id).sort((nt,ht)=>new Date(ht.createdAt).getTime()-new Date(nt.createdAt).getTime());t(Fe)}catch(re){console.error("Error loading transactions:",re)}finally{D(!1)}})()},[l,y==null?void 0:y.uid,u]),!l)return null;const N=G=>Kc.find(re=>re.id===G),b=(G,re)=>re>0?Math.min(G/re*100,100):0,E=G=>new Intl.NumberFormat("ar-EG").format(G),z=G=>new Date(G).toLocaleDateString("ar-EG",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}),L=(()=>{const G=new Date;let re;switch(p){case"week":re=new Date(G.getTime()-7*24*60*60*1e3);break;case"month":re=new Date(G.getFullYear(),G.getMonth(),1);break;default:return g}return g.filter(Fe=>new Date(Fe.createdAt)>=re)})(),T=G=>{const re=G.type,Fe=G.txnType;return re==="withdraw"||re==="withdrawal"||re==="receive"||Fe==="receive"},k=G=>{const re=G.type,Fe=G.txnType;return re==="send"||re==="transfer"||Fe==="send"},K=L.filter(G=>T(G)&&G.status==="completed").reduce((G,re)=>{const Fe=re.withdrawnAmount!==void 0?re.withdrawnAmount:re.amount;return G+(Fe||0)},0),U=L.filter(G=>k(G)&&G.status==="completed").reduce((G,re)=>{const Fe=re.sentAmount!==void 0?re.sentAmount:re.amount;return G+(Fe||0)},0),O=L.filter(G=>G.type==="deposit"&&G.status==="completed").reduce((G,re)=>G+re.amount,0),q=N(l.walletProvider||""),ue=b(l.monthlyWithdrawalUsage||0,l.monthlyWithdrawalLimit),se=b(l.monthlyTransferUsage||0,l.monthlyTransferLimit),ve=G=>{switch(G){case"withdrawal":return e.jsx(fa,{className:"h-4 w-4 text-red-500"});case"transfer":return e.jsx(Vs,{className:"h-4 w-4 text-blue-500"});case"deposit":return e.jsx(Qe,{className:"h-4 w-4 text-green-500"});default:return e.jsx(nn,{className:"h-4 w-4 text-gray-500"})}},Y=G=>{switch(G){case"completed":return e.jsx(Ps,{className:"h-4 w-4 text-green-500"});case"pending":return e.jsx(Os,{className:"h-4 w-4 text-yellow-500"});case"failed":return e.jsx(yn,{className:"h-4 w-4 text-red-500"});default:return e.jsx(Es,{className:"h-4 w-4 text-gray-500"})}},ee=G=>{switch(G){case"withdrawal":return"سحب";case"transfer":return"تحويل";case"deposit":return"إيداع";default:return"معاملة"}},Te=G=>{switch(G){case"completed":return"مكتملة";case"pending":return"قيد الانتظار";case"failed":return"فاشلة";default:return"غير محدد"}};return e.jsx(ie,{open:u,onOpenChange:o,children:e.jsxs(oe,{className:"max-w-6xl max-h-[90vh] overflow-y-auto",children:[e.jsx(ce,{className:"pb-4",children:e.jsxs(de,{className:"flex items-center gap-2 text-lg",children:[e.jsx(ba,{className:"h-5 w-5"}),"تفاصيل المحفظة: ",l.name,l.isDefault&&e.jsxs(mt,{variant:"default",className:"mr-2",children:[e.jsx(_l,{className:"h-3 w-3 mr-1"}),"افتراضية"]})]})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-1 space-y-4",children:[e.jsxs(qe,{children:[e.jsx(gt,{children:e.jsxs(kt,{className:"text-sm flex items-center gap-2",children:[e.jsx(ir,{className:"h-4 w-4"}),"المعلومات الأساسية"]})}),e.jsxs(Ge,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(cs,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-mono",children:l.phone})]}),l.nationalId&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(ir,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-mono",children:l.nationalId})]}),q&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Vl,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{children:q.name})]}),e.jsxs("div",{className:"text-xs text-gray-600 pr-6",children:[e.jsxs("div",{children:["المالك: ",q.ownerName]}),e.jsxs("div",{className:"font-mono",children:["الرقم القومي: ",q.nationalId]})]})]}),l.lastResetDate&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(gs,{className:"h-4 w-4 text-gray-500"}),e.jsxs("span",{children:["آخر إعادة تعيين: ",new Date(l.lastResetDate).toLocaleDateString("ar-EG")]})]})]})]}),e.jsxs(qe,{children:[e.jsx(gt,{children:e.jsxs(kt,{className:"text-sm flex items-center gap-2",children:[e.jsx(xn,{className:"h-4 w-4"}),"حدود الاستخدام الشهري"]})}),e.jsxs(Ge,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(fa,{className:"h-3 w-3 text-red-500"}),"السحب الشهري"]}),e.jsxs("span",{className:"font-mono",children:[E(l.monthlyWithdrawalUsage||0)," / ",E(l.monthlyWithdrawalLimit)]})]}),e.jsx(nr,{value:ue,className:"h-2"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["متبقي: ",E(l.monthlyWithdrawalLimit-(l.monthlyWithdrawalUsage||0))," جنيه"]})]}),e.jsx(un,{}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Vs,{className:"h-3 w-3 text-green-500"}),"التحويل الشهري"]}),e.jsxs("span",{className:"font-mono",children:[E(l.monthlyTransferUsage||0)," / ",E(l.monthlyTransferLimit)]})]}),e.jsx(nr,{value:se,className:"h-2"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["متبقي: ",E(l.monthlyTransferLimit-(l.monthlyTransferUsage||0))," جنيه"]})]})]})]})]}),e.jsxs("div",{className:"lg:col-span-2 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsx(qe,{children:e.jsxs(Ge,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(fa,{className:"h-5 w-5 text-red-500"})}),e.jsx("div",{className:"text-lg font-bold",children:E(K)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي السحب"})]})}),e.jsx(qe,{children:e.jsxs(Ge,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(Vs,{className:"h-5 w-5 text-blue-500"})}),e.jsx("div",{className:"text-lg font-bold",children:E(U)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي التحويل"})]})}),e.jsx(qe,{children:e.jsxs(Ge,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(Qe,{className:"h-5 w-5 text-green-500"})}),e.jsx("div",{className:"text-lg font-bold",children:E(O)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي الإيداع"})]})})]}),e.jsxs(qe,{children:[e.jsx(gt,{children:e.jsxs(kt,{className:"text-sm flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(nn,{className:"h-4 w-4"}),"سجل المعاملات"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(d,{size:"sm",variant:p==="week"?"default":"outline",onClick:()=>h("week"),className:"text-xs",children:"أسبوع"}),e.jsx(d,{size:"sm",variant:p==="month"?"default":"outline",onClick:()=>h("month"),className:"text-xs",children:"شهر"}),e.jsx(d,{size:"sm",variant:p==="all"?"default":"outline",onClick:()=>h("all"),className:"text-xs",children:"الكل"})]})]})}),e.jsx(Ge,{children:$?e.jsx("div",{className:"flex justify-center items-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-600",children:"جاري تحميل المعاملات..."})]})}):L.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(nn,{className:"h-8 w-8 text-gray-400 mx-auto mb-2"}),e.jsx("p",{className:"text-gray-600",children:"لا توجد معاملات في هذه الفترة"})]}):e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:L.map(G=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[ve(G.type),e.jsxs("div",{children:[e.jsxs("div",{className:"text-sm font-medium",children:[ee(G.type)," - ",E(G.amount)," جنيه"]}),e.jsx("div",{className:"text-xs text-gray-600",children:z(G.createdAt)}),G.description&&e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:G.description})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[Y(G.status),e.jsx("span",{className:"text-xs",children:Te(G.status)})]})]},G.id))})})]})]})]}),e.jsxs("div",{className:"flex justify-between pt-4 border-t",children:[e.jsxs(d,{onClick:x,variant:"outline",children:[e.jsx(Jl,{className:"h-4 w-4 mr-2"}),"العودة للمحافظ"]}),e.jsx(d,{onClick:o,variant:"outline",children:"إغلاق"})]})]})})},cn=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],Vc=({isOpen:l,onClose:u,onWalletUpdate:o,initialEditingWallet:x})=>{const{toast:y}=Qt(),{user:g}=ds(),t=Wl(),[$,D]=a.useState([]),[p,h]=a.useState(!1),[N,b]=a.useState(null),[E,z]=a.useState(""),[Z,L]=a.useState(""),[T,k]=a.useState(""),[K,U]=a.useState(""),[O,q]=a.useState("200000"),[ue,se]=a.useState("200000"),[ve,Y]=a.useState("100000"),[ee,Te]=a.useState("60000"),[G,re]=a.useState(!1),[Fe,nt]=a.useState(null),[ht,Oe]=a.useState(!1),[Tt,$e]=a.useState(!1),[Ze,ct]=a.useState(!1),[Ve,Ee]=a.useState(null),ft=()=>`wallets_${(g==null?void 0:g.uid)||"default"}`;a.useEffect(()=>{x&&(b(x),h(!0),z(x.name||""),L(x.phone||""),k(x.nationalId||""),U(x.walletProvider||""),q((x.monthlyWithdrawalLimit||2e5).toString()),se((x.monthlyTransferLimit||2e5).toString()),Y((x.dailyWithdrawalLimit||1e5).toString()),Te((x.dailyTransferLimit||6e4).toString()),re(!!x.isDefault))},[x]);const St=W=>{const ae=new Date,xe=ae.getMonth(),m=ae.getFullYear();if(!W.lastResetDate)return{...W,monthlyWithdrawalUsage:W.monthlyWithdrawalUsage||0,monthlyTransferUsage:W.monthlyTransferUsage||0,lastResetDate:ae.toISOString().split("T")[0]};const I=new Date(W.lastResetDate),J=I.getMonth(),j=I.getFullYear();return xe!==J||m!==j?{...W,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:ae.toISOString().split("T")[0]}:W},Dt=async(W,ae)=>{const xe=new Date().getMonth(),m=new Date().getFullYear(),I=ae.filter(M=>{const _=new Date(M.createdAt);return _.getMonth()===xe&&_.getFullYear()===m&&M.lineId===W}),J=I.filter(M=>M.txnType==="receive").reduce((M,_)=>M+(_.amount||0),0),j=I.filter(M=>M.txnType==="send").reduce((M,_)=>M+(_.amount||0),0);return{withdrawalUsage:J,transferUsage:j}},Xe=async(W,ae)=>{const xe=new Date,m=xe.getDate(),I=xe.getMonth(),J=xe.getFullYear(),j=ae.filter(me=>{const ge=new Date(me.createdAt);return ge.getDate()===m&&ge.getMonth()===I&&ge.getFullYear()===J&&me.lineId===W}),M=j.filter(me=>me.txnType==="receive").reduce((me,ge)=>me+(ge.amount||0),0),_=j.filter(me=>me.txnType==="send").reduce((me,ge)=>me+(ge.amount||0),0);return{withdrawalUsage:M,transferUsage:_}};a.useEffect(()=>{(async()=>{if(!(g!=null&&g.uid)){console.log("No user authenticated, skipping wallet loading"),Oe(!1);return}console.log("Loading wallets for user:",g.uid),Oe(!0);try{const{auth:ae}=await xs(async()=>{const{auth:_}=await import("./index-CimEj1on.js").then(me=>me.b0);return{auth:_}},__vite__mapDeps([0,1]));let xe=0;const m=5;for(;!ae.currentUser&&xe<m;)console.log(`Waiting for auth state... attempt ${xe+1}`),await new Promise(_=>setTimeout(_,1e3)),xe++;if(!ae.currentUser)throw console.error("User not authenticated in Firebase Auth after retries"),new Error("not authenticated");console.log("Firebase Auth User:",ae.currentUser.uid),console.log("Context User:",g.uid),console.log("Fetching wallets from Firebase...");const I=await ps.getByMerchantId(g.uid);console.log("Fetched wallets:",I),console.log("Fetching transactions from Firebase...");const J=await or.getByUserId(g.uid);console.log("Fetched transactions:",J);const M=(await Promise.all(I.map(async _=>{const{withdrawalUsage:me,transferUsage:ge}=await Dt(_.id,J),{withdrawalUsage:Be,transferUsage:ke}=await Xe(_.id,J);return{id:_.id,name:_.label||"محفظة بدون اسم",phone:_.msisdn,isDefault:!1,monthlyWithdrawalLimit:_.withdrawLimit||2e5,monthlyTransferLimit:_.transferLimit||2e5,dailyWithdrawalLimit:_.dailyWithdrawLimit||1e5,dailyTransferLimit:_.dailyTransferLimit||6e4,monthlyWithdrawalUsage:me,monthlyTransferUsage:ge,dailyWithdrawalUsage:Be,dailyTransferUsage:ke,lastResetDate:new Date().toISOString().split("T")[0],defaultTransferCommission:_.defaultTransferCommission!=null?Number(_.defaultTransferCommission):null,defaultWithdrawCommission:_.defaultWithdrawCommission!=null?Number(_.defaultWithdrawCommission):null}}))).map(St);D(M),console.log("Wallets loaded successfully:",M)}catch(ae){console.error("Error loading wallets:",ae),console.log("تم تحميل المحافظ من البيانات المحفوظة محلياً");const xe=localStorage.getItem(ft());if(xe){const m=JSON.parse(xe);D(m.map(I=>({...I,phone:I.phone||I.phoneNumber,monthlyWithdrawalLimit:I.monthlyWithdrawalLimit||2e5,monthlyTransferLimit:I.monthlyTransferLimit||2e5})))}}finally{Oe(!1)}})()},[g==null?void 0:g.uid]);const bt=()=>{z(""),L(""),k(""),U(""),q("200000"),se("200000"),Y("100000"),Te("60000"),re(!1),b(null),h(!1)},yt=async()=>{if(!E.trim()||!Z.trim()||!K.trim()){y({title:"خطأ",description:"يرجى ملء جميع الحقول المطلوبة",variant:"destructive"});return}if(!(g!=null&&g.uid)){y({title:"خطأ",description:"يجب تسجيل الدخول أولاً",variant:"destructive"});return}Oe(!0);try{if(N){await ps.update(N.id,{label:E.trim(),msisdn:Z.trim(),withdrawLimit:parseInt(O),transferLimit:parseInt(ue),dailyWithdrawLimit:parseInt(ve),dailyTransferLimit:parseInt(ee)}),await os.setLimits(N.id,{dailyTransferLimit:parseInt(ee||"0"),dailyWithdrawLimit:parseInt(ve||"0"),monthlyTransferLimit:parseInt(ue||"0"),monthlyWithdrawLimit:parseInt(O||"0")});const W=$.map(ae=>ae.id===N.id?{...ae,name:E.trim(),phone:Z.trim(),nationalId:T.trim(),walletProvider:K,monthlyWithdrawalLimit:parseInt(O),monthlyTransferLimit:parseInt(ue),dailyWithdrawalLimit:parseInt(ve),dailyTransferLimit:parseInt(ee)}:ae);D(W),localStorage.setItem(ft(),JSON.stringify(W)),y({title:"تم التحديث",description:"تم تحديث المحفظة بنجاح"})}else{const W={merchantUserId:g.uid,provider:K,msisdn:Z.trim(),label:E.trim(),isActive:!0,dailyLimit:2e5,monthlyLimit:2e5,withdrawLimit:parseInt(O),transferLimit:parseInt(ue),dailyTransferLimit:parseInt(ee),dailyWithdrawLimit:parseInt(ve),dailyUsage:0,monthlyUsage:0,transferUsage:0,withdrawUsage:0},ae=await ps.create(W);await os.setLimits(ae,{dailyTransferLimit:parseInt(ee||"0"),dailyWithdrawLimit:parseInt(ve||"0"),monthlyTransferLimit:parseInt(ue||"0"),monthlyWithdrawLimit:parseInt(O||"0")});const xe=new Date().toISOString().split("T")[0],m={id:ae,name:E.trim(),phone:Z.trim(),nationalId:T.trim(),walletProvider:K,isDefault:G,monthlyWithdrawalLimit:parseInt(O),monthlyTransferLimit:parseInt(ue),dailyWithdrawalLimit:parseInt(ve),dailyTransferLimit:parseInt(ee),monthlyWithdrawalUsage:0,monthlyTransferUsage:0,dailyWithdrawalUsage:0,dailyTransferUsage:0,lastResetDate:xe,defaultTransferCommission:null,defaultWithdrawCommission:null},I=[...$,m];D(I),localStorage.setItem(ft(),JSON.stringify(I)),y({title:"تم الإنشاء",description:"تم إنشاء المحفظة بنجاح"})}o&&o(),bt(),h(!1),b(null)}catch(W){console.error("Error saving wallet:",W),y({title:"خطأ",description:"حدث خطأ أثناء حفظ المحفظة",variant:"destructive"})}finally{Oe(!1)}},Bt=W=>{b(W),z(W.name),L(W.phone),k(W.nationalId||""),U(W.walletProvider||""),q(W.monthlyWithdrawalLimit.toString()),se(W.monthlyTransferLimit.toString()),re(W.isDefault),h(!0)},Ut=async W=>{const ae=$.find(xe=>xe.id===W);if(ae!=null&&ae.isDefault){y({title:"تحذير",description:"لا يمكن حذف المحفظة الافتراضية",variant:"destructive"});return}if(!(g!=null&&g.uid)){y({title:"خطأ",description:"يجب تسجيل الدخول أولاً",variant:"destructive"});return}Oe(!0);try{await ps.delete(W);const xe=$.filter(m=>m.id!==W);D(xe),localStorage.setItem(ft(),JSON.stringify(xe)),o&&o(),y({title:"تم الحذف",description:"تم حذف المحفظة بنجاح"})}catch(xe){console.error("Error deleting wallet:",xe),y({title:"خطأ",description:"حدث خطأ أثناء حذف المحفظة",variant:"destructive"})}finally{Oe(!1)}},jt=W=>{const ae=$.map(xe=>({...xe,isDefault:xe.id===W}));D(ae),localStorage.setItem(ft(),JSON.stringify(ae)),o&&o(),y({title:"تم تحديث المحفظة الافتراضية",description:"تم تعيين المحفظة كافتراضية بنجاح"})};return e.jsxs(ie,{open:l,onOpenChange:u,children:[e.jsxs(oe,{className:"max-w-4xl max-h-[80vh] overflow-y-auto",children:[e.jsx(ce,{className:"pb-2",children:e.jsxs(de,{className:"flex items-center gap-1 text-sm",children:[e.jsx(Ht,{className:"h-3 w-3"}),"إدارة المحافظ"]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h3",{className:"text-sm font-semibold",children:["المحافظ المتاحة (",$.length,")"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(d,{onClick:()=>ct(!0),className:"flex items-center gap-1 h-6 px-2 text-xs",size:"sm",variant:"outline",children:[e.jsx(rt,{className:"h-3 w-3"}),"الاطلاع على المحافظ"]}),e.jsxs(d,{onClick:()=>{u(),t("/user/add-wallet")},className:"flex items-center gap-1 h-6 px-2 text-xs",size:"sm",children:[e.jsx(vt,{className:"h-3 w-3"}),"إضافة محفظة جديدة"]})]})]}),(p||N)&&e.jsxs(qe,{className:"border-2 border-blue-200 bg-blue-50",children:[e.jsx(gt,{className:"pb-1",children:e.jsx(kt,{className:"text-sm",children:N?"تعديل المحفظة":"إضافة محفظة جديدة"})}),e.jsxs(Ge,{className:"space-y-2 pt-1",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"شركة المحفظة"}),e.jsx("div",{className:"flex gap-1 items-center",children:e.jsxs(ws,{value:K,onValueChange:U,children:[e.jsx(Ss,{className:"h-6 text-xs flex-1",children:e.jsx(Ds,{placeholder:"اختر شركة المحفظة"})}),e.jsx(Cs,{children:cn.map(W=>e.jsx(Vt,{value:W.id,className:"text-xs",children:e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsx("span",{children:W.name}),e.jsx("button",{type:"button",className:"h-4 w-4 p-0 ml-2 flex items-center justify-center hover:bg-blue-100 rounded",onClick:ae=>{ae.preventDefault(),ae.stopPropagation(),nt(W.id)},children:e.jsx(gn,{className:"h-3 w-3 text-blue-500 hover:text-blue-700"})})]})},W.id))})]})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"اسم المحفظة"}),e.jsx(R,{value:E,onChange:W=>z(W.target.value),placeholder:"مثال: محفظة العمل",className:"h-6 text-xs"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"رقم الهاتف"}),e.jsxs("div",{className:"relative",children:[e.jsx(cs,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(R,{value:Z,onChange:W=>L(W.target.value),placeholder:"01030302038",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الرقم القومي للخط"}),e.jsxs("div",{className:"relative",children:[e.jsx(ir,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(R,{value:T,onChange:W=>k(W.target.value),placeholder:"29012345678901",maxLength:14,className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد الشهري للسحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Qe,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(R,{type:"number",value:O,onChange:W=>q(W.target.value),placeholder:"200000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد الشهري للتحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Qe,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(R,{type:"number",value:ue,onChange:W=>se(W.target.value),placeholder:"200000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد اليومي للسحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(fa,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-red-400"}),e.jsx(R,{type:"number",value:ve,onChange:W=>Y(W.target.value),placeholder:"100000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد اليومي للتحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Vs,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-blue-400"}),e.jsx(R,{type:"number",value:ee,onChange:W=>Te(W.target.value),placeholder:"60000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",id:"isDefault",checked:G,onChange:W=>re(W.target.checked),className:"rounded w-3 h-3"}),e.jsx("label",{htmlFor:"isDefault",className:"text-xs font-medium text-gray-700",children:"تعيين كمحفظة افتراضية"})]}),e.jsx("div",{className:"border-t pt-2 mt-2",children:e.jsxs("div",{className:"flex items-center gap-1 mb-2",children:[e.jsx(Fl,{className:"h-3 w-3 text-gray-600"}),e.jsx("label",{className:"text-xs font-medium text-gray-700",children:"إعدادات العمولة"})]})}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(d,{onClick:yt,className:"flex-1 h-6 text-xs",size:"sm",children:N?"تحديث المحفظة":"إضافة المحفظة"}),e.jsx(d,{variant:"outline",onClick:bt,className:"h-6 text-xs",size:"sm",children:"إلغاء"})]})]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2",children:$.map(W=>{var ae;return e.jsxs(qe,{className:`${W.isDefault?"border-green-300 bg-green-50":""}`,children:[e.jsx(gt,{className:"pb-1",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(kt,{className:"text-sm flex items-center gap-1",children:[e.jsx(Ht,{className:"h-3 w-3"}),W.name]}),W.isDefault&&e.jsx(mt,{variant:"default",className:"bg-green-600 text-xs px-1 py-0",children:"افتراضية"})]})}),e.jsxs(Ge,{className:"space-y-1 pt-0",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(cs,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"text-xs",children:W.phone})]}),W.walletProvider&&e.jsx("div",{className:"text-xs text-blue-600 mt-1",children:((ae=cn.find(xe=>xe.id===W.walletProvider))==null?void 0:ae.name)||W.walletProvider}),e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-2 rounded-md border border-gray-200 shadow-sm space-y-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-gray-600 mb-1",children:"الحدود الشهرية"}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-red-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-red-400 to-red-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((W.monthlyWithdrawalUsage||0)/W.monthlyWithdrawalLimit*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-blue-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-400 to-blue-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((W.monthlyTransferUsage||0)/W.monthlyTransferLimit*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-xs text-red-600 font-medium",children:["متبقي سحب: ",Math.max(W.monthlyWithdrawalLimit-(W.monthlyWithdrawalUsage||0),0)," جنيه"]}),e.jsxs("div",{className:"text-xs text-blue-600 font-medium",children:["متبقي تحويل: ",Math.max(W.monthlyTransferLimit-(W.monthlyTransferUsage||0),0)," جنيه"]})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-gray-600 mb-1",children:"الحدود اليومية"}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-orange-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-orange-400 to-orange-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((W.dailyWithdrawalUsage||0)/W.dailyWithdrawalLimit*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-green-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-green-400 to-green-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((W.dailyTransferUsage||0)/W.dailyTransferLimit*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-xs text-orange-600 font-medium",children:["متبقي سحب يومي: ",Math.max(W.dailyWithdrawalLimit-(W.dailyWithdrawalUsage||0),0)," جنيه"]}),e.jsxs("div",{className:"text-xs text-green-600 font-medium",children:["متبقي تحويل يومي: ",Math.max(W.dailyTransferLimit-(W.dailyTransferUsage||0),0)," جنيه"]})]})]})]}),e.jsxs("div",{className:"flex gap-1 pt-1",children:[e.jsxs(d,{size:"sm",variant:"outline",onClick:()=>Bt(W),className:"flex-1 h-5 text-xs px-1",children:[e.jsx(zl,{className:"h-2 w-2 mr-0.5"}),"تعديل"]}),!W.isDefault&&e.jsxs(e.Fragment,{children:[e.jsx(d,{size:"sm",variant:"outline",onClick:()=>jt(W.id),className:"flex-1 h-5 text-xs px-1",children:"جعلها افتراضية"}),e.jsx(d,{size:"sm",variant:"destructive",onClick:()=>Ut(W.id),className:"h-5 px-1",children:e.jsx(Ot,{className:"h-2 w-2"})})]})]})]})]},W.id)})}),$.length===0&&e.jsx("div",{className:"text-center py-4 text-gray-500 text-xs",children:"لا توجد محافظ متاحة. قم بإضافة محفظة جديدة للبدء."})]}),Fe&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-800",children:"معلومات صاحب المحفظة"}),e.jsx("button",{onClick:()=>nt(null),className:"h-8 w-8 p-0 flex items-center justify-center hover:bg-gray-100 rounded-full transition-colors",children:e.jsx(El,{className:"h-4 w-4 text-gray-500"})})]}),(()=>{const W=cn.find(ae=>ae.id===Fe);return W?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-center mb-6",children:e.jsx("div",{className:"bg-blue-100 p-3 rounded-lg inline-block",children:e.jsx("h4",{className:"font-bold text-blue-700 text-lg",children:W.name})})}),e.jsx("div",{className:"bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-200",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-white p-3 rounded-lg shadow-sm",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full mr-2"}),e.jsx("span",{className:"font-semibold text-gray-700",children:"اسم صاحب المحفظة:"})]}),e.jsx("p",{className:"text-gray-900 font-medium text-lg mr-4",children:W.ownerName})]}),e.jsxs("div",{className:"bg-white p-3 rounded-lg shadow-sm",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full mr-2"}),e.jsx("span",{className:"font-semibold text-gray-700",children:"الرقم القومي:"})]}),e.jsx("p",{className:"text-gray-900 font-mono text-lg mr-4 tracking-wider",children:W.nationalId})]})]})}),e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 p-3 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(gn,{className:"h-4 w-4 text-yellow-600 mr-2"}),e.jsx("span",{className:"text-sm text-yellow-800 font-medium",children:"هذه البيانات مسجلة رسمياً في النظام لهذه المحفظة"})]})})]}):null})()]})})]}),e.jsx(As,{open:Ze,onOpenChange:ct,mode:"verify",title:"إدخال الرقم السري الرئيسي",description:"لا يمكن الاطلاع على المحافظ إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{ct(!1),$e(!0)}}),e.jsx(Jc,{isOpen:Tt,onClose:()=>$e(!1),onWalletSelect:W=>{Ee(W),$e(!1)},onEditWallet:W=>{t(`/user/add-wallet?edit=1&id=${W.id}`),$e(!1)},onDeleteWallet:async W=>{try{if(await ps.delete(W),D(ae=>{const xe=ae.filter(m=>m.id!==W);try{localStorage.setItem(ft(),JSON.stringify(xe))}catch(m){console.error("Failed to update localStorage wallets after delete:",m)}return xe}),o)try{await o()}catch(ae){console.error("onWalletUpdate callback failed:",ae)}}catch(ae){console.error("Error deleting wallet:",ae)}}}),e.jsx(qc,{wallet:Ve,isOpen:!!Ve,onClose:()=>Ee(null),onBack:()=>{Ee(null),$e(!0)}})]})},Yc=({isOpen:l,onClose:u,transaction:o,onDelete:x})=>{if(!o)return null;const y=p=>{switch(p){case"completed":return e.jsx(Ps,{className:"h-5 w-5 text-green-500"});case"pending":return e.jsx(Os,{className:"h-5 w-5 text-yellow-500"});case"failed":return e.jsx(yn,{className:"h-5 w-5 text-red-500"});default:return e.jsx(Os,{className:"h-5 w-5 text-gray-500"})}},g=p=>{switch(p){case"completed":return"مكتملة";case"pending":return"قيد الانتظار";case"failed":return"فاشلة";default:return"غير معروف"}},t=p=>{switch(p){case"withdraw":return"سحب";case"send":return"إرسال";case"receive":return"استقبال";default:return"تحويل"}},$=()=>{const p=!!o.senderNumber,h=!!o.senderName,N=p?"الرقم المرسل:":h?"الرقم الراسل:":"رقم المحفظة:",b=p?o.senderNumber:h?o.senderName:o.senderPhone,E=`
      <div style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 500px; margin: 0 auto; padding: 30px; background: #fff;">
        <!-- Header -->
        <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #2563eb; padding-bottom: 20px;">
          <h1 style="color: #2563eb; margin-bottom: 5px; font-size: 28px;">إيصال المعاملة</h1>
          <p style="color: #666; font-size: 16px; margin: 0;">رقم المرجع: ${o.transactionReference||o.id}</p>
          <p style="color: #888; font-size: 14px; margin: 5px 0 0 0;">${new Date().toLocaleString("ar-EG")}</p>
        </div>
        
        <!-- Shop Info -->
        <div style="background: #f8fafc; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
          <h3 style="color: #1e293b; margin: 0 0 15px 0; font-size: 18px;">معلومات المحل</h3>
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span style="font-weight: 600; color: #475569;">اسم المحل:</span>
            <span style="color: #1e293b;">${o.merchantShopName||o.shopName||"غير محدد"}</span>
          </div>
        </div>
        
        <!-- Transaction Details -->
        <div style="background: #fff; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
          <h3 style="color: #1e293b; margin: 0 0 15px 0; font-size: 18px;">تفاصيل المعاملة</h3>
          
          <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
            <span style="font-weight: 600; color: #475569;">نوع المعاملة:</span>
            <span style="color: #2563eb; font-weight: 600;">${t(o.type)}</span>
          </div>
          
          <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
            <span style="font-weight: 600; color: #475569;">الحالة:</span>
            <span style="color: ${o.status==="completed"?"#16a34a":o.status==="pending"?"#ca8a04":"#dc2626"}; font-weight: 600;">
              ${g(o.status)}
            </span>
          </div>

          ${o!=null&&o.cashierName?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الكاشير:</span>
              <span style="color: #1e293b;">${o.cashierName}</span>
            </div>
          `:""}
          
          ${o.type!=="withdraw"?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">${N}</span>
              <span style="color: #1e293b;">${b}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الرقم المستقبل:</span>
              <span style="color: #1e293b;">${o.receiverNumber||o.receiverPhone}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">المبلغ المحول:</span>
              <span style="color: #2563eb; font-weight: bold; font-size: 16px;">${o.transferredAmount||o.amount} جنيه</span>
            </div>
          `:`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">رقم المحفظة:</span>
              <span style="color: #1e293b;">${o.senderPhone}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">المبلغ المسحوب:</span>
              <span style="color: #dc2626; font-weight: bold; font-size: 16px;">${o.withdrawnAmountDetailed||o.withdrawnAmount||o.amount} جنيه</span>
            </div>
          `}
          
          ${o.commission?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">العمولة:</span>
              <span style="color: #f59e0b; font-weight: 600;">${o.commission} جنيه</span>
            </div>
          `:""}
          ${o!=null&&o.fee&&Number(o.fee)>0?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الرسوم:</span>
              <span style="color: #64748b; font-weight: 600;">${o.fee} جنيه</span>
            </div>
          `:""}
          
          <div style="display: flex; justify-content: space-between; padding: 8px 0;">
            <span style="font-weight: 600; color: #475569;">التاريخ والوقت:</span>
            <span style="color: #1e293b;">${o.createdAt.toLocaleString("ar-EG")}</span>
          </div>
        </div>
        
        <!-- Total Amount -->
        <div style="background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); border-radius: 12px; padding: 20px; margin-bottom: 20px; text-align: center;">
          <h3 style="color: white; margin: 0 0 10px 0; font-size: 16px;">إجمالي المبلغ</h3>
          <p style="color: white; font-size: 24px; font-weight: bold; margin: 0;">
            ${o.type==="withdraw"?"-":""}${o.amount} جنيه
          </p>
        </div>
        
        
        
        
        <!-- Footer -->
        <div style="text-align: center; color: #64748b; font-size: 12px; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
          <p style="margin: 0 0 5px 0;">شكراً لاستخدام خدماتنا</p>
          <p style="margin: 0;">تم إنشاء الإيصال في: ${new Date().toLocaleString("ar-EG")}</p>
        </div>
      </div>
    `,z=window.open("","_blank");z&&(z.document.write(`
        <html>
          <head>
            <title>إيصال المعاملة - ${o.transactionReference||o.id}</title>
            <meta charset="UTF-8">
            <style>
              body { 
                margin: 0; 
                padding: 20px; 
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: #f8fafc;
              }
              @media print {
                body { 
                  margin: 0; 
                  background: white;
                }
              }
            </style>
          </head>
          <body>
            ${E}
          </body>
        </html>
      `),z.document.close(),z.print())},D=()=>{window.confirm("هل أنت متأكد من حذف هذه المعاملة؟ لا يمكن التراجع عن هذا الإجراء.")&&(x(o.id),u())};return e.jsx(ie,{open:l,onOpenChange:u,children:e.jsxs(oe,{className:"w-[92vw] sm:w-auto sm:max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx(ce,{children:e.jsxs(de,{className:"flex items-center gap-2 text-xl",children:[e.jsx(rr,{className:"h-6 w-6 text-blue-600"}),"إيصال المعاملة المفصل"]})}),e.jsxs("div",{className:"space-y-6",children:[e.jsx(qe,{className:"bg-gradient-to-r from-blue-50 to-indigo-50 border-blue-200",children:e.jsxs(gt,{className:"text-center pb-2",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 mb-2",children:[y(o.status),e.jsx(mt,{variant:o.status==="completed"?"default":"secondary",className:"text-sm",children:g(o.status)})]}),e.jsxs("h3",{className:"text-2xl font-bold text-blue-600",children:[o.type==="withdraw"?"-":"",o.amount," جنيه"]}),e.jsxs("p",{className:"text-sm text-gray-600",children:["رقم المرجع: ",o.transactionReference||o.id]})]})}),e.jsxs(qe,{children:[e.jsx(gt,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(bc,{className:"h-5 w-5 text-green-600"}),e.jsx("h4",{className:"font-semibold text-lg",children:"معلومات المحل"})]})}),e.jsxs(Ge,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"اسم المحل:"}),e.jsx("span",{className:"text-gray-900",children:o.merchantShopName||o.shopName||"غير محدد"})]}),(o==null?void 0:o.cashierName)&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"الكاشير:"}),e.jsx("span",{className:"text-gray-900",children:o.cashierName})]})]})]}),e.jsxs(qe,{children:[e.jsx(gt,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ba,{className:"h-5 w-5 text-blue-600"}),e.jsx("h4",{className:"font-semibold text-lg",children:"تفاصيل المعاملة"})]})}),e.jsx(Ge,{className:"space-y-3",children:e.jsxs("div",{className:"grid grid-cols-1 gap-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-blue-700",children:"نوع المعاملة:"}),e.jsx(mt,{variant:"outline",className:"bg-blue-100 text-blue-800",children:t(o.type)})]}),o.type!=="withdraw"?e.jsxs(e.Fragment,{children:[(()=>{const p=!!o.senderNumber,h=!!o.senderName,N=p?"الرقم المرسل:":h?"الرقم الراسل:":"رقم المحفظة:",b=p?o.senderNumber:h?o.senderName:o.senderPhone,E=p?pn:cs;return e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(E,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:N})]}),e.jsx("span",{className:"text-gray-900 font-mono",children:b})]})})(),e.jsx("div",{className:"flex items-center justify-center p-2",children:e.jsx(yc,{className:"h-6 w-6 text-blue-500"})}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-green-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(pn,{className:"h-4 w-4 text-green-500"}),e.jsx("span",{className:"font-medium text-green-700",children:"الرقم المستقبل:"})]}),e.jsx("span",{className:"text-green-900 font-mono",children:o.receiverNumber||o.receiverPhone})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Qe,{className:"h-4 w-4 text-blue-500"}),e.jsx("span",{className:"font-medium text-blue-700",children:"المبلغ المحول:"})]}),e.jsxs("span",{className:"text-blue-900 font-bold text-lg",children:[o.transferredAmount||o.amount," جنيه"]})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(cs,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:"رقم المحفظة:"})]}),e.jsx("span",{className:"text-gray-900 font-mono",children:o.senderPhone})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-red-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Qe,{className:"h-4 w-4 text-red-500"}),e.jsx("span",{className:"font-medium text-red-700",children:"المبلغ المسحوب:"})]}),e.jsxs("span",{className:"text-red-900 font-bold text-lg",children:[o.withdrawnAmountDetailed||o.withdrawnAmount||o.amount," جنيه"]})]})]}),o.commission&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-yellow-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-yellow-700",children:"العمولة:"}),e.jsxs("span",{className:"text-yellow-900 font-semibold",children:[o.commission," جنيه"]})]}),(o==null?void 0:o.fee)&&Number(o.fee)>0&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"الرسوم:"}),e.jsxs("span",{className:"text-gray-900 font-semibold",children:[o.fee," جنيه"]})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(gs,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:"التاريخ والوقت:"})]}),e.jsx("span",{className:"text-gray-900",children:o.createdAt.toLocaleString("ar-EG")})]})]})})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs(d,{onClick:$,className:"flex-1 bg-blue-600 hover:bg-blue-700 text-white",size:"lg",children:[e.jsx(jc,{className:"h-5 w-5 mr-2"}),"طباعة الإيصال"]}),e.jsxs(d,{onClick:D,variant:"destructive",className:"flex-1",size:"lg",children:[e.jsx(Ot,{className:"h-5 w-5 mr-2"}),"حذف المعاملة"]})]}),e.jsx(d,{onClick:u,variant:"outline",className:"w-full",size:"lg",children:"إغلاق الإيصال"})]})]})})};function Il({open:l,onOpenChange:u,onSuccess:o,title:x,description:y,currentBalance:g,balanceLabel:t,userId:$}){const[D,p]=a.useState(""),[h,N]=a.useState(g.toString()),[b,E]=a.useState(!1),[z,Z]=a.useState(""),[L,T]=a.useState(!1),k=is.hasMasterPin(),K=async O=>{O.preventDefault(),Z(""),T(!0);try{const q=parseFloat(h);if(isNaN(q)||q<0){Z("يرجى إدخال مبلغ صحيح"),T(!1);return}k?is.verifyMasterPin(D)?(o(q),u(!1),p(""),N("")):Z("الرقم السري غير صحيح"):Z("لم يتم تعيين رقم سري رئيسي. يرجى تعيين رقم سري رئيسي أولاً من إعدادات التطبيق")}catch{Z("حدث خطأ أثناء التحقق من الرقم السري")}finally{T(!1)}},U=()=>{p(""),N(g.toString()),Z(""),u(!1)};return He.useEffect(()=>{l&&N(g.toString())},[g,l]),e.jsx(ie,{open:l,onOpenChange:U,children:e.jsxs(oe,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ce,{children:e.jsxs(de,{className:"flex items-center gap-2 text-right",children:[e.jsx(Qe,{className:"h-5 w-5"}),x]})}),e.jsxs("form",{onSubmit:K,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:y}),e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg",children:[e.jsxs(V,{className:"text-sm font-medium text-gray-700",children:[t," الحالي"]}),e.jsxs("div",{className:"text-lg font-bold text-gray-900 mt-1",children:[g.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"newAmount",className:"text-right",children:"المبلغ الجديد"}),e.jsx(R,{id:"newAmount",type:"number",step:"0.01",min:"0",value:h,onChange:O=>N(O.target.value),placeholder:"أدخل المبلغ الجديد",className:"text-right",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"pin",className:"text-right",children:"الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"pin",type:b?"text":"password",value:D,onChange:O=>p(O.target.value),placeholder:"أدخل الرقم السري",className:"text-right pr-10",required:!0}),e.jsx(d,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>E(!b),children:b?e.jsx(Wt,{className:"h-4 w-4"}):e.jsx(rt,{className:"h-4 w-4"})})]})]}),z&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-red-600 bg-red-50 p-2 rounded",children:[e.jsx(Es,{className:"h-4 w-4"}),z]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(d,{type:"button",variant:"outline",onClick:U,className:"flex-1",children:"إلغاء"}),e.jsx(d,{type:"submit",disabled:L||!D||!h,className:"flex-1",children:L?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"جاري التحديث..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Ws,{className:"h-4 w-4 mr-2"}),"تحديث الرصيد"]})})]})]})]})})}class va{static getSecretKey(u){return u?`${this.SECRET_KEY_BASE}_${u}`:this.SECRET_KEY_BASE}static setSecretPin(u,o){const x=btoa(u);this.secretCache.set(this.getSecretKey(o),x)}static hasSecretPin(u){return this.secretCache.has(this.getSecretKey(u))}static verifySecretPin(u,o){const x=this.secretCache.get(this.getSecretKey(o));if(!x)return!1;try{return atob(x)===u}catch{return!1}}static clearSecretPin(u){this.secretCache.delete(this.getSecretKey(u))}}an(va,"SECRET_KEY_BASE","dashboard_secret_pin"),an(va,"secretCache",new Map);function Hc({open:l,onOpenChange:u,userId:o}){const[x,y]=a.useState(""),[g,t]=a.useState(""),[$,D]=a.useState(""),[p,h]=a.useState(!1),[N,b]=a.useState(!1),[E,z]=a.useState(!1),[Z,L]=a.useState(""),[T,k]=a.useState(!1),{toast:K}=Qt(),U=va.hasSecretPin(o),O=async ue=>{ue.preventDefault(),L(""),k(!0);try{if(!g||g.length<4){L("يجب أن يكون الرقم السري 4 أرقام على الأقل"),k(!1);return}if(g!==$){L("الرقم السري الجديد وتأكيده غير متطابقين"),k(!1);return}if(U){if(!x){L("يرجى إدخال الرقم السري الحالي"),k(!1);return}if(!va.verifySecretPin(x,o)){L("الرقم السري الحالي غير صحيح"),k(!1);return}}va.setSecretPin(g,o),K({title:U?"تم تغيير الرقم السري":"تم تعيين الرقم السري",description:U?"تم تغيير الرقم السري بنجاح":"تم تعيين الرقم السري بنجاح"}),q()}catch{L("حدث خطأ أثناء حفظ الرقم السري")}finally{k(!1)}},q=()=>{y(""),t(""),D(""),L(""),h(!1),b(!1),z(!1),u(!1)};return e.jsx(ie,{open:l,onOpenChange:q,children:e.jsxs(oe,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ce,{children:e.jsxs(de,{className:"flex items-center gap-2 text-right",children:[e.jsx(Fl,{className:"h-5 w-5"}),U?"تغيير الرقم السري":"تعيين الرقم السري"]})}),e.jsxs("form",{onSubmit:O,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:U?"أدخل الرقم السري الحالي والرقم السري الجديد لتغييره":"أدخل الرقم السري الجديد الذي تريد استخدامه في عمليات التعديل"}),U&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"currentPin",type:p?"text":"password",autoComplete:"off",value:x,onChange:ue=>y(ue.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(d,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>h(!p),children:p?e.jsx(Wt,{className:"h-4 w-4"}):e.jsx(rt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"newPin",type:N?"text":"password",autoComplete:"off",value:g,onChange:ue=>t(ue.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(d,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>b(!N),children:N?e.jsx(Wt,{className:"h-4 w-4"}):e.jsx(rt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"confirmPin",type:E?"text":"password",autoComplete:"off",value:$,onChange:ue=>D(ue.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(d,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>z(!E),children:E?e.jsx(Wt,{className:"h-4 w-4"}):e.jsx(rt,{className:"h-4 w-4"})})]})]}),Z&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(Es,{className:"h-4 w-4"}),Z]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(d,{type:"submit",disabled:T,className:"flex-1",children:[e.jsx(Ws,{className:"h-4 w-4 mr-2"}),T?"جاري الحفظ...":U?"تغيير الرقم السري":"تعيين الرقم السري"]}),e.jsx(d,{type:"button",variant:"outline",onClick:q,disabled:T,children:"إلغاء"})]})]})]})})}const dn=new Map;function Gc({open:l,onOpenChange:u,userId:o}){const[x,y]=a.useState(""),[g,t]=a.useState(""),[$,D]=a.useState(""),[p,h]=a.useState(!1),[N,b]=a.useState(!1),[E,z]=a.useState(!1),[Z,L]=a.useState(""),[T,k]=a.useState(!1),{toast:K}=Qt(),U=o?`cash_drawer_pin_${o}`:"cash_drawer_pin",O=()=>dn.has(U),q=Y=>{const ee=dn.get(U);if(!ee)return!1;try{return atob(ee)===Y}catch{return!1}},ue=Y=>{const ee=btoa(Y);dn.set(U,ee)},se=async Y=>{Y.preventDefault(),L(""),k(!0);try{if(!g||g.length<4){L("يجب أن يكون الرقم السري 4 أرقام على الأقل"),k(!1);return}if(g!==$){L("الرقم السري الجديد وتأكيده غير متطابقين"),k(!1);return}if(O()){if(!x){L("يرجى إدخال الرقم السري الحالي لدرج النقدية"),k(!1);return}if(!q(x)){L("الرقم السري الحالي لدرج النقدية غير صحيح"),k(!1);return}}ue(g),K({title:O()?"تم تغيير رقم درج النقدية":"تم تعيين رقم درج النقدية",description:O()?"تم تغيير الرقم السري لدرج النقدية بنجاح":"تم تعيين الرقم السري لدرج النقدية بنجاح"}),ve()}catch{L("حدث خطأ أثناء حفظ الرقم السري لدرج النقدية")}finally{k(!1)}},ve=()=>{y(""),t(""),D(""),L(""),h(!1),b(!1),z(!1),u(!1)};return e.jsx(ie,{open:l,onOpenChange:ve,children:e.jsxs(oe,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ce,{children:e.jsxs(de,{className:"flex items-center gap-2 text-right",children:[e.jsx(Qe,{className:"h-5 w-5 text-green-600"}),O()?"تغيير رقم درج النقدية":"تعيين رقم درج النقدية"]})}),e.jsxs("form",{onSubmit:se,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:O()?"أدخل الرقم السري الحالي والرقم السري الجديد لدرج النقدية":"أدخل الرقم السري الجديد الذي تريد استخدامه لحماية درج النقدية"}),O()&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي لدرج النقدية"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"currentPin",type:p?"text":"password",autoComplete:"off",value:x,onChange:Y=>y(Y.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(d,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>h(!p),children:p?e.jsx(Wt,{className:"h-4 w-4"}):e.jsx(rt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد لدرج النقدية"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"newPin",type:N?"text":"password",autoComplete:"off",value:g,onChange:Y=>t(Y.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(d,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>b(!N),children:N?e.jsx(Wt,{className:"h-4 w-4"}):e.jsx(rt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"confirmPin",type:E?"text":"password",autoComplete:"off",value:$,onChange:Y=>D(Y.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(d,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>z(!E),children:E?e.jsx(Wt,{className:"h-4 w-4"}):e.jsx(rt,{className:"h-4 w-4"})})]})]}),Z&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(Es,{className:"h-4 w-4"}),Z]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(d,{type:"submit",disabled:T,className:"flex-1 bg-green-600 hover:bg-green-700",children:[e.jsx(Ws,{className:"h-4 w-4 mr-2"}),T?"جاري الحفظ...":O()?"تغيير رقم درج النقدية":"تعيين رقم درج النقدية"]}),e.jsx(d,{type:"button",variant:"outline",onClick:ve,disabled:T,children:"إلغاء"})]})]}),e.jsx("div",{className:"text-xs text-gray-500 text-center mt-2",children:"💰 هذا الرقم السري خاص بحماية درج النقدية فقط"})]})})}const mn=new Map;function Qc({open:l,onOpenChange:u,userId:o}){const[x,y]=a.useState(""),[g,t]=a.useState(""),[$,D]=a.useState(""),[p,h]=a.useState(!1),[N,b]=a.useState(!1),[E,z]=a.useState(!1),[Z,L]=a.useState(""),[T,k]=a.useState(!1),{toast:K}=Qt(),U=o?`wallet_total_pin_${o}`:"wallet_total_pin",O=()=>mn.has(U),q=Y=>{const ee=mn.get(U);if(!ee)return!1;try{return atob(ee)===Y}catch{return!1}},ue=Y=>{const ee=btoa(Y);mn.set(U,ee)},se=async Y=>{Y.preventDefault(),L(""),k(!0);try{if(!g||g.length<4){L("يجب أن يكون الرقم السري 4 أرقام على الأقل"),k(!1);return}if(g!==$){L("الرقم السري الجديد وتأكيده غير متطابقين"),k(!1);return}if(O()){if(!x){L("يرجى إدخال الرقم السري الحالي لإجمالي المحفظة"),k(!1);return}if(!q(x)){L("الرقم السري الحالي لإجمالي المحفظة غير صحيح"),k(!1);return}}ue(g),K({title:O()?"تم تغيير رقم إجمالي المحفظة":"تم تعيين رقم إجمالي المحفظة",description:O()?"تم تغيير الرقم السري لإجمالي المحفظة بنجاح":"تم تعيين الرقم السري لإجمالي المحفظة بنجاح"}),ve()}catch{L("حدث خطأ أثناء حفظ الرقم السري لإجمالي المحفظة")}finally{k(!1)}},ve=()=>{y(""),t(""),D(""),L(""),h(!1),b(!1),z(!1),u(!1)};return e.jsx(ie,{open:l,onOpenChange:ve,children:e.jsxs(oe,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ce,{children:e.jsxs(de,{className:"flex items-center gap-2 text-right",children:[e.jsx(Ht,{className:"h-5 w-5 text-blue-600"}),O()?"تغيير رقم إجمالي المحفظة":"تعيين رقم إجمالي المحفظة"]})}),e.jsxs("form",{onSubmit:se,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:O()?"أدخل الرقم السري الحالي والرقم السري الجديد لإجمالي المحفظة":"أدخل الرقم السري الجديد الذي تريد استخدامه لحماية إجمالي المحفظة"}),O()&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي لإجمالي المحفظة"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"currentPin",type:p?"text":"password",autoComplete:"off",value:x,onChange:Y=>y(Y.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(d,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>h(!p),children:p?e.jsx(Wt,{className:"h-4 w-4"}):e.jsx(rt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد لإجمالي المحفظة"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"newPin",type:N?"text":"password",autoComplete:"off",value:g,onChange:Y=>t(Y.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(d,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>b(!N),children:N?e.jsx(Wt,{className:"h-4 w-4"}):e.jsx(rt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"confirmPin",type:E?"text":"password",autoComplete:"off",value:$,onChange:Y=>D(Y.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(d,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>z(!E),children:E?e.jsx(Wt,{className:"h-4 w-4"}):e.jsx(rt,{className:"h-4 w-4"})})]})]}),Z&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(Es,{className:"h-4 w-4"}),Z]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(d,{type:"submit",disabled:T,className:"flex-1 bg-blue-600 hover:bg-blue-700",children:[e.jsx(Ws,{className:"h-4 w-4 mr-2"}),T?"جاري الحفظ...":O()?"تغيير رقم إجمالي المحفظة":"تعيين رقم إجمالي المحفظة"]}),e.jsx(d,{type:"button",variant:"outline",onClick:ve,disabled:T,children:"إلغاء"})]})]}),e.jsx("div",{className:"text-xs text-gray-500 text-center mt-2",children:"💼 هذا الرقم السري خاص بحماية إجمالي المحفظة فقط"})]})})}function Zc({open:l,onOpenChange:u,onSuccess:o,title:x,description:y,currentBalance:g,balanceLabel:t,userId:$}){const[D,p]=a.useState(""),[h,N]=a.useState(""),[b,E]=a.useState("add"),[z,Z]=a.useState(!1),[L,T]=a.useState(""),[k,K]=a.useState(!1),U=is.hasMasterPin(),O=async se=>{se.preventDefault(),T(""),K(!0);try{const ve=parseFloat(h);if(isNaN(ve)||ve<=0){T("يرجى إدخال مبلغ صحيح أكبر من صفر"),K(!1);return}if(b==="subtract"&&ve>g){T("لا يمكن خصم مبلغ أكبر من الرصيد الحالي"),K(!1);return}if(U)if(is.verifyMasterPin(D)){const Y=b==="add"?ve:-ve;q(),o(Y)}else T("الرقم السري غير صحيح");else T("لم يتم تعيين رقم سري رئيسي. يرجى تعيين رقم سري رئيسي أولاً من إعدادات التطبيق")}catch{T("حدث خطأ أثناء التحقق من الرقم السري")}finally{K(!1)}},q=()=>{p(""),N(""),E("add"),T(""),u(!1)},ue=()=>{const se=parseFloat(h)||0;return b==="add"?g+se:g-se};return e.jsx(ie,{open:l,onOpenChange:q,children:e.jsxs(oe,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ce,{children:e.jsxs(de,{className:"flex items-center gap-2 text-right",children:[b==="add"?e.jsx(vt,{className:"h-5 w-5 text-green-600"}):e.jsx(Ts,{className:"h-5 w-5 text-red-600"}),x]})}),e.jsxs("form",{onSubmit:O,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:y}),e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg",children:[e.jsxs(V,{className:"text-sm font-medium text-gray-700",children:[t," الحالي"]}),e.jsxs("div",{className:"text-lg font-bold text-gray-900 mt-1",children:[g.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{className:"text-right",children:"نوع العملية"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(d,{type:"button",variant:b==="add"?"default":"outline",onClick:()=>E("add"),className:"flex-1 flex items-center gap-2",children:[e.jsx(vt,{className:"h-4 w-4"}),"إضافة"]}),e.jsxs(d,{type:"button",variant:b==="subtract"?"default":"outline",onClick:()=>E("subtract"),className:"flex-1 flex items-center gap-2",children:[e.jsx(Ts,{className:"h-4 w-4"}),"خصم"]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(V,{htmlFor:"amount",className:"text-right",children:["المبلغ المراد ",b==="add"?"إضافته":"خصمه"]}),e.jsx(R,{id:"amount",type:"number",step:"0.01",min:"0.01",value:h,onChange:se=>N(se.target.value),placeholder:`أدخل المبلغ المراد ${b==="add"?"إضافته":"خصمه"}`,className:"text-right",required:!0})]}),h&&!isNaN(parseFloat(h))&&e.jsxs("div",{className:`p-3 rounded-lg ${b==="add"?"bg-green-50 border border-green-200":"bg-red-50 border border-red-200"}`,children:[e.jsx(V,{className:"text-sm font-medium text-gray-700",children:"الرصيد الجديد المتوقع"}),e.jsxs("div",{className:`text-lg font-bold mt-1 ${b==="add"?"text-green-700":"text-red-700"}`,children:[ue().toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"pin",className:"text-right",children:"الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"pin",type:z?"text":"password",autoComplete:"off",value:D,onChange:se=>p(se.target.value),placeholder:"أدخل الرقم السري",className:"text-right pr-10",required:!0}),e.jsx(d,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>Z(!z),children:z?e.jsx(Wt,{className:"h-4 w-4"}):e.jsx(rt,{className:"h-4 w-4"})})]})]}),L&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-red-600 bg-red-50 p-2 rounded",children:[e.jsx(Es,{className:"h-4 w-4"}),L]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(d,{type:"button",variant:"outline",onClick:q,className:"flex-1",children:"إلغاء"}),e.jsx(d,{type:"submit",disabled:k||!D||!h,className:`flex-1 ${b==="add"?"bg-green-600 hover:bg-green-700":"bg-red-600 hover:bg-red-700"}`,children:k?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"جاري التحديث..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Ws,{className:"h-4 w-4 mr-2"}),b==="add"?"إضافة المبلغ":"خصم المبلغ"]})})]})]})]})})}function Xc(l){return l?`readBroadcastIds_${l}`:"readBroadcastIds_guest"}function ed({className:l}){const{user:u,profile:o}=ds(),[x,y]=a.useState([]),[g,t]=a.useState(new Set);a.useState(null);const[$,D]=a.useState(!1);a.useRef(new Set),a.useRef(!1);const p=a.useRef(null),h=a.useRef(null);a.useRef(null),a.useState({position:"fixed",top:0,left:0,zIndex:1e4});const N=!1,b=a.useMemo(()=>{const k=["global"];return u!=null&&u.uid&&k.push(`user:${u.uid}`),o!=null&&o.shopId&&k.push(`shop:${o.shopId}`),k},[u==null?void 0:u.uid,o==null?void 0:o.shopId]),E=Xc(u==null?void 0:u.uid);a.useEffect(()=>{try{const k=localStorage.getItem(E);if(k){const K=JSON.parse(k);Array.isArray(K)&&t(new Set(K.filter(Boolean)))}else t(new Set)}catch(k){console.warn("Failed to load read ids",k),t(new Set)}},[E]),a.useEffect(()=>{const k=Ac(b,K=>{y(K)});return()=>k()},[b]),a.useEffect(()=>{},[x]),a.useEffect(()=>()=>{p.current&&clearTimeout(p.current)},[]);const z=x.reduce((k,K)=>k+(K.id&&!g.has(K.id)?1:0),0),Z=k=>{if(!k||g.has(k))return;const K=new Set(g);K.add(k),t(K);try{localStorage.setItem(E,JSON.stringify(Array.from(K)))}catch{}},L=()=>{const k=x.map(U=>U.id).filter(Boolean),K=new Set(g);k.forEach(U=>K.add(U)),t(K);try{localStorage.setItem(E,JSON.stringify(Array.from(K)))}catch{}},T=(k,K)=>{k&&window.open(k,"_blank"),K&&Z(K)};return a.useEffect(()=>{},[$]),e.jsxs("div",{className:`relative inline-block ${l||""}`,ref:h,children:[e.jsxs(Oc,{onOpenChange:k=>{k&&z>0&&L()},children:[e.jsx(Wc,{asChild:!0,children:e.jsx(d,{variant:"ghost",className:"relative h-8 w-8 rounded-full p-0 hover:bg-transparent focus:ring-1 focus:ring-primary focus:ring-offset-1 transition-all",title:"الإشعارات",children:e.jsxs("div",{className:"relative h-8 w-8 rounded-full bg-primary/10 flex items-center justify-center border border-border shadow-sm hover:shadow-md",children:[e.jsx(Cl,{className:"h-4 w-4 text-primary"}),z>0&&e.jsx("span",{className:"absolute -top-1 -right-1 min-w-[18px] h-[18px] px-1 rounded-full bg-red-500 text-white text-[10px] font-bold flex items-center justify-center shadow",children:z})]})})}),e.jsxs(Fc,{className:"w-80",align:"end",forceMount:!0,children:[e.jsxs(Ec,{className:"flex items-center justify-between",children:[e.jsx("span",{children:"الإشعارات"}),x.length>0&&e.jsxs(d,{variant:"outline",size:"sm",className:"h-7 text-xs",onClick:L,children:[e.jsx(Ps,{className:"h-3 w-3 mr-1"}),"تمييز الكل كمقروء"]})]}),e.jsx(Bc,{}),x.length===0?e.jsx("div",{className:"p-3 text-sm text-muted-foreground",children:"لا توجد إشعارات حالياً"}):e.jsx("div",{className:"max-h-64 overflow-y-auto pr-1",children:x.map(k=>{const K=k.id?!g.has(k.id):!1;return e.jsx("div",{className:`px-2 py-2 rounded-md ${K?"bg-primary/5":""}`,children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(Cl,{className:`h-4 w-4 ${K?"text-primary":"text-muted-foreground"}`}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-sm font-medium",children:k.title||"إشعار"}),e.jsx("div",{className:"text-xs text-muted-foreground whitespace-pre-line",children:k.message}),k.linkUrl&&e.jsxs(d,{variant:"link",className:"px-0 h-6 text-xs",onClick:()=>T(k.linkUrl,k.id),children:["فتح الرابط ",e.jsx(Pc,{className:"h-3 w-3 ml-1"})]})]}),K?e.jsx(d,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>Z(k.id),title:"تمييز كمقروء",children:e.jsx(Ps,{className:"h-4 w-4 text-primary"})}):e.jsx(d,{variant:"ghost",size:"icon",className:"h-6 w-6",disabled:!0,title:"مقروء",children:e.jsx(Ps,{className:"h-4 w-4 text-muted-foreground"})})]})},k.id)})})]})]}),N]})}const kl=({isOpen:l,onClose:u,onTrialStarted:o})=>{const{user:x}=ds(),[y,g]=a.useState(!1),[t,$]=a.useState(!1),[D,p]=a.useState(""),[h,N]=a.useState(24);a.useEffect(()=>{const z=async()=>{if(x!=null&&x.uid){const L=await ga.getTrialData(x.uid);$(L.hasUsedFreeTrial)}},Z=async()=>{try{const L=await ga.getTrialDurationHours();N(L)}catch{}};l&&(z(),Z())},[l,x]);const b=async()=>{if(x!=null&&x.uid){g(!0);try{const z=await ga.startFreeTrial(x.uid);z.success?(p(z.message),window.location.href="/user/dashboard"):p(z.message||"تعذر تفعيل التجربة المجانية")}catch{p("حدث خطأ أثناء تفعيل التجربة المجانية")}finally{g(!1)}}},E=async()=>{if(x!=null&&x.uid){g(!0);try{await Ho(x.uid,ls.ZERO,x.uid),window.location.href="/user/dashboard"}catch{p("حدث خطأ أثناء تفعيل باقة الزيرو")}finally{g(!1)}}};return e.jsxs(e.Fragment,{children:[l&&e.jsx("div",{className:"fixed inset-0 z-40",style:{background:"rgba(0, 0, 0, 0.15)",backdropFilter:"blur(3px)",WebkitBackdropFilter:"blur(3px)",pointerEvents:"auto"}}),e.jsx(ie,{open:l,onOpenChange:()=>{},children:e.jsxs(oe,{className:"sm:max-w-lg z-50 border-0 shadow-2xl",style:{position:"fixed",top:"50%",left:"50%",transform:"translate(-50%, -50%)",pointerEvents:"auto",background:"linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 0.95) 100%)",backdropFilter:"blur(10px)",WebkitBackdropFilter:"blur(10px)",borderRadius:"20px",border:"1px solid rgba(255, 255, 255, 0.3)"},children:[e.jsxs(ce,{className:"text-center pb-0 pt-0",children:[e.jsx("div",{className:"flex justify-center mb-1",children:e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-0 rounded-full",style:{background:"linear-gradient(135deg, #f59e0b, #d97706)",filter:"blur(8px)",opacity:.3}}),e.jsx("div",{className:"relative bg-gradient-to-br from-orange-400 to-orange-600 p-2 rounded-full",children:e.jsx(on,{className:"h-12 w-12 text-white"})})]})}),e.jsx(de,{className:"text-2xl font-bold bg-gradient-to-r from-gray-800 to-gray-600 bg-clip-text text-transparent text-center mt-0 mb-0 leading-tight",children:"تفعيل الحساب مطلوب"})]}),e.jsxs("div",{className:"text-center pt-6 pb-0 px-2",children:[e.jsxs("div",{className:"bg-gradient-to-r from-orange-50 to-amber-50 rounded-xl p-6 mb-6 border border-orange-100",children:[e.jsx("p",{className:"text-gray-700 text-lg leading-relaxed font-medium",children:"حسابك في انتظار التفعيل من قبل المسؤول"}),e.jsx("p",{className:"text-sm font-semibold text-orange-700 mt-3 mb-3 bg-orange-100 p-3 rounded-lg border border-orange-200",children:"للتفعيل السريع: تواصل مع الإدارة عبر واتساب فقط على الرقم التالي"}),e.jsxs("div",{className:"bg-green-50 p-4 rounded-lg border border-green-200 mt-3",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"text-base font-bold text-green-700",children:"واتساب الإدارة:"}),e.jsx("a",{href:"https://wa.me/201000392539",target:"_blank",rel:"noopener noreferrer",className:"text-lg font-bold text-green-600 hover:text-green-700 underline",children:"01000392539"})]}),e.jsx("p",{className:"text-sm text-green-600 mt-2 text-center",children:"اضغط على الرقم للتواصل المباشر عبر واتساب"})]})]}),!t&&e.jsxs("div",{className:"bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-4 mb-4 border border-green-200",children:[e.jsxs("div",{className:"flex items-center justify-center mb-2",children:[e.jsx(on,{className:"h-5 w-5 text-green-600 ml-2"}),e.jsx("span",{className:"text-green-700 font-semibold",children:"باقة الزيرو المجانية الدائمة"})]}),e.jsx("p",{className:"text-green-600 text-sm text-center",children:"فعل باقة الزيرو الان واستمتع ب 10 عمليات سحب وتحويل يوميا"})]}),D&&e.jsx("div",{className:`rounded-xl p-4 mb-4 text-center ${D.includes("تم تفعيل")?"bg-green-50 border border-green-200 text-green-700":"bg-red-50 border border-red-200 text-red-700"}`,children:e.jsx("p",{className:"font-medium",children:D})}),e.jsxs("div",{className:"flex items-center justify-center space-x-2 text-sm text-gray-500 mb-0",children:[e.jsxs("div",{className:"flex space-x-1",children:[e.jsx("div",{className:"w-2 h-2 bg-orange-400 rounded-full animate-pulse"}),e.jsx("div",{className:"w-2 h-2 bg-orange-400 rounded-full animate-pulse",style:{animationDelay:"0.2s"}}),e.jsx("div",{className:"w-2 h-2 bg-orange-400 rounded-full animate-pulse",style:{animationDelay:"0.4s"}})]}),e.jsx("span",{className:"mr-2",children:"في انتظار التفعيل"})]})]}),e.jsxs("div",{className:"flex flex-col space-y-3 pb-2",children:[!t&&!D.includes("تم تفعيل")&&e.jsxs(e.Fragment,{children:[e.jsxs(d,{onClick:b,disabled:y,className:"w-full max-w-2xl mx-auto relative bg-gradient-to-r from-blue-600 to-indigo-600 hover:brightness-110 text-white px-10 py-4 rounded-2xl font-bold text-xl ring-2 ring-blue-300 ring-offset-1 shadow-2xl hover:shadow-3xl transition-all duration-500 transform hover:scale-110 hover:-translate-y-1 disabled:opacity-50 disabled:cursor-not-allowed overflow-hidden group focus-visible:outline-none focus-visible:ring-4 focus-visible:ring-blue-300",style:{boxShadow:"0 15px 35px rgba(59, 130, 246, 0.4), 0 5px 15px rgba(0, 0, 0, 0.1)"},children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-white/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"}),e.jsx("div",{className:"absolute -top-1 -left-1 w-3 h-3 bg-yellow-400 rounded-full animate-ping"}),e.jsx("div",{className:"absolute -top-1 -right-1 w-2 h-2 bg-green-400 rounded-full animate-pulse"}),y?e.jsxs("div",{className:"flex items-center relative z-10",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-white ml-3"}),e.jsx("span",{className:"bg-gradient-to-r from-white to-gray-100 bg-clip-text text-transparent",children:"جاري التفعيل..."})]}):e.jsxs("div",{className:"flex items-center relative z-10",children:[e.jsx(Lc,{className:"h-6 w-6 ml-3 animate-bounce"}),e.jsx("span",{className:"bg-gradient-to-r from-white to-gray-100 bg-clip-text text-transparent",children:`التجربة المجانية لمدة ${h} ${h>=3&&h<=10?"ساعات":h===2?"ساعتين":"ساعة"}`})]})]}),e.jsxs(d,{onClick:E,disabled:y,className:"w-full max-w-2xl mx-auto relative bg-gradient-to-r from-green-600 to-emerald-600 hover:brightness-110 text-white px-10 py-4 rounded-2xl font-bold text-xl ring-2 ring-emerald-300 ring-offset-1 shadow-2xl hover:shadow-3xl transition-all duration-500 transform hover:scale-110 hover:-translate-y-1 disabled:opacity-50 disabled:cursor-not-allowed overflow-hidden group focus-visible:outline-none focus-visible:ring-4 focus-visible:ring-emerald-300",style:{boxShadow:"0 15px 35px rgba(99, 102, 241, 0.4), 0 5px 15px rgba(0, 0, 0, 0.1)"},children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-white/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"}),e.jsx("div",{className:"absolute -top-1 -left-1 w-3 h-3 bg-yellow-400 rounded-full animate-ping"}),e.jsx("div",{className:"absolute -top-1 -right-1 w-2 h-2 bg-green-400 rounded-full animate-pulse"}),y?e.jsxs("div",{className:"flex items-center relative z-10",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-white ml-3"}),e.jsx("span",{className:"bg-gradient-to-r from-white to-gray-100 bg-clip-text text-transparent",children:"جاري التفعيل..."})]}):e.jsxs("div",{className:"flex items-center relative z-10",children:[e.jsx(on,{className:"h-6 w-6 ml-3 animate-bounce"}),e.jsx("span",{className:"bg-gradient-to-r from-white to-gray-100 bg-clip-text text-transparent",children:"فعّل باقة الزيرو الآن"})]})]})]}),e.jsx(d,{onClick:u,variant:"outline",className:"border-2 border-gray-300 hover:border-gray-400 text-gray-700 hover:text-gray-800 px-10 py-3 rounded-xl font-semibold text-lg transition-all duration-300 transform hover:scale-105",children:t?"فهمت":"إغلاق"})]})]})})]})};function td({isOpen:l,onClose:u}){const[o,x]=a.useState("0"),[y,g]=a.useState(null),[t,$]=a.useState(null),[D,p]=a.useState(!1),h=U=>{D?(x(U),p(!1)):x(o==="0"?U:o+U)},N=U=>{const O=parseFloat(o);if(y===null)g(O);else if(t){const ue=b(y||0,O,t);x(String(ue)),g(ue)}p(!0),$(U)},b=(U,O,q)=>{switch(q){case"+":return U+O;case"-":return U-O;case"×":return U*O;case"÷":return O===0?0:U/O;case"=":return O;default:return O}},E=()=>{const U=parseFloat(o);if(y!==null&&t){const O=b(y,U,t);x(String(O)),g(null),$(null),p(!0)}},z=()=>{x("0"),g(null),$(null),p(!1)},Z=()=>{x("0")},L=()=>{D?(x("0."),p(!1)):o.indexOf(".")===-1&&x(o+".")},T=()=>{o!=="0"&&x(o.charAt(0)==="-"?o.slice(1):"-"+o)},k=()=>{const U=parseFloat(o);x(String(U/100))},K=U=>{const O=U.key;U.preventDefault(),O>="0"&&O<="9"?h(O):O==="+"?N("+"):O==="-"?N("-"):O==="*"?N("×"):O==="/"?N("÷"):O==="Enter"||O==="="?E():O==="Escape"||O==="c"||O==="C"?z():O==="Backspace"?Z():O==="."?L():O==="%"&&k()};return a.useEffect(()=>(l?document.addEventListener("keydown",K):document.removeEventListener("keydown",K),()=>{document.removeEventListener("keydown",K)}),[l,o,y,t,D]),e.jsx(ie,{open:l,onOpenChange:U=>!U&&u(),children:e.jsxs(oe,{className:"sm:max-w-md",children:[e.jsx(ce,{children:e.jsxs(de,{className:"flex items-center gap-2 text-right",children:[e.jsx(Kl,{className:"h-5 w-5"}),"آلة حاسبة"]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-gray-900 text-white p-4 rounded-lg text-right",children:e.jsx("div",{className:"text-3xl font-mono font-bold min-h-[3rem] flex items-center justify-end overflow-hidden",children:o})}),e.jsxs("div",{className:"grid grid-cols-4 gap-2",children:[e.jsx(d,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:z,children:"AC"}),e.jsx(d,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:Z,children:"CE"}),e.jsx(d,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:k,children:"%"}),e.jsx(d,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>N("÷"),children:"÷"}),e.jsx(d,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>h("7"),children:"7"}),e.jsx(d,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>h("8"),children:"8"}),e.jsx(d,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>h("9"),children:"9"}),e.jsx(d,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>N("×"),children:"×"}),e.jsx(d,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>h("4"),children:"4"}),e.jsx(d,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>h("5"),children:"5"}),e.jsx(d,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>h("6"),children:"6"}),e.jsx(d,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>N("-"),children:"-"}),e.jsx(d,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>h("1"),children:"1"}),e.jsx(d,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>h("2"),children:"2"}),e.jsx(d,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>h("3"),children:"3"}),e.jsx(d,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>N("+"),children:"+"}),e.jsx(d,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50 col-span-2",onClick:()=>h("0"),children:"0"}),e.jsx(d,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:L,children:"."}),e.jsx(d,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:E,children:"="})]}),e.jsx(d,{variant:"outline",className:"w-full h-10 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:T,children:"+/-"})]})]})})}function sd({isOpen:l,onClose:u,initialBarcode:o}){const[x,y]=a.useState([]),[g,t]=a.useState({productName:"",price:"",wholesalePrice:"",quantity:"",barcode:"",serialNumber:""}),[$,D]=a.useState(!1);a.useState(null);const{toast:p}=Qt(),{user:h,profile:N}=ds(),{isShiftActive:b,shiftUser:E}=ya(),[z,Z]=a.useState([]),[L,T]=a.useState({}),[k,K]=a.useState({});a.useState({});const[U,O]=a.useState(""),[q,ue]=a.useState(!1),[se,ve]=a.useState({}),Y=He.useRef(""),ee=He.useRef(0),[Te,G]=a.useState(0),[re,Fe]=a.useState(0),[nt,ht]=a.useState(!1),[Oe,Tt]=a.useState(!0),[$e,Ze]=a.useState(!1),[ct,Ve]=a.useState(""),Ee=a.useMemo(()=>{const m=ct.trim().toLowerCase();return m?z.filter(I=>I.name.toLowerCase().includes(m)):z},[z,ct]);a.useEffect(()=>{l&&(h!=null&&h.uid)&&(St(),Oe||Xe())},[l,h==null?void 0:h.uid,Oe]),a.useEffect(()=>{if(!l)return;const m=I=>{const J=Date.now();if(I.key==="Enter"){const j=(Y.current||"").trim();Y.current="",j&&ae(j);return}I.key.length===1&&(J-(ee.current||0)>100&&(Y.current=""),Y.current+=I.key,ee.current=J)};return window.addEventListener("keydown",m),()=>window.removeEventListener("keydown",m)},[l,z]),a.useEffect(()=>{l&&o&&ae(o)},[l,o]);const ft=async()=>{if(h!=null&&h.uid)try{const m=N==null?void 0:N.shopId;let I,J=[];if(m){const j=Is(ns(ot,"products"),It("shopId","==",m),It("userId","==",h.uid));if(I=await ks(j),J=I.docs.map(M=>({id:M.id,name:String(M.data().name??""),sellingPrice:Number(M.data().sellingPrice??0),wholesalePrice:Number(M.data().wholesalePrice??0),quantity:Number(M.data().quantity??0),barcode:String(M.data().barcode??""),serialNumber:String(M.data().serialNumber??"")})),J.length===0){const M=Is(ns(ot,"products"),It("userId","==",h.uid)),me=(await ks(M)).docs.map(ge=>({id:ge.id,name:String(ge.data().name??""),sellingPrice:Number(ge.data().sellingPrice??0),wholesalePrice:Number(ge.data().wholesalePrice??0),quantity:Number(ge.data().quantity??0),barcode:String(ge.data().barcode??""),serialNumber:String(ge.data().serialNumber??"")}));me.length>0&&(J=me,p({title:"تم استرجاع المنتجات",description:"عثرنا على منتجات محفوظة لك خارج المتجر الحالي وقمنا بعرضها."}))}}else{const j=Is(ns(ot,"products"),It("userId","==",h.uid));I=await ks(j),J=I.docs.map(M=>({id:M.id,name:String(M.data().name??""),sellingPrice:Number(M.data().sellingPrice??0),wholesalePrice:Number(M.data().wholesalePrice??0),quantity:Number(M.data().quantity??0),barcode:String(M.data().barcode??""),serialNumber:String(M.data().serialNumber??"")}))}if(Z(J),N!=null&&N.shopId&&J.length>0){const j=J.filter(M=>{const _=((I==null?void 0:I.docs)||[]).find(ge=>ge.id===M.id);return!(!!_&&!!_.data().shopId)});if(j.length>0)try{await Promise.all(j.map(M=>Ys(Yt(ot,"products",M.id),{shopId:N.shopId,updatedAt:Js()}))),p({title:"تم ترتيب المنتجات",description:"تم ربط بعض المنتجات غير المربوطة بمتجرك الحالي تلقائياً."})}catch(M){console.warn("تعذّر ترحيل shopId لبعض المنتجات:",M)}}}catch(m){console.error("Error loading shop products:",m)}};a.useEffect(()=>{l&&(h!=null&&h.uid)&&(ft(),Xe())},[l,h==null?void 0:h.uid,N==null?void 0:N.shopId]);const St=()=>{if(!(h!=null&&h.uid)){console.log("No user authenticated, cannot load sales data");return}const m=new Date().toISOString().split("T")[0],I=localStorage.getItem(`salesData_${h.uid}_${m}`);y(I?JSON.parse(I):[])},Dt=m=>{if(!(h!=null&&h.uid)){console.log("No user authenticated, cannot save sales data");return}const I=new Date().toISOString().split("T")[0];localStorage.setItem(`salesData_${h.uid}_${I}`,JSON.stringify(m)),y(m)},Xe=async()=>{if(h!=null&&h.uid)try{const m=new Date,I=new Date(m.getFullYear(),m.getMonth(),1),J=new Date(m.getFullYear(),m.getMonth()+1,0),j=je=>je.toISOString().split("T")[0],M=j(I),_=j(J),me=Is(ns(ot,"dailySales"),It("userId","==",h.uid),It("date",">=",M),It("date","<=",_)),ge=await ks(me);let Be=0,ke=0;if(!ge.empty)ge.forEach(je=>{const De=je.data(),Ue=Number(De.sellingPrice??0),et=Number(De.quantity??0),We=Number(De.profit??(Number(De.sellingPrice??0)-Number(De.wholesalePrice??0))*et);Be+=Ue*et,ke+=We});else{const je=Is(ns(ot,"dailySales"),It("userId","==",h.uid));(await ks(je)).forEach(Ue=>{const et=Ue.data(),We=String(et.date??"").slice(0,10);if(We>=M&&We<=_){const _t=Number(et.sellingPrice??0),Zt=Number(et.quantity??0),Ft=Number(et.profit??(Number(et.sellingPrice??0)-Number(et.wholesalePrice??0))*Zt);Be+=_t*Zt,ke+=Ft}}),(Be>0||ke>0)&&p({title:"تم استرجاع تقارير الشهر",description:"تم حساب التقارير باستخدام مسار احتياطي للتواريخ القديمة."})}G(Be),Fe(ke)}catch(m){console.error("Error loading monthly stats:",m)}},bt=async m=>{if(h!=null&&h.uid)try{const I=((m.price??0)-(m.wholesalePrice??0))*(m.quantity??0),J=b&&E?"cashier":"admin",j=J==="cashier"?(E==null?void 0:E.name)||"كاشير":(N==null?void 0:N.fullName)||(h==null?void 0:h.displayName)||"الحساب الرئيسي",M=J==="cashier"&&(E==null?void 0:E.username)||null;await Sl(ns(ot,"dailySales"),{userId:h.uid,productName:m.productName,quantity:m.quantity,wholesalePrice:m.wholesalePrice??null,sellingPrice:m.price,profit:I,date:m.date,time:m.time,performedByType:J,performedByName:j,performedByUsername:M,serialNumber:m.serialNumber??null,barcode:m.barcode??null,createdAt:Js()})}catch(I){console.error("Error saving sale:",I)}},yt=async m=>{const I=L[m.id]||"",J=parseInt(I);if(isNaN(J)||J<=0){p({title:"كمية غير صالحة",description:"أدخل كمية صحيحة للبيـع",variant:"destructive"});return}if(J>m.quantity){p({title:"كمية أكبر من المتاح",description:"الكمية المطلوب بيعها تتجاوز المخزون المتاح",variant:"destructive"});return}const j=new Date,M=b&&E?"cashier":"admin",_=M==="cashier"?(E==null?void 0:E.name)||"كاشير":(N==null?void 0:N.fullName)||(h==null?void 0:h.displayName)||"الحساب الرئيسي",me=M==="cashier"&&(E==null?void 0:E.username)||null,ge=(m.serialNumber||"").trim(),Be={id:Date.now().toString(),productName:m.name,price:m.sellingPrice,wholesalePrice:m.wholesalePrice,quantity:J,date:j.toISOString().split("T")[0],time:j.toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit"}),performedByType:M,performedByName:_,performedByUsername:me,serialNumber:ge||void 0,barcode:m.barcode};try{Dt([...x,Be]),await bt(Be);const ke=m.quantity-J;await Ys(Yt(ot,"products",m.id),{quantity:ke,updatedAt:Js()}),Z(je=>je.map(De=>De.id===m.id?{...De,quantity:ke}:De)),T(je=>({...je,[m.id]:""})),p({title:"تم البيع",description:`تم بيع ${J} قطعة من ${m.name}`})}catch(ke){console.error("Error selling product:",ke),p({title:"فشل البيع",description:"تعذّر تنفيذ عملية البيع",variant:"destructive"})}},Bt=async m=>{try{T(I=>({...I,[m.id]:"1"})),await yt(m)}catch(I){console.error("Error selling by barcode:",I)}},Ut=async m=>{if(b){p({title:"غير مسموح في وضع الكاشير",description:"لا يمكن إضافة قطع أثناء الورديه",variant:"destructive"});return}const I=k[m.id]||"",J=parseInt(I);if(isNaN(J)||J<=0){p({title:"كمية غير صالحة",description:"أدخل كمية صحيحة للإضافة",variant:"destructive"});return}try{const j=m.quantity+J;await Ys(Yt(ot,"products",m.id),{quantity:j,updatedAt:Js()}),Z(M=>M.map(_=>_.id===m.id?{..._,quantity:j}:_)),K(M=>({...M,[m.id]:""})),p({title:"تمت الإضافة",description:`تمت إضافة ${J} قطعة إلى ${m.name}`})}catch(j){console.error("Error adding pieces:",j),p({title:"فشل الإضافة",description:"تعذّر إضافة الكمية إلى المخزون",variant:"destructive"})}},jt=async m=>{if(!(h!=null&&h.uid))return;if(b){p({title:"غير مسموح في وضع الكاشير",description:"لا يمكن حذف المنتجات أثناء الورديه",variant:"destructive"});return}if(window.confirm(`هل تريد حذف المنتج "${m.name}"؟`))try{await Go(Yt(ot,"products",m.id)),Z(J=>J.filter(j=>j.id!==m.id)),p({title:"تم الحذف",description:`تم حذف المنتج ${m.name}`})}catch(J){console.error("Error deleting product:",J),p({title:"فشل الحذف",description:"تعذّر حذف المنتج",variant:"destructive"})}},W=async()=>{try{if(!(h!=null&&h.uid)){p({title:"خطأ",description:"غير مسجّل دخول",variant:"destructive"});return}if(b){p({title:"غير مسموح في وضع الكاشير",description:"لا يمكن إضافة منتجات أثناء الورديه",variant:"destructive"});return}const m=g.productName.trim(),I=parseFloat(g.price),J=parseFloat(g.wholesalePrice||"0"),j=parseInt(g.quantity);if(!m||isNaN(I)||isNaN(j)){p({title:"بيانات غير مكتملة",description:"أدخل اسم المنتج والسعر والكمية",variant:"destructive"});return}const M={name:m,sellingPrice:I,wholesalePrice:isNaN(J)?0:J,quantity:isNaN(j)?0:j,userId:h.uid,barcode:(g.barcode||"").trim()||void 0,serialNumber:(g.serialNumber||"").trim()||void 0,createdAt:Js(),updatedAt:Js()};N!=null&&N.shopId&&(M.shopId=N.shopId);const _=await Sl(ns(ot,"products"),M);Z(me=>[{id:_.id,name:m,sellingPrice:I,wholesalePrice:isNaN(J)?0:J,quantity:isNaN(j)?0:j,barcode:(g.barcode||"").trim()||"",serialNumber:(g.serialNumber||"").trim()||""},...me]),t({productName:"",price:"",wholesalePrice:"",quantity:"",barcode:"",serialNumber:""}),p({title:"تمت الإضافة",description:`تم إضافة المنتج ${m} بنجاح`})}catch(m){console.error("createProduct error",m),p({title:"فشل الإضافة",description:"تعذّر إضافة المنتج. حاول مجددًا",variant:"destructive"})}},ae=async m=>{const I=(m||"").trim();if(!I)return;const J=z.find(j=>(j.barcode||"")===I);if(!J){p({title:"باركود غير معروف",description:"لم يتم العثور على منتج بهذا الباركود"});return}await Bt(J)},xe=()=>{const m=Object.entries(se).map(([Be,ke])=>{const je=Number(ke),De=z.find(Ue=>Ue.id===Be);return!De||!je||je<=0?null:{name:De.name,qty:je,price:De.sellingPrice,total:je*De.sellingPrice}}).filter(Boolean);if(m.length===0){p({title:"لم يتم اختيار منتجات",description:"فعّل وضع الفاتورة واختر منتجات وكميات للطباعة"});return}const I=(N==null?void 0:N.shopName)||(h==null?void 0:h.displayName)||"المحل",J=(N==null?void 0:N.phone)||(h==null?void 0:h.phoneNumber)||"",j=m.reduce((Be,ke)=>Be+ke.total,0),M=new Date().toLocaleString("ar-EG"),_=m.map(Be=>`
        <tr>
          <td style="border:1px solid #ddd;padding:6px">${Be.name}</td>
          <td style="border:1px solid #ddd;padding:6px;text-align:center">${Be.qty}</td>
          <td style="border:1px solid #ddd;padding:6px;text-align:center">${it(Be.price)}</td>
          <td style="border:1px solid #ddd;padding:6px;text-align:center;font-weight:bold;color:#0a7">${it(Be.total)}</td>
        </tr>
      `).join(""),me=`
      <html>
        <head>
          <meta charset="utf-8" />
          <title>فاتورة</title>
          <style>
            body { font-family: Tahoma, Arial, sans-serif; direction: rtl; }
            .header { text-align: center; margin-bottom: 12px; }
            .header h2 { margin: 0; }
            .meta { text-align: center; color: #555; margin-bottom: 8px; }
            table { width: 100%; border-collapse: collapse; }
            .total { text-align: left; font-weight: bold; margin-top: 10px; }
          </style>
        </head>
        <body>
          <div class="header">
            <h2>${I}</h2>
            ${J?`<div class="meta">رقم التليفون: ${J}</div>`:""}
            <div class="meta">التاريخ: ${M}</div>
          </div>
          <table>
            <thead>
              <tr>
                <th style="border:1px solid #ddd;padding:6px">المنتج</th>
                <th style="border:1px solid #ddd;padding:6px">الكمية</th>
                <th style="border:1px solid #ddd;padding:6px">السعر</th>
                <th style="border:1px solid #ddd;padding:6px">الإجمالي</th>
              </tr>
            </thead>
            <tbody>
              ${_}
            </tbody>
          </table>
          <div class="total">الإجمالي الكلي: ${it(j)}</div>
        </body>
      </html>
    `,ge=window.open("","_blank");ge&&(ge.document.write(me),ge.document.close(),ge.focus(),ge.print(),ge.close())};return e.jsxs(ie,{open:l,onOpenChange:u,children:[e.jsxs(oe,{className:"max-w-7xl md:max-w-6xl lg:max-w-7xl w-[95vw] md:w-[90vw] h-[95vh] md:h-[90vh] p-0 overflow-y-auto",children:[e.jsx(ce,{className:"px-3 md:px-6 py-3 md:py-4 border-b bg-gradient-to-r from-blue-50 to-purple-50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 md:gap-3",children:[e.jsx("div",{className:"p-1.5 md:p-2 bg-blue-100 rounded-lg",children:e.jsx(xn,{className:"h-5 w-5 md:h-6 md:w-6 text-blue-600"})}),e.jsxs("div",{children:[e.jsx(de,{className:"text-lg md:text-xl font-bold text-gray-800",children:"📊 بيانات المبيعات اليومية"}),e.jsxs("p",{className:"text-xs md:text-sm text-gray-600 mt-1 hidden sm:block",children:["إدارة وتتبع مبيعات اليوم - ",new Date().toLocaleDateString("ar-EG")]})]})]}),e.jsx("div",{className:"flex items-center gap-1 md:gap-2",children:e.jsx(d,{variant:"ghost",size:"sm",onClick:u,className:"h-8 w-8 md:h-9 md:w-9",children:e.jsx(El,{className:"h-4 w-4"})})})]})}),e.jsxs("div",{className:"flex flex-col md:flex-row h-full",dir:"rtl",children:[e.jsxs("div",{className:"w-full md:w-72 lg:w-80 bg-white/50 border-r",children:[e.jsxs("div",{className:"p-3 md:p-4 border-b bg-white/30",children:[e.jsxs("h3",{className:"font-semibold text-gray-800 mb-3 flex items-center gap-2 text-sm md:text-base",children:[e.jsx(Qe,{className:"h-4 w-4 text-green-600"}),"ملخص المبيعات"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 md:gap-3",children:[e.jsxs("div",{className:"bg-blue-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-blue-600",children:it(x.reduce((m,I)=>m+I.price*I.quantity,0))}),e.jsx("div",{className:"text-xs md:text-sm text-blue-600",children:"إجمالي المبيعات"})]}),e.jsxs("div",{className:"bg-green-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-green-600",children:it(x.reduce((m,I)=>m+(I.price-(I.wholesalePrice??0))*I.quantity,0))}),e.jsx("div",{className:"text-xs md:text-sm text-green-600",children:"إجمالي الأرباح"})]}),e.jsxs("div",{className:"bg-yellow-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-yellow-600",children:Ks(z.length)}),e.jsx("div",{className:"text-xs md:text-sm text-yellow-600",children:"عدد المنتجات"})]}),e.jsxs("div",{className:"bg-purple-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-purple-600",children:Ks(x.length)}),e.jsx("div",{className:"text-xs md:text-sm text-purple-600",children:"عدد المبيعات"})]})]}),e.jsxs("div",{className:"relative mb-2",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-1 md:gap-2 text-xs md:text-sm font-semibold text-indigo-700",children:[e.jsx(gs,{className:"h-3 w-3 md:h-4 md:w-4"}),e.jsx(xn,{className:"h-3 w-3 md:h-4 md:w-4"}),e.jsx("span",{children:"تقارير الشهر"})]}),e.jsx(d,{size:"sm",variant:"ghost",onClick:()=>Ze(m=>!m),className:"h-6 w-6 p-0 rounded-full",title:$e?"إظهار التقارير":"إخفاء التقارير",children:$e?e.jsx(bn,{className:"h-4 w-4"}):e.jsx($l,{className:"h-4 w-4"})})]}),e.jsx("div",{className:$e?"overflow-hidden max-h-0 transition-[max-height] duration-300":"overflow-hidden transition-[max-height] duration-300 max-h-[400px]",children:e.jsxs("div",{className:Oe?"grid grid-cols-2 gap-2 md:gap-4 filter blur-sm pointer-events-none":"grid grid-cols-2 gap-2 md:gap-4",children:[e.jsxs("div",{className:"bg-indigo-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-indigo-600",children:it(Te)}),e.jsx("div",{className:"text-xs md:text-sm text-indigo-600",children:"مبيعات الشهر"})]}),e.jsxs("div",{className:"bg-pink-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-pink-600",children:it(re)}),e.jsx("div",{className:"text-xs md:text-sm text-pink-600",children:"أرباح الشهر"})]})]})}),!$e&&Oe&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center rounded-lg bg-yellow-100/60",children:e.jsxs(d,{size:"sm",variant:"ghost",onClick:async()=>{try{if(await isZeroPlan()){p({title:"الخطة زيرو",description:"التقارير الشهرية غير متاحة في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}catch{}ht(!0)},className:"flex items-center gap-2 bg-yellow-200/70 hover:bg-yellow-300 text-yellow-900 px-3 py-2 rounded-xl shadow-md hover:shadow-lg transition-all",title:"عرض تقارير الشهر",children:[e.jsx(rt,{className:"h-5 w-5 md:h-7 md:w-7"}),e.jsx("span",{className:"text-xs md:text-sm",children:"عرض تقارير الشهر"})]})})]})]}),e.jsx("div",{className:"p-3 md:p-4 border-b bg-white/30",children:e.jsxs("h3",{className:"font-semibold text-gray-800 mb-3 flex items-center gap-2 text-sm md:text-base",children:[e.jsx(tr,{className:"h-4 w-4 text-indigo-600"}),"إحصائيات المنتجات"]})}),e.jsx("div",{className:"p-3 md:p-4 flex-1 overflow-y-auto hidden md:block",children:e.jsxs("h3",{className:"font-semibold text-gray-800 mb-3 flex items-center gap-2",children:[e.jsx(gn,{className:"h-4 w-4 text-blue-600"}),"نصائح للمبيعات"]})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto transition-all duration-300 ease-in-out scrollbar-thin scrollbar-thumb-blue-300 scrollbar-track-blue-100 hover:scrollbar-thumb-blue-400",children:e.jsxs("div",{className:"p-3 md:p-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 md:mb-6 gap-2",children:[e.jsxs("h2",{className:"text-base md:text-lg font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(Uc,{className:"h-4 w-4 md:h-5 md:w-5 text-blue-600"}),"سجل المبيعات (",x.length," عنصر)"]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs md:text-sm text-gray-600",children:[e.jsx(gs,{className:"h-3 w-3 md:h-4 md:w-4"}),e.jsx("span",{className:"hidden sm:inline",children:new Date().toLocaleDateString("ar-EG")}),e.jsx(Os,{className:"h-3 w-3 md:h-4 md:w-4 ml-2"}),e.jsx("span",{children:new Date().toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit"})})]})]}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-3 md:p-4 mb-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("h3",{className:"text-sm md:text-base font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(vt,{className:"h-4 w-4 text-emerald-600"}),"إضافة منتج جديد"]}),e.jsxs(d,{size:"sm",variant:"ghost",className:"h-8",onClick:()=>{if(b){p({title:"غير مسموح في وضع الكاشير",description:"لا يمكن إضافة منتج أثناء الورديه",variant:"destructive"});return}D(m=>!m)},children:[e.jsx(vt,{className:"h-4 w-4 text-emerald-600"}),"إضافة منتج"]})]}),$&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx(V,{htmlFor:"new-product-name",className:"text-xs md:text-sm",children:"اسم المنتج"}),e.jsx(R,{id:"new-product-name",value:g.productName,onChange:m=>t(I=>({...I,productName:m.target.value})),placeholder:"أدخل اسم المنتج"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx(V,{htmlFor:"new-product-price",className:"text-xs md:text-sm",children:"سعر البيع (ج.م)"}),e.jsx(R,{type:"number",id:"new-product-price",value:g.price,onChange:m=>t(I=>({...I,price:m.target.value})),placeholder:"0.00"})]}),e.jsxs("div",{children:[e.jsx(V,{htmlFor:"new-product-wholesale",className:"text-xs md:text-sm",children:"سعر الجملة (ج.م)"}),e.jsx(R,{type:"number",id:"new-product-wholesale",value:g.wholesalePrice||"",onChange:m=>t(I=>({...I,wholesalePrice:m.target.value})),placeholder:"0.00"})]})]}),e.jsxs("div",{children:[e.jsx(V,{htmlFor:"new-product-qty",className:"text-xs md:text-sm",children:"الكمية"}),e.jsx(R,{type:"number",id:"new-product-qty",value:g.quantity,onChange:m=>t(I=>({...I,quantity:m.target.value})),placeholder:"1"})]}),e.jsxs("div",{children:[e.jsx(V,{htmlFor:"new-product-barcode",className:"text-xs md:text-sm",children:"باركود المنتج (اختياري)"}),e.jsx(R,{id:"new-product-barcode",value:g.barcode||"",onChange:m=>t(I=>({...I,barcode:m.target.value})),placeholder:"أدخل/امسح الباركود"})]}),e.jsxs("div",{children:[e.jsx(V,{htmlFor:"new-product-serial",className:"text-xs md:text-sm",children:"سيريال الجهاز (اختياري)"}),e.jsx(R,{id:"new-product-serial",value:g.serialNumber||"",onChange:m=>t(I=>({...I,serialNumber:m.target.value})),placeholder:"أدخل سيريال الجهاز"})]}),e.jsx(d,{className:"h-9 w-full md:w-auto",onClick:W,children:"إضافة المنتج"})]})]}),e.jsx("div",{id:"shop-products-section",className:"bg-white rounded-lg border border-gray-200 overflow-hidden mb-4",children:e.jsxs("div",{className:"mb-4",children:[e.jsxs("h3",{className:"text-sm md:text-base font-semibold text-gray-800 mb-2 flex items-center gap-2",children:[e.jsx(tr,{className:"h-4 w-4 text-green-600"}),"منتجات المحل"]}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(d,{variant:q?"default":"outline",size:"sm",onClick:()=>ue(m=>!m),children:q?"وضع الفاتورة: مفعل":"تفعيل وضع الفاتورة"}),e.jsx(d,{size:"sm",className:"bg-indigo-600 hover:bg-indigo-700 text-white",disabled:Object.keys(se).filter(m=>(se[m]||0)>0).length===0,onClick:xe,children:"طباعة فاتورة"})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(R,{value:ct,onChange:m=>Ve(m.target.value),placeholder:"ابحث عن منتج...",className:"h-9 w-full md:w-72 text-sm","aria-label":"البحث عن منتج من منتجات المحل"}),e.jsx(R,{value:U,onChange:m=>O(m.target.value),onKeyDown:async m=>{if(m.key!=="Enter")return;const I=U.trim();I&&(await ae(I),O(""))},placeholder:"مرّر ماسح الباركود هنا (اختياري)",className:"h-9 w-full md:w-64 text-sm","aria-label":"مسح الباركود لإضافة المنتج تلقائياً"}),ct&&e.jsx(d,{variant:"ghost",size:"sm",className:"h-9",onClick:()=>Ve(""),children:"مسح"})]}),e.jsx("div",{className:"overflow-x-auto border border-gray-200 rounded-lg hidden md:block",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"المنتج"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"سعر البيع"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"سعر الجملة"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"المتاح"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"بيع"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:Ee.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"px-3 py-3 text-center text-gray-500",children:z.length===0?"لا توجد منتجات بعد، أضف منتجاً من النموذج أعلاه":"لا توجد نتائج مطابقة للبحث"})}):Ee.map(m=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-3 py-2 font-medium text-gray-900",children:m.name}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:it(m.sellingPrice)}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:it(m.wholesalePrice)}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:Ks(m.quantity)}),e.jsx("td",{className:"px-3 py-2",children:e.jsxs("div",{className:"flex items-center gap-2 flex-nowrap",children:[e.jsx(R,{value:L[m.id]||"",onChange:I=>T(J=>({...J,[m.id]:I.target.value})),type:"number",placeholder:"عدد القطع للبيع",className:"h-8 w-28 text-sm"}),e.jsx(d,{size:"sm",className:"h-8 min-w-[64px]",onClick:()=>yt(m),children:"بيع"}),q&&e.jsx(R,{value:se[m.id]??"",onChange:I=>{const J=parseInt(I.target.value||"0");ve(j=>({...j,[m.id]:isNaN(J)?0:J}))},type:"number",placeholder:"كمية للفاتورة",className:"h-8 w-24 text-sm"}),e.jsx(R,{value:k[m.id]||"",onChange:I=>K(J=>({...J,[m.id]:I.target.value})),type:"number",placeholder:"عدد للإضافة",className:"h-8 w-28 text-sm",disabled:b}),e.jsxs("div",{className:"inline-flex items-center gap-2 flex-nowrap",children:[e.jsx(d,{size:"sm",variant:"outline",className:"h-8 whitespace-nowrap",onClick:()=>Ut(m),disabled:b,title:b?"غير مسموح في وضع الكاشير":void 0,children:"إضافة قطع جديدة"}),e.jsx(d,{size:"sm",variant:"destructive",className:"h-8",onClick:()=>jt(m),title:"حذف المنتج",disabled:b,children:e.jsx(Ot,{className:"h-4 w-4"})})]})]})})]},m.id))})]})}),e.jsx("div",{className:"block md:hidden space-y-3",children:Ee.length===0?e.jsx("div",{className:"text-center text-gray-500 text-sm",children:z.length===0?"لا توجد منتجات بعد، أضف منتجاً من النموذج أعلاه":"لا توجد نتائج مطابقة للبحث"}):Ee.map(m=>e.jsxs("div",{className:"bg-white rounded-xl p-3 border border-gray-200 shadow-sm",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"font-semibold text-gray-900 text-sm break-words",children:m.name}),e.jsx(d,{size:"sm",variant:"destructive",className:"h-8 min-w-[44px] touch-manipulation",onClick:()=>jt(m),title:"حذف المنتج",disabled:b,children:e.jsx(Ot,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-2 text-xs text-gray-700",children:[e.jsx("div",{className:"text-gray-600",children:"سعر البيع"}),e.jsx("div",{className:"text-right font-medium",children:it(m.sellingPrice)}),e.jsx("div",{className:"text-gray-600",children:"سعر الجملة"}),e.jsx("div",{className:"text-right font-medium",children:it(m.wholesalePrice)}),e.jsx("div",{className:"text-gray-600",children:"المتاح"}),e.jsx("div",{className:"text-right font-medium",children:Ks(m.quantity)})]}),e.jsxs("div",{className:"mt-3 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(R,{value:L[m.id]||"",onChange:I=>T(J=>({...J,[m.id]:I.target.value})),type:"number",placeholder:"عدد القطع للبيع",className:"h-9 flex-1 text-sm","aria-label":`عدد القطع للبيع لـ ${m.name}`}),e.jsx(d,{size:"sm",className:"h-9 min-w-[64px]",onClick:()=>yt(m),children:"بيع"})]}),q&&e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(R,{value:se[m.id]??"",onChange:I=>{const J=parseInt(I.target.value||"0");ve(j=>({...j,[m.id]:isNaN(J)?0:J}))},type:"number",placeholder:"كمية للفاتورة",className:"h-9 flex-1 text-sm","aria-label":`كمية للفاتورة لـ ${m.name}`})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(R,{value:k[m.id]||"",onChange:I=>K(J=>({...J,[m.id]:I.target.value})),type:"number",placeholder:"عدد للإضافة",className:"h-9 flex-1 text-sm","aria-label":`عدد القطع للإضافة لـ ${m.name}`,disabled:b}),e.jsx(d,{size:"sm",variant:"outline",className:"h-9 min-w-[64px]",onClick:()=>Ut(m),disabled:b,title:b?"غير مسموح في وضع الكاشير":void 0,children:"إضافة"})]})]})]},m.id))})]})}),x.length===0?e.jsxs("div",{className:"text-center py-8 md:py-12",children:[e.jsx("div",{className:"w-16 h-16 md:w-24 md:h-24 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center",children:e.jsx(tr,{className:"h-8 w-8 md:h-12 md:w-12 text-gray-400"})}),e.jsx("h3",{className:"text-base md:text-lg font-medium text-gray-900 mb-2",children:"لا توجد مبيعات اليوم"}),e.jsx("p",{className:"text-sm text-gray-500",children:"ابدأ ببيع منتج من القائمة أعلاه"})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"block md:hidden",children:e.jsx("div",{className:"max-h-[70vh] overflow-y-auto space-y-3 p-3",children:x.map(m=>e.jsxs("div",{className:"bg-white rounded-xl p-4 border border-gray-200 shadow-sm",children:[e.jsx("div",{className:"mb-3",children:e.jsx("h4",{className:"font-semibold text-gray-900 text-base break-words",children:m.productName})}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-2 text-sm text-gray-700",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Qe,{className:"h-4 w-4 text-blue-600"}),e.jsx("span",{className:"text-gray-600",children:"سعر البيع"})]}),e.jsx("div",{className:"text-right font-medium",children:it(m.price)}),typeof m.wholesalePrice=="number"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Qe,{className:"h-4 w-4 text-indigo-600"}),e.jsx("span",{className:"text-gray-600",children:"سعر الجملة"})]}),e.jsx("div",{className:"text-right font-medium",children:it(m.wholesalePrice)})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(tr,{className:"h-4 w-4 text-emerald-600"}),e.jsx("span",{className:"text-gray-600",children:"الكمية"})]}),e.jsx("div",{className:"text-right font-medium",children:Ks(m.quantity)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Vs,{className:"h-4 w-4 text-purple-600"}),e.jsx("span",{className:"text-gray-600",children:"الربح"})]}),e.jsx("div",{className:"text-right font-semibold text-purple-700",children:it(((m.price??0)-(m.wholesalePrice??0))*(m.quantity??0))}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Qe,{className:"h-4 w-4 text-green-600"}),e.jsx("span",{className:"text-gray-600",children:"الإجمالي"})]}),e.jsx("div",{className:"text-right font-bold text-green-700",children:it(m.price*m.quantity)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx($c,{className:"h-4 w-4 text-amber-600"}),e.jsx("span",{className:"text-gray-600",children:"المنفذ"})]}),e.jsx("div",{className:"text-right text-gray-700",children:m.performedByName??"-"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(gs,{className:"h-4 w-4 text-blue-600"}),e.jsx("span",{className:"text-gray-600",children:"التاريخ"})]}),e.jsx("div",{className:"text-right text-gray-600",children:Tl(m.date)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Os,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"text-gray-600",children:"الوقت"})]}),e.jsx("div",{className:"text-right text-gray-600",children:m.time})]})]},m.id))})}),e.jsx("div",{className:"hidden md:block overflow-x-auto max-h-96 overflow-y-auto scrollbar-thin scrollbar-thumb-green-300 scrollbar-track-green-100 hover:scrollbar-thumb-green-400",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"المنتج"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"سعر البيع (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"سعر الجملة (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الكمية"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الإجمالي (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الربح (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"التاريخ"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الوقت"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"المنفذ"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:x.map((m,I)=>e.jsxs("tr",{className:I%2===0?"bg-white":"bg-gray-50/50",children:[e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-gray-900",children:m.productName}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:it(m.price)}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:typeof m.wholesalePrice=="number"?it(m.wholesalePrice):"-"}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:Ks(m.quantity)}),e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-green-600",children:it(m.price*m.quantity)}),e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-purple-600",children:it(((m.price??0)-(m.wholesalePrice??0))*(m.quantity??0))}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-500",children:Tl(m.date)}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-500",children:m.time}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:m.performedByName??"-"})]},m.id))})]})})]}),e.jsxs("div",{className:"mt-4 md:mt-6 text-xs text-gray-500 text-center bg-gray-50/50 p-2 md:p-3 rounded border border-gray-200/40 space-y-1",children:[e.jsx("p",{className:"font-medium text-gray-600",children:"💰 نظام إدارة المبيعات اليومية"}),e.jsxs("p",{className:"hidden sm:block",children:["• يتم حفظ البيانات تلقائياً لليوم الحالي: ",new Date().toLocaleDateString("ar-EG")]}),e.jsx("p",{children:"• يمكنك إضافة وتعديل وحذف المنتجات حسب الحاجة"}),e.jsx("p",{className:"hidden sm:block",children:"• يتم حفظ البيانات محلياً وعلى Firebase لتعزيز الأمان"})]})]})})]})]}),e.jsx(As,{open:nt,onOpenChange:ht,mode:"verify",title:"قفل إحصائيات الشهر",description:"لا يمكن الاطلاع على تقارير الشهر إلا بإدخال الرقم السري الرئيسي",onSuccess:async()=>{try{const m=h==null?void 0:h.uid;if(m){const I=await vn(m),J=(I==null?void 0:I.planType)??(I==null?void 0:I.plan)??null,j=typeof J=="string"?J.toLowerCase():null;if(J===ls.ZERO||j==="zero"){p({title:"الخطة زيرو",description:"التقارير الشهرية غير متاحة في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}}catch{}Tt(!1),ht(!1),Xe()}})]})}const Ks=l=>new Intl.NumberFormat("ar-EG").format(Number(l||0)),it=l=>`${new Intl.NumberFormat("ar-EG",{minimumFractionDigits:2,maximumFractionDigits:2}).format(Number(l||0))} ج.م`,Tl=l=>{try{const u=new Date(l);return isNaN(u.getTime())?new Date(`${l}T00:00:00`).toLocaleDateString("ar-EG"):u.toLocaleDateString("ar-EG")}catch{return l}};function Yl({size:l=24,className:u,...o}){return e.jsxs("svg",{width:l,height:l,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",className:u,...o,children:[e.jsx("rect",{x:"5",y:"2.5",width:"14",height:"19",rx:"2.5",stroke:"currentColor",strokeWidth:"1.5"}),e.jsx("rect",{x:"7",y:"4.5",width:"10",height:"5.5",rx:"1",stroke:"currentColor",strokeWidth:"1.2"}),e.jsx("path",{d:"M9.5 11.5h5",stroke:"currentColor",strokeWidth:"1.4",strokeLinecap:"round"}),e.jsx("circle",{cx:"8.5",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"12",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"15.5",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"8.5",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"12",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"15.5",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("rect",{x:"8",y:"19",width:"9",height:"1.8",rx:"0.6",stroke:"currentColor",strokeWidth:"1"})]})}var Hl="AlertDialog",[ad,km]=Qo(Hl,[Rl]),ms=Rl(),Gl=l=>{const{__scopeAlertDialog:u,...o}=l,x=ms(u);return e.jsx(gc,{...x,...o,modal:!0})};Gl.displayName=Hl;var rd="AlertDialogTrigger",nd=a.forwardRef((l,u)=>{const{__scopeAlertDialog:o,...x}=l,y=ms(o);return e.jsx(dc,{...y,...x,ref:u})});nd.displayName=rd;var ld="AlertDialogPortal",Ql=l=>{const{__scopeAlertDialog:u,...o}=l,x=ms(u);return e.jsx(fc,{...x,...o})};Ql.displayName=ld;var id="AlertDialogOverlay",Zl=a.forwardRef((l,u)=>{const{__scopeAlertDialog:o,...x}=l,y=ms(o);return e.jsx(mc,{...y,...x,ref:u})});Zl.displayName=id;var Gs="AlertDialogContent",[od,cd]=ad(Gs),dd=Xo("AlertDialogContent"),Xl=a.forwardRef((l,u)=>{const{__scopeAlertDialog:o,children:x,...y}=l,g=ms(o),t=a.useRef(null),$=Bl(u,t),D=a.useRef(null);return e.jsx(hc,{contentName:Gs,titleName:ei,docsSlug:"alert-dialog",children:e.jsx(od,{scope:o,cancelRef:D,children:e.jsxs(uc,{role:"alertdialog",...g,...y,ref:$,onOpenAutoFocus:Zo(y.onOpenAutoFocus,p=>{var h;p.preventDefault(),(h=D.current)==null||h.focus({preventScroll:!0})}),onPointerDownOutside:p=>p.preventDefault(),onInteractOutside:p=>p.preventDefault(),children:[e.jsx(dd,{children:x}),e.jsx(hd,{contentRef:t})]})})})});Xl.displayName=Gs;var ei="AlertDialogTitle",ti=a.forwardRef((l,u)=>{const{__scopeAlertDialog:o,...x}=l,y=ms(o);return e.jsx(xc,{...y,...x,ref:u})});ti.displayName=ei;var si="AlertDialogDescription",ai=a.forwardRef((l,u)=>{const{__scopeAlertDialog:o,...x}=l,y=ms(o);return e.jsx(pc,{...y,...x,ref:u})});ai.displayName=si;var md="AlertDialogAction",ri=a.forwardRef((l,u)=>{const{__scopeAlertDialog:o,...x}=l,y=ms(o);return e.jsx(Ul,{...y,...x,ref:u})});ri.displayName=md;var ni="AlertDialogCancel",li=a.forwardRef((l,u)=>{const{__scopeAlertDialog:o,...x}=l,{cancelRef:y}=cd(ni,o),g=ms(o),t=Bl(u,y);return e.jsx(Ul,{...g,...x,ref:t})});li.displayName=ni;var hd=({contentRef:l})=>{const u=`\`${Gs}\` requires a description for the component to be accessible for screen reader users.

You can add a description to the \`${Gs}\` by passing a \`${si}\` component as a child, which also benefits sighted users by adding visible context to the dialog.

Alternatively, you can use your own component as a description by assigning it an \`id\` and passing the same value to the \`aria-describedby\` prop in \`${Gs}\`. If the description is confusing or duplicative for sighted users, you can use the \`@radix-ui/react-visually-hidden\` primitive as a wrapper around your description component.

For more information, see https://radix-ui.com/primitives/docs/components/alert-dialog`;return a.useEffect(()=>{var x;document.getElementById((x=l.current)==null?void 0:x.getAttribute("aria-describedby"))||console.warn(u)},[u,l]),null},ud=Gl,xd=Ql,ii=Zl,oi=Xl,ci=ri,di=li,mi=ti,hi=ai;const pd=ud,gd=xd,ui=a.forwardRef(({className:l,...u},o)=>e.jsx(ii,{className:Fs("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",l),...u,ref:o}));ui.displayName=ii.displayName;const xi=a.forwardRef(({className:l,...u},o)=>e.jsxs(gd,{children:[e.jsx(ui,{}),e.jsx(oi,{ref:o,className:Fs("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",l),...u})]}));xi.displayName=oi.displayName;const pi=({className:l,...u})=>e.jsx("div",{className:Fs("flex flex-col space-y-2 text-center sm:text-left",l),...u});pi.displayName="AlertDialogHeader";const gi=a.forwardRef(({className:l,...u},o)=>e.jsx(mi,{ref:o,className:Fs("text-lg font-semibold",l),...u}));gi.displayName=mi.displayName;const fi=a.forwardRef(({className:l,...u},o)=>e.jsx(hi,{ref:o,className:Fs("text-sm text-muted-foreground",l),...u}));fi.displayName=hi.displayName;const fn=a.forwardRef(({className:l,...u},o)=>e.jsx(ci,{ref:o,className:Fs(Ml(),l),...u}));fn.displayName=ci.displayName;const vi=a.forwardRef(({className:l,...u},o)=>e.jsx(di,{ref:o,className:Fs(Ml({variant:"outline"}),"mt-2 sm:mt-0",l),...u}));vi.displayName=di.displayName;const Me=l=>{try{return l.toLocaleString("en-US",{maximumFractionDigits:2})}catch{return String(l)}},Al=l=>{try{return(l?new Date(l):new Date).toLocaleString("en-GB",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}catch{return new Date().toISOString()}},sr="machine_daily_opening_values",Pl="machine_daily_receipts",Ol="machine_daily_transfer_receipts",hn="machine_daily_opening_snapshot";function fd({open:l,onOpenChange:u}){const{toast:o}=Qt(),{shiftUser:x}=ya(),[y,g]=a.useState(""),[t,$]=a.useState(""),[D,p]=a.useState(""),[h,N]=a.useState(null),[b,E]=a.useState(null),[z,Z]=a.useState(null),[L,T]=a.useState(null),[k,K]=a.useState(!1),[U,O]=a.useState(!1),[q,ue]=a.useState(""),[se,ve]=a.useState(""),[Y,ee]=a.useState(null),[Te,G]=a.useState(()=>{try{const j=localStorage.getItem(Pl),M=j?JSON.parse(j):[];return Array.isArray(M)?M:[]}catch{return[]}}),[re,Fe]=a.useState(()=>{try{const j=localStorage.getItem(Ol),M=j?JSON.parse(j):[];return Array.isArray(M)?M:[]}catch{return[]}}),[nt,ht]=a.useState(!1),[Oe,Tt]=a.useState(""),[$e,Ze]=a.useState(""),[ct,Ve]=a.useState(!1),[Ee,ft]=a.useState(null);a.useEffect(()=>{if(l)try{const j=localStorage.getItem(sr);if(j){const _=JSON.parse(j);typeof(_==null?void 0:_.openingBase)=="number"&&N(_.openingBase),typeof(_==null?void 0:_.openingAir)=="number"&&E(_.openingAir),typeof(_==null?void 0:_.drawerCash)=="number"&&Z(_.drawerCash)}const M=localStorage.getItem(hn);if(M){const _=JSON.parse(M);typeof(_==null?void 0:_.openingBase)=="number"&&typeof(_==null?void 0:_.openingAir)=="number"&&T({openingBase:_.openingBase,openingAir:_.openingAir,drawerCash:_.drawerCash||0})}}catch{}},[l]),a.useEffect(()=>{try{localStorage.setItem(Pl,JSON.stringify(Te))}catch{}},[Te]),a.useEffect(()=>{try{localStorage.setItem(Ol,JSON.stringify(re))}catch{}},[re]);const St=a.useMemo(()=>(x==null?void 0:x.displayName)||(x==null?void 0:x.name)||(x==null?void 0:x.username)||void 0,[x]),Dt=a.useMemo(()=>re.reduce((j,M)=>j+(M.profit||0),0),[re]),Xe=a.useMemo(()=>re.reduce((j,M)=>j+(M.wholesalePrice||0),0),[re]),bt=()=>{re.length!==0&&(Fe([]),o({title:"تم حذف الإيصالات",description:"تم مسح كل إيصالات التحويل."}))},yt=()=>{Te.length!==0&&(G([]),o({title:"تم حذف الإيصالات",description:"تم مسح كل إيصالات الماكينة."}))},Bt=j=>{G(M=>M.filter(_=>_.id!==j)),o({title:"تم حذف الإيصال",description:"تم إزالة إيصال الماكينة المحدد."})},Ut=()=>{N(null),E(null),Z(null),T(null),g(""),$(""),p("");try{localStorage.removeItem(sr),localStorage.removeItem(hn)}catch{}o({title:"تم التصفير",description:"يمكنك الآن إدخال رصيد افتتاحي جديد."})},jt=()=>{const j=parseFloat(y||"0"),M=parseFloat(t||"0"),_=parseFloat(D||"0");if(isNaN(j)||isNaN(M)||isNaN(_)){o({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة للرصيد الافتتاحي وفلوس الدرج.",variant:"destructive"});return}if(j<0||M<0||_<0){o({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}N(j),E(M),Z(_);try{localStorage.setItem(sr,JSON.stringify({openingBase:j,openingAir:M,drawerCash:_})),localStorage.setItem(hn,JSON.stringify({openingBase:j,openingAir:M,drawerCash:_})),T({openingBase:j,openingAir:M,drawerCash:_})}catch{}o({title:"تم تسجيل البيانات",description:`الافتتاحي الأساسي: ${Me(j)}، الهواء: ${Me(M)}، فلوس الدرج: ${Me(_)}`})},W=()=>{if(h==null||b==null){o({title:"سجل الرصيد الافتتاحي أولاً",description:'يرجى الضغط على زر "إضافة" بعد إدخال الافتتاحي.'});return}O(!0)},ae=()=>{const j=parseFloat(q||"0"),M=parseFloat(se||"0");if(isNaN(j)||isNaN(M)){o({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة لرصيد التسليم.",variant:"destructive"});return}if(j<0||M<0){o({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}const _=(L==null?void 0:L.openingBase)??(h||0),me=(L==null?void 0:L.openingAir)??(b||0),ge=_+me,ke=j+M-ge;ee(ke);const je={id:`${Date.now()}`,openingBase:_,openingAir:me,deliveryBase:j,deliveryAir:M,netResult:ke,createdAt:new Date().toISOString(),cashierName:St,requiredDrawerNoProfit:ke<0?Math.round(-ke*100)/100:0};G(De=>[je,...De]),o({title:"تم إنشاء إيصال تسليم",description:`الناتج النهائي: ${Me(ke)}`})},xe=()=>{const j=parseFloat(Oe||"0"),M=parseFloat($e||"0");if(!Number.isFinite(j)||!Number.isFinite(M)){o({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة لسعر الجملة وسعر التجزئة.",variant:"destructive"});return}if(j<0||M<0){o({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}if(h==null||b==null){o({title:"سجل الرصيد الافتتاحي أولاً",description:'يرجى إدخال الرصيد الأساسي ورصيد الهواء ثم الضغط "إضافة".'});return}const _=Math.round((M-j)*100)/100;ft({wholesalePrice:j,retailPrice:M,profit:_}),Ve(!0)},m=j=>{if(!Ee)return;const M={id:`transfer_${Date.now()}`,wholesalePrice:Ee.wholesalePrice,retailPrice:Ee.retailPrice,profit:Ee.profit,createdAt:new Date().toISOString(),cashierName:St,deductFrom:j},_=Ee.wholesalePrice,me=h??0,ge=b??0,Be=z??0;if(_>(j==="base"?me:ge)){o({title:"رصيد غير كافٍ",description:"لا يوجد رصيد كافٍ للخصم بسعر الجملة.",variant:"destructive"});return}const je=j==="base"?Math.round((me-_)*100)/100:me,De=j==="air"?Math.round((ge-_)*100)/100:ge,Ue=Math.round((Be+Ee.retailPrice)*100)/100;N(je),E(De),Z(Ue);try{localStorage.setItem(sr,JSON.stringify({openingBase:je,openingAir:De,drawerCash:Ue}))}catch{}Fe(et=>[M,...et]),ht(!1),Tt(""),Ze(""),ft(null),Ve(!1),o({title:"تم تسجيل تحويل",description:`الربح الفوري: ${Me(M.profit)} | خصم المخزون: -${Me(_)} (${j==="base"?"الأساسي":"الهواء"}) | درج: +${Me(Ee.retailPrice)}`})},I=()=>{g(""),$(""),O(!1),ue(""),ve(""),ee(null)},J=j=>{j||I(),u(j)};return e.jsxs(ie,{open:l,onOpenChange:J,children:[e.jsxs(oe,{className:"w-[92vw] sm:w-auto sm:max-w-2xl max-h-[85vh] overflow-y-auto",children:[e.jsxs(ce,{className:"space-y-2",children:[e.jsx(de,{className:"flex items-center justify-between text-right",children:e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(Yl,{className:"h-5 w-5 text-yellow-500"}),"يومية المكنة"]})}),e.jsx(Rt,{className:"text-right",children:'أدخل الرصيد الافتتاحي، ثم في نهاية اليوم قم بإدخال رصيد التسليم لإنشاء إيصال منظم باسم "إيصالات ماكينة".'})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-6",children:[e.jsxs(qe,{children:[e.jsx(gt,{className:"pb-2",children:e.jsxs(kt,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-right",children:"الرصيد الافتتاحي"}),e.jsx(d,{variant:"ghost",size:"sm",onClick:()=>K(j=>!j),className:"flex items-center gap-1",children:e.jsx(bn,{className:`h-4 w-4 transition-transform ${k?"rotate-180":""}`})})]})}),e.jsxs("div",{className:"flex items-center justify-between px-6",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(d,{variant:"outline",onClick:()=>ht(!0),disabled:h==null||b==null,className:"border-violet-300 text-violet-700",children:"تحويل"})}),h!=null&&b!=null&&e.jsxs(mt,{className:"bg-violet-100 text-violet-700 border border-violet-200",children:["تم التسجيل: أساسي ",Me(h)," | هواء ",Me(b)," | درج ",Me(z??0)]})]}),e.jsxs(Ge,{className:`space-y-4 ${k?"":"hidden"}`,children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الرصيد الأساسي"}),e.jsx(R,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:y,onChange:j=>g(j.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"رصيد الهواء"}),e.jsx(R,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:t,onChange:j=>$(j.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"فلوس الدرج"}),e.jsx(R,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:D,onChange:j=>p(j.target.value),placeholder:"0.00",className:"text-right"})]})]}),e.jsxs("div",{className:"flex items-center justify-end",children:[e.jsx(d,{variant:"outline",className:"mr-2",onClick:Ut,children:"تصفير"}),e.jsx(d,{onClick:jt,className:"bg-violet-600 hover:bg-violet-700",children:"إضافة"})]})]})]}),e.jsxs(qe,{children:[e.jsx(gt,{className:"pb-2",children:e.jsxs(kt,{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-right",children:"إيصالات تحويل"}),e.jsxs(mt,{className:"bg-green-100 text-green-700 border border-green-200",children:["ربح: ",Me(Dt)]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(d,{variant:"outline",size:"sm",onClick:bt,className:"border-red-300 text-red-700 hover:bg-red-50",children:"حذف الإيصالات"}),e.jsx(rr,{className:"h-4 w-4 text-gray-500"})]})]})}),e.jsx(Ge,{className:"space-y-3",children:re.length===0?e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد تحويلات مسجلة."}):e.jsx("div",{className:"space-y-3 max-h-52 overflow-y-auto pr-1",children:re.map(j=>e.jsxs("div",{className:"rounded-lg border p-3 grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"سعر الجملة"}),e.jsx("p",{className:"text-sm",children:Me(j.wholesalePrice)})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"سعر التجزئة"}),e.jsx("p",{className:"text-sm",children:Me(j.retailPrice)})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"الربح الفوري"}),e.jsx("p",{className:"text-sm text-green-700",children:Me(j.profit)}),j.deductFrom&&e.jsx("div",{className:"mt-1",children:e.jsxs("span",{className:"text-[11px] bg-violet-100 text-violet-700 border border-violet-200 rounded px-2 py-0.5",children:["الخصم من: ",j.deductFrom==="base"?"الأساسي":"الهواء"]})}),e.jsxs("div",{className:"flex items-center justify-end gap-2 text-xs text-gray-500",children:[e.jsx(gs,{className:"h-3 w-3"}),e.jsx("span",{children:Al(j.createdAt)}),j.cashierName&&e.jsxs(e.Fragment,{children:[e.jsx(un,{orientation:"vertical",className:"h-3"}),e.jsxs("span",{children:["الكاشير: ",j.cashierName]})]})]})]})]},j.id))})})]}),e.jsxs(qe,{children:[e.jsx(gt,{className:"pb-2",children:e.jsx(kt,{className:"text-right",children:"نهاية اليوم"})}),e.jsx(Ge,{className:"space-y-4",children:U?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الرصيد الأساسي الحالي"}),e.jsx(R,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:q,onChange:j=>ue(j.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"رصيد الهواء الحالي"}),e.jsx(R,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:se,onChange:j=>ve(j.target.value),placeholder:"0.00",className:"text-right"})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(d,{variant:"secondary",onClick:()=>O(!1),children:"إلغاء"}),e.jsx(d,{onClick:ae,className:"bg-green-600 hover:bg-green-700",children:"تسليم"})]}),Y!=null&&e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{className:"text-right",children:e.jsxs(mt,{className:Y>=0?"bg-green-100 text-green-700 border border-green-200":"bg-red-100 text-red-700 border border-red-200",children:["الناتج النهائي: ",Me(Y)]})}),e.jsxs("div",{className:"mt-2 flex items-center justify-end gap-2",children:[e.jsxs(mt,{className:"bg-blue-100 text-blue-700 border border-blue-200",children:["المجموع النهائي: ",Me(parseFloat(q||"0")+parseFloat(se||"0"))]}),e.jsxs(mt,{className:"bg-amber-100 text-amber-700 border border-amber-200",children:["مطلوب من الدرج (بدون أرباح): ",Me(Xe)]})]})]})]}):e.jsx("div",{className:"flex justify-end",children:e.jsx(d,{variant:"outline",onClick:W,className:"border-violet-300 text-violet-700",children:"تسليم يومية"})})})]}),e.jsxs(qe,{children:[e.jsx(gt,{className:"pb-2",children:e.jsxs(kt,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-right",children:"إيصالات ماكينة"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(d,{variant:"outline",size:"sm",onClick:yt,className:"border-red-300 text-red-700 hover:bg-red-50",children:"حذف الإيصالات"}),e.jsx(rr,{className:"h-4 w-4 text-gray-500"})]})]})}),e.jsx(Ge,{className:"space-y-3",children:Te.length===0?e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد إيصالات حتى الآن."}):e.jsx("div",{className:"space-y-3",children:Te.map(j=>e.jsxs("div",{className:"rounded-lg border p-3 grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"الافتتاحي"}),e.jsxs("p",{className:"text-sm",children:["أساسي: ",Me(j.openingBase)]}),e.jsxs("p",{className:"text-sm",children:["هواء: ",Me(j.openingAir)]})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"التسليم"}),e.jsxs("p",{className:"text-sm",children:["أساسي: ",Me(j.deliveryBase)]}),e.jsxs("p",{className:"text-sm",children:["هواء: ",Me(j.deliveryAir)]})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("div",{className:"flex items-center justify-end",children:e.jsxs(d,{variant:"outline",size:"sm",onClick:()=>Bt(j.id),className:"border-red-300 text-red-700 hover:bg-red-50",children:[e.jsx(Ot,{className:"h-3 w-3 mr-1"})," حذف"]})}),e.jsx("p",{className:"text-xs text-gray-500",children:"النتيجة"}),e.jsx("p",{className:`text-sm ${j.netResult>=0?"text-green-700":"text-red-700"}`,children:Me(j.netResult)}),e.jsxs("div",{className:"mt-1 flex items-center justify-end gap-2",children:[e.jsxs("span",{className:"text-[11px] bg-blue-100 text-blue-700 border border-blue-200 rounded px-2 py-0.5",children:["المجموع النهائي: ",Me(j.deliveryBase+j.deliveryAir)]}),typeof j.requiredDrawerNoProfit=="number"&&e.jsxs("span",{className:"text-[11px] bg-amber-100 text-amber-700 border border-amber-200 rounded px-2 py-0.5",children:["مطلوب من الدرج (بدون أرباح): ",Me(j.requiredDrawerNoProfit||0)]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2 text-xs text-gray-500",children:[e.jsx(gs,{className:"h-3 w-3"}),e.jsx("span",{children:Al(j.createdAt)}),j.cashierName&&e.jsxs(e.Fragment,{children:[e.jsx(un,{orientation:"vertical",className:"h-3"}),e.jsxs("span",{children:["الكاشير: ",j.cashierName]})]})]})]})]},j.id))})})]})]}),e.jsxs(Ce,{className:"flex items-center justify-between",children:[e.jsx(d,{variant:"outline",onClick:()=>J(!1),children:"إغلاق"}),e.jsxs("div",{className:"text-xs text-gray-500 flex items-center gap-1",children:[e.jsx(Os,{className:"h-3 w-3"}),e.jsx("span",{children:"يسجل التاريخ والوقت تلقائياً لكل إيصال"})]})]})]}),e.jsx(ie,{open:nt,onOpenChange:ht,children:e.jsxs(oe,{className:"sm:max-w-sm",children:[e.jsx(ce,{children:e.jsx(de,{children:"تحويل رصيد"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"سعر الجملة"}),e.jsx(R,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:Oe,onChange:j=>Tt(j.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"سعر التجزئة"}),e.jsx(R,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:$e,onChange:j=>Ze(j.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsx("div",{className:"text-right",children:e.jsxs(mt,{className:"bg-green-100 text-green-700 border border-green-200",children:["الربح الفوري: ",Me(parseFloat($e||"0")-parseFloat(Oe||"0")||0)]})})]}),e.jsxs(Ce,{className:"flex items-center justify-end gap-2",children:[e.jsx(d,{variant:"secondary",onClick:()=>ht(!1),children:"إلغاء"}),e.jsx(d,{onClick:xe,className:"bg-violet-600 hover:bg-violet-700",children:"تحويل"})]})]})}),e.jsx(pd,{open:ct,onOpenChange:Ve,children:e.jsxs(xi,{children:[e.jsxs(pi,{children:[e.jsx(gi,{children:"اختيار مصدر الخصم"}),e.jsx(fi,{children:"هل يتم الخصم من الرصيد الأساسي أم من رصيد الهواء؟"})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2 mt-4",children:[e.jsx(vi,{onClick:()=>Ve(!1),children:"رجوع"}),e.jsx(fn,{onClick:()=>m("base"),children:"خصم من الأساسي"}),e.jsx(fn,{onClick:()=>m("air"),children:"خصم من الهواء"})]})]})})]})}function vd(l,u=300){const[o,x]=He.useState(l);return He.useEffect(()=>{const y=setTimeout(()=>x(l),u);return()=>clearTimeout(y)},[l,u]),o}const bd=({userId:l,transactions:u})=>{const[o,x]=a.useState(!1),[y,g]=a.useState(!1),[t,$]=a.useState(!1),[D,p]=a.useState({monthlyWithdrawalProfit:0,monthlyTransferProfit:0,lastUpdated:new Date}),{userSubscription:h}=ds();a.useEffect(()=>{l&&o&&t&&N()},[l,o,t]);const N=async()=>{if(l)try{const L=Hs.getWithdrawTransferProfits(l);p({monthlyWithdrawalProfit:L.monthlyWithdrawProfit||0,monthlyTransferProfit:L.monthlyTransferProfit||0,lastUpdated:new Date})}catch(L){console.error("Error loading profit data:",L)}},b=L=>`${L.toFixed(2)} ج.م`,E=async()=>{try{const L=(h==null?void 0:h.subscription)||null,T=(L==null?void 0:L.planType)??(L==null?void 0:L.plan)??null,k=typeof T=="string"?T.toLowerCase():null;if(T===ls.ZERO||k==="zero"||k==="0"||T===0)return!0}catch{}try{if(l){const L=await vn(l),T=(L==null?void 0:L.planType)??(L==null?void 0:L.plan)??null,k=typeof T=="string"?T.toLowerCase():null;if(T===ls.ZERO||k==="zero"||k==="0"||T===0)return!0}}catch{}return!1},z=async()=>{try{if(await E()){Dl({title:"الخطة زيرو",description:"عرض الأرباح الشهرية غير متاح في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}catch{}g(!0)},Z=async()=>{try{if(await E()){Dl({title:"الخطة زيرو",description:"عرض الأرباح الشهرية غير متاح في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"}),g(!1);return}}catch{}$(!0),x(!0),g(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(d,{size:"sm",variant:"ghost",onClick:z,className:"h-2 w-2 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded transition-all duration-300 hover:scale-110 shadow-sm hover:shadow-md",title:"عرض الأرباح الشهرية",children:e.jsx(rt,{className:"h-1.5 w-1.5"})}),e.jsx(ie,{open:o,onOpenChange:x,children:e.jsxs(oe,{className:"max-w-[220px] mx-auto bg-white border border-gray-200 shadow-md rounded sm:max-w-[180px] sm:bg-gradient-to-br sm:from-purple-50 sm:to-white sm:border-2 sm:border-purple-200 sm:shadow-2xl sm:rounded-2xl",children:[e.jsx(ce,{className:"text-center pb-0 border-b-0 sm:pb-2 sm:border-b sm:border-purple-200",children:e.jsxs(de,{className:"text-xs font-bold text-purple-800 flex items-center justify-center gap-0 mb-0 leading-tight tracking-tight sm:text-xs sm:gap-1 sm:mb-0 sm:leading-normal sm:tracking-normal",children:[e.jsx(gs,{className:"h-2 w-2 text-purple-600 sm:h-3 sm:w-3"}),"شهري"]})}),e.jsxs("div",{className:"space-y-0 py-0 sm:space-y-2 sm:py-2",children:[e.jsx("div",{className:"bg-yellow-50 p-0.5 rounded border border-yellow-200 sm:bg-gradient-to-r sm:from-yellow-50 sm:to-yellow-100 sm:p-2 sm:rounded-xl sm:shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-[10px] sm:text-xs font-semibold text-yellow-900",children:"أرباح فوري"}),e.jsx("span",{className:"text-[10px] sm:text-xs font-bold text-yellow-900",children:b((D.monthlyWithdrawalProfit??0)+(D.monthlyTransferProfit??0))})]})}),e.jsx("div",{className:"bg-red-50 p-0.5 rounded border border-red-200 sm:bg-gradient-to-r sm:from-red-50 sm:to-red-100 sm:p-2 sm:rounded-xl sm:shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1 sm:gap-2",children:[e.jsx(lr,{className:"h-2 w-2 text-red-600 sm:h-3 sm:w-3"}),e.jsx("span",{className:"text-[10px] sm:text-xs",children:"سحب"})]}),e.jsx("span",{className:"text-[10px] sm:text-xs font-bold text-red-700",children:b(D.monthlyWithdrawalProfit)})]})}),e.jsx("div",{className:"bg-blue-50 p-0.5 rounded border border-blue-200 sm:bg-gradient-to-r sm:from-blue-50 sm:to-blue-100 sm:p-2 sm:rounded-xl sm:shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1 sm:gap-2",children:[e.jsx(ql,{className:"h-2 w-2 text-blue-600 sm:h-3 sm:w-3"}),e.jsx("span",{className:"text-[10px] sm:text-xs",children:"تحويل"})]}),e.jsx("span",{className:"text-[10px] sm:text-xs font-bold text-blue-700",children:b(D.monthlyTransferProfit)})]})}),e.jsx("div",{className:"bg-purple-50 p-0.5 rounded border border-purple-200 sm:bg-gradient-to-r sm:from-purple-50 sm:to-purple-100 sm:p-2 sm:rounded-xl sm:shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1 sm:gap-2",children:[e.jsx(Qe,{className:"h-2 w-2 text-purple-600 sm:h-3 sm:w-3"}),e.jsx("span",{className:"text-[10px] sm:text-xs",children:"إجمالي"})]}),e.jsx("span",{className:"text-[10px] sm:text-xs font-bold text-purple-700",children:b(D.monthlyWithdrawalProfit+D.monthlyTransferProfit)})]})})]}),!t&&e.jsx("div",{className:"absolute inset-0 bg-yellow-200/70 backdrop-blur-sm flex items-center justify-center rounded sm:rounded-2xl border border-yellow-300 pointer-events-auto",children:e.jsx(d,{size:"sm",variant:"ghost",onClick:()=>g(!0),className:"p-2 bg-yellow-300/80 text-yellow-900 hover:bg-yellow-400/90 rounded-full shadow-sm hover:shadow-md transition-all duration-300",title:"إدخال الرقم السري الرئيسي",children:e.jsx(rt,{className:"h-4 w-4"})})}),e.jsx("div",{className:"flex justify-center pt-0 border-t-0 sm:pt-2 sm:border-t sm:border-purple-200",children:e.jsx(d,{onClick:()=>x(!1),className:"bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-xl text-sm sm:bg-gradient-to-r sm:from-purple-600 sm:to-purple-700 sm:hover:from-purple-700 sm:hover:to-purple-800 sm:px-4 sm:py-1 sm:rounded-xl sm:shadow-lg sm:hover:shadow-xl sm:transition-all sm:duration-300",children:"إغلاق"})})]})}),e.jsx(As,{open:y,onOpenChange:g,onSuccess:Z,description:"لا يمكن الاطلاع على الأرباح الشهرية إلا بإدخال الرقم السري الرئيسي"})]})},yd=l=>e.jsx(bd,{...l});function jd({open:l,onOpenChange:u,onSuccess:o,userId:x}){const[y,g]=a.useState(""),[t,$]=a.useState(""),[D,p]=a.useState(!1),[h,N]=a.useState(!1),[b,E]=a.useState(""),[z,Z]=a.useState(!1),{toast:L}=Qt(),T=Hs.hasProfitPin(x),k=()=>{g(""),$(""),E(""),p(!1),N(!1),u(!1)},K=async U=>{U.preventDefault(),E(""),Z(!0);try{if(T){if(!Hs.verifyProfitPin(y,x)){E("الرقم السري غير صحيح"),Z(!1);return}}else{if(y.length<4){E("يجب أن يكون الرقم السري 4 أرقام على الأقل"),Z(!1);return}if(y!==t){E("الرقم السري غير متطابق"),Z(!1);return}Hs.setProfitPin(y,x)}L({title:"نجح العملية",description:T?"تم التحقق من الرقم السري بنجاح":"تم إنشاء رقم سري الأرباح بنجاح"}),o(),k()}catch{E("حدث خطأ أثناء معالجة الرقم السري")}finally{Z(!1)}};return e.jsx(ie,{open:l,onOpenChange:u,children:e.jsxs(oe,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ce,{children:e.jsxs(de,{className:"flex items-center gap-2 text-lg font-semibold",children:[e.jsx(Ws,{className:"h-5 w-5 text-green-600"}),T?"أدخل رقم سري الأرباح":"إنشاء رقم سري للأرباح"]})}),e.jsxs("form",{onSubmit:K,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-gray-600 bg-blue-50 p-3 rounded-lg",children:T?"أدخل الرقم السري لعرض بيانات الأرباح":"قم بإنشاء رقم سري لحماية بيانات الأرباح. يمكنك تغييره لاحقاً من إعدادات البروفيل."}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"pin",children:T?"الرقم السري":"الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"pin",type:D?"text":"password",value:y,onChange:U=>g(U.target.value),placeholder:T?"أدخل الرقم السري":"أدخل رقم سري جديد (4 أرقام على الأقل)",className:"pr-10",dir:"ltr",autoComplete:"off",required:!0}),e.jsx(d,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>p(!D),children:D?e.jsx(Wt,{className:"h-4 w-4"}):e.jsx(rt,{className:"h-4 w-4"})})]})]}),!T&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"confirmPin",children:"تأكيد الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"confirmPin",type:h?"text":"password",value:t,onChange:U=>$(U.target.value),placeholder:"أعد إدخال الرقم السري",className:"pr-10",dir:"ltr",autoComplete:"off",required:!0}),e.jsx(d,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>N(!h),children:h?e.jsx(Wt,{className:"h-4 w-4"}):e.jsx(rt,{className:"h-4 w-4"})})]})]}),b&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(Es,{className:"h-4 w-4"}),b]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(d,{type:"submit",disabled:z,className:"flex-1 bg-green-600 hover:bg-green-700",children:[e.jsx(Ws,{className:"h-4 w-4 mr-2"}),z?"جاري المعالجة...":T?"عرض الأرباح":"إنشاء وعرض الأرباح"]}),e.jsx(d,{type:"button",variant:"outline",onClick:k,disabled:z,children:"إلغاء"})]})]})]})})}const Nd=({userId:l,transactions:u})=>{const[o,x]=a.useState(!1),[y,g]=a.useState(!1),[t,$]=a.useState(!1),[D,p]=a.useState({dailyWithdrawalProfit:0,dailyTransferProfit:0,lastUpdated:new Date});a.useEffect(()=>{l&&o&&t&&h()},[l,o,t]);const h=async()=>{if(l)try{const z=Hs.getWithdrawTransferProfits(l);p({dailyWithdrawalProfit:z.dailyWithdrawProfit||0,dailyTransferProfit:z.dailyTransferProfit||0,lastUpdated:new Date})}catch(z){console.error("Error loading profit data:",z)}},N=z=>`${z.toFixed(2)} ج.م`,b=()=>{Hs.hasProfitPin(l),g(!0)},E=()=>{$(!0),x(!0),g(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(d,{size:"sm",variant:"ghost",onClick:b,className:"h-2 w-2 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded transition-all duration-300 hover:scale-110 shadow-sm hover:shadow-md",title:"عرض الأرباح اليومية",children:e.jsx(rt,{className:"h-1.5 w-1.5"})}),e.jsx(ie,{open:o,onOpenChange:x,children:e.jsxs(oe,{className:"max-w-[220px] mx-auto bg-white border border-gray-200 shadow-md rounded sm:max-w-[180px] sm:bg-gradient-to-br sm:from-blue-50 sm:to-white sm:border-2 sm:border-blue-200 sm:shadow-2xl sm:rounded-2xl",children:[e.jsx(ce,{className:"text-center pb-0 border-b-0 sm:pb-2 sm:border-b sm:border-blue-200",children:e.jsxs(de,{className:"text-xs font-bold text-blue-800 flex items-center justify-center gap-0 mb-0 leading-tight tracking-tight sm:text-sm sm:gap-1 sm:mb-0 sm:leading-normal sm:tracking-normal",children:[e.jsx(Qe,{className:"h-2 w-2 text-blue-600 sm:h-3 sm:w-3"}),"يومي"]})}),e.jsxs("div",{className:"space-y-0 py-0 sm:space-y-4 sm:py-4",children:[e.jsx("div",{className:"bg-yellow-50 p-2 rounded border border-yellow-200 sm:bg-gradient-to-r sm:from-yellow-50 sm:to-yellow-100 sm:p-4 sm:rounded-xl sm:shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-0 sm:gap-2",children:[e.jsx(Qe,{className:"h-3 w-3 text-yellow-600 sm:h-5 sm:w-5"}),e.jsx("span",{className:"font-medium text-yellow-800 text-xs sm:text-base",children:"أرباح فوري"})]}),e.jsx("span",{className:"font-bold text-sm text-yellow-900 bg-white px-0 py-0.5 rounded text-center sm:text-lg sm:px-3 sm:py-1",children:N((D.dailyWithdrawalProfit??0)+(D.dailyTransferProfit??0))})]})}),e.jsx("div",{className:"bg-red-50 p-2 rounded border border-red-200 sm:bg-gradient-to-r sm:from-red-50 sm:to-red-100 sm:p-4 sm:rounded-xl sm:shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-0 sm:gap-2",children:[e.jsx(lr,{className:"h-3 w-3 text-red-600 sm:h-5 sm:w-5"}),e.jsx("span",{className:"font-medium text-red-800 text-xs sm:text-base",children:"سحب"})]}),e.jsx("span",{className:"font-bold text-sm text-red-900 bg-white px-0 py-0.5 rounded text-center sm:text-lg sm:px-3 sm:py-1",children:N(D.dailyWithdrawalProfit)})]})}),e.jsx("div",{className:"bg-green-50 p-0.5 rounded border border-green-200 sm:bg-gradient-to-r sm:from-green-50 sm:to-green-100 sm:p-2 sm:rounded-xl sm:shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between h-4 sm:h-auto",children:[e.jsxs("div",{className:"flex items-center gap-0 sm:gap-1",children:[e.jsx(ql,{className:"h-2 w-2 text-green-600 sm:h-3 sm:w-3"}),e.jsx("span",{className:"font-medium text-green-800 text-xs leading-tight tracking-tighter sm:font-semibold sm:text-xs sm:leading-normal sm:tracking-normal",children:"تحويل"})]}),e.jsx("span",{className:"font-bold text-xs text-green-900 bg-white px-0 py-0 rounded text-center leading-tight tracking-tighter sm:text-sm sm:px-2 sm:py-0.5 sm:leading-normal sm:tracking-normal",children:N(D.dailyTransferProfit)})]})}),e.jsx("div",{className:"bg-blue-50 p-0.5 rounded border border-blue-200 sm:bg-gradient-to-r sm:from-blue-50 sm:to-blue-100 sm:p-2 sm:rounded-xl sm:shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between h-4 sm:h-auto",children:[e.jsxs("div",{className:"flex items-center gap-0 sm:gap-1",children:[e.jsx(Qe,{className:"h-2 w-2 text-blue-600 sm:h-3 sm:w-3"}),e.jsx("span",{className:"font-medium text-blue-800 text-xs leading-tight tracking-tighter sm:font-semibold sm:text-xs sm:leading-normal sm:tracking-normal",children:"مجموع"})]}),e.jsx("span",{className:"font-bold text-xs text-blue-900 bg-white px-0 py-0 rounded text-center leading-tight tracking-tighter sm:text-sm sm:px-2 sm:py-0.5 sm:leading-normal sm:tracking-normal",children:N(D.dailyWithdrawalProfit+D.dailyTransferProfit)})]})})]}),e.jsx("div",{className:"flex justify-center pt-0 border-t-0 sm:pt-2 sm:border-t sm:border-blue-200",children:e.jsx(d,{onClick:()=>x(!1),className:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-xl text-sm sm:bg-gradient-to-r sm:from-blue-600 sm:to-blue-700 sm:hover:from-blue-700 sm:hover:to-blue-800 sm:px-4 sm:py-1 sm:rounded-xl sm:shadow-lg sm:hover:shadow-xl sm:transition-all sm:duration-300 sm:text-xs",children:"إغلاق"})})]})}),e.jsx(jd,{open:y,onOpenChange:g,onSuccess:E,userId:l})]})},wd=l=>e.jsx(Nd,{...l}),ar=l=>Number(l||0).toFixed(2),Sd=({open:l,onOpenChange:u,userId:o})=>{const{toast:x}=Qt(),[y,g]=He.useState([]),[t,$]=He.useState(!1),[D,p]=He.useState("");He.useEffect(()=>{(async()=>{if(!(!l||!o))try{$(!0);const E=[...await Ll.getByUser(o)].sort((z,Z)=>z.reportDate<Z.reportDate?1:-1);g(E)}catch(b){console.error("Failed to load daily archive history:",b),x({title:"فشل تحميل الأرشيف",description:"تعذر تحميل أرشيف التقارير اليومية",variant:"destructive"})}finally{$(!1)}})()},[l,o]);const h=He.useMemo(()=>{if(!D)return y;const N=D.trim();return y.filter(b=>b.reportDate.includes(N))},[y,D]);return e.jsx(ie,{open:l,onOpenChange:u,children:e.jsxs(oe,{className:"sm:max-w-xl",children:[e.jsxs(ce,{children:[e.jsx(de,{children:"أرشيف التقارير اليومية"}),e.jsx(Rt,{children:"يعرض جميع الأيام المؤرشفة مع ملخص لكل يوم."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"archive-search",children:"بحث بالتاريخ (YYYY-MM-DD)"}),e.jsx(R,{id:"archive-search",placeholder:"مثال: 2025-10-19",value:D,onChange:N=>p(N.target.value)})]}),e.jsx("div",{className:"mt-3 space-y-2 max-h-[50vh] overflow-auto",children:t?e.jsx("div",{className:"text-sm text-muted-foreground",children:"جاري التحميل..."}):h.length===0?e.jsx("div",{className:"text-sm text-muted-foreground",children:"لا توجد تقارير مؤرشفة حتى الآن"}):h.map(N=>e.jsxs("div",{className:"border rounded-md p-2 bg-gradient-to-r from-white/80 to-blue-50/70",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{className:"font-bold text-blue-800",children:N.reportDate}),e.jsxs("div",{className:"text-xs text-blue-700",children:["عدد المعاملات: ",N.totalTransactions]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-1",children:[e.jsxs("div",{className:"text-xs text-blue-800",children:["إجمالي المبالغ: ",e.jsx("span",{className:"font-semibold",children:ar(N.totalAmount)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["المسحوب: ",e.jsx("span",{className:"font-semibold",children:ar(N.totalWithdrawn)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["المرسل: ",e.jsx("span",{className:"font-semibold",children:ar(N.totalSent)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["الربح: ",e.jsx("span",{className:"font-semibold",children:ar(N.profit)})]})]})]},N.id||`${N.userId}-${N.reportDate}`))}),e.jsx(Ce,{children:e.jsx(d,{variant:"outline",onClick:()=>u(!1),children:"إغلاق"})})]})})},Dd=({open:l,onOpenChange:u})=>{var Ms;const{shiftUser:o,isShiftActive:x,shiftStartAt:y,setShiftUser:g,startShift:t,endShift:$}=ya(),{userSubscription:D,user:p,signIn:h,profile:N}=ds(),{toast:b}=Qt(),[E,z]=a.useState((o==null?void 0:o.name)||""),[Z,L]=a.useState((o==null?void 0:o.username)||""),[T,k]=a.useState(""),[K,U]=a.useState(!1),[O,q]=a.useState(null),[ue,se]=a.useState(""),[ve,Y]=a.useState("");a.useState(!1);const[ee,Te]=a.useState(null),[G,re]=a.useState(""),[Fe,nt]=a.useState(""),[ht,Oe]=a.useState(!1),[Tt,$e]=a.useState(!1),[Ze,ct]=a.useState({totalTransfers:0,totalWithdrawals:0}),[Ve,Ee]=a.useState(null),[ft,St]=a.useState(""),[Dt,Xe]=a.useState(""),[bt,yt]=a.useState(0),[Bt,Ut]=a.useState({}),[jt,W]=a.useState(0),[ae,xe]=a.useState(0),[m,I]=a.useState({}),[J,j]=a.useState(""),[M,_]=a.useState(!1),[me,ge]=a.useState(()=>{try{const C=localStorage.getItem("cashierUsers");return C?JSON.parse(C):[]}catch{return[]}}),Be=(Ms=D==null?void 0:D.subscription)==null?void 0:Ms.planType,ke=Be==="yearly"?2:Be==="lifetime"?4:Number.POSITIVE_INFINITY;a.useEffect(()=>{try{localStorage.setItem("cashierUsers",JSON.stringify(me))}catch{}},[me]);const[je,De]=a.useState(!1),[Ue,et]=a.useState(""),[We,_t]=a.useState(null),[Zt,Ft]=a.useState([]),[fs,vs]=a.useState(!1),[ut,Xt]=a.useState(null),[ja,Bs]=a.useState(!1),[Qs,Ls]=a.useState(!1),At=C=>{const he=(o==null?void 0:o.username)===C;let Ae=!1;try{Ae=localStorage.getItem("lastHandoverToAdmin")==="true"}catch{}if(he&&!(he&&!x&&(J==="الأدمن الرئيسي"||Ae))){b({title:"لا يمكن الحذف",description:"لا يمكنك حذف مستخدم الوردية أثناء كونها نشطة أو قبل تسليمها للأدمن الرئيسي"});return}const zt=`هل أنت متأكد من حذف المستخدم ${C}؟

هذا الإجراء لا يمكن التراجع عنه.`;window.confirm(zt)&&(ge(xt=>xt.filter(Ne=>Ne.username!==C)),he&&g(null),b({title:"تم حذف المستخدم",description:C}))},Zs=()=>{if(!E.trim()||!Z.trim()||!T.trim())return;if(me.length>=ke){b({title:"وصلت الحد الأقصى للمستخدمين",description:`هذه الباقة تسمح بإضافة ${Number.isFinite(ke)?ke:"عدد غير محدود"} كاشير فقط`,variant:"destructive"});return}const C={name:E.trim(),username:Z.trim(),password:T.trim()};ge(he=>[C,...he]),z(""),L(""),k("")},cr=()=>{U(!0),q(null),Te(null),re(""),nt("")},Na=async()=>{try{let C=[];try{p!=null&&p.uid&&(C=await Se.getUserTransactions(p.uid))}catch{}if(!C||C.length===0)try{const ne=await _c({merchantUserId:p==null?void 0:p.uid,limit:200});C=(ne==null?void 0:ne.transactions)||[]}catch{}const he=y?new Date(y):null,Ae=new Date,Ye=ne=>{const Ie=ne.type,pt=ne.txnType;return Ie==="withdraw"||Ie==="withdrawal"||Ie==="receive"||pt==="receive"},Lt=ne=>{const Ie=ne.type,pt=ne.txnType;return Ie==="send"||Ie==="transfer"||pt==="send"},zt=ne=>{if(!ne)return null;if(ne instanceof Date)return ne;try{const Ie=new Date(ne);return Number.isNaN(Ie.getTime())?null:Ie}catch{return null}},xt=ne=>{const Ie=zt(ne.createdAt||ne.created_at||ne.timestamp);return!Ie||he&&Ie<he?!1:Ie<=Ae},Ne=ne=>ne==="completed"||ne==="confirmed",$s=C.filter(ne=>Ne(ne.status)&&xt(ne)),te=$s.filter(ne=>Ye(ne)).reduce((ne,Ie)=>{const pt=Ie.withdrawnAmount??Ie.receivedAmount??Ie.amount??0;return ne+(Number(pt)||0)},0);return{totalTransfers:$s.filter(ne=>Lt(ne)).reduce((ne,Ie)=>{const pt=Ie.sentAmount??Ie.transferredAmount??Ie.amount??0;return ne+(Number(pt)||0)},0),totalWithdrawals:te}}catch{return{totalTransfers:0,totalWithdrawals:0}}};a.useEffect(()=>{if(Tt){try{const C=localStorage.getItem("shiftInitialReceivedDrawerFunds");C!==null&&Xe(C)}catch{}try{const C=localStorage.getItem("shiftInitialReceivedWalletBalancesTotal");if(C!==null){const he=parseFloat(C);yt(Number.isFinite(he)?he:0)}}catch{}}},[Tt]),a.useEffect(()=>{if(!l&&!fs)return;(async()=>{try{const Ae=((p!=null&&p.uid?await Se.getUserTransactions(p.uid):[])||[]).filter(Ye=>(Ye==null?void 0:Ye.type)==="report"||((Ye==null?void 0:Ye.title)||"").includes("إيصال تسليم وردية"));Ae.sort((Ye,Lt)=>{const zt=new Date(Ye.createdAt||0).getTime();return new Date(Lt.createdAt||0).getTime()-zt}),Ft(Ae)}catch{Ft([])}})()},[l,Tt,fs,p==null?void 0:p.uid]);const dr=async(C,he,Ae)=>{try{let Ye=0,Lt=0;try{const xt=parseFloat(localStorage.getItem("shiftInitialReceivedDrawerFunds")||"0");Ye=Number.isFinite(xt)?xt:0}catch{}try{const xt=parseFloat(localStorage.getItem("shiftInitialReceivedWalletBalancesTotal")||"0");Lt=Number.isFinite(xt)?xt:0}catch{}const zt={id:`shift_receipt_${Date.now()}`,type:"report",senderPhone:(o==null?void 0:o.username)||"cashier",receiverPhone:J||"admin",amount:0,status:"completed",createdAt:new Date().toISOString(),title:"إيصال تسليم وردية",cashierName:(o==null?void 0:o.name)||(o==null?void 0:o.username)||null,deficit:he,deficitAmount:he?Ae:0,shiftStartAt:y,receivedDrawerFunds:Ye,receivedWalletBalancesTotal:Lt,receivedWalletBalances:Bt,deliveredDrawerFunds:jt||0,deliveredWalletBalancesTotal:ae||0,deliveredWalletBalances:m,shiftProfit:Math.round(((jt||0)+(ae||0)-(Ye+Lt))*100)/100};p!=null&&p.uid&&await Se.saveUserTransaction(p.uid,zt),Ft(xt=>[zt,...xt||[]])}catch{}};return e.jsxs(e.Fragment,{children:[e.jsx(ie,{open:l,onOpenChange:u,children:e.jsxs(oe,{className:"sm:max-w-md",children:[e.jsx(ce,{children:e.jsx(de,{children:x?"تسليم الورديه والخروج":"إضافة مستخدم وردية"})}),x?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsx("div",{className:"text-sm",children:"المستخدم الحالي للوردية:"}),e.jsxs("div",{className:"font-semibold text-sm",children:[o==null?void 0:o.name," (",o==null?void 0:o.username,")"]})]}),e.jsx("div",{className:"text-xs text-gray-600",children:'لإنهاء الوردية والخروج، اضغط "تسليم الورديه والخروج" وسيُطلب الرقم السري.'})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-xs text-gray-600",children:'لاستكمال إضافة مستخدم جديد اضغط الزر أسفل "إضافة مستخدم جديد" لفتح النموذج.'}),me.length>0&&e.jsxs("div",{className:"mt-4 border-t pt-3",children:[e.jsx("div",{className:"text-sm font-medium mb-2",children:"المستخدمون المسجلون"}),e.jsx("div",{className:"space-y-2 max-h-48 overflow-auto",children:me.map((C,he)=>e.jsxs("div",{className:"flex items-center justify-between rounded border px-3 py-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:C.name}),e.jsx("div",{className:"text-xs text-gray-500",children:C.username})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(d,{size:"sm",className:"w-full sm:w-auto",onClick:()=>{_t(C),De(!0)},children:"دخول"}),e.jsx(d,{size:"sm",className:"w-full sm:w-auto",variant:"destructive",onClick:()=>At(C.username),children:"حذف"})]})]},he))})]})]}),e.jsx(Ce,{className:"flex flex-wrap gap-2 justify-between",children:x?e.jsx("div",{className:"flex flex-wrap gap-2",children:e.jsx(d,{className:"w-full sm:w-auto",variant:"destructive",onClick:cr,children:"تسليم الورديه والخروج"})}):e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(d,{className:"w-full sm:w-auto",onClick:()=>Ls(!0),children:"إضافة مستخدم جديد"}),e.jsx(d,{className:"w-full sm:w-auto",variant:"outline",onClick:()=>vs(!0),children:"إيصالات التسليم"})]})})]})}),e.jsx(ie,{open:Qs,onOpenChange:Ls,children:e.jsxs(oe,{className:"sm:max-w-md",children:[e.jsx(ce,{children:e.jsx(de,{children:"إضافة مستخدم جديد"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(V,{className:"mb-1 block",children:"الاسم"}),e.jsx(R,{value:E,onChange:C=>z(C.target.value),placeholder:"أدخل الاسم"})]}),e.jsxs("div",{children:[e.jsx(V,{className:"mb-1 block",children:"اسم المستخدم"}),e.jsx(R,{value:Z,onChange:C=>L(C.target.value),placeholder:"أدخل اسم المستخدم"})]}),e.jsxs("div",{children:[e.jsx(V,{className:"mb-1 block",children:"الرقم السري"}),e.jsx(R,{type:"password",autoComplete:"new-password",value:T,onChange:C=>k(C.target.value),placeholder:"أدخل الرقم السري"})]}),e.jsx("div",{className:"text-xs text-gray-500",children:"المستخدم يمكنه: التحويل، السحب، اختيار المحفظة فقط."})]}),e.jsxs(Ce,{className:"flex gap-2 justify-between",children:[e.jsx(d,{variant:"secondary",onClick:()=>{Ls(!1)},children:"إلغاء"}),e.jsx(d,{onClick:()=>{!E.trim()||!Z.trim()||!T.trim()||(Zs(),Ls(!1))},children:"حفظ المستخدم"})]})]})}),e.jsx(ie,{open:fs,onOpenChange:vs,children:e.jsxs(oe,{className:"sm:max-w-lg",children:[e.jsx(ce,{children:e.jsx(de,{children:"إيصالات التسليم"})}),Zt.length===0?e.jsx("div",{className:"text-xs text-gray-600",children:"لا توجد إيصالات تسليم محفوظة بعد."}):e.jsx("div",{className:"space-y-2 max-h-[60vh] overflow-auto",children:Zt.map(C=>e.jsxs("div",{className:"rounded border px-3 py-2 cursor-pointer hover:bg-gray-50",onClick:()=>{Xt(C),Bs(!0)},children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm font-semibold",children:new Date(C.createdAt).toLocaleString("ar-EG")}),e.jsxs("div",{className:"text-xs text-gray-500",children:["إلى: ",C.receiverPhone]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-1",children:[e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مسلّمة: ",C.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مسلّمة (إجمالي): ",C.deliveredWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مستلمة: ",C.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مستلمة (إجمالي): ",C.receivedWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مسلّمة: ",C.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مسلّمة (إجمالي): ",C.deliveredWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مستلمة: ",C.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مستلمة (إجمالي): ",C.receivedWalletBalancesTotal??0]}),e.jsxs("div",{className:["text-xs",(C.shiftProfit??(C.deliveredDrawerFunds??0)+(C.deliveredWalletBalancesTotal??0)-(C.receivedDrawerFunds??0)-(C.receivedWalletBalancesTotal??0))>=0?"text-green-700":"text-red-700"].join(" "),children:["أرباح الوردية: ",C.shiftProfit??(C.deliveredDrawerFunds??0)+(C.deliveredWalletBalancesTotal??0)-(C.receivedDrawerFunds??0)-(C.receivedWalletBalancesTotal??0)]})]}),C.deficit&&e.jsxs("div",{className:"text-xs text-red-600 mt-1",children:["عجز: ",C.deficitAmount??0]})]},C.id))}),e.jsx(Ce,{className:"flex gap-2 justify-between",children:e.jsx(d,{variant:"secondary",onClick:()=>vs(!1),children:"إغلاق"})})]})}),e.jsx(ie,{open:ja,onOpenChange:Bs,children:e.jsxs(oe,{className:"sm:max-w-md",children:[e.jsx(ce,{children:e.jsx(de,{children:"إيصال تسليم وردية"})}),ut?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsxs("div",{className:"text-sm",children:["التاريخ: ",new Date(ut.createdAt).toLocaleString("ar-EG")]}),e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["تم التسليم إلى: ",ut.receiverPhone]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"المستلم عند الدخول"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية: ",ut.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["أرصدة المحافظ (إجمالي): ",ut.receivedWalletBalancesTotal??0]})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"المسلّم عند الخروج"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية: ",ut.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["أرصدة المحافظ (إجمالي): ",ut.deliveredWalletBalancesTotal??0]})]})]}),ut.deficit&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2 text-red-600",children:"عجز"}),e.jsxs("div",{className:"text-xs text-red-600",children:["المبلغ: ",ut.deficitAmount??0]})]}),ut.receivedWalletBalances&&Object.keys(ut.receivedWalletBalances).length>0&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"تفصيل المحافظ المستلمة"}),e.jsx("div",{className:"space-y-1",children:Object.entries(ut.receivedWalletBalances).map(([C,he])=>e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-gray-600",children:C}),e.jsx("span",{className:"font-semibold",children:he})]},C))})]}),ut.deliveredWalletBalances&&Object.keys(ut.deliveredWalletBalances).length>0&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"تفصيل المحافظ المسلّمة"}),e.jsx("div",{className:"space-y-1",children:Object.entries(ut.deliveredWalletBalances).map(([C,he])=>e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-gray-600",children:C}),e.jsx("span",{className:"font-semibold",children:he})]},C))})]})]}):e.jsx("div",{className:"text-xs text-gray-600",children:"لا يوجد تقرير محدد للعرض."}),e.jsx(Ce,{className:"flex gap-2 justify-between",children:e.jsx(d,{variant:"secondary",onClick:()=>Bs(!1),children:"إغلاق"})})]})}),e.jsx(ie,{open:je,onOpenChange:De,children:e.jsxs(oe,{className:"sm:max-w-md",children:[e.jsx(ce,{children:e.jsx(de,{children:"أدخل الرقم السري للدخول"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm",children:We?`${We.name} (${We.username})`:""}),e.jsx(R,{type:"password",autoComplete:"off",value:Ue,onChange:C=>et(C.target.value),placeholder:"أدخل الرقم السري"})]}),e.jsxs(Ce,{className:"flex gap-2 justify-between",children:[e.jsx(d,{variant:"secondary",onClick:()=>{et(""),_t(null),De(!1)},children:"إلغاء"}),e.jsx(d,{onClick:()=>{if(We){if(Ue.trim()!==We.password){b({title:"خطأ في الرقم السري",description:"الرقم السري للكاشير غير صحيح",variant:"destructive"});return}g({name:We.name,username:We.username}),et(""),De(!1),u(!1),t(),_(!0)}},children:"دخول الورديه"})]})]})}),e.jsx(ie,{open:M,onOpenChange:_,children:e.jsxs(oe,{className:"sm:max-w-md",children:[e.jsx(ce,{children:e.jsx(de,{children:"تسجيل أرصدة البداية والنقدية"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(V,{className:"mb-1 block",children:"الفلوس النقدية المستلمة عند الدخول"}),e.jsx(R,{type:"number",value:Dt,onChange:C=>Xe(C.target.value),placeholder:"أدخل قيمة النقدية في الدرج عند بداية الورديه"})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(V,{className:"mb-1 block",children:"أرصدة المحافظ المستلمة (إجمالي) عند الدخول"}),e.jsx(R,{type:"number",value:Number.isFinite(bt)?bt:0,onChange:C=>{const he=parseFloat(C.target.value);yt(Number.isFinite(he)?he:0)},placeholder:"أدخل إجمالي أرصدة المحافظ عند بداية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"يمكن إضافة التفصيل لاحقاً إن لزم، المهم تسجيل الإجمالي."})]})]}),e.jsx(Ce,{className:"flex gap-2 justify-between",children:e.jsx(d,{onClick:()=>{const C=parseFloat(Dt),he=bt,Ae=Number.isFinite(C)&&C>=0,Ye=Number.isFinite(he)&&he>=0;if(!Ae||!Ye){b({title:"يرجى إدخال قيم صحيحة",description:"أدخل قيمًا رقمية غير سالبة للنقدية ولإجمالي أرصدة المحافظ",variant:"destructive"});return}try{localStorage.setItem("shiftInitialReceivedDrawerFunds",String(C)),localStorage.setItem("shiftInitialReceivedWalletBalancesTotal",String(he))}catch{}b({title:"تم تسجيل أرصدة البداية",description:"سُجّل إجمالي النقدية وأرصدة المحافظ لبداية الورديه"}),_(!1)},children:"تأكيد وحفظ"})})]})}),e.jsx(ie,{open:K,onOpenChange:C=>{C&&U(!0)},children:e.jsxs(oe,{className:"sm:max-w-md",hideClose:!0,disableOutsideClose:!0,disableEscClose:!0,children:[e.jsx(ce,{children:e.jsx(de,{children:"تسليم الورديه والخروج"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(d,{variant:O==="toUser"?"default":"secondary",onClick:()=>q("toUser"),children:"تسليم إلى مستخدم آخر"}),e.jsx(d,{variant:O==="toAdmin"?"default":"secondary",onClick:()=>q("toAdmin"),children:"تسليم إلى الأدمن الرئيسي"})]}),O==="toUser"&&e.jsxs("div",{className:"space-y-3",children:[me.length===0?e.jsx("div",{className:"text-sm text-gray-600",children:"لا يوجد مستخدمون مسجلون. قم بإضافة مستخدم أولاً."}):e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"اختر المستخدم الذي سيتسلم الورديه"}),e.jsx("div",{className:"space-y-2 max-h-40 overflow-auto",children:me.map((C,he)=>e.jsxs("div",{className:`flex items-center justify-between rounded border px-3 py-2 cursor-pointer ${(ee==null?void 0:ee.username)===C.username?"bg-indigo-50 border-indigo-200":""}`,onClick:()=>Te(C),children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:C.name}),e.jsx("div",{className:"text-xs text-gray-500",children:C.username})]}),e.jsx("span",{className:"text-xs text-gray-400",children:"اختيار"})]},he))})]}),e.jsxs("div",{children:[e.jsx(V,{className:"mb-1 block",children:"كلمة سر المستخدم المحدد"}),e.jsx(R,{type:"password",autoComplete:"off",value:G,onChange:C=>re(C.target.value),placeholder:"أدخل كلمة السر"})]}),Fe&&e.jsx("div",{className:"text-xs text-red-600",children:Fe})]}),O==="toAdmin"&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm text-gray-600",children:"أدخل كلمة مرور الحساب الرئيسي لتسليم الورديه والخروج إلى الأدمن."}),e.jsx(R,{type:"password",autoComplete:"off",value:ue,onChange:C=>se(C.target.value),placeholder:"كلمة المرور"}),ve&&e.jsx("div",{className:"text-xs text-red-600",children:ve})]})]}),e.jsx(Ce,{className:"flex gap-2 justify-between",children:e.jsx(d,{disabled:ht||!O,onClick:async()=>{if(O){Oe(!0);try{const C=await Na();if(O==="toUser"){if(!ee){nt("يرجى اختيار المستخدم أولاً"),Oe(!1);return}if(G.trim()!==ee.password){nt("كلمة السر غير صحيحة"),Oe(!1);return}$(),g({name:ee.name,username:ee.username}),t(),j(`${ee.name} (${ee.username})`);try{localStorage.setItem("lastHandoverToAdmin","false")}catch{}U(!1),q(null),Te(null),re(""),nt(""),u(!1),ct(C),Ee(null),St(""),$e(!0)}else if(O==="toAdmin"){Y("");const he=(p==null?void 0:p.email)||"";if(!he){Y("لا يوجد بريد للمستخدم الرئيسي للتحقق"),Oe(!1);return}const{error:Ae}=await h(he,ue);if(Ae){Y("كلمة المرور غير صحيحة"),Oe(!1);return}$(),g(null);try{localStorage.setItem("lastHandoverToAdmin","true")}catch{}se(""),U(!1),u(!1),j("الأدمن الرئيسي"),ct(C),Ee(null),St(""),$e(!0)}}catch{nt("حدث خطأ أثناء التسليم، حاول مرة أخرى")}finally{Oe(!1)}}},children:"تأكيد التسليم"})})]})}),e.jsx(ie,{open:Tt,onOpenChange:$e,children:e.jsxs(oe,{className:"sm:max-w-lg",hideClose:!0,disableOutsideClose:!0,disableEscClose:!0,children:[e.jsx(ce,{children:e.jsx(de,{children:"تقرير تسليم الورديه والخروج"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsxs("div",{className:"text-sm",children:["تم تسليم الورديه إلى: ",e.jsx("span",{className:"font-semibold",children:J})]}),y&&e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["بداية الورديه: ",new Date(y).toLocaleString("ar-EG")]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نهاية الورديه: ",new Date().toLocaleString("ar-EG")]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(V,{className:"mb-1 block",children:"الفلوس النقدية المستلمة"}),e.jsx(R,{type:"number",value:Dt,readOnly:!0,disabled:!0,placeholder:"قيمة مسجلة عند بداية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"قيمة غير قابلة للتعديل؛ تُسجّل عند الدخول."})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(V,{className:"mb-1 block",children:"أرصدة المحافظ المستلمة (إجمالي)"}),e.jsx(R,{type:"number",value:bt,readOnly:!0,disabled:!0,placeholder:"إجمالي مسجل عند بداية الورديه"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(V,{className:"mb-1 block",children:"الفلوس النقدية المسلمة"}),e.jsx(R,{type:"number",value:jt,onChange:C=>{const he=parseFloat(C.target.value);W(Number.isFinite(he)?he:0)},placeholder:"أدخل قيمة النقدية المسلمة عند نهاية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"ادخال يدوي لقيمة النقدية المسلّمة عند نهاية الورديه"})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(V,{className:"mb-1 block",children:"أرصدة المحافظ المسلمة (إجمالي)"}),e.jsx(R,{type:"number",value:ae,onChange:C=>{const he=parseFloat(C.target.value);xe(Number.isFinite(he)?he:0)},placeholder:"أدخل إجمالي أرصدة المحافظ المسلّمة"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"يمكنك إدخال الإجمالي يدوياً؛ التفصيل يُحفظ إن لزم"})]})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-1",children:"أرباح الوردية"}),e.jsx("div",{className:["text-sm",(jt??0)+(ae??0)-((parseFloat(Dt||"0")||0)+(bt??0))>=0?"text-green-700":"text-red-700"].join(" "),children:Math.round(((jt??0)+(ae??0)-((parseFloat(Dt||"0")||0)+(bt??0)))*100)/100}),e.jsx("div",{className:"text-xs text-gray-600",children:"محسوبة: (المسلّم − المستلم) للنقدية + المحافظ"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"هل يوجد عجز؟"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(d,{variant:Ve==="no"?"default":"secondary",onClick:()=>Ee("no"),children:"لا"}),e.jsx(d,{variant:Ve==="yes"?"default":"secondary",onClick:()=>Ee("yes"),children:"نعم"})]}),Ve==="yes"&&e.jsxs("div",{children:[e.jsx(V,{className:"mb-1 block",children:"مبلغ العجز"}),e.jsx(R,{type:"number",value:ft,onChange:C=>St(C.target.value),placeholder:"أدخل مبلغ العجز"})]})]})]}),e.jsx(Ce,{className:"flex gap-2 justify-between",children:e.jsx(d,{onClick:()=>{const C=Ve==="yes",he=parseFloat(ft)||0;(async()=>await dr(Ze,C,he))(),b({title:"تم إضافة إيصال تسليم الورديه",description:"أُضيف الإيصال إلى المعاملات الأخيرة بعنوان إيصال تسليم وردية"}),$e(!1)},children:"تأكيد وحفظ الإيصال"})})]})})]})},Cd=({open:l,onOpenChange:u})=>{const{shiftUser:o,endShift:x,setShiftUser:y}=ya(),[g,t]=a.useState(""),[$,D]=a.useState(""),[p,h]=a.useState([]);a.useEffect(()=>{try{const b=localStorage.getItem("cashierUsers");h(b?JSON.parse(b):[])}catch{h([])}},[l]);const N=async()=>{if(D(""),!o)return;const b=p.find(E=>E.username===o.username);if(!b){D("لا يوجد مستخدم مطابق لهذه الوردية");return}if(g.trim()!==b.password){D("الرقم السري غير صحيح");return}x(),y(null),t(""),u(!1)};return e.jsx(ie,{open:l,onOpenChange:b=>{t(""),D(""),u(b)},children:e.jsxs(oe,{className:"sm:max-w-md",children:[e.jsx(ce,{children:e.jsx(de,{children:"بروفيل الوردية"})}),o?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"rounded-lg border p-3 bg-gradient-to-r from-blue-50 to-indigo-50",children:[e.jsx("div",{className:"text-sm font-semibold text-gray-800",children:o.name}),e.jsx("div",{className:"text-xs text-gray-600",children:o.username})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{className:"block",children:"أدخل الرقم السري لتسليم الوردية"}),e.jsx(R,{type:"password",value:g,onChange:b=>t(b.target.value),placeholder:"الرقم السري للمستخدم",dir:"ltr"}),$&&e.jsx("div",{className:"text-red-600 text-xs",children:$})]})]}):e.jsx("div",{className:"text-sm text-gray-600",children:"لا يوجد مستخدم وردية نشط حالياً"}),e.jsxs(Ce,{className:"flex justify-between",children:[e.jsx(d,{variant:"outline",onClick:()=>u(!1),children:"إغلاق"}),e.jsx(d,{onClick:N,disabled:!o,children:"تسليم الوردية"})]})]})})};class qs{static async processTransfer(u){const{amount:o,currentCashBalance:x,currentWalletBalances:y,wallets:g,selectedWalletId:t}=u;if(o<=0)return{success:!1,newCashBalance:x,newWalletBalances:y,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(t&&!u.skipRemoteLimitsCheck)try{const h=await os.canPerformOperation(t,o,"transfer");if(!h.canPerform)return{success:!1,newCashBalance:x,newWalletBalances:y,message:h.message||"تجاوز حد التحويل المسموح",error:"LIMIT_EXCEEDED"}}catch(h){return console.error("خطأ في التحقق من حدود التحويل:",h),{success:!1,newCashBalance:x,newWalletBalances:y,message:"خطأ في التحقق من حدود التحويل",error:"LIMIT_CHECK_ERROR"}}if(o<=0)return{success:!1,newCashBalance:x,newWalletBalances:y,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(t){const h=Math.max(y[t]||0,0);if(h<o){const N=g.find(b=>b.id===t);return{success:!1,newCashBalance:x,newWalletBalances:y,message:`رصيد غير كافي في المحفظة${N?` ${N.name}`:""}. المتاح: ${h} جنيه، المطلوب: ${o} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"}}}else{const h=qs.calculateTotalWalletBalance(y);if(h<o)return{success:!1,newCashBalance:x,newWalletBalances:y,message:`رصيد غير كافي في المحافظ. الرصيد المتاح: ${h} جنيه، المبلغ المطلوب: ${o} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"}}const $={...y};if(t){const h=$[t]||0;$[t]=h-o}else{let h=o;for(const N of g){if(h<=0)break;const b=Math.max($[N.id]||0,0),E=Math.min(b,h);E>0&&($[N.id]=($[N.id]||0)-E,h-=E)}}const D=x+o;if(t)try{const h=os.updateUsage(t,o,"transfer");u.nonBlockingUsageUpdate?h.catch(N=>console.error("خطأ في تحديث استخدام المحفظة:",N)):await h}catch(h){console.error("خطأ في تحديث استخدام المحفظة:",h)}let p="تم التحويل بنجاح";if(t){const h=$[t]||0;h<0&&(p=`تم التحويل بنجاح مع تحذير: رصيد محفظة ${t} أصبح ${h} جنيه.`)}return{success:!0,newCashBalance:D,newWalletBalances:$,message:p}}static processDeposit(u){const{amount:o,currentCashBalance:x,currentWalletBalances:y,wallets:g}=u;if(o<=0)return{success:!1,newCashBalance:x,newWalletBalances:y,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};const t=this.calculateTotalWalletBalance(y);if(t<o)return{success:!1,newCashBalance:x,newWalletBalances:y,message:`رصيد غير كافي في المحافظ. الرصيد المتاح: ${t} جنيه، المبلغ المطلوب: ${o} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"};const $=x+o,D={...y};let p=o;const h=g.find(b=>b.isDefault);if(h&&D[h.id]>=p)D[h.id]-=p,p=0;else for(const b of g){if(p<=0)break;const E=D[b.id]||0;if(E>0){const z=Math.min(E,p);D[b.id]=E-z,p-=z}}const N=p>0?`تم الإيداع جزئياً. تم إيداع ${o-p} جنيه في صندوق النقدية`:`تم الإيداع بنجاح. تم إضافة ${o} جنيه إلى صندوق النقدية`;return{success:!0,newCashBalance:$,newWalletBalances:D,message:N}}static async processWithdraw(u){const{amount:o,currentCashBalance:x,currentWalletBalances:y,wallets:g,selectedWalletId:t}=u;if(o<=0)return{success:!1,newCashBalance:x,newWalletBalances:y,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(t&&!u.skipRemoteLimitsCheck)try{const h=await os.canPerformOperation(t,o,"withdraw");if(!h.canPerform)return{success:!1,newCashBalance:x,newWalletBalances:y,message:h.reason||"تم تجاوز الحد المسموح للسحب",error:"LIMIT_EXCEEDED"}}catch(h){return console.error("خطأ في التحقق من حدود السحب:",h),{success:!1,newCashBalance:x,newWalletBalances:y,message:"خطأ في التحقق من حدود السحب",error:"LIMIT_CHECK_ERROR"}}if(x<o)return{success:!1,newCashBalance:x,newWalletBalances:y,message:`رصيد غير كافي في صندوق النقدية. الرصيد المتاح: ${x} جنيه، المبلغ المطلوب: ${o} جنيه`,error:"INSUFFICIENT_CASH_BALANCE"};const $=x-o,D={...y},p=t?g.find(h=>h.id===t):g.find(h=>h.isDefault)||g[0];if(p){const h=D[p.id]||0;D[p.id]=h+o}else return{success:!1,newCashBalance:x,newWalletBalances:y,message:"لا توجد محافظ متاحة لإضافة المبلغ إليها",error:"NO_WALLETS_AVAILABLE"};if(t)try{const h=os.updateUsage(t,o,"withdraw");u.nonBlockingUsageUpdate?h.catch(N=>console.error("خطأ في تحديث استخدام المحفظة:",N)):await h}catch(h){console.error("خطأ في تحديث استخدام المحفظة:",h)}return{success:!0,newCashBalance:$,newWalletBalances:D,message:`تم السحب بنجاح. تم إضافة ${o} جنيه إلى محفظة ${(p==null?void 0:p.name)||""}`}}static validateOperation(u,o){return u<=0?{valid:!1,error:"المبلغ يجب أن يكون أكبر من الصفر"}:!o||o.length===0?{valid:!1,error:"لا توجد محافظ متاحة"}:{valid:!0}}static calculateTotalWalletBalance(u){return Object.values(u).reduce((o,x)=>o+Math.max(x,0),0)}static deductFromWalletsAddToCash(u,o,x,y){return this.processTransfer({amount:u,currentCashBalance:o,currentWalletBalances:x,wallets:y})}static deductFromWalletsAddToCashDeposit(u,o,x,y){return this.processDeposit({amount:u,currentCashBalance:o,currentWalletBalances:x,wallets:y})}static deductFromCashAddToWallets(u,o,x,y){return this.processWithdraw({amount:u,currentCashBalance:o,currentWalletBalances:x,wallets:y})}static applyTransactionResult(u,o,x){u.success&&(o(u.newCashBalance),x(u.newWalletBalances))}static validateTransaction(u,o,x,y){if(u<=0)return{isValid:!1,error:"المبلغ يجب أن يكون أكبر من الصفر"};if(o==="transfer"){const g=this.calculateTotalWalletBalance(y);if(g<u)return{isValid:!1,error:`الرصيد المتاح في المحافظ (${g} جنيه) غير كافي للمبلغ المطلوب (${u} جنيه)`}}else if(o==="withdraw"){if(x<u)return{isValid:!1,error:`الرصيد المتاح في صندوق النقدية (${x} جنيه) غير كافي للمبلغ المطلوب (${u} جنيه)`}}else if(o==="deposit"){const g=this.calculateTotalWalletBalance(y);if(g<u)return{isValid:!1,error:`الرصيد المتاح في المحافظ (${g} جنيه) غير كافي للمبلغ المطلوب (${u} جنيه)`}}return{isValid:!0}}static getDeductionPreview(u,o,x){const y=[];let g=u;for(const t of x){if(g<=0)break;const $=o[t.id]||0,D=Math.min(Math.max($,0),g);D>0&&(y.push({walletId:t.id,walletName:t.name,currentBalance:$,deductedAmount:D,newBalance:$-D}),g-=D)}return y}}let pa=null;function Id(){const l=window;if(!pa){const u=l.AudioContext||l.webkitAudioContext;pa=new u}return pa.state==="suspended"&&pa.resume(),pa}function kd(l,u,o){const x=o/1e3,y=Math.floor(l.sampleRate*x),g=l.createBuffer(1,y,l.sampleRate),t=g.getChannelData(0);for(let h=0;h<y;h++)t[h]=(Math.random()*2-1)*.6;const $=l.createBufferSource();$.buffer=g;const D=l.createBiquadFilter();D.type="highpass",D.frequency.value=1500,D.Q.value=.7;const p=l.createGain();p.gain.setValueAtTime(1e-4,u),p.gain.exponentialRampToValueAtTime(.4,u+.015),p.gain.exponentialRampToValueAtTime(1e-4,u+x),$.connect(D),D.connect(p),p.connect(l.destination),$.start(u),$.stop(u+x+.01)}function Td(l,u,o,x,y,g="triangle"){const t=l.createOscillator(),$=l.createGain();t.type=g;const D=y/1e3;t.frequency.setValueAtTime(o,u),t.frequency.linearRampToValueAtTime(x,u+D),$.gain.setValueAtTime(1e-4,u),$.gain.exponentialRampToValueAtTime(.25,u+.02),$.gain.exponentialRampToValueAtTime(1e-4,u+D),t.connect($),$.connect(l.destination),t.start(u),t.stop(u+D+.02)}function Ad(){try{const l=Id(),u=l.currentTime;kd(l,u,90),Td(l,u+.12,1900,1100,180,"sawtooth")}catch{}}function Pd(l){if(!l)return!1;const o=l.replace(/[^0-9٠-٩]/g,"").replace(/[٠-٩]/g,x=>"0123456789"["٠١٢٣٤٥٦٧٨٩".indexOf(x)]);return/^(010|011|012|015)[0-9]{8}$/.test(o)}const Tm=()=>{var yl,jl,Nl,wl;console.log("🔥 UserDashboardPage component is loading...");const{toast:l}=Qt(),u=a.useRef(null),[o,x]=a.useState(0),y=async()=>{var n,i,c;const s="alkaptin678678@gmail.com",r=(i=(n=rn.currentUser)==null?void 0:n.email)==null?void 0:i.toLowerCase();if(!r||r!==s){l({title:"قيد التطوير",description:"هذه الميزة غير متاحة حالياً."});return}if(!$a||!Ra||!Ua){l({title:"بيانات ناقصة",description:"أدخل رقم الموبايل، الشركة والمبلغ",variant:"destructive"});return}try{Zn(!0);const f=await((c=rn.currentUser)==null?void 0:c.getIdToken()),v=await fetch("/api/topup",{method:"POST",headers:{"Content-Type":"application/json",...f?{Authorization:`Bearer ${f}`}:{}},body:JSON.stringify({phone:$a,countryCode:"EG",operator:Ra,amount:Number(Ua),useLocalAmount:!0})}),w=await v.json().catch(()=>({}));v.ok&&(w!=null&&w.success)?(l({title:"تم الشحن",description:(w==null?void 0:w.message)||"تم تنفيذ عملية الشحن بنجاح"}),Rr(!1),Yn(""),Hn(""),Gn("")):l({title:"فشل الشحن",description:(w==null?void 0:w.message)||"حدث خطأ أثناء طلب الشحن",variant:"destructive"})}catch(f){console.error("Topup request error:",f),l({title:"خطأ غير متوقع",description:"تعذّر تنفيذ عملية الشحن. حاول لاحقاً.",variant:"destructive"})}finally{Zn(!1)}},{signOut:g,user:t,profile:$}=ds(),D=((t==null?void 0:t.email)||"").toLowerCase()==="vodafonecash00@gmail.com",p=ec(),h=Wl(),{isShiftActive:N,shiftUser:b}=ya(),{shopName:E}=tc(),z=sc(),[Z,L]=a.useState(!1),[T,k]=a.useState(!1);console.log("🔥 UserDashboardPage - user:",t?"exists":"null");const[K,U]=a.useState(!0),[O,q]=a.useState(!0),[ue,se]=a.useState(!1),[ve,Y]=a.useState(!1),[ee,Te]=a.useState(""),[G,re]=a.useState(""),[Fe,nt]=a.useState(""),[ht,Oe]=a.useState([]),[Tt,$e]=a.useState(!1),[Ze,ct]=a.useState(null),[Ve,Ee]=a.useState("");a.useState(!1);const[ft,St]=a.useState(!1),[Dt,Xe]=a.useState(!1),[bt,yt]=a.useState(!1),[Bt,Ut]=a.useState(""),[jt,W]=a.useState(""),[ae,xe]=a.useState([]),[m,I]=a.useState(!1),[J,j]=a.useState(0),[M,_]=a.useState(!1),[me,ge]=a.useState(null),[Be,ke]=a.useState(!1),[je,De]=a.useState(""),[Ue,et]=a.useState(""),[We,_t]=a.useState(""),[Zt,Ft]=a.useState(!1),[fs,vs]=a.useState(""),[ut,Xt]=a.useState(""),[ja,Bs]=a.useState(""),[Qs,Ls]=a.useState(""),[At,Zs]=a.useState(null),[cr,Na]=a.useState(!1),[dr,Ms]=a.useState(!1),[C,he]=a.useState(""),[Ae,Ye]=a.useState(""),[Lt,zt]=a.useState(""),xt=s=>{const r="٠١٢٣٤٥٦٧٨٩",n="۰۱۲۳۴۵۶۷۸۹";return(s||"").split("").map(i=>{const c=r.indexOf(i);if(c>-1)return String(c);const f=n.indexOf(i);return f>-1?String(f):i}).join("")},[Ne,$s]=a.useState(()=>{try{const s=localStorage.getItem("commissionMode")||localStorage.getItem("commissionMode_default");return s?s==="add":!0}catch{return!0}}),[te,mr]=a.useState("transfer"),[ne,Ie]=a.useState([]),[pt,hr]=a.useState("all");a.useEffect(()=>{try{if(localStorage.setItem("commissionMode",Ne?"add":"deduct"),t!=null&&t.uid){const s=`commissionMode_${t.uid}`;localStorage.setItem(s,Ne?"add":"deduct")}}catch{}},[Ne,t==null?void 0:t.uid]),a.useEffect(()=>{try{const s=t!=null&&t.uid?localStorage.getItem(`commissionMode_${t.uid}`):null,r=localStorage.getItem("commissionMode"),n=localStorage.getItem("commissionMode_default"),i=s??r??n;i&&$s(i==="add")}catch{}},[t==null?void 0:t.uid]);const[ur,Xs]=a.useState(!1),[bi,yi]=a.useState(null),wa=He.useRef(""),jn=He.useRef(0);a.useEffect(()=>{const s=r=>{if(ur)return;const n=Date.now();if(r.key==="Enter"){const i=(wa.current||"").trim();wa.current="",i&&(yi(i),Xs(!0));return}r.key.length===1&&(n-(jn.current||0)>100&&(wa.current=""),wa.current+=r.key,jn.current=n)};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[ur]);const[ji,Ni]=a.useState(!1),[wi,Od]=a.useState(null),[X,ea]=a.useState("");a.useEffect(()=>{if(!Zt)return;const s=hs(),r=parseFloat(We||"0")||0;let n=0;if(te==="transfer"){if((s==null?void 0:s.defaultTransferCommission)!=null){const c=Number(s.defaultTransferCommission)||0;n=Math.round(c*r/1e3*100)/100}else{const c=Ae&&Ae.trim()!==""?parseFloat(Ae):0;n=Math.max(0,c)}const i=r+n;Xt((i||0).toString())}else{if((s==null?void 0:s.defaultWithdrawCommission)!=null){const c=Number(s.defaultWithdrawCommission)||0;n=Math.round(c*r/1e3*100)/100}else{const c=C&&C.trim()!==""?parseFloat(C):Math.round(r*.01*100)/100;n=Math.max(0,c)}const i=Ne?r:Math.max(0,Math.round((r-n)*100)/100);Xt((i||0).toString())}},[Zt,We,Ae,C,X,Ne,te]);const hs=()=>{var r,n;let s=ye.find(i=>i.id===X);if(!s)try{const i=localStorage.getItem(_s());if(i){const c=JSON.parse(i);if(Array.isArray(c)&&c.length>0){const v=localStorage.getItem(`selectedWallet_${(t==null?void 0:t.uid)||"default"}`)||((r=c.find(w=>w.isDefault))==null?void 0:r.id)||((n=c[0])==null?void 0:n.id);s=c.find(w=>w.id===v)}}}catch{}return s};a.useLayoutEffect(()=>{try{const s=`wallets_${(t==null?void 0:t.uid)||"default"}`;let r=localStorage.getItem(s);if(!r){const n=Object.keys(localStorage).find(i=>i.startsWith("wallets_"));n&&(r=localStorage.getItem(n)||null)}if(r){const n=JSON.parse(r);if(Array.isArray(n)&&n.length>0){es(n);const i=`selectedWallet_${(t==null?void 0:t.uid)||"default"}`,c=localStorage.getItem(i),f=c&&n.find(v=>v.id===c)||n.find(v=>v.isDefault)||n[0];f&&(ea(f.id),De(f.phone))}}}catch(s){console.error("تهيئة فورية للمحافظ من التخزين المحلي فشلت:",s)}},[]),a.useEffect(()=>{console.log("🔍 selectedWallet state changed to:",X)},[X]),a.useEffect(()=>{xo()},[]),a.useEffect(()=>{go()},[]);const[ye,es]=a.useState(()=>{try{const s=Object.keys(localStorage).find(n=>n.startsWith("wallets_")),r=s?localStorage.getItem(s):null;if(r){const n=JSON.parse(r);if(Array.isArray(n))return n}}catch{}return[]}),[Nn,Si]=a.useState(""),wn=(()=>{const s=Nn.replace(/\D/g,"");return s?ye.filter(r=>(r.phone||"").replace(/\D/g,"").includes(s)):ye})(),[Di,Wd]=a.useState(null),[Ci,Sn]=a.useState(!1),[Ii,Sa]=a.useState(!1),[ki,Ti]=a.useState(null);a.useState([]),a.useState([]);const[Ai,ta]=a.useState(!1),[xr,Dn]=a.useState("daily"),[Pi,Cn]=a.useState(!1),[Oi,pr]=a.useState(!1),[In,bs]=a.useState([]),Wi=async s=>{try{const r=ne.find(i=>i.id===s);if(!r||!t)return;const n=ne.filter(i=>i.id!==s);Ie(n);try{await Se.removeUserTransaction(t.uid,s),await Xa.permanentlyDeleteTransaction(s,t.uid)}catch(i){console.warn("تعذر الحذف النهائي من قواعد البيانات أثناء حذف الإيصال:",i)}try{const i=st(),c=tt(),f=localStorage.getItem(i),v=localStorage.getItem(c);let w=f?parseFloat(f):ze,B=v?JSON.parse(v):{...be};const A=r.amount||r.transferredAmount||r.withdrawnAmount||r.withdrawnAmountDetailed||0;if(r.type==="send"&&(r.fromWallet||X)){w-=r.commission||0;const Q=r.fromWallet||X;B[Q]=(B[Q]||0)+A}else if(r.type==="withdraw"&&(r.fromWallet||X)){w+=A,w-=r.commission||0;const Q=r.fromWallet||X;B[Q]=Math.max(0,(B[Q]||0)-A)}lt(w),Je(B),localStorage.setItem(i,w.toString()),localStorage.setItem(c,JSON.stringify(B));const S={cashBalance:w,walletBalances:B,lastUpdated:new Date().toISOString()},F=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(F,JSON.stringify(S)),t!=null&&t.uid?Se.updateUserData(t.uid,S).then(()=>{localStorage.removeItem(F),fe(!1)}).catch(Q=>{console.warn("تعذر حفظ الأرصدة في Firebase بعد الحذف، تم الاحتفاظ محليًا:",Q),fe(!0)}):fe(!0)}catch(i){console.warn("تعذر عكس تأثير الأرصدة بعد الحذف:",i)}try{const i=r.fromWallet||X,c=await os.getWalletLimits(t.uid,i);if(c){const f=r.amount||r.transferredAmount||r.withdrawnAmount||r.withdrawnAmountDetailed||0,v={...c};r.type==="send"?(v.dailyTransferUsed=Math.max(0,(c.dailyTransferUsed||0)-f),v.monthlyTransferUsed=Math.max(0,(c.monthlyTransferUsed||0)-f)):(v.dailyWithdrawUsed=Math.max(0,(c.dailyWithdrawUsed||0)-f),v.monthlyWithdrawUsed=Math.max(0,(c.monthlyWithdrawUsed||0)-f)),await os.updateWalletLimits(t.uid,i,v)}}catch(i){console.warn("تعذر تحديث حدود المحفظة بعد الحذف:",i)}try{qt.removeTransactionEffects(r,t.uid)}catch(i){console.warn("تعذر تحديث التقارير بعد الحذف:",i)}l({title:"تم الحذف نهائيًا",description:"تم حذف الإيصال نهائيًا وعكس تأثيراته على الأرصدة والحدود والتقارير."}),Sa(!1)}catch(r){console.error("خطأ أثناء حذف الإيصال:",r),l({title:"خطأ في حذف الإيصال",description:"حدث خطأ غير متوقع أثناء الحذف.",variant:"destructive"})}},Fi=async s=>{try{if(!ne.find(n=>n.id===s)||!t)return;await Ys(Yt(ot,"userTransactions",s),{status:"completed",confirmedAt:new Date}),Ie(n=>n.map(i=>i.id===s?{...i,status:"completed"}:i)),l({title:"تم الإكمال",description:"تم وسم المعاملة كمكتملة."}),Sa(!1)}catch(r){console.error("خطأ أثناء إكمال الإيصال:",r),l({title:"فشل الإكمال",description:"حدث خطأ غير متوقع أثناء تحديث الحالة.",variant:"destructive"})}},[kn,Ei]=a.useState(""),Tn=vd(kn,300),[Da,An]=a.useState(""),[Ca,Pn]=a.useState(""),[us,Fd]=a.useState(""),[gr,Rs]=a.useState(!1),[On,sa]=a.useState(!1),[Bi,Ia]=a.useState(!1),[Nt,fr]=a.useState(null),[Li,vr]=a.useState(!1),[Mi,ka]=a.useState(!1),[$i,Ta]=a.useState(!1),[Ri,Aa]=a.useState(!1),[Ui,Wn]=a.useState(!0),[aa,_i]=a.useState(!1),[zi,Pa]=a.useState(!1),[Ji,Fn]=a.useState(()=>{try{const s=t!=null&&t.uid?`dailyReportsLockEnabled_${t==null?void 0:t.uid}`:"dailyReportsLockEnabled";return(localStorage.getItem(s)??localStorage.getItem("dailyReportsLockEnabled"))==="true"}catch{return!1}}),[Ki,br]=a.useState(!1);a.useEffect(()=>{try{const s=t!=null&&t.uid?`dailyReportsLockEnabled_${t==null?void 0:t.uid}`:"dailyReportsLockEnabled",r=localStorage.getItem(s)??localStorage.getItem("dailyReportsLockEnabled");Fn(r==="true")}catch{}},[t==null?void 0:t.uid]);const[qi,Oa]=a.useState(!1),[Vi,ra]=a.useState(!1),[wt,Mt]=a.useState([]),[yr,En]=a.useState(""),[jr,Bn]=a.useState(""),[Nr,Ln]=a.useState(""),[pe,wr]=a.useState(null),[Yi,na]=a.useState(!1);a.useState(!1);const[Hi,Sr]=a.useState(!1),[Mn,Dr]=a.useState(""),[Gi,la]=a.useState(!1),[Qi,Cr]=a.useState(!1),[ts,Ir]=a.useState([]),[kr,$n]=a.useState(""),[Tr,Rn]=a.useState(""),[Ar,Un]=a.useState(""),[_n,zn]=a.useState(""),[Zi,Wa]=a.useState(!1),[Pr,Or]=a.useState(null),[Pt,ia]=a.useState(null),[Fa,Wr]=a.useState(""),[Xi,Us]=a.useState(!1),[Jn,Ea]=a.useState(0),[Jt,ys]=a.useState(null),[js,Fr]=a.useState(""),[Re,eo]=a.useState(null),ss=async s=>{try{const r=JSON.stringify(s);localStorage.setItem(Xn(),r);try{localStorage.setItem(tl(),r)}catch{}t!=null&&t.uid&&Se.updateUserData(t.uid,{debts:s}).catch(()=>fe(!0))}catch(r){console.error("خطأ في حفظ الديون:",r)}},to=async()=>{try{const s=Xn(),r=tl(),n=localStorage.getItem(s),i=localStorage.getItem(r),c=v=>{if(!v)return null;try{const w=JSON.parse(v);return Array.isArray(w)?w.map(B=>{var A;return{...B,createdAt:(A=B.createdAt)!=null&&A.toDate?B.createdAt.toDate():new Date(B.createdAt),partialPayments:Array.isArray(B.partialPayments)?B.partialPayments.map(S=>{var F;return{amount:Number(S.amount)||0,paidAt:(F=S.paidAt)!=null&&F.toDate?S.paidAt.toDate():new Date(S.paidAt)}}):[]}}):[]}catch(w){return console.warn("فشل في تحليل ديون localStorage:",w),null}};let f=c(n);if(!f||f.length===0){const v=c(i);if(v&&v.length>0&&(f=v,Mt(v),t!=null&&t.uid))try{await ss(v),localStorage.removeItem(r)}catch(w){console.warn("تعذر ترحيل الديون من المفتاح الافتراضي:",w)}}if(f&&f.length>0&&Mt(f),t!=null&&t.uid)try{const v=await er(Yt(ot,"users",t.uid));if(v.exists()){const w=v.data(),B=w.debts&&Array.isArray(w.debts)?w.debts.map(F=>{var Q;return{...F,createdAt:(Q=F.createdAt)!=null&&Q.toDate?F.createdAt.toDate():new Date(F.createdAt),partialPayments:Array.isArray(F.partialPayments)?F.partialPayments.map(P=>{var H;return{amount:Number(P.amount)||0,paidAt:(H=P.paidAt)!=null&&H.toDate?P.paidAt.toDate():new Date(P.paidAt)}}):[]}}):[],A=f&&f.length>0?f:B;Mt(A);try{localStorage.setItem(s,JSON.stringify(A))}catch{}(A.length!==B.length||A.some(F=>{const Q=B.find(P=>P.id===F.id);return!Q||Q.amount!==F.amount||Q.status!==F.status||(Q.paidAmount??0)!==(F.paidAmount??0)}))&&await Se.updateUserData(t.uid,{debts:A})}else f&&f.length>0&&await Se.saveUserData(t.uid,{debts:f})}catch(v){console.warn("تعذر تحميل الديون من Firebase، الاعتماد على المحلي:",v)}}catch(s){console.error("خطأ في تحميل الديون:",s)}},so=async()=>{if(t!=null&&t.uid){console.log("🔄 إعادة فحص حالة المستخدم...");try{await new Promise(r=>setTimeout(r,500));const s=await er(Yt(ot,"users",t.uid));if(s.exists()){const n=s.data().isActive===!0,i=await ga.checkTrialValidity(t.uid),c=i.isValid&&!i.isExpired;console.log("📊 حالة المستخدم:",{isActive:n,isOnTrial:c,hoursRemaining:i.hoursRemaining}),U(n||c),I(c),j(i.hoursRemaining),_(i.hasUsedTrial),Xe(!n&&!c),console.log("✅ تم تحديث حالة المستخدم بنجاح:",{userIsActive:n||c,isOnFreeTrial:c})}}catch(s){console.error("خطأ في إعادة فحص حالة المستخدم:",s)}}},ao=async()=>{console.log("🎉 تم بدء التجربة المجانية، إعادة فحص حالة المستخدم..."),await so()},ro=async()=>{if(t!=null&&t.uid)try{ke(!0);const s=await vn(t.uid);ge(s)}catch(s){console.error("خطأ في جلب بيانات الاشتراك:",s)}finally{ke(!1)}};a.useState(!1);const[no,Er]=a.useState(!1),[ze,lt]=a.useState(0),[be,Je]=a.useState({}),[lo,Kn]=a.useState(!1),[io,qn]=a.useState(!1),[oo,Br]=a.useState(!1),[co,Ba]=a.useState(!1),[Vn,Lr]=a.useState(""),[mo,Mr]=a.useState(!1),[ho,La]=a.useState(!1),[$r,Ma]=a.useState(""),[uo,Rr]=a.useState(!1),[$a,Yn]=a.useState(""),[Ra,Hn]=a.useState(""),[Ua,Gn]=a.useState(""),[Qn,Zn]=a.useState(!1),tt=()=>`walletBalances_${(t==null?void 0:t.uid)||"default"}`,st=()=>`cashBalance_${(t==null?void 0:t.uid)||"default"}`,Xn=()=>`debts_${(t==null?void 0:t.uid)||"default"}`,el=()=>`customers_${(t==null?void 0:t.uid)||"default"}`,tl=()=>"debts_default",sl=()=>`shopExpenses_${(t==null?void 0:t.uid)||"default"}`,xo=()=>{try{const s=localStorage.getItem(sl());if(s){const r=JSON.parse(s);Oe(r.map(n=>({...n,createdAt:new Date(n.createdAt)})))}}catch(s){console.error("خطأ أثناء تحميل مصروفات المحل من التخزين:",s)}},po=async s=>{try{localStorage.setItem(sl(),JSON.stringify(s)),Oe(s)}catch(r){console.error("خطأ أثناء حفظ مصروفات المحل في التخزين:",r)}},al=()=>`deficiencies_${(t==null?void 0:t.uid)||"default"}`,go=()=>{try{const s=localStorage.getItem(al());if(s){const r=JSON.parse(s);xe(r.map(n=>({...n,createdAt:new Date(n.createdAt)})))}}catch(s){console.error("خطأ أثناء تحميل النواقص من التخزين:",s)}},Ur=async s=>{try{localStorage.setItem(al(),JSON.stringify(s)),xe(s)}catch(r){console.error("خطأ أثناء حفظ النواقص في التخزين:",r)}},fo=async s=>{try{localStorage.setItem(el(),JSON.stringify(s)),Ir(s),t!=null&&t.uid&&await Se.updateUserData(t.uid,{customers:s})}catch(r){console.error("خطأ أثناء حفظ العملاء في التخزين:",r)}},vo=async()=>{try{if(t!=null&&t.uid){const r=await er(Yt(ot,"users",t.uid));if(r.exists()){const n=r.data();if(n.customers&&Array.isArray(n.customers)){const i=n.customers.map(c=>{var f;return{...c,createdAt:(f=c.createdAt)!=null&&f.toDate?c.createdAt.toDate():new Date(c.createdAt)}});Ir(i);return}}}const s=localStorage.getItem(el());if(s){const r=JSON.parse(s);Ir(r.map(n=>({...n,createdAt:new Date(n.createdAt)})))}}catch(s){console.error("خطأ أثناء تحميل العملاء من التخزين:",s)}},oa=()=>`transactions_${(t==null?void 0:t.uid)||"default"}`,ca=()=>`deletedTransactions_${(t==null?void 0:t.uid)||"default"}`,_s=()=>`wallets_${(t==null?void 0:t.uid)||"default"}`,Ns=()=>`selectedWallet_${(t==null?void 0:t.uid)||"default"}`,_r=()=>{try{const s=_s(),r=localStorage.getItem(s);if(r){const n=JSON.parse(r);if(Array.isArray(n)&&n.length>0)return n}}catch(s){console.warn("loadWalletsFromLocalWithMigration failed:",s)}return null},zr=s=>{try{const r=Ns(),n=localStorage.getItem(r);if(n&&s.find(i=>i.id===n))return n}catch{}return null},[Jr,_a]=a.useState(""),[Ct,rl]=a.useState(""),Kt=He.useMemo(()=>{const s=me;if(!s)return!1;const r=ac(s),n=s.planType??s.plan??null,i=typeof n=="string"?n.toLowerCase():null,c=i==="monthly"||i==="quarterly"||i==="yearly"||i==="lifetime"||n===ls.MONTHLY||n===ls.QUARTERLY||n===ls.YEARLY||n===ls.LIFETIME;return r&&c},[me]),Pe=He.useMemo(()=>{const s=me;if(!s)return!1;const r=s.planType??s.plan??null,n=typeof r=="string"?r.toLowerCase():null;return r===ls.ZERO||n==="zero"},[me]),bo=()=>{if(!Kt){l({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}L(!0)};a.useState(!1);const[yo,jo]=a.useState(!1),[No,wo]=a.useState(!1),[So,Do]=a.useState(!1),[Co,za]=a.useState(!1),[Ja,Kr]=a.useState(""),[qr,Vr]=a.useState(""),[nl,ll]=a.useState(!1),[Io,Ka]=a.useState(!1),[il,Yr]=a.useState(""),[ol,Hr]=a.useState(""),[cl,dl]=a.useState(!1),ml=async()=>{if(t!=null&&t.uid)try{const s=`userData_${t.uid}`,r=localStorage.getItem(s);if(r){const n=JSON.parse(r);console.log("🔄 مزامنة البيانات المحلية مع Firebase...",n);const i={lastSynced:new Date().toISOString()};typeof n.cashBalance=="number"&&(i.cashBalance=n.cashBalance),n.walletBalances&&typeof n.walletBalances=="object"&&(i.walletBalances=n.walletBalances),await Se.updateUserData(t.uid,i),localStorage.removeItem(s),fe(!1),console.log("✅ تمت المزامنة بنجاح وحذف البيانات المحلية")}else console.log("لا توجد بيانات محلية تحتاج للمزامنة")}catch(s){console.error("❌ فشل في مزامنة البيانات:",s),l({title:"فشل في المزامنة",description:"حدث خطأ أثناء مزامنة البيانات مع الخادم",variant:"destructive"})}},hl=t!=null&&t.uid?`recentTransactionsResetAt:${t.uid}`:null,Gr=He.useMemo(()=>{if(!hl)return null;try{const s=localStorage.getItem(hl);return s?new Date(s):null}catch{return null}},[t==null?void 0:t.uid]),ul=He.useMemo(()=>{const s=ne||[];return Gr?s.filter(r=>new Date(r.createdAt)>=Gr):s},[ne,Gr]),xl=He.useCallback(()=>{let s=ul;const r=Tn.trim();if(r&&(s=s.filter(n=>n.senderPhone&&n.senderPhone.includes(r)||n.receiverPhone&&n.receiverPhone.includes(r))),Da){const n=new Date(Da);s=s.filter(i=>{const c=new Date(i.createdAt);if(Ca){const[f,v]=Ca.split(":"),w=new Date(n);w.setHours(parseInt(f),parseInt(v),0,0);const B=new Date(w);return B.setHours(B.getHours()+1),c>=w&&c<B}else return c.toDateString()===n.toDateString()})}try{s=[...s].sort((n,i)=>{const c=new Date(n.createdAt||0).getTime();return new Date(i.createdAt||0).getTime()-c})}catch{}return s},[ul,Tn,Da,Ca]),[ko,qa]=a.useState(!1),[pl,Va]=a.useState(""),[To,Ya]=a.useState(!1),[Qr,Zr]=a.useState(""),[Ao,fe]=a.useState(!1);ye.reduce((s,r)=>s+(be[r.id]||0),0);const Po=s=>is.verifyMasterPin(s),Xr=s=>is.verifyMasterPin(s),en=async s=>{try{const r=rn.currentUser;if(!r||!r.email)return!1;const n=oc.credential(r.email,s);return await cc(r,n),!0}catch(r){return console.error("فشل التحقق من كلمة المرور:",r),!1}};a.useEffect(()=>{if(!(t!=null&&t.uid))return;console.log("🚀 استعادة البيانات من localStorage عند تحميل الصفحة للمستخدم:",t.uid);const s=`walletBalances_${t.uid}`,r=localStorage.getItem(s);if(r)try{const c=JSON.parse(r);console.log("📱 استعادة أرصدة المحافظ من localStorage:",c),Je(c)}catch(c){console.error("خطأ في قراءة أرصدة المحافظ من localStorage:",c)}const n=`cashBalance_${t.uid}`;let i=localStorage.getItem(n);if(!i){const c=`userCashBalance_${t.uid}`,f=localStorage.getItem(c);if(f){i=f;try{localStorage.setItem(n,f),localStorage.removeItem(c)}catch{}}}if(i){const c=parseFloat(i);console.log("💰 استعادة رصيد الدرج النقدي من localStorage:",c),lt(c)}},[t==null?void 0:t.uid]);const gl=async()=>{try{if(!X)return;const s=await os.autoResetLimitsIfNeeded(X);eo(s)}catch(s){console.error("خطأ في جلب حدود المحفظة المختارة:",s)}};a.useEffect(()=>{gl()},[X]),a.useEffect(()=>{const s=r=>{var n;(n=r==null?void 0:r.detail)!=null&&n.walletId&&r.detail.walletId===X&&gl()};return window.addEventListener("walletLimitsUpdated",s),()=>window.removeEventListener("walletLimitsUpdated",s)},[X]),a.useEffect(()=>{if(p.state){if(console.log("Location state:",p.state),p.state.openDebtDialog&&(Pe?l({title:"غير متاح",description:"الديون/الأجل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):ra(!0),window.history.replaceState({},document.title)),p.state.openSalesDialog&&(Pe?l({title:"غير متاح",description:"بيانات المبيعات غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Xs(!0),window.history.replaceState({},document.title)),p.state.openMaintenanceDialog&&(Pe?l({title:"غير متاح",description:"الصيانة غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ta(!0),window.history.replaceState({},document.title)),p.state.openCreditCardsDialog&&(console.log("Opening credit cards dialog"),Pe?l({title:"غير متاح",description:"كروت الائتمان غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):ka(!0),window.history.replaceState({},document.title)),p.state.openShopExpensesDialog&&(Pe?l({title:"غير متاح",description:"مصروفات المحل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):is.hasMasterPin()?Y(!0):se(!0),window.history.replaceState({},document.title)),p.state.openDeficienciesDialog&&(Pe?l({title:"غير متاح",description:"النواقص غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):yt(!0),window.history.replaceState({},document.title)),p.state.openTransactionSection){const s=document.getElementById("transaction-section");s&&s.scrollIntoView({behavior:"smooth"}),p.state.transactionType&&mr(p.state.transactionType),p.state.startNewTransaction&&(et(""),_t(""),he(""),Ye(""),console.log("🔒 Starting new transaction without changing wallet selection")),p.state.focusWalletSelection&&setTimeout(()=>{const r=document.querySelector('[data-testid="wallet-select"]');r&&r.focus()},500),window.history.replaceState({},document.title)}p.state.openCashierShiftModal&&(Kt?L(!0):l({title:"غير متاح",description:"وردية الكاشير متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"}),window.history.replaceState({},document.title)),p.state.openMachineDailyDialog&&(Kt?Aa(!0):l({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"}),window.history.replaceState({},document.title))}},[p.state,ye]),a.useEffect(()=>{var s;if(t!=null&&t.uid)try{const r=_r();if(r&&r.length>0){es(r);const n=zr(r)||localStorage.getItem(Ns()),i=n&&r.find(c=>c.id===n)?n:(s=r[0])==null?void 0:s.id;i&&!X&&da(i,"localStorageHydration")}}catch(r){console.error("خطأ في تهيئة المحافظ من التخزين المحلي:",r)}},[t==null?void 0:t.uid]),a.useEffect(()=>{p.pathname==="/user/dashboard"&&sessionStorage.getItem("previousPath")==="/user/add-wallet"&&(console.log("🔄 Returned from wallet addition page - reloading wallets"),Ha(),sessionStorage.removeItem("previousPath")),sessionStorage.setItem("previousPath",p.pathname)},[p.pathname,t==null?void 0:t.uid]),a.useEffect(()=>{if(!(t!=null&&t.uid))return;console.log("🔥 Setting up real-time user activation listener for:",t.uid);const s=Yt(ot,"users",t.uid),r=rc(s,n=>{if(n.exists()){const i=n.data(),c=i.isActive===!0;console.log("🔥 Real-time user status update:",{userId:t.uid,isActive:c,subscription:i.subscription}),c&&!K?(console.log("🎉 User activated! Redirecting to dashboard..."),U(!0),Xe(!1),q(!1)):!c&&K&&(console.log("❌ User deactivated! Showing activation modal..."),U(!1),Xe(!0))}},n=>{console.error("❌ Error in real-time user listener:",n)});return()=>{console.log("🔥 Cleaning up real-time user listener"),r()}},[t==null?void 0:t.uid,K]),a.useEffect(()=>{if(!(t!=null&&t.uid))return;const s=n=>{const{userId:i}=n.detail;i===t.uid&&(console.log("🎉 Subscription activation event received for current user!"),U(!0),Xe(!1),q(!1),setTimeout(()=>{console.log("✅ User activation completed - data updated")},1e3))},r=n=>{const{userId:i,isActive:c}=n.detail;i===t.uid&&(console.log("🔄 User subscription update event received:",{userId:i,isActive:c}),c&&!K&&(U(!0),Xe(!1),q(!1),setTimeout(()=>{console.log("✅ User subscription updated - data refreshed")},1e3)))};return window.addEventListener("subscriptionActivated",s),window.addEventListener("userSubscriptionUpdated",r),()=>{window.removeEventListener("subscriptionActivated",s),window.removeEventListener("userSubscriptionUpdated",r)}},[t==null?void 0:t.uid,K]),a.useEffect(()=>{const s=r=>{var f;const n=r.target,i=(f=n==null?void 0:n.tagName)==null?void 0:f.toLowerCase();if(!(i==="input"||i==="textarea"||i==="select"||((n==null?void 0:n.isContentEditable)??!1))&&!(r.ctrlKey||r.altKey||r.metaKey)&&!r.repeat){if(Pe&&r.key>="1"&&r.key<="9"){r.preventDefault();return}switch(r.key){case"1":break;case"2":vr(!0);break;case"3":Pe?l({title:"غير متاح",description:"كروت الائتمان غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):ka(!0);break;case"4":Kt?L(!0):l({title:"غير متاح",description:"وردية الكاشير متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});break;case"5":Pe?l({title:"غير متاح",description:"بيانات المبيعات غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Xs(!0);break;case"6":Pe?l({title:"غير متاح",description:"الديون/الأجل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):ra(!0);break;case"7":Pe?l({title:"غير متاح",description:"الصيانة غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ta(!0);break;case"8":Kt?Aa(!0):l({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});break;case"9":Pe?l({title:"غير متاح",description:"مصروفات المحل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):is.hasMasterPin()?Y(!0):se(!0);break}}};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[Pe,Kt]),a.useEffect(()=>{console.log("🔥 useEffect loadUserData started",{user:t==null?void 0:t.uid,isCheckingActivation:O}),(async()=>{try{if(!(t!=null&&t.uid)){console.log("🔥 No user UID, setting isCheckingActivation to false"),q(!1);return}let i=!1;const c=`userData_${t==null?void 0:t.uid}`,f=localStorage.getItem(c);if(f)try{const S=JSON.parse(f);S.walletBalances&&(Je(S.walletBalances),i=!0,console.log("⚡ تحميل فوري لأرصدة المحافظ من بيانات المستخدم:",S.walletBalances))}catch(S){console.error("خطأ في قراءة بيانات المستخدم من localStorage:",S)}if(!i){const S=localStorage.getItem(tt());if(S)try{const F=JSON.parse(S);Je(F),i=!0,console.log("⚡ تحميل فوري لأرصدة المحافظ من النسخة الاحتياطية:",F)}catch(F){console.error("خطأ في قراءة أرصدة المحافظ من localStorage:",F)}}if(!i){const F=Object.keys(localStorage).filter(Q=>Q.startsWith("walletBalances_backup_")).sort().reverse();for(const Q of F)try{const P=localStorage.getItem(Q);if(P){const H=JSON.parse(P);Je(H),i=!0,console.log("⚡ تحميل فوري لأرصدة المحافظ من النسخة الاحتياطية بالتوقيت:",H);break}}catch(P){console.error("خطأ في قراءة النسخة الاحتياطية:",P);continue}}let v=localStorage.getItem(st());if(!v&&(t!=null&&t.uid)){const S=`userCashBalance_${t.uid}`,F=localStorage.getItem(S);if(F){v=F;try{localStorage.setItem(st(),F),localStorage.removeItem(S)}catch{}}}v&&(lt(parseFloat(v)),console.log("⚡ تحميل فوري لرصيد الدرج النقدي من localStorage:",v));try{const S=await er(Yt(ot,"users",t.uid));if(S.exists()){const Q=S.data().isActive===!0,P=await ga.checkTrialValidity(t.uid),H=P.isValid&&!P.isExpired;U(Q||H),I(H),j(P.hoursRemaining),_(P.hasUsedTrial),Xe(!Q&&!H),console.log("📊 حالة المستخدم:",{isActive:Q,isOnTrial:H,hoursRemaining:P.hoursRemaining,hasUsedTrial:P.hasUsedTrial})}else U(!1),Xe(!0)}catch(S){console.error("خطأ في فحص حالة تفعيل المستخدم:",S),U(!1),Xe(!0)}finally{q(!1)}console.log("🔄 بدء تحميل بيانات المستخدم من Firebase...",{userId:t==null?void 0:t.uid});const w=localStorage.getItem(c);let B=!1;if(w)try{const S=JSON.parse(w),F=new Date(S.lastUpdated);(new Date().getTime()-F.getTime())/(1e3*60)<1&&(B=!0,console.log("⚡ توجد تغييرات محلية حديثة (أقل من دقيقة)، تجنب إعادة التحميل من Firebase"),S.walletBalances&&Je(S.walletBalances),S.cashBalance!==void 0&&lt(S.cashBalance))}catch(S){console.error("خطأ في قراءة البيانات المحلية:",S)}if(w&&!B)try{const S=JSON.parse(w),F=new Date(S.lastUpdated);(new Date().getTime()-F.getTime())/(1e3*60)>10&&(console.log("🗑️ حذف البيانات المحلية القديمة (أكثر من 10 دقائق)"),localStorage.removeItem(c))}catch(S){console.error("خطأ في حذف البيانات المحلية القديمة:",S)}if(!B&&(t!=null&&t.uid)){const S=await Se.getUserData(t.uid);if(console.log("📥 البيانات المحملة من Firebase:",S),S){const F=(S==null?void 0:S.walletBalances)||{},Q=S!=null&&S.lastUpdated?new Date(S.lastUpdated):null;let P=null,H=null;try{const we=localStorage.getItem(c);we&&(P=JSON.parse(we),P!=null&&P.lastUpdated&&(H=new Date(P.lastUpdated)))}catch(we){console.error("خطأ في قراءة بيانات النسخة المحلية للمقارنة:",we)}if(!!(H&&(!Q||H>Q))&&(P!=null&&P.walletBalances)){console.log("⚖️ تفضيل الأرصدة المحلية الأحدث على Firebase"),Je(P.walletBalances);try{localStorage.setItem(tt(),JSON.stringify(P.walletBalances))}catch{}try{await Se.updateUserData(t.uid,{walletBalances:P.walletBalances,lastUpdated:H.toISOString()})}catch(we){console.error("فشل مزامنة الأرصدة المحلية الأحدث إلى Firebase:",we),fe(!0)}}else{console.log("🏛️ اعتماد Firebase كمصدر الحقيقة لأرصدة المحافظ"),Je(F);try{localStorage.setItem(tt(),JSON.stringify(F))}catch{}}if((S==null?void 0:S.cashBalance)!==void 0){console.log("💰 تحميل رصيد الدرج النقدي من Firebase:",S.cashBalance),lt(S.cashBalance);try{localStorage.setItem(st(),S.cashBalance.toString())}catch{}}try{const we=t!=null&&t.uid?await Xa.getDeletedTransactionsByUser(t.uid):[];if(we&&we.length>0)bs(we),console.log("🗑️ تم تحميل المعاملات المحذوفة من Firebase:",we.length);else{const at=localStorage.getItem(ca());if(at)try{const Le=JSON.parse(at);bs(Le),console.log("🗑️ تم تحميل المعاملات المحذوفة من localStorage:",Le.length)}catch(Le){console.error("خطأ في قراءة المعاملات المحذوفة من localStorage:",Le)}}}catch(we){console.error("خطأ في تحميل المعاملات المحذوفة من Firebase:",we);const at=localStorage.getItem(ca());if(at)try{const Le=JSON.parse(at);bs(Le),console.log("🗑️ تم تحميل المعاملات المحذوفة من localStorage (fallback):",Le.length)}catch(Le){console.error("خطأ في قراءة المعاملات المحذوفة من localStorage:",Le)}}}else{console.log("⚠️ لا توجد بيانات مستخدم في Firebase، محاولة استعادة من localStorage");const F=localStorage.getItem(tt());if(F)try{const P=JSON.parse(F);console.log("📱 استعادة أرصدة المحافظ من localStorage:",P),Je(P)}catch(P){console.error("خطأ في قراءة أرصدة المحافظ من localStorage:",P)}let Q=localStorage.getItem(st());if(!Q&&(t!=null&&t.uid)){const P=`userCashBalance_${t.uid}`,H=localStorage.getItem(P);if(H){Q=H;try{localStorage.setItem(st(),H),localStorage.removeItem(P)}catch{}}}Q&&(lt(parseFloat(Q)),console.log("💰 استعادة رصيد الدرج النقدي من localStorage:",Q));try{const P=t!=null&&t.uid?await Xa.getDeletedTransactionsByUser(t.uid):[];if(P&&P.length>0)bs(P),console.log("🗑️ تم تحميل المعاملات المحذوفة من Firebase:",P.length);else{const H=localStorage.getItem(ca());if(H)try{const _e=JSON.parse(H);bs(_e),console.log("🗑️ تم تحميل المعاملات المحذوفة من localStorage:",_e.length)}catch(_e){console.error("خطأ في قراءة المعاملات المحذوفة من localStorage:",_e)}}}catch(P){console.error("خطأ في تحميل المعاملات المحذوفة من Firebase:",P);const H=localStorage.getItem(ca());if(H)try{const _e=JSON.parse(H);bs(_e),console.log("🗑️ تم تحميل المعاملات المحذوفة من localStorage (fallback):",_e.length)}catch(_e){console.error("خطأ في قراءة المعاملات المحذوفة من localStorage:",_e)}}}}console.log("🔄 بدء تحميل المحافظ من Firebase...");try{const S=await ps.getByMerchantId((t==null?void 0:t.uid)||"");if(S&&S.length>0){console.log("✅ تم العثور على محافظ في Firebase:",S.length);const F=S.map(H=>({id:H.id,name:H.label||"محفظة بدون اسم",phone:H.msisdn,isDefault:!1,monthlyWithdrawalLimit:H.monthlyWithdrawalLimit??H.withdrawLimit??2e5,monthlyTransferLimit:H.monthlyTransferLimit??H.transferLimit??2e5,defaultTransferCommission:H.defaultTransferCommission!=null?Number(H.defaultTransferCommission):null,defaultWithdrawCommission:H.defaultWithdrawCommission!=null?Number(H.defaultWithdrawCommission):null}));es(F),localStorage.setItem(_s(),JSON.stringify(F));const Q=localStorage.getItem(Ns());let P=null;Q&&F.find(H=>H.id===Q)?P=F.find(H=>H.id===Q):P=F[0],P&&(ea(P.id),De(P.phone)),console.log("🔄 تم تحديث المحافظ من Firebase وحفظها في localStorage")}else{console.log("⚠️ لا توجد محافظ في Firebase، محاولة التحميل من localStorage...");const F=_r();if(F&&F.length>0)try{console.log("📱 تم العثور على محافظ محلية بعد الهجرة:",F.length),es(F);const Q=zr(F)||localStorage.getItem(Ns());let P=null;Q&&F.find(H=>H.id===Q)?P=F.find(H=>H.id===Q):P=F.find(H=>H.isDefault)||F[0],P&&(ea(P.id),De(P.phone))}catch(Q){console.error("خطأ في معالجة المحافظ بعد الهجرة:",Q)}else console.log("⚠️ لا توجد محافظ محلية، لن نقوم بإنشاء محافظ افتراضية."),es([])}}catch(S){console.error("خطأ في تحميل المحافظ من Firebase:",S);const F=_r();if(F&&F.length>0)try{console.log("📱 استخدام المحافظ من localStorage بعد الهجرة:",F.length),es(F);const Q=zr(F)||localStorage.getItem(Ns());let P=null;Q&&F.find(H=>H.id===Q)?P=F.find(H=>H.id===Q):P=F.find(H=>H.isDefault)||F[0],P&&(ea(P.id),De(P.phone))}catch(Q){console.error("خطأ في قراءة المحافظ من localStorage بعد الهجرة:",Q),es([])}else console.log("⚠️ لا توجد محافظ محلية، لن يتم إنشاء محافظ افتراضية"),es([])}const A=t!=null&&t.uid?await Se.getUserTransactions(t.uid):[];if(A&&A.length>0){console.log("📊 تم تحميل المعاملات من Firebase:",A.length);const S=A.map(P=>({...P,createdAt:new Date(P.createdAt),senderPhone:P.senderMsisdn||P.senderPhone||"",receiverPhone:P.receiverMsisdn||P.receiverPhone||"",type:P.txnType==="send"?"send":P.txnType==="receive"?"withdraw":P.type||"withdraw",status:P.status==="confirmed"?"completed":P.status||"completed"})),F=In.map(P=>P.id||P.originalTransactionId),Q=S.filter(P=>!F.includes(P.id));console.log("✅ تم فلترة المعاملات المحذوفة:",{total:A.length,deleted:F.length,active:Q.length}),Ie(Q)}await ml()}catch(i){console.error("خطأ في تحميل بيانات المستخدم من Firebase:",i);let c=localStorage.getItem(st());if(!c&&(t!=null&&t.uid)){const v=`userCashBalance_${t.uid}`,w=localStorage.getItem(v);if(w){c=w;try{localStorage.setItem(st(),w),localStorage.removeItem(v)}catch{}}}c&&lt(parseFloat(c));const f=localStorage.getItem(tt());if(f)try{const v=JSON.parse(f);Je(v),console.log("📱 تم استعادة أرصدة المحافظ من localStorage:",v)}catch(v){console.error("خطأ في قراءة أرصدة المحافظ من localStorage:",v)}}})().then(async()=>{await r(),await n()});const r=async()=>{try{for(const i of ye)await Ic.autoResetLimitsIfNeeded(i.phone)}catch(i){console.error("خطأ في التصفير التلقائي للحدود:",i)}},n=async()=>{try{const i=qt.getReportsData(t==null?void 0:t.uid);if((i.lastDailyResetDate?qt.shouldResetDailyReports(i.lastDailyResetDate):!1)&&(t!=null&&t.uid)&&i.lastDailyResetDate){const v=new Date(i.lastDailyResetDate),w=v.toDateString();let B=ne.filter(we=>new Date(we.createdAt).toDateString()===w&&we.status==="completed");const A=qt.filterVisibleTransactions(B,"daily",t==null?void 0:t.uid),S=A.length,F=A.reduce((we,at)=>we+at.amount,0),Q=A.filter(ma).reduce((we,at)=>{const Le=at.withdrawnAmount!==void 0?at.withdrawnAmount:at.amount;return we+Le},0),P=A.filter(ha).reduce((we,at)=>{const Le=at.sentAmount!==void 0?at.sentAmount:at.amount;return we+Le},0),H=A.reduce((we,at)=>we+qt.calculateTransactionProfit(at),0),_e=new Date(v).toISOString().slice(0,10);await Ll.add({userId:t.uid,reportDate:_e,totalTransactions:S,totalAmount:Number(F.toFixed(2)),totalWithdrawn:Number(Q.toFixed(2)),totalSent:Number(P.toFixed(2)),profit:Number(H.toFixed(2)),walletId:null}),l({title:"تم أرشفة تقارير اليوم",description:_e})}const f=qt.autoResetReportsIfNeeded(t==null?void 0:t.uid);(f.dailyReset||f.monthlyReset)&&console.log("تم التصفير التلقائي:",f)}catch(i){console.error("خطأ في التصفير التلقائي للتقارير:",i)}};ro(),to(),vo(),console.log("🔥 useEffect loadUserData completed")},[t==null?void 0:t.uid]);const Ha=async()=>{var s;if(t!=null&&t.uid)try{const r=await ps.getByMerchantId(t.uid);if(r&&r.length>0){const n=r.map(i=>({id:i.id,name:i.label||"محفظة بدون اسم",phone:i.msisdn,isDefault:!1,monthlyWithdrawalLimit:i.monthlyWithdrawalLimit??i.withdrawLimit??2e5,monthlyTransferLimit:i.monthlyTransferLimit??i.transferLimit??2e5,defaultTransferCommission:i.defaultTransferCommission!=null?Number(i.defaultTransferCommission):void 0,defaultWithdrawCommission:i.defaultWithdrawCommission!=null?Number(i.defaultWithdrawCommission):void 0}));if(es(n),localStorage.setItem(_s(),JSON.stringify(n)),t!=null&&t.uid){const i=localStorage.getItem(Ns());if(!!(X&&n.find(f=>f.id===X)))console.log("🔒 Preserving current wallet selection:",X);else{const v=(i&&n.find(w=>w.id===i)?i:null)||((s=n[0])==null?void 0:s.id);v&&(console.log("🔄 Fixing invalid wallet selection:",v),da(v))}}console.log("🔄 تم تحديث المحافظ من Firebase:",n.length)}}catch(r){console.error("خطأ في تحميل المحافظ من Firebase:",r)}};a.useEffect(()=>{const s=p.pathname;sessionStorage.getItem("previousPath")==="/user/add-wallet"&&s==="/user/dashboard"&&(console.log("🔄 Returning from add wallet page - reloading wallets"),console.log("🔒 Current wallet before add-wallet return reload:",X),Ha(),sessionStorage.removeItem("previousPath")),sessionStorage.setItem("previousPath",s)},[p.pathname,t==null?void 0:t.uid]),a.useEffect(()=>{const s=()=>{console.log("🔄 Window focused - reloading wallets"),console.log("🔒 Current wallet before focus reload:",X),Ha().then(()=>{console.log("🔒 Wallet preserved after focus reload:",X)})};return window.addEventListener("focus",s),()=>{window.removeEventListener("focus",s)}},[t==null?void 0:t.uid,X,ye]);const da=(s,r="unknown")=>{console.log(`🎯 setWalletSelection called from ${r} with walletId:`,s),console.log("🔍 Previous selectedWallet:",X),ea(s);const n=ye.find(i=>i.id===s);n&&(De(n.phone),console.log("✅ Wallet set successfully:",s,"Phone:",n.phone)),t!=null&&t.uid&&(localStorage.setItem(Ns(),s),console.log("💾 Saved wallet to localStorage:",s))},Oo=s=>{if(s==="__add_wallet"){h("/user/add-wallet");return}if(s==="__view_wallets"){Ms(!0);return}da(s,"handleWalletChange")},Ga=s=>{console.log("🔄 handleTransactionTypeChange called with type:",s),console.log("🔍 Current selectedWallet before change:",X),console.log("🔍 Available wallets count:",ye.length),mr(s),et(""),_t(""),he(""),Ye(""),console.log("✅ Transaction type changed to:",s,"- Wallet selection preserved:",X),setTimeout(()=>{const r=document.getElementById("transaction-section");r&&r.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})},100)};a.useEffect(()=>{const s=r=>{const n=r.target;if(!!n&&(n.tagName==="INPUT"||n.tagName==="TEXTAREA"||n.tagName==="SELECT"||n.isContentEditable)||(r.key==="ArrowLeft"?(r.preventDefault(),Ga("withdraw")):r.key==="ArrowRight"&&(r.preventDefault(),Ga("transfer"))),r.key==="Enter"){const c=te==="transfer"?"transferSubmitButton":"withdrawSubmitButton",f=document.getElementById(c);f&&!f.disabled&&(r.preventDefault(),f.click())}};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[te]);const Wo=s=>{Ti((n=>({id:n.id,type:n.type==="send"?"transfer":"withdraw",sender_msisdn:n.senderPhone,receiver_msisdn:n.receiverPhone,amount:n.amount,commission:n.commission||0,fee:(n==null?void 0:n.fee)??0,status:n.status==="failed"?"failed":n.status==="completed"?"completed":"pending",createdAt:new Date(n.createdAt).toISOString(),updatedAt:new Date(n.createdAt).toISOString(),shopName:E??($==null?void 0:$.shopName)??(t==null?void 0:t.displayName)??"المحل",cashierName:(n==null?void 0:n.cashierName)??null,commissionMode:(n==null?void 0:n.commissionMode)??(n.type==="send"||Ne?"add":"deduct"),totalCharged:(n==null?void 0:n.totalCharged)??(n.type==="send"?Number(n.amount||0)+Number(n.commission||0)+Number((n==null?void 0:n.fee)||0):Ne?Number(n.amount||0)+Number(n.commission||0):Number(n.amount||0))}))(s)),Sa(!0)},Fo=async s=>{if(!(t!=null&&t.uid)){l({title:"خطأ في المصادقة",description:"يجب تسجيل الدخول أولاً لحذف المعاملات",variant:"destructive"});return}const r=ne.find(n=>n.id===s);if(!r){l({title:"خطأ في الحذف",description:"لم يتم العثور على المعاملة المطلوب حذفها",variant:"destructive"});return}try{console.log("🗑️ بدء عملية حذف المعاملة:",s),console.log("🔄 حذف المعاملة نهائياً من Firebase...",{transactionId:r.id,userId:t.uid,transactionData:r}),await Se.removeUserTransaction(t.uid,r.id),console.log("✅ تم حذف المعاملة نهائياً من Firebase userTransactions");try{await Xa.saveDeletedTransaction({...r,userId:t.uid,originalTransactionId:r.id,deletedAt:new Date().toISOString()}),console.log("✅ تم حفظ المعاملة في سجل المحذوفات مع تاريخ الحذف")}catch(c){console.warn("⚠️ فشل في حفظ المعاملة في سجل المحذوفات، لكن الحذف من Firebase نجح:",c)}const n=[...In,r],i=ne.filter(c=>c.id!==s);bs(n),Ie(i),Sn(!1),localStorage.setItem(ca(),JSON.stringify(n)),localStorage.setItem(oa(),JSON.stringify(i)),console.log("✅ تم تحديث البيانات المحلية بنجاح بعد الحذف من Firebase");try{let c=localStorage.getItem(st());if(!c&&(t!=null&&t.uid)){const B=`userCashBalance_${t.uid}`,A=localStorage.getItem(B);if(A){c=A;try{localStorage.setItem(st(),A),localStorage.removeItem(B)}catch{}}}const f=localStorage.getItem(tt());let v=c?parseFloat(c):0,w=f?JSON.parse(f):{};if(r.type==="send"){const B=r.commission||0;v-=B;const A=r.fromWallet||Object.keys(w)[0];if(A){const S=w[A]||0;w[A]=S+r.amount}}else if(r.type==="withdraw"){const B=r.commission||0;v+=r.amount,v-=B;const A=r.fromWallet||Object.keys(w)[0];if(A){const S=w[A]||0;w[A]=Math.max(0,S-r.amount)}}localStorage.setItem(st(),v.toString()),localStorage.setItem(tt(),JSON.stringify(w))}catch(c){console.warn("فشل عكس تأثير الأرصدة محليًا بعد الحذف:",c)}try{const c=r.fromWallet;if(c){const{walletDailyLimitsService:f}=await xs(async()=>{const{walletDailyLimitsService:w}=await import("./walletDailyLimitsService-BqIuU0I5.js");return{walletDailyLimitsService:w}},__vite__mapDeps([2,0,1])),v=await f.getWalletLimits(c);if(v){const w=r.type==="send",B={updatedAt:(await xs(async()=>{const{serverTimestamp:P}=await import("./index-CimEj1on.js").then(H=>H.a$);return{serverTimestamp:P}},__vite__mapDeps([0,1]))).serverTimestamp()};w?(B.dailyTransferUsed=Math.max(0,(v.dailyTransferUsed||0)-r.amount),B.monthlyTransferUsed=Math.max(0,(v.monthlyTransferUsed||0)-r.amount)):(B.dailyWithdrawUsed=Math.max(0,(v.dailyWithdrawUsed||0)-r.amount),B.monthlyWithdrawUsed=Math.max(0,(v.monthlyWithdrawUsed||0)-r.amount));const{doc:A,setDoc:S}=await xs(async()=>{const{doc:P,setDoc:H}=await import("./index-CimEj1on.js").then(_e=>_e.a$);return{doc:P,setDoc:H}},__vite__mapDeps([0,1])),{db:F}=await xs(async()=>{const{db:P}=await import("./index-CimEj1on.js").then(H=>H.b0);return{db:P}},__vite__mapDeps([0,1])),Q=A(F,"walletLimits",c);await S(Q,B,{merge:!0})}}}catch(c){console.warn("فشل استرجاع حدود المحفظة بعد الحذف:",c)}try{const{ProfitService:c}=await xs(async()=>{const{ProfitService:A}=await import("./profitService-WOL_cZ8K.js");return{ProfitService:A}},__vite__mapDeps([3,4])),{ReportsService:f}=await xs(async()=>{const{ReportsService:A}=await import("./reportsService-Bp1Io21u.js");return{ReportsService:A}},[]),w={txnType:r.type==="send"?"send":"receive",amount:r.amount,commission:r.commission||0,createdAt:r.createdAt,status:"confirmed"},B=c.calculateProfitFromTransaction(w);B>0&&c.addProfit(-B,t.uid);try{f.removeTransactionEffects(r,t.uid)}catch{}}catch(c){console.warn("فشل تحديث الأرباح/التقارير بعد الحذف:",c)}l({title:"تم حذف المعاملة نهائياً",description:"تم حذف المعاملة نهائياً من النظام. يمكنك العثور عليها في قائمة المحذوفات"})}catch(n){console.error("❌ خطأ في حذف المعاملة من Firebase:",n);let i="فشل في حذف المعاملة من الخادم. يرجى المحاولة مرة أخرى";n instanceof Error&&(n.message.includes("network")||n.message.includes("offline")?i="مشكلة في الاتصال بالإنترنت. تحقق من الاتصال وحاول مرة أخرى":n.message.includes("permission")||n.message.includes("unauthorized")?i="ليس لديك صلاحية لحذف هذه المعاملة":n.message.includes("not-found")&&(i="المعاملة غير موجودة أو تم حذفها مسبقاً")),l({title:"خطأ في الحذف",description:i,variant:"destructive"})}},ma=s=>{const r=s.type,n=s.txnType;return r==="withdraw"||r==="withdrawal"||r==="receive"||n==="receive"},ha=s=>{const r=s.type,n=s.txnType;return r==="send"||r==="transfer"||n==="send"},Qa=(s,r)=>{const n=new Date().toDateString();let i=ne.filter(A=>new Date(A.createdAt).toDateString()===n&&A.status==="completed");us&&us.trim()!==""&&(i=i.filter(A=>A.senderPhone&&A.senderPhone.includes(us)||A.receiverPhone&&A.receiverPhone.includes(us)));const c=qt.filterVisibleTransactions(i,"daily",t==null?void 0:t.uid),f=c.length,v=c.reduce((A,S)=>A+S.amount,0),w=c.filter(ma).reduce((A,S)=>{const F=S.withdrawnAmount!==void 0?S.withdrawnAmount:S.amount;return A+F},0),B=c.filter(ha).reduce((A,S)=>{const F=S.sentAmount!==void 0?S.sentAmount:S.amount;return A+F},0);return{totalTransactions:f,totalAmount:v,totalWithdrawn:w,totalSent:B}},ua=s=>{const r=new Date().getMonth(),n=new Date().getFullYear();let i=ne.filter(A=>{const S=new Date(A.createdAt);return S.getMonth()===r&&S.getFullYear()===n&&A.status==="completed"});us&&us.trim()!==""&&(i=i.filter(A=>A.senderPhone&&A.senderPhone.includes(us)||A.receiverPhone&&A.receiverPhone.includes(us)));const c=qt.filterVisibleTransactions(i,"monthly",t==null?void 0:t.uid),f=c.length,v=c.reduce((A,S)=>A+S.amount,0),w=c.filter(ma).reduce((A,S)=>{const F=S.withdrawnAmount!==void 0?S.withdrawnAmount:S.amount;return A+F},0),B=c.filter(ha).reduce((A,S)=>{const F=S.sentAmount!==void 0?S.sentAmount:S.amount;return A+F},0);return{totalTransactions:f,totalAmount:v,totalWithdrawn:w,totalSent:B}},fl=s=>{const r=new Date().getMonth(),n=new Date().getFullYear(),i=ne.filter(v=>{const w=new Date(v.createdAt);return w.getMonth()===r&&w.getFullYear()===n&&v.status==="completed"&&v.fromWallet===s}),c=i.filter(ma).reduce((v,w)=>{const B=w.withdrawnAmount||w.amount;return v+B},0),f=i.filter(ha).reduce((v,w)=>{const B=w.sentAmount||w.amount;return v+B},0);return{totalWithdrawn:c,totalTransferred:f}},Eo=s=>{const r=new Date,n=r.getDate(),i=r.getMonth(),c=r.getFullYear(),f=ne.filter(B=>{const A=new Date(B.createdAt);return A.getDate()===n&&A.getMonth()===i&&A.getFullYear()===c&&B.status==="completed"&&B.fromWallet===s}),v=f.filter(ma).reduce((B,A)=>{const S=A.withdrawnAmount||A.amount;return B+S},0),w=f.filter(ha).reduce((B,A)=>{const S=A.sentAmount||A.amount;return B+S},0);return{totalWithdrawn:v,totalTransferred:w}};ua(),a.useEffect(()=>{const s=localStorage.getItem(oa());if(s){const n=JSON.parse(s).map(i=>({...i,createdAt:new Date(i.createdAt)}));Ie(n)}},[]),a.useEffect(()=>{ne.length>0&&localStorage.setItem(oa(),JSON.stringify(ne))},[ne]);const vl=async()=>{Ad(),console.log("🔄 بدء عملية التحويل/السحب"),console.log("📊 البيانات المدخلة:",{senderPhone:je,receiverPhone:Ue,amount:We,transactionType:te});const s=()=>{te==="transfer"?Rs(!0):sa(!0)},r=()=>{te==="transfer"?Rs(!1):sa(!1)};if(s(),!je||!We){console.log("❌ خطأ: بيانات ناقصة"),l({title:"خطأ في البيانات",description:"يرجى ملء جميع الحقول المطلوبة",variant:"destructive"}),r();return}if(te==="transfer"&&!Ue&&!D){console.log("❌ خطأ: رقم المستقبل مفقود"),l({title:"خطأ في البيانات",description:"يرجى إدخال رقم المستقبل",variant:"destructive"}),r();return}if(te==="transfer"&&!D&&!Pd(Ue)){l({title:"رقم المستقبل غير صالح",description:"اكتب رقم صحيح مكون من 11 رقم ويبدأ بـ 015 أو 010 أو 012 أو 011",variant:"destructive"}),r();return}const n=parseFloat(We);if(console.log("💰 المبلغ المحول:",n),n<=0){console.log("❌ خطأ: مبلغ غير صحيح"),l({title:"خطأ في المبلغ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"}),r();return}if(Pe)try{const le=new Date,Ke=le.getFullYear(),Et=String(le.getMonth()+1).padStart(2,"0"),dt=String(le.getDate()).padStart(2,"0"),rs=`zeroPlanDailyConfirmCount:${(t==null?void 0:t.uid)||"default"}:${Ke}-${Et}-${dt}`,$t=localStorage.getItem(rs);if(($t&&parseInt($t,10)||0)>=10){l({title:"حد التأكيد اليومي",description:"باقة زيرو تسمح بـ 10 تأكيدات تحويل/سحب يومياً فقط.",variant:"destructive"}),r();return}}catch(le){console.warn("فشل قراءة عداد تأكيدات باقة زيرو من التخزين المحلي:",le)}const i=ye.find(le=>le.id===X);if(!i){l({title:"خطأ في المحفظة",description:"يرجى اختيار محفظة صحيحة",variant:"destructive"}),r();return}const c=fl(X);if(console.log("📈 فحص الحدود الشهرية للمحفظة المختارة"),console.log("📊 الإحصائيات الشهرية للمحفظة:",{walletId:X,walletName:i.name,currentWithdrawn:c.totalWithdrawn,currentTransferred:c.totalTransferred,withdrawalLimit:i.monthlyWithdrawalLimit,transferLimit:i.monthlyTransferLimit}),te==="withdraw"){if(console.log("🏧 فحص حد السحب الشهري للمحفظة"),console.log(`💸 المسحوب حالياً من المحفظة: ${c.totalWithdrawn}, المبلغ الجديد: ${n}, الحد الأقصى: ${i.monthlyWithdrawalLimit}`),c.totalWithdrawn+n>i.monthlyWithdrawalLimit){console.log("❌ تجاوز حد السحب الشهري للمحفظة"),l({title:"تجاوز حد السحب الشهري",description:`لا يمكن سحب أكثر من ${i.monthlyWithdrawalLimit} جنيه شهرياً من محفظة ${i.name}`,variant:"destructive"}),r();return}}else if(console.log("💸 فحص حد التحويل الشهري للمحفظة"),console.log(`📤 المحول حالياً من المحفظة: ${c.totalTransferred}, المبلغ الجديد: ${n}, الحد الأقصى: ${i.monthlyTransferLimit}`),c.totalTransferred+n>i.monthlyTransferLimit){console.log("❌ تجاوز حد التحويل الشهري للمحفظة"),l({title:"تجاوز حد التحويل الشهري",description:`لا يمكن تحويل أكثر من ${i.monthlyTransferLimit} جنيه شهرياً من محفظة ${i.name}`,variant:"destructive"}),r();return}const f=($==null?void 0:$.shopName)||(t==null?void 0:t.displayName)||"محل كاشي لينك",v={id:Date.now().toString(),type:te==="transfer"?"send":te==="deposit"?"deposit":"withdraw",senderPhone:je,receiverPhone:te==="transfer"?Ue:je,amount:n,status:"completed",createdAt:new Date,withdrawnAmount:te==="withdraw"?n:void 0,sentAmount:te==="transfer"?n:void 0,depositedAmount:void 0,fromWallet:X,senderNumber:je,senderName:je,shopName:(i==null?void 0:i.name)||"المحفظة الرئيسية",transferredAmount:te==="transfer"?n:void 0,receiverNumber:te==="transfer"?Ue:void 0,withdrawnAmountDetailed:te==="withdraw"?n:void 0,depositedAmountDetailed:void 0,merchantShopName:f,transactionReference:`TXN-${Date.now()}`,commission:0,notes:te==="transfer"?`تحويل من ${je} إلى ${Ue}`:`سحب نقدي من محفظة ${je}`};N&&(b!=null&&b.name||b!=null&&b.username)&&(v.cashierName=(b==null?void 0:b.name)||(b==null?void 0:b.username));const w=qs.validateTransaction(n,te,ze,be);if(!w.isValid){l({title:"خطأ في العملية",description:w.error,variant:"destructive"}),r();return}w.warning&&l({title:"تحذير",description:w.warning,variant:"destructive"});let B;if(te==="transfer")if((i==null?void 0:i.defaultTransferCommission)!=null){const le=Number(i.defaultTransferCommission)||0;B=Math.round(le*n/1e3*100)/100}else Ae&&Ae.trim()!==""?B=Math.max(0,parseFloat(Ae)):B=0;else if((i==null?void 0:i.defaultWithdrawCommission)!=null){const le=Number(i.defaultWithdrawCommission)||0;B=Math.round(le*n/1e3*100)/100}else C&&C.trim()!==""?B=Math.max(0,parseFloat(C)):B=Math.round(n*.01*100)/100;if(v.commission=B,te!=="transfer"&&!Ne&&B>=n){l({title:"خطأ في العمولة",description:"العمولة أكبر من أو تساوي المبلغ المدخل",variant:"destructive"}),r();return}const A=te==="transfer"||Ne?n:Math.round((n-B)*100)/100;v.amount=A,v.withdrawnAmount=te==="withdraw"?A:void 0,v.sentAmount=te==="transfer"?A:void 0,v.transferredAmount=te==="transfer"?A:void 0,v.withdrawnAmountDetailed=te==="withdraw"?A:void 0;let S;const F=te==="transfer"&&!!At,Q=te==="withdraw"&&!!At,P=F||Q;let H=null;const _e=xt(je||"").replace(/\D/g,""),we=xt(Ue||"").replace(/\D/g,""),at=te==="transfer"&&(_e.startsWith("010")&&(we.startsWith("011")||we.startsWith("012")||we.startsWith("015"))||_e.startsWith("012")&&we.startsWith("010")||_e.startsWith("011")&&we.startsWith("010")||_e.startsWith("015")&&we.startsWith("010")),Le=at?Math.max(0,parseFloat(Lt||"0")):0,sn=Math.round(B*100)/100;if(v.commission=sn,at&&!P&&Le<=0){l({title:"خطأ",description:"أدخل رسوم التحويل لعمليات 010 → 011/012/015 أو 012 → 010 أو 011 → 010 أو 015 → 010",variant:"destructive"}),r();return}if(te==="transfer"&&!P){const le=Number(be[X]||0),Ke=Number(A)+Number(Le);if(le<Ke){l({title:"رصيد المحفظة غير كافٍ",description:`الرصيد الحالي ${le} لا يكفي لخصم ${Ke}`,variant:"destructive"}),r();return}}if(P)if(F){const le=qs.validateTransaction(A,"transfer",ze,be);le.isValid?S={success:!0,newCashBalance:ze,newWalletBalances:be}:S={success:!1,newCashBalance:ze,newWalletBalances:be,message:le.error||"رصيد غير كافٍ للتحويل المؤجل",error:"INSUFFICIENT_WALLET_BALANCE"}}else S={success:!0,newCashBalance:ze,newWalletBalances:be};else te==="transfer"?S=await qs.processTransfer({amount:A,currentCashBalance:ze,currentWalletBalances:be,wallets:ye,selectedWalletId:X,skipRemoteLimitsCheck:!0,nonBlockingUsageUpdate:!0}):S=await qs.processWithdraw({amount:A,currentCashBalance:ze,currentWalletBalances:be,wallets:ye,selectedWalletId:X,skipRemoteLimitsCheck:!0,nonBlockingUsageUpdate:!0});if(!S.success){l({title:"فشل في العملية",description:S.error||S.message,variant:"destructive"}),r();return}let zs=P?ze:S.newCashBalance,as=P?be:S.newWalletBalances;if(!P&&te==="transfer"&&Le>0){const le=Number(as[X]||0);as={...as,[X]:Math.round((le-Number(Le))*100)/100}}if(P&&Q){const le=ye.find(dt=>dt.id===X)??ye.find(dt=>dt.isDefault)??ye[0],Ke=(le==null?void 0:le.id)||X;if(Ke!==X)try{da(Ke)}catch{}const Et=Number(be[Ke]||0);as={...be,[Ke]:Math.round((Et+Number(A))*100)/100};try{const dt=`walletEffectsAppliedOnCreation_${(t==null?void 0:t.uid)||"default"}`,rs=localStorage.getItem(dt),$t=rs?JSON.parse(rs):[];v!=null&&v.id&&!$t.includes(v.id)&&($t.push(v.id),localStorage.setItem(dt,JSON.stringify($t)))}catch{}}if(P&&F){const le=ye.find(dt=>dt.id===X)??ye.find(dt=>dt.isDefault)??ye[0],Ke=(le==null?void 0:le.id)||X;if(Ke!==X)try{da(Ke)}catch{}const Et=Number(be[Ke]||0);as={...be,[Ke]:Math.round((Et-Number(A)-Number(Le))*100)/100}}if((F||Q)&&At&&!cr){const le={id:`DEBT-${Date.now()}`,debtorName:At.debtorName,amount:At.amount,reason:At.notes||"",customerId:At.customerId,mobile:At.mobile,status:"pending",createdAt:new Date};H=le.id;const Ke=[le,...wt];Mt(Ke);try{await ss(Ke)}catch(Et){console.error("⚠️ فشل حفظ الدين المؤجل محلياً:",Et)}l({title:"تم إضافة الدين",description:"أضيف إلى إيصالات الديون حتى يتم السداد",variant:"default"})}if(!P){const le=Math.max(0,Number(B))+Math.max(0,Number(Le));le>0&&(zs=Math.round((zs+le)*100)/100,console.log(`💰 تم إضافة عمولة/رسوم ${le} جنيه لدرج النقدية`))}if(console.log("⚡ تحديث الواجهة فوراً..."),lt(zs),Je(as),P&&(v.status="pending"),Ie(le=>[v,...le]),Pe)try{const le=new Date,Ke=le.getFullYear(),Et=String(le.getMonth()+1).padStart(2,"0"),dt=String(le.getDate()).padStart(2,"0"),rs=`zeroPlanDailyConfirmCount:${(t==null?void 0:t.uid)||"default"}:${Ke}-${Et}-${dt}`,$t=localStorage.getItem(rs),Za=$t&&parseInt($t,10)||0;localStorage.setItem(rs,String(Za+1))}catch{}if(localStorage.setItem(st(),zs.toString()),localStorage.setItem(tt(),JSON.stringify(as)),(async()=>{try{console.log("🔄 بدء حفظ المعاملة في Firebase في الخلفية...");const le={shopId:($==null?void 0:$.shopId)||(t==null?void 0:t.uid)||"default-shop",lineId:X||"default-line",merchantUserId:(t==null?void 0:t.uid)||null,provider:"vodafone_cash",txnType:te==="transfer"?"send":"receive",amount:A,commission:sn,fee:Le,profit:0,senderMsisdn:je,receiverMsisdn:te==="transfer"?Ue:je,note:te==="transfer"?`تحويل من ${je} إلى ${Ue}`:`سحب ${A} جنيه من ${(i==null?void 0:i.name)||"المحفظة الرئيسية"}`,status:P?"pending":"confirmed",linkedDebtId:H||void 0,createdBy:(t==null?void 0:t.uid)||null,walletEffectAppliedOnCreation:!!(P&&Q)},Ke={...le,status:P?"pending":"completed",commissionMode:te==="transfer"||Ne?"add":"deduct",totalCharged:te==="transfer"?A+sn+Le:Ne?A+B:A,walletEffectAppliedOnCreation:!!(P&&Q),createdAt:new Date},{ProfitService:Et}=await xs(async()=>{const{ProfitService:Za}=await import("./profitService-WOL_cZ8K.js");return{ProfitService:Za}},__vite__mapDeps([3,4])),dt=Et.calculateProfitFromTransaction(Ke);dt>0&&(Et.addProfit(dt,t==null?void 0:t.uid),console.log("✅ تم إضافة الربح:",dt,"جنيه")),await Promise.all([...t!=null&&t.uid?[Se.updateUserData(t.uid,{cashBalance:zs,walletBalances:as,lastUpdated:new Date().toISOString()})]:[],or.create(le),...t!=null&&t.uid?[Se.saveUserTransaction(t.uid,{...Ke,transactionType:te,fromWallet:X,toWallet:te==="transfer"?F?null:"cash":null,cashierName:N&&((b==null?void 0:b.name)||(b==null?void 0:b.username))||"الحساب الرئيسي",linkedDebtId:H||void 0,description:`${te==="transfer"?"تحويل":"سحب"} ${A} من ${X} ${te==="transfer"?F?"":"إلى الدرج النقدي":""} — عمولة: ${B} (${te==="transfer"||Ne?"مضافة":"مخصومة"})${Le>0?` — رسوم: ${Le}`:""}${P?" — دين مؤجل (قيد المراجعة)":""}`})]:[]]),console.log("✅ تم حفظ جميع البيانات في Firebase بنجاح");const rs=`userData_${t==null?void 0:t.uid}`,$t={cashBalance:zs,walletBalances:as,lastUpdated:new Date().toISOString()};localStorage.setItem(rs,JSON.stringify($t))}catch(le){console.error("❌ خطأ في حفظ المعاملة في Firebase (في الخلفية):",le),l({title:"تحذير",description:"تم تنفيذ العملية محلياً، لكن فشلت المزامنة مع الخادم. ستتم المحاولة مرة أخرى تلقائياً.",variant:"destructive"})}})(),te==="transfer"){Rs(!0);const le=Number(n)+Number(B)+Math.max(0,Number(Le));fr({type:"transfer",amount:Math.max(0,Math.round(le*100)/100)}),Ia(!0),setTimeout(()=>{Rs(!1)},2e3)}else{sa(!0);const le=Ne?Number(n):Math.max(0,Math.round((Number(n)-Number(B))*100)/100);fr({type:"withdraw",amount:Math.max(0,Math.round(le*100)/100)}),Ia(!0),setTimeout(()=>{sa(!1)},2e3)}et(""),_t(""),Zs(null),vs(""),Xt(""),Bs(""),Na(!1)},tn=He.useMemo(()=>new Intl.DateTimeFormat("ar-EG"),[]),Bo=He.useMemo(()=>new Intl.DateTimeFormat("ar-EG",{hour:"2-digit",minute:"2-digit"}),[]),Lo=He.useMemo(()=>{try{return wt.reduce((s,r)=>{const n=Number(r.paidAmount||0),i=Math.max(0,Number(r.amount||0)-n);return s+i},0)}catch{return 0}},[wt]),bl=He.useMemo(()=>xl().filter(r=>pt==="all"?!0:pt==="send"?r.type==="send":pt==="receive"?r.type==="receive":pt==="withdraw"?r.type==="withdraw":pt!=="deleted"),[xl,pt]),Mo=()=>{if(xr==="daily"){const s=qt.resetReportsManually("daily",ne,t==null?void 0:t.uid);ta(!1),l({title:"تم تصفير المعاملات اليومية",description:`تم إخفاء ${s.length} معاملة من تقارير اليوم (الحدود لم تتأثر)`})}else{const s=qt.resetReportsManually("monthly",ne,t==null?void 0:t.uid);ta(!1),l({title:"تم تصفير المعاملات الشهرية",description:`تم إخفاء ${s.length} معاملة من تقارير الشهر (الحدود لم تتأثر)`})}},$o=()=>xr==="daily"?"تصفير المعاملات اليومية":"تصفير المعاملات الشهرية",Ro=()=>xr==="daily"?"أدخل كلمة مرور تسجيل الدخول لتصفير جميع معاملات اليوم":"أدخل كلمة مرور تسجيل الدخول لتصفير جميع معاملات الشهر",Uo=s=>{rl(s),Br(!0)},_o=s=>{lt(s),localStorage.setItem(st(),s.toString()),Kn(!1),l({title:"تم تحديث الرصيد النقدي",description:`تم تحديث الرصيد النقدي إلى ${s} جنيه`})},zo=async s=>{var v;if(!Ct){console.warn("لا يوجد معرف محفظة محدد لتعديل الرصيد");return}const r={...be,[Ct]:s};Je(r);const n=new Date().toISOString(),i={walletBalances:r,lastUpdated:n},c=`userData_${t==null?void 0:t.uid}`;try{localStorage.setItem(c,JSON.stringify(i)),localStorage.setItem(tt(),JSON.stringify(r)),localStorage.setItem(`walletBalances_backup_${n}`,JSON.stringify(r))}catch{}try{t!=null&&t.uid&&await Se.updateUserData(t.uid,i)}catch(w){console.error("خطأ أثناء حفظ رصيد المحفظة في Firebase:",w)}qn(!1);const f=((v=ye.find(w=>w.id===Ct))==null?void 0:v.name)||"المحفظة";l({title:"تم تحديث رصيد المحفظة",description:`تم تحديث رصيد ${f} إلى ${s.toLocaleString()} جنيه`})},Jo=async s=>{var r;if(console.log("💰 بدء تحديث رصيد المحفظة"),console.log("📊 معرف المحفظة المحررة:",Ct),console.log("💵 المبلغ المضاف/المخصوم:",s),Ct){const n=be[Ct]||0;console.log("💰 الرصيد الحالي:",n);const i=n+s;console.log("💰 الرصيد الجديد:",i);const c={...be,[Ct]:i};console.log("📊 الأرصدة المحدثة:",c),Je(c);const f=new Date().toISOString(),v={walletBalances:c,lastUpdated:f},w=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(w,JSON.stringify(v)),localStorage.setItem(tt(),JSON.stringify(c)),localStorage.setItem(`walletBalances_backup_${f}`,JSON.stringify(c));try{if(t!=null&&t.uid){console.log("🔄 حفظ البيانات في Firebase...");try{await Se.updateUserData(t.uid,v),console.log("✅ تم حفظ الأرصدة في Firebase بنجاح"),setTimeout(()=>{localStorage.removeItem(w),console.log("🧹 تم حذف النسخة المحلية المؤقتة بعد دقيقة واحدة")},6e4)}catch(F){console.error("❌ فشل في حفظ البيانات في Firebase:",F),fe(!0)}}else console.log("⚠️ المستخدم غير مسجل دخول، حفظ في localStorage"),localStorage.setItem(tt(),JSON.stringify(c));const B=((r=ye.find(F=>F.id===Ct))==null?void 0:r.name)||"المحفظة",A=s>0?"إضافة":"خصم",S=Math.abs(s);l({title:`تم ${A} مبلغ ${A==="إضافة"?"إلى":"من"} رصيد المحفظة`,description:`تم ${A} ${S} جنيه ${A==="إضافة"?"إلى":"من"} رصيد ${B}. الرصيد الجديد: ${i.toLocaleString()} جنيه`})}catch(B){if(console.error("❌ فشل في حفظ البيانات في Firebase:",B),localStorage.setItem(tt(),JSON.stringify(c)),t!=null&&t.uid){const A=`userData_${t.uid}`,S={walletBalances:c,lastUpdated:new Date().toISOString()};localStorage.setItem(A,JSON.stringify(S)),fe(!0)}l({title:"تم حفظ البيانات محلياً",description:"تم حفظ التغييرات محلياً وسيتم مزامنتها مع الخادم لاحقاً",variant:"default"})}}else console.log("❌ لا يوجد معرف محفظة للتحرير");setTimeout(()=>{const i=Object.keys(localStorage).filter(c=>c.startsWith("walletBalances_backup_")).sort();i.length>5&&i.slice(0,i.length-5).forEach(f=>{localStorage.removeItem(f),console.log("🗑️ حذف النسخة الاحتياطية القديمة:",f)})},5e3),Br(!1),rl("")};return console.log("🔥 UserDashboardPage - Render conditions:",{isCheckingActivation:O,isUserActive:K,showActivationModal:Dt}),!O&&!K?(console.log("🔥 UserDashboardPage - Showing activation modal"),e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center",children:e.jsx(kl,{isOpen:!0,onClose:()=>{}})})):O?(console.log("🔥 UserDashboardPage - Showing loading screen"),e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center",children:e.jsx("div",{className:"text-center",children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"w-3 h-3 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 animate-bounce",style:{animationDelay:"0ms"}}),e.jsx("span",{className:"w-3 h-3 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 animate-bounce",style:{animationDelay:"150ms"}}),e.jsx("span",{className:"w-3 h-3 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 animate-bounce",style:{animationDelay:"300ms"}})]})})})):(console.log("🔥 UserDashboardPage - Rendering main dashboard"),e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-gray-50 via-blue-50/30 to-indigo-50/20 px-2 sm:px-4 py-2 sm:py-4 relative overflow-hidden",children:[e.jsxs("div",{className:"absolute inset-0 overflow-hidden pointer-events-none",children:[e.jsx("div",{className:"absolute top-10 sm:top-20 left-2 sm:left-10 w-32 sm:w-72 h-32 sm:h-72 bg-blue-400/8 rounded-full blur-3xl"}),e.jsx("div",{className:"absolute bottom-10 sm:bottom-20 right-2 sm:right-10 w-40 sm:w-96 h-40 sm:h-96 bg-purple-400/8 rounded-full blur-3xl",style:{animationDelay:"2s"}}),e.jsx("div",{className:"absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-36 sm:w-80 h-36 sm:h-80 bg-indigo-400/5 rounded-full blur-3xl",style:{animationDelay:"4s"}})]}),e.jsxs("div",{className:"max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-3 sm:gap-6 relative z-10",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-2 sm:space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 sm:grid-cols-2 sm:gap-3 fade-in-up",children:[!aa&&e.jsxs(qe,{className:"bg-gradient-to-br from-purple-50 via-purple-25 to-white border border-purple-200/60 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 group relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-purple-500/5 to-purple-600/3 opacity-0 group-hover:opacity-100 transition-opacity duration-300"}),e.jsx("div",{className:"absolute top-0 right-0 w-20 sm:w-32 h-20 sm:h-32 bg-gradient-to-br from-purple-300/15 to-transparent rounded-full -translate-y-8 sm:-translate-y-16 translate-x-8 sm:translate-x-16 group-hover:scale-110 transition-transform duration-300"}),e.jsx(gt,{className:"pb-2 sm:pb-1 lg:pb-1 px-3 sm:px-3 lg:px-2 pt-3 sm:pt-2 lg:pt-1 relative z-10",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(kt,{className:"text-xs font-bold text-purple-800 flex items-center gap-1.5 sm:gap-1",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"w-2.5 sm:w-2 h-2.5 sm:h-2 bg-gradient-to-r from-purple-500 to-purple-600 rounded-full shadow-sm"}),e.jsx("div",{className:"absolute inset-0 w-2.5 sm:w-2 h-2.5 sm:h-2 bg-purple-400 rounded-full opacity-60 animate-pulse"})]}),e.jsx("span",{className:"text-xs",children:"الشهر"})]}),e.jsxs("div",{className:"flex items-center gap-1 sm:gap-1",children:[e.jsx("div",{className:"hidden"}),e.jsx(d,{size:"sm",variant:"ghost",onClick:()=>{Dn("monthly"),ta(!0)},className:"h-7 w-7 sm:h-6 sm:w-6 p-0 bg-gradient-to-r from-purple-100 to-purple-200 text-purple-700 hover:from-purple-200 hover:to-purple-300 hover:text-purple-800 rounded-lg sm:rounded-md transition-all duration-300 hover:scale-105 shadow-sm hover:shadow-md",title:"تصفير معاملات الشهر",children:e.jsx(Ot,{className:"h-3 w-3 sm:h-2.5 sm:w-2.5"})}),e.jsx("div",{className:"p-1.5 sm:p-1 bg-gradient-to-r from-purple-100 to-purple-200 rounded-lg sm:rounded-md",children:e.jsx(xa,{className:"h-3 w-3 sm:h-2.5 sm:w-2.5 text-purple-600"})})]})]})}),!aa&&e.jsxs(Ge,{className:"space-y-0.5 sm:space-y-1 lg:space-y-0 pt-0 px-2 sm:px-3 lg:px-2 pb-1.5 sm:pb-2 lg:pb-1 relative z-10",children:[e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-purple-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-purple-700",children:"عدد المعاملات:"}),e.jsx("span",{className:"font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:ua().totalTransactions})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-purple-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-purple-700",children:"إجمالي المبالغ:"}),e.jsx("span",{className:"font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:ua().totalAmount.toFixed(2)})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-purple-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-purple-700",children:"المسحوب:"}),e.jsx("span",{className:"font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:ua().totalWithdrawn.toFixed(2)})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-purple-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-purple-700",children:"المرسل:"}),e.jsx("span",{className:"font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:ua().totalSent.toFixed(2)})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-purple-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-purple-700",children:"الأرباح:"}),e.jsx(yd,{userId:t==null?void 0:t.uid,transactions:ne})]})]}),Ui&&e.jsx("div",{className:"absolute inset-0 z-20 bg-yellow-100/60 backdrop-blur-sm rounded-xl border border-yellow-300/70 flex items-center justify-center p-0 pointer-events-auto",children:e.jsxs(d,{size:"sm",variant:"ghost",onClick:async()=>{if(Pe){l({title:"غير متاح",description:"تقارير الشهر غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"});return}Pa(!0)},className:"px-2.5 py-1 rounded-full bg-gradient-to-r from-yellow-300 to-yellow-400 text-black hover:from-yellow-400 hover:to-yellow-500 shadow-md flex items-center gap-1 text-[11px] font-semibold",title:"عرض تقارير الشهر (يتطلب الرقم السري)",children:[e.jsx("span",{children:"عرض تقارير الشهر"}),e.jsx(rt,{className:"h-2.5 w-2.5"})]})})]}),e.jsx(As,{open:zi,onOpenChange:Pa,mode:"verify",title:"الرقم السري لفتح تقارير الشهر",description:"لا يمكن الاطلاع على إحصائيات الشهر إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{if(Pe){l({title:"غير متاح",description:"تقارير الشهر غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}),Pa(!1),Wn(!0);return}Wn(!1),Pa(!1)},userId:t==null?void 0:t.uid}),e.jsxs(qe,{className:"bg-gradient-to-br from-blue-50 via-blue-25 to-white border border-blue-200/60 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 group relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/5 to-blue-600/3 opacity-0 group-hover:opacity-100 transition-opacity duration-300"}),e.jsx("div",{className:"absolute top-0 right-0 w-20 sm:w-32 h-20 sm:h-32 bg-gradient-to-br from-blue-300/15 to-transparent rounded-full -translate-y-8 sm:-translate-y-16 translate-x-8 sm:translate-x-16 group-hover:scale-110 transition-transform duration-300"}),e.jsx(gt,{className:"pb-2 sm:pb-3 lg:pb-1 px-3 sm:px-4 lg:px-2 pt-3 sm:pt-4 lg:pt-1 relative z-10",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(kt,{className:"text-sm sm:text-base font-bold text-blue-800 flex items-center gap-1.5 sm:gap-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"w-2.5 sm:w-3 h-2.5 sm:h-3 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full shadow-sm"}),e.jsx("div",{className:"absolute inset-0 w-2.5 sm:w-3 h-2.5 sm:h-3 bg-blue-400 rounded-full opacity-60 animate-pulse"})]}),e.jsx("span",{className:"text-xs sm:text-sm",children:"اليوم"})]}),e.jsxs("div",{className:"flex items-center gap-1 sm:gap-1.5",children:[e.jsx(d,{size:"sm",variant:"ghost",onClick:()=>{Dn("daily"),ta(!0)},className:"h-7 w-7 sm:h-8 sm:w-8 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded-lg transition-all duration-300 hover:scale-105 shadow-sm hover:shadow-md",title:"تصفير معاملات اليوم",children:e.jsx(Ot,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"})}),e.jsx(d,{size:"sm",variant:"ghost",onClick:()=>pr(!0),className:"h-7 w-7 sm:h-8 sm:w-8 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded-lg transition-all duration-300 hover:scale-105 shadow-sm hover:shadow-md",title:"أرشيف التقارير اليومية",children:e.jsx(Nc,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"})}),e.jsx(d,{size:"sm",variant:"ghost",onClick:()=>_i(s=>!s),className:"h-7 w-7 sm:h-8 sm:w-8 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded-lg transition-all duration-300 hover:scale-105 shadow-sm hover:shadow-md",title:aa?"توسيع اليوم والشهر":"طي اليوم والشهر",children:aa?e.jsx(bn,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"}):e.jsx($l,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"})}),e.jsx("div",{className:"p-1.5 sm:p-2 bg-gradient-to-r from-blue-100 to-blue-200 rounded-lg",children:e.jsx(xa,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5 text-blue-600"})})]})]})}),!aa&&e.jsxs(Ge,{className:"space-y-0 pt-0 px-2 pb-1 relative z-10",children:[e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-blue-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-blue-700",children:"عدد المعاملات:"}),e.jsx("span",{className:"font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:Qa().totalTransactions})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-blue-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-blue-700",children:"إجمالي المبالغ:"}),e.jsx("span",{className:"font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:Qa().totalAmount.toFixed(2)})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-blue-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-blue-700",children:"المسحوب:"}),e.jsx("span",{className:"font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:Qa().totalWithdrawn.toFixed(2)})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-blue-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-blue-700",children:"المرسل:"}),e.jsx("span",{className:"font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:Qa().totalSent.toFixed(2)})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-blue-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-blue-700",children:"الأرباح:"}),e.jsx(wd,{userId:t==null?void 0:t.uid})]})]}),Ji&&e.jsx("div",{className:"absolute inset-0 z-20 bg-yellow-100/60 backdrop-blur-sm rounded-xl border border-yellow-300/70 flex items-center justify-center p-0 pointer-events-auto",children:e.jsxs(d,{size:"sm",variant:"ghost",onClick:()=>br(!0),className:"px-2.5 py-1 rounded-full bg-gradient-to-r from-yellow-300 to-yellow-400 text-black hover:from-yellow-400 hover:to-yellow-500 shadow-md flex items-center gap-1 text-[11px] font-semibold",title:"عرض تقارير اليوم (يتطلب الرقم السري)",children:[e.jsx("span",{children:"عرض تقارير اليوم"}),e.jsx(rt,{className:"h-2.5 w-2.5"})]})})]}),e.jsx(As,{open:Ki,onOpenChange:br,mode:"verify",title:"الرقم السري لفتح تقارير اليوم",description:"لا يمكن الاطلاع على تقارير اليوم إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{Fn(!1),br(!1)},userId:t==null?void 0:t.uid})]}),e.jsxs(qe,{className:"bg-white border-2 border-gray-200/50 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 group relative overflow-hidden   transform fade-in-up mb-6",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-emerald-500/5 via-blue-500/5 to-emerald-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-200"}),e.jsx("div",{className:"absolute top-0 left-0 w-40 h-40 bg-gradient-to-br from-emerald-300/10 to-transparent rounded-full -translate-y-20 -translate-x-20 group-hover:scale-150 transition-transform duration-200"}),e.jsx("div",{className:"absolute bottom-0 right-0 w-40 h-40 bg-gradient-to-br from-blue-300/10 to-transparent rounded-full translate-y-20 translate-x-20 group-hover:scale-150 transition-transform duration-200"}),e.jsx(Ge,{className:"p-3 relative z-10",children:e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"bg-emerald-50 border-2 border-emerald-200/50 p-1 rounded-xl shadow-lg hover:shadow-md transition-all duration-200 group/cash relative overflow-hidden ",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-emerald-500/10 to-transparent opacity-0 group-hover/cash:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex items-center justify-between relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-emerald-100 to-emerald-200 rounded-lg shadow-sm",children:e.jsx(Qe,{className:"h-1.5 w-1.5 text-emerald-600"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] font-bold text-emerald-800",children:"الفلوس النقدية"}),e.jsxs("span",{className:"text-[10px] font-extrabold text-emerald-700 bg-gradient-to-r from-emerald-100 to-emerald-200 px-1 py-0.5 rounded-lg shadow-sm",children:[ze.toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(d,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-green-100 to-green-200 text-green-700 hover:from-green-200 hover:to-green-300 hover:text-green-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>za(!0),children:e.jsx(vt,{className:"h-2 w-2"})}),e.jsx(d,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800 rounded-xl transition-all duration-300  hover:rotate-12 shadow-md hover:shadow-lg",onClick:()=>Ya(!0),children:e.jsx(Ot,{className:"h-2 w-2"})})]})]})]}),e.jsxs("div",{className:"bg-blue-50 border-2 border-blue-200/50 p-1 rounded-xl shadow-lg hover:shadow-md transition-all duration-200 group/wallet relative overflow-hidden ",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/10 to-transparent opacity-0 group-hover/wallet:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex items-center justify-between relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-blue-100 to-blue-200 rounded-lg shadow-sm",children:e.jsx(Ht,{className:"h-1.5 w-1.5 text-blue-600"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] font-bold text-blue-800",children:"الأرصدة علي المحافظ"}),e.jsxs("span",{className:"text-[10px] font-extrabold text-blue-700 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-lg shadow-sm",children:[Object.values(be).reduce((s,r)=>s+r,0).toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(d,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-green-100 to-green-200 text-green-700 hover:from-green-200 hover:to-green-300 hover:text-green-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>Ka(!0),title:"إضافة أموال لإجمالي المحفظة",children:e.jsx(vt,{className:"h-2 w-2"})}),e.jsx(d,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800 rounded-xl transition-all duration-300  hover:rotate-12 shadow-md hover:shadow-lg",onClick:()=>{qa(!0),Va("")},title:"تصفير إجمالي المحفظة",children:e.jsx(Ot,{className:"h-2 w-2"})})]})]})]}),e.jsxs("div",{className:"col-span-2 sm:col-span-1 bg-indigo-50 border-2 border-indigo-200/50 p-1 rounded-xl shadow-lg hover:shadow-md transition-all duration-200 group/selwallet relative overflow-hidden ",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-indigo-500/10 to-transparent opacity-0 group-hover/selwallet:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex items-center justify-between relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-indigo-100 to-indigo-200 rounded-lg shadow-sm",children:e.jsx(Ht,{className:"h-1.5 w-1.5 text-indigo-600"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] font-bold text-indigo-800",children:"رصيد المحفظه"}),e.jsxs("span",{className:"text-[10px] font-extrabold text-indigo-700 bg-gradient-to-r from-indigo-100 to-indigo-200 px-1 py-0.5 rounded-lg shadow-sm",children:[(X&&be[X]||0).toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(d,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-green-100 to-green-200 text-green-700 hover:from-green-200 hover:to-green-300 hover:text-green-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>{if(!X){l({title:"اختر محفظة",description:"يرجى اختيار محفظة من اختيار المحافظ بالأعلى أولاً",variant:"destructive"});return}Uo(X)},title:"إضافة/خصم إلى رصيد المحفظة المختارة",children:e.jsx(vt,{className:"h-2 w-2"})}),e.jsx(d,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800 rounded-xl transition-all duration-300  hover:rotate-12 shadow-md hover:shadow-lg",onClick:()=>{if(!X){l({title:"اختر محفظة",description:"يرجى اختيار محفظة لتصفير رصيدها فقط",variant:"destructive"});return}Ba(!0)},title:"تصفير رصيد المحفظة المختارة",children:e.jsx(Ot,{className:"h-2 w-2"})})]})]})]})]})})]}),e.jsxs(qe,{className:"bg-gradient-to-br from-gray-50 via-white to-slate-50 border border-gray-200/60 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 group relative overflow-hidden fade-in-up",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-gray-500/5 to-slate-600/3 opacity-0 group-hover:opacity-100 transition-opacity duration-300"}),e.jsxs(gt,{className:"pb-2 px-4 pt-4 relative z-10",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(kt,{className:"text-sm font-bold flex items-center gap-2 text-gray-800",children:[!z&&e.jsx("div",{className:"p-1.5 sm:p-2 bg-gradient-to-r from-gray-100 to-slate-200 rounded-lg",children:e.jsx(xa,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5 text-gray-600"})}),e.jsx("span",{className:"bg-gradient-to-r from-gray-600 to-slate-600 bg-clip-text text-transparent",children:"المعاملات الأخيرة"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[!z&&e.jsxs("div",{className:"flex items-center gap-0.5 bg-gray-50 rounded px-1 py-0.5 border border-gray-200 hover:border-blue-300 transition-all duration-200 group relative overflow-hidden max-w-[140px] md:max-w-[220px]",children:[e.jsx(vc,{className:"h-2 w-2 text-gray-400 group-hover:text-blue-600 transition-colors"}),e.jsx(R,{placeholder:"بحث...",value:kn,onChange:s=>Ei(s.target.value),className:"h-3 text-[8px] border-0 bg-transparent focus:ring-0 focus:outline-none text-gray-700 placeholder:text-gray-400"})]}),!z&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-green-600 mb-1",children:"شحن"}),e.jsx(d,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-green-50 text-green-600 hover:bg-green-100 border border-green-200 ring-3 ring-green-300 transition-all duration-200 hover:scale-105",onClick:()=>{l({title:"قيد التطوير",description:"هذه الميزة غير متاحة حالياً."})},title:"شحن الرصيد",children:e.jsx(ba,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"حاسبة"}),e.jsx(d,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105",onClick:()=>vr(!0),title:"آلة حاسبة",children:e.jsx(Kl,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"كروت"}),e.jsx(d,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105",onClick:()=>{Pe?l({title:"غير متاح",description:"كروت الائتمان غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):ka(!0)},title:"كروت الائتمان",children:e.jsx(ba,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-blue-600 mb-1",children:"الوردية"}),e.jsx(d,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-blue-50 text-blue-600 hover:bg-blue-100 border border-blue-200 ring-3 ring-blue-300 transition-all duration-200 hover:scale-105",onClick:bo,title:N&&(b!=null&&b.name||b!=null&&b.username)?`بروفيل الوردية: ${(b==null?void 0:b.name)||(b==null?void 0:b.username)}`:"وردية الكاشير",children:e.jsx(pn,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"المبيعات"}),e.jsx(d,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105",onClick:()=>{Pe?l({title:"غير متاح",description:"بيانات المبيعات غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Xs(!0)},title:"بيانات المبيعات",children:e.jsx(wc,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsxs("div",{className:"flex items-center gap-1 mb-1",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600",children:"الديون"}),wt.filter(s=>s.status==="pending").length>0&&e.jsx("span",{className:"h-4 w-4 rounded-full bg-red-600 text-white text-[10px] flex items-center justify-center ring-2 ring-white",children:wt.filter(s=>s.status==="pending").length})]}),e.jsx(d,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105",onClick:()=>{Pe?l({title:"غير متاح",description:"إدارة الديون/الأجل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):ra(!0)},title:"الديون",children:e.jsx(nc,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-amber-700 mb-1",children:"الصيانة"}),e.jsx(d,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-amber-50 text-amber-700 hover:bg-amber-100 border border-amber-200 ring-3 ring-amber-300 transition-all duration-200 hover:scale-105",onClick:()=>{Pe?l({title:"غير متاح",description:"الصيانة غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ta(!0)},title:"الصيانة",children:e.jsx(lc,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-yellow-500 mb-1",children:"المكنة"}),e.jsx(d,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-violet-50 text-violet-700 hover:bg-violet-100 border border-violet-200 ring-3 ring-violet-300 transition-all duration-200 hover:scale-105",onClick:()=>{Kt?Aa(!0):l({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"})},title:"يومية المكنة",children:e.jsx(Yl,{className:"h-5 w-5 text-yellow-500"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-orange-600 mb-1",children:"مصروفات"}),e.jsx(d,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-orange-50 text-orange-600 hover:bg-orange-100 border border-orange-200 ring-3 ring-orange-300 transition-all duration-200 hover:scale-105",onClick:()=>{Pe?l({title:"غير متاح",description:"مصروفات المحل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):is.hasMasterPin()?Y(!0):se(!0)},title:"مصروفات المحل",children:e.jsx(rr,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-rose-600 mb-1",children:"النواقص"}),e.jsx(d,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-rose-50 text-rose-600 hover:bg-rose-100 border border-rose-200 ring-3 ring-rose-300 transition-all duration-200 hover:scale-105",onClick:()=>{Pe?l({title:"غير متاح",description:"النواقص غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):yt(!0)},title:"النواقص",children:e.jsx(ic,{className:"h-5 w-5"})})]})]})]})]}),!z&&e.jsx("div",{className:"mt-2 w-full",children:e.jsxs("div",{className:"flex items-center justify-center gap-3 bg-gray-50 rounded-md p-3 border border-gray-200",children:[e.jsx(d,{variant:"ghost",size:"sm",className:`h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${pt==="send"?"bg-green-600 text-white border-green-600":"text-green-700 border-green-300 hover:bg-green-50"}`,onClick:()=>hr("send"),title:"تصفية التحويل",children:"التحويل"}),e.jsx(d,{variant:"ghost",size:"sm",className:`h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${pt==="withdraw"?"bg-red-600 text-white border-red-600":"text-red-700 border-red-300 hover:bg-red-50"}`,onClick:()=>hr("withdraw"),title:"تصفية السحب",children:"السحب"}),e.jsx(d,{variant:"ghost",size:"sm",className:`h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${pt==="all"?"bg-green-600 text-white border-green-600":"text-green-700 border-green-300 hover:bg-green-50"}`,onClick:()=>hr("all"),title:"عرض الكل",children:"الكل"}),e.jsxs("div",{className:"relative ml-1",children:[e.jsxs(d,{variant:"ghost",size:"sm",className:"h-8 px-3 text-[12px] rounded-full border bg-red-50 text-red-700 border-red-300 hover:bg-red-100",onClick:()=>Mr(!0),title:"تصفير المعاملات الأخيرة",children:[e.jsx(Ot,{className:"h-3.5 w-3.5 mr-1"}),"تصفير"]}),(t==null?void 0:t.uid)&&localStorage.getItem(`recentTransactionsResetAt:${t.uid}`)&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 h-2 w-2 rounded-full bg-red-500 ring-2 ring-white"})]})]})})]}),e.jsx(Ge,{className:"space-y-2 pt-0 px-4 pb-4 relative z-10",children:bl.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(xa,{className:"h-12 w-12 mx-auto mb-2 text-gray-300"}),e.jsx("p",{className:"text-sm",children:"لا توجد معاملات حتى الآن"})]}):e.jsx("div",{className:"max-h-[210px] overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400 transition-colors",children:e.jsx("div",{className:"space-y-2 pr-2",children:bl.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gradient-to-r from-white/70 to-gray-50/70 rounded-lg hover:from-white/90 hover:to-gray-50/90 transition-all duration-300 border border-gray-100/60 cursor-pointer hover:shadow-sm",onClick:()=>Wo(s),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[s.status==="completed"&&e.jsx(Ps,{className:"h-4 w-4 text-green-500"}),s.status==="pending"&&e.jsx(Os,{className:"h-4 w-4 text-yellow-500"}),s.status==="failed"&&e.jsx(yn,{className:"h-4 w-4 text-red-500"})]}),e.jsxs("div",{children:[(()=>{const r=(s==null?void 0:s.type)==="report"||((s==null?void 0:s.title)||"").includes("إيصال تسليم وردية");return e.jsx("p",{className:"font-medium text-sm text-gray-800",children:r?"إيصال تسليم وردية":(s.type==="send"?"تحويل":"سحب")+` - ${s.amount.toLocaleString()} جنيه`})})(),e.jsxs("p",{className:"text-[10px] text-gray-700",children:["تمت بواسطة: ",(s==null?void 0:s.cashierName)??"الحساب الرئيسي"]}),(()=>{const r=(s==null?void 0:s.type)==="report"||((s==null?void 0:s.title)||"").includes("إيصال تسليم وردية");return e.jsx("p",{className:"text-xs text-gray-500",children:r?`تم التسليم إلى: ${s.receiverPhone}`:`من ${s.senderPhone}${s.type==="send"?` إلى ${s.receiverPhone}`:""}`})})(),e.jsxs("p",{className:"text-xs text-gray-400",children:[tn.format(s.createdAt instanceof Date?s.createdAt:new Date(s.createdAt))," - ",Bo.format(s.createdAt instanceof Date?s.createdAt:new Date(s.createdAt))]})]})]}),e.jsx(mt,{variant:s.status==="completed"?"default":s.status==="pending"?"secondary":"destructive",className:"text-xs",children:s.status==="completed"?"مكتمل":s.status==="pending"?"قيد المعالجة":"فشل"})]},s.id))})})})]})]}),e.jsx(Sc,{isOpen:Ii,onClose:()=>Sa(!1),transaction:ki,onPrint:()=>window.print(),onDelete:Wi,onComplete:Fi}),e.jsxs("div",{className:"space-y-1 fade-in-right w-full lg:w-5/6 mx-auto",children:[e.jsxs(qe,{id:"transaction-section",className:"bg-gradient-to-br from-white via-blue-50/30 to-indigo-50/50 border border-blue-200/40 rounded-lg shadow-lg hover:shadow-lg transition-all duration-200 group relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/5 via-indigo-500/3 to-purple-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-200"}),e.jsx("div",{className:"absolute top-0 right-0 w-32 h-32 sm:w-28 sm:h-28 lg:w-20 lg:h-20 bg-gradient-to-bl from-blue-400/10 to-transparent rounded-full  "}),e.jsx("div",{className:"absolute bottom-0 left-0 w-24 h-24 bg-gradient-to-tr from-indigo-400/10 to-transparent rounded-full  ",style:{animationDelay:"1s"}}),e.jsx(gt,{className:"sticky top-0 z-20 bg-white/80 backdrop-blur supports-[backdrop-filter]:bg-white/60 pb-0.5 px-3 pt-1 lg:pt-0.5 lg:pb-0.5 lg:px-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(kt,{className:"text-sm font-bold flex items-center gap-2 text-gray-800",children:[e.jsxs("div",{className:"relative",children:[e.jsx(Ps,{className:"h-1 w-1 text-emerald-500 "}),e.jsx("div",{className:"absolute inset-0 h-1 w-1 bg-emerald-400 rounded-full opacity-20 "})]}),e.jsx("span",{className:"bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent",children:"إجراء معاملة جديدة"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[m&&e.jsx("div",{className:"hidden md:flex items-center gap-1 bg-gradient-to-r from-emerald-50 to-green-50 hover:from-emerald-100 hover:to-green-100 border border-emerald-200 text-emerald-800 text-sm transition-all duration-300 hover:scale-105 h-9 px-3 rounded-xl shadow-sm",children:e.jsxs("span",{className:"text-sm font-semibold whitespace-nowrap",children:["تجربة: ",J," ",J>=3&&J<=10?"ساعات":J===2?"ساعتين":"ساعة"]})}),e.jsxs("div",{className:"hidden md:flex items-center gap-2 bg-gradient-to-r from-gray-50 to-slate-50 hover:from-gray-100 hover:to-slate-100 border border-gray-200 transition-all duration-300 hover:scale-105 h-9 px-3 rounded-xl shadow-sm",children:[e.jsx(ed,{}),e.jsx(Tc,{})]})]}),Ao&&e.jsxs(d,{variant:"outline",size:"sm",className:"hidden flex items-center gap-1.5 sm:gap-2 bg-gradient-to-r from-cyan-50 to-blue-50 hover:from-cyan-100 hover:to-blue-100 border-cyan-200 text-cyan-800 text-xs sm:text-sm transition-all duration-300 hover:scale-105 hover:shadow-lg h-10 sm:h-12 px-4 sm:px-5 rounded-xl min-w-[44px] touch-manipulation",onClick:ml,title:"مزامنة البيانات المحفوظة محلياً مع الخادم",children:[e.jsx(Mc,{className:"h-3.5 w-3.5 sm:h-4 sm:w-4 animate-spin"}),e.jsx("span",{className:"text-xs sm:text-sm font-semibold whitespace-nowrap",children:"مزامنة"})]})]})}),e.jsxs(Ge,{ref:u,className:"space-y-1 px-2 pb-2 relative z-10 transition-transform duration-200 ease-out will-change-transform",style:{transform:o?`translateY(${o}px)`:void 0},onFocusCapture:s=>{const r=s.target;if(!((r==null?void 0:r.id)==="transferExtraFeeInput")){x(0);return}const i=document.getElementById("transferSubmitButton");if(i){const c=i.getBoundingClientRect(),f=window.innerHeight;if(c.bottom>f){const v=c.bottom-f,w=Math.min(v,220);x(-w)}else x(0)}else x(0)},onBlurCapture:s=>{s.currentTarget.contains(s.relatedTarget)||x(0)},children:[e.jsxs("div",{className:"grid grid-cols-2 gap-0.5 p-0.5 bg-gradient-to-r from-gray-50 to-slate-50 rounded-xl border border-gray-200/50 fade-in-up w-full lg:w-5/6 mx-auto ",children:[e.jsxs(d,{variant:te==="transfer"?"default":"ghost",onClick:()=>Ga("transfer"),className:`text-xs font-semibold transition-all duration-300 hover:scale-105 h-7 rounded-lg px-2 ${te==="transfer"?"bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg hover:shadow-md hover:from-blue-600 hover:to-indigo-700":"text-gray-600 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 hover:text-blue-700 hover:border-blue-200"}`,children:[e.jsx(xa,{className:"h-1 w-1 mr-1"}),"تحويل"]}),e.jsxs(d,{variant:te==="withdraw"?"default":"ghost",onClick:()=>Ga("withdraw"),className:`text-xs font-semibold transition-all duration-300 hover:scale-105 h-7 rounded-lg px-2 ${te==="withdraw"?"bg-gradient-to-r from-emerald-500 to-green-600 text-white shadow-lg hover:shadow-md hover:from-emerald-600 hover:to-green-700":"text-gray-600 hover:bg-gradient-to-r hover:from-emerald-50 hover:to-green-50 hover:text-emerald-700 hover:border-emerald-200"}`,children:[e.jsx(lr,{className:"h-1 w-1 mr-1"}),"سحب"]})]}),e.jsxs("div",{className:"fade-in-up",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("label",{className:"text-sm font-semibold text-gray-700 block flex items-center gap-2",children:[e.jsx(Ht,{className:"h-1 w-1 text-blue-600"}),"اختيار المحفظة"]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsxs(d,{variant:"ghost",size:"sm",className:"h-6 rounded-md px-2 text-[10px] bg-emerald-50 text-emerald-700 hover:bg-emerald-100 border border-emerald-200",onClick:()=>h("/user/add-wallet"),title:"إضافة محفظة",children:[e.jsx(vt,{className:"h-3 w-3 mr-1"}),"إضافة محفظة"]}),e.jsxs(d,{variant:"ghost",size:"sm",className:"h-6 rounded-md px-2 text-[10px] bg-indigo-50 text-indigo-700 hover:bg-indigo-100 border border-indigo-200",onClick:()=>Ms(!0),title:"المحافظ",children:[e.jsx(Ht,{className:"h-3 w-3 mr-1"}),"المحافظ"]})]})]}),ye.length>0?e.jsxs(ws,{value:X,onValueChange:Oo,children:[e.jsx(Ss,{"data-testid":"wallet-select",className:"w-full h-12 text-sm bg-gradient-to-r from-white to-gray-50 border-2 border-gray-200 hover:border-blue-400 focus:border-blue-500 rounded-xl transition-all duration-300 hover:shadow-md focus:shadow-lg",children:e.jsx(Ds,{placeholder:"اختر محفظة للمعاملة",className:"text-gray-600"})}),e.jsxs(Cs,{className:"rounded-xl border-2 border-gray-200 shadow-md z-[9999]",children:[e.jsx("div",{"data-fixed-header":"true",className:"sticky top-0 z-10 bg-white p-2 border-b border-gray-200",children:e.jsx(R,{value:Nn,onChange:s=>Si(s.target.value),placeholder:"ابحث برقم المحفظة",className:"h-6 text-xs"})}),e.jsx("div",{className:"pr-1",children:wn.length===0?e.jsx("div",{className:"text-xs text-gray-500 p-2",children:"لا توجد نتائج مطابقة"}):wn.map(s=>e.jsx(Vt,{value:s.id,className:"rounded-lg hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 transition-all duration-200",children:e.jsxs("div",{className:"flex items-center gap-1 py-1 w-full justify-between",children:[e.jsx("div",{className:"p-1 bg-gradient-to-r from-blue-100 to-indigo-100 rounded-lg",children:e.jsx(Ht,{className:"h-1 w-1 text-blue-600"})}),e.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-sm font-medium text-gray-800",children:s.name}),e.jsxs("span",{className:"text-[10px] text-gray-500",children:["(",s.phone,")"]})]}),s.isDefault&&e.jsx(mt,{variant:"secondary",className:"text-[10px] bg-gradient-to-r from-emerald-100 to-green-100 text-emerald-700 border-emerald-200",children:"افتراضي"})]}),e.jsx("div",{className:"ml-auto flex flex-col items-end gap-1"})]})},s.id))})]})]}):e.jsx("div",{className:"rounded-xl border-2 border-dashed border-gray-200 bg-gray-50 px-3 py-3 text-xs text-gray-600",children:"لا توجد محافظ حتى الآن. اضغط “إضافة محفظة” لإضافة أول محفظة."})]}),e.jsx(ie,{open:dr,onOpenChange:Ms,children:e.jsxs(oe,{className:"sm:max-w-3xl w-[95vw] sm:w-auto max-h-[80vh] overflow-y-auto",children:[e.jsx(ce,{children:e.jsx(de,{children:"عرض المحافظ"})}),e.jsx("div",{className:"mt-2",children:e.jsx(kc,{showAddButton:!1,showUsageBars:!1,showLimitCards:!1,showEditButton:!0})})]})}),X&&ye.length>0&&(()=>{const s=ye.find(we=>we.id===X),r=fl(X),n=Eo(X),i=(Re==null?void 0:Re.monthlyWithdrawLimit)??(s==null?void 0:s.monthlyWithdrawalLimit)??2e5,c=(Re==null?void 0:Re.monthlyTransferLimit)??(s==null?void 0:s.monthlyTransferLimit)??2e5,f=r.totalWithdrawn??(Re==null?void 0:Re.monthlyWithdrawUsed)??0,v=r.totalTransferred??(Re==null?void 0:Re.monthlyTransferUsed)??0,w=(Re==null?void 0:Re.dailyWithdrawLimit)??1e5,B=(Re==null?void 0:Re.dailyTransferLimit)??6e4,A=n.totalWithdrawn??(Re==null?void 0:Re.dailyWithdrawUsed)??0,S=n.totalTransferred??(Re==null?void 0:Re.dailyTransferUsed)??0,F=parseFloat(We||"0")||0,Q=f+(te==="withdraw"?F:0),P=v+(te==="transfer"?F:0),H=A+(te==="withdraw"?F:0),_e=S+(te==="transfer"?F:0);return s?e.jsxs("div",{className:"fade-in-up mb-2 space-y-2",children:[e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-1 rounded-md border border-gray-200 shadow-sm hover:shadow-md transition-all duration-300",children:[e.jsxs("div",{className:"text-[10px] text-gray-600 font-medium mb-1 text-center",children:["الحدود الشهرية: ",s.name]}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-red-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-red-400 to-red-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(Q/Math.max(i,1)*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-blue-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-400 to-blue-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(P/Math.max(c,1)*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-[10px] text-red-600 font-medium",children:["متبقي سحب: ",Math.max(i-Q,0).toLocaleString("en-US")," جنيه"]}),e.jsxs("div",{className:"text-[10px] text-blue-600 font-medium",children:["متبقي تحويل: ",Math.max(c-P,0).toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-1 rounded-md border border-gray-200 shadow-sm hover:shadow-md transition-all duration-300",children:[e.jsxs("div",{className:"text-[10px] text-gray-600 font-medium mb-1 text-center",children:["الحدود اليومية: ",s.name]}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-orange-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-orange-400 to-orange-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(H/Math.max(w,1)*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-green-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-green-400 to-green-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(_e/Math.max(B,1)*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-[10px] text-orange-600 font-medium",children:["متبقي سحب يومي: ",Math.max(w-H,0).toLocaleString("en-US")," جنيه"]}),e.jsxs("div",{className:"text-[10px] text-green-600 font-medium",children:["متبقي تحويل يومي: ",Math.max(B-_e,0).toLocaleString("en-US")," جنيه"]})]})]})]}):null})(),te==="transfer"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المرسل"}),e.jsxs("div",{className:"relative",children:[e.jsx(cs,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(R,{value:je,onChange:s=>De(s.target.value),onKeyDown:s=>{if(s.key==="Enter"){const r=document.getElementById("receiverPhoneInput");if(r)r.focus();else{const n=document.getElementById("amountInput");n==null||n.focus()}}},placeholder:"01030302038",className:"pl-10 h-10 text-sm transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]})]}),!D&&e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المستقبل"}),e.jsxs("div",{className:"relative",children:[e.jsx(cs,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(R,{id:"receiverPhoneInput",value:Ue,onChange:s=>{et(s.target.value),gr&&Rs(!1)},onKeyDown:s=>{if(s.key==="Enter"){const r=document.getElementById("amountInput");r==null||r.focus()}},inputMode:"numeric",maxLength:11,placeholder:"أدخل رقم المستقبل",className:"pl-10 h-10 text-sm transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المستقبل"}),e.jsxs("div",{className:"relative",children:[e.jsx(cs,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(R,{value:X&&((yl=ye.find(s=>s.id===X))==null?void 0:yl.phone)||"",readOnly:!0,placeholder:"اختر محفظة أولاً",className:"pl-10 h-10 text-sm bg-gray-50 transition-all duration-300"})]})]}),te==="transfer"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"المبلغ (جنيه)"}),e.jsxs("div",{className:"relative flex items-center gap-2",children:[e.jsx(Qe,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(R,{id:"amountInput",value:We,onChange:s=>{_t(s.target.value),gr&&Rs(!1)},onKeyDown:s=>{if(s.key==="Enter"){const r=document.getElementById("transferCommissionInput");if(r)r.focus();else{const n=document.getElementById("quickDebtButton");n==null||n.focus()}}},placeholder:"أدخل المبلغ",type:"number",className:"pl-10 h-10 text-sm transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),At?e.jsxs("div",{className:"mt-2 text-xs text-green-700 bg-green-50 border border-green-200 rounded px-2 py-1 flex items-center gap-2",children:[e.jsxs("span",{children:["تم إدخال تفاصيل الأجل لـ ",At.debtorName," بمبلغ ",At.amount," جنيه"]}),e.jsx(d,{type:"button",variant:"ghost",size:"sm",className:"h-6 px-2",onClick:()=>Zs(null),children:"إلغاء"})]}):null]}),(()=>{if(D)return null;const s=hs();return s&&s.defaultTransferCommission!=null?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة التحويل (تلقائية)"}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["سيتم تطبيق عمولة التحويل الافتراضية لكل ألف: ",s==null?void 0:s.defaultTransferCommission," جنيه لكل ألف"]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(d,{id:"quickDebtButton",type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const n=hs(),i=(n==null?void 0:n.defaultTransferCommission)!=null?Number(n.defaultTransferCommission):0,c=parseFloat(We||"0")||0,f=Math.round((i||0)*c/1e3*100)/100,v=c+f;Xt((v||0).toString()),Pe?l({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ft(!0)},children:"أجل"}),e.jsx(d,{type:"button",variant:"outline",size:"icon",className:"hidden",title:Ne?"العمولة تُضاف":"العمولة تُخصم",children:Ne?e.jsx(vt,{className:"h-4 w-4 text-green-600"}):e.jsx(Ts,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"hidden",children:Ne?"العمولة تُضاف":"العمولة تُخصم"})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة التحويل على العملية (جنيه)"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(Qe,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-orange-500"}),e.jsx(R,{id:"transferCommissionInput",value:Ae,onChange:n=>Ye(n.target.value),placeholder:"أدخل عمولة التحويل",type:"number",className:"pl-10 h-10 text-sm transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),e.jsx(d,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const n=hs(),i=parseFloat(We||"0")||0;let c=0;if((n==null?void 0:n.defaultTransferCommission)!=null){const v=Number(n.defaultTransferCommission)||0;c=Math.round(v*i/1e3*100)/100}else{const v=Ae&&Ae.trim()!==""?parseFloat(Ae):0;c=Math.max(0,v)}const f=i+c;Xt((f||0).toString()),Pe?l({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ft(!0)},children:"أجل"}),e.jsx(d,{type:"button",variant:"outline",size:"icon",className:"hidden",title:Ne?"العمولة تُضاف":"العمولة تُخصم",children:Ne?e.jsx(vt,{className:"h-4 w-4 text-green-600"}):e.jsx(Ts,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"hidden",children:Ne?"العمولة تُضاف":"العمولة تُخصم"})]}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"يمكنك إدخال عمولة العملية الإجمالية (اختياري)"})]})})(),(()=>{const s=xt(je||"").replace(/\D/g,""),r=xt(Ue||"").replace(/\D/g,"");return te==="transfer"&&(s.startsWith("010")&&(r.startsWith("011")||r.startsWith("012")||r.startsWith("015"))||s.startsWith("012")&&r.startsWith("010")||s.startsWith("011")&&r.startsWith("010")||s.startsWith("015")&&r.startsWith("010"))?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رسوم التحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Qe,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-orange-500"}),e.jsx(R,{id:"transferExtraFeeInput",value:Lt,onChange:i=>zt(i.target.value),placeholder:"أدخل رسوم التحويل",type:"number",className:"pl-10 h-10 text-sm transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),e.jsx("div",{className:"hidden",children:"تُخصم من المحفظة وتضاف للدرج — لعمليات 010 → 011/012/015 أو 012 → 010 أو 011 → 010 أو 015 → 010"})]}):null})(),e.jsx("div",{className:"sticky bottom-0 z-10 pt-2 bg-white/80 backdrop-blur supports-[backdrop-filter]:bg-white/60",children:e.jsx(d,{id:"transferSubmitButton",onClick:vl,className:"w-full font-medium h-10 text-sm btn-bounce hover-glow transition-all duration-300 bg-blue-600 hover:bg-blue-700 text-white",children:gr?"تم التحويل بنجاح":"تأكيد التحويل"})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"مبلغ السحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(lr,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-green-500"}),e.jsx(R,{id:"amountInput",value:We,onChange:s=>{_t(s.target.value),On&&sa(!1)},onKeyDown:s=>{if(s.key==="Enter"){const r=document.getElementById("manualWithdrawCommissionInput");if(r)r.focus();else{const n=document.getElementById("withdrawSubmitButton");n==null||n.focus()}}},placeholder:"أدخل مبلغ السحب",type:"number",className:"pl-10 h-10 text-sm transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]})]}),(()=>{const s=hs();return s&&s.defaultWithdrawCommission!=null?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة السحب (تلقائية)"}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["سيتم تطبيق عمولة السحب الافتراضية لكل ألف: ",s==null?void 0:s.defaultWithdrawCommission," جنيه لكل ألف"]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(d,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const n=hs(),i=parseFloat(We||"0")||0,c=(n==null?void 0:n.defaultWithdrawCommission)!=null&&Number(n.defaultWithdrawCommission)||0,f=Math.round(c*i/1e3*100)/100,v=Ne?i+f:i;Xt((v||0).toString()),Pe?l({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ft(!0)},children:"أجل"}),e.jsx(d,{type:"button",variant:"outline",size:"icon",className:"h-8 w-8",onClick:()=>$s(n=>!n),title:Ne?"العمولة تُضاف إلى الدين":"العمولة تُخصم من الدين",children:Ne?e.jsx(vt,{className:"h-4 w-4"}):e.jsx(Ts,{className:"h-4 w-4"})}),e.jsx("span",{className:"text-xs text-gray-600",children:Ne?"العمولة تُضاف":"العمولة تُخصم"})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة السحب على العملية (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Qe,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-orange-500"}),e.jsx(R,{id:"manualWithdrawCommissionInput",value:C,onChange:n=>he(n.target.value),onKeyDown:n=>{if(n.key==="Enter"){const i=document.getElementById("withdrawSubmitButton");i==null||i.focus()}},placeholder:"أدخل العمولة المطلوبة",type:"number",className:"pl-10 h-10 text-sm transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"أدخل العمولة الإجمالية لإتمام عملية السحب"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(d,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const n=hs(),i=parseFloat(We||"0")||0;let c=0;if((n==null?void 0:n.defaultWithdrawCommission)!=null){const v=Number(n.defaultWithdrawCommission)||0;c=Math.round(v*i/1e3*100)/100}else{const v=C&&C.trim()!==""?parseFloat(C):Math.round(i*.01*100)/100;c=Math.max(0,v)}const f=Ne?i+c:i;Xt((f||0).toString()),Pe?l({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ft(!0)},children:"أجل"}),e.jsx(d,{type:"button",variant:"outline",size:"icon",title:Ne?"العمولة تُضاف":"العمولة تُخصم",onClick:()=>$s(n=>!n),children:Ne?e.jsx(vt,{className:"h-4 w-4 text-green-600"}):e.jsx(Ts,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"text-xs text-gray-600",children:Ne?"العمولة تُضاف":"العمولة تُخصم"})]})]})})(),e.jsx("div",{className:"sticky bottom-0 z-10 pt-2 bg-white/80 backdrop-blur supports-[backdrop-filter]:bg-white/60",children:e.jsx(d,{id:"withdrawSubmitButton",onClick:vl,className:"w-full font-medium h-10 text-sm btn-bounce hover-glow transition-all duration-300 bg-green-600 hover:bg-green-700 text-white",children:On?"تم السحب بنجاح":"تأكيد السحب"})})]}),e.jsx(ie,{open:Zt,onOpenChange:Ft,children:e.jsxs(oe,{children:[e.jsxs(ce,{children:[e.jsx(de,{children:"تحويل مؤجل"}),e.jsx(Rt,{children:"أدخل بيانات صاحب الدين والمبلغ والملاحظات ثم اضغط حفظ"})]}),e.jsxs("div",{className:"space-y-3",children:[ts&&ts.length>0?e.jsxs("div",{children:[e.jsx(V,{children:"اختيار عميل"}),e.jsxs(ws,{value:Qs,onValueChange:s=>{Ls(s);const r=ts.find(n=>n.id===s);r&&vs(r.name)},children:[e.jsx(Ss,{className:"w-full",children:e.jsx(Ds,{placeholder:"اختر عميل"})}),e.jsx(Cs,{children:ts.map(s=>e.jsxs(Vt,{value:s.id,children:[s.name,s.mobile?` — ${s.mobile}`:""]},s.id))})]})]}):e.jsx("div",{className:"text-xs text-gray-500",children:"لا يوجد عملاء مُسجلين حالياً. يمكنك إضافة عميل من نافذة الديون."}),e.jsxs("div",{children:[e.jsx(V,{htmlFor:"quickDebtName",children:"اسم صاحب الدين"}),e.jsx(R,{id:"quickDebtName",value:fs,onChange:s=>vs(s.target.value),placeholder:"اكتب الاسم"})]}),e.jsxs("div",{children:[e.jsx(V,{htmlFor:"quickDebtAmount",children:"المبلغ (محسوب تلقائياً)"}),e.jsx(R,{id:"quickDebtAmount",type:"number",value:ut,readOnly:!0,placeholder:"المبلغ + عمولة التحويل"})]}),e.jsxs("div",{children:[e.jsx(V,{htmlFor:"quickDebtNotes",children:"ملاحظات"}),e.jsx(R,{id:"quickDebtNotes",value:ja,onChange:s=>Bs(s.target.value),placeholder:"اكتب ملاحظات (اختياري)"})]})]}),e.jsx(Ce,{children:e.jsx(d,{type:"button",onClick:()=>{const s=hs(),r=parseFloat((We||"").toString())||0;let n=0;if(te==="transfer")if((s==null?void 0:s.defaultTransferCommission)!=null){const f=Number(s.defaultTransferCommission)||0;n=Math.round(f*r/1e3*100)/100}else{const f=Ae&&Ae.trim()!==""?parseFloat(Ae):0;n=Math.max(0,f)}else if((s==null?void 0:s.defaultWithdrawCommission)!=null){const f=Number(s.defaultWithdrawCommission)||0;n=Math.round(f*r/1e3*100)/100}else{const f=C&&C.trim()!==""?parseFloat(C):Math.round(r*.01*100)/100;n=Math.max(0,f)}let i=0;if(te==="withdraw"?i=Ne?r:Math.max(0,Math.round((r-n)*100)/100):i=Math.max(0,Math.round((r+n)*100)/100),!fs||isNaN(i)||i<=0){l({title:"خطأ في بيانات الأجل",description:"يرجى إدخال الاسم والمبلغ بشكل صحيح",variant:"destructive"});return}const c=ts.find(f=>f.id===Qs);Zs({debtorName:fs,amount:i,notes:ja,customerId:Qs||void 0,mobile:c==null?void 0:c.mobile}),Na(!1),Ft(!1),l({title:"تم حفظ بيانات الأجل",description:"سيتم إضافة الدين عند تأكيد العملية",variant:"default"})},children:"حفظ"})})]})})]})]}),e.jsx(qe,{className:"bg-gradient-to-br from-red-50 to-red-100 border-red-200 fade-in-up card-float",children:e.jsxs(Ge,{className:"p-3 text-center",children:[e.jsx("div",{className:"text-red-600 font-medium text-[10px] mb-1",children:"⚠️ تحذير من التحويل"}),e.jsx("div",{className:"text-[10px] text-red-700",children:"لا يمكن إلغاء أي عملية بعد تأكيدها للمحافظة على الأمان"})]})})]})]}),e.jsx(Vc,{isOpen:ji,onClose:()=>Ni(!1),initialEditingWallet:wi,onWalletUpdate:async()=>{try{await Ha()}catch(s){console.error("Error reloading wallets after update:",s)}}}),e.jsx(Yc,{isOpen:Ci,onClose:()=>Sn(!1),transaction:Di,onDelete:Fo}),e.jsx(ln,{open:Ai,onOpenChange:ta,onSuccess:Mo,title:$o(),description:Ro()}),e.jsx(ln,{open:Oi,onOpenChange:pr,onSuccess:()=>{pr(!1),Cn(!0)},title:"حماية أرشيف التقارير اليومية",description:"أدخل كلمة مرور تسجيل الدخول للوصول إلى الأرشيف"}),e.jsx(Sd,{open:Pi,onOpenChange:Cn,userId:t==null?void 0:t.uid}),e.jsx(Il,{open:lo,onOpenChange:Kn,onSuccess:_o,title:"تعديل الرصيد النقدي في الدرج",description:"أدخل الرقم السري والمبلغ الجديد لتعديل الرصيد النقدي في الدرج",currentBalance:ze,balanceLabel:"الرصيد النقدي",userId:t==null?void 0:t.uid}),e.jsx(Il,{open:io,onOpenChange:qn,onSuccess:zo,title:"تعديل رصيد المحفظة",description:"أدخل الرقم السري والمبلغ الجديد لتعديل رصيد المحفظة",currentBalance:Ct&&be[Ct]||0,balanceLabel:`رصيد ${((jl=ye.find(s=>s.id===Ct))==null?void 0:jl.name)||"المحفظة"}`,userId:t==null?void 0:t.uid}),e.jsx(Zc,{open:oo,onOpenChange:Br,onSuccess:Jo,title:"إضافة أو خصم مبلغ من رصيد المحفظة",description:"أدخل الرقم السري والمبلغ المراد إضافته أو خصمه من رصيد المحفظة",currentBalance:Ct&&be[Ct]||0,balanceLabel:`رصيد ${((Nl=ye.find(s=>s.id===Ct))==null?void 0:Nl.name)||"المحفظة"}`,userId:t==null?void 0:t.uid}),e.jsx(Hc,{open:yo,onOpenChange:jo,userId:t==null?void 0:t.uid}),e.jsx(Gc,{open:No,onOpenChange:wo,userId:t==null?void 0:t.uid}),e.jsx(Qc,{open:So,onOpenChange:Do}),e.jsx(ie,{open:ho,onOpenChange:La,children:e.jsxs(oe,{className:"sm:max-w-md",children:[e.jsx(ce,{children:e.jsx(de,{className:"text-right",children:"تعديل الدرج النقدية"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(V,{htmlFor:"amount",className:"text-right block",children:"المبلغ"}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx(R,{id:"amount",type:"number",placeholder:"أدخل المبلغ",value:$r,onChange:s=>Ma(s.target.value),className:"text-right flex-1",dir:"rtl",min:"0"}),e.jsxs("div",{className:"flex gap-1",children:[e.jsxs(d,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white px-3 py-2",onClick:()=>{if(!Xr(Jr)){l({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}const s=parseFloat($r);if(isNaN(s)||s<=0){l({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const r=ze+s;lt(r);const n={cashBalance:r,lastUpdated:new Date().toISOString()},i=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(i,JSON.stringify(n)),t!=null&&t.uid?Se.updateUserData(t.uid,n).then(()=>{console.log("✅ تم حفظ رصيد الدرج النقدي في Firebase بنجاح"),localStorage.removeItem(i),fe(!1)}).catch(c=>{console.error("❌ خطأ في حفظ الرصيد في Firebase:",c),fe(!0)}):fe(!0),l({title:"تم بنجاح",description:`تم إضافة ${s} جنيه إلى الدرج النقدية وحفظه في السحابة`}),La(!1),Ma(""),_a("")},children:[e.jsx(vt,{className:"h-1 w-1 mr-1"}),"إضافة"]}),e.jsxs(d,{type:"button",size:"sm",className:"bg-red-600 hover:bg-red-700 text-white px-3 py-2",onClick:()=>{if(!Xr(Jr)){l({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}const s=parseFloat($r);if(isNaN(s)||s<=0){l({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const r=ze-s;lt(r);const n={cashBalance:r,lastUpdated:new Date().toISOString()},i=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(i,JSON.stringify(n)),t!=null&&t.uid?Se.updateUserData(t.uid,n).then(()=>{console.log("✅ تم حفظ رصيد الدرج النقدي في Firebase بنجاح"),localStorage.removeItem(i),fe(!1)}).catch(c=>{console.error("❌ خطأ في حفظ الرصيد في Firebase:",c),fe(!0)}):fe(!0),l({title:"تم بنجاح",description:`تم خصم ${s} جنيه من الدرج النقدية وحفظه في السحابة`}),La(!1),Ma(""),_a("")},children:[e.jsx(Ts,{className:"h-1 w-1 mr-1"}),"خصم"]})]})]}),e.jsxs("p",{className:"text-[10px] text-gray-500 text-right",children:["الرصيد الحالي: ",ze.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(V,{htmlFor:"pin",className:"text-right block",children:"الرقم السري"}),e.jsx(R,{id:"pin",type:"password",placeholder:"أدخل الرقم السري",value:Jr,onChange:s=>_a(s.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsx(Ce,{className:"flex gap-2",children:e.jsx(d,{variant:"outline",onClick:()=>{La(!1),Ma(""),_a("")},children:"إلغاء"})})]})}),e.jsx(ie,{open:ko,onOpenChange:qa,children:e.jsxs(oe,{className:"sm:max-w-md",children:[e.jsx(ce,{children:e.jsx(de,{className:"text-right text-red-600",children:"تصفير إجمالي المحفظة"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-red-50 rounded-lg border border-red-200",children:[e.jsx("p",{className:"text-red-800 font-medium mb-2",children:"تحذير!"}),e.jsx("p",{className:"text-red-700 text-sm",children:"سيتم تصفير جميع أرصدة المحافظ إلى صفر. هذا الإجراء لا يمكن التراجع عنه."}),e.jsxs("p",{className:"text-red-600 text-sm mt-2",children:["الرصيد الحالي: ",Object.values(be).reduce((s,r)=>s+r,0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(V,{htmlFor:"resetWalletTotalPin",className:"text-right block",children:"كلمة مرور تسجيل الدخول"}),e.jsx(R,{id:"resetWalletTotalPin",type:"password",placeholder:"أدخل كلمة مرور تسجيل الدخول",value:pl,onChange:s=>Va(s.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsxs(Ce,{className:"flex gap-2",children:[e.jsx(d,{variant:"outline",onClick:()=>{qa(!1),Va("")},children:"إلغاء"}),e.jsx(d,{variant:"destructive",onClick:async()=>{if(!await en(pl)){l({title:"خطأ",description:"كلمة المرور غير صحيحة",variant:"destructive"});return}try{const r={};Object.keys(be).forEach(f=>{r[f]=0}),Je(r),localStorage.setItem(tt(),JSON.stringify(r)),qa(!1),Va("");const n=new Date().toISOString(),i={walletBalances:r,lastUpdated:n},c=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(c,JSON.stringify(i)),t!=null&&t.uid?Se.updateUserData(t.uid,i).then(()=>{localStorage.removeItem(c),fe(!1)}).catch(f=>{console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",f),fe(!0),l({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):fe(!0),setTimeout(()=>{Je({...r})},100)}catch(r){console.error("خطأ في تصفير أرصدة المحافظ:",r),l({title:"خطأ",description:"حدث خطأ أثناء تصفير المحافظ",variant:"destructive"})}},children:"تصفير المحفظة"})]})]})}),e.jsx(ie,{open:co,onOpenChange:Ba,children:e.jsxs(oe,{className:"sm:max-w-md",children:[e.jsx(ce,{children:e.jsx(de,{className:"text-right text-red-600",children:"تصفير رصيد المحفظة المختارة"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-red-50 rounded-lg border border-red-200",children:[e.jsx("p",{className:"text-red-800 font-medium mb-2",children:"تحذير!"}),e.jsx("p",{className:"text-red-700 text-sm",children:"سيتم تصفير رصيد المحفظة المحددة إلى صفر. هذا الإجراء لا يمكن التراجع عنه."}),e.jsxs("p",{className:"text-red-600 text-sm mt-2",children:["المحفظة: ",((wl=ye.find(s=>s.id===X))==null?void 0:wl.name)||X]}),e.jsxs("p",{className:"text-red-600 text-sm",children:["الرصيد الحالي: ",(X&&be[X]?be[X]:0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(V,{htmlFor:"resetSelectedWalletPin",className:"text-right block",children:"كلمة مرور تسجيل الدخول"}),e.jsx(R,{id:"resetSelectedWalletPin",type:"password",autoComplete:"off",placeholder:"أدخل كلمة مرور تسجيل الدخول",value:Vn,onChange:s=>Lr(s.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsxs(Ce,{className:"flex gap-2",children:[e.jsx(d,{variant:"outline",onClick:()=>{Ba(!1),Lr("")},children:"إلغاء"}),e.jsx(d,{variant:"destructive",onClick:async()=>{var r;if(!X){l({title:"اختر محفظة",description:"يرجى اختيار محفظة أولاً",variant:"destructive"});return}if(!await en(Vn)){l({title:"خطأ",description:"كلمة المرور غير صحيحة",variant:"destructive"});return}try{const n={...be};n[X]=0,Je(n),localStorage.setItem(tt(),JSON.stringify(n)),Ba(!1),Lr("");const i=new Date().toISOString(),c={walletBalances:n,lastUpdated:i},f=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(f,JSON.stringify(c)),t!=null&&t.uid?Se.updateUserData(t.uid,c).then(()=>{localStorage.removeItem(f),fe(!1)}).catch(v=>{console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",v),fe(!0),l({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):fe(!0),l({title:"تم التصفير بنجاح",description:`تم تصفير رصيد المحفظة ${((r=ye.find(v=>v.id===X))==null?void 0:r.name)||X}`})}catch(n){console.error("خطأ في تصفير رصيد المحفظة المختارة:",n),l({title:"خطأ",description:"حدث خطأ أثناء تصفير رصيد المحفظة المختارة",variant:"destructive"})}},children:"تصفير المحفظة"})]})]})}),e.jsx(ie,{open:Io,onOpenChange:Ka,children:e.jsxs(oe,{className:"sm:max-w-md",children:[e.jsx(ce,{children:e.jsxs(de,{className:"text-right text-green-600 flex items-center gap-2 justify-end",children:[e.jsx(vt,{className:"h-4 w-4"}),"إضافة أموال لإجمالي المحفظة"]})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-green-50 rounded-lg border border-green-200",children:[e.jsx("p",{className:"text-green-800 font-medium mb-2",children:"إضافة أموال"}),e.jsx("p",{className:"text-green-700 text-sm",children:"سيتم إضافة المبلغ المحدد إلى إجمالي المحفظة بشكل متناسب على جميع المحافظ."}),e.jsxs("p",{className:"text-green-600 text-sm mt-2",children:["الرصيد الحالي: ",Object.values(be).reduce((s,r)=>s+r,0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"addWalletTotalAmount",className:"text-right block",children:"المبلغ المراد إضافته"}),e.jsx(R,{id:"addWalletTotalAmount",type:"number",placeholder:"أدخل المبلغ",value:il,onChange:s=>Yr(s.target.value),className:"text-right",dir:"rtl"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"addWalletTotalPin",className:"text-right block",children:"الرقم السري للتأكيد"}),e.jsx(R,{id:"addWalletTotalPin",type:"password",autoComplete:"off",placeholder:"أدخل الرقم السري",value:ol,onChange:s=>Hr(s.target.value),className:"text-right",dir:"rtl"})]})]})]}),e.jsxs(Ce,{className:"flex gap-2",children:[e.jsx(d,{variant:"outline",onClick:()=>{Ka(!1),Yr(""),Hr("")},children:"إلغاء"}),e.jsx(d,{variant:"default",className:"bg-green-600 hover:bg-green-700",disabled:cl,onClick:async()=>{const s=parseFloat(il);if(!s||s<=0){l({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}if(!Po(ol)){l({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}dl(!0);try{const r=Object.values(be).reduce((n,i)=>n+i,0);if(r===0){const n=Object.keys(be),i=s/n.length,c={};n.forEach(f=>{c[f]=i}),Je(c),localStorage.setItem(tt(),JSON.stringify(c)),t!=null&&t.uid?await Se.updateUserData(t.uid,{walletBalances:c,lastUpdated:new Date().toISOString()}):fe(!0)}else{const n={};Object.entries(be).forEach(([i,c])=>{const f=c/r,v=s*f;n[i]=c+v}),Je(n),localStorage.setItem(tt(),JSON.stringify(n)),t!=null&&t.uid?await Se.updateUserData(t.uid,{walletBalances:n,lastUpdated:new Date().toISOString()}):fe(!0)}setTimeout(()=>{Je(n=>({...n}))},100),Ka(!1),Yr(""),Hr("")}catch(r){console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",r),l({title:"خطأ",description:"حدث خطأ أثناء حفظ البيانات",variant:"destructive"})}finally{dl(!1)}},children:cl?"جاري الإضافة...":"إضافة الأموال"})]})]})}),e.jsx(ie,{open:To,onOpenChange:Ya,children:e.jsxs(oe,{className:"sm:max-w-[425px]",children:[e.jsx(ce,{children:e.jsxs(de,{className:"text-red-600 flex items-center gap-2",children:[e.jsx(Ot,{className:"h-1 w-1"}),"تصفير الرصيد النقدي"]})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-3",children:e.jsx("p",{className:"text-sm text-red-700",children:"⚠️ تحذير: سيتم تصفير الرصيد النقدي في الدرج إلى صفر. هذا الإجراء لا يمكن التراجع عنه."})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(V,{htmlFor:"resetCashPin",children:"كلمة مرور تسجيل الدخول"}),e.jsx(R,{id:"resetCashPin",type:"password",autoComplete:"off",placeholder:"أدخل كلمة مرور تسجيل الدخول",value:Qr,onChange:s=>Zr(s.target.value)})]})]}),e.jsxs(Ce,{children:[e.jsx(d,{variant:"outline",onClick:()=>{Ya(!1),Zr("")},children:"إلغاء"}),e.jsx(d,{variant:"destructive",onClick:async()=>{if(!Qr){l({title:"خطأ",description:"يرجى إدخال كلمة المرور",variant:"destructive"});return}if(!await en(Qr)){l({title:"خطأ",description:"كلمة المرور غير صحيحة",variant:"destructive"});return}try{lt(0),Ya(!1),Zr("");const r={cashBalance:0,lastUpdated:new Date().toISOString()};localStorage.setItem(st(),"0");const n=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(n,JSON.stringify(r)),t!=null&&t.uid?Se.updateUserData(t.uid,r).then(()=>{localStorage.removeItem(n),fe(!1)}).catch(i=>{console.error("خطأ في حفظ الرصيد في Firebase:",i),fe(!0),l({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):fe(!0)}catch(r){console.error("خطأ في تصفير الرصيد النقدي:",r),l({title:"خطأ",description:"حدث خطأ أثناء تصفير الرصيد النقدي",variant:"destructive"})}},children:"تصفير الرصيد"})]})]})}),e.jsx(ie,{open:Co,onOpenChange:za,children:e.jsxs(oe,{className:"sm:max-w-[425px]",children:[e.jsx(ce,{children:e.jsxs(de,{className:"text-green-600 flex items-center gap-2",children:[e.jsx(vt,{className:"h-4 w-4"}),"إضافة أموال للدرج"]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-3",children:e.jsx("p",{className:"text-sm text-green-700",children:"💰 سيتم إضافة المبلغ المحدد إلى الرصيد النقدي في الدرج"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"addCashAmount",children:"المبلغ المراد إضافته"}),e.jsx(R,{id:"addCashAmount",type:"number",placeholder:"أدخل المبلغ",value:Ja,onChange:s=>Kr(s.target.value),min:"0",step:"0.01"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"addCashPin",children:"الرقم السري لدرج النقدية"}),e.jsx(R,{id:"addCashPin",type:"password",placeholder:"أدخل الرقم السري",value:qr,onChange:s=>Vr(s.target.value)})]})]}),e.jsxs(Ce,{children:[e.jsx(d,{variant:"outline",onClick:()=>{za(!1),Kr(""),Vr("")},children:"إلغاء"}),e.jsx(d,{variant:"default",className:"bg-green-600 hover:bg-green-700",disabled:nl,onClick:async()=>{if(!Ja||parseFloat(Ja)<=0){l({title:"خطأ",description:"يرجى إدخال مبلغ صحيح أكبر من صفر",variant:"destructive"});return}if(!qr){l({title:"خطأ",description:"يرجى إدخال الرقم السري",variant:"destructive"});return}if(!Xr(qr)){l({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}ll(!0);try{const s=parseFloat(Ja),r=ze+s;lt(r),localStorage.setItem(st(),r.toString());const n={cashBalance:r,lastUpdated:new Date().toISOString()},i=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(i,JSON.stringify(n)),t!=null&&t.uid?(await Se.updateUserData(t.uid,n),localStorage.removeItem(i),fe(!1)):fe(!0),za(!1),Kr(""),Vr("")}catch(s){console.error("خطأ في حفظ الرصيد في Firebase:",s),lt(ze),localStorage.setItem("cashBalance",ze.toString()),l({title:"خطأ",description:"حدث خطأ أثناء حفظ البيانات، يرجى المحاولة مرة أخرى",variant:"destructive"})}finally{ll(!1)}},children:nl?"جاري الإضافة...":"إضافة الأموال"})]})]})}),e.jsx(ie,{open:no,onOpenChange:Er,children:e.jsxs(oe,{className:"sm:max-w-md",children:[e.jsx(ce,{children:e.jsx(de,{className:"text-right",children:"اختيار التاريخ والوقت للبحث"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(V,{htmlFor:"search-date",className:"text-right block",children:"التاريخ"}),e.jsx(R,{id:"search-date",type:"date",value:Da,onChange:s=>An(s.target.value),className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(V,{htmlFor:"search-time",className:"text-right block",children:"الوقت (اختياري)"}),e.jsx(R,{id:"search-time",type:"time",value:Ca,onChange:s=>Pn(s.target.value),className:"text-right",placeholder:"اختر الوقت للبحث في ساعة محددة"}),e.jsx("p",{className:"text-[10px] text-gray-500 text-right",children:"إذا لم تختر وقتاً محدداً، سيتم البحث في كامل اليوم"})]})]}),e.jsxs(Ce,{className:"flex justify-between",children:[e.jsx(d,{variant:"outline",onClick:()=>{An(""),Pn(""),Er(!1)},children:"مسح"}),e.jsx(d,{onClick:()=>Er(!1),children:"تطبيق"})]})]})}),e.jsx(kl,{isOpen:Dt&&!O,onClose:()=>Xe(!1),onTrialStarted:ao}),e.jsx(td,{isOpen:Li,onClose:()=>vr(!1)}),e.jsx(sd,{isOpen:ur,onClose:()=>Xs(!1),initialBarcode:bi}),e.jsx(Dc,{isOpen:Mi,onClose:()=>ka(!1)}),e.jsx(Cc,{open:$i,onOpenChange:Ta}),e.jsx(fd,{open:Ri,onOpenChange:s=>{if(s&&!Kt){l({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});return}Aa(s)}}),e.jsx(Dd,{open:Z,onOpenChange:s=>{if(s&&!Kt){l({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}L(s)}}),e.jsx(Cd,{open:T,onOpenChange:s=>{if(s&&!Kt){l({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}k(s)}}),e.jsx(ie,{open:uo,onOpenChange:s=>{if(s){l({title:"قيد التطوير",description:"هذه الميزة غير متاحة حالياً."});return}Rr(!1)},children:e.jsxs(oe,{dir:"rtl",className:"sm:max-w-md w-[95vw] sm:w-auto rounded-2xl border border-emerald-200 shadow-xl bg-gradient-to-br from-white via-green-50 to-emerald-50 backdrop-blur-md data-[state=open]:animate-in data-[state=open]:fade-in-0 data-[state=open]:zoom-in-90 data-[state=open]:slide-in-from-bottom-8 duration-300",children:[e.jsxs(ce,{children:[e.jsx(de,{className:"text-right text-green-700",children:"شحن رصيد الموبايل"}),e.jsx(Rt,{className:"text-right text-gray-600",children:"أدخل البيانات ثم اضغط تأكيد"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx(V,{htmlFor:"topupPhone",className:"text-right block",children:"رقم الموبايل"}),e.jsx(R,{id:"topupPhone",value:$a,onChange:s=>Yn(s.target.value),placeholder:"010xxxxxxx",className:"text-right"})]}),e.jsxs("div",{children:[e.jsx(V,{className:"text-right block",children:"شركة التشغيل"}),e.jsxs(ws,{value:Ra,onValueChange:Hn,children:[e.jsx(Ss,{className:"text-right",children:e.jsx(Ds,{placeholder:"اختر الشركة"})}),e.jsxs(Cs,{children:[e.jsx(Vt,{value:"vodafone",children:"فودافون"}),e.jsx(Vt,{value:"orange",children:"أورنج"}),e.jsx(Vt,{value:"etisalat",children:"اتصالات"}),e.jsx(Vt,{value:"we",children:"WE"})]})]})]}),e.jsxs("div",{children:[e.jsx(V,{htmlFor:"topupAmount",className:"text-right block",children:"المبلغ بالجنيه"}),e.jsx(R,{id:"topupAmount",type:"number",value:Ua,onChange:s=>Gn(s.target.value?Number(s.target.value):""),placeholder:"50",className:"text-right"})]})]}),e.jsxs(Ce,{className:"flex gap-2 justify-between",children:[e.jsx(d,{variant:"outline",onClick:()=>Rr(!1),className:"border-gray-300",children:"إلغاء"}),e.jsx(d,{onClick:y,disabled:Qn||!$a||!Ra||!Ua,className:"bg-emerald-600 hover:bg-emerald-700 text-white",children:Qn?"جارٍ التنفيذ...":"تأكيد الشحن"})]})]})}),e.jsx(As,{open:Vi,onOpenChange:ra,mode:"verify",title:"الرقم السري الرئيسي لفتح الديون",description:"أدخل الرقم السري الرئيسي لفتح صفحة الديون",onSuccess:()=>{ra(!1),Oa(!0)}}),e.jsx(ln,{open:mo,onOpenChange:Mr,title:"تأكيد كلمة المرور لتصفير المعاملات الأخيرة",description:"لن يتم حذف الإيصالات؛ سنبدأ القائمة من الآن.",onSuccess:()=>{try{t!=null&&t.uid&&(localStorage.setItem(`recentTransactionsResetAt:${t.uid}`,new Date().toISOString()),l({title:"تم التصفير",description:"تم بدء قائمة المعاملات من الآن."}))}catch{}Mr(!1)}}),e.jsx(As,{open:ve,onOpenChange:Y,mode:"verify",title:"الرقم السري لفتح مصروفات المحل",description:"أدخل الرقم السري الرئيسي لفتح نافذة مصروفات المحل",onSuccess:()=>{Y(!1),se(!0)}}),e.jsx(ie,{open:qi,onOpenChange:Oa,children:e.jsxs(oe,{className:"sm:max-w-[425px]",children:[e.jsxs(ce,{className:"flex items-center justify-between",children:[e.jsx(de,{className:"text-right",children:"إدارة الديون"}),e.jsxs("div",{className:"flex items-center gap-1 text-orange-700",children:[e.jsx(Rc,{className:"h-4 w-4"}),e.jsxs("span",{className:"text-xs font-bold",children:[Lo," جنيه"]})]})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(V,{htmlFor:"debtorName",className:"text-right col-span-1",children:"اسم المديون"}),e.jsx(R,{id:"debtorName",value:yr,onChange:s=>En(s.target.value),className:"col-span-3 text-right",placeholder:"أدخل اسم المديون"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(V,{htmlFor:"debtAmount",className:"text-right col-span-1",children:"المبلغ"}),e.jsx(R,{id:"debtAmount",type:"number",value:jr,onChange:s=>Bn(s.target.value),className:"col-span-3 text-right",placeholder:"أدخل المبلغ"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(V,{htmlFor:"debtReason",className:"text-right col-span-1",children:"سبب الدين"}),e.jsx(R,{id:"debtReason",value:Nr,onChange:s=>Ln(s.target.value),className:"col-span-3 text-right",placeholder:"أدخل سبب الدين"})]})]}),e.jsx(Ce,{children:e.jsx(d,{onClick:()=>{if(yr&&jr&&Nr){const s={id:Date.now().toString(),debtorName:yr,amount:parseFloat(jr),reason:Nr,status:"pending",createdAt:new Date,paidAmount:0,partialPayments:[]};Or(s),Wa(!0)}else l({title:"بيانات غير مكتملة",description:"يرجى إدخال الاسم والمبلغ والسبب",variant:"destructive"})},className:"bg-orange-500 hover:bg-orange-600",children:"حفظ"})}),e.jsx("div",{className:"mt-2",children:e.jsx(d,{variant:"outline",className:"w-full",onClick:()=>la(!0),children:"إيصالات الديون"})}),e.jsx("div",{className:"mt-2",children:e.jsx(d,{variant:"outline",className:"w-full",onClick:()=>Cr(!0),children:"إضافة عميل"})})]})}),e.jsx(ie,{open:Gi,onOpenChange:la,children:e.jsxs(oe,{className:"sm:max-w-[520px]",children:[e.jsxs(ce,{children:[e.jsx(de,{className:"text-right",children:"إيصالات الديون"}),e.jsx(Rt,{className:"text-right",children:"اختر دينًا لعرض إيصاله بالتفصيل"})]}),wt.length>0?e.jsx("div",{className:"max-h-64 overflow-y-auto space-y-2",children:wt.map(s=>e.jsx("div",{onClick:()=>{wr(s),na(!0),la(!1),Oa(!1)},className:"p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium",children:s.debtorName}),e.jsx("p",{className:"text-sm text-gray-600",children:s.reason}),e.jsx("p",{className:"text-sm text-gray-500",children:tn.format(s.createdAt instanceof Date?s.createdAt:new Date(s.createdAt))})]}),e.jsxs("div",{className:"text-left",children:[e.jsxs("p",{className:"font-bold text-lg",children:[s.amount," جنيه"]}),e.jsx(mt,{variant:s.status==="paid"?"default":"secondary",className:s.status==="paid"?"bg-green-500":"bg-yellow-500",children:s.status==="paid"?"مدفوع":"قيد المراجعة"})]})]})},s.id))}):e.jsx("div",{className:"text-center text-sm text-gray-500",children:"لا توجد ديون مسجلة"}),e.jsxs(Ce,{className:"flex justify-between mt-3",children:[e.jsx(d,{variant:"destructive",onClick:async()=>{try{if(!wt||wt.length===0){l({title:"لا توجد ديون",description:"القائمة فارغة بالفعل."});return}if(!window.confirm("هل تريد حذف كل إيصالات الديون؟ هذا الإجراء لا يمكن التراجع عنه."))return;const r=[];Mt(r),wr(null),await ss(r),l({title:"تم حذف كل إيصالات الديون",description:"تم تفريغ القائمة بالكامل."}),la(!1)}catch(s){console.error("تعذر حذف كل إيصالات الديون:",s),l({title:"فشل الحذف",description:"حدث خطأ أثناء الحذف، حاول مرة أخرى.",variant:"destructive"})}},children:"حذف كل الإيصالات"}),e.jsx(d,{variant:"outline",onClick:()=>la(!1),children:"إغلاق"})]})]})}),e.jsx(ie,{open:Qi,onOpenChange:Cr,children:e.jsxs(oe,{className:"sm:max-w-[480px]",children:[e.jsxs(ce,{children:[e.jsx(de,{className:"text-right",children:"إضافة عميل"}),e.jsx(Rt,{className:"text-right",children:"أدخل بيانات العميل ثم يمكنك تسجيل مبلغ دين عليه"})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(V,{htmlFor:"customerName",className:"text-right col-span-1",children:"اسم العميل"}),e.jsx(R,{id:"customerName",value:kr,onChange:s=>$n(s.target.value),className:"col-span-3 text-right",placeholder:"اكتب اسم العميل"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(V,{htmlFor:"customerMobile",className:"text-right col-span-1",children:"رقم الموبايل"}),e.jsx(R,{id:"customerMobile",value:Tr,onChange:s=>Rn(s.target.value),className:"col-span-3 text-right",placeholder:"اكتب رقم الموبايل"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(d,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{if(!kr||!Tr){l({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم العميل ورقم الموبايل",variant:"destructive"});return}const s={id:Date.now().toString(),name:kr.trim(),mobile:Tr.trim(),createdAt:new Date},r=[s,...ts];await fo(r),$n(""),Rn(""),l({title:"تمت إضافة العميل",description:`تم إضافة ${s.name}`})},children:"إضافة"})}),e.jsxs("div",{className:"border-t pt-4 space-y-3",children:[e.jsx(V,{className:"text-right block",children:"إضافة مبلغ على عميل"}),ts.length>0?e.jsxs("div",{className:"space-y-3",children:[e.jsxs(ws,{value:Ar,onValueChange:Un,children:[e.jsx(Ss,{className:"w-full",children:e.jsx(Ds,{placeholder:"اختر عميل"})}),e.jsx(Cs,{children:ts.map(s=>e.jsxs(Vt,{value:s.id,children:[s.name," — ",s.mobile]},s.id))})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(V,{htmlFor:"customerDebtAmount",className:"text-right col-span-1",children:"المبلغ"}),e.jsx(R,{id:"customerDebtAmount",type:"number",value:_n,onChange:s=>zn(s.target.value),className:"col-span-3 text-right",placeholder:"أدخل المبلغ"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(d,{className:"bg-orange-600 hover:bg-orange-700",onClick:async()=>{const s=parseFloat(_n);if(!Ar){l({title:"اختر عميل",description:"يرجى اختيار عميل أولاً",variant:"destructive"});return}if(isNaN(s)||s<=0){l({title:"قيمة غير صحيحة",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const r=ts.find(c=>c.id===Ar);if(!r)return;const n={id:Date.now().toString(),debtorName:r.name,customerId:r.id,mobile:r.mobile,amount:Number(s.toFixed(2)),reason:"دين عميل",status:"pending",createdAt:new Date,paidAmount:0,partialPayments:[]},i=[...wt,n];Mt(i),await ss(i),Un(""),zn(""),l({title:"تم تسجيل المبلغ على العميل",description:`تمت إضافة ${n.amount} جنيه للعميل ${r.name}`})},children:"إضافة المبلغ"})})]}):e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد عملاء مسجلين. أضف عميلًا أولاً."})]})]}),e.jsx(Ce,{className:"flex justify-end",children:e.jsx(d,{variant:"outline",onClick:()=>Cr(!1),children:"إغلاق"})})]})}),e.jsx(ie,{open:ue,onOpenChange:se,children:e.jsxs(oe,{className:"sm:max-w-[520px]",children:[e.jsxs(ce,{children:[e.jsx(de,{className:"text-right",children:"مصروفات المحل"}),e.jsx(Rt,{className:"text-right",children:"أدخل تفاصيل المصروف ثم اختر مصدر الخصم."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(V,{htmlFor:"expenseName",className:"text-right col-span-1",children:"اسم المصروف"}),e.jsx(R,{id:"expenseName",value:ee,onChange:s=>Te(s.target.value),className:"col-span-3 text-right",placeholder:"مثال: كهرباء، صيانة، مشتريات"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(V,{htmlFor:"expenseAmount",className:"text-right col-span-1",children:"تمن المصروف"}),e.jsx(R,{id:"expenseAmount",type:"number",value:G,onChange:s=>re(s.target.value),className:"col-span-3 text-right",placeholder:"0.00"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(V,{htmlFor:"expenseNotes",className:"text-right col-span-1",children:"ملاحظات"}),e.jsx(R,{id:"expenseNotes",value:Fe,onChange:s=>nt(s.target.value),className:"col-span-3 text-right",placeholder:"معلومات إضافية إن وجدت"})]})]}),e.jsxs(Ce,{className:"flex justify-between",children:[e.jsx(d,{className:"bg-orange-600 hover:bg-orange-700",onClick:()=>{if(!ee||!G){l({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم المصروف وقيمته",variant:"destructive"});return}$e(!0)},children:"إضافة مصروف"}),e.jsx(d,{variant:"outline",onClick:()=>St(!0),children:"إيصالات المصاريف"})]})]})}),e.jsx(ie,{open:ft,onOpenChange:St,children:e.jsxs(oe,{className:"sm:max-w-[420px]",dir:"rtl",children:[e.jsxs(ce,{children:[e.jsx(de,{className:"text-right",children:"إيصالات المصاريف"}),e.jsx(Rt,{className:"text-right",children:"آخر المصاريف المسجلة"})]}),ht.length>0?e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:ht.map(s=>e.jsx("div",{className:"p-2 border rounded-lg bg-white hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium text-sm",children:s.name}),e.jsx("p",{className:"text-[11px] text-gray-600",children:s.notes||"بدون ملاحظات"}),e.jsx("p",{className:"text-[10px] text-gray-500",children:new Date(s.createdAt).toLocaleString("ar-EG")})]}),e.jsxs("div",{className:"text-left",children:[e.jsxs("p",{className:"font-bold text-sm",children:[s.amount," جنيه"]}),e.jsx(mt,{variant:"secondary",className:s.source==="cash"?"bg-blue-100 text-blue-700":"bg-purple-100 text-purple-700",children:s.source==="cash"?"من النقدية":`من المحفظة${s.walletId?` (${s.walletId})`:""}`})]})]})},s.id))}):e.jsx("p",{className:"text-sm text-gray-500 text-center",children:"لا توجد مصاريف مسجلة بعد"})]})}),e.jsx(ie,{open:Tt,onOpenChange:$e,children:e.jsxs(oe,{className:"sm:max-w-[480px]",children:[e.jsx(ce,{children:e.jsx(de,{className:"text-right",children:"اختيار مصدر خصم المصروف"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600 text-right",children:"اختر هل تريد خصم مبلغ المصروف من الرصيد النقدي في الدرج أم من إحدى المحافظ."}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsx(d,{variant:Ze==="cash"?"default":"outline",className:Ze==="cash"?"bg-blue-600 hover:bg-blue-700 text-white":"",onClick:()=>ct("cash"),children:"الفلوس النقدية"}),e.jsx(d,{variant:Ze==="wallet"?"default":"outline",className:Ze==="wallet"?"bg-purple-600 hover:bg-purple-700 text-white":"",onClick:()=>ct("wallet"),children:"أرصدة المحافظ"})]}),Ze==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{className:"text-right block",children:"اختر المحفظة للخصم"}),e.jsxs(ws,{value:Ve,onValueChange:Ee,children:[e.jsx(Ss,{className:"w-full",children:e.jsx(Ds,{placeholder:"اختر محفظة"})}),e.jsx(Cs,{children:ye.map(s=>e.jsx(Vt,{value:s.id,children:s.phone||s.name||s.id},s.id))})]})]})]}),e.jsxs(Ce,{className:"flex justify-between",children:[e.jsx(d,{variant:"outline",onClick:()=>{$e(!1),ct(null),Ee("")},children:"إلغاء"}),e.jsx(d,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{const s=Number(G);if(isNaN(s)||s<=0){l({title:"قيمة غير صحيحة",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}if(!Ze){l({title:"اختر مصدر الخصم",description:"يرجى اختيار النقدية أو المحفظة",variant:"destructive"});return}try{if(Ze==="cash"){const i=Number((ze-s).toFixed(2));lt(i),localStorage.setItem(st(),i.toString());const c={cashBalance:i,lastUpdated:new Date().toISOString()},f=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(f,JSON.stringify(c)),t!=null&&t.uid?(await Se.updateUserData(t.uid,c),localStorage.removeItem(f),fe(!1)):fe(!0)}else if(Ze==="wallet"){if(!Ve){l({title:"اختر محفظة",description:"يرجى اختيار محفظة للخصم",variant:"destructive"});return}const i=be[Ve]||0,c=Number((i-s).toFixed(2)),f={...be,[Ve]:c};Je(f);const v=new Date().toISOString(),w={walletBalances:f,lastUpdated:v},B=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(B,JSON.stringify(w)),localStorage.setItem(tt(),JSON.stringify(f)),localStorage.setItem(`walletBalances_backup_${v}`,JSON.stringify(f)),t!=null&&t.uid&&await Se.updateUserData(t.uid,w)}}catch(i){console.error("خطأ أثناء تحديث الأرصدة عند حفظ المصروف:",i)}const r={id:Date.now().toString(),name:ee,amount:s,notes:Fe,source:Ze,walletId:Ze==="wallet"?Ve:void 0,createdAt:new Date},n=[...ht,r];await po(n),Te(""),re(""),nt(""),ct(null),Ee(""),$e(!1),se(!0),St(!0),l({title:"تم إضافة المصروف",description:Ze==="cash"?"تم الخصم من النقدية":"تم الخصم من أرصدة المحافظ"})},children:"تأكيد الخصم"})]})]})}),e.jsx(ie,{open:bt,onOpenChange:yt,children:e.jsxs(oe,{className:"sm:max-w-[520px]",children:[e.jsxs(ce,{children:[e.jsx(de,{className:"text-right",children:"النواقص"}),e.jsx(Rt,{className:"text-right",children:"سجل العناصر الناقصة التي تحتاج شراء وتابع حالتها."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(V,{htmlFor:"deficiencyName",className:"text-right col-span-1",children:"اسم العنصر"}),e.jsx(R,{id:"deficiencyName",value:Bt,onChange:s=>Ut(s.target.value),className:"col-span-3 text-right",placeholder:"مثال: سكر، زيت، مناديل"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(V,{htmlFor:"deficiencyQuantity",className:"text-right col-span-1",children:"الكمية"}),e.jsx(R,{id:"deficiencyQuantity",type:"number",value:jt,onChange:s=>W(s.target.value),className:"col-span-3 text-right",placeholder:"1"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(d,{className:"bg-rose-600 hover:bg-rose-700",onClick:()=>{if(Pe){l({title:"غير متاح",description:"النواقص غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"});return}const s=parseInt(jt||"1",10);if(!Bt){l({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم العنصر",variant:"destructive"});return}if(isNaN(s)||s<=0){l({title:"كمية غير صحيحة",description:"يرجى إدخال كمية صحيحة",variant:"destructive"});return}const r={id:Date.now().toString(),name:Bt,quantity:s,status:"pending",createdAt:new Date};xe(n=>{const i=[...n,r];return Ur(i),i}),Ut(""),W(""),l({title:"تمت الإضافة",description:"تمت إضافة العنصر إلى قائمة النواقص"})},children:"إضافة للنواقص"})}),ae.length>0?e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:ae.map(s=>e.jsx("div",{className:"p-2 border rounded-lg bg-white hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium text-sm",children:s.name}),e.jsxs("p",{className:"text-[11px] text-gray-600",children:["الكمية: ",s.quantity]}),e.jsx("p",{className:"text-[10px] text-gray-500",children:new Date(s.createdAt).toLocaleString("ar-EG")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(mt,{variant:"secondary",className:s.status==="pending"?"bg-rose-100 text-rose-700":"bg-green-100 text-green-700",children:s.status==="pending"?"قيد الشراء":"تم الشراء"}),e.jsx(d,{variant:"outline",className:s.status==="pending"?"text-green-700 border-green-300 hover:bg-green-50":"text-rose-700 border-rose-300 hover:bg-rose-50",onClick:()=>{xe(r=>{const n=r.map(i=>i.id===s.id?{...i,status:i.status==="pending"?"purchased":"pending"}:i);return Ur(n),n})},title:s.status==="pending"?"تم الشراء":"إلغاء الشراء",children:s.status==="pending"?"تم الشراء":"إلغاء الشراء"}),e.jsx(d,{variant:"outline",className:"text-red-700 border-red-300 hover:bg-red-50",onClick:()=>{xe(r=>{const n=r.filter(i=>i.id!==s.id);return Ur(n),n})},title:"حذف",children:"حذف"})]})]})},s.id))}):e.jsx("p",{className:"text-sm text-gray-500 text-center",children:"لا توجد عناصر مسجلة في النواقص"})]}),e.jsx(Ce,{className:"flex justify-end",children:e.jsx(d,{variant:"outline",onClick:()=>yt(!1),children:"إغلاق"})})]})}),e.jsx(ie,{open:Zi,onOpenChange:Wa,children:e.jsxs(oe,{className:"sm:max-w-[480px]",children:[e.jsx(ce,{children:e.jsx(de,{className:"text-right",children:"اختيار مصدر خصم الدين"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600 text-right",children:"اختر هل تريد خصم مبلغ الدين من الرصيد النقدي في الدرج أم من إحدى المحافظ أو تسجيله بدون خصم."}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsx(d,{variant:Pt==="cash"?"default":"outline",className:Pt==="cash"?"bg-blue-600 hover:bg-blue-700 text-white":"",onClick:()=>ia("cash"),children:"الفلوس النقدية"}),e.jsx(d,{variant:Pt==="wallet"?"default":"outline",className:Pt==="wallet"?"bg-purple-600 hover:bg-purple-700 text-white":"",onClick:()=>ia("wallet"),children:"أرصدة المحافظ"}),e.jsx(d,{variant:Pt==="none"?"default":"outline",className:Pt==="none"?"bg-gray-600 hover:bg-gray-700 text-white":"",onClick:()=>ia("none"),children:"بدون خصم"})]}),Pt==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{className:"text-right block",children:"اختر المحفظة للخصم"}),e.jsxs(ws,{value:Fa,onValueChange:Wr,children:[e.jsx(Ss,{className:"w-full",children:e.jsx(Ds,{placeholder:"اختر محفظة"})}),e.jsx(Cs,{children:ye.map(s=>e.jsx(Vt,{value:s.id,children:s.phone||s.name||s.id},s.id))})]})]})]}),e.jsxs(Ce,{className:"flex justify-between",children:[e.jsx(d,{variant:"outline",onClick:()=>{Wa(!1),Or(null),ia(null),Wr("")},children:"إلغاء"}),e.jsx(d,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{if(!Pr)return;const s=Number(Pr.amount);if(!Pt){l({title:"اختر مصدر الخصم",description:"يرجى اختيار النقدية أو المحفظة",variant:"destructive"});return}try{if(Pt==="cash"){const n=Number((ze-s).toFixed(2));lt(n),localStorage.setItem(st(),n.toString());const i=new Date().toISOString(),c={cashBalance:n,lastUpdated:i},f=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(f,JSON.stringify(c)),t!=null&&t.uid?await Se.updateUserData(t.uid,c).then(()=>{localStorage.removeItem(f),fe(!1)}).catch(()=>{fe(!0)}):fe(!0)}else if(Pt==="wallet"){if(!Fa){l({title:"اختر محفظة",description:"يرجى اختيار محفظة للخصم",variant:"destructive"});return}const n=be[Fa]||0,i=Number((n-s).toFixed(2)),c={...be,[Fa]:i};Je(c);const f=new Date().toISOString(),v={walletBalances:c,lastUpdated:f},w=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(w,JSON.stringify(v)),localStorage.setItem(tt(),JSON.stringify(c)),localStorage.setItem(`walletBalances_backup_${f}`,JSON.stringify(c)),t!=null&&t.uid&&await Se.updateUserData(t.uid,v)}}catch(n){console.error("خطأ أثناء تحديث الأرصدة عند حفظ الدين:",n)}const r=[...wt,Pr];Mt(r),await ss(r),En(""),Bn(""),Ln(""),Oa(!1),Wa(!1),Or(null),ia(null),Wr(""),l(Pt==="none"?{title:"تم حفظ الدين بدون خصم",description:"لم يتم الخصم من الدرج أو المحافظ"}:{title:"تم حفظ الدين وخصم المبلغ",description:Pt==="cash"?`تم خصم ${s} من الرصيد النقدي`:`تم خصم ${s} من رصيد المحفظة`})},children:"تأكيد الخصم وحفظ الدين"})]})]})}),e.jsx(ie,{open:Yi,onOpenChange:na,children:e.jsxs(oe,{className:"sm:max-w-[425px] z-[60]",children:[e.jsx(ce,{children:e.jsx(de,{className:"text-right",children:"إيصال الدين"})}),pe&&e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"text-center border-b pb-4",children:[e.jsx("h2",{className:"text-xl font-bold",children:"إيصال دين"}),e.jsx("p",{className:"text-sm text-gray-500",children:tn.format(pe.createdAt instanceof Date?pe.createdAt:new Date(pe.createdAt))})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"اسم المديون:"}),e.jsx("span",{children:pe.debtorName})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"المبلغ:"}),e.jsxs("span",{className:"font-bold text-lg",children:[pe.amount," جنيه"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"سبب الدين:"}),e.jsx("span",{children:pe.reason})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"الحالة:"}),e.jsx(mt,{variant:pe.status==="paid"?"default":"secondary",className:pe.status==="paid"?"bg-green-500":"bg-yellow-500",children:pe.status==="paid"?"مدفوع":"مؤجل"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"المبلغ المتبقي:"}),e.jsxs("span",{className:"font-bold text-lg",children:[Math.max(0,Number(pe.amount||0)-Number(pe.paidAmount||0))," جنيه"]})]}),pe.paidAmount?e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"إجمالي المدفوع:"}),e.jsxs("span",{className:"text-green-700",children:[pe.paidAmount," جنيه"]})]}):null,e.jsxs("div",{className:"mt-3 p-3 border rounded-lg bg-gray-50",children:[Hi?e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"partialAmount",className:"text-right block",children:"المبلغ المراد دفعه"}),e.jsx(R,{id:"partialAmount",type:"number",value:Mn,onChange:s=>Dr(s.target.value),className:"text-right",placeholder:"أدخل المبلغ"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(d,{variant:"outline",onClick:()=>{Sr(!1),Dr("")},children:"إلغاء"}),e.jsx(d,{className:"bg-blue-600 hover:bg-blue-700",onClick:async()=>{const s=parseFloat(Mn);if(!pe||isNaN(s)||s<=0){l({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const r=Math.max(0,Number(pe.amount||0)-Number(pe.paidAmount||0));if(s>r){l({title:"مبلغ زائد",description:"المبلغ المدفوع أكبر من المتبقي",variant:"destructive"});return}const n=Number(((pe.paidAmount||0)+s).toFixed(2)),i=n>=Number(pe.amount||0),c={...pe,amount:Number(pe.amount||0),paidAmount:n,status:i?"paid":"pending",partialPayments:[...pe.partialPayments||[],{amount:s,paidAt:new Date}]},f=wt.map(v=>v.id===pe.id?c:v);Mt(f),wr(c),await ss(f);try{c.status==="paid"&&(t!=null&&t.uid)&&(async()=>{const v=Is(ns(ot,"userTransactions"),It("userId","==",t.uid),It("linkedDebtId","==",pe.id),It("status","==","pending")),w=await ks(v);await Promise.allSettled(w.docs.map(B=>Ys(B.ref,{status:"completed",confirmedAt:new Date})))})().catch(v=>console.error("تعذر تحديث حالة المعاملات المرتبطة بالدين:",v))}catch(v){console.error("تعذر تجهيز تحديث حالة المعاملات المرتبطة:",v)}try{const v=oa(),w=localStorage.getItem(v);if(w){const A=(JSON.parse(w)||[]).map(S=>(S==null?void 0:S.linkedDebtId)===pe.id&&(S==null?void 0:S.status)==="pending"?{...S,status:"completed",confirmedAt:new Date}:S);localStorage.setItem(v,JSON.stringify(A)),Ie(S=>S.map(F=>(F==null?void 0:F.linkedDebtId)===pe.id&&(F==null?void 0:F.status)==="pending"?{...F,status:"completed",confirmedAt:new Date}:F))}}catch(v){console.warn("فشل تحديث حالة المعاملات المرتبطة محلياً بعد سداد الدين:",v)}Ea(s),ys("cash"),Us(!0),Sr(!1),Dr(""),l({title:"تم تسجيل دفع جزء",description:`تم دفع ${s} جنيه بتاريخ ${new Date().toLocaleString("ar-EG")}`})},children:"دفع"})]})]}):e.jsx(d,{variant:"outline",className:"w-full",onClick:()=>Sr(!0),children:"دفع جزء"}),pe.partialPayments&&pe.partialPayments.length>0&&e.jsxs("div",{className:"mt-3 text-xs text-gray-600",children:[e.jsx("p",{className:"font-medium mb-1",children:"سجل الدفعات الجزئية:"}),e.jsx("div",{className:"space-y-1 max-h-24 overflow-y-auto",children:pe.partialPayments.map((s,r)=>e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{children:["دفع: ",s.amount," جنيه"]}),e.jsx("span",{children:new Date(s.paidAt).toLocaleString("ar-EG")})]},r))})]})]})]})]}),e.jsxs(Ce,{className:"flex gap-2 justify-center",children:[e.jsx(d,{onClick:async()=>{if(pe){const s=wt.map(r=>r.id===pe.id?{...r,status:"pending"}:r);Mt(s),await ss(s),na(!1),l({title:"تم تحديث حالة الدين",description:"تم تعيين الدين كمؤجل"})}},variant:"outline",className:"bg-yellow-500 hover:bg-yellow-600 text-white",children:"مؤجل"}),e.jsx(d,{onClick:async()=>{if(pe){const r=Math.max(0,Number(pe.amount||0)-Number(pe.paidAmount||0)),n=wt.map(i=>i.id===pe.id?{...i,amount:Number(i.amount||0),paidAmount:Number(((i.paidAmount||0)+r).toFixed(2)),status:"paid",partialPayments:[...i.partialPayments||[],...r>0?[{amount:r,paidAt:new Date}]:[]]}:i);Mt(n),r>0&&(Ea(r),ys("cash"),Us(!0)),await ss(n);try{t!=null&&t.uid&&(pe!=null&&pe.id)&&(async()=>{const i=Is(ns(ot,"userTransactions"),It("userId","==",t.uid),It("linkedDebtId","==",pe.id),It("status","==","pending")),c=await ks(i);await Promise.allSettled(c.docs.map(f=>Ys(f.ref,{status:"completed",confirmedAt:new Date})))})().catch(i=>console.error("تعذر تحديث حالة المعاملات المرتبطة بالدين:",i))}catch(i){console.error("تعذر تجهيز تحديث حالة المعاملات المرتبطة:",i)}try{const i=oa(),c=localStorage.getItem(i);if(c){const v=(JSON.parse(c)||[]).map(w=>(w==null?void 0:w.linkedDebtId)===pe.id&&(w==null?void 0:w.status)==="pending"?{...w,status:"completed",confirmedAt:new Date}:w);localStorage.setItem(i,JSON.stringify(v)),Ie(w=>w.map(B=>(B==null?void 0:B.linkedDebtId)===pe.id&&(B==null?void 0:B.status)==="pending"?{...B,status:"completed",confirmedAt:new Date}:B))}}catch(i){console.warn("فشل تحديث حالة المعاملات المرتبطة محلياً بعد سداد الدين:",i)}na(!1),l({title:"تم تحديث حالة الدين",description:"تم تعيين الدين كمدفوع"})}},className:"bg-green-500 hover:bg-green-600",children:"مدفوع"}),e.jsx(d,{onClick:async()=>{if(pe){const s=wt.filter(r=>r.id!==pe.id);Mt(s),await ss(s),na(!1),l({title:"تم حذف الدين",description:"تم حذف الدين بنجاح"})}},variant:"destructive",children:"حذف"})]})]})}),e.jsx(ie,{open:Xi,onOpenChange:Us,children:e.jsxs(oe,{className:"sm:max-w-[425px]",children:[e.jsxs(ce,{children:[e.jsx(de,{className:"text-right",children:"اختيار إضافة مبلغ السداد"}),e.jsx(Rt,{className:"text-right",children:"هل تريد إضافة مبلغ السداد إلى الفلوس النقدية أم إلى إحدى المحافظ؟"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(d,{variant:Jt==="cash"?"default":"outline",className:Jt==="cash"?"bg-blue-600 text-white":"",onClick:()=>ys("cash"),children:"الفلوس النقدية"}),e.jsx(d,{variant:Jt==="wallet"?"default":"outline",className:Jt==="wallet"?"bg-blue-600 text-white":"",onClick:()=>ys("wallet"),children:"أرصدة المحافظ"}),e.jsx(d,{variant:Jt==="none"?"default":"outline",className:Jt==="none"?"bg-gray-600 text-white":"",onClick:()=>ys("none"),children:"بدون إضافة"})]}),Jt==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-right",children:"اختر المحفظة"}),e.jsxs("select",{className:"w-full border rounded p-2 text-right",value:js,onChange:s=>Fr(s.target.value),children:[e.jsx("option",{value:"",children:"— اختر محفظة —"}),ye&&ye.length>0?ye.map(s=>e.jsx("option",{value:s.id,children:s.phone||s.name||s.id},s.id)):Object.keys(be||{}).map(s=>{var r,n,i,c,f,v;return e.jsx("option",{value:s,children:((r=ye.find(w=>w.id===s))==null?void 0:r.phone)||((i=(n=JSON.parse(localStorage.getItem(_s())||"[]"))==null?void 0:n.find(w=>w.id===s))==null?void 0:i.phone)||((f=(c=JSON.parse(localStorage.getItem(_s())||"[]"))==null?void 0:c.find(w=>w.id===s))==null?void 0:f.name)||((v=ye.find(w=>w.id===s))==null?void 0:v.name)||s},s)})]})]}),e.jsxs("div",{className:"text-right text-sm text-gray-600",children:["المبلغ المراد إضافته: ",e.jsxs("span",{className:"font-bold",children:[Jn," جنيه"]})]})]}),e.jsxs(Ce,{className:"flex justify-end",children:[e.jsx(d,{variant:"outline",onClick:()=>{Us(!1),Ea(0),ys(null),Fr("")},children:"إلغاء"}),e.jsx(d,{onClick:async()=>{var s,r;try{const n=Jn;if(!n||n<=0){Us(!1);return}if(Jt==="cash"){const i=ze+n;lt(i),localStorage.setItem(st(),i.toString());const c={cashBalance:i,lastUpdated:new Date().toISOString()},f=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(f,JSON.stringify(c)),t!=null&&t.uid?(Se.updateUserData(t.uid,c).catch(()=>fe(!0)),localStorage.removeItem(f),fe(!1)):fe(!0),l({title:"تمت إضافة مبلغ السداد",description:`تمت إضافة ${n} جنيه إلى الفلوس النقدية`})}else if(Jt==="wallet"){if(!js){l({title:"اختر محفظة أولاً",description:"يرجى اختيار المحفظة لإضافة مبلغ السداد إليها",variant:"destructive"});return}const i={...be,[js]:(be[js]||0)+n};Je(i);const c=(ze||0)-n;lt(c),localStorage.setItem(st(),c.toString());const f=new Date().toISOString(),v={walletBalances:i,cashBalance:c,lastUpdated:f},w=`userData_${t==null?void 0:t.uid}`;if(localStorage.setItem(w,JSON.stringify(v)),localStorage.setItem(tt(),JSON.stringify(i)),localStorage.setItem(`walletBalances_backup_${f}`,JSON.stringify(i)),t!=null&&t.uid){Se.updateUserData(t.uid,v).catch(()=>fe(!0));try{localStorage.removeItem(w)}catch{}fe(!1)}else fe(!0);l({title:"تمت إضافة مبلغ السداد",description:`تمت إضافة ${n} جنيه إلى المحفظة ${((s=ye.find(B=>B.id===js))==null?void 0:s.phone)||((r=ye.find(B=>B.id===js))==null?void 0:r.name)||js} وتم خصم نفس المبلغ من درج النقدية`})}else if(Jt==="none"){const i=(ze||0)-n;lt(i),localStorage.setItem(st(),i.toString());const c={cashBalance:i,lastUpdated:new Date().toISOString()},f=`userData_${t==null?void 0:t.uid}`;if(localStorage.setItem(f,JSON.stringify(c)),t!=null&&t.uid){Se.updateUserData(t.uid,c).catch(()=>fe(!0));try{localStorage.removeItem(f)}catch{}fe(!1)}else fe(!0);l({title:"تم تسجيل السداد",description:`تم خصم ${n} جنيه من درج النقدية بدون إضافة للمحافظ`})}else{l({title:"اختر مصدر الإضافة",description:"يرجى اختيار إضافة المبلغ إلى النقدية أو المحفظة",variant:"destructive"});return}}catch(n){console.error("خطأ أثناء إضافة مبلغ السداد:",n),l({title:"حدث خطأ",description:"تعذر إضافة مبلغ السداد، حاول مرة أخرى",variant:"destructive"})}finally{Us(!1),Ea(0),ys(null),Fr("")}},className:"bg-green-600 hover:bg-green-700",children:"تأكيد الإضافة"})]})]})}),e.jsx(ie,{open:Bi,onOpenChange:Ia,children:e.jsxs(oe,{hideClose:!0,className:"sm:max-w-[420px] w-[90vw] rounded-2xl bg-gradient-to-br from-white via-indigo-50 to-blue-50 shadow-2xl border border-indigo-100",children:[e.jsxs(ce,{children:[e.jsx(de,{className:"text-right text-2xl font-bold",children:(Nt==null?void 0:Nt.type)==="transfer"?"مبلغ يجب استلامه":"مبلغ يجب تسليمه"}),e.jsx(Rt,{className:"text-right text-gray-600",children:(Nt==null?void 0:Nt.type)==="transfer"?"هذا هو المبلغ الواجب استلامه من العميل بعد التأكيد.":"هذا هو المبلغ الواجب تسليمه للعميل بعد التأكيد."})]}),e.jsxs("div",{className:"py-4 flex flex-col items-center gap-2",children:[e.jsxs("div",{className:"text-4xl font-extrabold text-blue-700 tracking-wider",children:[Nt==null?void 0:Nt.amount," جنيه"]}),e.jsx("div",{className:"text-sm text-gray-500 text-right w-full",children:(Nt==null?void 0:Nt.type)==="transfer"?"المبلغ المعروض شامل عمولة التحويل.":Ne?"العمولة مضافة ولا تؤثر على قيمة التسليم.":"العمولة مخصومة من المبلغ المسلّم للعميل."})]}),e.jsx(Ce,{className:"flex justify-end gap-2",children:e.jsx(d,{onClick:()=>{Ia(!1),fr(null)},className:"bg-green-600 hover:bg-green-700 text-white",children:(Nt==null?void 0:Nt.type)==="transfer"?"تم الاستلام":"تم التسليم"})})]})})]}))};export{Tm as default};
