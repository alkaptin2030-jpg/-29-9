const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-m0kHFZRo.js","assets/index-D6LCzO31.css","assets/walletDailyLimitsService-CI0pNeTV.js","assets/profitService-Un0hQgrk.js","assets/reportsService-Bp1Io21u.js","assets/masterPinService-B5aWu8_y.js"])))=>i.map(i=>d[i]);
var xi=Object.defineProperty;var ui=(i,v,t)=>v in i?xi(i,v,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[v]=t;var Pl=(i,v,t)=>ui(i,typeof v!="symbol"?v+"":v,t);import{c as Ot,h as gi,f as pi,u as Xt,r as l,j as e,a3 as Oa,G as Ps,a0 as Rt,aW as Fa,C as ms,d as Ft,a as Ul,a2 as ot,Q as $l,X as _l,_ as Yt,ax as Ar,R as et,F as Hs,W as Is,Z as Ht,k as tt,Y as St,am as Ts,a5 as Wr,a4 as Qt,O as Gs,i as _t,E as Vs,aS as fi,$ as Al,I as Ba,aj as Wl,aX as Rl,a1 as ve,w as vi,ag as yi,aD as ji,l as bi,o as Ni,K as qs,ak as wi,al as Si,ai as wa,n as Sa,g as Di,az as Ci,aA as Ii}from"./index-m0kHFZRo.js";import{C as Re,a as ct,b as jt,d as Ve}from"./card-CNVW1Pm3.js";import{B as c}from"./button-Br-OI1f7.js";import{I as U}from"./input-CfOT2vFp.js";import{B as yt}from"./badge-BnFAKgqN.js";import{S as Ns,a as ws,b as Ss,c as Ds,d as Cs,C as zl,e as Jl}from"./select-C0y1Y1Og.js";import{D as re,a as le,b as ne,c as ie,d as Gt,e as Ce}from"./dialog-DGzZN8QW.js";import{L as q}from"./label-CKTzLsQk.js";import{M as Zs,a as os}from"./MasterPinDialog-32LPDdzh.js";import{T as wt,P as ka}from"./progress-CH2krLv1.js";import{W as Wt}from"./wallet-BLOjLNET.js";import{S as Kl}from"./star-DPj2hIk5.js";import{S as Vl}from"./square-pen-BpX53DC-.js";import{P as zt}from"./phone-i180h3Ur.js";import{A as Or}from"./arrow-left-BI4lGUgQ.js";import{a as ql,S as Ti}from"./separator-CwZRybrE.js";import{C as ds}from"./calendar-WJAmw7cD.js";import{C as Tr}from"./chart-column-SaYovMy6.js";import{D as He}from"./dollar-sign-DoCkhEet.js";import{A as Cr}from"./activity-DjQlQIG_.js";import{C as xs}from"./circle-alert-B5fXTG4r.js";import{C as Fr}from"./circle-x-DdeCr0Id.js";import{C as Pa}from"./circle-check-big-CX1e4k1Y.js";import{a as Ge,E as bt}from"./eye-8WfFoA4m.js";import{S as ki}from"./store-DeHAZi-b.js";import{A as Pi}from"./arrow-right-Q6Easd7-.js";import{U as kr}from"./user-xVrCJxpS.js";import{c as Ai,C as Yl,a as Wi,R as Oi,P as Da,b as Fi,M as Bi}from"./PasswordConfirmDialog-CkSOlLwg.js";import{M as Zt}from"./masterPinService-B5aWu8_y.js";import{L as hs}from"./lock-B0wER2FP.js";import{w as Li,W as Ei}from"./WalletsManagement-BHjOojSu.js";import{walletDailyLimitsService as cs}from"./walletDailyLimitsService-CI0pNeTV.js";import{reportsService as At}from"./reportsService-Bp1Io21u.js";import{P as Mi}from"./ProfileIcon-BKp7YGHM.js";import{S as Ui}from"./shield-CbRJPyJB.js";import{G as Ol}from"./gift-Ca2iwfSO.js";import{ProfitService as As}from"./profitService-Un0hQgrk.js";import{R as $i}from"./refresh-cw-CAGEN6Jo.js";import"./index-B89jDZ7p.js";import"./Combination-BcNEVOqS.js";import"./check-BT0W6HyD.js";import"./dropdown-menu-D6n0gEJu.js";import"./index-Cv_MiR0H.js";import"./avatars-B7YaR9j7.js";import"./key-round-Djb6Pfs3.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Aa=Ot("ArrowDownLeft",[["path",{d:"M17 7 7 17",key:"15tmo1"}],["path",{d:"M17 17H7V7",key:"1org7z"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Hl=Ot("ArrowRightLeft",[["path",{d:"m16 3 4 4-4 4",key:"1x1c3m"}],["path",{d:"M20 7H4",key:"zbl0bi"}],["path",{d:"m8 21-4-4 4-4",key:"h9nckh"}],["path",{d:"M4 17h16",key:"g4d7ey"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _i=Ot("Banknote",[["rect",{width:"20",height:"12",x:"2",y:"6",rx:"2",key:"9lu3g6"}],["circle",{cx:"12",cy:"12",r:"2",key:"1c9p78"}],["path",{d:"M6 12h.01M18 12h.01",key:"113zkx"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ri=Ot("BookOpen",[["path",{d:"M12 7v14",key:"1akyts"}],["path",{d:"M3 18a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h5a4 4 0 0 1 4 4 4 4 0 0 1 4-4h5a1 1 0 0 1 1 1v13a1 1 0 0 1-1 1h-6a3 3 0 0 0-3 3 3 3 0 0 0-3-3z",key:"ruj8y"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Gl=Ot("Building",[["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",ry:"2",key:"76otgf"}],["path",{d:"M9 22v-4h6v4",key:"r93iot"}],["path",{d:"M8 6h.01",key:"1dz90k"}],["path",{d:"M16 6h.01",key:"1x0f13"}],["path",{d:"M12 6h.01",key:"1vi96p"}],["path",{d:"M12 10h.01",key:"1nrarc"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M16 10h.01",key:"1m94wz"}],["path",{d:"M16 14h.01",key:"1gbofw"}],["path",{d:"M8 10h.01",key:"19clt8"}],["path",{d:"M8 14h.01",key:"6423bh"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const zi=Ot("Download",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"7 10 12 15 17 10",key:"2ggqvy"}],["line",{x1:"12",x2:"12",y1:"15",y2:"3",key:"1vk2je"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Wa=Ot("IdCard",[["path",{d:"M16 10h2",key:"8sgtl7"}],["path",{d:"M16 14h2",key:"epxaof"}],["path",{d:"M6.17 15a3 3 0 0 1 5.66 0",key:"n6f512"}],["circle",{cx:"9",cy:"11",r:"2",key:"yxgjnd"}],["rect",{x:"2",y:"5",width:"20",height:"14",rx:"2",key:"qneu4z"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Pr=Ot("Info",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ca=Ot("Package",[["path",{d:"M11 21.73a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73z",key:"1a0edw"}],["path",{d:"M12 22V12",key:"d0xqtd"}],["path",{d:"m3.3 7 7.703 4.734a2 2 0 0 0 1.994 0L20.7 7",key:"yx3hmr"}],["path",{d:"m7.5 4.27 9 5.15",key:"1c824w"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Qs=Ot("TrendingDown",[["polyline",{points:"22 17 13.5 8.5 8.5 13.5 2 7",key:"1r2t7k"}],["polyline",{points:"16 17 22 17 22 11",key:"11uiuu"}]]),Ji=async(i={})=>{try{return(await gi(pi,"getLastTransactions")(i)).data}catch(v){throw console.error("Error getting last transactions:",v),v.code==="functions/unauthenticated"?new Error("يجب تسجيل الدخول للوصول إلى المعاملات"):v.code==="functions/invalid-argument"?new Error("بيانات الاستعلام غير صالحة: "+v.message):v.code==="functions/permission-denied"?new Error("ليس لديك صلاحية للوصول إلى هذه المعاملات: "+v.message):new Error("حدث خطأ أثناء جلب المعاملات: "+(v.message||"خطأ غير معروف"))}},Ki=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],Vi=({isOpen:i,onClose:v,onWalletSelect:t,onEditWallet:u,onDeleteWallet:j})=>{const{user:x}=Xt(),[I,M]=l.useState([]),[g,h]=l.useState(!1),p=()=>`wallets_${(x==null?void 0:x.uid)||"default"}`,T=()=>{try{const S=p(),$=localStorage.getItem(S);if($){const X=JSON.parse($);if(Array.isArray(X)&&X.length>0)return X}const Z="wallets_default",B=localStorage.getItem(Z);if(B){const X=JSON.parse(B);if(Array.isArray(X)&&X.length>0){localStorage.setItem(S,B);try{localStorage.removeItem(Z)}catch{}return X}}const P=Object.keys(localStorage).filter(X=>X.startsWith("wallets_")&&X!==S);let z=null,se=null;for(const X of P)try{const xe=localStorage.getItem(X);if(!xe)continue;const H=JSON.parse(xe);Array.isArray(H)&&H.length>0&&(!z||H.length>((z==null?void 0:z.length)||0))&&(z=H,se=X)}catch{}if(z&&se){localStorage.setItem(S,JSON.stringify(z));try{localStorage.removeItem(se)}catch{}return z}}catch(S){console.warn("WalletsViewPage migration failed:",S)}return null},k=async(S,$)=>{const Z=new Date().getMonth(),B=new Date().getFullYear(),P=$.filter(H=>{const Q=new Date(H.createdAt);return Q.getMonth()===Z&&Q.getFullYear()===B&&H.lineId===S}),z=H=>{const Q=H.type;return H.txnType==="receive"||Q==="withdraw"||Q==="withdrawal"||Q==="receive"},se=H=>{const Q=H.type;return H.txnType==="send"||Q==="send"||Q==="transfer"},X=P.filter(z).reduce((H,Q)=>{const Y=Q.withdrawnAmount!==void 0?Q.withdrawnAmount:Q.amount;return H+(Y||0)},0),xe=P.filter(se).reduce((H,Q)=>{const Y=Q.sentAmount!==void 0?Q.sentAmount:Q.amount;return H+(Y||0)},0);return{withdrawalUsage:X,transferUsage:xe}},O=S=>{const $=new Date().toISOString().split("T")[0],Z=S.lastResetDate;if(!Z)return{...S,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:$};const B=new Date(Z),P=new Date;return B.getMonth()!==P.getMonth()||B.getFullYear()!==P.getFullYear()?{...S,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:$}:S};l.useEffect(()=>{if(!(x!=null&&x.uid)||!i)return;(async()=>{h(!0);try{const $=await Rt.getByMerchantId(x.uid),Z=await Fa.getByUserId(x.uid),P=(await Promise.all($.map(async z=>{const{withdrawalUsage:se,transferUsage:X}=await k(z.id,Z);return{id:z.id,name:z.label||"محفظة بدون اسم",phone:z.msisdn,nationalId:z.nationalId||"",isDefault:!1,monthlyWithdrawalLimit:z.withdrawLimit||2e5,monthlyTransferLimit:z.transferLimit||2e5,monthlyWithdrawalUsage:se,monthlyTransferUsage:X,lastResetDate:new Date().toISOString().split("T")[0],walletProvider:z.walletProvider||""}}))).map(O);if(M(P),!P||P.length===0){const z=T();z&&z.length>0&&M(z.map(O))}}catch($){console.error("Error loading wallets:",$);const Z=T();Z&&M(Z.map(B=>({...B,phone:B.phone||B.phoneNumber,monthlyWithdrawalLimit:B.monthlyWithdrawalLimit||2e5,monthlyTransferLimit:B.monthlyTransferLimit||2e5})))}finally{h(!1)}})()},[x==null?void 0:x.uid,i]);const V=S=>Ki.find($=>$.id===S),K=(S,$)=>$>0?Math.min(S/$*100,100):0,F=S=>new Intl.NumberFormat("ar-EG").format(S);return e.jsx(re,{open:i,onOpenChange:v,children:e.jsxs(le,{className:"max-w-6xl max-h-[90vh] overflow-y-auto",children:[e.jsx(ne,{className:"pb-4",children:e.jsxs(ie,{className:"flex items-center gap-2 text-lg",children:[e.jsx(Wt,{className:"h-5 w-5"}),"الاطلاع على جميع المحافظ",e.jsxs(yt,{variant:"secondary",className:"mr-2",children:[I.length," محفظة"]})]})}),g?e.jsx("div",{className:"flex justify-center items-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-600",children:"جاري تحميل المحافظ..."})]})}):I.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Wt,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"لا توجد محافظ مضافة حتى الآن"})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:I.map(S=>{const $=V(S.walletProvider||""),Z=K(S.monthlyWithdrawalUsage||0,S.monthlyWithdrawalLimit),B=K(S.monthlyTransferUsage||0,S.monthlyTransferLimit);return e.jsxs(Re,{className:"cursor-pointer hover:shadow-lg transition-shadow border-2 hover:border-blue-300",onClick:()=>t(S),children:[e.jsx(ct,{className:"pb-3",children:e.jsxs(jt,{className:"flex items-center justify-between text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Oa,{className:"h-4 w-4"}),e.jsx("span",{children:S.name})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[S.isDefault&&e.jsxs(yt,{variant:"default",className:"text-xs",children:[e.jsx(Kl,{className:"h-3 w-3 mr-1"}),"افتراضية"]}),e.jsx(c,{variant:"ghost",size:"sm",onClick:P=>{P.stopPropagation(),u==null||u(S)},className:"h-7 px-2",children:e.jsx(Vl,{className:"h-4 w-4"})}),e.jsx(c,{variant:"ghost",size:"sm",onClick:P=>{P.stopPropagation(),j==null||j(S.id)},className:"h-7 px-2 text-destructive hover:text-destructive",children:e.jsx(wt,{className:"h-4 w-4"})})]})]})}),e.jsxs(Ve,{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(zt,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"font-mono",children:S.phone})]}),S.nationalId&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Wa,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"font-mono",children:S.nationalId})]}),$&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Gl,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{children:$.name})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Qs,{className:"h-3 w-3 text-red-500"}),"السحب الشهري"]}),e.jsxs("span",{className:"font-mono",children:[F(S.monthlyWithdrawalUsage||0)," / ",F(S.monthlyWithdrawalLimit)]})]}),e.jsx(ka,{value:Z,className:"h-2"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Ps,{className:"h-3 w-3 text-green-500"}),"التحويل الشهري"]}),e.jsxs("span",{className:"font-mono",children:[F(S.monthlyTransferUsage||0)," / ",F(S.monthlyTransferLimit)]})]}),e.jsx(ka,{value:B,className:"h-2"})]}),e.jsx(c,{variant:"outline",size:"sm",className:"w-full text-xs",onClick:P=>{P.stopPropagation(),t(S)},children:"عرض التفاصيل الكاملة"})]})]},S.id)})}),e.jsx("div",{className:"flex justify-end pt-4 border-t",children:e.jsxs(c,{onClick:v,variant:"outline",children:[e.jsx(Or,{className:"h-4 w-4 mr-2"}),"إغلاق"]})})]})})},qi=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],Yi=({wallet:i,isOpen:v,onClose:t,onBack:u})=>{const{user:j}=Xt(),[x,I]=l.useState([]),[M,g]=l.useState(!1),[h,p]=l.useState("month");if(l.useEffect(()=>{if(!i||!(j!=null&&j.uid)||!v)return;(async()=>{g(!0);try{const Be=(await Fa.getByUserId(j.uid)).filter(We=>We.walletId===i.id).sort((We,Le)=>new Date(Le.createdAt).getTime()-new Date(We.createdAt).getTime());I(Be)}catch(ae){console.error("Error loading transactions:",ae)}finally{g(!1)}})()},[i,j==null?void 0:j.uid,v]),!i)return null;const T=L=>qi.find(ae=>ae.id===L),k=(L,ae)=>ae>0?Math.min(L/ae*100,100):0,O=L=>new Intl.NumberFormat("ar-EG").format(L),V=L=>new Date(L).toLocaleDateString("ar-EG",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}),F=(()=>{const L=new Date;let ae;switch(h){case"week":ae=new Date(L.getTime()-7*24*60*60*1e3);break;case"month":ae=new Date(L.getFullYear(),L.getMonth(),1);break;default:return x}return x.filter(Be=>new Date(Be.createdAt)>=ae)})(),S=L=>{const ae=L.type,Be=L.txnType;return ae==="withdraw"||ae==="withdrawal"||ae==="receive"||Be==="receive"},$=L=>{const ae=L.type,Be=L.txnType;return ae==="send"||ae==="transfer"||Be==="send"},Z=F.filter(L=>S(L)&&L.status==="completed").reduce((L,ae)=>{const Be=ae.withdrawnAmount!==void 0?ae.withdrawnAmount:ae.amount;return L+(Be||0)},0),B=F.filter(L=>$(L)&&L.status==="completed").reduce((L,ae)=>{const Be=ae.sentAmount!==void 0?ae.sentAmount:ae.amount;return L+(Be||0)},0),P=F.filter(L=>L.type==="deposit"&&L.status==="completed").reduce((L,ae)=>L+ae.amount,0),z=T(i.walletProvider||""),se=k(i.monthlyWithdrawalUsage||0,i.monthlyWithdrawalLimit),X=k(i.monthlyTransferUsage||0,i.monthlyTransferLimit),xe=L=>{switch(L){case"withdrawal":return e.jsx(Qs,{className:"h-4 w-4 text-red-500"});case"transfer":return e.jsx(Ps,{className:"h-4 w-4 text-blue-500"});case"deposit":return e.jsx(He,{className:"h-4 w-4 text-green-500"});default:return e.jsx(Cr,{className:"h-4 w-4 text-gray-500"})}},H=L=>{switch(L){case"completed":return e.jsx(Pa,{className:"h-4 w-4 text-green-500"});case"pending":return e.jsx(ms,{className:"h-4 w-4 text-yellow-500"});case"failed":return e.jsx(Fr,{className:"h-4 w-4 text-red-500"});default:return e.jsx(xs,{className:"h-4 w-4 text-gray-500"})}},Q=L=>{switch(L){case"withdrawal":return"سحب";case"transfer":return"تحويل";case"deposit":return"إيداع";default:return"معاملة"}},Y=L=>{switch(L){case"completed":return"مكتملة";case"pending":return"قيد الانتظار";case"failed":return"فاشلة";default:return"غير محدد"}};return e.jsx(re,{open:v,onOpenChange:t,children:e.jsxs(le,{className:"max-w-6xl max-h-[90vh] overflow-y-auto",children:[e.jsx(ne,{className:"pb-4",children:e.jsxs(ie,{className:"flex items-center gap-2 text-lg",children:[e.jsx(Oa,{className:"h-5 w-5"}),"تفاصيل المحفظة: ",i.name,i.isDefault&&e.jsxs(yt,{variant:"default",className:"mr-2",children:[e.jsx(Kl,{className:"h-3 w-3 mr-1"}),"افتراضية"]})]})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-1 space-y-4",children:[e.jsxs(Re,{children:[e.jsx(ct,{children:e.jsxs(jt,{className:"text-sm flex items-center gap-2",children:[e.jsx(Wa,{className:"h-4 w-4"}),"المعلومات الأساسية"]})}),e.jsxs(Ve,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(zt,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-mono",children:i.phone})]}),i.nationalId&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Wa,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-mono",children:i.nationalId})]}),z&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Gl,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{children:z.name})]}),e.jsxs("div",{className:"text-xs text-gray-600 pr-6",children:[e.jsxs("div",{children:["المالك: ",z.ownerName]}),e.jsxs("div",{className:"font-mono",children:["الرقم القومي: ",z.nationalId]})]})]}),i.lastResetDate&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(ds,{className:"h-4 w-4 text-gray-500"}),e.jsxs("span",{children:["آخر إعادة تعيين: ",new Date(i.lastResetDate).toLocaleDateString("ar-EG")]})]})]})]}),e.jsxs(Re,{children:[e.jsx(ct,{children:e.jsxs(jt,{className:"text-sm flex items-center gap-2",children:[e.jsx(Tr,{className:"h-4 w-4"}),"حدود الاستخدام الشهري"]})}),e.jsxs(Ve,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Qs,{className:"h-3 w-3 text-red-500"}),"السحب الشهري"]}),e.jsxs("span",{className:"font-mono",children:[O(i.monthlyWithdrawalUsage||0)," / ",O(i.monthlyWithdrawalLimit)]})]}),e.jsx(ka,{value:se,className:"h-2"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["متبقي: ",O(i.monthlyWithdrawalLimit-(i.monthlyWithdrawalUsage||0))," جنيه"]})]}),e.jsx(ql,{}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Ps,{className:"h-3 w-3 text-green-500"}),"التحويل الشهري"]}),e.jsxs("span",{className:"font-mono",children:[O(i.monthlyTransferUsage||0)," / ",O(i.monthlyTransferLimit)]})]}),e.jsx(ka,{value:X,className:"h-2"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["متبقي: ",O(i.monthlyTransferLimit-(i.monthlyTransferUsage||0))," جنيه"]})]})]})]})]}),e.jsxs("div",{className:"lg:col-span-2 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsx(Re,{children:e.jsxs(Ve,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(Qs,{className:"h-5 w-5 text-red-500"})}),e.jsx("div",{className:"text-lg font-bold",children:O(Z)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي السحب"})]})}),e.jsx(Re,{children:e.jsxs(Ve,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(Ps,{className:"h-5 w-5 text-blue-500"})}),e.jsx("div",{className:"text-lg font-bold",children:O(B)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي التحويل"})]})}),e.jsx(Re,{children:e.jsxs(Ve,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(He,{className:"h-5 w-5 text-green-500"})}),e.jsx("div",{className:"text-lg font-bold",children:O(P)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي الإيداع"})]})})]}),e.jsxs(Re,{children:[e.jsx(ct,{children:e.jsxs(jt,{className:"text-sm flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(Cr,{className:"h-4 w-4"}),"سجل المعاملات"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(c,{size:"sm",variant:h==="week"?"default":"outline",onClick:()=>p("week"),className:"text-xs",children:"أسبوع"}),e.jsx(c,{size:"sm",variant:h==="month"?"default":"outline",onClick:()=>p("month"),className:"text-xs",children:"شهر"}),e.jsx(c,{size:"sm",variant:h==="all"?"default":"outline",onClick:()=>p("all"),className:"text-xs",children:"الكل"})]})]})}),e.jsx(Ve,{children:M?e.jsx("div",{className:"flex justify-center items-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-600",children:"جاري تحميل المعاملات..."})]})}):F.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Cr,{className:"h-8 w-8 text-gray-400 mx-auto mb-2"}),e.jsx("p",{className:"text-gray-600",children:"لا توجد معاملات في هذه الفترة"})]}):e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:F.map(L=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[xe(L.type),e.jsxs("div",{children:[e.jsxs("div",{className:"text-sm font-medium",children:[Q(L.type)," - ",O(L.amount)," جنيه"]}),e.jsx("div",{className:"text-xs text-gray-600",children:V(L.createdAt)}),L.description&&e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:L.description})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[H(L.status),e.jsx("span",{className:"text-xs",children:Y(L.status)})]})]},L.id))})})]})]})]}),e.jsxs("div",{className:"flex justify-between pt-4 border-t",children:[e.jsxs(c,{onClick:u,variant:"outline",children:[e.jsx(Or,{className:"h-4 w-4 mr-2"}),"العودة للمحافظ"]}),e.jsx(c,{onClick:t,variant:"outline",children:"إغلاق"})]})]})})},Ir=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],Hi=({isOpen:i,onClose:v,onWalletUpdate:t,initialEditingWallet:u})=>{const{toast:j}=Ft(),{user:x}=Xt(),I=Ul(),[M,g]=l.useState([]),[h,p]=l.useState(!1),[T,k]=l.useState(null),[O,V]=l.useState(""),[K,F]=l.useState(""),[S,$]=l.useState(""),[Z,B]=l.useState(""),[P,z]=l.useState("200000"),[se,X]=l.useState("200000"),[xe,H]=l.useState("100000"),[Q,Y]=l.useState("60000"),[L,ae]=l.useState(!1),[Be,We]=l.useState(null),[Le,Oe]=l.useState(!1),[dt,Ze]=l.useState(!1),[Jt,Nt]=l.useState(!1),[f,_]=l.useState(null),ee=()=>`wallets_${(x==null?void 0:x.uid)||"default"}`;l.useEffect(()=>{u&&(k(u),p(!0),V(u.name||""),F(u.phone||""),$(u.nationalId||""),B(u.walletProvider||""),z((u.monthlyWithdrawalLimit||2e5).toString()),X((u.monthlyTransferLimit||2e5).toString()),H((u.dailyWithdrawalLimit||1e5).toString()),Y((u.dailyTransferLimit||6e4).toString()),ae(!!u.isDefault))},[u]);const ue=D=>{const G=new Date,oe=G.getMonth(),be=G.getFullYear();if(!D.lastResetDate)return{...D,monthlyWithdrawalUsage:D.monthlyWithdrawalUsage||0,monthlyTransferUsage:D.monthlyTransferUsage||0,lastResetDate:G.toISOString().split("T")[0]};const Te=new Date(D.lastResetDate),we=Te.getMonth(),at=Te.getFullYear();return oe!==we||be!==at?{...D,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:G.toISOString().split("T")[0]}:D},Ie=async(D,G)=>{const oe=new Date().getMonth(),be=new Date().getFullYear(),Te=G.filter(Me=>{const fe=new Date(Me.createdAt);return fe.getMonth()===oe&&fe.getFullYear()===be&&Me.lineId===D}),we=Te.filter(Me=>Me.txnType==="receive").reduce((Me,fe)=>Me+(fe.amount||0),0),at=Te.filter(Me=>Me.txnType==="send").reduce((Me,fe)=>Me+(fe.amount||0),0);return{withdrawalUsage:we,transferUsage:at}},ze=async(D,G)=>{const oe=new Date,be=oe.getDate(),Te=oe.getMonth(),we=oe.getFullYear(),at=G.filter(Se=>{const rt=new Date(Se.createdAt);return rt.getDate()===be&&rt.getMonth()===Te&&rt.getFullYear()===we&&Se.lineId===D}),Me=at.filter(Se=>Se.txnType==="receive").reduce((Se,rt)=>Se+(rt.amount||0),0),fe=at.filter(Se=>Se.txnType==="send").reduce((Se,rt)=>Se+(rt.amount||0),0);return{withdrawalUsage:Me,transferUsage:fe}};l.useEffect(()=>{(async()=>{if(!(x!=null&&x.uid)){console.log("No user authenticated, skipping wallet loading"),Oe(!1);return}console.log("Loading wallets for user:",x.uid),Oe(!0);try{const{auth:G}=await Yt(async()=>{const{auth:fe}=await import("./index-m0kHFZRo.js").then(Se=>Se.aZ);return{auth:fe}},__vite__mapDeps([0,1]));let oe=0;const be=5;for(;!G.currentUser&&oe<be;)console.log(`Waiting for auth state... attempt ${oe+1}`),await new Promise(fe=>setTimeout(fe,1e3)),oe++;if(!G.currentUser)throw console.error("User not authenticated in Firebase Auth after retries"),new Error("not authenticated");console.log("Firebase Auth User:",G.currentUser.uid),console.log("Context User:",x.uid),console.log("Fetching wallets from Firebase...");const Te=await Rt.getByMerchantId(x.uid);console.log("Fetched wallets:",Te),console.log("Fetching transactions from Firebase...");const we=await Fa.getByUserId(x.uid);console.log("Fetched transactions:",we);const Me=(await Promise.all(Te.map(async fe=>{const{withdrawalUsage:Se,transferUsage:rt}=await Ie(fe.id,we),{withdrawalUsage:us,transferUsage:pt}=await ze(fe.id,we);return{id:fe.id,name:fe.label||"محفظة بدون اسم",phone:fe.msisdn,isDefault:!1,monthlyWithdrawalLimit:fe.withdrawLimit||2e5,monthlyTransferLimit:fe.transferLimit||2e5,dailyWithdrawalLimit:1e5,dailyTransferLimit:6e4,monthlyWithdrawalUsage:Se,monthlyTransferUsage:rt,dailyWithdrawalUsage:us,dailyTransferUsage:pt,lastResetDate:new Date().toISOString().split("T")[0],defaultTransferCommission:fe.defaultTransferCommission!=null?Number(fe.defaultTransferCommission):null,defaultWithdrawCommission:fe.defaultWithdrawCommission!=null?Number(fe.defaultWithdrawCommission):null}}))).map(ue);g(Me),console.log("Wallets loaded successfully:",Me)}catch(G){console.error("Error loading wallets:",G),console.log("تم تحميل المحافظ من البيانات المحفوظة محلياً");const oe=localStorage.getItem(ee());if(oe){const be=JSON.parse(oe);g(be.map(Te=>({...Te,phone:Te.phone||Te.phoneNumber,monthlyWithdrawalLimit:Te.monthlyWithdrawalLimit||2e5,monthlyTransferLimit:Te.monthlyTransferLimit||2e5})))}}finally{Oe(!1)}})()},[x==null?void 0:x.uid]);const st=()=>{V(""),F(""),$(""),B(""),z("200000"),X("200000"),H("100000"),Y("60000"),ae(!1),k(null),p(!1)},gt=async()=>{if(!O.trim()||!K.trim()||!Z.trim()){j({title:"خطأ",description:"يرجى ملء جميع الحقول المطلوبة",variant:"destructive"});return}if(!(x!=null&&x.uid)){j({title:"خطأ",description:"يجب تسجيل الدخول أولاً",variant:"destructive"});return}Oe(!0);try{if(T){await Rt.update(T.id,{label:O.trim(),msisdn:K.trim(),withdrawLimit:parseInt(P),transferLimit:parseInt(se)});const D=M.map(G=>G.id===T.id?{...G,name:O.trim(),phone:K.trim(),nationalId:S.trim(),walletProvider:Z,monthlyWithdrawalLimit:parseInt(P),monthlyTransferLimit:parseInt(se),dailyWithdrawalLimit:parseInt(xe),dailyTransferLimit:parseInt(Q)}:G);g(D),localStorage.setItem(ee(),JSON.stringify(D)),j({title:"تم التحديث",description:"تم تحديث المحفظة بنجاح"})}else{const D={merchantUserId:x.uid,provider:Z,msisdn:K.trim(),label:O.trim(),isActive:!0,dailyLimit:2e5,monthlyLimit:2e5,withdrawLimit:parseInt(P),transferLimit:parseInt(se),dailyUsage:0,monthlyUsage:0,transferUsage:0,withdrawUsage:0},G=await Rt.create(D),oe=new Date().toISOString().split("T")[0],be={id:G,name:O.trim(),phone:K.trim(),nationalId:S.trim(),walletProvider:Z,isDefault:L,monthlyWithdrawalLimit:parseInt(P),monthlyTransferLimit:parseInt(se),dailyWithdrawalLimit:parseInt(xe),dailyTransferLimit:parseInt(Q),monthlyWithdrawalUsage:0,monthlyTransferUsage:0,dailyWithdrawalUsage:0,dailyTransferUsage:0,lastResetDate:oe,defaultTransferCommission:null,defaultWithdrawCommission:null},Te=[...M,be];g(Te),localStorage.setItem(ee(),JSON.stringify(Te)),j({title:"تم الإنشاء",description:"تم إنشاء المحفظة بنجاح"})}t&&t(),st(),p(!1),k(null)}catch(D){console.error("Error saving wallet:",D),j({title:"خطأ",description:"حدث خطأ أثناء حفظ المحفظة",variant:"destructive"})}finally{Oe(!1)}},Dt=D=>{k(D),V(D.name),F(D.phone),$(D.nationalId||""),B(D.walletProvider||""),z(D.monthlyWithdrawalLimit.toString()),X(D.monthlyTransferLimit.toString()),ae(D.isDefault),p(!0)},es=async D=>{const G=M.find(oe=>oe.id===D);if(G!=null&&G.isDefault){j({title:"تحذير",description:"لا يمكن حذف المحفظة الافتراضية",variant:"destructive"});return}if(!(x!=null&&x.uid)){j({title:"خطأ",description:"يجب تسجيل الدخول أولاً",variant:"destructive"});return}Oe(!0);try{await Rt.delete(D);const oe=M.filter(be=>be.id!==D);g(oe),localStorage.setItem(ee(),JSON.stringify(oe)),t&&t(),j({title:"تم الحذف",description:"تم حذف المحفظة بنجاح"})}catch(oe){console.error("Error deleting wallet:",oe),j({title:"خطأ",description:"حدث خطأ أثناء حذف المحفظة",variant:"destructive"})}finally{Oe(!1)}},Bt=D=>{const G=M.map(oe=>({...oe,isDefault:oe.id===D}));g(G),localStorage.setItem(ee(),JSON.stringify(G)),t&&t(),j({title:"تم تحديث المحفظة الافتراضية",description:"تم تعيين المحفظة كافتراضية بنجاح"})};return e.jsxs(re,{open:i,onOpenChange:v,children:[e.jsxs(le,{className:"max-w-4xl max-h-[80vh] overflow-y-auto",children:[e.jsx(ne,{className:"pb-2",children:e.jsxs(ie,{className:"flex items-center gap-1 text-sm",children:[e.jsx(Wt,{className:"h-3 w-3"}),"إدارة المحافظ"]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h3",{className:"text-sm font-semibold",children:["المحافظ المتاحة (",M.length,")"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(c,{onClick:()=>Nt(!0),className:"flex items-center gap-1 h-6 px-2 text-xs",size:"sm",variant:"outline",children:[e.jsx(Ge,{className:"h-3 w-3"}),"الاطلاع على المحافظ"]}),e.jsxs(c,{onClick:()=>{v(),I("/user/add-wallet")},className:"flex items-center gap-1 h-6 px-2 text-xs",size:"sm",children:[e.jsx(ot,{className:"h-3 w-3"}),"إضافة محفظة جديدة"]})]})]}),(h||T)&&e.jsxs(Re,{className:"border-2 border-blue-200 bg-blue-50",children:[e.jsx(ct,{className:"pb-1",children:e.jsx(jt,{className:"text-sm",children:T?"تعديل المحفظة":"إضافة محفظة جديدة"})}),e.jsxs(Ve,{className:"space-y-2 pt-1",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"شركة المحفظة"}),e.jsx("div",{className:"flex gap-1 items-center",children:e.jsxs(Ns,{value:Z,onValueChange:B,children:[e.jsx(ws,{className:"h-6 text-xs flex-1",children:e.jsx(Ss,{placeholder:"اختر شركة المحفظة"})}),e.jsx(Ds,{children:Ir.map(D=>e.jsx(Cs,{value:D.id,className:"text-xs",children:e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsx("span",{children:D.name}),e.jsx("button",{type:"button",className:"h-4 w-4 p-0 ml-2 flex items-center justify-center hover:bg-blue-100 rounded",onClick:G=>{G.preventDefault(),G.stopPropagation(),We(D.id)},children:e.jsx(Pr,{className:"h-3 w-3 text-blue-500 hover:text-blue-700"})})]})},D.id))})]})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"اسم المحفظة"}),e.jsx(U,{value:O,onChange:D=>V(D.target.value),placeholder:"مثال: محفظة العمل",className:"h-6 text-xs"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"رقم الهاتف"}),e.jsxs("div",{className:"relative",children:[e.jsx(zt,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(U,{value:K,onChange:D=>F(D.target.value),placeholder:"01030302038",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الرقم القومي للخط"}),e.jsxs("div",{className:"relative",children:[e.jsx(Wa,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(U,{value:S,onChange:D=>$(D.target.value),placeholder:"29012345678901",maxLength:14,className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد الشهري للسحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(He,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(U,{type:"number",value:P,onChange:D=>z(D.target.value),placeholder:"200000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد الشهري للتحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(He,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(U,{type:"number",value:se,onChange:D=>X(D.target.value),placeholder:"200000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد اليومي للسحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Qs,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-red-400"}),e.jsx(U,{type:"number",value:xe,onChange:D=>H(D.target.value),placeholder:"100000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد اليومي للتحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Ps,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-blue-400"}),e.jsx(U,{type:"number",value:Q,onChange:D=>Y(D.target.value),placeholder:"60000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",id:"isDefault",checked:L,onChange:D=>ae(D.target.checked),className:"rounded w-3 h-3"}),e.jsx("label",{htmlFor:"isDefault",className:"text-xs font-medium text-gray-700",children:"تعيين كمحفظة افتراضية"})]}),e.jsx("div",{className:"border-t pt-2 mt-2",children:e.jsxs("div",{className:"flex items-center gap-1 mb-2",children:[e.jsx($l,{className:"h-3 w-3 text-gray-600"}),e.jsx("label",{className:"text-xs font-medium text-gray-700",children:"إعدادات العمولة"})]})}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(c,{onClick:gt,className:"flex-1 h-6 text-xs",size:"sm",children:T?"تحديث المحفظة":"إضافة المحفظة"}),e.jsx(c,{variant:"outline",onClick:st,className:"h-6 text-xs",size:"sm",children:"إلغاء"})]})]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2",children:M.map(D=>{var G;return e.jsxs(Re,{className:`${D.isDefault?"border-green-300 bg-green-50":""}`,children:[e.jsx(ct,{className:"pb-1",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(jt,{className:"text-sm flex items-center gap-1",children:[e.jsx(Wt,{className:"h-3 w-3"}),D.name]}),D.isDefault&&e.jsx(yt,{variant:"default",className:"bg-green-600 text-xs px-1 py-0",children:"افتراضية"})]})}),e.jsxs(Ve,{className:"space-y-1 pt-0",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(zt,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"text-xs",children:D.phone})]}),D.walletProvider&&e.jsx("div",{className:"text-xs text-blue-600 mt-1",children:((G=Ir.find(oe=>oe.id===D.walletProvider))==null?void 0:G.name)||D.walletProvider}),e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-2 rounded-md border border-gray-200 shadow-sm space-y-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-gray-600 mb-1",children:"الحدود الشهرية"}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-red-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-red-400 to-red-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((D.monthlyWithdrawalUsage||0)/D.monthlyWithdrawalLimit*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-blue-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-400 to-blue-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((D.monthlyTransferUsage||0)/D.monthlyTransferLimit*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-xs text-red-600 font-medium",children:["متبقي سحب: ",Math.max(D.monthlyWithdrawalLimit-(D.monthlyWithdrawalUsage||0),0)," جنيه"]}),e.jsxs("div",{className:"text-xs text-blue-600 font-medium",children:["متبقي تحويل: ",Math.max(D.monthlyTransferLimit-(D.monthlyTransferUsage||0),0)," جنيه"]})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-gray-600 mb-1",children:"الحدود اليومية"}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-orange-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-orange-400 to-orange-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((D.dailyWithdrawalUsage||0)/D.dailyWithdrawalLimit*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-green-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-green-400 to-green-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((D.dailyTransferUsage||0)/D.dailyTransferLimit*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-xs text-orange-600 font-medium",children:["متبقي سحب يومي: ",Math.max(D.dailyWithdrawalLimit-(D.dailyWithdrawalUsage||0),0)," جنيه"]}),e.jsxs("div",{className:"text-xs text-green-600 font-medium",children:["متبقي تحويل يومي: ",Math.max(D.dailyTransferLimit-(D.dailyTransferUsage||0),0)," جنيه"]})]})]})]}),e.jsxs("div",{className:"flex gap-1 pt-1",children:[e.jsxs(c,{size:"sm",variant:"outline",onClick:()=>Dt(D),className:"flex-1 h-5 text-xs px-1",children:[e.jsx(Vl,{className:"h-2 w-2 mr-0.5"}),"تعديل"]}),!D.isDefault&&e.jsxs(e.Fragment,{children:[e.jsx(c,{size:"sm",variant:"outline",onClick:()=>Bt(D.id),className:"flex-1 h-5 text-xs px-1",children:"جعلها افتراضية"}),e.jsx(c,{size:"sm",variant:"destructive",onClick:()=>es(D.id),className:"h-5 px-1",children:e.jsx(wt,{className:"h-2 w-2"})})]})]})]})]},D.id)})}),M.length===0&&e.jsx("div",{className:"text-center py-4 text-gray-500 text-xs",children:"لا توجد محافظ متاحة. قم بإضافة محفظة جديدة للبدء."})]}),Be&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-800",children:"معلومات صاحب المحفظة"}),e.jsx("button",{onClick:()=>We(null),className:"h-8 w-8 p-0 flex items-center justify-center hover:bg-gray-100 rounded-full transition-colors",children:e.jsx(_l,{className:"h-4 w-4 text-gray-500"})})]}),(()=>{const D=Ir.find(G=>G.id===Be);return D?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-center mb-6",children:e.jsx("div",{className:"bg-blue-100 p-3 rounded-lg inline-block",children:e.jsx("h4",{className:"font-bold text-blue-700 text-lg",children:D.name})})}),e.jsx("div",{className:"bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-200",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-white p-3 rounded-lg shadow-sm",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full mr-2"}),e.jsx("span",{className:"font-semibold text-gray-700",children:"اسم صاحب المحفظة:"})]}),e.jsx("p",{className:"text-gray-900 font-medium text-lg mr-4",children:D.ownerName})]}),e.jsxs("div",{className:"bg-white p-3 rounded-lg shadow-sm",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full mr-2"}),e.jsx("span",{className:"font-semibold text-gray-700",children:"الرقم القومي:"})]}),e.jsx("p",{className:"text-gray-900 font-mono text-lg mr-4 tracking-wider",children:D.nationalId})]})]})}),e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 p-3 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(Pr,{className:"h-4 w-4 text-yellow-600 mr-2"}),e.jsx("span",{className:"text-sm text-yellow-800 font-medium",children:"هذه البيانات مسجلة رسمياً في النظام لهذه المحفظة"})]})})]}):null})()]})})]}),e.jsx(Zs,{open:Jt,onOpenChange:Nt,mode:"verify",title:"إدخال الرقم السري الرئيسي",description:"لا يمكن الاطلاع على المحافظ إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{Nt(!1),Ze(!0)}}),e.jsx(Vi,{isOpen:dt,onClose:()=>Ze(!1),onWalletSelect:D=>{_(D),Ze(!1)},onEditWallet:D=>{I(`/user/add-wallet?edit=1&id=${D.id}`),Ze(!1)},onDeleteWallet:async D=>{try{if(await Rt.delete(D),g(G=>{const oe=G.filter(be=>be.id!==D);try{localStorage.setItem(ee(),JSON.stringify(oe))}catch(be){console.error("Failed to update localStorage wallets after delete:",be)}return oe}),t)try{await t()}catch(G){console.error("onWalletUpdate callback failed:",G)}}catch(G){console.error("Error deleting wallet:",G)}}}),e.jsx(Yi,{wallet:f,isOpen:!!f,onClose:()=>_(null),onBack:()=>{_(null),Ze(!0)}})]})},Gi=({isOpen:i,onClose:v,transaction:t,onDelete:u})=>{if(!t)return null;const j=h=>{switch(h){case"completed":return e.jsx(Pa,{className:"h-5 w-5 text-green-500"});case"pending":return e.jsx(ms,{className:"h-5 w-5 text-yellow-500"});case"failed":return e.jsx(Fr,{className:"h-5 w-5 text-red-500"});default:return e.jsx(ms,{className:"h-5 w-5 text-gray-500"})}},x=h=>{switch(h){case"completed":return"مكتملة";case"pending":return"قيد الانتظار";case"failed":return"فاشلة";default:return"غير معروف"}},I=h=>{switch(h){case"withdraw":return"سحب";case"send":return"إرسال";case"receive":return"استقبال";default:return"تحويل"}},M=()=>{const h=!!t.senderNumber,p=!!t.senderName,T=h?"الرقم المرسل:":p?"الرقم الراسل:":"رقم المحفظة:",k=h?t.senderNumber:p?t.senderName:t.senderPhone,O=`
      <div style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 500px; margin: 0 auto; padding: 30px; background: #fff;">
        <!-- Header -->
        <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #2563eb; padding-bottom: 20px;">
          <h1 style="color: #2563eb; margin-bottom: 5px; font-size: 28px;">إيصال المعاملة</h1>
          <p style="color: #666; font-size: 16px; margin: 0;">رقم المرجع: ${t.transactionReference||t.id}</p>
          <p style="color: #888; font-size: 14px; margin: 5px 0 0 0;">${new Date().toLocaleString("ar-EG")}</p>
        </div>
        
        <!-- Shop Info -->
        <div style="background: #f8fafc; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
          <h3 style="color: #1e293b; margin: 0 0 15px 0; font-size: 18px;">معلومات المحل</h3>
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span style="font-weight: 600; color: #475569;">اسم المحل:</span>
            <span style="color: #1e293b;">${t.merchantShopName||t.shopName||"غير محدد"}</span>
          </div>
        </div>
        
        <!-- Transaction Details -->
        <div style="background: #fff; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
          <h3 style="color: #1e293b; margin: 0 0 15px 0; font-size: 18px;">تفاصيل المعاملة</h3>
          
          <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
            <span style="font-weight: 600; color: #475569;">نوع المعاملة:</span>
            <span style="color: #2563eb; font-weight: 600;">${I(t.type)}</span>
          </div>
          
          <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
            <span style="font-weight: 600; color: #475569;">الحالة:</span>
            <span style="color: ${t.status==="completed"?"#16a34a":t.status==="pending"?"#ca8a04":"#dc2626"}; font-weight: 600;">
              ${x(t.status)}
            </span>
          </div>

          ${t!=null&&t.cashierName?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الكاشير:</span>
              <span style="color: #1e293b;">${t.cashierName}</span>
            </div>
          `:""}
          
          ${t.type!=="withdraw"?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">${T}</span>
              <span style="color: #1e293b;">${k}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الرقم المستقبل:</span>
              <span style="color: #1e293b;">${t.receiverNumber||t.receiverPhone}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">المبلغ المحول:</span>
              <span style="color: #2563eb; font-weight: bold; font-size: 16px;">${t.transferredAmount||t.amount} جنيه</span>
            </div>
          `:`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">رقم المحفظة:</span>
              <span style="color: #1e293b;">${t.senderPhone}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">المبلغ المسحوب:</span>
              <span style="color: #dc2626; font-weight: bold; font-size: 16px;">${t.withdrawnAmountDetailed||t.withdrawnAmount||t.amount} جنيه</span>
            </div>
          `}
          
          ${t.commission?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">العمولة:</span>
              <span style="color: #f59e0b; font-weight: 600;">${t.commission} جنيه</span>
            </div>
          `:""}
          
          <div style="display: flex; justify-content: space-between; padding: 8px 0;">
            <span style="font-weight: 600; color: #475569;">التاريخ والوقت:</span>
            <span style="color: #1e293b;">${t.createdAt.toLocaleString("ar-EG")}</span>
          </div>
        </div>
        
        <!-- Total Amount -->
        <div style="background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); border-radius: 12px; padding: 20px; margin-bottom: 20px; text-align: center;">
          <h3 style="color: white; margin: 0 0 10px 0; font-size: 16px;">إجمالي المبلغ</h3>
          <p style="color: white; font-size: 24px; font-weight: bold; margin: 0;">
            ${t.type==="withdraw"?"-":""}${t.amount} جنيه
          </p>
        </div>
        
        
        
        
        <!-- Footer -->
        <div style="text-align: center; color: #64748b; font-size: 12px; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
          <p style="margin: 0 0 5px 0;">شكراً لاستخدام خدماتنا</p>
          <p style="margin: 0;">تم إنشاء الإيصال في: ${new Date().toLocaleString("ar-EG")}</p>
        </div>
      </div>
    `,V=window.open("","_blank");V&&(V.document.write(`
        <html>
          <head>
            <title>إيصال المعاملة - ${t.transactionReference||t.id}</title>
            <meta charset="UTF-8">
            <style>
              body { 
                margin: 0; 
                padding: 20px; 
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: #f8fafc;
              }
              @media print {
                body { 
                  margin: 0; 
                  background: white;
                }
              }
            </style>
          </head>
          <body>
            ${O}
          </body>
        </html>
      `),V.document.close(),V.print())},g=()=>{window.confirm("هل أنت متأكد من حذف هذه المعاملة؟ لا يمكن التراجع عن هذا الإجراء.")&&(u(t.id),v())};return e.jsx(re,{open:i,onOpenChange:v,children:e.jsxs(le,{className:"w-[92vw] sm:w-auto sm:max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx(ne,{children:e.jsxs(ie,{className:"flex items-center gap-2 text-xl",children:[e.jsx(Ar,{className:"h-6 w-6 text-blue-600"}),"إيصال المعاملة المفصل"]})}),e.jsxs("div",{className:"space-y-6",children:[e.jsx(Re,{className:"bg-gradient-to-r from-blue-50 to-indigo-50 border-blue-200",children:e.jsxs(ct,{className:"text-center pb-2",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 mb-2",children:[j(t.status),e.jsx(yt,{variant:t.status==="completed"?"default":"secondary",className:"text-sm",children:x(t.status)})]}),e.jsxs("h3",{className:"text-2xl font-bold text-blue-600",children:[t.type==="withdraw"?"-":"",t.amount," جنيه"]}),e.jsxs("p",{className:"text-sm text-gray-600",children:["رقم المرجع: ",t.transactionReference||t.id]})]})}),e.jsxs(Re,{children:[e.jsx(ct,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ki,{className:"h-5 w-5 text-green-600"}),e.jsx("h4",{className:"font-semibold text-lg",children:"معلومات المحل"})]})}),e.jsxs(Ve,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"اسم المحل:"}),e.jsx("span",{className:"text-gray-900",children:t.merchantShopName||t.shopName||"غير محدد"})]}),(t==null?void 0:t.cashierName)&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"الكاشير:"}),e.jsx("span",{className:"text-gray-900",children:t.cashierName})]})]})]}),e.jsxs(Re,{children:[e.jsx(ct,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Oa,{className:"h-5 w-5 text-blue-600"}),e.jsx("h4",{className:"font-semibold text-lg",children:"تفاصيل المعاملة"})]})}),e.jsx(Ve,{className:"space-y-3",children:e.jsxs("div",{className:"grid grid-cols-1 gap-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-blue-700",children:"نوع المعاملة:"}),e.jsx(yt,{variant:"outline",className:"bg-blue-100 text-blue-800",children:I(t.type)})]}),t.type!=="withdraw"?e.jsxs(e.Fragment,{children:[(()=>{const h=!!t.senderNumber,p=!!t.senderName,T=h?"الرقم المرسل:":p?"الرقم الراسل:":"رقم المحفظة:",k=h?t.senderNumber:p?t.senderName:t.senderPhone,O=h?kr:zt;return e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(O,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:T})]}),e.jsx("span",{className:"text-gray-900 font-mono",children:k})]})})(),e.jsx("div",{className:"flex items-center justify-center p-2",children:e.jsx(Pi,{className:"h-6 w-6 text-blue-500"})}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-green-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(kr,{className:"h-4 w-4 text-green-500"}),e.jsx("span",{className:"font-medium text-green-700",children:"الرقم المستقبل:"})]}),e.jsx("span",{className:"text-green-900 font-mono",children:t.receiverNumber||t.receiverPhone})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(He,{className:"h-4 w-4 text-blue-500"}),e.jsx("span",{className:"font-medium text-blue-700",children:"المبلغ المحول:"})]}),e.jsxs("span",{className:"text-blue-900 font-bold text-lg",children:[t.transferredAmount||t.amount," جنيه"]})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(zt,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:"رقم المحفظة:"})]}),e.jsx("span",{className:"text-gray-900 font-mono",children:t.senderPhone})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-red-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(He,{className:"h-4 w-4 text-red-500"}),e.jsx("span",{className:"font-medium text-red-700",children:"المبلغ المسحوب:"})]}),e.jsxs("span",{className:"text-red-900 font-bold text-lg",children:[t.withdrawnAmountDetailed||t.withdrawnAmount||t.amount," جنيه"]})]})]}),t.commission&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-yellow-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-yellow-700",children:"العمولة:"}),e.jsxs("span",{className:"text-yellow-900 font-semibold",children:[t.commission," جنيه"]})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ds,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:"التاريخ والوقت:"})]}),e.jsx("span",{className:"text-gray-900",children:t.createdAt.toLocaleString("ar-EG")})]})]})})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs(c,{onClick:M,className:"flex-1 bg-blue-600 hover:bg-blue-700 text-white",size:"lg",children:[e.jsx(Ai,{className:"h-5 w-5 mr-2"}),"طباعة الإيصال"]}),e.jsxs(c,{onClick:g,variant:"destructive",className:"flex-1",size:"lg",children:[e.jsx(wt,{className:"h-5 w-5 mr-2"}),"حذف المعاملة"]})]}),e.jsx(c,{onClick:v,variant:"outline",className:"w-full",size:"lg",children:"إغلاق الإيصال"})]})]})})};function Fl({open:i,onOpenChange:v,onSuccess:t,title:u,description:j,currentBalance:x,balanceLabel:I,userId:M}){const[g,h]=l.useState(""),[p,T]=l.useState(x.toString()),[k,O]=l.useState(!1),[V,K]=l.useState(""),[F,S]=l.useState(!1),$=Zt.hasMasterPin(),Z=async P=>{P.preventDefault(),K(""),S(!0);try{const z=parseFloat(p);if(isNaN(z)||z<0){K("يرجى إدخال مبلغ صحيح"),S(!1);return}$?Zt.verifyMasterPin(g)?(t(z),v(!1),h(""),T("")):K("الرقم السري غير صحيح"):K("لم يتم تعيين رقم سري رئيسي. يرجى تعيين رقم سري رئيسي أولاً من إعدادات التطبيق")}catch{K("حدث خطأ أثناء التحقق من الرقم السري")}finally{S(!1)}},B=()=>{h(""),T(x.toString()),K(""),v(!1)};return et.useEffect(()=>{i&&T(x.toString())},[x,i]),e.jsx(re,{open:i,onOpenChange:B,children:e.jsxs(le,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ne,{children:e.jsxs(ie,{className:"flex items-center gap-2 text-right",children:[e.jsx(He,{className:"h-5 w-5"}),u]})}),e.jsxs("form",{onSubmit:Z,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:j}),e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg",children:[e.jsxs(q,{className:"text-sm font-medium text-gray-700",children:[I," الحالي"]}),e.jsxs("div",{className:"text-lg font-bold text-gray-900 mt-1",children:[x.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"newAmount",className:"text-right",children:"المبلغ الجديد"}),e.jsx(U,{id:"newAmount",type:"number",step:"0.01",min:"0",value:p,onChange:P=>T(P.target.value),placeholder:"أدخل المبلغ الجديد",className:"text-right",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"pin",className:"text-right",children:"الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"pin",type:k?"text":"password",value:g,onChange:P=>h(P.target.value),placeholder:"أدخل الرقم السري",className:"text-right pr-10",required:!0}),e.jsx(c,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>O(!k),children:k?e.jsx(bt,{className:"h-4 w-4"}):e.jsx(Ge,{className:"h-4 w-4"})})]})]}),V&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-red-600 bg-red-50 p-2 rounded",children:[e.jsx(xs,{className:"h-4 w-4"}),V]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(c,{type:"button",variant:"outline",onClick:B,className:"flex-1",children:"إلغاء"}),e.jsx(c,{type:"submit",disabled:F||!g||!p,className:"flex-1",children:F?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"جاري التحديث..."]}):e.jsxs(e.Fragment,{children:[e.jsx(hs,{className:"h-4 w-4 mr-2"}),"تحديث الرصيد"]})})]})]})]})})}class Ta{static getSecretKey(v){return v?`${this.SECRET_KEY_BASE}_${v}`:this.SECRET_KEY_BASE}static setSecretPin(v,t){const u=btoa(v);localStorage.setItem(this.getSecretKey(t),u)}static hasSecretPin(v){return localStorage.getItem(this.getSecretKey(v))!==null}static verifySecretPin(v,t){const u=localStorage.getItem(this.getSecretKey(t));if(!u)return!1;try{return atob(u)===v}catch{return!1}}static clearSecretPin(v){localStorage.removeItem(this.getSecretKey(v))}}Pl(Ta,"SECRET_KEY_BASE","dashboard_secret_pin");function Qi({open:i,onOpenChange:v,userId:t}){const[u,j]=l.useState(""),[x,I]=l.useState(""),[M,g]=l.useState(""),[h,p]=l.useState(!1),[T,k]=l.useState(!1),[O,V]=l.useState(!1),[K,F]=l.useState(""),[S,$]=l.useState(!1),{toast:Z}=Ft(),B=Ta.hasSecretPin(t),P=async se=>{se.preventDefault(),F(""),$(!0);try{if(!x||x.length<4){F("يجب أن يكون الرقم السري 4 أرقام على الأقل"),$(!1);return}if(x!==M){F("الرقم السري الجديد وتأكيده غير متطابقين"),$(!1);return}if(B){if(!u){F("يرجى إدخال الرقم السري الحالي"),$(!1);return}if(!Ta.verifySecretPin(u,t)){F("الرقم السري الحالي غير صحيح"),$(!1);return}}Ta.setSecretPin(x,t),Z({title:B?"تم تغيير الرقم السري":"تم تعيين الرقم السري",description:B?"تم تغيير الرقم السري بنجاح":"تم تعيين الرقم السري بنجاح"}),z()}catch{F("حدث خطأ أثناء حفظ الرقم السري")}finally{$(!1)}},z=()=>{j(""),I(""),g(""),F(""),p(!1),k(!1),V(!1),v(!1)};return e.jsx(re,{open:i,onOpenChange:z,children:e.jsxs(le,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ne,{children:e.jsxs(ie,{className:"flex items-center gap-2 text-right",children:[e.jsx($l,{className:"h-5 w-5"}),B?"تغيير الرقم السري":"تعيين الرقم السري"]})}),e.jsxs("form",{onSubmit:P,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:B?"أدخل الرقم السري الحالي والرقم السري الجديد لتغييره":"أدخل الرقم السري الجديد الذي تريد استخدامه في عمليات التعديل"}),B&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"currentPin",type:h?"text":"password",value:u,onChange:se=>j(se.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(c,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>p(!h),children:h?e.jsx(bt,{className:"h-4 w-4"}):e.jsx(Ge,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"newPin",type:T?"text":"password",value:x,onChange:se=>I(se.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(c,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>k(!T),children:T?e.jsx(bt,{className:"h-4 w-4"}):e.jsx(Ge,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"confirmPin",type:O?"text":"password",value:M,onChange:se=>g(se.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(c,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>V(!O),children:O?e.jsx(bt,{className:"h-4 w-4"}):e.jsx(Ge,{className:"h-4 w-4"})})]})]}),K&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(xs,{className:"h-4 w-4"}),K]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(c,{type:"submit",disabled:S,className:"flex-1",children:[e.jsx(hs,{className:"h-4 w-4 mr-2"}),S?"جاري الحفظ...":B?"تغيير الرقم السري":"تعيين الرقم السري"]}),e.jsx(c,{type:"button",variant:"outline",onClick:z,disabled:S,children:"إلغاء"})]})]})]})})}function Zi({open:i,onOpenChange:v,userId:t}){const[u,j]=l.useState(""),[x,I]=l.useState(""),[M,g]=l.useState(""),[h,p]=l.useState(!1),[T,k]=l.useState(!1),[O,V]=l.useState(!1),[K,F]=l.useState(""),[S,$]=l.useState(!1),{toast:Z}=Ft(),B=t?`cash_drawer_pin_${t}`:"cash_drawer_pin",P=()=>localStorage.getItem(B)!==null,z=H=>{const Q=localStorage.getItem(B);if(!Q)return!1;try{return atob(Q)===H}catch{return!1}},se=H=>{const Q=btoa(H);localStorage.setItem(B,Q)},X=async H=>{H.preventDefault(),F(""),$(!0);try{if(!x||x.length<4){F("يجب أن يكون الرقم السري 4 أرقام على الأقل"),$(!1);return}if(x!==M){F("الرقم السري الجديد وتأكيده غير متطابقين"),$(!1);return}if(P()){if(!u){F("يرجى إدخال الرقم السري الحالي لدرج النقدية"),$(!1);return}if(!z(u)){F("الرقم السري الحالي لدرج النقدية غير صحيح"),$(!1);return}}se(x),Z({title:P()?"تم تغيير رقم درج النقدية":"تم تعيين رقم درج النقدية",description:P()?"تم تغيير الرقم السري لدرج النقدية بنجاح":"تم تعيين الرقم السري لدرج النقدية بنجاح"}),xe()}catch{F("حدث خطأ أثناء حفظ الرقم السري لدرج النقدية")}finally{$(!1)}},xe=()=>{j(""),I(""),g(""),F(""),p(!1),k(!1),V(!1),v(!1)};return e.jsx(re,{open:i,onOpenChange:xe,children:e.jsxs(le,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ne,{children:e.jsxs(ie,{className:"flex items-center gap-2 text-right",children:[e.jsx(He,{className:"h-5 w-5 text-green-600"}),P()?"تغيير رقم درج النقدية":"تعيين رقم درج النقدية"]})}),e.jsxs("form",{onSubmit:X,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:P()?"أدخل الرقم السري الحالي والرقم السري الجديد لدرج النقدية":"أدخل الرقم السري الجديد الذي تريد استخدامه لحماية درج النقدية"}),P()&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي لدرج النقدية"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"currentPin",type:h?"text":"password",value:u,onChange:H=>j(H.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(c,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>p(!h),children:h?e.jsx(bt,{className:"h-4 w-4"}):e.jsx(Ge,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد لدرج النقدية"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"newPin",type:T?"text":"password",value:x,onChange:H=>I(H.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(c,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>k(!T),children:T?e.jsx(bt,{className:"h-4 w-4"}):e.jsx(Ge,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"confirmPin",type:O?"text":"password",value:M,onChange:H=>g(H.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(c,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>V(!O),children:O?e.jsx(bt,{className:"h-4 w-4"}):e.jsx(Ge,{className:"h-4 w-4"})})]})]}),K&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(xs,{className:"h-4 w-4"}),K]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(c,{type:"submit",disabled:S,className:"flex-1 bg-green-600 hover:bg-green-700",children:[e.jsx(hs,{className:"h-4 w-4 mr-2"}),S?"جاري الحفظ...":P()?"تغيير رقم درج النقدية":"تعيين رقم درج النقدية"]}),e.jsx(c,{type:"button",variant:"outline",onClick:xe,disabled:S,children:"إلغاء"})]})]}),e.jsx("div",{className:"text-xs text-gray-500 text-center mt-2",children:"💰 هذا الرقم السري خاص بحماية درج النقدية فقط"})]})})}function Xi({open:i,onOpenChange:v,userId:t}){const[u,j]=l.useState(""),[x,I]=l.useState(""),[M,g]=l.useState(""),[h,p]=l.useState(!1),[T,k]=l.useState(!1),[O,V]=l.useState(!1),[K,F]=l.useState(""),[S,$]=l.useState(!1),{toast:Z}=Ft(),B=t?`wallet_total_pin_${t}`:"wallet_total_pin",P=()=>localStorage.getItem(B)!==null,z=H=>{const Q=localStorage.getItem(B);if(!Q)return!1;try{return atob(Q)===H}catch{return!1}},se=H=>{const Q=btoa(H);localStorage.setItem(B,Q)},X=async H=>{H.preventDefault(),F(""),$(!0);try{if(!x||x.length<4){F("يجب أن يكون الرقم السري 4 أرقام على الأقل"),$(!1);return}if(x!==M){F("الرقم السري الجديد وتأكيده غير متطابقين"),$(!1);return}if(P()){if(!u){F("يرجى إدخال الرقم السري الحالي لإجمالي المحفظة"),$(!1);return}if(!z(u)){F("الرقم السري الحالي لإجمالي المحفظة غير صحيح"),$(!1);return}}se(x),Z({title:P()?"تم تغيير رقم إجمالي المحفظة":"تم تعيين رقم إجمالي المحفظة",description:P()?"تم تغيير الرقم السري لإجمالي المحفظة بنجاح":"تم تعيين الرقم السري لإجمالي المحفظة بنجاح"}),xe()}catch{F("حدث خطأ أثناء حفظ الرقم السري لإجمالي المحفظة")}finally{$(!1)}},xe=()=>{j(""),I(""),g(""),F(""),p(!1),k(!1),V(!1),v(!1)};return e.jsx(re,{open:i,onOpenChange:xe,children:e.jsxs(le,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ne,{children:e.jsxs(ie,{className:"flex items-center gap-2 text-right",children:[e.jsx(Wt,{className:"h-5 w-5 text-blue-600"}),P()?"تغيير رقم إجمالي المحفظة":"تعيين رقم إجمالي المحفظة"]})}),e.jsxs("form",{onSubmit:X,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:P()?"أدخل الرقم السري الحالي والرقم السري الجديد لإجمالي المحفظة":"أدخل الرقم السري الجديد الذي تريد استخدامه لحماية إجمالي المحفظة"}),P()&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي لإجمالي المحفظة"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"currentPin",type:h?"text":"password",value:u,onChange:H=>j(H.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(c,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>p(!h),children:h?e.jsx(bt,{className:"h-4 w-4"}):e.jsx(Ge,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد لإجمالي المحفظة"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"newPin",type:T?"text":"password",value:x,onChange:H=>I(H.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(c,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>k(!T),children:T?e.jsx(bt,{className:"h-4 w-4"}):e.jsx(Ge,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"confirmPin",type:O?"text":"password",value:M,onChange:H=>g(H.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(c,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>V(!O),children:O?e.jsx(bt,{className:"h-4 w-4"}):e.jsx(Ge,{className:"h-4 w-4"})})]})]}),K&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(xs,{className:"h-4 w-4"}),K]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(c,{type:"submit",disabled:S,className:"flex-1 bg-blue-600 hover:bg-blue-700",children:[e.jsx(hs,{className:"h-4 w-4 mr-2"}),S?"جاري الحفظ...":P()?"تغيير رقم إجمالي المحفظة":"تعيين رقم إجمالي المحفظة"]}),e.jsx(c,{type:"button",variant:"outline",onClick:xe,disabled:S,children:"إلغاء"})]})]}),e.jsx("div",{className:"text-xs text-gray-500 text-center mt-2",children:"💼 هذا الرقم السري خاص بحماية إجمالي المحفظة فقط"})]})})}function eo({open:i,onOpenChange:v,onSuccess:t,title:u,description:j,currentBalance:x,balanceLabel:I,userId:M}){const[g,h]=l.useState(""),[p,T]=l.useState(""),[k,O]=l.useState("add"),[V,K]=l.useState(!1),[F,S]=l.useState(""),[$,Z]=l.useState(!1),B=Zt.hasMasterPin(),P=async X=>{X.preventDefault(),S(""),Z(!0);try{const xe=parseFloat(p);if(isNaN(xe)||xe<=0){S("يرجى إدخال مبلغ صحيح أكبر من صفر"),Z(!1);return}if(k==="subtract"&&xe>x){S("لا يمكن خصم مبلغ أكبر من الرصيد الحالي"),Z(!1);return}if(B)if(Zt.verifyMasterPin(g)){const H=k==="add"?xe:-xe;z(),t(H)}else S("الرقم السري غير صحيح");else S("لم يتم تعيين رقم سري رئيسي. يرجى تعيين رقم سري رئيسي أولاً من إعدادات التطبيق")}catch{S("حدث خطأ أثناء التحقق من الرقم السري")}finally{Z(!1)}},z=()=>{h(""),T(""),O("add"),S(""),v(!1)},se=()=>{const X=parseFloat(p)||0;return k==="add"?x+X:x-X};return e.jsx(re,{open:i,onOpenChange:z,children:e.jsxs(le,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ne,{children:e.jsxs(ie,{className:"flex items-center gap-2 text-right",children:[k==="add"?e.jsx(ot,{className:"h-5 w-5 text-green-600"}):e.jsx(os,{className:"h-5 w-5 text-red-600"}),u]})}),e.jsxs("form",{onSubmit:P,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:j}),e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg",children:[e.jsxs(q,{className:"text-sm font-medium text-gray-700",children:[I," الحالي"]}),e.jsxs("div",{className:"text-lg font-bold text-gray-900 mt-1",children:[x.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{className:"text-right",children:"نوع العملية"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(c,{type:"button",variant:k==="add"?"default":"outline",onClick:()=>O("add"),className:"flex-1 flex items-center gap-2",children:[e.jsx(ot,{className:"h-4 w-4"}),"إضافة"]}),e.jsxs(c,{type:"button",variant:k==="subtract"?"default":"outline",onClick:()=>O("subtract"),className:"flex-1 flex items-center gap-2",children:[e.jsx(os,{className:"h-4 w-4"}),"خصم"]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(q,{htmlFor:"amount",className:"text-right",children:["المبلغ المراد ",k==="add"?"إضافته":"خصمه"]}),e.jsx(U,{id:"amount",type:"number",step:"0.01",min:"0.01",value:p,onChange:X=>T(X.target.value),placeholder:`أدخل المبلغ المراد ${k==="add"?"إضافته":"خصمه"}`,className:"text-right",required:!0})]}),p&&!isNaN(parseFloat(p))&&e.jsxs("div",{className:`p-3 rounded-lg ${k==="add"?"bg-green-50 border border-green-200":"bg-red-50 border border-red-200"}`,children:[e.jsx(q,{className:"text-sm font-medium text-gray-700",children:"الرصيد الجديد المتوقع"}),e.jsxs("div",{className:`text-lg font-bold mt-1 ${k==="add"?"text-green-700":"text-red-700"}`,children:[se().toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"pin",className:"text-right",children:"الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"pin",type:V?"text":"password",value:g,onChange:X=>h(X.target.value),placeholder:"أدخل الرقم السري",className:"text-right pr-10",required:!0}),e.jsx(c,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>K(!V),children:V?e.jsx(bt,{className:"h-4 w-4"}):e.jsx(Ge,{className:"h-4 w-4"})})]})]}),F&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-red-600 bg-red-50 p-2 rounded",children:[e.jsx(xs,{className:"h-4 w-4"}),F]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(c,{type:"button",variant:"outline",onClick:z,className:"flex-1",children:"إلغاء"}),e.jsx(c,{type:"submit",disabled:$||!g||!p,className:`flex-1 ${k==="add"?"bg-green-600 hover:bg-green-700":"bg-red-600 hover:bg-red-700"}`,children:$?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"جاري التحديث..."]}):e.jsxs(e.Fragment,{children:[e.jsx(hs,{className:"h-4 w-4 mr-2"}),k==="add"?"إضافة المبلغ":"خصم المبلغ"]})})]})]})]})})}const Bl=({isOpen:i,onClose:v,onTrialStarted:t})=>{const{user:u}=Xt(),[j,x]=l.useState(!1),[I,M]=l.useState(!1),[g,h]=l.useState(""),[p,T]=l.useState(24);l.useEffect(()=>{const O=async()=>{if(u!=null&&u.uid){const K=await Hs.getTrialData(u.uid);M(K.hasUsedFreeTrial)}},V=async()=>{try{const K=await Hs.getTrialDurationHours();T(K)}catch{}};i&&(O(),V())},[i,u]);const k=async()=>{if(u!=null&&u.uid){x(!0);try{const O=await Hs.startFreeTrial(u.uid);O.success?window.location.href="/user/dashboard":h(O.message)}catch{h("حدث خطأ أثناء تفعيل التجربة المجانية")}finally{x(!1)}}};return e.jsxs(e.Fragment,{children:[i&&e.jsx("div",{className:"fixed inset-0 z-40",style:{background:"rgba(0, 0, 0, 0.15)",backdropFilter:"blur(3px)",WebkitBackdropFilter:"blur(3px)",pointerEvents:"auto"}}),e.jsx(re,{open:i,onOpenChange:()=>{},children:e.jsxs(le,{className:"sm:max-w-lg z-50 border-0 shadow-2xl",style:{position:"fixed",top:"50%",left:"50%",transform:"translate(-50%, -50%)",pointerEvents:"auto",background:"linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 0.95) 100%)",backdropFilter:"blur(10px)",WebkitBackdropFilter:"blur(10px)",borderRadius:"20px",border:"1px solid rgba(255, 255, 255, 0.3)"},children:[e.jsxs(ne,{className:"text-center pb-2",children:[e.jsx("div",{className:"flex justify-center mb-6",children:e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-0 rounded-full",style:{background:"linear-gradient(135deg, #f59e0b, #d97706)",filter:"blur(8px)",opacity:.3}}),e.jsx("div",{className:"relative bg-gradient-to-br from-orange-400 to-orange-600 p-4 rounded-full",children:e.jsx(Ui,{className:"h-12 w-12 text-white"})})]})}),e.jsx(ie,{className:"text-2xl font-bold bg-gradient-to-r from-gray-800 to-gray-600 bg-clip-text text-transparent text-center",children:"تفعيل الحساب مطلوب"})]}),e.jsxs("div",{className:"text-center py-6 px-2",children:[e.jsxs("div",{className:"bg-gradient-to-r from-orange-50 to-amber-50 rounded-xl p-6 mb-6 border border-orange-100",children:[e.jsx("p",{className:"text-gray-700 text-lg leading-relaxed font-medium",children:"حسابك في انتظار التفعيل من قبل المسؤول"}),e.jsx("p",{className:"text-sm font-semibold text-orange-700 mt-3 mb-3 bg-orange-100 p-3 rounded-lg border border-orange-200",children:"للتفعيل السريع: تواصل مع الإدارة عبر واتساب فقط على الرقم التالي"}),e.jsxs("div",{className:"bg-green-50 p-4 rounded-lg border border-green-200 mt-3",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"text-base font-bold text-green-700",children:"واتساب الإدارة:"}),e.jsx("a",{href:"https://wa.me/201000392539",target:"_blank",rel:"noopener noreferrer",className:"text-lg font-bold text-green-600 hover:text-green-700 underline",children:"01000392539"})]}),e.jsx("p",{className:"text-sm text-green-600 mt-2 text-center",children:"اضغط على الرقم للتواصل المباشر عبر واتساب"})]})]}),!I&&e.jsxs("div",{className:"bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-4 mb-4 border border-green-200",children:[e.jsxs("div",{className:"flex items-center justify-center mb-2",children:[e.jsx(Ol,{className:"h-5 w-5 text-green-600 ml-2"}),e.jsxs("span",{className:"text-green-700 font-semibold",children:["تجربة مجانية لمدة ",p>=3&&p<=10?`${p} ساعات`:p===2?"ساعتين":`${p} ساعة`]})]}),e.jsxs("p",{className:"text-green-600 text-sm text-center",children:["احصل على وصول كامل لجميع الميزات لمدة ",p>=3&&p<=10?`${p} ساعات`:p===2?"ساعتين":`${p} ساعة`," مجاناً"]})]}),g&&e.jsx("div",{className:`rounded-xl p-4 mb-4 text-center ${g.includes("تم تفعيل")?"bg-green-50 border border-green-200 text-green-700":"bg-red-50 border border-red-200 text-red-700"}`,children:e.jsx("p",{className:"font-medium",children:g})}),e.jsxs("div",{className:"flex items-center justify-center space-x-2 text-sm text-gray-500 mb-4",children:[e.jsxs("div",{className:"flex space-x-1",children:[e.jsx("div",{className:"w-2 h-2 bg-orange-400 rounded-full animate-pulse"}),e.jsx("div",{className:"w-2 h-2 bg-orange-400 rounded-full animate-pulse",style:{animationDelay:"0.2s"}}),e.jsx("div",{className:"w-2 h-2 bg-orange-400 rounded-full animate-pulse",style:{animationDelay:"0.4s"}})]}),e.jsx("span",{className:"mr-2",children:"في انتظار التفعيل"})]})]}),e.jsxs("div",{className:"flex flex-col space-y-3 pb-2",children:[!I&&!g.includes("تم تفعيل")&&e.jsxs(c,{onClick:k,disabled:j,className:"relative bg-gradient-to-r from-blue-600 via-purple-600 to-indigo-600 hover:from-blue-700 hover:via-purple-700 hover:to-indigo-700 text-white px-10 py-4 rounded-2xl font-bold text-xl shadow-2xl hover:shadow-3xl transition-all duration-500 transform hover:scale-110 hover:-translate-y-1 disabled:opacity-50 disabled:cursor-not-allowed overflow-hidden group",style:{boxShadow:"0 15px 35px rgba(99, 102, 241, 0.4), 0 5px 15px rgba(0, 0, 0, 0.1)"},children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-white/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"}),e.jsx("div",{className:"absolute -top-1 -left-1 w-3 h-3 bg-yellow-400 rounded-full animate-ping"}),e.jsx("div",{className:"absolute -top-1 -right-1 w-2 h-2 bg-green-400 rounded-full animate-pulse"}),j?e.jsxs("div",{className:"flex items-center relative z-10",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-white ml-3"}),e.jsx("span",{className:"bg-gradient-to-r from-white to-gray-100 bg-clip-text text-transparent",children:"جاري التفعيل..."})]}):e.jsxs("div",{className:"flex items-center relative z-10",children:[e.jsx(Ol,{className:"h-6 w-6 ml-3 animate-bounce"}),e.jsx("span",{className:"bg-gradient-to-r from-white to-gray-100 bg-clip-text text-transparent",children:"🎉 ابدأ التجربة المجانية"})]})]}),e.jsx(c,{onClick:v,variant:"outline",className:"border-2 border-gray-300 hover:border-gray-400 text-gray-700 hover:text-gray-800 px-10 py-3 rounded-xl font-semibold text-lg transition-all duration-300 transform hover:scale-105",children:I?"فهمت":"إغلاق"})]})]})})]})};function to({isOpen:i,onClose:v}){const[t,u]=l.useState("0"),[j,x]=l.useState(null),[I,M]=l.useState(null),[g,h]=l.useState(!1),p=B=>{g?(u(B),h(!1)):u(t==="0"?B:t+B)},T=B=>{const P=parseFloat(t);if(j===null)x(P);else if(I){const se=k(j||0,P,I);u(String(se)),x(se)}h(!0),M(B)},k=(B,P,z)=>{switch(z){case"+":return B+P;case"-":return B-P;case"×":return B*P;case"÷":return P===0?0:B/P;case"=":return P;default:return P}},O=()=>{const B=parseFloat(t);if(j!==null&&I){const P=k(j,B,I);u(String(P)),x(null),M(null),h(!0)}},V=()=>{u("0"),x(null),M(null),h(!1)},K=()=>{u("0")},F=()=>{g?(u("0."),h(!1)):t.indexOf(".")===-1&&u(t+".")},S=()=>{t!=="0"&&u(t.charAt(0)==="-"?t.slice(1):"-"+t)},$=()=>{const B=parseFloat(t);u(String(B/100))},Z=B=>{const P=B.key;B.preventDefault(),P>="0"&&P<="9"?p(P):P==="+"?T("+"):P==="-"?T("-"):P==="*"?T("×"):P==="/"?T("÷"):P==="Enter"||P==="="?O():P==="Escape"||P==="c"||P==="C"?V():P==="Backspace"?K():P==="."?F():P==="%"&&$()};return l.useEffect(()=>(i?document.addEventListener("keydown",Z):document.removeEventListener("keydown",Z),()=>{document.removeEventListener("keydown",Z)}),[i,t,j,I,g]),e.jsx(re,{open:i,onOpenChange:B=>!B&&v(),children:e.jsxs(le,{className:"sm:max-w-md",children:[e.jsx(ne,{children:e.jsxs(ie,{className:"flex items-center gap-2 text-right",children:[e.jsx(Yl,{className:"h-5 w-5"}),"آلة حاسبة"]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-gray-900 text-white p-4 rounded-lg text-right",children:e.jsx("div",{className:"text-3xl font-mono font-bold min-h-[3rem] flex items-center justify-end overflow-hidden",children:t})}),e.jsxs("div",{className:"grid grid-cols-4 gap-2",children:[e.jsx(c,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:V,children:"AC"}),e.jsx(c,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:K,children:"CE"}),e.jsx(c,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:$,children:"%"}),e.jsx(c,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>T("÷"),children:"÷"}),e.jsx(c,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>p("7"),children:"7"}),e.jsx(c,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>p("8"),children:"8"}),e.jsx(c,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>p("9"),children:"9"}),e.jsx(c,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>T("×"),children:"×"}),e.jsx(c,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>p("4"),children:"4"}),e.jsx(c,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>p("5"),children:"5"}),e.jsx(c,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>p("6"),children:"6"}),e.jsx(c,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>T("-"),children:"-"}),e.jsx(c,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>p("1"),children:"1"}),e.jsx(c,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>p("2"),children:"2"}),e.jsx(c,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>p("3"),children:"3"}),e.jsx(c,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>T("+"),children:"+"}),e.jsx(c,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50 col-span-2",onClick:()=>p("0"),children:"0"}),e.jsx(c,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:F,children:"."}),e.jsx(c,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:O,children:"="})]}),e.jsx(c,{variant:"outline",className:"w-full h-10 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:S,children:"+/-"})]})]})})}function so({isOpen:i,onClose:v}){const[t,u]=l.useState([]),[j,x]=l.useState({productName:"",price:"",wholesalePrice:"",quantity:""}),[I,M]=l.useState(!1);l.useState(null);const{toast:g}=Ft(),{user:h,profile:p}=Xt(),[T,k]=l.useState([]),[O,V]=l.useState({}),[K,F]=l.useState({}),[S,$]=l.useState(0),[Z,B]=l.useState(0),[P,z]=l.useState(!1),[se,X]=l.useState(!0),[xe,H]=l.useState(!1),[Q,Y]=l.useState(""),L=l.useMemo(()=>{const f=Q.trim().toLowerCase();return f?T.filter(_=>_.name.toLowerCase().includes(f)):T},[T,Q]);l.useEffect(()=>{i&&(h!=null&&h.uid)&&(Be(),se||Le())},[i,h==null?void 0:h.uid,se]);const ae=async()=>{if(h!=null&&h.uid)try{const f=p==null?void 0:p.shopId;let _;if(f){const ue=Is(Ht(tt,"products"),St("shopId","==",f));if(_=await Ts(ue),_.empty){const Ie=Is(Ht(tt,"products"),St("userId","==",h.uid));_=await Ts(Ie)}}else{const ue=Is(Ht(tt,"products"),St("userId","==",h.uid));_=await Ts(ue)}const ee=_.docs.map(ue=>({id:ue.id,name:String(ue.data().name??""),sellingPrice:Number(ue.data().sellingPrice??0),wholesalePrice:Number(ue.data().wholesalePrice??0),quantity:Number(ue.data().quantity??0)}));k(ee)}catch(f){console.error("Error loading shop products:",f)}};l.useEffect(()=>{i&&(h!=null&&h.uid)&&(ae(),Le())},[i,h==null?void 0:h.uid,p==null?void 0:p.shopId]);const Be=()=>{if(!(h!=null&&h.uid)){console.log("No user authenticated, cannot load sales data");return}const f=new Date().toISOString().split("T")[0],_=localStorage.getItem(`salesData_${h.uid}_${f}`);u(_?JSON.parse(_):[])},We=f=>{if(!(h!=null&&h.uid)){console.log("No user authenticated, cannot save sales data");return}const _=new Date().toISOString().split("T")[0];localStorage.setItem(`salesData_${h.uid}_${_}`,JSON.stringify(f)),u(f)},Le=async()=>{if(h!=null&&h.uid)try{const f=new Date,_=new Date(f.getFullYear(),f.getMonth(),1),ee=new Date(f.getFullYear(),f.getMonth()+1,0),ue=Bt=>Bt.toISOString().split("T")[0],Ie=ue(_),ze=ue(ee),st=Is(Ht(tt,"dailySales"),St("userId","==",h.uid),St("date",">=",Ie),St("date","<=",ze)),gt=await Ts(st);let Dt=0,es=0;gt.forEach(Bt=>{const D=Bt.data(),G=Number(D.sellingPrice??0),oe=Number(D.quantity??0),be=Number(D.profit??(Number(D.sellingPrice??0)-Number(D.wholesalePrice??0))*oe);Dt+=G*oe,es+=be}),$(Dt),B(es)}catch(f){console.error("Error loading monthly stats:",f)}},Oe=async f=>{if(h!=null&&h.uid)try{const _=((f.price??0)-(f.wholesalePrice??0))*(f.quantity??0);await Al(Ht(tt,"dailySales"),{userId:h.uid,productName:f.productName,quantity:f.quantity,wholesalePrice:f.wholesalePrice??null,sellingPrice:f.price,profit:_,date:f.date,time:f.time,createdAt:Vs()})}catch(_){console.error("Error saving sale:",_)}},dt=async f=>{const _=O[f.id]||"",ee=parseInt(_);if(isNaN(ee)||ee<=0){g({title:"كمية غير صالحة",description:"أدخل كمية صحيحة للبيـع",variant:"destructive"});return}if(ee>f.quantity){g({title:"كمية أكبر من المتاح",description:"الكمية المطلوب بيعها تتجاوز المخزون المتاح",variant:"destructive"});return}const ue=new Date,Ie={id:Date.now().toString(),productName:f.name,price:f.sellingPrice,wholesalePrice:f.wholesalePrice,quantity:ee,date:ue.toISOString().split("T")[0],time:ue.toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit"})};try{We([...t,Ie]),await Oe(Ie);const ze=f.quantity-ee;await Gs(_t(tt,"products",f.id),{quantity:ze,updatedAt:Vs()}),k(st=>st.map(gt=>gt.id===f.id?{...gt,quantity:ze}:gt)),V(st=>({...st,[f.id]:""})),g({title:"تم البيع",description:`تم بيع ${ee} قطعة من ${f.name}`})}catch(ze){console.error("Error selling product:",ze),g({title:"فشل البيع",description:"تعذّر تنفيذ عملية البيع",variant:"destructive"})}},Ze=async f=>{const _=K[f.id]||"",ee=parseInt(_);if(isNaN(ee)||ee<=0){g({title:"كمية غير صالحة",description:"أدخل كمية صحيحة للإضافة",variant:"destructive"});return}try{const ue=f.quantity+ee;await Gs(_t(tt,"products",f.id),{quantity:ue,updatedAt:Vs()}),k(Ie=>Ie.map(ze=>ze.id===f.id?{...ze,quantity:ue}:ze)),F(Ie=>({...Ie,[f.id]:""})),g({title:"تمت الإضافة",description:`تمت إضافة ${ee} قطعة إلى ${f.name}`})}catch(ue){console.error("Error adding pieces:",ue),g({title:"فشل الإضافة",description:"تعذّر إضافة الكمية إلى المخزون",variant:"destructive"})}},Jt=async f=>{if(!(!(h!=null&&h.uid)||!window.confirm(`هل تريد حذف المنتج "${f.name}"؟`)))try{await fi(_t(tt,"products",f.id)),k(ee=>ee.filter(ue=>ue.id!==f.id)),g({title:"تم الحذف",description:`تم حذف المنتج ${f.name}`})}catch(ee){console.error("Error deleting product:",ee),g({title:"فشل الحذف",description:"تعذّر حذف المنتج",variant:"destructive"})}},Nt=async()=>{try{if(!(h!=null&&h.uid)){g({title:"خطأ",description:"غير مسجّل دخول",variant:"destructive"});return}const f=j.productName.trim(),_=parseFloat(j.price),ee=parseFloat(j.wholesalePrice||"0"),ue=parseInt(j.quantity);if(!f||isNaN(_)||isNaN(ue)){g({title:"بيانات غير مكتملة",description:"أدخل اسم المنتج والسعر والكمية",variant:"destructive"});return}const Ie={name:f,sellingPrice:_,wholesalePrice:isNaN(ee)?0:ee,quantity:isNaN(ue)?0:ue,userId:h.uid,createdAt:Vs(),updatedAt:Vs()};p!=null&&p.shopId&&(Ie.shopId=p.shopId);const ze=await Al(Ht(tt,"products"),Ie);k(st=>[{id:ze.id,name:f,sellingPrice:_,wholesalePrice:isNaN(ee)?0:ee,quantity:isNaN(ue)?0:ue},...st]),x({productName:"",price:"",wholesalePrice:"",quantity:""}),g({title:"تمت الإضافة",description:`تم إضافة المنتج ${f} بنجاح`})}catch(f){console.error("createProduct error",f),g({title:"فشل الإضافة",description:"تعذّر إضافة المنتج. حاول مجددًا",variant:"destructive"})}};return e.jsxs(re,{open:i,onOpenChange:v,children:[e.jsxs(le,{className:"max-w-7xl md:max-w-6xl lg:max-w-7xl w-[95vw] md:w-[90vw] h-[95vh] md:h-[90vh] p-0 overflow-y-auto",children:[e.jsx(ne,{className:"px-3 md:px-6 py-3 md:py-4 border-b bg-gradient-to-r from-blue-50 to-purple-50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 md:gap-3",children:[e.jsx("div",{className:"p-1.5 md:p-2 bg-blue-100 rounded-lg",children:e.jsx(Tr,{className:"h-5 w-5 md:h-6 md:w-6 text-blue-600"})}),e.jsxs("div",{children:[e.jsx(ie,{className:"text-lg md:text-xl font-bold text-gray-800",children:"📊 بيانات المبيعات اليومية"}),e.jsxs("p",{className:"text-xs md:text-sm text-gray-600 mt-1 hidden sm:block",children:["إدارة وتتبع مبيعات اليوم - ",new Date().toLocaleDateString("ar-EG")]})]})]}),e.jsx("div",{className:"flex items-center gap-1 md:gap-2",children:e.jsx(c,{variant:"ghost",size:"sm",onClick:v,className:"h-8 w-8 md:h-9 md:w-9",children:e.jsx(_l,{className:"h-4 w-4"})})})]})}),e.jsxs("div",{className:"flex flex-col md:flex-row h-full",dir:"rtl",children:[e.jsxs("div",{className:"w-full md:w-80 lg:w-96 bg-white/50 border-r",children:[e.jsxs("div",{className:"p-3 md:p-4 border-b bg-white/30",children:[e.jsxs("h3",{className:"font-semibold text-gray-800 mb-3 flex items-center gap-2 text-sm md:text-base",children:[e.jsx(He,{className:"h-4 w-4 text-green-600"}),"ملخص المبيعات"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 md:gap-3",children:[e.jsxs("div",{className:"bg-blue-50 p-2 md:p-3 rounded-lg text-center",children:[e.jsx("div",{className:"text-lg md:text-xl font-bold text-blue-600",children:it(t.reduce((f,_)=>f+_.price*_.quantity,0))}),e.jsx("div",{className:"text-xs md:text-sm text-blue-600",children:"إجمالي المبيعات"})]}),e.jsxs("div",{className:"bg-green-50 p-2 md:p-3 rounded-lg text-center",children:[e.jsx("div",{className:"text-lg md:text-xl font-bold text-green-600",children:it(t.reduce((f,_)=>f+(_.price-(_.wholesalePrice??0))*_.quantity,0))}),e.jsx("div",{className:"text-xs md:text-sm text-green-600",children:"إجمالي الأرباح"})]}),e.jsxs("div",{className:"bg-yellow-50 p-2 md:p-3 rounded-lg text-center",children:[e.jsx("div",{className:"text-lg md:text-xl font-bold text-yellow-600",children:bs(T.length)}),e.jsx("div",{className:"text-xs md:text-sm text-yellow-600",children:"عدد المنتجات"})]}),e.jsxs("div",{className:"bg-purple-50 p-2 md:p-3 rounded-lg text-center",children:[e.jsx("div",{className:"text-lg md:text-xl font-bold text-purple-600",children:bs(t.length)}),e.jsx("div",{className:"text-xs md:text-sm text-purple-600",children:"عدد المبيعات"})]})]}),e.jsxs("div",{className:"relative mb-2",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-1 md:gap-2 text-xs md:text-sm font-semibold text-indigo-700",children:[e.jsx(ds,{className:"h-3 w-3 md:h-4 md:w-4"}),e.jsx(Tr,{className:"h-3 w-3 md:h-4 md:w-4"}),e.jsx("span",{children:"تقارير الشهر"})]}),e.jsx(c,{size:"sm",variant:"ghost",onClick:()=>H(f=>!f),className:"h-6 w-6 p-0 rounded-full",title:xe?"إظهار التقارير":"إخفاء التقارير",children:xe?e.jsx(zl,{className:"h-4 w-4"}):e.jsx(Jl,{className:"h-4 w-4"})})]}),e.jsx("div",{className:xe?"overflow-hidden max-h-0 transition-[max-height] duration-300":"overflow-hidden transition-[max-height] duration-300 max-h-[400px]",children:e.jsxs("div",{className:se?"grid grid-cols-2 gap-2 md:gap-4 filter blur-sm pointer-events-none":"grid grid-cols-2 gap-2 md:gap-4",children:[e.jsxs("div",{className:"bg-indigo-50 p-2 md:p-3 rounded-lg text-center",children:[e.jsx("div",{className:"text-lg md:text-xl font-bold text-indigo-600",children:it(S)}),e.jsx("div",{className:"text-xs md:text-sm text-indigo-600",children:"مبيعات الشهر"})]}),e.jsxs("div",{className:"bg-pink-50 p-2 md:p-3 rounded-lg text-center",children:[e.jsx("div",{className:"text-lg md:text-xl font-bold text-pink-600",children:it(Z)}),e.jsx("div",{className:"text-xs md:text-sm text-pink-600",children:"أرباح الشهر"})]})]})}),!xe&&se&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center rounded-lg bg-yellow-100/60",children:e.jsxs(c,{size:"sm",variant:"ghost",onClick:async()=>{try{if(await isZeroPlan()){g({title:"الخطة زيرو",description:"التقارير الشهرية غير متاحة في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}catch{}z(!0)},className:"flex items-center gap-2 bg-yellow-200/70 hover:bg-yellow-300 text-yellow-900 px-3 py-2 rounded-xl shadow-md hover:shadow-lg transition-all",title:"عرض تقارير الشهر",children:[e.jsx(Ge,{className:"h-5 w-5 md:h-7 md:w-7"}),e.jsx("span",{className:"text-xs md:text-sm",children:"عرض تقارير الشهر"})]})})]})]}),e.jsx("div",{className:"p-3 md:p-4 border-b bg-white/30",children:e.jsxs("h3",{className:"font-semibold text-gray-800 mb-3 flex items-center gap-2 text-sm md:text-base",children:[e.jsx(Ca,{className:"h-4 w-4 text-indigo-600"}),"إحصائيات المنتجات"]})}),e.jsx("div",{className:"p-3 md:p-4 flex-1 overflow-y-auto hidden md:block",children:e.jsxs("h3",{className:"font-semibold text-gray-800 mb-3 flex items-center gap-2",children:[e.jsx(Pr,{className:"h-4 w-4 text-blue-600"}),"نصائح للمبيعات"]})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto transition-all duration-300 ease-in-out scrollbar-thin scrollbar-thumb-blue-300 scrollbar-track-blue-100 hover:scrollbar-thumb-blue-400",children:e.jsxs("div",{className:"p-3 md:p-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 md:mb-6 gap-2",children:[e.jsxs("h2",{className:"text-base md:text-lg font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(Ri,{className:"h-4 w-4 md:h-5 md:w-5 text-blue-600"}),"سجل المبيعات (",t.length," عنصر)"]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs md:text-sm text-gray-600",children:[e.jsx(ds,{className:"h-3 w-3 md:h-4 md:w-4"}),e.jsx("span",{className:"hidden sm:inline",children:new Date().toLocaleDateString("ar-EG")}),e.jsx(ms,{className:"h-3 w-3 md:h-4 md:w-4 ml-2"}),e.jsx("span",{children:new Date().toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit"})})]})]}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-3 md:p-4 mb-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("h3",{className:"text-sm md:text-base font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(ot,{className:"h-4 w-4 text-emerald-600"}),"إضافة منتج جديد"]}),e.jsxs(c,{size:"sm",variant:"ghost",className:"h-8",onClick:()=>M(f=>!f),children:[e.jsx(ot,{className:"h-4 w-4 text-emerald-600"}),"إضافة منتج"]})]}),I&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx(q,{htmlFor:"new-product-name",className:"text-xs md:text-sm",children:"اسم المنتج"}),e.jsx(U,{id:"new-product-name",value:j.productName,onChange:f=>x(_=>({..._,productName:f.target.value})),placeholder:"أدخل اسم المنتج"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx(q,{htmlFor:"new-product-price",className:"text-xs md:text-sm",children:"سعر البيع (ج.م)"}),e.jsx(U,{type:"number",id:"new-product-price",value:j.price,onChange:f=>x(_=>({..._,price:f.target.value})),placeholder:"0.00"})]}),e.jsxs("div",{children:[e.jsx(q,{htmlFor:"new-product-wholesale",className:"text-xs md:text-sm",children:"سعر الجملة (ج.م)"}),e.jsx(U,{type:"number",id:"new-product-wholesale",value:j.wholesalePrice||"",onChange:f=>x(_=>({..._,wholesalePrice:f.target.value})),placeholder:"0.00"})]})]}),e.jsxs("div",{children:[e.jsx(q,{htmlFor:"new-product-qty",className:"text-xs md:text-sm",children:"الكمية"}),e.jsx(U,{type:"number",id:"new-product-qty",value:j.quantity,onChange:f=>x(_=>({..._,quantity:f.target.value})),placeholder:"1"})]}),e.jsx(c,{className:"w-full md:w-auto",onClick:Nt,children:"إضافة المنتج"})]})]}),e.jsx("div",{id:"shop-products-section",className:"bg-white rounded-lg border border-gray-200 overflow-hidden mb-4",children:e.jsxs("div",{className:"mb-4",children:[e.jsxs("h3",{className:"text-sm md:text-base font-semibold text-gray-800 mb-2 flex items-center gap-2",children:[e.jsx(Ca,{className:"h-4 w-4 text-green-600"}),"منتجات المحل"]}),e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(U,{value:Q,onChange:f=>Y(f.target.value),placeholder:"ابحث عن منتج...",className:"h-9 w-full md:w-72 text-sm","aria-label":"البحث عن منتج من منتجات المحل"}),Q&&e.jsx(c,{variant:"ghost",size:"sm",className:"h-9",onClick:()=>Y(""),children:"مسح"})]}),e.jsx("div",{className:"overflow-x-auto border border-gray-200 rounded-lg hidden md:block",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"المنتج"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"سعر البيع"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"سعر الجملة"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"المتاح"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"بيع"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:L.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"px-3 py-3 text-center text-gray-500",children:T.length===0?"لا توجد منتجات بعد، أضف منتجاً من النموذج أعلاه":"لا توجد نتائج مطابقة للبحث"})}):L.map(f=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-3 py-2 font-medium text-gray-900",children:f.name}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:it(f.sellingPrice)}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:it(f.wholesalePrice)}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:bs(f.quantity)}),e.jsx("td",{className:"px-3 py-2",children:e.jsxs("div",{className:"flex items-center gap-2 flex-nowrap",children:[e.jsx(U,{value:O[f.id]||"",onChange:_=>V(ee=>({...ee,[f.id]:_.target.value})),type:"number",placeholder:"عدد القطع للبيع",className:"h-8 w-28 text-sm"}),e.jsx(c,{size:"sm",className:"h-8",onClick:()=>dt(f),children:"بيع"}),e.jsx(U,{value:K[f.id]||"",onChange:_=>F(ee=>({...ee,[f.id]:_.target.value})),type:"number",placeholder:"عدد للإضافة",className:"h-8 w-28 text-sm"}),e.jsxs("div",{className:"inline-flex items-center gap-2 flex-nowrap",children:[e.jsx(c,{size:"sm",variant:"outline",className:"h-8",onClick:()=>Ze(f),children:"إضافة قطع جديدة"}),e.jsx(c,{size:"sm",variant:"destructive",className:"h-8",onClick:()=>Jt(f),title:"حذف المنتج",children:e.jsx(wt,{className:"h-4 w-4"})})]})]})})]},f.id))})]})}),e.jsx("div",{className:"block md:hidden space-y-3",children:L.length===0?e.jsx("div",{className:"text-center text-gray-500 text-sm",children:T.length===0?"لا توجد منتجات بعد، أضف منتجاً من النموذج أعلاه":"لا توجد نتائج مطابقة للبحث"}):L.map(f=>e.jsxs("div",{className:"bg-white rounded-xl p-3 border border-gray-200 shadow-sm",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"font-semibold text-gray-900 text-sm break-words",children:f.name}),e.jsx(c,{size:"sm",variant:"destructive",className:"h-8 min-w-[44px] touch-manipulation",onClick:()=>Jt(f),title:"حذف المنتج",children:e.jsx(wt,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-2 text-xs text-gray-700",children:[e.jsx("div",{className:"text-gray-600",children:"سعر البيع"}),e.jsx("div",{className:"text-right font-medium",children:it(f.sellingPrice)}),e.jsx("div",{className:"text-gray-600",children:"سعر الجملة"}),e.jsx("div",{className:"text-right font-medium",children:it(f.wholesalePrice)}),e.jsx("div",{className:"text-gray-600",children:"المتاح"}),e.jsx("div",{className:"text-right font-medium",children:bs(f.quantity)})]}),e.jsxs("div",{className:"mt-3 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(U,{value:O[f.id]||"",onChange:_=>V(ee=>({...ee,[f.id]:_.target.value})),type:"number",placeholder:"عدد القطع للبيع",className:"h-9 flex-1 text-sm","aria-label":`عدد القطع للبيع لـ ${f.name}`}),e.jsx(c,{size:"sm",className:"h-9 min-w-[64px]",onClick:()=>dt(f),children:"بيع"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(U,{value:K[f.id]||"",onChange:_=>F(ee=>({...ee,[f.id]:_.target.value})),type:"number",placeholder:"عدد للإضافة",className:"h-9 flex-1 text-sm","aria-label":`عدد القطع للإضافة لـ ${f.name}`}),e.jsx(c,{size:"sm",variant:"outline",className:"h-9 min-w-[64px]",onClick:()=>Ze(f),children:"إضافة"})]})]})]},f.id))})]})}),t.length===0?e.jsxs("div",{className:"text-center py-8 md:py-12",children:[e.jsx("div",{className:"w-16 h-16 md:w-24 md:h-24 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center",children:e.jsx(Ca,{className:"h-8 w-8 md:h-12 md:w-12 text-gray-400"})}),e.jsx("h3",{className:"text-base md:text-lg font-medium text-gray-900 mb-2",children:"لا توجد مبيعات اليوم"}),e.jsx("p",{className:"text-sm text-gray-500",children:"ابدأ ببيع منتج من القائمة أعلاه"})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"block md:hidden",children:e.jsx("div",{className:"max-h-[70vh] overflow-y-auto space-y-3 p-3",children:t.map(f=>e.jsxs("div",{className:"bg-white rounded-xl p-4 border border-gray-200 shadow-sm",children:[e.jsx("div",{className:"mb-3",children:e.jsx("h4",{className:"font-semibold text-gray-900 text-base break-words",children:f.productName})}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-2 text-sm text-gray-700",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(He,{className:"h-4 w-4 text-blue-600"}),e.jsx("span",{className:"text-gray-600",children:"سعر البيع"})]}),e.jsx("div",{className:"text-right font-medium",children:it(f.price)}),typeof f.wholesalePrice=="number"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(He,{className:"h-4 w-4 text-indigo-600"}),e.jsx("span",{className:"text-gray-600",children:"سعر الجملة"})]}),e.jsx("div",{className:"text-right font-medium",children:it(f.wholesalePrice)})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ca,{className:"h-4 w-4 text-emerald-600"}),e.jsx("span",{className:"text-gray-600",children:"الكمية"})]}),e.jsx("div",{className:"text-right font-medium",children:bs(f.quantity)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ps,{className:"h-4 w-4 text-purple-600"}),e.jsx("span",{className:"text-gray-600",children:"الربح"})]}),e.jsx("div",{className:"text-right font-semibold text-purple-700",children:it(((f.price??0)-(f.wholesalePrice??0))*(f.quantity??0))}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(He,{className:"h-4 w-4 text-green-600"}),e.jsx("span",{className:"text-gray-600",children:"الإجمالي"})]}),e.jsx("div",{className:"text-right font-bold text-green-700",children:it(f.price*f.quantity)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ds,{className:"h-4 w-4 text-blue-600"}),e.jsx("span",{className:"text-gray-600",children:"التاريخ"})]}),e.jsx("div",{className:"text-right text-gray-600",children:Ll(f.date)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ms,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"text-gray-600",children:"الوقت"})]}),e.jsx("div",{className:"text-right text-gray-600",children:f.time})]})]},f.id))})}),e.jsx("div",{className:"hidden md:block overflow-x-auto max-h-96 overflow-y-auto scrollbar-thin scrollbar-thumb-green-300 scrollbar-track-green-100 hover:scrollbar-thumb-green-400",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"المنتج"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"سعر البيع (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"سعر الجملة (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الكمية"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الإجمالي (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الربح (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"التاريخ"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الوقت"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:t.map((f,_)=>e.jsxs("tr",{className:_%2===0?"bg-white":"bg-gray-50/50",children:[e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-gray-900",children:f.productName}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:it(f.price)}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:typeof f.wholesalePrice=="number"?it(f.wholesalePrice):"-"}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:bs(f.quantity)}),e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-green-600",children:it(f.price*f.quantity)}),e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-purple-600",children:it(((f.price??0)-(f.wholesalePrice??0))*(f.quantity??0))}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-500",children:Ll(f.date)}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-500",children:f.time})]},f.id))})]})})]}),e.jsxs("div",{className:"mt-4 md:mt-6 text-xs text-gray-500 text-center bg-gray-50/50 p-2 md:p-3 rounded border border-gray-200/40 space-y-1",children:[e.jsx("p",{className:"font-medium text-gray-600",children:"💰 نظام إدارة المبيعات اليومية"}),e.jsxs("p",{className:"hidden sm:block",children:["• يتم حفظ البيانات تلقائياً لليوم الحالي: ",new Date().toLocaleDateString("ar-EG")]}),e.jsx("p",{children:"• يمكنك إضافة وتعديل وحذف المنتجات حسب الحاجة"}),e.jsx("p",{className:"hidden sm:block",children:"• يتم حفظ البيانات محلياً وعلى Firebase لتعزيز الأمان"})]})]})})]})]}),e.jsx(Zs,{open:P,onOpenChange:z,mode:"verify",title:"قفل إحصائيات الشهر",description:"لا يمكن الاطلاع على تقارير الشهر إلا بإدخال الرقم السري الرئيسي",onSuccess:async()=>{try{const f=h==null?void 0:h.uid;if(f){const _=await Wr(f),ee=(_==null?void 0:_.planType)??(_==null?void 0:_.plan)??null,ue=typeof ee=="string"?ee.toLowerCase():null;if(ee===Qt.ZERO||ue==="zero"){g({title:"الخطة زيرو",description:"التقارير الشهرية غير متاحة في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}}catch{}X(!1),z(!1),Le()}})]})}const bs=i=>new Intl.NumberFormat("ar-EG").format(Number(i||0)),it=i=>`${new Intl.NumberFormat("ar-EG",{minimumFractionDigits:2,maximumFractionDigits:2}).format(Number(i||0))} ج.م`,Ll=i=>{try{const v=new Date(i);return isNaN(v.getTime())?new Date(`${i}T00:00:00`).toLocaleDateString("ar-EG"):v.toLocaleDateString("ar-EG")}catch{return i}};function Ql({size:i=24,className:v,...t}){return e.jsxs("svg",{width:i,height:i,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",className:v,...t,children:[e.jsx("rect",{x:"5",y:"2.5",width:"14",height:"19",rx:"2.5",stroke:"currentColor",strokeWidth:"1.5"}),e.jsx("rect",{x:"7",y:"4.5",width:"10",height:"5.5",rx:"1",stroke:"currentColor",strokeWidth:"1.2"}),e.jsx("path",{d:"M9.5 11.5h5",stroke:"currentColor",strokeWidth:"1.4",strokeLinecap:"round"}),e.jsx("circle",{cx:"8.5",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"12",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"15.5",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"8.5",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"12",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"15.5",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("rect",{x:"8",y:"19",width:"9",height:"1.8",rx:"0.6",stroke:"currentColor",strokeWidth:"1"})]})}const It=i=>{try{return i.toLocaleString("ar-EG",{maximumFractionDigits:2})}catch{return String(i)}},ao=i=>{try{return(i?new Date(i):new Date).toLocaleString("ar-EG",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"})}catch{return new Date().toISOString()}},El="machine_daily_opening_values",Ml="machine_daily_receipts";function ro({open:i,onOpenChange:v}){const{toast:t}=Ft(),{shiftUser:u}=Ba(),[j,x]=l.useState(""),[I,M]=l.useState(""),[g,h]=l.useState(null),[p,T]=l.useState(null),[k,O]=l.useState(!1),[V,K]=l.useState(""),[F,S]=l.useState(""),[$,Z]=l.useState(null),[B,P]=l.useState(()=>{try{const Y=localStorage.getItem(Ml),L=Y?JSON.parse(Y):[];return Array.isArray(L)?L:[]}catch{return[]}});l.useEffect(()=>{if(i)try{const Y=localStorage.getItem(El);if(Y){const L=JSON.parse(Y);typeof(L==null?void 0:L.openingBase)=="number"&&h(L.openingBase),typeof(L==null?void 0:L.openingAir)=="number"&&T(L.openingAir)}}catch{}},[i]),l.useEffect(()=>{try{localStorage.setItem(Ml,JSON.stringify(B))}catch{}},[B]);const z=l.useMemo(()=>(u==null?void 0:u.displayName)||(u==null?void 0:u.name)||(u==null?void 0:u.username)||void 0,[u]),se=()=>{const Y=parseFloat(j||"0"),L=parseFloat(I||"0");if(isNaN(Y)||isNaN(L)){t({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة للرصيد الافتتاحي.",variant:"destructive"});return}if(Y<0||L<0){t({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}h(Y),T(L);try{localStorage.setItem(El,JSON.stringify({openingBase:Y,openingAir:L}))}catch{}t({title:"تم تسجيل البيانات",description:`الافتتاحي الأساسي: ${It(Y)}، الهواء: ${It(L)}`})},X=()=>{if(g==null||p==null){t({title:"سجل الرصيد الافتتاحي أولاً",description:'يرجى الضغط على زر "إضافة" بعد إدخال الافتتاحي.'});return}O(!0)},xe=()=>{const Y=parseFloat(V||"0"),L=parseFloat(F||"0");if(isNaN(Y)||isNaN(L)){t({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة لرصيد التسليم.",variant:"destructive"});return}if(Y<0||L<0){t({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}const ae=(g||0)+(p||0),We=Y+L-ae;Z(We);const Le={id:`${Date.now()}`,openingBase:g||0,openingAir:p||0,deliveryBase:Y,deliveryAir:L,netResult:We,createdAt:new Date().toISOString(),cashierName:z};P(Oe=>[Le,...Oe]),t({title:"تم إنشاء إيصال تسليم",description:`الناتج النهائي: ${It(We)}`})},H=()=>{x(""),M(""),O(!1),K(""),S(""),Z(null)},Q=Y=>{Y||H(),v(Y)};return e.jsx(re,{open:i,onOpenChange:Q,children:e.jsxs(le,{className:"w-[92vw] sm:w-auto sm:max-w-2xl max-h-[85vh] overflow-y-auto",children:[e.jsxs(ne,{className:"space-y-2",children:[e.jsx(ie,{className:"flex items-center justify-between text-right",children:e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(Ql,{className:"h-5 w-5 text-yellow-500"}),"يومية المكنة"]})}),e.jsx(Gt,{className:"text-right",children:'أدخل الرصيد الافتتاحي، ثم في نهاية اليوم قم بإدخال رصيد التسليم لإنشاء إيصال منظم باسم "إيصالات ماكينة".'})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-6",children:[e.jsxs(Re,{children:[e.jsx(ct,{className:"pb-2",children:e.jsx(jt,{className:"text-right",children:"الرصيد الافتتاحي"})}),e.jsxs(Ve,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الرصيد الأساسي"}),e.jsx(U,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:j,onChange:Y=>x(Y.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"رصيد الهواء"}),e.jsx(U,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:I,onChange:Y=>M(Y.target.value),placeholder:"0.00",className:"text-right"})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(c,{onClick:se,className:"bg-violet-600 hover:bg-violet-700",children:"إضافة"}),g!=null&&p!=null&&e.jsxs(yt,{className:"bg-violet-100 text-violet-700 border border-violet-200",children:["تم التسجيل: أساسي ",It(g)," | هواء ",It(p)]})]})]})]}),e.jsxs(Re,{children:[e.jsx(ct,{className:"pb-2",children:e.jsx(jt,{className:"text-right",children:"نهاية اليوم"})}),e.jsx(Ve,{className:"space-y-4",children:k?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الرصيد الأساسي الحالي"}),e.jsx(U,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:V,onChange:Y=>K(Y.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"رصيد الهواء الحالي"}),e.jsx(U,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:F,onChange:Y=>S(Y.target.value),placeholder:"0.00",className:"text-right"})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(c,{variant:"secondary",onClick:()=>O(!1),children:"إلغاء"}),e.jsx(c,{onClick:xe,className:"bg-green-600 hover:bg-green-700",children:"تسليم"})]}),$!=null&&e.jsx("div",{className:"mt-3 text-right",children:e.jsxs(yt,{className:$>=0?"bg-green-100 text-green-700 border border-green-200":"bg-red-100 text-red-700 border border-red-200",children:["الناتج النهائي: ",It($)]})})]}):e.jsx("div",{className:"flex justify-end",children:e.jsx(c,{variant:"outline",onClick:X,className:"border-violet-300 text-violet-700",children:"تسليم يومية"})})})]}),e.jsxs(Re,{children:[e.jsx(ct,{className:"pb-2",children:e.jsxs(jt,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-right",children:"إيصالات ماكينة"}),e.jsx(Ar,{className:"h-4 w-4 text-gray-500"})]})}),e.jsx(Ve,{className:"space-y-3",children:B.length===0?e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد إيصالات حتى الآن."}):e.jsx("div",{className:"space-y-3",children:B.map(Y=>e.jsxs("div",{className:"rounded-lg border p-3 grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"الافتتاحي"}),e.jsxs("p",{className:"text-sm",children:["أساسي: ",It(Y.openingBase)]}),e.jsxs("p",{className:"text-sm",children:["هواء: ",It(Y.openingAir)]})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"التسليم"}),e.jsxs("p",{className:"text-sm",children:["أساسي: ",It(Y.deliveryBase)]}),e.jsxs("p",{className:"text-sm",children:["هواء: ",It(Y.deliveryAir)]})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"النتيجة"}),e.jsx("p",{className:`text-sm ${Y.netResult>=0?"text-green-700":"text-red-700"}`,children:It(Y.netResult)}),e.jsxs("div",{className:"flex items-center justify-end gap-2 text-xs text-gray-500",children:[e.jsx(ds,{className:"h-3 w-3"}),e.jsx("span",{children:ao(Y.createdAt)}),Y.cashierName&&e.jsxs(e.Fragment,{children:[e.jsx(ql,{orientation:"vertical",className:"h-3"}),e.jsxs("span",{children:["الكاشير: ",Y.cashierName]})]})]})]})]},Y.id))})})]})]}),e.jsxs(Ce,{className:"flex items-center justify-between",children:[e.jsx(c,{variant:"outline",onClick:()=>Q(!1),children:"إغلاق"}),e.jsxs("div",{className:"text-xs text-gray-500 flex items-center gap-1",children:[e.jsx(ms,{className:"h-3 w-3"}),e.jsx("span",{children:"يسجل التاريخ والوقت تلقائياً لكل إيصال"})]})]})]})})}function lo(i,v=300){const[t,u]=et.useState(i);return et.useEffect(()=>{const j=setTimeout(()=>u(i),v);return()=>clearTimeout(j)},[i,v]),t}const no=({userId:i,transactions:v})=>{const[t,u]=l.useState(!1),[j,x]=l.useState(!1),[I,M]=l.useState(!1),[g,h]=l.useState({monthlyWithdrawalProfit:0,monthlyTransferProfit:0,lastUpdated:new Date}),{userSubscription:p}=Xt();l.useEffect(()=>{i&&t&&I&&T()},[i,t,I]);const T=async()=>{if(i)try{const F=As.getWithdrawTransferProfits(i);h({monthlyWithdrawalProfit:F.monthlyWithdrawProfit||0,monthlyTransferProfit:F.monthlyTransferProfit||0,lastUpdated:new Date})}catch(F){console.error("Error loading profit data:",F)}},k=F=>`${F.toFixed(2)} ج.م`,O=async()=>{try{const F=(p==null?void 0:p.subscription)||null,S=(F==null?void 0:F.planType)??(F==null?void 0:F.plan)??null,$=typeof S=="string"?S.toLowerCase():null;if(S===Qt.ZERO||$==="zero"||$==="0"||S===0)return!0}catch{}try{if(i){const F=await Wr(i),S=(F==null?void 0:F.planType)??(F==null?void 0:F.plan)??null,$=typeof S=="string"?S.toLowerCase():null;if(S===Qt.ZERO||$==="zero"||$==="0"||S===0)return!0}}catch{}return!1},V=async()=>{try{if(await O()){Wl({title:"الخطة زيرو",description:"عرض الأرباح الشهرية غير متاح في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}catch{}x(!0)},K=async()=>{try{if(await O()){Wl({title:"الخطة زيرو",description:"عرض الأرباح الشهرية غير متاح في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"}),x(!1);return}}catch{}M(!0),u(!0),x(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(c,{size:"sm",variant:"ghost",onClick:V,className:"h-2 w-2 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded transition-all duration-300 hover:scale-110 shadow-sm hover:shadow-md",title:"عرض الأرباح الشهرية",children:e.jsx(Ge,{className:"h-1.5 w-1.5"})}),e.jsx(re,{open:t,onOpenChange:u,children:e.jsxs(le,{className:"max-w-[220px] mx-auto bg-white border border-gray-200 shadow-md rounded sm:max-w-[180px] sm:bg-gradient-to-br sm:from-purple-50 sm:to-white sm:border-2 sm:border-purple-200 sm:shadow-2xl sm:rounded-2xl",children:[e.jsx(ne,{className:"text-center pb-0 border-b-0 sm:pb-2 sm:border-b sm:border-purple-200",children:e.jsxs(ie,{className:"text-xs font-bold text-purple-800 flex items-center justify-center gap-0 mb-0 leading-tight tracking-tight sm:text-xs sm:gap-1 sm:mb-0 sm:leading-normal sm:tracking-normal",children:[e.jsx(ds,{className:"h-2 w-2 text-purple-600 sm:h-3 sm:w-3"}),"شهري"]})}),e.jsxs("div",{className:"space-y-0 py-0 sm:space-y-2 sm:py-2",children:[e.jsx("div",{className:"bg-red-50 p-0.5 rounded border border-red-200 sm:bg-gradient-to-r sm:from-red-50 sm:to-red-100 sm:p-2 sm:rounded-xl sm:shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1 sm:gap-2",children:[e.jsx(Aa,{className:"h-2 w-2 text-red-600 sm:h-3 sm:w-3"}),e.jsx("span",{className:"text-[10px] sm:text-xs",children:"سحب"})]}),e.jsx("span",{className:"text-[10px] sm:text-xs font-bold text-red-700",children:k(g.monthlyWithdrawalProfit)})]})}),e.jsx("div",{className:"bg-blue-50 p-0.5 rounded border border-blue-200 sm:bg-gradient-to-r sm:from-blue-50 sm:to-blue-100 sm:p-2 sm:rounded-xl sm:shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1 sm:gap-2",children:[e.jsx(Hl,{className:"h-2 w-2 text-blue-600 sm:h-3 sm:w-3"}),e.jsx("span",{className:"text-[10px] sm:text-xs",children:"تحويل"})]}),e.jsx("span",{className:"text-[10px] sm:text-xs font-bold text-blue-700",children:k(g.monthlyTransferProfit)})]})}),e.jsx("div",{className:"bg-purple-50 p-0.5 rounded border border-purple-200 sm:bg-gradient-to-r sm:from-purple-50 sm:to-purple-100 sm:p-2 sm:rounded-xl sm:shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1 sm:gap-2",children:[e.jsx(He,{className:"h-2 w-2 text-purple-600 sm:h-3 sm:w-3"}),e.jsx("span",{className:"text-[10px] sm:text-xs",children:"إجمالي"})]}),e.jsx("span",{className:"text-[10px] sm:text-xs font-bold text-purple-700",children:k(g.monthlyWithdrawalProfit+g.monthlyTransferProfit)})]})})]}),!I&&e.jsx("div",{className:"absolute inset-0 bg-yellow-200/70 backdrop-blur-sm flex items-center justify-center rounded sm:rounded-2xl border border-yellow-300 pointer-events-auto",children:e.jsx(c,{size:"sm",variant:"ghost",onClick:()=>x(!0),className:"p-2 bg-yellow-300/80 text-yellow-900 hover:bg-yellow-400/90 rounded-full shadow-sm hover:shadow-md transition-all duration-300",title:"إدخال الرقم السري الرئيسي",children:e.jsx(Ge,{className:"h-4 w-4"})})}),e.jsx("div",{className:"flex justify-center pt-0 border-t-0 sm:pt-2 sm:border-t sm:border-purple-200",children:e.jsx(c,{onClick:()=>u(!1),className:"bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-xl text-sm sm:bg-gradient-to-r sm:from-purple-600 sm:to-purple-700 sm:hover:from-purple-700 sm:hover:to-purple-800 sm:px-4 sm:py-1 sm:rounded-xl sm:shadow-lg sm:hover:shadow-xl sm:transition-all sm:duration-300",children:"إغلاق"})})]})}),e.jsx(Zs,{open:j,onOpenChange:x,onSuccess:K,description:"لا يمكن الاطلاع على الأرباح الشهرية إلا بإدخال الرقم السري الرئيسي"})]})},io=i=>e.jsx(no,{...i});function oo({open:i,onOpenChange:v,onSuccess:t,userId:u}){const[j,x]=l.useState(""),[I,M]=l.useState(""),[g,h]=l.useState(!1),[p,T]=l.useState(!1),[k,O]=l.useState(""),[V,K]=l.useState(!1),{toast:F}=Ft(),S=As.hasProfitPin(u),$=()=>{x(""),M(""),O(""),h(!1),T(!1),v(!1)},Z=async B=>{B.preventDefault(),O(""),K(!0);try{if(S){if(!As.verifyProfitPin(j,u)){O("الرقم السري غير صحيح"),K(!1);return}}else{if(j.length<4){O("يجب أن يكون الرقم السري 4 أرقام على الأقل"),K(!1);return}if(j!==I){O("الرقم السري غير متطابق"),K(!1);return}As.setProfitPin(j,u)}F({title:"نجح العملية",description:S?"تم التحقق من الرقم السري بنجاح":"تم إنشاء رقم سري الأرباح بنجاح"}),t(),$()}catch{O("حدث خطأ أثناء معالجة الرقم السري")}finally{K(!1)}};return e.jsx(re,{open:i,onOpenChange:v,children:e.jsxs(le,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ne,{children:e.jsxs(ie,{className:"flex items-center gap-2 text-lg font-semibold",children:[e.jsx(hs,{className:"h-5 w-5 text-green-600"}),S?"أدخل رقم سري الأرباح":"إنشاء رقم سري للأرباح"]})}),e.jsxs("form",{onSubmit:Z,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-gray-600 bg-blue-50 p-3 rounded-lg",children:S?"أدخل الرقم السري لعرض بيانات الأرباح":"قم بإنشاء رقم سري لحماية بيانات الأرباح. يمكنك تغييره لاحقاً من إعدادات البروفيل."}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"pin",children:S?"الرقم السري":"الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"pin",type:g?"text":"password",value:j,onChange:B=>x(B.target.value),placeholder:S?"أدخل الرقم السري":"أدخل رقم سري جديد (4 أرقام على الأقل)",className:"pr-10",dir:"ltr",required:!0}),e.jsx(c,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>h(!g),children:g?e.jsx(bt,{className:"h-4 w-4"}):e.jsx(Ge,{className:"h-4 w-4"})})]})]}),!S&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"confirmPin",children:"تأكيد الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"confirmPin",type:p?"text":"password",value:I,onChange:B=>M(B.target.value),placeholder:"أعد إدخال الرقم السري",className:"pr-10",dir:"ltr",required:!0}),e.jsx(c,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>T(!p),children:p?e.jsx(bt,{className:"h-4 w-4"}):e.jsx(Ge,{className:"h-4 w-4"})})]})]}),k&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(xs,{className:"h-4 w-4"}),k]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(c,{type:"submit",disabled:V,className:"flex-1 bg-green-600 hover:bg-green-700",children:[e.jsx(hs,{className:"h-4 w-4 mr-2"}),V?"جاري المعالجة...":S?"عرض الأرباح":"إنشاء وعرض الأرباح"]}),e.jsx(c,{type:"button",variant:"outline",onClick:$,disabled:V,children:"إلغاء"})]})]})]})})}const co=({userId:i,transactions:v})=>{const[t,u]=l.useState(!1),[j,x]=l.useState(!1),[I,M]=l.useState(!1),[g,h]=l.useState({dailyWithdrawalProfit:0,dailyTransferProfit:0,lastUpdated:new Date});l.useEffect(()=>{i&&t&&I&&p()},[i,t,I]);const p=async()=>{if(i)try{const V=As.getWithdrawTransferProfits(i);h({dailyWithdrawalProfit:V.dailyWithdrawProfit||0,dailyTransferProfit:V.dailyTransferProfit||0,lastUpdated:new Date})}catch(V){console.error("Error loading profit data:",V)}},T=V=>`${V.toFixed(2)} ج.م`,k=()=>{As.hasProfitPin(i),x(!0)},O=()=>{M(!0),u(!0),x(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(c,{size:"sm",variant:"ghost",onClick:k,className:"h-2 w-2 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded transition-all duration-300 hover:scale-110 shadow-sm hover:shadow-md",title:"عرض الأرباح اليومية",children:e.jsx(Ge,{className:"h-1.5 w-1.5"})}),e.jsx(re,{open:t,onOpenChange:u,children:e.jsxs(le,{className:"max-w-[220px] mx-auto bg-white border border-gray-200 shadow-md rounded sm:max-w-[180px] sm:bg-gradient-to-br sm:from-blue-50 sm:to-white sm:border-2 sm:border-blue-200 sm:shadow-2xl sm:rounded-2xl",children:[e.jsx(ne,{className:"text-center pb-0 border-b-0 sm:pb-2 sm:border-b sm:border-blue-200",children:e.jsxs(ie,{className:"text-xs font-bold text-blue-800 flex items-center justify-center gap-0 mb-0 leading-tight tracking-tight sm:text-sm sm:gap-1 sm:mb-0 sm:leading-normal sm:tracking-normal",children:[e.jsx(He,{className:"h-2 w-2 text-blue-600 sm:h-3 sm:w-3"}),"يومي"]})}),e.jsxs("div",{className:"space-y-0 py-0 sm:space-y-2 sm:py-2",children:[e.jsx("div",{className:"bg-red-50 p-0.5 rounded border border-red-200 sm:bg-gradient-to-r sm:from-red-50 sm:to-red-100 sm:p-2 sm:rounded-xl sm:shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between h-4 sm:h-auto",children:[e.jsxs("div",{className:"flex items-center gap-0 sm:gap-1",children:[e.jsx(Aa,{className:"h-2 w-2 text-red-600 sm:h-3 sm:w-3"}),e.jsx("span",{className:"font-medium text-red-800 text-xs leading-tight tracking-tighter sm:font-semibold sm:text-xs sm:leading-normal sm:tracking-normal",children:"سحب"})]}),e.jsx("span",{className:"font-bold text-xs text-red-900 bg-white px-0 py-0 rounded text-center leading-tight tracking-tighter sm:text-sm sm:px-2 sm:py-0.5 sm:leading-normal sm:tracking-normal",children:T(g.dailyWithdrawalProfit)})]})}),e.jsx("div",{className:"bg-green-50 p-0.5 rounded border border-green-200 sm:bg-gradient-to-r sm:from-green-50 sm:to-green-100 sm:p-2 sm:rounded-xl sm:shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between h-4 sm:h-auto",children:[e.jsxs("div",{className:"flex items-center gap-0 sm:gap-1",children:[e.jsx(Hl,{className:"h-2 w-2 text-green-600 sm:h-3 sm:w-3"}),e.jsx("span",{className:"font-medium text-green-800 text-xs leading-tight tracking-tighter sm:font-semibold sm:text-xs sm:leading-normal sm:tracking-normal",children:"تحويل"})]}),e.jsx("span",{className:"font-bold text-xs text-green-900 bg-white px-0 py-0 rounded text-center leading-tight tracking-tighter sm:text-sm sm:px-2 sm:py-0.5 sm:leading-normal sm:tracking-normal",children:T(g.dailyTransferProfit)})]})}),e.jsx("div",{className:"bg-blue-50 p-0.5 rounded border border-blue-200 sm:bg-gradient-to-r sm:from-blue-50 sm:to-blue-100 sm:p-2 sm:rounded-xl sm:shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between h-4 sm:h-auto",children:[e.jsxs("div",{className:"flex items-center gap-0 sm:gap-1",children:[e.jsx(He,{className:"h-2 w-2 text-blue-600 sm:h-3 sm:w-3"}),e.jsx("span",{className:"font-medium text-blue-800 text-xs leading-tight tracking-tighter sm:font-semibold sm:text-xs sm:leading-normal sm:tracking-normal",children:"مجموع"})]}),e.jsx("span",{className:"font-bold text-xs text-blue-900 bg-white px-0 py-0 rounded text-center leading-tight tracking-tighter sm:text-sm sm:px-2 sm:py-0.5 sm:leading-normal sm:tracking-normal",children:T(g.dailyWithdrawalProfit+g.dailyTransferProfit)})]})})]}),e.jsx("div",{className:"flex justify-center pt-0 border-t-0 sm:pt-2 sm:border-t sm:border-blue-200",children:e.jsx(c,{onClick:()=>u(!1),className:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-xl text-sm sm:bg-gradient-to-r sm:from-blue-600 sm:to-blue-700 sm:hover:from-blue-700 sm:hover:to-blue-800 sm:px-4 sm:py-1 sm:rounded-xl sm:shadow-lg sm:hover:shadow-xl sm:transition-all sm:duration-300 sm:text-xs",children:"إغلاق"})})]})}),e.jsx(oo,{open:j,onOpenChange:x,onSuccess:O,userId:i})]})},mo=i=>e.jsx(co,{...i}),Ia=i=>Number(i||0).toFixed(2),ho=({open:i,onOpenChange:v,userId:t})=>{const{toast:u}=Ft(),[j,x]=et.useState([]),[I,M]=et.useState(!1),[g,h]=et.useState("");et.useEffect(()=>{(async()=>{if(!(!i||!t))try{M(!0);const O=[...await Rl.getByUser(t)].sort((V,K)=>V.reportDate<K.reportDate?1:-1);x(O)}catch(k){console.error("Failed to load daily archive history:",k),u({title:"فشل تحميل الأرشيف",description:"تعذر تحميل أرشيف التقارير اليومية",variant:"destructive"})}finally{M(!1)}})()},[i,t]);const p=et.useMemo(()=>{if(!g)return j;const T=g.trim();return j.filter(k=>k.reportDate.includes(T))},[j,g]);return e.jsx(re,{open:i,onOpenChange:v,children:e.jsxs(le,{className:"sm:max-w-xl",children:[e.jsxs(ne,{children:[e.jsx(ie,{children:"أرشيف التقارير اليومية"}),e.jsx(Gt,{children:"يعرض جميع الأيام المؤرشفة مع ملخص لكل يوم."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"archive-search",children:"بحث بالتاريخ (YYYY-MM-DD)"}),e.jsx(U,{id:"archive-search",placeholder:"مثال: 2025-10-19",value:g,onChange:T=>h(T.target.value)})]}),e.jsx("div",{className:"mt-3 space-y-2 max-h-[50vh] overflow-auto",children:I?e.jsx("div",{className:"text-sm text-muted-foreground",children:"جاري التحميل..."}):p.length===0?e.jsx("div",{className:"text-sm text-muted-foreground",children:"لا توجد تقارير مؤرشفة حتى الآن"}):p.map(T=>e.jsxs("div",{className:"border rounded-md p-2 bg-gradient-to-r from-white/80 to-blue-50/70",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{className:"font-bold text-blue-800",children:T.reportDate}),e.jsxs("div",{className:"text-xs text-blue-700",children:["عدد المعاملات: ",T.totalTransactions]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-1",children:[e.jsxs("div",{className:"text-xs text-blue-800",children:["إجمالي المبالغ: ",e.jsx("span",{className:"font-semibold",children:Ia(T.totalAmount)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["المسحوب: ",e.jsx("span",{className:"font-semibold",children:Ia(T.totalWithdrawn)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["المرسل: ",e.jsx("span",{className:"font-semibold",children:Ia(T.totalSent)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["الربح: ",e.jsx("span",{className:"font-semibold",children:Ia(T.profit)})]})]})]},T.id||`${T.userId}-${T.reportDate}`))}),e.jsx(Ce,{children:e.jsx(c,{variant:"outline",onClick:()=>v(!1),children:"إغلاق"})})]})})},xo=({open:i,onOpenChange:v})=>{var vs;const{shiftUser:t,isShiftActive:u,shiftStartAt:j,setShiftUser:x,startShift:I,endShift:M}=Ba(),{userSubscription:g,user:h,signIn:p,profile:T}=Xt(),{toast:k}=Ft(),[O,V]=l.useState((t==null?void 0:t.name)||""),[K,F]=l.useState((t==null?void 0:t.username)||""),[S,$]=l.useState(""),[Z,B]=l.useState(!1),[P,z]=l.useState(null),[se,X]=l.useState(""),[xe,H]=l.useState("");l.useState(!1);const[Q,Y]=l.useState(null),[L,ae]=l.useState(""),[Be,We]=l.useState(""),[Le,Oe]=l.useState(!1),[dt,Ze]=l.useState(!1),[Jt,Nt]=l.useState({totalTransfers:0,totalWithdrawals:0}),[f,_]=l.useState(null),[ee,ue]=l.useState(""),[Ie,ze]=l.useState(""),[st,gt]=l.useState(0),[Dt,es]=l.useState({}),[Bt,D]=l.useState(0),[G,oe]=l.useState(0),[be,Te]=l.useState({}),[we,at]=l.useState(""),[Me,fe]=l.useState(!1),[Se,rt]=l.useState(()=>{try{const E=localStorage.getItem("cashierUsers");return E?JSON.parse(E):[]}catch{return[]}}),us=(vs=g==null?void 0:g.subscription)==null?void 0:vs.planType,pt=us==="yearly"?2:us==="lifetime"?4:Number.POSITIVE_INFINITY;l.useEffect(()=>{try{localStorage.setItem("cashierUsers",JSON.stringify(Se))}catch{}},[Se]);const[Xs,ts]=l.useState(!1),[gs,Ws]=l.useState(""),[qe,ps]=l.useState(null),[ea,fs]=l.useState([]),[Os,ss]=l.useState(!1),[Ne,Fs]=l.useState(null),[lt,as]=l.useState(!1),[je,Lt]=l.useState(!1),te=E=>{const ce=(t==null?void 0:t.username)===E;let mt=!1;try{mt=localStorage.getItem("lastHandoverToAdmin")==="true"}catch{}if(ce&&!(ce&&!u&&(we==="الأدمن الرئيسي"||mt))){k({title:"لا يمكن الحذف",description:"لا يمكنك حذف مستخدم الوردية أثناء كونها نشطة أو قبل تسليمها للأدمن الرئيسي"});return}const Qe=`هل أنت متأكد من حذف المستخدم ${E}؟

هذا الإجراء لا يمكن التراجع عنه.`;window.confirm(Qe)&&(rt(Ue=>Ue.filter(me=>me.username!==E)),ce&&x(null),k({title:"تم حذف المستخدم",description:E}))},ta=()=>{if(!O.trim()||!K.trim()||!S.trim())return;if(Se.length>=pt){k({title:"وصلت الحد الأقصى للمستخدمين",description:`هذه الباقة تسمح بإضافة ${Number.isFinite(pt)?pt:"عدد غير محدود"} كاشير فقط`,variant:"destructive"});return}const E={name:O.trim(),username:K.trim(),password:S.trim()};rt(ce=>[E,...ce]),V(""),F(""),$("")},Je=()=>{B(!0),z(null),Y(null),ae(""),We("")},Tt=async()=>{try{let E=[];try{h!=null&&h.uid&&(E=await ve.getUserTransactions(h.uid))}catch{}if(!E||E.length===0)try{const ye=await Ji({merchantUserId:h==null?void 0:h.uid,limit:200});E=(ye==null?void 0:ye.transactions)||[]}catch{}const ce=j?new Date(j):null,mt=new Date,Xe=ye=>{const ke=ye.type,Et=ye.txnType;return ke==="withdraw"||ke==="withdrawal"||ke==="receive"||Et==="receive"},R=ye=>{const ke=ye.type,Et=ye.txnType;return ke==="send"||ke==="transfer"||Et==="send"},Qe=ye=>{if(!ye)return null;if(ye instanceof Date)return ye;try{const ke=new Date(ye);return Number.isNaN(ke.getTime())?null:ke}catch{return null}},Ue=ye=>{const ke=Qe(ye.createdAt||ye.created_at||ye.timestamp);return!ke||ce&&ke<ce?!1:ke<=mt},me=ye=>ye==="completed"||ye==="confirmed",ht=E.filter(ye=>me(ye.status)&&Ue(ye)),La=ht.filter(ye=>Xe(ye)).reduce((ye,ke)=>{const Et=ke.withdrawnAmount??ke.receivedAmount??ke.amount??0;return ye+(Number(Et)||0)},0);return{totalTransfers:ht.filter(ye=>R(ye)).reduce((ye,ke)=>{const Et=ke.sentAmount??ke.transferredAmount??ke.amount??0;return ye+(Number(Et)||0)},0),totalWithdrawals:La}}catch{return{totalTransfers:0,totalWithdrawals:0}}};l.useEffect(()=>{if(dt){try{const E=localStorage.getItem("shiftInitialReceivedDrawerFunds");E!==null&&ze(E)}catch{}try{const E=localStorage.getItem("shiftInitialReceivedWalletBalancesTotal");if(E!==null){const ce=parseFloat(E);gt(Number.isFinite(ce)?ce:0)}}catch{}}},[dt]),l.useEffect(()=>{if(!i&&!Os)return;(async()=>{try{const mt=((h!=null&&h.uid?await ve.getUserTransactions(h.uid):[])||[]).filter(Xe=>(Xe==null?void 0:Xe.type)==="report"||((Xe==null?void 0:Xe.title)||"").includes("إيصال تسليم وردية"));mt.sort((Xe,R)=>{const Qe=new Date(Xe.createdAt||0).getTime();return new Date(R.createdAt||0).getTime()-Qe}),fs(mt)}catch{fs([])}})()},[i,dt,Os,h==null?void 0:h.uid]);const Ct=async(E,ce,mt)=>{try{let Xe=0,R=0;try{const Ue=parseFloat(localStorage.getItem("shiftInitialReceivedDrawerFunds")||"0");Xe=Number.isFinite(Ue)?Ue:0}catch{}try{const Ue=parseFloat(localStorage.getItem("shiftInitialReceivedWalletBalancesTotal")||"0");R=Number.isFinite(Ue)?Ue:0}catch{}const Qe={id:`shift_receipt_${Date.now()}`,type:"report",senderPhone:(t==null?void 0:t.username)||"cashier",receiverPhone:we||"admin",amount:0,status:"completed",createdAt:new Date().toISOString(),title:"إيصال تسليم وردية",cashierName:(t==null?void 0:t.name)||(t==null?void 0:t.username)||null,deficit:ce,deficitAmount:ce?mt:0,shiftStartAt:j,receivedDrawerFunds:Xe,receivedWalletBalancesTotal:R,receivedWalletBalances:Dt,deliveredDrawerFunds:Bt||0,deliveredWalletBalancesTotal:G||0,deliveredWalletBalances:be};h!=null&&h.uid&&await ve.saveUserTransaction(h.uid,Qe),fs(Ue=>[Qe,...Ue||[]])}catch{}};return e.jsxs(e.Fragment,{children:[e.jsx(re,{open:i,onOpenChange:v,children:e.jsxs(le,{className:"sm:max-w-md",children:[e.jsx(ne,{children:e.jsx(ie,{children:u?"تسليم الورديه والخروج":"إضافة مستخدم وردية"})}),u?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsx("div",{className:"text-sm",children:"المستخدم الحالي للوردية:"}),e.jsxs("div",{className:"font-semibold text-sm",children:[t==null?void 0:t.name," (",t==null?void 0:t.username,")"]})]}),e.jsx("div",{className:"text-xs text-gray-600",children:'لإنهاء الوردية والخروج، اضغط "تسليم الورديه والخروج" وسيُطلب الرقم السري.'})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-xs text-gray-600",children:'لاستكمال إضافة مستخدم جديد اضغط الزر أسفل "إضافة مستخدم جديد" لفتح النموذج.'}),Se.length>0&&e.jsxs("div",{className:"mt-4 border-t pt-3",children:[e.jsx("div",{className:"text-sm font-medium mb-2",children:"المستخدمون المسجلون"}),e.jsx("div",{className:"space-y-2 max-h-48 overflow-auto",children:Se.map((E,ce)=>e.jsxs("div",{className:"flex items-center justify-between rounded border px-3 py-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:E.name}),e.jsx("div",{className:"text-xs text-gray-500",children:E.username})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(c,{size:"sm",className:"w-full sm:w-auto",onClick:()=>{ps(E),ts(!0)},children:"دخول"}),e.jsx(c,{size:"sm",className:"w-full sm:w-auto",variant:"destructive",onClick:()=>te(E.username),children:"حذف"})]})]},ce))})]})]}),e.jsx(Ce,{className:"flex flex-wrap gap-2 justify-between",children:u?e.jsx("div",{className:"flex flex-wrap gap-2",children:e.jsx(c,{className:"w-full sm:w-auto",variant:"destructive",onClick:Je,children:"تسليم الورديه والخروج"})}):e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(c,{className:"w-full sm:w-auto",onClick:()=>Lt(!0),children:"إضافة مستخدم جديد"}),e.jsx(c,{className:"w-full sm:w-auto",variant:"outline",onClick:()=>ss(!0),children:"إيصالات التسليم"})]})})]})}),e.jsx(re,{open:je,onOpenChange:Lt,children:e.jsxs(le,{className:"sm:max-w-md",children:[e.jsx(ne,{children:e.jsx(ie,{children:"إضافة مستخدم جديد"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(q,{className:"mb-1 block",children:"الاسم"}),e.jsx(U,{value:O,onChange:E=>V(E.target.value),placeholder:"أدخل الاسم"})]}),e.jsxs("div",{children:[e.jsx(q,{className:"mb-1 block",children:"اسم المستخدم"}),e.jsx(U,{value:K,onChange:E=>F(E.target.value),placeholder:"أدخل اسم المستخدم"})]}),e.jsxs("div",{children:[e.jsx(q,{className:"mb-1 block",children:"الرقم السري"}),e.jsx(U,{type:"password",value:S,onChange:E=>$(E.target.value),placeholder:"أدخل الرقم السري"})]}),e.jsx("div",{className:"text-xs text-gray-500",children:"المستخدم يمكنه: التحويل، السحب، اختيار المحفظة فقط."})]}),e.jsxs(Ce,{className:"flex gap-2 justify-between",children:[e.jsx(c,{variant:"secondary",onClick:()=>{Lt(!1)},children:"إلغاء"}),e.jsx(c,{onClick:()=>{!O.trim()||!K.trim()||!S.trim()||(ta(),Lt(!1))},children:"حفظ المستخدم"})]})]})}),e.jsx(re,{open:Os,onOpenChange:ss,children:e.jsxs(le,{className:"sm:max-w-lg",children:[e.jsx(ne,{children:e.jsx(ie,{children:"إيصالات التسليم"})}),ea.length===0?e.jsx("div",{className:"text-xs text-gray-600",children:"لا توجد إيصالات تسليم محفوظة بعد."}):e.jsx("div",{className:"space-y-2 max-h-[60vh] overflow-auto",children:ea.map(E=>e.jsxs("div",{className:"rounded border px-3 py-2 cursor-pointer hover:bg-gray-50",onClick:()=>{Fs(E),as(!0)},children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm font-semibold",children:new Date(E.createdAt).toLocaleString("ar-EG")}),e.jsxs("div",{className:"text-xs text-gray-500",children:["إلى: ",E.receiverPhone]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-1",children:[e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مسلّمة: ",E.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مسلّمة (إجمالي): ",E.deliveredWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مستلمة: ",E.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مستلمة (إجمالي): ",E.receivedWalletBalancesTotal??0]})]}),E.deficit&&e.jsxs("div",{className:"text-xs text-red-600 mt-1",children:["عجز: ",E.deficitAmount??0]})]},E.id))}),e.jsx(Ce,{className:"flex gap-2 justify-between",children:e.jsx(c,{variant:"secondary",onClick:()=>ss(!1),children:"إغلاق"})})]})}),e.jsx(re,{open:lt,onOpenChange:as,children:e.jsxs(le,{className:"sm:max-w-md",children:[e.jsx(ne,{children:e.jsx(ie,{children:"إيصال تسليم وردية"})}),Ne?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsxs("div",{className:"text-sm",children:["التاريخ: ",new Date(Ne.createdAt).toLocaleString("ar-EG")]}),e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["تم التسليم إلى: ",Ne.receiverPhone]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"المستلم عند الدخول"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية: ",Ne.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["أرصدة المحافظ (إجمالي): ",Ne.receivedWalletBalancesTotal??0]})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"المسلّم عند الخروج"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية: ",Ne.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["أرصدة المحافظ (إجمالي): ",Ne.deliveredWalletBalancesTotal??0]})]})]}),Ne.deficit&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2 text-red-600",children:"عجز"}),e.jsxs("div",{className:"text-xs text-red-600",children:["المبلغ: ",Ne.deficitAmount??0]})]}),Ne.receivedWalletBalances&&Object.keys(Ne.receivedWalletBalances).length>0&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"تفصيل المحافظ المستلمة"}),e.jsx("div",{className:"space-y-1",children:Object.entries(Ne.receivedWalletBalances).map(([E,ce])=>e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-gray-600",children:E}),e.jsx("span",{className:"font-semibold",children:ce})]},E))})]}),Ne.deliveredWalletBalances&&Object.keys(Ne.deliveredWalletBalances).length>0&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"تفصيل المحافظ المسلّمة"}),e.jsx("div",{className:"space-y-1",children:Object.entries(Ne.deliveredWalletBalances).map(([E,ce])=>e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-gray-600",children:E}),e.jsx("span",{className:"font-semibold",children:ce})]},E))})]})]}):e.jsx("div",{className:"text-xs text-gray-600",children:"لا يوجد تقرير محدد للعرض."}),e.jsx(Ce,{className:"flex gap-2 justify-between",children:e.jsx(c,{variant:"secondary",onClick:()=>as(!1),children:"إغلاق"})})]})}),e.jsx(re,{open:Xs,onOpenChange:ts,children:e.jsxs(le,{className:"sm:max-w-md",children:[e.jsx(ne,{children:e.jsx(ie,{children:"أدخل الرقم السري للدخول"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm",children:qe?`${qe.name} (${qe.username})`:""}),e.jsx(U,{type:"password",value:gs,onChange:E=>Ws(E.target.value),placeholder:"أدخل الرقم السري"})]}),e.jsxs(Ce,{className:"flex gap-2 justify-between",children:[e.jsx(c,{variant:"secondary",onClick:()=>{Ws(""),ps(null),ts(!1)},children:"إلغاء"}),e.jsx(c,{onClick:()=>{if(qe){if(gs.trim()!==qe.password){k({title:"خطأ في الرقم السري",description:"الرقم السري للكاشير غير صحيح",variant:"destructive"});return}x({name:qe.name,username:qe.username}),Ws(""),ts(!1),v(!1),I(),fe(!0)}},children:"دخول الورديه"})]})]})}),e.jsx(re,{open:Me,onOpenChange:fe,children:e.jsxs(le,{className:"sm:max-w-md",children:[e.jsx(ne,{children:e.jsx(ie,{children:"تسجيل أرصدة البداية والنقدية"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(q,{className:"mb-1 block",children:"الفلوس النقدية المستلمة عند الدخول"}),e.jsx(U,{type:"number",value:Ie,onChange:E=>ze(E.target.value),placeholder:"أدخل قيمة النقدية في الدرج عند بداية الورديه"})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(q,{className:"mb-1 block",children:"أرصدة المحافظ المستلمة (إجمالي) عند الدخول"}),e.jsx(U,{type:"number",value:Number.isFinite(st)?st:0,onChange:E=>{const ce=parseFloat(E.target.value);gt(Number.isFinite(ce)?ce:0)},placeholder:"أدخل إجمالي أرصدة المحافظ عند بداية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"يمكن إضافة التفصيل لاحقاً إن لزم، المهم تسجيل الإجمالي."})]})]}),e.jsx(Ce,{className:"flex gap-2 justify-between",children:e.jsx(c,{onClick:()=>{const E=parseFloat(Ie),ce=st,mt=Number.isFinite(E)&&E>=0,Xe=Number.isFinite(ce)&&ce>=0;if(!mt||!Xe){k({title:"يرجى إدخال قيم صحيحة",description:"أدخل قيمًا رقمية غير سالبة للنقدية ولإجمالي أرصدة المحافظ",variant:"destructive"});return}try{localStorage.setItem("shiftInitialReceivedDrawerFunds",String(E)),localStorage.setItem("shiftInitialReceivedWalletBalancesTotal",String(ce))}catch{}k({title:"تم تسجيل أرصدة البداية",description:"سُجّل إجمالي النقدية وأرصدة المحافظ لبداية الورديه"}),fe(!1)},children:"تأكيد وحفظ"})})]})}),e.jsx(re,{open:Z,onOpenChange:E=>{E&&B(!0)},children:e.jsxs(le,{className:"sm:max-w-md",hideClose:!0,disableOutsideClose:!0,disableEscClose:!0,children:[e.jsx(ne,{children:e.jsx(ie,{children:"تسليم الورديه والخروج"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(c,{variant:P==="toUser"?"default":"secondary",onClick:()=>z("toUser"),children:"تسليم إلى مستخدم آخر"}),e.jsx(c,{variant:P==="toAdmin"?"default":"secondary",onClick:()=>z("toAdmin"),children:"تسليم إلى الأدمن الرئيسي"})]}),P==="toUser"&&e.jsxs("div",{className:"space-y-3",children:[Se.length===0?e.jsx("div",{className:"text-sm text-gray-600",children:"لا يوجد مستخدمون مسجلون. قم بإضافة مستخدم أولاً."}):e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"اختر المستخدم الذي سيتسلم الورديه"}),e.jsx("div",{className:"space-y-2 max-h-40 overflow-auto",children:Se.map((E,ce)=>e.jsxs("div",{className:`flex items-center justify-between rounded border px-3 py-2 cursor-pointer ${(Q==null?void 0:Q.username)===E.username?"bg-indigo-50 border-indigo-200":""}`,onClick:()=>Y(E),children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:E.name}),e.jsx("div",{className:"text-xs text-gray-500",children:E.username})]}),e.jsx("span",{className:"text-xs text-gray-400",children:"اختيار"})]},ce))})]}),e.jsxs("div",{children:[e.jsx(q,{className:"mb-1 block",children:"كلمة سر المستخدم المحدد"}),e.jsx(U,{type:"password",value:L,onChange:E=>ae(E.target.value),placeholder:"أدخل كلمة السر"})]}),Be&&e.jsx("div",{className:"text-xs text-red-600",children:Be})]}),P==="toAdmin"&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm text-gray-600",children:"أدخل كلمة مرور الحساب الرئيسي لتسليم الورديه والخروج إلى الأدمن."}),e.jsx(U,{type:"password",value:se,onChange:E=>X(E.target.value),placeholder:"كلمة المرور"}),xe&&e.jsx("div",{className:"text-xs text-red-600",children:xe})]})]}),e.jsx(Ce,{className:"flex gap-2 justify-between",children:e.jsx(c,{disabled:Le||!P,onClick:async()=>{if(P){Oe(!0);try{const E=await Tt();if(P==="toUser"){if(!Q){We("يرجى اختيار المستخدم أولاً"),Oe(!1);return}if(L.trim()!==Q.password){We("كلمة السر غير صحيحة"),Oe(!1);return}M(),x({name:Q.name,username:Q.username}),I(),at(`${Q.name} (${Q.username})`);try{localStorage.setItem("lastHandoverToAdmin","false")}catch{}B(!1),z(null),Y(null),ae(""),We(""),v(!1),Nt(E),_(null),ue(""),Ze(!0)}else if(P==="toAdmin"){H("");const ce=(h==null?void 0:h.email)||"";if(!ce){H("لا يوجد بريد للمستخدم الرئيسي للتحقق"),Oe(!1);return}const{error:mt}=await p(ce,se);if(mt){H("كلمة المرور غير صحيحة"),Oe(!1);return}M(),x(null);try{localStorage.setItem("lastHandoverToAdmin","true")}catch{}X(""),B(!1),v(!1),at("الأدمن الرئيسي"),Nt(E),_(null),ue(""),Ze(!0)}}catch{We("حدث خطأ أثناء التسليم، حاول مرة أخرى")}finally{Oe(!1)}}},children:"تأكيد التسليم"})})]})}),e.jsx(re,{open:dt,onOpenChange:Ze,children:e.jsxs(le,{className:"sm:max-w-lg",hideClose:!0,disableOutsideClose:!0,disableEscClose:!0,children:[e.jsx(ne,{children:e.jsx(ie,{children:"تقرير تسليم الورديه والخروج"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsxs("div",{className:"text-sm",children:["تم تسليم الورديه إلى: ",e.jsx("span",{className:"font-semibold",children:we})]}),j&&e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["بداية الورديه: ",new Date(j).toLocaleString("ar-EG")]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نهاية الورديه: ",new Date().toLocaleString("ar-EG")]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(q,{className:"mb-1 block",children:"الفلوس النقدية المستلمة"}),e.jsx(U,{type:"number",value:Ie,readOnly:!0,disabled:!0,placeholder:"قيمة مسجلة عند بداية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"قيمة غير قابلة للتعديل؛ تُسجّل عند الدخول."})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(q,{className:"mb-1 block",children:"أرصدة المحافظ المستلمة (إجمالي)"}),e.jsx(U,{type:"number",value:st,readOnly:!0,disabled:!0,placeholder:"إجمالي مسجل عند بداية الورديه"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(q,{className:"mb-1 block",children:"الفلوس النقدية المسلمة"}),e.jsx(U,{type:"number",value:Bt,onChange:E=>{const ce=parseFloat(E.target.value);D(Number.isFinite(ce)?ce:0)},placeholder:"أدخل قيمة النقدية المسلمة عند نهاية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"ادخال يدوي لقيمة النقدية المسلّمة عند نهاية الورديه"})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(q,{className:"mb-1 block",children:"أرصدة المحافظ المسلمة (إجمالي)"}),e.jsx(U,{type:"number",value:G,onChange:E=>{const ce=parseFloat(E.target.value);oe(Number.isFinite(ce)?ce:0)},placeholder:"أدخل إجمالي أرصدة المحافظ المسلّمة"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"يمكنك إدخال الإجمالي يدوياً؛ التفصيل يُحفظ إن لزم"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"هل يوجد عجز؟"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(c,{variant:f==="no"?"default":"secondary",onClick:()=>_("no"),children:"لا"}),e.jsx(c,{variant:f==="yes"?"default":"secondary",onClick:()=>_("yes"),children:"نعم"})]}),f==="yes"&&e.jsxs("div",{children:[e.jsx(q,{className:"mb-1 block",children:"مبلغ العجز"}),e.jsx(U,{type:"number",value:ee,onChange:E=>ue(E.target.value),placeholder:"أدخل مبلغ العجز"})]})]})]}),e.jsx(Ce,{className:"flex gap-2 justify-between",children:e.jsx(c,{onClick:()=>{const E=f==="yes",ce=parseFloat(ee)||0;(async()=>await Ct(Jt,E,ce))(),k({title:"تم إضافة إيصال تسليم الوردية",description:"أُضيف الإيصال إلى المعاملات الأخيرة بعنوان إيصال تسليم وردية"}),Ze(!1)},children:"تأكيد وحفظ الإيصال"})})]})})]})},uo=({open:i,onOpenChange:v})=>{const{shiftUser:t,endShift:u,setShiftUser:j}=Ba(),[x,I]=l.useState(""),[M,g]=l.useState(""),[h,p]=l.useState([]);l.useEffect(()=>{try{const k=localStorage.getItem("cashierUsers");p(k?JSON.parse(k):[])}catch{p([])}},[i]);const T=async()=>{if(g(""),!t)return;const k=h.find(O=>O.username===t.username);if(!k){g("لا يوجد مستخدم مطابق لهذه الوردية");return}if(x.trim()!==k.password){g("الرقم السري غير صحيح");return}u(),j(null),I(""),v(!1)};return e.jsx(re,{open:i,onOpenChange:k=>{I(""),g(""),v(k)},children:e.jsxs(le,{className:"sm:max-w-md",children:[e.jsx(ne,{children:e.jsx(ie,{children:"بروفيل الوردية"})}),t?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"rounded-lg border p-3 bg-gradient-to-r from-blue-50 to-indigo-50",children:[e.jsx("div",{className:"text-sm font-semibold text-gray-800",children:t.name}),e.jsx("div",{className:"text-xs text-gray-600",children:t.username})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{className:"block",children:"أدخل الرقم السري لتسليم الوردية"}),e.jsx(U,{type:"password",value:x,onChange:k=>I(k.target.value),placeholder:"الرقم السري للمستخدم",dir:"ltr"}),M&&e.jsx("div",{className:"text-red-600 text-xs",children:M})]})]}):e.jsx("div",{className:"text-sm text-gray-600",children:"لا يوجد مستخدم وردية نشط حالياً"}),e.jsxs(Ce,{className:"flex justify-between",children:[e.jsx(c,{variant:"outline",onClick:()=>v(!1),children:"إغلاق"}),e.jsx(c,{onClick:T,disabled:!t,children:"تسليم الوردية"})]})]})})};class ks{static async processTransfer(v){const{amount:t,currentCashBalance:u,currentWalletBalances:j,wallets:x,selectedWalletId:I}=v;if(t<=0)return{success:!1,newCashBalance:u,newWalletBalances:j,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(I&&!v.skipRemoteLimitsCheck)try{const p=await cs.canPerformOperation(I,t,"transfer");if(!p.canPerform)return{success:!1,newCashBalance:u,newWalletBalances:j,message:p.message||"تجاوز حد التحويل المسموح",error:"LIMIT_EXCEEDED"}}catch(p){return console.error("خطأ في التحقق من حدود التحويل:",p),{success:!1,newCashBalance:u,newWalletBalances:j,message:"خطأ في التحقق من حدود التحويل",error:"LIMIT_CHECK_ERROR"}}if(t<=0)return{success:!1,newCashBalance:u,newWalletBalances:j,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(I){const p=Math.max(j[I]||0,0);if(p<t){const T=x.find(k=>k.id===I);return{success:!1,newCashBalance:u,newWalletBalances:j,message:`رصيد غير كافي في المحفظة${T?` ${T.name}`:""}. المتاح: ${p} جنيه، المطلوب: ${t} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"}}}else{const p=ks.calculateTotalWalletBalance(j);if(p<t)return{success:!1,newCashBalance:u,newWalletBalances:j,message:`رصيد غير كافي في المحافظ. الرصيد المتاح: ${p} جنيه، المبلغ المطلوب: ${t} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"}}const M={...j};if(I){const p=M[I]||0;M[I]=p-t}else{let p=t;for(const T of x){if(p<=0)break;const k=Math.max(M[T.id]||0,0),O=Math.min(k,p);O>0&&(M[T.id]=(M[T.id]||0)-O,p-=O)}}const g=u+t;if(I)try{const p=cs.updateUsage(I,t,"transfer");v.nonBlockingUsageUpdate?p.catch(T=>console.error("خطأ في تحديث استخدام المحفظة:",T)):await p}catch(p){console.error("خطأ في تحديث استخدام المحفظة:",p)}let h="تم التحويل بنجاح";if(I){const p=M[I]||0;p<0&&(h=`تم التحويل بنجاح مع تحذير: رصيد محفظة ${I} أصبح ${p} جنيه.`)}return{success:!0,newCashBalance:g,newWalletBalances:M,message:h}}static processDeposit(v){const{amount:t,currentCashBalance:u,currentWalletBalances:j,wallets:x}=v;if(t<=0)return{success:!1,newCashBalance:u,newWalletBalances:j,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};const I=this.calculateTotalWalletBalance(j);if(I<t)return{success:!1,newCashBalance:u,newWalletBalances:j,message:`رصيد غير كافي في المحافظ. الرصيد المتاح: ${I} جنيه، المبلغ المطلوب: ${t} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"};const M=u+t,g={...j};let h=t;const p=x.find(k=>k.isDefault);if(p&&g[p.id]>=h)g[p.id]-=h,h=0;else for(const k of x){if(h<=0)break;const O=g[k.id]||0;if(O>0){const V=Math.min(O,h);g[k.id]=O-V,h-=V}}const T=h>0?`تم الإيداع جزئياً. تم إيداع ${t-h} جنيه في صندوق النقدية`:`تم الإيداع بنجاح. تم إضافة ${t} جنيه إلى صندوق النقدية`;return{success:!0,newCashBalance:M,newWalletBalances:g,message:T}}static async processWithdraw(v){const{amount:t,currentCashBalance:u,currentWalletBalances:j,wallets:x,selectedWalletId:I}=v;if(t<=0)return{success:!1,newCashBalance:u,newWalletBalances:j,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(I&&!v.skipRemoteLimitsCheck)try{const p=await cs.canPerformOperation(I,t,"withdraw");if(!p.canPerform)return{success:!1,newCashBalance:u,newWalletBalances:j,message:p.reason||"تم تجاوز الحد المسموح للسحب",error:"LIMIT_EXCEEDED"}}catch(p){return console.error("خطأ في التحقق من حدود السحب:",p),{success:!1,newCashBalance:u,newWalletBalances:j,message:"خطأ في التحقق من حدود السحب",error:"LIMIT_CHECK_ERROR"}}if(u<t)return{success:!1,newCashBalance:u,newWalletBalances:j,message:`رصيد غير كافي في صندوق النقدية. الرصيد المتاح: ${u} جنيه، المبلغ المطلوب: ${t} جنيه`,error:"INSUFFICIENT_CASH_BALANCE"};const M=u-t,g={...j},h=I?x.find(p=>p.id===I):x.find(p=>p.isDefault)||x[0];if(h){const p=g[h.id]||0;g[h.id]=p+t}else return{success:!1,newCashBalance:u,newWalletBalances:j,message:"لا توجد محافظ متاحة لإضافة المبلغ إليها",error:"NO_WALLETS_AVAILABLE"};if(I)try{const p=cs.updateUsage(I,t,"withdraw");v.nonBlockingUsageUpdate?p.catch(T=>console.error("خطأ في تحديث استخدام المحفظة:",T)):await p}catch(p){console.error("خطأ في تحديث استخدام المحفظة:",p)}return{success:!0,newCashBalance:M,newWalletBalances:g,message:`تم السحب بنجاح. تم إضافة ${t} جنيه إلى محفظة ${(h==null?void 0:h.name)||""}`}}static validateOperation(v,t){return v<=0?{valid:!1,error:"المبلغ يجب أن يكون أكبر من الصفر"}:!t||t.length===0?{valid:!1,error:"لا توجد محافظ متاحة"}:{valid:!0}}static calculateTotalWalletBalance(v){return Object.values(v).reduce((t,u)=>t+Math.max(u,0),0)}static deductFromWalletsAddToCash(v,t,u,j){return this.processTransfer({amount:v,currentCashBalance:t,currentWalletBalances:u,wallets:j})}static deductFromWalletsAddToCashDeposit(v,t,u,j){return this.processDeposit({amount:v,currentCashBalance:t,currentWalletBalances:u,wallets:j})}static deductFromCashAddToWallets(v,t,u,j){return this.processWithdraw({amount:v,currentCashBalance:t,currentWalletBalances:u,wallets:j})}static applyTransactionResult(v,t,u){v.success&&(t(v.newCashBalance),u(v.newWalletBalances))}static validateTransaction(v,t,u,j){if(v<=0)return{isValid:!1,error:"المبلغ يجب أن يكون أكبر من الصفر"};if(t==="transfer"){const x=this.calculateTotalWalletBalance(j);if(x<v)return{isValid:!1,error:`الرصيد المتاح في المحافظ (${x} جنيه) غير كافي للمبلغ المطلوب (${v} جنيه)`}}else if(t==="withdraw"){if(u<v)return{isValid:!1,error:`الرصيد المتاح في صندوق النقدية (${u} جنيه) غير كافي للمبلغ المطلوب (${v} جنيه)`}}else if(t==="deposit"){const x=this.calculateTotalWalletBalance(j);if(x<v)return{isValid:!1,error:`الرصيد المتاح في المحافظ (${x} جنيه) غير كافي للمبلغ المطلوب (${v} جنيه)`}}return{isValid:!0}}static getDeductionPreview(v,t,u){const j=[];let x=v;for(const I of u){if(x<=0)break;const M=t[I.id]||0,g=Math.min(Math.max(M,0),x);g>0&&(j.push({walletId:I.id,walletName:I.name,currentBalance:M,deductedAmount:g,newBalance:M-g}),x-=g)}return j}}let Ys=null;function go(){const i=window;if(!Ys){const v=i.AudioContext||i.webkitAudioContext;Ys=new v}return Ys.state==="suspended"&&Ys.resume(),Ys}function po(i,v,t){const u=t/1e3,j=Math.floor(i.sampleRate*u),x=i.createBuffer(1,j,i.sampleRate),I=x.getChannelData(0);for(let p=0;p<j;p++)I[p]=(Math.random()*2-1)*.6;const M=i.createBufferSource();M.buffer=x;const g=i.createBiquadFilter();g.type="highpass",g.frequency.value=1500,g.Q.value=.7;const h=i.createGain();h.gain.setValueAtTime(1e-4,v),h.gain.exponentialRampToValueAtTime(.4,v+.015),h.gain.exponentialRampToValueAtTime(1e-4,v+u),M.connect(g),g.connect(h),h.connect(i.destination),M.start(v),M.stop(v+u+.01)}function fo(i,v,t,u,j,x="triangle"){const I=i.createOscillator(),M=i.createGain();I.type=x;const g=j/1e3;I.frequency.setValueAtTime(t,v),I.frequency.linearRampToValueAtTime(u,v+g),M.gain.setValueAtTime(1e-4,v),M.gain.exponentialRampToValueAtTime(.25,v+.02),M.gain.exponentialRampToValueAtTime(1e-4,v+g),I.connect(M),M.connect(i.destination),I.start(v),I.stop(v+g+.02)}function vo(){try{const i=go(),v=i.currentTime;po(i,v,90),fo(i,v+.12,1900,1100,180,"sawtooth")}catch{}}const hc=()=>{var Cl,Il,Tl,kl;console.log("🔥 UserDashboardPage component is loading...");const{toast:i}=Ft(),{signOut:v,user:t,profile:u}=Xt(),j=((t==null?void 0:t.email)||"").toLowerCase()==="vodafonecash00@gmail.com",x=vi(),I=Ul(),{isShiftActive:M,shiftUser:g}=Ba(),{shopName:h}=yi(),p=ji(),[T,k]=l.useState(!1),[O,V]=l.useState(!1);console.log("🔥 UserDashboardPage - user:",t?"exists":"null");const[K,F]=l.useState(!0),[S,$]=l.useState(!0),[Z,B]=l.useState(!1),[P,z]=l.useState(!1),[se,X]=l.useState(""),[xe,H]=l.useState(""),[Q,Y]=l.useState(""),[L,ae]=l.useState([]),[Be,We]=l.useState(!1),[Le,Oe]=l.useState(null),[dt,Ze]=l.useState("");l.useState(!1);const[Jt,Nt]=l.useState(!1),[f,_]=l.useState(!1),[ee,ue]=l.useState(!1),[Ie,ze]=l.useState(0),[st,gt]=l.useState(!1),[Dt,es]=l.useState(null),[Bt,D]=l.useState(!1),[G,oe]=l.useState(()=>{try{const s=Object.keys(localStorage).find(a=>a.startsWith("wallets_")),r=s?localStorage.getItem(s):null;if(r){const a=JSON.parse(r);if(Array.isArray(a)&&a.length>0){const n=Object.keys(localStorage).find(m=>m.startsWith("selectedWallet_")),o=n?localStorage.getItem(n):null,d=o&&a.find(m=>m.id===o)||a.find(m=>m.isDefault)||a[0];return(d==null?void 0:d.phone)||"01030302038"}}}catch{}return"01030302038"}),[be,Te]=l.useState(""),[we,at]=l.useState(""),[Me,fe]=l.useState(!1),[Se,rt]=l.useState(""),[us,pt]=l.useState(""),[Xs,ts]=l.useState(""),[gs,Ws]=l.useState(""),[qe,ps]=l.useState(null),[ea,fs]=l.useState(!1),[Os,ss]=l.useState(!1),[Ne,Fs]=l.useState(""),[lt,as]=l.useState(""),[je,Lt]=l.useState(()=>{try{const s=localStorage.getItem(`commissionMode_${(t==null?void 0:t.uid)||"default"}`);return s?s==="add":!0}catch{return!0}}),[te,ta]=l.useState("transfer"),[Je,Tt]=l.useState([]),[Ct,vs]=l.useState("all");l.useEffect(()=>{try{localStorage.setItem(`commissionMode_${(t==null?void 0:t.uid)||"default"}`,je?"add":"deduct")}catch{}},[je,t==null?void 0:t.uid]);const[E,ce]=l.useState(!1),[mt,Xe]=l.useState(null),[R,Qe]=l.useState(()=>{var s,r,a;try{const n=Object.keys(localStorage).find(b=>b.startsWith("wallets_")),o=n?localStorage.getItem(n):null,d=o?JSON.parse(o):null,m=Object.keys(localStorage).find(b=>b.startsWith("selectedWallet_")),y=m?localStorage.getItem(m):null;return(d&&Array.isArray(d)&&d.length>0?y&&((s=d.find(b=>b.id===y))==null?void 0:s.id)||((r=d.find(b=>b.isDefault))==null?void 0:r.id)||((a=d[0])==null?void 0:a.id):"")||""}catch{}return""});l.useEffect(()=>{if(!Me)return;const s=Ue(),r=parseFloat(we||"0")||0;let a=0;if(te==="transfer"){if((s==null?void 0:s.defaultTransferCommission)!=null){const o=Number(s.defaultTransferCommission)||0;a=Math.round(o*r/1e3*100)/100}else{const o=lt&&lt.trim()!==""?parseFloat(lt):0;a=Math.max(0,o)}const n=je?r+a:r;pt((n||0).toString())}else{if((s==null?void 0:s.defaultWithdrawCommission)!=null){const o=Number(s.defaultWithdrawCommission)||0;a=Math.round(o*r/1e3*100)/100}else{const o=Ne&&Ne.trim()!==""?parseFloat(Ne):Math.round(r*.01*100)/100;a=Math.max(0,o)}const n=je?r:Math.max(0,Math.round((r-a)*100)/100);pt((n||0).toString())}},[Me,we,lt,Ne,R,je,te]);const Ue=()=>{var r,a;let s=me.find(n=>n.id===R);if(!s)try{const n=localStorage.getItem(Ut());if(n){const o=JSON.parse(n);if(Array.isArray(o)&&o.length>0){const m=localStorage.getItem(`selectedWallet_${(t==null?void 0:t.uid)||"default"}`)||((r=o.find(y=>y.isDefault))==null?void 0:r.id)||((a=o[0])==null?void 0:a.id);s=o.find(y=>y.id===m)}}}catch{}return s};l.useLayoutEffect(()=>{try{const s=`wallets_${(t==null?void 0:t.uid)||"default"}`;let r=localStorage.getItem(s);if(!r){const a=Object.keys(localStorage).find(n=>n.startsWith("wallets_"));a&&(r=localStorage.getItem(a)||null)}if(r){const a=JSON.parse(r);if(Array.isArray(a)&&a.length>0){ht(a);const n=`selectedWallet_${(t==null?void 0:t.uid)||"default"}`,o=localStorage.getItem(n),d=o&&a.find(m=>m.id===o)||a.find(m=>m.isDefault)||a[0];d&&(Qe(d.id),oe(d.phone))}}}catch(s){console.error("تهيئة فورية للمحافظ من التخزين المحلي فشلت:",s)}},[]),l.useEffect(()=>{console.log("🔍 selectedWallet state changed to:",R)},[R]),l.useEffect(()=>{Ln()},[]);const[me,ht]=l.useState(()=>{try{const s=Object.keys(localStorage).find(a=>a.startsWith("wallets_")),r=s?localStorage.getItem(s):null;if(r){const a=JSON.parse(r);if(Array.isArray(a))return a}}catch{}return[]}),[La,Zl]=l.useState(null),[ye,ke]=l.useState(!1),[Et,sa]=l.useState(!1),[Xl,en]=l.useState(null);l.useState([]),l.useState([]);const[tn,Bs]=l.useState(!1),[Ea,Br]=l.useState("daily"),[sn,Lr]=l.useState(!1),[an,Ma]=l.useState(!1),[Er,rs]=l.useState([]),rn=async s=>{try{const r=Je.find(n=>n.id===s);if(!r||!t)return;const a=Je.filter(n=>n.id!==s);Tt(a);try{await ve.removeUserTransaction(t.uid,s),await wa.permanentlyDeleteTransaction(s,t.uid)}catch(n){console.warn("تعذر الحذف النهائي من قواعد البيانات أثناء حذف الإيصال:",n)}try{const n=$e(),o=Ee(),d=localStorage.getItem(n),m=localStorage.getItem(o);let y=d?parseFloat(d):Fe,C=m?JSON.parse(m):{...ge};const b=r.amount||r.transferredAmount||r.withdrawnAmount||r.withdrawnAmountDetailed||0;if(r.type==="send"&&(r.fromWallet||R)){y-=r.commission||0;const A=r.fromWallet||R;C[A]=(C[A]||0)+b}else if(r.type==="withdraw"&&(r.fromWallet||R)){y+=b,y-=r.commission||0;const A=r.fromWallet||R;C[A]=Math.max(0,(C[A]||0)-b)}Ke(y),Ae(C),localStorage.setItem(n,y.toString()),localStorage.setItem(o,JSON.stringify(C));const N={cashBalance:y,walletBalances:C,lastUpdated:new Date().toISOString()},W=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(W,JSON.stringify(N)),t!=null&&t.uid?ve.updateUserData(t.uid,N).then(()=>{localStorage.removeItem(W),de(!1)}).catch(A=>{console.warn("تعذر حفظ الأرصدة في Firebase بعد الحذف، تم الاحتفاظ محليًا:",A),de(!0)}):de(!0)}catch(n){console.warn("تعذر عكس تأثير الأرصدة بعد الحذف:",n)}try{const n=r.fromWallet||R,o=await cs.getWalletLimits(t.uid,n);if(o){const d=r.amount||r.transferredAmount||r.withdrawnAmount||r.withdrawnAmountDetailed||0,m={...o};r.type==="send"?(m.dailyTransferUsed=Math.max(0,(o.dailyTransferUsed||0)-d),m.monthlyTransferUsed=Math.max(0,(o.monthlyTransferUsed||0)-d)):(m.dailyWithdrawUsed=Math.max(0,(o.dailyWithdrawUsed||0)-d),m.monthlyWithdrawUsed=Math.max(0,(o.monthlyWithdrawUsed||0)-d)),await cs.updateWalletLimits(t.uid,n,m)}}catch(n){console.warn("تعذر تحديث حدود المحفظة بعد الحذف:",n)}try{At.removeTransactionEffects(r,t.uid)}catch(n){console.warn("تعذر تحديث التقارير بعد الحذف:",n)}i({title:"تم الحذف نهائيًا",description:"تم حذف الإيصال نهائيًا وعكس تأثيراته على الأرصدة والحدود والتقارير."}),sa(!1)}catch(r){console.error("خطأ أثناء حذف الإيصال:",r),i({title:"خطأ في حذف الإيصال",description:"حدث خطأ غير متوقع أثناء الحذف.",variant:"destructive"})}},ln=async s=>{try{if(!Je.find(a=>a.id===s)||!t)return;await Gs(_t(tt,"userTransactions",s),{status:"completed",confirmedAt:new Date}),Tt(a=>a.map(n=>n.id===s?{...n,status:"completed"}:n)),i({title:"تم الإكمال",description:"تم وسم المعاملة كمكتملة."}),sa(!1)}catch(r){console.error("خطأ أثناء إكمال الإيصال:",r),i({title:"فشل الإكمال",description:"حدث خطأ غير متوقع أثناء تحديث الحالة.",variant:"destructive"})}},[Mr,nn]=l.useState(""),Ur=lo(Mr,300),[aa,$r]=l.useState(""),[ra,_r]=l.useState(""),[Kt,yo]=l.useState(""),[Ua,ys]=l.useState(!1),[Rr,Ls]=l.useState(!1),[on,zr]=l.useState(!1),[cn,$a]=l.useState(!1),[dn,_a]=l.useState(!1),[mn,Ra]=l.useState(!1),[hn,za]=l.useState(!1),[xn,Jr]=l.useState(!0),[Es,un]=l.useState(!1),[gn,la]=l.useState(!1),[pn,na]=l.useState(!1),[fn,ia]=l.useState(!1),[ft,kt]=l.useState([]),[Ja,Kr]=l.useState(""),[Ka,Vr]=l.useState(""),[Va,qr]=l.useState(""),[he,Yr]=l.useState(null),[vn,Ms]=l.useState(!1);l.useState(!1);const[yn,qa]=l.useState(!1),[Hr,Ya]=l.useState(""),[jn,Ha]=l.useState(!1),[bn,Ga]=l.useState(!1),[Mt,Qa]=l.useState([]),[Za,Gr]=l.useState(""),[Xa,Qr]=l.useState(""),[er,Zr]=l.useState(""),[Xr,el]=l.useState(""),[Nn,oa]=l.useState(!1),[tr,sr]=l.useState(null),[vt,Us]=l.useState(null),[ca,ar]=l.useState(""),[wn,js]=l.useState(!1),[tl,da]=l.useState(0),[Pt,ls]=l.useState(null),[ns,rr]=l.useState(""),[Pe,Sn]=l.useState(null),Vt=async s=>{try{const r=JSON.stringify(s);localStorage.setItem(ll(),r);try{localStorage.setItem(il(),r)}catch{}t!=null&&t.uid&&ve.updateUserData(t.uid,{debts:s}).catch(()=>de(!0))}catch(r){console.error("خطأ في حفظ الديون:",r)}},Dn=async()=>{try{const s=ll(),r=il(),a=localStorage.getItem(s),n=localStorage.getItem(r),o=m=>{if(!m)return null;try{const y=JSON.parse(m);return Array.isArray(y)?y.map(C=>{var b;return{...C,createdAt:(b=C.createdAt)!=null&&b.toDate?C.createdAt.toDate():new Date(C.createdAt),partialPayments:Array.isArray(C.partialPayments)?C.partialPayments.map(N=>{var W;return{amount:Number(N.amount)||0,paidAt:(W=N.paidAt)!=null&&W.toDate?N.paidAt.toDate():new Date(N.paidAt)}}):[]}}):[]}catch(y){return console.warn("فشل في تحليل ديون localStorage:",y),null}};let d=o(a);if(!d||d.length===0){const m=o(n);if(m&&m.length>0&&(d=m,kt(m),t!=null&&t.uid))try{await Vt(m),localStorage.removeItem(r)}catch(y){console.warn("تعذر ترحيل الديون من المفتاح الافتراضي:",y)}}if(d&&d.length>0&&kt(d),t!=null&&t.uid)try{const m=await Sa(_t(tt,"users",t.uid));if(m.exists()){const y=m.data(),C=y.debts&&Array.isArray(y.debts)?y.debts.map(A=>{var w;return{...A,createdAt:(w=A.createdAt)!=null&&w.toDate?A.createdAt.toDate():new Date(A.createdAt),partialPayments:Array.isArray(A.partialPayments)?A.partialPayments.map(J=>{var De;return{amount:Number(J.amount)||0,paidAt:(De=J.paidAt)!=null&&De.toDate?J.paidAt.toDate():new Date(J.paidAt)}}):[]}}):[],b=new Map;for(const A of d||[])b.set(A.id,A);for(const A of C)b.set(A.id,A);const N=Array.from(b.values());kt(N);try{localStorage.setItem(s,JSON.stringify(N))}catch{}(N.length!==C.length||N.some(A=>{const w=C.find(J=>J.id===A.id);return!w||w.amount!==A.amount||w.status!==A.status||(w.paidAmount??0)!==(A.paidAmount??0)}))&&await ve.updateUserData(t.uid,{debts:N})}else d&&d.length>0&&await ve.saveUserData(t.uid,{debts:d})}catch(m){console.warn("تعذر تحميل الديون من Firebase، الاعتماد على المحلي:",m)}}catch(s){console.error("خطأ في تحميل الديون:",s)}},Cn=async()=>{if(t!=null&&t.uid){console.log("🔄 إعادة فحص حالة المستخدم...");try{await new Promise(r=>setTimeout(r,500));const s=await Sa(_t(tt,"users",t.uid));if(s.exists()){const a=s.data().isActive===!0,n=await Hs.checkTrialValidity(t.uid),o=n.isValid&&!n.isExpired;console.log("📊 حالة المستخدم:",{isActive:a,isOnTrial:o,hoursRemaining:n.hoursRemaining}),F(a||o),ue(o),ze(n.hoursRemaining),gt(n.hasUsedTrial),_(!a&&!o),console.log("✅ تم تحديث حالة المستخدم بنجاح:",{userIsActive:a||o,isOnFreeTrial:o})}}catch(s){console.error("خطأ في إعادة فحص حالة المستخدم:",s)}}},In=async()=>{console.log("🎉 تم بدء التجربة المجانية، إعادة فحص حالة المستخدم..."),await Cn()},Tn=async()=>{if(t!=null&&t.uid)try{D(!0);const s=await Wr(t.uid);es(s)}catch(s){console.error("خطأ في جلب بيانات الاشتراك:",s)}finally{D(!1)}};l.useState(!1);const[kn,lr]=l.useState(!1),[Fe,Ke]=l.useState(0),[ge,Ae]=l.useState({}),[Pn,sl]=l.useState(!1),[An,al]=l.useState(!1),[Wn,nr]=l.useState(!1),[On,ma]=l.useState(!1),[rl,ir]=l.useState(""),[Fn,or]=l.useState(!1),[Bn,ha]=l.useState(!1),[cr,xa]=l.useState(""),Ee=()=>`walletBalances_${(t==null?void 0:t.uid)||"default"}`,$e=()=>`cashBalance_${(t==null?void 0:t.uid)||"default"}`,ll=()=>`debts_${(t==null?void 0:t.uid)||"default"}`,nl=()=>`customers_${(t==null?void 0:t.uid)||"default"}`,il=()=>"debts_default",ol=()=>`shopExpenses_${(t==null?void 0:t.uid)||"default"}`,Ln=()=>{try{const s=localStorage.getItem(ol());if(s){const r=JSON.parse(s);ae(r.map(a=>({...a,createdAt:new Date(a.createdAt)})))}}catch(s){console.error("خطأ أثناء تحميل مصروفات المحل من التخزين:",s)}},En=async s=>{try{localStorage.setItem(ol(),JSON.stringify(s)),ae(s)}catch(r){console.error("خطأ أثناء حفظ مصروفات المحل في التخزين:",r)}},Mn=async s=>{try{localStorage.setItem(nl(),JSON.stringify(s)),Qa(s),t!=null&&t.uid&&await ve.updateUserData(t.uid,{customers:s})}catch(r){console.error("خطأ أثناء حفظ العملاء في التخزين:",r)}},Un=async()=>{try{if(t!=null&&t.uid){const r=await Sa(_t(tt,"users",t.uid));if(r.exists()){const a=r.data();if(a.customers&&Array.isArray(a.customers)){const n=a.customers.map(o=>{var d;return{...o,createdAt:(d=o.createdAt)!=null&&d.toDate?o.createdAt.toDate():new Date(o.createdAt)}});Qa(n);return}}}const s=localStorage.getItem(nl());if(s){const r=JSON.parse(s);Qa(r.map(a=>({...a,createdAt:new Date(a.createdAt)})))}}catch(s){console.error("خطأ أثناء تحميل العملاء من التخزين:",s)}},$s=()=>`transactions_${(t==null?void 0:t.uid)||"default"}`,_s=()=>`deletedTransactions_${(t==null?void 0:t.uid)||"default"}`,Ut=()=>`wallets_${(t==null?void 0:t.uid)||"default"}`,$t=()=>`selectedWallet_${(t==null?void 0:t.uid)||"default"}`,dr=()=>{try{const s=Ut(),r=localStorage.getItem(s);if(r){const y=JSON.parse(r);if(Array.isArray(y)&&y.length>0)return y}const a="wallets_default",n=localStorage.getItem(a);if(n){const y=JSON.parse(n);if(Array.isArray(y)&&y.length>0){localStorage.setItem(s,n);try{localStorage.removeItem(a)}catch{}return y}}const o=Object.keys(localStorage).filter(y=>y.startsWith("wallets_")&&y!==s);let d=null,m=null;for(const y of o)try{const C=localStorage.getItem(y);if(!C)continue;const b=JSON.parse(C);Array.isArray(b)&&b.length>0&&(!d||b.length>((d==null?void 0:d.length)||0))&&(d=b,m=y)}catch{}if(d&&m){localStorage.setItem(s,JSON.stringify(d));try{localStorage.removeItem(m)}catch{}return d}}catch(s){console.warn("loadWalletsFromLocalWithMigration failed:",s)}return null},mr=s=>{try{const r=$t(),a=localStorage.getItem(r);if(a&&s.find(o=>o.id===a))return a;const n=[`selectedWallet_${(t==null?void 0:t.uid)||""}`,"selectedWallet_default",...Object.keys(localStorage).filter(o=>o.startsWith("selectedWallet_"))];for(const o of n)try{const d=localStorage.getItem(o);if(d&&s.find(m=>m.id===d)){if(localStorage.setItem(r,d),o!==r)try{localStorage.removeItem(o)}catch{}return d}}catch{}}catch{}return null},[hr,ua]=l.useState(""),[xt,cl]=l.useState(""),is=et.useMemo(()=>{const s=Dt;if(!s)return!1;const r=bi(s),a=s.planType??s.plan??null,n=typeof a=="string"?a.toLowerCase():null,o=n==="monthly"||n==="quarterly"||n==="yearly"||n==="lifetime"||a===Qt.MONTHLY||a===Qt.QUARTERLY||a===Qt.YEARLY||a===Qt.LIFETIME;return r&&o},[Dt]),nt=et.useMemo(()=>{const s=Dt;if(!s)return!1;const r=s.planType??s.plan??null,a=typeof r=="string"?r.toLowerCase():null;return r===Qt.ZERO||a==="zero"},[Dt]),$n=()=>{if(!is){i({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}k(!0)};l.useState(!1);const[_n,Rn]=l.useState(!1),[zn,Jn]=l.useState(!1),[Kn,Vn]=l.useState(!1),[qn,ga]=l.useState(!1),[pa,xr]=l.useState(""),[ur,gr]=l.useState(""),[dl,ml]=l.useState(!1),[Yn,fa]=l.useState(!1),[hl,pr]=l.useState(""),[xl,fr]=l.useState(""),[ul,gl]=l.useState(!1),pl=async()=>{if(t!=null&&t.uid)try{const s=`userData_${t.uid}`,r=localStorage.getItem(s);if(r){const a=JSON.parse(r);console.log("🔄 مزامنة البيانات المحلية مع Firebase...",a);const n={lastSynced:new Date().toISOString()};typeof a.cashBalance=="number"&&(n.cashBalance=a.cashBalance),a.walletBalances&&typeof a.walletBalances=="object"&&(n.walletBalances=a.walletBalances),await ve.updateUserData(t.uid,n),localStorage.removeItem(s),de(!1),console.log("✅ تمت المزامنة بنجاح وحذف البيانات المحلية")}else console.log("لا توجد بيانات محلية تحتاج للمزامنة")}catch(s){console.error("❌ فشل في مزامنة البيانات:",s),i({title:"فشل في المزامنة",description:"حدث خطأ أثناء مزامنة البيانات مع الخادم",variant:"destructive"})}},fl=t!=null&&t.uid?`recentTransactionsResetAt:${t.uid}`:null,vr=et.useMemo(()=>{if(!fl)return null;try{const s=localStorage.getItem(fl);return s?new Date(s):null}catch{return null}},[t==null?void 0:t.uid]),vl=et.useMemo(()=>{const s=Je||[];return vr?s.filter(r=>new Date(r.createdAt)>=vr):s},[Je,vr]),yl=et.useCallback(()=>{let s=vl;const r=Ur.trim();if(r&&(s=s.filter(a=>a.senderPhone&&a.senderPhone.includes(r)||a.receiverPhone&&a.receiverPhone.includes(r))),aa){const a=new Date(aa);s=s.filter(n=>{const o=new Date(n.createdAt);if(ra){const[d,m]=ra.split(":"),y=new Date(a);y.setHours(parseInt(d),parseInt(m),0,0);const C=new Date(y);return C.setHours(C.getHours()+1),o>=y&&o<C}else return o.toDateString()===a.toDateString()})}try{s=[...s].sort((a,n)=>{const o=new Date(a.createdAt||0).getTime();return new Date(n.createdAt||0).getTime()-o})}catch{}return s},[vl,Ur,aa,ra]),[Hn,va]=l.useState(!1),[jl,ya]=l.useState(""),[Gn,ja]=l.useState(!1),[yr,jr]=l.useState(""),[Qn,de]=l.useState(!1);me.reduce((s,r)=>s+(ge[r.id]||0),0);const Zn=s=>Zt.verifyMasterPin(s),br=s=>Zt.verifyMasterPin(s),Nr=async s=>{try{const r=Di.currentUser;if(!r||!r.email)return!1;const a=Ci.credential(r.email,s);return await Ii(r,a),!0}catch(r){return console.error("فشل التحقق من كلمة المرور:",r),!1}};l.useEffect(()=>{if(!(t!=null&&t.uid))return;console.log("🚀 استعادة البيانات من localStorage عند تحميل الصفحة للمستخدم:",t.uid);const s=`walletBalances_${t.uid}`,r=localStorage.getItem(s);if(r)try{const o=JSON.parse(r);console.log("📱 استعادة أرصدة المحافظ من localStorage:",o),Ae(o)}catch(o){console.error("خطأ في قراءة أرصدة المحافظ من localStorage:",o)}const a=`cashBalance_${t.uid}`;let n=localStorage.getItem(a);if(!n){const o=`userCashBalance_${t.uid}`,d=localStorage.getItem(o);if(d){n=d;try{localStorage.setItem(a,d),localStorage.removeItem(o)}catch{}}}if(n){const o=parseFloat(n);console.log("💰 استعادة رصيد الدرج النقدي من localStorage:",o),Ke(o)}},[t==null?void 0:t.uid]);const bl=async()=>{try{if(!R)return;const s=await cs.autoResetLimitsIfNeeded(R);Sn(s)}catch(s){console.error("خطأ في جلب حدود المحفظة المختارة:",s)}};l.useEffect(()=>{bl()},[R]),l.useEffect(()=>{const s=r=>{var a;(a=r==null?void 0:r.detail)!=null&&a.walletId&&r.detail.walletId===R&&bl()};return window.addEventListener("walletLimitsUpdated",s),()=>window.removeEventListener("walletLimitsUpdated",s)},[R]),l.useEffect(()=>{if(x.state){if(console.log("Location state:",x.state),x.state.openDebtDialog&&(nt?i({title:"غير متاح",description:"الديون/الأجل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):ia(!0),window.history.replaceState({},document.title)),x.state.openSalesDialog&&(nt?i({title:"غير متاح",description:"بيانات المبيعات غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):$a(!0),window.history.replaceState({},document.title)),x.state.openMaintenanceDialog&&(nt?i({title:"غير متاح",description:"الصيانة غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ra(!0),window.history.replaceState({},document.title)),x.state.openCreditCardsDialog&&(console.log("Opening credit cards dialog"),nt?i({title:"غير متاح",description:"كروت الائتمان غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):_a(!0),window.history.replaceState({},document.title)),x.state.openShopExpensesDialog&&(nt?i({title:"غير متاح",description:"مصروفات المحل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Zt.hasMasterPin()?z(!0):B(!0),window.history.replaceState({},document.title)),x.state.openTransactionSection){const s=document.getElementById("transaction-section");s&&s.scrollIntoView({behavior:"smooth"}),x.state.transactionType&&ta(x.state.transactionType),x.state.startNewTransaction&&(Te(""),at(""),Fs(""),as(""),console.log("🔒 Starting new transaction without changing wallet selection")),x.state.focusWalletSelection&&setTimeout(()=>{const r=document.querySelector('[data-testid="wallet-select"]');r&&r.focus()},500),window.history.replaceState({},document.title)}x.state.openCashierShiftModal&&(is?k(!0):i({title:"غير متاح",description:"وردية الكاشير متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"}),window.history.replaceState({},document.title)),x.state.openMachineDailyDialog&&(is?za(!0):i({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"}),window.history.replaceState({},document.title))}},[x.state,me]),l.useEffect(()=>{var s;if(t!=null&&t.uid)try{const r=dr();if(r&&r.length>0){ht(r);const a=mr(r)||localStorage.getItem($t()),n=a&&r.find(o=>o.id===a)?a:(s=r[0])==null?void 0:s.id;n&&!R&&Sr(n,"localStorageHydration")}}catch(r){console.error("خطأ في تهيئة المحافظ من التخزين المحلي:",r)}},[t==null?void 0:t.uid]),l.useEffect(()=>{x.pathname==="/user/dashboard"&&sessionStorage.getItem("previousPath")==="/user/add-wallet"&&(console.log("🔄 Returned from wallet addition page - reloading wallets"),wr(),sessionStorage.removeItem("previousPath")),sessionStorage.setItem("previousPath",x.pathname)},[x.pathname,t==null?void 0:t.uid]),l.useEffect(()=>{if(!(t!=null&&t.uid))return;console.log("🔥 Setting up real-time user activation listener for:",t.uid);const s=_t(tt,"users",t.uid),r=Ni(s,a=>{if(a.exists()){const n=a.data(),o=n.isActive===!0;console.log("🔥 Real-time user status update:",{userId:t.uid,isActive:o,subscription:n.subscription}),o&&!K?(console.log("🎉 User activated! Redirecting to dashboard..."),F(!0),_(!1),$(!1)):!o&&K&&(console.log("❌ User deactivated! Showing activation modal..."),F(!1),_(!0))}},a=>{console.error("❌ Error in real-time user listener:",a)});return()=>{console.log("🔥 Cleaning up real-time user listener"),r()}},[t==null?void 0:t.uid,K]),l.useEffect(()=>{if(!(t!=null&&t.uid))return;const s=a=>{const{userId:n}=a.detail;n===t.uid&&(console.log("🎉 Subscription activation event received for current user!"),F(!0),_(!1),$(!1),setTimeout(()=>{console.log("✅ User activation completed - data updated")},1e3))},r=a=>{const{userId:n,isActive:o}=a.detail;n===t.uid&&(console.log("🔄 User subscription update event received:",{userId:n,isActive:o}),o&&!K&&(F(!0),_(!1),$(!1),setTimeout(()=>{console.log("✅ User subscription updated - data refreshed")},1e3)))};return window.addEventListener("subscriptionActivated",s),window.addEventListener("userSubscriptionUpdated",r),()=>{window.removeEventListener("subscriptionActivated",s),window.removeEventListener("userSubscriptionUpdated",r)}},[t==null?void 0:t.uid,K]),l.useEffect(()=>{console.log("🔥 useEffect loadUserData started",{user:t==null?void 0:t.uid,isCheckingActivation:S}),(async()=>{try{if(!(t!=null&&t.uid)){console.log("🔥 No user UID, setting isCheckingActivation to false"),$(!1);return}let n=!1;const o=`userData_${t==null?void 0:t.uid}`,d=localStorage.getItem(o);if(d)try{const N=JSON.parse(d);N.walletBalances&&(Ae(N.walletBalances),n=!0,console.log("⚡ تحميل فوري لأرصدة المحافظ من بيانات المستخدم:",N.walletBalances))}catch(N){console.error("خطأ في قراءة بيانات المستخدم من localStorage:",N)}if(!n){const N=localStorage.getItem(Ee());if(N)try{const W=JSON.parse(N);Ae(W),n=!0,console.log("⚡ تحميل فوري لأرصدة المحافظ من النسخة الاحتياطية:",W)}catch(W){console.error("خطأ في قراءة أرصدة المحافظ من localStorage:",W)}}if(!n){const W=Object.keys(localStorage).filter(A=>A.startsWith("walletBalances_backup_")).sort().reverse();for(const A of W)try{const w=localStorage.getItem(A);if(w){const J=JSON.parse(w);Ae(J),n=!0,console.log("⚡ تحميل فوري لأرصدة المحافظ من النسخة الاحتياطية بالتوقيت:",J);break}}catch(w){console.error("خطأ في قراءة النسخة الاحتياطية:",w);continue}}let m=localStorage.getItem($e());if(!m&&(t!=null&&t.uid)){const N=`userCashBalance_${t.uid}`,W=localStorage.getItem(N);if(W){m=W;try{localStorage.setItem($e(),W),localStorage.removeItem(N)}catch{}}}m&&(Ke(parseFloat(m)),console.log("⚡ تحميل فوري لرصيد الدرج النقدي من localStorage:",m));try{const N=await Sa(_t(tt,"users",t.uid));if(N.exists()){const A=N.data().isActive===!0,w=await Hs.checkTrialValidity(t.uid),J=w.isValid&&!w.isExpired;F(A||J),ue(J),ze(w.hoursRemaining),gt(w.hasUsedTrial),_(!A&&!J),console.log("📊 حالة المستخدم:",{isActive:A,isOnTrial:J,hoursRemaining:w.hoursRemaining,hasUsedTrial:w.hasUsedTrial})}else F(!1),_(!0)}catch(N){console.error("خطأ في فحص حالة تفعيل المستخدم:",N),F(!1),_(!0)}finally{$(!1)}console.log("🔄 بدء تحميل بيانات المستخدم من Firebase...",{userId:t==null?void 0:t.uid});const y=localStorage.getItem(o);let C=!1;if(y)try{const N=JSON.parse(y),W=new Date(N.lastUpdated);(new Date().getTime()-W.getTime())/(1e3*60)<1&&(C=!0,console.log("⚡ توجد تغييرات محلية حديثة (أقل من دقيقة)، تجنب إعادة التحميل من Firebase"),N.walletBalances&&Ae(N.walletBalances),N.cashBalance!==void 0&&Ke(N.cashBalance))}catch(N){console.error("خطأ في قراءة البيانات المحلية:",N)}if(y&&!C)try{const N=JSON.parse(y),W=new Date(N.lastUpdated);(new Date().getTime()-W.getTime())/(1e3*60)>10&&(console.log("🗑️ حذف البيانات المحلية القديمة (أكثر من 10 دقائق)"),localStorage.removeItem(o))}catch(N){console.error("خطأ في حذف البيانات المحلية القديمة:",N)}if(!C&&(t!=null&&t.uid)){const N=await ve.getUserData(t.uid);if(console.log("📥 البيانات المحملة من Firebase:",N),N){if(N.walletBalances!==void 0&&Object.keys(ge).length===0)console.log("👛 تحميل أرصدة المحافظ:",N.walletBalances),Ae(N.walletBalances),localStorage.setItem(Ee(),JSON.stringify(N.walletBalances));else{const W=localStorage.getItem(Ee());if(W)try{const A=JSON.parse(W);console.log("📱 استعادة أرصدة المحافظ من localStorage:",A),Ae(A),t!=null&&t.uid?await ve.updateUserData(t.uid,{walletBalances:A,lastUpdated:new Date().toISOString()}):de(!0)}catch(A){console.error("خطأ في قراءة أرصدة المحافظ من localStorage:",A);const w={"wallet-1":1e4,"wallet-2":5e3};Ae(w),localStorage.setItem(Ee(),JSON.stringify(w)),t!=null&&t.uid?await ve.updateUserData(t.uid,{walletBalances:w,lastUpdated:new Date().toISOString()}):de(!0)}else{console.log("⚠️ لا توجد أرصدة محافظ في Firebase أو localStorage، إنشاء أرصدة افتراضية");const A={"wallet-1":1e4,"wallet-2":5e3};Ae(A),localStorage.setItem(Ee(),JSON.stringify(A)),t!=null&&t.uid?await ve.updateUserData(t.uid,{walletBalances:A,lastUpdated:new Date().toISOString()}):de(!0)}}N.cashBalance!==void 0&&Fe===0?(console.log("💰 تحميل رصيد الدرج النقدي:",N.cashBalance),Ke(N.cashBalance),localStorage.setItem($e(),N.cashBalance.toString())):(console.log("⚠️ لا يوجد رصيد درج نقدي، استخدام القيمة الافتراضية: 0"),Ke(0),localStorage.setItem($e(),"0"));try{const W=await wa.getDeletedTransactions();if(W&&W.length>0)rs(W),console.log("🗑️ تم تحميل المعاملات المحذوفة من Firebase:",W.length);else{const A=localStorage.getItem(_s());if(A)try{const w=JSON.parse(A);rs(w),console.log("🗑️ تم تحميل المعاملات المحذوفة من localStorage:",w.length)}catch(w){console.error("خطأ في قراءة المعاملات المحذوفة من localStorage:",w)}}}catch(W){console.error("خطأ في تحميل المعاملات المحذوفة من Firebase:",W);const A=localStorage.getItem(_s());if(A)try{const w=JSON.parse(A);rs(w),console.log("🗑️ تم تحميل المعاملات المحذوفة من localStorage (fallback):",w.length)}catch(w){console.error("خطأ في قراءة المعاملات المحذوفة من localStorage:",w)}}}else{console.log("⚠️ لا توجد بيانات مستخدم في Firebase، محاولة استعادة من localStorage");const W=localStorage.getItem(Ee());if(W)try{const w=JSON.parse(W);console.log("📱 استعادة أرصدة المحافظ من localStorage:",w),Ae(w)}catch(w){console.error("خطأ في قراءة أرصدة المحافظ من localStorage:",w)}let A=localStorage.getItem($e());if(!A&&(t!=null&&t.uid)){const w=`userCashBalance_${t.uid}`,J=localStorage.getItem(w);if(J){A=J;try{localStorage.setItem($e(),J),localStorage.removeItem(w)}catch{}}}A&&(Ke(parseFloat(A)),console.log("💰 استعادة رصيد الدرج النقدي من localStorage:",A));try{const w=await wa.getDeletedTransactions();if(w&&w.length>0)rs(w),console.log("🗑️ تم تحميل المعاملات المحذوفة من Firebase:",w.length);else{const J=localStorage.getItem(_s());if(J)try{const De=JSON.parse(J);rs(De),console.log("🗑️ تم تحميل المعاملات المحذوفة من localStorage:",De.length)}catch(De){console.error("خطأ في قراءة المعاملات المحذوفة من localStorage:",De)}}}catch(w){console.error("خطأ في تحميل المعاملات المحذوفة من Firebase:",w);const J=localStorage.getItem(_s());if(J)try{const De=JSON.parse(J);rs(De),console.log("🗑️ تم تحميل المعاملات المحذوفة من localStorage (fallback):",De.length)}catch(De){console.error("خطأ في قراءة المعاملات المحذوفة من localStorage:",De)}}}}console.log("🔄 بدء تحميل المحافظ من Firebase...");try{const N=await Rt.getByMerchantId((t==null?void 0:t.uid)||"");if(N&&N.length>0){console.log("✅ تم العثور على محافظ في Firebase:",N.length);const W=N.map(J=>({id:J.id,name:J.label||"محفظة بدون اسم",phone:J.msisdn,isDefault:!1,monthlyWithdrawalLimit:J.monthlyWithdrawalLimit??J.withdrawLimit??2e5,monthlyTransferLimit:J.monthlyTransferLimit??J.transferLimit??2e5,defaultTransferCommission:J.defaultTransferCommission!=null?Number(J.defaultTransferCommission):null,defaultWithdrawCommission:J.defaultWithdrawCommission!=null?Number(J.defaultWithdrawCommission):null}));ht(W),localStorage.setItem(Ut(),JSON.stringify(W));const A=localStorage.getItem($t());let w=null;A&&W.find(J=>J.id===A)?w=W.find(J=>J.id===A):w=W[0],w&&(Qe(w.id),oe(w.phone)),console.log("🔄 تم تحديث المحافظ من Firebase وحفظها في localStorage")}else{console.log("⚠️ لا توجد محافظ في Firebase، محاولة التحميل من localStorage...");const W=dr();if(W&&W.length>0)try{console.log("📱 تم العثور على محافظ محلية بعد الهجرة:",W.length),ht(W);const A=mr(W)||localStorage.getItem($t());let w=null;A&&W.find(J=>J.id===A)?w=W.find(J=>J.id===A):w=W.find(J=>J.isDefault)||W[0],w&&(Qe(w.id),oe(w.phone))}catch(A){console.error("خطأ في معالجة المحافظ بعد الهجرة:",A)}else{console.log("⚠️ لا توجد محافظ محلية، إنشاء محافظ افتراضية...");const A=[{id:"wallet-1",name:"المحفظة الرئيسية",phone:"01030302038",isDefault:!0,monthlyWithdrawalLimit:2e5,monthlyTransferLimit:2e5},{id:"wallet-2",name:"محفظة احتياطية",phone:"01234567890",isDefault:!1,monthlyWithdrawalLimit:2e5,monthlyTransferLimit:2e5}];ht(A),localStorage.setItem(Ut(),JSON.stringify(A))}}}catch(N){console.error("خطأ في تحميل المحافظ من Firebase:",N);const W=dr();if(W&&W.length>0)try{console.log("📱 استخدام المحافظ من localStorage بعد الهجرة:",W.length),ht(W);const A=mr(W)||localStorage.getItem($t());let w=null;A&&W.find(J=>J.id===A)?w=W.find(J=>J.id===A):w=W.find(J=>J.isDefault)||W[0],w&&(Qe(w.id),oe(w.phone))}catch(A){console.error("خطأ في قراءة المحافظ من localStorage بعد الهجرة:",A),ht([{id:"wallet-1",name:"المحفظة الرئيسية",phone:"01030302038",isDefault:!0,monthlyWithdrawalLimit:2e5,monthlyTransferLimit:2e5}])}else console.log("⚠️ لا توجد محافظ محلية، إنشاء محفظة افتراضية..."),ht([{id:"wallet-1",name:"المحفظة الرئيسية",phone:"01030302038",isDefault:!0,monthlyWithdrawalLimit:2e5,monthlyTransferLimit:2e5}])}const b=t!=null&&t.uid?await ve.getUserTransactions(t.uid):[];if(b&&b.length>0){console.log("📊 تم تحميل المعاملات من Firebase:",b.length);const N=b.map(w=>({...w,createdAt:new Date(w.createdAt),senderPhone:w.senderMsisdn||w.senderPhone||"",receiverPhone:w.receiverMsisdn||w.receiverPhone||"",type:w.txnType==="send"?"send":w.txnType==="receive"?"withdraw":w.type||"withdraw",status:w.status==="confirmed"?"completed":w.status||"completed"})),W=Er.map(w=>w.id||w.originalTransactionId),A=N.filter(w=>!W.includes(w.id));console.log("✅ تم فلترة المعاملات المحذوفة:",{total:b.length,deleted:W.length,active:A.length}),Tt(A)}await pl()}catch(n){console.error("خطأ في تحميل بيانات المستخدم من Firebase:",n);let o=localStorage.getItem($e());if(!o&&(t!=null&&t.uid)){const m=`userCashBalance_${t.uid}`,y=localStorage.getItem(m);if(y){o=y;try{localStorage.setItem($e(),y),localStorage.removeItem(m)}catch{}}}o&&Ke(parseFloat(o));const d=localStorage.getItem(Ee());if(d)try{const m=JSON.parse(d);Ae(m),console.log("📱 تم استعادة أرصدة المحافظ من localStorage:",m)}catch(m){console.error("خطأ في قراءة أرصدة المحافظ من localStorage:",m)}}})().then(async()=>{await r(),await a()});const r=async()=>{try{for(const n of me)await Li.autoResetLimitsIfNeeded(n.phone)}catch(n){console.error("خطأ في التصفير التلقائي للحدود:",n)}},a=async()=>{try{const n=At.getReportsData(t==null?void 0:t.uid);if((n.lastDailyResetDate?At.shouldResetDailyReports(n.lastDailyResetDate):!1)&&(t!=null&&t.uid)&&n.lastDailyResetDate){const m=new Date(n.lastDailyResetDate),y=m.toDateString();let C=Je.filter(Ye=>new Date(Ye.createdAt).toDateString()===y&&Ye.status==="completed");const b=At.filterVisibleTransactions(C,"daily",t==null?void 0:t.uid),N=b.length,W=b.reduce((Ye,pe)=>Ye+pe.amount,0),A=b.filter(Rs).reduce((Ye,pe)=>{const _e=pe.withdrawnAmount!==void 0?pe.withdrawnAmount:pe.amount;return Ye+_e},0),w=b.filter(zs).reduce((Ye,pe)=>{const _e=pe.sentAmount!==void 0?pe.sentAmount:pe.amount;return Ye+_e},0),J=b.reduce((Ye,pe)=>Ye+At.calculateTransactionProfit(pe),0),De=new Date(m).toISOString().slice(0,10);await Rl.add({userId:t.uid,reportDate:De,totalTransactions:N,totalAmount:Number(W.toFixed(2)),totalWithdrawn:Number(A.toFixed(2)),totalSent:Number(w.toFixed(2)),profit:Number(J.toFixed(2)),walletId:null}),i({title:"تم أرشفة تقارير اليوم",description:De})}const d=At.autoResetReportsIfNeeded(t==null?void 0:t.uid);(d.dailyReset||d.monthlyReset)&&console.log("تم التصفير التلقائي:",d)}catch(n){console.error("خطأ في التصفير التلقائي للتقارير:",n)}};Tn(),Dn(),Un(),console.log("🔥 useEffect loadUserData completed")},[t==null?void 0:t.uid]);const wr=async()=>{var s;if(t!=null&&t.uid)try{const r=await Rt.getByMerchantId(t.uid);if(r&&r.length>0){const a=r.map(n=>({id:n.id,name:n.label||"محفظة بدون اسم",phone:n.msisdn,isDefault:!1,monthlyWithdrawalLimit:n.monthlyWithdrawalLimit??n.withdrawLimit??2e5,monthlyTransferLimit:n.monthlyTransferLimit??n.transferLimit??2e5,defaultTransferCommission:n.defaultTransferCommission!=null?Number(n.defaultTransferCommission):void 0,defaultWithdrawCommission:n.defaultWithdrawCommission!=null?Number(n.defaultWithdrawCommission):void 0}));if(ht(a),localStorage.setItem(Ut(),JSON.stringify(a)),t!=null&&t.uid){const n=localStorage.getItem($t());if(!!(R&&a.find(d=>d.id===R)))console.log("🔒 Preserving current wallet selection:",R);else{const m=(n&&a.find(y=>y.id===n)?n:null)||((s=a[0])==null?void 0:s.id);m&&(console.log("🔄 Fixing invalid wallet selection:",m),Sr(m))}}console.log("🔄 تم تحديث المحافظ من Firebase:",a.length)}}catch(r){console.error("خطأ في تحميل المحافظ من Firebase:",r)}};l.useEffect(()=>{const s=x.pathname;sessionStorage.getItem("previousPath")==="/user/add-wallet"&&s==="/user/dashboard"&&(console.log("🔄 Returning from add wallet page - reloading wallets"),console.log("🔒 Current wallet before add-wallet return reload:",R),wr(),sessionStorage.removeItem("previousPath")),sessionStorage.setItem("previousPath",s)},[x.pathname,t==null?void 0:t.uid]),l.useEffect(()=>{const s=()=>{console.log("🔄 Window focused - reloading wallets"),console.log("🔒 Current wallet before focus reload:",R),wr().then(()=>{console.log("🔒 Wallet preserved after focus reload:",R)})};return window.addEventListener("focus",s),()=>{window.removeEventListener("focus",s)}},[t==null?void 0:t.uid,R,me]);const Sr=(s,r="unknown")=>{console.log(`🎯 setWalletSelection called from ${r} with walletId:`,s),console.log("🔍 Previous selectedWallet:",R),Qe(s);const a=me.find(n=>n.id===s);a&&(oe(a.phone),console.log("✅ Wallet set successfully:",s,"Phone:",a.phone)),t!=null&&t.uid&&(localStorage.setItem($t(),s),console.log("💾 Saved wallet to localStorage:",s))},Xn=s=>{if(s==="__add_wallet"){I("/user/add-wallet");return}if(s==="__view_wallets"){ss(!0);return}Sr(s,"handleWalletChange")},Nl=s=>{console.log("🔄 handleTransactionTypeChange called with type:",s),console.log("🔍 Current selectedWallet before change:",R),console.log("🔍 Available wallets count:",me.length),ta(s),Te(""),at(""),Fs(""),as(""),console.log("✅ Transaction type changed to:",s,"- Wallet selection preserved:",R),setTimeout(()=>{const r=document.getElementById("transaction-section");r&&r.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})},100)},ei=s=>{en((a=>({id:a.id,type:a.type==="send"?"transfer":"withdraw",sender_msisdn:a.senderPhone,receiver_msisdn:a.receiverPhone,amount:a.amount,commission:a.commission||0,status:a.status==="failed"?"failed":a.status==="completed"?"completed":"pending",createdAt:new Date(a.createdAt).toISOString(),updatedAt:new Date(a.createdAt).toISOString(),shopName:h??(u==null?void 0:u.shopName)??(t==null?void 0:t.displayName)??"المحل",cashierName:(a==null?void 0:a.cashierName)??null,commissionMode:(a==null?void 0:a.commissionMode)??(je?"add":"deduct"),totalCharged:(a==null?void 0:a.totalCharged)??(je?Number(a.amount||0)+Number(a.commission||0):Number(a.amount||0))}))(s)),sa(!0)},ti=async s=>{if(!(t!=null&&t.uid)){i({title:"خطأ في المصادقة",description:"يجب تسجيل الدخول أولاً لحذف المعاملات",variant:"destructive"});return}const r=Je.find(a=>a.id===s);if(!r){i({title:"خطأ في الحذف",description:"لم يتم العثور على المعاملة المطلوب حذفها",variant:"destructive"});return}try{console.log("🗑️ بدء عملية حذف المعاملة:",s),console.log("🔄 حذف المعاملة نهائياً من Firebase...",{transactionId:r.id,userId:t.uid,transactionData:r}),await ve.removeUserTransaction(t.uid,r.id),console.log("✅ تم حذف المعاملة نهائياً من Firebase userTransactions");try{await wa.saveDeletedTransaction({...r,userId:t.uid,originalTransactionId:r.id,deletedAt:new Date().toISOString()}),console.log("✅ تم حفظ المعاملة في سجل المحذوفات مع تاريخ الحذف")}catch(o){console.warn("⚠️ فشل في حفظ المعاملة في سجل المحذوفات، لكن الحذف من Firebase نجح:",o)}const a=[...Er,r],n=Je.filter(o=>o.id!==s);rs(a),Tt(n),ke(!1),localStorage.setItem(_s(),JSON.stringify(a)),localStorage.setItem($s(),JSON.stringify(n)),console.log("✅ تم تحديث البيانات المحلية بنجاح بعد الحذف من Firebase");try{let o=localStorage.getItem($e());if(!o&&(t!=null&&t.uid)){const C=`userCashBalance_${t.uid}`,b=localStorage.getItem(C);if(b){o=b;try{localStorage.setItem($e(),b),localStorage.removeItem(C)}catch{}}}const d=localStorage.getItem(Ee());let m=o?parseFloat(o):0,y=d?JSON.parse(d):{};if(r.type==="send"){const C=r.commission||0;m-=C;const b=r.fromWallet||Object.keys(y)[0];if(b){const N=y[b]||0;y[b]=N+r.amount}}else if(r.type==="withdraw"){const C=r.commission||0;m+=r.amount,m-=C;const b=r.fromWallet||Object.keys(y)[0];if(b){const N=y[b]||0;y[b]=Math.max(0,N-r.amount)}}localStorage.setItem($e(),m.toString()),localStorage.setItem(Ee(),JSON.stringify(y))}catch(o){console.warn("فشل عكس تأثير الأرصدة محليًا بعد الحذف:",o)}try{const o=r.fromWallet;if(o){const{walletDailyLimitsService:d}=await Yt(async()=>{const{walletDailyLimitsService:y}=await import("./walletDailyLimitsService-CI0pNeTV.js");return{walletDailyLimitsService:y}},__vite__mapDeps([2,0,1])),m=await d.getWalletLimits(o);if(m){const y=r.type==="send",C={updatedAt:(await Yt(async()=>{const{serverTimestamp:w}=await import("./index-m0kHFZRo.js").then(J=>J.aY);return{serverTimestamp:w}},__vite__mapDeps([0,1]))).serverTimestamp()};y?(C.dailyTransferUsed=Math.max(0,(m.dailyTransferUsed||0)-r.amount),C.monthlyTransferUsed=Math.max(0,(m.monthlyTransferUsed||0)-r.amount)):(C.dailyWithdrawUsed=Math.max(0,(m.dailyWithdrawUsed||0)-r.amount),C.monthlyWithdrawUsed=Math.max(0,(m.monthlyWithdrawUsed||0)-r.amount));const{doc:b,setDoc:N}=await Yt(async()=>{const{doc:w,setDoc:J}=await import("./index-m0kHFZRo.js").then(De=>De.aY);return{doc:w,setDoc:J}},__vite__mapDeps([0,1])),{db:W}=await Yt(async()=>{const{db:w}=await import("./index-m0kHFZRo.js").then(J=>J.aZ);return{db:w}},__vite__mapDeps([0,1])),A=b(W,"walletLimits",o);await N(A,C,{merge:!0})}}}catch(o){console.warn("فشل استرجاع حدود المحفظة بعد الحذف:",o)}try{const{ProfitService:o}=await Yt(async()=>{const{ProfitService:b}=await import("./profitService-Un0hQgrk.js");return{ProfitService:b}},__vite__mapDeps([3,4,5])),{ReportsService:d}=await Yt(async()=>{const{ReportsService:b}=await import("./reportsService-Bp1Io21u.js");return{ReportsService:b}},[]),y={txnType:r.type==="send"?"send":"receive",amount:r.amount,commission:r.commission||0,createdAt:r.createdAt,status:"confirmed"},C=o.calculateProfitFromTransaction(y);C>0&&o.addProfit(-C,t.uid);try{d.removeTransactionEffects(r,t.uid)}catch{}}catch(o){console.warn("فشل تحديث الأرباح/التقارير بعد الحذف:",o)}i({title:"تم حذف المعاملة نهائياً",description:"تم حذف المعاملة نهائياً من النظام. يمكنك العثور عليها في قائمة المحذوفات"})}catch(a){console.error("❌ خطأ في حذف المعاملة من Firebase:",a);let n="فشل في حذف المعاملة من الخادم. يرجى المحاولة مرة أخرى";a instanceof Error&&(a.message.includes("network")||a.message.includes("offline")?n="مشكلة في الاتصال بالإنترنت. تحقق من الاتصال وحاول مرة أخرى":a.message.includes("permission")||a.message.includes("unauthorized")?n="ليس لديك صلاحية لحذف هذه المعاملة":a.message.includes("not-found")&&(n="المعاملة غير موجودة أو تم حذفها مسبقاً")),i({title:"خطأ في الحذف",description:n,variant:"destructive"})}},Rs=s=>{const r=s.type,a=s.txnType;return r==="withdraw"||r==="withdrawal"||r==="receive"||a==="receive"},zs=s=>{const r=s.type,a=s.txnType;return r==="send"||r==="transfer"||a==="send"},ba=(s,r)=>{const a=new Date().toDateString();let n=Je.filter(b=>new Date(b.createdAt).toDateString()===a&&b.status==="completed");Kt&&Kt.trim()!==""&&(n=n.filter(b=>b.senderPhone&&b.senderPhone.includes(Kt)||b.receiverPhone&&b.receiverPhone.includes(Kt)));const o=At.filterVisibleTransactions(n,"daily",t==null?void 0:t.uid),d=o.length,m=o.reduce((b,N)=>b+N.amount,0),y=o.filter(Rs).reduce((b,N)=>{const W=N.withdrawnAmount!==void 0?N.withdrawnAmount:N.amount;return b+W},0),C=o.filter(zs).reduce((b,N)=>{const W=N.sentAmount!==void 0?N.sentAmount:N.amount;return b+W},0);return{totalTransactions:d,totalAmount:m,totalWithdrawn:y,totalSent:C}},Js=s=>{const r=new Date().getMonth(),a=new Date().getFullYear();let n=Je.filter(b=>{const N=new Date(b.createdAt);return N.getMonth()===r&&N.getFullYear()===a&&b.status==="completed"});Kt&&Kt.trim()!==""&&(n=n.filter(b=>b.senderPhone&&b.senderPhone.includes(Kt)||b.receiverPhone&&b.receiverPhone.includes(Kt)));const o=At.filterVisibleTransactions(n,"monthly",t==null?void 0:t.uid),d=o.length,m=o.reduce((b,N)=>b+N.amount,0),y=o.filter(Rs).reduce((b,N)=>{const W=N.withdrawnAmount!==void 0?N.withdrawnAmount:N.amount;return b+W},0),C=o.filter(zs).reduce((b,N)=>{const W=N.sentAmount!==void 0?N.sentAmount:N.amount;return b+W},0);return{totalTransactions:d,totalAmount:m,totalWithdrawn:y,totalSent:C}},wl=s=>{const r=new Date().getMonth(),a=new Date().getFullYear(),n=Je.filter(m=>{const y=new Date(m.createdAt);return y.getMonth()===r&&y.getFullYear()===a&&m.status==="completed"&&m.fromWallet===s}),o=n.filter(Rs).reduce((m,y)=>{const C=y.withdrawnAmount||y.amount;return m+C},0),d=n.filter(zs).reduce((m,y)=>{const C=y.sentAmount||y.amount;return m+C},0);return{totalWithdrawn:o,totalTransferred:d}},si=s=>{const r=new Date,a=r.getDate(),n=r.getMonth(),o=r.getFullYear(),d=Je.filter(C=>{const b=new Date(C.createdAt);return b.getDate()===a&&b.getMonth()===n&&b.getFullYear()===o&&C.status==="completed"&&C.fromWallet===s}),m=d.filter(Rs).reduce((C,b)=>{const N=b.withdrawnAmount||b.amount;return C+N},0),y=d.filter(zs).reduce((C,b)=>{const N=b.sentAmount||b.amount;return C+N},0);return{totalWithdrawn:m,totalTransferred:y}};Js(),l.useEffect(()=>{const s=localStorage.getItem($s());if(s){const a=JSON.parse(s).map(n=>({...n,createdAt:new Date(n.createdAt)}));Tt(a)}},[]),l.useEffect(()=>{Je.length>0&&localStorage.setItem($s(),JSON.stringify(Je))},[Je]);const Sl=async()=>{vo(),console.log("🔄 بدء عملية التحويل/السحب"),console.log("📊 البيانات المدخلة:",{senderPhone:G,receiverPhone:be,amount:we,transactionType:te});const s=()=>{te==="transfer"?ys(!0):Ls(!0)},r=()=>{te==="transfer"?ys(!1):Ls(!1)};if(s(),!G||!we){console.log("❌ خطأ: بيانات ناقصة"),i({title:"خطأ في البيانات",description:"يرجى ملء جميع الحقول المطلوبة",variant:"destructive"}),r();return}if(te==="transfer"&&!be&&!j){console.log("❌ خطأ: رقم المستقبل مفقود"),i({title:"خطأ في البيانات",description:"يرجى إدخال رقم المستقبل",variant:"destructive"}),r();return}const a=parseFloat(we);if(console.log("💰 المبلغ المحول:",a),a<=0){console.log("❌ خطأ: مبلغ غير صحيح"),i({title:"خطأ في المبلغ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"}),r();return}const n=me.find(pe=>pe.id===R);if(!n){i({title:"خطأ في المحفظة",description:"يرجى اختيار محفظة صحيحة",variant:"destructive"}),r();return}const o=wl(R);if(console.log("📈 فحص الحدود الشهرية للمحفظة المختارة"),console.log("📊 الإحصائيات الشهرية للمحفظة:",{walletId:R,walletName:n.name,currentWithdrawn:o.totalWithdrawn,currentTransferred:o.totalTransferred,withdrawalLimit:n.monthlyWithdrawalLimit,transferLimit:n.monthlyTransferLimit}),te==="withdraw"){if(console.log("🏧 فحص حد السحب الشهري للمحفظة"),console.log(`💸 المسحوب حالياً من المحفظة: ${o.totalWithdrawn}, المبلغ الجديد: ${a}, الحد الأقصى: ${n.monthlyWithdrawalLimit}`),o.totalWithdrawn+a>n.monthlyWithdrawalLimit){console.log("❌ تجاوز حد السحب الشهري للمحفظة"),i({title:"تجاوز حد السحب الشهري",description:`لا يمكن سحب أكثر من ${n.monthlyWithdrawalLimit} جنيه شهرياً من محفظة ${n.name}`,variant:"destructive"}),r();return}}else if(console.log("💸 فحص حد التحويل الشهري للمحفظة"),console.log(`📤 المحول حالياً من المحفظة: ${o.totalTransferred}, المبلغ الجديد: ${a}, الحد الأقصى: ${n.monthlyTransferLimit}`),o.totalTransferred+a>n.monthlyTransferLimit){console.log("❌ تجاوز حد التحويل الشهري للمحفظة"),i({title:"تجاوز حد التحويل الشهري",description:`لا يمكن تحويل أكثر من ${n.monthlyTransferLimit} جنيه شهرياً من محفظة ${n.name}`,variant:"destructive"}),r();return}const d=(u==null?void 0:u.shopName)||(t==null?void 0:t.displayName)||"محل كاشي لينك",m={id:Date.now().toString(),type:te==="transfer"?"send":te==="deposit"?"deposit":"withdraw",senderPhone:G,receiverPhone:te==="transfer"?be:G,amount:a,status:"completed",createdAt:new Date,withdrawnAmount:te==="withdraw"?a:void 0,sentAmount:te==="transfer"?a:void 0,depositedAmount:void 0,fromWallet:R,senderNumber:G,senderName:G,shopName:(n==null?void 0:n.name)||"المحفظة الرئيسية",transferredAmount:te==="transfer"?a:void 0,receiverNumber:te==="transfer"?be:void 0,withdrawnAmountDetailed:te==="withdraw"?a:void 0,depositedAmountDetailed:void 0,merchantShopName:d,transactionReference:`TXN-${Date.now()}`,commission:0,notes:te==="transfer"?`تحويل من ${G} إلى ${be}`:`سحب نقدي من محفظة ${G}`};M&&(g!=null&&g.name||g!=null&&g.username)&&(m.cashierName=(g==null?void 0:g.name)||(g==null?void 0:g.username));const y=ks.validateTransaction(a,te,Fe,ge);if(!y.isValid){i({title:"خطأ في العملية",description:y.error,variant:"destructive"}),r();return}y.warning&&i({title:"تحذير",description:y.warning,variant:"destructive"});let C;if(te==="transfer")if((n==null?void 0:n.defaultTransferCommission)!=null){const pe=Number(n.defaultTransferCommission)||0;C=Math.round(pe*a/1e3*100)/100}else lt&&lt.trim()!==""?C=Math.max(0,parseFloat(lt)):C=0;else if((n==null?void 0:n.defaultWithdrawCommission)!=null){const pe=Number(n.defaultWithdrawCommission)||0;C=Math.round(pe*a/1e3*100)/100}else Ne&&Ne.trim()!==""?C=Math.max(0,parseFloat(Ne)):C=Math.round(a*.01*100)/100;if(m.commission=C,!je&&C>=a){i({title:"خطأ في العمولة",description:"العمولة أكبر من أو تساوي المبلغ المدخل",variant:"destructive"}),r();return}const b=je?a:Math.round((a-C)*100)/100;m.amount=b,m.withdrawnAmount=te==="withdraw"?b:void 0,m.sentAmount=te==="transfer"?b:void 0,m.transferredAmount=te==="transfer"?b:void 0,m.withdrawnAmountDetailed=te==="withdraw"?b:void 0;let N;const W=te==="transfer"&&!!qe,A=te==="withdraw"&&!!qe,w=W||A;let J=null;if(w)if(W){const pe=ks.validateTransaction(b,"transfer",Fe,ge);pe.isValid?N={success:!0,newCashBalance:Fe,newWalletBalances:ge}:N={success:!1,newCashBalance:Fe,newWalletBalances:ge,message:pe.error||"رصيد غير كافٍ للتحويل المؤجل",error:"INSUFFICIENT_WALLET_BALANCE"}}else N={success:!0,newCashBalance:Fe,newWalletBalances:ge};else te==="transfer"?N=await ks.processTransfer({amount:b,currentCashBalance:Fe,currentWalletBalances:ge,wallets:me,selectedWalletId:R,skipRemoteLimitsCheck:!0,nonBlockingUsageUpdate:!0}):N=await ks.processWithdraw({amount:b,currentCashBalance:Fe,currentWalletBalances:ge,wallets:me,selectedWalletId:R,skipRemoteLimitsCheck:!0,nonBlockingUsageUpdate:!0});if(!N.success){i({title:"فشل في العملية",description:N.error||N.message,variant:"destructive"}),r();return}let De=w?Fe:N.newCashBalance,Ye=w?ge:N.newWalletBalances;if(w&&A){const pe=me.find(ut=>ut.id===R)??me.find(ut=>ut.isDefault)??me[0],_e=(pe==null?void 0:pe.id)||R;if(_e!==R)try{Qe(_e),localStorage.setItem($t(),_e)}catch{}const qt=Number(ge[_e]||0);Ye={...ge,[_e]:Math.round((qt+Number(b))*100)/100};try{const ut=`walletEffectsAppliedOnCreation_${(t==null?void 0:t.uid)||"default"}`,Na=localStorage.getItem(ut),Ks=Na?JSON.parse(Na):[];m!=null&&m.id&&!Ks.includes(m.id)&&(Ks.push(m.id),localStorage.setItem(ut,JSON.stringify(Ks)))}catch{}}if(w&&W){const pe=me.find(ut=>ut.id===R)??me.find(ut=>ut.isDefault)??me[0],_e=(pe==null?void 0:pe.id)||R;if(_e!==R)try{Qe(_e),localStorage.setItem($t(),_e)}catch{}const qt=Number(ge[_e]||0);Ye={...ge,[_e]:Math.round((qt-Number(b))*100)/100}}if((W||A)&&qe&&!ea){const pe={id:`DEBT-${Date.now()}`,debtorName:qe.debtorName,amount:qe.amount,reason:qe.notes||"",customerId:qe.customerId,mobile:qe.mobile,status:"pending",createdAt:new Date};J=pe.id;const _e=[pe,...ft];kt(_e);try{await Vt(_e)}catch(qt){console.error("⚠️ فشل حفظ الدين المؤجل محلياً:",qt)}i({title:"تم إضافة الدين",description:"أضيف إلى إيصالات الديون حتى يتم السداد",variant:"default"})}C>0&&!w&&(De+=C,console.log(`💰 تم إضافة عمولة ${C} جنيه لدرج النقدية`)),console.log("⚡ تحديث الواجهة فوراً..."),Ke(De),Ae(Ye),w&&(m.status="pending"),Tt(pe=>[m,...pe]),localStorage.setItem($e(),De.toString()),localStorage.setItem(Ee(),JSON.stringify(Ye)),(async()=>{try{console.log("🔄 بدء حفظ المعاملة في Firebase في الخلفية...");const pe={shopId:"default-shop",lineId:R||"default-line",merchantUserId:(t==null?void 0:t.uid)||null,provider:"vodafone_cash",txnType:te==="transfer"?"send":"receive",amount:b,commission:C,profit:0,senderMsisdn:G,receiverMsisdn:te==="transfer"?be:G,note:te==="transfer"?`تحويل من ${G} إلى ${be}`:`سحب ${b} جنيه من ${(n==null?void 0:n.name)||"المحفظة الرئيسية"}`,status:w?"pending":"confirmed",linkedDebtId:J||void 0,createdBy:(t==null?void 0:t.uid)||null,walletEffectAppliedOnCreation:!!(w&&A)},_e={...pe,status:w?"pending":"completed",commissionMode:je?"add":"deduct",totalCharged:je?b+C:b,walletEffectAppliedOnCreation:!!(w&&A)},{ProfitService:qt}=await Yt(async()=>{const{ProfitService:hi}=await import("./profitService-Un0hQgrk.js");return{ProfitService:hi}},__vite__mapDeps([3,4,5])),ut=qt.calculateProfitFromTransaction(_e);ut>0&&(qt.addProfit(ut,t==null?void 0:t.uid),console.log("✅ تم إضافة الربح:",ut,"جنيه")),await Promise.all([...t!=null&&t.uid?[ve.updateUserData(t.uid,{cashBalance:De,walletBalances:Ye,lastUpdated:new Date().toISOString()})]:[],Fa.create(pe),...t!=null&&t.uid?[ve.saveUserTransaction(t.uid,{..._e,transactionType:te,fromWallet:R,toWallet:te==="transfer"?W?null:"cash":null,cashierName:M&&((g==null?void 0:g.name)||(g==null?void 0:g.username))||"الحساب الرئيسي",linkedDebtId:J||void 0,description:`${te==="transfer"?"تحويل":"سحب"} ${b} من ${R} ${te==="transfer"?W?"":"إلى الدرج النقدي":""} — عمولة: ${C} (${je?"مضافة":"مخصومة"})${w?" — دين مؤجل (قيد المراجعة)":""}`})]:[]]),console.log("✅ تم حفظ جميع البيانات في Firebase بنجاح");const Na=`userData_${t==null?void 0:t.uid}`,Ks={cashBalance:De,walletBalances:Ye,lastUpdated:new Date().toISOString()};localStorage.setItem(Na,JSON.stringify(Ks))}catch(pe){console.error("❌ خطأ في حفظ المعاملة في Firebase (في الخلفية):",pe),i({title:"تحذير",description:"تم تنفيذ العملية محلياً، لكن فشلت المزامنة مع الخادم. ستتم المحاولة مرة أخرى تلقائياً.",variant:"destructive"})}})(),te==="transfer"?(ys(!0),setTimeout(()=>{ys(!1)},2e3)):(Ls(!0),setTimeout(()=>{Ls(!1)},2e3)),Te(""),at(""),ps(null),rt(""),pt(""),ts(""),fs(!1)},Dr=et.useMemo(()=>new Intl.DateTimeFormat("ar-EG"),[]),ai=et.useMemo(()=>new Intl.DateTimeFormat("ar-EG",{hour:"2-digit",minute:"2-digit"}),[]),ri=et.useMemo(()=>{try{return ft.reduce((s,r)=>{const a=Number(r.paidAmount||0)+(Array.isArray(r.partialPayments)?r.partialPayments.reduce((o,d)=>o+Number(d.amount||0),0):0),n=Math.max(0,Number(r.amount||0)-a);return s+n},0)}catch{return 0}},[ft]),Dl=et.useMemo(()=>yl().filter(r=>Ct==="all"?!0:Ct==="send"?r.type==="send":Ct==="receive"?r.type==="receive":Ct==="withdraw"?r.type==="withdraw":Ct!=="deleted"),[yl,Ct]),li=()=>{if(Ea==="daily"){const s=At.resetReportsManually("daily",Je,t==null?void 0:t.uid);Bs(!1),i({title:"تم تصفير المعاملات اليومية",description:`تم إخفاء ${s.length} معاملة من تقارير اليوم (الحدود لم تتأثر)`})}else{const s=At.resetReportsManually("monthly",Je,t==null?void 0:t.uid);Bs(!1),i({title:"تم تصفير المعاملات الشهرية",description:`تم إخفاء ${s.length} معاملة من تقارير الشهر (الحدود لم تتأثر)`})}},ni=()=>Ea==="daily"?"تصفير المعاملات اليومية":"تصفير المعاملات الشهرية",ii=()=>Ea==="daily"?"أدخل كلمة مرور تسجيل الدخول لتصفير جميع معاملات اليوم":"أدخل كلمة مرور تسجيل الدخول لتصفير جميع معاملات الشهر",oi=s=>{cl(s),nr(!0)},ci=s=>{Ke(s),localStorage.setItem($e(),s.toString()),sl(!1),i({title:"تم تحديث الرصيد النقدي",description:`تم تحديث الرصيد النقدي إلى ${s} جنيه`})},di=async s=>{var m;if(!xt){console.warn("لا يوجد معرف محفظة محدد لتعديل الرصيد");return}const r={...ge,[xt]:s};Ae(r);const a=new Date().toISOString(),n={walletBalances:r,lastUpdated:a},o=`userData_${t==null?void 0:t.uid}`;try{localStorage.setItem(o,JSON.stringify(n)),localStorage.setItem(Ee(),JSON.stringify(r)),localStorage.setItem(`walletBalances_backup_${a}`,JSON.stringify(r))}catch{}try{t!=null&&t.uid&&await ve.updateUserData(t.uid,n)}catch(y){console.error("خطأ أثناء حفظ رصيد المحفظة في Firebase:",y)}al(!1);const d=((m=me.find(y=>y.id===xt))==null?void 0:m.name)||"المحفظة";i({title:"تم تحديث رصيد المحفظة",description:`تم تحديث رصيد ${d} إلى ${s.toLocaleString()} جنيه`})},mi=async s=>{var r;if(console.log("💰 بدء تحديث رصيد المحفظة"),console.log("📊 معرف المحفظة المحررة:",xt),console.log("💵 المبلغ المضاف/المخصوم:",s),xt){const a=ge[xt]||0;console.log("💰 الرصيد الحالي:",a);const n=a+s;console.log("💰 الرصيد الجديد:",n);const o={...ge,[xt]:n};console.log("📊 الأرصدة المحدثة:",o),Ae(o);const d=new Date().toISOString(),m={walletBalances:o,lastUpdated:d},y=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(y,JSON.stringify(m)),localStorage.setItem(Ee(),JSON.stringify(o)),localStorage.setItem(`walletBalances_backup_${d}`,JSON.stringify(o));try{if(t!=null&&t.uid){console.log("🔄 حفظ البيانات في Firebase...");try{await ve.updateUserData(t.uid,m),console.log("✅ تم حفظ الأرصدة في Firebase بنجاح"),setTimeout(()=>{localStorage.removeItem(y),console.log("🧹 تم حذف النسخة المحلية المؤقتة بعد دقيقة واحدة")},6e4)}catch(W){console.error("❌ فشل في حفظ البيانات في Firebase:",W),de(!0)}}else console.log("⚠️ المستخدم غير مسجل دخول، حفظ في localStorage"),localStorage.setItem(Ee(),JSON.stringify(o));const C=((r=me.find(W=>W.id===xt))==null?void 0:r.name)||"المحفظة",b=s>0?"إضافة":"خصم",N=Math.abs(s);i({title:`تم ${b} مبلغ ${b==="إضافة"?"إلى":"من"} رصيد المحفظة`,description:`تم ${b} ${N} جنيه ${b==="إضافة"?"إلى":"من"} رصيد ${C}. الرصيد الجديد: ${n.toLocaleString()} جنيه`})}catch(C){if(console.error("❌ فشل في حفظ البيانات في Firebase:",C),localStorage.setItem(Ee(),JSON.stringify(o)),t!=null&&t.uid){const b=`userData_${t.uid}`,N={walletBalances:o,lastUpdated:new Date().toISOString()};localStorage.setItem(b,JSON.stringify(N)),de(!0)}i({title:"تم حفظ البيانات محلياً",description:"تم حفظ التغييرات محلياً وسيتم مزامنتها مع الخادم لاحقاً",variant:"default"})}}else console.log("❌ لا يوجد معرف محفظة للتحرير");setTimeout(()=>{const n=Object.keys(localStorage).filter(o=>o.startsWith("walletBalances_backup_")).sort();n.length>5&&n.slice(0,n.length-5).forEach(d=>{localStorage.removeItem(d),console.log("🗑️ حذف النسخة الاحتياطية القديمة:",d)})},5e3),nr(!1),cl("")};return console.log("🔥 UserDashboardPage - Render conditions:",{isCheckingActivation:S,isUserActive:K,showActivationModal:f}),!S&&!K?(console.log("🔥 UserDashboardPage - Showing activation modal"),e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center",children:e.jsx(Bl,{isOpen:!0,onClose:()=>{}})})):S?(console.log("🔥 UserDashboardPage - Showing loading screen"),e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center",children:e.jsx("div",{className:"text-center",children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"w-3 h-3 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 animate-bounce",style:{animationDelay:"0ms"}}),e.jsx("span",{className:"w-3 h-3 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 animate-bounce",style:{animationDelay:"150ms"}}),e.jsx("span",{className:"w-3 h-3 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 animate-bounce",style:{animationDelay:"300ms"}})]})})})):(console.log("🔥 UserDashboardPage - Rendering main dashboard"),e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-gray-50 via-blue-50/30 to-indigo-50/20 px-2 sm:px-4 py-2 sm:py-4 relative overflow-hidden",children:[e.jsxs("div",{className:"absolute inset-0 overflow-hidden pointer-events-none",children:[e.jsx("div",{className:"absolute top-10 sm:top-20 left-2 sm:left-10 w-32 sm:w-72 h-32 sm:h-72 bg-blue-400/8 rounded-full blur-3xl"}),e.jsx("div",{className:"absolute bottom-10 sm:bottom-20 right-2 sm:right-10 w-40 sm:w-96 h-40 sm:h-96 bg-purple-400/8 rounded-full blur-3xl",style:{animationDelay:"2s"}}),e.jsx("div",{className:"absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-36 sm:w-80 h-36 sm:h-80 bg-indigo-400/5 rounded-full blur-3xl",style:{animationDelay:"4s"}})]}),e.jsxs("div",{className:"max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-3 sm:gap-6 relative z-10",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-2 sm:space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 sm:grid-cols-2 sm:gap-3 fade-in-up",children:[!Es&&e.jsxs(Re,{className:"bg-gradient-to-br from-purple-50 via-purple-25 to-white border border-purple-200/60 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 group relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-purple-500/5 to-purple-600/3 opacity-0 group-hover:opacity-100 transition-opacity duration-300"}),e.jsx("div",{className:"absolute top-0 right-0 w-20 sm:w-32 h-20 sm:h-32 bg-gradient-to-br from-purple-300/15 to-transparent rounded-full -translate-y-8 sm:-translate-y-16 translate-x-8 sm:translate-x-16 group-hover:scale-110 transition-transform duration-300"}),e.jsx(ct,{className:"pb-2 sm:pb-1 lg:pb-1 px-3 sm:px-3 lg:px-2 pt-3 sm:pt-2 lg:pt-1 relative z-10",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(jt,{className:"text-xs font-bold text-purple-800 flex items-center gap-1.5 sm:gap-1",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"w-2.5 sm:w-2 h-2.5 sm:h-2 bg-gradient-to-r from-purple-500 to-purple-600 rounded-full shadow-sm"}),e.jsx("div",{className:"absolute inset-0 w-2.5 sm:w-2 h-2.5 sm:h-2 bg-purple-400 rounded-full opacity-60 animate-pulse"})]}),e.jsx("span",{className:"text-xs",children:"الشهر"})]}),e.jsxs("div",{className:"flex items-center gap-1 sm:gap-1",children:[e.jsx("div",{className:"hidden"}),e.jsx(c,{size:"sm",variant:"ghost",onClick:()=>{Br("monthly"),Bs(!0)},className:"h-7 w-7 sm:h-6 sm:w-6 p-0 bg-gradient-to-r from-purple-100 to-purple-200 text-purple-700 hover:from-purple-200 hover:to-purple-300 hover:text-purple-800 rounded-lg sm:rounded-md transition-all duration-300 hover:scale-105 shadow-sm hover:shadow-md",title:"تصفير معاملات الشهر",children:e.jsx(wt,{className:"h-3 w-3 sm:h-2.5 sm:w-2.5"})}),e.jsx("div",{className:"p-1.5 sm:p-1 bg-gradient-to-r from-purple-100 to-purple-200 rounded-lg sm:rounded-md",children:e.jsx(qs,{className:"h-3 w-3 sm:h-2.5 sm:w-2.5 text-purple-600"})})]})]})}),!Es&&e.jsxs(Ve,{className:"space-y-0.5 sm:space-y-1 lg:space-y-0 pt-0 px-2 sm:px-3 lg:px-2 pb-1.5 sm:pb-2 lg:pb-1 relative z-10",children:[e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-purple-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-purple-700",children:"عدد المعاملات:"}),e.jsx("span",{className:"font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:Js().totalTransactions})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-purple-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-purple-700",children:"إجمالي المبالغ:"}),e.jsx("span",{className:"font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:Js().totalAmount.toFixed(2)})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-purple-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-purple-700",children:"المسحوب:"}),e.jsx("span",{className:"font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:Js().totalWithdrawn.toFixed(2)})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-purple-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-purple-700",children:"المرسل:"}),e.jsx("span",{className:"font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:Js().totalSent.toFixed(2)})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-purple-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-purple-700",children:"الأرباح:"}),e.jsx(io,{userId:t==null?void 0:t.uid,transactions:Je})]})]}),xn&&e.jsx("div",{className:"absolute inset-0 z-20 bg-yellow-100/60 backdrop-blur-sm rounded-xl border border-yellow-300/70 flex items-center justify-center p-0 pointer-events-auto",children:e.jsxs(c,{size:"sm",variant:"ghost",onClick:async()=>{if(nt){i({title:"غير متاح",description:"تقارير الشهر غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"});return}la(!0)},className:"px-2.5 py-1 rounded-full bg-gradient-to-r from-yellow-300 to-yellow-400 text-black hover:from-yellow-400 hover:to-yellow-500 shadow-md flex items-center gap-1 text-[11px] font-semibold",title:"عرض تقارير الشهر (يتطلب الرقم السري)",children:[e.jsx("span",{children:"عرض تقارير الشهر"}),e.jsx(Ge,{className:"h-2.5 w-2.5"})]})})]}),e.jsx(Zs,{open:gn,onOpenChange:la,mode:"verify",title:"الرقم السري لفتح تقارير الشهر",description:"لا يمكن الاطلاع على إحصائيات الشهر إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{if(nt){i({title:"غير متاح",description:"تقارير الشهر غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}),la(!1),Jr(!0);return}Jr(!1),la(!1)},userId:t==null?void 0:t.uid}),e.jsxs(Re,{className:"bg-gradient-to-br from-blue-50 via-blue-25 to-white border border-blue-200/60 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 group relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/5 to-blue-600/3 opacity-0 group-hover:opacity-100 transition-opacity duration-300"}),e.jsx("div",{className:"absolute top-0 right-0 w-20 sm:w-32 h-20 sm:h-32 bg-gradient-to-br from-blue-300/15 to-transparent rounded-full -translate-y-8 sm:-translate-y-16 translate-x-8 sm:translate-x-16 group-hover:scale-110 transition-transform duration-300"}),e.jsx(ct,{className:"pb-2 sm:pb-3 lg:pb-1 px-3 sm:px-4 lg:px-2 pt-3 sm:pt-4 lg:pt-1 relative z-10",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(jt,{className:"text-sm sm:text-base font-bold text-blue-800 flex items-center gap-1.5 sm:gap-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"w-2.5 sm:w-3 h-2.5 sm:h-3 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full shadow-sm"}),e.jsx("div",{className:"absolute inset-0 w-2.5 sm:w-3 h-2.5 sm:h-3 bg-blue-400 rounded-full opacity-60 animate-pulse"})]}),e.jsx("span",{className:"text-xs sm:text-sm",children:"اليوم"})]}),e.jsxs("div",{className:"flex items-center gap-1 sm:gap-1.5",children:[e.jsx(c,{size:"sm",variant:"ghost",onClick:()=>{Br("daily"),Bs(!0)},className:"h-7 w-7 sm:h-8 sm:w-8 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded-lg transition-all duration-300 hover:scale-105 shadow-sm hover:shadow-md",title:"تصفير معاملات اليوم",children:e.jsx(wt,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"})}),e.jsx(c,{size:"sm",variant:"ghost",onClick:()=>Ma(!0),className:"h-7 w-7 sm:h-8 sm:w-8 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded-lg transition-all duration-300 hover:scale-105 shadow-sm hover:shadow-md",title:"أرشيف التقارير اليومية",children:e.jsx(zi,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"})}),e.jsx(c,{size:"sm",variant:"ghost",onClick:()=>un(s=>!s),className:"h-7 w-7 sm:h-8 sm:w-8 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded-lg transition-all duration-300 hover:scale-105 shadow-sm hover:shadow-md",title:Es?"توسيع اليوم والشهر":"طي اليوم والشهر",children:Es?e.jsx(zl,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"}):e.jsx(Jl,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"})}),e.jsx("div",{className:"p-1.5 sm:p-2 bg-gradient-to-r from-blue-100 to-blue-200 rounded-lg",children:e.jsx(qs,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5 text-blue-600"})})]})]})}),!Es&&e.jsxs(Ve,{className:"space-y-0 pt-0 px-2 pb-1 relative z-10",children:[e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-blue-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-blue-700",children:"عدد المعاملات:"}),e.jsx("span",{className:"font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:ba().totalTransactions})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-blue-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-blue-700",children:"إجمالي المبالغ:"}),e.jsx("span",{className:"font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:ba().totalAmount.toFixed(2)})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-blue-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-blue-700",children:"المسحوب:"}),e.jsx("span",{className:"font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:ba().totalWithdrawn.toFixed(2)})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-blue-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-blue-700",children:"المرسل:"}),e.jsx("span",{className:"font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:ba().totalSent.toFixed(2)})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-blue-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-blue-700",children:"الأرباح:"}),e.jsx(mo,{userId:t==null?void 0:t.uid})]})]})]})]}),e.jsxs(Re,{className:"bg-white border-2 border-gray-200/50 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 group relative overflow-hidden   transform fade-in-up mb-6",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-emerald-500/5 via-blue-500/5 to-emerald-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-200"}),e.jsx("div",{className:"absolute top-0 left-0 w-40 h-40 bg-gradient-to-br from-emerald-300/10 to-transparent rounded-full -translate-y-20 -translate-x-20 group-hover:scale-150 transition-transform duration-200"}),e.jsx("div",{className:"absolute bottom-0 right-0 w-40 h-40 bg-gradient-to-br from-blue-300/10 to-transparent rounded-full translate-y-20 translate-x-20 group-hover:scale-150 transition-transform duration-200"}),e.jsx(Ve,{className:"p-3 relative z-10",children:e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"bg-emerald-50 border-2 border-emerald-200/50 p-1 rounded-xl shadow-lg hover:shadow-md transition-all duration-200 group/cash relative overflow-hidden ",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-emerald-500/10 to-transparent opacity-0 group-hover/cash:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex items-center justify-between relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-emerald-100 to-emerald-200 rounded-lg shadow-sm",children:e.jsx(He,{className:"h-1.5 w-1.5 text-emerald-600"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] font-bold text-emerald-800",children:"الفلوس النقدية"}),e.jsxs("span",{className:"text-[10px] font-extrabold text-emerald-700 bg-gradient-to-r from-emerald-100 to-emerald-200 px-1 py-0.5 rounded-lg shadow-sm",children:[Fe.toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(c,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-green-100 to-green-200 text-green-700 hover:from-green-200 hover:to-green-300 hover:text-green-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>ga(!0),children:e.jsx(ot,{className:"h-2 w-2"})}),e.jsx(c,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800 rounded-xl transition-all duration-300  hover:rotate-12 shadow-md hover:shadow-lg",onClick:()=>ja(!0),children:e.jsx(wt,{className:"h-2 w-2"})})]})]})]}),e.jsxs("div",{className:"bg-blue-50 border-2 border-blue-200/50 p-1 rounded-xl shadow-lg hover:shadow-md transition-all duration-200 group/wallet relative overflow-hidden ",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/10 to-transparent opacity-0 group-hover/wallet:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex items-center justify-between relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-blue-100 to-blue-200 rounded-lg shadow-sm",children:e.jsx(Wt,{className:"h-1.5 w-1.5 text-blue-600"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] font-bold text-blue-800",children:"الأرصدة علي المحافظ"}),e.jsxs("span",{className:"text-[10px] font-extrabold text-blue-700 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-lg shadow-sm",children:[Object.values(ge).reduce((s,r)=>s+r,0).toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(c,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-green-100 to-green-200 text-green-700 hover:from-green-200 hover:to-green-300 hover:text-green-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>fa(!0),title:"إضافة أموال لإجمالي المحفظة",children:e.jsx(ot,{className:"h-2 w-2"})}),e.jsx(c,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800 rounded-xl transition-all duration-300  hover:rotate-12 shadow-md hover:shadow-lg",onClick:()=>{va(!0),ya("")},title:"تصفير إجمالي المحفظة",children:e.jsx(wt,{className:"h-2 w-2"})})]})]})]}),e.jsxs("div",{className:"col-span-2 sm:col-span-1 bg-indigo-50 border-2 border-indigo-200/50 p-1 rounded-xl shadow-lg hover:shadow-md transition-all duration-200 group/selwallet relative overflow-hidden ",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-indigo-500/10 to-transparent opacity-0 group-hover/selwallet:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex items-center justify-between relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-indigo-100 to-indigo-200 rounded-lg shadow-sm",children:e.jsx(Wt,{className:"h-1.5 w-1.5 text-indigo-600"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] font-bold text-indigo-800",children:"رصيد المحفظه"}),e.jsxs("span",{className:"text-[10px] font-extrabold text-indigo-700 bg-gradient-to-r from-indigo-100 to-indigo-200 px-1 py-0.5 rounded-lg shadow-sm",children:[(R&&ge[R]||0).toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(c,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-green-100 to-green-200 text-green-700 hover:from-green-200 hover:to-green-300 hover:text-green-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>{if(!R){i({title:"اختر محفظة",description:"يرجى اختيار محفظة من اختيار المحافظ بالأعلى أولاً",variant:"destructive"});return}oi(R)},title:"إضافة/خصم إلى رصيد المحفظة المختارة",children:e.jsx(ot,{className:"h-2 w-2"})}),e.jsx(c,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800 rounded-xl transition-all duration-300  hover:rotate-12 shadow-md hover:shadow-lg",onClick:()=>{if(!R){i({title:"اختر محفظة",description:"يرجى اختيار محفظة لتصفير رصيدها فقط",variant:"destructive"});return}ma(!0)},title:"تصفير رصيد المحفظة المختارة",children:e.jsx(wt,{className:"h-2 w-2"})})]})]})]})]})})]}),e.jsxs(Re,{className:"bg-gradient-to-br from-gray-50 via-white to-slate-50 border border-gray-200/60 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 group relative overflow-hidden fade-in-up",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-gray-500/5 to-slate-600/3 opacity-0 group-hover:opacity-100 transition-opacity duration-300"}),e.jsxs(ct,{className:"pb-2 px-4 pt-4 relative z-10",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(jt,{className:"text-sm font-bold flex items-center gap-2 text-gray-800",children:[!p&&e.jsx("div",{className:"p-1.5 sm:p-2 bg-gradient-to-r from-gray-100 to-slate-200 rounded-lg",children:e.jsx(qs,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5 text-gray-600"})}),e.jsx("span",{className:"bg-gradient-to-r from-gray-600 to-slate-600 bg-clip-text text-transparent",children:"المعاملات الأخيرة"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[!p&&e.jsxs("div",{className:"flex items-center gap-0.5 bg-gray-50 rounded px-1 py-0.5 border border-gray-200 hover:border-blue-300 transition-all duration-200 group relative overflow-hidden max-w-[140px] md:max-w-[220px]",children:[e.jsx(Ti,{className:"h-2 w-2 text-gray-400 group-hover:text-blue-600 transition-colors"}),e.jsx(U,{placeholder:"بحث...",value:Mr,onChange:s=>nn(s.target.value),className:"h-3 text-[8px] border-0 bg-transparent focus:ring-0 focus:outline-none text-gray-700 placeholder:text-gray-400"})]}),!p&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"حاسبة"}),e.jsx(c,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105",onClick:()=>zr(!0),title:"آلة حاسبة",children:e.jsx(Yl,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"كروت"}),e.jsx(c,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105",onClick:()=>{nt?i({title:"غير متاح",description:"كروت الائتمان غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):_a(!0)},title:"كروت الائتمان",children:e.jsx(Oa,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-blue-600 mb-1",children:"الوردية"}),e.jsx(c,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-blue-50 text-blue-600 hover:bg-blue-100 border border-blue-200 ring-3 ring-blue-300 transition-all duration-200 hover:scale-105",onClick:$n,title:M&&(g!=null&&g.name||g!=null&&g.username)?`بروفيل الوردية: ${(g==null?void 0:g.name)||(g==null?void 0:g.username)}`:"وردية الكاشير",children:e.jsx(kr,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"المبيعات"}),e.jsx(c,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105",onClick:()=>{nt?i({title:"غير متاح",description:"بيانات المبيعات غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):$a(!0)},title:"بيانات المبيعات",children:e.jsx(Wi,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsxs("div",{className:"flex items-center gap-1 mb-1",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600",children:"الديون"}),ft.filter(s=>s.status==="pending").length>0&&e.jsx("span",{className:"h-4 w-4 rounded-full bg-red-600 text-white text-[10px] flex items-center justify-center ring-2 ring-white",children:ft.filter(s=>s.status==="pending").length})]}),e.jsx(c,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105",onClick:()=>{nt?i({title:"غير متاح",description:"إدارة الديون/الأجل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):ia(!0)},title:"الديون",children:e.jsx(wi,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-amber-700 mb-1",children:"الصيانة"}),e.jsx(c,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-amber-50 text-amber-700 hover:bg-amber-100 border border-amber-200 ring-3 ring-amber-300 transition-all duration-200 hover:scale-105",onClick:()=>{nt?i({title:"غير متاح",description:"الصيانة غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ra(!0)},title:"الصيانة",children:e.jsx(Si,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-yellow-500 mb-1",children:"المكنة"}),e.jsx(c,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-violet-50 text-violet-700 hover:bg-violet-100 border border-violet-200 ring-3 ring-violet-300 transition-all duration-200 hover:scale-105",onClick:()=>{is?za(!0):i({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"})},title:"يومية المكنة",children:e.jsx(Ql,{className:"h-5 w-5 text-yellow-500"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-orange-600 mb-1",children:"مصروفات"}),e.jsx(c,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-orange-50 text-orange-600 hover:bg-orange-100 border border-orange-200 ring-3 ring-orange-300 transition-all duration-200 hover:scale-105",onClick:()=>{nt?i({title:"غير متاح",description:"مصروفات المحل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Zt.hasMasterPin()?z(!0):B(!0)},title:"مصروفات المحل",children:e.jsx(Ar,{className:"h-5 w-5"})})]})]})]}),e.jsx(c,{variant:"ghost",size:"sm",onClick:()=>I("/user/transactions"),className:"h-7 w-7 sm:h-8 sm:w-8 p-0 bg-gradient-to-r from-gray-100 to-slate-200 text-gray-700 hover:from-gray-200 hover:to-slate-300 hover:text-gray-800 rounded-lg transition-all duration-300 hover:scale-105 shadow-sm hover:shadow-md",title:"عرض جميع المعاملات",children:e.jsx(Or,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"})})]}),!p&&e.jsx("div",{className:"mt-2 w-full",children:e.jsxs("div",{className:"flex items-center justify-center gap-3 bg-gray-50 rounded-md p-3 border border-gray-200",children:[e.jsx(c,{variant:"ghost",size:"sm",className:`h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${Ct==="send"?"bg-green-600 text-white border-green-600":"text-green-700 border-green-300 hover:bg-green-50"}`,onClick:()=>vs("send"),title:"تصفية التحويل",children:"التحويل"}),e.jsx(c,{variant:"ghost",size:"sm",className:`h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${Ct==="withdraw"?"bg-red-600 text-white border-red-600":"text-red-700 border-red-300 hover:bg-red-50"}`,onClick:()=>vs("withdraw"),title:"تصفية السحب",children:"السحب"}),e.jsx(c,{variant:"ghost",size:"sm",className:`h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${Ct==="all"?"bg-green-600 text-white border-green-600":"text-green-700 border-green-300 hover:bg-green-50"}`,onClick:()=>vs("all"),title:"عرض الكل",children:"الكل"}),e.jsxs("div",{className:"relative ml-1",children:[e.jsxs(c,{variant:"ghost",size:"sm",className:"h-8 px-3 text-[12px] rounded-full border bg-red-50 text-red-700 border-red-300 hover:bg-red-100",onClick:()=>or(!0),title:"تصفير المعاملات الأخيرة",children:[e.jsx(wt,{className:"h-3.5 w-3.5 mr-1"}),"تصفير"]}),(t==null?void 0:t.uid)&&localStorage.getItem(`recentTransactionsResetAt:${t.uid}`)&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 h-2 w-2 rounded-full bg-red-500 ring-2 ring-white"})]})]})})]}),e.jsx(Ve,{className:"space-y-2 pt-0 px-4 pb-4 relative z-10",children:Dl.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(qs,{className:"h-12 w-12 mx-auto mb-2 text-gray-300"}),e.jsx("p",{className:"text-sm",children:"لا توجد معاملات حتى الآن"})]}):e.jsx("div",{className:"max-h-[210px] overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400 transition-colors",children:e.jsx("div",{className:"space-y-2 pr-2",children:Dl.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gradient-to-r from-white/70 to-gray-50/70 rounded-lg hover:from-white/90 hover:to-gray-50/90 transition-all duration-300 border border-gray-100/60 cursor-pointer hover:shadow-sm",onClick:()=>ei(s),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[s.status==="completed"&&e.jsx(Pa,{className:"h-4 w-4 text-green-500"}),s.status==="pending"&&e.jsx(ms,{className:"h-4 w-4 text-yellow-500"}),s.status==="failed"&&e.jsx(Fr,{className:"h-4 w-4 text-red-500"})]}),e.jsxs("div",{children:[(()=>{const r=(s==null?void 0:s.type)==="report"||((s==null?void 0:s.title)||"").includes("إيصال تسليم وردية");return e.jsx("p",{className:"font-medium text-sm text-gray-800",children:r?"إيصال تسليم وردية":(s.type==="send"?"تحويل":"سحب")+` - ${s.amount.toLocaleString()} جنيه`})})(),e.jsxs("p",{className:"text-[10px] text-gray-700",children:["تمت بواسطة: ",(s==null?void 0:s.cashierName)??"الحساب الرئيسي"]}),(()=>{const r=(s==null?void 0:s.type)==="report"||((s==null?void 0:s.title)||"").includes("إيصال تسليم وردية");return e.jsx("p",{className:"text-xs text-gray-500",children:r?`تم التسليم إلى: ${s.receiverPhone}`:`من ${s.senderPhone}${s.type==="send"?` إلى ${s.receiverPhone}`:""}`})})(),e.jsxs("p",{className:"text-xs text-gray-400",children:[Dr.format(s.createdAt instanceof Date?s.createdAt:new Date(s.createdAt))," - ",ai.format(s.createdAt instanceof Date?s.createdAt:new Date(s.createdAt))]})]})]}),e.jsx(yt,{variant:s.status==="completed"?"default":s.status==="pending"?"secondary":"destructive",className:"text-xs",children:s.status==="completed"?"مكتمل":s.status==="pending"?"قيد المعالجة":"فشل"})]},s.id))})})})]})]}),e.jsx(Oi,{isOpen:Et,onClose:()=>sa(!1),transaction:Xl,onPrint:()=>window.print(),onDelete:rn,onComplete:ln}),e.jsxs("div",{className:"space-y-1 fade-in-right w-full lg:w-5/6 mx-auto",children:[e.jsxs(Re,{id:"transaction-section",className:"bg-gradient-to-br from-white via-blue-50/30 to-indigo-50/50 border border-blue-200/40 rounded-lg shadow-lg hover:shadow-lg transition-all duration-200 group relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/5 via-indigo-500/3 to-purple-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-200"}),e.jsx("div",{className:"absolute top-0 right-0 w-32 h-32 sm:w-28 sm:h-28 lg:w-20 lg:h-20 bg-gradient-to-bl from-blue-400/10 to-transparent rounded-full  "}),e.jsx("div",{className:"absolute bottom-0 left-0 w-24 h-24 bg-gradient-to-tr from-indigo-400/10 to-transparent rounded-full  ",style:{animationDelay:"1s"}}),e.jsx(ct,{className:"pb-0.5 px-3 pt-1 lg:pt-0.5 lg:pb-0.5 lg:px-2 relative z-10",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(jt,{className:"text-sm font-bold flex items-center gap-2 text-gray-800",children:[e.jsxs("div",{className:"relative",children:[e.jsx(Pa,{className:"h-1 w-1 text-emerald-500 "}),e.jsx("div",{className:"absolute inset-0 h-1 w-1 bg-emerald-400 rounded-full opacity-20 "})]}),e.jsx("span",{className:"bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent",children:"إجراء معاملة جديدة"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[ee&&e.jsx("div",{className:"hidden md:flex items-center gap-1 bg-gradient-to-r from-emerald-50 to-green-50 hover:from-emerald-100 hover:to-green-100 border border-emerald-200 text-emerald-800 text-sm transition-all duration-300 hover:scale-105 h-9 px-3 rounded-xl shadow-sm",children:e.jsxs("span",{className:"text-sm font-semibold whitespace-nowrap",children:["تجربة: ",Ie," ",Ie>=3&&Ie<=10?"ساعات":Ie===2?"ساعتين":"ساعة"]})}),e.jsx("div",{className:"hidden md:flex items-center gap-2 bg-gradient-to-r from-gray-50 to-slate-50 hover:from-gray-100 hover:to-slate-100 border border-gray-200 transition-all duration-300 hover:scale-105 h-9 px-3 rounded-xl shadow-sm",children:e.jsx(Mi,{})})]}),Qn&&e.jsxs(c,{variant:"outline",size:"sm",className:"hidden flex items-center gap-1.5 sm:gap-2 bg-gradient-to-r from-cyan-50 to-blue-50 hover:from-cyan-100 hover:to-blue-100 border-cyan-200 text-cyan-800 text-xs sm:text-sm transition-all duration-300 hover:scale-105 hover:shadow-lg h-10 sm:h-12 px-4 sm:px-5 rounded-xl min-w-[44px] touch-manipulation",onClick:pl,title:"مزامنة البيانات المحفوظة محلياً مع الخادم",children:[e.jsx($i,{className:"h-3.5 w-3.5 sm:h-4 sm:w-4 animate-spin"}),e.jsx("span",{className:"text-xs sm:text-sm font-semibold whitespace-nowrap",children:"مزامنة"})]})]})}),e.jsxs(Ve,{className:"space-y-1 px-2 pb-2 relative z-10",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-0.5 p-0.5 bg-gradient-to-r from-gray-50 to-slate-50 rounded-xl border border-gray-200/50 fade-in-up w-full lg:w-5/6 mx-auto ",children:[e.jsxs(c,{variant:te==="transfer"?"default":"ghost",onClick:()=>Nl("transfer"),className:`text-xs font-semibold transition-all duration-300 hover:scale-105 h-7 rounded-lg px-2 ${te==="transfer"?"bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg hover:shadow-md hover:from-blue-600 hover:to-indigo-700":"text-gray-600 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 hover:text-blue-700 hover:border-blue-200"}`,children:[e.jsx(qs,{className:"h-1 w-1 mr-1"}),"تحويل"]}),e.jsxs(c,{variant:te==="withdraw"?"default":"ghost",onClick:()=>Nl("withdraw"),className:`text-xs font-semibold transition-all duration-300 hover:scale-105 h-7 rounded-lg px-2 ${te==="withdraw"?"bg-gradient-to-r from-emerald-500 to-green-600 text-white shadow-lg hover:shadow-md hover:from-emerald-600 hover:to-green-700":"text-gray-600 hover:bg-gradient-to-r hover:from-emerald-50 hover:to-green-50 hover:text-emerald-700 hover:border-emerald-200"}`,children:[e.jsx(Aa,{className:"h-1 w-1 mr-1"}),"سحب"]})]}),me.length>0&&e.jsxs("div",{className:"fade-in-up",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("label",{className:"text-sm font-semibold text-gray-700 block flex items-center gap-2",children:[e.jsx(Wt,{className:"h-1 w-1 text-blue-600"}),"اختيار المحفظة"]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsxs(c,{variant:"ghost",size:"sm",className:"h-6 rounded-md px-2 text-[10px] bg-emerald-50 text-emerald-700 hover:bg-emerald-100 border border-emerald-200",onClick:()=>I("/user/add-wallet"),title:"إضافة محفظة",children:[e.jsx(ot,{className:"h-3 w-3 mr-1"}),"إضافة محفظة"]}),e.jsxs(c,{variant:"ghost",size:"sm",className:"h-6 rounded-md px-2 text-[10px] bg-indigo-50 text-indigo-700 hover:bg-indigo-100 border border-indigo-200",onClick:()=>ss(!0),title:"المحافظ",children:[e.jsx(Wt,{className:"h-3 w-3 mr-1"}),"المحافظ"]})]})]}),e.jsxs(Ns,{value:R,onValueChange:Xn,children:[e.jsx(ws,{"data-testid":"wallet-select",className:"w-full h-12 text-sm bg-gradient-to-r from-white to-gray-50 border-2 border-gray-200 hover:border-blue-400 focus:border-blue-500 rounded-xl transition-all duration-300 hover:shadow-md focus:shadow-lg",children:e.jsx(Ss,{placeholder:"اختر محفظة للمعاملة",className:"text-gray-600"})}),e.jsx(Ds,{className:"rounded-xl border-2 border-gray-200 shadow-md max-h-[220px] overflow-y-auto z-50 ",children:e.jsx("div",{className:"max-h-[180px] overflow-y-auto pr-1",children:me.map(s=>e.jsx(Cs,{value:s.id,className:"rounded-lg hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 transition-all duration-200",children:e.jsxs("div",{className:"flex items-center gap-1 py-1 w-full justify-between",children:[e.jsx("div",{className:"p-1 bg-gradient-to-r from-blue-100 to-indigo-100 rounded-lg",children:e.jsx(Wt,{className:"h-1 w-1 text-blue-600"})}),e.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-sm font-medium text-gray-800",children:s.name}),e.jsxs("span",{className:"text-[10px] text-gray-500",children:["(",s.phone,")"]})]}),s.isDefault&&e.jsx(yt,{variant:"secondary",className:"text-[10px] bg-gradient-to-r from-emerald-100 to-green-100 text-emerald-700 border-emerald-200",children:"افتراضي"})]}),e.jsx("div",{className:"ml-auto flex flex-col items-end gap-1"})]})},s.id))})})]})]}),e.jsx(re,{open:Os,onOpenChange:ss,children:e.jsxs(le,{className:"sm:max-w-3xl w-[95vw] sm:w-auto max-h-[80vh] overflow-y-auto",children:[e.jsx(ne,{children:e.jsx(ie,{children:"عرض المحافظ"})}),e.jsx("div",{className:"mt-2",children:e.jsx(Ei,{showAddButton:!1,showUsageBars:!1,showLimitCards:!1,showEditButton:!0})})]})}),R&&me.length>0&&(()=>{const s=me.find(Ye=>Ye.id===R),r=wl(R),a=si(R),n=(Pe==null?void 0:Pe.monthlyWithdrawLimit)??(s==null?void 0:s.monthlyWithdrawalLimit)??2e5,o=(Pe==null?void 0:Pe.monthlyTransferLimit)??(s==null?void 0:s.monthlyTransferLimit)??2e5,d=r.totalWithdrawn??(Pe==null?void 0:Pe.monthlyWithdrawUsed)??0,m=r.totalTransferred??(Pe==null?void 0:Pe.monthlyTransferUsed)??0,y=(Pe==null?void 0:Pe.dailyWithdrawLimit)??1e5,C=(Pe==null?void 0:Pe.dailyTransferLimit)??6e4,b=a.totalWithdrawn??(Pe==null?void 0:Pe.dailyWithdrawUsed)??0,N=a.totalTransferred??(Pe==null?void 0:Pe.dailyTransferUsed)??0,W=parseFloat(we||"0")||0,A=d+(te==="withdraw"?W:0),w=m+(te==="transfer"?W:0),J=b+(te==="withdraw"?W:0),De=N+(te==="transfer"?W:0);return s?e.jsxs("div",{className:"fade-in-up mb-2 space-y-2",children:[e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-1 rounded-md border border-gray-200 shadow-sm hover:shadow-md transition-all duration-300",children:[e.jsxs("div",{className:"text-[10px] text-gray-600 font-medium mb-1 text-center",children:["الحدود الشهرية: ",s.name]}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-red-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-red-400 to-red-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(A/Math.max(n,1)*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-blue-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-400 to-blue-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(w/Math.max(o,1)*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-[10px] text-red-600 font-medium",children:["متبقي سحب: ",Math.max(n-A,0).toLocaleString("en-US")," جنيه"]}),e.jsxs("div",{className:"text-[10px] text-blue-600 font-medium",children:["متبقي تحويل: ",Math.max(o-w,0).toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-1 rounded-md border border-gray-200 shadow-sm hover:shadow-md transition-all duration-300",children:[e.jsxs("div",{className:"text-[10px] text-gray-600 font-medium mb-1 text-center",children:["الحدود اليومية: ",s.name]}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-orange-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-orange-400 to-orange-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(J/Math.max(y,1)*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-green-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-green-400 to-green-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(De/Math.max(C,1)*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-[10px] text-orange-600 font-medium",children:["متبقي سحب يومي: ",Math.max(y-J,0).toLocaleString("en-US")," جنيه"]}),e.jsxs("div",{className:"text-[10px] text-green-600 font-medium",children:["متبقي تحويل يومي: ",Math.max(C-De,0).toLocaleString("en-US")," جنيه"]})]})]})]}):null})(),te==="transfer"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المرسل"}),e.jsxs("div",{className:"relative",children:[e.jsx(zt,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(U,{value:G,onChange:s=>oe(s.target.value),onKeyDown:s=>{if(s.key==="Enter"){const r=document.getElementById("receiverPhoneInput");if(r)r.focus();else{const a=document.getElementById("amountInput");a==null||a.focus()}}},placeholder:"01030302038",className:"pl-10 h-10 text-sm transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]})]}),!j&&e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المستقبل"}),e.jsxs("div",{className:"relative",children:[e.jsx(zt,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(U,{id:"receiverPhoneInput",value:be,onChange:s=>{Te(s.target.value),Ua&&ys(!1)},onKeyDown:s=>{if(s.key==="Enter"){const r=document.getElementById("amountInput");r==null||r.focus()}},placeholder:"أدخل رقم المستقبل",className:"pl-10 h-10 text-sm transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المستقبل"}),e.jsxs("div",{className:"relative",children:[e.jsx(zt,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(U,{value:R&&((Cl=me.find(s=>s.id===R))==null?void 0:Cl.phone)||"",readOnly:!0,placeholder:"اختر محفظة أولاً",className:"pl-10 h-10 text-sm bg-gray-50 transition-all duration-300"})]})]}),te==="transfer"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"المبلغ (جنيه)"}),e.jsxs("div",{className:"relative flex items-center gap-2",children:[e.jsx(He,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(U,{id:"amountInput",value:we,onChange:s=>{at(s.target.value),Ua&&ys(!1)},onKeyDown:s=>{if(s.key==="Enter"){const r=document.getElementById("transferCommissionInput");if(r)r.focus();else{const a=document.getElementById("quickDebtButton");a==null||a.focus()}}},placeholder:"أدخل المبلغ",type:"number",className:"pl-10 h-10 text-sm transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),qe?e.jsxs("div",{className:"mt-2 text-xs text-green-700 bg-green-50 border border-green-200 rounded px-2 py-1 flex items-center gap-2",children:[e.jsxs("span",{children:["تم إدخال تفاصيل الأجل لـ ",qe.debtorName," بمبلغ ",qe.amount," جنيه"]}),e.jsx(c,{type:"button",variant:"ghost",size:"sm",className:"h-6 px-2",onClick:()=>ps(null),children:"إلغاء"})]}):null]}),(()=>{if(j)return null;const s=Ue();return s&&s.defaultTransferCommission!=null?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة التحويل (تلقائية)"}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["سيتم تطبيق عمولة التحويل الافتراضية لكل ألف: ",s==null?void 0:s.defaultTransferCommission," جنيه لكل ألف"]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(c,{id:"quickDebtButton",type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const a=Ue(),n=(a==null?void 0:a.defaultTransferCommission)!=null?Number(a.defaultTransferCommission):0,o=parseFloat(we||"0")||0,d=Math.round((n||0)*o/1e3*100)/100,m=je?o+d:o;pt((m||0).toString()),nt?i({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):fe(!0)},children:"أجل"}),e.jsx(c,{type:"button",variant:"outline",size:"icon",title:je?"العمولة تُضاف":"العمولة تُخصم",onClick:()=>Lt(a=>!a),children:je?e.jsx(ot,{className:"h-4 w-4 text-green-600"}):e.jsx(os,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"text-xs text-gray-600",children:je?"العمولة تُضاف":"العمولة تُخصم"})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة التحويل على العملية (جنيه)"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(He,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-orange-500"}),e.jsx(U,{id:"transferCommissionInput",value:lt,onChange:a=>as(a.target.value),placeholder:"أدخل عمولة التحويل",type:"number",className:"pl-10 h-10 text-sm transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),e.jsx(c,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const a=Ue(),n=parseFloat(we||"0")||0;let o=0;if((a==null?void 0:a.defaultTransferCommission)!=null){const m=Number(a.defaultTransferCommission)||0;o=Math.round(m*n/1e3*100)/100}else{const m=lt&&lt.trim()!==""?parseFloat(lt):0;o=Math.max(0,m)}const d=je?n+o:n;pt((d||0).toString()),nt?i({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):fe(!0)},children:"أجل"}),e.jsx(c,{type:"button",variant:"outline",size:"icon",title:je?"العمولة تُضاف":"العمولة تُخصم",onClick:()=>Lt(a=>!a),children:je?e.jsx(ot,{className:"h-4 w-4 text-green-600"}):e.jsx(os,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"text-xs text-gray-600",children:je?"العمولة تُضاف":"العمولة تُخصم"})]}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"يمكنك إدخال عمولة العملية الإجمالية (اختياري)"})]})})(),e.jsx(c,{onClick:Sl,className:"w-full font-medium h-10 text-sm btn-bounce hover-glow transition-all duration-300 bg-blue-600 hover:bg-blue-700 text-white",children:Ua?"تم التحويل بنجاح":"تأكيد التحويل"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"مبلغ السحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Aa,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-green-500"}),e.jsx(U,{id:"amountInput",value:we,onChange:s=>{at(s.target.value),Rr&&Ls(!1)},onKeyDown:s=>{if(s.key==="Enter"){const r=document.getElementById("manualWithdrawCommissionInput");if(r)r.focus();else{const a=document.getElementById("withdrawSubmitButton");a==null||a.focus()}}},placeholder:"أدخل مبلغ السحب",type:"number",className:"pl-10 h-10 text-sm transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]})]}),(()=>{const s=Ue();return s&&s.defaultWithdrawCommission!=null?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة السحب (تلقائية)"}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["سيتم تطبيق عمولة السحب الافتراضية لكل ألف: ",s==null?void 0:s.defaultWithdrawCommission," جنيه لكل ألف"]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(c,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const a=Ue(),n=parseFloat(we||"0")||0,o=(a==null?void 0:a.defaultWithdrawCommission)!=null&&Number(a.defaultWithdrawCommission)||0,d=Math.round(o*n/1e3*100)/100,m=je?n+d:n;pt((m||0).toString()),nt?i({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):fe(!0)},children:"أجل"}),e.jsx(c,{type:"button",variant:"outline",size:"icon",className:"h-8 w-8",onClick:()=>Lt(a=>!a),title:je?"العمولة تُضاف إلى الدين":"العمولة تُخصم من الدين",children:je?e.jsx(ot,{className:"h-4 w-4"}):e.jsx(os,{className:"h-4 w-4"})}),e.jsx("span",{className:"text-xs text-gray-600",children:je?"العمولة تُضاف":"العمولة تُخصم"})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة السحب على العملية (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(He,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-orange-500"}),e.jsx(U,{id:"manualWithdrawCommissionInput",value:Ne,onChange:a=>Fs(a.target.value),onKeyDown:a=>{if(a.key==="Enter"){const n=document.getElementById("withdrawSubmitButton");n==null||n.focus()}},placeholder:"أدخل العمولة المطلوبة",type:"number",className:"pl-10 h-10 text-sm transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"أدخل العمولة الإجمالية لإتمام عملية السحب"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(c,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const a=Ue(),n=parseFloat(we||"0")||0;let o=0;if((a==null?void 0:a.defaultWithdrawCommission)!=null){const m=Number(a.defaultWithdrawCommission)||0;o=Math.round(m*n/1e3*100)/100}else{const m=Ne&&Ne.trim()!==""?parseFloat(Ne):Math.round(n*.01*100)/100;o=Math.max(0,m)}const d=je?n+o:n;pt((d||0).toString()),nt?i({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):fe(!0)},children:"أجل"}),e.jsx(c,{type:"button",variant:"outline",size:"icon",title:je?"العمولة تُضاف":"العمولة تُخصم",onClick:()=>Lt(a=>!a),children:je?e.jsx(ot,{className:"h-4 w-4 text-green-600"}):e.jsx(os,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"text-xs text-gray-600",children:je?"العمولة تُضاف":"العمولة تُخصم"})]})]})})(),e.jsx(c,{id:"withdrawSubmitButton",onClick:Sl,className:"w-full font-medium h-10 text-sm btn-bounce hover-glow transition-all duration-300 bg-green-600 hover:bg-green-700 text-white",children:Rr?"تم السحب بنجاح":"تأكيد السحب"})]}),e.jsx(re,{open:Me,onOpenChange:fe,children:e.jsxs(le,{children:[e.jsxs(ne,{children:[e.jsx(ie,{children:"تحويل مؤجل"}),e.jsx(Gt,{children:"أدخل بيانات صاحب الدين والمبلغ والملاحظات ثم اضغط حفظ"})]}),e.jsxs("div",{className:"space-y-3",children:[Mt&&Mt.length>0?e.jsxs("div",{children:[e.jsx(q,{children:"اختيار عميل"}),e.jsxs(Ns,{value:gs,onValueChange:s=>{Ws(s);const r=Mt.find(a=>a.id===s);r&&rt(r.name)},children:[e.jsx(ws,{className:"w-full",children:e.jsx(Ss,{placeholder:"اختر عميل"})}),e.jsx(Ds,{children:Mt.map(s=>e.jsxs(Cs,{value:s.id,children:[s.name,s.mobile?` — ${s.mobile}`:""]},s.id))})]})]}):e.jsx("div",{className:"text-xs text-gray-500",children:"لا يوجد عملاء مُسجلين حالياً. يمكنك إضافة عميل من نافذة الديون."}),e.jsxs("div",{children:[e.jsx(q,{htmlFor:"quickDebtName",children:"اسم صاحب الدين"}),e.jsx(U,{id:"quickDebtName",value:Se,onChange:s=>rt(s.target.value),placeholder:"اكتب الاسم"})]}),e.jsxs("div",{children:[e.jsx(q,{htmlFor:"quickDebtAmount",children:"المبلغ (محسوب تلقائياً)"}),e.jsx(U,{id:"quickDebtAmount",type:"number",value:us,readOnly:!0,placeholder:"المبلغ + عمولة التحويل"})]}),e.jsxs("div",{children:[e.jsx(q,{htmlFor:"quickDebtNotes",children:"ملاحظات"}),e.jsx(U,{id:"quickDebtNotes",value:Xs,onChange:s=>ts(s.target.value),placeholder:"اكتب ملاحظات (اختياري)"})]})]}),e.jsx(Ce,{children:e.jsx(c,{type:"button",onClick:()=>{const s=Ue(),r=parseFloat((we||"").toString())||0;let a=0;if(te==="transfer")if((s==null?void 0:s.defaultTransferCommission)!=null){const d=Number(s.defaultTransferCommission)||0;a=Math.round(d*r/1e3*100)/100}else{const d=lt&&lt.trim()!==""?parseFloat(lt):0;a=Math.max(0,d)}else if((s==null?void 0:s.defaultWithdrawCommission)!=null){const d=Number(s.defaultWithdrawCommission)||0;a=Math.round(d*r/1e3*100)/100}else{const d=Ne&&Ne.trim()!==""?parseFloat(Ne):Math.round(r*.01*100)/100;a=Math.max(0,d)}let n=0;if(te==="withdraw"?n=je?r:Math.max(0,Math.round((r-a)*100)/100):n=je?r+a:r,!Se||isNaN(n)||n<=0){i({title:"خطأ في بيانات الأجل",description:"يرجى إدخال الاسم والمبلغ بشكل صحيح",variant:"destructive"});return}const o=Mt.find(d=>d.id===gs);ps({debtorName:Se,amount:n,notes:Xs,customerId:gs||void 0,mobile:o==null?void 0:o.mobile}),fs(!1),fe(!1),i({title:"تم حفظ بيانات الأجل",description:"سيتم إضافة الدين عند تأكيد العملية",variant:"default"})},children:"حفظ"})})]})})]})]}),e.jsx(Re,{className:"bg-gradient-to-br from-red-50 to-red-100 border-red-200 fade-in-up card-float",children:e.jsxs(Ve,{className:"p-3 text-center",children:[e.jsx("div",{className:"text-red-600 font-medium text-[10px] mb-1",children:"⚠️ تحذير من التحويل"}),e.jsx("div",{className:"text-[10px] text-red-700",children:"لا يمكن إلغاء أي عملية بعد تأكيدها للمحافظة على الأمان"})]})})]})]}),e.jsx(Hi,{isOpen:E,onClose:()=>ce(!1),initialEditingWallet:mt,onWalletUpdate:async()=>{var r,a;try{if(t!=null&&t.uid){const n=await Rt.getByMerchantId(t.uid);if(n&&n.length>0){const o=n.map(d=>({id:d.id,name:d.label||"محفظة بدون اسم",phone:d.msisdn,isDefault:!1,monthlyWithdrawalLimit:d.monthlyWithdrawalLimit??d.withdrawLimit??2e5,monthlyTransferLimit:d.monthlyTransferLimit??d.transferLimit??2e5,defaultTransferCommission:d.defaultTransferCommission!=null?Number(d.defaultTransferCommission):null,defaultWithdrawCommission:d.defaultWithdrawCommission!=null?Number(d.defaultWithdrawCommission):null}));ht(o),localStorage.setItem(Ut(),JSON.stringify(o)),(!R||!o.find(d=>d.id===R))&&Qe(((r=o[0])==null?void 0:r.id)||"");return}}}catch(n){console.error("Error loading wallets from Firebase:",n)}const s=localStorage.getItem(Ut());if(s){const n=JSON.parse(s);ht(n),(!R||!n.find(o=>o.id===R))&&Qe(((a=n[0])==null?void 0:a.id)||"")}}}),e.jsx(Gi,{isOpen:ye,onClose:()=>ke(!1),transaction:La,onDelete:ti}),e.jsx(Da,{open:tn,onOpenChange:Bs,onSuccess:li,title:ni(),description:ii()}),e.jsx(Da,{open:an,onOpenChange:Ma,onSuccess:()=>{Ma(!1),Lr(!0)},title:"حماية أرشيف التقارير اليومية",description:"أدخل كلمة مرور تسجيل الدخول للوصول إلى الأرشيف"}),e.jsx(ho,{open:sn,onOpenChange:Lr,userId:t==null?void 0:t.uid}),e.jsx(Fl,{open:Pn,onOpenChange:sl,onSuccess:ci,title:"تعديل الرصيد النقدي في الدرج",description:"أدخل الرقم السري والمبلغ الجديد لتعديل الرصيد النقدي في الدرج",currentBalance:Fe,balanceLabel:"الرصيد النقدي",userId:t==null?void 0:t.uid}),e.jsx(Fl,{open:An,onOpenChange:al,onSuccess:di,title:"تعديل رصيد المحفظة",description:"أدخل الرقم السري والمبلغ الجديد لتعديل رصيد المحفظة",currentBalance:xt&&ge[xt]||0,balanceLabel:`رصيد ${((Il=me.find(s=>s.id===xt))==null?void 0:Il.name)||"المحفظة"}`,userId:t==null?void 0:t.uid}),e.jsx(eo,{open:Wn,onOpenChange:nr,onSuccess:mi,title:"إضافة أو خصم مبلغ من رصيد المحفظة",description:"أدخل الرقم السري والمبلغ المراد إضافته أو خصمه من رصيد المحفظة",currentBalance:xt&&ge[xt]||0,balanceLabel:`رصيد ${((Tl=me.find(s=>s.id===xt))==null?void 0:Tl.name)||"المحفظة"}`,userId:t==null?void 0:t.uid}),e.jsx(Qi,{open:_n,onOpenChange:Rn,userId:t==null?void 0:t.uid}),e.jsx(Zi,{open:zn,onOpenChange:Jn,userId:t==null?void 0:t.uid}),e.jsx(Xi,{open:Kn,onOpenChange:Vn}),e.jsx(re,{open:Bn,onOpenChange:ha,children:e.jsxs(le,{className:"sm:max-w-md",children:[e.jsx(ne,{children:e.jsx(ie,{className:"text-right",children:"تعديل الدرج النقدية"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(q,{htmlFor:"amount",className:"text-right block",children:"المبلغ"}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx(U,{id:"amount",type:"number",placeholder:"أدخل المبلغ",value:cr,onChange:s=>xa(s.target.value),className:"text-right flex-1",dir:"rtl",min:"0"}),e.jsxs("div",{className:"flex gap-1",children:[e.jsxs(c,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white px-3 py-2",onClick:()=>{if(!br(hr)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}const s=parseFloat(cr);if(isNaN(s)||s<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const r=Fe+s;Ke(r);const a={cashBalance:r,lastUpdated:new Date().toISOString()},n=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(n,JSON.stringify(a)),t!=null&&t.uid?ve.updateUserData(t.uid,a).then(()=>{console.log("✅ تم حفظ رصيد الدرج النقدي في Firebase بنجاح"),localStorage.removeItem(n),de(!1)}).catch(o=>{console.error("❌ خطأ في حفظ الرصيد في Firebase:",o),de(!0)}):de(!0),i({title:"تم بنجاح",description:`تم إضافة ${s} جنيه إلى الدرج النقدية وحفظه في السحابة`}),ha(!1),xa(""),ua("")},children:[e.jsx(ot,{className:"h-1 w-1 mr-1"}),"إضافة"]}),e.jsxs(c,{type:"button",size:"sm",className:"bg-red-600 hover:bg-red-700 text-white px-3 py-2",onClick:()=>{if(!br(hr)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}const s=parseFloat(cr);if(isNaN(s)||s<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const r=Fe-s;Ke(r);const a={cashBalance:r,lastUpdated:new Date().toISOString()},n=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(n,JSON.stringify(a)),t!=null&&t.uid?ve.updateUserData(t.uid,a).then(()=>{console.log("✅ تم حفظ رصيد الدرج النقدي في Firebase بنجاح"),localStorage.removeItem(n),de(!1)}).catch(o=>{console.error("❌ خطأ في حفظ الرصيد في Firebase:",o),de(!0)}):de(!0),i({title:"تم بنجاح",description:`تم خصم ${s} جنيه من الدرج النقدية وحفظه في السحابة`}),ha(!1),xa(""),ua("")},children:[e.jsx(os,{className:"h-1 w-1 mr-1"}),"خصم"]})]})]}),e.jsxs("p",{className:"text-[10px] text-gray-500 text-right",children:["الرصيد الحالي: ",Fe.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(q,{htmlFor:"pin",className:"text-right block",children:"الرقم السري"}),e.jsx(U,{id:"pin",type:"password",placeholder:"أدخل الرقم السري",value:hr,onChange:s=>ua(s.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsx(Ce,{className:"flex gap-2",children:e.jsx(c,{variant:"outline",onClick:()=>{ha(!1),xa(""),ua("")},children:"إلغاء"})})]})}),e.jsx(re,{open:Hn,onOpenChange:va,children:e.jsxs(le,{className:"sm:max-w-md",children:[e.jsx(ne,{children:e.jsx(ie,{className:"text-right text-red-600",children:"تصفير إجمالي المحفظة"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-red-50 rounded-lg border border-red-200",children:[e.jsx("p",{className:"text-red-800 font-medium mb-2",children:"تحذير!"}),e.jsx("p",{className:"text-red-700 text-sm",children:"سيتم تصفير جميع أرصدة المحافظ إلى صفر. هذا الإجراء لا يمكن التراجع عنه."}),e.jsxs("p",{className:"text-red-600 text-sm mt-2",children:["الرصيد الحالي: ",Object.values(ge).reduce((s,r)=>s+r,0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(q,{htmlFor:"resetWalletTotalPin",className:"text-right block",children:"كلمة مرور تسجيل الدخول"}),e.jsx(U,{id:"resetWalletTotalPin",type:"password",placeholder:"أدخل كلمة مرور تسجيل الدخول",value:jl,onChange:s=>ya(s.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsxs(Ce,{className:"flex gap-2",children:[e.jsx(c,{variant:"outline",onClick:()=>{va(!1),ya("")},children:"إلغاء"}),e.jsx(c,{variant:"destructive",onClick:async()=>{if(!await Nr(jl)){i({title:"خطأ",description:"كلمة المرور غير صحيحة",variant:"destructive"});return}try{const r={};Object.keys(ge).forEach(d=>{r[d]=0}),Ae(r),localStorage.setItem(Ee(),JSON.stringify(r)),va(!1),ya("");const a=new Date().toISOString(),n={walletBalances:r,lastUpdated:a},o=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(o,JSON.stringify(n)),t!=null&&t.uid?ve.updateUserData(t.uid,n).then(()=>{localStorage.removeItem(o),de(!1)}).catch(d=>{console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",d),de(!0),i({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):de(!0),setTimeout(()=>{Ae({...r})},100)}catch(r){console.error("خطأ في تصفير أرصدة المحافظ:",r),i({title:"خطأ",description:"حدث خطأ أثناء تصفير المحافظ",variant:"destructive"})}},children:"تصفير المحفظة"})]})]})}),e.jsx(re,{open:On,onOpenChange:ma,children:e.jsxs(le,{className:"sm:max-w-md",children:[e.jsx(ne,{children:e.jsx(ie,{className:"text-right text-red-600",children:"تصفير رصيد المحفظة المختارة"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-red-50 rounded-lg border border-red-200",children:[e.jsx("p",{className:"text-red-800 font-medium mb-2",children:"تحذير!"}),e.jsx("p",{className:"text-red-700 text-sm",children:"سيتم تصفير رصيد المحفظة المحددة إلى صفر. هذا الإجراء لا يمكن التراجع عنه."}),e.jsxs("p",{className:"text-red-600 text-sm mt-2",children:["المحفظة: ",((kl=me.find(s=>s.id===R))==null?void 0:kl.name)||R]}),e.jsxs("p",{className:"text-red-600 text-sm",children:["الرصيد الحالي: ",(R&&ge[R]?ge[R]:0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(q,{htmlFor:"resetSelectedWalletPin",className:"text-right block",children:"كلمة مرور تسجيل الدخول"}),e.jsx(U,{id:"resetSelectedWalletPin",type:"password",placeholder:"أدخل كلمة مرور تسجيل الدخول",value:rl,onChange:s=>ir(s.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsxs(Ce,{className:"flex gap-2",children:[e.jsx(c,{variant:"outline",onClick:()=>{ma(!1),ir("")},children:"إلغاء"}),e.jsx(c,{variant:"destructive",onClick:async()=>{var r;if(!R){i({title:"اختر محفظة",description:"يرجى اختيار محفظة أولاً",variant:"destructive"});return}if(!await Nr(rl)){i({title:"خطأ",description:"كلمة المرور غير صحيحة",variant:"destructive"});return}try{const a={...ge};a[R]=0,Ae(a),localStorage.setItem(Ee(),JSON.stringify(a)),ma(!1),ir("");const n=new Date().toISOString(),o={walletBalances:a,lastUpdated:n},d=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(d,JSON.stringify(o)),t!=null&&t.uid?ve.updateUserData(t.uid,o).then(()=>{localStorage.removeItem(d),de(!1)}).catch(m=>{console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",m),de(!0),i({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):de(!0),i({title:"تم التصفير بنجاح",description:`تم تصفير رصيد المحفظة ${((r=me.find(m=>m.id===R))==null?void 0:r.name)||R}`})}catch(a){console.error("خطأ في تصفير رصيد المحفظة المختارة:",a),i({title:"خطأ",description:"حدث خطأ أثناء تصفير رصيد المحفظة المختارة",variant:"destructive"})}},children:"تصفير المحفظة"})]})]})}),e.jsx(re,{open:Yn,onOpenChange:fa,children:e.jsxs(le,{className:"sm:max-w-md",children:[e.jsx(ne,{children:e.jsxs(ie,{className:"text-right text-green-600 flex items-center gap-2 justify-end",children:[e.jsx(ot,{className:"h-4 w-4"}),"إضافة أموال لإجمالي المحفظة"]})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-green-50 rounded-lg border border-green-200",children:[e.jsx("p",{className:"text-green-800 font-medium mb-2",children:"إضافة أموال"}),e.jsx("p",{className:"text-green-700 text-sm",children:"سيتم إضافة المبلغ المحدد إلى إجمالي المحفظة بشكل متناسب على جميع المحافظ."}),e.jsxs("p",{className:"text-green-600 text-sm mt-2",children:["الرصيد الحالي: ",Object.values(ge).reduce((s,r)=>s+r,0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"addWalletTotalAmount",className:"text-right block",children:"المبلغ المراد إضافته"}),e.jsx(U,{id:"addWalletTotalAmount",type:"number",placeholder:"أدخل المبلغ",value:hl,onChange:s=>pr(s.target.value),className:"text-right",dir:"rtl"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"addWalletTotalPin",className:"text-right block",children:"الرقم السري للتأكيد"}),e.jsx(U,{id:"addWalletTotalPin",type:"password",placeholder:"أدخل الرقم السري",value:xl,onChange:s=>fr(s.target.value),className:"text-right",dir:"rtl"})]})]})]}),e.jsxs(Ce,{className:"flex gap-2",children:[e.jsx(c,{variant:"outline",onClick:()=>{fa(!1),pr(""),fr("")},children:"إلغاء"}),e.jsx(c,{variant:"default",className:"bg-green-600 hover:bg-green-700",disabled:ul,onClick:async()=>{const s=parseFloat(hl);if(!s||s<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}if(!Zn(xl)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}gl(!0);try{const r=Object.values(ge).reduce((a,n)=>a+n,0);if(r===0){const a=Object.keys(ge),n=s/a.length,o={};a.forEach(d=>{o[d]=n}),Ae(o),localStorage.setItem(Ee(),JSON.stringify(o)),t!=null&&t.uid?await ve.updateUserData(t.uid,{walletBalances:o,lastUpdated:new Date().toISOString()}):de(!0)}else{const a={};Object.entries(ge).forEach(([n,o])=>{const d=o/r,m=s*d;a[n]=o+m}),Ae(a),localStorage.setItem(Ee(),JSON.stringify(a)),t!=null&&t.uid?await ve.updateUserData(t.uid,{walletBalances:a,lastUpdated:new Date().toISOString()}):de(!0)}setTimeout(()=>{Ae(a=>({...a}))},100),fa(!1),pr(""),fr("")}catch(r){console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",r),i({title:"خطأ",description:"حدث خطأ أثناء حفظ البيانات",variant:"destructive"})}finally{gl(!1)}},children:ul?"جاري الإضافة...":"إضافة الأموال"})]})]})}),e.jsx(re,{open:Gn,onOpenChange:ja,children:e.jsxs(le,{className:"sm:max-w-[425px]",children:[e.jsx(ne,{children:e.jsxs(ie,{className:"text-red-600 flex items-center gap-2",children:[e.jsx(wt,{className:"h-1 w-1"}),"تصفير الرصيد النقدي"]})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-3",children:e.jsx("p",{className:"text-sm text-red-700",children:"⚠️ تحذير: سيتم تصفير الرصيد النقدي في الدرج إلى صفر. هذا الإجراء لا يمكن التراجع عنه."})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(q,{htmlFor:"resetCashPin",children:"كلمة مرور تسجيل الدخول"}),e.jsx(U,{id:"resetCashPin",type:"password",placeholder:"أدخل كلمة مرور تسجيل الدخول",value:yr,onChange:s=>jr(s.target.value)})]})]}),e.jsxs(Ce,{children:[e.jsx(c,{variant:"outline",onClick:()=>{ja(!1),jr("")},children:"إلغاء"}),e.jsx(c,{variant:"destructive",onClick:async()=>{if(!yr){i({title:"خطأ",description:"يرجى إدخال كلمة المرور",variant:"destructive"});return}if(!await Nr(yr)){i({title:"خطأ",description:"كلمة المرور غير صحيحة",variant:"destructive"});return}try{Ke(0),ja(!1),jr("");const r={cashBalance:0,lastUpdated:new Date().toISOString()};localStorage.setItem($e(),"0");const a=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(a,JSON.stringify(r)),t!=null&&t.uid?ve.updateUserData(t.uid,r).then(()=>{localStorage.removeItem(a),de(!1)}).catch(n=>{console.error("خطأ في حفظ الرصيد في Firebase:",n),de(!0),i({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):de(!0)}catch(r){console.error("خطأ في تصفير الرصيد النقدي:",r),i({title:"خطأ",description:"حدث خطأ أثناء تصفير الرصيد النقدي",variant:"destructive"})}},children:"تصفير الرصيد"})]})]})}),e.jsx(re,{open:qn,onOpenChange:ga,children:e.jsxs(le,{className:"sm:max-w-[425px]",children:[e.jsx(ne,{children:e.jsxs(ie,{className:"text-green-600 flex items-center gap-2",children:[e.jsx(ot,{className:"h-4 w-4"}),"إضافة أموال للدرج"]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-3",children:e.jsx("p",{className:"text-sm text-green-700",children:"💰 سيتم إضافة المبلغ المحدد إلى الرصيد النقدي في الدرج"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"addCashAmount",children:"المبلغ المراد إضافته"}),e.jsx(U,{id:"addCashAmount",type:"number",placeholder:"أدخل المبلغ",value:pa,onChange:s=>xr(s.target.value),min:"0",step:"0.01"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"addCashPin",children:"الرقم السري لدرج النقدية"}),e.jsx(U,{id:"addCashPin",type:"password",placeholder:"أدخل الرقم السري",value:ur,onChange:s=>gr(s.target.value)})]})]}),e.jsxs(Ce,{children:[e.jsx(c,{variant:"outline",onClick:()=>{ga(!1),xr(""),gr("")},children:"إلغاء"}),e.jsx(c,{variant:"default",className:"bg-green-600 hover:bg-green-700",disabled:dl,onClick:async()=>{if(!pa||parseFloat(pa)<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح أكبر من صفر",variant:"destructive"});return}if(!ur){i({title:"خطأ",description:"يرجى إدخال الرقم السري",variant:"destructive"});return}if(!br(ur)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}ml(!0);try{const s=parseFloat(pa),r=Fe+s;Ke(r),localStorage.setItem($e(),r.toString());const a={cashBalance:r,lastUpdated:new Date().toISOString()},n=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(n,JSON.stringify(a)),t!=null&&t.uid?(await ve.updateUserData(t.uid,a),localStorage.removeItem(n),de(!1)):de(!0),ga(!1),xr(""),gr("")}catch(s){console.error("خطأ في حفظ الرصيد في Firebase:",s),Ke(Fe),localStorage.setItem("cashBalance",Fe.toString()),i({title:"خطأ",description:"حدث خطأ أثناء حفظ البيانات، يرجى المحاولة مرة أخرى",variant:"destructive"})}finally{ml(!1)}},children:dl?"جاري الإضافة...":"إضافة الأموال"})]})]})}),e.jsx(re,{open:kn,onOpenChange:lr,children:e.jsxs(le,{className:"sm:max-w-md",children:[e.jsx(ne,{children:e.jsx(ie,{className:"text-right",children:"اختيار التاريخ والوقت للبحث"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(q,{htmlFor:"search-date",className:"text-right block",children:"التاريخ"}),e.jsx(U,{id:"search-date",type:"date",value:aa,onChange:s=>$r(s.target.value),className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(q,{htmlFor:"search-time",className:"text-right block",children:"الوقت (اختياري)"}),e.jsx(U,{id:"search-time",type:"time",value:ra,onChange:s=>_r(s.target.value),className:"text-right",placeholder:"اختر الوقت للبحث في ساعة محددة"}),e.jsx("p",{className:"text-[10px] text-gray-500 text-right",children:"إذا لم تختر وقتاً محدداً، سيتم البحث في كامل اليوم"})]})]}),e.jsxs(Ce,{className:"flex justify-between",children:[e.jsx(c,{variant:"outline",onClick:()=>{$r(""),_r(""),lr(!1)},children:"مسح"}),e.jsx(c,{onClick:()=>lr(!1),children:"تطبيق"})]})]})}),e.jsx(Bl,{isOpen:f&&!S,onClose:()=>_(!1),onTrialStarted:In}),e.jsx(to,{isOpen:on,onClose:()=>zr(!1)}),e.jsx(so,{isOpen:cn,onClose:()=>$a(!1)}),e.jsx(Fi,{isOpen:dn,onClose:()=>_a(!1)}),e.jsx(Bi,{open:mn,onOpenChange:Ra}),e.jsx(ro,{open:hn,onOpenChange:s=>{if(s&&!is){i({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});return}za(s)}}),e.jsx(xo,{open:T,onOpenChange:s=>{if(s&&!is){i({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}k(s)}}),e.jsx(uo,{open:O,onOpenChange:s=>{if(s&&!is){i({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}V(s)}}),e.jsx(Da,{open:fn,onOpenChange:ia,title:"تأكيد كلمة المرور لفتح الديون",description:"أدخل كلمة مرور تسجيل الدخول لفتح صفحة الديون",onSuccess:()=>{ia(!1),na(!0)}}),e.jsx(Da,{open:Fn,onOpenChange:or,title:"تأكيد كلمة المرور لتصفير المعاملات الأخيرة",description:"لن يتم حذف الإيصالات؛ سنبدأ القائمة من الآن.",onSuccess:()=>{try{t!=null&&t.uid&&(localStorage.setItem(`recentTransactionsResetAt:${t.uid}`,new Date().toISOString()),i({title:"تم التصفير",description:"تم بدء قائمة المعاملات من الآن."}))}catch{}or(!1)}}),e.jsx(Zs,{open:P,onOpenChange:z,mode:"verify",title:"الرقم السري لفتح مصروفات المحل",description:"أدخل الرقم السري الرئيسي لفتح نافذة مصروفات المحل",onSuccess:()=>{z(!1),B(!0)}}),e.jsx(re,{open:pn,onOpenChange:na,children:e.jsxs(le,{className:"sm:max-w-[425px]",children:[e.jsxs(ne,{className:"flex items-center justify-between",children:[e.jsx(ie,{className:"text-right",children:"إدارة الديون"}),e.jsxs("div",{className:"flex items-center gap-1 text-orange-700",children:[e.jsx(_i,{className:"h-4 w-4"}),e.jsxs("span",{className:"text-xs font-bold",children:[ri," جنيه"]})]})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(q,{htmlFor:"debtorName",className:"text-right col-span-1",children:"اسم المديون"}),e.jsx(U,{id:"debtorName",value:Ja,onChange:s=>Kr(s.target.value),className:"col-span-3 text-right",placeholder:"أدخل اسم المديون"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(q,{htmlFor:"debtAmount",className:"text-right col-span-1",children:"المبلغ"}),e.jsx(U,{id:"debtAmount",type:"number",value:Ka,onChange:s=>Vr(s.target.value),className:"col-span-3 text-right",placeholder:"أدخل المبلغ"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(q,{htmlFor:"debtReason",className:"text-right col-span-1",children:"سبب الدين"}),e.jsx(U,{id:"debtReason",value:Va,onChange:s=>qr(s.target.value),className:"col-span-3 text-right",placeholder:"أدخل سبب الدين"})]})]}),e.jsx(Ce,{children:e.jsx(c,{onClick:()=>{if(Ja&&Ka&&Va){const s={id:Date.now().toString(),debtorName:Ja,amount:parseFloat(Ka),reason:Va,status:"pending",createdAt:new Date,paidAmount:0,partialPayments:[]};sr(s),oa(!0)}else i({title:"بيانات غير مكتملة",description:"يرجى إدخال الاسم والمبلغ والسبب",variant:"destructive"})},className:"bg-orange-500 hover:bg-orange-600",children:"حفظ"})}),e.jsx("div",{className:"mt-2",children:e.jsx(c,{variant:"outline",className:"w-full",onClick:()=>Ha(!0),children:"إيصالات الديون"})}),e.jsx("div",{className:"mt-2",children:e.jsx(c,{variant:"outline",className:"w-full",onClick:()=>Ga(!0),children:"إضافة عميل"})})]})}),e.jsx(re,{open:jn,onOpenChange:Ha,children:e.jsxs(le,{className:"sm:max-w-[520px]",children:[e.jsxs(ne,{children:[e.jsx(ie,{className:"text-right",children:"إيصالات الديون"}),e.jsx(Gt,{className:"text-right",children:"اختر دينًا لعرض إيصاله بالتفصيل"})]}),ft.length>0?e.jsx("div",{className:"max-h-64 overflow-y-auto space-y-2",children:ft.map(s=>e.jsx("div",{onClick:()=>{Yr(s),Ms(!0),Ha(!1),na(!1)},className:"p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium",children:s.debtorName}),e.jsx("p",{className:"text-sm text-gray-600",children:s.reason}),e.jsx("p",{className:"text-sm text-gray-500",children:Dr.format(s.createdAt instanceof Date?s.createdAt:new Date(s.createdAt))})]}),e.jsxs("div",{className:"text-left",children:[e.jsxs("p",{className:"font-bold text-lg",children:[s.amount," جنيه"]}),e.jsx(yt,{variant:s.status==="paid"?"default":"secondary",className:s.status==="paid"?"bg-green-500":"bg-yellow-500",children:s.status==="paid"?"مدفوع":"قيد المراجعة"})]})]})},s.id))}):e.jsx("div",{className:"text-center text-sm text-gray-500",children:"لا توجد ديون مسجلة"})]})}),e.jsx(re,{open:bn,onOpenChange:Ga,children:e.jsxs(le,{className:"sm:max-w-[480px]",children:[e.jsxs(ne,{children:[e.jsx(ie,{className:"text-right",children:"إضافة عميل"}),e.jsx(Gt,{className:"text-right",children:"أدخل بيانات العميل ثم يمكنك تسجيل مبلغ دين عليه"})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(q,{htmlFor:"customerName",className:"text-right col-span-1",children:"اسم العميل"}),e.jsx(U,{id:"customerName",value:Za,onChange:s=>Gr(s.target.value),className:"col-span-3 text-right",placeholder:"اكتب اسم العميل"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(q,{htmlFor:"customerMobile",className:"text-right col-span-1",children:"رقم الموبايل"}),e.jsx(U,{id:"customerMobile",value:Xa,onChange:s=>Qr(s.target.value),className:"col-span-3 text-right",placeholder:"اكتب رقم الموبايل"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(c,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{if(!Za||!Xa){i({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم العميل ورقم الموبايل",variant:"destructive"});return}const s={id:Date.now().toString(),name:Za.trim(),mobile:Xa.trim(),createdAt:new Date},r=[s,...Mt];await Mn(r),Gr(""),Qr(""),i({title:"تمت إضافة العميل",description:`تم إضافة ${s.name}`})},children:"إضافة"})}),e.jsxs("div",{className:"border-t pt-4 space-y-3",children:[e.jsx(q,{className:"text-right block",children:"إضافة مبلغ على عميل"}),Mt.length>0?e.jsxs("div",{className:"space-y-3",children:[e.jsxs(Ns,{value:er,onValueChange:Zr,children:[e.jsx(ws,{className:"w-full",children:e.jsx(Ss,{placeholder:"اختر عميل"})}),e.jsx(Ds,{children:Mt.map(s=>e.jsxs(Cs,{value:s.id,children:[s.name," — ",s.mobile]},s.id))})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(q,{htmlFor:"customerDebtAmount",className:"text-right col-span-1",children:"المبلغ"}),e.jsx(U,{id:"customerDebtAmount",type:"number",value:Xr,onChange:s=>el(s.target.value),className:"col-span-3 text-right",placeholder:"أدخل المبلغ"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(c,{className:"bg-orange-600 hover:bg-orange-700",onClick:async()=>{const s=parseFloat(Xr);if(!er){i({title:"اختر عميل",description:"يرجى اختيار عميل أولاً",variant:"destructive"});return}if(isNaN(s)||s<=0){i({title:"قيمة غير صحيحة",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const r=Mt.find(o=>o.id===er);if(!r)return;const a={id:Date.now().toString(),debtorName:r.name,customerId:r.id,mobile:r.mobile,amount:Number(s.toFixed(2)),reason:"دين عميل",status:"pending",createdAt:new Date,paidAmount:0,partialPayments:[]},n=[...ft,a];kt(n),await Vt(n),Zr(""),el(""),i({title:"تم تسجيل المبلغ على العميل",description:`تمت إضافة ${a.amount} جنيه للعميل ${r.name}`})},children:"إضافة المبلغ"})})]}):e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد عملاء مسجلين. أضف عميلًا أولاً."})]})]}),e.jsx(Ce,{className:"flex justify-end",children:e.jsx(c,{variant:"outline",onClick:()=>Ga(!1),children:"إغلاق"})})]})}),e.jsx(re,{open:Z,onOpenChange:B,children:e.jsxs(le,{className:"sm:max-w-[520px]",children:[e.jsxs(ne,{children:[e.jsx(ie,{className:"text-right",children:"مصروفات المحل"}),e.jsx(Gt,{className:"text-right",children:"أدخل تفاصيل المصروف ثم اختر مصدر الخصم."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(q,{htmlFor:"expenseName",className:"text-right col-span-1",children:"اسم المصروف"}),e.jsx(U,{id:"expenseName",value:se,onChange:s=>X(s.target.value),className:"col-span-3 text-right",placeholder:"مثال: كهرباء، صيانة، مشتريات"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(q,{htmlFor:"expenseAmount",className:"text-right col-span-1",children:"تمن المصروف"}),e.jsx(U,{id:"expenseAmount",type:"number",value:xe,onChange:s=>H(s.target.value),className:"col-span-3 text-right",placeholder:"0.00"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(q,{htmlFor:"expenseNotes",className:"text-right col-span-1",children:"ملاحظات"}),e.jsx(U,{id:"expenseNotes",value:Q,onChange:s=>Y(s.target.value),className:"col-span-3 text-right",placeholder:"معلومات إضافية إن وجدت"})]})]}),e.jsxs(Ce,{className:"flex justify-between",children:[e.jsx(c,{className:"bg-orange-600 hover:bg-orange-700",onClick:()=>{if(!se||!xe){i({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم المصروف وقيمته",variant:"destructive"});return}We(!0)},children:"إضافة مصروف"}),e.jsx(c,{variant:"outline",onClick:()=>Nt(!0),children:"إيصالات المصاريف"})]})]})}),e.jsx(re,{open:Jt,onOpenChange:Nt,children:e.jsxs(le,{className:"sm:max-w-[420px]",dir:"rtl",children:[e.jsxs(ne,{children:[e.jsx(ie,{className:"text-right",children:"إيصالات المصاريف"}),e.jsx(Gt,{className:"text-right",children:"آخر المصاريف المسجلة"})]}),L.length>0?e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:L.map(s=>e.jsx("div",{className:"p-2 border rounded-lg bg-white hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium text-sm",children:s.name}),e.jsx("p",{className:"text-[11px] text-gray-600",children:s.notes||"بدون ملاحظات"}),e.jsx("p",{className:"text-[10px] text-gray-500",children:new Date(s.createdAt).toLocaleString("ar-EG")})]}),e.jsxs("div",{className:"text-left",children:[e.jsxs("p",{className:"font-bold text-sm",children:[s.amount," جنيه"]}),e.jsx(yt,{variant:"secondary",className:s.source==="cash"?"bg-blue-100 text-blue-700":"bg-purple-100 text-purple-700",children:s.source==="cash"?"من النقدية":`من المحفظة${s.walletId?` (${s.walletId})`:""}`})]})]})},s.id))}):e.jsx("p",{className:"text-sm text-gray-500 text-center",children:"لا توجد مصاريف مسجلة بعد"})]})}),e.jsx(re,{open:Be,onOpenChange:We,children:e.jsxs(le,{className:"sm:max-w-[480px]",children:[e.jsx(ne,{children:e.jsx(ie,{className:"text-right",children:"اختيار مصدر خصم المصروف"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600 text-right",children:"اختر هل تريد خصم مبلغ المصروف من الرصيد النقدي في الدرج أم من إحدى المحافظ."}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsx(c,{variant:Le==="cash"?"default":"outline",className:Le==="cash"?"bg-blue-600 hover:bg-blue-700 text-white":"",onClick:()=>Oe("cash"),children:"الفلوس النقدية"}),e.jsx(c,{variant:Le==="wallet"?"default":"outline",className:Le==="wallet"?"bg-purple-600 hover:bg-purple-700 text-white":"",onClick:()=>Oe("wallet"),children:"أرصدة المحافظ"})]}),Le==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{className:"text-right block",children:"اختر المحفظة للخصم"}),e.jsxs(Ns,{value:dt,onValueChange:Ze,children:[e.jsx(ws,{className:"w-full",children:e.jsx(Ss,{placeholder:"اختر محفظة"})}),e.jsx(Ds,{children:me.map(s=>e.jsx(Cs,{value:s.id,children:s.phone||s.name||s.id},s.id))})]})]})]}),e.jsxs(Ce,{className:"flex justify-between",children:[e.jsx(c,{variant:"outline",onClick:()=>{We(!1),Oe(null),Ze("")},children:"إلغاء"}),e.jsx(c,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{const s=Number(xe);if(isNaN(s)||s<=0){i({title:"قيمة غير صحيحة",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}if(!Le){i({title:"اختر مصدر الخصم",description:"يرجى اختيار النقدية أو المحفظة",variant:"destructive"});return}try{if(Le==="cash"){const n=Number((Fe-s).toFixed(2));Ke(n),localStorage.setItem($e(),n.toString());const o={cashBalance:n,lastUpdated:new Date().toISOString()},d=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(d,JSON.stringify(o)),t!=null&&t.uid?(await ve.updateUserData(t.uid,o),localStorage.removeItem(d),de(!1)):de(!0)}else if(Le==="wallet"){if(!dt){i({title:"اختر محفظة",description:"يرجى اختيار محفظة للخصم",variant:"destructive"});return}const n=ge[dt]||0,o=Number((n-s).toFixed(2)),d={...ge,[dt]:o};Ae(d);const m=new Date().toISOString(),y={walletBalances:d,lastUpdated:m},C=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(C,JSON.stringify(y)),localStorage.setItem(Ee(),JSON.stringify(d)),localStorage.setItem(`walletBalances_backup_${m}`,JSON.stringify(d)),t!=null&&t.uid&&await ve.updateUserData(t.uid,y)}}catch(n){console.error("خطأ أثناء تحديث الأرصدة عند حفظ المصروف:",n)}const r={id:Date.now().toString(),name:se,amount:s,notes:Q,source:Le,walletId:Le==="wallet"?dt:void 0,createdAt:new Date},a=[...L,r];await En(a),X(""),H(""),Y(""),Oe(null),Ze(""),We(!1),B(!0),Nt(!0),i({title:"تم إضافة المصروف",description:Le==="cash"?"تم الخصم من النقدية":"تم الخصم من أرصدة المحافظ"})},children:"تأكيد الخصم"})]})]})}),e.jsx(re,{open:Nn,onOpenChange:oa,children:e.jsxs(le,{className:"sm:max-w-[480px]",children:[e.jsx(ne,{children:e.jsx(ie,{className:"text-right",children:"اختيار مصدر خصم الدين"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600 text-right",children:"اختر هل تريد خصم مبلغ الدين من الرصيد النقدي في الدرج أم من إحدى المحافظ أو تسجيله بدون خصم."}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsx(c,{variant:vt==="cash"?"default":"outline",className:vt==="cash"?"bg-blue-600 hover:bg-blue-700 text-white":"",onClick:()=>Us("cash"),children:"الفلوس النقدية"}),e.jsx(c,{variant:vt==="wallet"?"default":"outline",className:vt==="wallet"?"bg-purple-600 hover:bg-purple-700 text-white":"",onClick:()=>Us("wallet"),children:"أرصدة المحافظ"}),e.jsx(c,{variant:vt==="none"?"default":"outline",className:vt==="none"?"bg-gray-600 hover:bg-gray-700 text-white":"",onClick:()=>Us("none"),children:"بدون خصم"})]}),vt==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{className:"text-right block",children:"اختر المحفظة للخصم"}),e.jsxs(Ns,{value:ca,onValueChange:ar,children:[e.jsx(ws,{className:"w-full",children:e.jsx(Ss,{placeholder:"اختر محفظة"})}),e.jsx(Ds,{children:me.map(s=>e.jsx(Cs,{value:s.id,children:s.phone||s.name||s.id},s.id))})]})]})]}),e.jsxs(Ce,{className:"flex justify-between",children:[e.jsx(c,{variant:"outline",onClick:()=>{oa(!1),sr(null),Us(null),ar("")},children:"إلغاء"}),e.jsx(c,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{if(!tr)return;const s=Number(tr.amount);if(!vt){i({title:"اختر مصدر الخصم",description:"يرجى اختيار النقدية أو المحفظة",variant:"destructive"});return}try{if(vt==="cash"){const a=Number((Fe-s).toFixed(2));Ke(a),localStorage.setItem($e(),a.toString());const n=new Date().toISOString(),o={cashBalance:a,lastUpdated:n},d=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(d,JSON.stringify(o)),t!=null&&t.uid?await ve.updateUserData(t.uid,o).then(()=>{localStorage.removeItem(d),de(!1)}).catch(()=>{de(!0)}):de(!0)}else if(vt==="wallet"){if(!ca){i({title:"اختر محفظة",description:"يرجى اختيار محفظة للخصم",variant:"destructive"});return}const a=ge[ca]||0,n=Number((a-s).toFixed(2)),o={...ge,[ca]:n};Ae(o);const d=new Date().toISOString(),m={walletBalances:o,lastUpdated:d},y=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(y,JSON.stringify(m)),localStorage.setItem(Ee(),JSON.stringify(o)),localStorage.setItem(`walletBalances_backup_${d}`,JSON.stringify(o)),t!=null&&t.uid&&await ve.updateUserData(t.uid,m)}}catch(a){console.error("خطأ أثناء تحديث الأرصدة عند حفظ الدين:",a)}const r=[...ft,tr];kt(r),await Vt(r),Kr(""),Vr(""),qr(""),na(!1),oa(!1),sr(null),Us(null),ar(""),i(vt==="none"?{title:"تم حفظ الدين بدون خصم",description:"لم يتم الخصم من الدرج أو المحافظ"}:{title:"تم حفظ الدين وخصم المبلغ",description:vt==="cash"?`تم خصم ${s} من الرصيد النقدي`:`تم خصم ${s} من رصيد المحفظة`})},children:"تأكيد الخصم وحفظ الدين"})]})]})}),e.jsx(re,{open:vn,onOpenChange:Ms,children:e.jsxs(le,{className:"sm:max-w-[425px] z-[60]",children:[e.jsx(ne,{children:e.jsx(ie,{className:"text-right",children:"إيصال الدين"})}),he&&e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"text-center border-b pb-4",children:[e.jsx("h2",{className:"text-xl font-bold",children:"إيصال دين"}),e.jsx("p",{className:"text-sm text-gray-500",children:Dr.format(he.createdAt instanceof Date?he.createdAt:new Date(he.createdAt))})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"اسم المديون:"}),e.jsx("span",{children:he.debtorName})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"المبلغ:"}),e.jsxs("span",{className:"font-bold text-lg",children:[he.amount," جنيه"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"سبب الدين:"}),e.jsx("span",{children:he.reason})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"الحالة:"}),e.jsx(yt,{variant:he.status==="paid"?"default":"secondary",className:he.status==="paid"?"bg-green-500":"bg-yellow-500",children:he.status==="paid"?"مدفوع":"مؤجل"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"المبلغ المتبقي:"}),e.jsxs("span",{className:"font-bold text-lg",children:[he.amount," جنيه"]})]}),he.paidAmount?e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"إجمالي المدفوع:"}),e.jsxs("span",{className:"text-green-700",children:[he.paidAmount," جنيه"]})]}):null,e.jsxs("div",{className:"mt-3 p-3 border rounded-lg bg-gray-50",children:[yn?e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"partialAmount",className:"text-right block",children:"المبلغ المراد دفعه"}),e.jsx(U,{id:"partialAmount",type:"number",value:Hr,onChange:s=>Ya(s.target.value),className:"text-right",placeholder:"أدخل المبلغ"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(c,{variant:"outline",onClick:()=>{qa(!1),Ya("")},children:"إلغاء"}),e.jsx(c,{className:"bg-blue-600 hover:bg-blue-700",onClick:async()=>{const s=parseFloat(Hr);if(!he||isNaN(s)||s<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}if(s>he.amount){i({title:"مبلغ زائد",description:"المبلغ المدفوع أكبر من المتبقي",variant:"destructive"});return}const r={...he,amount:Number((he.amount-s).toFixed(2)),paidAmount:Number(((he.paidAmount||0)+s).toFixed(2)),status:he.amount-s<=0?"paid":"pending",partialPayments:[...he.partialPayments||[],{amount:s,paidAt:new Date}]},a=ft.map(n=>n.id===he.id?r:n);kt(a),Yr(r),await Vt(a);try{r.status==="paid"&&(t!=null&&t.uid)&&(async()=>{const n=Is(Ht(tt,"userTransactions"),St("userId","==",t.uid),St("linkedDebtId","==",he.id),St("status","==","pending")),o=await Ts(n);await Promise.allSettled(o.docs.map(d=>Gs(d.ref,{status:"completed",confirmedAt:new Date})))})().catch(n=>console.error("تعذر تحديث حالة المعاملات المرتبطة بالدين:",n))}catch(n){console.error("تعذر تجهيز تحديث حالة المعاملات المرتبطة:",n)}try{const n=$s(),o=localStorage.getItem(n);if(o){const m=(JSON.parse(o)||[]).map(y=>(y==null?void 0:y.linkedDebtId)===he.id&&(y==null?void 0:y.status)==="pending"?{...y,status:"completed",confirmedAt:new Date}:y);localStorage.setItem(n,JSON.stringify(m)),Tt(y=>y.map(C=>(C==null?void 0:C.linkedDebtId)===he.id&&(C==null?void 0:C.status)==="pending"?{...C,status:"completed",confirmedAt:new Date}:C))}}catch(n){console.warn("فشل تحديث حالة المعاملات المرتبطة محلياً بعد سداد الدين:",n)}da(s),ls("cash"),js(!0),qa(!1),Ya(""),i({title:"تم تسجيل دفع جزء",description:`تم دفع ${s} جنيه بتاريخ ${new Date().toLocaleString("ar-EG")}`})},children:"دفع"})]})]}):e.jsx(c,{variant:"outline",className:"w-full",onClick:()=>qa(!0),children:"دفع جزء"}),he.partialPayments&&he.partialPayments.length>0&&e.jsxs("div",{className:"mt-3 text-xs text-gray-600",children:[e.jsx("p",{className:"font-medium mb-1",children:"سجل الدفعات الجزئية:"}),e.jsx("div",{className:"space-y-1 max-h-24 overflow-y-auto",children:he.partialPayments.map((s,r)=>e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{children:["دفع: ",s.amount," جنيه"]}),e.jsx("span",{children:new Date(s.paidAt).toLocaleString("ar-EG")})]},r))})]})]})]})]}),e.jsxs(Ce,{className:"flex gap-2 justify-center",children:[e.jsx(c,{onClick:async()=>{if(he){const s=ft.map(r=>r.id===he.id?{...r,status:"pending"}:r);kt(s),await Vt(s),Ms(!1),i({title:"تم تحديث حالة الدين",description:"تم تعيين الدين كمؤجل"})}},variant:"outline",className:"bg-yellow-500 hover:bg-yellow-600 text-white",children:"مؤجل"}),e.jsx(c,{onClick:async()=>{if(he){const s=he.amount,r=ft.map(a=>a.id===he.id?{...a,amount:0,paidAmount:Number(((a.paidAmount||0)+s).toFixed(2)),status:"paid",partialPayments:[...a.partialPayments||[],...s>0?[{amount:s,paidAt:new Date}]:[]]}:a);kt(r),s>0&&(da(s),ls("cash"),js(!0)),await Vt(r);try{t!=null&&t.uid&&(he!=null&&he.id)&&(async()=>{const a=Is(Ht(tt,"userTransactions"),St("userId","==",t.uid),St("linkedDebtId","==",he.id),St("status","==","pending")),n=await Ts(a);await Promise.allSettled(n.docs.map(o=>Gs(o.ref,{status:"completed",confirmedAt:new Date})))})().catch(a=>console.error("تعذر تحديث حالة المعاملات المرتبطة بالدين:",a))}catch(a){console.error("تعذر تجهيز تحديث حالة المعاملات المرتبطة:",a)}try{const a=$s(),n=localStorage.getItem(a);if(n){const d=(JSON.parse(n)||[]).map(m=>(m==null?void 0:m.linkedDebtId)===he.id&&(m==null?void 0:m.status)==="pending"?{...m,status:"completed",confirmedAt:new Date}:m);localStorage.setItem(a,JSON.stringify(d)),Tt(m=>m.map(y=>(y==null?void 0:y.linkedDebtId)===he.id&&(y==null?void 0:y.status)==="pending"?{...y,status:"completed",confirmedAt:new Date}:y))}}catch(a){console.warn("فشل تحديث حالة المعاملات المرتبطة محلياً بعد سداد الدين:",a)}Ms(!1),i({title:"تم تحديث حالة الدين",description:"تم تعيين الدين كمدفوع"})}},className:"bg-green-500 hover:bg-green-600",children:"مدفوع"}),e.jsx(c,{onClick:async()=>{if(he){const s=ft.filter(r=>r.id!==he.id);kt(s),await Vt(s),Ms(!1),i({title:"تم حذف الدين",description:"تم حذف الدين بنجاح"})}},variant:"destructive",children:"حذف"})]})]})}),e.jsx(re,{open:wn,onOpenChange:js,children:e.jsxs(le,{className:"sm:max-w-[425px]",children:[e.jsxs(ne,{children:[e.jsx(ie,{className:"text-right",children:"اختيار إضافة مبلغ السداد"}),e.jsx(Gt,{className:"text-right",children:"هل تريد إضافة مبلغ السداد إلى الفلوس النقدية أم إلى إحدى المحافظ؟"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(c,{variant:Pt==="cash"?"default":"outline",className:Pt==="cash"?"bg-blue-600 text-white":"",onClick:()=>ls("cash"),children:"الفلوس النقدية"}),e.jsx(c,{variant:Pt==="wallet"?"default":"outline",className:Pt==="wallet"?"bg-blue-600 text-white":"",onClick:()=>ls("wallet"),children:"أرصدة المحافظ"}),e.jsx(c,{variant:Pt==="none"?"default":"outline",className:Pt==="none"?"bg-gray-600 text-white":"",onClick:()=>ls("none"),children:"بدون إضافة"})]}),Pt==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-right",children:"اختر المحفظة"}),e.jsxs("select",{className:"w-full border rounded p-2 text-right",value:ns,onChange:s=>rr(s.target.value),children:[e.jsx("option",{value:"",children:"— اختر محفظة —"}),me&&me.length>0?me.map(s=>e.jsx("option",{value:s.id,children:s.phone||s.name||s.id},s.id)):Object.keys(ge||{}).map(s=>{var r,a,n,o,d,m;return e.jsx("option",{value:s,children:((r=me.find(y=>y.id===s))==null?void 0:r.phone)||((n=(a=JSON.parse(localStorage.getItem(Ut())||"[]"))==null?void 0:a.find(y=>y.id===s))==null?void 0:n.phone)||((d=(o=JSON.parse(localStorage.getItem(Ut())||"[]"))==null?void 0:o.find(y=>y.id===s))==null?void 0:d.name)||((m=me.find(y=>y.id===s))==null?void 0:m.name)||s},s)})]})]}),e.jsxs("div",{className:"text-right text-sm text-gray-600",children:["المبلغ المراد إضافته: ",e.jsxs("span",{className:"font-bold",children:[tl," جنيه"]})]})]}),e.jsxs(Ce,{className:"flex justify-end",children:[e.jsx(c,{variant:"outline",onClick:()=>{js(!1),da(0),ls(null),rr("")},children:"إلغاء"}),e.jsx(c,{onClick:async()=>{var s,r;try{const a=tl;if(!a||a<=0){js(!1);return}if(Pt==="cash"){const n=Fe+a;Ke(n),localStorage.setItem($e(),n.toString());const o={cashBalance:n,lastUpdated:new Date().toISOString()},d=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(d,JSON.stringify(o)),t!=null&&t.uid?(ve.updateUserData(t.uid,o).catch(()=>de(!0)),localStorage.removeItem(d),de(!1)):de(!0),i({title:"تمت إضافة مبلغ السداد",description:`تمت إضافة ${a} جنيه إلى الفلوس النقدية`})}else if(Pt==="wallet"){if(!ns){i({title:"اختر محفظة أولاً",description:"يرجى اختيار المحفظة لإضافة مبلغ السداد إليها",variant:"destructive"});return}const n={...ge,[ns]:(ge[ns]||0)+a};Ae(n);const o=(Fe||0)-a;Ke(o),localStorage.setItem($e(),o.toString());const d=new Date().toISOString(),m={walletBalances:n,cashBalance:o,lastUpdated:d},y=`userData_${t==null?void 0:t.uid}`;if(localStorage.setItem(y,JSON.stringify(m)),localStorage.setItem(Ee(),JSON.stringify(n)),localStorage.setItem(`walletBalances_backup_${d}`,JSON.stringify(n)),t!=null&&t.uid){ve.updateUserData(t.uid,m).catch(()=>de(!0));try{localStorage.removeItem(y)}catch{}de(!1)}else de(!0);i({title:"تمت إضافة مبلغ السداد",description:`تمت إضافة ${a} جنيه إلى المحفظة ${((s=me.find(C=>C.id===ns))==null?void 0:s.phone)||((r=me.find(C=>C.id===ns))==null?void 0:r.name)||ns} وتم خصم نفس المبلغ من درج النقدية`})}else if(Pt==="none"){const n=(Fe||0)-a;Ke(n),localStorage.setItem($e(),n.toString());const o={cashBalance:n,lastUpdated:new Date().toISOString()},d=`userData_${t==null?void 0:t.uid}`;if(localStorage.setItem(d,JSON.stringify(o)),t!=null&&t.uid){ve.updateUserData(t.uid,o).catch(()=>de(!0));try{localStorage.removeItem(d)}catch{}de(!1)}else de(!0);i({title:"تم تسجيل السداد",description:`تم خصم ${a} جنيه من درج النقدية بدون إضافة للمحافظ`})}else{i({title:"اختر مصدر الإضافة",description:"يرجى اختيار إضافة المبلغ إلى النقدية أو المحفظة",variant:"destructive"});return}}catch(a){console.error("خطأ أثناء إضافة مبلغ السداد:",a),i({title:"حدث خطأ",description:"تعذر إضافة مبلغ السداد، حاول مرة أخرى",variant:"destructive"})}finally{js(!1),da(0),ls(null),rr("")}},className:"bg-green-600 hover:bg-green-700",children:"تأكيد الإضافة"})]})]})})]}))};export{hc as default};
