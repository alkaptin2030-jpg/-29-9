var T=Object.defineProperty;var S=(o,e,a)=>e in o?T(o,e,{enumerable:!0,configurable:!0,writable:!0,value:a}):o[e]=a;var M=(o,e,a)=>S(o,typeof e!="symbol"?e+"":e,a);import{aw as p}from"./index-CMr4Oi63.js";const l={async syncReportsDataFromFirebase(o){try{if(!o)return null;const e=await p.getUserData(o),a=e==null?void 0:e.reportsData;if(!a)return null;const t=`reportsData_${o}`,i=s=>{if(!s)return null;try{return s!=null&&s.toDate?s.toDate():new Date(s)}catch{return null}},n={lastDailyResetDate:i(a.lastDailyResetDate),lastMonthlyResetDate:i(a.lastMonthlyResetDate),hiddenDailyTransactionIds:Array.isArray(a.hiddenDailyTransactionIds)?a.hiddenDailyTransactionIds:[],hiddenMonthlyTransactionIds:Array.isArray(a.hiddenMonthlyTransactionIds)?a.hiddenMonthlyTransactionIds:[],dailyProfit:Number(a.dailyProfit??0),monthlyProfit:Number(a.monthlyProfit??0),lastDailyProfitResetDate:i(a.lastDailyProfitResetDate),lastMonthlyProfitResetDate:i(a.lastMonthlyProfitResetDate)};try{localStorage.setItem(t,JSON.stringify(n))}catch{}return n}catch(e){return console.warn("تعذر مزامنة بيانات التقارير من Firebase:",e),null}},shouldResetDailyReports:o=>{if(!o)return!0;const e=new Date,a=new Date(o);return e.toDateString()!==a.toDateString()},shouldResetMonthlyReports:o=>{if(!o)return!0;const e=new Date,a=new Date(o),t=e.getDate()===1,i=e.getMonth()!==a.getMonth()||e.getFullYear()!==a.getFullYear();return t&&i},autoResetReportsIfNeeded:o=>{try{const e=o?`reportsData_${o}`:"reportsData",a=localStorage.getItem(e);let t={lastDailyResetDate:null,lastMonthlyResetDate:null,hiddenDailyTransactionIds:[],hiddenMonthlyTransactionIds:[],dailyProfit:0,monthlyProfit:0,lastDailyProfitResetDate:null,lastMonthlyProfitResetDate:null};if(a){const s=JSON.parse(a);t={lastDailyResetDate:s.lastDailyResetDate?new Date(s.lastDailyResetDate):null,lastMonthlyResetDate:s.lastMonthlyResetDate?new Date(s.lastMonthlyResetDate):null,hiddenDailyTransactionIds:s.hiddenDailyTransactionIds||[],hiddenMonthlyTransactionIds:s.hiddenMonthlyTransactionIds||[],dailyProfit:s.dailyProfit||0,monthlyProfit:s.monthlyProfit||0,lastDailyProfitResetDate:s.lastDailyProfitResetDate?new Date(s.lastDailyProfitResetDate):null,lastMonthlyProfitResetDate:s.lastMonthlyProfitResetDate?new Date(s.lastMonthlyProfitResetDate):null}}else if(o){const s=localStorage.getItem("reportsData");if(s)try{const r=JSON.parse(s);t={lastDailyResetDate:r.lastDailyResetDate?new Date(r.lastDailyResetDate):null,lastMonthlyResetDate:r.lastMonthlyResetDate?new Date(r.lastMonthlyResetDate):null,hiddenDailyTransactionIds:r.hiddenDailyTransactionIds||[],hiddenMonthlyTransactionIds:r.hiddenMonthlyTransactionIds||[],dailyProfit:r.dailyProfit||0,monthlyProfit:r.monthlyProfit||0,lastDailyProfitResetDate:r.lastDailyProfitResetDate?new Date(r.lastDailyProfitResetDate):null,lastMonthlyProfitResetDate:r.lastMonthlyProfitResetDate?new Date(r.lastMonthlyProfitResetDate):null},localStorage.setItem(e,JSON.stringify(t))}catch(r){console.error("خطأ في مهاجرة بيانات التقارير القديمة:",r)}}let i=!1,n=!1;if(t.lastDailyResetDate?l.shouldResetDailyReports(t.lastDailyResetDate)&&(t.hiddenDailyTransactionIds=[],t.lastDailyResetDate=new Date,i=!0,console.log("تم تصفير التقارير اليومية تلقائياً")):t.lastDailyResetDate=new Date,t.lastDailyProfitResetDate?l.shouldResetDailyReports(t.lastDailyProfitResetDate)&&(t.dailyProfit=0,t.lastDailyProfitResetDate=new Date,console.log("تم تصفير الأرباح اليومية تلقائياً")):t.lastDailyProfitResetDate=new Date,t.lastMonthlyResetDate?l.shouldResetMonthlyReports(t.lastMonthlyResetDate)&&(t.hiddenMonthlyTransactionIds=[],t.lastMonthlyResetDate=new Date,n=!0,console.log("تم تصفير التقارير الشهرية تلقائياً")):t.lastMonthlyResetDate=new Date,t.lastMonthlyProfitResetDate?l.shouldResetMonthlyReports(t.lastMonthlyProfitResetDate)&&(t.monthlyProfit=0,t.lastMonthlyProfitResetDate=new Date,console.log("تم تصفير الأرباح الشهرية تلقائياً")):t.lastMonthlyProfitResetDate=new Date,localStorage.setItem(e,JSON.stringify(t)),o)try{p.updateUserData(o,{reportsData:{...t}})}catch(s){console.warn("تعذر تحديث بيانات التقارير في Firebase بعد التصفير التلقائي:",s)}return{dailyReset:i,monthlyReset:n}}catch(e){return console.error("خطأ في التصفير التلقائي للتقارير:",e),{dailyReset:!1,monthlyReset:!1}}},resetReportsManually:(o,e,a)=>{try{const t=a?`reportsData_${a}`:"reportsData",i=localStorage.getItem(t);let n={lastDailyResetDate:null,lastMonthlyResetDate:null,hiddenDailyTransactionIds:[],hiddenMonthlyTransactionIds:[],dailyProfit:0,monthlyProfit:0,lastDailyProfitResetDate:null,lastMonthlyProfitResetDate:null};if(i){const r=JSON.parse(i);n={lastDailyResetDate:r.lastDailyResetDate?new Date(r.lastDailyResetDate):null,lastMonthlyResetDate:r.lastMonthlyResetDate?new Date(r.lastMonthlyResetDate):null,hiddenDailyTransactionIds:r.hiddenDailyTransactionIds||[],hiddenMonthlyTransactionIds:r.hiddenMonthlyTransactionIds||[],dailyProfit:r.dailyProfit||0,monthlyProfit:r.monthlyProfit||0,lastDailyProfitResetDate:r.lastDailyProfitResetDate?new Date(r.lastDailyProfitResetDate):null,lastMonthlyProfitResetDate:r.lastMonthlyProfitResetDate?new Date(r.lastMonthlyProfitResetDate):null}}let s=[];if(o==="daily"){const r=new Date().toDateString();s=e.filter(D=>new Date(D.createdAt).toDateString()===r).map(D=>D.id),n.hiddenDailyTransactionIds=[...new Set([...n.hiddenDailyTransactionIds,...s])],n.lastDailyResetDate=new Date,n.dailyProfit=0,n.lastDailyProfitResetDate=new Date}else{const r=new Date().getMonth(),D=new Date().getFullYear();s=e.filter(d=>{const m=new Date(d.createdAt);return m.getMonth()===r&&m.getFullYear()===D}).map(d=>d.id),n.hiddenMonthlyTransactionIds=[...new Set([...n.hiddenMonthlyTransactionIds,...s])],n.lastMonthlyResetDate=new Date,n.monthlyProfit=0,n.lastMonthlyProfitResetDate=new Date}if(localStorage.setItem(t,JSON.stringify(n)),a)try{p.updateUserData(a,{reportsData:{...n}})}catch(r){console.warn("تعذر تحديث بيانات التقارير في Firebase بعد التصفير اليدوي:",r)}return console.log(`تم تصفير التقارير ${o==="daily"?"اليومية":"الشهرية"} يدوياً`),s}catch(t){return console.error("خطأ في التصفير اليدوي للتقارير:",t),[]}},getReportsData:o=>{try{const e=o?`reportsData_${o}`:"reportsData",a=localStorage.getItem(e);if(!a)return{lastDailyResetDate:null,lastMonthlyResetDate:null,hiddenDailyTransactionIds:[],hiddenMonthlyTransactionIds:[],dailyProfit:0,monthlyProfit:0,lastDailyProfitResetDate:null,lastMonthlyProfitResetDate:null};const t=JSON.parse(a);return{lastDailyResetDate:t.lastDailyResetDate?new Date(t.lastDailyResetDate):null,lastMonthlyResetDate:t.lastMonthlyResetDate?new Date(t.lastMonthlyResetDate):null,hiddenDailyTransactionIds:t.hiddenDailyTransactionIds||[],hiddenMonthlyTransactionIds:t.hiddenMonthlyTransactionIds||[],dailyProfit:t.dailyProfit||0,monthlyProfit:t.monthlyProfit||0,lastDailyProfitResetDate:t.lastDailyProfitResetDate?new Date(t.lastDailyProfitResetDate):null,lastMonthlyProfitResetDate:t.lastMonthlyProfitResetDate?new Date(t.lastMonthlyProfitResetDate):null}}catch(e){return console.error("خطأ في قراءة بيانات التقارير:",e),{lastDailyResetDate:null,lastMonthlyResetDate:null,hiddenDailyTransactionIds:[],hiddenMonthlyTransactionIds:[],dailyProfit:0,monthlyProfit:0,lastDailyProfitResetDate:null,lastMonthlyProfitResetDate:null}}},filterVisibleTransactions:(o,e,a)=>{try{const t=l.getReportsData(a),i=e==="daily"?t.hiddenDailyTransactionIds:t.hiddenMonthlyTransactionIds;return o.filter(n=>!i.includes(n.id))}catch(t){return console.error("خطأ في تصفية المعاملات:",t),o}},addProfit:(o,e,a)=>{try{const t=a?`reportsData_${a}`:"reportsData",i=l.getReportsData(a);if(e==="daily"?i.dailyProfit+=o:i.monthlyProfit+=o,localStorage.setItem(t,JSON.stringify(i)),a)try{p.updateUserData(a,{reportsData:{...i}})}catch(n){console.warn("تعذر مزامنة أرباح التقارير مع Firebase:",n)}}catch(t){console.error("خطأ في إضافة الربح:",t)}},getProfits:o=>{try{const e=l.getReportsData(o);return{dailyProfit:e.dailyProfit,monthlyProfit:e.monthlyProfit}}catch(e){return console.error("خطأ في قراءة الأرباح:",e),{dailyProfit:0,monthlyProfit:0}}},removeTransactionEffects:(o,e)=>{try{const a=e?`reportsData_${e}`:"reportsData",t=l.getReportsData(e),i=new Date(o.createdAt),n=new Date,s=n.getMonth(),r=n.getFullYear(),D=l.calculateTransactionProfit(o);if(i.toDateString()===n.toDateString()&&((t.hiddenDailyTransactionIds||[]).includes(o.id)||(t.dailyProfit=Math.round((t.dailyProfit-D)*100)/100,t.dailyProfit<0&&(t.dailyProfit=0))),i.getMonth()===s&&i.getFullYear()===r&&((t.hiddenMonthlyTransactionIds||[]).includes(o.id)||(t.monthlyProfit=Math.round((t.monthlyProfit-D)*100)/100,t.monthlyProfit<0&&(t.monthlyProfit=0))),localStorage.setItem(a,JSON.stringify(t)),e)try{p.updateUserData(e,{reportsData:{...t}})}catch(d){console.warn("تعذر مزامنة خصم تأثيرات المعاملة مع Firebase:",d)}}catch(a){console.error("خطأ في خصم تأثيرات المعاملة من التقارير:",a)}},calculateTransactionProfit:o=>{const e=Number((o==null?void 0:o.fee)??0);if(o.commission!==void 0){const i=Math.max(0,Number(o.commission||0));return Math.round((i+Math.max(0,e))*100)/100}const a=String(o.type||"").toLowerCase(),t=a==="withdrawal"?"withdraw":a;if(t==="withdraw"||t==="receive"||t==="send"||t==="transfer"){const i=Math.round(Number(o.amount||0)*.01*100)/100;return Math.round((i+Math.max(0,e))*100)/100}return 0}},_=l,F=Object.freeze(Object.defineProperty({__proto__:null,ReportsService:_,reportsService:l},Symbol.toStringTag,{value:"Module"}));class g{static getProfitPinKey(e){return e?`${this.PROFIT_PIN_KEY_BASE}_${e}`:this.PROFIT_PIN_KEY_BASE}static getMasterPinKey(e){return e?`${this.MASTER_PIN_KEY_BASE}_${e}`:this.MASTER_PIN_KEY_BASE}static setProfitPin(e,a){console.warn("setProfitPin is deprecated. Using master PIN instead.")}static hasProfitPin(e){try{const a=localStorage.getItem(this.getMasterPinKey(e));return!!a&&a.length>0}catch{return!1}}static verifyProfitPin(e,a){try{const t=localStorage.getItem(this.getMasterPinKey(a));return t?atob(t)===e:!1}catch{return!1}}static getProfitData(e){l.autoResetReportsIfNeeded(e);const a=l.getProfits(e),t=this.getWithdrawTransferProfits(e);return{dailyProfit:a.dailyProfit,monthlyProfit:a.monthlyProfit,dailyWithdrawProfit:t.dailyWithdrawProfit,monthlyWithdrawProfit:t.monthlyWithdrawProfit,dailyTransferProfit:t.dailyTransferProfit,monthlyTransferProfit:t.monthlyTransferProfit,lastUpdated:new Date}}static addProfit(e,a){l.addProfit(e,"daily",a),l.addProfit(e,"monthly",a)}static calculateProfitFromTransaction(e){return l.calculateTransactionProfit(e)}static resetProfits(e,a,t){if(!this.verifyProfitPin(a,t))return!1;const i=t?`reportsData_${t}`:"reportsData",n=l.getReportsData(t);if(e==="daily"?(n.dailyProfit=0,n.lastDailyProfitResetDate=new Date):(n.monthlyProfit=0,n.lastMonthlyProfitResetDate=new Date),localStorage.setItem(i,JSON.stringify(n)),t)try{p.updateUserData(t,{reportsData:{...n}})}catch(s){console.warn("تعذر مزامنة تصفير الأرباح مع Firebase:",s)}return!0}static clearProfitPin(e){localStorage.removeItem(this.getProfitPinKey(e))}static updateProfitsFromTransactions(e,a){const t=a?`reportsData_${a}`:"reportsData",i=l.getReportsData(a);let n=0,s=0;const r=new Date,D=r.getMonth(),d=r.getFullYear(),m=l.filterVisibleTransactions(e,"daily",a),w=l.filterVisibleTransactions(e,"monthly",a);if(m.forEach(c=>{const y=new Date(c.createdAt),P=String(c.status||"confirmed").toLowerCase();if(y.toDateString()!==r.toDateString()||P!=="completed"&&P!=="confirmed")return;const h=String(c.type||c.txnType||"").toLowerCase(),R={type:h==="withdrawal"?"withdraw":h,amount:Number(c.amount||0),commission:c.commission};n+=this.calculateProfitFromTransaction(R)}),w.forEach(c=>{const y=new Date(c.createdAt),P=String(c.status||"confirmed").toLowerCase();if(y.getMonth()!==D||y.getFullYear()!==d||P!=="completed"&&P!=="confirmed")return;const h=String(c.type||c.txnType||"").toLowerCase(),R={type:h==="withdrawal"?"withdraw":h,amount:Number(c.amount||0),commission:c.commission};s+=this.calculateProfitFromTransaction(R)}),i.dailyProfit=Math.round(n*100)/100,i.monthlyProfit=Math.round(s*100)/100,localStorage.setItem(t,JSON.stringify(i)),a)try{p.updateUserData(a,{reportsData:{...i}})}catch(c){console.warn("تعذر مزامنة تحديث الأرباح من المعاملات مع Firebase:",c)}}static getWithdrawTransferProfits(e){l.getReportsData(e);const a=new Date,t=a.getMonth(),i=a.getFullYear(),n=`transactions_${e||"default"}`,s=JSON.parse(localStorage.getItem(n)||"[]");let r=0,D=0,d=0,m=0;const w=l.filterVisibleTransactions(s,"daily",e),c=l.filterVisibleTransactions(s,"monthly",e);return w.forEach(y=>{const P=new Date(y.createdAt),h=String(y.status||"confirmed").toLowerCase();if(P.toDateString()!==a.toDateString()||h!=="completed"&&h!=="confirmed")return;const u=String(y.type||y.txnType||"").toLowerCase(),f={type:u==="withdrawal"?"withdraw":u,amount:Number(y.amount||0),commission:y.commission};f.type==="withdraw"?r+=this.calculateProfitFromTransaction(f):(f.type==="receive"||f.type==="send"||f.type==="transfer")&&(d+=this.calculateProfitFromTransaction(f))}),c.forEach(y=>{const P=new Date(y.createdAt),h=String(y.status||"confirmed").toLowerCase();if(P.getMonth()!==t||P.getFullYear()!==i||h!=="completed"&&h!=="confirmed")return;const u=String(y.type||y.txnType||"").toLowerCase(),f={type:u==="withdrawal"?"withdraw":u,amount:Number(y.amount||0),commission:y.commission};f.type==="withdraw"?D+=this.calculateProfitFromTransaction(f):(f.type==="receive"||f.type==="send"||f.type==="transfer")&&(m+=this.calculateProfitFromTransaction(f))}),{dailyWithdrawProfit:Math.round(r*100)/100,monthlyWithdrawProfit:Math.round(D*100)/100,dailyTransferProfit:Math.round(d*100)/100,monthlyTransferProfit:Math.round(m*100)/100}}}M(g,"PROFIT_PIN_KEY_BASE","profit_pin"),M(g,"MASTER_PIN_KEY_BASE","master_pin");const N=Object.freeze(Object.defineProperty({__proto__:null,ProfitService:g},Symbol.toStringTag,{value:"Module"}));export{g as P,F as a,N as p,l as r};
