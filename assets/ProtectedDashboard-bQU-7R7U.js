import{_ as Be,c as Oe,u as Ae,ab as Pe,ac as Le,ad as H,r as s,j as e,B as P,ae as Fe,af as Re,p as ve,I as L,C as _e,aa as J,v as X,f as q,ag as Me,K as $e,H as ze,w as Ke,O as Ue,a as Ve,ah as ye}from"./index-5EflPS7Y.js";import{C as v,a as y,b as w,d as S}from"./card-DXPppts9.js";import{B as He}from"./badge-DZ4fmRLR.js";import{S as G,a as Q,b as Y,c as Z,d as u}from"./select-3q_346E_.js";import{M as Je}from"./MasterPinDialog-DQOde7Hj.js";import{D as we}from"./dollar-sign-Cmw8CMzs.js";import{W as Xe}from"./wallet-NIRbOtei.js";import{C as qe}from"./circle-check-big-DzztOUK9.js";import{C as Ge}from"./circle-x-BJ7R2vQm.js";import"./Combination-vrlhZqzc.js";import"./index-R9UGA7TY.js";import"./label-BbMWBagC.js";import"./dialog-CY7KVlhj.js";import"./shield-Aq4l2F3b.js";import"./circle-alert-L2Owt6-y.js";const Qe=()=>{const x=Be(),{toast:h}=Oe(),{signOut:F,user:n,profile:D}=Ae(),{isShiftActive:Se,shiftUser:ee}=Pe(),N=Le(),R=(typeof H<"u"&&typeof H.getPlatform=="function"?H.getPlatform():"web")==="android"||/Android/i.test(typeof navigator<"u"?navigator.userAgent:""),[m,C]=s.useState("01030302038"),[c,_]=s.useState(""),[M,$]=s.useState(""),[p,te]=s.useState("transfer"),[z,se]=s.useState("vodafone_cash"),[K,ae]=s.useState("vodafone_cash"),[ne,U]=s.useState(""),[f,le]=s.useState([]),[Ye,Ze]=s.useState("all"),[et,tt]=s.useState(!1),[De,st]=s.useState(""),[re,at]=s.useState([]),[nt,lt]=s.useState(null),[rt,it]=s.useState(!1),[ot,ct]=s.useState([]),[dt,mt]=s.useState([]),[ut,ht]=s.useState(!1),[xt,pt]=s.useState("daily"),[ft,T]=s.useState([]),[ie,g]=s.useState(0),[I,b]=s.useState({}),[gt,bt]=s.useState(!1),[jt,vt]=s.useState(!1),[yt,wt]=s.useState(!1),[St,Dt]=s.useState(!1),[Nt,Tt]=s.useState(!1),[It,Wt]=s.useState(""),[Ct,kt]=s.useState(!1),[Ne,V]=s.useState(!1),[k,oe]=s.useState(()=>{try{const t=n!=null&&n.uid?`dailyReportsLockEnabled_${n==null?void 0:n.uid}`:"dailyReportsLockEnabled";return(localStorage.getItem(t)??localStorage.getItem("dailyReportsLockEnabled"))==="true"}catch{return!1}}),[Te,E]=s.useState(!1),[Ie,We]=s.useState(!1),i=t=>{const a="٠١٢٣٤٥٦٧٨٩",l="۰۱۲۳۴۵۶۷۸۹";return(t||"").split("").map(o=>{const r=a.indexOf(o);if(r>-1)return String(r);const d=l.indexOf(o);return d>-1?String(d):o}).join("")},ce=t=>{const a=i(t).replace(/\D/g,"");return a.startsWith("010")?"vodafone_cash":a.startsWith("011")?"etisalat_cash":a.startsWith("012")?"orange_cash":null};s.useEffect(()=>{const t=ce(m);t&&t!==z&&se(t)},[m]),s.useEffect(()=>{const t=ce(c);t&&t!==K&&ae(t)},[c]),s.useEffect(()=>{try{const t=n!=null&&n.uid?`dailyReportsLockEnabled_${n==null?void 0:n.uid}`:"dailyReportsLockEnabled",a=localStorage.getItem(t)??localStorage.getItem("dailyReportsLockEnabled");oe(a==="true")}catch{}},[n==null?void 0:n.uid]),s.useEffect(()=>{const t=x.state||{};t!=null&&t.openTransactionSection&&(((t==null?void 0:t.transactionType)==="withdraw"||(t==null?void 0:t.transactionType)==="transfer")&&te(t.transactionType),We(!0),t!=null&&t.startNewTransaction&&(C("01030302038"),_(""),$(""),U("")),setTimeout(()=>{window.scrollTo({top:0,behavior:"smooth"})},50))},[x.state]);const de=async t=>{if(n)try{const a=await J.getById(n.uid);if(a!=null&&a.shopId){const l=X(q,"dashboardData",a.shopId);await Ue(l,t)}}catch(a){console.error("Error saving to Firebase:",a),h({title:"خطأ في الحفظ",description:"حدث خطأ أثناء حفظ البيانات في Firebase",variant:"destructive"})}};s.useEffect(()=>{if(!n)return;(async()=>{V(!0);try{const a=await J.getById(n.uid);if(a!=null&&a.shopId){const l=X(q,"dashboardData",a.shopId);try{const r=await Me(l);if(r.exists()){const d=r.data();g(d.cashBalance||0),b(d.walletBalances||{}),T(d.deletedTransactions||[]),V(!1)}}catch{}const o=await $e(l);if(o.exists()){const r=o.data();g(r.cashBalance||0),b(r.walletBalances||{}),T(r.deletedTransactions||[])}else{const r={walletBalances:{},deletedTransactions:[]};await ze(l,r),g(0),b(r.walletBalances),T(r.deletedTransactions)}}}catch(a){console.error("Error loading data from Firebase:",a),g(0),b({}),T([])}finally{V(!1)}})()},[n]),s.useEffect(()=>{if(!n)return;let t=null;return(async()=>{try{const l=await J.getById(n.uid);if(l!=null&&l.shopId){const o=X(q,"dashboardData",l.shopId);t=Ke(o,{includeMetadataChanges:!0},r=>{if(r.exists()){const d=r.data();g(d.cashBalance||0),b(d.walletBalances||{}),T(d.deletedTransactions||[])}},r=>{console.error("Error subscribing to dashboardData:",r)})}}catch(l){console.error("Error initializing realtime dashboard subscription:",l)}})(),()=>{t&&t()}},[n==null?void 0:n.uid]);const Ce=async t=>{if(t.preventDefault(),p==="transfer"){if(!m||!c||!M){h({title:"خطأ",description:"يرجى ملء جميع الحقول المطلوبة",variant:"destructive"});return}const a=(D==null?void 0:D.shopName)||(n==null?void 0:n.displayName)||"محل كاشي لينك",l=re.find(A=>A.id===De)||re.find(A=>A.isDefault),o=i(m||"").replace(/\D/g,""),r=i(c||"").replace(/\D/g,""),d=z===K,me=o.startsWith("010")&&(r.startsWith("011")||r.startsWith("012")||r.startsWith("015"))||o.startsWith("012")&&r.startsWith("010")||o.startsWith("011")&&r.startsWith("010")||o.startsWith("015")&&r.startsWith("010"),j=d?1:me?parseFloat(ne||"0"):0;if(me&&(Number.isNaN(j)||j<=0)){h({title:"خطأ",description:"أدخل رسوم التحويل لعمليات 010 → 011/012/015 أو 012 → 010 أو 011 → 010 أو 015 → 010",variant:"destructive"});return}if(!l){h({title:"لا توجد محفظة",description:"يرجى اختيار محفظة لإتمام التحويل",variant:"destructive"});return}const B=parseFloat(M),ue=B+j,he=I[l.id]||0;if(he<ue){h({title:"رصيد المحفظة غير كافٍ",description:`الرصيد الحالي ${he} لا يكفي لخصم ${ue}`,variant:"destructive"});return}const xe={id:Date.now().toString(),type:"send",senderPhone:m,receiverPhone:c,amount:B,status:"pending",createdAt:new Date,withdrawnAmount:0,sentAmount:B,merchantShopName:a,shopName:(l==null?void 0:l.name)||"المحفظة الرئيسية",commission:0,fee:j,fromWallet:l.id},pe=[xe,...f];le(pe);const ke=B+j,O=l==null?void 0:l.id,Ee=O&&I[O]||0,fe=O?{...I,[O]:Ee-ke}:I;b(fe),await de({transactions:pe,walletBalances:fe}),h({title:"تم إرسال التحويل",description:"جاري معالجة التحويل..."}),setTimeout(async()=>{const ge=[{...xe,status:"completed"},...f];le(ge);const be=j,je=ie+(Number.isFinite(be)?be:0);g(je),await de({transactions:ge,cashBalance:je})},2e3),C("01030302038"),_(""),$(""),U("")}};return e.jsxs("div",{className:"min-h-screen bg-background p-4",children:[Ne&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white p-6 rounded-lg",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"}),e.jsx("p",{className:"mt-2 text-center",children:"جاري تحميل البيانات..."})]})}),e.jsxs("div",{className:"max-w-7xl mx-auto space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"لوحة تحكم الإدارة"}),e.jsxs(P,{onClick:F,variant:"outline",className:"flex items-center gap-2",children:[e.jsx(Fe,{className:"h-4 w-4"}),"تسجيل الخروج"]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-6",children:[e.jsxs(v,{children:[e.jsxs(y,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(w,{className:"text-sm font-medium",children:"الرصيد النقدي"}),e.jsx(we,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(S,{children:e.jsxs("div",{className:"text-2xl font-bold",children:[ie.toLocaleString()," جنيه"]})})]}),e.jsxs(v,{children:[e.jsxs(y,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(w,{className:"text-sm font-medium",children:"الأرصدة علي المحافظ"}),e.jsx(Xe,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(S,{children:e.jsxs("div",{className:"text-2xl font-bold",children:[Object.values(I).reduce((t,a)=>t+a,0).toLocaleString()," جنيه"]})})]}),e.jsxs(v,{className:"relative",children:[e.jsxs(y,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(w,{className:"text-sm font-medium",children:"المعاملات اليوم"}),e.jsx(Re,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(S,{className:k?"filter blur-sm pointer-events-none":"",children:e.jsx("div",{className:"text-2xl font-bold",children:f.length})}),k&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center rounded-lg bg-yellow-100/60",children:e.jsxs(P,{size:"sm",variant:"ghost",onClick:()=>E(!0),className:"flex items-center gap-2 bg-yellow-200/70 hover:bg-yellow-300 text-yellow-900 px-3 py-2 rounded-xl shadow-md hover:shadow-lg transition-all",title:"عرض تقارير اليوم",children:[e.jsx(ve,{className:"h-5 w-5"}),e.jsx("span",{className:"text-xs",children:"عرض تقارير اليوم"})]})})]}),e.jsxs(v,{className:"relative",children:[e.jsxs(y,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(w,{className:"text-sm font-medium",children:"إجمالي اليوم"}),e.jsx(we,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(S,{className:k?"filter blur-sm pointer-events-none":"",children:e.jsxs("div",{className:"text-2xl font-bold",children:[f.reduce((t,a)=>t+a.amount,0).toLocaleString()," جنيه"]})}),k&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center rounded-lg bg-yellow-100/60",children:e.jsxs(P,{size:"sm",variant:"ghost",onClick:()=>E(!0),className:"flex items-center gap-2 bg-yellow-200/70 hover:bg-yellow-300 text-yellow-900 px-3 py-2 rounded-xl shadow-md hover:shadow-lg transition-all",title:"عرض تقارير اليوم",children:[e.jsx(ve,{className:"h-5 w-5"}),e.jsx("span",{className:"text-xs",children:"عرض تقارير اليوم"})]})})]}),e.jsx(Je,{open:Te,onOpenChange:E,mode:"verify",title:"قفل تقارير اليوم",description:"لا يمكن الاطلاع على تقارير اليوم إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{oe(!1),E(!1)}})]}),e.jsxs(v,{className:N&&Ie?"sticky top-0 z-40 shadow-lg bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/70":"",children:[e.jsx(y,{children:e.jsx(w,{children:"إجراء معاملة جديدة"})}),e.jsx(S,{children:e.jsxs("form",{onSubmit:Ce,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"نوع المعاملة"}),e.jsxs(G,{value:p,onValueChange:t=>te(t),children:[e.jsx(Q,{children:e.jsx(Y,{})}),e.jsxs(Z,{children:[e.jsx(u,{value:"transfer",children:"تحويل"}),e.jsx(u,{value:"withdraw",children:"سحب"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"رقم المرسل"}),e.jsx(L,{type:"tel",value:m,onChange:t=>C(t.target.value),onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("receiverPhoneInput");if(a)a.focus();else{const l=document.getElementById("amountInput");l==null||l.focus()}}},placeholder:"01xxxxxxxxx"})]}),p==="transfer"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"رقم المستقبل"}),e.jsx(L,{id:"receiverPhoneInput",type:"tel",value:c,onChange:t=>_(t.target.value),onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("amountInput");a==null||a.focus()}},placeholder:"01xxxxxxxxx"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"شركة المرسل"}),e.jsxs(G,{value:z,onValueChange:t=>se(t),children:[e.jsx(Q,{children:e.jsx(Y,{})}),e.jsxs(Z,{children:[e.jsx(u,{value:"vodafone_cash",children:"فودافون"}),e.jsx(u,{value:"etisalat_cash",children:"اتصالات"}),e.jsx(u,{value:"orange_cash",children:"أورانج"}),e.jsx(u,{value:"instapay",children:"إنستاباي"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"شركة المستقبل"}),e.jsxs(G,{value:K,onValueChange:t=>ae(t),children:[e.jsx(Q,{children:e.jsx(Y,{})}),e.jsxs(Z,{children:[e.jsx(u,{value:"vodafone_cash",children:"فودافون"}),e.jsx(u,{value:"etisalat_cash",children:"اتصالات"}),e.jsx(u,{value:"orange_cash",children:"أورانج"}),e.jsx(u,{value:"instapay",children:"إنستاباي"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"المبلغ"}),e.jsx(L,{id:"amountInput",type:"number",value:M,onChange:t=>$(t.target.value),onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("txSubmitButton");a==null||a.focus()}},placeholder:"0.00"})]}),p==="transfer"&&(i(m||"").replace(/\D/g,"").startsWith("010")&&(i(c||"").replace(/\D/g,"").startsWith("011")||i(c||"").replace(/\D/g,"").startsWith("012")||i(c||"").replace(/\D/g,"").startsWith("015"))||i(m||"").replace(/\D/g,"").startsWith("012")&&i(c||"").replace(/\D/g,"").startsWith("010")||i(m||"").replace(/\D/g,"").startsWith("011")&&i(c||"").replace(/\D/g,"").startsWith("010")||i(m||"").replace(/\D/g,"").startsWith("015")&&i(c||"").replace(/\D/g,"").startsWith("010"))&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"رسوم التحويل"}),e.jsx(L,{type:"number",value:ne,onChange:t=>U(t.target.value),placeholder:"0.00"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"تُخصم من المحفظة وتضاف للدرج"})]})]}),e.jsx(P,{id:"txSubmitButton",type:"submit",className:`w-full ${p==="transfer"?"btn-transfer-confirm":"btn-withdraw-confirm"}`,children:p==="transfer"?"إرسال التحويل":"تنفيذ السحب"})]})})]}),e.jsxs(v,{children:[e.jsx(y,{children:e.jsx(w,{children:"المعاملات الأخيرة"})}),e.jsx(S,{children:f.length===0?e.jsx("p",{className:"text-sm text-gray-500",children:"لا توجد معاملات حديثة."}):e.jsx("div",{className:N||R?"receipts-list space-y-4 max-h-[310px] overflow-y-auto pr-1 scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400":"receipts-list space-y-4",children:f.map(t=>e.jsxs("div",{className:"receipts-row flex items-center justify-between p-4 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[t.status==="completed"&&e.jsx(qe,{className:`h-5 w-5 ${t.type==="withdraw"?"text-red-500":"text-green-500"}`}),t.status==="pending"&&e.jsx(_e,{className:"h-5 w-5 text-yellow-500"}),t.status==="failed"&&e.jsx(Ge,{className:"h-5 w-5 text-red-500"})]}),e.jsxs("div",{children:[e.jsxs("p",{className:`font-medium ${t.type==="send"?"text-green-700":"text-red-700"}`,children:[t.type==="send"?"تحويل":"سحب"," - ",t.amount.toLocaleString()," جنيه"]}),e.jsxs("p",{className:`text-sm ${t.type==="send"?"text-green-600":"text-red-500"}`,children:["من ",t.senderPhone," إلى ",t.receiverPhone]})]})]}),e.jsx(He,{variant:t.status==="completed"?"default":t.status==="pending"?"secondary":"destructive",children:t.status==="completed"?"مكتمل":t.status==="pending"?"قيد المعالجة":"فشل"})]},t.id))})})]})]})]})},Ht=()=>{const x=Ve(),[h,F]=s.useState(!1),[n,D]=s.useState(!0);return s.useEffect(()=>{(()=>{const ee=localStorage.getItem("dashboardAuth"),N=localStorage.getItem("dashboardUser");if(ee==="true"&&N)try{const W=JSON.parse(N),R=new Date(W.loginTime);(new Date().getTime()-R.getTime())/(1e3*60*60)<24?F(!0):(localStorage.removeItem("dashboardAuth"),localStorage.removeItem("dashboardUser"),x("/dashboard/login"))}catch(W){console.error("Error parsing user data:",W),x("/dashboard/login")}else x("/dashboard/login");D(!1)})()},[x]),n?e.jsx(ye,{}):h?e.jsx(Qe,{}):e.jsx(ye,{})};export{Ht as default};
