import{J as X,r as i,j as e,a1 as je,a3 as $,a7 as Ne,a$ as B,Y as W,u as Q,c as Z,I as R,B as N,E as _,p as U,aB as Pe,aC as Se,b4 as be,a as ye,ab as Ce,M as ke,ai as Ee,ae as Ae}from"./index-Bp5r4OnK.js";import{L as Ie,D as Le,a as De,b as Me,c as Oe,d as F,e as D}from"./dropdown-menu-DHvHQpSY.js";import{D as ee,a as se,b as te,c as ae,e as Re,d as _e}from"./dialog-vGJZIRWz.js";import{L as T}from"./label-C3jr878i.js";import{M as Ue}from"./MasterPinDialog-DbZV4-13.js";import{g as Fe}from"./avatars-CQGTrUQX.js";import{S as Te}from"./shield-UNnwisJ-.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const gs=X("Activity",[["path",{d:"M22 12h-2.48a2 2 0 0 0-1.93 1.46l-2.35 8.36a.25.25 0 0 1-.48 0L9.24 2.18a.25.25 0 0 0-.48 0l-2.35 8.36A2 2 0 0 1 4.49 12H2",key:"169zse"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ge=X("CloudDownload",[["path",{d:"M12 13v8l-4-4",key:"1f5nwf"}],["path",{d:"m12 21 4-4",key:"1lfcce"}],["path",{d:"M4.393 15.269A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.436 8.284",key:"ui1hmy"}]]);var re={exports:{}},ne={};/**
 * @license React
 * use-sync-external-store-shim.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var C=i;function Be(a,t){return a===t&&(a!==0||1/a===1/t)||a!==a&&t!==t}var $e=typeof Object.is=="function"?Object.is:Be,We=C.useState,Ke=C.useEffect,Ve=C.useLayoutEffect,ze=C.useDebugValue;function He(a,t){var s=t(),c=We({inst:{value:s,getSnapshot:t}}),n=c[0].inst,o=c[1];return Ve(function(){n.value=s,n.getSnapshot=t,G(n)&&o({inst:n})},[a,s,t]),Ke(function(){return G(n)&&o({inst:n}),a(function(){G(n)&&o({inst:n})})},[a]),ze(s),s}function G(a){var t=a.getSnapshot;a=a.value;try{var s=t();return!$e(a,s)}catch{return!0}}function Ye(a,t){return t()}var qe=typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"?Ye:He;ne.useSyncExternalStore=C.useSyncExternalStore!==void 0?C.useSyncExternalStore:qe;re.exports=ne;var Je=re.exports;function Xe(){return Je.useSyncExternalStore(Qe,()=>!0,()=>!1)}function Qe(){return()=>{}}var K="Avatar",[Ze]=je(K),[es,oe]=Ze(K),ie=i.forwardRef((a,t)=>{const{__scopeAvatar:s,...c}=a,[n,o]=i.useState("idle");return e.jsx(es,{scope:s,imageLoadingStatus:n,onImageLoadingStatusChange:o,children:e.jsx($.span,{...c,ref:t})})});ie.displayName=K;var ce="AvatarImage",le=i.forwardRef((a,t)=>{const{__scopeAvatar:s,src:c,onLoadingStatusChange:n=()=>{},...o}=a,x=oe(ce,s),h=ss(c,o),m=Ne(w=>{n(w),x.onImageLoadingStatusChange(w)});return B(()=>{h!=="idle"&&m(h)},[h,m]),h==="loaded"?e.jsx($.img,{...o,ref:t,src:c}):null});le.displayName=ce;var de="AvatarFallback",ue=i.forwardRef((a,t)=>{const{__scopeAvatar:s,delayMs:c,...n}=a,o=oe(de,s),[x,h]=i.useState(c===void 0);return i.useEffect(()=>{if(c!==void 0){const m=window.setTimeout(()=>h(!0),c);return()=>window.clearTimeout(m)}},[c]),x&&o.imageLoadingStatus!=="loaded"?e.jsx($.span,{...n,ref:t}):null});ue.displayName=de;function J(a,t){return a?t?(a.src!==t&&(a.src=t),a.complete&&a.naturalWidth>0?"loaded":"loading"):"error":"idle"}function ss(a,{referrerPolicy:t,crossOrigin:s}){const c=Xe(),n=i.useRef(null),o=c?(n.current||(n.current=new window.Image),n.current):null,[x,h]=i.useState(()=>J(o,a));return B(()=>{h(J(o,a))},[o,a]),B(()=>{const m=A=>()=>{h(A)};if(!o)return;const w=m("loaded"),S=m("error");return o.addEventListener("load",w),o.addEventListener("error",S),t&&(o.referrerPolicy=t),typeof s=="string"&&(o.crossOrigin=s),()=>{o.removeEventListener("load",w),o.removeEventListener("error",S)}},[o,s,t]),x}var me=ie,he=le,fe=ue;const we=i.forwardRef(({className:a,...t},s)=>e.jsx(me,{ref:s,className:W("relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",a),...t}));we.displayName=me.displayName;const ge=i.forwardRef(({className:a,...t},s)=>e.jsx(he,{ref:s,className:W("aspect-square h-full w-full",a),...t}));ge.displayName=he.displayName;const xe=i.forwardRef(({className:a,...t},s)=>e.jsx(fe,{ref:s,className:W("flex h-full w-full items-center justify-center rounded-full bg-muted",a),...t}));xe.displayName=fe.displayName;function ts({open:a,onOpenChange:t}){const{user:s}=Q(),{toast:c}=Z(),[n,o]=i.useState(!1),[x,h]=i.useState(!1),[m,w]=i.useState(!1),[S,A]=i.useState(!1),[V,b]=i.useState(!1),[z,y]=i.useState(!1),[g,I]=i.useState({currentPassword:"",newPassword:"",confirmPassword:""}),[d,p]=i.useState({currentPassword:"",newPassword:"",confirmPassword:""}),M=()=>{const l={currentPassword:"",newPassword:"",confirmPassword:""};return g.currentPassword||(l.currentPassword="كلمة المرور الحالية مطلوبة"),g.newPassword?g.newPassword.length<6&&(l.newPassword="كلمة المرور يجب أن تكون 6 أحرف على الأقل"):l.newPassword="كلمة المرور الجديدة مطلوبة",g.confirmPassword?g.newPassword!==g.confirmPassword&&(l.confirmPassword="كلمات المرور غير متطابقة"):l.confirmPassword="تأكيد كلمة المرور مطلوب",p(l),!Object.values(l).some(u=>u!=="")},L=async l=>{if(l.preventDefault(),!(!M()||!s||!s.email)){o(!0);try{const u=Pe.credential(s.email,g.currentPassword);await Se(s,u),y(!0),b(!0),c({title:"تأكيد الهوية",description:"أدخل الرقم السري الرئيسي لتأكيد تغيير كلمة المرور"})}catch(u){console.error("خطأ في تغيير كلمة المرور:",u);let j="حدث خطأ أثناء تغيير كلمة المرور";if(u.code==="auth/wrong-password"){p(E=>({...E,currentPassword:"كلمة المرور الحالية غير صحيحة"}));return}else if(u.code==="auth/weak-password"){p(E=>({...E,newPassword:"كلمة المرور ضعيفة جداً"}));return}else u.code==="auth/requires-recent-login"&&(j="يجب تسجيل الدخول مرة أخرى لتغيير كلمة المرور");c({title:"خطأ في تغيير كلمة المرور",description:j,variant:"destructive"})}finally{o(!1)}}},O=async()=>{if(s){o(!0);try{await be(s,g.newPassword),c({title:"تم تغيير كلمة المرور بنجاح",description:"تم تحديث كلمة المرور الخاصة بك بنجاح"}),I({currentPassword:"",newPassword:"",confirmPassword:""}),p({currentPassword:"",newPassword:"",confirmPassword:""}),b(!1),y(!1),t(!1)}catch(l){console.error("خطأ في تحديث كلمة المرور:",l);let u="حدث خطأ أثناء تغيير كلمة المرور";l.code==="auth/requires-recent-login"&&(u="انتهت جلسة المصادقة. يرجى إعادة إدخال كلمة المرور الحالية"),c({title:"خطأ في تغيير كلمة المرور",description:u,variant:"destructive"})}finally{o(!1)}}},v=l=>u=>{I(j=>({...j,[l]:u.target.value})),d[l]&&p(j=>({...j,[l]:""}))},k=()=>{I({currentPassword:"",newPassword:"",confirmPassword:""}),p({currentPassword:"",newPassword:"",confirmPassword:""}),b(!1),y(!1),t(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(ee,{open:a,onOpenChange:k,children:e.jsxs(se,{className:"sm:max-w-[425px]",children:[e.jsxs(te,{children:[e.jsx(ae,{children:"تغيير كلمة المرور"}),e.jsx(Re,{children:"أدخل كلمة المرور الحالية وكلمة المرور الجديدة لتحديث حسابك"})]}),e.jsxs("form",{onSubmit:L,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(T,{htmlFor:"currentPassword",children:"كلمة المرور الحالية"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"currentPassword",type:x?"text":"password",value:g.currentPassword,onChange:v("currentPassword"),className:d.currentPassword?"border-red-500":"",autoComplete:"off",disabled:n}),e.jsx(N,{type:"button",variant:"ghost",size:"sm",className:"absolute right-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>h(!x),disabled:n,children:x?e.jsx(_,{className:"h-4 w-4"}):e.jsx(U,{className:"h-4 w-4"})})]}),d.currentPassword&&e.jsx("p",{className:"text-sm text-red-500",children:d.currentPassword})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(T,{htmlFor:"newPassword",children:"كلمة المرور الجديدة"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"newPassword",type:m?"text":"password",value:g.newPassword,onChange:v("newPassword"),className:d.newPassword?"border-red-500":"",autoComplete:"new-password",disabled:n}),e.jsx(N,{type:"button",variant:"ghost",size:"sm",className:"absolute right-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>w(!m),disabled:n,children:m?e.jsx(_,{className:"h-4 w-4"}):e.jsx(U,{className:"h-4 w-4"})})]}),d.newPassword&&e.jsx("p",{className:"text-sm text-red-500",children:d.newPassword})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(T,{htmlFor:"confirmPassword",children:"تأكيد كلمة المرور الجديدة"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"confirmPassword",type:S?"text":"password",value:g.confirmPassword,onChange:v("confirmPassword"),className:d.confirmPassword?"border-red-500":"",autoComplete:"new-password",disabled:n}),e.jsx(N,{type:"button",variant:"ghost",size:"sm",className:"absolute right-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>A(!S),disabled:n,children:S?e.jsx(_,{className:"h-4 w-4"}):e.jsx(U,{className:"h-4 w-4"})})]}),d.confirmPassword&&e.jsx("p",{className:"text-sm text-red-500",children:d.confirmPassword})]}),e.jsxs(_e,{children:[e.jsx(N,{type:"button",variant:"outline",onClick:k,disabled:n,children:"إلغاء"}),e.jsxs(N,{type:"submit",disabled:n,children:[n&&e.jsx(Ie,{className:"mr-2 h-4 w-4 animate-spin"}),"تغيير كلمة المرور"]})]})]})]})}),e.jsx(Ue,{open:V&&z,onOpenChange:l=>{b(l),l||y(!1)},mode:"verify",title:"التحقق من الرقم السري الرئيسي",description:"لا يمكن تغيير كلمة المرور إلا بعد التحقق من الرقم السري الرئيسي",onSuccess:O,onCancel:()=>{b(!1),y(!1)}})]})}const as="cashy.google.accessToken",rs="cashy.google.email",ns="cashy.google.expiresAt";function os(){try{const a=localStorage.getItem(as),t=localStorage.getItem(rs),s=localStorage.getItem(ns),c=s?Number(s):null;return{token:a,email:t,expiresAt:c}}catch{return{token:null,email:null,expiresAt:null}}}async function is(a,t,s){try{const c=await fetch("/user/google-backup-token",{method:"POST",headers:{"Content-Type":"application/json","X-USER-ID":a},body:JSON.stringify({email:t,refresh_token:s})}),n=await c.json().catch(()=>({}));return!!(c.ok&&(n!=null&&n.ok))}catch{return!1}}function xs({className:a}){const{user:t,profile:s,signOut:c,updateUserProfile:n}=Q(),o=ye(),[x,h]=i.useState(!1),{isShiftActive:m}=Ce(),{toast:w}=Z(),[S,A]=i.useState(!1),[V,b]=i.useState(!1),[z,y]=i.useState(!1),[{token:g},I]=i.useState(()=>os()),d=typeof window<"u"?window.electronAPI:void 0,p=!!d,[M,L]=i.useState(!1),[O,v]=i.useState(!1),[k,l]=i.useState(""),[u,j]=i.useState("");i.useEffect(()=>{if(!(!p||!d))try{d.onUpdateAvailable(r=>{var f,P;L(!0),l(String(((f=r==null?void 0:r.info)==null?void 0:f.version)||"")),j(String(((P=r==null?void 0:r.info)==null?void 0:P.notes)||"")),v(!0)}),d.onUpdateDownloaded(r=>{var f,P;L(!0),l(String(((f=r==null?void 0:r.info)==null?void 0:f.version)||"")),j(String(((P=r==null?void 0:r.info)==null?void 0:P.notes)||"")),v(!0)}),d.onUpdateError(r=>{try{w({title:"فشل التحديث",description:String((r==null?void 0:r.message)||(r==null?void 0:r.code)||"تعذر التحميل"),variant:"destructive"})}catch{}}),d.checkUpdate()}catch{}},[p,d]);const E=async()=>{try{if(d){const r=await d.downloadAndInstallUpdate();if(typeof r=="string"&&r.startsWith("err:"))try{w({title:"فشل التحديث",description:r.slice(4),variant:"destructive"})}catch{}}}catch(r){try{w({title:"فشل التحديث",description:(r==null?void 0:r.message)||"حدث خطأ أثناء التنزيل",variant:"destructive"})}catch{}}},pe=()=>s!=null&&s.fullName?s==null?void 0:s.fullName.split(" ").map(r=>r.charAt(0)).join("").toUpperCase().slice(0,2):t.email?t.email.charAt(0).toUpperCase():"U",H=s!=null&&s.avatarId?Fe(s.avatarId):null;if(i.useEffect(()=>{console.log("Profile updated in ProfileIcon:",s==null?void 0:s.avatarId)},[s==null?void 0:s.avatarId]),i.useEffect(()=>{const r=async f=>{try{if(!(f!=null&&f.data)||typeof f.data!="object"||f.origin!=="https://cashy.link")return;const{type:P,email:Y,refresh_token:q}=f.data||{};P==="cashy_oauth_token"&&(t!=null&&t.uid)&&Y&&q&&await is(t.uid,String(Y),String(q))&&w({title:"تم ربط جوجل",description:"تم حفظ توكن النسخ الاحتياطي عبر الخادم."})}catch{}};return window.addEventListener("message",r),()=>window.removeEventListener("message",r)},[t==null?void 0:t.uid]),!t)return null;const ve=async()=>{try{await c(),o("/user/login",{replace:!0})}catch(r){console.error("خطأ في تسجيل الخروج:",r);try{o("/user/login",{replace:!0})}catch{}}};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[p&&e.jsxs(N,{type:"button",onClick:()=>v(!0),title:"تحديث التطبيق",className:"relative inline-flex items-center justify-center w-9 h-9 rounded-md bg-transparent text-blue-600 hover:bg-blue-500/10 focus:outline-none dark:text-blue-400 dark:hover:bg-blue-400/10",variant:"ghost",children:[e.jsx(Ge,{className:"w-5 h-5"}),M&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 inline-block w-2 h-2 rounded-full bg-red-500"})]}),e.jsxs(Le,{children:[e.jsx(De,{asChild:!0,children:e.jsx(N,{variant:"ghost",disabled:m,title:m?"غير متاح أثناء وجود وردية كاشير نشطة":void 0,className:`relative h-8 w-8 rounded-full p-0 hover:bg-transparent focus:ring-1 focus:ring-primary focus:ring-offset-1 transition-all duration-200 disabled:opacity-60 disabled:cursor-not-allowed ${a}`,children:e.jsx(we,{className:"h-8 w-8 border border-border shadow-sm hover:shadow-md transition-all duration-200 hover:scale-105 bg-white",children:H?e.jsx("div",{className:"w-full h-full flex items-center justify-center bg-white dark:bg-neutral-900/20 rounded-full overflow-hidden",children:e.jsx("div",{className:"w-full h-full flex items-center justify-center scale-[2.5]",children:H.component})}):e.jsxs(e.Fragment,{children:[e.jsx(ge,{src:t.photoURL||void 0,alt:(s==null?void 0:s.fullName)||t.email||"المستخدم",className:"object-cover"}),e.jsx(xe,{className:"bg-white text-gray-900 font-semibold text-lg border-0",children:pe()})]})})})}),e.jsxs(Me,{className:"w-64",align:"end",forceMount:!0,children:[e.jsx(Oe,{className:"font-normal",children:e.jsxs("div",{className:"flex flex-col space-y-1",children:[e.jsx("p",{className:"text-sm font-medium leading-none",children:(s==null?void 0:s.fullName)||"المستخدم"}),e.jsx("p",{className:"text-xs leading-none text-muted-foreground",children:t.email}),(s==null?void 0:s.role)&&e.jsxs("p",{className:"text-xs leading-none text-muted-foreground",children:["الدور: ",s.role==="staff"?"مدير":s.role==="merchant"?"تاجر":"مستخدم"]})]})}),e.jsx(F,{}),e.jsxs(D,{onClick:async()=>{try{await n({showWithdrawNote:!((s==null?void 0:s.showWithdrawNote)??!0)})}catch{}},className:"cursor-pointer",children:[e.jsx(ke,{className:"mr-2 h-4 w-4"}),e.jsx("span",{children:(s==null?void 0:s.showWithdrawNote)??!0?"إخفاء خانة ملاحظة السحب":"إظهار خانة ملاحظة السحب"})]}),e.jsx(F,{}),e.jsxs(D,{onClick:()=>o("/profile-settings"),className:"cursor-pointer",children:[e.jsx(Ee,{className:"mr-2 h-4 w-4"}),e.jsx("span",{children:"إعدادات البروفيل"})]}),((s==null?void 0:s.role)==="admin"||(s==null?void 0:s.role)==="staff")&&e.jsxs(D,{onClick:()=>o("/admin"),className:"cursor-pointer",children:[e.jsx(Te,{className:"mr-2 h-4 w-4"}),e.jsx("span",{children:"لوحة الإدارة"})]}),e.jsx(F,{}),e.jsxs(D,{onClick:ve,className:"cursor-pointer text-red-600 focus:text-red-600",children:[e.jsx(Ae,{className:"mr-2 h-4 w-4"}),e.jsx("span",{children:"تسجيل الخروج"})]})]})]})]}),p&&e.jsx(ee,{open:O,onOpenChange:v,children:e.jsxs(se,{className:"sm:max-w-md",children:[e.jsx(te,{children:e.jsx(ae,{children:"يوجد تحديث جديد للبرنامج"})}),e.jsx("div",{className:"text-sm",children:"هل ترغب في تنزيله الآن؟"}),k&&e.jsxs("div",{className:"mt-2 text-xs",children:["الإصدار الجديد: ",e.jsxs("span",{className:"font-semibold",children:["v",k]})]}),u&&e.jsx("div",{className:"mt-2 text-xs text-muted-foreground whitespace-pre-line",children:u}),e.jsxs("div",{className:"flex items-center justify-end gap-2 mt-3",children:[e.jsx(N,{variant:"outline",onClick:()=>v(!1),children:"إلغاء"}),e.jsx(N,{className:"bg-blue-600 hover:bg-blue-700",onClick:E,children:"تنزيل وتحديث"})]})]})}),e.jsx(ts,{open:x,onOpenChange:h})]})}export{gs as A,xs as P};
