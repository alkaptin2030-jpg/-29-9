import{$ as Ee,c as Be,u as Oe,ac as Ae,ad as Pe,ae as H,r as s,j as e,B as P,af as Le,ag as Re,p as je,I as L,C as Fe,ab as J,v as X,f as q,ah as _e,K as $e,H as Me,w as ze,O as Ke,a as Ue,ai as ve}from"./index-BvNyRub4.js";import{C as v,a as y,b as w,d as S}from"./card-8dQqE_Bb.js";import{B as Ve}from"./badge-D2lawrde.js";import{S as G,a as Q,b as Y,c as Z,d as h}from"./select-BNt_bMz0.js";import{M as He}from"./MasterPinDialog-CZC_eblb.js";import{D as ye}from"./dollar-sign-C_yruOG3.js";import{W as Je}from"./wallet-B1l_BZQD.js";import{C as Xe}from"./circle-check-big-CLCERVs4.js";import{C as qe}from"./circle-x-3yt95wHO.js";import"./Combination-BFsitWaT.js";import"./index-BSD5qNog.js";import"./label-D4uI-2Sf.js";import"./dialog-zxhbkGLW.js";import"./shield-DJfnlgL_.js";import"./circle-alert-C4mStF22.js";const Ge=()=>{const x=Ee(),{toast:m}=Be(),{signOut:R,user:n,profile:D}=Oe(),{isShiftActive:we,shiftUser:ee}=Ae(),N=Pe(),F=(typeof H<"u"&&typeof H.getPlatform=="function"?H.getPlatform():"web")==="android"||/Android/i.test(typeof navigator<"u"?navigator.userAgent:""),[u,k]=s.useState("01030302038"),[c,_]=s.useState(""),[$,M]=s.useState(""),[f,te]=s.useState("transfer"),[z,se]=s.useState("vodafone_cash"),[K,ae]=s.useState("vodafone_cash"),[ne,U]=s.useState(""),[p,le]=s.useState([]),[Qe,Ye]=s.useState("all"),[Ze,et]=s.useState(!1),[Se,tt]=s.useState(""),[re,st]=s.useState([]),[at,nt]=s.useState(null),[lt,rt]=s.useState(!1),[it,ot]=s.useState([]),[ct,dt]=s.useState([]),[ut,ht]=s.useState(!1),[mt,xt]=s.useState("daily"),[ft,T]=s.useState([]),[ie,g]=s.useState(0),[I,b]=s.useState({}),[pt,gt]=s.useState(!1),[bt,jt]=s.useState(!1),[vt,yt]=s.useState(!1),[wt,St]=s.useState(!1),[Dt,Nt]=s.useState(!1),[Tt,It]=s.useState(""),[Wt,kt]=s.useState(!1),[De,V]=s.useState(!1),[C,oe]=s.useState(()=>{try{const t=n!=null&&n.uid?`dailyReportsLockEnabled_${n==null?void 0:n.uid}`:"dailyReportsLockEnabled";return(localStorage.getItem(t)??localStorage.getItem("dailyReportsLockEnabled"))==="true"}catch{return!1}}),[Ne,E]=s.useState(!1),[Te,Ie]=s.useState(!1),i=t=>{const a="٠١٢٣٤٥٦٧٨٩",l="۰۱۲۳۴۵۶۷۸۹";return(t||"").split("").map(o=>{const r=a.indexOf(o);if(r>-1)return String(r);const d=l.indexOf(o);return d>-1?String(d):o}).join("")},ce=t=>{const a=i(t).replace(/\D/g,"");return a.startsWith("010")?"vodafone_cash":a.startsWith("011")?"etisalat_cash":a.startsWith("012")?"orange_cash":null};s.useEffect(()=>{const t=ce(u);t&&t!==z&&se(t)},[u]),s.useEffect(()=>{const t=ce(c);t&&t!==K&&ae(t)},[c]),s.useEffect(()=>{try{const t=n!=null&&n.uid?`dailyReportsLockEnabled_${n==null?void 0:n.uid}`:"dailyReportsLockEnabled",a=localStorage.getItem(t)??localStorage.getItem("dailyReportsLockEnabled");oe(a==="true")}catch{}},[n==null?void 0:n.uid]),s.useEffect(()=>{const t=x.state||{};t!=null&&t.openTransactionSection&&(((t==null?void 0:t.transactionType)==="withdraw"||(t==null?void 0:t.transactionType)==="transfer")&&te(t.transactionType),Ie(!0),t!=null&&t.startNewTransaction&&(k("01030302038"),_(""),M(""),U("")),setTimeout(()=>{window.scrollTo({top:0,behavior:"smooth"})},50))},[x.state]);const de=async t=>{if(n)try{const a=await J.getById(n.uid);if(a!=null&&a.shopId){const l=X(q,"dashboardData",a.shopId);await Ke(l,t)}}catch(a){console.error("Error saving to Firebase:",a),m({title:"خطأ في الحفظ",description:"حدث خطأ أثناء حفظ البيانات في Firebase",variant:"destructive"})}};s.useEffect(()=>{if(!n)return;(async()=>{V(!0);try{const a=await J.getById(n.uid);if(a!=null&&a.shopId){const l=X(q,"dashboardData",a.shopId);try{const r=await _e(l);if(r.exists()){const d=r.data();g(d.cashBalance||0),b(d.walletBalances||{}),T(d.deletedTransactions||[]),V(!1)}}catch{}const o=await $e(l);if(o.exists()){const r=o.data();g(r.cashBalance||0),b(r.walletBalances||{}),T(r.deletedTransactions||[])}else{const r={walletBalances:{},deletedTransactions:[]};await Me(l,r),g(0),b(r.walletBalances),T(r.deletedTransactions)}}}catch(a){console.error("Error loading data from Firebase:",a),g(0),b({}),T([])}finally{V(!1)}})()},[n]),s.useEffect(()=>{if(!n)return;let t=null;return(async()=>{try{const l=await J.getById(n.uid);if(l!=null&&l.shopId){const o=X(q,"dashboardData",l.shopId);t=ze(o,{includeMetadataChanges:!0},r=>{if(r.exists()){const d=r.data();g(d.cashBalance||0),b(d.walletBalances||{}),T(d.deletedTransactions||[])}},r=>{console.error("Error subscribing to dashboardData:",r)})}}catch(l){console.error("Error initializing realtime dashboard subscription:",l)}})(),()=>{t&&t()}},[n==null?void 0:n.uid]);const We=async t=>{if(t.preventDefault(),f==="transfer"){if(!u||!c||!$){m({title:"خطأ",description:"يرجى ملء جميع الحقول المطلوبة",variant:"destructive"});return}const a=(D==null?void 0:D.shopName)||(n==null?void 0:n.displayName)||"محل كاشي لينك",l=re.find(A=>A.id===Se)||re.find(A=>A.isDefault),o=i(u||"").replace(/\D/g,""),r=i(c||"").replace(/\D/g,""),d=z===K,ue=o.startsWith("010")&&(r.startsWith("011")||r.startsWith("012")||r.startsWith("015"))||o.startsWith("012")&&r.startsWith("010")||o.startsWith("011")&&r.startsWith("010")||o.startsWith("015")&&r.startsWith("010"),j=d?1:ue?parseFloat(ne||"0"):0;if(ue&&(Number.isNaN(j)||j<=0)){m({title:"خطأ",description:"أدخل رسوم التحويل لعمليات 010 → 011/012/015 أو 012 → 010 أو 011 → 010 أو 015 → 010",variant:"destructive"});return}if(!l){m({title:"لا توجد محفظة",description:"يرجى اختيار محفظة لإتمام التحويل",variant:"destructive"});return}const B=parseFloat($),he=B+j,me=I[l.id]||0;if(me<he){m({title:"رصيد المحفظة غير كافٍ",description:`الرصيد الحالي ${me} لا يكفي لخصم ${he}`,variant:"destructive"});return}const xe={id:Date.now().toString(),type:"send",senderPhone:u,receiverPhone:c,amount:B,status:"pending",createdAt:new Date,withdrawnAmount:0,sentAmount:B,merchantShopName:a,shopName:(l==null?void 0:l.name)||"المحفظة الرئيسية",commission:0,fee:j,fromWallet:l.id},fe=[xe,...p];le(fe);const ke=B+j,O=l==null?void 0:l.id,Ce=O&&I[O]||0,pe=O?{...I,[O]:Ce-ke}:I;b(pe);const ge=ie+j;g(ge),await de({transactions:fe,walletBalances:pe,cashBalance:ge}),m({title:"تم إرسال التحويل",description:"جاري معالجة التحويل..."}),setTimeout(async()=>{const be=[{...xe,status:"completed"},...p];le(be),await de({transactions:be})},2e3),k("01030302038"),_(""),M(""),U("")}};return e.jsxs("div",{className:"min-h-screen bg-background p-4",children:[De&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white p-6 rounded-lg",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"}),e.jsx("p",{className:"mt-2 text-center",children:"جاري تحميل البيانات..."})]})}),e.jsxs("div",{className:"max-w-7xl mx-auto space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"لوحة تحكم الإدارة"}),e.jsxs(P,{onClick:R,variant:"outline",className:"flex items-center gap-2",children:[e.jsx(Le,{className:"h-4 w-4"}),"تسجيل الخروج"]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-6",children:[e.jsxs(v,{children:[e.jsxs(y,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(w,{className:"text-sm font-medium",children:"الرصيد النقدي"}),e.jsx(ye,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(S,{children:e.jsxs("div",{className:"text-2xl font-bold",children:[ie.toLocaleString()," جنيه"]})})]}),e.jsxs(v,{children:[e.jsxs(y,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(w,{className:"text-sm font-medium",children:"الأرصدة علي المحافظ"}),e.jsx(Je,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(S,{children:e.jsxs("div",{className:"text-2xl font-bold",children:[Object.values(I).reduce((t,a)=>t+a,0).toLocaleString()," جنيه"]})})]}),e.jsxs(v,{className:"relative",children:[e.jsxs(y,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(w,{className:"text-sm font-medium",children:"المعاملات اليوم"}),e.jsx(Re,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(S,{className:C?"filter blur-sm pointer-events-none":"",children:e.jsx("div",{className:"text-2xl font-bold",children:p.length})}),C&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center rounded-lg bg-yellow-100/60",children:e.jsxs(P,{size:"sm",variant:"ghost",onClick:()=>E(!0),className:"flex items-center gap-2 bg-yellow-200/70 hover:bg-yellow-300 text-yellow-900 px-3 py-2 rounded-xl shadow-md hover:shadow-lg transition-all",title:"عرض تقارير اليوم",children:[e.jsx(je,{className:"h-5 w-5"}),e.jsx("span",{className:"text-xs",children:"عرض تقارير اليوم"})]})})]}),e.jsxs(v,{className:"relative",children:[e.jsxs(y,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(w,{className:"text-sm font-medium",children:"إجمالي اليوم"}),e.jsx(ye,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(S,{className:C?"filter blur-sm pointer-events-none":"",children:e.jsxs("div",{className:"text-2xl font-bold",children:[p.reduce((t,a)=>t+a.amount,0).toLocaleString()," جنيه"]})}),C&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center rounded-lg bg-yellow-100/60",children:e.jsxs(P,{size:"sm",variant:"ghost",onClick:()=>E(!0),className:"flex items-center gap-2 bg-yellow-200/70 hover:bg-yellow-300 text-yellow-900 px-3 py-2 rounded-xl shadow-md hover:shadow-lg transition-all",title:"عرض تقارير اليوم",children:[e.jsx(je,{className:"h-5 w-5"}),e.jsx("span",{className:"text-xs",children:"عرض تقارير اليوم"})]})})]}),e.jsx(He,{open:Ne,onOpenChange:E,mode:"verify",title:"قفل تقارير اليوم",description:"لا يمكن الاطلاع على تقارير اليوم إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{oe(!1),E(!1)}})]}),e.jsxs(v,{className:N&&Te?"sticky top-0 z-40 shadow-lg bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/70":"",children:[e.jsx(y,{children:e.jsx(w,{children:"إجراء معاملة جديدة"})}),e.jsx(S,{children:e.jsxs("form",{onSubmit:We,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"نوع المعاملة"}),e.jsxs(G,{value:f,onValueChange:t=>te(t),children:[e.jsx(Q,{children:e.jsx(Y,{})}),e.jsxs(Z,{children:[e.jsx(h,{value:"transfer",children:"تحويل"}),e.jsx(h,{value:"withdraw",children:"سحب"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"رقم المرسل"}),e.jsx(L,{type:"tel",value:u,onChange:t=>k(t.target.value),onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("receiverPhoneInput");if(a)a.focus();else{const l=document.getElementById("amountInput");l==null||l.focus()}}},placeholder:"01xxxxxxxxx"})]}),f==="transfer"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"رقم المستقبل"}),e.jsx(L,{id:"receiverPhoneInput",type:"tel",value:c,onChange:t=>_(t.target.value),onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("amountInput");a==null||a.focus()}},placeholder:"01xxxxxxxxx"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"شركة المرسل"}),e.jsxs(G,{value:z,onValueChange:t=>se(t),children:[e.jsx(Q,{children:e.jsx(Y,{})}),e.jsxs(Z,{children:[e.jsx(h,{value:"vodafone_cash",children:"فودافون"}),e.jsx(h,{value:"etisalat_cash",children:"اتصالات"}),e.jsx(h,{value:"orange_cash",children:"أورانج"}),e.jsx(h,{value:"instapay",children:"إنستاباي"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"شركة المستقبل"}),e.jsxs(G,{value:K,onValueChange:t=>ae(t),children:[e.jsx(Q,{children:e.jsx(Y,{})}),e.jsxs(Z,{children:[e.jsx(h,{value:"vodafone_cash",children:"فودافون"}),e.jsx(h,{value:"etisalat_cash",children:"اتصالات"}),e.jsx(h,{value:"orange_cash",children:"أورانج"}),e.jsx(h,{value:"instapay",children:"إنستاباي"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"المبلغ"}),e.jsx(L,{id:"amountInput",type:"number",value:$,onChange:t=>M(t.target.value),onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("txSubmitButton");a==null||a.focus()}},placeholder:"0.00"})]}),f==="transfer"&&(i(u||"").replace(/\D/g,"").startsWith("010")&&(i(c||"").replace(/\D/g,"").startsWith("011")||i(c||"").replace(/\D/g,"").startsWith("012")||i(c||"").replace(/\D/g,"").startsWith("015"))||i(u||"").replace(/\D/g,"").startsWith("012")&&i(c||"").replace(/\D/g,"").startsWith("010")||i(u||"").replace(/\D/g,"").startsWith("011")&&i(c||"").replace(/\D/g,"").startsWith("010")||i(u||"").replace(/\D/g,"").startsWith("015")&&i(c||"").replace(/\D/g,"").startsWith("010"))&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"رسوم التحويل"}),e.jsx(L,{type:"number",value:ne,onChange:t=>U(t.target.value),placeholder:"0.00"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"تُخصم من المحفظة وتضاف للدرج"})]})]}),e.jsx(P,{id:"txSubmitButton",type:"submit",className:`w-full ${f==="transfer"?"btn-transfer-confirm":"btn-withdraw-confirm"}`,children:f==="transfer"?"إرسال التحويل":"تنفيذ السحب"})]})})]}),e.jsxs(v,{children:[e.jsx(y,{children:e.jsx(w,{children:"المعاملات الأخيرة"})}),e.jsx(S,{children:p.length===0?e.jsx("p",{className:"text-sm text-gray-500",children:"لا توجد معاملات حديثة."}):e.jsx("div",{className:N||F?"receipts-list space-y-4 max-h-[310px] overflow-y-auto pr-1 scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400":"receipts-list space-y-4",children:p.map(t=>e.jsxs("div",{className:"receipts-row flex items-center justify-between p-4 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[t.status==="completed"&&e.jsx(Xe,{className:`h-5 w-5 ${t.type==="withdraw"?"text-red-500":"text-green-500"}`}),t.status==="pending"&&e.jsx(Fe,{className:"h-5 w-5 text-yellow-500"}),t.status==="failed"&&e.jsx(qe,{className:"h-5 w-5 text-red-500"})]}),e.jsxs("div",{children:[e.jsxs("p",{className:`font-medium ${t.type==="send"?"text-green-700":"text-red-700"}`,children:[t.type==="send"?"تحويل":"سحب"," - ",t.amount.toLocaleString()," جنيه"]}),e.jsxs("p",{className:`text-sm ${t.type==="send"?"text-green-600":"text-red-500"}`,children:["من ",t.senderPhone," إلى ",t.receiverPhone]})]})]}),e.jsx(Ve,{variant:t.status==="completed"?"default":t.status==="pending"?"secondary":"destructive",children:t.status==="completed"?"مكتمل":t.status==="pending"?"قيد المعالجة":"فشل"})]},t.id))})})]})]})]})},Vt=()=>{const x=Ue(),[m,R]=s.useState(!1),[n,D]=s.useState(!0);return s.useEffect(()=>{(()=>{const ee=localStorage.getItem("dashboardAuth"),N=localStorage.getItem("dashboardUser");if(ee==="true"&&N)try{const W=JSON.parse(N),F=new Date(W.loginTime);(new Date().getTime()-F.getTime())/(1e3*60*60)<24?R(!0):(localStorage.removeItem("dashboardAuth"),localStorage.removeItem("dashboardUser"),x("/dashboard/login"))}catch(W){console.error("Error parsing user data:",W),x("/dashboard/login")}else x("/dashboard/login");D(!1)})()},[x]),n?e.jsx(ve,{}):m?e.jsx(Ge,{}):e.jsx(ve,{})};export{Vt as default};
