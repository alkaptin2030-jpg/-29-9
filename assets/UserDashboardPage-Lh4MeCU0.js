const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-4FXqbJ0i.js","assets/index-DHdq-Edv.css","assets/walletDailyLimitsService-DfpiIhi1.js","assets/profitService-WOL_cZ8K.js","assets/reportsService-Bp1Io21u.js"])))=>i.map(i=>d[i]);
var nc=Object.defineProperty;var lc=(l,h,o)=>h in l?nc(l,h,{enumerable:!0,configurable:!0,writable:!0,value:o}):l[h]=o;var hn=(l,h,o)=>lc(l,typeof h!="symbol"?h+"":h,o);import{c as Zt,Q as ic,U as oc,u as xs,r,j as e,a7 as Ia,K as ea,a5 as js,aZ as gr,C as Ls,d as Xt,a as ql,a6 as ft,a0 as Yl,$ as Hl,_ as bs,aR as hr,R as mt,F as Sa,n as cc,S as ds,W as Ta,q as Ws,f as cs,g as it,a3 as kt,h as Fs,a8 as Cn,Z as ta,k as Gt,J as Gs,aV as dc,a4 as Ll,B as mc,D as Gl,H as hc,a_ as uc,x as $s,an as Rl,a$ as Ql,a9 as we,z as xc,al as pc,aU as gc,e as Qs,aW as un,p as fc,m as vc,Y as Na,ao as yc,ap as bc,aT as jc,M as Nc,am as ir,t as or,aO as wc,aP as Sc}from"./index-4FXqbJ0i.js";import{C as Ve,a as ht,b as At,d as He}from"./card-CWS_VYqU.js";import{B as d,b as Zl}from"./button-m7GXumE4.js";import{I as R}from"./input-4AJ6TGF6.js";import{B as dt}from"./badge-Dd1TwtGD.js";import{S as ks,a as As,b as Ps,c as Os,d as Ht,C as In,e as Xl}from"./select-CCt1WPwX.js";import{D as ie,a as oe,b as ce,c as de,f as ei,T as Dc,O as Cc,W as Ic,C as Tc,g as kc,h as Ac,i as ti,R as Pc,P as Oc,d as Mt,e as De}from"./dialog-DEyzxC_F.js";import{L as V}from"./label-Douiz0aH.js";import{M as Bs,a as ms}from"./MasterPinDialog-Dy0RCprq.js";import{walletDailyLimitsService as hs}from"./walletDailyLimitsService-DfpiIhi1.js";import{T as Wt,P as ur}from"./progress-COi37FWP.js";import{W as Qt}from"./wallet-CjSjB8Os.js";import{S as si}from"./star-DOvsZAc8.js";import{S as ai}from"./square-pen-Db4lvUy9.js";import{P as us}from"./phone-C68Ey5Ve.js";import{A as ri}from"./arrow-left-daeHifGg.js";import{a as jn,S as Wc}from"./index.esm-utKuqPz7.js";import{C as Ns}from"./calendar-ni1DkPsw.js";import{C as Nn}from"./chart-column-CE5gym9K.js";import{D as Ge}from"./dollar-sign-D-69fxnH.js";import{A as xn,B as $l}from"./bell-bYBPtoeK.js";import{C as Us}from"./circle-alert-PTpMyQK_.js";import{C as Tn}from"./circle-x-DOnaw03b.js";import{C as Ms}from"./circle-check-big-dgxMdHf8.js";import{a as st,E as Ft}from"./eye-BdDn2k6S.js";import{S as Fc}from"./store-Cuhm0s8o.js";import{A as Ec}from"./arrow-right-B62LGQCI.js";import{U as wn}from"./user-Dn_-fAXr.js";import{c as Bc,C as ni,D as Mc,a as Lc,R as Rc,P as pn,b as $c,M as Uc}from"./PasswordConfirmDialog-C4ya-eVR.js";import{L as Rs}from"./lock-DQWGCtd_.js";import{M as Es}from"./minus-C_Sa-n76.js";import{w as _c,W as zc}from"./WalletsManagement-BQxY3vz2.js";import{reportsService as Yt}from"./reportsService-Bp1Io21u.js";import{P as Jc}from"./ProfileIcon-DiG6xsV7.js";import{a as Kc,E as Vc}from"./broadcastService-CnJyruZp.js";import{D as qc,a as Yc,b as Hc,c as Gc,d as Qc}from"./dropdown-menu-D2vnZoMw.js";import{S as gn}from"./shield-AStdmVLN.js";import{G as Zc}from"./gift-DAjhD-tU.js";import{ProfitService as sa}from"./profitService-WOL_cZ8K.js";import{R as Xc}from"./refresh-cw-BZTzTIR3.js";import"./index-0j-FZMrA.js";import"./Combination-DPvVklS4.js";import"./index-CP9Fj8u5.js";import"./whatsappService-Dl0y5teo.js";import"./avatars-DOTqaCLK.js";import"./index-CPnYy-wr.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xr=Zt("ArrowDownLeft",[["path",{d:"M17 7 7 17",key:"15tmo1"}],["path",{d:"M17 17H7V7",key:"1org7z"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const li=Zt("ArrowRightLeft",[["path",{d:"m16 3 4 4-4 4",key:"1x1c3m"}],["path",{d:"M20 7H4",key:"zbl0bi"}],["path",{d:"m8 21-4-4 4-4",key:"h9nckh"}],["path",{d:"M4 17h16",key:"g4d7ey"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ed=Zt("Award",[["path",{d:"m15.477 12.89 1.515 8.526a.5.5 0 0 1-.81.47l-3.58-2.687a1 1 0 0 0-1.197 0l-3.586 2.686a.5.5 0 0 1-.81-.469l1.514-8.526",key:"1yiouv"}],["circle",{cx:"12",cy:"8",r:"6",key:"1vp47v"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const td=Zt("Banknote",[["rect",{width:"20",height:"12",x:"2",y:"6",rx:"2",key:"9lu3g6"}],["circle",{cx:"12",cy:"12",r:"2",key:"1c9p78"}],["path",{d:"M6 12h.01M18 12h.01",key:"113zkx"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const sd=Zt("BookOpen",[["path",{d:"M12 7v14",key:"1akyts"}],["path",{d:"M3 18a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h5a4 4 0 0 1 4 4 4 4 0 0 1 4-4h5a1 1 0 0 1 1 1v13a1 1 0 0 1-1 1h-6a3 3 0 0 0-3 3 3 3 0 0 0-3-3z",key:"ruj8y"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ii=Zt("Building",[["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",ry:"2",key:"76otgf"}],["path",{d:"M9 22v-4h6v4",key:"r93iot"}],["path",{d:"M8 6h.01",key:"1dz90k"}],["path",{d:"M16 6h.01",key:"1x0f13"}],["path",{d:"M12 6h.01",key:"1vi96p"}],["path",{d:"M12 10h.01",key:"1nrarc"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M16 10h.01",key:"1m94wz"}],["path",{d:"M16 14h.01",key:"1gbofw"}],["path",{d:"M8 10h.01",key:"19clt8"}],["path",{d:"M8 14h.01",key:"6423bh"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pr=Zt("IdCard",[["path",{d:"M16 10h2",key:"8sgtl7"}],["path",{d:"M16 14h2",key:"epxaof"}],["path",{d:"M6.17 15a3 3 0 0 1 5.66 0",key:"n6f512"}],["circle",{cx:"9",cy:"11",r:"2",key:"yxgjnd"}],["rect",{x:"2",y:"5",width:"20",height:"14",rx:"2",key:"qneu4z"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Sn=Zt("Info",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const cr=Zt("Package",[["path",{d:"M11 21.73a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73z",key:"1a0edw"}],["path",{d:"M12 22V12",key:"d0xqtd"}],["path",{d:"m3.3 7 7.703 4.734a2 2 0 0 0 1.994 0L20.7 7",key:"yx3hmr"}],["path",{d:"m7.5 4.27 9 5.15",key:"1c824w"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Da=Zt("TrendingDown",[["polyline",{points:"22 17 13.5 8.5 8.5 13.5 2 7",key:"1r2t7k"}],["polyline",{points:"16 17 22 17 22 11",key:"11uiuu"}]]),ad=async(l={})=>{try{return(await ic(oc,"getLastTransactions")(l)).data}catch(h){throw console.error("Error getting last transactions:",h),h.code==="functions/unauthenticated"?new Error("يجب تسجيل الدخول للوصول إلى المعاملات"):h.code==="functions/invalid-argument"?new Error("بيانات الاستعلام غير صالحة: "+h.message):h.code==="functions/permission-denied"?new Error("ليس لديك صلاحية للوصول إلى هذه المعاملات: "+h.message):new Error("حدث خطأ أثناء جلب المعاملات: "+(h.message||"خطأ غير معروف"))}},rd=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],nd=({isOpen:l,onClose:h,onWalletSelect:o,onEditWallet:u,onDeleteWallet:y})=>{const{user:v}=xs(),[t,A]=r.useState([]),[j,m]=r.useState(!1),x=()=>`wallets_${(v==null?void 0:v.uid)||"default"}`,S=()=>{try{const k=x(),C=localStorage.getItem(k);if(C){const ae=JSON.parse(C);if(Array.isArray(ae)&&ae.length>0)return ae}const _="wallets_default",L=localStorage.getItem(_);if(L){const ae=JSON.parse(L);if(Array.isArray(ae)&&ae.length>0){localStorage.setItem(k,L);try{localStorage.removeItem(_)}catch{}return ae}}const O=Object.keys(localStorage).filter(ae=>ae.startsWith("wallets_")&&ae!==k);let J=null,he=null;for(const ae of O)try{const pe=localStorage.getItem(ae);if(!pe)continue;const H=JSON.parse(pe);Array.isArray(H)&&H.length>0&&(!J||H.length>((J==null?void 0:J.length)||0))&&(J=H,he=ae)}catch{}if(J&&he){localStorage.setItem(k,JSON.stringify(J));try{localStorage.removeItem(he)}catch{}return J}}catch(k){console.warn("WalletsViewPage migration failed:",k)}return null},b=async(k,C)=>{const _=new Date().getMonth(),L=new Date().getFullYear(),O=C.filter(H=>{const X=new Date(H.createdAt);return X.getMonth()===_&&X.getFullYear()===L&&H.lineId===k}),J=H=>{const X=H.type;return H.txnType==="receive"||X==="withdraw"||X==="withdrawal"||X==="receive"},he=H=>{const X=H.type;return H.txnType==="send"||X==="send"||X==="transfer"},ae=O.filter(J).reduce((H,X)=>{const Te=X.withdrawnAmount!==void 0?X.withdrawnAmount:X.amount;return H+(Te||0)},0),pe=O.filter(he).reduce((H,X)=>{const Te=X.sentAmount!==void 0?X.sentAmount:X.amount;return H+(Te||0)},0);return{withdrawalUsage:ae,transferUsage:pe}},M=k=>{const C=new Date().toISOString().split("T")[0],_=k.lastResetDate;if(!_)return{...k,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:C};const L=new Date(_),O=new Date;return L.getMonth()!==O.getMonth()||L.getFullYear()!==O.getFullYear()?{...k,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:C}:k};r.useEffect(()=>{if(!(v!=null&&v.uid)||!l)return;(async()=>{m(!0);try{const C=await js.getByMerchantId(v.uid),_=await gr.getByUserId(v.uid),O=(await Promise.all(C.map(async J=>{const{withdrawalUsage:he,transferUsage:ae}=await b(J.id,_);return{id:J.id,name:J.label||"محفظة بدون اسم",phone:J.msisdn,nationalId:J.nationalId||"",isDefault:!1,monthlyWithdrawalLimit:J.withdrawLimit||2e5,monthlyTransferLimit:J.transferLimit||2e5,monthlyWithdrawalUsage:he,monthlyTransferUsage:ae,lastResetDate:new Date().toISOString().split("T")[0],walletProvider:J.walletProvider||""}}))).map(M);if(A(O),!O||O.length===0){const J=S();J&&J.length>0&&A(J.map(M))}}catch(C){console.error("Error loading wallets:",C);const _=S();_&&A(_.map(L=>({...L,phone:L.phone||L.phoneNumber,monthlyWithdrawalLimit:L.monthlyWithdrawalLimit||2e5,monthlyTransferLimit:L.monthlyTransferLimit||2e5})))}finally{m(!1)}})()},[v==null?void 0:v.uid,l]);const U=k=>rd.find(C=>C.id===k),Z=(k,C)=>C>0?Math.min(k/C*100,100):0,B=k=>new Intl.NumberFormat("ar-EG").format(k);return e.jsx(ie,{open:l,onOpenChange:h,children:e.jsxs(oe,{className:"max-w-6xl max-h-[90vh] overflow-y-auto",children:[e.jsx(ce,{className:"pb-4",children:e.jsxs(de,{className:"flex items-center gap-2 text-lg",children:[e.jsx(Qt,{className:"h-5 w-5"}),"الاطلاع على جميع المحافظ",e.jsxs(dt,{variant:"secondary",className:"mr-2",children:[t.length," محفظة"]})]})}),j?e.jsx("div",{className:"flex justify-center items-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-600",children:"جاري تحميل المحافظ..."})]})}):t.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Qt,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"لا توجد محافظ مضافة حتى الآن"})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:t.map(k=>{const C=U(k.walletProvider||""),_=Z(k.monthlyWithdrawalUsage||0,k.monthlyWithdrawalLimit),L=Z(k.monthlyTransferUsage||0,k.monthlyTransferLimit);return e.jsxs(Ve,{className:"cursor-pointer hover:shadow-lg transition-shadow border-2 hover:border-blue-300",onClick:()=>o(k),children:[e.jsx(ht,{className:"pb-3",children:e.jsxs(At,{className:"flex items-center justify-between text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ia,{className:"h-4 w-4"}),e.jsx("span",{children:k.name})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[k.isDefault&&e.jsxs(dt,{variant:"default",className:"text-xs",children:[e.jsx(si,{className:"h-3 w-3 mr-1"}),"افتراضية"]}),e.jsx(d,{variant:"ghost",size:"sm",onClick:O=>{O.stopPropagation(),u==null||u(k)},className:"h-7 px-2",children:e.jsx(ai,{className:"h-4 w-4"})}),e.jsx(d,{variant:"ghost",size:"sm",onClick:O=>{O.stopPropagation(),y==null||y(k.id)},className:"h-7 px-2 text-destructive hover:text-destructive",children:e.jsx(Wt,{className:"h-4 w-4"})})]})]})}),e.jsxs(He,{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(us,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"font-mono",children:k.phone})]}),k.nationalId&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(pr,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"font-mono",children:k.nationalId})]}),C&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(ii,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{children:C.name})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Da,{className:"h-3 w-3 text-red-500"}),"السحب الشهري"]}),e.jsxs("span",{className:"font-mono",children:[B(k.monthlyWithdrawalUsage||0)," / ",B(k.monthlyWithdrawalLimit)]})]}),e.jsx(ur,{value:_,className:"h-2"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(ea,{className:"h-3 w-3 text-green-500"}),"التحويل الشهري"]}),e.jsxs("span",{className:"font-mono",children:[B(k.monthlyTransferUsage||0)," / ",B(k.monthlyTransferLimit)]})]}),e.jsx(ur,{value:L,className:"h-2"})]}),e.jsx(d,{variant:"outline",size:"sm",className:"w-full text-xs",onClick:O=>{O.stopPropagation(),o(k)},children:"عرض التفاصيل الكاملة"})]})]},k.id)})}),e.jsx("div",{className:"flex justify-end pt-4 border-t",children:e.jsxs(d,{onClick:h,variant:"outline",children:[e.jsx(ri,{className:"h-4 w-4 mr-2"}),"إغلاق"]})})]})})},ld=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],id=({wallet:l,isOpen:h,onClose:o,onBack:u})=>{const{user:y}=xs(),[v,t]=r.useState([]),[A,j]=r.useState(!1),[m,x]=r.useState("month");if(r.useEffect(()=>{if(!l||!(y!=null&&y.uid)||!h)return;(async()=>{j(!0);try{const ke=(await gr.getByUserId(y.uid)).filter(at=>at.walletId===l.id).sort((at,vt)=>new Date(vt.createdAt).getTime()-new Date(at.createdAt).getTime());t(ke)}catch(re){console.error("Error loading transactions:",re)}finally{j(!1)}})()},[l,y==null?void 0:y.uid,h]),!l)return null;const S=K=>ld.find(re=>re.id===K),b=(K,re)=>re>0?Math.min(K/re*100,100):0,M=K=>new Intl.NumberFormat("ar-EG").format(K),U=K=>new Date(K).toLocaleDateString("ar-EG",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}),B=(()=>{const K=new Date;let re;switch(m){case"week":re=new Date(K.getTime()-7*24*60*60*1e3);break;case"month":re=new Date(K.getFullYear(),K.getMonth(),1);break;default:return v}return v.filter(ke=>new Date(ke.createdAt)>=re)})(),k=K=>{const re=K.type,ke=K.txnType;return re==="withdraw"||re==="withdrawal"||re==="receive"||ke==="receive"},C=K=>{const re=K.type,ke=K.txnType;return re==="send"||re==="transfer"||ke==="send"},_=B.filter(K=>k(K)&&K.status==="completed").reduce((K,re)=>{const ke=re.withdrawnAmount!==void 0?re.withdrawnAmount:re.amount;return K+(ke||0)},0),L=B.filter(K=>C(K)&&K.status==="completed").reduce((K,re)=>{const ke=re.sentAmount!==void 0?re.sentAmount:re.amount;return K+(ke||0)},0),O=B.filter(K=>K.type==="deposit"&&K.status==="completed").reduce((K,re)=>K+re.amount,0),J=S(l.walletProvider||""),he=b(l.monthlyWithdrawalUsage||0,l.monthlyWithdrawalLimit),ae=b(l.monthlyTransferUsage||0,l.monthlyTransferLimit),pe=K=>{switch(K){case"withdrawal":return e.jsx(Da,{className:"h-4 w-4 text-red-500"});case"transfer":return e.jsx(ea,{className:"h-4 w-4 text-blue-500"});case"deposit":return e.jsx(Ge,{className:"h-4 w-4 text-green-500"});default:return e.jsx(xn,{className:"h-4 w-4 text-gray-500"})}},H=K=>{switch(K){case"completed":return e.jsx(Ms,{className:"h-4 w-4 text-green-500"});case"pending":return e.jsx(Ls,{className:"h-4 w-4 text-yellow-500"});case"failed":return e.jsx(Tn,{className:"h-4 w-4 text-red-500"});default:return e.jsx(Us,{className:"h-4 w-4 text-gray-500"})}},X=K=>{switch(K){case"withdrawal":return"سحب";case"transfer":return"تحويل";case"deposit":return"إيداع";default:return"معاملة"}},Te=K=>{switch(K){case"completed":return"مكتملة";case"pending":return"قيد الانتظار";case"failed":return"فاشلة";default:return"غير محدد"}};return e.jsx(ie,{open:h,onOpenChange:o,children:e.jsxs(oe,{className:"max-w-6xl max-h-[90vh] overflow-y-auto",children:[e.jsx(ce,{className:"pb-4",children:e.jsxs(de,{className:"flex items-center gap-2 text-lg",children:[e.jsx(Ia,{className:"h-5 w-5"}),"تفاصيل المحفظة: ",l.name,l.isDefault&&e.jsxs(dt,{variant:"default",className:"mr-2",children:[e.jsx(si,{className:"h-3 w-3 mr-1"}),"افتراضية"]})]})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-1 space-y-4",children:[e.jsxs(Ve,{children:[e.jsx(ht,{children:e.jsxs(At,{className:"text-sm flex items-center gap-2",children:[e.jsx(pr,{className:"h-4 w-4"}),"المعلومات الأساسية"]})}),e.jsxs(He,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(us,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-mono",children:l.phone})]}),l.nationalId&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(pr,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-mono",children:l.nationalId})]}),J&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(ii,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{children:J.name})]}),e.jsxs("div",{className:"text-xs text-gray-600 pr-6",children:[e.jsxs("div",{children:["المالك: ",J.ownerName]}),e.jsxs("div",{className:"font-mono",children:["الرقم القومي: ",J.nationalId]})]})]}),l.lastResetDate&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Ns,{className:"h-4 w-4 text-gray-500"}),e.jsxs("span",{children:["آخر إعادة تعيين: ",new Date(l.lastResetDate).toLocaleDateString("ar-EG")]})]})]})]}),e.jsxs(Ve,{children:[e.jsx(ht,{children:e.jsxs(At,{className:"text-sm flex items-center gap-2",children:[e.jsx(Nn,{className:"h-4 w-4"}),"حدود الاستخدام الشهري"]})}),e.jsxs(He,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Da,{className:"h-3 w-3 text-red-500"}),"السحب الشهري"]}),e.jsxs("span",{className:"font-mono",children:[M(l.monthlyWithdrawalUsage||0)," / ",M(l.monthlyWithdrawalLimit)]})]}),e.jsx(ur,{value:he,className:"h-2"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["متبقي: ",M(l.monthlyWithdrawalLimit-(l.monthlyWithdrawalUsage||0))," جنيه"]})]}),e.jsx(jn,{}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(ea,{className:"h-3 w-3 text-green-500"}),"التحويل الشهري"]}),e.jsxs("span",{className:"font-mono",children:[M(l.monthlyTransferUsage||0)," / ",M(l.monthlyTransferLimit)]})]}),e.jsx(ur,{value:ae,className:"h-2"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["متبقي: ",M(l.monthlyTransferLimit-(l.monthlyTransferUsage||0))," جنيه"]})]})]})]})]}),e.jsxs("div",{className:"lg:col-span-2 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsx(Ve,{children:e.jsxs(He,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(Da,{className:"h-5 w-5 text-red-500"})}),e.jsx("div",{className:"text-lg font-bold",children:M(_)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي السحب"})]})}),e.jsx(Ve,{children:e.jsxs(He,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(ea,{className:"h-5 w-5 text-blue-500"})}),e.jsx("div",{className:"text-lg font-bold",children:M(L)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي التحويل"})]})}),e.jsx(Ve,{children:e.jsxs(He,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(Ge,{className:"h-5 w-5 text-green-500"})}),e.jsx("div",{className:"text-lg font-bold",children:M(O)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي الإيداع"})]})})]}),e.jsxs(Ve,{children:[e.jsx(ht,{children:e.jsxs(At,{className:"text-sm flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(xn,{className:"h-4 w-4"}),"سجل المعاملات"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(d,{size:"sm",variant:m==="week"?"default":"outline",onClick:()=>x("week"),className:"text-xs",children:"أسبوع"}),e.jsx(d,{size:"sm",variant:m==="month"?"default":"outline",onClick:()=>x("month"),className:"text-xs",children:"شهر"}),e.jsx(d,{size:"sm",variant:m==="all"?"default":"outline",onClick:()=>x("all"),className:"text-xs",children:"الكل"})]})]})}),e.jsx(He,{children:A?e.jsx("div",{className:"flex justify-center items-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-600",children:"جاري تحميل المعاملات..."})]})}):B.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(xn,{className:"h-8 w-8 text-gray-400 mx-auto mb-2"}),e.jsx("p",{className:"text-gray-600",children:"لا توجد معاملات في هذه الفترة"})]}):e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:B.map(K=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[pe(K.type),e.jsxs("div",{children:[e.jsxs("div",{className:"text-sm font-medium",children:[X(K.type)," - ",M(K.amount)," جنيه"]}),e.jsx("div",{className:"text-xs text-gray-600",children:U(K.createdAt)}),K.description&&e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:K.description})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[H(K.status),e.jsx("span",{className:"text-xs",children:Te(K.status)})]})]},K.id))})})]})]})]}),e.jsxs("div",{className:"flex justify-between pt-4 border-t",children:[e.jsxs(d,{onClick:u,variant:"outline",children:[e.jsx(ri,{className:"h-4 w-4 mr-2"}),"العودة للمحافظ"]}),e.jsx(d,{onClick:o,variant:"outline",children:"إغلاق"})]})]})})},fn=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],od=({isOpen:l,onClose:h,onWalletUpdate:o,initialEditingWallet:u})=>{const{toast:y}=Xt(),{user:v}=xs(),t=ql(),[A,j]=r.useState([]),[m,x]=r.useState(!1),[S,b]=r.useState(null),[M,U]=r.useState(""),[Z,B]=r.useState(""),[k,C]=r.useState(""),[_,L]=r.useState(""),[O,J]=r.useState("200000"),[he,ae]=r.useState("200000"),[pe,H]=r.useState("100000"),[X,Te]=r.useState("60000"),[K,re]=r.useState(!1),[ke,at]=r.useState(null),[vt,Ee]=r.useState(!1),[yt,qe]=r.useState(!1),[Ye,ut]=r.useState(!1),[rt,Be]=r.useState(null),p=()=>`wallets_${(v==null?void 0:v.uid)||"default"}`;r.useEffect(()=>{u&&(b(u),x(!0),U(u.name||""),B(u.phone||""),C(u.nationalId||""),L(u.walletProvider||""),J((u.monthlyWithdrawalLimit||2e5).toString()),ae((u.monthlyTransferLimit||2e5).toString()),H((u.dailyWithdrawalLimit||1e5).toString()),Te((u.dailyTransferLimit||6e4).toString()),re(!!u.isDefault))},[u]);const z=D=>{const Q=new Date,ue=Q.getMonth(),Se=Q.getFullYear();if(!D.lastResetDate)return{...D,monthlyWithdrawalUsage:D.monthlyWithdrawalUsage||0,monthlyTransferUsage:D.monthlyTransferUsage||0,lastResetDate:Q.toISOString().split("T")[0]};const be=new Date(D.lastResetDate),Le=be.getMonth(),F=be.getFullYear();return ue!==Le||Se!==F?{...D,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:Q.toISOString().split("T")[0]}:D},ee=async(D,Q)=>{const ue=new Date().getMonth(),Se=new Date().getFullYear(),be=Q.filter(te=>{const $=new Date(te.createdAt);return $.getMonth()===ue&&$.getFullYear()===Se&&te.lineId===D}),Le=be.filter(te=>te.txnType==="receive").reduce((te,$)=>te+($.amount||0),0),F=be.filter(te=>te.txnType==="send").reduce((te,$)=>te+($.amount||0),0);return{withdrawalUsage:Le,transferUsage:F}},fe=async(D,Q)=>{const ue=new Date,Se=ue.getDate(),be=ue.getMonth(),Le=ue.getFullYear(),F=Q.filter(Ce=>{const Re=new Date(Ce.createdAt);return Re.getDate()===Se&&Re.getMonth()===be&&Re.getFullYear()===Le&&Ce.lineId===D}),te=F.filter(Ce=>Ce.txnType==="receive").reduce((Ce,Re)=>Ce+(Re.amount||0),0),$=F.filter(Ce=>Ce.txnType==="send").reduce((Ce,Re)=>Ce+(Re.amount||0),0);return{withdrawalUsage:te,transferUsage:$}};r.useEffect(()=>{(async()=>{if(!(v!=null&&v.uid)){console.log("No user authenticated, skipping wallet loading"),Ee(!1);return}console.log("Loading wallets for user:",v.uid),Ee(!0);try{const{auth:Q}=await bs(async()=>{const{auth:$}=await import("./index-4FXqbJ0i.js").then(Ce=>Ce.b1);return{auth:$}},__vite__mapDeps([0,1]));let ue=0;const Se=5;for(;!Q.currentUser&&ue<Se;)console.log(`Waiting for auth state... attempt ${ue+1}`),await new Promise($=>setTimeout($,1e3)),ue++;if(!Q.currentUser)throw console.error("User not authenticated in Firebase Auth after retries"),new Error("not authenticated");console.log("Firebase Auth User:",Q.currentUser.uid),console.log("Context User:",v.uid),console.log("Fetching wallets from Firebase...");const be=await js.getByMerchantId(v.uid);console.log("Fetched wallets:",be),console.log("Fetching transactions from Firebase...");const Le=await gr.getByUserId(v.uid);console.log("Fetched transactions:",Le);const te=(await Promise.all(be.map(async $=>{const{withdrawalUsage:Ce,transferUsage:Re}=await ee($.id,Le),{withdrawalUsage:Lt,transferUsage:bt}=await fe($.id,Le);return{id:$.id,name:$.label||"محفظة بدون اسم",phone:$.msisdn,isDefault:!1,monthlyWithdrawalLimit:$.withdrawLimit||2e5,monthlyTransferLimit:$.transferLimit||2e5,dailyWithdrawalLimit:$.dailyWithdrawLimit||1e5,dailyTransferLimit:$.dailyTransferLimit||6e4,monthlyWithdrawalUsage:Ce,monthlyTransferUsage:Re,dailyWithdrawalUsage:Lt,dailyTransferUsage:bt,lastResetDate:new Date().toISOString().split("T")[0],defaultTransferCommission:$.defaultTransferCommission!=null?Number($.defaultTransferCommission):null,defaultWithdrawCommission:$.defaultWithdrawCommission!=null?Number($.defaultWithdrawCommission):null}}))).map(z);j(te),console.log("Wallets loaded successfully:",te)}catch(Q){console.error("Error loading wallets:",Q),console.log("تم تحميل المحافظ من البيانات المحفوظة محلياً");const ue=localStorage.getItem(p());if(ue){const Se=JSON.parse(ue);j(Se.map(be=>({...be,phone:be.phone||be.phoneNumber,monthlyWithdrawalLimit:be.monthlyWithdrawalLimit||2e5,monthlyTransferLimit:be.monthlyTransferLimit||2e5})))}}finally{Ee(!1)}})()},[v==null?void 0:v.uid]);const ne=()=>{U(""),B(""),C(""),L(""),J("200000"),ae("200000"),H("100000"),Te("60000"),re(!1),b(null),x(!1)},Me=async()=>{if(!M.trim()||!Z.trim()||!_.trim()){y({title:"خطأ",description:"يرجى ملء جميع الحقول المطلوبة",variant:"destructive"});return}if(!(v!=null&&v.uid)){y({title:"خطأ",description:"يجب تسجيل الدخول أولاً",variant:"destructive"});return}Ee(!0);try{if(S){await js.update(S.id,{label:M.trim(),msisdn:Z.trim(),withdrawLimit:parseInt(O),transferLimit:parseInt(he),dailyWithdrawLimit:parseInt(pe),dailyTransferLimit:parseInt(X)}),await hs.setLimits(S.id,{dailyTransferLimit:parseInt(X||"0"),dailyWithdrawLimit:parseInt(pe||"0"),monthlyTransferLimit:parseInt(he||"0"),monthlyWithdrawLimit:parseInt(O||"0")});const D=A.map(Q=>Q.id===S.id?{...Q,name:M.trim(),phone:Z.trim(),nationalId:k.trim(),walletProvider:_,monthlyWithdrawalLimit:parseInt(O),monthlyTransferLimit:parseInt(he),dailyWithdrawalLimit:parseInt(pe),dailyTransferLimit:parseInt(X)}:Q);j(D),localStorage.setItem(p(),JSON.stringify(D)),y({title:"تم التحديث",description:"تم تحديث المحفظة بنجاح"})}else{const D={merchantUserId:v.uid,provider:_,msisdn:Z.trim(),label:M.trim(),isActive:!0,dailyLimit:2e5,monthlyLimit:2e5,withdrawLimit:parseInt(O),transferLimit:parseInt(he),dailyTransferLimit:parseInt(X),dailyWithdrawLimit:parseInt(pe),dailyUsage:0,monthlyUsage:0,transferUsage:0,withdrawUsage:0},Q=await js.create(D);await hs.setLimits(Q,{dailyTransferLimit:parseInt(X||"0"),dailyWithdrawLimit:parseInt(pe||"0"),monthlyTransferLimit:parseInt(he||"0"),monthlyWithdrawLimit:parseInt(O||"0")});const ue=new Date().toISOString().split("T")[0],Se={id:Q,name:M.trim(),phone:Z.trim(),nationalId:k.trim(),walletProvider:_,isDefault:K,monthlyWithdrawalLimit:parseInt(O),monthlyTransferLimit:parseInt(he),dailyWithdrawalLimit:parseInt(pe),dailyTransferLimit:parseInt(X),monthlyWithdrawalUsage:0,monthlyTransferUsage:0,dailyWithdrawalUsage:0,dailyTransferUsage:0,lastResetDate:ue,defaultTransferCommission:null,defaultWithdrawCommission:null},be=[...A,Se];j(be),localStorage.setItem(p(),JSON.stringify(be)),y({title:"تم الإنشاء",description:"تم إنشاء المحفظة بنجاح"})}o&&o(),ne(),x(!1),b(null)}catch(D){console.error("Error saving wallet:",D),y({title:"خطأ",description:"حدث خطأ أثناء حفظ المحفظة",variant:"destructive"})}finally{Ee(!1)}},nt=D=>{b(D),U(D.name),B(D.phone),C(D.nationalId||""),L(D.walletProvider||""),J(D.monthlyWithdrawalLimit.toString()),ae(D.monthlyTransferLimit.toString()),re(D.isDefault),x(!0)},Qe=async D=>{const Q=A.find(ue=>ue.id===D);if(Q!=null&&Q.isDefault){y({title:"تحذير",description:"لا يمكن حذف المحفظة الافتراضية",variant:"destructive"});return}if(!(v!=null&&v.uid)){y({title:"خطأ",description:"يجب تسجيل الدخول أولاً",variant:"destructive"});return}Ee(!0);try{await js.delete(D);const ue=A.filter(Se=>Se.id!==D);j(ue),localStorage.setItem(p(),JSON.stringify(ue)),o&&o(),y({title:"تم الحذف",description:"تم حذف المحفظة بنجاح"})}catch(ue){console.error("Error deleting wallet:",ue),y({title:"خطأ",description:"حدث خطأ أثناء حذف المحفظة",variant:"destructive"})}finally{Ee(!1)}},_e=D=>{const Q=A.map(ue=>({...ue,isDefault:ue.id===D}));j(Q),localStorage.setItem(p(),JSON.stringify(Q)),o&&o(),y({title:"تم تحديث المحفظة الافتراضية",description:"تم تعيين المحفظة كافتراضية بنجاح"})};return e.jsxs(ie,{open:l,onOpenChange:h,children:[e.jsxs(oe,{className:"max-w-4xl max-h-[80vh] overflow-y-auto",children:[e.jsx(ce,{className:"pb-2",children:e.jsxs(de,{className:"flex items-center gap-1 text-sm",children:[e.jsx(Qt,{className:"h-3 w-3"}),"إدارة المحافظ"]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h3",{className:"text-sm font-semibold",children:["المحافظ المتاحة (",A.length,")"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(d,{onClick:()=>ut(!0),className:"flex items-center gap-1 h-6 px-2 text-xs",size:"sm",variant:"outline",children:[e.jsx(st,{className:"h-3 w-3"}),"الاطلاع على المحافظ"]}),e.jsxs(d,{onClick:()=>{h(),t("/user/add-wallet")},className:"flex items-center gap-1 h-6 px-2 text-xs",size:"sm",children:[e.jsx(ft,{className:"h-3 w-3"}),"إضافة محفظة جديدة"]})]})]}),(m||S)&&e.jsxs(Ve,{className:"border-2 border-blue-200 bg-blue-50",children:[e.jsx(ht,{className:"pb-1",children:e.jsx(At,{className:"text-sm",children:S?"تعديل المحفظة":"إضافة محفظة جديدة"})}),e.jsxs(He,{className:"space-y-2 pt-1",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"شركة المحفظة"}),e.jsx("div",{className:"flex gap-1 items-center",children:e.jsxs(ks,{value:_,onValueChange:L,children:[e.jsx(As,{className:"h-6 text-xs flex-1",children:e.jsx(Ps,{placeholder:"اختر شركة المحفظة"})}),e.jsx(Os,{children:fn.map(D=>e.jsx(Ht,{value:D.id,className:"text-xs",children:e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsx("span",{children:D.name}),e.jsx("button",{type:"button",className:"h-4 w-4 p-0 ml-2 flex items-center justify-center hover:bg-blue-100 rounded",onClick:Q=>{Q.preventDefault(),Q.stopPropagation(),at(D.id)},children:e.jsx(Sn,{className:"h-3 w-3 text-blue-500 hover:text-blue-700"})})]})},D.id))})]})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"اسم المحفظة"}),e.jsx(R,{value:M,onChange:D=>U(D.target.value),placeholder:"مثال: محفظة العمل",className:"h-6 text-xs"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"رقم الهاتف"}),e.jsxs("div",{className:"relative",children:[e.jsx(us,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(R,{value:Z,onChange:D=>B(D.target.value),placeholder:"01030302038",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الرقم القومي للخط"}),e.jsxs("div",{className:"relative",children:[e.jsx(pr,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(R,{value:k,onChange:D=>C(D.target.value),placeholder:"29012345678901",maxLength:14,className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد الشهري للسحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Ge,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(R,{type:"number",value:O,onChange:D=>J(D.target.value),placeholder:"200000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد الشهري للتحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Ge,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(R,{type:"number",value:he,onChange:D=>ae(D.target.value),placeholder:"200000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد اليومي للسحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Da,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-red-400"}),e.jsx(R,{type:"number",value:pe,onChange:D=>H(D.target.value),placeholder:"100000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد اليومي للتحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(ea,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-blue-400"}),e.jsx(R,{type:"number",value:X,onChange:D=>Te(D.target.value),placeholder:"60000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",id:"isDefault",checked:K,onChange:D=>re(D.target.checked),className:"rounded w-3 h-3"}),e.jsx("label",{htmlFor:"isDefault",className:"text-xs font-medium text-gray-700",children:"تعيين كمحفظة افتراضية"})]}),e.jsx("div",{className:"border-t pt-2 mt-2",children:e.jsxs("div",{className:"flex items-center gap-1 mb-2",children:[e.jsx(Yl,{className:"h-3 w-3 text-gray-600"}),e.jsx("label",{className:"text-xs font-medium text-gray-700",children:"إعدادات العمولة"})]})}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(d,{onClick:Me,className:"flex-1 h-6 text-xs",size:"sm",children:S?"تحديث المحفظة":"إضافة المحفظة"}),e.jsx(d,{variant:"outline",onClick:ne,className:"h-6 text-xs",size:"sm",children:"إلغاء"})]})]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2",children:A.map(D=>{var Q;return e.jsxs(Ve,{className:`${D.isDefault?"border-green-300 bg-green-50":""}`,children:[e.jsx(ht,{className:"pb-1",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(At,{className:"text-sm flex items-center gap-1",children:[e.jsx(Qt,{className:"h-3 w-3"}),D.name]}),D.isDefault&&e.jsx(dt,{variant:"default",className:"bg-green-600 text-xs px-1 py-0",children:"افتراضية"})]})}),e.jsxs(He,{className:"space-y-1 pt-0",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(us,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"text-xs",children:D.phone})]}),D.walletProvider&&e.jsx("div",{className:"text-xs text-blue-600 mt-1",children:((Q=fn.find(ue=>ue.id===D.walletProvider))==null?void 0:Q.name)||D.walletProvider}),e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-2 rounded-md border border-gray-200 shadow-sm space-y-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-gray-600 mb-1",children:"الحدود الشهرية"}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-red-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-red-400 to-red-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((D.monthlyWithdrawalUsage||0)/D.monthlyWithdrawalLimit*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-blue-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-400 to-blue-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((D.monthlyTransferUsage||0)/D.monthlyTransferLimit*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-xs text-red-600 font-medium",children:["متبقي سحب: ",Math.max(D.monthlyWithdrawalLimit-(D.monthlyWithdrawalUsage||0),0)," جنيه"]}),e.jsxs("div",{className:"text-xs text-blue-600 font-medium",children:["متبقي تحويل: ",Math.max(D.monthlyTransferLimit-(D.monthlyTransferUsage||0),0)," جنيه"]})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-gray-600 mb-1",children:"الحدود اليومية"}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-orange-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-orange-400 to-orange-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((D.dailyWithdrawalUsage||0)/D.dailyWithdrawalLimit*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-green-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-green-400 to-green-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((D.dailyTransferUsage||0)/D.dailyTransferLimit*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-xs text-orange-600 font-medium",children:["متبقي سحب يومي: ",Math.max(D.dailyWithdrawalLimit-(D.dailyWithdrawalUsage||0),0)," جنيه"]}),e.jsxs("div",{className:"text-xs text-green-600 font-medium",children:["متبقي تحويل يومي: ",Math.max(D.dailyTransferLimit-(D.dailyTransferUsage||0),0)," جنيه"]})]})]})]}),e.jsxs("div",{className:"flex gap-1 pt-1",children:[e.jsxs(d,{size:"sm",variant:"outline",onClick:()=>nt(D),className:"flex-1 h-5 text-xs px-1",children:[e.jsx(ai,{className:"h-2 w-2 mr-0.5"}),"تعديل"]}),!D.isDefault&&e.jsxs(e.Fragment,{children:[e.jsx(d,{size:"sm",variant:"outline",onClick:()=>_e(D.id),className:"flex-1 h-5 text-xs px-1",children:"جعلها افتراضية"}),e.jsx(d,{size:"sm",variant:"destructive",onClick:()=>Qe(D.id),className:"h-5 px-1",children:e.jsx(Wt,{className:"h-2 w-2"})})]})]})]})]},D.id)})}),A.length===0&&e.jsx("div",{className:"text-center py-4 text-gray-500 text-xs",children:"لا توجد محافظ متاحة. قم بإضافة محفظة جديدة للبدء."})]}),ke&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-800",children:"معلومات صاحب المحفظة"}),e.jsx("button",{onClick:()=>at(null),className:"h-8 w-8 p-0 flex items-center justify-center hover:bg-gray-100 rounded-full transition-colors",children:e.jsx(Hl,{className:"h-4 w-4 text-gray-500"})})]}),(()=>{const D=fn.find(Q=>Q.id===ke);return D?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-center mb-6",children:e.jsx("div",{className:"bg-blue-100 p-3 rounded-lg inline-block",children:e.jsx("h4",{className:"font-bold text-blue-700 text-lg",children:D.name})})}),e.jsx("div",{className:"bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-200",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-white p-3 rounded-lg shadow-sm",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full mr-2"}),e.jsx("span",{className:"font-semibold text-gray-700",children:"اسم صاحب المحفظة:"})]}),e.jsx("p",{className:"text-gray-900 font-medium text-lg mr-4",children:D.ownerName})]}),e.jsxs("div",{className:"bg-white p-3 rounded-lg shadow-sm",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full mr-2"}),e.jsx("span",{className:"font-semibold text-gray-700",children:"الرقم القومي:"})]}),e.jsx("p",{className:"text-gray-900 font-mono text-lg mr-4 tracking-wider",children:D.nationalId})]})]})}),e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 p-3 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(Sn,{className:"h-4 w-4 text-yellow-600 mr-2"}),e.jsx("span",{className:"text-sm text-yellow-800 font-medium",children:"هذه البيانات مسجلة رسمياً في النظام لهذه المحفظة"})]})})]}):null})()]})})]}),e.jsx(Bs,{open:Ye,onOpenChange:ut,mode:"verify",title:"إدخال الرقم السري الرئيسي",description:"لا يمكن الاطلاع على المحافظ إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{ut(!1),qe(!0)}}),e.jsx(nd,{isOpen:yt,onClose:()=>qe(!1),onWalletSelect:D=>{Be(D),qe(!1)},onEditWallet:D=>{t(`/user/add-wallet?edit=1&id=${D.id}`),qe(!1)},onDeleteWallet:async D=>{try{if(await js.delete(D),j(Q=>{const ue=Q.filter(Se=>Se.id!==D);try{localStorage.setItem(p(),JSON.stringify(ue))}catch(Se){console.error("Failed to update localStorage wallets after delete:",Se)}return ue}),o)try{await o()}catch(Q){console.error("onWalletUpdate callback failed:",Q)}}catch(Q){console.error("Error deleting wallet:",Q)}}}),e.jsx(id,{wallet:rt,isOpen:!!rt,onClose:()=>Be(null),onBack:()=>{Be(null),qe(!0)}})]})},cd=({isOpen:l,onClose:h,transaction:o,onDelete:u})=>{if(!o)return null;const y=m=>{switch(m){case"completed":return e.jsx(Ms,{className:"h-5 w-5 text-green-500"});case"pending":return e.jsx(Ls,{className:"h-5 w-5 text-yellow-500"});case"failed":return e.jsx(Tn,{className:"h-5 w-5 text-red-500"});default:return e.jsx(Ls,{className:"h-5 w-5 text-gray-500"})}},v=m=>{switch(m){case"completed":return"مكتملة";case"pending":return"قيد الانتظار";case"failed":return"فاشلة";default:return"غير معروف"}},t=m=>{switch(m){case"withdraw":return"سحب";case"send":return"إرسال";case"receive":return"استقبال";default:return"تحويل"}},A=()=>{const m=!!o.senderNumber,x=!!o.senderName,S=m?"الرقم المرسل:":x?"الرقم الراسل:":"رقم المحفظة:",b=m?o.senderNumber:x?o.senderName:o.senderPhone,M=`
      <div style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 500px; margin: 0 auto; padding: 30px; background: #fff;">
        <!-- Header -->
        <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #2563eb; padding-bottom: 20px;">
          <h1 style="color: #2563eb; margin-bottom: 5px; font-size: 28px;">إيصال المعاملة</h1>
          <p style="color: #666; font-size: 16px; margin: 0;">رقم المرجع: ${o.transactionReference||o.id}</p>
          <p style="color: #888; font-size: 14px; margin: 5px 0 0 0;">${new Date().toLocaleString("ar-EG")}</p>
        </div>
        
        <!-- Shop Info -->
        <div style="background: #f8fafc; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
          <h3 style="color: #1e293b; margin: 0 0 15px 0; font-size: 18px;">معلومات المحل</h3>
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span style="font-weight: 600; color: #475569;">اسم المحل:</span>
            <span style="color: #1e293b;">${o.merchantShopName||o.shopName||"غير محدد"}</span>
          </div>
        </div>
        
        <!-- Transaction Details -->
        <div style="background: #fff; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
          <h3 style="color: #1e293b; margin: 0 0 15px 0; font-size: 18px;">تفاصيل المعاملة</h3>
          
          <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
            <span style="font-weight: 600; color: #475569;">نوع المعاملة:</span>
            <span style="color: #2563eb; font-weight: 600;">${t(o.type)}</span>
          </div>
          
          <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
            <span style="font-weight: 600; color: #475569;">الحالة:</span>
            <span style="color: ${o.status==="completed"?"#16a34a":o.status==="pending"?"#ca8a04":"#dc2626"}; font-weight: 600;">
              ${v(o.status)}
            </span>
          </div>

          ${o!=null&&o.cashierName?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الكاشير:</span>
              <span style="color: #1e293b;">${o.cashierName}</span>
            </div>
          `:""}
          
          ${o.type!=="withdraw"?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">${S}</span>
              <span style="color: #1e293b;">${b}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الرقم المستقبل:</span>
              <span style="color: #1e293b;">${o.receiverNumber||o.receiverPhone}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">المبلغ المحول:</span>
              <span style="color: #2563eb; font-weight: bold; font-size: 16px;">${o.transferredAmount||o.amount} جنيه</span>
            </div>
          `:`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">رقم المحفظة:</span>
              <span style="color: #1e293b;">${o.senderPhone}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">المبلغ المسحوب:</span>
              <span style="color: #dc2626; font-weight: bold; font-size: 16px;">${o.withdrawnAmountDetailed||o.withdrawnAmount||o.amount} جنيه</span>
            </div>
          `}
          
          ${o.commission?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">العمولة:</span>
              <span style="color: #f59e0b; font-weight: 600;">${o.commission} جنيه</span>
            </div>
          `:""}
          ${o!=null&&o.fee&&Number(o.fee)>0?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الرسوم:</span>
              <span style="color: #64748b; font-weight: 600;">${o.fee} جنيه</span>
            </div>
          `:""}
          
          <div style="display: flex; justify-content: space-between; padding: 8px 0;">
            <span style="font-weight: 600; color: #475569;">التاريخ والوقت:</span>
            <span style="color: #1e293b;">${o.createdAt.toLocaleString("ar-EG")}</span>
          </div>
        </div>
        
        <!-- Total Amount -->
        <div style="background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); border-radius: 12px; padding: 20px; margin-bottom: 20px; text-align: center;">
          <h3 style="color: white; margin: 0 0 10px 0; font-size: 16px;">إجمالي المبلغ</h3>
          <p style="color: white; font-size: 24px; font-weight: bold; margin: 0;">
            ${o.type==="withdraw"?"-":""}${o.amount} جنيه
          </p>
        </div>
        
        
        
        
        <!-- Footer -->
        <div style="text-align: center; color: #64748b; font-size: 12px; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
          <p style="margin: 0 0 5px 0;">شكراً لاستخدام خدماتنا</p>
          <p style="margin: 0;">تم إنشاء الإيصال في: ${new Date().toLocaleString("ar-EG")}</p>
        </div>
      </div>
    `,U=window.open("","_blank");U&&(U.document.write(`
        <html>
          <head>
            <title>إيصال المعاملة - ${o.transactionReference||o.id}</title>
            <meta charset="UTF-8">
            <style>
              body { 
                margin: 0; 
                padding: 20px; 
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: #f8fafc;
              }
              @media print {
                body { 
                  margin: 0; 
                  background: white;
                }
              }
            </style>
          </head>
          <body>
            ${M}
          </body>
        </html>
      `),U.document.close(),U.print())},j=()=>{window.confirm("هل أنت متأكد من حذف هذه المعاملة؟ لا يمكن التراجع عن هذا الإجراء.")&&(u(o.id),h())};return e.jsx(ie,{open:l,onOpenChange:h,children:e.jsxs(oe,{className:"w-[92vw] sm:w-auto sm:max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx(ce,{children:e.jsxs(de,{className:"flex items-center gap-2 text-xl",children:[e.jsx(hr,{className:"h-6 w-6 text-blue-600"}),"إيصال المعاملة المفصل"]})}),e.jsxs("div",{className:"space-y-6",children:[e.jsx(Ve,{className:"bg-gradient-to-r from-blue-50 to-indigo-50 border-blue-200",children:e.jsxs(ht,{className:"text-center pb-2",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 mb-2",children:[y(o.status),e.jsx(dt,{variant:o.status==="completed"?"default":"secondary",className:"text-sm",children:v(o.status)})]}),e.jsxs("h3",{className:"text-2xl font-bold text-blue-600",children:[o.type==="withdraw"?"-":"",o.amount," جنيه"]}),e.jsxs("p",{className:"text-sm text-gray-600",children:["رقم المرجع: ",o.transactionReference||o.id]})]})}),e.jsxs(Ve,{children:[e.jsx(ht,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Fc,{className:"h-5 w-5 text-green-600"}),e.jsx("h4",{className:"font-semibold text-lg",children:"معلومات المحل"})]})}),e.jsxs(He,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"اسم المحل:"}),e.jsx("span",{className:"text-gray-900",children:o.merchantShopName||o.shopName||"غير محدد"})]}),(o==null?void 0:o.cashierName)&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"الكاشير:"}),e.jsx("span",{className:"text-gray-900",children:o.cashierName})]})]})]}),e.jsxs(Ve,{children:[e.jsx(ht,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ia,{className:"h-5 w-5 text-blue-600"}),e.jsx("h4",{className:"font-semibold text-lg",children:"تفاصيل المعاملة"})]})}),e.jsx(He,{className:"space-y-3",children:e.jsxs("div",{className:"grid grid-cols-1 gap-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-blue-700",children:"نوع المعاملة:"}),e.jsx(dt,{variant:"outline",className:"bg-blue-100 text-blue-800",children:t(o.type)})]}),o.type!=="withdraw"?e.jsxs(e.Fragment,{children:[(()=>{const m=!!o.senderNumber,x=!!o.senderName,S=m?"الرقم المرسل:":x?"الرقم الراسل:":"رقم المحفظة:",b=m?o.senderNumber:x?o.senderName:o.senderPhone,M=m?wn:us;return e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(M,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:S})]}),e.jsx("span",{className:"text-gray-900 font-mono",children:b})]})})(),e.jsx("div",{className:"flex items-center justify-center p-2",children:e.jsx(Ec,{className:"h-6 w-6 text-blue-500"})}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-green-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(wn,{className:"h-4 w-4 text-green-500"}),e.jsx("span",{className:"font-medium text-green-700",children:"الرقم المستقبل:"})]}),e.jsx("span",{className:"text-green-900 font-mono",children:o.receiverNumber||o.receiverPhone})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ge,{className:"h-4 w-4 text-blue-500"}),e.jsx("span",{className:"font-medium text-blue-700",children:"المبلغ المحول:"})]}),e.jsxs("span",{className:"text-blue-900 font-bold text-lg",children:[o.transferredAmount||o.amount," جنيه"]})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(us,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:"رقم المحفظة:"})]}),e.jsx("span",{className:"text-gray-900 font-mono",children:o.senderPhone})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-red-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ge,{className:"h-4 w-4 text-red-500"}),e.jsx("span",{className:"font-medium text-red-700",children:"المبلغ المسحوب:"})]}),e.jsxs("span",{className:"text-red-900 font-bold text-lg",children:[o.withdrawnAmountDetailed||o.withdrawnAmount||o.amount," جنيه"]})]})]}),o.commission&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-yellow-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-yellow-700",children:"العمولة:"}),e.jsxs("span",{className:"text-yellow-900 font-semibold",children:[o.commission," جنيه"]})]}),(o==null?void 0:o.fee)&&Number(o.fee)>0&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"الرسوم:"}),e.jsxs("span",{className:"text-gray-900 font-semibold",children:[o.fee," جنيه"]})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ns,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:"التاريخ والوقت:"})]}),e.jsx("span",{className:"text-gray-900",children:o.createdAt.toLocaleString("ar-EG")})]})]})})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs(d,{onClick:A,className:"flex-1 bg-blue-600 hover:bg-blue-700 text-white",size:"lg",children:[e.jsx(Bc,{className:"h-5 w-5 mr-2"}),"طباعة الإيصال"]}),e.jsxs(d,{onClick:j,variant:"destructive",className:"flex-1",size:"lg",children:[e.jsx(Wt,{className:"h-5 w-5 mr-2"}),"حذف المعاملة"]})]}),e.jsx(d,{onClick:h,variant:"outline",className:"w-full",size:"lg",children:"إغلاق الإيصال"})]})]})})};function Ul({open:l,onOpenChange:h,onSuccess:o,title:u,description:y,currentBalance:v,balanceLabel:t,userId:A}){const[j,m]=r.useState(""),[x,S]=r.useState(v.toString()),[b,M]=r.useState(!1),[U,Z]=r.useState(""),[B,k]=r.useState(!1),C=ms.hasMasterPin(),_=async O=>{O.preventDefault(),Z(""),k(!0);try{const J=parseFloat(x);if(isNaN(J)||J<0){Z("يرجى إدخال مبلغ صحيح"),k(!1);return}C?ms.verifyMasterPin(j)?(o(J),h(!1),m(""),S("")):Z("الرقم السري غير صحيح"):Z("لم يتم تعيين رقم سري رئيسي. يرجى تعيين رقم سري رئيسي أولاً من إعدادات التطبيق")}catch{Z("حدث خطأ أثناء التحقق من الرقم السري")}finally{k(!1)}},L=()=>{m(""),S(v.toString()),Z(""),h(!1)};return mt.useEffect(()=>{l&&S(v.toString())},[v,l]),e.jsx(ie,{open:l,onOpenChange:L,children:e.jsxs(oe,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ce,{children:e.jsxs(de,{className:"flex items-center gap-2 text-right",children:[e.jsx(Ge,{className:"h-5 w-5"}),u]})}),e.jsxs("form",{onSubmit:_,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:y}),e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg",children:[e.jsxs(V,{className:"text-sm font-medium text-gray-700",children:[t," الحالي"]}),e.jsxs("div",{className:"text-lg font-bold text-gray-900 mt-1",children:[v.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"newAmount",className:"text-right",children:"المبلغ الجديد"}),e.jsx(R,{id:"newAmount",type:"number",step:"0.01",min:"0",value:x,onChange:O=>S(O.target.value),placeholder:"أدخل المبلغ الجديد",className:"text-right",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"pin",className:"text-right",children:"الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"pin",type:b?"text":"password",value:j,onChange:O=>m(O.target.value),placeholder:"أدخل الرقم السري",className:"text-right pr-10",required:!0}),e.jsx(d,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>M(!b),children:b?e.jsx(Ft,{className:"h-4 w-4"}):e.jsx(st,{className:"h-4 w-4"})})]})]}),U&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-red-600 bg-red-50 p-2 rounded",children:[e.jsx(Us,{className:"h-4 w-4"}),U]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(d,{type:"button",variant:"outline",onClick:L,className:"flex-1",children:"إلغاء"}),e.jsx(d,{type:"submit",disabled:B||!j||!x,className:"flex-1",children:B?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"جاري التحديث..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Rs,{className:"h-4 w-4 mr-2"}),"تحديث الرصيد"]})})]})]})]})})}class Ca{static getSecretKey(h){return h?`${this.SECRET_KEY_BASE}_${h}`:this.SECRET_KEY_BASE}static setSecretPin(h,o){const u=btoa(h);this.secretCache.set(this.getSecretKey(o),u)}static hasSecretPin(h){return this.secretCache.has(this.getSecretKey(h))}static verifySecretPin(h,o){const u=this.secretCache.get(this.getSecretKey(o));if(!u)return!1;try{return atob(u)===h}catch{return!1}}static clearSecretPin(h){this.secretCache.delete(this.getSecretKey(h))}}hn(Ca,"SECRET_KEY_BASE","dashboard_secret_pin"),hn(Ca,"secretCache",new Map);function dd({open:l,onOpenChange:h,userId:o}){const[u,y]=r.useState(""),[v,t]=r.useState(""),[A,j]=r.useState(""),[m,x]=r.useState(!1),[S,b]=r.useState(!1),[M,U]=r.useState(!1),[Z,B]=r.useState(""),[k,C]=r.useState(!1),{toast:_}=Xt(),L=Ca.hasSecretPin(o),O=async he=>{he.preventDefault(),B(""),C(!0);try{if(!v||v.length<4){B("يجب أن يكون الرقم السري 4 أرقام على الأقل"),C(!1);return}if(v!==A){B("الرقم السري الجديد وتأكيده غير متطابقين"),C(!1);return}if(L){if(!u){B("يرجى إدخال الرقم السري الحالي"),C(!1);return}if(!Ca.verifySecretPin(u,o)){B("الرقم السري الحالي غير صحيح"),C(!1);return}}Ca.setSecretPin(v,o),_({title:L?"تم تغيير الرقم السري":"تم تعيين الرقم السري",description:L?"تم تغيير الرقم السري بنجاح":"تم تعيين الرقم السري بنجاح"}),J()}catch{B("حدث خطأ أثناء حفظ الرقم السري")}finally{C(!1)}},J=()=>{y(""),t(""),j(""),B(""),x(!1),b(!1),U(!1),h(!1)};return e.jsx(ie,{open:l,onOpenChange:J,children:e.jsxs(oe,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ce,{children:e.jsxs(de,{className:"flex items-center gap-2 text-right",children:[e.jsx(Yl,{className:"h-5 w-5"}),L?"تغيير الرقم السري":"تعيين الرقم السري"]})}),e.jsxs("form",{onSubmit:O,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:L?"أدخل الرقم السري الحالي والرقم السري الجديد لتغييره":"أدخل الرقم السري الجديد الذي تريد استخدامه في عمليات التعديل"}),L&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"currentPin",type:m?"text":"password",autoComplete:"off",value:u,onChange:he=>y(he.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(d,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>x(!m),children:m?e.jsx(Ft,{className:"h-4 w-4"}):e.jsx(st,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"newPin",type:S?"text":"password",autoComplete:"off",value:v,onChange:he=>t(he.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(d,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>b(!S),children:S?e.jsx(Ft,{className:"h-4 w-4"}):e.jsx(st,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"confirmPin",type:M?"text":"password",autoComplete:"off",value:A,onChange:he=>j(he.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(d,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>U(!M),children:M?e.jsx(Ft,{className:"h-4 w-4"}):e.jsx(st,{className:"h-4 w-4"})})]})]}),Z&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(Us,{className:"h-4 w-4"}),Z]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(d,{type:"submit",disabled:k,className:"flex-1",children:[e.jsx(Rs,{className:"h-4 w-4 mr-2"}),k?"جاري الحفظ...":L?"تغيير الرقم السري":"تعيين الرقم السري"]}),e.jsx(d,{type:"button",variant:"outline",onClick:J,disabled:k,children:"إلغاء"})]})]})]})})}const vn=new Map;function md({open:l,onOpenChange:h,userId:o}){const[u,y]=r.useState(""),[v,t]=r.useState(""),[A,j]=r.useState(""),[m,x]=r.useState(!1),[S,b]=r.useState(!1),[M,U]=r.useState(!1),[Z,B]=r.useState(""),[k,C]=r.useState(!1),{toast:_}=Xt(),L=o?`cash_drawer_pin_${o}`:"cash_drawer_pin",O=()=>vn.has(L),J=H=>{const X=vn.get(L);if(!X)return!1;try{return atob(X)===H}catch{return!1}},he=H=>{const X=btoa(H);vn.set(L,X)},ae=async H=>{H.preventDefault(),B(""),C(!0);try{if(!v||v.length<4){B("يجب أن يكون الرقم السري 4 أرقام على الأقل"),C(!1);return}if(v!==A){B("الرقم السري الجديد وتأكيده غير متطابقين"),C(!1);return}if(O()){if(!u){B("يرجى إدخال الرقم السري الحالي لدرج النقدية"),C(!1);return}if(!J(u)){B("الرقم السري الحالي لدرج النقدية غير صحيح"),C(!1);return}}he(v),_({title:O()?"تم تغيير رقم درج النقدية":"تم تعيين رقم درج النقدية",description:O()?"تم تغيير الرقم السري لدرج النقدية بنجاح":"تم تعيين الرقم السري لدرج النقدية بنجاح"}),pe()}catch{B("حدث خطأ أثناء حفظ الرقم السري لدرج النقدية")}finally{C(!1)}},pe=()=>{y(""),t(""),j(""),B(""),x(!1),b(!1),U(!1),h(!1)};return e.jsx(ie,{open:l,onOpenChange:pe,children:e.jsxs(oe,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ce,{children:e.jsxs(de,{className:"flex items-center gap-2 text-right",children:[e.jsx(Ge,{className:"h-5 w-5 text-green-600"}),O()?"تغيير رقم درج النقدية":"تعيين رقم درج النقدية"]})}),e.jsxs("form",{onSubmit:ae,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:O()?"أدخل الرقم السري الحالي والرقم السري الجديد لدرج النقدية":"أدخل الرقم السري الجديد الذي تريد استخدامه لحماية درج النقدية"}),O()&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي لدرج النقدية"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"currentPin",type:m?"text":"password",autoComplete:"off",value:u,onChange:H=>y(H.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(d,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>x(!m),children:m?e.jsx(Ft,{className:"h-4 w-4"}):e.jsx(st,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد لدرج النقدية"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"newPin",type:S?"text":"password",autoComplete:"off",value:v,onChange:H=>t(H.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(d,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>b(!S),children:S?e.jsx(Ft,{className:"h-4 w-4"}):e.jsx(st,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"confirmPin",type:M?"text":"password",autoComplete:"off",value:A,onChange:H=>j(H.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(d,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>U(!M),children:M?e.jsx(Ft,{className:"h-4 w-4"}):e.jsx(st,{className:"h-4 w-4"})})]})]}),Z&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(Us,{className:"h-4 w-4"}),Z]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(d,{type:"submit",disabled:k,className:"flex-1 bg-green-600 hover:bg-green-700",children:[e.jsx(Rs,{className:"h-4 w-4 mr-2"}),k?"جاري الحفظ...":O()?"تغيير رقم درج النقدية":"تعيين رقم درج النقدية"]}),e.jsx(d,{type:"button",variant:"outline",onClick:pe,disabled:k,children:"إلغاء"})]})]}),e.jsx("div",{className:"text-xs text-gray-500 text-center mt-2",children:"💰 هذا الرقم السري خاص بحماية درج النقدية فقط"})]})})}const yn=new Map;function hd({open:l,onOpenChange:h,userId:o}){const[u,y]=r.useState(""),[v,t]=r.useState(""),[A,j]=r.useState(""),[m,x]=r.useState(!1),[S,b]=r.useState(!1),[M,U]=r.useState(!1),[Z,B]=r.useState(""),[k,C]=r.useState(!1),{toast:_}=Xt(),L=o?`wallet_total_pin_${o}`:"wallet_total_pin",O=()=>yn.has(L),J=H=>{const X=yn.get(L);if(!X)return!1;try{return atob(X)===H}catch{return!1}},he=H=>{const X=btoa(H);yn.set(L,X)},ae=async H=>{H.preventDefault(),B(""),C(!0);try{if(!v||v.length<4){B("يجب أن يكون الرقم السري 4 أرقام على الأقل"),C(!1);return}if(v!==A){B("الرقم السري الجديد وتأكيده غير متطابقين"),C(!1);return}if(O()){if(!u){B("يرجى إدخال الرقم السري الحالي لإجمالي المحفظة"),C(!1);return}if(!J(u)){B("الرقم السري الحالي لإجمالي المحفظة غير صحيح"),C(!1);return}}he(v),_({title:O()?"تم تغيير رقم إجمالي المحفظة":"تم تعيين رقم إجمالي المحفظة",description:O()?"تم تغيير الرقم السري لإجمالي المحفظة بنجاح":"تم تعيين الرقم السري لإجمالي المحفظة بنجاح"}),pe()}catch{B("حدث خطأ أثناء حفظ الرقم السري لإجمالي المحفظة")}finally{C(!1)}},pe=()=>{y(""),t(""),j(""),B(""),x(!1),b(!1),U(!1),h(!1)};return e.jsx(ie,{open:l,onOpenChange:pe,children:e.jsxs(oe,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ce,{children:e.jsxs(de,{className:"flex items-center gap-2 text-right",children:[e.jsx(Qt,{className:"h-5 w-5 text-blue-600"}),O()?"تغيير رقم إجمالي المحفظة":"تعيين رقم إجمالي المحفظة"]})}),e.jsxs("form",{onSubmit:ae,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:O()?"أدخل الرقم السري الحالي والرقم السري الجديد لإجمالي المحفظة":"أدخل الرقم السري الجديد الذي تريد استخدامه لحماية إجمالي المحفظة"}),O()&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي لإجمالي المحفظة"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"currentPin",type:m?"text":"password",autoComplete:"off",value:u,onChange:H=>y(H.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(d,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>x(!m),children:m?e.jsx(Ft,{className:"h-4 w-4"}):e.jsx(st,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد لإجمالي المحفظة"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"newPin",type:S?"text":"password",autoComplete:"off",value:v,onChange:H=>t(H.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(d,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>b(!S),children:S?e.jsx(Ft,{className:"h-4 w-4"}):e.jsx(st,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"confirmPin",type:M?"text":"password",autoComplete:"off",value:A,onChange:H=>j(H.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(d,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>U(!M),children:M?e.jsx(Ft,{className:"h-4 w-4"}):e.jsx(st,{className:"h-4 w-4"})})]})]}),Z&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(Us,{className:"h-4 w-4"}),Z]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(d,{type:"submit",disabled:k,className:"flex-1 bg-blue-600 hover:bg-blue-700",children:[e.jsx(Rs,{className:"h-4 w-4 mr-2"}),k?"جاري الحفظ...":O()?"تغيير رقم إجمالي المحفظة":"تعيين رقم إجمالي المحفظة"]}),e.jsx(d,{type:"button",variant:"outline",onClick:pe,disabled:k,children:"إلغاء"})]})]}),e.jsx("div",{className:"text-xs text-gray-500 text-center mt-2",children:"💼 هذا الرقم السري خاص بحماية إجمالي المحفظة فقط"})]})})}function ud({open:l,onOpenChange:h,onSuccess:o,title:u,description:y,currentBalance:v,balanceLabel:t,userId:A}){const[j,m]=r.useState(""),[x,S]=r.useState(""),[b,M]=r.useState("add"),[U,Z]=r.useState(!1),[B,k]=r.useState(""),[C,_]=r.useState(!1),L=ms.hasMasterPin(),O=async ae=>{ae.preventDefault(),k(""),_(!0);try{const pe=parseFloat(x);if(isNaN(pe)||pe<=0){k("يرجى إدخال مبلغ صحيح أكبر من صفر"),_(!1);return}if(b==="subtract"&&pe>v){k("لا يمكن خصم مبلغ أكبر من الرصيد الحالي"),_(!1);return}if(L)if(ms.verifyMasterPin(j)){const H=b==="add"?pe:-pe;J(),o(H)}else k("الرقم السري غير صحيح");else k("لم يتم تعيين رقم سري رئيسي. يرجى تعيين رقم سري رئيسي أولاً من إعدادات التطبيق")}catch{k("حدث خطأ أثناء التحقق من الرقم السري")}finally{_(!1)}},J=()=>{m(""),S(""),M("add"),k(""),h(!1)},he=()=>{const ae=parseFloat(x)||0;return b==="add"?v+ae:v-ae};return e.jsx(ie,{open:l,onOpenChange:J,children:e.jsxs(oe,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ce,{children:e.jsxs(de,{className:"flex items-center gap-2 text-right",children:[b==="add"?e.jsx(ft,{className:"h-5 w-5 text-green-600"}):e.jsx(Es,{className:"h-5 w-5 text-red-600"}),u]})}),e.jsxs("form",{onSubmit:O,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:y}),e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg",children:[e.jsxs(V,{className:"text-sm font-medium text-gray-700",children:[t," الحالي"]}),e.jsxs("div",{className:"text-lg font-bold text-gray-900 mt-1",children:[v.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{className:"text-right",children:"نوع العملية"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(d,{type:"button",variant:b==="add"?"default":"outline",onClick:()=>M("add"),className:"flex-1 flex items-center gap-2",children:[e.jsx(ft,{className:"h-4 w-4"}),"إضافة"]}),e.jsxs(d,{type:"button",variant:b==="subtract"?"default":"outline",onClick:()=>M("subtract"),className:"flex-1 flex items-center gap-2",children:[e.jsx(Es,{className:"h-4 w-4"}),"خصم"]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(V,{htmlFor:"amount",className:"text-right",children:["المبلغ المراد ",b==="add"?"إضافته":"خصمه"]}),e.jsx(R,{id:"amount",type:"number",step:"0.01",min:"0.01",value:x,onChange:ae=>S(ae.target.value),placeholder:`أدخل المبلغ المراد ${b==="add"?"إضافته":"خصمه"}`,className:"text-right",required:!0})]}),x&&!isNaN(parseFloat(x))&&e.jsxs("div",{className:`p-3 rounded-lg ${b==="add"?"bg-green-50 border border-green-200":"bg-red-50 border border-red-200"}`,children:[e.jsx(V,{className:"text-sm font-medium text-gray-700",children:"الرصيد الجديد المتوقع"}),e.jsxs("div",{className:`text-lg font-bold mt-1 ${b==="add"?"text-green-700":"text-red-700"}`,children:[he().toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"pin",className:"text-right",children:"الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"pin",type:U?"text":"password",autoComplete:"off",value:j,onChange:ae=>m(ae.target.value),placeholder:"أدخل الرقم السري",className:"text-right pr-10",required:!0}),e.jsx(d,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>Z(!U),children:U?e.jsx(Ft,{className:"h-4 w-4"}):e.jsx(st,{className:"h-4 w-4"})})]})]}),B&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-red-600 bg-red-50 p-2 rounded",children:[e.jsx(Us,{className:"h-4 w-4"}),B]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(d,{type:"button",variant:"outline",onClick:J,className:"flex-1",children:"إلغاء"}),e.jsx(d,{type:"submit",disabled:C||!j||!x,className:`flex-1 ${b==="add"?"bg-green-600 hover:bg-green-700":"bg-red-600 hover:bg-red-700"}`,children:C?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"جاري التحديث..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Rs,{className:"h-4 w-4 mr-2"}),b==="add"?"إضافة المبلغ":"خصم المبلغ"]})})]})]})]})})}function xd(l){return l?`readBroadcastIds_${l}`:"readBroadcastIds_guest"}function pd({className:l}){const{user:h,profile:o}=xs(),[u,y]=r.useState([]),[v,t]=r.useState(new Set);r.useState(null);const[A,j]=r.useState(!1);r.useRef(new Set),r.useRef(!1);const m=r.useRef(null),x=r.useRef(null);r.useRef(null),r.useState({position:"fixed",top:0,left:0,zIndex:1e4});const S=!1,b=r.useMemo(()=>{const C=["global"];return h!=null&&h.uid&&C.push(`user:${h.uid}`),o!=null&&o.shopId&&C.push(`shop:${o.shopId}`),C},[h==null?void 0:h.uid,o==null?void 0:o.shopId]),M=xd(h==null?void 0:h.uid);r.useEffect(()=>{try{const C=localStorage.getItem(M);if(C){const _=JSON.parse(C);Array.isArray(_)&&t(new Set(_.filter(Boolean)))}else t(new Set)}catch(C){console.warn("Failed to load read ids",C),t(new Set)}},[M]),r.useEffect(()=>{const C=Kc(b,_=>{y(_)});return()=>C()},[b]),r.useEffect(()=>{},[u]),r.useEffect(()=>()=>{m.current&&clearTimeout(m.current)},[]);const U=u.reduce((C,_)=>C+(_.id&&!v.has(_.id)?1:0),0),Z=C=>{if(!C||v.has(C))return;const _=new Set(v);_.add(C),t(_);try{localStorage.setItem(M,JSON.stringify(Array.from(_)))}catch{}},B=()=>{const C=u.map(L=>L.id).filter(Boolean),_=new Set(v);C.forEach(L=>_.add(L)),t(_);try{localStorage.setItem(M,JSON.stringify(Array.from(_)))}catch{}},k=(C,_)=>{C&&window.open(C,"_blank"),_&&Z(_)};return r.useEffect(()=>{},[A]),e.jsxs("div",{className:`relative inline-block ${l||""}`,ref:x,children:[e.jsxs(qc,{onOpenChange:C=>{C&&U>0&&B()},children:[e.jsx(Yc,{asChild:!0,children:e.jsx(d,{variant:"ghost",className:"relative h-8 w-8 rounded-full p-0 hover:bg-transparent focus:ring-1 focus:ring-primary focus:ring-offset-1 transition-all",title:"الإشعارات",children:e.jsxs("div",{className:"relative h-8 w-8 rounded-full bg-primary/10 flex items-center justify-center border border-border shadow-sm hover:shadow-md",children:[e.jsx($l,{className:"h-4 w-4 text-primary"}),U>0&&e.jsx("span",{className:"absolute -top-1 -right-1 min-w-[18px] h-[18px] px-1 rounded-full bg-red-500 text-white text-[10px] font-bold flex items-center justify-center shadow",children:U})]})})}),e.jsxs(Hc,{className:"w-80",align:"end",forceMount:!0,children:[e.jsxs(Gc,{className:"flex items-center justify-between",children:[e.jsx("span",{children:"الإشعارات"}),u.length>0&&e.jsxs(d,{variant:"outline",size:"sm",className:"h-7 text-xs",onClick:B,children:[e.jsx(Ms,{className:"h-3 w-3 mr-1"}),"تمييز الكل كمقروء"]})]}),e.jsx(Qc,{}),u.length===0?e.jsx("div",{className:"p-3 text-sm text-muted-foreground",children:"لا توجد إشعارات حالياً"}):e.jsx("div",{className:"max-h-64 overflow-y-auto pr-1",children:u.map(C=>{const _=C.id?!v.has(C.id):!1;return e.jsx("div",{className:`px-2 py-2 rounded-md ${_?"bg-primary/5":""}`,children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx($l,{className:`h-4 w-4 ${_?"text-primary":"text-muted-foreground"}`}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-sm font-medium",children:C.title||"إشعار"}),e.jsx("div",{className:"text-xs text-muted-foreground whitespace-pre-line",children:C.message}),C.linkUrl&&e.jsxs(d,{variant:"link",className:"px-0 h-6 text-xs",onClick:()=>k(C.linkUrl,C.id),children:["فتح الرابط ",e.jsx(Vc,{className:"h-3 w-3 ml-1"})]})]}),_?e.jsx(d,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>Z(C.id),title:"تمييز كمقروء",children:e.jsx(Ms,{className:"h-4 w-4 text-primary"})}):e.jsx(d,{variant:"ghost",size:"icon",className:"h-6 w-6",disabled:!0,title:"مقروء",children:e.jsx(Ms,{className:"h-4 w-4 text-muted-foreground"})})]})},C.id)})})]})]}),S]})}const _l=({isOpen:l,onClose:h,onTrialStarted:o})=>{const{user:u}=xs(),[y,v]=r.useState(!1),[t,A]=r.useState(!1),[j,m]=r.useState(""),[x,S]=r.useState(24);r.useEffect(()=>{const U=async()=>{if(u!=null&&u.uid){const B=await Sa.getTrialData(u.uid);A(B.hasUsedFreeTrial)}},Z=async()=>{try{const B=await Sa.getTrialDurationHours();S(B)}catch{}};l&&(U(),Z())},[l,u]);const b=async()=>{if(u!=null&&u.uid){v(!0);try{const U=await Sa.startFreeTrial(u.uid);U.success?(m(U.message),window.location.href="/user/dashboard"):m(U.message||"تعذر تفعيل التجربة المجانية")}catch{m("حدث خطأ أثناء تفعيل التجربة المجانية")}finally{v(!1)}}},M=async()=>{if(u!=null&&u.uid){v(!0);try{await cc(u.uid,ds.ZERO,u.uid),window.location.href="/user/dashboard"}catch{m("حدث خطأ أثناء تفعيل باقة الزيرو")}finally{v(!1)}}};return e.jsxs(e.Fragment,{children:[l&&e.jsx("div",{className:"fixed inset-0 z-40",style:{background:"rgba(0, 0, 0, 0.15)",backdropFilter:"blur(3px)",WebkitBackdropFilter:"blur(3px)",pointerEvents:"auto"}}),e.jsx(ie,{open:l,onOpenChange:()=>{},children:e.jsxs(oe,{className:"sm:max-w-lg z-50 border-0 shadow-2xl",style:{position:"fixed",top:"50%",left:"50%",transform:"translate(-50%, -50%)",pointerEvents:"auto",background:"linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 0.95) 100%)",backdropFilter:"blur(10px)",WebkitBackdropFilter:"blur(10px)",borderRadius:"20px",border:"1px solid rgba(255, 255, 255, 0.3)"},children:[e.jsxs(ce,{className:"text-center pb-0 pt-0",children:[e.jsx("div",{className:"flex justify-center mb-1",children:e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-0 rounded-full",style:{background:"linear-gradient(135deg, #f59e0b, #d97706)",filter:"blur(8px)",opacity:.3}}),e.jsx("div",{className:"relative bg-gradient-to-br from-orange-400 to-orange-600 p-2 rounded-full",children:e.jsx(gn,{className:"h-12 w-12 text-white"})})]})}),e.jsx(de,{className:"text-2xl font-bold bg-gradient-to-r from-gray-800 to-gray-600 bg-clip-text text-transparent text-center mt-0 mb-0 leading-tight",children:"تفعيل الحساب مطلوب"})]}),e.jsxs("div",{className:"text-center pt-6 pb-0 px-2",children:[e.jsxs("div",{className:"bg-gradient-to-r from-orange-50 to-amber-50 rounded-xl p-6 mb-6 border border-orange-100",children:[e.jsx("p",{className:"text-gray-700 text-lg leading-relaxed font-medium",children:"حسابك في انتظار التفعيل من قبل المسؤول"}),e.jsx("p",{className:"text-sm font-semibold text-orange-700 mt-3 mb-3 bg-orange-100 p-3 rounded-lg border border-orange-200",children:"للتفعيل السريع: تواصل مع الإدارة عبر واتساب فقط على الرقم التالي"}),e.jsxs("div",{className:"bg-green-50 p-4 rounded-lg border border-green-200 mt-3",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"text-base font-bold text-green-700",children:"واتساب الإدارة:"}),e.jsx("a",{href:"https://wa.me/201000392539",target:"_blank",rel:"noopener noreferrer",className:"text-lg font-bold text-green-600 hover:text-green-700 underline",children:"01000392539"})]}),e.jsx("p",{className:"text-sm text-green-600 mt-2 text-center",children:"اضغط على الرقم للتواصل المباشر عبر واتساب"})]})]}),!t&&e.jsxs("div",{className:"bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-4 mb-4 border border-green-200",children:[e.jsxs("div",{className:"flex items-center justify-center mb-2",children:[e.jsx(gn,{className:"h-5 w-5 text-green-600 ml-2"}),e.jsx("span",{className:"text-green-700 font-semibold",children:"باقة الزيرو المجانية الدائمة"})]}),e.jsx("p",{className:"text-green-600 text-sm text-center",children:"فعل باقة الزيرو الان واستمتع ب 10 عمليات سحب وتحويل يوميا"})]}),j&&e.jsx("div",{className:`rounded-xl p-4 mb-4 text-center ${j.includes("تم تفعيل")?"bg-green-50 border border-green-200 text-green-700":"bg-red-50 border border-red-200 text-red-700"}`,children:e.jsx("p",{className:"font-medium",children:j})}),e.jsxs("div",{className:"flex items-center justify-center space-x-2 text-sm text-gray-500 mb-0",children:[e.jsxs("div",{className:"flex space-x-1",children:[e.jsx("div",{className:"w-2 h-2 bg-orange-400 rounded-full animate-pulse"}),e.jsx("div",{className:"w-2 h-2 bg-orange-400 rounded-full animate-pulse",style:{animationDelay:"0.2s"}}),e.jsx("div",{className:"w-2 h-2 bg-orange-400 rounded-full animate-pulse",style:{animationDelay:"0.4s"}})]}),e.jsx("span",{className:"mr-2",children:"في انتظار التفعيل"})]})]}),e.jsxs("div",{className:"flex flex-col space-y-3 pb-2",children:[!t&&!j.includes("تم تفعيل")&&e.jsxs(e.Fragment,{children:[e.jsxs(d,{onClick:b,disabled:y,className:"w-full max-w-2xl mx-auto relative bg-gradient-to-r from-blue-600 to-indigo-600 hover:brightness-110 text-white px-10 py-4 rounded-2xl font-bold text-xl ring-2 ring-blue-300 ring-offset-1 shadow-2xl hover:shadow-3xl transition-all duration-500 transform hover:scale-110 hover:-translate-y-1 disabled:opacity-50 disabled:cursor-not-allowed overflow-hidden group focus-visible:outline-none focus-visible:ring-4 focus-visible:ring-blue-300",style:{boxShadow:"0 15px 35px rgba(59, 130, 246, 0.4), 0 5px 15px rgba(0, 0, 0, 0.1)"},children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-white/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"}),e.jsx("div",{className:"absolute -top-1 -left-1 w-3 h-3 bg-yellow-400 rounded-full animate-ping"}),e.jsx("div",{className:"absolute -top-1 -right-1 w-2 h-2 bg-green-400 rounded-full animate-pulse"}),y?e.jsxs("div",{className:"flex items-center relative z-10",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-white ml-3"}),e.jsx("span",{className:"bg-gradient-to-r from-white to-gray-100 bg-clip-text text-transparent",children:"جاري التفعيل..."})]}):e.jsxs("div",{className:"flex items-center relative z-10",children:[e.jsx(Zc,{className:"h-6 w-6 ml-3 animate-bounce"}),e.jsx("span",{className:"bg-gradient-to-r from-white to-gray-100 bg-clip-text text-transparent",children:`التجربة المجانية لمدة ${x} ${x>=3&&x<=10?"ساعات":x===2?"ساعتين":"ساعة"}`})]})]}),e.jsxs(d,{onClick:M,disabled:y,className:"w-full max-w-2xl mx-auto relative bg-gradient-to-r from-green-600 to-emerald-600 hover:brightness-110 text-white px-10 py-4 rounded-2xl font-bold text-xl ring-2 ring-emerald-300 ring-offset-1 shadow-2xl hover:shadow-3xl transition-all duration-500 transform hover:scale-110 hover:-translate-y-1 disabled:opacity-50 disabled:cursor-not-allowed overflow-hidden group focus-visible:outline-none focus-visible:ring-4 focus-visible:ring-emerald-300",style:{boxShadow:"0 15px 35px rgba(99, 102, 241, 0.4), 0 5px 15px rgba(0, 0, 0, 0.1)"},children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-white/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"}),e.jsx("div",{className:"absolute -top-1 -left-1 w-3 h-3 bg-yellow-400 rounded-full animate-ping"}),e.jsx("div",{className:"absolute -top-1 -right-1 w-2 h-2 bg-green-400 rounded-full animate-pulse"}),y?e.jsxs("div",{className:"flex items-center relative z-10",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-white ml-3"}),e.jsx("span",{className:"bg-gradient-to-r from-white to-gray-100 bg-clip-text text-transparent",children:"جاري التفعيل..."})]}):e.jsxs("div",{className:"flex items-center relative z-10",children:[e.jsx(gn,{className:"h-6 w-6 ml-3 animate-bounce"}),e.jsx("span",{className:"bg-gradient-to-r from-white to-gray-100 bg-clip-text text-transparent",children:"فعّل باقة الزيرو الآن"})]})]})]}),e.jsx(d,{onClick:h,variant:"outline",className:"border-2 border-gray-300 hover:border-gray-400 text-gray-700 hover:text-gray-800 px-10 py-3 rounded-xl font-semibold text-lg transition-all duration-300 transform hover:scale-105",children:t?"فهمت":"إغلاق"})]})]})})]})};function gd({isOpen:l,onClose:h}){const[o,u]=r.useState("0"),[y,v]=r.useState(null),[t,A]=r.useState(null),[j,m]=r.useState(!1),x=L=>{j?(u(L),m(!1)):u(o==="0"?L:o+L)},S=L=>{const O=parseFloat(o);if(y===null)v(O);else if(t){const he=b(y||0,O,t);u(String(he)),v(he)}m(!0),A(L)},b=(L,O,J)=>{switch(J){case"+":return L+O;case"-":return L-O;case"×":return L*O;case"÷":return O===0?0:L/O;case"=":return O;default:return O}},M=()=>{const L=parseFloat(o);if(y!==null&&t){const O=b(y,L,t);u(String(O)),v(null),A(null),m(!0)}},U=()=>{u("0"),v(null),A(null),m(!1)},Z=()=>{u("0")},B=()=>{j?(u("0."),m(!1)):o.indexOf(".")===-1&&u(o+".")},k=()=>{o!=="0"&&u(o.charAt(0)==="-"?o.slice(1):"-"+o)},C=()=>{const L=parseFloat(o);u(String(L/100))},_=L=>{const O=L.key;L.preventDefault(),O>="0"&&O<="9"?x(O):O==="+"?S("+"):O==="-"?S("-"):O==="*"?S("×"):O==="/"?S("÷"):O==="Enter"||O==="="?M():O==="Escape"||O==="c"||O==="C"?U():O==="Backspace"?Z():O==="."?B():O==="%"&&C()};return r.useEffect(()=>(l?document.addEventListener("keydown",_):document.removeEventListener("keydown",_),()=>{document.removeEventListener("keydown",_)}),[l,o,y,t,j]),e.jsx(ie,{open:l,onOpenChange:L=>!L&&h(),children:e.jsxs(oe,{className:"sm:max-w-md",children:[e.jsx(ce,{children:e.jsxs(de,{className:"flex items-center gap-2 text-right",children:[e.jsx(ni,{className:"h-5 w-5"}),"آلة حاسبة"]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-gray-900 text-white p-4 rounded-lg text-right",children:e.jsx("div",{className:"text-3xl font-mono font-bold min-h-[3rem] flex items-center justify-end overflow-hidden",children:o})}),e.jsxs("div",{className:"grid grid-cols-4 gap-2",children:[e.jsx(d,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:U,children:"AC"}),e.jsx(d,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:Z,children:"CE"}),e.jsx(d,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:C,children:"%"}),e.jsx(d,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>S("÷"),children:"÷"}),e.jsx(d,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>x("7"),children:"7"}),e.jsx(d,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>x("8"),children:"8"}),e.jsx(d,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>x("9"),children:"9"}),e.jsx(d,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>S("×"),children:"×"}),e.jsx(d,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>x("4"),children:"4"}),e.jsx(d,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>x("5"),children:"5"}),e.jsx(d,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>x("6"),children:"6"}),e.jsx(d,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>S("-"),children:"-"}),e.jsx(d,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>x("1"),children:"1"}),e.jsx(d,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>x("2"),children:"2"}),e.jsx(d,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>x("3"),children:"3"}),e.jsx(d,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>S("+"),children:"+"}),e.jsx(d,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50 col-span-2",onClick:()=>x("0"),children:"0"}),e.jsx(d,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:B,children:"."}),e.jsx(d,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:M,children:"="})]}),e.jsx(d,{variant:"outline",className:"w-full h-10 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:k,children:"+/-"})]})]})})}function fd({isOpen:l,onClose:h}){const[o,u]=r.useState([]),[y,v]=r.useState({productName:"",price:"",wholesalePrice:"",quantity:""}),[t,A]=r.useState(!1);r.useState(null);const{toast:j}=Xt(),{user:m,profile:x}=xs(),{isShiftActive:S,shiftUser:b}=Ta(),[M,U]=r.useState([]),[Z,B]=r.useState({}),[k,C]=r.useState({}),[_,L]=r.useState(0),[O,J]=r.useState(0),[he,ae]=r.useState(!1),[pe,H]=r.useState(!0),[X,Te]=r.useState(!1),[K,re]=r.useState(""),ke=r.useMemo(()=>{const p=K.trim().toLowerCase();return p?M.filter(z=>z.name.toLowerCase().includes(p)):M},[M,K]);r.useEffect(()=>{l&&(m!=null&&m.uid)&&(vt(),pe||yt())},[l,m==null?void 0:m.uid,pe]);const at=async()=>{if(m!=null&&m.uid)try{const p=x==null?void 0:x.shopId;let z,ee=[];if(p){const fe=Ws(cs(it,"products"),kt("shopId","==",p),kt("userId","==",m.uid));if(z=await Fs(fe),ee=z.docs.map(ne=>({id:ne.id,name:String(ne.data().name??""),sellingPrice:Number(ne.data().sellingPrice??0),wholesalePrice:Number(ne.data().wholesalePrice??0),quantity:Number(ne.data().quantity??0)})),ee.length===0){const ne=Ws(cs(it,"products"),kt("userId","==",m.uid)),nt=(await Fs(ne)).docs.map(Qe=>({id:Qe.id,name:String(Qe.data().name??""),sellingPrice:Number(Qe.data().sellingPrice??0),wholesalePrice:Number(Qe.data().wholesalePrice??0),quantity:Number(Qe.data().quantity??0)}));nt.length>0&&(ee=nt,j({title:"تم استرجاع المنتجات",description:"عثرنا على منتجات محفوظة لك خارج المتجر الحالي وقمنا بعرضها."}))}}else{const fe=Ws(cs(it,"products"),kt("userId","==",m.uid));z=await Fs(fe),ee=z.docs.map(ne=>({id:ne.id,name:String(ne.data().name??""),sellingPrice:Number(ne.data().sellingPrice??0),wholesalePrice:Number(ne.data().wholesalePrice??0),quantity:Number(ne.data().quantity??0)}))}if(U(ee),x!=null&&x.shopId&&ee.length>0){const fe=ee.filter(ne=>{const Me=((z==null?void 0:z.docs)||[]).find(Qe=>Qe.id===ne.id);return!(!!Me&&!!Me.data().shopId)});if(fe.length>0)try{await Promise.all(fe.map(ne=>ta(Gt(it,"products",ne.id),{shopId:x.shopId,updatedAt:Gs()}))),j({title:"تم ترتيب المنتجات",description:"تم ربط بعض المنتجات غير المربوطة بمتجرك الحالي تلقائياً."})}catch(ne){console.warn("تعذّر ترحيل shopId لبعض المنتجات:",ne)}}}catch(p){console.error("Error loading shop products:",p)}};r.useEffect(()=>{l&&(m!=null&&m.uid)&&(at(),yt())},[l,m==null?void 0:m.uid,x==null?void 0:x.shopId]);const vt=()=>{if(!(m!=null&&m.uid)){console.log("No user authenticated, cannot load sales data");return}const p=new Date().toISOString().split("T")[0],z=localStorage.getItem(`salesData_${m.uid}_${p}`);u(z?JSON.parse(z):[])},Ee=p=>{if(!(m!=null&&m.uid)){console.log("No user authenticated, cannot save sales data");return}const z=new Date().toISOString().split("T")[0];localStorage.setItem(`salesData_${m.uid}_${z}`,JSON.stringify(p)),u(p)},yt=async()=>{if(m!=null&&m.uid)try{const p=new Date,z=new Date(p.getFullYear(),p.getMonth(),1),ee=new Date(p.getFullYear(),p.getMonth()+1,0),fe=Q=>Q.toISOString().split("T")[0],ne=fe(z),Me=fe(ee),nt=Ws(cs(it,"dailySales"),kt("userId","==",m.uid),kt("date",">=",ne),kt("date","<=",Me)),Qe=await Fs(nt);let _e=0,D=0;if(!Qe.empty)Qe.forEach(Q=>{const ue=Q.data(),Se=Number(ue.sellingPrice??0),be=Number(ue.quantity??0),Le=Number(ue.profit??(Number(ue.sellingPrice??0)-Number(ue.wholesalePrice??0))*be);_e+=Se*be,D+=Le});else{const Q=Ws(cs(it,"dailySales"),kt("userId","==",m.uid));(await Fs(Q)).forEach(Se=>{const be=Se.data(),Le=String(be.date??"").slice(0,10);if(Le>=ne&&Le<=Me){const F=Number(be.sellingPrice??0),te=Number(be.quantity??0),$=Number(be.profit??(Number(be.sellingPrice??0)-Number(be.wholesalePrice??0))*te);_e+=F*te,D+=$}}),(_e>0||D>0)&&j({title:"تم استرجاع تقارير الشهر",description:"تم حساب التقارير باستخدام مسار احتياطي للتواريخ القديمة."})}L(_e),J(D)}catch(p){console.error("Error loading monthly stats:",p)}},qe=async p=>{if(m!=null&&m.uid)try{const z=((p.price??0)-(p.wholesalePrice??0))*(p.quantity??0),ee=S&&b?"cashier":"admin",fe=ee==="cashier"?(b==null?void 0:b.name)||"كاشير":(x==null?void 0:x.fullName)||(m==null?void 0:m.displayName)||"الحساب الرئيسي",ne=ee==="cashier"&&(b==null?void 0:b.username)||null;await Ll(cs(it,"dailySales"),{userId:m.uid,productName:p.productName,quantity:p.quantity,wholesalePrice:p.wholesalePrice??null,sellingPrice:p.price,profit:z,date:p.date,time:p.time,performedByType:ee,performedByName:fe,performedByUsername:ne,createdAt:Gs()})}catch(z){console.error("Error saving sale:",z)}},Ye=async p=>{const z=Z[p.id]||"",ee=parseInt(z);if(isNaN(ee)||ee<=0){j({title:"كمية غير صالحة",description:"أدخل كمية صحيحة للبيـع",variant:"destructive"});return}if(ee>p.quantity){j({title:"كمية أكبر من المتاح",description:"الكمية المطلوب بيعها تتجاوز المخزون المتاح",variant:"destructive"});return}const fe=new Date,ne=S&&b?"cashier":"admin",Me=ne==="cashier"?(b==null?void 0:b.name)||"كاشير":(x==null?void 0:x.fullName)||(m==null?void 0:m.displayName)||"الحساب الرئيسي",nt=ne==="cashier"&&(b==null?void 0:b.username)||null,Qe={id:Date.now().toString(),productName:p.name,price:p.sellingPrice,wholesalePrice:p.wholesalePrice,quantity:ee,date:fe.toISOString().split("T")[0],time:fe.toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit"}),performedByType:ne,performedByName:Me,performedByUsername:nt};try{Ee([...o,Qe]),await qe(Qe);const _e=p.quantity-ee;await ta(Gt(it,"products",p.id),{quantity:_e,updatedAt:Gs()}),U(D=>D.map(Q=>Q.id===p.id?{...Q,quantity:_e}:Q)),B(D=>({...D,[p.id]:""})),j({title:"تم البيع",description:`تم بيع ${ee} قطعة من ${p.name}`})}catch(_e){console.error("Error selling product:",_e),j({title:"فشل البيع",description:"تعذّر تنفيذ عملية البيع",variant:"destructive"})}},ut=async p=>{if(S){j({title:"غير مسموح في وضع الكاشير",description:"لا يمكن إضافة قطع أثناء الورديه",variant:"destructive"});return}const z=k[p.id]||"",ee=parseInt(z);if(isNaN(ee)||ee<=0){j({title:"كمية غير صالحة",description:"أدخل كمية صحيحة للإضافة",variant:"destructive"});return}try{const fe=p.quantity+ee;await ta(Gt(it,"products",p.id),{quantity:fe,updatedAt:Gs()}),U(ne=>ne.map(Me=>Me.id===p.id?{...Me,quantity:fe}:Me)),C(ne=>({...ne,[p.id]:""})),j({title:"تمت الإضافة",description:`تمت إضافة ${ee} قطعة إلى ${p.name}`})}catch(fe){console.error("Error adding pieces:",fe),j({title:"فشل الإضافة",description:"تعذّر إضافة الكمية إلى المخزون",variant:"destructive"})}},rt=async p=>{if(!(m!=null&&m.uid))return;if(S){j({title:"غير مسموح في وضع الكاشير",description:"لا يمكن حذف المنتجات أثناء الورديه",variant:"destructive"});return}if(window.confirm(`هل تريد حذف المنتج "${p.name}"؟`))try{await dc(Gt(it,"products",p.id)),U(ee=>ee.filter(fe=>fe.id!==p.id)),j({title:"تم الحذف",description:`تم حذف المنتج ${p.name}`})}catch(ee){console.error("Error deleting product:",ee),j({title:"فشل الحذف",description:"تعذّر حذف المنتج",variant:"destructive"})}},Be=async()=>{try{if(!(m!=null&&m.uid)){j({title:"خطأ",description:"غير مسجّل دخول",variant:"destructive"});return}if(S){j({title:"غير مسموح في وضع الكاشير",description:"لا يمكن إضافة منتجات أثناء الورديه",variant:"destructive"});return}const p=y.productName.trim(),z=parseFloat(y.price),ee=parseFloat(y.wholesalePrice||"0"),fe=parseInt(y.quantity);if(!p||isNaN(z)||isNaN(fe)){j({title:"بيانات غير مكتملة",description:"أدخل اسم المنتج والسعر والكمية",variant:"destructive"});return}const ne={name:p,sellingPrice:z,wholesalePrice:isNaN(ee)?0:ee,quantity:isNaN(fe)?0:fe,userId:m.uid,createdAt:Gs(),updatedAt:Gs()};x!=null&&x.shopId&&(ne.shopId=x.shopId);const Me=await Ll(cs(it,"products"),ne);U(nt=>[{id:Me.id,name:p,sellingPrice:z,wholesalePrice:isNaN(ee)?0:ee,quantity:isNaN(fe)?0:fe},...nt]),v({productName:"",price:"",wholesalePrice:"",quantity:""}),j({title:"تمت الإضافة",description:`تم إضافة المنتج ${p} بنجاح`})}catch(p){console.error("createProduct error",p),j({title:"فشل الإضافة",description:"تعذّر إضافة المنتج. حاول مجددًا",variant:"destructive"})}};return e.jsxs(ie,{open:l,onOpenChange:h,children:[e.jsxs(oe,{className:"max-w-7xl md:max-w-6xl lg:max-w-7xl w-[95vw] md:w-[90vw] h-[95vh] md:h-[90vh] p-0 overflow-y-auto",children:[e.jsx(ce,{className:"px-3 md:px-6 py-3 md:py-4 border-b bg-gradient-to-r from-blue-50 to-purple-50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 md:gap-3",children:[e.jsx("div",{className:"p-1.5 md:p-2 bg-blue-100 rounded-lg",children:e.jsx(Nn,{className:"h-5 w-5 md:h-6 md:w-6 text-blue-600"})}),e.jsxs("div",{children:[e.jsx(de,{className:"text-lg md:text-xl font-bold text-gray-800",children:"📊 بيانات المبيعات اليومية"}),e.jsxs("p",{className:"text-xs md:text-sm text-gray-600 mt-1 hidden sm:block",children:["إدارة وتتبع مبيعات اليوم - ",new Date().toLocaleDateString("ar-EG")]})]})]}),e.jsx("div",{className:"flex items-center gap-1 md:gap-2",children:e.jsx(d,{variant:"ghost",size:"sm",onClick:h,className:"h-8 w-8 md:h-9 md:w-9",children:e.jsx(Hl,{className:"h-4 w-4"})})})]})}),e.jsxs("div",{className:"flex flex-col md:flex-row h-full",dir:"rtl",children:[e.jsxs("div",{className:"w-full md:w-80 lg:w-96 bg-white/50 border-r",children:[e.jsxs("div",{className:"p-3 md:p-4 border-b bg-white/30",children:[e.jsxs("h3",{className:"font-semibold text-gray-800 mb-3 flex items-center gap-2 text-sm md:text-base",children:[e.jsx(Ge,{className:"h-4 w-4 text-green-600"}),"ملخص المبيعات"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 md:gap-3",children:[e.jsxs("div",{className:"bg-blue-50 p-2 md:p-3 rounded-lg text-center",children:[e.jsx("div",{className:"text-lg md:text-xl font-bold text-blue-600",children:gt(o.reduce((p,z)=>p+z.price*z.quantity,0))}),e.jsx("div",{className:"text-xs md:text-sm text-blue-600",children:"إجمالي المبيعات"})]}),e.jsxs("div",{className:"bg-green-50 p-2 md:p-3 rounded-lg text-center",children:[e.jsx("div",{className:"text-lg md:text-xl font-bold text-green-600",children:gt(o.reduce((p,z)=>p+(z.price-(z.wholesalePrice??0))*z.quantity,0))}),e.jsx("div",{className:"text-xs md:text-sm text-green-600",children:"إجمالي الأرباح"})]}),e.jsxs("div",{className:"bg-yellow-50 p-2 md:p-3 rounded-lg text-center",children:[e.jsx("div",{className:"text-lg md:text-xl font-bold text-yellow-600",children:Zs(M.length)}),e.jsx("div",{className:"text-xs md:text-sm text-yellow-600",children:"عدد المنتجات"})]}),e.jsxs("div",{className:"bg-purple-50 p-2 md:p-3 rounded-lg text-center",children:[e.jsx("div",{className:"text-lg md:text-xl font-bold text-purple-600",children:Zs(o.length)}),e.jsx("div",{className:"text-xs md:text-sm text-purple-600",children:"عدد المبيعات"})]})]}),e.jsxs("div",{className:"relative mb-2",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-1 md:gap-2 text-xs md:text-sm font-semibold text-indigo-700",children:[e.jsx(Ns,{className:"h-3 w-3 md:h-4 md:w-4"}),e.jsx(Nn,{className:"h-3 w-3 md:h-4 md:w-4"}),e.jsx("span",{children:"تقارير الشهر"})]}),e.jsx(d,{size:"sm",variant:"ghost",onClick:()=>Te(p=>!p),className:"h-6 w-6 p-0 rounded-full",title:X?"إظهار التقارير":"إخفاء التقارير",children:X?e.jsx(In,{className:"h-4 w-4"}):e.jsx(Xl,{className:"h-4 w-4"})})]}),e.jsx("div",{className:X?"overflow-hidden max-h-0 transition-[max-height] duration-300":"overflow-hidden transition-[max-height] duration-300 max-h-[400px]",children:e.jsxs("div",{className:pe?"grid grid-cols-2 gap-2 md:gap-4 filter blur-sm pointer-events-none":"grid grid-cols-2 gap-2 md:gap-4",children:[e.jsxs("div",{className:"bg-indigo-50 p-2 md:p-3 rounded-lg text-center",children:[e.jsx("div",{className:"text-lg md:text-xl font-bold text-indigo-600",children:gt(_)}),e.jsx("div",{className:"text-xs md:text-sm text-indigo-600",children:"مبيعات الشهر"})]}),e.jsxs("div",{className:"bg-pink-50 p-2 md:p-3 rounded-lg text-center",children:[e.jsx("div",{className:"text-lg md:text-xl font-bold text-pink-600",children:gt(O)}),e.jsx("div",{className:"text-xs md:text-sm text-pink-600",children:"أرباح الشهر"})]})]})}),!X&&pe&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center rounded-lg bg-yellow-100/60",children:e.jsxs(d,{size:"sm",variant:"ghost",onClick:async()=>{try{if(await isZeroPlan()){j({title:"الخطة زيرو",description:"التقارير الشهرية غير متاحة في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}catch{}ae(!0)},className:"flex items-center gap-2 bg-yellow-200/70 hover:bg-yellow-300 text-yellow-900 px-3 py-2 rounded-xl shadow-md hover:shadow-lg transition-all",title:"عرض تقارير الشهر",children:[e.jsx(st,{className:"h-5 w-5 md:h-7 md:w-7"}),e.jsx("span",{className:"text-xs md:text-sm",children:"عرض تقارير الشهر"})]})})]})]}),e.jsx("div",{className:"p-3 md:p-4 border-b bg-white/30",children:e.jsxs("h3",{className:"font-semibold text-gray-800 mb-3 flex items-center gap-2 text-sm md:text-base",children:[e.jsx(cr,{className:"h-4 w-4 text-indigo-600"}),"إحصائيات المنتجات"]})}),e.jsx("div",{className:"p-3 md:p-4 flex-1 overflow-y-auto hidden md:block",children:e.jsxs("h3",{className:"font-semibold text-gray-800 mb-3 flex items-center gap-2",children:[e.jsx(Sn,{className:"h-4 w-4 text-blue-600"}),"نصائح للمبيعات"]})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto transition-all duration-300 ease-in-out scrollbar-thin scrollbar-thumb-blue-300 scrollbar-track-blue-100 hover:scrollbar-thumb-blue-400",children:e.jsxs("div",{className:"p-3 md:p-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 md:mb-6 gap-2",children:[e.jsxs("h2",{className:"text-base md:text-lg font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(sd,{className:"h-4 w-4 md:h-5 md:w-5 text-blue-600"}),"سجل المبيعات (",o.length," عنصر)"]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs md:text-sm text-gray-600",children:[e.jsx(Ns,{className:"h-3 w-3 md:h-4 md:w-4"}),e.jsx("span",{className:"hidden sm:inline",children:new Date().toLocaleDateString("ar-EG")}),e.jsx(Ls,{className:"h-3 w-3 md:h-4 md:w-4 ml-2"}),e.jsx("span",{children:new Date().toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit"})})]})]}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-3 md:p-4 mb-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("h3",{className:"text-sm md:text-base font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(ft,{className:"h-4 w-4 text-emerald-600"}),"إضافة منتج جديد"]}),e.jsxs(d,{size:"sm",variant:"ghost",className:"h-8",onClick:()=>{if(S){j({title:"غير مسموح في وضع الكاشير",description:"لا يمكن إضافة منتج أثناء الورديه",variant:"destructive"});return}A(p=>!p)},children:[e.jsx(ft,{className:"h-4 w-4 text-emerald-600"}),"إضافة منتج"]})]}),t&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx(V,{htmlFor:"new-product-name",className:"text-xs md:text-sm",children:"اسم المنتج"}),e.jsx(R,{id:"new-product-name",value:y.productName,onChange:p=>v(z=>({...z,productName:p.target.value})),placeholder:"أدخل اسم المنتج"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx(V,{htmlFor:"new-product-price",className:"text-xs md:text-sm",children:"سعر البيع (ج.م)"}),e.jsx(R,{type:"number",id:"new-product-price",value:y.price,onChange:p=>v(z=>({...z,price:p.target.value})),placeholder:"0.00"})]}),e.jsxs("div",{children:[e.jsx(V,{htmlFor:"new-product-wholesale",className:"text-xs md:text-sm",children:"سعر الجملة (ج.م)"}),e.jsx(R,{type:"number",id:"new-product-wholesale",value:y.wholesalePrice||"",onChange:p=>v(z=>({...z,wholesalePrice:p.target.value})),placeholder:"0.00"})]})]}),e.jsxs("div",{children:[e.jsx(V,{htmlFor:"new-product-qty",className:"text-xs md:text-sm",children:"الكمية"}),e.jsx(R,{type:"number",id:"new-product-qty",value:y.quantity,onChange:p=>v(z=>({...z,quantity:p.target.value})),placeholder:"1"})]}),e.jsx(d,{className:"w-full md:w-auto",onClick:Be,children:"إضافة المنتج"})]})]}),e.jsx("div",{id:"shop-products-section",className:"bg-white rounded-lg border border-gray-200 overflow-hidden mb-4",children:e.jsxs("div",{className:"mb-4",children:[e.jsxs("h3",{className:"text-sm md:text-base font-semibold text-gray-800 mb-2 flex items-center gap-2",children:[e.jsx(cr,{className:"h-4 w-4 text-green-600"}),"منتجات المحل"]}),e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(R,{value:K,onChange:p=>re(p.target.value),placeholder:"ابحث عن منتج...",className:"h-9 w-full md:w-72 text-sm","aria-label":"البحث عن منتج من منتجات المحل"}),K&&e.jsx(d,{variant:"ghost",size:"sm",className:"h-9",onClick:()=>re(""),children:"مسح"})]}),e.jsx("div",{className:"overflow-x-auto border border-gray-200 rounded-lg hidden md:block",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"المنتج"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"سعر البيع"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"سعر الجملة"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"المتاح"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"بيع"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:ke.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"px-3 py-3 text-center text-gray-500",children:M.length===0?"لا توجد منتجات بعد، أضف منتجاً من النموذج أعلاه":"لا توجد نتائج مطابقة للبحث"})}):ke.map(p=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-3 py-2 font-medium text-gray-900",children:p.name}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:gt(p.sellingPrice)}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:gt(p.wholesalePrice)}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:Zs(p.quantity)}),e.jsx("td",{className:"px-3 py-2",children:e.jsxs("div",{className:"flex items-center gap-2 flex-nowrap",children:[e.jsx(R,{value:Z[p.id]||"",onChange:z=>B(ee=>({...ee,[p.id]:z.target.value})),type:"number",placeholder:"عدد القطع للبيع",className:"h-8 w-28 text-sm"}),e.jsx(d,{size:"sm",className:"h-8",onClick:()=>Ye(p),children:"بيع"}),e.jsx(R,{value:k[p.id]||"",onChange:z=>C(ee=>({...ee,[p.id]:z.target.value})),type:"number",placeholder:"عدد للإضافة",className:"h-8 w-28 text-sm",disabled:S}),e.jsxs("div",{className:"inline-flex items-center gap-2 flex-nowrap",children:[e.jsx(d,{size:"sm",variant:"outline",className:"h-8",onClick:()=>ut(p),disabled:S,title:S?"غير مسموح في وضع الكاشير":void 0,children:"إضافة قطع جديدة"}),e.jsx(d,{size:"sm",variant:"destructive",className:"h-8",onClick:()=>rt(p),title:"حذف المنتج",disabled:S,children:e.jsx(Wt,{className:"h-4 w-4"})})]})]})})]},p.id))})]})}),e.jsx("div",{className:"block md:hidden space-y-3",children:ke.length===0?e.jsx("div",{className:"text-center text-gray-500 text-sm",children:M.length===0?"لا توجد منتجات بعد، أضف منتجاً من النموذج أعلاه":"لا توجد نتائج مطابقة للبحث"}):ke.map(p=>e.jsxs("div",{className:"bg-white rounded-xl p-3 border border-gray-200 shadow-sm",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"font-semibold text-gray-900 text-sm break-words",children:p.name}),e.jsx(d,{size:"sm",variant:"destructive",className:"h-8 min-w-[44px] touch-manipulation",onClick:()=>rt(p),title:"حذف المنتج",disabled:S,children:e.jsx(Wt,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-2 text-xs text-gray-700",children:[e.jsx("div",{className:"text-gray-600",children:"سعر البيع"}),e.jsx("div",{className:"text-right font-medium",children:gt(p.sellingPrice)}),e.jsx("div",{className:"text-gray-600",children:"سعر الجملة"}),e.jsx("div",{className:"text-right font-medium",children:gt(p.wholesalePrice)}),e.jsx("div",{className:"text-gray-600",children:"المتاح"}),e.jsx("div",{className:"text-right font-medium",children:Zs(p.quantity)})]}),e.jsxs("div",{className:"mt-3 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(R,{value:Z[p.id]||"",onChange:z=>B(ee=>({...ee,[p.id]:z.target.value})),type:"number",placeholder:"عدد القطع للبيع",className:"h-9 flex-1 text-sm","aria-label":`عدد القطع للبيع لـ ${p.name}`}),e.jsx(d,{size:"sm",className:"h-9 min-w-[64px]",onClick:()=>Ye(p),children:"بيع"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(R,{value:k[p.id]||"",onChange:z=>C(ee=>({...ee,[p.id]:z.target.value})),type:"number",placeholder:"عدد للإضافة",className:"h-9 flex-1 text-sm","aria-label":`عدد القطع للإضافة لـ ${p.name}`,disabled:S}),e.jsx(d,{size:"sm",variant:"outline",className:"h-9 min-w-[64px]",onClick:()=>ut(p),disabled:S,title:S?"غير مسموح في وضع الكاشير":void 0,children:"إضافة"})]})]})]},p.id))})]})}),o.length===0?e.jsxs("div",{className:"text-center py-8 md:py-12",children:[e.jsx("div",{className:"w-16 h-16 md:w-24 md:h-24 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center",children:e.jsx(cr,{className:"h-8 w-8 md:h-12 md:w-12 text-gray-400"})}),e.jsx("h3",{className:"text-base md:text-lg font-medium text-gray-900 mb-2",children:"لا توجد مبيعات اليوم"}),e.jsx("p",{className:"text-sm text-gray-500",children:"ابدأ ببيع منتج من القائمة أعلاه"})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"block md:hidden",children:e.jsx("div",{className:"max-h-[70vh] overflow-y-auto space-y-3 p-3",children:o.map(p=>e.jsxs("div",{className:"bg-white rounded-xl p-4 border border-gray-200 shadow-sm",children:[e.jsx("div",{className:"mb-3",children:e.jsx("h4",{className:"font-semibold text-gray-900 text-base break-words",children:p.productName})}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-2 text-sm text-gray-700",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ge,{className:"h-4 w-4 text-blue-600"}),e.jsx("span",{className:"text-gray-600",children:"سعر البيع"})]}),e.jsx("div",{className:"text-right font-medium",children:gt(p.price)}),typeof p.wholesalePrice=="number"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ge,{className:"h-4 w-4 text-indigo-600"}),e.jsx("span",{className:"text-gray-600",children:"سعر الجملة"})]}),e.jsx("div",{className:"text-right font-medium",children:gt(p.wholesalePrice)})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(cr,{className:"h-4 w-4 text-emerald-600"}),e.jsx("span",{className:"text-gray-600",children:"الكمية"})]}),e.jsx("div",{className:"text-right font-medium",children:Zs(p.quantity)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ea,{className:"h-4 w-4 text-purple-600"}),e.jsx("span",{className:"text-gray-600",children:"الربح"})]}),e.jsx("div",{className:"text-right font-semibold text-purple-700",children:gt(((p.price??0)-(p.wholesalePrice??0))*(p.quantity??0))}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ge,{className:"h-4 w-4 text-green-600"}),e.jsx("span",{className:"text-gray-600",children:"الإجمالي"})]}),e.jsx("div",{className:"text-right font-bold text-green-700",children:gt(p.price*p.quantity)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ed,{className:"h-4 w-4 text-amber-600"}),e.jsx("span",{className:"text-gray-600",children:"المنفذ"})]}),e.jsx("div",{className:"text-right text-gray-700",children:p.performedByName??"-"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ns,{className:"h-4 w-4 text-blue-600"}),e.jsx("span",{className:"text-gray-600",children:"التاريخ"})]}),e.jsx("div",{className:"text-right text-gray-600",children:zl(p.date)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ls,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"text-gray-600",children:"الوقت"})]}),e.jsx("div",{className:"text-right text-gray-600",children:p.time})]})]},p.id))})}),e.jsx("div",{className:"hidden md:block overflow-x-auto max-h-96 overflow-y-auto scrollbar-thin scrollbar-thumb-green-300 scrollbar-track-green-100 hover:scrollbar-thumb-green-400",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"المنتج"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"سعر البيع (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"سعر الجملة (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الكمية"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الإجمالي (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الربح (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"التاريخ"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الوقت"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"المنفذ"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:o.map((p,z)=>e.jsxs("tr",{className:z%2===0?"bg-white":"bg-gray-50/50",children:[e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-gray-900",children:p.productName}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:gt(p.price)}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:typeof p.wholesalePrice=="number"?gt(p.wholesalePrice):"-"}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:Zs(p.quantity)}),e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-green-600",children:gt(p.price*p.quantity)}),e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-purple-600",children:gt(((p.price??0)-(p.wholesalePrice??0))*(p.quantity??0))}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-500",children:zl(p.date)}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-500",children:p.time}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:p.performedByName??"-"})]},p.id))})]})})]}),e.jsxs("div",{className:"mt-4 md:mt-6 text-xs text-gray-500 text-center bg-gray-50/50 p-2 md:p-3 rounded border border-gray-200/40 space-y-1",children:[e.jsx("p",{className:"font-medium text-gray-600",children:"💰 نظام إدارة المبيعات اليومية"}),e.jsxs("p",{className:"hidden sm:block",children:["• يتم حفظ البيانات تلقائياً لليوم الحالي: ",new Date().toLocaleDateString("ar-EG")]}),e.jsx("p",{children:"• يمكنك إضافة وتعديل وحذف المنتجات حسب الحاجة"}),e.jsx("p",{className:"hidden sm:block",children:"• يتم حفظ البيانات محلياً وعلى Firebase لتعزيز الأمان"})]})]})})]})]}),e.jsx(Bs,{open:he,onOpenChange:ae,mode:"verify",title:"قفل إحصائيات الشهر",description:"لا يمكن الاطلاع على تقارير الشهر إلا بإدخال الرقم السري الرئيسي",onSuccess:async()=>{try{const p=m==null?void 0:m.uid;if(p){const z=await Cn(p),ee=(z==null?void 0:z.planType)??(z==null?void 0:z.plan)??null,fe=typeof ee=="string"?ee.toLowerCase():null;if(ee===ds.ZERO||fe==="zero"){j({title:"الخطة زيرو",description:"التقارير الشهرية غير متاحة في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}}catch{}H(!1),ae(!1),yt()}})]})}const Zs=l=>new Intl.NumberFormat("ar-EG").format(Number(l||0)),gt=l=>`${new Intl.NumberFormat("ar-EG",{minimumFractionDigits:2,maximumFractionDigits:2}).format(Number(l||0))} ج.م`,zl=l=>{try{const h=new Date(l);return isNaN(h.getTime())?new Date(`${l}T00:00:00`).toLocaleDateString("ar-EG"):h.toLocaleDateString("ar-EG")}catch{return l}};function oi({size:l=24,className:h,...o}){return e.jsxs("svg",{width:l,height:l,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",className:h,...o,children:[e.jsx("rect",{x:"5",y:"2.5",width:"14",height:"19",rx:"2.5",stroke:"currentColor",strokeWidth:"1.5"}),e.jsx("rect",{x:"7",y:"4.5",width:"10",height:"5.5",rx:"1",stroke:"currentColor",strokeWidth:"1.2"}),e.jsx("path",{d:"M9.5 11.5h5",stroke:"currentColor",strokeWidth:"1.4",strokeLinecap:"round"}),e.jsx("circle",{cx:"8.5",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"12",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"15.5",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"8.5",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"12",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"15.5",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("rect",{x:"8",y:"19",width:"9",height:"1.8",rx:"0.6",stroke:"currentColor",strokeWidth:"1"})]})}var ci="AlertDialog",[vd,zm]=mc(ci,[ei]),ps=ei(),di=l=>{const{__scopeAlertDialog:h,...o}=l,u=ps(h);return e.jsx(Pc,{...u,...o,modal:!0})};di.displayName=ci;var yd="AlertDialogTrigger",bd=r.forwardRef((l,h)=>{const{__scopeAlertDialog:o,...u}=l,y=ps(o);return e.jsx(Dc,{...y,...u,ref:h})});bd.displayName=yd;var jd="AlertDialogPortal",mi=l=>{const{__scopeAlertDialog:h,...o}=l,u=ps(h);return e.jsx(Oc,{...u,...o})};mi.displayName=jd;var Nd="AlertDialogOverlay",hi=r.forwardRef((l,h)=>{const{__scopeAlertDialog:o,...u}=l,y=ps(o);return e.jsx(Cc,{...y,...u,ref:h})});hi.displayName=Nd;var aa="AlertDialogContent",[wd,Sd]=vd(aa),Dd=uc("AlertDialogContent"),ui=r.forwardRef((l,h)=>{const{__scopeAlertDialog:o,children:u,...y}=l,v=ps(o),t=r.useRef(null),A=Gl(h,t),j=r.useRef(null);return e.jsx(Ic,{contentName:aa,titleName:xi,docsSlug:"alert-dialog",children:e.jsx(wd,{scope:o,cancelRef:j,children:e.jsxs(Tc,{role:"alertdialog",...v,...y,ref:A,onOpenAutoFocus:hc(y.onOpenAutoFocus,m=>{var x;m.preventDefault(),(x=j.current)==null||x.focus({preventScroll:!0})}),onPointerDownOutside:m=>m.preventDefault(),onInteractOutside:m=>m.preventDefault(),children:[e.jsx(Dd,{children:u}),e.jsx(Id,{contentRef:t})]})})})});ui.displayName=aa;var xi="AlertDialogTitle",pi=r.forwardRef((l,h)=>{const{__scopeAlertDialog:o,...u}=l,y=ps(o);return e.jsx(kc,{...y,...u,ref:h})});pi.displayName=xi;var gi="AlertDialogDescription",fi=r.forwardRef((l,h)=>{const{__scopeAlertDialog:o,...u}=l,y=ps(o);return e.jsx(Ac,{...y,...u,ref:h})});fi.displayName=gi;var Cd="AlertDialogAction",vi=r.forwardRef((l,h)=>{const{__scopeAlertDialog:o,...u}=l,y=ps(o);return e.jsx(ti,{...y,...u,ref:h})});vi.displayName=Cd;var yi="AlertDialogCancel",bi=r.forwardRef((l,h)=>{const{__scopeAlertDialog:o,...u}=l,{cancelRef:y}=Sd(yi,o),v=ps(o),t=Gl(h,y);return e.jsx(ti,{...v,...u,ref:t})});bi.displayName=yi;var Id=({contentRef:l})=>{const h=`\`${aa}\` requires a description for the component to be accessible for screen reader users.

You can add a description to the \`${aa}\` by passing a \`${gi}\` component as a child, which also benefits sighted users by adding visible context to the dialog.

Alternatively, you can use your own component as a description by assigning it an \`id\` and passing the same value to the \`aria-describedby\` prop in \`${aa}\`. If the description is confusing or duplicative for sighted users, you can use the \`@radix-ui/react-visually-hidden\` primitive as a wrapper around your description component.

For more information, see https://radix-ui.com/primitives/docs/components/alert-dialog`;return r.useEffect(()=>{var u;document.getElementById((u=l.current)==null?void 0:u.getAttribute("aria-describedby"))||console.warn(h)},[h,l]),null},Td=di,kd=mi,ji=hi,Ni=ui,wi=vi,Si=bi,Di=pi,Ci=fi;const Ad=Td,Pd=kd,Ii=r.forwardRef(({className:l,...h},o)=>e.jsx(ji,{className:$s("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",l),...h,ref:o}));Ii.displayName=ji.displayName;const Ti=r.forwardRef(({className:l,...h},o)=>e.jsxs(Pd,{children:[e.jsx(Ii,{}),e.jsx(Ni,{ref:o,className:$s("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",l),...h})]}));Ti.displayName=Ni.displayName;const ki=({className:l,...h})=>e.jsx("div",{className:$s("flex flex-col space-y-2 text-center sm:text-left",l),...h});ki.displayName="AlertDialogHeader";const Ai=r.forwardRef(({className:l,...h},o)=>e.jsx(Di,{ref:o,className:$s("text-lg font-semibold",l),...h}));Ai.displayName=Di.displayName;const Pi=r.forwardRef(({className:l,...h},o)=>e.jsx(Ci,{ref:o,className:$s("text-sm text-muted-foreground",l),...h}));Pi.displayName=Ci.displayName;const Dn=r.forwardRef(({className:l,...h},o)=>e.jsx(wi,{ref:o,className:$s(Zl(),l),...h}));Dn.displayName=wi.displayName;const Oi=r.forwardRef(({className:l,...h},o)=>e.jsx(Si,{ref:o,className:$s(Zl({variant:"outline"}),"mt-2 sm:mt-0",l),...h}));Oi.displayName=Si.displayName;const We=l=>{try{return l.toLocaleString("en-US",{maximumFractionDigits:2})}catch{return String(l)}},Jl=l=>{try{return(l?new Date(l):new Date).toLocaleString("en-GB",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}catch{return new Date().toISOString()}},dr="machine_daily_opening_values",Kl="machine_daily_receipts",Vl="machine_daily_transfer_receipts",bn="machine_daily_opening_snapshot";function Od({open:l,onOpenChange:h}){const{toast:o}=Xt(),{shiftUser:u}=Ta(),[y,v]=r.useState(""),[t,A]=r.useState(""),[j,m]=r.useState(""),[x,S]=r.useState(null),[b,M]=r.useState(null),[U,Z]=r.useState(null),[B,k]=r.useState(null),[C,_]=r.useState(!1),[L,O]=r.useState(!1),[J,he]=r.useState(""),[ae,pe]=r.useState(""),[H,X]=r.useState(null),[Te,K]=r.useState(()=>{try{const F=localStorage.getItem(Kl),te=F?JSON.parse(F):[];return Array.isArray(te)?te:[]}catch{return[]}}),[re,ke]=r.useState(()=>{try{const F=localStorage.getItem(Vl),te=F?JSON.parse(F):[];return Array.isArray(te)?te:[]}catch{return[]}}),[at,vt]=r.useState(!1),[Ee,yt]=r.useState(""),[qe,Ye]=r.useState(""),[ut,rt]=r.useState(!1),[Be,p]=r.useState(null);r.useEffect(()=>{if(l)try{const F=localStorage.getItem(dr);if(F){const $=JSON.parse(F);typeof($==null?void 0:$.openingBase)=="number"&&S($.openingBase),typeof($==null?void 0:$.openingAir)=="number"&&M($.openingAir),typeof($==null?void 0:$.drawerCash)=="number"&&Z($.drawerCash)}const te=localStorage.getItem(bn);if(te){const $=JSON.parse(te);typeof($==null?void 0:$.openingBase)=="number"&&typeof($==null?void 0:$.openingAir)=="number"&&k({openingBase:$.openingBase,openingAir:$.openingAir,drawerCash:$.drawerCash||0})}}catch{}},[l]),r.useEffect(()=>{try{localStorage.setItem(Kl,JSON.stringify(Te))}catch{}},[Te]),r.useEffect(()=>{try{localStorage.setItem(Vl,JSON.stringify(re))}catch{}},[re]);const z=r.useMemo(()=>(u==null?void 0:u.displayName)||(u==null?void 0:u.name)||(u==null?void 0:u.username)||void 0,[u]),ee=r.useMemo(()=>re.reduce((F,te)=>F+(te.profit||0),0),[re]),fe=r.useMemo(()=>re.reduce((F,te)=>F+(te.wholesalePrice||0),0),[re]),ne=()=>{re.length!==0&&(ke([]),o({title:"تم حذف الإيصالات",description:"تم مسح كل إيصالات التحويل."}))},Me=()=>{Te.length!==0&&(K([]),o({title:"تم حذف الإيصالات",description:"تم مسح كل إيصالات الماكينة."}))},nt=F=>{K(te=>te.filter($=>$.id!==F)),o({title:"تم حذف الإيصال",description:"تم إزالة إيصال الماكينة المحدد."})},Qe=()=>{S(null),M(null),Z(null),k(null),v(""),A(""),m("");try{localStorage.removeItem(dr),localStorage.removeItem(bn)}catch{}o({title:"تم التصفير",description:"يمكنك الآن إدخال رصيد افتتاحي جديد."})},_e=()=>{const F=parseFloat(y||"0"),te=parseFloat(t||"0"),$=parseFloat(j||"0");if(isNaN(F)||isNaN(te)||isNaN($)){o({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة للرصيد الافتتاحي وفلوس الدرج.",variant:"destructive"});return}if(F<0||te<0||$<0){o({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}S(F),M(te),Z($);try{localStorage.setItem(dr,JSON.stringify({openingBase:F,openingAir:te,drawerCash:$})),localStorage.setItem(bn,JSON.stringify({openingBase:F,openingAir:te,drawerCash:$})),k({openingBase:F,openingAir:te,drawerCash:$})}catch{}o({title:"تم تسجيل البيانات",description:`الافتتاحي الأساسي: ${We(F)}، الهواء: ${We(te)}، فلوس الدرج: ${We($)}`})},D=()=>{if(x==null||b==null){o({title:"سجل الرصيد الافتتاحي أولاً",description:'يرجى الضغط على زر "إضافة" بعد إدخال الافتتاحي.'});return}O(!0)},Q=()=>{const F=parseFloat(J||"0"),te=parseFloat(ae||"0");if(isNaN(F)||isNaN(te)){o({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة لرصيد التسليم.",variant:"destructive"});return}if(F<0||te<0){o({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}const $=(B==null?void 0:B.openingBase)??(x||0),Ce=(B==null?void 0:B.openingAir)??(b||0),Re=$+Ce,bt=F+te-Re;X(bt);const es={id:`${Date.now()}`,openingBase:$,openingAir:Ce,deliveryBase:F,deliveryAir:te,netResult:bt,createdAt:new Date().toISOString(),cashierName:z,requiredDrawerNoProfit:bt<0?Math.round(-bt*100)/100:0};K(Et=>[es,...Et]),o({title:"تم إنشاء إيصال تسليم",description:`الناتج النهائي: ${We(bt)}`})},ue=()=>{const F=parseFloat(Ee||"0"),te=parseFloat(qe||"0");if(!Number.isFinite(F)||!Number.isFinite(te)){o({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة لسعر الجملة وسعر التجزئة.",variant:"destructive"});return}if(F<0||te<0){o({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}if(x==null||b==null){o({title:"سجل الرصيد الافتتاحي أولاً",description:'يرجى إدخال الرصيد الأساسي ورصيد الهواء ثم الضغط "إضافة".'});return}const $=Math.round((te-F)*100)/100;p({wholesalePrice:F,retailPrice:te,profit:$}),rt(!0)},Se=F=>{if(!Be)return;const te={id:`transfer_${Date.now()}`,wholesalePrice:Be.wholesalePrice,retailPrice:Be.retailPrice,profit:Be.profit,createdAt:new Date().toISOString(),cashierName:z,deductFrom:F},$=Be.wholesalePrice,Ce=x??0,Re=b??0,Lt=U??0;if($>(F==="base"?Ce:Re)){o({title:"رصيد غير كافٍ",description:"لا يوجد رصيد كافٍ للخصم بسعر الجملة.",variant:"destructive"});return}const es=F==="base"?Math.round((Ce-$)*100)/100:Ce,Et=F==="air"?Math.round((Re-$)*100)/100:Re,gs=Math.round((Lt+Be.retailPrice)*100)/100;S(es),M(Et),Z(gs);try{localStorage.setItem(dr,JSON.stringify({openingBase:es,openingAir:Et,drawerCash:gs}))}catch{}ke(Rt=>[te,...Rt]),vt(!1),yt(""),Ye(""),p(null),rt(!1),o({title:"تم تسجيل تحويل",description:`الربح الفوري: ${We(te.profit)} | خصم المخزون: -${We($)} (${F==="base"?"الأساسي":"الهواء"}) | درج: +${We(Be.retailPrice)}`})},be=()=>{v(""),A(""),O(!1),he(""),pe(""),X(null)},Le=F=>{F||be(),h(F)};return e.jsxs(ie,{open:l,onOpenChange:Le,children:[e.jsxs(oe,{className:"w-[92vw] sm:w-auto sm:max-w-2xl max-h-[85vh] overflow-y-auto",children:[e.jsxs(ce,{className:"space-y-2",children:[e.jsx(de,{className:"flex items-center justify-between text-right",children:e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(oi,{className:"h-5 w-5 text-yellow-500"}),"يومية المكنة"]})}),e.jsx(Mt,{className:"text-right",children:'أدخل الرصيد الافتتاحي، ثم في نهاية اليوم قم بإدخال رصيد التسليم لإنشاء إيصال منظم باسم "إيصالات ماكينة".'})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-6",children:[e.jsxs(Ve,{children:[e.jsx(ht,{className:"pb-2",children:e.jsxs(At,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-right",children:"الرصيد الافتتاحي"}),e.jsx(d,{variant:"ghost",size:"sm",onClick:()=>_(F=>!F),className:"flex items-center gap-1",children:e.jsx(In,{className:`h-4 w-4 transition-transform ${C?"rotate-180":""}`})})]})}),e.jsxs("div",{className:"flex items-center justify-between px-6",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(d,{variant:"outline",onClick:()=>vt(!0),disabled:x==null||b==null,className:"border-violet-300 text-violet-700",children:"تحويل"})}),x!=null&&b!=null&&e.jsxs(dt,{className:"bg-violet-100 text-violet-700 border border-violet-200",children:["تم التسجيل: أساسي ",We(x)," | هواء ",We(b)," | درج ",We(U??0)]})]}),e.jsxs(He,{className:`space-y-4 ${C?"":"hidden"}`,children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الرصيد الأساسي"}),e.jsx(R,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:y,onChange:F=>v(F.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"رصيد الهواء"}),e.jsx(R,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:t,onChange:F=>A(F.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"فلوس الدرج"}),e.jsx(R,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:j,onChange:F=>m(F.target.value),placeholder:"0.00",className:"text-right"})]})]}),e.jsxs("div",{className:"flex items-center justify-end",children:[e.jsx(d,{variant:"outline",className:"mr-2",onClick:Qe,children:"تصفير"}),e.jsx(d,{onClick:_e,className:"bg-violet-600 hover:bg-violet-700",children:"إضافة"})]})]})]}),e.jsxs(Ve,{children:[e.jsx(ht,{className:"pb-2",children:e.jsxs(At,{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-right",children:"إيصالات تحويل"}),e.jsxs(dt,{className:"bg-green-100 text-green-700 border border-green-200",children:["ربح: ",We(ee)]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(d,{variant:"outline",size:"sm",onClick:ne,className:"border-red-300 text-red-700 hover:bg-red-50",children:"حذف الإيصالات"}),e.jsx(hr,{className:"h-4 w-4 text-gray-500"})]})]})}),e.jsx(He,{className:"space-y-3",children:re.length===0?e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد تحويلات مسجلة."}):e.jsx("div",{className:"space-y-3 max-h-52 overflow-y-auto pr-1",children:re.map(F=>e.jsxs("div",{className:"rounded-lg border p-3 grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"سعر الجملة"}),e.jsx("p",{className:"text-sm",children:We(F.wholesalePrice)})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"سعر التجزئة"}),e.jsx("p",{className:"text-sm",children:We(F.retailPrice)})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"الربح الفوري"}),e.jsx("p",{className:"text-sm text-green-700",children:We(F.profit)}),F.deductFrom&&e.jsx("div",{className:"mt-1",children:e.jsxs("span",{className:"text-[11px] bg-violet-100 text-violet-700 border border-violet-200 rounded px-2 py-0.5",children:["الخصم من: ",F.deductFrom==="base"?"الأساسي":"الهواء"]})}),e.jsxs("div",{className:"flex items-center justify-end gap-2 text-xs text-gray-500",children:[e.jsx(Ns,{className:"h-3 w-3"}),e.jsx("span",{children:Jl(F.createdAt)}),F.cashierName&&e.jsxs(e.Fragment,{children:[e.jsx(jn,{orientation:"vertical",className:"h-3"}),e.jsxs("span",{children:["الكاشير: ",F.cashierName]})]})]})]})]},F.id))})})]}),e.jsxs(Ve,{children:[e.jsx(ht,{className:"pb-2",children:e.jsx(At,{className:"text-right",children:"نهاية اليوم"})}),e.jsx(He,{className:"space-y-4",children:L?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الرصيد الأساسي الحالي"}),e.jsx(R,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:J,onChange:F=>he(F.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"رصيد الهواء الحالي"}),e.jsx(R,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:ae,onChange:F=>pe(F.target.value),placeholder:"0.00",className:"text-right"})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(d,{variant:"secondary",onClick:()=>O(!1),children:"إلغاء"}),e.jsx(d,{onClick:Q,className:"bg-green-600 hover:bg-green-700",children:"تسليم"})]}),H!=null&&e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{className:"text-right",children:e.jsxs(dt,{className:H>=0?"bg-green-100 text-green-700 border border-green-200":"bg-red-100 text-red-700 border border-red-200",children:["الناتج النهائي: ",We(H)]})}),e.jsxs("div",{className:"mt-2 flex items-center justify-end gap-2",children:[e.jsxs(dt,{className:"bg-blue-100 text-blue-700 border border-blue-200",children:["المجموع النهائي: ",We(parseFloat(J||"0")+parseFloat(ae||"0"))]}),e.jsxs(dt,{className:"bg-amber-100 text-amber-700 border border-amber-200",children:["مطلوب من الدرج (بدون أرباح): ",We(fe)]})]})]})]}):e.jsx("div",{className:"flex justify-end",children:e.jsx(d,{variant:"outline",onClick:D,className:"border-violet-300 text-violet-700",children:"تسليم يومية"})})})]}),e.jsxs(Ve,{children:[e.jsx(ht,{className:"pb-2",children:e.jsxs(At,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-right",children:"إيصالات ماكينة"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(d,{variant:"outline",size:"sm",onClick:Me,className:"border-red-300 text-red-700 hover:bg-red-50",children:"حذف الإيصالات"}),e.jsx(hr,{className:"h-4 w-4 text-gray-500"})]})]})}),e.jsx(He,{className:"space-y-3",children:Te.length===0?e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد إيصالات حتى الآن."}):e.jsx("div",{className:"space-y-3",children:Te.map(F=>e.jsxs("div",{className:"rounded-lg border p-3 grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"الافتتاحي"}),e.jsxs("p",{className:"text-sm",children:["أساسي: ",We(F.openingBase)]}),e.jsxs("p",{className:"text-sm",children:["هواء: ",We(F.openingAir)]})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"التسليم"}),e.jsxs("p",{className:"text-sm",children:["أساسي: ",We(F.deliveryBase)]}),e.jsxs("p",{className:"text-sm",children:["هواء: ",We(F.deliveryAir)]})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("div",{className:"flex items-center justify-end",children:e.jsxs(d,{variant:"outline",size:"sm",onClick:()=>nt(F.id),className:"border-red-300 text-red-700 hover:bg-red-50",children:[e.jsx(Wt,{className:"h-3 w-3 mr-1"})," حذف"]})}),e.jsx("p",{className:"text-xs text-gray-500",children:"النتيجة"}),e.jsx("p",{className:`text-sm ${F.netResult>=0?"text-green-700":"text-red-700"}`,children:We(F.netResult)}),e.jsxs("div",{className:"mt-1 flex items-center justify-end gap-2",children:[e.jsxs("span",{className:"text-[11px] bg-blue-100 text-blue-700 border border-blue-200 rounded px-2 py-0.5",children:["المجموع النهائي: ",We(F.deliveryBase+F.deliveryAir)]}),typeof F.requiredDrawerNoProfit=="number"&&e.jsxs("span",{className:"text-[11px] bg-amber-100 text-amber-700 border border-amber-200 rounded px-2 py-0.5",children:["مطلوب من الدرج (بدون أرباح): ",We(F.requiredDrawerNoProfit||0)]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2 text-xs text-gray-500",children:[e.jsx(Ns,{className:"h-3 w-3"}),e.jsx("span",{children:Jl(F.createdAt)}),F.cashierName&&e.jsxs(e.Fragment,{children:[e.jsx(jn,{orientation:"vertical",className:"h-3"}),e.jsxs("span",{children:["الكاشير: ",F.cashierName]})]})]})]})]},F.id))})})]})]}),e.jsxs(De,{className:"flex items-center justify-between",children:[e.jsx(d,{variant:"outline",onClick:()=>Le(!1),children:"إغلاق"}),e.jsxs("div",{className:"text-xs text-gray-500 flex items-center gap-1",children:[e.jsx(Ls,{className:"h-3 w-3"}),e.jsx("span",{children:"يسجل التاريخ والوقت تلقائياً لكل إيصال"})]})]})]}),e.jsx(ie,{open:at,onOpenChange:vt,children:e.jsxs(oe,{className:"sm:max-w-sm",children:[e.jsx(ce,{children:e.jsx(de,{children:"تحويل رصيد"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"سعر الجملة"}),e.jsx(R,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:Ee,onChange:F=>yt(F.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"سعر التجزئة"}),e.jsx(R,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:qe,onChange:F=>Ye(F.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsx("div",{className:"text-right",children:e.jsxs(dt,{className:"bg-green-100 text-green-700 border border-green-200",children:["الربح الفوري: ",We(parseFloat(qe||"0")-parseFloat(Ee||"0")||0)]})})]}),e.jsxs(De,{className:"flex items-center justify-end gap-2",children:[e.jsx(d,{variant:"secondary",onClick:()=>vt(!1),children:"إلغاء"}),e.jsx(d,{onClick:ue,className:"bg-violet-600 hover:bg-violet-700",children:"تحويل"})]})]})}),e.jsx(Ad,{open:ut,onOpenChange:rt,children:e.jsxs(Ti,{children:[e.jsxs(ki,{children:[e.jsx(Ai,{children:"اختيار مصدر الخصم"}),e.jsx(Pi,{children:"هل يتم الخصم من الرصيد الأساسي أم من رصيد الهواء؟"})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2 mt-4",children:[e.jsx(Oi,{onClick:()=>rt(!1),children:"رجوع"}),e.jsx(Dn,{onClick:()=>Se("base"),children:"خصم من الأساسي"}),e.jsx(Dn,{onClick:()=>Se("air"),children:"خصم من الهواء"})]})]})})]})}function Wd(l,h=300){const[o,u]=mt.useState(l);return mt.useEffect(()=>{const y=setTimeout(()=>u(l),h);return()=>clearTimeout(y)},[l,h]),o}const Fd=({userId:l,transactions:h})=>{const[o,u]=r.useState(!1),[y,v]=r.useState(!1),[t,A]=r.useState(!1),[j,m]=r.useState({monthlyWithdrawalProfit:0,monthlyTransferProfit:0,lastUpdated:new Date}),{userSubscription:x}=xs();r.useEffect(()=>{l&&o&&t&&S()},[l,o,t]);const S=async()=>{if(l)try{const B=sa.getWithdrawTransferProfits(l);m({monthlyWithdrawalProfit:B.monthlyWithdrawProfit||0,monthlyTransferProfit:B.monthlyTransferProfit||0,lastUpdated:new Date})}catch(B){console.error("Error loading profit data:",B)}},b=B=>`${B.toFixed(2)} ج.م`,M=async()=>{try{const B=(x==null?void 0:x.subscription)||null,k=(B==null?void 0:B.planType)??(B==null?void 0:B.plan)??null,C=typeof k=="string"?k.toLowerCase():null;if(k===ds.ZERO||C==="zero"||C==="0"||k===0)return!0}catch{}try{if(l){const B=await Cn(l),k=(B==null?void 0:B.planType)??(B==null?void 0:B.plan)??null,C=typeof k=="string"?k.toLowerCase():null;if(k===ds.ZERO||C==="zero"||C==="0"||k===0)return!0}}catch{}return!1},U=async()=>{try{if(await M()){Rl({title:"الخطة زيرو",description:"عرض الأرباح الشهرية غير متاح في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}catch{}v(!0)},Z=async()=>{try{if(await M()){Rl({title:"الخطة زيرو",description:"عرض الأرباح الشهرية غير متاح في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"}),v(!1);return}}catch{}A(!0),u(!0),v(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(d,{size:"sm",variant:"ghost",onClick:U,className:"h-2 w-2 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded transition-all duration-300 hover:scale-110 shadow-sm hover:shadow-md",title:"عرض الأرباح الشهرية",children:e.jsx(st,{className:"h-1.5 w-1.5"})}),e.jsx(ie,{open:o,onOpenChange:u,children:e.jsxs(oe,{className:"max-w-[220px] mx-auto bg-white border border-gray-200 shadow-md rounded sm:max-w-[180px] sm:bg-gradient-to-br sm:from-purple-50 sm:to-white sm:border-2 sm:border-purple-200 sm:shadow-2xl sm:rounded-2xl",children:[e.jsx(ce,{className:"text-center pb-0 border-b-0 sm:pb-2 sm:border-b sm:border-purple-200",children:e.jsxs(de,{className:"text-xs font-bold text-purple-800 flex items-center justify-center gap-0 mb-0 leading-tight tracking-tight sm:text-xs sm:gap-1 sm:mb-0 sm:leading-normal sm:tracking-normal",children:[e.jsx(Ns,{className:"h-2 w-2 text-purple-600 sm:h-3 sm:w-3"}),"شهري"]})}),e.jsxs("div",{className:"space-y-0 py-0 sm:space-y-2 sm:py-2",children:[e.jsx("div",{className:"bg-yellow-50 p-0.5 rounded border border-yellow-200 sm:bg-gradient-to-r sm:from-yellow-50 sm:to-yellow-100 sm:p-2 sm:rounded-xl sm:shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-[10px] sm:text-xs font-semibold text-yellow-900",children:"أرباح فوري"}),e.jsx("span",{className:"text-[10px] sm:text-xs font-bold text-yellow-900",children:b((j.monthlyWithdrawalProfit??0)+(j.monthlyTransferProfit??0))})]})}),e.jsx("div",{className:"bg-red-50 p-0.5 rounded border border-red-200 sm:bg-gradient-to-r sm:from-red-50 sm:to-red-100 sm:p-2 sm:rounded-xl sm:shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1 sm:gap-2",children:[e.jsx(xr,{className:"h-2 w-2 text-red-600 sm:h-3 sm:w-3"}),e.jsx("span",{className:"text-[10px] sm:text-xs",children:"سحب"})]}),e.jsx("span",{className:"text-[10px] sm:text-xs font-bold text-red-700",children:b(j.monthlyWithdrawalProfit)})]})}),e.jsx("div",{className:"bg-blue-50 p-0.5 rounded border border-blue-200 sm:bg-gradient-to-r sm:from-blue-50 sm:to-blue-100 sm:p-2 sm:rounded-xl sm:shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1 sm:gap-2",children:[e.jsx(li,{className:"h-2 w-2 text-blue-600 sm:h-3 sm:w-3"}),e.jsx("span",{className:"text-[10px] sm:text-xs",children:"تحويل"})]}),e.jsx("span",{className:"text-[10px] sm:text-xs font-bold text-blue-700",children:b(j.monthlyTransferProfit)})]})}),e.jsx("div",{className:"bg-purple-50 p-0.5 rounded border border-purple-200 sm:bg-gradient-to-r sm:from-purple-50 sm:to-purple-100 sm:p-2 sm:rounded-xl sm:shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1 sm:gap-2",children:[e.jsx(Ge,{className:"h-2 w-2 text-purple-600 sm:h-3 sm:w-3"}),e.jsx("span",{className:"text-[10px] sm:text-xs",children:"إجمالي"})]}),e.jsx("span",{className:"text-[10px] sm:text-xs font-bold text-purple-700",children:b(j.monthlyWithdrawalProfit+j.monthlyTransferProfit)})]})})]}),!t&&e.jsx("div",{className:"absolute inset-0 bg-yellow-200/70 backdrop-blur-sm flex items-center justify-center rounded sm:rounded-2xl border border-yellow-300 pointer-events-auto",children:e.jsx(d,{size:"sm",variant:"ghost",onClick:()=>v(!0),className:"p-2 bg-yellow-300/80 text-yellow-900 hover:bg-yellow-400/90 rounded-full shadow-sm hover:shadow-md transition-all duration-300",title:"إدخال الرقم السري الرئيسي",children:e.jsx(st,{className:"h-4 w-4"})})}),e.jsx("div",{className:"flex justify-center pt-0 border-t-0 sm:pt-2 sm:border-t sm:border-purple-200",children:e.jsx(d,{onClick:()=>u(!1),className:"bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-xl text-sm sm:bg-gradient-to-r sm:from-purple-600 sm:to-purple-700 sm:hover:from-purple-700 sm:hover:to-purple-800 sm:px-4 sm:py-1 sm:rounded-xl sm:shadow-lg sm:hover:shadow-xl sm:transition-all sm:duration-300",children:"إغلاق"})})]})}),e.jsx(Bs,{open:y,onOpenChange:v,onSuccess:Z,description:"لا يمكن الاطلاع على الأرباح الشهرية إلا بإدخال الرقم السري الرئيسي"})]})},Ed=l=>e.jsx(Fd,{...l});function Bd({open:l,onOpenChange:h,onSuccess:o,userId:u}){const[y,v]=r.useState(""),[t,A]=r.useState(""),[j,m]=r.useState(!1),[x,S]=r.useState(!1),[b,M]=r.useState(""),[U,Z]=r.useState(!1),{toast:B}=Xt(),k=sa.hasProfitPin(u),C=()=>{v(""),A(""),M(""),m(!1),S(!1),h(!1)},_=async L=>{L.preventDefault(),M(""),Z(!0);try{if(k){if(!sa.verifyProfitPin(y,u)){M("الرقم السري غير صحيح"),Z(!1);return}}else{if(y.length<4){M("يجب أن يكون الرقم السري 4 أرقام على الأقل"),Z(!1);return}if(y!==t){M("الرقم السري غير متطابق"),Z(!1);return}sa.setProfitPin(y,u)}B({title:"نجح العملية",description:k?"تم التحقق من الرقم السري بنجاح":"تم إنشاء رقم سري الأرباح بنجاح"}),o(),C()}catch{M("حدث خطأ أثناء معالجة الرقم السري")}finally{Z(!1)}};return e.jsx(ie,{open:l,onOpenChange:h,children:e.jsxs(oe,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ce,{children:e.jsxs(de,{className:"flex items-center gap-2 text-lg font-semibold",children:[e.jsx(Rs,{className:"h-5 w-5 text-green-600"}),k?"أدخل رقم سري الأرباح":"إنشاء رقم سري للأرباح"]})}),e.jsxs("form",{onSubmit:_,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-gray-600 bg-blue-50 p-3 rounded-lg",children:k?"أدخل الرقم السري لعرض بيانات الأرباح":"قم بإنشاء رقم سري لحماية بيانات الأرباح. يمكنك تغييره لاحقاً من إعدادات البروفيل."}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"pin",children:k?"الرقم السري":"الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"pin",type:j?"text":"password",value:y,onChange:L=>v(L.target.value),placeholder:k?"أدخل الرقم السري":"أدخل رقم سري جديد (4 أرقام على الأقل)",className:"pr-10",dir:"ltr",autoComplete:"off",required:!0}),e.jsx(d,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>m(!j),children:j?e.jsx(Ft,{className:"h-4 w-4"}):e.jsx(st,{className:"h-4 w-4"})})]})]}),!k&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"confirmPin",children:"تأكيد الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"confirmPin",type:x?"text":"password",value:t,onChange:L=>A(L.target.value),placeholder:"أعد إدخال الرقم السري",className:"pr-10",dir:"ltr",autoComplete:"off",required:!0}),e.jsx(d,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>S(!x),children:x?e.jsx(Ft,{className:"h-4 w-4"}):e.jsx(st,{className:"h-4 w-4"})})]})]}),b&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(Us,{className:"h-4 w-4"}),b]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(d,{type:"submit",disabled:U,className:"flex-1 bg-green-600 hover:bg-green-700",children:[e.jsx(Rs,{className:"h-4 w-4 mr-2"}),U?"جاري المعالجة...":k?"عرض الأرباح":"إنشاء وعرض الأرباح"]}),e.jsx(d,{type:"button",variant:"outline",onClick:C,disabled:U,children:"إلغاء"})]})]})]})})}const Md=({userId:l,transactions:h})=>{const[o,u]=r.useState(!1),[y,v]=r.useState(!1),[t,A]=r.useState(!1),[j,m]=r.useState({dailyWithdrawalProfit:0,dailyTransferProfit:0,lastUpdated:new Date});r.useEffect(()=>{l&&o&&t&&x()},[l,o,t]);const x=async()=>{if(l)try{const U=sa.getWithdrawTransferProfits(l);m({dailyWithdrawalProfit:U.dailyWithdrawProfit||0,dailyTransferProfit:U.dailyTransferProfit||0,lastUpdated:new Date})}catch(U){console.error("Error loading profit data:",U)}},S=U=>`${U.toFixed(2)} ج.م`,b=()=>{sa.hasProfitPin(l),v(!0)},M=()=>{A(!0),u(!0),v(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(d,{size:"sm",variant:"ghost",onClick:b,className:"h-2 w-2 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded transition-all duration-300 hover:scale-110 shadow-sm hover:shadow-md",title:"عرض الأرباح اليومية",children:e.jsx(st,{className:"h-1.5 w-1.5"})}),e.jsx(ie,{open:o,onOpenChange:u,children:e.jsxs(oe,{className:"max-w-[220px] mx-auto bg-white border border-gray-200 shadow-md rounded sm:max-w-[180px] sm:bg-gradient-to-br sm:from-blue-50 sm:to-white sm:border-2 sm:border-blue-200 sm:shadow-2xl sm:rounded-2xl",children:[e.jsx(ce,{className:"text-center pb-0 border-b-0 sm:pb-2 sm:border-b sm:border-blue-200",children:e.jsxs(de,{className:"text-xs font-bold text-blue-800 flex items-center justify-center gap-0 mb-0 leading-tight tracking-tight sm:text-sm sm:gap-1 sm:mb-0 sm:leading-normal sm:tracking-normal",children:[e.jsx(Ge,{className:"h-2 w-2 text-blue-600 sm:h-3 sm:w-3"}),"يومي"]})}),e.jsxs("div",{className:"space-y-0 py-0 sm:space-y-4 sm:py-4",children:[e.jsx("div",{className:"bg-yellow-50 p-2 rounded border border-yellow-200 sm:bg-gradient-to-r sm:from-yellow-50 sm:to-yellow-100 sm:p-4 sm:rounded-xl sm:shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-0 sm:gap-2",children:[e.jsx(Ge,{className:"h-3 w-3 text-yellow-600 sm:h-5 sm:w-5"}),e.jsx("span",{className:"font-medium text-yellow-800 text-xs sm:text-base",children:"أرباح فوري"})]}),e.jsx("span",{className:"font-bold text-sm text-yellow-900 bg-white px-0 py-0.5 rounded text-center sm:text-lg sm:px-3 sm:py-1",children:S((j.dailyWithdrawalProfit??0)+(j.dailyTransferProfit??0))})]})}),e.jsx("div",{className:"bg-red-50 p-2 rounded border border-red-200 sm:bg-gradient-to-r sm:from-red-50 sm:to-red-100 sm:p-4 sm:rounded-xl sm:shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-0 sm:gap-2",children:[e.jsx(xr,{className:"h-3 w-3 text-red-600 sm:h-5 sm:w-5"}),e.jsx("span",{className:"font-medium text-red-800 text-xs sm:text-base",children:"سحب"})]}),e.jsx("span",{className:"font-bold text-sm text-red-900 bg-white px-0 py-0.5 rounded text-center sm:text-lg sm:px-3 sm:py-1",children:S(j.dailyWithdrawalProfit)})]})}),e.jsx("div",{className:"bg-green-50 p-0.5 rounded border border-green-200 sm:bg-gradient-to-r sm:from-green-50 sm:to-green-100 sm:p-2 sm:rounded-xl sm:shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between h-4 sm:h-auto",children:[e.jsxs("div",{className:"flex items-center gap-0 sm:gap-1",children:[e.jsx(li,{className:"h-2 w-2 text-green-600 sm:h-3 sm:w-3"}),e.jsx("span",{className:"font-medium text-green-800 text-xs leading-tight tracking-tighter sm:font-semibold sm:text-xs sm:leading-normal sm:tracking-normal",children:"تحويل"})]}),e.jsx("span",{className:"font-bold text-xs text-green-900 bg-white px-0 py-0 rounded text-center leading-tight tracking-tighter sm:text-sm sm:px-2 sm:py-0.5 sm:leading-normal sm:tracking-normal",children:S(j.dailyTransferProfit)})]})}),e.jsx("div",{className:"bg-blue-50 p-0.5 rounded border border-blue-200 sm:bg-gradient-to-r sm:from-blue-50 sm:to-blue-100 sm:p-2 sm:rounded-xl sm:shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between h-4 sm:h-auto",children:[e.jsxs("div",{className:"flex items-center gap-0 sm:gap-1",children:[e.jsx(Ge,{className:"h-2 w-2 text-blue-600 sm:h-3 sm:w-3"}),e.jsx("span",{className:"font-medium text-blue-800 text-xs leading-tight tracking-tighter sm:font-semibold sm:text-xs sm:leading-normal sm:tracking-normal",children:"مجموع"})]}),e.jsx("span",{className:"font-bold text-xs text-blue-900 bg-white px-0 py-0 rounded text-center leading-tight tracking-tighter sm:text-sm sm:px-2 sm:py-0.5 sm:leading-normal sm:tracking-normal",children:S(j.dailyWithdrawalProfit+j.dailyTransferProfit)})]})})]}),e.jsx("div",{className:"flex justify-center pt-0 border-t-0 sm:pt-2 sm:border-t sm:border-blue-200",children:e.jsx(d,{onClick:()=>u(!1),className:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-xl text-sm sm:bg-gradient-to-r sm:from-blue-600 sm:to-blue-700 sm:hover:from-blue-700 sm:hover:to-blue-800 sm:px-4 sm:py-1 sm:rounded-xl sm:shadow-lg sm:hover:shadow-xl sm:transition-all sm:duration-300 sm:text-xs",children:"إغلاق"})})]})}),e.jsx(Bd,{open:y,onOpenChange:v,onSuccess:M,userId:l})]})},Ld=l=>e.jsx(Md,{...l}),mr=l=>Number(l||0).toFixed(2),Rd=({open:l,onOpenChange:h,userId:o})=>{const{toast:u}=Xt(),[y,v]=mt.useState([]),[t,A]=mt.useState(!1),[j,m]=mt.useState("");mt.useEffect(()=>{(async()=>{if(!(!l||!o))try{A(!0);const M=[...await Ql.getByUser(o)].sort((U,Z)=>U.reportDate<Z.reportDate?1:-1);v(M)}catch(b){console.error("Failed to load daily archive history:",b),u({title:"فشل تحميل الأرشيف",description:"تعذر تحميل أرشيف التقارير اليومية",variant:"destructive"})}finally{A(!1)}})()},[l,o]);const x=mt.useMemo(()=>{if(!j)return y;const S=j.trim();return y.filter(b=>b.reportDate.includes(S))},[y,j]);return e.jsx(ie,{open:l,onOpenChange:h,children:e.jsxs(oe,{className:"sm:max-w-xl",children:[e.jsxs(ce,{children:[e.jsx(de,{children:"أرشيف التقارير اليومية"}),e.jsx(Mt,{children:"يعرض جميع الأيام المؤرشفة مع ملخص لكل يوم."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"archive-search",children:"بحث بالتاريخ (YYYY-MM-DD)"}),e.jsx(R,{id:"archive-search",placeholder:"مثال: 2025-10-19",value:j,onChange:S=>m(S.target.value)})]}),e.jsx("div",{className:"mt-3 space-y-2 max-h-[50vh] overflow-auto",children:t?e.jsx("div",{className:"text-sm text-muted-foreground",children:"جاري التحميل..."}):x.length===0?e.jsx("div",{className:"text-sm text-muted-foreground",children:"لا توجد تقارير مؤرشفة حتى الآن"}):x.map(S=>e.jsxs("div",{className:"border rounded-md p-2 bg-gradient-to-r from-white/80 to-blue-50/70",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{className:"font-bold text-blue-800",children:S.reportDate}),e.jsxs("div",{className:"text-xs text-blue-700",children:["عدد المعاملات: ",S.totalTransactions]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-1",children:[e.jsxs("div",{className:"text-xs text-blue-800",children:["إجمالي المبالغ: ",e.jsx("span",{className:"font-semibold",children:mr(S.totalAmount)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["المسحوب: ",e.jsx("span",{className:"font-semibold",children:mr(S.totalWithdrawn)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["المرسل: ",e.jsx("span",{className:"font-semibold",children:mr(S.totalSent)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["الربح: ",e.jsx("span",{className:"font-semibold",children:mr(S.profit)})]})]})]},S.id||`${S.userId}-${S.reportDate}`))}),e.jsx(De,{children:e.jsx(d,{variant:"outline",onClick:()=>h(!1),children:"إغلاق"})})]})})},$d=({open:l,onOpenChange:h})=>{var ss;const{shiftUser:o,isShiftActive:u,shiftStartAt:y,setShiftUser:v,startShift:t,endShift:A}=Ta(),{userSubscription:j,user:m,signIn:x,profile:S}=xs(),{toast:b}=Xt(),[M,U]=r.useState((o==null?void 0:o.name)||""),[Z,B]=r.useState((o==null?void 0:o.username)||""),[k,C]=r.useState(""),[_,L]=r.useState(!1),[O,J]=r.useState(null),[he,ae]=r.useState(""),[pe,H]=r.useState("");r.useState(!1);const[X,Te]=r.useState(null),[K,re]=r.useState(""),[ke,at]=r.useState(""),[vt,Ee]=r.useState(!1),[yt,qe]=r.useState(!1),[Ye,ut]=r.useState({totalTransfers:0,totalWithdrawals:0}),[rt,Be]=r.useState(null),[p,z]=r.useState(""),[ee,fe]=r.useState(""),[ne,Me]=r.useState(0),[nt,Qe]=r.useState({}),[_e,D]=r.useState(0),[Q,ue]=r.useState(0),[Se,be]=r.useState({}),[Le,F]=r.useState(""),[te,$]=r.useState(!1),[Ce,Re]=r.useState(()=>{try{const W=localStorage.getItem("cashierUsers");return W?JSON.parse(W):[]}catch{return[]}}),Lt=(ss=j==null?void 0:j.subscription)==null?void 0:ss.planType,bt=Lt==="yearly"?2:Lt==="lifetime"?4:Number.POSITIVE_INFINITY;r.useEffect(()=>{try{localStorage.setItem("cashierUsers",JSON.stringify(Ce))}catch{}},[Ce]);const[es,Et]=r.useState(!1),[gs,Rt]=r.useState(""),[ts,ra]=r.useState(null),[ws,_s]=r.useState([]),[ka,zs]=r.useState(!1),[Ze,fr]=r.useState(null),[kn,Js]=r.useState(!1),[xt,$t]=r.useState(!1),Pt=W=>{const me=(o==null?void 0:o.username)===W;let Nt=!1;try{Nt=localStorage.getItem("lastHandoverToAdmin")==="true"}catch{}if(me&&!(me&&!u&&(Le==="الأدمن الرئيسي"||Nt))){b({title:"لا يمكن الحذف",description:"لا يمكنك حذف مستخدم الوردية أثناء كونها نشطة أو قبل تسليمها للأدمن الرئيسي"});return}const _t=`هل أنت متأكد من حذف المستخدم ${W}؟

هذا الإجراء لا يمكن التراجع عنه.`;window.confirm(_t)&&(Re(pt=>pt.filter(la=>la.username!==W)),me&&v(null),b({title:"تم حذف المستخدم",description:W}))},Ks=()=>{if(!M.trim()||!Z.trim()||!k.trim())return;if(Ce.length>=bt){b({title:"وصلت الحد الأقصى للمستخدمين",description:`هذه الباقة تسمح بإضافة ${Number.isFinite(bt)?bt:"عدد غير محدود"} كاشير فقط`,variant:"destructive"});return}const W={name:M.trim(),username:Z.trim(),password:k.trim()};Re(me=>[W,...me]),U(""),B(""),C("")},jt=()=>{L(!0),J(null),Te(null),re(""),at("")},Ss=async()=>{try{let W=[];try{m!=null&&m.uid&&(W=await we.getUserTransactions(m.uid))}catch{}if(!W||W.length===0)try{const je=await ad({merchantUserId:m==null?void 0:m.uid,limit:200});W=(je==null?void 0:je.transactions)||[]}catch{}const me=y?new Date(y):null,Nt=new Date,Pe=je=>{const $e=je.type,zt=je.txnType;return $e==="withdraw"||$e==="withdrawal"||$e==="receive"||zt==="receive"},Ut=je=>{const $e=je.type,zt=je.txnType;return $e==="send"||$e==="transfer"||zt==="send"},_t=je=>{if(!je)return null;if(je instanceof Date)return je;try{const $e=new Date(je);return Number.isNaN($e.getTime())?null:$e}catch{return null}},pt=je=>{const $e=_t(je.createdAt||je.created_at||je.timestamp);return!$e||me&&$e<me?!1:$e<=Nt},la=je=>je==="completed"||je==="confirmed",Dt=W.filter(je=>la(je.status)&&pt(je)),ia=Dt.filter(je=>Pe(je)).reduce((je,$e)=>{const zt=$e.withdrawnAmount??$e.receivedAmount??$e.amount??0;return je+(Number(zt)||0)},0);return{totalTransfers:Dt.filter(je=>Ut(je)).reduce((je,$e)=>{const zt=$e.sentAmount??$e.transferredAmount??$e.amount??0;return je+(Number(zt)||0)},0),totalWithdrawals:ia}}catch{return{totalTransfers:0,totalWithdrawals:0}}};r.useEffect(()=>{if(yt){try{const W=localStorage.getItem("shiftInitialReceivedDrawerFunds");W!==null&&fe(W)}catch{}try{const W=localStorage.getItem("shiftInitialReceivedWalletBalancesTotal");if(W!==null){const me=parseFloat(W);Me(Number.isFinite(me)?me:0)}}catch{}}},[yt]),r.useEffect(()=>{if(!l&&!ka)return;(async()=>{try{const Nt=((m!=null&&m.uid?await we.getUserTransactions(m.uid):[])||[]).filter(Pe=>(Pe==null?void 0:Pe.type)==="report"||((Pe==null?void 0:Pe.title)||"").includes("إيصال تسليم وردية"));Nt.sort((Pe,Ut)=>{const _t=new Date(Pe.createdAt||0).getTime();return new Date(Ut.createdAt||0).getTime()-_t}),_s(Nt)}catch{_s([])}})()},[l,yt,ka,m==null?void 0:m.uid]);const na=async(W,me,Nt)=>{try{let Pe=0,Ut=0;try{const pt=parseFloat(localStorage.getItem("shiftInitialReceivedDrawerFunds")||"0");Pe=Number.isFinite(pt)?pt:0}catch{}try{const pt=parseFloat(localStorage.getItem("shiftInitialReceivedWalletBalancesTotal")||"0");Ut=Number.isFinite(pt)?pt:0}catch{}const _t={id:`shift_receipt_${Date.now()}`,type:"report",senderPhone:(o==null?void 0:o.username)||"cashier",receiverPhone:Le||"admin",amount:0,status:"completed",createdAt:new Date().toISOString(),title:"إيصال تسليم وردية",cashierName:(o==null?void 0:o.name)||(o==null?void 0:o.username)||null,deficit:me,deficitAmount:me?Nt:0,shiftStartAt:y,receivedDrawerFunds:Pe,receivedWalletBalancesTotal:Ut,receivedWalletBalances:nt,deliveredDrawerFunds:_e||0,deliveredWalletBalancesTotal:Q||0,deliveredWalletBalances:Se,shiftProfit:Math.round(((_e||0)+(Q||0)-(Pe+Ut))*100)/100};m!=null&&m.uid&&await we.saveUserTransaction(m.uid,_t),_s(pt=>[_t,...pt||[]])}catch{}};return e.jsxs(e.Fragment,{children:[e.jsx(ie,{open:l,onOpenChange:h,children:e.jsxs(oe,{className:"sm:max-w-md",children:[e.jsx(ce,{children:e.jsx(de,{children:u?"تسليم الورديه والخروج":"إضافة مستخدم وردية"})}),u?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsx("div",{className:"text-sm",children:"المستخدم الحالي للوردية:"}),e.jsxs("div",{className:"font-semibold text-sm",children:[o==null?void 0:o.name," (",o==null?void 0:o.username,")"]})]}),e.jsx("div",{className:"text-xs text-gray-600",children:'لإنهاء الوردية والخروج، اضغط "تسليم الورديه والخروج" وسيُطلب الرقم السري.'})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-xs text-gray-600",children:'لاستكمال إضافة مستخدم جديد اضغط الزر أسفل "إضافة مستخدم جديد" لفتح النموذج.'}),Ce.length>0&&e.jsxs("div",{className:"mt-4 border-t pt-3",children:[e.jsx("div",{className:"text-sm font-medium mb-2",children:"المستخدمون المسجلون"}),e.jsx("div",{className:"space-y-2 max-h-48 overflow-auto",children:Ce.map((W,me)=>e.jsxs("div",{className:"flex items-center justify-between rounded border px-3 py-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:W.name}),e.jsx("div",{className:"text-xs text-gray-500",children:W.username})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(d,{size:"sm",className:"w-full sm:w-auto",onClick:()=>{ra(W),Et(!0)},children:"دخول"}),e.jsx(d,{size:"sm",className:"w-full sm:w-auto",variant:"destructive",onClick:()=>Pt(W.username),children:"حذف"})]})]},me))})]})]}),e.jsx(De,{className:"flex flex-wrap gap-2 justify-between",children:u?e.jsx("div",{className:"flex flex-wrap gap-2",children:e.jsx(d,{className:"w-full sm:w-auto",variant:"destructive",onClick:jt,children:"تسليم الورديه والخروج"})}):e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(d,{className:"w-full sm:w-auto",onClick:()=>$t(!0),children:"إضافة مستخدم جديد"}),e.jsx(d,{className:"w-full sm:w-auto",variant:"outline",onClick:()=>zs(!0),children:"إيصالات التسليم"})]})})]})}),e.jsx(ie,{open:xt,onOpenChange:$t,children:e.jsxs(oe,{className:"sm:max-w-md",children:[e.jsx(ce,{children:e.jsx(de,{children:"إضافة مستخدم جديد"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(V,{className:"mb-1 block",children:"الاسم"}),e.jsx(R,{value:M,onChange:W=>U(W.target.value),placeholder:"أدخل الاسم"})]}),e.jsxs("div",{children:[e.jsx(V,{className:"mb-1 block",children:"اسم المستخدم"}),e.jsx(R,{value:Z,onChange:W=>B(W.target.value),placeholder:"أدخل اسم المستخدم"})]}),e.jsxs("div",{children:[e.jsx(V,{className:"mb-1 block",children:"الرقم السري"}),e.jsx(R,{type:"password",autoComplete:"new-password",value:k,onChange:W=>C(W.target.value),placeholder:"أدخل الرقم السري"})]}),e.jsx("div",{className:"text-xs text-gray-500",children:"المستخدم يمكنه: التحويل، السحب، اختيار المحفظة فقط."})]}),e.jsxs(De,{className:"flex gap-2 justify-between",children:[e.jsx(d,{variant:"secondary",onClick:()=>{$t(!1)},children:"إلغاء"}),e.jsx(d,{onClick:()=>{!M.trim()||!Z.trim()||!k.trim()||(Ks(),$t(!1))},children:"حفظ المستخدم"})]})]})}),e.jsx(ie,{open:ka,onOpenChange:zs,children:e.jsxs(oe,{className:"sm:max-w-lg",children:[e.jsx(ce,{children:e.jsx(de,{children:"إيصالات التسليم"})}),ws.length===0?e.jsx("div",{className:"text-xs text-gray-600",children:"لا توجد إيصالات تسليم محفوظة بعد."}):e.jsx("div",{className:"space-y-2 max-h-[60vh] overflow-auto",children:ws.map(W=>e.jsxs("div",{className:"rounded border px-3 py-2 cursor-pointer hover:bg-gray-50",onClick:()=>{fr(W),Js(!0)},children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm font-semibold",children:new Date(W.createdAt).toLocaleString("ar-EG")}),e.jsxs("div",{className:"text-xs text-gray-500",children:["إلى: ",W.receiverPhone]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-1",children:[e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مسلّمة: ",W.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مسلّمة (إجمالي): ",W.deliveredWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مستلمة: ",W.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مستلمة (إجمالي): ",W.receivedWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مسلّمة: ",W.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مسلّمة (إجمالي): ",W.deliveredWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مستلمة: ",W.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مستلمة (إجمالي): ",W.receivedWalletBalancesTotal??0]}),e.jsxs("div",{className:["text-xs",(W.shiftProfit??(W.deliveredDrawerFunds??0)+(W.deliveredWalletBalancesTotal??0)-(W.receivedDrawerFunds??0)-(W.receivedWalletBalancesTotal??0))>=0?"text-green-700":"text-red-700"].join(" "),children:["أرباح الوردية: ",W.shiftProfit??(W.deliveredDrawerFunds??0)+(W.deliveredWalletBalancesTotal??0)-(W.receivedDrawerFunds??0)-(W.receivedWalletBalancesTotal??0)]})]}),W.deficit&&e.jsxs("div",{className:"text-xs text-red-600 mt-1",children:["عجز: ",W.deficitAmount??0]})]},W.id))}),e.jsx(De,{className:"flex gap-2 justify-between",children:e.jsx(d,{variant:"secondary",onClick:()=>zs(!1),children:"إغلاق"})})]})}),e.jsx(ie,{open:kn,onOpenChange:Js,children:e.jsxs(oe,{className:"sm:max-w-md",children:[e.jsx(ce,{children:e.jsx(de,{children:"إيصال تسليم وردية"})}),Ze?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsxs("div",{className:"text-sm",children:["التاريخ: ",new Date(Ze.createdAt).toLocaleString("ar-EG")]}),e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["تم التسليم إلى: ",Ze.receiverPhone]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"المستلم عند الدخول"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية: ",Ze.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["أرصدة المحافظ (إجمالي): ",Ze.receivedWalletBalancesTotal??0]})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"المسلّم عند الخروج"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية: ",Ze.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["أرصدة المحافظ (إجمالي): ",Ze.deliveredWalletBalancesTotal??0]})]})]}),Ze.deficit&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2 text-red-600",children:"عجز"}),e.jsxs("div",{className:"text-xs text-red-600",children:["المبلغ: ",Ze.deficitAmount??0]})]}),Ze.receivedWalletBalances&&Object.keys(Ze.receivedWalletBalances).length>0&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"تفصيل المحافظ المستلمة"}),e.jsx("div",{className:"space-y-1",children:Object.entries(Ze.receivedWalletBalances).map(([W,me])=>e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-gray-600",children:W}),e.jsx("span",{className:"font-semibold",children:me})]},W))})]}),Ze.deliveredWalletBalances&&Object.keys(Ze.deliveredWalletBalances).length>0&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"تفصيل المحافظ المسلّمة"}),e.jsx("div",{className:"space-y-1",children:Object.entries(Ze.deliveredWalletBalances).map(([W,me])=>e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-gray-600",children:W}),e.jsx("span",{className:"font-semibold",children:me})]},W))})]})]}):e.jsx("div",{className:"text-xs text-gray-600",children:"لا يوجد تقرير محدد للعرض."}),e.jsx(De,{className:"flex gap-2 justify-between",children:e.jsx(d,{variant:"secondary",onClick:()=>Js(!1),children:"إغلاق"})})]})}),e.jsx(ie,{open:es,onOpenChange:Et,children:e.jsxs(oe,{className:"sm:max-w-md",children:[e.jsx(ce,{children:e.jsx(de,{children:"أدخل الرقم السري للدخول"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm",children:ts?`${ts.name} (${ts.username})`:""}),e.jsx(R,{type:"password",autoComplete:"off",value:gs,onChange:W=>Rt(W.target.value),placeholder:"أدخل الرقم السري"})]}),e.jsxs(De,{className:"flex gap-2 justify-between",children:[e.jsx(d,{variant:"secondary",onClick:()=>{Rt(""),ra(null),Et(!1)},children:"إلغاء"}),e.jsx(d,{onClick:()=>{if(ts){if(gs.trim()!==ts.password){b({title:"خطأ في الرقم السري",description:"الرقم السري للكاشير غير صحيح",variant:"destructive"});return}v({name:ts.name,username:ts.username}),Rt(""),Et(!1),h(!1),t(),$(!0)}},children:"دخول الورديه"})]})]})}),e.jsx(ie,{open:te,onOpenChange:$,children:e.jsxs(oe,{className:"sm:max-w-md",children:[e.jsx(ce,{children:e.jsx(de,{children:"تسجيل أرصدة البداية والنقدية"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(V,{className:"mb-1 block",children:"الفلوس النقدية المستلمة عند الدخول"}),e.jsx(R,{type:"number",value:ee,onChange:W=>fe(W.target.value),placeholder:"أدخل قيمة النقدية في الدرج عند بداية الورديه"})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(V,{className:"mb-1 block",children:"أرصدة المحافظ المستلمة (إجمالي) عند الدخول"}),e.jsx(R,{type:"number",value:Number.isFinite(ne)?ne:0,onChange:W=>{const me=parseFloat(W.target.value);Me(Number.isFinite(me)?me:0)},placeholder:"أدخل إجمالي أرصدة المحافظ عند بداية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"يمكن إضافة التفصيل لاحقاً إن لزم، المهم تسجيل الإجمالي."})]})]}),e.jsx(De,{className:"flex gap-2 justify-between",children:e.jsx(d,{onClick:()=>{const W=parseFloat(ee),me=ne,Nt=Number.isFinite(W)&&W>=0,Pe=Number.isFinite(me)&&me>=0;if(!Nt||!Pe){b({title:"يرجى إدخال قيم صحيحة",description:"أدخل قيمًا رقمية غير سالبة للنقدية ولإجمالي أرصدة المحافظ",variant:"destructive"});return}try{localStorage.setItem("shiftInitialReceivedDrawerFunds",String(W)),localStorage.setItem("shiftInitialReceivedWalletBalancesTotal",String(me))}catch{}b({title:"تم تسجيل أرصدة البداية",description:"سُجّل إجمالي النقدية وأرصدة المحافظ لبداية الورديه"}),$(!1)},children:"تأكيد وحفظ"})})]})}),e.jsx(ie,{open:_,onOpenChange:W=>{W&&L(!0)},children:e.jsxs(oe,{className:"sm:max-w-md",hideClose:!0,disableOutsideClose:!0,disableEscClose:!0,children:[e.jsx(ce,{children:e.jsx(de,{children:"تسليم الورديه والخروج"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(d,{variant:O==="toUser"?"default":"secondary",onClick:()=>J("toUser"),children:"تسليم إلى مستخدم آخر"}),e.jsx(d,{variant:O==="toAdmin"?"default":"secondary",onClick:()=>J("toAdmin"),children:"تسليم إلى الأدمن الرئيسي"})]}),O==="toUser"&&e.jsxs("div",{className:"space-y-3",children:[Ce.length===0?e.jsx("div",{className:"text-sm text-gray-600",children:"لا يوجد مستخدمون مسجلون. قم بإضافة مستخدم أولاً."}):e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"اختر المستخدم الذي سيتسلم الورديه"}),e.jsx("div",{className:"space-y-2 max-h-40 overflow-auto",children:Ce.map((W,me)=>e.jsxs("div",{className:`flex items-center justify-between rounded border px-3 py-2 cursor-pointer ${(X==null?void 0:X.username)===W.username?"bg-indigo-50 border-indigo-200":""}`,onClick:()=>Te(W),children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:W.name}),e.jsx("div",{className:"text-xs text-gray-500",children:W.username})]}),e.jsx("span",{className:"text-xs text-gray-400",children:"اختيار"})]},me))})]}),e.jsxs("div",{children:[e.jsx(V,{className:"mb-1 block",children:"كلمة سر المستخدم المحدد"}),e.jsx(R,{type:"password",autoComplete:"off",value:K,onChange:W=>re(W.target.value),placeholder:"أدخل كلمة السر"})]}),ke&&e.jsx("div",{className:"text-xs text-red-600",children:ke})]}),O==="toAdmin"&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm text-gray-600",children:"أدخل كلمة مرور الحساب الرئيسي لتسليم الورديه والخروج إلى الأدمن."}),e.jsx(R,{type:"password",autoComplete:"off",value:he,onChange:W=>ae(W.target.value),placeholder:"كلمة المرور"}),pe&&e.jsx("div",{className:"text-xs text-red-600",children:pe})]})]}),e.jsx(De,{className:"flex gap-2 justify-between",children:e.jsx(d,{disabled:vt||!O,onClick:async()=>{if(O){Ee(!0);try{const W=await Ss();if(O==="toUser"){if(!X){at("يرجى اختيار المستخدم أولاً"),Ee(!1);return}if(K.trim()!==X.password){at("كلمة السر غير صحيحة"),Ee(!1);return}A(),v({name:X.name,username:X.username}),t(),F(`${X.name} (${X.username})`);try{localStorage.setItem("lastHandoverToAdmin","false")}catch{}L(!1),J(null),Te(null),re(""),at(""),h(!1),ut(W),Be(null),z(""),qe(!0)}else if(O==="toAdmin"){H("");const me=(m==null?void 0:m.email)||"";if(!me){H("لا يوجد بريد للمستخدم الرئيسي للتحقق"),Ee(!1);return}const{error:Nt}=await x(me,he);if(Nt){H("كلمة المرور غير صحيحة"),Ee(!1);return}A(),v(null);try{localStorage.setItem("lastHandoverToAdmin","true")}catch{}ae(""),L(!1),h(!1),F("الأدمن الرئيسي"),ut(W),Be(null),z(""),qe(!0)}}catch{at("حدث خطأ أثناء التسليم، حاول مرة أخرى")}finally{Ee(!1)}}},children:"تأكيد التسليم"})})]})}),e.jsx(ie,{open:yt,onOpenChange:qe,children:e.jsxs(oe,{className:"sm:max-w-lg",hideClose:!0,disableOutsideClose:!0,disableEscClose:!0,children:[e.jsx(ce,{children:e.jsx(de,{children:"تقرير تسليم الورديه والخروج"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsxs("div",{className:"text-sm",children:["تم تسليم الورديه إلى: ",e.jsx("span",{className:"font-semibold",children:Le})]}),y&&e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["بداية الورديه: ",new Date(y).toLocaleString("ar-EG")]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نهاية الورديه: ",new Date().toLocaleString("ar-EG")]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(V,{className:"mb-1 block",children:"الفلوس النقدية المستلمة"}),e.jsx(R,{type:"number",value:ee,readOnly:!0,disabled:!0,placeholder:"قيمة مسجلة عند بداية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"قيمة غير قابلة للتعديل؛ تُسجّل عند الدخول."})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(V,{className:"mb-1 block",children:"أرصدة المحافظ المستلمة (إجمالي)"}),e.jsx(R,{type:"number",value:ne,readOnly:!0,disabled:!0,placeholder:"إجمالي مسجل عند بداية الورديه"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(V,{className:"mb-1 block",children:"الفلوس النقدية المسلمة"}),e.jsx(R,{type:"number",value:_e,onChange:W=>{const me=parseFloat(W.target.value);D(Number.isFinite(me)?me:0)},placeholder:"أدخل قيمة النقدية المسلمة عند نهاية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"ادخال يدوي لقيمة النقدية المسلّمة عند نهاية الورديه"})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(V,{className:"mb-1 block",children:"أرصدة المحافظ المسلمة (إجمالي)"}),e.jsx(R,{type:"number",value:Q,onChange:W=>{const me=parseFloat(W.target.value);ue(Number.isFinite(me)?me:0)},placeholder:"أدخل إجمالي أرصدة المحافظ المسلّمة"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"يمكنك إدخال الإجمالي يدوياً؛ التفصيل يُحفظ إن لزم"})]})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-1",children:"أرباح الوردية"}),e.jsx("div",{className:["text-sm",(_e??0)+(Q??0)-((parseFloat(ee||"0")||0)+(ne??0))>=0?"text-green-700":"text-red-700"].join(" "),children:Math.round(((_e??0)+(Q??0)-((parseFloat(ee||"0")||0)+(ne??0)))*100)/100}),e.jsx("div",{className:"text-xs text-gray-600",children:"محسوبة: (المسلّم − المستلم) للنقدية + المحافظ"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"هل يوجد عجز؟"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(d,{variant:rt==="no"?"default":"secondary",onClick:()=>Be("no"),children:"لا"}),e.jsx(d,{variant:rt==="yes"?"default":"secondary",onClick:()=>Be("yes"),children:"نعم"})]}),rt==="yes"&&e.jsxs("div",{children:[e.jsx(V,{className:"mb-1 block",children:"مبلغ العجز"}),e.jsx(R,{type:"number",value:p,onChange:W=>z(W.target.value),placeholder:"أدخل مبلغ العجز"})]})]})]}),e.jsx(De,{className:"flex gap-2 justify-between",children:e.jsx(d,{onClick:()=>{const W=rt==="yes",me=parseFloat(p)||0;(async()=>await na(Ye,W,me))(),b({title:"تم إضافة إيصال تسليم الورديه",description:"أُضيف الإيصال إلى المعاملات الأخيرة بعنوان إيصال تسليم وردية"}),qe(!1)},children:"تأكيد وحفظ الإيصال"})})]})})]})},Ud=({open:l,onOpenChange:h})=>{const{shiftUser:o,endShift:u,setShiftUser:y}=Ta(),[v,t]=r.useState(""),[A,j]=r.useState(""),[m,x]=r.useState([]);r.useEffect(()=>{try{const b=localStorage.getItem("cashierUsers");x(b?JSON.parse(b):[])}catch{x([])}},[l]);const S=async()=>{if(j(""),!o)return;const b=m.find(M=>M.username===o.username);if(!b){j("لا يوجد مستخدم مطابق لهذه الوردية");return}if(v.trim()!==b.password){j("الرقم السري غير صحيح");return}u(),y(null),t(""),h(!1)};return e.jsx(ie,{open:l,onOpenChange:b=>{t(""),j(""),h(b)},children:e.jsxs(oe,{className:"sm:max-w-md",children:[e.jsx(ce,{children:e.jsx(de,{children:"بروفيل الوردية"})}),o?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"rounded-lg border p-3 bg-gradient-to-r from-blue-50 to-indigo-50",children:[e.jsx("div",{className:"text-sm font-semibold text-gray-800",children:o.name}),e.jsx("div",{className:"text-xs text-gray-600",children:o.username})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{className:"block",children:"أدخل الرقم السري لتسليم الوردية"}),e.jsx(R,{type:"password",value:v,onChange:b=>t(b.target.value),placeholder:"الرقم السري للمستخدم",dir:"ltr"}),A&&e.jsx("div",{className:"text-red-600 text-xs",children:A})]})]}):e.jsx("div",{className:"text-sm text-gray-600",children:"لا يوجد مستخدم وردية نشط حالياً"}),e.jsxs(De,{className:"flex justify-between",children:[e.jsx(d,{variant:"outline",onClick:()=>h(!1),children:"إغلاق"}),e.jsx(d,{onClick:S,disabled:!o,children:"تسليم الوردية"})]})]})})};class Xs{static async processTransfer(h){const{amount:o,currentCashBalance:u,currentWalletBalances:y,wallets:v,selectedWalletId:t}=h;if(o<=0)return{success:!1,newCashBalance:u,newWalletBalances:y,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(t&&!h.skipRemoteLimitsCheck)try{const x=await hs.canPerformOperation(t,o,"transfer");if(!x.canPerform)return{success:!1,newCashBalance:u,newWalletBalances:y,message:x.message||"تجاوز حد التحويل المسموح",error:"LIMIT_EXCEEDED"}}catch(x){return console.error("خطأ في التحقق من حدود التحويل:",x),{success:!1,newCashBalance:u,newWalletBalances:y,message:"خطأ في التحقق من حدود التحويل",error:"LIMIT_CHECK_ERROR"}}if(o<=0)return{success:!1,newCashBalance:u,newWalletBalances:y,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(t){const x=Math.max(y[t]||0,0);if(x<o){const S=v.find(b=>b.id===t);return{success:!1,newCashBalance:u,newWalletBalances:y,message:`رصيد غير كافي في المحفظة${S?` ${S.name}`:""}. المتاح: ${x} جنيه، المطلوب: ${o} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"}}}else{const x=Xs.calculateTotalWalletBalance(y);if(x<o)return{success:!1,newCashBalance:u,newWalletBalances:y,message:`رصيد غير كافي في المحافظ. الرصيد المتاح: ${x} جنيه، المبلغ المطلوب: ${o} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"}}const A={...y};if(t){const x=A[t]||0;A[t]=x-o}else{let x=o;for(const S of v){if(x<=0)break;const b=Math.max(A[S.id]||0,0),M=Math.min(b,x);M>0&&(A[S.id]=(A[S.id]||0)-M,x-=M)}}const j=u+o;if(t)try{const x=hs.updateUsage(t,o,"transfer");h.nonBlockingUsageUpdate?x.catch(S=>console.error("خطأ في تحديث استخدام المحفظة:",S)):await x}catch(x){console.error("خطأ في تحديث استخدام المحفظة:",x)}let m="تم التحويل بنجاح";if(t){const x=A[t]||0;x<0&&(m=`تم التحويل بنجاح مع تحذير: رصيد محفظة ${t} أصبح ${x} جنيه.`)}return{success:!0,newCashBalance:j,newWalletBalances:A,message:m}}static processDeposit(h){const{amount:o,currentCashBalance:u,currentWalletBalances:y,wallets:v}=h;if(o<=0)return{success:!1,newCashBalance:u,newWalletBalances:y,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};const t=this.calculateTotalWalletBalance(y);if(t<o)return{success:!1,newCashBalance:u,newWalletBalances:y,message:`رصيد غير كافي في المحافظ. الرصيد المتاح: ${t} جنيه، المبلغ المطلوب: ${o} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"};const A=u+o,j={...y};let m=o;const x=v.find(b=>b.isDefault);if(x&&j[x.id]>=m)j[x.id]-=m,m=0;else for(const b of v){if(m<=0)break;const M=j[b.id]||0;if(M>0){const U=Math.min(M,m);j[b.id]=M-U,m-=U}}const S=m>0?`تم الإيداع جزئياً. تم إيداع ${o-m} جنيه في صندوق النقدية`:`تم الإيداع بنجاح. تم إضافة ${o} جنيه إلى صندوق النقدية`;return{success:!0,newCashBalance:A,newWalletBalances:j,message:S}}static async processWithdraw(h){const{amount:o,currentCashBalance:u,currentWalletBalances:y,wallets:v,selectedWalletId:t}=h;if(o<=0)return{success:!1,newCashBalance:u,newWalletBalances:y,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(t&&!h.skipRemoteLimitsCheck)try{const x=await hs.canPerformOperation(t,o,"withdraw");if(!x.canPerform)return{success:!1,newCashBalance:u,newWalletBalances:y,message:x.reason||"تم تجاوز الحد المسموح للسحب",error:"LIMIT_EXCEEDED"}}catch(x){return console.error("خطأ في التحقق من حدود السحب:",x),{success:!1,newCashBalance:u,newWalletBalances:y,message:"خطأ في التحقق من حدود السحب",error:"LIMIT_CHECK_ERROR"}}if(u<o)return{success:!1,newCashBalance:u,newWalletBalances:y,message:`رصيد غير كافي في صندوق النقدية. الرصيد المتاح: ${u} جنيه، المبلغ المطلوب: ${o} جنيه`,error:"INSUFFICIENT_CASH_BALANCE"};const A=u-o,j={...y},m=t?v.find(x=>x.id===t):v.find(x=>x.isDefault)||v[0];if(m){const x=j[m.id]||0;j[m.id]=x+o}else return{success:!1,newCashBalance:u,newWalletBalances:y,message:"لا توجد محافظ متاحة لإضافة المبلغ إليها",error:"NO_WALLETS_AVAILABLE"};if(t)try{const x=hs.updateUsage(t,o,"withdraw");h.nonBlockingUsageUpdate?x.catch(S=>console.error("خطأ في تحديث استخدام المحفظة:",S)):await x}catch(x){console.error("خطأ في تحديث استخدام المحفظة:",x)}return{success:!0,newCashBalance:A,newWalletBalances:j,message:`تم السحب بنجاح. تم إضافة ${o} جنيه إلى محفظة ${(m==null?void 0:m.name)||""}`}}static validateOperation(h,o){return h<=0?{valid:!1,error:"المبلغ يجب أن يكون أكبر من الصفر"}:!o||o.length===0?{valid:!1,error:"لا توجد محافظ متاحة"}:{valid:!0}}static calculateTotalWalletBalance(h){return Object.values(h).reduce((o,u)=>o+Math.max(u,0),0)}static deductFromWalletsAddToCash(h,o,u,y){return this.processTransfer({amount:h,currentCashBalance:o,currentWalletBalances:u,wallets:y})}static deductFromWalletsAddToCashDeposit(h,o,u,y){return this.processDeposit({amount:h,currentCashBalance:o,currentWalletBalances:u,wallets:y})}static deductFromCashAddToWallets(h,o,u,y){return this.processWithdraw({amount:h,currentCashBalance:o,currentWalletBalances:u,wallets:y})}static applyTransactionResult(h,o,u){h.success&&(o(h.newCashBalance),u(h.newWalletBalances))}static validateTransaction(h,o,u,y){if(h<=0)return{isValid:!1,error:"المبلغ يجب أن يكون أكبر من الصفر"};if(o==="transfer"){const v=this.calculateTotalWalletBalance(y);if(v<h)return{isValid:!1,error:`الرصيد المتاح في المحافظ (${v} جنيه) غير كافي للمبلغ المطلوب (${h} جنيه)`}}else if(o==="withdraw"){if(u<h)return{isValid:!1,error:`الرصيد المتاح في صندوق النقدية (${u} جنيه) غير كافي للمبلغ المطلوب (${h} جنيه)`}}else if(o==="deposit"){const v=this.calculateTotalWalletBalance(y);if(v<h)return{isValid:!1,error:`الرصيد المتاح في المحافظ (${v} جنيه) غير كافي للمبلغ المطلوب (${h} جنيه)`}}return{isValid:!0}}static getDeductionPreview(h,o,u){const y=[];let v=h;for(const t of u){if(v<=0)break;const A=o[t.id]||0,j=Math.min(Math.max(A,0),v);j>0&&(y.push({walletId:t.id,walletName:t.name,currentBalance:A,deductedAmount:j,newBalance:A-j}),v-=j)}return y}}let wa=null;function _d(){const l=window;if(!wa){const h=l.AudioContext||l.webkitAudioContext;wa=new h}return wa.state==="suspended"&&wa.resume(),wa}function zd(l,h,o){const u=o/1e3,y=Math.floor(l.sampleRate*u),v=l.createBuffer(1,y,l.sampleRate),t=v.getChannelData(0);for(let x=0;x<y;x++)t[x]=(Math.random()*2-1)*.6;const A=l.createBufferSource();A.buffer=v;const j=l.createBiquadFilter();j.type="highpass",j.frequency.value=1500,j.Q.value=.7;const m=l.createGain();m.gain.setValueAtTime(1e-4,h),m.gain.exponentialRampToValueAtTime(.4,h+.015),m.gain.exponentialRampToValueAtTime(1e-4,h+u),A.connect(j),j.connect(m),m.connect(l.destination),A.start(h),A.stop(h+u+.01)}function Jd(l,h,o,u,y,v="triangle"){const t=l.createOscillator(),A=l.createGain();t.type=v;const j=y/1e3;t.frequency.setValueAtTime(o,h),t.frequency.linearRampToValueAtTime(u,h+j),A.gain.setValueAtTime(1e-4,h),A.gain.exponentialRampToValueAtTime(.25,h+.02),A.gain.exponentialRampToValueAtTime(1e-4,h+j),t.connect(A),A.connect(l.destination),t.start(h),t.stop(h+j+.02)}function Kd(){try{const l=_d(),h=l.currentTime;zd(l,h,90),Jd(l,h+.12,1900,1100,180,"sawtooth")}catch{}}function Vd(l){if(!l)return!1;const o=l.replace(/[^0-9٠-٩]/g,"").replace(/[٠-٩]/g,u=>"0123456789"["٠١٢٣٤٥٦٧٨٩".indexOf(u)]);return/^(010|011|012|015)[0-9]{8}$/.test(o)}const Jm=()=>{var Pl,Ol,Wl,Fl,El,Bl,Ml;console.log("🔥 UserDashboardPage component is loading...");const{toast:l}=Xt(),h=r.useRef(null),[o,u]=r.useState(0),y=async()=>{var n,i,c;const s="alkaptin678678@gmail.com",a=(i=(n=Qs.currentUser)==null?void 0:n.email)==null?void 0:i.toLowerCase();if(!a||a!==s){l({title:"قيد التطوير",description:"هذه الميزة غير متاحة حالياً."});return}if(!qa||!Ya||!Ha){l({title:"بيانات ناقصة",description:"أدخل رقم الموبايل، الشركة والمبلغ",variant:"destructive"});return}try{cl(!0);const g=await((c=Qs.currentUser)==null?void 0:c.getIdToken()),f=await fetch("/api/topup",{method:"POST",headers:{"Content-Type":"application/json",...g?{Authorization:`Bearer ${g}`}:{}},body:JSON.stringify({phone:qa,countryCode:"EG",operator:Ya,amount:Number(Ha),useLocalAmount:!0})}),N=await f.json().catch(()=>({}));f.ok&&(N!=null&&N.success)?(l({title:"تم الشحن",description:(N==null?void 0:N.message)||"تم تنفيذ عملية الشحن بنجاح"}),Yr(!1),nl(""),ll(""),il("")):l({title:"فشل الشحن",description:(N==null?void 0:N.message)||"حدث خطأ أثناء طلب الشحن",variant:"destructive"})}catch(g){console.error("Topup request error:",g),l({title:"خطأ غير متوقع",description:"تعذّر تنفيذ عملية الشحن. حاول لاحقاً.",variant:"destructive"})}finally{cl(!1)}},{signOut:v,user:t,profile:A}=xs(),j=((t==null?void 0:t.email)||"").toLowerCase()==="vodafonecash00@gmail.com",m=xc(),x=ql(),{isShiftActive:S,shiftUser:b}=Ta(),{shopName:M}=pc(),U=gc(),[Z,B]=r.useState(!1),[k,C]=r.useState(!1);console.log("🔥 UserDashboardPage - user:",t?"exists":"null");const[_,L]=r.useState(!0),[O,J]=r.useState(!0),[he,ae]=r.useState(!1),[pe,H]=r.useState(!1),[X,Te]=r.useState(""),[K,re]=r.useState(""),[ke,at]=r.useState(""),[vt,Ee]=r.useState([]),[yt,qe]=r.useState(!1),[Ye,ut]=r.useState(null),[rt,Be]=r.useState(!1),[p,z]=r.useState(""),[ee,fe]=r.useState(!1),[ne,Me]=r.useState(0),[nt,Qe]=r.useState([]),_e=(A==null?void 0:A.fullName)||((Pl=Qs.currentUser)==null?void 0:Pl.displayName)||((Ol=Qs.currentUser)==null?void 0:Ol.email)||"مستخدم",D=(A==null?void 0:A.phone)||null,Q=((Wl=Qs.currentUser)==null?void 0:Wl.email)||null;r.useEffect(()=>{if(!(t!=null&&t.uid))return;const s=un.listenForUserReports(t.uid,a=>{Qe(a);const n=a.filter(i=>i.status==="replied"&&!i.isReadByUser).length;Me(n)});return()=>{try{typeof s=="function"&&s()}catch{}}},[t==null?void 0:t.uid]),r.useEffect(()=>{rt&&nt.filter(s=>s.status==="replied"&&!s.isReadByUser).forEach(s=>{un.markAsRead(s.id).catch(()=>{})})},[rt]);const ue=async()=>{const s=p.trim();if(!(t!=null&&t.uid)||!s){l({title:"بيانات ناقصة",description:"أدخل نص البلاغ.",variant:"destructive"});return}try{fe(!0),await un.create({userId:t.uid,shopId:(A==null?void 0:A.shopId)??null,userName:_e||"مستخدم",phone:D,email:Q,message:s}),l({title:"تم الإرسال",description:"تم إرسال البلاغ وسيصل رد الإدمن هنا."}),z(""),Be(!1)}catch(a){console.error("Report send error:",a),l({title:"خطأ في الإرسال",description:"حاول مرة أخرى لاحقاً.",variant:"destructive"})}finally{fe(!1)}},[Se,be]=r.useState("");r.useState(!1);const[Le,F]=r.useState(!1),[te,$]=r.useState(!1),[Ce,Re]=r.useState(!1),[Lt,bt]=r.useState(""),[es,Et]=r.useState(""),[gs,Rt]=r.useState([]),[ts,ra]=r.useState(!1),[ws,_s]=r.useState(0),[ka,zs]=r.useState(!1),[Ze,fr]=r.useState(null),[kn,Js]=r.useState(!1),[xt,$t]=r.useState(""),[Pt,Ks]=r.useState(""),[jt,Ss]=r.useState(""),[na,ss]=r.useState(!1),[W,me]=r.useState(""),[Nt,Pe]=r.useState(""),[Ut,_t]=r.useState(""),[pt,la]=r.useState(""),[Dt,ia]=r.useState(null),[An,je]=r.useState(!1),[$e,zt]=r.useState(!1),[Ct,vr]=r.useState(""),[It,yr]=r.useState(""),[Pn,Wi]=r.useState(""),Aa=s=>{const a="٠١٢٣٤٥٦٧٨٩",n="۰۱۲۳۴۵۶۷۸۹";return(s||"").split("").map(i=>{const c=a.indexOf(i);if(c>-1)return String(c);const g=n.indexOf(i);return g>-1?String(g):i}).join("")},[Ie,br]=r.useState(()=>{try{const s=localStorage.getItem("commissionMode")||localStorage.getItem("commissionMode_default");return s?s==="add":!0}catch{return!0}}),[se,On]=r.useState("transfer"),[ot,fs]=r.useState([]),[as,jr]=r.useState("all");r.useEffect(()=>{try{if(localStorage.setItem("commissionMode",Ie?"add":"deduct"),t!=null&&t.uid){const s=`commissionMode_${t.uid}`;localStorage.setItem(s,Ie?"add":"deduct")}}catch{}},[Ie,t==null?void 0:t.uid]),r.useEffect(()=>{try{const s=t!=null&&t.uid?localStorage.getItem(`commissionMode_${t.uid}`):null,a=localStorage.getItem("commissionMode"),n=localStorage.getItem("commissionMode_default"),i=s??a??n;i&&br(i==="add")}catch{}},[t==null?void 0:t.uid]);const[Fi,Ei]=r.useState(!1),[Bi,qd]=r.useState(null),[G,oa]=r.useState("");r.useEffect(()=>{if(!na)return;const s=vs(),a=parseFloat(jt||"0")||0;let n=0;if(se==="transfer"){if((s==null?void 0:s.defaultTransferCommission)!=null){const c=Number(s.defaultTransferCommission)||0;n=Math.round(c*a/1e3*100)/100}else{const c=It&&It.trim()!==""?parseFloat(It):0;n=Math.max(0,c)}const i=a+n;Pe((i||0).toString())}else{if((s==null?void 0:s.defaultWithdrawCommission)!=null){const c=Number(s.defaultWithdrawCommission)||0;n=Math.round(c*a/1e3*100)/100}else{const c=Ct&&Ct.trim()!==""?parseFloat(Ct):Math.round(a*.01*100)/100;n=Math.max(0,c)}const i=Ie?a:Math.max(0,Math.round((a-n)*100)/100);Pe((i||0).toString())}},[na,jt,It,Ct,G,Ie,se]);const vs=()=>{var a,n;let s=ye.find(i=>i.id===G);if(!s)try{const i=localStorage.getItem(Ys());if(i){const c=JSON.parse(i);if(Array.isArray(c)&&c.length>0){const f=localStorage.getItem(`selectedWallet_${(t==null?void 0:t.uid)||"default"}`)||((a=c.find(N=>N.isDefault))==null?void 0:a.id)||((n=c[0])==null?void 0:n.id);s=c.find(N=>N.id===f)}}}catch{}return s};r.useLayoutEffect(()=>{try{const s=`wallets_${(t==null?void 0:t.uid)||"default"}`;let a=localStorage.getItem(s);if(!a){const n=Object.keys(localStorage).find(i=>i.startsWith("wallets_"));n&&(a=localStorage.getItem(n)||null)}if(a){const n=JSON.parse(a);if(Array.isArray(n)&&n.length>0){rs(n);const i=`selectedWallet_${(t==null?void 0:t.uid)||"default"}`,c=localStorage.getItem(i),g=c&&n.find(f=>f.id===c)||n.find(f=>f.isDefault)||n[0];g&&(oa(g.id),$t(g.phone))}}}catch(s){console.error("تهيئة فورية للمحافظ من التخزين المحلي فشلت:",s)}},[]),r.useEffect(()=>{console.log("🔍 selectedWallet state changed to:",G)},[G]),r.useEffect(()=>{To()},[]),r.useEffect(()=>{Ao()},[]);const[ye,rs]=r.useState(()=>{try{const s=Object.keys(localStorage).find(n=>n.startsWith("wallets_")),a=s?localStorage.getItem(s):null;if(a){const n=JSON.parse(a);if(Array.isArray(n))return n}}catch{}return[]}),[Wn,Mi]=r.useState(""),Fn=(()=>{const s=Wn.replace(/\D/g,"");return s?ye.filter(a=>(a.phone||"").replace(/\D/g,"").includes(s)):ye})(),[Li,Yd]=r.useState(null),[Ri,En]=r.useState(!1),[$i,Pa]=r.useState(!1),[Ui,_i]=r.useState(null);r.useState([]),r.useState([]);const[zi,ca]=r.useState(!1),[Nr,Bn]=r.useState("daily"),[Ji,Mn]=r.useState(!1),[Ki,wr]=r.useState(!1),[Ln,Ds]=r.useState([]),Vi=async s=>{try{const a=ot.find(i=>i.id===s);if(!a||!t)return;const n=ot.filter(i=>i.id!==s);fs(n);try{await we.removeUserTransaction(t.uid,s),await ir.permanentlyDeleteTransaction(s,t.uid)}catch(i){console.warn("تعذر الحذف النهائي من قواعد البيانات أثناء حذف الإيصال:",i)}try{const i=et(),c=Xe(),g=localStorage.getItem(i),f=localStorage.getItem(c);let N=g?parseFloat(g):ze,E=f?JSON.parse(f):{...ve};const I=a.amount||a.transferredAmount||a.withdrawnAmount||a.withdrawnAmountDetailed||0;if(a.type==="send"&&(a.fromWallet||G)){N-=a.commission||0;const Y=a.fromWallet||G;E[Y]=(E[Y]||0)+I}else if(a.type==="withdraw"&&(a.fromWallet||G)){N+=I,N-=a.commission||0;const Y=a.fromWallet||G;E[Y]=Math.max(0,(E[Y]||0)-I)}lt(N),Je(E),localStorage.setItem(i,N.toString()),localStorage.setItem(c,JSON.stringify(E));const w={cashBalance:N,walletBalances:E,lastUpdated:new Date().toISOString()},P=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(P,JSON.stringify(w)),t!=null&&t.uid?we.updateUserData(t.uid,w).then(()=>{localStorage.removeItem(P),ge(!1)}).catch(Y=>{console.warn("تعذر حفظ الأرصدة في Firebase بعد الحذف، تم الاحتفاظ محليًا:",Y),ge(!0)}):ge(!0)}catch(i){console.warn("تعذر عكس تأثير الأرصدة بعد الحذف:",i)}try{const i=a.fromWallet||G,c=await hs.getWalletLimits(t.uid,i);if(c){const g=a.amount||a.transferredAmount||a.withdrawnAmount||a.withdrawnAmountDetailed||0,f={...c};a.type==="send"?(f.dailyTransferUsed=Math.max(0,(c.dailyTransferUsed||0)-g),f.monthlyTransferUsed=Math.max(0,(c.monthlyTransferUsed||0)-g)):(f.dailyWithdrawUsed=Math.max(0,(c.dailyWithdrawUsed||0)-g),f.monthlyWithdrawUsed=Math.max(0,(c.monthlyWithdrawUsed||0)-g)),await hs.updateWalletLimits(t.uid,i,f)}}catch(i){console.warn("تعذر تحديث حدود المحفظة بعد الحذف:",i)}try{Yt.removeTransactionEffects(a,t.uid)}catch(i){console.warn("تعذر تحديث التقارير بعد الحذف:",i)}l({title:"تم الحذف نهائيًا",description:"تم حذف الإيصال نهائيًا وعكس تأثيراته على الأرصدة والحدود والتقارير."}),Pa(!1)}catch(a){console.error("خطأ أثناء حذف الإيصال:",a),l({title:"خطأ في حذف الإيصال",description:"حدث خطأ غير متوقع أثناء الحذف.",variant:"destructive"})}},qi=async s=>{try{if(!ot.find(n=>n.id===s)||!t)return;await ta(Gt(it,"userTransactions",s),{status:"completed",confirmedAt:new Date}),fs(n=>n.map(i=>i.id===s?{...i,status:"completed"}:i)),l({title:"تم الإكمال",description:"تم وسم المعاملة كمكتملة."}),Pa(!1)}catch(a){console.error("خطأ أثناء إكمال الإيصال:",a),l({title:"فشل الإكمال",description:"حدث خطأ غير متوقع أثناء تحديث الحالة.",variant:"destructive"})}},[Rn,Yi]=r.useState(""),$n=Wd(Rn,300),[Oa,Un]=r.useState(""),[Wa,_n]=r.useState(""),[ys,Hd]=r.useState(""),[Sr,Vs]=r.useState(!1),[zn,da]=r.useState(!1),[Hi,Fa]=r.useState(!1),[wt,Dr]=r.useState(null),[Gi,Cr]=r.useState(!1),[Qi,Ea]=r.useState(!1),[Zi,Ba]=r.useState(!1),[Xi,Ma]=r.useState(!1),[eo,La]=r.useState(!1),[to,Jn]=r.useState(!0),[ma,so]=r.useState(!1),[ao,Ra]=r.useState(!1),[ro,Kn]=r.useState(()=>{try{const s=t!=null&&t.uid?`dailyReportsLockEnabled_${t==null?void 0:t.uid}`:"dailyReportsLockEnabled";return(localStorage.getItem(s)??localStorage.getItem("dailyReportsLockEnabled"))==="true"}catch{return!1}}),[no,Ir]=r.useState(!1);r.useEffect(()=>{try{const s=t!=null&&t.uid?`dailyReportsLockEnabled_${t==null?void 0:t.uid}`:"dailyReportsLockEnabled",a=localStorage.getItem(s)??localStorage.getItem("dailyReportsLockEnabled");Kn(a==="true")}catch{}},[t==null?void 0:t.uid]);const[lo,$a]=r.useState(!1),[io,ha]=r.useState(!1),[St,Jt]=r.useState([]),[Tr,Vn]=r.useState(""),[kr,qn]=r.useState(""),[Ar,Yn]=r.useState(""),[xe,Pr]=r.useState(null),[oo,ua]=r.useState(!1);r.useState(!1);const[co,Or]=r.useState(!1),[Hn,Wr]=r.useState(""),[mo,xa]=r.useState(!1),[ho,Fr]=r.useState(!1),[ns,Er]=r.useState([]),[Br,Gn]=r.useState(""),[Mr,Qn]=r.useState(""),[Lr,Zn]=r.useState(""),[Xn,el]=r.useState(""),[uo,Ua]=r.useState(!1),[Rr,$r]=r.useState(null),[Ot,pa]=r.useState(null),[_a,Ur]=r.useState(""),[xo,qs]=r.useState(!1),[tl,za]=r.useState(0),[Vt,Cs]=r.useState(null),[Is,_r]=r.useState(""),[Fe,po]=r.useState(null),ls=async s=>{try{const a=JSON.stringify(s);localStorage.setItem(dl(),a);try{localStorage.setItem(hl(),a)}catch{}t!=null&&t.uid&&we.updateUserData(t.uid,{debts:s}).catch(()=>ge(!0))}catch(a){console.error("خطأ في حفظ الديون:",a)}},go=async()=>{try{const s=dl(),a=hl(),n=localStorage.getItem(s),i=localStorage.getItem(a),c=f=>{if(!f)return null;try{const N=JSON.parse(f);return Array.isArray(N)?N.map(E=>{var I;return{...E,createdAt:(I=E.createdAt)!=null&&I.toDate?E.createdAt.toDate():new Date(E.createdAt),partialPayments:Array.isArray(E.partialPayments)?E.partialPayments.map(w=>{var P;return{amount:Number(w.amount)||0,paidAt:(P=w.paidAt)!=null&&P.toDate?w.paidAt.toDate():new Date(w.paidAt)}}):[]}}):[]}catch(N){return console.warn("فشل في تحليل ديون localStorage:",N),null}};let g=c(n);if(!g||g.length===0){const f=c(i);if(f&&f.length>0&&(g=f,Jt(f),t!=null&&t.uid))try{await ls(f),localStorage.removeItem(a)}catch(N){console.warn("تعذر ترحيل الديون من المفتاح الافتراضي:",N)}}if(g&&g.length>0&&Jt(g),t!=null&&t.uid)try{const f=await or(Gt(it,"users",t.uid));if(f.exists()){const N=f.data(),E=N.debts&&Array.isArray(N.debts)?N.debts.map(P=>{var Y;return{...P,createdAt:(Y=P.createdAt)!=null&&Y.toDate?P.createdAt.toDate():new Date(P.createdAt),partialPayments:Array.isArray(P.partialPayments)?P.partialPayments.map(T=>{var q;return{amount:Number(T.amount)||0,paidAt:(q=T.paidAt)!=null&&q.toDate?T.paidAt.toDate():new Date(T.paidAt)}}):[]}}):[],I=g&&g.length>0?g:E;Jt(I);try{localStorage.setItem(s,JSON.stringify(I))}catch{}(I.length!==E.length||I.some(P=>{const Y=E.find(T=>T.id===P.id);return!Y||Y.amount!==P.amount||Y.status!==P.status||(Y.paidAmount??0)!==(P.paidAmount??0)}))&&await we.updateUserData(t.uid,{debts:I})}else g&&g.length>0&&await we.saveUserData(t.uid,{debts:g})}catch(f){console.warn("تعذر تحميل الديون من Firebase، الاعتماد على المحلي:",f)}}catch(s){console.error("خطأ في تحميل الديون:",s)}},fo=async()=>{if(t!=null&&t.uid){console.log("🔄 إعادة فحص حالة المستخدم...");try{await new Promise(a=>setTimeout(a,500));const s=await or(Gt(it,"users",t.uid));if(s.exists()){const n=s.data().isActive===!0,i=await Sa.checkTrialValidity(t.uid),c=i.isValid&&!i.isExpired;console.log("📊 حالة المستخدم:",{isActive:n,isOnTrial:c,hoursRemaining:i.hoursRemaining}),L(n||c),ra(c),_s(i.hoursRemaining),zs(i.hasUsedTrial),$(!n&&!c),console.log("✅ تم تحديث حالة المستخدم بنجاح:",{userIsActive:n||c,isOnFreeTrial:c})}}catch(s){console.error("خطأ في إعادة فحص حالة المستخدم:",s)}}},vo=async()=>{console.log("🎉 تم بدء التجربة المجانية، إعادة فحص حالة المستخدم..."),await fo()},yo=async()=>{if(t!=null&&t.uid)try{Js(!0);const s=await Cn(t.uid);fr(s)}catch(s){console.error("خطأ في جلب بيانات الاشتراك:",s)}finally{Js(!1)}};r.useState(!1);const[bo,zr]=r.useState(!1),[ze,lt]=r.useState(0),[ve,Je]=r.useState({}),[jo,sl]=r.useState(!1),[No,al]=r.useState(!1),[wo,Jr]=r.useState(!1),[So,Ja]=r.useState(!1),[rl,Kr]=r.useState(""),[Do,Vr]=r.useState(!1),[Co,Ka]=r.useState(!1),[qr,Va]=r.useState(""),[Io,Yr]=r.useState(!1),[qa,nl]=r.useState(""),[Ya,ll]=r.useState(""),[Ha,il]=r.useState(""),[ol,cl]=r.useState(!1),Xe=()=>`walletBalances_${(t==null?void 0:t.uid)||"default"}`,et=()=>`cashBalance_${(t==null?void 0:t.uid)||"default"}`,dl=()=>`debts_${(t==null?void 0:t.uid)||"default"}`,ml=()=>`customers_${(t==null?void 0:t.uid)||"default"}`,hl=()=>"debts_default",ul=()=>`shopExpenses_${(t==null?void 0:t.uid)||"default"}`,To=()=>{try{const s=localStorage.getItem(ul());if(s){const a=JSON.parse(s);Ee(a.map(n=>({...n,createdAt:new Date(n.createdAt)})))}}catch(s){console.error("خطأ أثناء تحميل مصروفات المحل من التخزين:",s)}},ko=async s=>{try{localStorage.setItem(ul(),JSON.stringify(s)),Ee(s)}catch(a){console.error("خطأ أثناء حفظ مصروفات المحل في التخزين:",a)}},xl=()=>`deficiencies_${(t==null?void 0:t.uid)||"default"}`,Ao=()=>{try{const s=localStorage.getItem(xl());if(s){const a=JSON.parse(s);Rt(a.map(n=>({...n,createdAt:new Date(n.createdAt)})))}}catch(s){console.error("خطأ أثناء تحميل النواقص من التخزين:",s)}},Hr=async s=>{try{localStorage.setItem(xl(),JSON.stringify(s)),Rt(s)}catch(a){console.error("خطأ أثناء حفظ النواقص في التخزين:",a)}},Po=async s=>{try{localStorage.setItem(ml(),JSON.stringify(s)),Er(s),t!=null&&t.uid&&await we.updateUserData(t.uid,{customers:s})}catch(a){console.error("خطأ أثناء حفظ العملاء في التخزين:",a)}},Oo=async()=>{try{if(t!=null&&t.uid){const a=await or(Gt(it,"users",t.uid));if(a.exists()){const n=a.data();if(n.customers&&Array.isArray(n.customers)){const i=n.customers.map(c=>{var g;return{...c,createdAt:(g=c.createdAt)!=null&&g.toDate?c.createdAt.toDate():new Date(c.createdAt)}});Er(i);return}}}const s=localStorage.getItem(ml());if(s){const a=JSON.parse(s);Er(a.map(n=>({...n,createdAt:new Date(n.createdAt)})))}}catch(s){console.error("خطأ أثناء تحميل العملاء من التخزين:",s)}},ga=()=>`transactions_${(t==null?void 0:t.uid)||"default"}`,fa=()=>`deletedTransactions_${(t==null?void 0:t.uid)||"default"}`,Ys=()=>`wallets_${(t==null?void 0:t.uid)||"default"}`,Ts=()=>`selectedWallet_${(t==null?void 0:t.uid)||"default"}`,Gr=()=>{try{const s=Ys(),a=localStorage.getItem(s);if(a){const n=JSON.parse(a);if(Array.isArray(n)&&n.length>0)return n}}catch(s){console.warn("loadWalletsFromLocalWithMigration failed:",s)}return null},Qr=s=>{try{const a=Ts(),n=localStorage.getItem(a);if(n&&s.find(i=>i.id===n))return n}catch{}return null},[Zr,Ga]=r.useState(""),[Tt,pl]=r.useState(""),qt=mt.useMemo(()=>{const s=Ze;if(!s)return!1;const a=fc(s),n=s.planType??s.plan??null,i=typeof n=="string"?n.toLowerCase():null,c=i==="monthly"||i==="quarterly"||i==="yearly"||i==="lifetime"||n===ds.MONTHLY||n===ds.QUARTERLY||n===ds.YEARLY||n===ds.LIFETIME;return a&&c},[Ze]),Ae=mt.useMemo(()=>{const s=Ze;if(!s)return!1;const a=s.planType??s.plan??null,n=typeof a=="string"?a.toLowerCase():null;return a===ds.ZERO||n==="zero"},[Ze]),Wo=()=>{if(!qt){l({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}B(!0)};r.useState(!1);const[Fo,Eo]=r.useState(!1),[Bo,Mo]=r.useState(!1),[Lo,Ro]=r.useState(!1),[$o,Qa]=r.useState(!1),[Za,Xr]=r.useState(""),[en,tn]=r.useState(""),[gl,fl]=r.useState(!1),[Uo,Xa]=r.useState(!1),[vl,sn]=r.useState(""),[yl,an]=r.useState(""),[bl,jl]=r.useState(!1),Nl=async()=>{if(t!=null&&t.uid)try{const s=`userData_${t.uid}`,a=localStorage.getItem(s);if(a){const n=JSON.parse(a);console.log("🔄 مزامنة البيانات المحلية مع Firebase...",n);const i={lastSynced:new Date().toISOString()};typeof n.cashBalance=="number"&&(i.cashBalance=n.cashBalance),n.walletBalances&&typeof n.walletBalances=="object"&&(i.walletBalances=n.walletBalances),await we.updateUserData(t.uid,i),localStorage.removeItem(s),ge(!1),console.log("✅ تمت المزامنة بنجاح وحذف البيانات المحلية")}else console.log("لا توجد بيانات محلية تحتاج للمزامنة")}catch(s){console.error("❌ فشل في مزامنة البيانات:",s),l({title:"فشل في المزامنة",description:"حدث خطأ أثناء مزامنة البيانات مع الخادم",variant:"destructive"})}},wl=t!=null&&t.uid?`recentTransactionsResetAt:${t.uid}`:null,rn=mt.useMemo(()=>{if(!wl)return null;try{const s=localStorage.getItem(wl);return s?new Date(s):null}catch{return null}},[t==null?void 0:t.uid]),Sl=mt.useMemo(()=>{const s=ot||[];return rn?s.filter(a=>new Date(a.createdAt)>=rn):s},[ot,rn]),Dl=mt.useCallback(()=>{let s=Sl;const a=$n.trim();if(a&&(s=s.filter(n=>n.senderPhone&&n.senderPhone.includes(a)||n.receiverPhone&&n.receiverPhone.includes(a))),Oa){const n=new Date(Oa);s=s.filter(i=>{const c=new Date(i.createdAt);if(Wa){const[g,f]=Wa.split(":"),N=new Date(n);N.setHours(parseInt(g),parseInt(f),0,0);const E=new Date(N);return E.setHours(E.getHours()+1),c>=N&&c<E}else return c.toDateString()===n.toDateString()})}try{s=[...s].sort((n,i)=>{const c=new Date(n.createdAt||0).getTime();return new Date(i.createdAt||0).getTime()-c})}catch{}return s},[Sl,$n,Oa,Wa]),[_o,er]=r.useState(!1),[Cl,tr]=r.useState(""),[zo,sr]=r.useState(!1),[nn,ln]=r.useState(""),[Jo,ge]=r.useState(!1);ye.reduce((s,a)=>s+(ve[a.id]||0),0);const Ko=s=>ms.verifyMasterPin(s),on=s=>ms.verifyMasterPin(s),cn=async s=>{try{const a=Qs.currentUser;if(!a||!a.email)return!1;const n=wc.credential(a.email,s);return await Sc(a,n),!0}catch(a){return console.error("فشل التحقق من كلمة المرور:",a),!1}};r.useEffect(()=>{if(!(t!=null&&t.uid))return;console.log("🚀 استعادة البيانات من localStorage عند تحميل الصفحة للمستخدم:",t.uid);const s=`walletBalances_${t.uid}`,a=localStorage.getItem(s);if(a)try{const c=JSON.parse(a);console.log("📱 استعادة أرصدة المحافظ من localStorage:",c),Je(c)}catch(c){console.error("خطأ في قراءة أرصدة المحافظ من localStorage:",c)}const n=`cashBalance_${t.uid}`;let i=localStorage.getItem(n);if(!i){const c=`userCashBalance_${t.uid}`,g=localStorage.getItem(c);if(g){i=g;try{localStorage.setItem(n,g),localStorage.removeItem(c)}catch{}}}if(i){const c=parseFloat(i);console.log("💰 استعادة رصيد الدرج النقدي من localStorage:",c),lt(c)}},[t==null?void 0:t.uid]);const Il=async()=>{try{if(!G)return;const s=await hs.autoResetLimitsIfNeeded(G);po(s)}catch(s){console.error("خطأ في جلب حدود المحفظة المختارة:",s)}};r.useEffect(()=>{Il()},[G]),r.useEffect(()=>{const s=a=>{var n;(n=a==null?void 0:a.detail)!=null&&n.walletId&&a.detail.walletId===G&&Il()};return window.addEventListener("walletLimitsUpdated",s),()=>window.removeEventListener("walletLimitsUpdated",s)},[G]),r.useEffect(()=>{if(m.state){if(console.log("Location state:",m.state),m.state.openDebtDialog&&(Ae?l({title:"غير متاح",description:"الديون/الأجل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):ha(!0),window.history.replaceState({},document.title)),m.state.openSalesDialog&&(Ae?l({title:"غير متاح",description:"بيانات المبيعات غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ea(!0),window.history.replaceState({},document.title)),m.state.openMaintenanceDialog&&(Ae?l({title:"غير متاح",description:"الصيانة غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ma(!0),window.history.replaceState({},document.title)),m.state.openCreditCardsDialog&&(console.log("Opening credit cards dialog"),Ae?l({title:"غير متاح",description:"كروت الائتمان غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ba(!0),window.history.replaceState({},document.title)),m.state.openShopExpensesDialog&&(Ae?l({title:"غير متاح",description:"مصروفات المحل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):ms.hasMasterPin()?H(!0):ae(!0),window.history.replaceState({},document.title)),m.state.openDeficienciesDialog&&(Ae?l({title:"غير متاح",description:"النواقص غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Re(!0),window.history.replaceState({},document.title)),m.state.openTransactionSection){const s=document.getElementById("transaction-section");s&&s.scrollIntoView({behavior:"smooth"}),m.state.transactionType&&On(m.state.transactionType),m.state.startNewTransaction&&(Ks(""),Ss(""),vr(""),yr(""),console.log("🔒 Starting new transaction without changing wallet selection")),m.state.focusWalletSelection&&setTimeout(()=>{const a=document.querySelector('[data-testid="wallet-select"]');a&&a.focus()},500),window.history.replaceState({},document.title)}m.state.openCashierShiftModal&&(qt?B(!0):l({title:"غير متاح",description:"وردية الكاشير متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"}),window.history.replaceState({},document.title)),m.state.openMachineDailyDialog&&(qt?La(!0):l({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"}),window.history.replaceState({},document.title))}},[m.state,ye]),r.useEffect(()=>{var s;if(t!=null&&t.uid)try{const a=Gr();if(a&&a.length>0){rs(a);const n=Qr(a)||localStorage.getItem(Ts()),i=n&&a.find(c=>c.id===n)?n:(s=a[0])==null?void 0:s.id;i&&!G&&va(i,"localStorageHydration")}}catch(a){console.error("خطأ في تهيئة المحافظ من التخزين المحلي:",a)}},[t==null?void 0:t.uid]),r.useEffect(()=>{m.pathname==="/user/dashboard"&&sessionStorage.getItem("previousPath")==="/user/add-wallet"&&(console.log("🔄 Returned from wallet addition page - reloading wallets"),ar(),sessionStorage.removeItem("previousPath")),sessionStorage.setItem("previousPath",m.pathname)},[m.pathname,t==null?void 0:t.uid]),r.useEffect(()=>{if(!(t!=null&&t.uid))return;console.log("🔥 Setting up real-time user activation listener for:",t.uid);const s=Gt(it,"users",t.uid),a=vc(s,n=>{if(n.exists()){const i=n.data(),c=i.isActive===!0;console.log("🔥 Real-time user status update:",{userId:t.uid,isActive:c,subscription:i.subscription}),c&&!_?(console.log("🎉 User activated! Redirecting to dashboard..."),L(!0),$(!1),J(!1)):!c&&_&&(console.log("❌ User deactivated! Showing activation modal..."),L(!1),$(!0))}},n=>{console.error("❌ Error in real-time user listener:",n)});return()=>{console.log("🔥 Cleaning up real-time user listener"),a()}},[t==null?void 0:t.uid,_]),r.useEffect(()=>{if(!(t!=null&&t.uid))return;const s=n=>{const{userId:i}=n.detail;i===t.uid&&(console.log("🎉 Subscription activation event received for current user!"),L(!0),$(!1),J(!1),setTimeout(()=>{console.log("✅ User activation completed - data updated")},1e3))},a=n=>{const{userId:i,isActive:c}=n.detail;i===t.uid&&(console.log("🔄 User subscription update event received:",{userId:i,isActive:c}),c&&!_&&(L(!0),$(!1),J(!1),setTimeout(()=>{console.log("✅ User subscription updated - data refreshed")},1e3)))};return window.addEventListener("subscriptionActivated",s),window.addEventListener("userSubscriptionUpdated",a),()=>{window.removeEventListener("subscriptionActivated",s),window.removeEventListener("userSubscriptionUpdated",a)}},[t==null?void 0:t.uid,_]),r.useEffect(()=>{const s=a=>{var g;const n=a.target,i=(g=n==null?void 0:n.tagName)==null?void 0:g.toLowerCase();if(!(i==="input"||i==="textarea"||i==="select"||((n==null?void 0:n.isContentEditable)??!1))&&!(a.ctrlKey||a.altKey||a.metaKey)&&!a.repeat){if(Ae&&a.key>="1"&&a.key<="9"){a.preventDefault();return}switch(a.key){case"1":break;case"2":Cr(!0);break;case"3":Ae?l({title:"غير متاح",description:"كروت الائتمان غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ba(!0);break;case"4":qt?B(!0):l({title:"غير متاح",description:"وردية الكاشير متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});break;case"5":Ae?l({title:"غير متاح",description:"بيانات المبيعات غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ea(!0);break;case"6":Ae?l({title:"غير متاح",description:"الديون/الأجل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):ha(!0);break;case"7":Ae?l({title:"غير متاح",description:"الصيانة غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ma(!0);break;case"8":qt?La(!0):l({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});break;case"9":Ae?l({title:"غير متاح",description:"مصروفات المحل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):ms.hasMasterPin()?H(!0):ae(!0);break}}};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[Ae,qt]),r.useEffect(()=>{console.log("🔥 useEffect loadUserData started",{user:t==null?void 0:t.uid,isCheckingActivation:O}),(async()=>{try{if(!(t!=null&&t.uid)){console.log("🔥 No user UID, setting isCheckingActivation to false"),J(!1);return}let i=!1;const c=`userData_${t==null?void 0:t.uid}`,g=localStorage.getItem(c);if(g)try{const w=JSON.parse(g);w.walletBalances&&(Je(w.walletBalances),i=!0,console.log("⚡ تحميل فوري لأرصدة المحافظ من بيانات المستخدم:",w.walletBalances))}catch(w){console.error("خطأ في قراءة بيانات المستخدم من localStorage:",w)}if(!i){const w=localStorage.getItem(Xe());if(w)try{const P=JSON.parse(w);Je(P),i=!0,console.log("⚡ تحميل فوري لأرصدة المحافظ من النسخة الاحتياطية:",P)}catch(P){console.error("خطأ في قراءة أرصدة المحافظ من localStorage:",P)}}if(!i){const P=Object.keys(localStorage).filter(Y=>Y.startsWith("walletBalances_backup_")).sort().reverse();for(const Y of P)try{const T=localStorage.getItem(Y);if(T){const q=JSON.parse(T);Je(q),i=!0,console.log("⚡ تحميل فوري لأرصدة المحافظ من النسخة الاحتياطية بالتوقيت:",q);break}}catch(T){console.error("خطأ في قراءة النسخة الاحتياطية:",T);continue}}let f=localStorage.getItem(et());if(!f&&(t!=null&&t.uid)){const w=`userCashBalance_${t.uid}`,P=localStorage.getItem(w);if(P){f=P;try{localStorage.setItem(et(),P),localStorage.removeItem(w)}catch{}}}f&&(lt(parseFloat(f)),console.log("⚡ تحميل فوري لرصيد الدرج النقدي من localStorage:",f));try{const w=await or(Gt(it,"users",t.uid));if(w.exists()){const Y=w.data().isActive===!0,T=await Sa.checkTrialValidity(t.uid),q=T.isValid&&!T.isExpired;L(Y||q),ra(q),_s(T.hoursRemaining),zs(T.hasUsedTrial),$(!Y&&!q),console.log("📊 حالة المستخدم:",{isActive:Y,isOnTrial:q,hoursRemaining:T.hoursRemaining,hasUsedTrial:T.hasUsedTrial})}else L(!1),$(!0)}catch(w){console.error("خطأ في فحص حالة تفعيل المستخدم:",w),L(!1),$(!0)}finally{J(!1)}console.log("🔄 بدء تحميل بيانات المستخدم من Firebase...",{userId:t==null?void 0:t.uid});const N=localStorage.getItem(c);let E=!1;if(N)try{const w=JSON.parse(N),P=new Date(w.lastUpdated);(new Date().getTime()-P.getTime())/(1e3*60)<1&&(E=!0,console.log("⚡ توجد تغييرات محلية حديثة (أقل من دقيقة)، تجنب إعادة التحميل من Firebase"),w.walletBalances&&Je(w.walletBalances),w.cashBalance!==void 0&&lt(w.cashBalance))}catch(w){console.error("خطأ في قراءة البيانات المحلية:",w)}if(N&&!E)try{const w=JSON.parse(N),P=new Date(w.lastUpdated);(new Date().getTime()-P.getTime())/(1e3*60)>10&&(console.log("🗑️ حذف البيانات المحلية القديمة (أكثر من 10 دقائق)"),localStorage.removeItem(c))}catch(w){console.error("خطأ في حذف البيانات المحلية القديمة:",w)}if(!E&&(t!=null&&t.uid)){const w=await we.getUserData(t.uid);if(console.log("📥 البيانات المحملة من Firebase:",w),w){const P=(w==null?void 0:w.walletBalances)||{},Y=w!=null&&w.lastUpdated?new Date(w.lastUpdated):null;let T=null,q=null;try{const Ne=localStorage.getItem(c);Ne&&(T=JSON.parse(Ne),T!=null&&T.lastUpdated&&(q=new Date(T.lastUpdated)))}catch(Ne){console.error("خطأ في قراءة بيانات النسخة المحلية للمقارنة:",Ne)}if(!!(q&&(!Y||q>Y))&&(T!=null&&T.walletBalances)){console.log("⚖️ تفضيل الأرصدة المحلية الأحدث على Firebase"),Je(T.walletBalances);try{localStorage.setItem(Xe(),JSON.stringify(T.walletBalances))}catch{}try{await we.updateUserData(t.uid,{walletBalances:T.walletBalances,lastUpdated:q.toISOString()})}catch(Ne){console.error("فشل مزامنة الأرصدة المحلية الأحدث إلى Firebase:",Ne),ge(!0)}}else{console.log("🏛️ اعتماد Firebase كمصدر الحقيقة لأرصدة المحافظ"),Je(P);try{localStorage.setItem(Xe(),JSON.stringify(P))}catch{}}if((w==null?void 0:w.cashBalance)!==void 0){console.log("💰 تحميل رصيد الدرج النقدي من Firebase:",w.cashBalance),lt(w.cashBalance);try{localStorage.setItem(et(),w.cashBalance.toString())}catch{}}try{const Ne=t!=null&&t.uid?await ir.getDeletedTransactionsByUser(t.uid):[];if(Ne&&Ne.length>0)Ds(Ne),console.log("🗑️ تم تحميل المعاملات المحذوفة من Firebase:",Ne.length);else{const tt=localStorage.getItem(fa());if(tt)try{const Oe=JSON.parse(tt);Ds(Oe),console.log("🗑️ تم تحميل المعاملات المحذوفة من localStorage:",Oe.length)}catch(Oe){console.error("خطأ في قراءة المعاملات المحذوفة من localStorage:",Oe)}}}catch(Ne){console.error("خطأ في تحميل المعاملات المحذوفة من Firebase:",Ne);const tt=localStorage.getItem(fa());if(tt)try{const Oe=JSON.parse(tt);Ds(Oe),console.log("🗑️ تم تحميل المعاملات المحذوفة من localStorage (fallback):",Oe.length)}catch(Oe){console.error("خطأ في قراءة المعاملات المحذوفة من localStorage:",Oe)}}}else{console.log("⚠️ لا توجد بيانات مستخدم في Firebase، محاولة استعادة من localStorage");const P=localStorage.getItem(Xe());if(P)try{const T=JSON.parse(P);console.log("📱 استعادة أرصدة المحافظ من localStorage:",T),Je(T)}catch(T){console.error("خطأ في قراءة أرصدة المحافظ من localStorage:",T)}let Y=localStorage.getItem(et());if(!Y&&(t!=null&&t.uid)){const T=`userCashBalance_${t.uid}`,q=localStorage.getItem(T);if(q){Y=q;try{localStorage.setItem(et(),q),localStorage.removeItem(T)}catch{}}}Y&&(lt(parseFloat(Y)),console.log("💰 استعادة رصيد الدرج النقدي من localStorage:",Y));try{const T=t!=null&&t.uid?await ir.getDeletedTransactionsByUser(t.uid):[];if(T&&T.length>0)Ds(T),console.log("🗑️ تم تحميل المعاملات المحذوفة من Firebase:",T.length);else{const q=localStorage.getItem(fa());if(q)try{const Ue=JSON.parse(q);Ds(Ue),console.log("🗑️ تم تحميل المعاملات المحذوفة من localStorage:",Ue.length)}catch(Ue){console.error("خطأ في قراءة المعاملات المحذوفة من localStorage:",Ue)}}}catch(T){console.error("خطأ في تحميل المعاملات المحذوفة من Firebase:",T);const q=localStorage.getItem(fa());if(q)try{const Ue=JSON.parse(q);Ds(Ue),console.log("🗑️ تم تحميل المعاملات المحذوفة من localStorage (fallback):",Ue.length)}catch(Ue){console.error("خطأ في قراءة المعاملات المحذوفة من localStorage:",Ue)}}}}console.log("🔄 بدء تحميل المحافظ من Firebase...");try{const w=await js.getByMerchantId((t==null?void 0:t.uid)||"");if(w&&w.length>0){console.log("✅ تم العثور على محافظ في Firebase:",w.length);const P=w.map(q=>({id:q.id,name:q.label||"محفظة بدون اسم",phone:q.msisdn,isDefault:!1,monthlyWithdrawalLimit:q.monthlyWithdrawalLimit??q.withdrawLimit??2e5,monthlyTransferLimit:q.monthlyTransferLimit??q.transferLimit??2e5,defaultTransferCommission:q.defaultTransferCommission!=null?Number(q.defaultTransferCommission):null,defaultWithdrawCommission:q.defaultWithdrawCommission!=null?Number(q.defaultWithdrawCommission):null}));rs(P),localStorage.setItem(Ys(),JSON.stringify(P));const Y=localStorage.getItem(Ts());let T=null;Y&&P.find(q=>q.id===Y)?T=P.find(q=>q.id===Y):T=P[0],T&&(oa(T.id),$t(T.phone)),console.log("🔄 تم تحديث المحافظ من Firebase وحفظها في localStorage")}else{console.log("⚠️ لا توجد محافظ في Firebase، محاولة التحميل من localStorage...");const P=Gr();if(P&&P.length>0)try{console.log("📱 تم العثور على محافظ محلية بعد الهجرة:",P.length),rs(P);const Y=Qr(P)||localStorage.getItem(Ts());let T=null;Y&&P.find(q=>q.id===Y)?T=P.find(q=>q.id===Y):T=P.find(q=>q.isDefault)||P[0],T&&(oa(T.id),$t(T.phone))}catch(Y){console.error("خطأ في معالجة المحافظ بعد الهجرة:",Y)}else console.log("⚠️ لا توجد محافظ محلية، لن نقوم بإنشاء محافظ افتراضية."),rs([])}}catch(w){console.error("خطأ في تحميل المحافظ من Firebase:",w);const P=Gr();if(P&&P.length>0)try{console.log("📱 استخدام المحافظ من localStorage بعد الهجرة:",P.length),rs(P);const Y=Qr(P)||localStorage.getItem(Ts());let T=null;Y&&P.find(q=>q.id===Y)?T=P.find(q=>q.id===Y):T=P.find(q=>q.isDefault)||P[0],T&&(oa(T.id),$t(T.phone))}catch(Y){console.error("خطأ في قراءة المحافظ من localStorage بعد الهجرة:",Y),rs([])}else console.log("⚠️ لا توجد محافظ محلية، لن يتم إنشاء محافظ افتراضية"),rs([])}const I=t!=null&&t.uid?await we.getUserTransactions(t.uid):[];if(I&&I.length>0){console.log("📊 تم تحميل المعاملات من Firebase:",I.length);const w=I.map(T=>({...T,createdAt:new Date(T.createdAt),senderPhone:T.senderMsisdn||T.senderPhone||"",receiverPhone:T.receiverMsisdn||T.receiverPhone||"",type:T.txnType==="send"?"send":T.txnType==="receive"?"withdraw":T.type||"withdraw",status:T.status==="confirmed"?"completed":T.status||"completed"})),P=Ln.map(T=>T.id||T.originalTransactionId),Y=w.filter(T=>!P.includes(T.id));console.log("✅ تم فلترة المعاملات المحذوفة:",{total:I.length,deleted:P.length,active:Y.length}),fs(Y)}await Nl()}catch(i){console.error("خطأ في تحميل بيانات المستخدم من Firebase:",i);let c=localStorage.getItem(et());if(!c&&(t!=null&&t.uid)){const f=`userCashBalance_${t.uid}`,N=localStorage.getItem(f);if(N){c=N;try{localStorage.setItem(et(),N),localStorage.removeItem(f)}catch{}}}c&&lt(parseFloat(c));const g=localStorage.getItem(Xe());if(g)try{const f=JSON.parse(g);Je(f),console.log("📱 تم استعادة أرصدة المحافظ من localStorage:",f)}catch(f){console.error("خطأ في قراءة أرصدة المحافظ من localStorage:",f)}}})().then(async()=>{await a(),await n()});const a=async()=>{try{for(const i of ye)await _c.autoResetLimitsIfNeeded(i.phone)}catch(i){console.error("خطأ في التصفير التلقائي للحدود:",i)}},n=async()=>{try{const i=Yt.getReportsData(t==null?void 0:t.uid);if((i.lastDailyResetDate?Yt.shouldResetDailyReports(i.lastDailyResetDate):!1)&&(t!=null&&t.uid)&&i.lastDailyResetDate){const f=new Date(i.lastDailyResetDate),N=f.toDateString();let E=ot.filter(Ne=>new Date(Ne.createdAt).toDateString()===N&&Ne.status==="completed");const I=Yt.filterVisibleTransactions(E,"daily",t==null?void 0:t.uid),w=I.length,P=I.reduce((Ne,tt)=>Ne+tt.amount,0),Y=I.filter(ya).reduce((Ne,tt)=>{const Oe=tt.withdrawnAmount!==void 0?tt.withdrawnAmount:tt.amount;return Ne+Oe},0),T=I.filter(ba).reduce((Ne,tt)=>{const Oe=tt.sentAmount!==void 0?tt.sentAmount:tt.amount;return Ne+Oe},0),q=I.reduce((Ne,tt)=>Ne+Yt.calculateTransactionProfit(tt),0),Ue=new Date(f).toISOString().slice(0,10);await Ql.add({userId:t.uid,reportDate:Ue,totalTransactions:w,totalAmount:Number(P.toFixed(2)),totalWithdrawn:Number(Y.toFixed(2)),totalSent:Number(T.toFixed(2)),profit:Number(q.toFixed(2)),walletId:null}),l({title:"تم أرشفة تقارير اليوم",description:Ue})}const g=Yt.autoResetReportsIfNeeded(t==null?void 0:t.uid);(g.dailyReset||g.monthlyReset)&&console.log("تم التصفير التلقائي:",g)}catch(i){console.error("خطأ في التصفير التلقائي للتقارير:",i)}};yo(),go(),Oo(),console.log("🔥 useEffect loadUserData completed")},[t==null?void 0:t.uid]);const ar=async()=>{var s;if(t!=null&&t.uid)try{const a=await js.getByMerchantId(t.uid);if(a&&a.length>0){const n=a.map(i=>({id:i.id,name:i.label||"محفظة بدون اسم",phone:i.msisdn,isDefault:!1,monthlyWithdrawalLimit:i.monthlyWithdrawalLimit??i.withdrawLimit??2e5,monthlyTransferLimit:i.monthlyTransferLimit??i.transferLimit??2e5,defaultTransferCommission:i.defaultTransferCommission!=null?Number(i.defaultTransferCommission):void 0,defaultWithdrawCommission:i.defaultWithdrawCommission!=null?Number(i.defaultWithdrawCommission):void 0}));if(rs(n),localStorage.setItem(Ys(),JSON.stringify(n)),t!=null&&t.uid){const i=localStorage.getItem(Ts());if(!!(G&&n.find(g=>g.id===G)))console.log("🔒 Preserving current wallet selection:",G);else{const f=(i&&n.find(N=>N.id===i)?i:null)||((s=n[0])==null?void 0:s.id);f&&(console.log("🔄 Fixing invalid wallet selection:",f),va(f))}}console.log("🔄 تم تحديث المحافظ من Firebase:",n.length)}}catch(a){console.error("خطأ في تحميل المحافظ من Firebase:",a)}};r.useEffect(()=>{const s=m.pathname;sessionStorage.getItem("previousPath")==="/user/add-wallet"&&s==="/user/dashboard"&&(console.log("🔄 Returning from add wallet page - reloading wallets"),console.log("🔒 Current wallet before add-wallet return reload:",G),ar(),sessionStorage.removeItem("previousPath")),sessionStorage.setItem("previousPath",s)},[m.pathname,t==null?void 0:t.uid]),r.useEffect(()=>{const s=()=>{console.log("🔄 Window focused - reloading wallets"),console.log("🔒 Current wallet before focus reload:",G),ar().then(()=>{console.log("🔒 Wallet preserved after focus reload:",G)})};return window.addEventListener("focus",s),()=>{window.removeEventListener("focus",s)}},[t==null?void 0:t.uid,G,ye]);const va=(s,a="unknown")=>{console.log(`🎯 setWalletSelection called from ${a} with walletId:`,s),console.log("🔍 Previous selectedWallet:",G),oa(s);const n=ye.find(i=>i.id===s);n&&($t(n.phone),console.log("✅ Wallet set successfully:",s,"Phone:",n.phone)),t!=null&&t.uid&&(localStorage.setItem(Ts(),s),console.log("💾 Saved wallet to localStorage:",s))},Vo=s=>{if(s==="__add_wallet"){x("/user/add-wallet");return}if(s==="__view_wallets"){zt(!0);return}va(s,"handleWalletChange")},rr=s=>{console.log("🔄 handleTransactionTypeChange called with type:",s),console.log("🔍 Current selectedWallet before change:",G),console.log("🔍 Available wallets count:",ye.length),On(s),Ks(""),Ss(""),vr(""),yr(""),console.log("✅ Transaction type changed to:",s,"- Wallet selection preserved:",G),setTimeout(()=>{const a=document.getElementById("transaction-section");a&&a.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})},100)};r.useEffect(()=>{const s=a=>{const n=a.target;if(!!n&&(n.tagName==="INPUT"||n.tagName==="TEXTAREA"||n.tagName==="SELECT"||n.isContentEditable)||(a.key==="ArrowLeft"?(a.preventDefault(),rr("withdraw")):a.key==="ArrowRight"&&(a.preventDefault(),rr("transfer"))),a.key==="Enter"){const c=se==="transfer"?"transferSubmitButton":"withdrawSubmitButton",g=document.getElementById(c);g&&!g.disabled&&(a.preventDefault(),g.click())}};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[se]);const qo=s=>{_i((n=>({id:n.id,type:n.type==="send"?"transfer":"withdraw",sender_msisdn:n.senderPhone,receiver_msisdn:n.receiverPhone,amount:n.amount,commission:n.commission||0,fee:(n==null?void 0:n.fee)??0,status:n.status==="failed"?"failed":n.status==="completed"?"completed":"pending",createdAt:new Date(n.createdAt).toISOString(),updatedAt:new Date(n.createdAt).toISOString(),shopName:M??(A==null?void 0:A.shopName)??(t==null?void 0:t.displayName)??"المحل",cashierName:(n==null?void 0:n.cashierName)??null,commissionMode:(n==null?void 0:n.commissionMode)??(n.type==="send"||Ie?"add":"deduct"),totalCharged:(n==null?void 0:n.totalCharged)??(n.type==="send"?Number(n.amount||0)+Number(n.commission||0)+Number((n==null?void 0:n.fee)||0):Ie?Number(n.amount||0)+Number(n.commission||0):Number(n.amount||0))}))(s)),Pa(!0)},Yo=async s=>{if(!(t!=null&&t.uid)){l({title:"خطأ في المصادقة",description:"يجب تسجيل الدخول أولاً لحذف المعاملات",variant:"destructive"});return}const a=ot.find(n=>n.id===s);if(!a){l({title:"خطأ في الحذف",description:"لم يتم العثور على المعاملة المطلوب حذفها",variant:"destructive"});return}try{console.log("🗑️ بدء عملية حذف المعاملة:",s),console.log("🔄 حذف المعاملة نهائياً من Firebase...",{transactionId:a.id,userId:t.uid,transactionData:a}),await we.removeUserTransaction(t.uid,a.id),console.log("✅ تم حذف المعاملة نهائياً من Firebase userTransactions");try{await ir.saveDeletedTransaction({...a,userId:t.uid,originalTransactionId:a.id,deletedAt:new Date().toISOString()}),console.log("✅ تم حفظ المعاملة في سجل المحذوفات مع تاريخ الحذف")}catch(c){console.warn("⚠️ فشل في حفظ المعاملة في سجل المحذوفات، لكن الحذف من Firebase نجح:",c)}const n=[...Ln,a],i=ot.filter(c=>c.id!==s);Ds(n),fs(i),En(!1),localStorage.setItem(fa(),JSON.stringify(n)),localStorage.setItem(ga(),JSON.stringify(i)),console.log("✅ تم تحديث البيانات المحلية بنجاح بعد الحذف من Firebase");try{let c=localStorage.getItem(et());if(!c&&(t!=null&&t.uid)){const E=`userCashBalance_${t.uid}`,I=localStorage.getItem(E);if(I){c=I;try{localStorage.setItem(et(),I),localStorage.removeItem(E)}catch{}}}const g=localStorage.getItem(Xe());let f=c?parseFloat(c):0,N=g?JSON.parse(g):{};if(a.type==="send"){const E=a.commission||0;f-=E;const I=a.fromWallet||Object.keys(N)[0];if(I){const w=N[I]||0;N[I]=w+a.amount}}else if(a.type==="withdraw"){const E=a.commission||0;f+=a.amount,f-=E;const I=a.fromWallet||Object.keys(N)[0];if(I){const w=N[I]||0;N[I]=Math.max(0,w-a.amount)}}localStorage.setItem(et(),f.toString()),localStorage.setItem(Xe(),JSON.stringify(N))}catch(c){console.warn("فشل عكس تأثير الأرصدة محليًا بعد الحذف:",c)}try{const c=a.fromWallet;if(c){const{walletDailyLimitsService:g}=await bs(async()=>{const{walletDailyLimitsService:N}=await import("./walletDailyLimitsService-DfpiIhi1.js");return{walletDailyLimitsService:N}},__vite__mapDeps([2,0,1])),f=await g.getWalletLimits(c);if(f){const N=a.type==="send",E={updatedAt:(await bs(async()=>{const{serverTimestamp:T}=await import("./index-4FXqbJ0i.js").then(q=>q.b0);return{serverTimestamp:T}},__vite__mapDeps([0,1]))).serverTimestamp()};N?(E.dailyTransferUsed=Math.max(0,(f.dailyTransferUsed||0)-a.amount),E.monthlyTransferUsed=Math.max(0,(f.monthlyTransferUsed||0)-a.amount)):(E.dailyWithdrawUsed=Math.max(0,(f.dailyWithdrawUsed||0)-a.amount),E.monthlyWithdrawUsed=Math.max(0,(f.monthlyWithdrawUsed||0)-a.amount));const{doc:I,setDoc:w}=await bs(async()=>{const{doc:T,setDoc:q}=await import("./index-4FXqbJ0i.js").then(Ue=>Ue.b0);return{doc:T,setDoc:q}},__vite__mapDeps([0,1])),{db:P}=await bs(async()=>{const{db:T}=await import("./index-4FXqbJ0i.js").then(q=>q.b1);return{db:T}},__vite__mapDeps([0,1])),Y=I(P,"walletLimits",c);await w(Y,E,{merge:!0})}}}catch(c){console.warn("فشل استرجاع حدود المحفظة بعد الحذف:",c)}try{const{ProfitService:c}=await bs(async()=>{const{ProfitService:I}=await import("./profitService-WOL_cZ8K.js");return{ProfitService:I}},__vite__mapDeps([3,4])),{ReportsService:g}=await bs(async()=>{const{ReportsService:I}=await import("./reportsService-Bp1Io21u.js");return{ReportsService:I}},[]),N={txnType:a.type==="send"?"send":"receive",amount:a.amount,commission:a.commission||0,createdAt:a.createdAt,status:"confirmed"},E=c.calculateProfitFromTransaction(N);E>0&&c.addProfit(-E,t.uid);try{g.removeTransactionEffects(a,t.uid)}catch{}}catch(c){console.warn("فشل تحديث الأرباح/التقارير بعد الحذف:",c)}l({title:"تم حذف المعاملة نهائياً",description:"تم حذف المعاملة نهائياً من النظام. يمكنك العثور عليها في قائمة المحذوفات"})}catch(n){console.error("❌ خطأ في حذف المعاملة من Firebase:",n);let i="فشل في حذف المعاملة من الخادم. يرجى المحاولة مرة أخرى";n instanceof Error&&(n.message.includes("network")||n.message.includes("offline")?i="مشكلة في الاتصال بالإنترنت. تحقق من الاتصال وحاول مرة أخرى":n.message.includes("permission")||n.message.includes("unauthorized")?i="ليس لديك صلاحية لحذف هذه المعاملة":n.message.includes("not-found")&&(i="المعاملة غير موجودة أو تم حذفها مسبقاً")),l({title:"خطأ في الحذف",description:i,variant:"destructive"})}},ya=s=>{const a=s.type,n=s.txnType;return a==="withdraw"||a==="withdrawal"||a==="receive"||n==="receive"},ba=s=>{const a=s.type,n=s.txnType;return a==="send"||a==="transfer"||n==="send"},nr=(s,a)=>{const n=new Date().toDateString();let i=ot.filter(I=>new Date(I.createdAt).toDateString()===n&&I.status==="completed");ys&&ys.trim()!==""&&(i=i.filter(I=>I.senderPhone&&I.senderPhone.includes(ys)||I.receiverPhone&&I.receiverPhone.includes(ys)));const c=Yt.filterVisibleTransactions(i,"daily",t==null?void 0:t.uid),g=c.length,f=c.reduce((I,w)=>I+w.amount,0),N=c.filter(ya).reduce((I,w)=>{const P=w.withdrawnAmount!==void 0?w.withdrawnAmount:w.amount;return I+P},0),E=c.filter(ba).reduce((I,w)=>{const P=w.sentAmount!==void 0?w.sentAmount:w.amount;return I+P},0);return{totalTransactions:g,totalAmount:f,totalWithdrawn:N,totalSent:E}},ja=s=>{const a=new Date().getMonth(),n=new Date().getFullYear();let i=ot.filter(I=>{const w=new Date(I.createdAt);return w.getMonth()===a&&w.getFullYear()===n&&I.status==="completed"});ys&&ys.trim()!==""&&(i=i.filter(I=>I.senderPhone&&I.senderPhone.includes(ys)||I.receiverPhone&&I.receiverPhone.includes(ys)));const c=Yt.filterVisibleTransactions(i,"monthly",t==null?void 0:t.uid),g=c.length,f=c.reduce((I,w)=>I+w.amount,0),N=c.filter(ya).reduce((I,w)=>{const P=w.withdrawnAmount!==void 0?w.withdrawnAmount:w.amount;return I+P},0),E=c.filter(ba).reduce((I,w)=>{const P=w.sentAmount!==void 0?w.sentAmount:w.amount;return I+P},0);return{totalTransactions:g,totalAmount:f,totalWithdrawn:N,totalSent:E}},Tl=s=>{const a=new Date().getMonth(),n=new Date().getFullYear(),i=ot.filter(f=>{const N=new Date(f.createdAt);return N.getMonth()===a&&N.getFullYear()===n&&f.status==="completed"&&f.fromWallet===s}),c=i.filter(ya).reduce((f,N)=>{const E=N.withdrawnAmount||N.amount;return f+E},0),g=i.filter(ba).reduce((f,N)=>{const E=N.sentAmount||N.amount;return f+E},0);return{totalWithdrawn:c,totalTransferred:g}},Ho=s=>{const a=new Date,n=a.getDate(),i=a.getMonth(),c=a.getFullYear(),g=ot.filter(E=>{const I=new Date(E.createdAt);return I.getDate()===n&&I.getMonth()===i&&I.getFullYear()===c&&E.status==="completed"&&E.fromWallet===s}),f=g.filter(ya).reduce((E,I)=>{const w=I.withdrawnAmount||I.amount;return E+w},0),N=g.filter(ba).reduce((E,I)=>{const w=I.sentAmount||I.amount;return E+w},0);return{totalWithdrawn:f,totalTransferred:N}};ja(),r.useEffect(()=>{const s=localStorage.getItem(ga());if(s){const n=JSON.parse(s).map(i=>({...i,createdAt:new Date(i.createdAt)}));fs(n)}},[]),r.useEffect(()=>{ot.length>0&&localStorage.setItem(ga(),JSON.stringify(ot))},[ot]);const kl=async()=>{Kd(),console.log("🔄 بدء عملية التحويل/السحب"),console.log("📊 البيانات المدخلة:",{senderPhone:xt,receiverPhone:Pt,amount:jt,transactionType:se});const s=()=>{se==="transfer"?Vs(!0):da(!0)},a=()=>{se==="transfer"?Vs(!1):da(!1)};if(s(),!xt||!jt){console.log("❌ خطأ: بيانات ناقصة"),l({title:"خطأ في البيانات",description:"يرجى ملء جميع الحقول المطلوبة",variant:"destructive"}),a();return}if(se==="transfer"&&!Pt&&!j){console.log("❌ خطأ: رقم المستقبل مفقود"),l({title:"خطأ في البيانات",description:"يرجى إدخال رقم المستقبل",variant:"destructive"}),a();return}if(se==="transfer"&&!j&&!Vd(Pt)){l({title:"رقم المستقبل غير صالح",description:"اكتب رقم صحيح مكون من 11 رقم ويبدأ بـ 015 أو 010 أو 012 أو 011",variant:"destructive"}),a();return}const n=parseFloat(jt);if(console.log("💰 المبلغ المحول:",n),n<=0){console.log("❌ خطأ: مبلغ غير صحيح"),l({title:"خطأ في المبلغ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"}),a();return}if(Ae)try{const le=new Date,Ke=le.getFullYear(),Bt=String(le.getMonth()+1).padStart(2,"0"),ct=String(le.getDate()).padStart(2,"0"),os=`zeroPlanDailyConfirmCount:${(t==null?void 0:t.uid)||"default"}:${Ke}-${Bt}-${ct}`,Kt=localStorage.getItem(os);if((Kt&&parseInt(Kt,10)||0)>=10){l({title:"حد التأكيد اليومي",description:"باقة زيرو تسمح بـ 10 تأكيدات تحويل/سحب يومياً فقط.",variant:"destructive"}),a();return}}catch(le){console.warn("فشل قراءة عداد تأكيدات باقة زيرو من التخزين المحلي:",le)}const i=ye.find(le=>le.id===G);if(!i){l({title:"خطأ في المحفظة",description:"يرجى اختيار محفظة صحيحة",variant:"destructive"}),a();return}const c=Tl(G);if(console.log("📈 فحص الحدود الشهرية للمحفظة المختارة"),console.log("📊 الإحصائيات الشهرية للمحفظة:",{walletId:G,walletName:i.name,currentWithdrawn:c.totalWithdrawn,currentTransferred:c.totalTransferred,withdrawalLimit:i.monthlyWithdrawalLimit,transferLimit:i.monthlyTransferLimit}),se==="withdraw"){if(console.log("🏧 فحص حد السحب الشهري للمحفظة"),console.log(`💸 المسحوب حالياً من المحفظة: ${c.totalWithdrawn}, المبلغ الجديد: ${n}, الحد الأقصى: ${i.monthlyWithdrawalLimit}`),c.totalWithdrawn+n>i.monthlyWithdrawalLimit){console.log("❌ تجاوز حد السحب الشهري للمحفظة"),l({title:"تجاوز حد السحب الشهري",description:`لا يمكن سحب أكثر من ${i.monthlyWithdrawalLimit} جنيه شهرياً من محفظة ${i.name}`,variant:"destructive"}),a();return}}else if(console.log("💸 فحص حد التحويل الشهري للمحفظة"),console.log(`📤 المحول حالياً من المحفظة: ${c.totalTransferred}, المبلغ الجديد: ${n}, الحد الأقصى: ${i.monthlyTransferLimit}`),c.totalTransferred+n>i.monthlyTransferLimit){console.log("❌ تجاوز حد التحويل الشهري للمحفظة"),l({title:"تجاوز حد التحويل الشهري",description:`لا يمكن تحويل أكثر من ${i.monthlyTransferLimit} جنيه شهرياً من محفظة ${i.name}`,variant:"destructive"}),a();return}const g=(A==null?void 0:A.shopName)||(t==null?void 0:t.displayName)||"محل كاشي لينك",f={id:Date.now().toString(),type:se==="transfer"?"send":se==="deposit"?"deposit":"withdraw",senderPhone:xt,receiverPhone:se==="transfer"?Pt:xt,amount:n,status:"completed",createdAt:new Date,withdrawnAmount:se==="withdraw"?n:void 0,sentAmount:se==="transfer"?n:void 0,depositedAmount:void 0,fromWallet:G,senderNumber:xt,senderName:xt,shopName:(i==null?void 0:i.name)||"المحفظة الرئيسية",transferredAmount:se==="transfer"?n:void 0,receiverNumber:se==="transfer"?Pt:void 0,withdrawnAmountDetailed:se==="withdraw"?n:void 0,depositedAmountDetailed:void 0,merchantShopName:g,transactionReference:`TXN-${Date.now()}`,commission:0,notes:se==="transfer"?`تحويل من ${xt} إلى ${Pt}`:`سحب نقدي من محفظة ${xt}`};S&&(b!=null&&b.name||b!=null&&b.username)&&(f.cashierName=(b==null?void 0:b.name)||(b==null?void 0:b.username));const N=Xs.validateTransaction(n,se,ze,ve);if(!N.isValid){l({title:"خطأ في العملية",description:N.error,variant:"destructive"}),a();return}N.warning&&l({title:"تحذير",description:N.warning,variant:"destructive"});let E;if(se==="transfer")if((i==null?void 0:i.defaultTransferCommission)!=null){const le=Number(i.defaultTransferCommission)||0;E=Math.round(le*n/1e3*100)/100}else It&&It.trim()!==""?E=Math.max(0,parseFloat(It)):E=0;else if((i==null?void 0:i.defaultWithdrawCommission)!=null){const le=Number(i.defaultWithdrawCommission)||0;E=Math.round(le*n/1e3*100)/100}else Ct&&Ct.trim()!==""?E=Math.max(0,parseFloat(Ct)):E=Math.round(n*.01*100)/100;if(f.commission=E,se!=="transfer"&&!Ie&&E>=n){l({title:"خطأ في العمولة",description:"العمولة أكبر من أو تساوي المبلغ المدخل",variant:"destructive"}),a();return}const I=se==="transfer"||Ie?n:Math.round((n-E)*100)/100;f.amount=I,f.withdrawnAmount=se==="withdraw"?I:void 0,f.sentAmount=se==="transfer"?I:void 0,f.transferredAmount=se==="transfer"?I:void 0,f.withdrawnAmountDetailed=se==="withdraw"?I:void 0;let w;const P=se==="transfer"&&!!Dt,Y=se==="withdraw"&&!!Dt,T=P||Y;let q=null;const Ue=Aa(xt||"").replace(/\D/g,""),Ne=Aa(Pt||"").replace(/\D/g,""),tt=se==="transfer"&&(Ue.startsWith("010")&&(Ne.startsWith("011")||Ne.startsWith("012")||Ne.startsWith("015"))||Ue.startsWith("012")&&Ne.startsWith("010")||Ue.startsWith("011")&&Ne.startsWith("010")||Ue.startsWith("015")&&Ne.startsWith("010")),Oe=tt?Math.max(0,parseFloat(Pn||"0")):0,mn=Math.round(E*100)/100;if(f.commission=mn,tt&&!T&&Oe<=0){l({title:"خطأ",description:"أدخل رسوم التحويل لعمليات 010 → 011/012/015 أو 012 → 010 أو 011 → 010 أو 015 → 010",variant:"destructive"}),a();return}if(se==="transfer"&&!T){const le=Number(ve[G]||0),Ke=Number(I)+Number(Oe);if(le<Ke){l({title:"رصيد المحفظة غير كافٍ",description:`الرصيد الحالي ${le} لا يكفي لخصم ${Ke}`,variant:"destructive"}),a();return}}if(T)if(P){const le=Xs.validateTransaction(I,"transfer",ze,ve);le.isValid?w={success:!0,newCashBalance:ze,newWalletBalances:ve}:w={success:!1,newCashBalance:ze,newWalletBalances:ve,message:le.error||"رصيد غير كافٍ للتحويل المؤجل",error:"INSUFFICIENT_WALLET_BALANCE"}}else w={success:!0,newCashBalance:ze,newWalletBalances:ve};else se==="transfer"?w=await Xs.processTransfer({amount:I,currentCashBalance:ze,currentWalletBalances:ve,wallets:ye,selectedWalletId:G,skipRemoteLimitsCheck:!0,nonBlockingUsageUpdate:!0}):w=await Xs.processWithdraw({amount:I,currentCashBalance:ze,currentWalletBalances:ve,wallets:ye,selectedWalletId:G,skipRemoteLimitsCheck:!0,nonBlockingUsageUpdate:!0});if(!w.success){l({title:"فشل في العملية",description:w.error||w.message,variant:"destructive"}),a();return}let Hs=T?ze:w.newCashBalance,is=T?ve:w.newWalletBalances;if(!T&&se==="transfer"&&Oe>0){const le=Number(is[G]||0);is={...is,[G]:Math.round((le-Number(Oe))*100)/100}}if(T&&Y){const le=ye.find(ct=>ct.id===G)??ye.find(ct=>ct.isDefault)??ye[0],Ke=(le==null?void 0:le.id)||G;if(Ke!==G)try{va(Ke)}catch{}const Bt=Number(ve[Ke]||0);is={...ve,[Ke]:Math.round((Bt+Number(I))*100)/100};try{const ct=`walletEffectsAppliedOnCreation_${(t==null?void 0:t.uid)||"default"}`,os=localStorage.getItem(ct),Kt=os?JSON.parse(os):[];f!=null&&f.id&&!Kt.includes(f.id)&&(Kt.push(f.id),localStorage.setItem(ct,JSON.stringify(Kt)))}catch{}}if(T&&P){const le=ye.find(ct=>ct.id===G)??ye.find(ct=>ct.isDefault)??ye[0],Ke=(le==null?void 0:le.id)||G;if(Ke!==G)try{va(Ke)}catch{}const Bt=Number(ve[Ke]||0);is={...ve,[Ke]:Math.round((Bt-Number(I)-Number(Oe))*100)/100}}if((P||Y)&&Dt&&!An){const le={id:`DEBT-${Date.now()}`,debtorName:Dt.debtorName,amount:Dt.amount,reason:Dt.notes||"",customerId:Dt.customerId,mobile:Dt.mobile,status:"pending",createdAt:new Date};q=le.id;const Ke=[le,...St];Jt(Ke);try{await ls(Ke)}catch(Bt){console.error("⚠️ فشل حفظ الدين المؤجل محلياً:",Bt)}l({title:"تم إضافة الدين",description:"أضيف إلى إيصالات الديون حتى يتم السداد",variant:"default"})}if(!T){const le=Math.max(0,Number(E))+Math.max(0,Number(Oe));le>0&&(Hs=Math.round((Hs+le)*100)/100,console.log(`💰 تم إضافة عمولة/رسوم ${le} جنيه لدرج النقدية`))}if(console.log("⚡ تحديث الواجهة فوراً..."),lt(Hs),Je(is),T&&(f.status="pending"),fs(le=>[f,...le]),Ae)try{const le=new Date,Ke=le.getFullYear(),Bt=String(le.getMonth()+1).padStart(2,"0"),ct=String(le.getDate()).padStart(2,"0"),os=`zeroPlanDailyConfirmCount:${(t==null?void 0:t.uid)||"default"}:${Ke}-${Bt}-${ct}`,Kt=localStorage.getItem(os),lr=Kt&&parseInt(Kt,10)||0;localStorage.setItem(os,String(lr+1))}catch{}if(localStorage.setItem(et(),Hs.toString()),localStorage.setItem(Xe(),JSON.stringify(is)),(async()=>{try{console.log("🔄 بدء حفظ المعاملة في Firebase في الخلفية...");const le={shopId:(A==null?void 0:A.shopId)||(t==null?void 0:t.uid)||"default-shop",lineId:G||"default-line",merchantUserId:(t==null?void 0:t.uid)||null,provider:"vodafone_cash",txnType:se==="transfer"?"send":"receive",amount:I,commission:mn,fee:Oe,profit:0,senderMsisdn:xt,receiverMsisdn:se==="transfer"?Pt:xt,note:se==="transfer"?`تحويل من ${xt} إلى ${Pt}`:`سحب ${I} جنيه من ${(i==null?void 0:i.name)||"المحفظة الرئيسية"}`,status:T?"pending":"confirmed",linkedDebtId:q||void 0,createdBy:(t==null?void 0:t.uid)||null,walletEffectAppliedOnCreation:!!(T&&Y)},Ke={...le,status:T?"pending":"completed",commissionMode:se==="transfer"||Ie?"add":"deduct",totalCharged:se==="transfer"?I+mn+Oe:Ie?I+E:I,walletEffectAppliedOnCreation:!!(T&&Y),createdAt:new Date},{ProfitService:Bt}=await bs(async()=>{const{ProfitService:lr}=await import("./profitService-WOL_cZ8K.js");return{ProfitService:lr}},__vite__mapDeps([3,4])),ct=Bt.calculateProfitFromTransaction(Ke);ct>0&&(Bt.addProfit(ct,t==null?void 0:t.uid),console.log("✅ تم إضافة الربح:",ct,"جنيه")),await Promise.all([...t!=null&&t.uid?[we.updateUserData(t.uid,{cashBalance:Hs,walletBalances:is,lastUpdated:new Date().toISOString()})]:[],gr.create(le),...t!=null&&t.uid?[we.saveUserTransaction(t.uid,{...Ke,transactionType:se,fromWallet:G,toWallet:se==="transfer"?P?null:"cash":null,cashierName:S&&((b==null?void 0:b.name)||(b==null?void 0:b.username))||"الحساب الرئيسي",linkedDebtId:q||void 0,description:`${se==="transfer"?"تحويل":"سحب"} ${I} من ${G} ${se==="transfer"?P?"":"إلى الدرج النقدي":""} — عمولة: ${E} (${se==="transfer"||Ie?"مضافة":"مخصومة"})${Oe>0?` — رسوم: ${Oe}`:""}${T?" — دين مؤجل (قيد المراجعة)":""}`})]:[]]),console.log("✅ تم حفظ جميع البيانات في Firebase بنجاح");const os=`userData_${t==null?void 0:t.uid}`,Kt={cashBalance:Hs,walletBalances:is,lastUpdated:new Date().toISOString()};localStorage.setItem(os,JSON.stringify(Kt))}catch(le){console.error("❌ خطأ في حفظ المعاملة في Firebase (في الخلفية):",le),l({title:"تحذير",description:"تم تنفيذ العملية محلياً، لكن فشلت المزامنة مع الخادم. ستتم المحاولة مرة أخرى تلقائياً.",variant:"destructive"})}})(),se==="transfer"){Vs(!0);const le=Number(n)+Number(E)+Math.max(0,Number(Oe));Dr({type:"transfer",amount:Math.max(0,Math.round(le*100)/100)}),Fa(!0),setTimeout(()=>{Vs(!1)},2e3)}else{da(!0);const le=Ie?Number(n):Math.max(0,Math.round((Number(n)-Number(E))*100)/100);Dr({type:"withdraw",amount:Math.max(0,Math.round(le*100)/100)}),Fa(!0),setTimeout(()=>{da(!1)},2e3)}Ks(""),Ss(""),ia(null),me(""),Pe(""),_t(""),je(!1)},dn=mt.useMemo(()=>new Intl.DateTimeFormat("ar-EG"),[]),Go=mt.useMemo(()=>new Intl.DateTimeFormat("ar-EG",{hour:"2-digit",minute:"2-digit"}),[]),Qo=mt.useMemo(()=>{try{return St.reduce((s,a)=>{const n=Number(a.paidAmount||0),i=Math.max(0,Number(a.amount||0)-n);return s+i},0)}catch{return 0}},[St]),Al=mt.useMemo(()=>Dl().filter(a=>as==="all"?!0:as==="send"?a.type==="send":as==="receive"?a.type==="receive":as==="withdraw"?a.type==="withdraw":as!=="deleted"),[Dl,as]),Zo=()=>{if(Nr==="daily"){const s=Yt.resetReportsManually("daily",ot,t==null?void 0:t.uid);ca(!1),l({title:"تم تصفير المعاملات اليومية",description:`تم إخفاء ${s.length} معاملة من تقارير اليوم (الحدود لم تتأثر)`})}else{const s=Yt.resetReportsManually("monthly",ot,t==null?void 0:t.uid);ca(!1),l({title:"تم تصفير المعاملات الشهرية",description:`تم إخفاء ${s.length} معاملة من تقارير الشهر (الحدود لم تتأثر)`})}},Xo=()=>Nr==="daily"?"تصفير المعاملات اليومية":"تصفير المعاملات الشهرية",ec=()=>Nr==="daily"?"أدخل كلمة مرور تسجيل الدخول لتصفير جميع معاملات اليوم":"أدخل كلمة مرور تسجيل الدخول لتصفير جميع معاملات الشهر",tc=s=>{pl(s),Jr(!0)},sc=s=>{lt(s),localStorage.setItem(et(),s.toString()),sl(!1),l({title:"تم تحديث الرصيد النقدي",description:`تم تحديث الرصيد النقدي إلى ${s} جنيه`})},ac=async s=>{var f;if(!Tt){console.warn("لا يوجد معرف محفظة محدد لتعديل الرصيد");return}const a={...ve,[Tt]:s};Je(a);const n=new Date().toISOString(),i={walletBalances:a,lastUpdated:n},c=`userData_${t==null?void 0:t.uid}`;try{localStorage.setItem(c,JSON.stringify(i)),localStorage.setItem(Xe(),JSON.stringify(a)),localStorage.setItem(`walletBalances_backup_${n}`,JSON.stringify(a))}catch{}try{t!=null&&t.uid&&await we.updateUserData(t.uid,i)}catch(N){console.error("خطأ أثناء حفظ رصيد المحفظة في Firebase:",N)}al(!1);const g=((f=ye.find(N=>N.id===Tt))==null?void 0:f.name)||"المحفظة";l({title:"تم تحديث رصيد المحفظة",description:`تم تحديث رصيد ${g} إلى ${s.toLocaleString()} جنيه`})},rc=async s=>{var a;if(console.log("💰 بدء تحديث رصيد المحفظة"),console.log("📊 معرف المحفظة المحررة:",Tt),console.log("💵 المبلغ المضاف/المخصوم:",s),Tt){const n=ve[Tt]||0;console.log("💰 الرصيد الحالي:",n);const i=n+s;console.log("💰 الرصيد الجديد:",i);const c={...ve,[Tt]:i};console.log("📊 الأرصدة المحدثة:",c),Je(c);const g=new Date().toISOString(),f={walletBalances:c,lastUpdated:g},N=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(N,JSON.stringify(f)),localStorage.setItem(Xe(),JSON.stringify(c)),localStorage.setItem(`walletBalances_backup_${g}`,JSON.stringify(c));try{if(t!=null&&t.uid){console.log("🔄 حفظ البيانات في Firebase...");try{await we.updateUserData(t.uid,f),console.log("✅ تم حفظ الأرصدة في Firebase بنجاح"),setTimeout(()=>{localStorage.removeItem(N),console.log("🧹 تم حذف النسخة المحلية المؤقتة بعد دقيقة واحدة")},6e4)}catch(P){console.error("❌ فشل في حفظ البيانات في Firebase:",P),ge(!0)}}else console.log("⚠️ المستخدم غير مسجل دخول، حفظ في localStorage"),localStorage.setItem(Xe(),JSON.stringify(c));const E=((a=ye.find(P=>P.id===Tt))==null?void 0:a.name)||"المحفظة",I=s>0?"إضافة":"خصم",w=Math.abs(s);l({title:`تم ${I} مبلغ ${I==="إضافة"?"إلى":"من"} رصيد المحفظة`,description:`تم ${I} ${w} جنيه ${I==="إضافة"?"إلى":"من"} رصيد ${E}. الرصيد الجديد: ${i.toLocaleString()} جنيه`})}catch(E){if(console.error("❌ فشل في حفظ البيانات في Firebase:",E),localStorage.setItem(Xe(),JSON.stringify(c)),t!=null&&t.uid){const I=`userData_${t.uid}`,w={walletBalances:c,lastUpdated:new Date().toISOString()};localStorage.setItem(I,JSON.stringify(w)),ge(!0)}l({title:"تم حفظ البيانات محلياً",description:"تم حفظ التغييرات محلياً وسيتم مزامنتها مع الخادم لاحقاً",variant:"default"})}}else console.log("❌ لا يوجد معرف محفظة للتحرير");setTimeout(()=>{const i=Object.keys(localStorage).filter(c=>c.startsWith("walletBalances_backup_")).sort();i.length>5&&i.slice(0,i.length-5).forEach(g=>{localStorage.removeItem(g),console.log("🗑️ حذف النسخة الاحتياطية القديمة:",g)})},5e3),Jr(!1),pl("")};return console.log("🔥 UserDashboardPage - Render conditions:",{isCheckingActivation:O,isUserActive:_,showActivationModal:te}),!O&&!_?(console.log("🔥 UserDashboardPage - Showing activation modal"),e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center",children:e.jsx(_l,{isOpen:!0,onClose:()=>{}})})):O?(console.log("🔥 UserDashboardPage - Showing loading screen"),e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center",children:e.jsx("div",{className:"text-center",children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"w-3 h-3 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 animate-bounce",style:{animationDelay:"0ms"}}),e.jsx("span",{className:"w-3 h-3 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 animate-bounce",style:{animationDelay:"150ms"}}),e.jsx("span",{className:"w-3 h-3 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 animate-bounce",style:{animationDelay:"300ms"}})]})})})):(console.log("🔥 UserDashboardPage - Rendering main dashboard"),e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-gray-50 via-blue-50/30 to-indigo-50/20 px-2 sm:px-4 py-2 sm:py-4 relative overflow-hidden",children:[e.jsxs("div",{className:"absolute inset-0 overflow-hidden pointer-events-none",children:[e.jsx("div",{className:"absolute top-10 sm:top-20 left-2 sm:left-10 w-32 sm:w-72 h-32 sm:h-72 bg-blue-400/8 rounded-full blur-3xl"}),e.jsx("div",{className:"absolute bottom-10 sm:bottom-20 right-2 sm:right-10 w-40 sm:w-96 h-40 sm:h-96 bg-purple-400/8 rounded-full blur-3xl",style:{animationDelay:"2s"}}),e.jsx("div",{className:"absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-36 sm:w-80 h-36 sm:h-80 bg-indigo-400/5 rounded-full blur-3xl",style:{animationDelay:"4s"}})]}),e.jsxs("div",{className:"max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-3 sm:gap-6 relative z-10",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-2 sm:space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 sm:grid-cols-2 sm:gap-3 fade-in-up",children:[!ma&&e.jsxs(Ve,{className:"bg-gradient-to-br from-purple-50 via-purple-25 to-white border border-purple-200/60 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 group relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-purple-500/5 to-purple-600/3 opacity-0 group-hover:opacity-100 transition-opacity duration-300"}),e.jsx("div",{className:"absolute top-0 right-0 w-20 sm:w-32 h-20 sm:h-32 bg-gradient-to-br from-purple-300/15 to-transparent rounded-full -translate-y-8 sm:-translate-y-16 translate-x-8 sm:translate-x-16 group-hover:scale-110 transition-transform duration-300"}),e.jsx(ht,{className:"pb-2 sm:pb-1 lg:pb-1 px-3 sm:px-3 lg:px-2 pt-3 sm:pt-2 lg:pt-1 relative z-10",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(At,{className:"text-xs font-bold text-purple-800 flex items-center gap-1.5 sm:gap-1",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"w-2.5 sm:w-2 h-2.5 sm:h-2 bg-gradient-to-r from-purple-500 to-purple-600 rounded-full shadow-sm"}),e.jsx("div",{className:"absolute inset-0 w-2.5 sm:w-2 h-2.5 sm:h-2 bg-purple-400 rounded-full opacity-60 animate-pulse"})]}),e.jsx("span",{className:"text-xs",children:"الشهر"})]}),e.jsxs("div",{className:"flex items-center gap-1 sm:gap-1",children:[e.jsx("div",{className:"hidden"}),e.jsx(d,{size:"sm",variant:"ghost",onClick:()=>{Bn("monthly"),ca(!0)},className:"h-7 w-7 sm:h-6 sm:w-6 p-0 bg-gradient-to-r from-purple-100 to-purple-200 text-purple-700 hover:from-purple-200 hover:to-purple-300 hover:text-purple-800 rounded-lg sm:rounded-md transition-all duration-300 hover:scale-105 shadow-sm hover:shadow-md",title:"تصفير معاملات الشهر",children:e.jsx(Wt,{className:"h-3 w-3 sm:h-2.5 sm:w-2.5"})}),e.jsx("div",{className:"p-1.5 sm:p-1 bg-gradient-to-r from-purple-100 to-purple-200 rounded-lg sm:rounded-md",children:e.jsx(Na,{className:"h-3 w-3 sm:h-2.5 sm:w-2.5 text-purple-600"})})]})]})}),!ma&&e.jsxs(He,{className:"space-y-0.5 sm:space-y-1 lg:space-y-0 pt-0 px-2 sm:px-3 lg:px-2 pb-1.5 sm:pb-2 lg:pb-1 relative z-10",children:[e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-purple-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-purple-700",children:"عدد المعاملات:"}),e.jsx("span",{className:"font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:ja().totalTransactions})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-purple-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-purple-700",children:"إجمالي المبالغ:"}),e.jsx("span",{className:"font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:ja().totalAmount.toFixed(2)})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-purple-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-purple-700",children:"المسحوب:"}),e.jsx("span",{className:"font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:ja().totalWithdrawn.toFixed(2)})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-purple-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-purple-700",children:"المرسل:"}),e.jsx("span",{className:"font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:ja().totalSent.toFixed(2)})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-purple-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-purple-700",children:"الأرباح:"}),e.jsx(Ed,{userId:t==null?void 0:t.uid,transactions:ot})]})]}),to&&e.jsx("div",{className:"absolute inset-0 z-20 bg-yellow-100/60 backdrop-blur-sm rounded-xl border border-yellow-300/70 flex items-center justify-center p-0 pointer-events-auto",children:e.jsxs(d,{size:"sm",variant:"ghost",onClick:async()=>{if(Ae){l({title:"غير متاح",description:"تقارير الشهر غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"});return}Ra(!0)},className:"px-2.5 py-1 rounded-full bg-gradient-to-r from-yellow-300 to-yellow-400 text-black hover:from-yellow-400 hover:to-yellow-500 shadow-md flex items-center gap-1 text-[11px] font-semibold",title:"عرض تقارير الشهر (يتطلب الرقم السري)",children:[e.jsx("span",{children:"عرض تقارير الشهر"}),e.jsx(st,{className:"h-2.5 w-2.5"})]})})]}),e.jsx(Bs,{open:ao,onOpenChange:Ra,mode:"verify",title:"الرقم السري لفتح تقارير الشهر",description:"لا يمكن الاطلاع على إحصائيات الشهر إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{if(Ae){l({title:"غير متاح",description:"تقارير الشهر غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}),Ra(!1),Jn(!0);return}Jn(!1),Ra(!1)},userId:t==null?void 0:t.uid}),e.jsxs(Ve,{className:"bg-gradient-to-br from-blue-50 via-blue-25 to-white border border-blue-200/60 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 group relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/5 to-blue-600/3 opacity-0 group-hover:opacity-100 transition-opacity duration-300"}),e.jsx("div",{className:"absolute top-0 right-0 w-20 sm:w-32 h-20 sm:h-32 bg-gradient-to-br from-blue-300/15 to-transparent rounded-full -translate-y-8 sm:-translate-y-16 translate-x-8 sm:translate-x-16 group-hover:scale-110 transition-transform duration-300"}),e.jsx(ht,{className:"pb-2 sm:pb-3 lg:pb-1 px-3 sm:px-4 lg:px-2 pt-3 sm:pt-4 lg:pt-1 relative z-10",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(At,{className:"text-sm sm:text-base font-bold text-blue-800 flex items-center gap-1.5 sm:gap-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"w-2.5 sm:w-3 h-2.5 sm:h-3 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full shadow-sm"}),e.jsx("div",{className:"absolute inset-0 w-2.5 sm:w-3 h-2.5 sm:h-3 bg-blue-400 rounded-full opacity-60 animate-pulse"})]}),e.jsx("span",{className:"text-xs sm:text-sm",children:"اليوم"})]}),e.jsxs("div",{className:"flex items-center gap-1 sm:gap-1.5",children:[e.jsx(d,{size:"sm",variant:"ghost",onClick:()=>{Bn("daily"),ca(!0)},className:"h-7 w-7 sm:h-8 sm:w-8 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded-lg transition-all duration-300 hover:scale-105 shadow-sm hover:shadow-md",title:"تصفير معاملات اليوم",children:e.jsx(Wt,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"})}),e.jsx(d,{size:"sm",variant:"ghost",onClick:()=>wr(!0),className:"h-7 w-7 sm:h-8 sm:w-8 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded-lg transition-all duration-300 hover:scale-105 shadow-sm hover:shadow-md",title:"أرشيف التقارير اليومية",children:e.jsx(Mc,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"})}),e.jsx(d,{size:"sm",variant:"ghost",onClick:()=>so(s=>!s),className:"h-7 w-7 sm:h-8 sm:w-8 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded-lg transition-all duration-300 hover:scale-105 shadow-sm hover:shadow-md",title:ma?"توسيع اليوم والشهر":"طي اليوم والشهر",children:ma?e.jsx(In,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"}):e.jsx(Xl,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"})}),e.jsx("div",{className:"p-1.5 sm:p-2 bg-gradient-to-r from-blue-100 to-blue-200 rounded-lg",children:e.jsx(Na,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5 text-blue-600"})})]})]})}),!ma&&e.jsxs(He,{className:"space-y-0 pt-0 px-2 pb-1 relative z-10",children:[e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-blue-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-blue-700",children:"عدد المعاملات:"}),e.jsx("span",{className:"font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:nr().totalTransactions})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-blue-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-blue-700",children:"إجمالي المبالغ:"}),e.jsx("span",{className:"font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:nr().totalAmount.toFixed(2)})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-blue-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-blue-700",children:"المسحوب:"}),e.jsx("span",{className:"font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:nr().totalWithdrawn.toFixed(2)})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-blue-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-blue-700",children:"المرسل:"}),e.jsx("span",{className:"font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:nr().totalSent.toFixed(2)})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-blue-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-blue-700",children:"الأرباح:"}),e.jsx(Ld,{userId:t==null?void 0:t.uid})]})]}),ro&&e.jsx("div",{className:"absolute inset-0 z-20 bg-yellow-100/60 backdrop-blur-sm rounded-xl border border-yellow-300/70 flex items-center justify-center p-0 pointer-events-auto",children:e.jsxs(d,{size:"sm",variant:"ghost",onClick:()=>Ir(!0),className:"px-2.5 py-1 rounded-full bg-gradient-to-r from-yellow-300 to-yellow-400 text-black hover:from-yellow-400 hover:to-yellow-500 shadow-md flex items-center gap-1 text-[11px] font-semibold",title:"عرض تقارير اليوم (يتطلب الرقم السري)",children:[e.jsx("span",{children:"عرض تقارير اليوم"}),e.jsx(st,{className:"h-2.5 w-2.5"})]})})]}),e.jsx(Bs,{open:no,onOpenChange:Ir,mode:"verify",title:"الرقم السري لفتح تقارير اليوم",description:"لا يمكن الاطلاع على تقارير اليوم إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{Kn(!1),Ir(!1)},userId:t==null?void 0:t.uid})]}),e.jsxs(Ve,{className:"bg-white border-2 border-gray-200/50 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 group relative overflow-hidden   transform fade-in-up mb-6",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-emerald-500/5 via-blue-500/5 to-emerald-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-200"}),e.jsx("div",{className:"absolute top-0 left-0 w-40 h-40 bg-gradient-to-br from-emerald-300/10 to-transparent rounded-full -translate-y-20 -translate-x-20 group-hover:scale-150 transition-transform duration-200"}),e.jsx("div",{className:"absolute bottom-0 right-0 w-40 h-40 bg-gradient-to-br from-blue-300/10 to-transparent rounded-full translate-y-20 translate-x-20 group-hover:scale-150 transition-transform duration-200"}),e.jsx(He,{className:"p-3 relative z-10",children:e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"bg-emerald-50 border-2 border-emerald-200/50 p-1 rounded-xl shadow-lg hover:shadow-md transition-all duration-200 group/cash relative overflow-hidden ",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-emerald-500/10 to-transparent opacity-0 group-hover/cash:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex items-center justify-between relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-emerald-100 to-emerald-200 rounded-lg shadow-sm",children:e.jsx(Ge,{className:"h-1.5 w-1.5 text-emerald-600"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] font-bold text-emerald-800",children:"الفلوس النقدية"}),e.jsxs("span",{className:"text-[10px] font-extrabold text-emerald-700 bg-gradient-to-r from-emerald-100 to-emerald-200 px-1 py-0.5 rounded-lg shadow-sm",children:[ze.toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(d,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-green-100 to-green-200 text-green-700 hover:from-green-200 hover:to-green-300 hover:text-green-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>Qa(!0),children:e.jsx(ft,{className:"h-2 w-2"})}),e.jsx(d,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800 rounded-xl transition-all duration-300  hover:rotate-12 shadow-md hover:shadow-lg",onClick:()=>sr(!0),children:e.jsx(Wt,{className:"h-2 w-2"})})]})]})]}),e.jsxs("div",{className:"bg-blue-50 border-2 border-blue-200/50 p-1 rounded-xl shadow-lg hover:shadow-md transition-all duration-200 group/wallet relative overflow-hidden ",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/10 to-transparent opacity-0 group-hover/wallet:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex items-center justify-between relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-blue-100 to-blue-200 rounded-lg shadow-sm",children:e.jsx(Qt,{className:"h-1.5 w-1.5 text-blue-600"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] font-bold text-blue-800",children:"الأرصدة علي المحافظ"}),e.jsxs("span",{className:"text-[10px] font-extrabold text-blue-700 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-lg shadow-sm",children:[Object.values(ve).reduce((s,a)=>s+a,0).toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(d,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-green-100 to-green-200 text-green-700 hover:from-green-200 hover:to-green-300 hover:text-green-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>Xa(!0),title:"إضافة أموال لإجمالي المحفظة",children:e.jsx(ft,{className:"h-2 w-2"})}),e.jsx(d,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800 rounded-xl transition-all duration-300  hover:rotate-12 shadow-md hover:shadow-lg",onClick:()=>{er(!0),tr("")},title:"تصفير إجمالي المحفظة",children:e.jsx(Wt,{className:"h-2 w-2"})})]})]})]}),e.jsxs("div",{className:"col-span-2 sm:col-span-1 bg-indigo-50 border-2 border-indigo-200/50 p-1 rounded-xl shadow-lg hover:shadow-md transition-all duration-200 group/selwallet relative overflow-hidden ",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-indigo-500/10 to-transparent opacity-0 group-hover/selwallet:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex items-center justify-between relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-indigo-100 to-indigo-200 rounded-lg shadow-sm",children:e.jsx(Qt,{className:"h-1.5 w-1.5 text-indigo-600"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] font-bold text-indigo-800",children:"رصيد المحفظه"}),e.jsxs("span",{className:"text-[10px] font-extrabold text-indigo-700 bg-gradient-to-r from-indigo-100 to-indigo-200 px-1 py-0.5 rounded-lg shadow-sm",children:[(G&&ve[G]||0).toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(d,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-green-100 to-green-200 text-green-700 hover:from-green-200 hover:to-green-300 hover:text-green-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>{if(!G){l({title:"اختر محفظة",description:"يرجى اختيار محفظة من اختيار المحافظ بالأعلى أولاً",variant:"destructive"});return}tc(G)},title:"إضافة/خصم إلى رصيد المحفظة المختارة",children:e.jsx(ft,{className:"h-2 w-2"})}),e.jsx(d,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800 rounded-xl transition-all duration-300  hover:rotate-12 shadow-md hover:shadow-lg",onClick:()=>{if(!G){l({title:"اختر محفظة",description:"يرجى اختيار محفظة لتصفير رصيدها فقط",variant:"destructive"});return}Ja(!0)},title:"تصفير رصيد المحفظة المختارة",children:e.jsx(Wt,{className:"h-2 w-2"})})]})]})]})]})})]}),e.jsxs(Ve,{className:"bg-gradient-to-br from-gray-50 via-white to-slate-50 border border-gray-200/60 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 group relative overflow-hidden fade-in-up",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-gray-500/5 to-slate-600/3 opacity-0 group-hover:opacity-100 transition-opacity duration-300"}),e.jsxs(ht,{className:"pb-2 px-4 pt-4 relative z-10",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(At,{className:"text-sm font-bold flex items-center gap-2 text-gray-800",children:[!U&&e.jsx("div",{className:"p-1.5 sm:p-2 bg-gradient-to-r from-gray-100 to-slate-200 rounded-lg",children:e.jsx(Na,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5 text-gray-600"})}),e.jsx("span",{className:"bg-gradient-to-r from-gray-600 to-slate-600 bg-clip-text text-transparent",children:"المعاملات الأخيرة"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[!U&&e.jsxs("div",{className:"flex items-center gap-0.5 bg-gray-50 rounded px-1 py-0.5 border border-gray-200 hover:border-blue-300 transition-all duration-200 group relative overflow-hidden max-w-[140px] md:max-w-[220px]",children:[e.jsx(Wc,{className:"h-2 w-2 text-gray-400 group-hover:text-blue-600 transition-colors"}),e.jsx(R,{placeholder:"بحث...",value:Rn,onChange:s=>Yi(s.target.value),className:"h-3 text-[8px] border-0 bg-transparent focus:ring-0 focus:outline-none text-gray-700 placeholder:text-gray-400"})]}),!U&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-green-600 mb-1",children:"شحن"}),e.jsx(d,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-green-50 text-green-600 hover:bg-green-100 border border-green-200 ring-3 ring-green-300 transition-all duration-200 hover:scale-105",onClick:()=>{l({title:"قيد التطوير",description:"هذه الميزة غير متاحة حالياً."})},title:"شحن الرصيد",children:e.jsx(Ia,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"حاسبة"}),e.jsx(d,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105",onClick:()=>Cr(!0),title:"آلة حاسبة",children:e.jsx(ni,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"كروت"}),e.jsx(d,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105",onClick:()=>{Ae?l({title:"غير متاح",description:"كروت الائتمان غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ba(!0)},title:"كروت الائتمان",children:e.jsx(Ia,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-blue-600 mb-1",children:"الوردية"}),e.jsx(d,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-blue-50 text-blue-600 hover:bg-blue-100 border border-blue-200 ring-3 ring-blue-300 transition-all duration-200 hover:scale-105",onClick:Wo,title:S&&(b!=null&&b.name||b!=null&&b.username)?`بروفيل الوردية: ${(b==null?void 0:b.name)||(b==null?void 0:b.username)}`:"وردية الكاشير",children:e.jsx(wn,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"المبيعات"}),e.jsx(d,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105",onClick:()=>{Ae?l({title:"غير متاح",description:"بيانات المبيعات غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ea(!0)},title:"بيانات المبيعات",children:e.jsx(Lc,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsxs("div",{className:"flex items-center gap-1 mb-1",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600",children:"الديون"}),St.filter(s=>s.status==="pending").length>0&&e.jsx("span",{className:"h-4 w-4 rounded-full bg-red-600 text-white text-[10px] flex items-center justify-center ring-2 ring-white",children:St.filter(s=>s.status==="pending").length})]}),e.jsx(d,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105",onClick:()=>{Ae?l({title:"غير متاح",description:"إدارة الديون/الأجل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):ha(!0)},title:"الديون",children:e.jsx(yc,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-amber-700 mb-1",children:"الصيانة"}),e.jsx(d,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-amber-50 text-amber-700 hover:bg-amber-100 border border-amber-200 ring-3 ring-amber-300 transition-all duration-200 hover:scale-105",onClick:()=>{Ae?l({title:"غير متاح",description:"الصيانة غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ma(!0)},title:"الصيانة",children:e.jsx(bc,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-yellow-500 mb-1",children:"المكنة"}),e.jsx(d,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-violet-50 text-violet-700 hover:bg-violet-100 border border-violet-200 ring-3 ring-violet-300 transition-all duration-200 hover:scale-105",onClick:()=>{qt?La(!0):l({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"})},title:"يومية المكنة",children:e.jsx(oi,{className:"h-5 w-5 text-yellow-500"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-orange-600 mb-1",children:"مصروفات"}),e.jsx(d,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-orange-50 text-orange-600 hover:bg-orange-100 border border-orange-200 ring-3 ring-orange-300 transition-all duration-200 hover:scale-105",onClick:()=>{Ae?l({title:"غير متاح",description:"مصروفات المحل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):ms.hasMasterPin()?H(!0):ae(!0)},title:"مصروفات المحل",children:e.jsx(hr,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-rose-600 mb-1",children:"النواقص"}),e.jsx(d,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-rose-50 text-rose-600 hover:bg-rose-100 border border-rose-200 ring-3 ring-rose-300 transition-all duration-200 hover:scale-105",onClick:()=>{Ae?l({title:"غير متاح",description:"النواقص غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Re(!0)},title:"النواقص",children:e.jsx(jc,{className:"h-5 w-5"})})]})]})]})]}),!U&&e.jsx("div",{className:"mt-2 w-full",children:e.jsxs("div",{className:"flex items-center justify-center gap-3 bg-gray-50 rounded-md p-3 border border-gray-200",children:[e.jsx(d,{variant:"ghost",size:"sm",className:`h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${as==="send"?"bg-green-600 text-white border-green-600":"text-green-700 border-green-300 hover:bg-green-50"}`,onClick:()=>jr("send"),title:"تصفية التحويل",children:"التحويل"}),e.jsx(d,{variant:"ghost",size:"sm",className:`h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${as==="withdraw"?"bg-red-600 text-white border-red-600":"text-red-700 border-red-300 hover:bg-red-50"}`,onClick:()=>jr("withdraw"),title:"تصفية السحب",children:"السحب"}),e.jsx(d,{variant:"ghost",size:"sm",className:`h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${as==="all"?"bg-green-600 text-white border-green-600":"text-green-700 border-green-300 hover:bg-green-50"}`,onClick:()=>jr("all"),title:"عرض الكل",children:"الكل"}),e.jsxs("div",{className:"relative ml-1",children:[e.jsxs(d,{variant:"ghost",size:"sm",className:"h-8 px-3 text-[12px] rounded-full border bg-red-50 text-red-700 border-red-300 hover:bg-red-100",onClick:()=>Vr(!0),title:"تصفير المعاملات الأخيرة",children:[e.jsx(Wt,{className:"h-3.5 w-3.5 mr-1"}),"تصفير"]}),(t==null?void 0:t.uid)&&localStorage.getItem(`recentTransactionsResetAt:${t.uid}`)&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 h-2 w-2 rounded-full bg-red-500 ring-2 ring-white"})]})]})})]}),e.jsx(He,{className:"space-y-2 pt-0 px-4 pb-4 relative z-10",children:Al.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(Na,{className:"h-12 w-12 mx-auto mb-2 text-gray-300"}),e.jsx("p",{className:"text-sm",children:"لا توجد معاملات حتى الآن"})]}):e.jsx("div",{className:"max-h-[210px] overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400 transition-colors",children:e.jsx("div",{className:"space-y-2 pr-2",children:Al.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gradient-to-r from-white/70 to-gray-50/70 rounded-lg hover:from-white/90 hover:to-gray-50/90 transition-all duration-300 border border-gray-100/60 cursor-pointer hover:shadow-sm",onClick:()=>qo(s),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[s.status==="completed"&&e.jsx(Ms,{className:"h-4 w-4 text-green-500"}),s.status==="pending"&&e.jsx(Ls,{className:"h-4 w-4 text-yellow-500"}),s.status==="failed"&&e.jsx(Tn,{className:"h-4 w-4 text-red-500"})]}),e.jsxs("div",{children:[(()=>{const a=(s==null?void 0:s.type)==="report"||((s==null?void 0:s.title)||"").includes("إيصال تسليم وردية");return e.jsx("p",{className:"font-medium text-sm text-gray-800",children:a?"إيصال تسليم وردية":(s.type==="send"?"تحويل":"سحب")+` - ${s.amount.toLocaleString()} جنيه`})})(),e.jsxs("p",{className:"text-[10px] text-gray-700",children:["تمت بواسطة: ",(s==null?void 0:s.cashierName)??"الحساب الرئيسي"]}),(()=>{const a=(s==null?void 0:s.type)==="report"||((s==null?void 0:s.title)||"").includes("إيصال تسليم وردية");return e.jsx("p",{className:"text-xs text-gray-500",children:a?`تم التسليم إلى: ${s.receiverPhone}`:`من ${s.senderPhone}${s.type==="send"?` إلى ${s.receiverPhone}`:""}`})})(),e.jsxs("p",{className:"text-xs text-gray-400",children:[dn.format(s.createdAt instanceof Date?s.createdAt:new Date(s.createdAt))," - ",Go.format(s.createdAt instanceof Date?s.createdAt:new Date(s.createdAt))]})]})]}),e.jsx(dt,{variant:s.status==="completed"?"default":s.status==="pending"?"secondary":"destructive",className:"text-xs",children:s.status==="completed"?"مكتمل":s.status==="pending"?"قيد المعالجة":"فشل"})]},s.id))})})})]})]}),e.jsx(Rc,{isOpen:$i,onClose:()=>Pa(!1),transaction:Ui,onPrint:()=>window.print(),onDelete:Vi,onComplete:qi}),e.jsx(ie,{open:rt,onOpenChange:Be,children:e.jsxs(oe,{children:[e.jsxs(ce,{children:[e.jsx(de,{children:"إبلاغ للإدمن"}),e.jsx(Mt,{children:"أرسل طلب أو شكوى وسيتم الرد عليك هنا."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-2 text-sm",children:[e.jsxs("div",{className:"text-gray-600",children:["الاسم: ",e.jsx("span",{className:"font-semibold text-gray-900",children:_e})]}),e.jsxs("div",{className:"text-gray-600",children:["الموبايل: ",e.jsx("span",{className:"font-semibold text-gray-900",children:D||"غير متوفر"})]}),e.jsxs("div",{className:"text-gray-600",children:["البريد: ",e.jsx("span",{className:"font-semibold text-gray-900",children:Q||"غير متوفر"})]})]}),nt.length>0&&e.jsx("div",{className:"rounded-md border border-gray-200 p-2 max-h-40 overflow-y-auto",children:nt.map(s=>e.jsxs("div",{className:"py-1 text-sm",children:[e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-gray-700",children:"رسالتك:"}),e.jsx("span",{className:"text-gray-900",children:s.message})]}),s.adminReply&&e.jsxs("div",{className:"mt-1 flex items-start gap-2",children:[e.jsx("span",{className:"text-blue-700",children:"رد الإدمن:"}),e.jsx("span",{className:"text-blue-900",children:s.adminReply})]})]},s.id))}),e.jsx(V,{htmlFor:"userReportMessage",children:"نص البلاغ"}),e.jsx("textarea",{id:"userReportMessage",className:"min-h-[100px] w-full rounded-md border border-gray-200 p-2 text-sm",value:p,onChange:s=>z(s.target.value),placeholder:"اكتب رسالتك..."})]}),e.jsxs(De,{children:[e.jsx(d,{variant:"outline",onClick:()=>Be(!1),children:"إلغاء"}),e.jsx(d,{disabled:ee||!p.trim(),onClick:ue,children:ee?"جارٍ الإرسال...":"إرسال"})]})]})}),e.jsxs("div",{className:"space-y-1 fade-in-right w-full lg:w-5/6 mx-auto",children:[e.jsxs(Ve,{id:"transaction-section",className:"bg-gradient-to-br from-white via-blue-50/30 to-indigo-50/50 border border-blue-200/40 rounded-lg shadow-lg hover:shadow-lg transition-all duration-200 group relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/5 via-indigo-500/3 to-purple-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-200"}),e.jsx("div",{className:"absolute top-0 right-0 w-32 h-32 sm:w-28 sm:h-28 lg:w-20 lg:h-20 bg-gradient-to-bl from-blue-400/10 to-transparent rounded-full  "}),e.jsx("div",{className:"absolute bottom-0 left-0 w-24 h-24 bg-gradient-to-tr from-indigo-400/10 to-transparent rounded-full  ",style:{animationDelay:"1s"}}),e.jsx(ht,{className:"sticky top-0 z-20 bg-white/80 backdrop-blur supports-[backdrop-filter]:bg-white/60 pb-0.5 px-3 pt-1 lg:pt-0.5 lg:pb-0.5 lg:px-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(At,{className:"text-sm font-bold flex items-center gap-2 text-gray-800",children:[e.jsxs("div",{className:"relative",children:[e.jsx(Ms,{className:"h-1 w-1 text-emerald-500 "}),e.jsx("div",{className:"absolute inset-0 h-1 w-1 bg-emerald-400 rounded-full opacity-20 "})]}),e.jsx("span",{className:"bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent",children:"إجراء معاملة جديدة"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[ts&&e.jsx("div",{className:"hidden md:flex items-center gap-1 bg-gradient-to-r from-emerald-50 to-green-50 hover:from-emerald-100 hover:to-green-100 border border-emerald-200 text-emerald-800 text-sm transition-all duration-300 hover:scale-105 h-9 px-3 rounded-xl shadow-sm",children:e.jsxs("span",{className:"text-sm font-semibold whitespace-nowrap",children:["تجربة: ",ws," ",ws>=3&&ws<=10?"ساعات":ws===2?"ساعتين":"ساعة"]})}),e.jsxs("div",{className:"hidden md:flex items-center gap-2 bg-gradient-to-r from-gray-50 to-slate-50 hover:from-gray-100 hover:to-slate-100 border border-gray-200 transition-all duration-300 hover:scale-105 h-9 px-3 rounded-xl shadow-sm",children:[e.jsxs(d,{variant:"ghost",className:"relative h-9 w-9 rounded-full p-0",onClick:()=>Be(!0),title:"إبلاغ/طلب دعم",children:[e.jsx(Nc,{className:"h-4 w-4 text-blue-600"}),ne>0&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-red-500 text-white rounded-full text-[10px] h-5 w-5 flex items-center justify-center",children:ne})]}),e.jsx(pd,{}),e.jsx(Jc,{})]})]}),Jo&&e.jsxs(d,{variant:"outline",size:"sm",className:"hidden flex items-center gap-1.5 sm:gap-2 bg-gradient-to-r from-cyan-50 to-blue-50 hover:from-cyan-100 hover:to-blue-100 border-cyan-200 text-cyan-800 text-xs sm:text-sm transition-all duration-300 hover:scale-105 hover:shadow-lg h-10 sm:h-12 px-4 sm:px-5 rounded-xl min-w-[44px] touch-manipulation",onClick:Nl,title:"مزامنة البيانات المحفوظة محلياً مع الخادم",children:[e.jsx(Xc,{className:"h-3.5 w-3.5 sm:h-4 sm:w-4 animate-spin"}),e.jsx("span",{className:"text-xs sm:text-sm font-semibold whitespace-nowrap",children:"مزامنة"})]})]})}),e.jsxs(He,{ref:h,className:"space-y-1 px-2 pb-2 relative z-10 transition-transform duration-200 ease-out will-change-transform",style:{transform:o?`translateY(${o}px)`:void 0},onFocusCapture:s=>{const a=s.target;if(!((a==null?void 0:a.id)==="transferExtraFeeInput")){u(0);return}const i=document.getElementById("transferSubmitButton");if(i){const c=i.getBoundingClientRect(),g=window.innerHeight;if(c.bottom>g){const f=c.bottom-g,N=Math.min(f,220);u(-N)}else u(0)}else u(0)},onBlurCapture:s=>{s.currentTarget.contains(s.relatedTarget)||u(0)},children:[e.jsxs("div",{className:"grid grid-cols-2 gap-0.5 p-0.5 bg-gradient-to-r from-gray-50 to-slate-50 rounded-xl border border-gray-200/50 fade-in-up w-full lg:w-5/6 mx-auto ",children:[e.jsxs(d,{variant:se==="transfer"?"default":"ghost",onClick:()=>rr("transfer"),className:`text-xs font-semibold transition-all duration-300 hover:scale-105 h-7 rounded-lg px-2 ${se==="transfer"?"bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg hover:shadow-md hover:from-blue-600 hover:to-indigo-700":"text-gray-600 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 hover:text-blue-700 hover:border-blue-200"}`,children:[e.jsx(Na,{className:"h-1 w-1 mr-1"}),"تحويل"]}),e.jsxs(d,{variant:se==="withdraw"?"default":"ghost",onClick:()=>rr("withdraw"),className:`text-xs font-semibold transition-all duration-300 hover:scale-105 h-7 rounded-lg px-2 ${se==="withdraw"?"bg-gradient-to-r from-emerald-500 to-green-600 text-white shadow-lg hover:shadow-md hover:from-emerald-600 hover:to-green-700":"text-gray-600 hover:bg-gradient-to-r hover:from-emerald-50 hover:to-green-50 hover:text-emerald-700 hover:border-emerald-200"}`,children:[e.jsx(xr,{className:"h-1 w-1 mr-1"}),"سحب"]})]}),e.jsxs("div",{className:"fade-in-up",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("label",{className:"text-sm font-semibold text-gray-700 block flex items-center gap-2",children:[e.jsx(Qt,{className:"h-1 w-1 text-blue-600"}),"اختيار المحفظة"]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsxs(d,{variant:"ghost",size:"sm",className:"h-6 rounded-md px-2 text-[10px] bg-emerald-50 text-emerald-700 hover:bg-emerald-100 border border-emerald-200",onClick:()=>x("/user/add-wallet"),title:"إضافة محفظة",children:[e.jsx(ft,{className:"h-3 w-3 mr-1"}),"إضافة محفظة"]}),e.jsxs(d,{variant:"ghost",size:"sm",className:"h-6 rounded-md px-2 text-[10px] bg-indigo-50 text-indigo-700 hover:bg-indigo-100 border border-indigo-200",onClick:()=>zt(!0),title:"المحافظ",children:[e.jsx(Qt,{className:"h-3 w-3 mr-1"}),"المحافظ"]})]})]}),ye.length>0?e.jsxs(ks,{value:G,onValueChange:Vo,children:[e.jsx(As,{"data-testid":"wallet-select",className:"w-full h-12 text-sm bg-gradient-to-r from-white to-gray-50 border-2 border-gray-200 hover:border-blue-400 focus:border-blue-500 rounded-xl transition-all duration-300 hover:shadow-md focus:shadow-lg",children:e.jsx(Ps,{placeholder:"اختر محفظة للمعاملة",className:"text-gray-600"})}),e.jsxs(Os,{className:"rounded-xl border-2 border-gray-200 shadow-md max-h-[220px] overflow-y-auto z-50 ",children:[e.jsx("div",{className:"sticky top-0 bg-white p-2 border-b border-gray-200",children:e.jsx(R,{value:Wn,onChange:s=>Mi(s.target.value),placeholder:"ابحث برقم المحفظة",className:"h-6 text-xs"})}),e.jsx("div",{className:"pr-1",children:Fn.length===0?e.jsx("div",{className:"text-xs text-gray-500 p-2",children:"لا توجد نتائج مطابقة"}):Fn.map(s=>e.jsx(Ht,{value:s.id,className:"rounded-lg hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 transition-all duration-200",children:e.jsxs("div",{className:"flex items-center gap-1 py-1 w-full justify-between",children:[e.jsx("div",{className:"p-1 bg-gradient-to-r from-blue-100 to-indigo-100 rounded-lg",children:e.jsx(Qt,{className:"h-1 w-1 text-blue-600"})}),e.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-sm font-medium text-gray-800",children:s.name}),e.jsxs("span",{className:"text-[10px] text-gray-500",children:["(",s.phone,")"]})]}),s.isDefault&&e.jsx(dt,{variant:"secondary",className:"text-[10px] bg-gradient-to-r from-emerald-100 to-green-100 text-emerald-700 border-emerald-200",children:"افتراضي"})]}),e.jsx("div",{className:"ml-auto flex flex-col items-end gap-1"})]})},s.id))})]})]}):e.jsx("div",{className:"rounded-xl border-2 border-dashed border-gray-200 bg-gray-50 px-3 py-3 text-xs text-gray-600",children:"لا توجد محافظ حتى الآن. اضغط “إضافة محفظة” لإضافة أول محفظة."})]}),e.jsx(ie,{open:$e,onOpenChange:zt,children:e.jsxs(oe,{className:"sm:max-w-3xl w-[95vw] sm:w-auto max-h-[80vh] overflow-y-auto",children:[e.jsx(ce,{children:e.jsx(de,{children:"عرض المحافظ"})}),e.jsx("div",{className:"mt-2",children:e.jsx(zc,{showAddButton:!1,showUsageBars:!1,showLimitCards:!1,showEditButton:!0})})]})}),G&&ye.length>0&&(()=>{const s=ye.find(Ne=>Ne.id===G),a=Tl(G),n=Ho(G),i=(Fe==null?void 0:Fe.monthlyWithdrawLimit)??(s==null?void 0:s.monthlyWithdrawalLimit)??2e5,c=(Fe==null?void 0:Fe.monthlyTransferLimit)??(s==null?void 0:s.monthlyTransferLimit)??2e5,g=a.totalWithdrawn??(Fe==null?void 0:Fe.monthlyWithdrawUsed)??0,f=a.totalTransferred??(Fe==null?void 0:Fe.monthlyTransferUsed)??0,N=(Fe==null?void 0:Fe.dailyWithdrawLimit)??1e5,E=(Fe==null?void 0:Fe.dailyTransferLimit)??6e4,I=n.totalWithdrawn??(Fe==null?void 0:Fe.dailyWithdrawUsed)??0,w=n.totalTransferred??(Fe==null?void 0:Fe.dailyTransferUsed)??0,P=parseFloat(jt||"0")||0,Y=g+(se==="withdraw"?P:0),T=f+(se==="transfer"?P:0),q=I+(se==="withdraw"?P:0),Ue=w+(se==="transfer"?P:0);return s?e.jsxs("div",{className:"fade-in-up mb-2 space-y-2",children:[e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-1 rounded-md border border-gray-200 shadow-sm hover:shadow-md transition-all duration-300",children:[e.jsxs("div",{className:"text-[10px] text-gray-600 font-medium mb-1 text-center",children:["الحدود الشهرية: ",s.name]}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-red-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-red-400 to-red-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(Y/Math.max(i,1)*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-blue-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-400 to-blue-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(T/Math.max(c,1)*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-[10px] text-red-600 font-medium",children:["متبقي سحب: ",Math.max(i-Y,0).toLocaleString("en-US")," جنيه"]}),e.jsxs("div",{className:"text-[10px] text-blue-600 font-medium",children:["متبقي تحويل: ",Math.max(c-T,0).toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-1 rounded-md border border-gray-200 shadow-sm hover:shadow-md transition-all duration-300",children:[e.jsxs("div",{className:"text-[10px] text-gray-600 font-medium mb-1 text-center",children:["الحدود اليومية: ",s.name]}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-orange-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-orange-400 to-orange-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(q/Math.max(N,1)*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-green-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-green-400 to-green-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(Ue/Math.max(E,1)*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-[10px] text-orange-600 font-medium",children:["متبقي سحب يومي: ",Math.max(N-q,0).toLocaleString("en-US")," جنيه"]}),e.jsxs("div",{className:"text-[10px] text-green-600 font-medium",children:["متبقي تحويل يومي: ",Math.max(E-Ue,0).toLocaleString("en-US")," جنيه"]})]})]})]}):null})(),se==="transfer"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المرسل"}),e.jsxs("div",{className:"relative",children:[e.jsx(us,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(R,{value:xt,onChange:s=>$t(s.target.value),onKeyDown:s=>{if(s.key==="Enter"){const a=document.getElementById("receiverPhoneInput");if(a)a.focus();else{const n=document.getElementById("amountInput");n==null||n.focus()}}},placeholder:"01030302038",className:"pl-10 h-10 text-sm transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]})]}),!j&&e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المستقبل"}),e.jsxs("div",{className:"relative",children:[e.jsx(us,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(R,{id:"receiverPhoneInput",value:Pt,onChange:s=>{Ks(s.target.value),Sr&&Vs(!1)},onKeyDown:s=>{if(s.key==="Enter"){const a=document.getElementById("amountInput");a==null||a.focus()}},inputMode:"numeric",maxLength:11,placeholder:"أدخل رقم المستقبل",className:"pl-10 h-10 text-sm transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المستقبل"}),e.jsxs("div",{className:"relative",children:[e.jsx(us,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(R,{value:G&&((Fl=ye.find(s=>s.id===G))==null?void 0:Fl.phone)||"",readOnly:!0,placeholder:"اختر محفظة أولاً",className:"pl-10 h-10 text-sm bg-gray-50 transition-all duration-300"})]})]}),se==="transfer"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"المبلغ (جنيه)"}),e.jsxs("div",{className:"relative flex items-center gap-2",children:[e.jsx(Ge,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(R,{id:"amountInput",value:jt,onChange:s=>{Ss(s.target.value),Sr&&Vs(!1)},onKeyDown:s=>{if(s.key==="Enter"){const a=document.getElementById("transferCommissionInput");if(a)a.focus();else{const n=document.getElementById("quickDebtButton");n==null||n.focus()}}},placeholder:"أدخل المبلغ",type:"number",className:"pl-10 h-10 text-sm transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),Dt?e.jsxs("div",{className:"mt-2 text-xs text-green-700 bg-green-50 border border-green-200 rounded px-2 py-1 flex items-center gap-2",children:[e.jsxs("span",{children:["تم إدخال تفاصيل الأجل لـ ",Dt.debtorName," بمبلغ ",Dt.amount," جنيه"]}),e.jsx(d,{type:"button",variant:"ghost",size:"sm",className:"h-6 px-2",onClick:()=>ia(null),children:"إلغاء"})]}):null]}),(()=>{if(j)return null;const s=vs();return s&&s.defaultTransferCommission!=null?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة التحويل (تلقائية)"}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["سيتم تطبيق عمولة التحويل الافتراضية لكل ألف: ",s==null?void 0:s.defaultTransferCommission," جنيه لكل ألف"]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(d,{id:"quickDebtButton",type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const n=vs(),i=(n==null?void 0:n.defaultTransferCommission)!=null?Number(n.defaultTransferCommission):0,c=parseFloat(jt||"0")||0,g=Math.round((i||0)*c/1e3*100)/100,f=c+g;Pe((f||0).toString()),Ae?l({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):ss(!0)},children:"أجل"}),e.jsx(d,{type:"button",variant:"outline",size:"icon",className:"hidden",title:Ie?"العمولة تُضاف":"العمولة تُخصم",children:Ie?e.jsx(ft,{className:"h-4 w-4 text-green-600"}):e.jsx(Es,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"hidden",children:Ie?"العمولة تُضاف":"العمولة تُخصم"})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة التحويل على العملية (جنيه)"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(Ge,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-orange-500"}),e.jsx(R,{id:"transferCommissionInput",value:It,onChange:n=>yr(n.target.value),placeholder:"أدخل عمولة التحويل",type:"number",className:"pl-10 h-10 text-sm transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),e.jsx(d,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const n=vs(),i=parseFloat(jt||"0")||0;let c=0;if((n==null?void 0:n.defaultTransferCommission)!=null){const f=Number(n.defaultTransferCommission)||0;c=Math.round(f*i/1e3*100)/100}else{const f=It&&It.trim()!==""?parseFloat(It):0;c=Math.max(0,f)}const g=i+c;Pe((g||0).toString()),Ae?l({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):ss(!0)},children:"أجل"}),e.jsx(d,{type:"button",variant:"outline",size:"icon",className:"hidden",title:Ie?"العمولة تُضاف":"العمولة تُخصم",children:Ie?e.jsx(ft,{className:"h-4 w-4 text-green-600"}):e.jsx(Es,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"hidden",children:Ie?"العمولة تُضاف":"العمولة تُخصم"})]}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"يمكنك إدخال عمولة العملية الإجمالية (اختياري)"})]})})(),(()=>{const s=Aa(xt||"").replace(/\D/g,""),a=Aa(Pt||"").replace(/\D/g,"");return se==="transfer"&&(s.startsWith("010")&&(a.startsWith("011")||a.startsWith("012")||a.startsWith("015"))||s.startsWith("012")&&a.startsWith("010")||s.startsWith("011")&&a.startsWith("010")||s.startsWith("015")&&a.startsWith("010"))?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رسوم التحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Ge,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-orange-500"}),e.jsx(R,{id:"transferExtraFeeInput",value:Pn,onChange:i=>Wi(i.target.value),placeholder:"أدخل رسوم التحويل",type:"number",className:"pl-10 h-10 text-sm transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),e.jsx("div",{className:"hidden",children:"تُخصم من المحفظة وتضاف للدرج — لعمليات 010 → 011/012/015 أو 012 → 010 أو 011 → 010 أو 015 → 010"})]}):null})(),e.jsx("div",{className:"sticky bottom-0 z-10 pt-2 bg-white/80 backdrop-blur supports-[backdrop-filter]:bg-white/60",children:e.jsx(d,{id:"transferSubmitButton",onClick:kl,className:"w-full font-medium h-10 text-sm btn-bounce hover-glow transition-all duration-300 bg-blue-600 hover:bg-blue-700 text-white",children:Sr?"تم التحويل بنجاح":"تأكيد التحويل"})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"مبلغ السحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(xr,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-green-500"}),e.jsx(R,{id:"amountInput",value:jt,onChange:s=>{Ss(s.target.value),zn&&da(!1)},onKeyDown:s=>{if(s.key==="Enter"){const a=document.getElementById("manualWithdrawCommissionInput");if(a)a.focus();else{const n=document.getElementById("withdrawSubmitButton");n==null||n.focus()}}},placeholder:"أدخل مبلغ السحب",type:"number",className:"pl-10 h-10 text-sm transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]})]}),(()=>{const s=vs();return s&&s.defaultWithdrawCommission!=null?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة السحب (تلقائية)"}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["سيتم تطبيق عمولة السحب الافتراضية لكل ألف: ",s==null?void 0:s.defaultWithdrawCommission," جنيه لكل ألف"]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(d,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const n=vs(),i=parseFloat(jt||"0")||0,c=(n==null?void 0:n.defaultWithdrawCommission)!=null&&Number(n.defaultWithdrawCommission)||0,g=Math.round(c*i/1e3*100)/100,f=Ie?i+g:i;Pe((f||0).toString()),Ae?l({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):ss(!0)},children:"أجل"}),e.jsx(d,{type:"button",variant:"outline",size:"icon",className:"h-8 w-8",onClick:()=>br(n=>!n),title:Ie?"العمولة تُضاف إلى الدين":"العمولة تُخصم من الدين",children:Ie?e.jsx(ft,{className:"h-4 w-4"}):e.jsx(Es,{className:"h-4 w-4"})}),e.jsx("span",{className:"text-xs text-gray-600",children:Ie?"العمولة تُضاف":"العمولة تُخصم"})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة السحب على العملية (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Ge,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-orange-500"}),e.jsx(R,{id:"manualWithdrawCommissionInput",value:Ct,onChange:n=>vr(n.target.value),onKeyDown:n=>{if(n.key==="Enter"){const i=document.getElementById("withdrawSubmitButton");i==null||i.focus()}},placeholder:"أدخل العمولة المطلوبة",type:"number",className:"pl-10 h-10 text-sm transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"أدخل العمولة الإجمالية لإتمام عملية السحب"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(d,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const n=vs(),i=parseFloat(jt||"0")||0;let c=0;if((n==null?void 0:n.defaultWithdrawCommission)!=null){const f=Number(n.defaultWithdrawCommission)||0;c=Math.round(f*i/1e3*100)/100}else{const f=Ct&&Ct.trim()!==""?parseFloat(Ct):Math.round(i*.01*100)/100;c=Math.max(0,f)}const g=Ie?i+c:i;Pe((g||0).toString()),Ae?l({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):ss(!0)},children:"أجل"}),e.jsx(d,{type:"button",variant:"outline",size:"icon",title:Ie?"العمولة تُضاف":"العمولة تُخصم",onClick:()=>br(n=>!n),children:Ie?e.jsx(ft,{className:"h-4 w-4 text-green-600"}):e.jsx(Es,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"text-xs text-gray-600",children:Ie?"العمولة تُضاف":"العمولة تُخصم"})]})]})})(),e.jsx("div",{className:"sticky bottom-0 z-10 pt-2 bg-white/80 backdrop-blur supports-[backdrop-filter]:bg-white/60",children:e.jsx(d,{id:"withdrawSubmitButton",onClick:kl,className:"w-full font-medium h-10 text-sm btn-bounce hover-glow transition-all duration-300 bg-green-600 hover:bg-green-700 text-white",children:zn?"تم السحب بنجاح":"تأكيد السحب"})})]}),e.jsx(ie,{open:na,onOpenChange:ss,children:e.jsxs(oe,{children:[e.jsxs(ce,{children:[e.jsx(de,{children:"تحويل مؤجل"}),e.jsx(Mt,{children:"أدخل بيانات صاحب الدين والمبلغ والملاحظات ثم اضغط حفظ"})]}),e.jsxs("div",{className:"space-y-3",children:[ns&&ns.length>0?e.jsxs("div",{children:[e.jsx(V,{children:"اختيار عميل"}),e.jsxs(ks,{value:pt,onValueChange:s=>{la(s);const a=ns.find(n=>n.id===s);a&&me(a.name)},children:[e.jsx(As,{className:"w-full",children:e.jsx(Ps,{placeholder:"اختر عميل"})}),e.jsx(Os,{children:ns.map(s=>e.jsxs(Ht,{value:s.id,children:[s.name,s.mobile?` — ${s.mobile}`:""]},s.id))})]})]}):e.jsx("div",{className:"text-xs text-gray-500",children:"لا يوجد عملاء مُسجلين حالياً. يمكنك إضافة عميل من نافذة الديون."}),e.jsxs("div",{children:[e.jsx(V,{htmlFor:"quickDebtName",children:"اسم صاحب الدين"}),e.jsx(R,{id:"quickDebtName",value:W,onChange:s=>me(s.target.value),placeholder:"اكتب الاسم"})]}),e.jsxs("div",{children:[e.jsx(V,{htmlFor:"quickDebtAmount",children:"المبلغ (محسوب تلقائياً)"}),e.jsx(R,{id:"quickDebtAmount",type:"number",value:Nt,readOnly:!0,placeholder:"المبلغ + عمولة التحويل"})]}),e.jsxs("div",{children:[e.jsx(V,{htmlFor:"quickDebtNotes",children:"ملاحظات"}),e.jsx(R,{id:"quickDebtNotes",value:Ut,onChange:s=>_t(s.target.value),placeholder:"اكتب ملاحظات (اختياري)"})]})]}),e.jsx(De,{children:e.jsx(d,{type:"button",onClick:()=>{const s=vs(),a=parseFloat((jt||"").toString())||0;let n=0;if(se==="transfer")if((s==null?void 0:s.defaultTransferCommission)!=null){const g=Number(s.defaultTransferCommission)||0;n=Math.round(g*a/1e3*100)/100}else{const g=It&&It.trim()!==""?parseFloat(It):0;n=Math.max(0,g)}else if((s==null?void 0:s.defaultWithdrawCommission)!=null){const g=Number(s.defaultWithdrawCommission)||0;n=Math.round(g*a/1e3*100)/100}else{const g=Ct&&Ct.trim()!==""?parseFloat(Ct):Math.round(a*.01*100)/100;n=Math.max(0,g)}let i=0;if(se==="withdraw"?i=Ie?a:Math.max(0,Math.round((a-n)*100)/100):i=Math.max(0,Math.round((a+n)*100)/100),!W||isNaN(i)||i<=0){l({title:"خطأ في بيانات الأجل",description:"يرجى إدخال الاسم والمبلغ بشكل صحيح",variant:"destructive"});return}const c=ns.find(g=>g.id===pt);ia({debtorName:W,amount:i,notes:Ut,customerId:pt||void 0,mobile:c==null?void 0:c.mobile}),je(!1),ss(!1),l({title:"تم حفظ بيانات الأجل",description:"سيتم إضافة الدين عند تأكيد العملية",variant:"default"})},children:"حفظ"})})]})})]})]}),e.jsx(Ve,{className:"bg-gradient-to-br from-red-50 to-red-100 border-red-200 fade-in-up card-float",children:e.jsxs(He,{className:"p-3 text-center",children:[e.jsx("div",{className:"text-red-600 font-medium text-[10px] mb-1",children:"⚠️ تحذير من التحويل"}),e.jsx("div",{className:"text-[10px] text-red-700",children:"لا يمكن إلغاء أي عملية بعد تأكيدها للمحافظة على الأمان"})]})})]})]}),e.jsx(od,{isOpen:Fi,onClose:()=>Ei(!1),initialEditingWallet:Bi,onWalletUpdate:async()=>{try{await ar()}catch(s){console.error("Error reloading wallets after update:",s)}}}),e.jsx(cd,{isOpen:Ri,onClose:()=>En(!1),transaction:Li,onDelete:Yo}),e.jsx(pn,{open:zi,onOpenChange:ca,onSuccess:Zo,title:Xo(),description:ec()}),e.jsx(pn,{open:Ki,onOpenChange:wr,onSuccess:()=>{wr(!1),Mn(!0)},title:"حماية أرشيف التقارير اليومية",description:"أدخل كلمة مرور تسجيل الدخول للوصول إلى الأرشيف"}),e.jsx(Rd,{open:Ji,onOpenChange:Mn,userId:t==null?void 0:t.uid}),e.jsx(Ul,{open:jo,onOpenChange:sl,onSuccess:sc,title:"تعديل الرصيد النقدي في الدرج",description:"أدخل الرقم السري والمبلغ الجديد لتعديل الرصيد النقدي في الدرج",currentBalance:ze,balanceLabel:"الرصيد النقدي",userId:t==null?void 0:t.uid}),e.jsx(Ul,{open:No,onOpenChange:al,onSuccess:ac,title:"تعديل رصيد المحفظة",description:"أدخل الرقم السري والمبلغ الجديد لتعديل رصيد المحفظة",currentBalance:Tt&&ve[Tt]||0,balanceLabel:`رصيد ${((El=ye.find(s=>s.id===Tt))==null?void 0:El.name)||"المحفظة"}`,userId:t==null?void 0:t.uid}),e.jsx(ud,{open:wo,onOpenChange:Jr,onSuccess:rc,title:"إضافة أو خصم مبلغ من رصيد المحفظة",description:"أدخل الرقم السري والمبلغ المراد إضافته أو خصمه من رصيد المحفظة",currentBalance:Tt&&ve[Tt]||0,balanceLabel:`رصيد ${((Bl=ye.find(s=>s.id===Tt))==null?void 0:Bl.name)||"المحفظة"}`,userId:t==null?void 0:t.uid}),e.jsx(dd,{open:Fo,onOpenChange:Eo,userId:t==null?void 0:t.uid}),e.jsx(md,{open:Bo,onOpenChange:Mo,userId:t==null?void 0:t.uid}),e.jsx(hd,{open:Lo,onOpenChange:Ro}),e.jsx(ie,{open:Co,onOpenChange:Ka,children:e.jsxs(oe,{className:"sm:max-w-md",children:[e.jsx(ce,{children:e.jsx(de,{className:"text-right",children:"تعديل الدرج النقدية"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(V,{htmlFor:"amount",className:"text-right block",children:"المبلغ"}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx(R,{id:"amount",type:"number",placeholder:"أدخل المبلغ",value:qr,onChange:s=>Va(s.target.value),className:"text-right flex-1",dir:"rtl",min:"0"}),e.jsxs("div",{className:"flex gap-1",children:[e.jsxs(d,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white px-3 py-2",onClick:()=>{if(!on(Zr)){l({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}const s=parseFloat(qr);if(isNaN(s)||s<=0){l({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const a=ze+s;lt(a);const n={cashBalance:a,lastUpdated:new Date().toISOString()},i=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(i,JSON.stringify(n)),t!=null&&t.uid?we.updateUserData(t.uid,n).then(()=>{console.log("✅ تم حفظ رصيد الدرج النقدي في Firebase بنجاح"),localStorage.removeItem(i),ge(!1)}).catch(c=>{console.error("❌ خطأ في حفظ الرصيد في Firebase:",c),ge(!0)}):ge(!0),l({title:"تم بنجاح",description:`تم إضافة ${s} جنيه إلى الدرج النقدية وحفظه في السحابة`}),Ka(!1),Va(""),Ga("")},children:[e.jsx(ft,{className:"h-1 w-1 mr-1"}),"إضافة"]}),e.jsxs(d,{type:"button",size:"sm",className:"bg-red-600 hover:bg-red-700 text-white px-3 py-2",onClick:()=>{if(!on(Zr)){l({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}const s=parseFloat(qr);if(isNaN(s)||s<=0){l({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const a=ze-s;lt(a);const n={cashBalance:a,lastUpdated:new Date().toISOString()},i=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(i,JSON.stringify(n)),t!=null&&t.uid?we.updateUserData(t.uid,n).then(()=>{console.log("✅ تم حفظ رصيد الدرج النقدي في Firebase بنجاح"),localStorage.removeItem(i),ge(!1)}).catch(c=>{console.error("❌ خطأ في حفظ الرصيد في Firebase:",c),ge(!0)}):ge(!0),l({title:"تم بنجاح",description:`تم خصم ${s} جنيه من الدرج النقدية وحفظه في السحابة`}),Ka(!1),Va(""),Ga("")},children:[e.jsx(Es,{className:"h-1 w-1 mr-1"}),"خصم"]})]})]}),e.jsxs("p",{className:"text-[10px] text-gray-500 text-right",children:["الرصيد الحالي: ",ze.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(V,{htmlFor:"pin",className:"text-right block",children:"الرقم السري"}),e.jsx(R,{id:"pin",type:"password",placeholder:"أدخل الرقم السري",value:Zr,onChange:s=>Ga(s.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsx(De,{className:"flex gap-2",children:e.jsx(d,{variant:"outline",onClick:()=>{Ka(!1),Va(""),Ga("")},children:"إلغاء"})})]})}),e.jsx(ie,{open:_o,onOpenChange:er,children:e.jsxs(oe,{className:"sm:max-w-md",children:[e.jsx(ce,{children:e.jsx(de,{className:"text-right text-red-600",children:"تصفير إجمالي المحفظة"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-red-50 rounded-lg border border-red-200",children:[e.jsx("p",{className:"text-red-800 font-medium mb-2",children:"تحذير!"}),e.jsx("p",{className:"text-red-700 text-sm",children:"سيتم تصفير جميع أرصدة المحافظ إلى صفر. هذا الإجراء لا يمكن التراجع عنه."}),e.jsxs("p",{className:"text-red-600 text-sm mt-2",children:["الرصيد الحالي: ",Object.values(ve).reduce((s,a)=>s+a,0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(V,{htmlFor:"resetWalletTotalPin",className:"text-right block",children:"كلمة مرور تسجيل الدخول"}),e.jsx(R,{id:"resetWalletTotalPin",type:"password",placeholder:"أدخل كلمة مرور تسجيل الدخول",value:Cl,onChange:s=>tr(s.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsxs(De,{className:"flex gap-2",children:[e.jsx(d,{variant:"outline",onClick:()=>{er(!1),tr("")},children:"إلغاء"}),e.jsx(d,{variant:"destructive",onClick:async()=>{if(!await cn(Cl)){l({title:"خطأ",description:"كلمة المرور غير صحيحة",variant:"destructive"});return}try{const a={};Object.keys(ve).forEach(g=>{a[g]=0}),Je(a),localStorage.setItem(Xe(),JSON.stringify(a)),er(!1),tr("");const n=new Date().toISOString(),i={walletBalances:a,lastUpdated:n},c=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(c,JSON.stringify(i)),t!=null&&t.uid?we.updateUserData(t.uid,i).then(()=>{localStorage.removeItem(c),ge(!1)}).catch(g=>{console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",g),ge(!0),l({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):ge(!0),setTimeout(()=>{Je({...a})},100)}catch(a){console.error("خطأ في تصفير أرصدة المحافظ:",a),l({title:"خطأ",description:"حدث خطأ أثناء تصفير المحافظ",variant:"destructive"})}},children:"تصفير المحفظة"})]})]})}),e.jsx(ie,{open:So,onOpenChange:Ja,children:e.jsxs(oe,{className:"sm:max-w-md",children:[e.jsx(ce,{children:e.jsx(de,{className:"text-right text-red-600",children:"تصفير رصيد المحفظة المختارة"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-red-50 rounded-lg border border-red-200",children:[e.jsx("p",{className:"text-red-800 font-medium mb-2",children:"تحذير!"}),e.jsx("p",{className:"text-red-700 text-sm",children:"سيتم تصفير رصيد المحفظة المحددة إلى صفر. هذا الإجراء لا يمكن التراجع عنه."}),e.jsxs("p",{className:"text-red-600 text-sm mt-2",children:["المحفظة: ",((Ml=ye.find(s=>s.id===G))==null?void 0:Ml.name)||G]}),e.jsxs("p",{className:"text-red-600 text-sm",children:["الرصيد الحالي: ",(G&&ve[G]?ve[G]:0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(V,{htmlFor:"resetSelectedWalletPin",className:"text-right block",children:"كلمة مرور تسجيل الدخول"}),e.jsx(R,{id:"resetSelectedWalletPin",type:"password",autoComplete:"off",placeholder:"أدخل كلمة مرور تسجيل الدخول",value:rl,onChange:s=>Kr(s.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsxs(De,{className:"flex gap-2",children:[e.jsx(d,{variant:"outline",onClick:()=>{Ja(!1),Kr("")},children:"إلغاء"}),e.jsx(d,{variant:"destructive",onClick:async()=>{var a;if(!G){l({title:"اختر محفظة",description:"يرجى اختيار محفظة أولاً",variant:"destructive"});return}if(!await cn(rl)){l({title:"خطأ",description:"كلمة المرور غير صحيحة",variant:"destructive"});return}try{const n={...ve};n[G]=0,Je(n),localStorage.setItem(Xe(),JSON.stringify(n)),Ja(!1),Kr("");const i=new Date().toISOString(),c={walletBalances:n,lastUpdated:i},g=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(g,JSON.stringify(c)),t!=null&&t.uid?we.updateUserData(t.uid,c).then(()=>{localStorage.removeItem(g),ge(!1)}).catch(f=>{console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",f),ge(!0),l({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):ge(!0),l({title:"تم التصفير بنجاح",description:`تم تصفير رصيد المحفظة ${((a=ye.find(f=>f.id===G))==null?void 0:a.name)||G}`})}catch(n){console.error("خطأ في تصفير رصيد المحفظة المختارة:",n),l({title:"خطأ",description:"حدث خطأ أثناء تصفير رصيد المحفظة المختارة",variant:"destructive"})}},children:"تصفير المحفظة"})]})]})}),e.jsx(ie,{open:Uo,onOpenChange:Xa,children:e.jsxs(oe,{className:"sm:max-w-md",children:[e.jsx(ce,{children:e.jsxs(de,{className:"text-right text-green-600 flex items-center gap-2 justify-end",children:[e.jsx(ft,{className:"h-4 w-4"}),"إضافة أموال لإجمالي المحفظة"]})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-green-50 rounded-lg border border-green-200",children:[e.jsx("p",{className:"text-green-800 font-medium mb-2",children:"إضافة أموال"}),e.jsx("p",{className:"text-green-700 text-sm",children:"سيتم إضافة المبلغ المحدد إلى إجمالي المحفظة بشكل متناسب على جميع المحافظ."}),e.jsxs("p",{className:"text-green-600 text-sm mt-2",children:["الرصيد الحالي: ",Object.values(ve).reduce((s,a)=>s+a,0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"addWalletTotalAmount",className:"text-right block",children:"المبلغ المراد إضافته"}),e.jsx(R,{id:"addWalletTotalAmount",type:"number",placeholder:"أدخل المبلغ",value:vl,onChange:s=>sn(s.target.value),className:"text-right",dir:"rtl"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"addWalletTotalPin",className:"text-right block",children:"الرقم السري للتأكيد"}),e.jsx(R,{id:"addWalletTotalPin",type:"password",autoComplete:"off",placeholder:"أدخل الرقم السري",value:yl,onChange:s=>an(s.target.value),className:"text-right",dir:"rtl"})]})]})]}),e.jsxs(De,{className:"flex gap-2",children:[e.jsx(d,{variant:"outline",onClick:()=>{Xa(!1),sn(""),an("")},children:"إلغاء"}),e.jsx(d,{variant:"default",className:"bg-green-600 hover:bg-green-700",disabled:bl,onClick:async()=>{const s=parseFloat(vl);if(!s||s<=0){l({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}if(!Ko(yl)){l({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}jl(!0);try{const a=Object.values(ve).reduce((n,i)=>n+i,0);if(a===0){const n=Object.keys(ve),i=s/n.length,c={};n.forEach(g=>{c[g]=i}),Je(c),localStorage.setItem(Xe(),JSON.stringify(c)),t!=null&&t.uid?await we.updateUserData(t.uid,{walletBalances:c,lastUpdated:new Date().toISOString()}):ge(!0)}else{const n={};Object.entries(ve).forEach(([i,c])=>{const g=c/a,f=s*g;n[i]=c+f}),Je(n),localStorage.setItem(Xe(),JSON.stringify(n)),t!=null&&t.uid?await we.updateUserData(t.uid,{walletBalances:n,lastUpdated:new Date().toISOString()}):ge(!0)}setTimeout(()=>{Je(n=>({...n}))},100),Xa(!1),sn(""),an("")}catch(a){console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",a),l({title:"خطأ",description:"حدث خطأ أثناء حفظ البيانات",variant:"destructive"})}finally{jl(!1)}},children:bl?"جاري الإضافة...":"إضافة الأموال"})]})]})}),e.jsx(ie,{open:zo,onOpenChange:sr,children:e.jsxs(oe,{className:"sm:max-w-[425px]",children:[e.jsx(ce,{children:e.jsxs(de,{className:"text-red-600 flex items-center gap-2",children:[e.jsx(Wt,{className:"h-1 w-1"}),"تصفير الرصيد النقدي"]})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-3",children:e.jsx("p",{className:"text-sm text-red-700",children:"⚠️ تحذير: سيتم تصفير الرصيد النقدي في الدرج إلى صفر. هذا الإجراء لا يمكن التراجع عنه."})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(V,{htmlFor:"resetCashPin",children:"كلمة مرور تسجيل الدخول"}),e.jsx(R,{id:"resetCashPin",type:"password",autoComplete:"off",placeholder:"أدخل كلمة مرور تسجيل الدخول",value:nn,onChange:s=>ln(s.target.value)})]})]}),e.jsxs(De,{children:[e.jsx(d,{variant:"outline",onClick:()=>{sr(!1),ln("")},children:"إلغاء"}),e.jsx(d,{variant:"destructive",onClick:async()=>{if(!nn){l({title:"خطأ",description:"يرجى إدخال كلمة المرور",variant:"destructive"});return}if(!await cn(nn)){l({title:"خطأ",description:"كلمة المرور غير صحيحة",variant:"destructive"});return}try{lt(0),sr(!1),ln("");const a={cashBalance:0,lastUpdated:new Date().toISOString()};localStorage.setItem(et(),"0");const n=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(n,JSON.stringify(a)),t!=null&&t.uid?we.updateUserData(t.uid,a).then(()=>{localStorage.removeItem(n),ge(!1)}).catch(i=>{console.error("خطأ في حفظ الرصيد في Firebase:",i),ge(!0),l({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):ge(!0)}catch(a){console.error("خطأ في تصفير الرصيد النقدي:",a),l({title:"خطأ",description:"حدث خطأ أثناء تصفير الرصيد النقدي",variant:"destructive"})}},children:"تصفير الرصيد"})]})]})}),e.jsx(ie,{open:$o,onOpenChange:Qa,children:e.jsxs(oe,{className:"sm:max-w-[425px]",children:[e.jsx(ce,{children:e.jsxs(de,{className:"text-green-600 flex items-center gap-2",children:[e.jsx(ft,{className:"h-4 w-4"}),"إضافة أموال للدرج"]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-3",children:e.jsx("p",{className:"text-sm text-green-700",children:"💰 سيتم إضافة المبلغ المحدد إلى الرصيد النقدي في الدرج"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"addCashAmount",children:"المبلغ المراد إضافته"}),e.jsx(R,{id:"addCashAmount",type:"number",placeholder:"أدخل المبلغ",value:Za,onChange:s=>Xr(s.target.value),min:"0",step:"0.01"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"addCashPin",children:"الرقم السري لدرج النقدية"}),e.jsx(R,{id:"addCashPin",type:"password",placeholder:"أدخل الرقم السري",value:en,onChange:s=>tn(s.target.value)})]})]}),e.jsxs(De,{children:[e.jsx(d,{variant:"outline",onClick:()=>{Qa(!1),Xr(""),tn("")},children:"إلغاء"}),e.jsx(d,{variant:"default",className:"bg-green-600 hover:bg-green-700",disabled:gl,onClick:async()=>{if(!Za||parseFloat(Za)<=0){l({title:"خطأ",description:"يرجى إدخال مبلغ صحيح أكبر من صفر",variant:"destructive"});return}if(!en){l({title:"خطأ",description:"يرجى إدخال الرقم السري",variant:"destructive"});return}if(!on(en)){l({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}fl(!0);try{const s=parseFloat(Za),a=ze+s;lt(a),localStorage.setItem(et(),a.toString());const n={cashBalance:a,lastUpdated:new Date().toISOString()},i=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(i,JSON.stringify(n)),t!=null&&t.uid?(await we.updateUserData(t.uid,n),localStorage.removeItem(i),ge(!1)):ge(!0),Qa(!1),Xr(""),tn("")}catch(s){console.error("خطأ في حفظ الرصيد في Firebase:",s),lt(ze),localStorage.setItem("cashBalance",ze.toString()),l({title:"خطأ",description:"حدث خطأ أثناء حفظ البيانات، يرجى المحاولة مرة أخرى",variant:"destructive"})}finally{fl(!1)}},children:gl?"جاري الإضافة...":"إضافة الأموال"})]})]})}),e.jsx(ie,{open:bo,onOpenChange:zr,children:e.jsxs(oe,{className:"sm:max-w-md",children:[e.jsx(ce,{children:e.jsx(de,{className:"text-right",children:"اختيار التاريخ والوقت للبحث"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(V,{htmlFor:"search-date",className:"text-right block",children:"التاريخ"}),e.jsx(R,{id:"search-date",type:"date",value:Oa,onChange:s=>Un(s.target.value),className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(V,{htmlFor:"search-time",className:"text-right block",children:"الوقت (اختياري)"}),e.jsx(R,{id:"search-time",type:"time",value:Wa,onChange:s=>_n(s.target.value),className:"text-right",placeholder:"اختر الوقت للبحث في ساعة محددة"}),e.jsx("p",{className:"text-[10px] text-gray-500 text-right",children:"إذا لم تختر وقتاً محدداً، سيتم البحث في كامل اليوم"})]})]}),e.jsxs(De,{className:"flex justify-between",children:[e.jsx(d,{variant:"outline",onClick:()=>{Un(""),_n(""),zr(!1)},children:"مسح"}),e.jsx(d,{onClick:()=>zr(!1),children:"تطبيق"})]})]})}),e.jsx(_l,{isOpen:te&&!O,onClose:()=>$(!1),onTrialStarted:vo}),e.jsx(gd,{isOpen:Gi,onClose:()=>Cr(!1)}),e.jsx(fd,{isOpen:Qi,onClose:()=>Ea(!1)}),e.jsx($c,{isOpen:Zi,onClose:()=>Ba(!1)}),e.jsx(Uc,{open:Xi,onOpenChange:Ma}),e.jsx(Od,{open:eo,onOpenChange:s=>{if(s&&!qt){l({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});return}La(s)}}),e.jsx($d,{open:Z,onOpenChange:s=>{if(s&&!qt){l({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}B(s)}}),e.jsx(Ud,{open:k,onOpenChange:s=>{if(s&&!qt){l({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}C(s)}}),e.jsx(ie,{open:Io,onOpenChange:s=>{if(s){l({title:"قيد التطوير",description:"هذه الميزة غير متاحة حالياً."});return}Yr(!1)},children:e.jsxs(oe,{dir:"rtl",className:"sm:max-w-md w-[95vw] sm:w-auto rounded-2xl border border-emerald-200 shadow-xl bg-gradient-to-br from-white via-green-50 to-emerald-50 backdrop-blur-md data-[state=open]:animate-in data-[state=open]:fade-in-0 data-[state=open]:zoom-in-90 data-[state=open]:slide-in-from-bottom-8 duration-300",children:[e.jsxs(ce,{children:[e.jsx(de,{className:"text-right text-green-700",children:"شحن رصيد الموبايل"}),e.jsx(Mt,{className:"text-right text-gray-600",children:"أدخل البيانات ثم اضغط تأكيد"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx(V,{htmlFor:"topupPhone",className:"text-right block",children:"رقم الموبايل"}),e.jsx(R,{id:"topupPhone",value:qa,onChange:s=>nl(s.target.value),placeholder:"010xxxxxxx",className:"text-right"})]}),e.jsxs("div",{children:[e.jsx(V,{className:"text-right block",children:"شركة التشغيل"}),e.jsxs(ks,{value:Ya,onValueChange:ll,children:[e.jsx(As,{className:"text-right",children:e.jsx(Ps,{placeholder:"اختر الشركة"})}),e.jsxs(Os,{children:[e.jsx(Ht,{value:"vodafone",children:"فودافون"}),e.jsx(Ht,{value:"orange",children:"أورنج"}),e.jsx(Ht,{value:"etisalat",children:"اتصالات"}),e.jsx(Ht,{value:"we",children:"WE"})]})]})]}),e.jsxs("div",{children:[e.jsx(V,{htmlFor:"topupAmount",className:"text-right block",children:"المبلغ بالجنيه"}),e.jsx(R,{id:"topupAmount",type:"number",value:Ha,onChange:s=>il(s.target.value?Number(s.target.value):""),placeholder:"50",className:"text-right"})]})]}),e.jsxs(De,{className:"flex gap-2 justify-between",children:[e.jsx(d,{variant:"outline",onClick:()=>Yr(!1),className:"border-gray-300",children:"إلغاء"}),e.jsx(d,{onClick:y,disabled:ol||!qa||!Ya||!Ha,className:"bg-emerald-600 hover:bg-emerald-700 text-white",children:ol?"جارٍ التنفيذ...":"تأكيد الشحن"})]})]})}),e.jsx(Bs,{open:io,onOpenChange:ha,mode:"verify",title:"الرقم السري الرئيسي لفتح الديون",description:"أدخل الرقم السري الرئيسي لفتح صفحة الديون",onSuccess:()=>{ha(!1),$a(!0)}}),e.jsx(pn,{open:Do,onOpenChange:Vr,title:"تأكيد كلمة المرور لتصفير المعاملات الأخيرة",description:"لن يتم حذف الإيصالات؛ سنبدأ القائمة من الآن.",onSuccess:()=>{try{t!=null&&t.uid&&(localStorage.setItem(`recentTransactionsResetAt:${t.uid}`,new Date().toISOString()),l({title:"تم التصفير",description:"تم بدء قائمة المعاملات من الآن."}))}catch{}Vr(!1)}}),e.jsx(Bs,{open:pe,onOpenChange:H,mode:"verify",title:"الرقم السري لفتح مصروفات المحل",description:"أدخل الرقم السري الرئيسي لفتح نافذة مصروفات المحل",onSuccess:()=>{H(!1),ae(!0)}}),e.jsx(ie,{open:lo,onOpenChange:$a,children:e.jsxs(oe,{className:"sm:max-w-[425px]",children:[e.jsxs(ce,{className:"flex items-center justify-between",children:[e.jsx(de,{className:"text-right",children:"إدارة الديون"}),e.jsxs("div",{className:"flex items-center gap-1 text-orange-700",children:[e.jsx(td,{className:"h-4 w-4"}),e.jsxs("span",{className:"text-xs font-bold",children:[Qo," جنيه"]})]})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(V,{htmlFor:"debtorName",className:"text-right col-span-1",children:"اسم المديون"}),e.jsx(R,{id:"debtorName",value:Tr,onChange:s=>Vn(s.target.value),className:"col-span-3 text-right",placeholder:"أدخل اسم المديون"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(V,{htmlFor:"debtAmount",className:"text-right col-span-1",children:"المبلغ"}),e.jsx(R,{id:"debtAmount",type:"number",value:kr,onChange:s=>qn(s.target.value),className:"col-span-3 text-right",placeholder:"أدخل المبلغ"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(V,{htmlFor:"debtReason",className:"text-right col-span-1",children:"سبب الدين"}),e.jsx(R,{id:"debtReason",value:Ar,onChange:s=>Yn(s.target.value),className:"col-span-3 text-right",placeholder:"أدخل سبب الدين"})]})]}),e.jsx(De,{children:e.jsx(d,{onClick:()=>{if(Tr&&kr&&Ar){const s={id:Date.now().toString(),debtorName:Tr,amount:parseFloat(kr),reason:Ar,status:"pending",createdAt:new Date,paidAmount:0,partialPayments:[]};$r(s),Ua(!0)}else l({title:"بيانات غير مكتملة",description:"يرجى إدخال الاسم والمبلغ والسبب",variant:"destructive"})},className:"bg-orange-500 hover:bg-orange-600",children:"حفظ"})}),e.jsx("div",{className:"mt-2",children:e.jsx(d,{variant:"outline",className:"w-full",onClick:()=>xa(!0),children:"إيصالات الديون"})}),e.jsx("div",{className:"mt-2",children:e.jsx(d,{variant:"outline",className:"w-full",onClick:()=>Fr(!0),children:"إضافة عميل"})})]})}),e.jsx(ie,{open:mo,onOpenChange:xa,children:e.jsxs(oe,{className:"sm:max-w-[520px]",children:[e.jsxs(ce,{children:[e.jsx(de,{className:"text-right",children:"إيصالات الديون"}),e.jsx(Mt,{className:"text-right",children:"اختر دينًا لعرض إيصاله بالتفصيل"})]}),St.length>0?e.jsx("div",{className:"max-h-64 overflow-y-auto space-y-2",children:St.map(s=>e.jsx("div",{onClick:()=>{Pr(s),ua(!0),xa(!1),$a(!1)},className:"p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium",children:s.debtorName}),e.jsx("p",{className:"text-sm text-gray-600",children:s.reason}),e.jsx("p",{className:"text-sm text-gray-500",children:dn.format(s.createdAt instanceof Date?s.createdAt:new Date(s.createdAt))})]}),e.jsxs("div",{className:"text-left",children:[e.jsxs("p",{className:"font-bold text-lg",children:[s.amount," جنيه"]}),e.jsx(dt,{variant:s.status==="paid"?"default":"secondary",className:s.status==="paid"?"bg-green-500":"bg-yellow-500",children:s.status==="paid"?"مدفوع":"قيد المراجعة"})]})]})},s.id))}):e.jsx("div",{className:"text-center text-sm text-gray-500",children:"لا توجد ديون مسجلة"}),e.jsxs(De,{className:"flex justify-between mt-3",children:[e.jsx(d,{variant:"destructive",onClick:async()=>{try{if(!St||St.length===0){l({title:"لا توجد ديون",description:"القائمة فارغة بالفعل."});return}if(!window.confirm("هل تريد حذف كل إيصالات الديون؟ هذا الإجراء لا يمكن التراجع عنه."))return;const a=[];Jt(a),Pr(null),await ls(a),l({title:"تم حذف كل إيصالات الديون",description:"تم تفريغ القائمة بالكامل."}),xa(!1)}catch(s){console.error("تعذر حذف كل إيصالات الديون:",s),l({title:"فشل الحذف",description:"حدث خطأ أثناء الحذف، حاول مرة أخرى.",variant:"destructive"})}},children:"حذف كل الإيصالات"}),e.jsx(d,{variant:"outline",onClick:()=>xa(!1),children:"إغلاق"})]})]})}),e.jsx(ie,{open:ho,onOpenChange:Fr,children:e.jsxs(oe,{className:"sm:max-w-[480px]",children:[e.jsxs(ce,{children:[e.jsx(de,{className:"text-right",children:"إضافة عميل"}),e.jsx(Mt,{className:"text-right",children:"أدخل بيانات العميل ثم يمكنك تسجيل مبلغ دين عليه"})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(V,{htmlFor:"customerName",className:"text-right col-span-1",children:"اسم العميل"}),e.jsx(R,{id:"customerName",value:Br,onChange:s=>Gn(s.target.value),className:"col-span-3 text-right",placeholder:"اكتب اسم العميل"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(V,{htmlFor:"customerMobile",className:"text-right col-span-1",children:"رقم الموبايل"}),e.jsx(R,{id:"customerMobile",value:Mr,onChange:s=>Qn(s.target.value),className:"col-span-3 text-right",placeholder:"اكتب رقم الموبايل"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(d,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{if(!Br||!Mr){l({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم العميل ورقم الموبايل",variant:"destructive"});return}const s={id:Date.now().toString(),name:Br.trim(),mobile:Mr.trim(),createdAt:new Date},a=[s,...ns];await Po(a),Gn(""),Qn(""),l({title:"تمت إضافة العميل",description:`تم إضافة ${s.name}`})},children:"إضافة"})}),e.jsxs("div",{className:"border-t pt-4 space-y-3",children:[e.jsx(V,{className:"text-right block",children:"إضافة مبلغ على عميل"}),ns.length>0?e.jsxs("div",{className:"space-y-3",children:[e.jsxs(ks,{value:Lr,onValueChange:Zn,children:[e.jsx(As,{className:"w-full",children:e.jsx(Ps,{placeholder:"اختر عميل"})}),e.jsx(Os,{children:ns.map(s=>e.jsxs(Ht,{value:s.id,children:[s.name," — ",s.mobile]},s.id))})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(V,{htmlFor:"customerDebtAmount",className:"text-right col-span-1",children:"المبلغ"}),e.jsx(R,{id:"customerDebtAmount",type:"number",value:Xn,onChange:s=>el(s.target.value),className:"col-span-3 text-right",placeholder:"أدخل المبلغ"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(d,{className:"bg-orange-600 hover:bg-orange-700",onClick:async()=>{const s=parseFloat(Xn);if(!Lr){l({title:"اختر عميل",description:"يرجى اختيار عميل أولاً",variant:"destructive"});return}if(isNaN(s)||s<=0){l({title:"قيمة غير صحيحة",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const a=ns.find(c=>c.id===Lr);if(!a)return;const n={id:Date.now().toString(),debtorName:a.name,customerId:a.id,mobile:a.mobile,amount:Number(s.toFixed(2)),reason:"دين عميل",status:"pending",createdAt:new Date,paidAmount:0,partialPayments:[]},i=[...St,n];Jt(i),await ls(i),Zn(""),el(""),l({title:"تم تسجيل المبلغ على العميل",description:`تمت إضافة ${n.amount} جنيه للعميل ${a.name}`})},children:"إضافة المبلغ"})})]}):e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد عملاء مسجلين. أضف عميلًا أولاً."})]})]}),e.jsx(De,{className:"flex justify-end",children:e.jsx(d,{variant:"outline",onClick:()=>Fr(!1),children:"إغلاق"})})]})}),e.jsx(ie,{open:he,onOpenChange:ae,children:e.jsxs(oe,{className:"sm:max-w-[520px]",children:[e.jsxs(ce,{children:[e.jsx(de,{className:"text-right",children:"مصروفات المحل"}),e.jsx(Mt,{className:"text-right",children:"أدخل تفاصيل المصروف ثم اختر مصدر الخصم."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(V,{htmlFor:"expenseName",className:"text-right col-span-1",children:"اسم المصروف"}),e.jsx(R,{id:"expenseName",value:X,onChange:s=>Te(s.target.value),className:"col-span-3 text-right",placeholder:"مثال: كهرباء، صيانة، مشتريات"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(V,{htmlFor:"expenseAmount",className:"text-right col-span-1",children:"تمن المصروف"}),e.jsx(R,{id:"expenseAmount",type:"number",value:K,onChange:s=>re(s.target.value),className:"col-span-3 text-right",placeholder:"0.00"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(V,{htmlFor:"expenseNotes",className:"text-right col-span-1",children:"ملاحظات"}),e.jsx(R,{id:"expenseNotes",value:ke,onChange:s=>at(s.target.value),className:"col-span-3 text-right",placeholder:"معلومات إضافية إن وجدت"})]})]}),e.jsxs(De,{className:"flex justify-between",children:[e.jsx(d,{className:"bg-orange-600 hover:bg-orange-700",onClick:()=>{if(!X||!K){l({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم المصروف وقيمته",variant:"destructive"});return}qe(!0)},children:"إضافة مصروف"}),e.jsx(d,{variant:"outline",onClick:()=>F(!0),children:"إيصالات المصاريف"})]})]})}),e.jsx(ie,{open:Le,onOpenChange:F,children:e.jsxs(oe,{className:"sm:max-w-[420px]",dir:"rtl",children:[e.jsxs(ce,{children:[e.jsx(de,{className:"text-right",children:"إيصالات المصاريف"}),e.jsx(Mt,{className:"text-right",children:"آخر المصاريف المسجلة"})]}),vt.length>0?e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:vt.map(s=>e.jsx("div",{className:"p-2 border rounded-lg bg-white hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium text-sm",children:s.name}),e.jsx("p",{className:"text-[11px] text-gray-600",children:s.notes||"بدون ملاحظات"}),e.jsx("p",{className:"text-[10px] text-gray-500",children:new Date(s.createdAt).toLocaleString("ar-EG")})]}),e.jsxs("div",{className:"text-left",children:[e.jsxs("p",{className:"font-bold text-sm",children:[s.amount," جنيه"]}),e.jsx(dt,{variant:"secondary",className:s.source==="cash"?"bg-blue-100 text-blue-700":"bg-purple-100 text-purple-700",children:s.source==="cash"?"من النقدية":`من المحفظة${s.walletId?` (${s.walletId})`:""}`})]})]})},s.id))}):e.jsx("p",{className:"text-sm text-gray-500 text-center",children:"لا توجد مصاريف مسجلة بعد"})]})}),e.jsx(ie,{open:yt,onOpenChange:qe,children:e.jsxs(oe,{className:"sm:max-w-[480px]",children:[e.jsx(ce,{children:e.jsx(de,{className:"text-right",children:"اختيار مصدر خصم المصروف"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600 text-right",children:"اختر هل تريد خصم مبلغ المصروف من الرصيد النقدي في الدرج أم من إحدى المحافظ."}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsx(d,{variant:Ye==="cash"?"default":"outline",className:Ye==="cash"?"bg-blue-600 hover:bg-blue-700 text-white":"",onClick:()=>ut("cash"),children:"الفلوس النقدية"}),e.jsx(d,{variant:Ye==="wallet"?"default":"outline",className:Ye==="wallet"?"bg-purple-600 hover:bg-purple-700 text-white":"",onClick:()=>ut("wallet"),children:"أرصدة المحافظ"})]}),Ye==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{className:"text-right block",children:"اختر المحفظة للخصم"}),e.jsxs(ks,{value:Se,onValueChange:be,children:[e.jsx(As,{className:"w-full",children:e.jsx(Ps,{placeholder:"اختر محفظة"})}),e.jsx(Os,{children:ye.map(s=>e.jsx(Ht,{value:s.id,children:s.phone||s.name||s.id},s.id))})]})]})]}),e.jsxs(De,{className:"flex justify-between",children:[e.jsx(d,{variant:"outline",onClick:()=>{qe(!1),ut(null),be("")},children:"إلغاء"}),e.jsx(d,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{const s=Number(K);if(isNaN(s)||s<=0){l({title:"قيمة غير صحيحة",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}if(!Ye){l({title:"اختر مصدر الخصم",description:"يرجى اختيار النقدية أو المحفظة",variant:"destructive"});return}try{if(Ye==="cash"){const i=Number((ze-s).toFixed(2));lt(i),localStorage.setItem(et(),i.toString());const c={cashBalance:i,lastUpdated:new Date().toISOString()},g=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(g,JSON.stringify(c)),t!=null&&t.uid?(await we.updateUserData(t.uid,c),localStorage.removeItem(g),ge(!1)):ge(!0)}else if(Ye==="wallet"){if(!Se){l({title:"اختر محفظة",description:"يرجى اختيار محفظة للخصم",variant:"destructive"});return}const i=ve[Se]||0,c=Number((i-s).toFixed(2)),g={...ve,[Se]:c};Je(g);const f=new Date().toISOString(),N={walletBalances:g,lastUpdated:f},E=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(E,JSON.stringify(N)),localStorage.setItem(Xe(),JSON.stringify(g)),localStorage.setItem(`walletBalances_backup_${f}`,JSON.stringify(g)),t!=null&&t.uid&&await we.updateUserData(t.uid,N)}}catch(i){console.error("خطأ أثناء تحديث الأرصدة عند حفظ المصروف:",i)}const a={id:Date.now().toString(),name:X,amount:s,notes:ke,source:Ye,walletId:Ye==="wallet"?Se:void 0,createdAt:new Date},n=[...vt,a];await ko(n),Te(""),re(""),at(""),ut(null),be(""),qe(!1),ae(!0),F(!0),l({title:"تم إضافة المصروف",description:Ye==="cash"?"تم الخصم من النقدية":"تم الخصم من أرصدة المحافظ"})},children:"تأكيد الخصم"})]})]})}),e.jsx(ie,{open:Ce,onOpenChange:Re,children:e.jsxs(oe,{className:"sm:max-w-[520px]",children:[e.jsxs(ce,{children:[e.jsx(de,{className:"text-right",children:"النواقص"}),e.jsx(Mt,{className:"text-right",children:"سجل العناصر الناقصة التي تحتاج شراء وتابع حالتها."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(V,{htmlFor:"deficiencyName",className:"text-right col-span-1",children:"اسم العنصر"}),e.jsx(R,{id:"deficiencyName",value:Lt,onChange:s=>bt(s.target.value),className:"col-span-3 text-right",placeholder:"مثال: سكر، زيت، مناديل"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(V,{htmlFor:"deficiencyQuantity",className:"text-right col-span-1",children:"الكمية"}),e.jsx(R,{id:"deficiencyQuantity",type:"number",value:es,onChange:s=>Et(s.target.value),className:"col-span-3 text-right",placeholder:"1"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(d,{className:"bg-rose-600 hover:bg-rose-700",onClick:()=>{if(Ae){l({title:"غير متاح",description:"النواقص غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"});return}const s=parseInt(es||"1",10);if(!Lt){l({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم العنصر",variant:"destructive"});return}if(isNaN(s)||s<=0){l({title:"كمية غير صحيحة",description:"يرجى إدخال كمية صحيحة",variant:"destructive"});return}const a={id:Date.now().toString(),name:Lt,quantity:s,status:"pending",createdAt:new Date};Rt(n=>{const i=[...n,a];return Hr(i),i}),bt(""),Et(""),l({title:"تمت الإضافة",description:"تمت إضافة العنصر إلى قائمة النواقص"})},children:"إضافة للنواقص"})}),gs.length>0?e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:gs.map(s=>e.jsx("div",{className:"p-2 border rounded-lg bg-white hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium text-sm",children:s.name}),e.jsxs("p",{className:"text-[11px] text-gray-600",children:["الكمية: ",s.quantity]}),e.jsx("p",{className:"text-[10px] text-gray-500",children:new Date(s.createdAt).toLocaleString("ar-EG")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(dt,{variant:"secondary",className:s.status==="pending"?"bg-rose-100 text-rose-700":"bg-green-100 text-green-700",children:s.status==="pending"?"قيد الشراء":"تم الشراء"}),e.jsx(d,{variant:"outline",className:s.status==="pending"?"text-green-700 border-green-300 hover:bg-green-50":"text-rose-700 border-rose-300 hover:bg-rose-50",onClick:()=>{Rt(a=>{const n=a.map(i=>i.id===s.id?{...i,status:i.status==="pending"?"purchased":"pending"}:i);return Hr(n),n})},title:s.status==="pending"?"تم الشراء":"إلغاء الشراء",children:s.status==="pending"?"تم الشراء":"إلغاء الشراء"}),e.jsx(d,{variant:"outline",className:"text-red-700 border-red-300 hover:bg-red-50",onClick:()=>{Rt(a=>{const n=a.filter(i=>i.id!==s.id);return Hr(n),n})},title:"حذف",children:"حذف"})]})]})},s.id))}):e.jsx("p",{className:"text-sm text-gray-500 text-center",children:"لا توجد عناصر مسجلة في النواقص"})]}),e.jsx(De,{className:"flex justify-end",children:e.jsx(d,{variant:"outline",onClick:()=>Re(!1),children:"إغلاق"})})]})}),e.jsx(ie,{open:uo,onOpenChange:Ua,children:e.jsxs(oe,{className:"sm:max-w-[480px]",children:[e.jsx(ce,{children:e.jsx(de,{className:"text-right",children:"اختيار مصدر خصم الدين"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600 text-right",children:"اختر هل تريد خصم مبلغ الدين من الرصيد النقدي في الدرج أم من إحدى المحافظ أو تسجيله بدون خصم."}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsx(d,{variant:Ot==="cash"?"default":"outline",className:Ot==="cash"?"bg-blue-600 hover:bg-blue-700 text-white":"",onClick:()=>pa("cash"),children:"الفلوس النقدية"}),e.jsx(d,{variant:Ot==="wallet"?"default":"outline",className:Ot==="wallet"?"bg-purple-600 hover:bg-purple-700 text-white":"",onClick:()=>pa("wallet"),children:"أرصدة المحافظ"}),e.jsx(d,{variant:Ot==="none"?"default":"outline",className:Ot==="none"?"bg-gray-600 hover:bg-gray-700 text-white":"",onClick:()=>pa("none"),children:"بدون خصم"})]}),Ot==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{className:"text-right block",children:"اختر المحفظة للخصم"}),e.jsxs(ks,{value:_a,onValueChange:Ur,children:[e.jsx(As,{className:"w-full",children:e.jsx(Ps,{placeholder:"اختر محفظة"})}),e.jsx(Os,{children:ye.map(s=>e.jsx(Ht,{value:s.id,children:s.phone||s.name||s.id},s.id))})]})]})]}),e.jsxs(De,{className:"flex justify-between",children:[e.jsx(d,{variant:"outline",onClick:()=>{Ua(!1),$r(null),pa(null),Ur("")},children:"إلغاء"}),e.jsx(d,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{if(!Rr)return;const s=Number(Rr.amount);if(!Ot){l({title:"اختر مصدر الخصم",description:"يرجى اختيار النقدية أو المحفظة",variant:"destructive"});return}try{if(Ot==="cash"){const n=Number((ze-s).toFixed(2));lt(n),localStorage.setItem(et(),n.toString());const i=new Date().toISOString(),c={cashBalance:n,lastUpdated:i},g=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(g,JSON.stringify(c)),t!=null&&t.uid?await we.updateUserData(t.uid,c).then(()=>{localStorage.removeItem(g),ge(!1)}).catch(()=>{ge(!0)}):ge(!0)}else if(Ot==="wallet"){if(!_a){l({title:"اختر محفظة",description:"يرجى اختيار محفظة للخصم",variant:"destructive"});return}const n=ve[_a]||0,i=Number((n-s).toFixed(2)),c={...ve,[_a]:i};Je(c);const g=new Date().toISOString(),f={walletBalances:c,lastUpdated:g},N=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(N,JSON.stringify(f)),localStorage.setItem(Xe(),JSON.stringify(c)),localStorage.setItem(`walletBalances_backup_${g}`,JSON.stringify(c)),t!=null&&t.uid&&await we.updateUserData(t.uid,f)}}catch(n){console.error("خطأ أثناء تحديث الأرصدة عند حفظ الدين:",n)}const a=[...St,Rr];Jt(a),await ls(a),Vn(""),qn(""),Yn(""),$a(!1),Ua(!1),$r(null),pa(null),Ur(""),l(Ot==="none"?{title:"تم حفظ الدين بدون خصم",description:"لم يتم الخصم من الدرج أو المحافظ"}:{title:"تم حفظ الدين وخصم المبلغ",description:Ot==="cash"?`تم خصم ${s} من الرصيد النقدي`:`تم خصم ${s} من رصيد المحفظة`})},children:"تأكيد الخصم وحفظ الدين"})]})]})}),e.jsx(ie,{open:oo,onOpenChange:ua,children:e.jsxs(oe,{className:"sm:max-w-[425px] z-[60]",children:[e.jsx(ce,{children:e.jsx(de,{className:"text-right",children:"إيصال الدين"})}),xe&&e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"text-center border-b pb-4",children:[e.jsx("h2",{className:"text-xl font-bold",children:"إيصال دين"}),e.jsx("p",{className:"text-sm text-gray-500",children:dn.format(xe.createdAt instanceof Date?xe.createdAt:new Date(xe.createdAt))})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"اسم المديون:"}),e.jsx("span",{children:xe.debtorName})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"المبلغ:"}),e.jsxs("span",{className:"font-bold text-lg",children:[xe.amount," جنيه"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"سبب الدين:"}),e.jsx("span",{children:xe.reason})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"الحالة:"}),e.jsx(dt,{variant:xe.status==="paid"?"default":"secondary",className:xe.status==="paid"?"bg-green-500":"bg-yellow-500",children:xe.status==="paid"?"مدفوع":"مؤجل"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"المبلغ المتبقي:"}),e.jsxs("span",{className:"font-bold text-lg",children:[Math.max(0,Number(xe.amount||0)-Number(xe.paidAmount||0))," جنيه"]})]}),xe.paidAmount?e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"إجمالي المدفوع:"}),e.jsxs("span",{className:"text-green-700",children:[xe.paidAmount," جنيه"]})]}):null,e.jsxs("div",{className:"mt-3 p-3 border rounded-lg bg-gray-50",children:[co?e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"partialAmount",className:"text-right block",children:"المبلغ المراد دفعه"}),e.jsx(R,{id:"partialAmount",type:"number",value:Hn,onChange:s=>Wr(s.target.value),className:"text-right",placeholder:"أدخل المبلغ"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(d,{variant:"outline",onClick:()=>{Or(!1),Wr("")},children:"إلغاء"}),e.jsx(d,{className:"bg-blue-600 hover:bg-blue-700",onClick:async()=>{const s=parseFloat(Hn);if(!xe||isNaN(s)||s<=0){l({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const a=Math.max(0,Number(xe.amount||0)-Number(xe.paidAmount||0));if(s>a){l({title:"مبلغ زائد",description:"المبلغ المدفوع أكبر من المتبقي",variant:"destructive"});return}const n=Number(((xe.paidAmount||0)+s).toFixed(2)),i=n>=Number(xe.amount||0),c={...xe,amount:Number(xe.amount||0),paidAmount:n,status:i?"paid":"pending",partialPayments:[...xe.partialPayments||[],{amount:s,paidAt:new Date}]},g=St.map(f=>f.id===xe.id?c:f);Jt(g),Pr(c),await ls(g);try{c.status==="paid"&&(t!=null&&t.uid)&&(async()=>{const f=Ws(cs(it,"userTransactions"),kt("userId","==",t.uid),kt("linkedDebtId","==",xe.id),kt("status","==","pending")),N=await Fs(f);await Promise.allSettled(N.docs.map(E=>ta(E.ref,{status:"completed",confirmedAt:new Date})))})().catch(f=>console.error("تعذر تحديث حالة المعاملات المرتبطة بالدين:",f))}catch(f){console.error("تعذر تجهيز تحديث حالة المعاملات المرتبطة:",f)}try{const f=ga(),N=localStorage.getItem(f);if(N){const I=(JSON.parse(N)||[]).map(w=>(w==null?void 0:w.linkedDebtId)===xe.id&&(w==null?void 0:w.status)==="pending"?{...w,status:"completed",confirmedAt:new Date}:w);localStorage.setItem(f,JSON.stringify(I)),fs(w=>w.map(P=>(P==null?void 0:P.linkedDebtId)===xe.id&&(P==null?void 0:P.status)==="pending"?{...P,status:"completed",confirmedAt:new Date}:P))}}catch(f){console.warn("فشل تحديث حالة المعاملات المرتبطة محلياً بعد سداد الدين:",f)}za(s),Cs("cash"),qs(!0),Or(!1),Wr(""),l({title:"تم تسجيل دفع جزء",description:`تم دفع ${s} جنيه بتاريخ ${new Date().toLocaleString("ar-EG")}`})},children:"دفع"})]})]}):e.jsx(d,{variant:"outline",className:"w-full",onClick:()=>Or(!0),children:"دفع جزء"}),xe.partialPayments&&xe.partialPayments.length>0&&e.jsxs("div",{className:"mt-3 text-xs text-gray-600",children:[e.jsx("p",{className:"font-medium mb-1",children:"سجل الدفعات الجزئية:"}),e.jsx("div",{className:"space-y-1 max-h-24 overflow-y-auto",children:xe.partialPayments.map((s,a)=>e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{children:["دفع: ",s.amount," جنيه"]}),e.jsx("span",{children:new Date(s.paidAt).toLocaleString("ar-EG")})]},a))})]})]})]})]}),e.jsxs(De,{className:"flex gap-2 justify-center",children:[e.jsx(d,{onClick:async()=>{if(xe){const s=St.map(a=>a.id===xe.id?{...a,status:"pending"}:a);Jt(s),await ls(s),ua(!1),l({title:"تم تحديث حالة الدين",description:"تم تعيين الدين كمؤجل"})}},variant:"outline",className:"bg-yellow-500 hover:bg-yellow-600 text-white",children:"مؤجل"}),e.jsx(d,{onClick:async()=>{if(xe){const a=Math.max(0,Number(xe.amount||0)-Number(xe.paidAmount||0)),n=St.map(i=>i.id===xe.id?{...i,amount:Number(i.amount||0),paidAmount:Number(((i.paidAmount||0)+a).toFixed(2)),status:"paid",partialPayments:[...i.partialPayments||[],...a>0?[{amount:a,paidAt:new Date}]:[]]}:i);Jt(n),a>0&&(za(a),Cs("cash"),qs(!0)),await ls(n);try{t!=null&&t.uid&&(xe!=null&&xe.id)&&(async()=>{const i=Ws(cs(it,"userTransactions"),kt("userId","==",t.uid),kt("linkedDebtId","==",xe.id),kt("status","==","pending")),c=await Fs(i);await Promise.allSettled(c.docs.map(g=>ta(g.ref,{status:"completed",confirmedAt:new Date})))})().catch(i=>console.error("تعذر تحديث حالة المعاملات المرتبطة بالدين:",i))}catch(i){console.error("تعذر تجهيز تحديث حالة المعاملات المرتبطة:",i)}try{const i=ga(),c=localStorage.getItem(i);if(c){const f=(JSON.parse(c)||[]).map(N=>(N==null?void 0:N.linkedDebtId)===xe.id&&(N==null?void 0:N.status)==="pending"?{...N,status:"completed",confirmedAt:new Date}:N);localStorage.setItem(i,JSON.stringify(f)),fs(N=>N.map(E=>(E==null?void 0:E.linkedDebtId)===xe.id&&(E==null?void 0:E.status)==="pending"?{...E,status:"completed",confirmedAt:new Date}:E))}}catch(i){console.warn("فشل تحديث حالة المعاملات المرتبطة محلياً بعد سداد الدين:",i)}ua(!1),l({title:"تم تحديث حالة الدين",description:"تم تعيين الدين كمدفوع"})}},className:"bg-green-500 hover:bg-green-600",children:"مدفوع"}),e.jsx(d,{onClick:async()=>{if(xe){const s=St.filter(a=>a.id!==xe.id);Jt(s),await ls(s),ua(!1),l({title:"تم حذف الدين",description:"تم حذف الدين بنجاح"})}},variant:"destructive",children:"حذف"})]})]})}),e.jsx(ie,{open:xo,onOpenChange:qs,children:e.jsxs(oe,{className:"sm:max-w-[425px]",children:[e.jsxs(ce,{children:[e.jsx(de,{className:"text-right",children:"اختيار إضافة مبلغ السداد"}),e.jsx(Mt,{className:"text-right",children:"هل تريد إضافة مبلغ السداد إلى الفلوس النقدية أم إلى إحدى المحافظ؟"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(d,{variant:Vt==="cash"?"default":"outline",className:Vt==="cash"?"bg-blue-600 text-white":"",onClick:()=>Cs("cash"),children:"الفلوس النقدية"}),e.jsx(d,{variant:Vt==="wallet"?"default":"outline",className:Vt==="wallet"?"bg-blue-600 text-white":"",onClick:()=>Cs("wallet"),children:"أرصدة المحافظ"}),e.jsx(d,{variant:Vt==="none"?"default":"outline",className:Vt==="none"?"bg-gray-600 text-white":"",onClick:()=>Cs("none"),children:"بدون إضافة"})]}),Vt==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-right",children:"اختر المحفظة"}),e.jsxs("select",{className:"w-full border rounded p-2 text-right",value:Is,onChange:s=>_r(s.target.value),children:[e.jsx("option",{value:"",children:"— اختر محفظة —"}),ye&&ye.length>0?ye.map(s=>e.jsx("option",{value:s.id,children:s.phone||s.name||s.id},s.id)):Object.keys(ve||{}).map(s=>{var a,n,i,c,g,f;return e.jsx("option",{value:s,children:((a=ye.find(N=>N.id===s))==null?void 0:a.phone)||((i=(n=JSON.parse(localStorage.getItem(Ys())||"[]"))==null?void 0:n.find(N=>N.id===s))==null?void 0:i.phone)||((g=(c=JSON.parse(localStorage.getItem(Ys())||"[]"))==null?void 0:c.find(N=>N.id===s))==null?void 0:g.name)||((f=ye.find(N=>N.id===s))==null?void 0:f.name)||s},s)})]})]}),e.jsxs("div",{className:"text-right text-sm text-gray-600",children:["المبلغ المراد إضافته: ",e.jsxs("span",{className:"font-bold",children:[tl," جنيه"]})]})]}),e.jsxs(De,{className:"flex justify-end",children:[e.jsx(d,{variant:"outline",onClick:()=>{qs(!1),za(0),Cs(null),_r("")},children:"إلغاء"}),e.jsx(d,{onClick:async()=>{var s,a;try{const n=tl;if(!n||n<=0){qs(!1);return}if(Vt==="cash"){const i=ze+n;lt(i),localStorage.setItem(et(),i.toString());const c={cashBalance:i,lastUpdated:new Date().toISOString()},g=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(g,JSON.stringify(c)),t!=null&&t.uid?(we.updateUserData(t.uid,c).catch(()=>ge(!0)),localStorage.removeItem(g),ge(!1)):ge(!0),l({title:"تمت إضافة مبلغ السداد",description:`تمت إضافة ${n} جنيه إلى الفلوس النقدية`})}else if(Vt==="wallet"){if(!Is){l({title:"اختر محفظة أولاً",description:"يرجى اختيار المحفظة لإضافة مبلغ السداد إليها",variant:"destructive"});return}const i={...ve,[Is]:(ve[Is]||0)+n};Je(i);const c=(ze||0)-n;lt(c),localStorage.setItem(et(),c.toString());const g=new Date().toISOString(),f={walletBalances:i,cashBalance:c,lastUpdated:g},N=`userData_${t==null?void 0:t.uid}`;if(localStorage.setItem(N,JSON.stringify(f)),localStorage.setItem(Xe(),JSON.stringify(i)),localStorage.setItem(`walletBalances_backup_${g}`,JSON.stringify(i)),t!=null&&t.uid){we.updateUserData(t.uid,f).catch(()=>ge(!0));try{localStorage.removeItem(N)}catch{}ge(!1)}else ge(!0);l({title:"تمت إضافة مبلغ السداد",description:`تمت إضافة ${n} جنيه إلى المحفظة ${((s=ye.find(E=>E.id===Is))==null?void 0:s.phone)||((a=ye.find(E=>E.id===Is))==null?void 0:a.name)||Is} وتم خصم نفس المبلغ من درج النقدية`})}else if(Vt==="none"){const i=(ze||0)-n;lt(i),localStorage.setItem(et(),i.toString());const c={cashBalance:i,lastUpdated:new Date().toISOString()},g=`userData_${t==null?void 0:t.uid}`;if(localStorage.setItem(g,JSON.stringify(c)),t!=null&&t.uid){we.updateUserData(t.uid,c).catch(()=>ge(!0));try{localStorage.removeItem(g)}catch{}ge(!1)}else ge(!0);l({title:"تم تسجيل السداد",description:`تم خصم ${n} جنيه من درج النقدية بدون إضافة للمحافظ`})}else{l({title:"اختر مصدر الإضافة",description:"يرجى اختيار إضافة المبلغ إلى النقدية أو المحفظة",variant:"destructive"});return}}catch(n){console.error("خطأ أثناء إضافة مبلغ السداد:",n),l({title:"حدث خطأ",description:"تعذر إضافة مبلغ السداد، حاول مرة أخرى",variant:"destructive"})}finally{qs(!1),za(0),Cs(null),_r("")}},className:"bg-green-600 hover:bg-green-700",children:"تأكيد الإضافة"})]})]})}),e.jsx(ie,{open:Hi,onOpenChange:Fa,children:e.jsxs(oe,{hideClose:!0,className:"sm:max-w-[420px] w-[90vw] rounded-2xl bg-gradient-to-br from-white via-indigo-50 to-blue-50 shadow-2xl border border-indigo-100",children:[e.jsxs(ce,{children:[e.jsx(de,{className:"text-right text-2xl font-bold",children:(wt==null?void 0:wt.type)==="transfer"?"مبلغ يجب استلامه":"مبلغ يجب تسليمه"}),e.jsx(Mt,{className:"text-right text-gray-600",children:(wt==null?void 0:wt.type)==="transfer"?"هذا هو المبلغ الواجب استلامه من العميل بعد التأكيد.":"هذا هو المبلغ الواجب تسليمه للعميل بعد التأكيد."})]}),e.jsxs("div",{className:"py-4 flex flex-col items-center gap-2",children:[e.jsxs("div",{className:"text-4xl font-extrabold text-blue-700 tracking-wider",children:[wt==null?void 0:wt.amount," جنيه"]}),e.jsx("div",{className:"text-sm text-gray-500 text-right w-full",children:(wt==null?void 0:wt.type)==="transfer"?"المبلغ المعروض شامل عمولة التحويل.":Ie?"العمولة مضافة ولا تؤثر على قيمة التسليم.":"العمولة مخصومة من المبلغ المسلّم للعميل."})]}),e.jsx(De,{className:"flex justify-end gap-2",children:e.jsx(d,{onClick:()=>{Fa(!1),Dr(null)},className:"bg-green-600 hover:bg-green-700 text-white",children:(wt==null?void 0:wt.type)==="transfer"?"تم الاستلام":"تم التسليم"})})]})})]}))};export{Jm as default};
