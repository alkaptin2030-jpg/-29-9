import{J as Y,r as c,j as s,a1 as lt,a3 as we,a7 as dt,a_ as le,Y as ge,u as xe,c as Ee,I as ee,B as S,E as te,p as se,aB as ut,aC as ft,b3 as mt,b4 as Ae,b5 as ht,ay as H,ao as de,b6 as ue,ad as pt,a as wt,ab as gt,M as xt,ai as yt,ae as vt,d as $,_ as jt,q as St,e as Ce,f as Ie,an as kt,w as bt,C as Nt,k as Pt,s as At}from"./index-B6U9UJBf.js";import{L as Ct,D as fe,a as me,b as he,c as pe,d as W,e as R}from"./dropdown-menu-CTKDy3Fy.js";import{D as Le,a as Re,b as _e,c as Me,e as Oe,d as Be,f as It}from"./dialog-DYxeSMlS.js";import{L as ae}from"./label-CYlIvCqy.js";import{M as Dt}from"./MasterPinDialog-DQ3Gc3ql.js";import{g as Tt}from"./avatars-Dgv5SA6_.js";import{R as Et}from"./refresh-cw-Cp6_8OTE.js";import{S as Lt}from"./shield-Dvikdag6.js";import{a as Rt,E as _t}from"./broadcastService-W6HQEAKz.js";import{B as De,T as Mt}from"./textarea-B4Hku7fb.js";import{C as re}from"./circle-check-big-DNZxnolB.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Cs=Y("Activity",[["path",{d:"M22 12h-2.48a2 2 0 0 0-1.93 1.46l-2.35 8.36a.25.25 0 0 1-.48 0L9.24 2.18a.25.25 0 0 0-.48 0l-2.35 8.36A2 2 0 0 1 4.49 12H2",key:"169zse"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ot=Y("CloudUpload",[["path",{d:"M12 13v8",key:"1l5pq0"}],["path",{d:"M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242",key:"1pljnt"}],["path",{d:"m8 17 4-4 4 4",key:"1quai1"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Bt=Y("Cloud",[["path",{d:"M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z",key:"p7xjir"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ft=Y("LogIn",[["path",{d:"M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4",key:"u53s6r"}],["polyline",{points:"10 17 15 12 10 7",key:"1ail0h"}],["line",{x1:"15",x2:"3",y1:"12",y2:"12",key:"v6grx8"}]]);var Fe={exports:{}},Ue={};/**
 * @license React
 * use-sync-external-store-shim.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var F=c;function Ut(a,t){return a===t&&(a!==0||1/a===1/t)||a!==a&&t!==t}var Gt=typeof Object.is=="function"?Object.is:Ut,$t=F.useState,zt=F.useEffect,qt=F.useLayoutEffect,Wt=F.useDebugValue;function Jt(a,t){var e=t(),o=$t({inst:{value:e,getSnapshot:t}}),r=o[0].inst,n=o[1];return qt(function(){r.value=e,r.getSnapshot=t,ne(r)&&n({inst:r})},[a,e,t]),zt(function(){return ne(r)&&n({inst:r}),a(function(){ne(r)&&n({inst:r})})},[a]),Wt(e),e}function ne(a){var t=a.getSnapshot;a=a.value;try{var e=t();return!Gt(a,e)}catch{return!0}}function Kt(a,t){return t()}var Qt=typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"?Kt:Jt;Ue.useSyncExternalStore=F.useSyncExternalStore!==void 0?F.useSyncExternalStore:Qt;Fe.exports=Ue;var Vt=Fe.exports;function Ht(){return Vt.useSyncExternalStore(Yt,()=>!0,()=>!1)}function Yt(){return()=>{}}var ye="Avatar",[Xt]=lt(ye),[Zt,Ge]=Xt(ye),$e=c.forwardRef((a,t)=>{const{__scopeAvatar:e,...o}=a,[r,n]=c.useState("idle");return s.jsx(Zt,{scope:e,imageLoadingStatus:r,onImageLoadingStatusChange:n,children:s.jsx(we.span,{...o,ref:t})})});$e.displayName=ye;var ze="AvatarImage",qe=c.forwardRef((a,t)=>{const{__scopeAvatar:e,src:o,onLoadingStatusChange:r=()=>{},...n}=a,l=Ge(ze,e),i=es(o,n),d=dt(h=>{r(h),l.onImageLoadingStatusChange(h)});return le(()=>{i!=="idle"&&d(i)},[i,d]),i==="loaded"?s.jsx(we.img,{...n,ref:t,src:o}):null});qe.displayName=ze;var We="AvatarFallback",Je=c.forwardRef((a,t)=>{const{__scopeAvatar:e,delayMs:o,...r}=a,n=Ge(We,e),[l,i]=c.useState(o===void 0);return c.useEffect(()=>{if(o!==void 0){const d=window.setTimeout(()=>i(!0),o);return()=>window.clearTimeout(d)}},[o]),l&&n.imageLoadingStatus!=="loaded"?s.jsx(we.span,{...r,ref:t}):null});Je.displayName=We;function Te(a,t){return a?t?(a.src!==t&&(a.src=t),a.complete&&a.naturalWidth>0?"loaded":"loading"):"error":"idle"}function es(a,{referrerPolicy:t,crossOrigin:e}){const o=Ht(),r=c.useRef(null),n=o?(r.current||(r.current=new window.Image),r.current):null,[l,i]=c.useState(()=>Te(n,a));return le(()=>{i(Te(n,a))},[n,a]),le(()=>{const d=N=>()=>{i(N)};if(!n)return;const h=d("loaded"),k=d("error");return n.addEventListener("load",h),n.addEventListener("error",k),t&&(n.referrerPolicy=t),typeof e=="string"&&(n.crossOrigin=e),()=>{n.removeEventListener("load",h),n.removeEventListener("error",k)}},[n,e,t]),l}var Ke=$e,Qe=qe,Ve=Je;const He=c.forwardRef(({className:a,...t},e)=>s.jsx(Ke,{ref:e,className:ge("relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",a),...t}));He.displayName=Ke.displayName;const Ye=c.forwardRef(({className:a,...t},e)=>s.jsx(Qe,{ref:e,className:ge("aspect-square h-full w-full",a),...t}));Ye.displayName=Qe.displayName;const Xe=c.forwardRef(({className:a,...t},e)=>s.jsx(Ve,{ref:e,className:ge("flex h-full w-full items-center justify-center rounded-full bg-muted",a),...t}));Xe.displayName=Ve.displayName;function ts({open:a,onOpenChange:t}){const{user:e}=xe(),{toast:o}=Ee(),[r,n]=c.useState(!1),[l,i]=c.useState(!1),[d,h]=c.useState(!1),[k,N]=c.useState(!1),[D,x]=c.useState(!1),[E,P]=c.useState(!1),[y,b]=c.useState({currentPassword:"",newPassword:"",confirmPassword:""}),[v,A]=c.useState({currentPassword:"",newPassword:"",confirmPassword:""}),J=()=>{const f={currentPassword:"",newPassword:"",confirmPassword:""};return y.currentPassword||(f.currentPassword="كلمة المرور الحالية مطلوبة"),y.newPassword?y.newPassword.length<6&&(f.newPassword="كلمة المرور يجب أن تكون 6 أحرف على الأقل"):f.newPassword="كلمة المرور الجديدة مطلوبة",y.confirmPassword?y.newPassword!==y.confirmPassword&&(f.confirmPassword="كلمات المرور غير متطابقة"):f.confirmPassword="تأكيد كلمة المرور مطلوب",A(f),!Object.values(f).some(w=>w!=="")},U=async f=>{if(f.preventDefault(),!(!J()||!e||!e.email)){n(!0);try{const w=ut.credential(e.email,y.currentPassword);await ft(e,w),P(!0),x(!0),o({title:"تأكيد الهوية",description:"أدخل الرقم السري الرئيسي لتأكيد تغيير كلمة المرور"})}catch(w){console.error("خطأ في تغيير كلمة المرور:",w);let p="حدث خطأ أثناء تغيير كلمة المرور";if(w.code==="auth/wrong-password"){A(j=>({...j,currentPassword:"كلمة المرور الحالية غير صحيحة"}));return}else if(w.code==="auth/weak-password"){A(j=>({...j,newPassword:"كلمة المرور ضعيفة جداً"}));return}else w.code==="auth/requires-recent-login"&&(p="يجب تسجيل الدخول مرة أخرى لتغيير كلمة المرور");o({title:"خطأ في تغيير كلمة المرور",description:p,variant:"destructive"})}finally{n(!1)}}},K=async()=>{if(e){n(!0);try{await mt(e,y.newPassword),o({title:"تم تغيير كلمة المرور بنجاح",description:"تم تحديث كلمة المرور الخاصة بك بنجاح"}),b({currentPassword:"",newPassword:"",confirmPassword:""}),A({currentPassword:"",newPassword:"",confirmPassword:""}),x(!1),P(!1),t(!1)}catch(f){console.error("خطأ في تحديث كلمة المرور:",f);let w="حدث خطأ أثناء تغيير كلمة المرور";f.code==="auth/requires-recent-login"&&(w="انتهت جلسة المصادقة. يرجى إعادة إدخال كلمة المرور الحالية"),o({title:"خطأ في تغيير كلمة المرور",description:w,variant:"destructive"})}finally{n(!1)}}},L=f=>w=>{b(p=>({...p,[f]:w.target.value})),v[f]&&A(p=>({...p,[f]:""}))},g=()=>{b({currentPassword:"",newPassword:"",confirmPassword:""}),A({currentPassword:"",newPassword:"",confirmPassword:""}),x(!1),P(!1),t(!1)};return s.jsxs(s.Fragment,{children:[s.jsx(Le,{open:a,onOpenChange:g,children:s.jsxs(Re,{className:"sm:max-w-[425px]",children:[s.jsxs(_e,{children:[s.jsx(Me,{children:"تغيير كلمة المرور"}),s.jsx(Oe,{children:"أدخل كلمة المرور الحالية وكلمة المرور الجديدة لتحديث حسابك"})]}),s.jsxs("form",{onSubmit:U,className:"space-y-4",children:[s.jsxs("div",{className:"space-y-2",children:[s.jsx(ae,{htmlFor:"currentPassword",children:"كلمة المرور الحالية"}),s.jsxs("div",{className:"relative",children:[s.jsx(ee,{id:"currentPassword",type:l?"text":"password",value:y.currentPassword,onChange:L("currentPassword"),className:v.currentPassword?"border-red-500":"",autoComplete:"off",disabled:r}),s.jsx(S,{type:"button",variant:"ghost",size:"sm",className:"absolute right-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>i(!l),disabled:r,children:l?s.jsx(te,{className:"h-4 w-4"}):s.jsx(se,{className:"h-4 w-4"})})]}),v.currentPassword&&s.jsx("p",{className:"text-sm text-red-500",children:v.currentPassword})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(ae,{htmlFor:"newPassword",children:"كلمة المرور الجديدة"}),s.jsxs("div",{className:"relative",children:[s.jsx(ee,{id:"newPassword",type:d?"text":"password",value:y.newPassword,onChange:L("newPassword"),className:v.newPassword?"border-red-500":"",autoComplete:"new-password",disabled:r}),s.jsx(S,{type:"button",variant:"ghost",size:"sm",className:"absolute right-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>h(!d),disabled:r,children:d?s.jsx(te,{className:"h-4 w-4"}):s.jsx(se,{className:"h-4 w-4"})})]}),v.newPassword&&s.jsx("p",{className:"text-sm text-red-500",children:v.newPassword})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(ae,{htmlFor:"confirmPassword",children:"تأكيد كلمة المرور الجديدة"}),s.jsxs("div",{className:"relative",children:[s.jsx(ee,{id:"confirmPassword",type:k?"text":"password",value:y.confirmPassword,onChange:L("confirmPassword"),className:v.confirmPassword?"border-red-500":"",autoComplete:"new-password",disabled:r}),s.jsx(S,{type:"button",variant:"ghost",size:"sm",className:"absolute right-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>N(!k),disabled:r,children:k?s.jsx(te,{className:"h-4 w-4"}):s.jsx(se,{className:"h-4 w-4"})})]}),v.confirmPassword&&s.jsx("p",{className:"text-sm text-red-500",children:v.confirmPassword})]}),s.jsxs(Be,{children:[s.jsx(S,{type:"button",variant:"outline",onClick:g,disabled:r,children:"إلغاء"}),s.jsxs(S,{type:"submit",disabled:r,children:[r&&s.jsx(Ct,{className:"mr-2 h-4 w-4 animate-spin"}),"تغيير كلمة المرور"]})]})]})]})}),s.jsx(Dt,{open:D&&E,onOpenChange:f=>{x(f),f||P(!1)},mode:"verify",title:"التحقق من الرقم السري الرئيسي",description:"لا يمكن تغيير كلمة المرور إلا بعد التحقق من الرقم السري الرئيسي",onSuccess:K,onCancel:()=>{x(!1),P(!1)}})]})}const Ze="cashy.google.accessToken",et="cashy.google.email",tt="cashy.google.expiresAt";function st(a,t,e){try{localStorage.setItem(Ze,a),t&&localStorage.setItem(et,t);const o=e??Math.floor(Date.now()/1e3)+3500;localStorage.setItem(tt,String(o))}catch{}}function I(){try{const a=localStorage.getItem(Ze),t=localStorage.getItem(et),e=localStorage.getItem(tt),o=e?Number(e):null;return{token:a,email:t,expiresAt:o}}catch{return{token:null,email:null,expiresAt:null}}}function at(){const{token:a,expiresAt:t}=I();return a?t?Math.floor(Date.now()/1e3)<t-30:!0:!1}async function z(a){var t;try{const e=new Ae;e.addScope("https://www.googleapis.com/auth/drive.file"),e.addScope("https://www.googleapis.com/auth/userinfo.email"),e.setCustomParameters({prompt:"consent",access_type:"offline",include_granted_scopes:"true"});const o=await ht(a,e),r=Ae.credentialFromResult(o),n=(r==null?void 0:r.accessToken)||null,l=((t=o.user)==null?void 0:t.email)||void 0;return n?(st(n,l),{ok:!0,email:l}):{ok:!1,error:"تعذر الحصول على توكن الوصول من جوجل"}}catch(e){return{ok:!1,error:(e==null?void 0:e.message)||"فشل تسجيل الدخول بجوجل"}}}function ss(){return new Promise((a,t)=>{var o,r;if((r=(o=window.google)==null?void 0:o.accounts)!=null&&r.oauth2){a();return}const e=document.createElement("script");e.src="https://accounts.google.com/gsi/client",e.async=!0,e.onload=()=>a(),e.onerror=()=>t(new Error("فشل تحميل مكتبة Google Identity Services")),document.head.appendChild(e)})}async function q(a){var t;try{await ss();const e=window.google;if(!((t=e==null?void 0:e.accounts)!=null&&t.oauth2))return{ok:!1,error:"مكتبة Google غير متاحة"};const o="https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.email",n=await new Promise((i,d)=>{const h=e.accounts.oauth2.initTokenClient({client_id:a,scope:o,callback:x=>{x!=null&&x.access_token?i(String(x.access_token)):d(new Error("تعذر الحصول على access token"))},prompt:"consent"});try{h.requestAccessToken({prompt:"consent"})}catch(x){d(x)}const N=setTimeout(()=>{d(new Error("انتهت المهلة أثناء طلب رمز الوصول من جوجل"))},12e3),D=x=>E=>{clearTimeout(N),x(E)};i=D(i),d=D(d)});let l;try{const d=await(await fetch("https://www.googleapis.com/oauth2/v3/userinfo",{headers:{Authorization:`Bearer ${n}`}})).json().catch(()=>({}));d!=null&&d.email&&(l=String(d.email))}catch{}return st(n,l),{ok:!0,email:l}}catch(e){return{ok:!1,error:(e==null?void 0:e.message)||"فشل تسجيل الدخول بجوجل"}}}async function oe(a){try{return!!window.open("https://cashy.link/api/google/oauth2/start","cashy_google_oauth","width=600,height=650,menubar=no,toolbar=no")}catch{return!1}}async function ie(a,t=2e4,e=1500){const o=Date.now();for(;Date.now()-o<t;){const r=await as(a);if(r&&r.refresh_token)return!0;await new Promise(n=>setTimeout(n,e))}return!1}async function as(a){try{const t=new AbortController,e=setTimeout(()=>t.abort(),6e3),o=await fetch("https://cashy.link/api/google/oauth2/token",{method:"GET",headers:{"Content-Type":"application/json",...a?{"X-USER-ID":a}:{}},credentials:"include",signal:t.signal}).finally(()=>clearTimeout(e)),r=await o.json().catch(()=>({}));if(o.ok&&(r!=null&&r.ok)&&(r!=null&&r.refresh_token)&&(r!=null&&r.email))return{refresh_token:String(r.refresh_token),email:String(r.email)}}catch{}for(const t of["/api/google/oauth2/token","/user/google-backup-token"])try{const e=new AbortController,o=setTimeout(()=>e.abort(),5e3),r=await fetch(t,{method:"GET",headers:{"Content-Type":"application/json",...a?{"X-USER-ID":a}:{}},signal:e.signal}).finally(()=>clearTimeout(o)),n=await r.json().catch(()=>({}));if(r.ok&&(n!=null&&n.ok)&&(n!=null&&n.refresh_token)&&(n!=null&&n.email))return{refresh_token:String(n.refresh_token),email:String(n.email)}}catch{}return null}async function rt(a){const t={Authorization:`Bearer ${a}`},o=`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent("name='Cashy Backup' and mimeType='application/vnd.google-apps.folder' and trashed=false")}&fields=files(id,name)`,n=await(await fetch(o,{headers:t})).json().catch(()=>({})),l=Array.isArray(n==null?void 0:n.files)?n.files[0]:null;if(l!=null&&l.id)return String(l.id);const d=await(await fetch("https://www.googleapis.com/drive/v3/files",{method:"POST",headers:{...t,"Content-Type":"application/json"},body:JSON.stringify({name:"Cashy Backup",mimeType:"application/vnd.google-apps.folder"})})).json().catch(()=>({}));return d!=null&&d.id?String(d.id):null}async function rs(a,t){const e={Authorization:`Bearer ${a}`},r=`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(`'${t}' in parents and trashed=false`)}&orderBy=modifiedTime desc&fields=files(id,name,modifiedTime,createdTime)`,l=await(await fetch(r,{headers:e})).json().catch(()=>({})),i=Array.isArray(l==null?void 0:l.files)?l.files[0]:null;return i!=null&&i.id?{id:String(i.id),name:String(i.name)}:null}async function ns(a,t,e,o){const r={name:e,parents:[t]},n="foo_bar_baz_"+Math.random().toString(16).slice(2),l=`\r
--${n}\r
`,i=`\r
--${n}--`,d=l+`Content-Type: application/json; charset=UTF-8\r
\r
`+JSON.stringify(r)+l+`Content-Type: application/json\r
\r
`+JSON.stringify(o)+i;return(await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart",{method:"POST",headers:{Authorization:`Bearer ${a}`,"Content-Type":`multipart/related; boundary=${n}`},body:d})).ok}async function os(a,t){const e=`https://www.googleapis.com/drive/v3/files/${t}?alt=media`,o=await fetch(e,{headers:{Authorization:`Bearer ${a}`}});if(!o.ok)return null;const r=await o.text();try{return JSON.parse(r)}catch{return null}}function ce(){const a={};try{for(let t=0;t<localStorage.length;t++){const e=localStorage.key(t);if(!e)continue;const o=localStorage.getItem(e);a[e]=o}}catch{}return{platform:pt.getPlatform(),ts:new Date().toISOString(),localStorage:a}}function is(a){try{const t=a==null?void 0:a.localStorage;if(t&&typeof t=="object"){for(const[e,o]of Object.entries(t))localStorage.setItem(String(e),String(o??""));return!0}}catch{}return!1}async function cs(a){if(!at())return{ok:!1,error:"يرجى تسجيل الدخول بجوجل أولاً"};const t=I().token,e=await rt(t);if(!e)return{ok:!1,error:"فشل إنشاء/إيجاد مجلد التطبيق"};const o=await fs(a),r=`cashy-backup-${new Date().toISOString().replace(/[.:]/g,"-")}.json`;return await ns(t,e,r,o)?{ok:!0}:{ok:!1,error:"فشل رفع الملف"}}async function ls(a){if(!at())return{ok:!1,error:"يرجى تسجيل الدخول بجوجل أولاً"};const t=I().token,e=await rt(t);if(!e)return{ok:!1,error:"فشل إيجاد مجلد التطبيق"};const o=await rs(t,e);if(!(o!=null&&o.id))return{ok:!1,error:"لا توجد نسخة احتياطية"};const r=await os(t,o.id);if(!r)return{ok:!1,error:"فشل تنزيل النسخة"};const n=is(r),l=await hs(a,r);return n&&l?{ok:!0}:{ok:!1,error:"فشل الاسترجاع"}}async function ds(a,t,e){try{const o=await fetch("/user/google-backup-token",{method:"POST",headers:{"Content-Type":"application/json","X-USER-ID":a},body:JSON.stringify({email:t,refresh_token:e})}),r=await o.json().catch(()=>({}));return!!(o.ok&&(r!=null&&r.ok))}catch{return!1}}function us(a){return a instanceof Date?a.toISOString():a}function O(a){if(a==null)return a;if(Array.isArray(a))return a.map(O);if(typeof a=="object"){const t={};for(const[e,o]of Object.entries(a))o instanceof Date?t[e]=us(o):t[e]=O(o);return t}return a}async function fs(a){if(!a)return{version:2,ts:new Date().toISOString(),userId:null,local:ce()};try{const[t,e,o,r]=await Promise.all([H.getUserData(a),de.getByMerchantId(a),H.getUserTransactions(a),ue.getByUser(a,500)]);return{version:2,ts:new Date().toISOString(),userId:a,local:ce(),firestore:{userData:O(t),wallets:O(e),userTransactions:O(o),dailyReportsArchive:O(r)}}}catch{return{version:2,ts:new Date().toISOString(),userId:a,local:ce(),firestore:null,error:"تعذر جمع بعض بيانات Firestore"}}}function ms(a){if(typeof a=="string"){const t=new Date(a);if(!isNaN(t.getTime()))return t}return a}function B(a){if(a==null)return a;if(Array.isArray(a))return a.map(B);if(typeof a=="object"){const t={};for(const[e,o]of Object.entries(a))t[e]=o instanceof Date?o:ms(B(o));return t}return a}async function hs(a,t){try{if(!a)return!1;const e=t==null?void 0:t.firestore;if(!(e&&typeof e=="object"))return!0;if(e.userData){const r=B(e.userData);try{await H.saveUserData(a,r)}catch{}}if(Array.isArray(e.wallets))try{const r=await de.getByMerchantId(a),n=new Set(r.map(l=>`${l.provider}|${l.msisdn}`));for(const l of e.wallets){const i=B(l),d=`${i.provider}|${i.msisdn}`;n.has(d)||await de.create({merchantUserId:a,provider:i.provider,msisdn:i.msisdn,label:i.label??void 0,isActive:i.isActive??!0,dailyLimit:Number(i.dailyLimit??0),monthlyLimit:Number(i.monthlyLimit??0),transferLimit:Number(i.transferLimit??2e5),withdrawLimit:Number(i.withdrawLimit??2e5),transferUsage:Number(i.transferUsage??0),withdrawUsage:Number(i.withdrawUsage??0),dailyTransferLimit:i.dailyTransferLimit??void 0,dailyWithdrawLimit:i.dailyWithdrawLimit??void 0,defaultTransferCommission:i.defaultTransferCommission??null,defaultWithdrawCommission:i.defaultWithdrawCommission??null})}}catch{}if(Array.isArray(e.userTransactions))try{for(const r of e.userTransactions){const n=B(r);await H.saveUserTransaction(a,n)}}catch{}if(Array.isArray(e.dailyReportsArchive))try{const r=await ue.getByUser(a,1e3),n=new Set(r.map(l=>`${l.reportDate}|${l.walletId??"null"}`));for(const l of e.dailyReportsArchive){const i=B(l),d=`${i.reportDate}|${i.walletId??"null"}`;n.has(d)||await ue.add({userId:a,reportDate:String(i.reportDate),totalTransactions:Number(i.totalTransactions||0),totalAmount:Number(i.totalAmount||0),totalWithdrawn:Number(i.totalWithdrawn||0),totalSent:Number(i.totalSent||0),profit:i.profit!==void 0?Number(i.profit):void 0,walletId:i.walletId??null})}}catch{}return!0}catch{return!1}}function Is({className:a}){const{user:t,profile:e,signOut:o,updateUserProfile:r}=xe(),n=wt(),[l,i]=c.useState(!1),{isShiftActive:d}=gt(),{toast:h}=Ee(),[k,N]=c.useState(!1),[D,x]=c.useState(!1),[E,P]=c.useState(!1),[{token:y},b]=c.useState(()=>I()),v=()=>e!=null&&e.fullName?e==null?void 0:e.fullName.split(" ").map(g=>g.charAt(0)).join("").toUpperCase().slice(0,2):t.email?t.email.charAt(0).toUpperCase():"U",A=e!=null&&e.avatarId?Tt(e.avatarId):null;if(c.useEffect(()=>{console.log("Profile updated in ProfileIcon:",e==null?void 0:e.avatarId)},[e==null?void 0:e.avatarId]),c.useEffect(()=>{const g=async f=>{try{if(!(f!=null&&f.data)||typeof f.data!="object"||f.origin!=="https://cashy.link")return;const{type:w,email:p,refresh_token:j}=f.data||{};w==="cashy_oauth_token"&&(t!=null&&t.uid)&&p&&j&&await ds(t.uid,String(p),String(j))&&h({title:"تم ربط جوجل",description:"تم حفظ توكن النسخ الاحتياطي عبر الخادم."})}catch{}};return window.addEventListener("message",g),()=>window.removeEventListener("message",g)},[t==null?void 0:t.uid]),!t)return null;const J=async()=>{try{await o(),n("/user/login",{replace:!0})}catch(g){console.error("خطأ في تسجيل الخروج:",g);try{n("/user/login",{replace:!0})}catch{}}},U=async()=>{if(t!=null&&t.uid)try{if(N(!0),!y)if(await oe()){if(!await ie(t.uid,2e4,1500)){const p=await q("483702062341-bhdprmoot8rto79jmjvkijdl7pbz28b.apps.googleusercontent.com");if(!p.ok){const j=await z($);if(!j.ok){h({title:"فشل تسجيل الدخول",description:j.error||p.error||"يرجى التسجيل بجوجل أولاً.",variant:"destructive"});return}}b(I())}}else{const w=await q("483702062341-bhdprmoot8rto79jmjvkijdl7pbz28b.apps.googleusercontent.com");if(!w.ok){const p=await z($);if(!p.ok){h({title:"فشل تسجيل الدخول",description:p.error||w.error||"يرجى التسجيل بجوجل أولاً.",variant:"destructive"});return}}b(I())}const g=await cs(t.uid);g.ok?h({title:"تم النسخ الاحتياطي",description:"تم حفظ بياناتك إلى Google Drive بنجاح."}):h({title:"فشل النسخ الاحتياطي",description:g.error||"حدث خطأ أثناء النسخ الاحتياطي.",variant:"destructive"})}catch{h({title:"خطأ غير متوقع",description:"تعذر إكمال النسخ الاحتياطي.",variant:"destructive"})}finally{N(!1)}},K=async()=>{if(t!=null&&t.uid)try{if(x(!0),!y)if(await oe()){if(!await ie(t.uid,2e4,1500)){const p=await q("483702062341-bhdprmoot8rto79jmjvkijdl7pbz28b.apps.googleusercontent.com");if(!p.ok){const j=await z($);if(!j.ok){h({title:"فشل تسجيل الدخول",description:j.error||p.error||"يرجى التسجيل بجوجل أولاً.",variant:"destructive"});return}}b(I())}}else{const w=await q("483702062341-bhdprmoot8rto79jmjvkijdl7pbz28b.apps.googleusercontent.com");if(!w.ok){const p=await z($);if(!p.ok){h({title:"فشل تسجيل الدخول",description:p.error||w.error||"يرجى التسجيل بجوجل أولاً.",variant:"destructive"});return}}b(I())}const g=await ls(t.uid);g.ok?h({title:"تم الاسترجاع",description:"تم استرجاع بياناتك بنجاح من Google Drive."}):h({title:"فشل الاسترجاع",description:g.error||"حدث خطأ أثناء الاسترجاع.",variant:"destructive"})}catch{h({title:"خطأ غير متوقع",description:"تعذر إكمال الاسترجاع.",variant:"destructive"})}finally{x(!1)}},L=async()=>{try{P(!0);const g=await oe();let f=!1;if(g&&(t!=null&&t.uid)&&(f=await ie(t.uid,2e4,1500)),f){h({title:"تم ربط جوجل",description:"تم تفعيل النسخ الاحتياطي عبر الخادم"});return}const w=await q("483702062341-bhdprmoot8rto79jmjvkijdl7pbz28b.apps.googleusercontent.com");if(w.ok){const p=I();b(p),h({title:"تم ربط جوجل",description:"تم تفعيل النسخ الاحتياطي على Google Drive"})}else{const p=await z($);if(p.ok){const j=I();b(j),h({title:"تم ربط جوجل",description:"تم تفعيل النسخ الاحتياطي على Google Drive"})}else h({title:"فشل ربط جوجل",description:p.error||w.error||"حدث خطأ أثناء تسجيل الدخول بجوجل.",variant:"destructive"})}}catch{h({title:"خطأ غير متوقع",description:"تعذر إكمال تسجيل الدخول بجوجل.",variant:"destructive"})}finally{P(!1)}};return s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs(fe,{children:[s.jsx(me,{asChild:!0,children:s.jsx(S,{variant:"ghost",size:"icon",disabled:d,title:d?"غير متاح أثناء وجود وردية كاشير نشطة":"نسخ احتياطي على Google Drive",className:"h-8 w-8 rounded-full p-0 hover:bg-transparent focus:ring-1 focus:ring-primary focus:ring-offset-1 transition-all duration-200 disabled:opacity-60 disabled:cursor-not-allowed",children:s.jsx(Bt,{className:"h-4 w-4"})})}),s.jsxs(he,{className:"w-72",align:"end",forceMount:!0,children:[s.jsx(pe,{className:"font-normal",children:s.jsxs("div",{className:"flex flex-col space-y-1",children:[s.jsx("p",{className:"text-sm font-medium leading-none",children:"نسخ احتياطي على Google Drive"}),!y&&s.jsx("p",{className:"text-xs leading-none text-muted-foreground",children:"لا يوجد ربط بحساب جوجل، يرجى تسجيل الدخول أولاً."})]})}),s.jsx(W,{}),s.jsxs(R,{onClick:L,className:"cursor-pointer",disabled:E,children:[s.jsx(Ft,{className:"mr-2 h-4 w-4"}),s.jsx("span",{children:"تسجيل الدخول بجوجل للنسخ الاحتياطي"})]}),s.jsxs(R,{onClick:U,className:"cursor-pointer",disabled:k,children:[s.jsx(Ot,{className:"mr-2 h-4 w-4"}),s.jsx("span",{children:"عمل نسخة احتياطية"})]}),s.jsxs(R,{onClick:K,className:"cursor-pointer",disabled:D,children:[s.jsx(Et,{className:"mr-2 h-4 w-4"}),s.jsx("span",{children:"استرجاع البيانات"})]})]})]}),s.jsxs(fe,{children:[s.jsx(me,{asChild:!0,children:s.jsx(S,{variant:"ghost",disabled:d,title:d?"غير متاح أثناء وجود وردية كاشير نشطة":void 0,className:`relative h-8 w-8 rounded-full p-0 hover:bg-transparent focus:ring-1 focus:ring-primary focus:ring-offset-1 transition-all duration-200 disabled:opacity-60 disabled:cursor-not-allowed ${a}`,children:s.jsx(He,{className:"h-8 w-8 border border-border shadow-sm hover:shadow-md transition-all duration-200 hover:scale-105 bg-white",children:A?s.jsx("div",{className:"w-full h-full flex items-center justify-center bg-white dark:bg-neutral-900/20 rounded-full overflow-hidden",children:s.jsx("div",{className:"w-full h-full flex items-center justify-center scale-[2.5]",children:A.component})}):s.jsxs(s.Fragment,{children:[s.jsx(Ye,{src:t.photoURL||void 0,alt:(e==null?void 0:e.fullName)||t.email||"المستخدم",className:"object-cover"}),s.jsx(Xe,{className:"bg-white text-gray-900 font-semibold text-lg border-0",children:v()})]})})})}),s.jsxs(he,{className:"w-64",align:"end",forceMount:!0,children:[s.jsx(pe,{className:"font-normal",children:s.jsxs("div",{className:"flex flex-col space-y-1",children:[s.jsx("p",{className:"text-sm font-medium leading-none",children:(e==null?void 0:e.fullName)||"المستخدم"}),s.jsx("p",{className:"text-xs leading-none text-muted-foreground",children:t.email}),(e==null?void 0:e.role)&&s.jsxs("p",{className:"text-xs leading-none text-muted-foreground",children:["الدور: ",e.role==="staff"?"مدير":e.role==="merchant"?"تاجر":"مستخدم"]})]})}),s.jsx(W,{}),s.jsxs(R,{onClick:async()=>{try{await r({showWithdrawNote:!((e==null?void 0:e.showWithdrawNote)??!0)})}catch{}},className:"cursor-pointer",children:[s.jsx(xt,{className:"mr-2 h-4 w-4"}),s.jsx("span",{children:(e==null?void 0:e.showWithdrawNote)??!0?"إخفاء خانة ملاحظة السحب":"إظهار خانة ملاحظة السحب"})]}),s.jsx(W,{}),s.jsxs(R,{onClick:()=>n("/profile-settings"),className:"cursor-pointer",children:[s.jsx(yt,{className:"mr-2 h-4 w-4"}),s.jsx("span",{children:"إعدادات البروفيل"})]}),((e==null?void 0:e.role)==="admin"||(e==null?void 0:e.role)==="staff")&&s.jsxs(R,{onClick:()=>n("/admin"),className:"cursor-pointer",children:[s.jsx(Lt,{className:"mr-2 h-4 w-4"}),s.jsx("span",{children:"لوحة الإدارة"})]}),s.jsx(W,{}),s.jsxs(R,{onClick:J,className:"cursor-pointer text-red-600 focus:text-red-600",children:[s.jsx(vt,{className:"mr-2 h-4 w-4"}),s.jsx("span",{children:"تسجيل الخروج"})]})]})]})]}),s.jsx(ts,{open:l,onOpenChange:i})]})}function ps(a){return a?`readBroadcastIds_${a}`:"readBroadcastIds_guest"}function Ds({className:a}){const{user:t,profile:e,isSubscriptionActive:o}=xe(),r=jt(),[n,l]=c.useState([]),[i,d]=c.useState(new Set),[h,k]=c.useState(!1),[N,D]=c.useState(""),[x,E]=c.useState(!1),[P,y]=c.useState(null),[b,v]=c.useState("none"),[A,J]=c.useState(null),[U,K]=c.useState(!1);c.useRef(new Set),c.useRef(!1);const L=c.useRef(null),g=c.useRef(null);c.useRef(null);const[f,w]=c.useState({position:"fixed",top:0,left:0,zIndex:1e4}),p=!1,j=c.useMemo(()=>{const u=["global"];return t!=null&&t.uid&&u.push(`user:${t.uid}`),e!=null&&e.shopId&&u.push(`shop:${e.shopId}`),u},[t==null?void 0:t.uid,e==null?void 0:e.shopId]),G=ps(t==null?void 0:t.uid),X=c.useMemo(()=>{var C;const u=(C=r==null?void 0:r.pathname)==null?void 0:C.includes("/user/pending-approval");return!!(t!=null&&t.uid)&&!u},[t==null?void 0:t.uid,r==null?void 0:r.pathname]);c.useEffect(()=>{try{const u=localStorage.getItem(G);if(u){const m=JSON.parse(u);Array.isArray(m)&&d(new Set(m.filter(Boolean)))}else d(new Set)}catch(u){console.warn("Failed to load read ids",u),d(new Set)}},[G]),c.useEffect(()=>{if(!X){l([]);return}const u=Rt(j,m=>{l(m)});return()=>u()},[j,X]),c.useEffect(()=>{},[n]),c.useEffect(()=>()=>{L.current&&clearTimeout(L.current)},[]);const Z=n.reduce((u,m)=>u+(m.id&&!i.has(m.id)?1:0),0),ve=u=>{if(!u||i.has(u))return;const m=new Set(i);m.add(u),d(m);try{localStorage.setItem(G,JSON.stringify(Array.from(m)))}catch{}},je=()=>{const u=n.map(C=>C.id).filter(Boolean),m=new Set(i);u.forEach(C=>m.add(C)),d(m);try{localStorage.setItem(G,JSON.stringify(Array.from(m)))}catch{}},nt=(u,m)=>{u&&window.open(u,"_blank"),m&&ve(m)};c.useEffect(()=>{},[U]);const ot=async()=>{if(!(t!=null&&t.uid)){alert("يرجى تسجيل الدخول لإرسال الطلب.");return}const u=N.trim();if(!u){alert("يرجى كتابة سبب طلب التحدث.");return}try{E(!0),y(null);const m=e!=null&&e.fullName&&e.fullName.trim()?e.fullName.trim():t.email?t.email.split("@")[0]:"مستخدم",C=(e==null?void 0:e.phone)||null;await Pt(Ce(Ie,"waiting_list"),{userId:t.uid,name:m,phone:C,reason:u,status:"pending",createdAt:At()}),y("تم إرسال طلبك إلى قائمة الانتظار بنجاح ✅"),D(""),setTimeout(()=>k(!1),900)}catch(m){console.error("فشل إرسال طلب قائمة الانتظار:",m),alert("حدث خطأ أثناء إرسال الطلب. حاول مرة أخرى.")}finally{E(!1)}};return c.useEffect(()=>{if(!(t!=null&&t.uid)){v("none");return}let u=null;try{const m=St(Ce(Ie,"waiting_list"),kt("userId","==",t.uid));u=bt(m,C=>{const Se=C.docs.map(T=>({id:T.id,...T.data()})).sort((T,M)=>{var Q,ke,be,V,Ne,Pe;const ct=((ke=(Q=T==null?void 0:T.createdAt)==null?void 0:Q.toMillis)==null?void 0:ke.call(Q))??((be=T==null?void 0:T.createdAt)==null?void 0:be.seconds)*1e3??0;return(((Ne=(V=M==null?void 0:M.createdAt)==null?void 0:V.toMillis)==null?void 0:Ne.call(V))??((Pe=M==null?void 0:M.createdAt)==null?void 0:Pe.seconds)*1e3??0)-ct});if(Se.length===0){v("none");return}const _=Se[0],it=(_==null?void 0:_.contacted)===!0||(_==null?void 0:_.status)==="contacted";v(it?"contacted":"pending")})}catch(m){console.warn("⚠️ فشل الاشتراك في waiting_list للمستخدم:",m),v("none")}return()=>{u&&u()}},[t==null?void 0:t.uid]),X?s.jsxs("div",{className:`relative inline-flex items-center gap-2 ${a||""}`,ref:g,children:[s.jsxs(fe,{onOpenChange:u=>{u&&Z>0&&je()},children:[s.jsx(me,{asChild:!0,children:s.jsx(S,{variant:"ghost",className:"relative h-8 w-8 rounded-full p-0 hover:bg-transparent focus:ring-1 focus:ring-primary focus:ring-offset-1 transition-all",title:"الإشعارات",children:s.jsxs("div",{className:"relative h-8 w-8 rounded-full bg-primary/10 flex items-center justify-center border border-border shadow-sm hover:shadow-md",children:[s.jsx(De,{className:"h-4 w-4 text-primary"}),Z>0&&s.jsx("span",{className:"absolute -top-1 -right-1 min-w-[18px] h-[18px] px-1 rounded-full bg-red-500 text-white text-[10px] font-bold flex items-center justify-center shadow",children:Z})]})})}),s.jsxs(he,{className:"w-80",align:"end",forceMount:!0,children:[s.jsxs(pe,{className:"flex items-center justify-between",children:[s.jsx("span",{children:"الإشعارات"}),n.length>0&&s.jsxs(S,{variant:"outline",size:"sm",className:"h-7 text-xs",onClick:je,children:[s.jsx(re,{className:"h-3 w-3 mr-1"}),"تمييز الكل كمقروء"]})]}),s.jsx(W,{}),n.length===0?s.jsx("div",{className:"p-3 text-sm text-muted-foreground",children:"لا توجد إشعارات حالياً"}):s.jsx("div",{className:"max-h-64 overflow-y-auto pr-1",children:n.map(u=>{const m=u.id?!i.has(u.id):!1;return s.jsx("div",{className:`px-2 py-2 rounded-md ${m?"bg-primary/5":""}`,children:s.jsxs("div",{className:"flex items-start gap-2",children:[s.jsx(De,{className:`h-4 w-4 ${m?"text-primary":"text-muted-foreground"}`}),s.jsxs("div",{className:"flex-1",children:[s.jsx("div",{className:"text-sm font-medium",children:u.title||"إشعار"}),s.jsx("div",{className:"text-xs text-muted-foreground whitespace-pre-line",children:u.message}),u.linkUrl&&s.jsxs(S,{variant:"link",className:"px-0 h-6 text-xs",onClick:()=>nt(u.linkUrl,u.id),children:["فتح الرابط ",s.jsx(_t,{className:"h-3 w-3 ml-1"})]})]}),m?s.jsx(S,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>ve(u.id),title:"تمييز كمقروء",children:s.jsx(re,{className:"h-4 w-4 text-primary"})}):s.jsx(S,{variant:"ghost",size:"icon",className:"h-6 w-6",disabled:!0,title:"مقروء",children:s.jsx(re,{className:"h-4 w-4 text-muted-foreground"})})]})},u.id)})})]})]}),s.jsxs(Le,{open:h,onOpenChange:k,children:[s.jsx(It,{asChild:!0,children:s.jsx(S,{variant:"ghost",size:"icon",className:"h-8 w-8 rounded-full hover:bg-transparent focus:ring-1 focus:ring-primary/60 focus:ring-offset-1",title:"قائمة الانتظار",children:s.jsx(Nt,{className:`h-4 w-4 ${b==="pending"?"text-red-600":b==="contacted"?"text-green-600":"text-muted-foreground"}`})})}),s.jsxs(Re,{className:"max-w-md border border-purple-200/50 shadow-xl bg-gradient-to-br from-purple-50 to-blue-50",children:[s.jsxs(_e,{children:[s.jsx(Me,{children:"طلب التحدث"}),s.jsx(Oe,{children:"يرجى كتابة سبب طلب التحدث ليصل للإدارة في قسم قائمة الانتظار."})]}),s.jsxs("div",{className:"grid gap-3",children:[s.jsx("label",{className:"text-sm font-medium text-gray-700",children:"سبب الطلب"}),s.jsx(Mt,{value:N,onChange:u=>D(u.target.value),placeholder:"اكتب سبب طلب التحدث هنا...",className:"min-h-[120px] text-right"}),P&&s.jsx("div",{className:"text-sm text-green-700 bg-green-50 border border-green-200 rounded-md p-2",children:P})]}),s.jsxs(Be,{children:[s.jsx(S,{variant:"outline",onClick:()=>k(!1),disabled:x,children:"إلغاء"}),s.jsx(S,{onClick:ot,disabled:x,className:"bg-gradient-to-r from-green-600 to-emerald-600 text-white",children:x?"جارٍ الإرسال...":"إرسال"})]})]})]}),p]}):null}export{Cs as A,Ds as N,Is as P};
