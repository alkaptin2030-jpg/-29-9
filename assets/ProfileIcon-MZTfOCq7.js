import{r as d,y as se,j as e,P as k,B as ae,au as D,t as R,u as $,d as re,az as te,aA as ne,aB as oe,a as de,I as ie,Q as le,J as ce}from"./index-B4rr4Fr9.js";import{L as ue,D as me,a as fe,b as we,c as he,d as _,e as N}from"./dropdown-menu-DrEM0XR_.js";import{B as j}from"./button-C40VjUZp.js";import{D as xe,a as pe,b as ve,c as ge,d as je,e as Pe}from"./dialog-DGVHnQzO.js";import{I as C}from"./input-B1SYo6-5.js";import{L as A}from"./label-B793cNH3.js";import{E,a as L}from"./eye-CEmYMwfa.js";import{g as Ne}from"./avatars-DIdcxx4p.js";import{K as be}from"./key-round-Bw8Rur7J.js";import{S as ye}from"./shield-wDJk5gwp.js";var B={exports:{}},T={};/**
 * @license React
 * use-sync-external-store-shim.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var P=d;function Se(r,a){return r===a&&(r!==0||1/r===1/a)||r!==r&&a!==a}var Ce=typeof Object.is=="function"?Object.is:Se,Ae=P.useState,Ee=P.useEffect,Le=P.useLayoutEffect,Ie=P.useDebugValue;function De(r,a){var s=a(),o=Ae({inst:{value:s,getSnapshot:a}}),t=o[0].inst,n=o[1];return Le(function(){t.value=s,t.getSnapshot=a,I(t)&&n({inst:t})},[r,s,a]),Ee(function(){return I(t)&&n({inst:t}),r(function(){I(t)&&n({inst:t})})},[r]),Ie(s),s}function I(r){var a=r.getSnapshot;r=r.value;try{var s=a();return!Ce(r,s)}catch{return!0}}function ke(r,a){return a()}var Re=typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"?ke:De;T.useSyncExternalStore=P.useSyncExternalStore!==void 0?P.useSyncExternalStore:Re;B.exports=T;var Fe=B.exports;function Me(){return Fe.useSyncExternalStore(_e,()=>!0,()=>!1)}function _e(){return()=>{}}var F="Avatar",[Oe,Xe]=se(F),[$e,U]=Oe(F),z=d.forwardRef((r,a)=>{const{__scopeAvatar:s,...o}=r,[t,n]=d.useState("idle");return e.jsx($e,{scope:s,imageLoadingStatus:t,onImageLoadingStatusChange:n,children:e.jsx(k.span,{...o,ref:a})})});z.displayName=F;var H="AvatarImage",K=d.forwardRef((r,a)=>{const{__scopeAvatar:s,src:o,onLoadingStatusChange:t=()=>{},...n}=r,u=U(H,s),i=Be(o,n),l=ae(f=>{t(f),u.onImageLoadingStatusChange(f)});return D(()=>{i!=="idle"&&l(i)},[i,l]),i==="loaded"?e.jsx(k.img,{...n,ref:a,src:o}):null});K.displayName=H;var V="AvatarFallback",q=d.forwardRef((r,a)=>{const{__scopeAvatar:s,delayMs:o,...t}=r,n=U(V,s),[u,i]=d.useState(o===void 0);return d.useEffect(()=>{if(o!==void 0){const l=window.setTimeout(()=>i(!0),o);return()=>window.clearTimeout(l)}},[o]),u&&n.imageLoadingStatus!=="loaded"?e.jsx(k.span,{...t,ref:a}):null});q.displayName=V;function O(r,a){return r?a?(r.src!==a&&(r.src=a),r.complete&&r.naturalWidth>0?"loaded":"loading"):"error":"idle"}function Be(r,{referrerPolicy:a,crossOrigin:s}){const o=Me(),t=d.useRef(null),n=o?(t.current||(t.current=new window.Image),t.current):null,[u,i]=d.useState(()=>O(n,r));return D(()=>{i(O(n,r))},[n,r]),D(()=>{const l=p=>()=>{i(p)};if(!n)return;const f=l("loaded"),x=l("error");return n.addEventListener("load",f),n.addEventListener("error",x),a&&(n.referrerPolicy=a),typeof s=="string"&&(n.crossOrigin=s),()=>{n.removeEventListener("load",f),n.removeEventListener("error",x)}},[n,s,a]),u}var G=z,W=K,J=q;const Q=d.forwardRef(({className:r,...a},s)=>e.jsx(G,{ref:s,className:R("relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",r),...a}));Q.displayName=G.displayName;const X=d.forwardRef(({className:r,...a},s)=>e.jsx(W,{ref:s,className:R("aspect-square h-full w-full",r),...a}));X.displayName=W.displayName;const Y=d.forwardRef(({className:r,...a},s)=>e.jsx(J,{ref:s,className:R("flex h-full w-full items-center justify-center rounded-full bg-muted",r),...a}));Y.displayName=J.displayName;function Te({open:r,onOpenChange:a}){const{user:s}=$(),{toast:o}=re(),[t,n]=d.useState(!1),[u,i]=d.useState(!1),[l,f]=d.useState(!1),[x,p]=d.useState(!1),[m,b]=d.useState({currentPassword:"",newPassword:"",confirmPassword:""}),[w,v]=d.useState({currentPassword:"",newPassword:"",confirmPassword:""}),Z=()=>{const c={currentPassword:"",newPassword:"",confirmPassword:""};return m.currentPassword||(c.currentPassword="كلمة المرور الحالية مطلوبة"),m.newPassword?m.newPassword.length<6&&(c.newPassword="كلمة المرور يجب أن تكون 6 أحرف على الأقل"):c.newPassword="كلمة المرور الجديدة مطلوبة",m.confirmPassword?m.newPassword!==m.confirmPassword&&(c.confirmPassword="كلمات المرور غير متطابقة"):c.confirmPassword="تأكيد كلمة المرور مطلوب",v(c),!Object.values(c).some(h=>h!=="")},ee=async c=>{if(c.preventDefault(),!(!Z()||!s||!s.email)){n(!0);try{const h=te.credential(s.email,m.currentPassword);await ne(s,h),await oe(s,m.newPassword),o({title:"تم تغيير كلمة المرور بنجاح",description:"تم تحديث كلمة المرور الخاصة بك بنجاح"}),b({currentPassword:"",newPassword:"",confirmPassword:""}),v({currentPassword:"",newPassword:"",confirmPassword:""}),a(!1)}catch(h){console.error("خطأ في تغيير كلمة المرور:",h);let g="حدث خطأ أثناء تغيير كلمة المرور";if(h.code==="auth/wrong-password"){v(S=>({...S,currentPassword:"كلمة المرور الحالية غير صحيحة"}));return}else if(h.code==="auth/weak-password"){v(S=>({...S,newPassword:"كلمة المرور ضعيفة جداً"}));return}else h.code==="auth/requires-recent-login"&&(g="يجب تسجيل الدخول مرة أخرى لتغيير كلمة المرور");o({title:"خطأ في تغيير كلمة المرور",description:g,variant:"destructive"})}finally{n(!1)}}},y=c=>h=>{b(g=>({...g,[c]:h.target.value})),w[c]&&v(g=>({...g,[c]:""}))},M=()=>{b({currentPassword:"",newPassword:"",confirmPassword:""}),v({currentPassword:"",newPassword:"",confirmPassword:""}),a(!1)};return e.jsx(xe,{open:r,onOpenChange:M,children:e.jsxs(pe,{className:"sm:max-w-[425px]",children:[e.jsxs(ve,{children:[e.jsx(ge,{children:"تغيير كلمة المرور"}),e.jsx(je,{children:"أدخل كلمة المرور الحالية وكلمة المرور الجديدة لتحديث حسابك"})]}),e.jsxs("form",{onSubmit:ee,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(A,{htmlFor:"currentPassword",children:"كلمة المرور الحالية"}),e.jsxs("div",{className:"relative",children:[e.jsx(C,{id:"currentPassword",type:u?"text":"password",value:m.currentPassword,onChange:y("currentPassword"),className:w.currentPassword?"border-red-500":"",disabled:t}),e.jsx(j,{type:"button",variant:"ghost",size:"sm",className:"absolute right-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>i(!u),disabled:t,children:u?e.jsx(E,{className:"h-4 w-4"}):e.jsx(L,{className:"h-4 w-4"})})]}),w.currentPassword&&e.jsx("p",{className:"text-sm text-red-500",children:w.currentPassword})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(A,{htmlFor:"newPassword",children:"كلمة المرور الجديدة"}),e.jsxs("div",{className:"relative",children:[e.jsx(C,{id:"newPassword",type:l?"text":"password",value:m.newPassword,onChange:y("newPassword"),className:w.newPassword?"border-red-500":"",disabled:t}),e.jsx(j,{type:"button",variant:"ghost",size:"sm",className:"absolute right-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>f(!l),disabled:t,children:l?e.jsx(E,{className:"h-4 w-4"}):e.jsx(L,{className:"h-4 w-4"})})]}),w.newPassword&&e.jsx("p",{className:"text-sm text-red-500",children:w.newPassword})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(A,{htmlFor:"confirmPassword",children:"تأكيد كلمة المرور الجديدة"}),e.jsxs("div",{className:"relative",children:[e.jsx(C,{id:"confirmPassword",type:x?"text":"password",value:m.confirmPassword,onChange:y("confirmPassword"),className:w.confirmPassword?"border-red-500":"",disabled:t}),e.jsx(j,{type:"button",variant:"ghost",size:"sm",className:"absolute right-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>p(!x),disabled:t,children:x?e.jsx(E,{className:"h-4 w-4"}):e.jsx(L,{className:"h-4 w-4"})})]}),w.confirmPassword&&e.jsx("p",{className:"text-sm text-red-500",children:w.confirmPassword})]}),e.jsxs(Pe,{children:[e.jsx(j,{type:"button",variant:"outline",onClick:M,disabled:t,children:"إلغاء"}),e.jsxs(j,{type:"submit",disabled:t,children:[t&&e.jsx(ue,{className:"mr-2 h-4 w-4 animate-spin"}),"تغيير كلمة المرور"]})]})]})]})})}function Ye({className:r}){const{user:a,profile:s,signOut:o}=$(),t=de(),[n,u]=d.useState(!1),{isShiftActive:i}=ie();if(!a)return null;const l=()=>s!=null&&s.fullName?s==null?void 0:s.fullName.split(" ").map(p=>p.charAt(0)).join("").toUpperCase().slice(0,2):a.email?a.email.charAt(0).toUpperCase():"U",f=s!=null&&s.avatarId?Ne(s.avatarId):null;d.useEffect(()=>{console.log("Profile updated in ProfileIcon:",s==null?void 0:s.avatarId)},[s==null?void 0:s.avatarId]);const x=async()=>{try{await o()}catch(p){console.error("خطأ في تسجيل الخروج:",p)}};return e.jsxs(e.Fragment,{children:[e.jsxs(me,{children:[e.jsx(fe,{asChild:!0,children:e.jsx(j,{variant:"ghost",disabled:i,title:i?"غير متاح أثناء وجود وردية كاشير نشطة":void 0,className:`relative h-8 w-8 rounded-full p-0 hover:bg-transparent focus:ring-1 focus:ring-primary focus:ring-offset-1 transition-all duration-200 disabled:opacity-60 disabled:cursor-not-allowed ${r}`,children:e.jsx(Q,{className:"h-8 w-8 border border-border shadow-sm hover:shadow-md transition-all duration-200 hover:scale-105",children:f?e.jsx("div",{className:"w-full h-full flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-blue-900/20 dark:to-indigo-900/20 rounded-full overflow-hidden",children:e.jsx("div",{className:"w-full h-full flex items-center justify-center scale-[2.5]",children:f.component})}):e.jsxs(e.Fragment,{children:[e.jsx(X,{src:a.photoURL||void 0,alt:(s==null?void 0:s.fullName)||a.email||"المستخدم",className:"object-cover"}),e.jsx(Y,{className:"bg-gradient-to-br from-primary to-primary/80 text-primary-foreground font-semibold text-lg border-0",children:l()})]})})})}),e.jsxs(we,{className:"w-64",align:"end",forceMount:!0,children:[e.jsx(he,{className:"font-normal",children:e.jsxs("div",{className:"flex flex-col space-y-1",children:[e.jsx("p",{className:"text-sm font-medium leading-none",children:(s==null?void 0:s.fullName)||"المستخدم"}),e.jsx("p",{className:"text-xs leading-none text-muted-foreground",children:a.email}),(s==null?void 0:s.role)&&e.jsxs("p",{className:"text-xs leading-none text-muted-foreground",children:["الدور: ",s.role==="staff"?"موظف":s.role==="merchant"?"تاجر":"مستخدم"]})]})}),e.jsx(_,{}),e.jsxs(N,{onClick:()=>u(!0),className:"cursor-pointer",children:[e.jsx(be,{className:"mr-2 h-4 w-4"}),e.jsx("span",{children:"تغيير كلمة المرور"})]}),e.jsxs(N,{onClick:()=>t("/profile-settings"),className:"cursor-pointer",children:[e.jsx(le,{className:"mr-2 h-4 w-4"}),e.jsx("span",{children:"إعدادات البروفيل"})]}),((s==null?void 0:s.role)==="admin"||(s==null?void 0:s.role)==="staff")&&e.jsxs(N,{onClick:()=>t("/admin"),className:"cursor-pointer",children:[e.jsx(ye,{className:"mr-2 h-4 w-4"}),e.jsx("span",{children:"لوحة الإدارة"})]}),e.jsx(_,{}),e.jsxs(N,{onClick:x,className:"cursor-pointer text-red-600 focus:text-red-600",children:[e.jsx(ce,{className:"mr-2 h-4 w-4"}),e.jsx("span",{children:"تسجيل الخروج"})]})]})]}),e.jsx(Te,{open:n,onOpenChange:u})]})}export{Ye as P};
