const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./dailyOperationCountService-BUlwZZKI.js","./index-BaJ4CYlQ.js","./index-f1lkdN4_.css","./walletDailyLimitsService-CbdZ_7wZ.js","./profitService-Bj9jIfaS.js"])))=>i.map(i=>d[i]);
import{J as cs,r as p,a6 as ds,j as t,a1 as ms,a3 as Ae,a4 as _e,as as ps,Y as He,u as yt,B as A,p as ut,C as Ue,z as $,ar as Me,aD as j,a as us,R as we,aE as hs,ab as xs,v as te,f as E,w as Te,q as z,e as U,an as _,g as se,aF as fs,o as gs,ay as V,aG as ie,_ as bs,aa as We,K as ae,I as Be,aq as ht,aH as vs,aI as ys,d as Fe,aJ as xt,a9 as H,O as ze}from"./index-BaJ4CYlQ.js";import{C as js,a as Ns,b as ws,d as Ts}from"./card-DLfh52HJ.js";import{D as $e,a as Ve,b as qe,c as Ge,e as Cs}from"./dialog-Dficjy7S.js";import{u as Ds,S as As,a as Ss,b as Rs,c as Ps,d as Ce}from"./select-DyuXCEgh.js";import{B as De}from"./badge-CK9fQGht.js";import{c as jt,R as ks,I as Es}from"./index-CvylMYeU.js";import{u as Os}from"./Combination-uvOg_TRR.js";import{A as ft,a as gt,C as Is,b as Ls,f as W,M as _s,c as Ms,R as Ws}from"./MaintenanceDialog-BS9B6y-S.js";import{M as Nt,P as Bs}from"./MasterPinDialog-CaA8A3a3.js";import{r as bt,P as le}from"./profitService-Bj9jIfaS.js";import{D as Fs}from"./dollar-sign-B82hCvWQ.js";import{C as wt}from"./calendar-B_Alfioc.js";import{A as zs}from"./arrow-left-CFvmOtRJ.js";import{S as Us}from"./separator-CyJmhVM9.js";import{T as vt}from"./progress-9fiwWm9n.js";import{C as $s}from"./circle-x-BMM-biHI.js";import{C as Vs}from"./circle-check-big-nE2HPuqM.js";import"./index-BDxANiQU.js";import"./whatsappService-CkFpZfJI.js";import"./download-CV0yHFGN.js";import"./label-BUMa-ycB.js";import"./circle-alert-DetpNY9Y.js";import"./shield-BUfn1tuF.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qs=cs("BatteryCharging",[["path",{d:"M15 7h1a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2h-2",key:"1sdynx"}],["path",{d:"M6 7H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h1",key:"1gkd3k"}],["path",{d:"m11 7-3 5h4l-3 5",key:"b4a64w"}],["line",{x1:"22",x2:"22",y1:"11",y2:"13",key:"4dh1rd"}]]);var Se="Tabs",[Gs]=ms(Se,[jt]),Tt=jt(),[Hs,Xe]=Gs(Se),Ct=p.forwardRef((h,s)=>{const{__scopeTabs:b,value:x,onValueChange:P,defaultValue:k,orientation:S="horizontal",dir:B,activationMode:N="automatic",...O}=h,w=Ds(B),[C,M]=ds({prop:x,onChange:P,defaultProp:k??"",caller:Se});return t.jsx(Hs,{scope:b,baseId:Os(),value:C,onValueChange:M,orientation:S,dir:w,activationMode:N,children:t.jsx(Ae.div,{dir:w,"data-orientation":S,...O,ref:s})})});Ct.displayName=Se;var Dt="TabsList",At=p.forwardRef((h,s)=>{const{__scopeTabs:b,loop:x=!0,...P}=h,k=Xe(Dt,b),S=Tt(b);return t.jsx(ks,{asChild:!0,...S,orientation:k.orientation,dir:k.dir,loop:x,children:t.jsx(Ae.div,{role:"tablist","aria-orientation":k.orientation,...P,ref:s})})});At.displayName=Dt;var St="TabsTrigger",Rt=p.forwardRef((h,s)=>{const{__scopeTabs:b,value:x,disabled:P=!1,...k}=h,S=Xe(St,b),B=Tt(b),N=Et(S.baseId,x),O=Ot(S.baseId,x),w=x===S.value;return t.jsx(Es,{asChild:!0,...B,focusable:!P,active:w,children:t.jsx(Ae.button,{type:"button",role:"tab","aria-selected":w,"aria-controls":O,"data-state":w?"active":"inactive","data-disabled":P?"":void 0,disabled:P,id:N,...k,ref:s,onMouseDown:_e(h.onMouseDown,C=>{!P&&C.button===0&&C.ctrlKey===!1?S.onValueChange(x):C.preventDefault()}),onKeyDown:_e(h.onKeyDown,C=>{[" ","Enter"].includes(C.key)&&S.onValueChange(x)}),onFocus:_e(h.onFocus,()=>{const C=S.activationMode!=="manual";!w&&!P&&C&&S.onValueChange(x)})})})});Rt.displayName=St;var Pt="TabsContent",kt=p.forwardRef((h,s)=>{const{__scopeTabs:b,value:x,forceMount:P,children:k,...S}=h,B=Xe(Pt,b),N=Et(B.baseId,x),O=Ot(B.baseId,x),w=x===B.value,C=p.useRef(w);return p.useEffect(()=>{const M=requestAnimationFrame(()=>C.current=!1);return()=>cancelAnimationFrame(M)},[]),t.jsx(ps,{present:P||w,children:({present:M})=>t.jsx(Ae.div,{"data-state":w?"active":"inactive","data-orientation":B.orientation,role:"tabpanel","aria-labelledby":N,hidden:!M,id:O,tabIndex:0,...S,ref:s,style:{...h.style,animationDuration:C.current?"0s":void 0},children:M&&k})})});kt.displayName=Pt;function Et(h,s){return`${h}-trigger-${s}`}function Ot(h,s){return`${h}-content-${s}`}var Xs=Ct,It=At,Lt=Rt,_t=kt;const Js=Xs,Mt=p.forwardRef(({className:h,...s},b)=>t.jsx(It,{ref:b,className:He("inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",h),...s}));Mt.displayName=It.displayName;const ce=p.forwardRef(({className:h,...s},b)=>t.jsx(Lt,{ref:b,className:He("inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm",h),...s}));ce.displayName=Lt.displayName;const de=p.forwardRef(({className:h,...s},b)=>t.jsx(_t,{ref:b,className:He("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",h),...s}));de.displayName=_t.displayName;const Ys=({userId:h,transactions:s=[]})=>{const[b,x]=p.useState(!1),[P,k]=p.useState(!1),[S,B]=p.useState(!1),[N,O]=p.useState({dailyWithdraw:0,dailyTransfer:0,monthlyWithdraw:0,monthlyTransfer:0,lastUpdated:new Date}),{userSubscription:w}=yt();p.useEffect(()=>{h&&b&&S&&Z()},[h,b,S]);const C=g=>`${g.toFixed(2)} ج.م`,M=async()=>{try{const g=(w==null?void 0:w.subscription)||null,u=(g==null?void 0:g.planType)??(g==null?void 0:g.plan)??null,T=typeof u=="string"?u.toLowerCase():null;if(u===$.ZERO||T==="zero"||T==="0"||u===0)return!0}catch{}try{if(h){const g=await Me(h),u=(g==null?void 0:g.planType)??(g==null?void 0:g.plan)??null,T=typeof u=="string"?u.toLowerCase():null;if(u===$.ZERO||T==="zero"||T==="0"||u===0)return!0}}catch{}return!1},re=async()=>{try{const g=await(async()=>{try{const u=(w==null?void 0:w.subscription)||null,T=(u==null?void 0:u.planType)??(u==null?void 0:u.plan)??null,F=typeof T=="string"?T.toLowerCase():null;if(T===$.TAHWEELA||F==="tahweela")return!0}catch{}try{if(h){const u=await Me(h),T=(u==null?void 0:u.planType)??(u==null?void 0:u.plan)??null,F=typeof T=="string"?T.toLowerCase():null;if(T===$.TAHWEELA||F==="tahweela")return!0}}catch{}return!1})();if(await M()||g){j({title:"غير متاح لاشتراكك",description:"عرض إجمالي الأرباح غير متاح في هذه الخطة.",variant:"destructive"});return}}catch{}k(!0)},Re=async()=>{try{const g=await(async()=>{try{const u=(w==null?void 0:w.subscription)||null,T=(u==null?void 0:u.planType)??(u==null?void 0:u.plan)??null,F=typeof T=="string"?T.toLowerCase():null;if(T===$.TAHWEELA||F==="tahweela")return!0}catch{}try{if(h){const u=await Me(h),T=(u==null?void 0:u.planType)??(u==null?void 0:u.plan)??null,F=typeof T=="string"?T.toLowerCase():null;if(T===$.TAHWEELA||F==="tahweela")return!0}}catch{}return!1})();if(await M()||g){j({title:"غير متاح لاشتراكك",description:"عرض إجمالي الأرباح غير متاح في هذه الخطة.",variant:"destructive"}),k(!1);return}}catch{}B(!0),x(!0),k(!1)},Z=async()=>{if(h)try{if(Array.isArray(s)&&s.length>0){const u=new Date,T=u.getMonth(),F=u.getFullYear(),X=bt.filterVisibleTransactions(s,"daily",h),me=bt.filterVisibleTransactions(s,"monthly",h);let q=0,pe=0,G=0,ue=0;X.forEach(I=>{const K=new Date(I.createdAt),Q=String(I.status||"confirmed").toLowerCase();if(K.toDateString()!==u.toDateString()||Q!=="completed"&&Q!=="confirmed")return;const J=(I.type||I.txnType||"").toLowerCase(),L={type:J==="withdrawal"?"withdraw":J,amount:Number(I.amount||0),commission:I.commission};L.type==="withdraw"?q+=le.calculateProfitFromTransaction(L):(L.type==="send"||L.type==="receive"||L.type==="transfer")&&(pe+=le.calculateProfitFromTransaction(L))}),me.forEach(I=>{const K=new Date(I.createdAt),Q=String(I.status||"confirmed").toLowerCase();if(K.getMonth()!==T||K.getFullYear()!==F||Q!=="completed"&&Q!=="confirmed")return;const J=(I.type||I.txnType||"").toLowerCase(),L={type:J==="withdrawal"?"withdraw":J,amount:Number(I.amount||0),commission:I.commission};L.type==="withdraw"?G+=le.calculateProfitFromTransaction(L):(L.type==="send"||L.type==="receive"||L.type==="transfer")&&(ue+=le.calculateProfitFromTransaction(L))}),O({dailyWithdraw:Math.round(q*100)/100,dailyTransfer:Math.round(pe*100)/100,monthlyWithdraw:Math.round(G*100)/100,monthlyTransfer:Math.round(ue*100)/100,lastUpdated:new Date});return}const g=le.getWithdrawTransferProfits(h);O({dailyWithdraw:g.dailyWithdrawProfit||0,dailyTransfer:g.dailyTransferProfit||0,monthlyWithdraw:g.monthlyWithdrawProfit||0,monthlyTransfer:g.monthlyTransferProfit||0,lastUpdated:new Date})}catch(g){console.error("Error loading total profits:",g)}};return t.jsxs(t.Fragment,{children:[t.jsx(A,{size:"sm",variant:"ghost",onClick:re,className:"h-2 w-2 p-0 bg-gradient-to-r from-blue-100 to-purple-200 text-purple-700 hover:from-blue-200 hover:to-purple-300 hover:text-purple-800 rounded transition-all duration-300 hover:scale-110 shadow-sm hover:shadow-md",title:"عرض إجمالي الأرباح",children:t.jsx(ut,{className:"h-1.5 w-1.5"})}),t.jsx($e,{open:b,onOpenChange:x,children:t.jsxs(Ve,{className:"max-w-[240px] mx-auto bg-white border border-gray-200 shadow-md rounded sm:max-w-[220px] sm:bg-gradient-to-br sm:from-purple-50 sm:to-white sm:border-2 sm:border-purple-200 sm:shadow-2xl sm:rounded-2xl",children:[t.jsx(qe,{className:"text-center pb-0 border-b-0 sm:pb-2 sm:border-b sm:border-purple-200",children:t.jsxs(Ge,{className:"text-xs font-bold text-purple-800 flex items-center justify-center gap-1 mb-0 leading-tight tracking-tight sm:text-xs sm:gap-1 sm:mb-0 sm:leading-normal sm:tracking-normal",children:[t.jsx(Fs,{className:"h-2 w-2 text-purple-600 sm:h-3 sm:w-3"}),"إجمالي الأرباح (فوري)"]})}),t.jsxs("div",{className:"space-y-1 py-1 sm:space-y-2 sm:py-2",children:[t.jsxs("div",{className:"bg-blue-50 p-1 rounded border border-blue-200 sm:bg-gradient-to-r sm:from-blue-50 sm:to-blue-100 sm:p-2 sm:rounded-xl sm:shadow-sm",children:[t.jsxs("div",{className:"flex items-center justify-between mb-1",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(Ue,{className:"h-2 w-2 text-blue-600"}),t.jsx("span",{className:"text-[10px] font-semibold text-blue-800",children:"يومي"})]}),t.jsx("span",{className:"text-[10px] font-bold text-blue-900",children:C((N.dailyWithdraw??0)+(N.dailyTransfer??0))})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-1",children:[t.jsxs("div",{className:"flex items-center justify-between bg-red-50 p-0.5 rounded border border-red-200",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(ft,{className:"h-2 w-2 text-red-600"}),t.jsx("span",{className:"text-[10px] text-red-800",children:"سحب"})]}),t.jsx("span",{className:"text-[10px] font-bold text-red-700",children:C(N.dailyWithdraw)})]}),t.jsxs("div",{className:"flex items-center justify-between bg-green-50 p-0.5 rounded border border-green-200",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(gt,{className:"h-2 w-2 text-green-600"}),t.jsx("span",{className:"text-[10px] text-green-800",children:"تحويل"})]}),t.jsx("span",{className:"text-[10px] font-bold text-green-700",children:C(N.dailyTransfer)})]})]})]}),t.jsxs("div",{className:"bg-purple-50 p-1 rounded border border-purple-200 sm:bg-gradient-to-r sm:from-purple-50 sm:to-purple-100 sm:p-2 sm:rounded-xl sm:shadow-sm",children:[t.jsxs("div",{className:"flex items-center justify-between mb-1",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(wt,{className:"h-2 w-2 text-purple-600"}),t.jsx("span",{className:"text-[10px] font-semibold text-purple-800",children:"شهري"})]}),t.jsx("span",{className:"text-[10px] font-bold text-purple-900",children:C((N.monthlyWithdraw??0)+(N.monthlyTransfer??0))})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-1",children:[t.jsxs("div",{className:"flex items-center justify-between bg-red-50 p-0.5 rounded border border-red-200",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(ft,{className:"h-2 w-2 text-red-600"}),t.jsx("span",{className:"text-[10px] text-red-800",children:"سحب"})]}),t.jsx("span",{className:"text-[10px] font-bold text-red-700",children:C(N.monthlyWithdraw)})]}),t.jsxs("div",{className:"flex items-center justify-between bg-blue-50 p-0.5 rounded border border-blue-200",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(gt,{className:"h-2 w-2 text-blue-600"}),t.jsx("span",{className:"text-[10px] text-blue-800",children:"تحويل"})]}),t.jsx("span",{className:"text-[10px] font-bold text-blue-700",children:C(N.monthlyTransfer)})]})]})]})]}),!S&&t.jsx("div",{className:"absolute inset-0 bg-yellow-200/70 backdrop-blur-sm flex items-center justify-center rounded sm:rounded-2xl border border-yellow-300 pointer-events-auto",children:t.jsx(A,{size:"sm",variant:"ghost",onClick:()=>k(!0),className:"p-2 bg-yellow-300/80 text-yellow-900 hover:bg-yellow-400/90 rounded-full shadow-sm hover:shadow-md transition-all duration-300",title:"إدخال الرقم السري الرئيسي",children:t.jsx(ut,{className:"h-4 w-4"})})}),t.jsx("div",{className:"flex justify-center pt-1 border-t-0 sm:pt-2 sm:border-t sm:border-purple-200",children:t.jsx(A,{onClick:()=>x(!1),className:"bg-purple-600 hover:bg-purple-700 text-white px-4 py-1 rounded-xl text-xs sm:bg-gradient-to-r sm:from-purple-600 sm:to-purple-700 sm:hover:from-purple-700 sm:hover:to-purple-800 sm:px-4 sm:py-1 sm:rounded-xl sm:shadow-lg sm:hover:shadow-xl sm:transition-all sm:duration-300",children:"إغلاق"})})]})}),t.jsx(Nt,{open:P,onOpenChange:k,onSuccess:Re,description:"لا يمكن الاطلاع على إجمالي الأرباح إلا بإدخال الرقم السري الرئيسي"})]})},Zs=h=>t.jsx(Ys,{...h}),Na=()=>{var lt,ct,dt,mt,pt;const h=us(),{user:s,profile:b,userSubscription:x}=yt(),P=we.useMemo(()=>{var i,l,r,a;const e=((i=x==null?void 0:x.subscription)==null?void 0:i.planType)??((l=x==null?void 0:x.subscription)==null?void 0:l.plan)??((r=b==null?void 0:b.subscription)==null?void 0:r.planType)??((a=b==null?void 0:b.subscription)==null?void 0:a.plan)??null;return e===$.ZERO||String(e).toLowerCase()==="zero"},[(lt=x==null?void 0:x.subscription)==null?void 0:lt.planType,(ct=x==null?void 0:x.subscription)==null?void 0:ct.plan,(dt=b==null?void 0:b.subscription)==null?void 0:dt.planType,(mt=b==null?void 0:b.subscription)==null?void 0:mt.plan]),{shopName:k}=hs(),{isShiftActive:S,shiftUser:B}=xs(),[N,O]=p.useState([]),[w,C]=p.useState([]),[M,re]=p.useState(new Set),[Re,Z]=p.useState(!1),[g,u]=p.useState(null),[T,F]=p.useState("all"),[X,me]=p.useState(""),[q,pe]=p.useState(""),[G,ue]=p.useState(""),[I,K]=p.useState(!1);we.useEffect(()=>{var i;((i=x==null?void 0:x.subscription)==null?void 0:i.planType)===$.TAHWEELA&&(j({title:"غير متاح لاشتراكك",description:"صفحة المعاملات غير متاحة في باقة تحويله. استخدم لوحة المستخدم للتحويل/السحب فقط.",variant:"destructive"}),h("/user/dashboard"))},[(pt=x==null?void 0:x.subscription)==null?void 0:pt.planType]);const[Q,J]=p.useState(!1),[L,Wt]=p.useState(!1),[Ks,Bt]=p.useState(!1),[Ft,Pe]=p.useState(!1),[zt,Je]=p.useState(!1),[Ut,Ye]=p.useState(!1),[$t,ke]=p.useState(!1),[Vt,qt]=p.useState(null),[Gt,he]=p.useState(!1),[ee,xe]=p.useState({keepLastCount:30,intervalDays:7,lastResetAt:null});p.useEffect(()=>{(async()=>{if(s!=null&&s.uid)try{const i=await V.getUserData(s.uid),l=(i==null?void 0:i.recentReset)||{},r=Number(l==null?void 0:l.keepLastCount)>0?Number(l.keepLastCount):30,a=Number(l==null?void 0:l.intervalDays)>0?Number(l.intervalDays):7,n=c=>c instanceof Date?c:typeof(c==null?void 0:c.toDate)=="function"?c.toDate():c?new Date(String(c)):null,m=l!=null&&l.lastResetAt?n(l.lastResetAt):null,o=new Date;!m||o.getTime()-m.getTime()>=a*24*60*60*1e3?(await V.updateUserData(s.uid,{recentReset:{keepLastCount:r,intervalDays:a,lastResetAt:o}}),xe({keepLastCount:r,intervalDays:a,lastResetAt:o})):xe({keepLastCount:r,intervalDays:a,lastResetAt:m})}catch{xe({keepLastCount:30,intervalDays:7,lastResetAt:null})}})()},[s==null?void 0:s.uid]);const[Ht,fe]=p.useState(!1),[ge,Ze]=p.useState(""),[ne,Ke]=p.useState(""),[be,Qe]=p.useState(""),[et,tt]=p.useState(!1),[st,ve]=p.useState(0);p.useEffect(()=>{if(!(s!=null&&s.uid)){ve(0);return}const e=te(E,"users",s.uid),i=Te(e,l=>{try{const r=l.exists()?l.data():{},n=(Array.isArray(r==null?void 0:r.debts)?r.debts:[]).filter(m=>(m==null?void 0:m.status)==="pending"&&(Number(m==null?void 0:m.amount)||0)>0).length;ve(n)}catch{ve(0)}},l=>{console.warn("فشل الاشتراك في ديون المستخدم من Firestore:",l),ve(0)});return()=>i()},[s==null?void 0:s.uid]),p.useEffect(()=>{Xt(),Jt()},[s]),p.useEffect(()=>{(async()=>{try{if(!(s!=null&&s.uid)){re(new Set);return}const e=z(U(E,"deletedTransactions"),_("userId","==",s.uid),_("permanent","==",!0)),l=(await se(e)).docs.flatMap(r=>{const a=r.data();return[a.originalTransactionId,a.transactionId,a.reference,r.id].filter(Boolean).map(String)});re(new Set(l))}catch{re(new Set)}})()},[s==null?void 0:s.uid]),p.useEffect(()=>{(async()=>{try{if(!(s!=null&&s.uid))return;const i=new Date;if(i.getDate()!==1)return;const l=`${i.getFullYear()}-${i.getMonth()+1}`,r=`lastMonthlyDbCleanup:${s.uid}`;if(localStorage.getItem(r)===l)return;const n=new Date(i.getFullYear(),i.getMonth(),1,0,0,0,0),m=c=>c instanceof Date?c:typeof(c==null?void 0:c.toDate)=="function"?c.toDate():new Date(String(c));let o=[];try{const c=z(U(E,"userTransactions"),_("userId","==",s.uid),_("createdAt","<",n));o=(await se(c)).docs}catch{const c=z(U(E,"userTransactions"),_("userId","==",s.uid));o=(await se(c)).docs.filter(v=>{var y;return m((y=v.data())==null?void 0:y.createdAt)<n})}await Promise.allSettled(o.map(c=>xt(c.ref)));let d=[];try{const c=z(U(E,"transactions"),_("userId","==",s.uid),_("createdAt","<",n));d=(await se(c)).docs}catch{const c=z(U(E,"transactions"),_("userId","==",s.uid));d=(await se(c)).docs.filter(v=>{var y;return m((y=v.data())==null?void 0:y.createdAt)<n})}await Promise.allSettled(d.map(c=>xt(c.ref)));try{localStorage.setItem(r,l)}catch{}console.log("✅ تنظيف شهري (TransactionsPage):",{userTransactionsDeleted:o.length,globalTransactionsDeleted:d.length,monthStart:n})}catch(i){console.error("فشل التنظيف الشهري التلقائي (TransactionsPage):",i)}})()},[s==null?void 0:s.uid]),p.useEffect(()=>{if(!(s!=null&&s.uid))return;let e=null,i=!1;const l=a=>{const m=a.map(o=>{const d=o.data(),c=d==null?void 0:d.createdAt,f=c!=null&&c.toDate?c.toDate():c instanceof Date?c:new Date(c);return{id:o.id,...d,createdAt:f}}).filter(o=>(o==null?void 0:o.status)!=="cancelled"&&!(o!=null&&o.isDeleted)).filter(o=>!((o==null?void 0:o.type)==="report"||((o==null?void 0:o.title)||"").includes("إيصال تسليم وردية"))).sort((o,d)=>{const c=o.createdAt?new Date(o.createdAt).getTime():0;return(d.createdAt?new Date(d.createdAt).getTime():0)-c}).filter(o=>{const d=String(o.id||""),c=String(o.transactionId||""),f=String(o.reference||o.transactionReference||"");return!M.has(d)&&(!c||!M.has(c))&&(!f||!M.has(f))});O(m.map(Oe))},r=()=>{const a=z(U(E,"userTransactions"),_("userId","==",s.uid));e=Te(a,n=>{try{l(n.docs)}catch(m){console.error("خطأ في معالجة بيانات الاشتراك الاحتياطي:",m)}},n=>{console.error("خطأ في الاشتراك الاحتياطي لمعاملات المستخدم:",n)})};(async()=>{try{const a=z(U(E,"userTransactions"),_("userId","==",s.uid)),n=await fs(a);if(n&&n.docs&&n.docs.length>0)try{l(n.docs)}catch{}}catch{}})();try{let a=z(U(E,"userTransactions"),_("userId","==",s.uid),gs("createdAt","desc"),limit(200));try{e=Te(a,{includeMetadataChanges:!0},n=>{try{l(n.docs)}catch(m){console.error("خطأ في معالجة بيانات الاشتراك:",m)}},n=>{if(console.error("خطأ في الاشتراك لمعاملات المستخدم:",n),!i){i=!0;try{e&&e()}catch{}r()}})}catch{const m=z(U(E,"userTransactions"),_("userId","==",s.uid));e=Te(m,o=>{try{l(o.docs)}catch{}},o=>{console.error("خطأ في الاشتراك البسيط لمعاملات المستخدم:",o),i||(i=!0,r())})}}catch(a){console.error("فشل إعداد الاشتراك الفوري لمعاملات المستخدم، بدء السقوط الاحتياطي:",a),r()}return()=>{try{e&&e()}catch{}}},[s==null?void 0:s.uid]);const Xt=async()=>{try{if(!s)return;let e=await V.getUserTransactions(s.uid);if(!e||e.length===0)try{const n=await V.getByUserId(s.uid);e=Array.isArray(n)?n:[]}catch{}let i=[];try{const n=z(U(E,"deletedTransactions"),_("userId","==",s.uid),_("permanent","==",!0));i=(await se(n)).docs.flatMap(o=>{const d=o.data();return[d.originalTransactionId,d.transactionId,d.reference,o.id].filter(Boolean).map(String)})}catch{}const l=new Set(i),a=(e||[]).map(n=>({...n,createdAt:n.createdAt instanceof Date?n.createdAt:new Date(n.createdAt)})).filter(n=>!((n==null?void 0:n.type)==="report"||((n==null?void 0:n.title)||"").includes("إيصال تسليم وردية"))).filter(n=>{const m=String(n.id||""),o=String(n.transactionId||""),d=String(n.reference||n.transactionReference||"");return!l.has(m)&&(!o||!l.has(o))&&(!d||!l.has(d))});O(a.map(Oe))}catch(e){console.error("خطأ في تحميل معاملات المستخدم من Firestore:",e),j({title:"فشل جلب معاملات المستخدم",description:"قد تكون المشكلة صلاحيات Firestore أو اتصال الشبكة. سيتم عرض المتاح محليًا إن وُجد. جرّب تسجيل الدخول مجددًا أو افتح صفحة اختبار المصادقة.",variant:"destructive"})}},Jt=async()=>{try{if(!s)return;const i=(await ie.getDeletedTransactionsByUser(s.uid)).map(l=>({...l,createdAt:l.createdAt instanceof Date?l.createdAt:new Date(l.createdAt)}));C(i.map(Oe))}catch(e){console.error("خطأ في تحميل المعاملات المحذوفة من Firestore:",e),j({title:"فشل جلب المعاملات المحذوفة",description:"تحقق من الصلاحيات والاتصال. يمكن مراجعة صفحة اختبار المصادقة للتشخيص.",variant:"destructive"})}},oe=we.useMemo(()=>{const e=ee.keepLastCount??30;return[...N].sort((l,r)=>r.createdAt.getTime()-l.createdAt.getTime()).slice(0,e)},[N,ee.keepLastCount]),Yt=we.useMemo(()=>Math.max(0,((N==null?void 0:N.length)||0)-(ee.keepLastCount||30)),[N==null?void 0:N.length,ee.keepLastCount]),at=oe.filter(e=>{const i=!X||e.senderPhone.includes(X)||e.receiverPhone.includes(X),l=!q||e.createdAt.toDateString()===new Date(q).toDateString(),r=!G||e.createdAt.toTimeString().startsWith(G);return i&&l&&r}),ye=(e,i)=>{switch(e){case"completed":return t.jsx(Vs,{className:`h-4 w-4 ${i==="withdraw"?"text-red-500":"text-green-500"}`});case"pending":return t.jsx(Ue,{className:"h-4 w-4 text-yellow-500"});case"cancelled":return t.jsx($s,{className:"h-4 w-4 text-red-500"});default:return t.jsx(Ue,{className:"h-4 w-4 text-gray-500"})}},Ee=e=>{switch(e){case"completed":return"مكتمل";case"pending":return"قيد المراجعة";case"cancelled":return"ملغي";default:return"غير معروف"}},Oe=e=>{const i=((e==null?void 0:e.status)??"").toString().toLowerCase(),l=i==="confirmed"||i==="success"||i==="completed"?"completed":i==="failed"||i==="error"||i==="cancelled"||i==="canceled"?"cancelled":"pending",a=((e==null?void 0:e.type)??(e==null?void 0:e.txnType)??"").toString().toLowerCase()==="withdraw"?"withdraw":"send",n=(e==null?void 0:e.senderPhone)??(e==null?void 0:e.senderMsisdn)??(e==null?void 0:e.sender_msisdn)??(e==null?void 0:e.sender)??(e==null?void 0:e.from)??"",m=(e==null?void 0:e.receiverPhone)??(e==null?void 0:e.receiverMsisdn)??(e==null?void 0:e.receiver_msisdn)??(e==null?void 0:e.receiver)??(e==null?void 0:e.to)??"",o=e==null?void 0:e.createdAt,d=o instanceof Date?o:o!=null&&o.toDate?o.toDate():new Date(o);return{id:e==null?void 0:e.id,senderPhone:n||"غير معروف",receiverPhone:m||"غير معروف",amount:Number((e==null?void 0:e.amount)??0),status:l,type:a,createdAt:d,commission:(e==null?void 0:e.commission)??void 0,withdrawnAmount:(e==null?void 0:e.withdrawnAmount)??void 0,sentAmount:(e==null?void 0:e.sentAmount)??void 0,fromWallet:(e==null?void 0:e.fromWallet)??(e==null?void 0:e.walletId)??void 0,cashierName:(e==null?void 0:e.cashierName)??(e==null?void 0:e.createdByName)??(e==null?void 0:e.cashier)??void 0,commissionMode:(e==null?void 0:e.commissionMode)??(e==null?void 0:e.commission_mode)??void 0,totalCharged:(e==null?void 0:e.totalCharged)??void 0,walletEffectAppliedOnCreation:(e==null?void 0:e.walletEffectAppliedOnCreation)??(e==null?void 0:e.effectsAppliedOnCreation)??(e==null?void 0:e.effectAppliedOnCreation)??!1,fee:(e==null?void 0:e.fee)??void 0}},Zt=e=>({id:e.id,type:e.type==="send"?"transfer":"withdraw",sender_msisdn:e.senderPhone,receiver_msisdn:e.receiverPhone,amount:e.amount,commission:e.commission||0,status:e.status==="cancelled"?"failed":e.status,createdAt:e.createdAt.toISOString(),updatedAt:e.createdAt.toISOString(),shopName:k??(b==null?void 0:b.shopName)??(s==null?void 0:s.displayName)??"المحل",cashierName:(e==null?void 0:e.cashierName)??null,commissionMode:(e==null?void 0:e.commissionMode)??void 0,totalCharged:(e==null?void 0:e.totalCharged)??void 0,fee:(e==null?void 0:e.fee)??void 0,note:(e==null?void 0:e.note)??(e==null?void 0:e.notes)??void 0}),Ie=e=>{const i=Zt(e);qt(i),ke(!0)},Kt=e=>{u(e),Z(!0)},Qt=async()=>{g&&(await es(g.id),Z(!1),u(null))},es=async e=>{try{const i=w.find(a=>a.id===e);if(!i||!s)return;const l=await V.saveUserTransaction(s.uid,{...i,userId:s.uid,status:"completed",cashierName:i.cashierName??"الحساب الرئيسي"});await ie.permanentlyDeleteTransaction(e,s.uid);const r={...i,id:l};O(a=>[...a,r]),C(a=>a.filter(n=>n.id!==e)),j({title:"تم الاسترجاع",description:"تم استرجاع الإيصال إلى حسابك."})}catch(i){console.error("خطأ في استرجاع المعاملة من Firestore:",i),j({title:"فشل الاسترجاع",description:"تحقق من الاتصال ثم أعد المحاولة.",variant:"destructive"})}},ts=async e=>{try{if(!s)return;C(i=>i.filter(l=>l.id!==e)),await ie.permanentlyDeleteTransaction(e,s.uid),await V.removeUserTransaction(s.uid,e),j({title:"تم الحذف نهائيًا",description:"الإيصال لن يعود بعد التحديث."})}catch(i){console.error("فشل الحذف النهائي للمعاملة:",i),j({title:"خطأ في الحذف النهائي",description:"تحقق من الاتصال ثم أعد المحاولة.",variant:"destructive"})}},rt=async e=>{var i,l,r;try{const a=N.find(f=>f.id===e);if(!a||!s)return;try{const f=(i=x==null?void 0:x.subscription)==null?void 0:i.planType;if(f===$.ZERO){const{dailyOperationCountService:v}=await H(async()=>{const{dailyOperationCountService:R}=await import("./dailyOperationCountService-BUlwZZKI.js");return{dailyOperationCountService:R}},__vite__mapDeps([0,1,2]),import.meta.url),y=a.type==="send"?"transfer":"withdraw";if(!(await v.checkAndIncrement(s.uid,y,5)).allowed){j({title:"تم بلوغ حد باقة الزيرو",description:"مسموح بحد أقصى 5 تأكيدات يوميًا للتحويل/السحب. جرّب غدًا أو قم بالترقية.",variant:"destructive"});return}}else if(f===$.TAHWEELA){const{dailyOperationCountService:v}=await H(async()=>{const{dailyOperationCountService:R}=await import("./dailyOperationCountService-BUlwZZKI.js");return{dailyOperationCountService:R}},__vite__mapDeps([0,1,2]),import.meta.url),y=a.type==="send"?"transfer":"withdraw";if(!(await v.checkAndIncrementCombined(s.uid,y,40)).allowed){j({title:"تم بلوغ حد باقة تحويله",description:"هذه الباقة تسمح بحد أقصى 40 عملية تحويل/سحب يومياً.",variant:"destructive"});return}}}catch(f){console.warn("تعذر التحقق من حد التأكيد اليومي:",f)}const n=await We.getById(s.uid);if(!(n!=null&&n.shopId))throw new Error("لا يمكن تحديد معرف المتجر (shopId) للمستخدم");const m=te(E,"dashboardData",n.shopId),o=await ae(m);let d=o.exists()?Number(((l=o.data())==null?void 0:l.cashBalance)||0):0,c=o.exists()?((r=o.data())==null?void 0:r.walletBalances)||{}:{};if(a.type==="withdraw"){const f=a.fromWallet||Object.keys(c)[0],v=Number(a.withdrawnAmount??a.amount??0),y=Number(a.commission??0);if(!!!(a!=null&&a.walletEffectAppliedOnCreation)&&f&&v>0){const R=c[f]||0;c[f]=R+v}d=d-v+y,await ze(m,{cashBalance:d,walletBalances:c})}await ze(te(E,"userTransactions",e),{status:"completed",confirmedAt:new Date}),O(f=>f.map(v=>v.id===e?{...v,status:"completed"}:v)),j({title:"تم الإكمال",description:"تم وسم المعاملة كمكتملة."}),ke(!1)}catch(a){console.error("خطأ في إكمال المعاملة:",a),j({title:"فشل الإكمال",description:"تحقق من الاتصال ثم أعد المحاولة.",variant:"destructive"})}},nt=async e=>{var i,l;try{const r=N.find(a=>a.id===e);if(!r||!s)return;O(a=>a.filter(n=>n.id!==e)),C(a=>[{...r},...a]);try{let a={};try{const d=await ae(te(E,"userTransactions",e));a=d.exists()?d.data():{}}catch{}const n=e,m=String((a==null?void 0:a.transactionId)||(r==null?void 0:r.transactionId)||n),o=String((a==null?void 0:a.reference)||(a==null?void 0:a.transactionReference)||(r==null?void 0:r.reference)||(r==null?void 0:r.transactionReference)||"");await V.removeUserTransaction(s.uid,e),await ie.saveDeletedTransaction({...r,userId:s.uid,originalTransactionId:e,transactionId:m,reference:o||void 0,permanent:!0});try{await ie.permanentlyDeleteTransaction(e,s.uid)}catch{}}catch(a){console.warn("تعذر الحذف النهائي من قواعد البيانات في هذه الخطوة، سيتم الحذف من لائحة المحذوفات عند التنفيذ اليدوي للحذف النهائي:",a)}try{const a=await We.getById(s.uid);if(!(a!=null&&a.shopId))throw new Error("لا يمكن تحديد معرف المتجر (shopId) للمستخدم");const n=te(E,"dashboardData",a.shopId),m=await ae(n);let o=m.exists()?Number(((i=m.data())==null?void 0:i.cashBalance)||0):0,d=m.exists()?((l=m.data())==null?void 0:l.walletBalances)||{}:{};const c=Number(r.withdrawnAmount??r.amount??0),f=Number(r.commission??0),v=r.fromWallet||Object.keys(d)[0],y=!!(r!=null&&r.walletEffectAppliedOnCreation);if(r.type==="send"){const D=Number(r.fee??0),R=f+D;if(o-=R,v&&c>0){const Y=d[v]||0;d[v]=Y+c}}else if(r.type==="withdraw"){if(r.status==="completed"){if(o=o+c-f,v&&c>0){const D=d[v]||0;d[v]=D-c}}else if(v&&y&&c>0){const D=d[v]||0;d[v]=D-c}}await ze(n,{cashBalance:o,walletBalances:d})}catch(a){console.warn("فشل عكس تأثير الأرصدة محليًا:",a)}try{const a=r.fromWallet;if(a){const{walletDailyLimitsService:n}=await H(async()=>{const{walletDailyLimitsService:o}=await import("./walletDailyLimitsService-CbdZ_7wZ.js");return{walletDailyLimitsService:o}},__vite__mapDeps([3,1,2]),import.meta.url),m=await n.getWalletLimits(a);if(m){const o=r.type==="send",d={updatedAt:(await H(async()=>{const{serverTimestamp:D}=await import("./index-BaJ4CYlQ.js").then(R=>R.bg);return{serverTimestamp:D}},__vite__mapDeps([1,2]),import.meta.url)).serverTimestamp()};o?(d.dailyTransferUsed=Math.max(0,(m.dailyTransferUsed||0)-r.amount),d.monthlyTransferUsed=Math.max(0,(m.monthlyTransferUsed||0)-r.amount)):(d.dailyWithdrawUsed=Math.max(0,(m.dailyWithdrawUsed||0)-r.amount),d.monthlyWithdrawUsed=Math.max(0,(m.monthlyWithdrawUsed||0)-r.amount));const{doc:c,setDoc:f}=await H(async()=>{const{doc:D,setDoc:R}=await import("./index-BaJ4CYlQ.js").then(Y=>Y.bg);return{doc:D,setDoc:R}},__vite__mapDeps([1,2]),import.meta.url),{db:v}=await H(async()=>{const{db:D}=await import("./index-BaJ4CYlQ.js").then(R=>R.bh);return{db:D}},__vite__mapDeps([1,2]),import.meta.url),y=c(v,"walletLimits",a);await f(y,d,{merge:!0})}}}catch(a){console.warn("فشل استرجاع حدود المحفظة:",a)}try{const{ProfitService:a}=await H(async()=>{const{ProfitService:c}=await import("./profitService-Bj9jIfaS.js").then(f=>f.p);return{ProfitService:c}},__vite__mapDeps([4,1,2]),import.meta.url),{ReportsService:n}=await H(async()=>{const{ReportsService:c}=await import("./profitService-Bj9jIfaS.js").then(f=>f.a);return{ReportsService:c}},__vite__mapDeps([4,1,2]),import.meta.url),o={txnType:r.type==="send"?"send":"receive",amount:r.amount,commission:r.commission||0,createdAt:r.createdAt,status:"confirmed"},d=a.calculateProfitFromTransaction(o);d>0&&a.addProfit(-d,s.uid);try{n.removeTransactionEffects(r,s.uid)}catch{}}catch(a){console.warn("فشل تحديث التقارير/الأرباح بعد الحذف:",a)}}catch(r){console.error("خطأ أثناء حذف الإيصال:",r)}},ot=p.useRef(!1),it=bs();p.useEffect(()=>{!(new URLSearchParams(it.search).get("autoTestBalances")==="1")||ot.current||(ot.current=!0,(async()=>{var l,r,a,n,m,o;try{if(!s)return;const d=await We.getById(s.uid);if(!(d!=null&&d.shopId)){console.warn("autoTest: لا يوجد shopId للمستخدم، سيتم إيقاف الاختبار.");return}const c=te(E,"dashboardData",d.shopId),f=await ae(c),v=f.exists()?Number(((l=f.data())==null?void 0:l.cashBalance)||0):0,y=f.exists()?((r=f.data())==null?void 0:r.walletBalances)||{}:{},D=Object.keys(y)[0]||void 0,R=100,Y=5,Le=await V.saveUserTransaction(s.uid,{senderPhone:"auto-test-sender",receiverPhone:"auto-test-receiver",amount:R,status:"pending",type:"withdraw",createdAt:new Date,reference:`AUTO-${Date.now()}`,commission:Y,withdrawnAmount:R,fromWallet:D,cashierName:"AutoTest",commissionMode:"add",totalCharged:R+Y,walletEffectAppliedOnCreation:!1});console.log("autoTest: تم إنشاء إيصال سحب تجريبي:",Le),await rt(Le);const je=await ae(c),as=je.exists()?Number(((a=je.data())==null?void 0:a.cashBalance)||0):0,rs=je.exists()?((n=je.data())==null?void 0:n.walletBalances)||{}:{},ns=v-R+Y,os=D?Number(y[D]||0)+R:void 0;console.log("autoTest: توقع الدرج بعد الإكمال:",ns,"فعلي:",as),D&&console.log("autoTest: توقع المحفظة بعد الإكمال:",os,"فعلي:",rs[D]),await nt(Le);const Ne=await ae(c),is=Ne.exists()?Number(((m=Ne.data())==null?void 0:m.cashBalance)||0):0,ls=Ne.exists()?((o=Ne.data())==null?void 0:o.walletBalances)||{}:{};console.log("autoTest: تحقق نهائي — الدرج قبل/بعد الحذف:",v,is),D&&console.log("autoTest: تحقق نهائي — المحفظة قبل/بعد الحذف:",y[D]||0,ls[D]||0),j({title:"اختبار الأرصدة (Firestore فقط)",description:"تم إنشاء/إكمال/حذف إيصال تجريبي والتحقق من الأرصدة.",variant:"default"})}catch(d){console.error("autoTest: فشل اختبار الأرصدة:",d),j({title:"فشل اختبار الأرصدة",description:"تحقق من الاتصال ووجود shopId والمحافظ في Firestore.",variant:"destructive"})}})())},[it.search,s]);const ss=async()=>{var l,r,a;const e="alkaptin678678@gmail.com",i=(r=(l=Fe.currentUser)==null?void 0:l.email)==null?void 0:r.toLowerCase();if(!i||i!==e){j({title:"قيد الإنشاء",description:"ميزة الشحن متاحة لهذا الحساب فقط حالياً."});return}if(!ge||!ne||!be){j({title:"بيانات ناقصة",description:"يرجى إدخال رقم وشركة والمبلغ",variant:"destructive"});return}tt(!0);try{const m={vodafone_eg:"Vodafone",orange_eg:"Orange",etisalat_eg:"Etisalat",we_eg:"WE"}[ne]??ne,o=new AbortController,d=setTimeout(()=>o.abort(),15e3),c=await((a=Fe.currentUser)==null?void 0:a.getIdToken()),f=await fetch("/api/topup",{method:"POST",headers:{"Content-Type":"application/json",...c?{Authorization:`Bearer ${c}`}:{}},body:JSON.stringify({phone:ge,countryCode:"EG",operator:m,amount:Number(be),useLocalAmount:!0}),signal:o.signal});clearTimeout(d);const v=await f.text();let y;try{y=JSON.parse(v)}catch{y={success:!1,message:v||"فشل قراءة استجابة الخادم"}}f.ok&&(y!=null&&y.success)?(j({title:"تم الشحن",description:(y==null?void 0:y.message)||"تم تنفيذ عملية الشحن بنجاح"}),fe(!1),Ze(""),Ke(""),Qe("")):j({title:"فشل الشحن",description:(y==null?void 0:y.message)||"حدث خطأ أثناء طلب الشحن",variant:"destructive"})}catch(n){console.error("Topup request error:",n),(n==null?void 0:n.name)==="AbortError"?j({title:"انتهت المهلة",description:"الخادم لم يستجب في الوقت المحدد. تأكد أن السيرفر يعمل.",variant:"destructive"}):j({title:"خطأ في الاتصال",description:"تعذر الاتصال بالخادم. حاول لاحقاً.",variant:"destructive"})}finally{tt(!1)}};return t.jsxs("div",{className:"fixed inset-0 overscroll-y-none overflow-y-auto bg-background p-4",children:[t.jsxs("div",{className:"max-w-4xl mx-auto",children:[t.jsxs("div",{className:"flex items-center gap-4 mb-6",children:[t.jsxs(A,{variant:"ghost",size:"sm",onClick:()=>h("/user/dashboard"),className:"flex items-center gap-2 text-gray-600 hover:text-gray-800",children:[t.jsx(zs,{className:"h-4 w-4"}),"العودة"]}),t.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:"المعاملات"})]}),t.jsxs(js,{className:"card-modern fade-in-up",children:[t.jsxs(Ns,{className:"pb-2 px-3 pt-3",children:[t.jsx(ws,{className:"text-sm font-bold",children:"المعاملات الأخيرة"}),t.jsxs("div",{className:"flex items-center gap-0.5 mt-1 relative",children:[t.jsxs("div",{className:"flex items-center gap-0.5 flex-1 bg-gray-50 rounded px-1 py-0.5 border border-gray-200 hover:border-blue-300 transition-all duration-200 group relative overflow-hidden max-w-[140px] md:max-w-[220px]",children:[t.jsx(Us,{className:"h-2 w-2 text-gray-400 group-hover:text-blue-600 transition-colors"}),t.jsx(Be,{placeholder:"بحث...",value:X,onChange:e=>me(e.target.value),className:"h-3 text-[8px] border-0 bg-transparent focus:ring-0 focus:outline-none text-gray-700 placeholder:text-gray-400"})]}),t.jsxs("div",{className:"hidden md:flex items-center gap-1",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(Zs,{userId:s==null?void 0:s.uid,transactions:N}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"أرباح"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(A,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 rounded bg-emerald-50 text-emerald-600 hover:bg-emerald-100 border border-emerald-200 hover:border-emerald-300 transition-all duration-200 hover:scale-105",onClick:()=>{j({title:"قيد الإنشاء",description:"هذه الميزة قيد الإنشاء حالياً."})},title:"نافذة شحن سريعة",children:t.jsx(ht,{className:"h-2.5 w-2.5"})}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"شحن"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(A,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 rounded bg-blue-50 text-blue-600 hover:bg-blue-100 border border-blue-200 hover:border-blue-300 transition-all duration-200 hover:scale-105",onClick:()=>K(!0),title:"آلة حاسبة",children:t.jsx(Is,{className:"h-2.5 w-2.5"})}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"حاسبة"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(A,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 rounded bg-green-50 text-green-600 hover:bg-green-100 border border-green-200 hover:border-green-300 transition-all duration-200 hover:scale-105",onClick:()=>{if(P){j({title:"الخطة الحالية لا تسمح",description:"بيانات المبيعات غير متاحة في خطة زيرو. قم بالترقية."});return}J(!0)},title:"بيانات المبيعات",children:t.jsx(Ls,{className:"h-2.5 w-2.5"})}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"مبيعات"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsxs(A,{variant:"ghost",size:"sm",className:`h-5 w-5 p-0 rounded border transition-all duration-200 hover:scale-105 ${q||G?"bg-purple-100 text-purple-600 border-purple-300":"bg-purple-50 text-purple-600 hover:bg-purple-100 border-purple-200 hover:border-purple-300"}`,onClick:()=>Wt(!0),title:"اختيار التاريخ",children:[t.jsx(wt,{className:"h-2.5 w-2.5"}),(q||G)&&t.jsx("div",{className:"absolute -top-0.5 -right-0.5 h-1 w-1 bg-purple-500 rounded-full"})]}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"تاريخ"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(A,{variant:"ghost",size:"sm",className:"relative h-5 w-5 p-0 rounded bg-orange-50 text-orange-600 hover:bg-orange-100 border border-orange-200 hover:border-orange-300 transition-all duration-200 hover:scale-105",onClick:()=>{if(P){j({title:"الخطة الحالية لا تسمح",description:"إدارة الديون غير متاحة في خطة زيرو. قم بالترقية."});return}Pe(!0)},title:"إدارة الديون",children:t.jsxs("div",{className:"relative inline-flex items-center justify-center h-full w-full",children:[t.jsx(vs,{className:"h-2.5 w-2.5"}),st>0&&t.jsx("div",{className:"absolute -top-1 -right-1 z-10 min-w-[12px] h-[12px] px-[2px] bg-red-600 text-white rounded-full text-[8px] leading-[12px] flex items-center justify-center pointer-events-none ring-1 ring-white",children:st})]})}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"ديون"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(A,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 rounded bg-amber-50 text-amber-700 hover:bg-amber-100 border border-amber-200 hover:border-amber-300 transition-all duration-200 hover:scale-105",onClick:()=>{if(P){j({title:"الخطة الحالية لا تسمح",description:"الصيانة غير متاحة في خطة زيرو. قم بالترقية."});return}Ye(!0)},title:"الصيانة",children:t.jsx(ys,{className:"h-2.5 w-2.5"})}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"صيانه"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(A,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 rounded bg-violet-50 text-violet-600 hover:bg-violet-100 border border-violet-200 hover:border-violet-300 transition-all duration-200 hover:scale-105",onClick:()=>{h("/user/dashboard",{state:{openCashierShiftModal:!0}})},title:"يومية المكنة",children:t.jsx(qs,{className:"h-2.5 w-2.5"})}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"المكنة"})]}),t.jsxs("div",{className:"hidden sm:flex items-center gap-1",children:[t.jsx(A,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 rounded bg-indigo-50 text-indigo-600 hover:bg-indigo-100 border border-indigo-200 hover:border-indigo-300 transition-all duration-200 hover:scale-105",onClick:()=>{if(P){j({title:"الخطة الحالية لا تسمح",description:"الفيز الائتمانية غير متاحة في خطة زيرو. قم بالترقية."});return}Je(!0)},title:"الفيز الائتمانية",children:t.jsx(ht,{className:"h-2.5 w-2.5"})}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"فيز"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsxs(A,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 rounded bg-red-50 text-red-600 hover:bg-red-100 border border-red-200 hover:border-red-300 transition-all duration-200 hover:scale-105 relative",onClick:()=>{he(!0)},title:"تصفير المعاملات الأخيرة",children:[t.jsx(vt,{className:"h-2.5 w-2.5"}),Yt>0&&t.jsx("div",{className:"absolute -top-0.5 -right-0.5 h-1 w-1 bg-red-500 rounded-full"})]}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"تصفير"})]}),(X||q||G)&&t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(A,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 rounded bg-red-50 text-red-500 hover:bg-red-100 border border-red-200 hover:border-red-300 transition-all duration-200 hover:scale-105",onClick:()=>{me(""),pe(""),ue("")},title:"مسح",children:t.jsx("span",{className:"text-[10px] font-bold",children:"×"})}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"مسح"})]})]})]})]}),t.jsx(Ts,{className:"px-3 pb-3",children:t.jsxs(Js,{value:T,onValueChange:F,className:"w-full",children:[t.jsxs(Mt,{className:"hidden sm:grid w-full grid-cols-4 h-10 text-sm bg-gradient-to-r from-gray-50 via-blue-50/30 to-purple-50/30 border border-gray-200/60 rounded-md p-1 shadow-sm relative overflow-hidden",children:[t.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-blue-500/5 via-purple-500/5 to-pink-500/5 opacity-0 hover:opacity-100 transition-all duration-200"}),t.jsxs(ce,{value:"all",className:"text-sm relative z-10 rounded transition-all duration-300  data-[state=active]:bg-gradient-to-r data-[state=active]:from-blue-500 data-[state=active]:to-blue-600 data-[state=active]:text-white data-[state=active]:shadow-md data-[state=active]:shadow-blue-200/50 hover:bg-blue-50/80 hover:text-blue-700 group",children:[t.jsx("span",{className:"relative z-10",children:"الكل"}),t.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-blue-500/10 to-purple-500/10 opacity-0 group-hover:opacity-100 transition-all duration-300 rounded"})]}),t.jsxs(ce,{value:"send",className:"text-sm relative z-10 rounded transition-all duration-300  data-[state=active]:bg-gradient-to-r data-[state=active]:from-green-500 data-[state=active]:to-emerald-600 data-[state=active]:text-white data-[state=active]:shadow-md data-[state=active]:shadow-green-200/50 hover:bg-green-50/80 hover:text-green-700 group",children:[t.jsx("span",{className:"relative z-10",children:"مرسل"}),t.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-green-500/10 to-emerald-500/10 opacity-0 group-hover:opacity-100 transition-all duration-300 rounded"})]}),t.jsxs(ce,{value:"withdraw",className:"text-sm relative z-10 rounded transition-all duration-300  data-[state=active]:bg-gradient-to-r data-[state=active]:from-orange-500 data-[state=active]:to-amber-600 data-[state=active]:text-white data-[state=active]:shadow-md data-[state=active]:shadow-orange-200/50 hover:bg-orange-50/80 hover:text-orange-700 group",children:[t.jsx("span",{className:"relative z-10",children:"سحب"}),t.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-orange-500/10 to-amber-500/10 opacity-0 group-hover:opacity-100 transition-all duration-300 rounded"})]}),t.jsxs(ce,{value:"deleted",className:"text-sm relative z-10 rounded transition-all duration-300  data-[state=active]:bg-gradient-to-r data-[state=active]:from-red-500 data-[state=active]:to-rose-600 data-[state=active]:text-white data-[state=active]:shadow-md data-[state=active]:shadow-red-200/50 hover:bg-red-50/80 hover:text-red-700 group",children:[t.jsx("span",{className:"relative z-10",children:"محذوف"}),t.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-red-500/10 to-rose-500/10 opacity-0 group-hover:opacity-100 transition-all duration-300 rounded"})]})]}),t.jsx(de,{value:"all",className:"mt-2 receipts-list",children:at.length===0?t.jsx("div",{className:"text-center py-4 text-gray-500 fade-in-up tab-stagger-item text-[10px]",children:"لا توجد معاملات محفوظة بعد"}):t.jsx("div",{className:"space-y-1 fade-in-up tab-content-smooth max-h-[600px] overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400",children:at.map((e,i)=>t.jsxs("div",{className:"receipts-row flex items-center justify-between p-3 bg-white rounded-lg border hover:shadow-md cursor-pointer transition-all duration-200",onClick:()=>Ie(e),children:[t.jsxs("div",{className:"flex items-center gap-1",children:[ye(e.status,e.type),t.jsxs("div",{children:[t.jsx("p",{className:`font-medium text-sm ${e.type==="withdraw"?"text-red-700":"text-green-700"}`,children:e.type==="withdraw"?e.receiverPhone:`${e.senderPhone} → ${e.receiverPhone}`}),e.type==="withdraw"&&t.jsxs(t.Fragment,{children:[t.jsxs("p",{className:"text-sm font-semibold text-red-600",children:[W(e.amount)," جنيه"]}),t.jsxs("p",{className:"text-xs text-red-600",children:["عمولة: ",W(e.commission||0)," جنيه"]})]}),t.jsxs("p",{className:`text-[10px] ${e.type==="withdraw"?"text-red-700":"text-green-700"}`,children:["تمت بواسطة: ",e.cashierName??"الحساب الرئيسي"]}),t.jsx("p",{className:`text-sm ${e.type==="withdraw"?"text-red-500":"text-green-600"}`,children:e.createdAt.toLocaleString("en-GB")})]})]}),t.jsxs("div",{className:"text-right",children:[e.type!=="withdraw"&&t.jsxs("p",{className:"font-bold text-sm text-green-700",children:[W(e.amount)," جنيه"]}),e.withdrawnAmount&&t.jsxs("p",{className:"text-sm text-red-600",children:["مسحوب: ",W(e.withdrawnAmount)," جنيه"]}),e.sentAmount&&t.jsxs("p",{className:"text-sm text-green-600",children:["مرسل: ",W(e.sentAmount)," جنيه"]}),t.jsx(De,{variant:e.status==="completed"?"default":"secondary",className:`text-sm ${e.status==="completed"?e.type==="withdraw"?"bg-red-100 text-red-800 border-red-300":e.type==="send"?"bg-green-100 text-green-800 border-green-300":"":e.type==="withdraw"?"bg-red-100 text-red-800":""}`,children:e.type==="withdraw"?"سحب":Ee(e.status)})]})]},e.id))})}),t.jsx(de,{value:"send",className:"mt-2 receipts-list",children:oe.filter(e=>e.type==="send").length===0?t.jsx("div",{className:"text-center py-4 text-gray-500 fade-in-up tab-stagger-item text-[10px]",children:"لا توجد معاملات إرسال محفوظة بعد"}):t.jsx("div",{className:"space-y-1 fade-in-up tab-content-smooth max-h-[600px] overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400",children:oe.filter(e=>e.type==="send").map((e,i)=>t.jsxs("div",{className:"receipts-row flex items-center justify-between p-3 rounded-lg border cursor-pointer transition-all duration-200",onClick:()=>Ie(e),children:[t.jsxs("div",{className:"flex items-center gap-1",children:[ye(e.status,e.type),t.jsxs("div",{children:[t.jsxs("p",{className:"font-medium text-sm text-green-700",children:[e.senderPhone," → ",e.receiverPhone]}),t.jsxs("p",{className:"text-[10px] text-green-700",children:["تمت بواسطة: ",e.cashierName??"الحساب الرئيسي"]}),t.jsx("p",{className:"text-sm text-green-600",children:e.createdAt.toLocaleString("ar-EG")})]})]}),t.jsxs("div",{className:"text-right",children:[t.jsxs("p",{className:"font-bold text-sm text-green-700",children:[W(e.amount)," جنيه"]}),e.sentAmount&&t.jsxs("p",{className:"text-sm text-green-600",children:["مرسل: ",W(e.sentAmount)," جنيه"]}),t.jsx(De,{variant:e.status==="completed"?"default":"secondary",className:`text-sm ${e.status==="completed"?"bg-green-100 text-green-800 border-green-300":""}`,children:Ee(e.status)})]})]},e.id))})}),t.jsx(de,{value:"withdraw",className:"mt-2 receipts-list",children:oe.filter(e=>e.type==="withdraw").length===0?t.jsx("div",{className:"text-center py-4 text-gray-500 fade-in-up tab-stagger-item text-[10px]",children:"لا توجد معاملات سحب محفوظة بعد"}):t.jsx("div",{className:"space-y-1 max-h-[600px] overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400",children:oe.filter(e=>e.type==="withdraw").map((e,i)=>t.jsxs("div",{className:"receipts-row flex items-center justify-between p-3 rounded-lg border cursor-pointer",onClick:()=>Ie(e),children:[t.jsxs("div",{className:"flex items-center gap-1",children:[ye(e.status,e.type),t.jsxs("div",{children:[t.jsx("p",{className:"font-medium text-sm text-red-700",children:e.receiverPhone}),t.jsxs("p",{className:"text-[10px] text-red-700",children:["تمت بواسطة: ",e.cashierName??"الحساب الرئيسي"]}),t.jsx("p",{className:"text-sm text-red-500",children:e.createdAt.toLocaleString("ar-EG")})]})]}),t.jsxs("div",{className:"text-right",children:[t.jsxs("p",{className:"font-bold text-sm text-red-700",children:[W(e.amount)," جنيه"]}),e.withdrawnAmount&&t.jsxs("p",{className:"text-sm text-red-600",children:["مسحوب: ",W(e.withdrawnAmount)," جنيه"]}),t.jsx(De,{variant:e.status==="completed"?"default":"secondary",className:`text-sm ${e.status==="completed"?"bg-red-100 text-red-800 border-red-300":"bg-red-100 text-red-800"}`,children:Ee(e.status)})]})]},e.id))})}),t.jsx(de,{value:"deleted",className:"mt-2",children:w.length===0?t.jsx("div",{className:"text-center py-4 text-gray-500 fade-in-up tab-stagger-item text-[10px]",children:"لا توجد معاملات محذوفة"}):t.jsx("div",{className:"space-y-1 max-h-[600px] overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400",children:w.map((e,i)=>t.jsxs("div",{className:"receipts-row flex items-center justify-between p-3 rounded-lg border",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[ye(e.status,e.type),t.jsxs("div",{children:[t.jsx("p",{className:"font-medium text-sm text-red-700",children:e.type==="withdraw"?e.receiverPhone:`${e.senderPhone} → ${e.receiverPhone}`}),e.type==="withdraw"&&t.jsxs(t.Fragment,{children:[t.jsxs("p",{className:"text-sm font-semibold text-red-600",children:[W(e.amount)," جنيه"]}),t.jsxs("p",{className:"text-xs text-orange-500",children:["عمولة: ",W(e.commission||0)," جنيه"]})]}),t.jsxs("p",{className:"text-[10px] text-red-700",children:["تمت بواسطة: ",e.cashierName??"الحساب الرئيسي"]}),t.jsx("p",{className:"text-sm text-red-500",children:e.createdAt.toLocaleString("ar-EG")})]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("div",{className:"text-right mr-2",children:[e.type!=="withdraw"&&t.jsxs("p",{className:"font-bold text-sm text-red-700",children:[W(e.amount)," جنيه"]}),t.jsx(De,{variant:"secondary",className:"text-[10px] bg-red-100 text-red-800",children:"محذوف"})]}),t.jsx(A,{variant:"ghost",size:"sm",className:"text-green-600 hover:bg-green-100 h-10 sm:h-12 px-4 sm:px-5 min-w-[44px] touch-manipulation",onClick:()=>Kt(e),children:t.jsx("span",{className:"text-xs sm:text-sm",children:"استرجاع"})}),t.jsx(A,{variant:"ghost",size:"sm",className:"text-red-600 hover:bg-red-100 h-10 sm:h-12 px-3 sm:px-4 min-w-[44px] touch-manipulation",onClick:()=>ts(e.id),children:t.jsx(vt,{className:"h-4 w-4 sm:h-5 sm:w-5"})})]})]},e.id))})})]})})]}),t.jsx(_s,{open:Ut,onOpenChange:Ye})]}),t.jsx(Ms,{isOpen:zt,onClose:()=>Je(!1)}),t.jsx(Nt,{open:Ft,onOpenChange:Pe,mode:"verify",title:"الرقم السري الرئيسي لفتح الديون",description:"أدخل الرقم السري الرئيسي لفتح صفحة الديون",onSuccess:()=>{Pe(!1),Bt(!0)}}),t.jsx(Bs,{open:Gt,onOpenChange:he,title:"تأكيد كلمة المرور لتصفير المعاملات الأخيرة",description:"سيتم حذف كل المعاملات السابقة نهائيًا من حسابك وFirebase.",onSuccess:async()=>{try{if(!(s!=null&&s.uid)){he(!1);return}const e=new Date,i=l=>l instanceof Date?l:typeof(l==null?void 0:l.toDate)=="function"?l.toDate():new Date(String(l));await V.updateUserData(s.uid,{recentReset:{keepLastCount:ee.keepLastCount??30,intervalDays:ee.intervalDays??7,lastResetAt:e}}),xe(l=>({...l,lastResetAt:e})),j({title:"تم إخفاء المعاملات السابقة",description:"تم إخفاء كل الإيصالات الأقدم من وقت التصفير من العرض بدون التأثير على التقارير اليومية/الشهرية أو الحدود."})}catch(e){console.error("فشل تنفيذ التصفير النهائي:",e),j({title:"فشل التصفير",description:"تحقق من الاتصال ثم أعد المحاولة.",variant:"destructive"})}finally{he(!1)}}}),t.jsx($e,{open:Ht,onOpenChange:e=>{var i,l;if(e){const r="alkaptin678678@gmail.com",a=(l=(i=Fe.currentUser)==null?void 0:i.email)==null?void 0:l.toLowerCase();if(!a||a!==r){j({title:"قيد الإنشاء",description:"هذه الميزة قيد الإنشاء حالياً."});return}fe(!0)}else fe(!1)},children:t.jsxs(Ve,{dir:"rtl",className:"sm:max-w-md",children:[t.jsx(qe,{children:t.jsx(Ge,{children:"شحن رصيد الموبايل"})}),t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-right mb-1",children:"رقم الموبايل"}),t.jsx(Be,{value:ge,onChange:e=>Ze(e.target.value),placeholder:"01XXXXXXXXX",dir:"ltr"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-right mb-1",children:"الشركة"}),t.jsxs(As,{value:ne,onValueChange:Ke,children:[t.jsx(Ss,{className:"w-full",children:t.jsx(Rs,{placeholder:"اختر الشركة"})}),t.jsxs(Ps,{children:[t.jsx(Ce,{value:"vodafone_eg",children:"فودافون"}),t.jsx(Ce,{value:"orange_eg",children:"أورنج"}),t.jsx(Ce,{value:"etisalat_eg",children:"اتصالات"}),t.jsx(Ce,{value:"we_eg",children:"WE"})]})]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-right mb-1",children:"المبلغ بالجنيه"}),t.jsx(Be,{type:"number",min:1,value:be,onChange:e=>Qe(e.target.value?Number(e.target.value):""),placeholder:"50"})]}),t.jsxs("div",{className:"flex items-center justify-between gap-2 pt-2",children:[t.jsx(A,{variant:"outline",onClick:()=>fe(!1),children:"إلغاء"}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(A,{variant:"secondary",onClick:()=>h("/topup"),children:"صفحة الشحن الكاملة"}),t.jsx(A,{onClick:ss,disabled:et||!ge||!ne||!be,children:et?"جارٍ التنفيذ...":"تأكيد الشحن"})]})]})]})]})}),t.jsx($e,{open:Re,onOpenChange:Z,children:t.jsxs(Ve,{className:"sm:max-w-[460px]",children:[t.jsxs(qe,{children:[t.jsx(Ge,{children:"تأكيد استرجاع الإيصال"}),t.jsx(Cs,{children:"سيتم إعادة الإيصال إلى قائمة المعاملات الحالية."})]}),g&&t.jsxs("div",{className:"mt-2 space-y-2 text-sm",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"المبلغ"}),t.jsxs("span",{className:"font-bold",children:[g.amount," جنيه"]})]}),g.type==="withdraw"?t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"العميل"}),t.jsx("span",{className:"font-medium",children:g.receiverPhone})]}):t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"من → إلى"}),t.jsxs("span",{className:"font-medium",children:[g.senderPhone," → ",g.receiverPhone]})]}),t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"الكاشير"}),t.jsx("span",{className:"font-medium",children:g.cashierName??"الحساب الرئيسي"})]}),t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"التاريخ"}),t.jsx("span",{className:"font-medium",children:g.createdAt.toLocaleString("ar-EG")})]})]}),t.jsxs("div",{className:"flex items-center justify-between gap-2 pt-3",children:[t.jsx(A,{variant:"outline",onClick:()=>{Z(!1),u(null)},children:"إلغاء"}),t.jsx(A,{onClick:Qt,children:"تأكيد الاسترجاع"})]})]})}),t.jsx(Ws,{isOpen:$t,onClose:()=>ke(!1),transaction:Vt,onPrint:()=>window.print(),onDelete:nt,onComplete:rt})]})};export{Na as default};
