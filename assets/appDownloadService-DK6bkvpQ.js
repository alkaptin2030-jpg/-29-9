import{K as Z,v as y,f as _,w as q,Q as H,T as M,V as G,W as j,s as D,H as K,X as h}from"./index-BvNyRub4.js";var T,P;const V=(P=(T=import.meta)==null?void 0:T.env)==null?void 0:P.VITE_ANDROID_DOWNLOAD_URL;var B,v;const u=(v=(B=import.meta)==null?void 0:B.env)==null?void 0:v.VITE_PC_DOWNLOAD_URL;var C,L;const f=(L=(C=import.meta)==null?void 0:C.env)==null?void 0:L.VITE_PC32_DOWNLOAD_URL;var k,J;const U=(J=(k=import.meta)==null?void 0:k.env)==null?void 0:J.VITE_ANDROID_VERSION;var x,W;const a=(W=(x=import.meta)==null?void 0:x.env)==null?void 0:W.VITE_PC_VERSION;var F,$;const m=($=(F=import.meta)==null?void 0:F.env)==null?void 0:$.VITE_PC32_VERSION;function t(e){if(e)try{const r=(e.split("?")[0].split("#")[0].split("/").pop()||"").match(/v?(\d+\.\d+(?:\.\d+)?)/i);return r==null?void 0:r[1]}catch{return}}function or(e){if(e)try{const s=e.match(/drive\.google\.com\/file\/d\/([^/]+)\//),r=e.match(/drive\.google\.com\/open\?id=([^&]+)/),o=(s==null?void 0:s[1])||(r==null?void 0:r[1]);return o?`https://drive.google.com/uc?export=download&id=${o}`:(/drive\.google\.com\/uc\?/.test(e),e)}catch{return e}}const l=["siteContent","appDownloads"],g="appDownloadsCache";function nr(){try{const s=localStorage.getItem(g);if(s){const r=JSON.parse(s),o={androidUrl:(r==null?void 0:r.androidUrl)||V,pcUrl:(r==null?void 0:r.pcUrl)||u,pc32Url:(r==null?void 0:r.pc32Url)||f,androidVersion:(r==null?void 0:r.androidVersion)||U,pcVersion:(r==null?void 0:r.pcVersion)||a,pc32Version:(r==null?void 0:r.pc32Version)||m,updatedAt:r==null?void 0:r.updatedAt,updatedBy:r==null?void 0:r.updatedBy};return o.pcVersion||(o.pcVersion=t(o.pcUrl)),o.androidVersion||(o.androidVersion=t(o.androidUrl)),o.pc32Version||(o.pc32Version=t(o.pc32Url)),o}}catch{}const e={androidUrl:V,pcUrl:u,pc32Url:f,androidVersion:U,pcVersion:a,pc32Version:m};return e.pcVersion||(e.pcVersion=t(e.pcUrl)),e.androidVersion||(e.androidVersion=t(e.androidUrl)),e.pc32Version||(e.pc32Version=t(e.pc32Url)),e}async function er(){try{const e=await Z(y(_,l[0],l[1]));if(e.exists()){const r=e.data();try{localStorage.setItem(g,JSON.stringify(r))}catch{}const o={androidUrl:(r==null?void 0:r.androidUrl)||V,pcUrl:(r==null?void 0:r.pcUrl)||u,pc32Url:(r==null?void 0:r.pc32Url)||f,androidVersion:(r==null?void 0:r.androidVersion)||U,pcVersion:(r==null?void 0:r.pcVersion)||a,pc32Version:(r==null?void 0:r.pc32Version)||m,updatedAt:r==null?void 0:r.updatedAt,updatedBy:r==null?void 0:r.updatedBy};return o.pcVersion||(o.pcVersion=t(o.pcUrl)),o.androidVersion||(o.androidVersion=t(o.androidUrl)),o.pc32Version||(o.pc32Version=t(o.pc32Url)),o}const s={androidUrl:V,pcUrl:u,pc32Url:f,androidVersion:U,pcVersion:a,pc32Version:m};return s.pcVersion||(s.pcVersion=t(s.pcUrl)),s.androidVersion||(s.androidVersion=t(s.androidUrl)),s.pc32Version||(s.pc32Version=t(s.pc32Url)),s}catch(e){const s=(e==null?void 0:e.message)||"";((e==null?void 0:e.code)||"")==="permission-denied"||s.includes("Missing or insufficient permissions")?console.warn("⚠️ Cannot read app downloads (unauth/public). Using cached or empty.",e):console.error("❌ Error loading app downloads:",e);try{const i=localStorage.getItem(g);if(i){const n=JSON.parse(i),p={androidUrl:(n==null?void 0:n.androidUrl)||V,pcUrl:(n==null?void 0:n.pcUrl)||u,pc32Url:(n==null?void 0:n.pc32Url)||f,androidVersion:(n==null?void 0:n.androidVersion)||U,pcVersion:(n==null?void 0:n.pcVersion)||a,pc32Version:(n==null?void 0:n.pc32Version)||m,updatedAt:n==null?void 0:n.updatedAt,updatedBy:n==null?void 0:n.updatedBy};return p.pcVersion||(p.pcVersion=t(p.pcUrl)),p.androidVersion||(p.androidVersion=t(p.androidUrl)),p.pc32Version||(p.pc32Version=t(p.pc32Url)),p}}catch{}const o={androidUrl:V,pcUrl:u,pc32Url:f,androidVersion:U,pcVersion:a,pc32Version:m};return o.pcVersion||(o.pcVersion=t(o.pcUrl)),o.androidVersion||(o.androidVersion=t(o.androidUrl)),o.pc32Version||(o.pc32Version=t(o.pc32Url)),o}}function ir(e){try{const s=y(_,l[0],l[1]);return q(s,o=>{const i=(o.exists()?o.data():{})||{},n={androidUrl:(i==null?void 0:i.androidUrl)||V,pcUrl:(i==null?void 0:i.pcUrl)||u,pc32Url:(i==null?void 0:i.pc32Url)||f,androidVersion:(i==null?void 0:i.androidVersion)||U,pcVersion:(i==null?void 0:i.pcVersion)||a,pc32Version:(i==null?void 0:i.pc32Version)||m,updatedAt:i==null?void 0:i.updatedAt,updatedBy:i==null?void 0:i.updatedBy};n.pcVersion||(n.pcVersion=t(n.pcUrl)),n.androidVersion||(n.androidVersion=t(n.androidUrl)),n.pc32Version||(n.pc32Version=t(n.pc32Url));try{localStorage.setItem(g,JSON.stringify(n))}catch{}e(n)},o=>{console.warn("listenAppDownloads error; falling back to cache",o);try{const i=localStorage.getItem(g);i&&e(JSON.parse(i))}catch{}})}catch{return()=>{}}}async function sr(e,s,r,o,i,n=12e4){const p=H(),w=e.name.replace(/[^a-zA-Z0-9_.-]/g,"_"),A=`public/apps/${s}/${Date.now()}_${w}`,O=M(p,A);return new Promise((z,N)=>{const R=G(O,e);let I=!1;const S=setTimeout(()=>{I=!0;try{R.cancel()}catch{}N(new Error("Upload timed out"))},n);R.on("state_changed",c=>{const d=Math.round(c.bytesTransferred/c.totalBytes*100);i&&i(d)},c=>{clearTimeout(S),N(c)},async()=>{try{if(clearTimeout(S),I)return;const c=await j(O),d={updatedAt:D(),updatedBy:r||"admin"};s==="android"?(d.androidUrl=c,o&&(d.androidVersion=o)):s==="pc"?(d.pcUrl=c,o&&(d.pcVersion=o)):(d.pc32Url=c,o&&(d.pc32Version=o));const Q=Math.min(Math.max(2e4,Math.floor(n/10)),6e4),X=K(y(_,l[0],l[1]),d,{merge:!0});let b=!1;const Y=new Promise(E=>setTimeout(()=>{b=!0,E()},Q));try{await Promise.race([X,Y])}catch(E){console.warn("⚠️ Firestore write error, proceeding with URL only:",E)}b&&console.warn("⚠️ Firestore update timed out; تم رفع الملف، لكن لم يتم تحديث معلومات الإصدار في قاعدة البيانات بعد."),z(c)}catch(c){N(c)}})})}async function tr(e,s){const r={};Object.entries(e||{}).forEach(([i,n])=>{n!==void 0&&(r[i]=n)});const o={...r,updatedAt:D(),updatedBy:s||"admin"};await K(y(_,l[0],l[1]),o,{merge:!0})}async function pr(e,s,r,o,i){const n=H(),p=M(n,"public/desktop_version.json"),w=JSON.stringify({version:e,updateUrl64:s,updateUrli32:r,notes:o,force:i}),A=new Blob([w],{type:"application/json"});return await h(p,A),await j(p)}export{er as getAppDownloads,nr as getCachedOrEnvAppDownloads,ir as listenAppDownloads,pr as publishDesktopVersion,or as resolveDownloadUrl,tr as setAppDownloadLinks,sr as uploadAppBinaryResumable};
