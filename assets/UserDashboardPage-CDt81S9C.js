const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-BaJ4CYlQ.js","./index-f1lkdN4_.css","./dailyOperationCountService-BUlwZZKI.js","./walletDailyLimitsService-CbdZ_7wZ.js","./profitService-Bj9jIfaS.js"])))=>i.map(i=>d[i]);
var Hd=Object.defineProperty;var Gd=(i,u,c)=>u in i?Hd(i,u,{enumerable:!0,configurable:!0,writable:!0,value:c}):i[u]=c;var wi=(i,u,c)=>Gd(i,typeof u!="symbol"?u+"":u,c);import{J as $s,h as Qd,i as Zd,u as Us,r as n,c as Ps,j as e,B as h,ao as Ws,aq as jr,b8 as yn,b9 as so,a8 as vr,C as Zs,z as cs,a as fo,p as jt,ap as as,I as U,ai as yo,ax as vo,a9 as dt,b2 as un,U as Ii,A as Xd,R as Ve,E as es,n as Sa,aN as ja,v as $e,f as J,H as Is,s as Ye,d as $a,a0 as wa,K as da,q as et,e as _e,an as Ce,g as ct,_ as bo,w as Bs,k as Ts,F as br,y as em,ab as Sr,aE as vn,l as cn,ar as ki,O as Ls,ay as De,aJ as ws,a5 as wo,a1 as tm,a4 as sm,ba as am,Y as Da,bb as No,aD as ao,aI as jo,bc as rm,ac as nm,bd as xr,D as im,ah as lm,af as pr,aH as om,b5 as ro,M as cm,aG as gr,ad as no,be as io,aT as dm,bf as mm}from"./index-BaJ4CYlQ.js";import{C as xt,a as Ht,b as ds,d as Nt}from"./card-DLfh52HJ.js";import{B as Mt}from"./badge-CK9fQGht.js";import{S as na,a as ia,b as la,c as oa,d as _s,e as wr,f as mn}from"./select-DyuXCEgh.js";import{D as ce,a as de,b as me,c as he,f as hm,e as ss,d as Ge,g as So,R as um,P as xm,W as pm,C as gm,T as fm,h as ym,i as Do,O as vm,j as bm}from"./dialog-Dficjy7S.js";import{L as H}from"./label-BUMa-ycB.js";import{M as rs,a as ns,P as wm}from"./MasterPinDialog-CaA8A3a3.js";import{walletDailyLimitsService as As}from"./walletDailyLimitsService-CbdZ_7wZ.js";import{W as Rs}from"./wallet-C1yKhE0a.js";import{S as Co,a as Nm}from"./star-L08Zk0xc.js";import{S as Io}from"./square-pen-OQ3nvd0b.js";import{T as Yt,P as lo}from"./progress-9fiwWm9n.js";import{P as Qs}from"./phone-YdedcXja.js";import{A as Ao}from"./arrow-left-CFvmOtRJ.js";import{a as Ai,S as jm}from"./separator-CyJmhVM9.js";import{C as ma}from"./calendar-B_Alfioc.js";import{C as xn}from"./chart-column-C_McLIUh.js";import{D as Pt}from"./dollar-sign-B82hCvWQ.js";import{A as dn,P as Sm}from"./ProfileIcon-623ctrff.js";import{C as Ca}from"./circle-alert-DetpNY9Y.js";import{C as pn}from"./circle-x-BMM-biHI.js";import{C as ha}from"./circle-check-big-nE2HPuqM.js";import{f as bs,P as Dm,C as To,A as gn,a as Po,b as oo,R as Cm,c as Im,M as Am}from"./MaintenanceDialog-BS9B6y-S.js";import{S as ko}from"./store-Cv5kGqRP.js";import{r as ts,P as ca}from"./profitService-Bj9jIfaS.js";import{a as Tm,E as Pm}from"./broadcastService-FoH3ZT6x.js";import{B as co,T as km}from"./textarea-BV93sHIa.js";import{D as Om,a as Em,b as _m,c as Wm,d as Fm}from"./dropdown-menu-C2FHz94g.js";import{S as Ni}from"./shield-BUfn1tuF.js";import{G as Mm}from"./gift-04i0Aw1w.js";import{W as Lm}from"./WalletsManagement-DM8bbrtc.js";import{P as Rm,w as Bm}from"./walletSelectionPinService-fh4XBRJS.js";import{R as $m}from"./refresh-cw-DLI1ZDVa.js";import"./Combination-uvOg_TRR.js";import"./index-BDxANiQU.js";import"./avatars-DDgW7Iin.js";import"./whatsappService-CkFpZfJI.js";import"./download-CV0yHFGN.js";import"./index-CvylMYeU.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Um=$s("Award",[["path",{d:"m15.477 12.89 1.515 8.526a.5.5 0 0 1-.81.47l-3.58-2.687a1 1 0 0 0-1.197 0l-3.586 2.686a.5.5 0 0 1-.81-.469l1.514-8.526",key:"1yiouv"}],["circle",{cx:"12",cy:"8",r:"6",key:"1vp47v"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const mo=$s("Banknote",[["rect",{width:"20",height:"12",x:"2",y:"6",rx:"2",key:"9lu3g6"}],["circle",{cx:"12",cy:"12",r:"2",key:"1c9p78"}],["path",{d:"M6 12h.01M18 12h.01",key:"113zkx"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const zm=$s("BookOpen",[["path",{d:"M12 7v14",key:"1akyts"}],["path",{d:"M3 18a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h5a4 4 0 0 1 4 4 4 4 0 0 1 4-4h5a1 1 0 0 1 1 1v13a1 1 0 0 1-1 1h-6a3 3 0 0 0-3 3 3 3 0 0 0-3-3z",key:"ruj8y"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Oo=$s("Building",[["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",ry:"2",key:"76otgf"}],["path",{d:"M9 22v-4h6v4",key:"r93iot"}],["path",{d:"M8 6h.01",key:"1dz90k"}],["path",{d:"M16 6h.01",key:"1x0f13"}],["path",{d:"M12 6h.01",key:"1vi96p"}],["path",{d:"M12 10h.01",key:"1nrarc"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M16 10h.01",key:"1m94wz"}],["path",{d:"M16 14h.01",key:"1gbofw"}],["path",{d:"M8 10h.01",key:"19clt8"}],["path",{d:"M8 14h.01",key:"6423bh"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fn=$s("IdCard",[["path",{d:"M16 10h2",key:"8sgtl7"}],["path",{d:"M16 14h2",key:"epxaof"}],["path",{d:"M6.17 15a3 3 0 0 1 5.66 0",key:"n6f512"}],["circle",{cx:"9",cy:"11",r:"2",key:"yxgjnd"}],["rect",{x:"2",y:"5",width:"20",height:"14",rx:"2",key:"qneu4z"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ti=$s("Info",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ji=$s("ListChecks",[["path",{d:"m3 17 2 2 4-4",key:"1jhpwq"}],["path",{d:"m3 7 2 2 4-4",key:"1obspn"}],["path",{d:"M13 6h8",key:"15sg57"}],["path",{d:"M13 12h8",key:"h98zly"}],["path",{d:"M13 18h8",key:"oe0vm4"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qm=$s("Notebook",[["path",{d:"M2 6h4",key:"aawbzj"}],["path",{d:"M2 10h4",key:"l0bgd4"}],["path",{d:"M2 14h4",key:"1gsvsf"}],["path",{d:"M2 18h4",key:"1bu2t1"}],["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",key:"1nb95v"}],["path",{d:"M16 2v20",key:"rotuqe"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const yr=$s("Package",[["path",{d:"M11 21.73a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73z",key:"1a0edw"}],["path",{d:"M12 22V12",key:"d0xqtd"}],["path",{d:"m3.3 7 7.703 4.734a2 2 0 0 0 1.994 0L20.7 7",key:"yx3hmr"}],["path",{d:"m7.5 4.27 9 5.15",key:"1c824w"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const hn=$s("TrendingDown",[["polyline",{points:"22 17 13.5 8.5 8.5 13.5 2 7",key:"1r2t7k"}],["polyline",{points:"16 17 22 17 22 11",key:"11uiuu"}]]),Vm=async(i={})=>{try{return(await Qd(Zd,"getLastTransactions")(i)).data}catch(u){throw console.error("Error getting last transactions:",u),u.code==="functions/unauthenticated"?new Error("يجب تسجيل الدخول للوصول إلى المعاملات"):u.code==="functions/invalid-argument"?new Error("بيانات الاستعلام غير صالحة: "+u.message):u.code==="functions/permission-denied"?new Error("ليس لديك صلاحية للوصول إلى هذه المعاملات: "+u.message):new Error("حدث خطأ أثناء جلب المعاملات: "+(u.message||"خطأ غير معروف"))}},Jm=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],Km=({isOpen:i,onClose:u,onWalletSelect:c,onEditWallet:p,onDeleteWallet:v})=>{const{user:D}=Us(),[s,I]=n.useState([]),[M,S]=n.useState(!1),[A,P]=n.useState([]),[f,w]=n.useState(!1),{toast:T}=Ps(),V=async(_,W)=>{const ne=new Date().getMonth(),se=new Date().getFullYear(),xe=W.filter(je=>{const We=new Date(je.createdAt);return We.getMonth()===ne&&We.getFullYear()===se&&(je.lineId===_||je.fromWallet===_)}),re=je=>{const We=je.type;return je.txnType==="receive"||We==="withdraw"||We==="withdrawal"||We==="receive"},X=je=>{const We=je.type;return je.txnType==="send"||We==="send"||We==="transfer"},Se=xe.filter(re).reduce((je,We)=>{const Me=We.withdrawnAmount!==void 0?We.withdrawnAmount:We.amount;return je+(Me||0)},0),Ae=xe.filter(X).reduce((je,We)=>{const Me=We.sentAmount!==void 0?We.sentAmount:We.amount;return je+(Me||0)},0);return{withdrawalUsage:Se,transferUsage:Ae}},O=_=>{const W=new Date().toISOString().split("T")[0],ne=_.lastResetDate;if(!ne)return{..._,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:W};const se=new Date(ne),xe=new Date;return se.getMonth()!==xe.getMonth()||se.getFullYear()!==xe.getFullYear()?{..._,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:W}:_};n.useEffect(()=>{if(!(D!=null&&D.uid)||!i)return;(async()=>{w(!0);try{const W=await Ws.getByMerchantId(D.uid),ne=await yn.getByUserId(D.uid),xe=(await Promise.all(W.map(async re=>{const{withdrawalUsage:X,transferUsage:Se}=await V(re.id,ne),Ae=await As.getWalletLimits(re.id);return{id:re.id,name:re.label||"محفظة بدون اسم",phone:re.msisdn,nationalId:re.nationalId||"",isDefault:!1,isActive:re.isActive===!0,monthlyWithdrawalLimit:(Ae==null?void 0:Ae.monthlyWithdrawLimit)??re.withdrawLimit??2e5,monthlyTransferLimit:(Ae==null?void 0:Ae.monthlyTransferLimit)??re.transferLimit??2e5,monthlyWithdrawalUsage:(Ae==null?void 0:Ae.monthlyWithdrawUsed)??X??0,monthlyTransferUsage:(Ae==null?void 0:Ae.monthlyTransferUsed)??Se??0,lastResetDate:new Date().toISOString().split("T")[0],walletProvider:re.walletProvider||""}}))).map(O);I(xe)}catch(W){console.error("Error loading wallets:",W),T({title:"فشل جلب بيانات المحافظ",description:"قد تكون المشكلة بسبب الصلاحيات أو الاتصال. سيتم عرض البيانات المحلية إن وُجدت. جرّب تسجيل الدخول مجددًا أو افتح صفحة اختبار المصادقة من القائمة.",variant:"destructive"})}finally{w(!1)}})()},[D==null?void 0:D.uid,i]);const q=_=>Jm.find(W=>W.id===_),Y=(_,W)=>W>0?Math.min(_/W*100,100):0,ae=_=>new Intl.NumberFormat("ar-EG").format(_);return e.jsx(ce,{open:i,onOpenChange:u,children:e.jsxs(de,{className:"max-w-6xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(me,{className:"pb-4",children:[e.jsxs(he,{className:"flex items-center gap-2 text-lg",children:[e.jsx(Rs,{className:"h-5 w-5"}),"الاطلاع على جميع المحافظ",e.jsxs(Mt,{variant:"secondary",className:"mr-2",children:[s.length," محفظة"]})]}),e.jsx("div",{className:"flex items-center gap-2 mt-2",children:M?e.jsxs(e.Fragment,{children:[e.jsx(h,{size:"sm",onClick:async()=>{try{if(!(D!=null&&D.uid))return;const _=s.map(W=>Ws.update(W.id,{isActive:A.includes(W.id)}));await Promise.all(_),I(W=>W.map(ne=>({...ne,isActive:A.includes(ne.id)}))),S(!1),T({title:"تم تفعيل المحافظ",description:"فقط المحافظ المحددة ستظهر في الاختيار الخارجي"});try{window.dispatchEvent(new CustomEvent("wallets:activation-updated"))}catch{}}catch(_){console.error("Error activating wallets:",_),T({title:"فشل التفعيل",description:"تعذر تفعيل المحافظ المحددة",variant:"destructive"})}},className:"h-7",children:"تفعيل المحافظ"}),e.jsx(h,{variant:"ghost",size:"sm",onClick:()=>{S(!1),P([])},className:"h-7",children:"إلغاء"})]}):e.jsx(h,{variant:"outline",size:"sm",onClick:()=>S(!0),className:"h-7",children:"تحديد المحافظ"})})]}),f?e.jsx("div",{className:"flex justify-center items-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-600",children:"جاري تحميل المحافظ..."})]})}):s.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Rs,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"لا توجد محافظ مضافة حتى الآن"})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:s.map(_=>{const W=q(_.walletProvider||"");Y(_.monthlyWithdrawalUsage||0,_.monthlyWithdrawalLimit),Y(_.monthlyTransferUsage||0,_.monthlyTransferLimit);const ne=A.includes(_.id),se=M?`cursor-pointer transition-shadow border-2 ${ne?"border-blue-500 shadow-lg":"hover:border-blue-300"}`:"cursor-pointer hover:shadow-lg transition-shadow border-2 hover:border-blue-300";return e.jsxs(xt,{className:se,onClick:()=>{M?P(xe=>xe.includes(_.id)?xe.filter(re=>re!==_.id):[...xe,_.id]):c(_)},children:[e.jsx(Ht,{className:"pb-3",children:e.jsxs(ds,{className:"flex items-center justify-between text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(jr,{className:"h-4 w-4"}),e.jsx("span",{children:_.name})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[_.isActive&&e.jsx(Mt,{variant:"default",className:"text-xs",children:"نشطة"}),_.isDefault&&e.jsxs(Mt,{variant:"default",className:"text-xs",children:[e.jsx(Co,{className:"h-3 w-3 mr-1"}),"افتراضية"]}),e.jsx(h,{variant:"ghost",size:"sm",onClick:xe=>{xe.stopPropagation(),p==null||p(_)},className:"h-7 px-2",children:e.jsx(Io,{className:"h-4 w-4"})}),e.jsx(h,{variant:"ghost",size:"sm",onClick:xe=>{xe.stopPropagation(),v==null||v(_.id)},className:"h-7 px-2 text-destructive hover:text-destructive",children:e.jsx(Yt,{className:"h-4 w-4"})})]})]})}),e.jsxs(Nt,{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Qs,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"font-mono",children:_.phone})]}),_.nationalId&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(fn,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"font-mono",children:_.nationalId})]}),W&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Oo,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{children:W.name})]})]}),(()=>{const xe=_.monthlyWithdrawalLimit,re=_.monthlyTransferLimit,X=_.monthlyWithdrawalUsage||0,Se=_.monthlyTransferUsage||0,Ae=Math.max(xe-X,0),je=Math.max(re-Se,0);return e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-2 rounded-md border border-gray-200 shadow-sm space-y-2",children:[e.jsxs("div",{className:"text-xs text-gray-600 font-medium text-center",children:["الحدود الشهرية: ",(W==null?void 0:W.name)||_.walletProvider," - ",_.phone]}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-red-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-red-400 to-red-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(X/Math.max(xe,1)*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-blue-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-400 to-blue-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(Se/Math.max(re,1)*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-1",children:[e.jsxs("div",{className:"text-xs text-red-600 font-medium",children:["متبقي سحب: ",ae(Ae)," جنيه"]}),e.jsxs("div",{className:"text-xs text-blue-600 font-medium",children:["متبقي تحويل: ",ae(je)," جنيه"]})]})]})})(),e.jsx(h,{variant:"outline",size:"sm",className:"w-full text-xs",onClick:xe=>{xe.stopPropagation(),c(_)},children:"عرض التفاصيل الكاملة"})]})]},_.id)})}),e.jsx("div",{className:"flex justify-end pt-4 border-t",children:e.jsxs(h,{onClick:u,variant:"outline",children:[e.jsx(Ao,{className:"h-4 w-4 mr-2"}),"إغلاق"]})})]})})},Ym=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],Hm=({wallet:i,isOpen:u,onClose:c,onBack:p})=>{const{user:v}=Us(),[D,s]=n.useState([]),[I,M]=n.useState(!1),[S,A]=n.useState("month"),{toast:P}=Ps();if(n.useEffect(()=>{if(!i||!(v!=null&&v.uid)||!u)return;(async()=>{M(!0);try{const fe=(await yn.getByUserId(v.uid)).filter(Z=>Z.walletId===i.id).sort((Z,Q)=>new Date(Q.createdAt).getTime()-new Date(Z.createdAt).getTime());s(fe)}catch(ue){console.error("Error loading transactions:",ue),P({title:"فشل جلب معاملات المحفظة",description:"قد تكون المشكلة بسبب صلاحيات Firestore أو الاتصال. تم عرض ما أمكن محليًا. جرّب تسجيل الدخول مجددًا أو صفحة اختبار المصادقة.",variant:"destructive"})}finally{M(!1)}})()},[i,v==null?void 0:v.uid,u]),!i)return null;const f=G=>Ym.find(ue=>ue.id===G),w=(G,ue)=>ue>0?Math.min(G/ue*100,100):0,T=G=>new Intl.NumberFormat("ar-EG").format(G),V=G=>new Date(G).toLocaleDateString("ar-EG",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}),q=(()=>{const G=new Date;let ue;switch(S){case"week":ue=new Date(G.getTime()-7*24*60*60*1e3);break;case"month":ue=new Date(G.getFullYear(),G.getMonth(),1);break;default:return D}return D.filter(fe=>new Date(fe.createdAt)>=ue)})(),Y=G=>{const ue=G.type,fe=G.txnType;return ue==="withdraw"||ue==="withdrawal"||ue==="receive"||fe==="receive"},ae=G=>{const ue=G.type,fe=G.txnType;return ue==="send"||ue==="transfer"||fe==="send"},_=q.filter(G=>Y(G)&&G.status==="completed").reduce((G,ue)=>{const fe=ue.withdrawnAmount!==void 0?ue.withdrawnAmount:ue.amount;return G+(fe||0)},0),W=q.filter(G=>ae(G)&&G.status==="completed").reduce((G,ue)=>{const fe=ue.sentAmount!==void 0?ue.sentAmount:ue.amount;return G+(fe||0)},0),ne=q.filter(G=>G.type==="deposit"&&G.status==="completed").reduce((G,ue)=>G+ue.amount,0),se=q.filter(G=>G.status==="completed"),xe=se.length,re=se.reduce((G,ue)=>{if(Y(ue)){const fe=ue.withdrawnAmount??ue.receivedAmount??ue.amount??0;return G+so(Number(fe)||0,"receive")}if(ae(ue)){const fe=ue.sentAmount??ue.transferredAmount??ue.amount??0;return G+so(Number(fe)||0,"send")}return G},0),X=f(i.walletProvider||""),Se=w(i.monthlyWithdrawalUsage||0,i.monthlyWithdrawalLimit),Ae=w(i.monthlyTransferUsage||0,i.monthlyTransferLimit),je=G=>{switch(G){case"withdrawal":return e.jsx(hn,{className:"h-4 w-4 text-red-500"});case"transfer":return e.jsx(vr,{className:"h-4 w-4 text-blue-500"});case"deposit":return e.jsx(Pt,{className:"h-4 w-4 text-green-500"});default:return e.jsx(dn,{className:"h-4 w-4 text-gray-500"})}},We=G=>{switch(G){case"completed":return e.jsx(ha,{className:"h-4 w-4 text-green-500"});case"pending":return e.jsx(Zs,{className:"h-4 w-4 text-yellow-500"});case"failed":return e.jsx(pn,{className:"h-4 w-4 text-red-500"});default:return e.jsx(Ca,{className:"h-4 w-4 text-gray-500"})}},Me=G=>{switch(G){case"withdrawal":return"سحب";case"transfer":return"تحويل";case"deposit":return"إيداع";default:return"معاملة"}},Qe=G=>{switch(G){case"completed":return"مكتملة";case"pending":return"قيد الانتظار";case"failed":return"فاشلة";default:return"غير محدد"}};return e.jsx(ce,{open:u,onOpenChange:c,children:e.jsxs(de,{className:"max-w-6xl max-h-[90vh] overflow-y-auto",children:[e.jsx(me,{className:"pb-4",children:e.jsxs(he,{className:"flex items-center gap-2 text-lg",children:[e.jsx(jr,{className:"h-5 w-5"}),"تفاصيل المحفظة: ",i.name,i.isDefault&&e.jsxs(Mt,{variant:"default",className:"mr-2",children:[e.jsx(Co,{className:"h-3 w-3 mr-1"}),"افتراضية"]})]})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-1 space-y-4",children:[e.jsxs(xt,{children:[e.jsx(Ht,{children:e.jsxs(ds,{className:"text-sm flex items-center gap-2",children:[e.jsx(fn,{className:"h-4 w-4"}),"المعلومات الأساسية"]})}),e.jsxs(Nt,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Qs,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-mono",children:i.phone})]}),i.nationalId&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(fn,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-mono",children:i.nationalId})]}),X&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Oo,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{children:X.name})]}),e.jsxs("div",{className:"text-xs text-gray-600 pr-6",children:[e.jsxs("div",{children:["المالك: ",X.ownerName]}),e.jsxs("div",{className:"font-mono",children:["الرقم القومي: ",X.nationalId]})]})]}),i.lastResetDate&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(ma,{className:"h-4 w-4 text-gray-500"}),e.jsxs("span",{children:["آخر إعادة تعيين: ",new Date(i.lastResetDate).toLocaleDateString("ar-EG")]})]})]})]}),e.jsxs(xt,{children:[e.jsx(Ht,{children:e.jsxs(ds,{className:"text-sm flex items-center gap-2",children:[e.jsx(xn,{className:"h-4 w-4"}),"حدود الاستخدام الشهري"]})}),e.jsxs(Nt,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(hn,{className:"h-3 w-3 text-red-500"}),"السحب الشهري"]}),e.jsxs("span",{className:"font-mono",children:[T(i.monthlyWithdrawalUsage||0)," / ",T(i.monthlyWithdrawalLimit)]})]}),e.jsx(lo,{value:Se,className:"h-2"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["متبقي: ",T(i.monthlyWithdrawalLimit-(i.monthlyWithdrawalUsage||0))," جنيه"]})]}),e.jsx(Ai,{}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(vr,{className:"h-3 w-3 text-green-500"}),"التحويل الشهري"]}),e.jsxs("span",{className:"font-mono",children:[T(i.monthlyTransferUsage||0)," / ",T(i.monthlyTransferLimit)]})]}),e.jsx(lo,{value:Ae,className:"h-2"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["متبقي: ",T(i.monthlyTransferLimit-(i.monthlyTransferUsage||0))," جنيه"]})]})]})]})]}),e.jsxs("div",{className:"lg:col-span-2 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-5 gap-4",children:[e.jsx(xt,{children:e.jsxs(Nt,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(hn,{className:"h-5 w-5 text-red-500"})}),e.jsx("div",{className:"text-lg font-bold",children:T(_)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي السحب"})]})}),e.jsx(xt,{children:e.jsxs(Nt,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(vr,{className:"h-5 w-5 text-blue-500"})}),e.jsx("div",{className:"text-lg font-bold",children:T(W)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي التحويل"})]})}),e.jsx(xt,{children:e.jsxs(Nt,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(Pt,{className:"h-5 w-5 text-green-500"})}),e.jsx("div",{className:"text-lg font-bold",children:T(ne)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي الإيداع"})]})}),e.jsx(xt,{children:e.jsxs(Nt,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(xn,{className:"h-5 w-5 text-emerald-600"})}),e.jsx("div",{className:"text-lg font-bold",children:T(re)}),e.jsx("div",{className:"text-xs text-gray-600",children:"أرباح الفترة"})]})}),e.jsx(xt,{children:e.jsxs(Nt,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(dn,{className:"h-5 w-5 text-purple-600"})}),e.jsx("div",{className:"text-lg font-bold",children:T(xe)}),e.jsx("div",{className:"text-xs text-gray-600",children:"عدد العمليات"})]})})]}),e.jsxs(xt,{children:[e.jsx(Ht,{children:e.jsxs(ds,{className:"text-sm flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(dn,{className:"h-4 w-4"}),"سجل المعاملات"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(h,{size:"sm",variant:S==="week"?"default":"outline",onClick:()=>A("week"),className:"text-xs",children:"أسبوع"}),e.jsx(h,{size:"sm",variant:S==="month"?"default":"outline",onClick:()=>A("month"),className:"text-xs",children:"شهر"}),e.jsx(h,{size:"sm",variant:S==="all"?"default":"outline",onClick:()=>A("all"),className:"text-xs",children:"الكل"})]})]})}),e.jsx(Nt,{children:I?e.jsx("div",{className:"flex justify-center items-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-600",children:"جاري تحميل المعاملات..."})]})}):q.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(dn,{className:"h-8 w-8 text-gray-400 mx-auto mb-2"}),e.jsx("p",{className:"text-gray-600",children:"لا توجد معاملات في هذه الفترة"})]}):e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:q.map(G=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[je(G.type),e.jsxs("div",{children:[e.jsxs("div",{className:"text-sm font-medium",children:[Me(G.type)," - ",T(G.amount)," جنيه"]}),e.jsx("div",{className:"text-xs text-gray-600",children:V(G.createdAt)}),G.description&&e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:G.description})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[We(G.status),e.jsx("span",{className:"text-xs",children:Qe(G.status)})]})]},G.id))})})]})]})]}),e.jsxs("div",{className:"flex justify-between pt-4 border-t",children:[e.jsxs(h,{onClick:p,variant:"outline",children:[e.jsx(Ao,{className:"h-4 w-4 mr-2"}),"العودة للمحافظ"]}),e.jsx(h,{onClick:c,variant:"outline",children:"إغلاق"})]})]})})},Si=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],Gm=({isOpen:i,onClose:u,onWalletUpdate:c,initialEditingWallet:p})=>{const{toast:v}=Ps(),{user:D,userSubscription:s}=Us();(()=>{var Oe,at;const L=((Oe=s==null?void 0:s.subscription)==null?void 0:Oe.planType)??((at=s==null?void 0:s.subscription)==null?void 0:at.plan)??(s==null?void 0:s.planType)??(s==null?void 0:s.plan)??null,ye=typeof L=="string"?String(L).trim().toLowerCase():null;return L===cs.TAHWEELA||ye==="tahweela"||ye==="تحويله"})();const I=fo(),[M,S]=n.useState([]),[A,P]=n.useState(!1),[f,w]=n.useState(null),[T,V]=n.useState(""),[O,q]=n.useState(""),[Y,ae]=n.useState(""),[_,W]=n.useState(""),[ne,se]=n.useState("200000"),[xe,re]=n.useState("200000"),[X,Se]=n.useState("100000"),[Ae,je]=n.useState("60000"),[We,Me]=n.useState(!1),[Qe,G]=n.useState(null),[ue,fe]=n.useState(!1),[Z,Q]=n.useState(!1),[ze,mt]=n.useState(!1),[Et,St]=n.useState(null),Le=()=>`wallets_${(D==null?void 0:D.uid)||"default"}`;n.useEffect(()=>{p&&(w(p),P(!0),V(p.name||""),q(p.phone||""),ae(p.nationalId||""),W(p.walletProvider||""),se((p.monthlyWithdrawalLimit||2e5).toString()),re((p.monthlyTransferLimit||2e5).toString()),Se((p.dailyWithdrawalLimit||1e5).toString()),je((p.dailyTransferLimit||6e4).toString()),Me(!!p.isDefault))},[p]);const Ct=L=>{const ye=new Date,Oe=ye.getMonth(),at=ye.getFullYear();if(!L.lastResetDate)return{...L,monthlyWithdrawalUsage:L.monthlyWithdrawalUsage||0,monthlyTransferUsage:L.monthlyTransferUsage||0,lastResetDate:ye.toISOString().split("T")[0]};const kt=new Date(L.lastResetDate),pt=kt.getMonth(),gt=kt.getFullYear();return Oe!==pt||at!==gt?{...L,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:ye.toISOString().split("T")[0]}:L},ht=async(L,ye)=>{const Oe=new Date().getMonth(),at=new Date().getFullYear(),kt=ye.filter(rt=>{const Ue=new Date(rt.createdAt);return Ue.getMonth()===Oe&&Ue.getFullYear()===at&&rt.lineId===L}),pt=kt.filter(rt=>rt.txnType==="receive").reduce((rt,Ue)=>rt+(Ue.amount||0),0),gt=kt.filter(rt=>rt.txnType==="send").reduce((rt,Ue)=>rt+(Ue.amount||0),0);return{withdrawalUsage:pt,transferUsage:gt}},Dt=async(L,ye)=>{const Oe=new Date,at=Oe.getDate(),kt=Oe.getMonth(),pt=Oe.getFullYear(),gt=ye.filter(ft=>{const it=new Date(ft.createdAt);return it.getDate()===at&&it.getMonth()===kt&&it.getFullYear()===pt&&ft.lineId===L}),rt=gt.filter(ft=>ft.txnType==="receive").reduce((ft,it)=>ft+(it.amount||0),0),Ue=gt.filter(ft=>ft.txnType==="send").reduce((ft,it)=>ft+(it.amount||0),0);return{withdrawalUsage:rt,transferUsage:Ue}};n.useEffect(()=>{(async()=>{if(!(D!=null&&D.uid)){console.log("No user authenticated, skipping wallet loading"),fe(!1);return}console.log("Loading wallets for user:",D.uid),fe(!0);try{const{auth:ye}=await dt(async()=>{const{auth:Ue}=await import("./index-BaJ4CYlQ.js").then(ft=>ft.bh);return{auth:Ue}},__vite__mapDeps([0,1]),import.meta.url);let Oe=0;const at=5;for(;!ye.currentUser&&Oe<at;)console.log(`Waiting for auth state... attempt ${Oe+1}`),await new Promise(Ue=>setTimeout(Ue,1e3)),Oe++;if(!ye.currentUser)throw console.error("User not authenticated in Firebase Auth after retries"),new Error("not authenticated");console.log("Firebase Auth User:",ye.currentUser.uid),console.log("Context User:",D.uid),console.log("Fetching wallets from Firebase...");const kt=await Ws.getByMerchantId(D.uid);console.log("Fetched wallets:",kt),console.log("Fetching transactions from Firebase...");const pt=await yn.getByUserId(D.uid);console.log("Fetched transactions:",pt);const rt=(await Promise.all(kt.map(async Ue=>{const{withdrawalUsage:ft,transferUsage:it}=await ht(Ue.id,pt),{withdrawalUsage:Lt,transferUsage:It}=await Dt(Ue.id,pt);return{id:Ue.id,name:Ue.label||"محفظة بدون اسم",phone:Ue.msisdn,isDefault:!1,monthlyWithdrawalLimit:Ue.withdrawLimit||2e5,monthlyTransferLimit:Ue.transferLimit||2e5,dailyWithdrawalLimit:Ue.dailyWithdrawLimit||1e5,dailyTransferLimit:Ue.dailyTransferLimit||6e4,monthlyWithdrawalUsage:ft,monthlyTransferUsage:it,dailyWithdrawalUsage:Lt,dailyTransferUsage:It,lastResetDate:new Date().toISOString().split("T")[0],defaultTransferCommission:Ue.defaultTransferCommission!=null?Number(Ue.defaultTransferCommission):null,defaultWithdrawCommission:Ue.defaultWithdrawCommission!=null?Number(Ue.defaultWithdrawCommission):null}}))).map(Ct);S(rt),console.log("Wallets loaded successfully:",rt)}catch(ye){console.error("Error loading wallets:",ye),S([])}finally{fe(!1)}})()},[D==null?void 0:D.uid]);const be=()=>{V(""),q(""),ae(""),W(""),se("200000"),re("200000"),Se("100000"),je("60000"),Me(!1),w(null),P(!1)},st=async()=>{if(!T.trim()||!O.trim()||!_.trim()){v({title:"خطأ",description:"يرجى ملء جميع الحقول المطلوبة",variant:"destructive"});return}if(!(D!=null&&D.uid)){v({title:"خطأ",description:"يجب تسجيل الدخول أولاً",variant:"destructive"});return}fe(!0);try{if(f){await Ws.update(f.id,{label:T.trim(),msisdn:O.trim(),withdrawLimit:parseInt(ne),transferLimit:parseInt(xe),dailyWithdrawLimit:parseInt(X),dailyTransferLimit:parseInt(Ae)}),await As.setLimits(f.id,{dailyTransferLimit:parseInt(Ae||"0"),dailyWithdrawLimit:parseInt(X||"0"),monthlyTransferLimit:parseInt(xe||"0"),monthlyWithdrawLimit:parseInt(ne||"0")});const L=M.map(ye=>ye.id===f.id?{...ye,name:T.trim(),phone:O.trim(),nationalId:Y.trim(),walletProvider:_,monthlyWithdrawalLimit:parseInt(ne),monthlyTransferLimit:parseInt(xe),dailyWithdrawalLimit:parseInt(X),dailyTransferLimit:parseInt(Ae)}:ye);S(L),localStorage.setItem(Le(),JSON.stringify(L)),v({title:"تم التحديث",description:"تم تحديث المحفظة بنجاح"})}else{const L={merchantUserId:D.uid,provider:_,msisdn:O.trim(),label:T.trim(),isActive:!0,dailyLimit:2e5,monthlyLimit:2e5,withdrawLimit:parseInt(ne),transferLimit:parseInt(xe),dailyTransferLimit:parseInt(Ae),dailyWithdrawLimit:parseInt(X),dailyUsage:0,monthlyUsage:0,transferUsage:0,withdrawUsage:0},ye=await Ws.create(L);await As.setLimits(ye,{dailyTransferLimit:parseInt(Ae||"0"),dailyWithdrawLimit:parseInt(X||"0"),monthlyTransferLimit:parseInt(xe||"0"),monthlyWithdrawLimit:parseInt(ne||"0")});const Oe=new Date().toISOString().split("T")[0],at={id:ye,name:T.trim(),phone:O.trim(),nationalId:Y.trim(),walletProvider:_,isDefault:We,monthlyWithdrawalLimit:parseInt(ne),monthlyTransferLimit:parseInt(xe),dailyWithdrawalLimit:parseInt(X),dailyTransferLimit:parseInt(Ae),monthlyWithdrawalUsage:0,monthlyTransferUsage:0,dailyWithdrawalUsage:0,dailyTransferUsage:0,lastResetDate:Oe,defaultTransferCommission:null,defaultWithdrawCommission:null},kt=[...M,at];S(kt),localStorage.setItem(Le(),JSON.stringify(kt)),v({title:"تم الإنشاء",description:"تم إنشاء المحفظة بنجاح"})}c&&c(),be(),P(!1),w(null)}catch(L){console.error("Error saving wallet:",L),v({title:"خطأ",description:"حدث خطأ أثناء حفظ المحفظة",variant:"destructive"})}finally{fe(!1)}},ms=L=>{w(L),V(L.name),q(L.phone),ae(L.nationalId||""),W(L.walletProvider||""),se(L.monthlyWithdrawalLimit.toString()),re(L.monthlyTransferLimit.toString()),Me(L.isDefault),P(!0)},_t=async L=>{const ye=M.find(Oe=>Oe.id===L);if(ye!=null&&ye.isDefault){v({title:"تحذير",description:"لا يمكن حذف المحفظة الافتراضية",variant:"destructive"});return}if(!(D!=null&&D.uid)){v({title:"خطأ",description:"يجب تسجيل الدخول أولاً",variant:"destructive"});return}fe(!0);try{await Ws.delete(L);const Oe=M.filter(at=>at.id!==L);S(Oe),localStorage.setItem(Le(),JSON.stringify(Oe)),c&&c(),v({title:"تم الحذف",description:"تم حذف المحفظة بنجاح"})}catch(Oe){console.error("Error deleting wallet:",Oe),v({title:"خطأ",description:"حدث خطأ أثناء حذف المحفظة",variant:"destructive"})}finally{fe(!1)}},Wt=L=>{const ye=M.map(Oe=>({...Oe,isDefault:Oe.id===L}));S(ye),localStorage.setItem(Le(),JSON.stringify(ye)),c&&c(),v({title:"تم تحديث المحفظة الافتراضية",description:"تم تعيين المحفظة كافتراضية بنجاح"})};return e.jsxs(ce,{open:i,onOpenChange:u,children:[e.jsxs(de,{className:"max-w-4xl max-h-[80vh] overflow-y-auto",children:[e.jsx(me,{className:"pb-2",children:e.jsxs(he,{className:"flex items-center gap-1 text-sm",children:[e.jsx(Rs,{className:"h-3 w-3"}),"إدارة المحافظ"]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h3",{className:"text-sm font-semibold",children:["المحافظ المتاحة (",M.length,")"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(h,{onClick:()=>{mt(!0)},className:"flex items-center gap-1 h-6 px-2 text-xs",size:"sm",variant:"outline",children:[e.jsx(jt,{className:"h-3 w-3"}),"الاطلاع على المحافظ"]}),e.jsxs(h,{onClick:()=>{u(),I("/user/add-wallet")},className:"flex items-center gap-1 h-6 px-2 text-xs",size:"sm",children:[e.jsx(as,{className:"h-3 w-3"}),"إضافة محفظة جديدة"]})]})]}),(A||f)&&e.jsxs(xt,{className:"border-2 border-blue-200 bg-blue-50",children:[e.jsx(Ht,{className:"pb-1",children:e.jsx(ds,{className:"text-sm",children:f?"تعديل المحفظة":"إضافة محفظة جديدة"})}),e.jsxs(Nt,{className:"space-y-2 pt-1",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"شركة المحفظة"}),e.jsx("div",{className:"flex gap-1 items-center",children:e.jsxs(na,{value:_,onValueChange:W,children:[e.jsx(ia,{className:"h-6 text-xs flex-1",children:e.jsx(la,{placeholder:"اختر شركة المحفظة"})}),e.jsx(oa,{children:Si.map(L=>e.jsx(_s,{value:L.id,className:"text-xs",children:e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsx("span",{children:L.name}),e.jsx("button",{type:"button",className:"h-4 w-4 p-0 ml-2 flex items-center justify-center hover:bg-blue-100 rounded",onClick:ye=>{ye.preventDefault(),ye.stopPropagation(),G(L.id)},children:e.jsx(Ti,{className:"h-3 w-3 text-blue-500 hover:text-blue-700"})})]})},L.id))})]})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"اسم المحفظة"}),e.jsx(U,{value:T,onChange:L=>V(L.target.value),placeholder:"مثال: محفظة العمل",className:"h-6 text-xs"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"رقم الهاتف"}),e.jsxs("div",{className:"relative",children:[e.jsx(Qs,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(U,{value:O,onChange:L=>q(L.target.value),placeholder:"01030302038",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الرقم القومي للخط"}),e.jsxs("div",{className:"relative",children:[e.jsx(fn,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(U,{value:Y,onChange:L=>ae(L.target.value),placeholder:"29012345678901",maxLength:14,className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد الشهري للسحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Pt,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(U,{type:"number",value:ne,onChange:L=>se(L.target.value),placeholder:"200000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد الشهري للتحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Pt,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(U,{type:"number",value:xe,onChange:L=>re(L.target.value),placeholder:"200000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد اليومي للسحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(hn,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-red-400"}),e.jsx(U,{type:"number",value:X,onChange:L=>Se(L.target.value),placeholder:"100000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد اليومي للتحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(vr,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-blue-400"}),e.jsx(U,{type:"number",value:Ae,onChange:L=>je(L.target.value),placeholder:"60000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",id:"isDefault",checked:We,onChange:L=>Me(L.target.checked),className:"rounded w-3 h-3"}),e.jsx("label",{htmlFor:"isDefault",className:"text-xs font-medium text-gray-700",children:"تعيين كمحفظة افتراضية"})]}),e.jsx("div",{className:"border-t pt-2 mt-2",children:e.jsxs("div",{className:"flex items-center gap-1 mb-2",children:[e.jsx(yo,{className:"h-3 w-3 text-gray-600"}),e.jsx("label",{className:"text-xs font-medium text-gray-700",children:"إعدادات العمولة"})]})}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(h,{onClick:st,className:"flex-1 h-6 text-xs",size:"sm",children:f?"تحديث المحفظة":"إضافة المحفظة"}),e.jsx(h,{variant:"outline",onClick:be,className:"h-6 text-xs",size:"sm",children:"إلغاء"})]})]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2",children:M.map(L=>{var ye;return e.jsxs(xt,{className:`${L.isDefault?"border-green-300 bg-green-50":""}`,children:[e.jsx(Ht,{className:"pb-1",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(ds,{className:"text-sm flex items-center gap-1",children:[e.jsx(Rs,{className:"h-3 w-3"}),L.name]}),L.isDefault&&e.jsx(Mt,{variant:"default",className:"bg-green-600 text-xs px-1 py-0",children:"افتراضية"})]})}),e.jsxs(Nt,{className:"space-y-1 pt-0",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Qs,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"text-xs",children:L.phone})]}),L.walletProvider&&e.jsx("div",{className:"text-xs text-blue-600 mt-1",children:((ye=Si.find(Oe=>Oe.id===L.walletProvider))==null?void 0:ye.name)||L.walletProvider}),e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-2 rounded-md border border-gray-200 shadow-sm space-y-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-gray-600 mb-1",children:"الحدود الشهرية"}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-red-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-red-400 to-red-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((L.monthlyWithdrawalUsage||0)/L.monthlyWithdrawalLimit*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-blue-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-400 to-blue-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((L.monthlyTransferUsage||0)/L.monthlyTransferLimit*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-xs text-red-600 font-medium",children:["متبقي سحب: ",Math.max(L.monthlyWithdrawalLimit-(L.monthlyWithdrawalUsage||0),0)," جنيه"]}),e.jsxs("div",{className:"text-xs text-blue-600 font-medium",children:["متبقي تحويل: ",Math.max(L.monthlyTransferLimit-(L.monthlyTransferUsage||0),0)," جنيه"]})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-gray-600 mb-1",children:"الحدود اليومية"}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-orange-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-orange-400 to-orange-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((L.dailyWithdrawalUsage||0)/L.dailyWithdrawalLimit*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-green-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-green-400 to-green-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((L.dailyTransferUsage||0)/L.dailyTransferLimit*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify بين items-center mt-0.5",children:[e.jsxs("div",{className:"text-xs text-orange-600 font-medium",children:["متبقي سحب يومي: ",Math.max(L.dailyWithdrawalLimit-(L.dailyWithdrawalUsage||0),0)," جنيه"]}),e.jsxs("div",{className:"text-xs text-green-600 font-medium",children:["متبقي تحويل يومي: ",Math.max(L.dailyTransferLimit-(L.dailyTransferUsage||0),0)," جنيه"]})]})]})]}),e.jsxs("div",{className:"flex gap-1 pt-1",children:[e.jsxs(h,{size:"sm",variant:"outline",onClick:()=>ms(L),className:"flex-1 h-5 text-xs px-1",children:[e.jsx(Io,{className:"h-2 w-2 mr-0.5"}),"تعديل"]}),!L.isDefault&&e.jsxs(e.Fragment,{children:[e.jsx(h,{size:"sm",variant:"outline",onClick:()=>Wt(L.id),className:"flex-1 h-5 text-xs px-1",children:"جعلها افتراضية"}),e.jsx(h,{size:"sm",variant:"destructive",onClick:()=>_t(L.id),className:"h-5 px-1",children:e.jsx(Yt,{className:"h-2 w-2"})})]})]})]})]},L.id)})}),M.length===0&&e.jsx("div",{className:"text-center py-4 text-gray-500 text-xs",children:"لا توجد محافظ متاحة. قم بإضافة محفظة جديدة للبدء."})]}),Qe&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-800",children:"معلومات صاحب المحفظة"}),e.jsx("button",{onClick:()=>G(null),className:"h-8 w-8 p-0 flex items-center justify-center hover:bg-gray-100 rounded-full transition-colors",children:e.jsx(vo,{className:"h-4 w-4 text-gray-500"})})]}),(()=>{const L=Si.find(ye=>ye.id===Qe);return L?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-center mb-6",children:e.jsx("div",{className:"bg-blue-100 p-3 rounded-lg inline-block",children:e.jsx("h4",{className:"font-bold text-blue-700 text-lg",children:L.name})})}),e.jsx("div",{className:"bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-200",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-white p-3 rounded-lg shadow-sm",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full mr-2"}),e.jsx("span",{className:"font-semibold text-gray-700",children:"اسم صاحب المحفظة:"})]}),e.jsx("p",{className:"text-gray-900 font-medium text-lg mr-4",children:L.ownerName})]}),e.jsxs("div",{className:"bg-white p-3 rounded-lg shadow-sm",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full mr-2"}),e.jsx("span",{className:"font-semibold text-gray-700",children:"الرقم القومي:"})]}),e.jsx("p",{className:"text-gray-900 font-mono text-lg mr-4 tracking-wider",children:L.nationalId})]})]})}),e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 p-3 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(Ti,{className:"h-4 w-4 text-yellow-600 mr-2"}),e.jsx("span",{className:"text-sm text-yellow-800 font-medium",children:"هذه البيانات مسجلة رسمياً في النظام لهذه المحفظة"})]})})]}):null})()]})})]}),e.jsx(rs,{open:ze,onOpenChange:mt,mode:"verify",title:"إدخال الرقم السري الرئيسي",description:"لا يمكن الاطلاع على المحافظ إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{mt(!1),Q(!0)}}),e.jsx(Km,{isOpen:Z,onClose:()=>Q(!1),onWalletSelect:L=>{St(L),Q(!1)},onEditWallet:L=>{I(`/user/add-wallet?edit=1&id=${L.id}`),Q(!1)},onDeleteWallet:async L=>{try{if(await Ws.delete(L),S(ye=>{const Oe=ye.filter(at=>at.id!==L);try{localStorage.setItem(Le(),JSON.stringify(Oe))}catch(at){console.error("Failed to update localStorage wallets after delete:",at)}return Oe}),c)try{await c()}catch(ye){console.error("onWalletUpdate callback failed:",ye)}}catch(ye){console.error("Error deleting wallet:",ye)}}}),e.jsx(Hm,{wallet:Et,isOpen:!!Et,onClose:()=>St(null),onBack:()=>{St(null),Q(!0)}})]})},Qm=({isOpen:i,onClose:u,transaction:c,onDelete:p})=>{if(!c)return null;const v=S=>{switch(S){case"completed":return e.jsx(ha,{className:"h-5 w-5 text-green-500"});case"pending":return e.jsx(Zs,{className:"h-5 w-5 text-yellow-500"});case"failed":return e.jsx(pn,{className:"h-5 w-5 text-red-500"});default:return e.jsx(Zs,{className:"h-5 w-5 text-gray-500"})}},D=S=>{switch(S){case"completed":return"مكتملة";case"pending":return"قيد الانتظار";case"failed":return"فاشلة";default:return"غير معروف"}},s=S=>{switch(S){case"withdraw":return"سحب";case"send":return"إرسال";case"receive":return"استقبال";default:return"تحويل"}},I=()=>{const S=!!c.senderNumber,A=!!c.senderName,P=S?"الرقم المرسل:":A?"الرقم الراسل:":"رقم المحفظة:",f=S?c.senderNumber:A?c.senderName:c.senderPhone,w=`
      <div style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 500px; margin: 0 auto; padding: 30px; background: #fff;">
        <!-- Header -->
        <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #2563eb; padding-bottom: 20px;">
          <h1 style="color: #2563eb; margin-bottom: 5px; font-size: 28px;">إيصال المعاملة</h1>
          <p style="color: #666; font-size: 16px; margin: 0;">رقم المرجع: ${c.transactionReference||c.id}</p>
          <p style="color: #888; font-size: 14px; margin: 5px 0 0 0;">${new Date().toLocaleString("ar-EG")}</p>
        </div>
        
        <!-- Shop Info -->
        <div style="background: #f8fafc; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
          <h3 style="color: #1e293b; margin: 0 0 15px 0; font-size: 18px;">معلومات المحل</h3>
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span style="font-weight: 600; color: #475569;">اسم المحل:</span>
            <span style="color: #1e293b;">${c.merchantShopName||c.shopName||"غير محدد"}</span>
          </div>
        </div>
        
        <!-- Transaction Details -->
        <div style="background: #fff; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
          <h3 style="color: #1e293b; margin: 0 0 15px 0; font-size: 18px;">تفاصيل المعاملة</h3>
          
          <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
            <span style="font-weight: 600; color: #475569;">نوع المعاملة:</span>
            <span style="color: #2563eb; font-weight: 600;">${s(c.type)}</span>
          </div>
          
          <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
            <span style="font-weight: 600; color: #475569;">الحالة:</span>
            <span style="color: ${c.status==="completed"?"#16a34a":c.status==="pending"?"#ca8a04":"#dc2626"}; font-weight: 600;">
              ${D(c.status)}
            </span>
          </div>

          ${c!=null&&c.cashierName?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الكاشير:</span>
              <span style="color: #1e293b;">${c.cashierName}</span>
            </div>
          `:""}
          
          ${c.type!=="withdraw"?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">${P}</span>
              <span style="color: #1e293b;">${f}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الرقم المستقبل:</span>
              <span style="color: #1e293b;">${c.receiverNumber||c.receiverPhone}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">المبلغ المحول:</span>
              <span style="color: #2563eb; font-weight: bold; font-size: 16px;">${bs(c.transferredAmount||c.amount)} جنيه</span>
            </div>
          `:`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">رقم المحفظة:</span>
              <span style="color: #1e293b;">${c.senderPhone}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">المبلغ المسحوب:</span>
              <span style="color: #dc2626; font-weight: bold; font-size: 16px;">${bs(c.withdrawnAmountDetailed||c.withdrawnAmount||c.amount)} جنيه</span>
            </div>
          `}
          
          ${c.commission?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">العمولة:</span>
              <span style="color: #f59e0b; font-weight: 600;">${bs(c.commission||0)} جنيه</span>
            </div>
          `:""}
          ${c!=null&&c.fee&&Number(c.fee)>0?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الرسوم:</span>
              <span style="color: #64748b; font-weight: 600;">${bs(c.fee||0)} جنيه</span>
            </div>
          `:""}
          
          <div style="display: flex; justify-content: space-between; padding: 8px 0;">
            <span style="font-weight: 600; color: #475569;">التاريخ والوقت:</span>
            <span style="color: #1e293b;">${c.createdAt.toLocaleString("ar-EG")}</span>
          </div>
        </div>
        
        <!-- Total Amount -->
        <div style="background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); border-radius: 12px; padding: 20px; margin-bottom: 20px; text-align: center;">
          <h3 style="color: white; margin: 0 0 10px 0; font-size: 16px;">إجمالي المبلغ</h3>
          <p style="color: white; font-size: 24px; font-weight: bold; margin: 0;">
            ${c.type==="withdraw"?"-":""}${bs(c.amount)} جنيه
          </p>
        </div>
        
        
        
        
        <!-- Footer -->
        <div style="text-align: center; color: #64748b; font-size: 12px; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
          <p style="margin: 0 0 5px 0;">شكراً لاستخدام خدماتنا</p>
          <p style="margin: 0;">تم إنشاء الإيصال في: ${new Date().toLocaleString("ar-EG")}</p>
        </div>
      </div>
    `,T=window.open("","_blank");T&&(T.document.write(`
        <html>
          <head>
            <title>إيصال المعاملة - ${c.transactionReference||c.id}</title>
            <meta charset="UTF-8">
            <style>
              body { 
                margin: 0; 
                padding: 20px; 
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: #f8fafc;
              }
              @media print {
                body { 
                  margin: 0; 
                  background: white;
                }
              }
            </style>
          </head>
          <body>
            ${w}
          </body>
        </html>
      `),T.document.close(),T.print())},M=()=>{window.confirm("هل أنت متأكد من حذف هذه المعاملة؟ لا يمكن التراجع عن هذا الإجراء.")&&(p(c.id),u())};return e.jsx(ce,{open:i,onOpenChange:u,children:e.jsxs(de,{className:"w-[92vw] sm:w-auto sm:max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx(me,{children:e.jsxs(he,{className:"flex items-center gap-2 text-xl",children:[e.jsx(un,{className:"h-6 w-6 text-blue-600"}),"إيصال المعاملة المفصل"]})}),e.jsxs("div",{className:"space-y-6",children:[e.jsx(xt,{className:"bg-gradient-to-r from-blue-50 to-indigo-50 border-blue-200",children:e.jsxs(Ht,{className:"text-center pb-2",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 mb-2",children:[v(c.status),e.jsx(Mt,{variant:c.status==="completed"?"default":"secondary",className:"text-sm",children:D(c.status)})]}),e.jsxs("h3",{className:"text-2xl font-bold text-blue-600",children:[c.type==="withdraw"?"-":"",bs(c.amount)," جنيه"]}),e.jsxs("p",{className:"text-sm text-gray-600",children:["رقم المرجع: ",c.transactionReference||c.id]})]})}),e.jsxs(xt,{children:[e.jsx(Ht,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ko,{className:"h-5 w-5 text-green-600"}),e.jsx("h4",{className:"font-semibold text-lg",children:"معلومات المحل"})]})}),e.jsxs(Nt,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"اسم المحل:"}),e.jsx("span",{className:"text-gray-900",children:c.merchantShopName||c.shopName||"غير محدد"})]}),(c==null?void 0:c.cashierName)&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"الكاشير:"}),e.jsx("span",{className:"text-gray-900",children:c.cashierName})]})]})]}),e.jsxs(xt,{children:[e.jsx(Ht,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(jr,{className:"h-5 w-5 text-blue-600"}),e.jsx("h4",{className:"font-semibold text-lg",children:"تفاصيل المعاملة"})]})}),e.jsx(Nt,{className:"space-y-3",children:e.jsxs("div",{className:"grid grid-cols-1 gap-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-blue-700",children:"نوع المعاملة:"}),e.jsx(Mt,{variant:"outline",className:"bg-blue-100 text-blue-800",children:s(c.type)})]}),c.type!=="withdraw"?e.jsxs(e.Fragment,{children:[(()=>{const S=!!c.senderNumber,A=!!c.senderName,P=S?"الرقم المرسل:":A?"الرقم الراسل:":"رقم المحفظة:",f=S?c.senderNumber:A?c.senderName:c.senderPhone,w=S?Ii:Qs;return e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(w,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:P})]}),e.jsx("span",{className:"text-gray-900 font-mono",children:f})]})})(),e.jsx("div",{className:"flex items-center justify-center p-2",children:e.jsx(Xd,{className:"h-6 w-6 text-blue-500"})}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-green-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ii,{className:"h-4 w-4 text-green-500"}),e.jsx("span",{className:"font-medium text-green-700",children:"الرقم المستقبل:"})]}),e.jsx("span",{className:"text-green-900 font-mono",children:c.receiverNumber||c.receiverPhone})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Pt,{className:"h-4 w-4 text-blue-500"}),e.jsx("span",{className:"font-medium text-blue-700",children:"المبلغ المحول:"})]}),e.jsxs("span",{className:"text-blue-900 font-bold text-lg",children:[bs(c.transferredAmount||c.amount)," جنيه"]})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Qs,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:"رقم المحفظة:"})]}),e.jsx("span",{className:"text-gray-900 font-mono",children:c.senderPhone})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-red-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Pt,{className:"h-4 w-4 text-red-500"}),e.jsx("span",{className:"font-medium text-red-700",children:"المبلغ المسحوب:"})]}),e.jsxs("span",{className:"text-red-900 font-bold text-lg",children:[bs(c.withdrawnAmountDetailed||c.withdrawnAmount||c.amount)," جنيه"]})]})]}),c.commission&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-yellow-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-yellow-700",children:"العمولة:"}),e.jsxs("span",{className:"text-yellow-900 font-semibold",children:[c.commission," جنيه"]})]}),(c==null?void 0:c.fee)&&Number(c.fee)>0&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"الرسوم:"}),e.jsxs("span",{className:"text-gray-900 font-semibold",children:[c.fee," جنيه"]})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ma,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:"التاريخ والوقت:"})]}),e.jsx("span",{className:"text-gray-900",children:c.createdAt.toLocaleString("ar-EG")})]})]})})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs(h,{onClick:I,className:"flex-1 bg-blue-600 hover:bg-blue-700 text-white",size:"lg",children:[e.jsx(Dm,{className:"h-5 w-5 mr-2"}),"طباعة الإيصال"]}),e.jsxs(h,{onClick:M,variant:"destructive",className:"flex-1",size:"lg",children:[e.jsx(Yt,{className:"h-5 w-5 mr-2"}),"حذف المعاملة"]})]}),e.jsx(h,{onClick:u,variant:"outline",className:"w-full",size:"lg",children:"إغلاق الإيصال"})]})]})})};function ho({open:i,onOpenChange:u,onSuccess:c,title:p,description:v,currentBalance:D,balanceLabel:s,userId:I}){const[M,S]=n.useState(""),[A,P]=n.useState(D.toString()),[f,w]=n.useState(!1),[T,V]=n.useState(""),[O,q]=n.useState(!1),Y=async _=>{_.preventDefault(),V(""),q(!0);try{const W=parseFloat(A);if(isNaN(W)||W<0){V("يرجى إدخال مبلغ صحيح"),q(!1);return}await ns.hasMasterPin(I)?await ns.verifyMasterPin(M,I)?(c(W),u(!1),S(""),P("")):V("الرقم السري غير صحيح"):V("لم يتم تعيين رقم سري رئيسي. يرجى تعيين رقم سري رئيسي أولاً من إعدادات التطبيق")}catch{V("حدث خطأ أثناء التحقق من الرقم السري")}finally{q(!1)}},ae=()=>{S(""),P(D.toString()),V(""),u(!1)};return Ve.useEffect(()=>{i&&P(D.toString())},[D,i]),e.jsx(ce,{open:i,onOpenChange:ae,children:e.jsxs(de,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(me,{children:e.jsxs(he,{className:"flex items-center gap-2 text-right",children:[e.jsx(Pt,{className:"h-5 w-5"}),p]})}),e.jsxs("form",{onSubmit:Y,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:v}),e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg",children:[e.jsxs(H,{className:"text-sm font-medium text-gray-700",children:[s," الحالي"]}),e.jsxs("div",{className:"text-lg font-bold text-gray-900 mt-1",children:[D.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"newAmount",className:"text-right",children:"المبلغ الجديد"}),e.jsx(U,{id:"newAmount",type:"number",step:"0.01",min:"0",value:A,onChange:_=>P(_.target.value),placeholder:"أدخل المبلغ الجديد",className:"text-right",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"pin",className:"text-right",children:"الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"pin",type:f?"text":"password",value:M,onChange:_=>S(_.target.value),placeholder:"أدخل الرقم السري",className:"text-right pr-10",required:!0}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>w(!f),children:f?e.jsx(es,{className:"h-4 w-4"}):e.jsx(jt,{className:"h-4 w-4"})})]})]}),T&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-red-600 bg-red-50 p-2 rounded",children:[e.jsx(Ca,{className:"h-4 w-4"}),T]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(h,{type:"button",variant:"outline",onClick:ae,className:"flex-1",children:"إلغاء"}),e.jsx(h,{type:"submit",disabled:O||!M||!A,className:"flex-1",children:O?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"جاري التحديث..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Sa,{className:"h-4 w-4 mr-2"}),"تحديث الرصيد"]})})]})]})]})})}class Nr{static getSecretKey(u){return u?`${this.SECRET_KEY_BASE}_${u}`:this.SECRET_KEY_BASE}static setSecretPin(u,c){const p=btoa(u);this.secretCache.set(this.getSecretKey(c),p)}static hasSecretPin(u){return this.secretCache.has(this.getSecretKey(u))}static verifySecretPin(u,c){const p=this.secretCache.get(this.getSecretKey(c));if(!p)return!1;try{return atob(p)===u}catch{return!1}}static clearSecretPin(u){this.secretCache.delete(this.getSecretKey(u))}}wi(Nr,"SECRET_KEY_BASE","dashboard_secret_pin"),wi(Nr,"secretCache",new Map);function Zm({open:i,onOpenChange:u,userId:c}){const[p,v]=n.useState(""),[D,s]=n.useState(""),[I,M]=n.useState(""),[S,A]=n.useState(!1),[P,f]=n.useState(!1),[w,T]=n.useState(!1),[V,O]=n.useState(""),[q,Y]=n.useState(!1),{toast:ae}=Ps(),_=Nr.hasSecretPin(c),W=async se=>{se.preventDefault(),O(""),Y(!0);try{if(!D||D.length<4){O("يجب أن يكون الرقم السري 4 أرقام على الأقل"),Y(!1);return}if(D!==I){O("الرقم السري الجديد وتأكيده غير متطابقين"),Y(!1);return}if(_){if(!p){O("يرجى إدخال الرقم السري الحالي"),Y(!1);return}if(!Nr.verifySecretPin(p,c)){O("الرقم السري الحالي غير صحيح"),Y(!1);return}}Nr.setSecretPin(D,c),ae({title:_?"تم تغيير الرقم السري":"تم تعيين الرقم السري",description:_?"تم تغيير الرقم السري بنجاح":"تم تعيين الرقم السري بنجاح"}),ne()}catch{O("حدث خطأ أثناء حفظ الرقم السري")}finally{Y(!1)}},ne=()=>{v(""),s(""),M(""),O(""),A(!1),f(!1),T(!1),u(!1)};return e.jsx(ce,{open:i,onOpenChange:ne,children:e.jsxs(de,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(me,{children:e.jsxs(he,{className:"flex items-center gap-2 text-right",children:[e.jsx(yo,{className:"h-5 w-5"}),_?"تغيير الرقم السري":"تعيين الرقم السري"]})}),e.jsxs("form",{onSubmit:W,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:_?"أدخل الرقم السري الحالي والرقم السري الجديد لتغييره":"أدخل الرقم السري الجديد الذي تريد استخدامه في عمليات التعديل"}),_&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"currentPin",type:S?"text":"password",autoComplete:"off",value:p,onChange:se=>v(se.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>A(!S),children:S?e.jsx(es,{className:"h-4 w-4"}):e.jsx(jt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"newPin",type:P?"text":"password",autoComplete:"off",value:D,onChange:se=>s(se.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>f(!P),children:P?e.jsx(es,{className:"h-4 w-4"}):e.jsx(jt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"confirmPin",type:w?"text":"password",autoComplete:"off",value:I,onChange:se=>M(se.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>T(!w),children:w?e.jsx(es,{className:"h-4 w-4"}):e.jsx(jt,{className:"h-4 w-4"})})]})]}),V&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(Ca,{className:"h-4 w-4"}),V]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(h,{type:"submit",disabled:q,className:"flex-1",children:[e.jsx(Sa,{className:"h-4 w-4 mr-2"}),q?"جاري الحفظ...":_?"تغيير الرقم السري":"تعيين الرقم السري"]}),e.jsx(h,{type:"button",variant:"outline",onClick:ne,disabled:q,children:"إلغاء"})]})]})]})})}const Di=new Map;function Xm({open:i,onOpenChange:u,userId:c}){const[p,v]=n.useState(""),[D,s]=n.useState(""),[I,M]=n.useState(""),[S,A]=n.useState(!1),[P,f]=n.useState(!1),[w,T]=n.useState(!1),[V,O]=n.useState(""),[q,Y]=n.useState(!1),{toast:ae}=Ps(),_=c?`cash_drawer_pin_${c}`:"cash_drawer_pin",W=()=>Di.has(_),ne=X=>{const Se=Di.get(_);if(!Se)return!1;try{return atob(Se)===X}catch{return!1}},se=X=>{const Se=btoa(X);Di.set(_,Se)},xe=async X=>{X.preventDefault(),O(""),Y(!0);try{if(!D||D.length<4){O("يجب أن يكون الرقم السري 4 أرقام على الأقل"),Y(!1);return}if(D!==I){O("الرقم السري الجديد وتأكيده غير متطابقين"),Y(!1);return}if(W()){if(!p){O("يرجى إدخال الرقم السري الحالي لدرج النقدية"),Y(!1);return}if(!ne(p)){O("الرقم السري الحالي لدرج النقدية غير صحيح"),Y(!1);return}}se(D),ae({title:W()?"تم تغيير رقم درج النقدية":"تم تعيين رقم درج النقدية",description:W()?"تم تغيير الرقم السري لدرج النقدية بنجاح":"تم تعيين الرقم السري لدرج النقدية بنجاح"}),re()}catch{O("حدث خطأ أثناء حفظ الرقم السري لدرج النقدية")}finally{Y(!1)}},re=()=>{v(""),s(""),M(""),O(""),A(!1),f(!1),T(!1),u(!1)};return e.jsx(ce,{open:i,onOpenChange:re,children:e.jsxs(de,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(me,{children:e.jsxs(he,{className:"flex items-center gap-2 text-right",children:[e.jsx(Pt,{className:"h-5 w-5 text-green-600"}),W()?"تغيير رقم درج النقدية":"تعيين رقم درج النقدية"]})}),e.jsxs("form",{onSubmit:xe,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:W()?"أدخل الرقم السري الحالي والرقم السري الجديد لدرج النقدية":"أدخل الرقم السري الجديد الذي تريد استخدامه لحماية درج النقدية"}),W()&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي لدرج النقدية"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"currentPin",type:S?"text":"password",autoComplete:"off",value:p,onChange:X=>v(X.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>A(!S),children:S?e.jsx(es,{className:"h-4 w-4"}):e.jsx(jt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد لدرج النقدية"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"newPin",type:P?"text":"password",autoComplete:"off",value:D,onChange:X=>s(X.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>f(!P),children:P?e.jsx(es,{className:"h-4 w-4"}):e.jsx(jt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"confirmPin",type:w?"text":"password",autoComplete:"off",value:I,onChange:X=>M(X.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>T(!w),children:w?e.jsx(es,{className:"h-4 w-4"}):e.jsx(jt,{className:"h-4 w-4"})})]})]}),V&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(Ca,{className:"h-4 w-4"}),V]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(h,{type:"submit",disabled:q,className:"flex-1 bg-green-600 hover:bg-green-700",children:[e.jsx(Sa,{className:"h-4 w-4 mr-2"}),q?"جاري الحفظ...":W()?"تغيير رقم درج النقدية":"تعيين رقم درج النقدية"]}),e.jsx(h,{type:"button",variant:"outline",onClick:re,disabled:q,children:"إلغاء"})]})]}),e.jsx("div",{className:"text-xs text-gray-500 text-center mt-2",children:"💰 هذا الرقم السري خاص بحماية درج النقدية فقط"})]})})}const Ci=new Map;function eh({open:i,onOpenChange:u,userId:c}){const[p,v]=n.useState(""),[D,s]=n.useState(""),[I,M]=n.useState(""),[S,A]=n.useState(!1),[P,f]=n.useState(!1),[w,T]=n.useState(!1),[V,O]=n.useState(""),[q,Y]=n.useState(!1),{toast:ae}=Ps(),_=c?`wallet_total_pin_${c}`:"wallet_total_pin",W=()=>Ci.has(_),ne=X=>{const Se=Ci.get(_);if(!Se)return!1;try{return atob(Se)===X}catch{return!1}},se=X=>{const Se=btoa(X);Ci.set(_,Se)},xe=async X=>{X.preventDefault(),O(""),Y(!0);try{if(!D||D.length<4){O("يجب أن يكون الرقم السري 4 أرقام على الأقل"),Y(!1);return}if(D!==I){O("الرقم السري الجديد وتأكيده غير متطابقين"),Y(!1);return}if(W()){if(!p){O("يرجى إدخال الرقم السري الحالي لإجمالي المحفظة"),Y(!1);return}if(!ne(p)){O("الرقم السري الحالي لإجمالي المحفظة غير صحيح"),Y(!1);return}}se(D),ae({title:W()?"تم تغيير رقم إجمالي المحفظة":"تم تعيين رقم إجمالي المحفظة",description:W()?"تم تغيير الرقم السري لإجمالي المحفظة بنجاح":"تم تعيين الرقم السري لإجمالي المحفظة بنجاح"}),re()}catch{O("حدث خطأ أثناء حفظ الرقم السري لإجمالي المحفظة")}finally{Y(!1)}},re=()=>{v(""),s(""),M(""),O(""),A(!1),f(!1),T(!1),u(!1)};return e.jsx(ce,{open:i,onOpenChange:re,children:e.jsxs(de,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(me,{children:e.jsxs(he,{className:"flex items-center gap-2 text-right",children:[e.jsx(Rs,{className:"h-5 w-5 text-blue-600"}),W()?"تغيير رقم إجمالي المحفظة":"تعيين رقم إجمالي المحفظة"]})}),e.jsxs("form",{onSubmit:xe,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:W()?"أدخل الرقم السري الحالي والرقم السري الجديد لإجمالي المحفظة":"أدخل الرقم السري الجديد الذي تريد استخدامه لحماية إجمالي المحفظة"}),W()&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي لإجمالي المحفظة"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"currentPin",type:S?"text":"password",autoComplete:"off",value:p,onChange:X=>v(X.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>A(!S),children:S?e.jsx(es,{className:"h-4 w-4"}):e.jsx(jt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد لإجمالي المحفظة"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"newPin",type:P?"text":"password",autoComplete:"off",value:D,onChange:X=>s(X.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>f(!P),children:P?e.jsx(es,{className:"h-4 w-4"}):e.jsx(jt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"confirmPin",type:w?"text":"password",autoComplete:"off",value:I,onChange:X=>M(X.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>T(!w),children:w?e.jsx(es,{className:"h-4 w-4"}):e.jsx(jt,{className:"h-4 w-4"})})]})]}),V&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(Ca,{className:"h-4 w-4"}),V]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(h,{type:"submit",disabled:q,className:"flex-1 bg-blue-600 hover:bg-blue-700",children:[e.jsx(Sa,{className:"h-4 w-4 mr-2"}),q?"جاري الحفظ...":W()?"تغيير رقم إجمالي المحفظة":"تعيين رقم إجمالي المحفظة"]}),e.jsx(h,{type:"button",variant:"outline",onClick:re,disabled:q,children:"إلغاء"})]})]}),e.jsx("div",{className:"text-xs text-gray-500 text-center mt-2",children:"💼 هذا الرقم السري خاص بحماية إجمالي المحفظة فقط"})]})})}function th({open:i,onOpenChange:u,onSuccess:c,title:p,description:v,currentBalance:D,balanceLabel:s,userId:I}){const[M,S]=n.useState(""),[A,P]=n.useState(""),[f,w]=n.useState("add"),[T,V]=n.useState(!1),[O,q]=n.useState(""),[Y,ae]=n.useState(!1),[_,W]=n.useState(!1);n.useEffect(()=>{let re=!0;return(async()=>{const X=await ns.hasMasterPin(I);re&&W(X)})(),()=>{re=!1}},[I,i]);const ne=async re=>{re.preventDefault(),q(""),ae(!0);try{const X=parseFloat(A);if(isNaN(X)||X<=0){q("يرجى إدخال مبلغ صحيح أكبر من صفر"),ae(!1);return}if(f==="subtract"&&X>D){q("لا يمكن خصم مبلغ أكبر من الرصيد الحالي"),ae(!1);return}if(_)if(await ns.verifyMasterPin(M,I)){const Ae=f==="add"?X:-X;se(),c(Ae)}else q("الرقم السري غير صحيح");else q("لم يتم تعيين الرقم السري الرئيسي. يرجى تعيينه من إعدادات البروفيل أولاً")}catch{q("حدث خطأ أثناء التحقق من الرقم السري")}finally{ae(!1)}},se=()=>{S(""),P(""),w("add"),q(""),u(!1)},xe=()=>{const re=parseFloat(A)||0;return f==="add"?D+re:D-re};return e.jsx(ce,{open:i,onOpenChange:se,children:e.jsxs(de,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(me,{children:e.jsxs(he,{className:"flex items-center gap-2 text-right",children:[f==="add"?e.jsx(as,{className:"h-5 w-5 text-green-600"}):e.jsx(ja,{className:"h-5 w-5 text-red-600"}),p]})}),e.jsxs("form",{onSubmit:ne,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:v}),e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg",children:[e.jsxs(H,{className:"text-sm font-medium text-gray-700",children:[s," الحالي"]}),e.jsxs("div",{className:"text-lg font-bold text-gray-900 mt-1",children:[D.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{className:"text-right",children:"نوع العملية"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(h,{type:"button",variant:f==="add"?"default":"outline",onClick:()=>w("add"),className:"flex-1 flex items-center gap-2",children:[e.jsx(as,{className:"h-4 w-4"}),"إضافة"]}),e.jsxs(h,{type:"button",variant:f==="subtract"?"default":"outline",onClick:()=>w("subtract"),className:"flex-1 flex items-center gap-2",children:[e.jsx(ja,{className:"h-4 w-4"}),"خصم"]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(H,{htmlFor:"amount",className:"text-right",children:["المبلغ المراد ",f==="add"?"إضافته":"خصمه"]}),e.jsx(U,{id:"amount",type:"number",step:"0.01",min:"0.01",value:A,onChange:re=>P(re.target.value),placeholder:`أدخل المبلغ المراد ${f==="add"?"إضافته":"خصمه"}`,className:"text-right",required:!0})]}),A&&!isNaN(parseFloat(A))&&e.jsxs("div",{className:`p-3 rounded-lg ${f==="add"?"bg-green-50 border border-green-200":"bg-red-50 border border-red-200"}`,children:[e.jsx(H,{className:"text-sm font-medium text-gray-700",children:"الرصيد الجديد المتوقع"}),e.jsxs("div",{className:`text-lg font-bold mt-1 ${f==="add"?"text-green-700":"text-red-700"}`,children:[xe().toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"pin",className:"text-right",children:"الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"pin",type:T?"text":"password",autoComplete:"off",value:M,onChange:re=>S(re.target.value),placeholder:"أدخل الرقم السري",className:"text-right pr-10",required:!0}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>V(!T),children:T?e.jsx(es,{className:"h-4 w-4"}):e.jsx(jt,{className:"h-4 w-4"})})]})]}),O&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-red-600 bg-red-50 p-2 rounded",children:[e.jsx(Ca,{className:"h-4 w-4"}),O]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(h,{type:"button",variant:"outline",onClick:se,className:"flex-1",children:"إلغاء"}),e.jsx(h,{type:"submit",disabled:Y||!M||!A,className:`flex-1 ${f==="add"?"bg-green-600 hover:bg-green-700":"bg-red-600 hover:bg-red-700"}`,children:Y?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"جاري التحديث..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Sa,{className:"h-4 w-4 mr-2"}),f==="add"?"إضافة المبلغ":"خصم المبلغ"]})})]})]})]})})}const uo={BASE_URL:"./",DEV:!1,MODE:"production",PROD:!0,SSR:!1,VITE_APP_VERSION:"0.0.0",VITE_DEV_MODE:"true",VITE_ENABLE_OFFLINE_PERSISTENCE:"false",VITE_FIREBASE_API_KEY:"AIzaSyA33RTf43u2QE2OsK1RepQHSKrSet9ZI0s",VITE_FIREBASE_APP_ID:"1:483702062341:web:b1ff06ad175cb7ae428b6c",VITE_FIREBASE_AUTH_DOMAIN:"voda-c6abd.firebaseapp.com",VITE_FIREBASE_AUTH_EMULATOR_URL:"http://localhost:9099",VITE_FIREBASE_FIRESTORE_EMULATOR_HOST:"localhost:8080",VITE_FIREBASE_FUNCTIONS_EMULATOR_HOST:"localhost:5001",VITE_FIREBASE_MEASUREMENT_ID:"G-CV6QGH7G7P",VITE_FIREBASE_MESSAGING_SENDER_ID:"483702062341",VITE_FIREBASE_PROJECT_ID:"voda-c6abd",VITE_FIREBASE_STORAGE_BUCKET:"voda-c6abd.appspot.com",VITE_FORCE_HASH_ROUTER:"true",VITE_SHOP_ID:"demo-shop-001",VITE_SHOP_NAME:"محل كاشي لينك التجريبي",VITE_SHOW_ENV_BANNER:"true",VITE_USE_EMULATORS:"false",VITE_USE_FIREBASE_EMULATOR:"false"},aa=i=>typeof i=="string"&&i.trim().length>0,sh={getCurrentMonthId(){const i=new Date;return`${i.getFullYear()}-${String(i.getMonth()+1).padStart(2,"0")}`},async getWalletUsage(i){var u;try{if(!aa(i))return console.error("Error getting wallet usage: invalid walletId",i),null;const c=$e(J,"walletLimits",i),p=await da(c);if(p.exists()){const D=p.data();return{walletId:i,used_transfer:D.monthlyTransferUsed??D.used_transfer??0,used_withdraw:D.monthlyWithdrawUsed??D.used_withdraw??0,monthly_limit:D.monthlyLimit??D.monthlyTransferLimit??D.monthlyWithdrawLimit??2e5,last_reset:D.lastMonthlyReset??D.last_reset??null,updatedAt:D.updatedAt||wa.now()}}const v={walletId:i,used_transfer:0,used_withdraw:0,monthly_limit:2e5,last_reset:null,updatedAt:wa.now()};return await Is(c,{monthlyTransferUsed:0,monthlyWithdrawUsed:0,monthlyTransferLimit:2e5,monthlyWithdrawLimit:2e5,lastMonthlyReset:null,updatedAt:Ye(),ownerId:(u=$a.currentUser)==null?void 0:u.uid}),v}catch(c){return console.error("Error getting wallet usage:",c),{walletId:i,used_transfer:0,used_withdraw:0,monthly_limit:2e5,last_reset:null,updatedAt:wa.now()}}},shouldResetLimits(i){const u=new Date,c=u.getDate();if(!i)return!0;if(c===1){const p=i.toDate(),v=u.getMonth(),D=u.getFullYear();return p.getMonth()!==v||p.getFullYear()!==D}return!1},async autoResetLimitsIfNeeded(i){try{if(!aa(i))return console.error("خطأ في التصفير التلقائي للحدود: walletId غير صالح",i),!1;typeof import.meta<"u";const u=await this.getWalletUsage(i);return u&&this.shouldResetLimits(u.last_reset)?(console.log(`🔄 تصفير تلقائي للحدود للمحفظة ${i} - اليوم الأول من الشهر`),await this.resetWalletUsage(i)):!1}catch(u){return console.error("خطأ في التصفير التلقائي للحدود:",u),!1}},async resetWalletUsage(i){try{if(!aa(i))return console.error("خطأ في تصفير استخدام المحفظة: walletId غير صالح",i),!1;const u=$e(J,"walletLimits",i);return await Is(u,{monthlyTransferUsed:0,monthlyWithdrawUsed:0,lastMonthlyReset:Ye(),updatedAt:Ye()},{merge:!0}),console.log(`🔄 تم تصفير استخدام المحفظة ${i} بنجاح`),!0}catch(u){return console.error("خطأ في تصفير استخدام المحفظة:",u),!1}},async calculateUsageFromTransactions(i){var u,c;try{if(!aa(i))return console.error("خطأ في حساب الاستخدام من المعاملات: walletId غير صالح",i),{used_transfer:0,used_withdraw:0};const p=$e(J,"walletLimits",i),v=new Date;let D=wa.fromDate(new Date(v.getFullYear(),v.getMonth(),1));try{const A=await da(p);D=A.exists()?((u=A.data())==null?void 0:u.lastMonthlyReset)??((c=A.data())==null?void 0:c.last_reset)??D:D}catch{}const s=et(_e(J,"tx"),Ce("uid","==",i),...D?[Ce("createdAt",">=",D)]:[]),I=await ct(s);let M=0,S=0;return I.forEach(A=>{const P=A.data();P.status==="completed"&&(P.type==="transfer"?M+=P.amount:P.type==="withdraw"&&(S+=P.amount))}),{used_transfer:M,used_withdraw:S}}catch(p){return console.error("خطأ في حساب الاستخدام من المعاملات:",p),{used_transfer:0,used_withdraw:0}}},async getWalletUsageWithRefresh(i){var u,c;try{if(!aa(i))return console.error("خطأ في الحصول على الاستخدام مع التحديث: walletId غير صالح",i),null;typeof import.meta<"u";const p=await this.getWalletUsage(i);if(!p){const D=await this.calculateUsageFromTransactions(i),s=$e(J,"walletLimits",i);try{await Is(s,{monthlyTransferUsed:D.used_transfer,monthlyWithdrawUsed:D.used_withdraw,updatedAt:Ye(),ownerId:(u=$a.currentUser)==null?void 0:u.uid},{merge:!0})}catch{}return{walletId:i,used_transfer:D.used_transfer,used_withdraw:D.used_withdraw,monthly_limit:2e5,last_reset:null,updatedAt:wa.now()}}const v=await this.calculateUsageFromTransactions(i);if(p.used_transfer!==v.used_transfer||p.used_withdraw!==v.used_withdraw){const D=$e(J,"walletLimits",i);try{await Is(D,{monthlyTransferUsed:v.used_transfer,monthlyWithdrawUsed:v.used_withdraw,updatedAt:Ye(),ownerId:(c=$a.currentUser)==null?void 0:c.uid},{merge:!0})}catch{}return await this.getWalletUsage(i)}return p}catch(p){return console.error("خطأ في الحصول على الاستخدام مع التحديث:",p),{walletId:i,used_transfer:0,used_withdraw:0,monthly_limit:2e5,last_reset:null,updatedAt:wa.now()}}},calculateRemaining(i){return{remainingTransfer:Math.max(0,i.monthly_limit-i.used_transfer),remainingWithdraw:Math.max(0,i.monthly_limit-i.used_withdraw)}},async canPerformOperation(i,u,c){try{if(!aa(i))return console.error("Error checking operation limits: invalid walletId",i),{canPerform:!1,message:"walletId غير صالح"};const p=await this.getWalletUsageWithRefresh(i);if(!p)return{canPerform:!1,message:"لا يمكن العثور على بيانات الاستخدام للمحفظة"};const v=this.calculateRemaining(p);return c==="transfer"&&u>v.remainingTransfer?{canPerform:!1,message:`تجاوز حد التحويل المسموح. المتبقي: ${v.remainingTransfer.toLocaleString()} ج.م من أصل ${p.monthly_limit.toLocaleString()} ج.م`,remaining:v.remainingTransfer}:c==="withdraw"&&u>v.remainingWithdraw?{canPerform:!1,message:`تجاوز حد السحب المسموح. المتبقي: ${v.remainingWithdraw.toLocaleString()} ج.م من أصل ${p.monthly_limit.toLocaleString()} ج.م`,remaining:v.remainingWithdraw}:{canPerform:!0}}catch(p){return console.error("Error checking operation limits:",p),{canPerform:!1,message:"خطأ في التحقق من الحدود"}}},async updateUsage(i,u,c){var p;try{if(!aa(i))throw new Error("walletId غير صالح");const v=await this.getWalletUsageWithRefresh(i);if(!v)throw new Error("لا يمكن العثور على بيانات الاستخدام للمحفظة");const D=await this.canPerformOperation(i,u,c);if(!D.canPerform)throw new Error(D.message||"لا يمكن إجراء العملية");const s=c==="transfer"?v.used_transfer+u:v.used_transfer,I=c==="withdraw"?v.used_withdraw+u:v.used_withdraw,M=$e(J,"walletLimits",v.walletId);try{await Is(M,{monthlyTransferUsed:s,monthlyWithdrawUsed:I,updatedAt:Ye(),ownerId:(p=$a.currentUser)==null?void 0:p.uid},{merge:!0})}catch{}let S=await this.getWalletUsageWithRefresh(i);return S||(S={walletId:i,used_transfer:s,used_withdraw:I,monthly_limit:v.monthly_limit,last_reset:v.last_reset,updatedAt:wa.now()}),S}catch(v){throw console.error("Error updating wallet usage:",v),v}},async resetWalletUsageManually(i){try{if(!aa(i))throw new Error("walletId غير صالح");const u=$e(J,"walletLimits",i),c={walletId:i,used_transfer:0,used_withdraw:0,monthly_limit:0,last_reset:null,updatedAt:new Date};return Is(u,{monthlyTransferUsed:0,monthlyWithdrawUsed:0,lastMonthlyReset:Ye(),updatedAt:Ye()},{merge:!0}).catch(p=>{console.error("خطأ في حفظ تصفير الاستخدام في Firebase:",p)}),console.log(`✅ تم تصفير استخدام المحفظة ${i} بنجاح`),c}catch(u){throw console.error("Error resetting wallet usage:",u),u}},async getAllWalletsUsage(i){try{const c=(await Ws.getByMerchantId(i)).map(v=>this.getWalletUsageWithRefresh(v.id));return(await Promise.all(c)).filter(v=>v!==null)}catch(u){return console.error("Error getting all wallets usage:",u),[]}}};function ah(i){return i?`readBroadcastIds_${i}`:"readBroadcastIds_guest"}function rh({className:i}){const{user:u,profile:c,isSubscriptionActive:p}=Us(),v=bo(),[D,s]=n.useState([]),[I,M]=n.useState(new Set),[S,A]=n.useState(!1),[P,f]=n.useState(""),[w,T]=n.useState(!1),[V,O]=n.useState(null),[q,Y]=n.useState("none"),[ae,_]=n.useState(null),[W,ne]=n.useState(!1);n.useRef(new Set),n.useRef(!1);const se=n.useRef(null),xe=n.useRef(null);n.useRef(null);const[re,X]=n.useState({position:"fixed",top:0,left:0,zIndex:1e4}),Se=!1,Ae=n.useMemo(()=>{const Z=["global"];return u!=null&&u.uid&&Z.push(`user:${u.uid}`),c!=null&&c.shopId&&Z.push(`shop:${c.shopId}`),Z},[u==null?void 0:u.uid,c==null?void 0:c.shopId]),je=ah(u==null?void 0:u.uid),We=n.useMemo(()=>{var ze;const Z=(ze=v==null?void 0:v.pathname)==null?void 0:ze.includes("/user/pending-approval");return!!(u!=null&&u.uid)&&!Z},[u==null?void 0:u.uid,v==null?void 0:v.pathname]);n.useEffect(()=>{try{const Z=localStorage.getItem(je);if(Z){const Q=JSON.parse(Z);Array.isArray(Q)&&M(new Set(Q.filter(Boolean)))}else M(new Set)}catch(Z){console.warn("Failed to load read ids",Z),M(new Set)}},[je]),n.useEffect(()=>{if(!We){s([]);return}const Z=Tm(Ae,Q=>{s(Q)});return()=>Z()},[Ae,We]),n.useEffect(()=>{},[D]),n.useEffect(()=>()=>{se.current&&clearTimeout(se.current)},[]);const Me=D.reduce((Z,Q)=>Z+(Q.id&&!I.has(Q.id)?1:0),0),Qe=Z=>{if(!Z||I.has(Z))return;const Q=new Set(I);Q.add(Z),M(Q);try{localStorage.setItem(je,JSON.stringify(Array.from(Q)))}catch{}},G=()=>{const Z=D.map(ze=>ze.id).filter(Boolean),Q=new Set(I);Z.forEach(ze=>Q.add(ze)),M(Q);try{localStorage.setItem(je,JSON.stringify(Array.from(Q)))}catch{}},ue=(Z,Q)=>{Z&&window.open(Z,"_blank"),Q&&Qe(Q)};n.useEffect(()=>{},[W]);const fe=async()=>{if(!(u!=null&&u.uid)){alert("يرجى تسجيل الدخول لإرسال الطلب.");return}const Z=P.trim();if(!Z){alert("يرجى كتابة سبب طلب التحدث.");return}try{T(!0),O(null);const Q=c!=null&&c.fullName&&c.fullName.trim()?c.fullName.trim():u.email?u.email.split("@")[0]:"مستخدم",ze=(c==null?void 0:c.phone)||null;await Ts(_e(J,"waiting_list"),{userId:u.uid,name:Q,phone:ze,reason:Z,status:"pending",createdAt:Ye()}),O("تم إرسال طلبك إلى قائمة الانتظار بنجاح ✅"),f(""),setTimeout(()=>A(!1),900)}catch(Q){console.error("فشل إرسال طلب قائمة الانتظار:",Q),alert("حدث خطأ أثناء إرسال الطلب. حاول مرة أخرى.")}finally{T(!1)}};return n.useEffect(()=>{if(!(u!=null&&u.uid)){Y("none");return}let Z=null;try{const Q=et(_e(J,"waiting_list"),Ce("userId","==",u.uid));Z=Bs(Q,ze=>{const mt=ze.docs.map(Le=>({id:Le.id,...Le.data()})).sort((Le,Ct)=>{var be,st,ms,_t,Wt,L;const ht=((st=(be=Le==null?void 0:Le.createdAt)==null?void 0:be.toMillis)==null?void 0:st.call(be))??((ms=Le==null?void 0:Le.createdAt)==null?void 0:ms.seconds)*1e3??0;return(((Wt=(_t=Ct==null?void 0:Ct.createdAt)==null?void 0:_t.toMillis)==null?void 0:Wt.call(_t))??((L=Ct==null?void 0:Ct.createdAt)==null?void 0:L.seconds)*1e3??0)-ht});if(mt.length===0){Y("none");return}const Et=mt[0],St=(Et==null?void 0:Et.contacted)===!0||(Et==null?void 0:Et.status)==="contacted";Y(St?"contacted":"pending")})}catch(Q){console.warn("⚠️ فشل الاشتراك في waiting_list للمستخدم:",Q),Y("none")}return()=>{Z&&Z()}},[u==null?void 0:u.uid]),We?e.jsxs("div",{className:`relative inline-flex items-center gap-2 ${i||""}`,ref:xe,children:[e.jsxs(Om,{onOpenChange:Z=>{Z&&Me>0&&G()},children:[e.jsx(Em,{asChild:!0,children:e.jsx(h,{variant:"ghost",className:"relative h-8 w-8 rounded-full p-0 hover:bg-transparent focus:ring-1 focus:ring-primary focus:ring-offset-1 transition-all",title:"الإشعارات",children:e.jsxs("div",{className:"relative h-8 w-8 rounded-full bg-primary/10 flex items-center justify-center border border-border shadow-sm hover:shadow-md",children:[e.jsx(co,{className:"h-4 w-4 text-primary"}),Me>0&&e.jsx("span",{className:"absolute -top-1 -right-1 min-w-[18px] h-[18px] px-1 rounded-full bg-red-500 text-white text-[10px] font-bold flex items-center justify-center shadow",children:Me})]})})}),e.jsxs(_m,{className:"w-80",align:"end",forceMount:!0,children:[e.jsxs(Wm,{className:"flex items-center justify-between",children:[e.jsx("span",{children:"الإشعارات"}),D.length>0&&e.jsxs(h,{variant:"outline",size:"sm",className:"h-7 text-xs",onClick:G,children:[e.jsx(ha,{className:"h-3 w-3 mr-1"}),"تمييز الكل كمقروء"]})]}),e.jsx(Fm,{}),D.length===0?e.jsx("div",{className:"p-3 text-sm text-muted-foreground",children:"لا توجد إشعارات حالياً"}):e.jsx("div",{className:"max-h-64 overflow-y-auto pr-1",children:D.map(Z=>{const Q=Z.id?!I.has(Z.id):!1;return e.jsx("div",{className:`px-2 py-2 rounded-md ${Q?"bg-primary/5":""}`,children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(co,{className:`h-4 w-4 ${Q?"text-primary":"text-muted-foreground"}`}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-sm font-medium",children:Z.title||"إشعار"}),e.jsx("div",{className:"text-xs text-muted-foreground whitespace-pre-line",children:Z.message}),Z.linkUrl&&e.jsxs(h,{variant:"link",className:"px-0 h-6 text-xs",onClick:()=>ue(Z.linkUrl,Z.id),children:["فتح الرابط ",e.jsx(Pm,{className:"h-3 w-3 ml-1"})]})]}),Q?e.jsx(h,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>Qe(Z.id),title:"تمييز كمقروء",children:e.jsx(ha,{className:"h-4 w-4 text-primary"})}):e.jsx(h,{variant:"ghost",size:"icon",className:"h-6 w-6",disabled:!0,title:"مقروء",children:e.jsx(ha,{className:"h-4 w-4 text-muted-foreground"})})]})},Z.id)})})]})]}),e.jsxs(ce,{open:S,onOpenChange:A,children:[e.jsx(hm,{asChild:!0,children:e.jsx(h,{variant:"ghost",size:"icon",className:"h-8 w-8 rounded-full hover:bg-transparent focus:ring-1 focus:ring-primary/60 focus:ring-offset-1",title:"قائمة الانتظار",children:e.jsx(Zs,{className:`h-4 w-4 ${q==="pending"?"text-red-600":q==="contacted"?"text-green-600":"text-muted-foreground"}`})})}),e.jsxs(de,{className:"max-w-md border border-purple-200/50 shadow-xl bg-gradient-to-br from-purple-50 to-blue-50",children:[e.jsxs(me,{children:[e.jsx(he,{children:"طلب التحدث"}),e.jsx(ss,{children:"يرجى كتابة سبب طلب التحدث ليصل للإدارة في قسم قائمة الانتظار."})]}),e.jsxs("div",{className:"grid gap-3",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"سبب الطلب"}),e.jsx(km,{value:P,onChange:Z=>f(Z.target.value),placeholder:"اكتب سبب طلب التحدث هنا...",className:"min-h-[120px] text-right"}),V&&e.jsx("div",{className:"text-sm text-green-700 bg-green-50 border border-green-200 rounded-md p-2",children:V})]}),e.jsxs(Ge,{children:[e.jsx(h,{variant:"outline",onClick:()=>A(!1),disabled:w,children:"إلغاء"}),e.jsx(h,{onClick:fe,disabled:w,className:"bg-gradient-to-r from-green-600 to-emerald-600 text-white",children:w?"جارٍ الإرسال...":"إرسال"})]})]})]}),Se]}):null}const xo=({isOpen:i,onClose:u,onTrialStarted:c})=>{const{user:p}=Us(),[v,D]=n.useState(!1),[s,I]=n.useState(!1),[M,S]=n.useState(""),[A,P]=n.useState(24);n.useEffect(()=>{const T=async()=>{if(p!=null&&p.uid){const O=await br.getTrialData(p.uid);I(O.hasUsedFreeTrial)}},V=async()=>{try{const O=await br.getTrialDurationHours();P(O)}catch{}};i&&(T(),V())},[i,p]);const f=async()=>{if(p!=null&&p.uid){D(!0);try{const T=await br.startFreeTrial(p.uid);T.success?(S(T.message),window.location.href="/user/dashboard"):S(T.message||"تعذر تفعيل التجربة المجانية")}catch{S("حدث خطأ أثناء تفعيل التجربة المجانية")}finally{D(!1)}}},w=async()=>{if(p!=null&&p.uid){D(!0);try{await em(p.uid,cs.ZERO,p.uid),window.location.href="/user/dashboard"}catch{S("حدث خطأ أثناء تفعيل باقة الزيرو")}finally{D(!1)}}};return e.jsxs(e.Fragment,{children:[i&&e.jsx("div",{className:"fixed inset-0 z-40",style:{background:"rgba(0, 0, 0, 0.15)",pointerEvents:"auto"}}),e.jsx(ce,{open:i,onOpenChange:()=>{},children:e.jsxs(de,{className:"sm:max-w-lg z-50 border-0 shadow-2xl",style:{position:"fixed",top:"50%",left:"50%",transform:"translate(-50%, -50%)",pointerEvents:"auto",background:"linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 0.95) 100%)",borderRadius:"20px",border:"1px solid rgba(255, 255, 255, 0.3)"},children:[e.jsxs(me,{className:"text-center pb-0 pt-0",children:[e.jsx("div",{className:"flex justify-center mb-1",children:e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-0 rounded-full",style:{background:"linear-gradient(135deg, #f59e0b, #d97706)",filter:"blur(8px)",opacity:.3}}),e.jsx("div",{className:"relative bg-gradient-to-br from-orange-400 to-orange-600 p-2 rounded-full",children:e.jsx(Ni,{className:"h-12 w-12 text-white"})})]})}),e.jsx(he,{className:"text-2xl font-bold bg-gradient-to-r from-gray-800 to-gray-600 bg-clip-text text-transparent text-center mt-0 mb-0 leading-tight",children:"تفعيل الحساب مطلوب"})]}),e.jsxs("div",{className:"text-center pt-6 pb-0 px-2",children:[e.jsxs("div",{className:"bg-gradient-to-r from-orange-50 to-amber-50 rounded-xl p-6 mb-6 border border-orange-100",children:[e.jsx("p",{className:"text-gray-700 text-lg leading-relaxed font-medium",children:"حسابك في انتظار التفعيل من قبل المسؤول"}),e.jsx("p",{className:"text-sm font-semibold text-orange-700 mt-3 mb-3 bg-orange-100 p-3 rounded-lg border border-orange-200",children:"للتفعيل السريع: تواصل مع الإدارة عبر واتساب فقط على الرقم التالي"}),e.jsxs("div",{className:"bg-green-50 p-4 rounded-lg border border-green-200 mt-3",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"text-base font-bold text-green-700",children:"واتساب الإدارة:"}),e.jsx("a",{href:"https://wa.me/201000392539",target:"_blank",rel:"noopener noreferrer",className:"text-lg font-bold text-green-600 hover:text-green-700 underline",children:"01000392539"})]}),e.jsx("p",{className:"text-sm text-green-600 mt-2 text-center",children:"اضغط على الرقم للتواصل المباشر عبر واتساب"})]})]}),!s&&e.jsxs("div",{className:"bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-4 mb-4 border border-green-200",children:[e.jsxs("div",{className:"flex items-center justify-center mb-2",children:[e.jsx(Ni,{className:"h-5 w-5 text-green-600 ml-2"}),e.jsx("span",{className:"text-green-700 font-semibold",children:"باقة الزيرو المجانية الدائمة"})]}),e.jsx("p",{className:"text-green-600 text-sm text-center",children:"فعل باقة الزيرو الان واستمتع ب 10 عمليات سحب وتحويل يوميا"})]}),M&&e.jsx("div",{className:`rounded-xl p-4 mb-4 text-center ${M.includes("تم تفعيل")?"bg-green-50 border border-green-200 text-green-700":"bg-red-50 border border-red-200 text-red-700"}`,children:e.jsx("p",{className:"font-medium",children:M})}),e.jsxs("div",{className:"flex items-center justify-center space-x-2 text-sm text-gray-500 mb-0",children:[e.jsxs("div",{className:"flex space-x-1",children:[e.jsx("div",{className:"w-2 h-2 bg-orange-400 rounded-full animate-pulse"}),e.jsx("div",{className:"w-2 h-2 bg-orange-400 rounded-full animate-pulse",style:{animationDelay:"0.2s"}}),e.jsx("div",{className:"w-2 h-2 bg-orange-400 rounded-full animate-pulse",style:{animationDelay:"0.4s"}})]}),e.jsx("span",{className:"mr-2",children:"في انتظار التفعيل"})]})]}),e.jsxs("div",{className:"flex flex-col space-y-3 pb-2",children:[!s&&!M.includes("تم تفعيل")&&e.jsxs(e.Fragment,{children:[e.jsxs(h,{onClick:f,disabled:v,className:"w-full max-w-2xl mx-auto relative bg-gradient-to-r from-blue-600 to-indigo-600 hover:brightness-110 text-white px-10 py-4 rounded-2xl font-bold text-xl ring-2 ring-blue-300 ring-offset-1 shadow-2xl hover:shadow-3xl transition-all duration-500 transform hover:scale-110 hover:-translate-y-1 disabled:opacity-50 disabled:cursor-not-allowed overflow-hidden group focus-visible:outline-none focus-visible:ring-4 focus-visible:ring-blue-300",style:{boxShadow:"0 15px 35px rgba(59, 130, 246, 0.4), 0 5px 15px rgba(0, 0, 0, 0.1)"},children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-white/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"}),e.jsx("div",{className:"absolute -top-1 -left-1 w-3 h-3 bg-yellow-400 rounded-full animate-ping"}),e.jsx("div",{className:"absolute -top-1 -right-1 w-2 h-2 bg-green-400 rounded-full animate-pulse"}),v?e.jsxs("div",{className:"flex items-center relative z-10",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-white ml-3"}),e.jsx("span",{className:"bg-gradient-to-r from-white to-gray-100 bg-clip-text text-transparent",children:"جاري التفعيل..."})]}):e.jsxs("div",{className:"flex items-center relative z-10",children:[e.jsx(Mm,{className:"h-6 w-6 ml-3 animate-bounce"}),e.jsx("span",{className:"bg-gradient-to-r from-white to-gray-100 bg-clip-text text-transparent",children:`التجربة المجانية لمدة ${A} ${A>=3&&A<=10?"ساعات":A===2?"ساعتين":"ساعة"}`})]})]}),e.jsxs(h,{onClick:w,disabled:v,className:"w-full max-w-2xl mx-auto relative bg-gradient-to-r from-green-600 to-emerald-600 hover:brightness-110 text-white px-10 py-4 rounded-2xl font-bold text-xl ring-2 ring-emerald-300 ring-offset-1 shadow-2xl hover:shadow-3xl transition-all duration-500 transform hover:scale-110 hover:-translate-y-1 disabled:opacity-50 disabled:cursor-not-allowed overflow-hidden group focus-visible:outline-none focus-visible:ring-4 focus-visible:ring-emerald-300",style:{boxShadow:"0 15px 35px rgba(99, 102, 241, 0.4), 0 5px 15px rgba(0, 0, 0, 0.1)"},children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-white/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"}),e.jsx("div",{className:"absolute -top-1 -left-1 w-3 h-3 bg-yellow-400 rounded-full animate-ping"}),e.jsx("div",{className:"absolute -top-1 -right-1 w-2 h-2 bg-green-400 rounded-full animate-pulse"}),v?e.jsxs("div",{className:"flex items-center relative z-10",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-white ml-3"}),e.jsx("span",{className:"bg-gradient-to-r from-white to-gray-100 bg-clip-text text-transparent",children:"جاري التفعيل..."})]}):e.jsxs("div",{className:"flex items-center relative z-10",children:[e.jsx(Ni,{className:"h-6 w-6 ml-3 animate-bounce"}),e.jsx("span",{className:"bg-gradient-to-r from-white to-gray-100 bg-clip-text text-transparent",children:"فعّل باقة الزيرو الآن"})]})]})]}),e.jsx(h,{onClick:u,variant:"outline",className:"border-2 border-gray-300 hover:border-gray-400 text-gray-700 hover:text-gray-800 px-10 py-3 rounded-xl font-semibold text-lg transition-all duration-300 transform hover:scale-105",children:s?"فهمت":"إغلاق"})]})]})})]})};function nh({isOpen:i,onClose:u}){const[c,p]=n.useState("0"),[v,D]=n.useState(null),[s,I]=n.useState(null),[M,S]=n.useState(!1),A=_=>{M?(p(_),S(!1)):p(c==="0"?_:c+_)},P=_=>{const W=parseFloat(c);if(v===null)D(W);else if(s){const se=f(v||0,W,s);p(String(se)),D(se)}S(!0),I(_)},f=(_,W,ne)=>{switch(ne){case"+":return _+W;case"-":return _-W;case"×":return _*W;case"÷":return W===0?0:_/W;case"=":return W;default:return W}},w=()=>{const _=parseFloat(c);if(v!==null&&s){const W=f(v,_,s);p(String(W)),D(null),I(null),S(!0)}},T=()=>{p("0"),D(null),I(null),S(!1)},V=()=>{p("0")},O=()=>{M?(p("0."),S(!1)):c.indexOf(".")===-1&&p(c+".")},q=()=>{c!=="0"&&p(c.charAt(0)==="-"?c.slice(1):"-"+c)},Y=()=>{const _=parseFloat(c);p(String(_/100))},ae=_=>{const W=_.key;_.preventDefault(),W>="0"&&W<="9"?A(W):W==="+"?P("+"):W==="-"?P("-"):W==="*"?P("×"):W==="/"?P("÷"):W==="Enter"||W==="="?w():W==="Escape"||W==="c"||W==="C"?T():W==="Backspace"?V():W==="."?O():W==="%"&&Y()};return n.useEffect(()=>(i?document.addEventListener("keydown",ae):document.removeEventListener("keydown",ae),()=>{document.removeEventListener("keydown",ae)}),[i,c,v,s,M]),e.jsx(ce,{open:i,onOpenChange:_=>!_&&u(),children:e.jsxs(de,{className:"sm:max-w-md",children:[e.jsx(me,{children:e.jsxs(he,{className:"flex items-center gap-2 text-right",children:[e.jsx(To,{className:"h-5 w-5"}),"آلة حاسبة"]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-gray-900 text-white p-4 rounded-lg text-right",children:e.jsx("div",{className:"text-3xl font-mono font-bold min-h-[3rem] flex items-center justify-end overflow-hidden",children:c})}),e.jsxs("div",{className:"grid grid-cols-4 gap-2",children:[e.jsx(h,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:T,children:"AC"}),e.jsx(h,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:V,children:"CE"}),e.jsx(h,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:Y,children:"%"}),e.jsx(h,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>P("÷"),children:"÷"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>A("7"),children:"7"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>A("8"),children:"8"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>A("9"),children:"9"}),e.jsx(h,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>P("×"),children:"×"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>A("4"),children:"4"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>A("5"),children:"5"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>A("6"),children:"6"}),e.jsx(h,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>P("-"),children:"-"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>A("1"),children:"1"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>A("2"),children:"2"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>A("3"),children:"3"}),e.jsx(h,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>P("+"),children:"+"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50 col-span-2",onClick:()=>A("0"),children:"0"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:O,children:"."}),e.jsx(h,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:w,children:"="})]}),e.jsx(h,{variant:"outline",className:"w-full h-10 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:q,children:"+/-"})]})]})})}function ih({isOpen:i,onClose:u,initialBarcode:c}){const[p,v]=n.useState([]),[D,s]=n.useState({productName:"",price:"",wholesalePrice:"",quantity:"",barcode:"",serialNumber:""}),[I,M]=n.useState(!1),[S,A]=n.useState(null),{toast:P}=Ps(),{user:f,profile:w}=Us(),{isShiftActive:T,shiftUser:V}=Sr(),{shopId:O}=vn(),[q,Y]=n.useState([]),[ae,_]=n.useState({}),[W,ne]=n.useState({}),[se,xe]=n.useState({}),[re,X]=n.useState(""),[Se,Ae]=n.useState(!1),[je,We]=n.useState({}),[Me,Qe]=n.useState(!1),[G,ue]=n.useState(!0),[fe,Z]=n.useState(!1),Q=Ve.useRef(""),ze=Ve.useRef(0),[mt,Et]=n.useState(0),[St,Le]=n.useState(0),[Ct,ht]=n.useState(!1),[Dt,be]=n.useState(!0),[st,ms]=n.useState(!1),[_t,Wt]=n.useState(!0),[L,ye]=n.useState(!0),[Oe,at]=n.useState({}),[kt,pt]=n.useState(!1),[gt,rt]=n.useState("التحقق قبل العملية"),[Ue,ft]=n.useState("أدخل الرقم السري الرئيسي للمتابعة"),it=Ve.useRef(null),Lt=(m,E,F)=>{rt(m),ft(E),it.current=F,pt(!0)},[It,R]=n.useState(""),we=n.useMemo(()=>{const m=It.trim().toLowerCase();return m?q.filter(E=>E.name.toLowerCase().includes(m)):q},[q,It]),Pe=()=>new Date().toISOString().split("T")[0];n.useEffect(()=>{i&&(f!=null&&f.uid)&&(Rt(),Dt||Gt())},[i,f==null?void 0:f.uid,Dt]),n.useEffect(()=>{if(!(!i||!(f!=null&&f.uid)))try{const m=Pe(),E=new Intl.DateTimeFormat("en-CA",{timeZone:"Africa/Cairo"}).format(new Date),F=k=>{try{const te=k.docs.map(ve=>{const oe=ve.data();return{id:String(oe.clientId||ve.id),productName:String(oe.productName||""),price:Number(oe.sellingPrice||0),wholesalePrice:typeof oe.wholesalePrice=="number"?oe.wholesalePrice:Number(oe.wholesalePrice||0),quantity:Number(oe.quantity||0),date:String(oe.date||m),time:String(oe.time||""),performedByType:oe.performedByType||void 0,performedByName:oe.performedByName||void 0,performedByUsername:oe.performedByUsername||null,serialNumber:oe.serialNumber||void 0,barcode:oe.barcode||void 0,firestoreId:ve.id}}).filter(ve=>{const oe=String((ve==null?void 0:ve.date)||"").slice(0,10);return oe===m||oe===E}),pe=(p||[]).filter(ve=>!ve.firestoreId),le={};[...te,...pe].forEach(ve=>{le[ve.id]=ve});const Ie=Object.values(le);Ze(Ie)}catch{}};let N;try{const k=O||(w==null?void 0:w.shopId)||null,K=et(_e(J,"dailySales"),Ce("userId","==",f.uid),...k?[Ce("shopId","==",k)]:[]);N=Bs(K,F,()=>{try{N&&N()}catch{}const te=et(_e(J,"users",f.uid,"dailySales"),...k?[Ce("shopId","==",k)]:[]);N=Bs(te,F)})}catch{const k=O||(w==null?void 0:w.shopId)||null,K=et(_e(J,"users",f.uid,"dailySales"),...k?[Ce("shopId","==",k)]:[]);N=Bs(K,F)}return()=>{try{N&&N()}catch{}}}catch{}},[i,f==null?void 0:f.uid]),n.useEffect(()=>{if(!i)return;const m=E=>{const F=Date.now();if(E.key==="Enter"){const N=(Q.current||"").trim();Q.current="",N&&ls(N);return}E.key.length===1&&(F-(ze.current||0)>100&&(Q.current=""),Q.current+=E.key,ze.current=F)};return window.addEventListener("keydown",m),()=>window.removeEventListener("keydown",m)},[i,q]),n.useEffect(()=>{i&&c&&ls(c)},[i,c]);const Ke=async()=>{if(f!=null&&f.uid)try{const m=w==null?void 0:w.shopId;let E,F=[];if(m){const N=et(_e(J,"products"),Ce("shopId","==",m),Ce("userId","==",f.uid));if(E=await ct(N),F=E.docs.map(k=>({id:k.id,name:String(k.data().name??""),sellingPrice:Number(k.data().sellingPrice??0),wholesalePrice:Number(k.data().wholesalePrice??0),quantity:Number(k.data().quantity??0),barcode:String(k.data().barcode??""),serialNumber:String(k.data().serialNumber??"")})),F.length===0){const k=et(_e(J,"products"),Ce("userId","==",f.uid)),te=(await ct(k)).docs.map(pe=>({id:pe.id,name:String(pe.data().name??""),sellingPrice:Number(pe.data().sellingPrice??0),wholesalePrice:Number(pe.data().wholesalePrice??0),quantity:Number(pe.data().quantity??0),barcode:String(pe.data().barcode??""),serialNumber:String(pe.data().serialNumber??"")}));te.length>0&&(F=te,P({title:"تم استرجاع المنتجات",description:"عثرنا على منتجات محفوظة لك خارج المتجر الحالي وقمنا بعرضها."}))}}else{const N=et(_e(J,"products"),Ce("userId","==",f.uid));E=await ct(N),F=E.docs.map(k=>({id:k.id,name:String(k.data().name??""),sellingPrice:Number(k.data().sellingPrice??0),wholesalePrice:Number(k.data().wholesalePrice??0),quantity:Number(k.data().quantity??0),barcode:String(k.data().barcode??""),serialNumber:String(k.data().serialNumber??"")}))}if(Y(F),w!=null&&w.shopId&&F.length>0){const N=F.filter(k=>{const K=((E==null?void 0:E.docs)||[]).find(pe=>pe.id===k.id);return!(!!K&&!!K.data().shopId)});if(N.length>0)try{await Promise.all(N.map(k=>Ls($e(J,"products",k.id),{shopId:w.shopId,updatedAt:Ye()}))),P({title:"تم ترتيب المنتجات",description:"تم ربط بعض المنتجات غير المربوطة بمتجرك الحالي تلقائياً."})}catch(k){console.warn("تعذّر ترحيل shopId لبعض المنتجات:",k)}}}catch(m){console.error("Error loading shop products:",m)}};n.useEffect(()=>{i&&(f!=null&&f.uid)&&(Ke(),Gt(),Rt(),Ns())},[i,f==null?void 0:f.uid,w==null?void 0:w.shopId]);const Ee=()=>{const m=new Date,E=m.getFullYear(),F=String(m.getMonth()+1).padStart(2,"0"),N=String(m.getDate()).padStart(2,"0");return`${E}-${F}-${N}`},Rt=()=>{if(!(f!=null&&f.uid)){console.log("No user authenticated, cannot load sales data");return}const m=O||(w==null?void 0:w.shopId)||"main",E=`salesData_all_${f.uid}_${m}`,F=localStorage.getItem(E);if(F)try{v(JSON.parse(F))}catch{}const N=Ee(),k=`salesData_${f.uid}_${m}_${N}`,K=localStorage.getItem(k);if(K){const Ie=JSON.parse(K);v(Ie);try{localStorage.setItem(E,JSON.stringify(Ie))}catch{}}const te=new Date().toISOString().split("T")[0],pe=`salesData_${f.uid}_${m}_${te}`,le=localStorage.getItem(pe);if(le){const Ie=JSON.parse(le);v(Ie);try{localStorage.setItem(k,le),localStorage.setItem(E,le)}catch{}}v([]),zt()},Ze=m=>{if(!(f!=null&&f.uid)){console.log("No user authenticated, cannot save sales data");return}const E=O||(w==null?void 0:w.shopId)||"main",F=Ee(),N=`salesData_${f.uid}_${E}_${F}`,k=`salesData_all_${f.uid}_${E}`;localStorage.setItem(N,JSON.stringify(m));try{const K=localStorage.getItem(k),te=K?JSON.parse(K):[],pe={};[...Array.isArray(te)?te:[],...m].forEach(le=>{pe[le.id]=le}),localStorage.setItem(k,JSON.stringify(Object.values(pe)))}catch{}v(m)},zt=async()=>{if(f!=null&&f.uid)try{const m=O||(w==null?void 0:w.shopId)||null,E=new Date().toISOString().split("T")[0],F=new Intl.DateTimeFormat("en-CA",{timeZone:"Africa/Cairo"}).format(new Date);let N,k;try{const ve=et(_e(J,"dailySales"),Ce("userId","==",f.uid),...m?[Ce("shopId","==",m)]:[]);N=await ct(ve)}catch{}try{const ve=et(_e(J,"users",f.uid,"dailySales"),...m?[Ce("shopId","==",m)]:[]);k=await ct(ve)}catch{}const pe=[...N?N.docs:[],...k?k.docs:[]].map(ve=>{const oe=ve.data();return{id:String(oe.clientId||ve.id),firestoreId:ve.id,productName:String(oe.productName||""),price:Number(oe.sellingPrice||0),wholesalePrice:oe.wholesalePrice!==void 0?Number(oe.wholesalePrice):null,quantity:Number(oe.quantity||0),date:String(oe.date||E),time:String(oe.time||""),serialNumber:oe.serialNumber||void 0,barcode:oe.barcode||void 0,performedByType:oe.performedByType||void 0,performedByName:oe.performedByName||void 0,performedByUsername:oe.performedByUsername||void 0}}).filter(ve=>{const oe=String((ve==null?void 0:ve.date)||"").slice(0,10);return oe===E||oe===F}),le={};[...p,...pe].forEach(ve=>{le[ve.id]=ve});const Ie=Object.values(le);Ze(Ie)}catch{}},Gt=async()=>{if(f!=null&&f.uid)try{const m=new Date,E=new Date(m.getFullYear(),m.getMonth(),1),F=new Date(m.getFullYear(),m.getMonth()+1,0),N=ve=>ve.toISOString().split("T")[0],k=N(E),K=N(F),te=O||(w==null?void 0:w.shopId)||null;let pe;try{const ve=et(_e(J,"dailySales"),Ce("userId","==",f.uid),...te?[Ce("shopId","==",te)]:[]);pe=await ct(ve)}catch{const ve=et(_e(J,"users",f.uid,"dailySales"),...te?[Ce("shopId","==",te)]:[]);pe=await ct(ve)}let le=0,Ie=0;pe.forEach(ve=>{const oe=ve.data(),Qt=String(oe.date??"").slice(0,10);if(Qt>=k&&Qt<=K){const vt=Number(oe.sellingPrice??0),Fe=Number(oe.quantity??0),Je=Number(oe.profit??(Number(oe.sellingPrice??0)-Number(oe.wholesalePrice??0))*Fe);le+=vt*Fe,Ie+=Je}}),Et(le),Le(Ie)}catch(m){console.error("Error loading monthly stats:",m)}},is=async m=>{if(!(f!=null&&f.uid))return null;try{const E=((m.price??0)-(m.wholesalePrice??0))*(m.quantity??0),F=T&&V?"cashier":"admin",N=F==="cashier"?(V==null?void 0:V.name)||"كاشير":(w==null?void 0:w.fullName)||(f==null?void 0:f.displayName)||"الحساب الرئيسي",k=F==="cashier"&&(V==null?void 0:V.username)||null,K=await Ts(_e(J,"dailySales"),{userId:f.uid,clientId:m.id,productName:m.productName,quantity:m.quantity,wholesalePrice:m.wholesalePrice??null,sellingPrice:m.price,profit:E,date:m.date,time:m.time,performedByType:F,performedByName:N,performedByUsername:k,serialNumber:m.serialNumber??null,barcode:m.barcode??null,...w!=null&&w.shopId?{shopId:w.shopId}:O?{shopId:O}:{},createdAt:Ye()});try{await Is($e(J,"users",f.uid,"dailySales",K.id),{userId:f.uid,clientId:m.id,productName:m.productName,quantity:m.quantity,wholesalePrice:m.wholesalePrice??null,sellingPrice:m.price,profit:E,date:m.date,time:m.time,performedByType:F,performedByName:N,performedByUsername:k,serialNumber:m.serialNumber??null,barcode:m.barcode??null,...w!=null&&w.shopId?{shopId:w.shopId}:O?{shopId:O}:{},createdAt:Ye()})}catch{}return K.id}catch{try{const E=await Ts(_e(J,"users",f.uid,"dailySales"),{userId:f.uid,clientId:m.id,productName:m.productName,quantity:m.quantity,wholesalePrice:m.wholesalePrice??null,sellingPrice:m.price,profit,date:m.date,time:m.time,performedByType,performedByName,performedByUsername,serialNumber:m.serialNumber??null,barcode:m.barcode??null,...w!=null&&w.shopId?{shopId:w.shopId}:O?{shopId:O}:{},createdAt:Ye()});try{await Is($e(J,"dailySales",E.id),{userId:f.uid,clientId:m.id,productName:m.productName,quantity:m.quantity,wholesalePrice:m.wholesalePrice??null,sellingPrice:m.price,profit,date:m.date,time:m.time,performedByType,performedByName,performedByUsername,serialNumber:m.serialNumber??null,barcode:m.barcode??null,...w!=null&&w.shopId?{shopId:w.shopId}:O?{shopId:O}:{},createdAt:Ye()})}catch{}return E.id}catch(E){return console.error("Error saving sale:",E),null}}},nt=()=>{const m=O||(w==null?void 0:w.shopId)||"main";return`cashBalance_${(f==null?void 0:f.uid)||"default"}_${m}`},Ns=async()=>{if(!(f!=null&&f.uid))return;const m=p.filter(E=>!E.firestoreId);if(m.length!==0)for(const E of m)try{let F;try{const k=et(_e(J,"dailySales"),Ce("userId","==",f.uid),Ce("clientId","==",E.id),cn(1));F=await ct(k)}catch{const k=et(_e(J,"users",f.uid,"dailySales"),Ce("clientId","==",E.id),cn(1));F=await ct(k)}if(!F.empty){const k=F.docs[0].id,K=p.map(te=>te.id===E.id?{...te,firestoreId:k}:te);Ze(K);continue}const N=await is(E);if(N){const k=p.map(K=>K.id===E.id?{...K,firestoreId:N}:K);Ze(k)}}catch{}},yt=async m=>{try{if(f!=null&&f.uid)try{const le=_e(J,"deficiencies"),Ie=await Ts(le,{shopId:(w==null?void 0:w.shopId)||f.uid||"default-shop",name:m,quantity:1,status:"pending",createdAt:Ye()});try{const ve=`deficiencies_${(w==null?void 0:w.shopId)||(f==null?void 0:f.uid)||"default-shop"}`,oe=localStorage.getItem(ve),Qt=oe?JSON.parse(oe):[],vt=Array.isArray(Qt)?Qt:[],Fe=vt.some(qt=>String((qt==null?void 0:qt.id)||"")===Ie.id),Je={id:Ie.id,name:m,quantity:1,status:"pending",createdAt:new Date().toISOString()},Bt=Fe?vt:[...vt,Je];localStorage.setItem(ve,JSON.stringify(Bt))}catch{}P({title:"تمت الإضافة للنواقص",description:`المنتج ${m} نفد من المخزون وتمت إضافته للنواقص`});return}catch(le){console.warn("Failed to add deficiency to Firestore, falling back to local storage:",le)}const E=`deficiencies_${(w==null?void 0:w.shopId)||(f==null?void 0:f.uid)||"default-shop"}`,F=localStorage.getItem(E),N=F?JSON.parse(F):[],k=Array.isArray(N)?N:[];if(k.some(le=>String((le==null?void 0:le.name)||"").trim()===m&&String((le==null?void 0:le.status)||"pending")==="pending"))return;const te={id:Date.now().toString(),name:m,quantity:1,status:"pending",createdAt:new Date().toISOString()},pe=[...k,te];localStorage.setItem(E,JSON.stringify(pe)),P({title:"تمت الإضافة للنواقص",description:`المنتج ${m} نفد من المخزون وتمت إضافته للنواقص`})}catch(E){console.error("Error adding deficiency for out-of-stock:",E)}},zs=async m=>{const E=ae[m.id]||"",F=parseInt(E);if(isNaN(F)||F<=0){P({title:"كمية غير صالحة",description:"أدخل كمية صحيحة للبيـع",variant:"destructive"});return}if(F>m.quantity){P({title:"كمية أكبر من المتاح",description:"الكمية المطلوب بيعها تتجاوز المخزون المتاح",variant:"destructive"});return}const N=new Date,k=T&&V?"cashier":"admin",K=k==="cashier"?(V==null?void 0:V.name)||"كاشير":(w==null?void 0:w.fullName)||(f==null?void 0:f.displayName)||"الحساب الرئيسي",te=k==="cashier"&&(V==null?void 0:V.username)||null,pe=(m.serialNumber||"").trim(),le=Oe[m.id]||"",Ie=parseFloat(le),ve=!isNaN(Ie)&&Ie>0?Ie:m.sellingPrice,oe={id:Date.now().toString(),productName:m.name,price:ve,wholesalePrice:m.wholesalePrice,quantity:F,date:N.toISOString().split("T")[0],time:N.toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit"}),performedByType:k,performedByName:K,performedByUsername:te,serialNumber:pe||void 0,barcode:m.barcode};try{const Qt=await is(oe),vt=Qt?{...oe,firestoreId:Qt}:oe;Ze([...p,vt]);const Fe=m.quantity-F;await Ls($e(J,"products",m.id),{quantity:Fe,updatedAt:Ye()}),Y(Je=>Je.map(Bt=>Bt.id===m.id?{...Bt,quantity:Fe}:Bt)),_(Je=>({...Je,[m.id]:""})),at(Je=>({...Je,[m.id]:""})),Fe===0&&yt(m.name);try{const Je=ve*F,Bt=nt(),qt=localStorage.getItem(Bt),os=(qt?parseFloat(qt):0)+Je;localStorage.setItem(Bt,os.toString());const Pa=`userData_${f==null?void 0:f.uid}`,$t={cashBalance:os,lastUpdated:new Date().toISOString()};localStorage.setItem(Pa,JSON.stringify($t)),f!=null&&f.uid&&De.updateUserData(f.uid,$t).catch(()=>{})}catch(Je){console.warn("تعذر تحديث رصيد الدرج النقدي بعد البيع:",Je)}P({title:"تم البيع",description:`تم بيع ${F} قطعة من ${m.name}`})}catch(Qt){console.error("Error selling product:",Qt),P({title:"فشل البيع",description:"تعذّر تنفيذ عملية البيع",variant:"destructive"})}},ua=async m=>{if(!(f!=null&&f.uid))return;if(T){P({title:"غير مسموح في وضع الكاشير",description:"لا يمكن حذف إيصالات البيع أثناء الورديه",variant:"destructive"});return}window.confirm(`هل تريد حذف إيصال بيع للمنتج "${m.productName}"؟ سيتم عكس المخزون والرصيد.`)&&Lt("تأكيد حذف إيصال بيع","أدخل الرقم السري الرئيسي لحذف الإيصال وعكس الآثار",async()=>{try{try{const F=(m.price??0)*(m.quantity??0),N=nt(),k=localStorage.getItem(N),te=(k?parseFloat(k):0)-F;localStorage.setItem(N,te.toString());const pe=`userData_${f==null?void 0:f.uid}`,le={cashBalance:te,lastUpdated:new Date().toISOString()};localStorage.setItem(pe,JSON.stringify(le)),f!=null&&f.uid&&De.updateUserData(f.uid,le).catch(()=>{})}catch(F){console.warn("تعذر عكس رصيد الدرج النقدي عند حذف الإيصال:",F)}try{const F=q.find(N=>m.barcode&&N.barcode===m.barcode||N.name===m.productName);if(F){const N=(F.quantity||0)+(m.quantity||0);await Ls($e(J,"products",F.id),{quantity:N,updatedAt:Ye()}),Y(k=>k.map(K=>K.id===F.id?{...K,quantity:N}:K))}}catch(F){console.warn("تعذر عكس المخزون عند حذف الإيصال:",F)}try{if(m.firestoreId){try{await ws($e(J,"dailySales",m.firestoreId))}catch{}try{await ws($e(J,"users",f.uid,"dailySales",m.firestoreId))}catch{}}else{let F;try{const N=et(_e(J,"dailySales"),Ce("userId","==",f.uid),Ce("date","==",m.date),Ce("productName","==",m.productName),cn(5));F=await ct(N)}catch{const N=et(_e(J,"users",f.uid,"dailySales"),Ce("date","==",m.date),Ce("productName","==",m.productName),cn(5));F=await ct(N)}if(!F.empty){const N=F.docs.find(k=>{const K=k.data();return Number((K==null?void 0:K.sellingPrice)??0)===Number(m.price??0)&&Number((K==null?void 0:K.quantity)??0)===Number(m.quantity??0)&&String((K==null?void 0:K.time)??"")===String(m.time??"")})||F.docs[0];N&&await ws(N.ref)}}}catch(F){console.warn("تعذر حذف سجل البيع من Firestore:",F)}try{const F=Ee(),N=`salesData_${f.uid}_${F}`,k=`salesData_all_${f.uid}`,K=p.filter(Ie=>Ie.id!==m.id);localStorage.setItem(N,JSON.stringify(K));const te=localStorage.getItem(k),pe=te?JSON.parse(te):[],le=(Array.isArray(pe)?pe:[]).filter(Ie=>(Ie==null?void 0:Ie.id)!==m.id);localStorage.setItem(k,JSON.stringify(le)),v(K)}catch(F){console.warn("تعذر تحديث التخزين المحلي بعد الحذف:",F)}try{Dt||await Gt()}catch{}P({title:"تم حذف الإيصال",description:`تم حذف إيصال بيع للمنتج ${m.productName} وتم عكس الآثار`})}catch(F){console.error("Error deleting sale:",F),P({title:"فشل حذف الإيصال",description:"تعذّر حذف إيصال البيع",variant:"destructive"})}})},Ia=async m=>{try{_(E=>({...E,[m.id]:"1"})),await zs(m)}catch(E){console.error("Error selling by barcode:",E)}},Aa=async m=>{if(T){P({title:"غير مسموح في وضع الكاشير",description:"لا يمكن إضافة قطع أثناء الورديه",variant:"destructive"});return}const E=W[m.id]||"",F=parseInt(E);if(isNaN(F)||F<=0){P({title:"كمية غير صالحة",description:"أدخل كمية صحيحة للإضافة",variant:"destructive"});return}Lt("تأكيد إضافة قطع","لا يمكن إضافة قطع إلا بإدخال الرقم السري الرئيسي",async()=>{try{const N=m.quantity+F;await Ls($e(J,"products",m.id),{quantity:N,updatedAt:Ye()}),Y(k=>k.map(K=>K.id===m.id?{...K,quantity:N}:K)),ne(k=>({...k,[m.id]:""})),P({title:"تمت الإضافة",description:`تمت إضافة ${F} قطعة إلى ${m.name}`})}catch(N){console.error("Error adding pieces:",N),P({title:"فشل الإضافة",description:"تعذّر إضافة الكمية إلى المخزون",variant:"destructive"})}})},ks=async m=>{if(!(f!=null&&f.uid))return;if(T){P({title:"غير مسموح في وضع الكاشير",description:"لا يمكن حذف المنتجات أثناء الورديه",variant:"destructive"});return}window.confirm(`هل تريد حذف المنتج "${m.name}"؟`)&&Lt("تأكيد حذف منتج","لا يمكن حذف المنتجات إلا بإدخال الرقم السري الرئيسي",async()=>{try{await ws($e(J,"products",m.id)),Y(F=>F.filter(N=>N.id!==m.id)),P({title:"تم الحذف",description:`تم حذف المنتج ${m.name}`})}catch(F){console.error("Error deleting product:",F),P({title:"فشل الحذف",description:"تعذّر حذف المنتج",variant:"destructive"})}})},Ta=async()=>{try{if(!(f!=null&&f.uid)){P({title:"خطأ",description:"غير مسجّل دخول",variant:"destructive"});return}if(T){P({title:"غير مسموح في وضع الكاشير",description:"لا يمكن إضافة منتجات أثناء الورديه",variant:"destructive"});return}const m=D.productName.trim(),E=parseFloat(D.price),F=parseFloat(D.wholesalePrice||"0"),N=parseInt(D.quantity);if(!m||isNaN(E)||isNaN(N)){P({title:"بيانات غير مكتملة",description:"أدخل اسم المنتج والسعر والكمية",variant:"destructive"});return}const k={name:m,sellingPrice:E,wholesalePrice:isNaN(F)?0:F,quantity:isNaN(N)?0:N,userId:f.uid,createdAt:Ye(),updatedAt:Ye()},K=(D.barcode||"").trim();K&&(k.barcode=K);const te=(D.serialNumber||"").trim();te&&(k.serialNumber=te),w!=null&&w.shopId&&(k.shopId=w.shopId);const pe=await Ts(_e(J,"products"),k);Y(le=>[{id:pe.id,name:m,sellingPrice:E,wholesalePrice:isNaN(F)?0:F,quantity:isNaN(N)?0:N,barcode:(D.barcode||"").trim()||"",serialNumber:(D.serialNumber||"").trim()||""},...le]),s({productName:"",price:"",wholesalePrice:"",quantity:"",barcode:"",serialNumber:""}),P({title:"تمت الإضافة",description:`تم إضافة المنتج ${m} بنجاح`})}catch(m){console.error("createProduct error",m),P({title:"فشل الإضافة",description:"تعذّر إضافة المنتج. حاول مجددًا",variant:"destructive"})}},ls=async m=>{const E=(m||"").trim();if(!E)return;const F=q.find(N=>(N.barcode||"")===E);if(!F){P({title:"باركود غير معروف",description:"لم يتم العثور على منتج بهذا الباركود"});return}await Ia(F)},qa=()=>{const m=Object.entries(je).map(([le,Ie])=>{const ve=Number(Ie),oe=q.find(Qt=>Qt.id===le);return!oe||!ve||ve<=0?null:{name:oe.name,qty:ve,price:oe.sellingPrice,total:ve*oe.sellingPrice}}).filter(Boolean);if(m.length===0){P({title:"لم يتم اختيار منتجات",description:"فعّل وضع الفاتورة واختر منتجات وكميات للطباعة"});return}const E=(w==null?void 0:w.shopName)||(f==null?void 0:f.displayName)||"المحل",F=(w==null?void 0:w.phone)||(f==null?void 0:f.phoneNumber)||"",N=m.reduce((le,Ie)=>le+Ie.total,0),k=new Date().toLocaleString("ar-EG"),K=m.map(le=>`
        <tr>
          <td style="border:1px solid #ddd;padding:6px">${le.name}</td>
          <td style="border:1px solid #ddd;padding:6px;text-align:center">${le.qty}</td>
          <td style="border:1px solid #ddd;padding:6px;text-align:center">${Ut(le.price)}</td>
          <td style="border:1px solid #ddd;padding:6px;text-align:center;font-weight:bold;color:#0a7">${Ut(le.total)}</td>
        </tr>
      `).join(""),te=`
      <html>
        <head>
          <meta charset="utf-8" />
          <title>فاتورة</title>
          <style>
            body { font-family: Tahoma, Arial, sans-serif; direction: rtl; }
            .header { text-align: center; margin-bottom: 12px; }
            .header h2 { margin: 0; }
            .meta { text-align: center; color: #555; margin-bottom: 8px; }
            table { width: 100%; border-collapse: collapse; }
            .total { text-align: left; font-weight: bold; margin-top: 10px; }
          </style>
        </head>
        <body>
          <div class="header">
            <h2>${E}</h2>
            ${F?`<div class="meta">رقم التليفون: ${F}</div>`:""}
            <div class="meta">التاريخ: ${k}</div>
          </div>
          <table>
            <thead>
              <tr>
                <th style="border:1px solid #ddd;padding:6px">المنتج</th>
                <th style="border:1px solid #ddd;padding:6px">الكمية</th>
                <th style="border:1px solid #ddd;padding:6px">السعر</th>
                <th style="border:1px solid #ddd;padding:6px">الإجمالي</th>
              </tr>
            </thead>
            <tbody>
              ${K}
            </tbody>
          </table>
          <div class="total">الإجمالي الكلي: ${Ut(N)}</div>
        </body>
      </html>
    `,pe=window.open("","_blank");pe&&(pe.document.write(te),pe.document.close(),pe.focus(),pe.print(),pe.close())};return e.jsxs(ce,{open:i,onOpenChange:u,children:[e.jsxs(de,{className:"max-w-none w-[100vw] md:w-[100vw] lg:w-[100vw] max-h-[85vh] md:h-[100dvh] md:max-h-[100dvh] p-0 overflow-y-auto",children:[e.jsx(me,{className:"px-3 md:px-6 py-3 md:py-4 border-b bg-gradient-to-r from-blue-50 to-purple-50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 md:gap-3",children:[e.jsx("div",{className:"p-1.5 md:p-2 bg-blue-100 rounded-lg",children:e.jsx(xn,{className:"h-5 w-5 md:h-6 md:w-6 text-blue-600"})}),e.jsxs("div",{children:[e.jsx(he,{className:"text-lg md:text-xl font-bold text-gray-800",children:"📊 بيانات المبيعات اليومية"}),e.jsxs("p",{className:"text-xs md:text-sm text-gray-600 mt-1 hidden sm:block",children:["إدارة وتتبع مبيعات اليوم - ",new Date().toLocaleDateString("ar-EG")]})]})]}),e.jsxs("div",{className:"flex items-center gap-1 md:gap-2",children:[e.jsx(h,{variant:"outline",size:"sm",onClick:()=>Ns(),className:"text-xs md:text-sm",children:"استرجاع الإيصالات"}),e.jsx(h,{variant:"ghost",size:"sm",onClick:u,className:"h-8 w-8 md:h-9 md:w-9",children:e.jsx(vo,{className:"h-4 w-4"})})]})]})}),e.jsxs("div",{className:"flex flex-col md:flex-row h-full",dir:"rtl",children:[e.jsxs("div",{className:"w-full md:w-72 lg:w-80 bg-white/50 border-r",children:[e.jsxs("div",{className:"p-3 md:p-4 border-b bg-white/30",children:[e.jsxs("h3",{className:"font-semibold text-gray-800 mb-3 flex items-center gap-2 text-sm md:text-base",children:[e.jsx(Pt,{className:"h-4 w-4 text-green-600"}),"ملخص المبيعات"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 md:gap-3",children:[e.jsxs("div",{className:"bg-blue-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-blue-600",children:Ut(p.reduce((m,E)=>m+E.price*E.quantity,0))}),e.jsx("div",{className:"text-xs md:text-sm text-blue-600",children:"إجمالي المبيعات"})]}),e.jsxs("div",{className:"relative bg-green-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsxs("div",{className:G?"filter blur-sm pointer-events-none":"",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-green-600",children:Ut(p.reduce((m,E)=>m+(E.price-(E.wholesalePrice??0))*E.quantity,0))}),e.jsx("div",{className:"text-xs md:text-sm text-green-600",children:"إجمالي الأرباح"})]}),G&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>Z(!0),className:"bg-white/80 hover:bg-white text-green-700 border border-green-200",children:"عرض الأرباح"})})]}),e.jsxs("div",{className:"bg-yellow-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-yellow-600",children:Ba(q.length)}),e.jsx("div",{className:"text-xs md:text-sm text-yellow-600",children:"عدد المنتجات"})]}),e.jsxs("div",{className:"bg-purple-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-purple-600",children:Ba(p.length)}),e.jsx("div",{className:"text-xs md:text-sm text-purple-600",children:"عدد المبيعات"})]})]}),e.jsxs("div",{className:"relative mb-2",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-1 md:gap-2 text-xs md:text-sm font-semibold text-indigo-700",children:[e.jsx(ma,{className:"h-3 w-3 md:h-4 md:w-4"}),e.jsx(xn,{className:"h-3 w-3 md:h-4 md:w-4"}),e.jsx("span",{children:"تقارير الشهر"})]}),e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>ms(m=>!m),className:"h-6 w-6 p-0 rounded-full",title:st?"إظهار التقارير":"إخفاء التقارير",children:st?e.jsx(wr,{className:"h-4 w-4"}):e.jsx(mn,{className:"h-4 w-4"})})]}),e.jsx("div",{className:st?"overflow-hidden max-h-0 transition-[max-height] duration-300":"overflow-hidden transition-[max-height] duration-300 max-h-[400px]",children:e.jsxs("div",{className:Dt?"grid grid-cols-2 gap-2 md:gap-4 filter blur-sm pointer-events-none":"grid grid-cols-2 gap-2 md:gap-4",children:[e.jsxs("div",{className:"bg-indigo-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-indigo-600",children:Ut(mt)}),e.jsx("div",{className:"text-xs md:text-sm text-indigo-600",children:"مبيعات الشهر"})]}),e.jsxs("div",{className:"bg-pink-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-pink-600",children:Ut(St)}),e.jsx("div",{className:"text-xs md:text-sm text-pink-600",children:"أرباح الشهر"})]})]})}),!st&&Dt&&e.jsx("div",{className:"absolute left-0 right-0 top-7 md:top-10 bottom-0 flex items-center justify-center rounded-lg bg-yellow-100/60",children:e.jsxs(h,{size:"sm",variant:"ghost",onClick:async()=>{try{if(await isZeroPlan()){P({title:"الخطة زيرو",description:"التقارير الشهرية غير متاحة في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}catch{}ht(!0)},className:"flex items-center gap-2 bg-yellow-200/70 hover:bg-yellow-300 text-yellow-900 px-3 py-2 rounded-xl shadow-md hover:shadow-lg transition-all btn-monthly-reports",title:"عرض تقارير الشهر",children:[e.jsx(jt,{className:"h-5 w-5 md:h-7 md:w-7"}),e.jsx("span",{className:"text-xs md:text-sm",children:"عرض تقارير الشهر"})]})})]})]}),e.jsxs("div",{className:"p-3 md:p-4 border-b bg-white/30",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("h3",{className:"font-semibold text-gray-800 flex items-center gap-2 text-sm md:text-base",children:[e.jsx(yr,{className:"h-4 w-4 text-indigo-600"}),"إحصائيات المنتجات"]}),e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>Wt(m=>!m),className:"h-6 w-6 p-0 rounded-full",title:_t?"إظهار القسم":"إخفاء القسم",children:_t?e.jsx(wr,{className:"h-4 w-4"}):e.jsx(mn,{className:"h-4 w-4"})})]}),e.jsx("div",{className:_t?"overflow-hidden max-h-0 transition-[max-height] duration-300":"overflow-hidden transition-[max-height] duration-300 max-h-[400px]"})]}),e.jsxs("div",{className:"p-3 md:p-4 flex-1 hidden md:block",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("h3",{className:"font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(Ti,{className:"h-4 w-4 text-blue-600"}),"نصائح للمبيعات"]}),e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>ye(m=>!m),className:"h-6 w-6 p-0 rounded-full",title:L?"إظهار القسم":"إخفاء القسم",children:L?e.jsx(wr,{className:"h-4 w-4"}):e.jsx(mn,{className:"h-4 w-4"})})]}),e.jsx("div",{className:L?"overflow-hidden max-h-0 transition-[max-height] duration-300":"overflow-hidden transition-[max-height] duration-300 max-h-[400px]"})]})]}),e.jsx("div",{className:"flex-1 overflow-y-visible transition-all duration-300 ease-in-out",children:e.jsxs("div",{className:"p-3 md:p-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 md:mb-6 gap-2",children:[e.jsxs("h2",{className:"text-base md:text-lg font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(zm,{className:"h-4 w-4 md:h-5 md:w-5 text-blue-600"}),"سجل المبيعات (",p.length," عنصر)"]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs md:text-sm text-gray-600",children:[e.jsx(ma,{className:"h-3 w-3 md:h-4 md:w-4"}),e.jsx("span",{className:"hidden sm:inline",children:new Date().toLocaleDateString("ar-EG")}),e.jsx(Zs,{className:"h-3 w-3 md:h-4 md:w-4 ml-2"}),e.jsx("span",{children:new Date().toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit"})})]})]}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-3 md:p-4 mb-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("h3",{className:"text-sm md:text-base font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(as,{className:"h-4 w-4 text-emerald-600"}),"إضافة منتج جديد"]}),e.jsxs(h,{size:"sm",variant:"ghost",className:"h-8",onClick:()=>{if(T){P({title:"غير مسموح في وضع الكاشير",description:"لا يمكن إضافة منتج أثناء الورديه",variant:"destructive"});return}Lt("فتح نموذج إضافة منتج","أدخل الرقم السري الرئيسي لفتح نموذج الإضافة",()=>M(!0))},children:[e.jsx(as,{className:"h-4 w-4 text-emerald-600"}),"إضافة منتج"]})]}),I&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx(H,{htmlFor:"new-product-name",className:"text-xs md:text-sm",children:"اسم المنتج"}),e.jsx(U,{id:"new-product-name",value:D.productName,onChange:m=>s(E=>({...E,productName:m.target.value})),placeholder:"أدخل اسم المنتج"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx(H,{htmlFor:"new-product-price",className:"text-xs md:text-sm",children:"سعر البيع (ج.م)"}),e.jsx(U,{type:"number",id:"new-product-price",value:D.price,onChange:m=>s(E=>({...E,price:m.target.value})),placeholder:"0.00"})]}),e.jsxs("div",{children:[e.jsx(H,{htmlFor:"new-product-wholesale",className:"text-xs md:text-sm",children:"سعر الجملة (ج.م)"}),e.jsx(U,{type:"number",id:"new-product-wholesale",value:D.wholesalePrice||"",onChange:m=>s(E=>({...E,wholesalePrice:m.target.value})),placeholder:"0.00"})]})]}),e.jsxs("div",{children:[e.jsx(H,{htmlFor:"new-product-qty",className:"text-xs md:text-sm",children:"الكمية"}),e.jsx(U,{type:"number",id:"new-product-qty",value:D.quantity,onChange:m=>s(E=>({...E,quantity:m.target.value})),placeholder:"1"})]}),e.jsxs("div",{children:[e.jsx(H,{htmlFor:"new-product-barcode",className:"text-xs md:text-sm",children:"باركود المنتج (اختياري)"}),e.jsx(U,{id:"new-product-barcode",value:D.barcode||"",onChange:m=>s(E=>({...E,barcode:m.target.value})),placeholder:"أدخل/امسح الباركود"})]}),e.jsxs("div",{children:[e.jsx(H,{htmlFor:"new-product-serial",className:"text-xs md:text-sm",children:"سيريال الجهاز (اختياري)"}),e.jsx(U,{id:"new-product-serial",value:D.serialNumber||"",onChange:m=>s(E=>({...E,serialNumber:m.target.value})),placeholder:"أدخل سيريال الجهاز"})]}),e.jsx(h,{className:"h-9 w-full md:w-auto bg-indigo-600 hover:bg-indigo-700 text-white",onClick:Ta,children:"إضافة المنتج"})]})]}),e.jsx("div",{id:"shop-products-section",className:"bg-white rounded-lg border border-gray-200 overflow-hidden mb-4",children:e.jsxs("div",{className:"mb-4",children:[e.jsxs("h3",{className:"text-sm md:text-base font-semibold text-gray-800 mb-2 flex items-center gap-2",children:[e.jsx(yr,{className:"h-4 w-4 text-green-600"}),"منتجات المحل"]}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(h,{variant:Se?"default":"outline",size:"sm",onClick:()=>Ae(m=>!m),children:Se?"وضع الفاتورة: مفعل":"تفعيل وضع الفاتورة"}),e.jsx(h,{size:"sm",className:"bg-indigo-600 hover:bg-indigo-700 text-white",disabled:Object.keys(je).filter(m=>(je[m]||0)>0).length===0,onClick:qa,children:"طباعة فاتورة"})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(U,{value:It,onChange:m=>R(m.target.value),placeholder:"ابحث عن منتج...",className:"h-9 w-full md:w-72 text-sm","aria-label":"البحث عن منتج من منتجات المحل"}),e.jsx(U,{value:re,onChange:m=>X(m.target.value),onKeyDown:async m=>{if(m.key!=="Enter")return;const E=re.trim();E&&(await ls(E),X(""))},placeholder:"مرّر ماسح الباركود هنا (اختياري)",className:"h-9 w-full md:w-64 text-sm","aria-label":"مسح الباركود لإضافة المنتج تلقائياً"}),It&&e.jsx(h,{variant:"ghost",size:"sm",className:"h-9",onClick:()=>R(""),children:"مسح"})]}),e.jsx("div",{className:"overflow-x-auto border border-gray-200 rounded-lg hidden md:block",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"المنتج"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"سعر البيع"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("span",{children:"سعر الجملة"}),e.jsx(h,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>Qe(m=>!m),"aria-label":Me?"إخفاء سعر الجملة":"إظهار سعر الجملة",children:Me?e.jsx(es,{className:"h-4 w-4"}):e.jsx(jt,{className:"h-4 w-4"})})]})}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"المتاح"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"بيع"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:we.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"px-3 py-3 text-center text-gray-500",children:q.length===0?"لا توجد منتجات بعد، أضف منتجاً من النموذج أعلاه":"لا توجد نتائج مطابقة للبحث"})}):we.map(m=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-3 py-2 font-medium text-gray-900",children:m.name}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:Ut(m.sellingPrice)}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:e.jsx("span",{className:Me?"":"blur-sm select-none",children:Ut(m.wholesalePrice)})}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:Ba(m.quantity)}),e.jsx("td",{className:"px-3 py-2",children:e.jsxs("div",{className:"flex items-center gap-2 flex-nowrap",children:[e.jsx(U,{value:ae[m.id]||"",onChange:E=>_(F=>({...F,[m.id]:E.target.value})),type:"number",placeholder:"عدد القطع للبيع",className:"h-8 w-28 text-sm"}),e.jsx(U,{value:Oe[m.id]||"",onChange:E=>at(F=>({...F,[m.id]:E.target.value})),type:"number",placeholder:"سعر بيع اختياري",className:"h-8 w-32 text-sm","aria-label":`سعر بيع اختياري لـ ${m.name}`}),e.jsx(h,{size:"sm",className:"h-8 min-w-[64px] bg-indigo-600 hover:bg-indigo-700 text-white",onClick:()=>zs(m),children:"بيع"}),Se&&e.jsx(U,{value:je[m.id]??"",onChange:E=>{const F=parseInt(E.target.value||"0");We(N=>({...N,[m.id]:isNaN(F)?0:F}))},type:"number",placeholder:"كمية للفاتورة",className:"h-8 w-24 text-sm"}),e.jsx(U,{value:W[m.id]||"",onChange:E=>ne(F=>({...F,[m.id]:E.target.value})),type:"number",placeholder:"عدد للإضافة",className:"h-8 w-28 text-sm",disabled:T}),e.jsxs("div",{className:"inline-flex items-center gap-2 flex-nowrap",children:[e.jsx(h,{size:"sm",variant:"outline",className:"h-8 whitespace-nowrap",onClick:()=>Aa(m),disabled:T,title:T?"غير مسموح في وضع الكاشير":void 0,children:"إضافة قطع جديدة"}),e.jsx(h,{size:"sm",variant:"destructive",className:"h-8",onClick:()=>ks(m),title:"حذف المنتج",disabled:T,children:e.jsx(Yt,{className:"h-4 w-4"})})]})]})})]},m.id))})]})}),e.jsx("div",{className:"block md:hidden space-y-3",children:we.length===0?e.jsx("div",{className:"text-center text-gray-500 text-sm",children:q.length===0?"لا توجد منتجات بعد، أضف منتجاً من النموذج أعلاه":"لا توجد نتائج مطابقة للبحث"}):we.map(m=>e.jsxs("div",{className:"bg-white rounded-xl p-3 border border-gray-200 shadow-sm",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"font-semibold text-gray-900 text-sm break-words",children:m.name}),e.jsx(h,{size:"sm",variant:"destructive",className:"h-8 min-w-[44px] touch-manipulation",onClick:()=>ks(m),title:"حذف المنتج",disabled:T,children:e.jsx(Yt,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-2 text-xs text-gray-700",children:[e.jsx("div",{className:"text-gray-600",children:"سعر البيع"}),e.jsx("div",{className:"text-right font-medium",children:Ut(m.sellingPrice)}),e.jsxs("div",{className:"text-gray-600 inline-flex items-center gap-1",children:[e.jsx("span",{children:"سعر الجملة"}),e.jsx(h,{variant:"ghost",size:"icon",className:"h-5 w-5",onClick:()=>Qe(E=>!E),"aria-label":Me?"إخفاء سعر الجملة":"إظهار سعر الجملة",children:Me?e.jsx(es,{className:"h-4 w-4"}):e.jsx(jt,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"text-right font-medium",children:e.jsx("span",{className:Me?"":"blur-sm select-none",children:Ut(m.wholesalePrice)})}),e.jsx("div",{className:"text-gray-600",children:"المتاح"}),e.jsx("div",{className:"text-right font-medium",children:Ba(m.quantity)})]}),e.jsxs("div",{className:"mt-3 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(U,{value:ae[m.id]||"",onChange:E=>_(F=>({...F,[m.id]:E.target.value})),type:"number",placeholder:"عدد القطع للبيع",className:"h-9 flex-1 text-sm","aria-label":`عدد القطع للبيع لـ ${m.name}`}),e.jsx(U,{value:Oe[m.id]||"",onChange:E=>at(F=>({...F,[m.id]:E.target.value})),type:"number",placeholder:"سعر بيع اختياري",className:"h-9 w-28 text-sm","aria-label":`سعر بيع اختياري لـ ${m.name}`}),e.jsx(h,{size:"sm",className:"h-9 min-w-[64px] bg-indigo-600 hover:bg-indigo-700 text-white",onClick:()=>zs(m),children:"بيع"})]}),Se&&e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(U,{value:je[m.id]??"",onChange:E=>{const F=parseInt(E.target.value||"0");We(N=>({...N,[m.id]:isNaN(F)?0:F}))},type:"number",placeholder:"كمية للفاتورة",className:"h-9 flex-1 text-sm","aria-label":`كمية للفاتورة لـ ${m.name}`})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(U,{value:W[m.id]||"",onChange:E=>ne(F=>({...F,[m.id]:E.target.value})),type:"number",placeholder:"عدد للإضافة",className:"h-9 flex-1 text-sm","aria-label":`عدد القطع للإضافة لـ ${m.name}`,disabled:T}),e.jsx(h,{size:"sm",variant:"outline",className:"h-9 min-w-[64px]",onClick:()=>Aa(m),disabled:T,title:T?"غير مسموح في وضع الكاشير":void 0,children:"إضافة"})]})]})]},m.id))})]})}),p.length===0?e.jsxs("div",{className:"text-center py-8 md:py-12",children:[e.jsx("div",{className:"w-16 h-16 md:w-24 md:h-24 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center",children:e.jsx(yr,{className:"h-8 w-8 md:h-12 md:w-12 text-gray-400"})}),e.jsx("h3",{className:"text-base md:text-lg font-medium text-gray-900 mb-2",children:"لا توجد مبيعات اليوم"}),e.jsx("p",{className:"text-sm text-gray-500",children:"ابدأ ببيع منتج من القائمة أعلاه"})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"block md:hidden",children:e.jsx("div",{className:"max-h-[70vh] overflow-y-auto space-y-3 p-3",children:p.map(m=>e.jsxs("div",{className:"bg-white rounded-xl p-4 border border-gray-200 shadow-sm",children:[e.jsx("div",{className:"mb-3",children:e.jsx("h4",{className:"font-semibold text-gray-900 text-base break-words",children:m.productName})}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-2 text-sm text-gray-700",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Pt,{className:"h-4 w-4 text-blue-600"}),e.jsx("span",{className:"text-gray-600",children:"سعر البيع"})]}),e.jsx("div",{className:"text-right font-medium",children:Ut(m.price)}),typeof m.wholesalePrice=="number"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Pt,{className:"h-4 w-4 text-indigo-600"}),e.jsxs("span",{className:"text-gray-600 inline-flex items-center gap-1",children:["سعر الجملة",e.jsx(h,{variant:"ghost",size:"icon",className:"h-5 w-5",onClick:()=>Qe(E=>!E),"aria-label":Me?"إخفاء سعر الجملة":"إظهار سعر الجملة",children:Me?e.jsx(es,{className:"h-4 w-4"}):e.jsx(jt,{className:"h-4 w-4"})})]})]}),e.jsx("div",{className:"text-right font-medium",children:e.jsx("span",{className:Me?"":"blur-sm select-none",children:Ut(m.wholesalePrice)})})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(yr,{className:"h-4 w-4 text-emerald-600"}),e.jsx("span",{className:"text-gray-600",children:"الكمية"})]}),e.jsx("div",{className:"text-right font-medium",children:Ba(m.quantity)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(vr,{className:"h-4 w-4 text-purple-600"}),e.jsx("span",{className:"text-gray-600",children:"الربح"})]}),e.jsx("div",{className:"text-right font-semibold text-purple-700",children:Ut(((m.price??0)-(m.wholesalePrice??0))*(m.quantity??0))}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Pt,{className:"h-4 w-4 text-green-600"}),e.jsx("span",{className:"text-gray-600",children:"الإجمالي"})]}),e.jsx("div",{className:"text-right font-bold text-green-700",children:Ut(m.price*m.quantity)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Um,{className:"h-4 w-4 text-amber-600"}),e.jsx("span",{className:"text-gray-600",children:"المنفذ"})]}),e.jsx("div",{className:"text-right text-gray-700",children:m.performedByName??"-"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ma,{className:"h-4 w-4 text-blue-600"}),e.jsx("span",{className:"text-gray-600",children:"التاريخ"})]}),e.jsx("div",{className:"text-right text-gray-600",children:po(m.date)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Zs,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"text-gray-600",children:"الوقت"})]}),e.jsx("div",{className:"text-right text-gray-600",children:m.time})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-end gap-2",children:[e.jsx(h,{size:"sm",variant:"outline",onClick:()=>ua(m),disabled:T,title:T?"غير مسموح في وضع الكاشير":"مرتجع",className:"h-8 border-red-300 text-red-600 hover:bg-red-50",children:"مرتجع"}),e.jsxs(h,{size:"sm",variant:"destructive",onClick:()=>ua(m),disabled:T,title:T?"غير مسموح في وضع الكاشير":"حذف الإيصال",className:"h-8",children:[e.jsx(Yt,{className:"h-4 w-4"}),e.jsx("span",{className:"ml-1",children:"حذف الإيصال"})]})]})]},m.id))})}),e.jsx("div",{className:"hidden md:block overflow-x-auto max-h-96 overflow-y-auto scrollbar-thin scrollbar-thumb-green-300 scrollbar-track-green-100 hover:scrollbar-thumb-green-400",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"المنتج"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"سعر البيع (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("span",{children:"سعر الجملة (ج.م)"}),e.jsx(h,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>Qe(m=>!m),"aria-label":Me?"إخفاء سعر الجملة":"إظهار سعر الجملة",children:Me?e.jsx(es,{className:"h-4 w-4"}):e.jsx(jt,{className:"h-4 w-4"})})]})}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الكمية"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الإجمالي (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الربح (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"التاريخ"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الوقت"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"المنفذ"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"إجراءات"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:p.map((m,E)=>e.jsxs("tr",{className:E%2===0?"bg-white":"bg-gray-50/50",children:[e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-gray-900",children:m.productName}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:Ut(m.price)}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:typeof m.wholesalePrice=="number"?e.jsx("span",{className:Me?"":"blur-sm select-none",children:Ut(m.wholesalePrice)}):"-"}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:Ba(m.quantity)}),e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-green-600",children:Ut(m.price*m.quantity)}),e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-purple-600",children:Ut(((m.price??0)-(m.wholesalePrice??0))*(m.quantity??0))}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-500",children:po(m.date)}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-500",children:m.time}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:m.performedByName??"-"}),e.jsx("td",{className:"px-4 py-3 text-sm text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(h,{size:"sm",variant:"outline",onClick:()=>ua(m),disabled:T,title:T?"غير مسموح في وضع الكاشير":"مرتجع",className:"h-8 border-red-300 text-red-600 hover:bg-red-50",children:"مرتجع"}),e.jsx(h,{size:"sm",variant:"destructive",onClick:()=>ua(m),disabled:T,title:T?"غير مسموح في وضع الكاشير":"حذف الإيصال",className:"h-8",children:e.jsx(Yt,{className:"h-4 w-4"})})]})})]},m.id))})]})})]})]})})]})]}),e.jsx(rs,{open:fe,onOpenChange:Z,mode:"verify",title:"قفل إجمالي الأرباح",description:"أدخل الرقم السري الرئيسي لعرض إجمالي الأرباح",onSuccess:()=>{ue(!1),Z(!1)}}),e.jsx(rs,{open:Ct,onOpenChange:ht,mode:"verify",title:"قفل إحصائيات الشهر",description:"لا يمكن الاطلاع على تقارير الشهر إلا بإدخال الرقم السري الرئيسي",onSuccess:async()=>{try{const m=f==null?void 0:f.uid;if(m){const E=await ki(m),F=(E==null?void 0:E.planType)??(E==null?void 0:E.plan)??null,N=typeof F=="string"?F.toLowerCase():null;if(F===cs.ZERO||N==="zero"){P({title:"الخطة زيرو",description:"التقارير الشهرية غير متاحة في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}}catch{}be(!1),ht(!1),Gt()}}),e.jsx(rs,{open:kt,onOpenChange:pt,mode:"verify",title:gt,description:Ue,onSuccess:()=>{const m=it.current;it.current=null,pt(!1),m&&m()}})]})}const Ba=i=>new Intl.NumberFormat("ar-EG").format(Number(i||0)),Ut=i=>`${new Intl.NumberFormat("ar-EG",{minimumFractionDigits:2,maximumFractionDigits:2}).format(Number(i||0))} ج.م`,po=i=>{try{const u=new Date(i);return isNaN(u.getTime())?new Date(`${i}T00:00:00`).toLocaleDateString("ar-EG"):u.toLocaleDateString("ar-EG")}catch{return i}},lh=({open:i,onOpenChange:u,userId:c,cashBalance:p,walletBalances:v,transactions:D})=>{const[s,I]=Ve.useState(0),[M,S]=Ve.useState(0),[A,P]=Ve.useState(p||0),[f,w]=Ve.useState(!1),[T,V]=Ve.useState(null),{toast:O}=Ps(),{shopId:q}=vn()||{},[Y,ae]=Ve.useState(!1),[_,W]=Ve.useState(""),[ne,se]=Ve.useState(!1),[xe,re]=Ve.useState(!1),[X,Se]=Ve.useState(""),Ae=fe=>`${new Intl.NumberFormat("ar-EG").format(Number(fe||0))} جنيه`;Ve.useEffect(()=>{const fe=async()=>{try{if(!c){I(0);return}const Q=new Date,ze=Q.getFullYear(),mt=String(Q.getMonth()+1).padStart(2,"0"),Et=String(Q.getDate()).padStart(2,"0"),St=`${ze}-${mt}-${Et}`;let Le;try{const ht=et(_e(J,"dailySales"),Ce("userId","==",c),...q?[Ce("shopId","==",q)]:[],Ce("date","==",St));Le=await ct(ht)}catch{const ht=et(_e(J,"users",c,"dailySales"),...q?[Ce("shopId","==",q)]:[],Ce("date","==",St));Le=await ct(ht)}let Ct=0;Le.forEach(ht=>{const Dt=ht.data(),be=Number(Dt.sellingPrice??0),st=Number(Dt.quantity??0);be>0&&st>0&&(Ct+=be*st)}),I(Ct)}catch(Q){console.warn("فشل تحميل مبيعات الإكسسوار لليوم:",Q)}},Z=async()=>{try{if(!c){S(0);return}const Q=await De.getUserData(c),ze=new Date().toISOString().slice(0,10),mt=(Q==null?void 0:Q.dailyReceipts)||{};mt!=null&&mt.date&&String(mt.date).slice(0,10)===ze?S(Number(mt.accessory||0)):S(0),P(Number((Q==null?void 0:Q.cashBalance)||p||0))}catch{S(0)}};i&&(fe(),Z())},[i,c,D,p,q]);const je=Math.max(0,Number(s)-Number(M)),We=async fe=>{if(!c)return;const Z=new Date().toISOString().slice(0,10);try{const Q=je;if(Q<=0){O({title:"لا يوجد مبلغ لتأكيد استلامه",variant:"default"});return}const ze=Math.max(0,Number(A)-Q);P(ze),S(mt=>mt+Q),await De.updateUserData(c,{cashBalance:ze,dailyReceipts:{date:Z,accessory:M+Q}});try{localStorage.setItem(`cashBalance_${c}`,String(ze))}catch{}O({title:"تم الاستلام",description:`تم خصم ${Q.toFixed(2)} من الدرج وتصفير البند`})}catch{O({title:"خطأ",description:"تعذر تنفيذ عملية تم الاستلام",variant:"destructive"})}},Me=()=>{W(""),Se(""),ae(!0)},Qe=()=>{if(!_.trim()){O({title:"سبب الخصم مطلوب",variant:"destructive"});return}ae(!1),se(!0)},G=()=>{se(!1),re(!0)},ue=async()=>{try{if(!c)return;const fe=Math.max(0,Number(X||0));if(!Number.isFinite(fe)||fe<=0){O({title:"مبلغ غير صالح",description:"أدخل مبلغ خصم صحيح أكبر من الصفر",variant:"destructive"});return}const Z=Math.max(0,Number(A)-fe);P(Z),await De.updateUserData(c,{cashBalance:Z});try{localStorage.setItem(`cashBalance_${c}`,String(Z))}catch{}const Q={title:"ايصال خصم من الفلوس النقديه",type:"cash_deduction",amount:fe,status:"completed",createdAt:new Date,note:_,cashierName:"الحساب الرئيسي"};try{await De.saveUserTransaction(c,Q)}catch{}O({title:"تم الخصم",description:`تم خصم ${fe.toFixed(2)} من الدرج`}),re(!1),Se(""),W("")}catch{O({title:"فشل الخصم",description:"تعذر تنفيذ عملية الخصم",variant:"destructive"})}};return e.jsx(ce,{open:i,onOpenChange:u,children:e.jsxs(de,{className:"sm:max-w-lg animate-in fade-in-90 zoom-in-95 slide-in-from-top-4",dir:"rtl",children:[e.jsx(me,{children:e.jsxs(he,{className:"flex items-center gap-2 text-right",children:[e.jsx(Pt,{className:"h-5 w-5 text-emerald-600"}),"تفاصيل الفلوس النقدية"]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between bg-amber-50 border border-amber-200 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-amber-800 font-bold text-sm",children:[e.jsx(Pt,{className:"h-4 w-4"}),"مجموع الفلوس النقدية (الدرج)"]}),e.jsx("div",{className:"text-amber-700 font-extrabold text-sm",children:Ae(A)})]}),e.jsxs("div",{className:"flex items-center justify-between bg-blue-50 border border-blue-200 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-blue-800 font-bold text-sm",children:[e.jsx(yr,{className:"h-4 w-4"}),"فلوس الإكسسوار (اليوم)"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-blue-700 font-extrabold text-sm",children:Ae(je)}),e.jsx(h,{size:"sm",variant:"ghost",className:"h-6 px-2 rounded-lg bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800",onClick:()=>{V("accessory"),w(!0)},children:"تم الاستلام"})]})]}),e.jsxs("div",{className:"flex items-center justify-between bg-red-50 border border-red-200 rounded-lg p-2",children:[e.jsx("div",{className:"flex items-center gap-2 text-red-800 font-bold text-sm",children:"خصم فلوس من الفلوس النقديه"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(h,{size:"sm",variant:"ghost",className:"h-6 px-2 rounded-lg bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800",onClick:Me,children:"خصم"})})]})]}),e.jsx(rs,{open:f,onOpenChange:w,mode:"verify",title:"تأكيد الرقم السري لعملية تم الاستلام",description:"يرجى إدخال الرقم السري الرئيسي لتأكيد استلام المبلغ",onSuccess:()=>{T&&(We(),V(null)),w(!1)}}),e.jsx(ce,{open:Y,onOpenChange:ae,children:e.jsxs(de,{className:"sm:max-w-sm",children:[e.jsx(me,{children:e.jsx(he,{children:"سبب الخصم"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"deduct-reason",children:"اكتب سبب الخصم"}),e.jsx(U,{id:"deduct-reason",value:_,onChange:fe=>W(fe.target.value),placeholder:"سبب الخصم"})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-3",children:[e.jsx(h,{variant:"outline",onClick:()=>ae(!1),children:"إلغاء"}),e.jsx(h,{onClick:Qe,className:"bg-red-600 hover:bg-red-700",children:"متابعة"})]})]})}),e.jsx(rs,{open:ne,onOpenChange:se,mode:"verify",title:"تأكيد الرقم السري لعملية الخصم",description:"يرجى إدخال الرقم السري الرئيسي لمتابعة الخصم",onSuccess:G}),e.jsx(ce,{open:xe,onOpenChange:re,children:e.jsxs(de,{className:"sm:max-w-sm",children:[e.jsx(me,{children:e.jsx(he,{children:"مبلغ الخصم"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"deduct-amount",children:"أدخل مبلغ الخصم"}),e.jsx(U,{id:"deduct-amount",type:"number",value:X,onChange:fe=>Se(fe.target.value),placeholder:"0.00"})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-3",children:[e.jsx(h,{variant:"outline",onClick:()=>re(!1),children:"إلغاء"}),e.jsx(h,{onClick:ue,className:"bg-red-600 hover:bg-red-700",children:"تأكيد الخصم"})]})]})})]})})};function Eo({size:i=24,className:u,...c}){return e.jsxs("svg",{width:i,height:i,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",className:u,...c,children:[e.jsx("rect",{x:"5",y:"2.5",width:"14",height:"19",rx:"2.5",stroke:"currentColor",strokeWidth:"1.5"}),e.jsx("rect",{x:"7",y:"4.5",width:"10",height:"5.5",rx:"1",stroke:"currentColor",strokeWidth:"1.2"}),e.jsx("path",{d:"M9.5 11.5h5",stroke:"currentColor",strokeWidth:"1.4",strokeLinecap:"round"}),e.jsx("circle",{cx:"8.5",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"12",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"15.5",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"8.5",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"12",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"15.5",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("rect",{x:"8",y:"19",width:"9",height:"1.8",rx:"0.6",stroke:"currentColor",strokeWidth:"1"})]})}var _o="AlertDialog",[oh]=tm(_o,[So]),Xs=So(),Wo=i=>{const{__scopeAlertDialog:u,...c}=i,p=Xs(u);return e.jsx(um,{...p,...c,modal:!0})};Wo.displayName=_o;var ch="AlertDialogTrigger",dh=n.forwardRef((i,u)=>{const{__scopeAlertDialog:c,...p}=i,v=Xs(c);return e.jsx(bm,{...v,...p,ref:u})});dh.displayName=ch;var mh="AlertDialogPortal",Fo=i=>{const{__scopeAlertDialog:u,...c}=i,p=Xs(u);return e.jsx(xm,{...p,...c})};Fo.displayName=mh;var hh="AlertDialogOverlay",Mo=n.forwardRef((i,u)=>{const{__scopeAlertDialog:c,...p}=i,v=Xs(c);return e.jsx(vm,{...v,...p,ref:u})});Mo.displayName=hh;var za="AlertDialogContent",[uh,xh]=oh(za),ph=am("AlertDialogContent"),Lo=n.forwardRef((i,u)=>{const{__scopeAlertDialog:c,children:p,...v}=i,D=Xs(c),s=n.useRef(null),I=wo(u,s),M=n.useRef(null);return e.jsx(pm,{contentName:za,titleName:Ro,docsSlug:"alert-dialog",children:e.jsx(uh,{scope:c,cancelRef:M,children:e.jsxs(gm,{role:"alertdialog",...D,...v,ref:I,onOpenAutoFocus:sm(v.onOpenAutoFocus,S=>{var A;S.preventDefault(),(A=M.current)==null||A.focus({preventScroll:!0})}),onPointerDownOutside:S=>S.preventDefault(),onInteractOutside:S=>S.preventDefault(),children:[e.jsx(ph,{children:p}),e.jsx(fh,{contentRef:s})]})})})});Lo.displayName=za;var Ro="AlertDialogTitle",Bo=n.forwardRef((i,u)=>{const{__scopeAlertDialog:c,...p}=i,v=Xs(c);return e.jsx(fm,{...v,...p,ref:u})});Bo.displayName=Ro;var $o="AlertDialogDescription",Uo=n.forwardRef((i,u)=>{const{__scopeAlertDialog:c,...p}=i,v=Xs(c);return e.jsx(ym,{...v,...p,ref:u})});Uo.displayName=$o;var gh="AlertDialogAction",zo=n.forwardRef((i,u)=>{const{__scopeAlertDialog:c,...p}=i,v=Xs(c);return e.jsx(Do,{...v,...p,ref:u})});zo.displayName=gh;var qo="AlertDialogCancel",Vo=n.forwardRef((i,u)=>{const{__scopeAlertDialog:c,...p}=i,{cancelRef:v}=xh(qo,c),D=Xs(c),s=wo(u,v);return e.jsx(Do,{...D,...p,ref:s})});Vo.displayName=qo;var fh=({contentRef:i})=>{const u=`\`${za}\` requires a description for the component to be accessible for screen reader users.

You can add a description to the \`${za}\` by passing a \`${$o}\` component as a child, which also benefits sighted users by adding visible context to the dialog.

Alternatively, you can use your own component as a description by assigning it an \`id\` and passing the same value to the \`aria-describedby\` prop in \`${za}\`. If the description is confusing or duplicative for sighted users, you can use the \`@radix-ui/react-visually-hidden\` primitive as a wrapper around your description component.

For more information, see https://radix-ui.com/primitives/docs/components/alert-dialog`;return n.useEffect(()=>{var p;document.getElementById((p=i.current)==null?void 0:p.getAttribute("aria-describedby"))||console.warn(u)},[u,i]),null},yh=Wo,vh=Fo,Jo=Mo,Ko=Lo,Yo=zo,Ho=Vo,Go=Bo,Qo=Uo;const bh=yh,wh=vh,Zo=n.forwardRef(({className:i,...u},c)=>e.jsx(Jo,{className:Da("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",i),...u,ref:c}));Zo.displayName=Jo.displayName;const Xo=n.forwardRef(({className:i,...u},c)=>e.jsxs(wh,{children:[e.jsx(Zo,{}),e.jsx(Ko,{ref:c,className:Da("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",i),...u})]}));Xo.displayName=Ko.displayName;const ec=({className:i,...u})=>e.jsx("div",{className:Da("flex flex-col space-y-2 text-center sm:text-left",i),...u});ec.displayName="AlertDialogHeader";const tc=n.forwardRef(({className:i,...u},c)=>e.jsx(Go,{ref:c,className:Da("text-lg font-semibold",i),...u}));tc.displayName=Go.displayName;const sc=n.forwardRef(({className:i,...u},c)=>e.jsx(Qo,{ref:c,className:Da("text-sm text-muted-foreground",i),...u}));sc.displayName=Qo.displayName;const Pi=n.forwardRef(({className:i,...u},c)=>e.jsx(Yo,{ref:c,className:Da(No(),i),...u}));Pi.displayName=Yo.displayName;const ac=n.forwardRef(({className:i,...u},c)=>e.jsx(Ho,{ref:c,className:Da(No({variant:"outline"}),"mt-2 sm:mt-0",i),...u}));ac.displayName=Ho.displayName;const ut=i=>{try{return i.toLocaleString("en-US",{maximumFractionDigits:2})}catch{return String(i)}},go=i=>{try{return(i?new Date(i):new Date).toLocaleString("en-GB",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}catch{return new Date().toISOString()}},ra="machine_daily_opening_values",Na="machine_daily_opening_snapshot";function Nh({open:i,onOpenChange:u}){const{toast:c}=Ps(),{shiftUser:p}=Sr(),{shopId:v,shopName:D}=vn();n.useEffect(()=>{try{if(i){const R=document.body.style.overflow;document.body.setAttribute("data-prev-overflow",R),document.body.style.overflow="hidden"}else{const R=document.body.getAttribute("data-prev-overflow")||"";document.body.style.overflow=R,document.body.removeAttribute("data-prev-overflow")}}catch{}return()=>{try{const R=document.body.getAttribute("data-prev-overflow")||"";document.body.style.overflow=R,document.body.removeAttribute("data-prev-overflow")}catch{}}},[i]);const[s,I]=n.useState(""),[M,S]=n.useState(""),[A,P]=n.useState(""),[f,w]=n.useState(null),[T,V]=n.useState(null),[O,q]=n.useState(null),[Y,ae]=n.useState(null),[_,W]=n.useState(!1),[ne,se]=n.useState(!1),[xe,re]=n.useState(""),[X,Se]=n.useState(""),[Ae,je]=n.useState(null),[We,Me]=n.useState([]),[Qe,G]=n.useState([]),[ue,fe]=n.useState(!1),[Z,Q]=n.useState(""),[ze,mt]=n.useState(""),[Et,St]=n.useState(!1),[Le,Ct]=n.useState(null),[ht,Dt]=n.useState([]),[be,st]=n.useState(null),[ms,_t]=n.useState("");n.useEffect(()=>{if(i)try{const R=be?`${ra}_${be}`:ra,we=be?`${Na}_${be}`:Na,Pe=localStorage.getItem(R);if(Pe){const Ee=JSON.parse(Pe);typeof(Ee==null?void 0:Ee.openingBase)=="number"&&w(Ee.openingBase),typeof(Ee==null?void 0:Ee.openingAir)=="number"&&V(Ee.openingAir),typeof(Ee==null?void 0:Ee.drawerCash)=="number"&&q(Ee.drawerCash)}else w(null),V(null),q(null);const Ke=localStorage.getItem(we);if(Ke){const Ee=JSON.parse(Ke);typeof(Ee==null?void 0:Ee.openingBase)=="number"&&typeof(Ee==null?void 0:Ee.openingAir)=="number"?ae({openingBase:Ee.openingBase,openingAir:Ee.openingAir,drawerCash:Ee.drawerCash||0}):ae(null)}else ae(null)}catch{}},[i,be]),n.useEffect(()=>{(async()=>{try{if(!i||!v)return;const{getDocs:R,query:we}=await dt(async()=>{const{getDocs:Rt,query:Ze}=await import("./index-BaJ4CYlQ.js").then(zt=>zt.bg);return{getDocs:Rt,query:Ze}},__vite__mapDeps([0,1]),import.meta.url),Pe=_e(J,"shops",v,"machines"),Ee=(await R(we(Pe))).docs.map(Rt=>({id:Rt.id,name:String(Rt.data().name||"ماكينة")}));Dt(Ee),!be&&Ee.length>0&&st(Ee[0].id)}catch(R){console.error("Load machines error:",R)}})()},[i,v]);const Wt=n.useMemo(()=>(p==null?void 0:p.displayName)||(p==null?void 0:p.name)||(p==null?void 0:p.username)||void 0,[p]),L=n.useMemo(()=>Qe.reduce((R,we)=>R+(we.profit||0),0),[Qe]),ye=n.useMemo(()=>Qe.reduce((R,we)=>R+(we.wholesalePrice||0),0),[Qe]),Oe=()=>{Qe.length!==0&&(G([]),c({title:"تم حذف الإيصالات",description:"تم مسح كل إيصالات التحويل."}))},at=()=>{We.length!==0&&(Me([]),c({title:"تم حذف الإيصالات",description:"تم مسح كل إيصالات الماكينة."}))},kt=R=>{Me(we=>we.filter(Pe=>Pe.id!==R)),c({title:"تم حذف الإيصال",description:"تم إزالة إيصال الماكينة المحدد."})},pt=()=>{w(null),V(null),q(null),ae(null),I(""),S(""),P("");try{const R=be?`${ra}_${be}`:ra,we=be?`${Na}_${be}`:Na;localStorage.removeItem(R),localStorage.removeItem(we)}catch{}c({title:"تم التصفير",description:"يمكنك الآن إدخال رصيد افتتاحي جديد."})},gt=async()=>{var Ke;const R=parseFloat(s||"0"),we=parseFloat(M||"0"),Pe=parseFloat(A||"0");if(isNaN(R)||isNaN(we)||isNaN(Pe)){c({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة للرصيد الافتتاحي وفلوس الدرج.",variant:"destructive"});return}if(R<0||we<0||Pe<0){c({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}w(R),V(we),q(Pe);try{const Ee=be?`${ra}_${be}`:ra,Rt=be?`${Na}_${be}`:Na;if(localStorage.setItem(Ee,JSON.stringify({openingBase:R,openingAir:we,drawerCash:Pe})),localStorage.setItem(Rt,JSON.stringify({openingBase:R,openingAir:we,drawerCash:Pe})),ae({openingBase:R,openingAir:we,drawerCash:Pe}),v&&be){const Ze=$e(J,"shops",v,"machines",be);await Is(Ze,{name:((Ke=ht.find(zt=>zt.id===be))==null?void 0:Ke.name)||"ماكينة",openingBase:R,openingAir:we,drawerCash:Pe,cashierName:Wt,shopName:D||null,updatedAt:Ye()},{merge:!0})}}catch{}c({title:"تم تسجيل البيانات",description:`الافتتاحي الأساسي: ${ut(R)}، الهواء: ${ut(we)}، فلوس الدرج: ${ut(Pe)}`})},rt=()=>{if(f==null||T==null){c({title:"سجل الرصيد الافتتاحي أولاً",description:'يرجى الضغط على زر "إضافة" بعد إدخال الافتتاحي.'});return}se(!0)},Ue=()=>{const R=parseFloat(xe||"0"),we=parseFloat(X||"0");if(isNaN(R)||isNaN(we)){c({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة لرصيد التسليم.",variant:"destructive"});return}if(R<0||we<0){c({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}const Pe=(Y==null?void 0:Y.openingBase)??(f||0),Ke=(Y==null?void 0:Y.openingAir)??(T||0),Ee=Pe+Ke,Ze=R+we-Ee;je(Ze);const zt={id:`${Date.now()}`,openingBase:Pe,openingAir:Ke,deliveryBase:R,deliveryAir:we,netResult:Ze,createdAt:new Date().toISOString(),cashierName:Wt,requiredDrawerNoProfit:Ze<0?Math.round(-Ze*100)/100:0};(async()=>{try{v&&be&&(await Ts(_e(J,"shops",v,"machines",be,"deliveries"),{cashierName:Wt,openingBase:Pe,openingAir:Ke,deliveryBase:R,deliveryAir:we,netResult:Ze,createdAt:Ye()}),await Is($e(J,"shops",v,"machines",be),{lastDeliveryAt:Ye(),updatedAt:Ye()},{merge:!0}))}catch(Gt){console.error("Persist delivery error:",Gt)}})(),Me(Gt=>[zt,...Gt]),c({title:"تم إنشاء إيصال تسليم",description:`الناتج النهائي: ${ut(Ze)}`})},ft=()=>{const R=parseFloat(Z||"0"),we=parseFloat(ze||"0");if(!Number.isFinite(R)||!Number.isFinite(we)){c({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة لسعر الجملة وسعر التجزئة.",variant:"destructive"});return}if(R<0||we<0){c({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}if(f==null||T==null){c({title:"سجل الرصيد الافتتاحي أولاً",description:'يرجى إدخال الرصيد الأساسي ورصيد الهواء ثم الضغط "إضافة".'});return}const Pe=Math.round((we-R)*100)/100;Ct({wholesalePrice:R,retailPrice:we,profit:Pe}),St(!0)},it=async R=>{if(!Le)return;const we={id:`transfer_${Date.now()}`,wholesalePrice:Le.wholesalePrice,retailPrice:Le.retailPrice,profit:Le.profit,createdAt:new Date().toISOString(),cashierName:Wt,deductFrom:R},Pe=Le.wholesalePrice,Ke=f??0,Ee=T??0,Rt=O??0;if(Pe>(R==="base"?Ke:Ee)){c({title:"رصيد غير كافٍ",description:"لا يوجد رصيد كافٍ للخصم بسعر الجملة.",variant:"destructive"});return}const zt=R==="base"?Math.round((Ke-Pe)*100)/100:Ke,Gt=R==="air"?Math.round((Ee-Pe)*100)/100:Ee,is=Math.round((Rt+Le.retailPrice)*100)/100;w(zt),V(Gt),q(is);try{if(localStorage.setItem(ra,JSON.stringify({openingBase:zt,openingAir:Gt,drawerCash:is})),v&&be){const nt=$e(J,"shops",v,"machines",be);await Is(nt,{openingBase:zt,openingAir:Gt,drawerCash:is,cashierName:Wt,updatedAt:Ye()},{merge:!0}),await Ts(_e(J,"shops",v,"machines",be,"transfers"),{wholesalePrice:Le.wholesalePrice,retailPrice:Le.retailPrice,profit:Le.profit,deductFrom:R,cashierName:Wt,createdAt:Ye()})}}catch{}G(nt=>[we,...nt]),fe(!1),Q(""),mt(""),Ct(null),St(!1),c({title:"تم تسجيل تحويل",description:`الربح الفوري: ${ut(we.profit)} | خصم المخزون: -${ut(Pe)} (${R==="base"?"الأساسي":"الهواء"}) | درج: +${ut(Le.retailPrice)}`})},Lt=()=>{I(""),S(""),se(!1),re(""),Se(""),je(null)},It=R=>{R||Lt(),u(R)};return e.jsxs(ce,{open:i,onOpenChange:It,children:[e.jsxs(de,{className:"w-screen h-[100vh] overflow-hidden rounded-none p-0 flex flex-col dark:bg-[#121212]",children:[e.jsxs(me,{className:"sticky top-0 bg-white dark:bg-[#0F0F0F] z-20 border-b border-gray-200 dark:border-[#333] px-4 py-3",children:[e.jsx(he,{className:"flex items-center justify-between text-right",children:e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(Eo,{className:"h-5 w-5 text-yellow-500"}),"يومية المكنة"]})}),e.jsx(ss,{className:"text-right",children:'أدخل الرصيد الافتتاحي، ثم في نهاية اليوم قم بإدخال رصيد التسليم لإنشاء إيصال منظم باسم "إيصالات ماكينة".'})]}),e.jsxs("div",{className:"px-4 py-3 overflow-y-auto flex-1 grid grid-cols-1 gap-6",children:[e.jsxs(xt,{children:[e.jsx(Ht,{className:"pb-2",children:e.jsxs(ds,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-right",children:"اختيار ماكينة"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(h,{variant:"destructive",onClick:async()=>{try{if(!v||!be)return;const R=$e(J,"shops",v,"machines",be);try{const Pe=await ct(_e(J,"shops",v,"machines",be,"transfers"));await Promise.all(Pe.docs.map(Ke=>ws(Ke.ref)))}catch{}try{const Pe=await ct(_e(J,"shops",v,"machines",be,"deliveries"));await Promise.all(Pe.docs.map(Ke=>ws(Ke.ref)))}catch{}await ws(R),Dt(Pe=>Pe.filter(Ke=>Ke.id!==be));const we=ht.find(Pe=>Pe.id!==be);st(we?we.id:null);try{const Pe=`${ra}_${be}`,Ke=`${Na}_${be}`;localStorage.removeItem(Pe),localStorage.removeItem(Ke)}catch{}c({title:"تم حذف الماكينة",description:"تمت الإزالة نهائيًا."})}catch{c({title:"فشل الحذف",description:"تعذر حذف الماكينة.",variant:"destructive"})}},disabled:!be,title:"حذف الماكينة",children:e.jsx(Yt,{className:"h-4 w-4"})})})]})}),e.jsx(Nt,{className:"space-y-3",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 items-end",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الماكينة الحالية"}),e.jsxs(na,{value:be??"",onValueChange:R=>st(R),children:[e.jsx(ia,{className:"text-right",children:e.jsx(la,{placeholder:"اختر ماكينة"})}),e.jsx(oa,{children:ht.map(R=>e.jsx(_s,{value:R.id,children:R.name},R.id))})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-2",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"إنشاء ماكينة جديدة"}),e.jsx(U,{value:ms,onChange:R=>_t(R.target.value),placeholder:"اسم الماكينة",className:"text-right"})]}),e.jsx("div",{className:"flex justify-end md:justify-start",children:e.jsx(h,{onClick:async()=>{try{if(!v){c({title:"لا يوجد محل",description:"يرجى التأكد من تحميل بيانات المحل.",variant:"destructive"});return}const R=(ms||"").trim();if(!R){c({title:"اسم الماكينة مطلوب",description:"أدخل اسم للماكينة الجديدة.",variant:"destructive"});return}const we=await Ts(_e(J,"shops",v,"machines"),{name:R,shopId:v,createdAt:Ye(),updatedAt:Ye(),isActive:!0}),Pe={id:we.id,name:R};Dt(Ke=>[Pe,...Ke]),st(we.id),_t(""),c({title:"تم إنشاء ماكينة",description:`تمت إضافة ${R}`})}catch(R){console.error("Create machine error:",R),c({title:"خطأ في الإنشاء",description:"تعذر إنشاء الماكينة.",variant:"destructive"})}},className:"bg-violet-600 hover:bg-violet-700",children:"إضافة"})})]})]})})]}),e.jsxs(xt,{children:[e.jsx(Ht,{className:"pb-2",children:e.jsxs(ds,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-right",children:"الرصيد الافتتاحي"}),e.jsx(h,{variant:"ghost",size:"sm",onClick:()=>W(R=>!R),className:"flex items-center gap-1",children:e.jsx(wr,{className:`h-4 w-4 transition-transform ${_?"rotate-180":""}`})})]})}),e.jsxs("div",{className:"flex items-center justify-between px-6",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(h,{variant:"outline",onClick:()=>fe(!0),disabled:f==null||T==null,className:"border-violet-300 text-violet-700",children:"تحويل"})}),f!=null&&T!=null&&e.jsxs(Mt,{className:"bg-violet-100 text-violet-700 border border-violet-200",children:["تم التسجيل: أساسي ",ut(f)," | هواء ",ut(T)," | درج ",ut(O??0)]})]}),e.jsxs(Nt,{className:`space-y-4 ${_?"":"hidden"}`,children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الرصيد الأساسي"}),e.jsx(U,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:s,onChange:R=>I(R.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"رصيد الهواء"}),e.jsx(U,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:M,onChange:R=>S(R.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"فلوس الدرج"}),e.jsx(U,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:A,onChange:R=>P(R.target.value),placeholder:"0.00",className:"text-right"})]})]}),e.jsxs("div",{className:"flex items-center justify-end",children:[e.jsx(h,{variant:"outline",className:"mr-2",onClick:pt,children:"تصفير"}),e.jsx(h,{onClick:gt,className:"bg-violet-600 hover:bg-violet-700",children:"إضافة"})]})]})]}),e.jsxs(xt,{children:[e.jsx(Ht,{className:"pb-2",children:e.jsxs(ds,{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-right",children:"إيصالات تحويل"}),e.jsxs(Mt,{className:"bg-green-100 text-green-700 border border-green-200",children:["ربح: ",ut(L)]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(h,{variant:"outline",size:"sm",onClick:Oe,className:"border-red-300 text-red-700 hover:bg-red-50",children:"حذف الإيصالات"}),e.jsx(un,{className:"h-4 w-4 text-gray-500"})]})]})}),e.jsx(Nt,{className:"space-y-3",children:Qe.length===0?e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد تحويلات مسجلة."}):e.jsx("div",{className:"space-y-3 max-h-52 overflow-y-auto pr-1",children:Qe.map(R=>e.jsxs("div",{className:"rounded-lg border p-3 grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"سعر الجملة"}),e.jsx("p",{className:"text-sm",children:ut(R.wholesalePrice)})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"سعر التجزئة"}),e.jsx("p",{className:"text-sm",children:ut(R.retailPrice)})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"الربح الفوري"}),e.jsx("p",{className:"text-sm text-green-700",children:ut(R.profit)}),R.deductFrom&&e.jsx("div",{className:"mt-1",children:e.jsxs("span",{className:"text-[11px] bg-violet-100 text-violet-700 border border-violet-200 rounded px-2 py-0.5",children:["الخصم من: ",R.deductFrom==="base"?"الأساسي":"الهواء"]})}),e.jsxs("div",{className:"flex items-center justify-end gap-2 text-xs text-gray-500",children:[e.jsx(ma,{className:"h-3 w-3"}),e.jsx("span",{children:go(R.createdAt)}),R.cashierName&&e.jsxs(e.Fragment,{children:[e.jsx(Ai,{orientation:"vertical",className:"h-3"}),e.jsxs("span",{children:["الكاشير: ",R.cashierName]})]})]})]})]},R.id))})})]}),e.jsxs(xt,{children:[e.jsx(Ht,{className:"pb-2",children:e.jsx(ds,{className:"text-right",children:"نهاية اليوم"})}),e.jsx(Nt,{className:"space-y-4",children:ne?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الرصيد الأساسي الحالي"}),e.jsx(U,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:xe,onChange:R=>re(R.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"رصيد الهواء الحالي"}),e.jsx(U,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:X,onChange:R=>Se(R.target.value),placeholder:"0.00",className:"text-right"})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(h,{variant:"secondary",onClick:()=>se(!1),children:"إلغاء"}),e.jsx(h,{onClick:Ue,className:"bg-green-600 hover:bg-green-700",children:"تسليم"})]}),Ae!=null&&e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{className:"text-right",children:e.jsxs(Mt,{className:Ae>=0?"bg-green-100 text-green-700 border border-green-200":"bg-red-100 text-red-700 border border-red-200",children:["الناتج النهائي: ",ut(Ae)]})}),e.jsxs("div",{className:"mt-2 flex items-center justify-end gap-2",children:[e.jsxs(Mt,{className:"bg-blue-100 text-blue-700 border border-blue-200",children:["المجموع النهائي: ",ut(parseFloat(xe||"0")+parseFloat(X||"0"))]}),e.jsxs(Mt,{className:"bg-amber-100 text-amber-700 border border-amber-200",children:["مطلوب من الدرج (بدون أرباح): ",ut(ye)]})]})]})]}):e.jsx("div",{className:"flex justify-end",children:e.jsx(h,{variant:"outline",onClick:rt,className:"border-violet-300 text-violet-700",children:"تسليم يومية"})})})]}),e.jsxs(xt,{children:[e.jsx(Ht,{className:"pb-2",children:e.jsxs(ds,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-right",children:"إيصالات ماكينة"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(h,{variant:"outline",size:"sm",onClick:at,className:"border-red-300 text-red-700 hover:bg-red-50",children:"حذف الإيصالات"}),e.jsx(un,{className:"h-4 w-4 text-gray-500"})]})]})}),e.jsx(Nt,{className:"space-y-3",children:We.length===0?e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد إيصالات حتى الآن."}):e.jsx("div",{className:"space-y-3",children:We.map(R=>e.jsxs("div",{className:"rounded-lg border p-3 grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"الافتتاحي"}),e.jsxs("p",{className:"text-sm",children:["أساسي: ",ut(R.openingBase)]}),e.jsxs("p",{className:"text-sm",children:["هواء: ",ut(R.openingAir)]})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"التسليم"}),e.jsxs("p",{className:"text-sm",children:["أساسي: ",ut(R.deliveryBase)]}),e.jsxs("p",{className:"text-sm",children:["هواء: ",ut(R.deliveryAir)]})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("div",{className:"flex items-center justify-end",children:e.jsxs(h,{variant:"outline",size:"sm",onClick:()=>kt(R.id),className:"border-red-300 text-red-700 hover:bg-red-50",children:[e.jsx(Yt,{className:"h-3 w-3 mr-1"})," حذف"]})}),e.jsx("p",{className:"text-xs text-gray-500",children:"النتيجة"}),e.jsx("p",{className:`text-sm ${R.netResult>=0?"text-green-700":"text-red-700"}`,children:ut(R.netResult)}),e.jsxs("div",{className:"mt-1 flex items-center justify-end gap-2",children:[e.jsxs("span",{className:"text-[11px] bg-blue-100 text-blue-700 border border-blue-200 rounded px-2 py-0.5",children:["المجموع النهائي: ",ut(R.deliveryBase+R.deliveryAir)]}),typeof R.requiredDrawerNoProfit=="number"&&e.jsxs("span",{className:"text-[11px] bg-amber-100 text-amber-700 border border-amber-200 rounded px-2 py-0.5",children:["مطلوب من الدرج (بدون أرباح): ",ut(R.requiredDrawerNoProfit||0)]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2 text-xs text-gray-500",children:[e.jsx(ma,{className:"h-3 w-3"}),e.jsx("span",{children:go(R.createdAt)}),R.cashierName&&e.jsxs(e.Fragment,{children:[e.jsx(Ai,{orientation:"vertical",className:"h-3"}),e.jsxs("span",{children:["الكاشير: ",R.cashierName]})]})]})]})]},R.id))})})]})]}),e.jsxs(Ge,{className:"sticky bottom-0 bg-white dark:bg-[#0F0F0F] z-20 border-t border-gray-200 dark:border-[#333] px-4 py-3 flex items-center justify-between",children:[e.jsx(h,{variant:"outline",onClick:()=>It(!1),children:"إغلاق"}),e.jsxs("div",{className:"text-xs text-gray-500 flex items-center gap-1",children:[e.jsx(Zs,{className:"h-3 w-3"}),e.jsx("span",{children:"يسجل التاريخ والوقت تلقائياً لكل إيصال"})]})]})]}),e.jsx(ce,{open:ue,onOpenChange:fe,children:e.jsxs(de,{className:"sm:max-w-sm",children:[e.jsx(me,{children:e.jsx(he,{children:"تحويل رصيد"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"سعر الجملة"}),e.jsx(U,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:Z,onChange:R=>Q(R.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"سعر التجزئة"}),e.jsx(U,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:ze,onChange:R=>mt(R.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsx("div",{className:"text-right",children:e.jsxs(Mt,{className:"bg-green-100 text-green-700 border border-green-200",children:["الربح الفوري: ",ut(parseFloat(ze||"0")-parseFloat(Z||"0")||0)]})})]}),e.jsxs(Ge,{className:"flex items-center justify-end gap-2",children:[e.jsx(h,{variant:"secondary",onClick:()=>fe(!1),children:"إلغاء"}),e.jsx(h,{onClick:ft,className:"bg-violet-600 hover:bg-violet-700",children:"تحويل"})]})]})}),e.jsx(bh,{open:Et,onOpenChange:St,children:e.jsxs(Xo,{children:[e.jsxs(ec,{children:[e.jsx(tc,{children:"اختيار مصدر الخصم"}),e.jsx(sc,{children:"هل يتم الخصم من الرصيد الأساسي أم من رصيد الهواء؟"})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2 mt-4",children:[e.jsx(ac,{onClick:()=>St(!1),children:"رجوع"}),e.jsx(Pi,{onClick:()=>it("base"),children:"خصم من الأساسي"}),e.jsx(Pi,{onClick:()=>it("air"),children:"خصم من الهواء"})]})]})})]})}function jh(i,u=300){const[c,p]=Ve.useState(i);return Ve.useEffect(()=>{const v=setTimeout(()=>p(i),u);return()=>clearTimeout(v)},[i,u]),c}const Sh=({userId:i,transactions:u})=>{const[c,p]=n.useState(!1),[v,D]=n.useState(!1),[s,I]=n.useState(!1),[M,S]=n.useState({monthlyWithdrawalProfit:0,monthlyTransferProfit:0,lastUpdated:new Date}),{userSubscription:A}=Us();n.useEffect(()=>{i&&c&&s&&P()},[i,c,s]);const P=async()=>{if(i)try{if(Array.isArray(u)&&u.length>0){const q=new Date,Y=q.getMonth(),ae=q.getFullYear(),_=ts.filterVisibleTransactions(u,"monthly",i);let W=0,ne=0;_.forEach(se=>{const xe=new Date(se.createdAt),re=String(se.status||"confirmed").toLowerCase();if(xe.getMonth()!==Y||xe.getFullYear()!==ae||re!=="completed"&&re!=="confirmed")return;const X=(se.type||se.txnType||"").toLowerCase(),Se={type:X==="withdrawal"?"withdraw":X,amount:Number(se.amount||0),commission:se.commission};Se.type==="withdraw"?W+=ca.calculateProfitFromTransaction(Se):(Se.type==="send"||Se.type==="receive"||Se.type==="transfer")&&(ne+=ca.calculateProfitFromTransaction(Se))}),S({monthlyWithdrawalProfit:Math.round(W*100)/100,monthlyTransferProfit:Math.round(ne*100)/100,lastUpdated:new Date});return}const O=ca.getWithdrawTransferProfits(i);S({monthlyWithdrawalProfit:O.monthlyWithdrawProfit||0,monthlyTransferProfit:O.monthlyTransferProfit||0,lastUpdated:new Date})}catch(O){console.error("Error loading profit data:",O)}},f=O=>`${O.toFixed(2)} ج.م`,w=async()=>{try{const O=(A==null?void 0:A.subscription)||null,q=(O==null?void 0:O.planType)??(O==null?void 0:O.plan)??null,Y=typeof q=="string"?q.toLowerCase():null;if(q===cs.ZERO||Y==="zero"||Y==="0"||q===0)return!0}catch{}try{if(i){const O=await ki(i),q=(O==null?void 0:O.planType)??(O==null?void 0:O.plan)??null,Y=typeof q=="string"?q.toLowerCase():null;if(q===cs.ZERO||Y==="zero"||Y==="0"||q===0)return!0}}catch{}return!1},T=async()=>{try{if(await w()){ao({title:"الخطة زيرو",description:"عرض الأرباح الشهرية غير متاح في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}catch{}D(!0)},V=async()=>{try{if(await w()){ao({title:"الخطة زيرو",description:"عرض الأرباح الشهرية غير متاح في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"}),D(!1);return}}catch{}I(!0),p(!0),D(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(h,{size:"sm",variant:"ghost",onClick:T,className:"h-2 w-2 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded transition-all duration-300 hover:scale-110 shadow-sm hover:shadow-md",title:"عرض الأرباح الشهرية",children:e.jsx(jt,{className:"h-1.5 w-1.5"})}),e.jsx(ce,{open:c,onOpenChange:p,children:e.jsxs(de,{className:"max-w-[220px] mx-auto bg-white border border-gray-200 shadow-md rounded sm:max-w-[180px] sm:bg-gradient-to-br sm:from-purple-50 sm:to-white sm:border-2 sm:border-purple-200 sm:shadow-2xl sm:rounded-2xl",children:[e.jsx(me,{className:"text-center pb-0 border-b-0 sm:pb-2 sm:border-b sm:border-purple-200",children:e.jsxs(he,{className:"text-xs font-bold text-purple-800 flex items-center justify-center gap-0 mb-0 leading-tight tracking-tight sm:text-xs sm:gap-1 sm:mb-0 sm:leading-normal sm:tracking-normal",children:[e.jsx(ma,{className:"h-2 w-2 text-purple-600 sm:h-3 sm:w-3"}),"شهري"]})}),e.jsx("div",{className:"py-0 sm:py-3",children:e.jsxs("div",{className:"rounded-xl border border-purple-300 bg-white overflow-hidden",children:[e.jsx("div",{className:"p-2 sm:p-3 bg-red-50 border-b border-purple-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(gn,{className:"h-3 w-3 text-red-600"}),e.jsx("span",{className:"font-medium text-red-800 text-xs",children:"سحب"})]}),e.jsx("span",{className:"font-bold text-sm text-red-900 bg-white px-2 py-0.5 rounded",children:f(M.monthlyWithdrawalProfit)})]})}),e.jsx("div",{className:"p-2 sm:p-3 bg-blue-50 border-b border-purple-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Po,{className:"h-3 w-3 text-blue-600"}),e.jsx("span",{className:"font-medium text-blue-800 text-xs",children:"تحويل"})]}),e.jsx("span",{className:"font-bold text-sm text-blue-900 bg-white px-2 py-0.5 rounded",children:f(M.monthlyTransferProfit)})]})}),e.jsx("div",{className:"p-2 sm:p-3 bg-purple-50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Pt,{className:"h-3 w-3 text-purple-600"}),e.jsx("span",{className:"font-medium text-purple-800 text-xs",children:"إجمالي"})]}),e.jsx("span",{className:"font-bold text-sm text-purple-900 bg-white px-2 py-0.5 rounded",children:f(M.monthlyWithdrawalProfit+M.monthlyTransferProfit)})]})})]})}),!s&&e.jsx("div",{className:"absolute inset-0 bg-yellow-200/70 backdrop-blur-sm flex items-center justify-center rounded sm:rounded-2xl border border-yellow-300 pointer-events-auto",children:e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>D(!0),className:"p-2 bg-yellow-300/80 text-yellow-900 hover:bg-yellow-400/90 rounded-full shadow-sm hover:shadow-md transition-all duration-300",title:"إدخال الرقم السري الرئيسي",children:e.jsx(jt,{className:"h-4 w-4"})})}),e.jsx("div",{className:"flex justify-center pt-0 border-t-0 sm:pt-2 sm:border-t sm:border-purple-200",children:e.jsx(h,{onClick:()=>p(!1),className:"bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-xl text-sm sm:bg-gradient-to-r sm:from-purple-600 sm:to-purple-700 sm:hover:from-purple-700 sm:hover:to-purple-800 sm:px-4 sm:py-1 sm:rounded-xl sm:shadow-lg sm:hover:shadow-xl sm:transition-all sm:duration-300",children:"إغلاق"})})]})}),e.jsx(rs,{open:v,onOpenChange:D,onSuccess:V,description:"لا يمكن الاطلاع على الأرباح الشهرية إلا بإدخال الرقم السري الرئيسي"})]})},Dh=i=>e.jsx(Sh,{...i});function Ch({open:i,onOpenChange:u,onSuccess:c,userId:p}){const[v,D]=n.useState(""),[s,I]=n.useState(""),[M,S]=n.useState(!1),[A,P]=n.useState(!1),[f,w]=n.useState(""),[T,V]=n.useState(!1),[O,q]=n.useState(!1),{toast:Y}=Ps();n.useEffect(()=>{let W=!0;return(async()=>{const ne=await ns.hasMasterPin(p);W&&q(ne)})(),()=>{W=!1}},[p,i]);const ae=()=>{D(""),I(""),w(""),S(!1),P(!1),u(!1)},_=async W=>{W.preventDefault(),w(""),V(!0);try{if(O){if(!await ns.verifyMasterPin(v,p)){w("الرقم السري غير صحيح"),V(!1);return}}else{if(v.length<4){w("يجب أن يكون الرقم السري 4 أرقام على الأقل"),V(!1);return}if(v!==s){w("الرقم السري غير متطابق"),V(!1);return}if(!await ns.createMasterPin(v,p)){w("تعذر إنشاء الرقم السري الرئيسي"),V(!1);return}}Y({title:"نجح العملية",description:O?"تم التحقق من الرقم السري الرئيسي بنجاح":"تم إنشاء الرقم السري الرئيسي بنجاح"}),c(),ae()}catch{w("حدث خطأ أثناء معالجة الرقم السري")}finally{V(!1)}};return e.jsx(ce,{open:i,onOpenChange:u,children:e.jsxs(de,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(me,{children:e.jsxs(he,{className:"flex items-center gap-2 text-lg font-semibold",children:[e.jsx(Sa,{className:"h-5 w-5 text-green-600"}),O?"أدخل الرقم السري الرئيسي":"إنشاء الرقم السري الرئيسي"]})}),e.jsxs("form",{onSubmit:_,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-gray-600 bg-blue-50 p-3 rounded-lg",children:O?"أدخل الرقم السري الرئيسي لعرض بيانات الأرباح":"قم بإنشاء الرقم السري الرئيسي لحماية بيانات الأرباح. يمكنك تغييره لاحقاً من إعدادات البروفيل."}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"pin",children:O?"الرقم السري الرئيسي":"الرقم السري الرئيسي الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"pin",type:M?"text":"password",value:v,onChange:W=>D(W.target.value),placeholder:O?"أدخل الرقم السري":"أدخل رقم سري جديد (4 أرقام على الأقل)",className:"pr-10",dir:"ltr",autoComplete:"off",required:!0}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>S(!M),children:M?e.jsx(es,{className:"h-4 w-4"}):e.jsx(jt,{className:"h-4 w-4"})})]})]}),!O&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"confirmPin",children:"تأكيد الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"confirmPin",type:A?"text":"password",value:s,onChange:W=>I(W.target.value),placeholder:"أعد إدخال الرقم السري",className:"pr-10",dir:"ltr",autoComplete:"off",required:!0}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>P(!A),children:A?e.jsx(es,{className:"h-4 w-4"}):e.jsx(jt,{className:"h-4 w-4"})})]})]}),f&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(Ca,{className:"h-4 w-4"}),f]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(h,{type:"submit",disabled:T,className:"flex-1 bg-green-600 hover:bg-green-700",children:[e.jsx(Sa,{className:"h-4 w-4 mr-2"}),T?"جاري المعالجة...":O?"عرض الأرباح":"إنشاء وعرض الأرباح"]}),e.jsx(h,{type:"button",variant:"outline",onClick:ae,disabled:T,children:"إلغاء"})]})]})]})})}const Ih=({userId:i,transactions:u})=>{const[c,p]=n.useState(!1),[v,D]=n.useState(!1),[s,I]=n.useState(!1),[M,S]=n.useState({dailyWithdrawalProfit:0,dailyTransferProfit:0,lastUpdated:new Date});n.useEffect(()=>{i&&c&&s&&A()},[i,c,s]);const A=async()=>{if(i)try{if(Array.isArray(u)&&u.length>0){const V=new Date,O=ts.filterVisibleTransactions(u,"daily",i);let q=0,Y=0;O.forEach(ae=>{const _=new Date(ae.createdAt),W=String(ae.status||"confirmed").toLowerCase();if(_.toDateString()!==V.toDateString()||W!=="completed"&&W!=="confirmed")return;const ne=(ae.type||ae.txnType||"").toLowerCase(),se={type:ne==="withdrawal"?"withdraw":ne,amount:Number(ae.amount||0),commission:ae.commission};se.type==="withdraw"?q+=ca.calculateProfitFromTransaction(se):(se.type==="send"||se.type==="receive"||se.type==="transfer")&&(Y+=ca.calculateProfitFromTransaction(se))}),S({dailyWithdrawalProfit:Math.round(q*100)/100,dailyTransferProfit:Math.round(Y*100)/100,lastUpdated:new Date});try{ca.updateProfitsFromTransactions(u,i)}catch{}return}const T=ca.getWithdrawTransferProfits(i);S({dailyWithdrawalProfit:T.dailyWithdrawProfit||0,dailyTransferProfit:T.dailyTransferProfit||0,lastUpdated:new Date})}catch(T){console.error("Error loading profit data:",T)}},P=T=>`${T.toFixed(2)} ج.م`,f=()=>{ca.hasProfitPin(i),D(!0)},w=()=>{I(!0),p(!0),D(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(h,{size:"sm",variant:"ghost",onClick:f,className:"h-2 w-2 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded transition-all duration-300 hover:scale-110 shadow-sm hover:shadow-md",title:"عرض الأرباح اليومية",children:e.jsx(jt,{className:"h-1.5 w-1.5"})}),e.jsx(ce,{open:c,onOpenChange:p,children:e.jsxs(de,{className:"max-w-[220px] mx-auto bg-white border border-gray-200 shadow-md rounded sm:max-w-[180px] sm:bg-gradient-to-br sm:from-blue-50 sm:to-white sm:border-2 sm:border-blue-200 sm:shadow-2xl sm:rounded-2xl",children:[e.jsx(me,{className:"text-center pb-0 border-b-0 sm:pb-2 sm:border-b sm:border-blue-200",children:e.jsxs(he,{className:"text-xs font-bold text-blue-800 flex items-center justify-center gap-0 mb-0 leading-tight tracking-tight sm:text-sm sm:gap-1 sm:mb-0 sm:leading-normal sm:tracking-normal",children:[e.jsx(Pt,{className:"h-2 w-2 text-blue-600 sm:h-3 sm:w-3"}),"يومي"]})}),e.jsx("div",{className:"py-0 sm:py-3",children:e.jsxs("div",{className:"rounded-xl border border-blue-300 bg-white overflow-hidden",children:[e.jsx("div",{className:"p-2 sm:p-3 bg-red-50 border-b border-blue-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(gn,{className:"h-3 w-3 text-red-600"}),e.jsx("span",{className:"font-medium text-red-800 text-xs",children:"سحب"})]}),e.jsx("span",{className:"font-bold text-sm text-red-900 bg-white px-2 py-0.5 rounded",children:P(M.dailyWithdrawalProfit)})]})}),e.jsx("div",{className:"p-2 sm:p-3 bg-green-50 border-b border-blue-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Po,{className:"h-3 w-3 text-green-600"}),e.jsx("span",{className:"font-medium text-green-800 text-xs",children:"تحويل"})]}),e.jsx("span",{className:"font-bold text-sm text-green-900 bg-white px-2 py-0.5 rounded",children:P(M.dailyTransferProfit)})]})}),e.jsx("div",{className:"p-2 sm:p-3 bg-blue-50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Pt,{className:"h-3 w-3 text-blue-600"}),e.jsx("span",{className:"font-medium text-blue-800 text-xs",children:"إجمالي"})]}),e.jsx("span",{className:"font-bold text-sm text-blue-900 bg-white px-2 py-0.5 rounded",children:P(M.dailyWithdrawalProfit+M.dailyTransferProfit)})]})})]})}),e.jsx("div",{className:"flex justify-center pt-0 border-t-0 sm:pt-2 sm:border-t sm:border-blue-200",children:e.jsx(h,{onClick:()=>p(!1),className:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-xl text-sm sm:bg-gradient-to-r sm:from-blue-600 sm:to-blue-700 sm:hover:from-blue-700 sm:hover:to-blue-800 sm:px-4 sm:py-1 sm:rounded-xl sm:shadow-lg sm:hover:shadow-xl sm:transition-all sm:duration-300 sm:text-xs",children:"إغلاق"})})]})}),e.jsx(Ch,{open:v,onOpenChange:D,onSuccess:w,userId:i})]})},Ah=i=>e.jsx(Ih,{...i}),Th=({open:i,onOpenChange:u})=>{var F;const{shiftUser:c,isShiftActive:p,shiftStartAt:v,setShiftUser:D,startShift:s,endShift:I}=Sr(),{userSubscription:M,user:S,signIn:A,profile:P}=Us(),{toast:f}=Ps(),[w,T]=n.useState((c==null?void 0:c.name)||""),[V,O]=n.useState((c==null?void 0:c.username)||""),[q,Y]=n.useState(""),[ae,_]=n.useState(!1),[W,ne]=n.useState(null),[se,xe]=n.useState(""),[re,X]=n.useState(""),[Se,Ae]=n.useState(!1),[je,We]=n.useState(null),[Me,Qe]=n.useState(""),[G,ue]=n.useState(""),[fe,Z]=n.useState(!1),[Q,ze]=n.useState(!1),[mt,Et]=n.useState({totalTransfers:0,totalWithdrawals:0}),[St,Le]=n.useState(null),[Ct,ht]=n.useState(""),[Dt,be]=n.useState(""),[st,ms]=n.useState(0),[_t,Wt]=n.useState({}),[L,ye]=n.useState(0),[Oe,at]=n.useState(0),[kt,pt]=n.useState({}),[gt,rt]=n.useState(""),[Ue,ft]=n.useState(!1),it=()=>`cashierUsers_${(S==null?void 0:S.uid)||"default"}`,[Lt,It]=n.useState(()=>{try{let N=localStorage.getItem(it());if(!N){const k=localStorage.getItem("cashierUsers");k&&(N=k)}return N?JSON.parse(N):[]}catch{return[]}});n.useEffect(()=>{(async()=>{try{if(!(S!=null&&S.uid))return;const N=$e(J,"profiles",S.uid,"cashierUsers","list"),k=await da(N);if(k.exists()){const K=k.data(),te=Array.isArray(K==null?void 0:K.users)?K.users:[];te&&te.length>0&&It(te)}}catch{}})()},[S==null?void 0:S.uid]),n.useEffect(()=>{if(!(S!=null&&S.uid))return;const N=$e(J,"profiles",S.uid,"cashierUsers","list"),k=Bs(N,K=>{try{if(K.exists()){const te=K.data(),pe=Array.isArray(te==null?void 0:te.users)?te.users:[];if(pe&&pe.length>0)It(pe);else try{const le=localStorage.getItem(it()),Ie=le?JSON.parse(le):[];It(Ie)}catch{It([])}}}catch{}},K=>{console.warn("cashierUsers realtime subscription error:",K)});return()=>k()},[S==null?void 0:S.uid]);const R=(F=M==null?void 0:M.subscription)==null?void 0:F.planType,we=R==="yearly"?2:R==="lifetime"?4:Number.POSITIVE_INFINITY;n.useEffect(()=>{try{localStorage.setItem(it(),JSON.stringify(Lt));try{localStorage.removeItem("cashierUsers")}catch{}}catch{}(async()=>{try{if(!(S!=null&&S.uid))return;const N=$e(J,"profiles",S.uid,"cashierUsers","list");await Is(N,{users:Lt},{merge:!0})}catch{}})()},[Lt]);const[Pe,Ke]=n.useState(!1),[Ee,Rt]=n.useState(""),[Ze,zt]=n.useState(null),[Gt,is]=n.useState([]),[nt,Ns]=n.useState(!1),[yt,zs]=n.useState(null),[ua,Ia]=n.useState(!1),[Aa,ks]=n.useState(!1),Ta=N=>{const k=(c==null?void 0:c.username)===N;let K=!1;try{K=localStorage.getItem("lastHandoverToAdmin")==="true"}catch{}if(k&&!(k&&!p&&(gt==="الأدمن الرئيسي"||K))){f({title:"لا يمكن الحذف",description:"لا يمكنك حذف مستخدم الوردية أثناء كونها نشطة أو قبل تسليمها للأدمن الرئيسي"});return}const le=`هل أنت متأكد من حذف المستخدم ${N}؟

هذا الإجراء لا يمكن التراجع عنه.`;window.confirm(le)&&(It(Ie=>Ie.filter(ve=>ve.username!==N)),k&&D(null),f({title:"تم حذف المستخدم",description:N}))},ls=()=>{if(!w.trim()||!V.trim()||!q.trim())return;if(Lt.length>=we){f({title:"وصلت الحد الأقصى للمستخدمين",description:`هذه الباقة تسمح بإضافة ${Number.isFinite(we)?we:"عدد غير محدود"} كاشير فقط`,variant:"destructive"});return}const N={name:w.trim(),username:V.trim(),password:q.trim()};It(k=>[N,...k]),T(""),O(""),Y("")},qa=()=>{_(!0),ne(null),We(null),Qe(""),ue("")},m=async()=>{try{let N=[];try{S!=null&&S.uid&&(N=await De.getUserTransactions(S.uid))}catch{}if(!N||N.length===0)try{const Fe=await Vm({merchantUserId:S==null?void 0:S.uid,limit:200});N=(Fe==null?void 0:Fe.transactions)||[]}catch{}const k=v?new Date(v):null,K=new Date,te=Fe=>{const Je=Fe.type,Bt=Fe.txnType;return Je==="withdraw"||Je==="withdrawal"||Je==="receive"||Bt==="receive"},pe=Fe=>{const Je=Fe.type,Bt=Fe.txnType;return Je==="send"||Je==="transfer"||Bt==="send"},le=Fe=>{if(!Fe)return null;if(Fe instanceof Date)return Fe;try{const Je=new Date(Fe);return Number.isNaN(Je.getTime())?null:Je}catch{return null}},Ie=Fe=>{const Je=le(Fe.createdAt||Fe.created_at||Fe.timestamp);return!Je||k&&Je<k?!1:Je<=K},ve=Fe=>Fe==="completed"||Fe==="confirmed",oe=N.filter(Fe=>ve(Fe.status)&&Ie(Fe)),Qt=oe.filter(Fe=>te(Fe)).reduce((Fe,Je)=>{const Bt=Je.withdrawnAmount??Je.receivedAmount??Je.amount??0;return Fe+(Number(Bt)||0)},0);return{totalTransfers:oe.filter(Fe=>pe(Fe)).reduce((Fe,Je)=>{const Bt=Je.sentAmount??Je.transferredAmount??Je.amount??0;return Fe+(Number(Bt)||0)},0),totalWithdrawals:Qt}}catch{return{totalTransfers:0,totalWithdrawals:0}}};n.useEffect(()=>{if(Q){try{const N=localStorage.getItem("shiftInitialReceivedDrawerFunds");N!==null&&be(N)}catch{}try{const N=localStorage.getItem("shiftInitialReceivedWalletBalancesTotal");if(N!==null){const k=parseFloat(N);ms(Number.isFinite(k)?k:0)}}catch{}}},[Q]),n.useEffect(()=>{if(!i&&!nt)return;(async()=>{try{const K=((S!=null&&S.uid?await De.getUserTransactions(S.uid):[])||[]).filter(te=>(te==null?void 0:te.type)==="report"||((te==null?void 0:te.title)||"").includes("إيصال تسليم وردية"));K.sort((te,pe)=>{const le=new Date(te.createdAt||0).getTime();return new Date(pe.createdAt||0).getTime()-le}),is(K)}catch{is([])}})()},[i,Q,nt,S==null?void 0:S.uid]);const E=async(N,k,K)=>{try{let te=0,pe=0;try{const Ie=parseFloat(localStorage.getItem("shiftInitialReceivedDrawerFunds")||"0");te=Number.isFinite(Ie)?Ie:0}catch{}try{const Ie=parseFloat(localStorage.getItem("shiftInitialReceivedWalletBalancesTotal")||"0");pe=Number.isFinite(Ie)?Ie:0}catch{}const le={id:`shift_receipt_${Date.now()}`,type:"report",senderPhone:(c==null?void 0:c.username)||"cashier",receiverPhone:gt||"admin",amount:0,status:"completed",createdAt:new Date().toISOString(),title:"إيصال تسليم وردية",cashierName:(c==null?void 0:c.name)||(c==null?void 0:c.username)||null,deficit:k,deficitAmount:k?K:0,shiftStartAt:v,receivedDrawerFunds:te,receivedWalletBalancesTotal:pe,receivedWalletBalances:_t,deliveredDrawerFunds:L||0,deliveredWalletBalancesTotal:Oe||0,deliveredWalletBalances:kt,shiftProfit:Math.round(((L||0)+(Oe||0)-(te+pe))*100)/100};S!=null&&S.uid&&await De.saveUserTransaction(S.uid,le),is(Ie=>[le,...Ie||[]])}catch{}};return e.jsxs(e.Fragment,{children:[e.jsx(ce,{open:i,onOpenChange:u,children:e.jsxs(de,{className:"sm:max-w-md",children:[e.jsx(me,{children:e.jsx(he,{children:p?"تسليم الورديه والخروج":"إضافة مستخدم وردية"})}),p?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsx("div",{className:"text-sm",children:"المستخدم الحالي للوردية:"}),e.jsxs("div",{className:"font-semibold text-sm",children:[c==null?void 0:c.name," (",c==null?void 0:c.username,")"]})]}),e.jsx("div",{className:"text-xs text-gray-600",children:'لإنهاء الوردية والخروج، اضغط "تسليم الورديه والخروج" وسيُطلب الرقم السري.'})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-xs text-gray-600",children:'لاستكمال إضافة مستخدم جديد اضغط الزر أسفل "إضافة مستخدم جديد" لفتح النموذج.'}),Lt.length>0&&e.jsxs("div",{className:"mt-4 border-t pt-3",children:[e.jsx("div",{className:"text-sm font-medium mb-2",children:"المستخدمون المسجلون"}),e.jsx("div",{className:"space-y-2 max-h-48 overflow-auto",children:Lt.map((N,k)=>e.jsxs("div",{className:"flex items-center justify-between rounded border px-3 py-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:N.name}),e.jsx("div",{className:"text-xs text-gray-500",children:N.username})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(h,{size:"sm",className:"w-full sm:w-auto",onClick:()=>{zt(N),Ke(!0)},children:"دخول"}),e.jsx(h,{size:"sm",className:"w-full sm:w-auto",variant:"destructive",onClick:()=>Ta(N.username),children:"حذف"})]})]},k))})]})]}),e.jsx(Ge,{className:"flex flex-wrap gap-2 justify-between",children:p?e.jsx("div",{className:"flex flex-wrap gap-2",children:e.jsx(h,{className:"w-full sm:w-auto",variant:"destructive",onClick:qa,children:"تسليم الورديه والخروج"})}):e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(h,{className:"w-full sm:w-auto",onClick:()=>ks(!0),children:"إضافة مستخدم جديد"}),e.jsx(h,{className:"w-full sm:w-auto",variant:"outline",onClick:()=>Ns(!0),children:"إيصالات التسليم"})]})})]})}),e.jsx(ce,{open:Aa,onOpenChange:ks,children:e.jsxs(de,{className:"sm:max-w-md",children:[e.jsx(me,{children:e.jsx(he,{children:"إضافة مستخدم جديد"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(H,{className:"mb-1 block",children:"الاسم"}),e.jsx(U,{value:w,onChange:N=>T(N.target.value),placeholder:"أدخل الاسم"})]}),e.jsxs("div",{children:[e.jsx(H,{className:"mb-1 block",children:"اسم المستخدم"}),e.jsx(U,{value:V,onChange:N=>O(N.target.value),placeholder:"أدخل اسم المستخدم"})]}),e.jsxs("div",{children:[e.jsx(H,{className:"mb-1 block",children:"الرقم السري"}),e.jsx(U,{type:"password",autoComplete:"new-password",value:q,onChange:N=>Y(N.target.value),placeholder:"أدخل الرقم السري"})]}),e.jsx("div",{className:"text-xs text-gray-500",children:"المستخدم يمكنه: التحويل، السحب، اختيار المحفظة فقط."})]}),e.jsxs(Ge,{className:"flex gap-2 justify-between",children:[e.jsx(h,{variant:"secondary",onClick:()=>{ks(!1)},children:"إلغاء"}),e.jsx(h,{onClick:()=>{!w.trim()||!V.trim()||!q.trim()||(ls(),ks(!1))},children:"حفظ المستخدم"})]})]})}),e.jsx(ce,{open:nt,onOpenChange:Ns,children:e.jsxs(de,{className:"sm:max-w-lg",children:[e.jsx(me,{children:e.jsx(he,{children:"إيصالات التسليم"})}),Gt.length===0?e.jsx("div",{className:"text-xs text-gray-600",children:"لا توجد إيصالات تسليم محفوظة بعد."}):e.jsx("div",{className:"space-y-2 max-h-[60vh] overflow-auto",children:Gt.map(N=>e.jsxs("div",{className:"rounded border px-3 py-2 cursor-pointer hover:bg-gray-50",onClick:()=>{zs(N),Ia(!0)},children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm font-semibold",children:new Date(N.createdAt).toLocaleString("ar-EG")}),e.jsxs("div",{className:"text-xs text-gray-500",children:["إلى: ",N.receiverPhone]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-1",children:[e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مسلّمة: ",N.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مسلّمة (إجمالي): ",N.deliveredWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مستلمة: ",N.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مستلمة (إجمالي): ",N.receivedWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مسلّمة: ",N.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مسلّمة (إجمالي): ",N.deliveredWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مستلمة: ",N.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مستلمة (إجمالي): ",N.receivedWalletBalancesTotal??0]}),e.jsxs("div",{className:["text-xs",(N.shiftProfit??(N.deliveredDrawerFunds??0)+(N.deliveredWalletBalancesTotal??0)-(N.receivedDrawerFunds??0)-(N.receivedWalletBalancesTotal??0))>=0?"text-green-700":"text-red-700"].join(" "),children:["أرباح الوردية: ",N.shiftProfit??(N.deliveredDrawerFunds??0)+(N.deliveredWalletBalancesTotal??0)-(N.receivedDrawerFunds??0)-(N.receivedWalletBalancesTotal??0)]})]}),N.deficit&&e.jsxs("div",{className:"text-xs text-red-600 mt-1",children:["عجز: ",N.deficitAmount??0]})]},N.id))}),e.jsx(Ge,{className:"flex gap-2 justify-between",children:e.jsx(h,{variant:"secondary",onClick:()=>Ns(!1),children:"إغلاق"})})]})}),e.jsx(ce,{open:ua,onOpenChange:Ia,children:e.jsxs(de,{className:"sm:max-w-md",children:[e.jsx(me,{children:e.jsx(he,{children:"إيصال تسليم وردية"})}),yt?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsxs("div",{className:"text-sm",children:["التاريخ: ",new Date(yt.createdAt).toLocaleString("ar-EG")]}),e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["تم التسليم إلى: ",yt.receiverPhone]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"المستلم عند الدخول"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية: ",yt.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["أرصدة المحافظ (إجمالي): ",yt.receivedWalletBalancesTotal??0]})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"المسلّم عند الخروج"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية: ",yt.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["أرصدة المحافظ (إجمالي): ",yt.deliveredWalletBalancesTotal??0]})]})]}),yt.deficit&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2 text-red-600",children:"عجز"}),e.jsxs("div",{className:"text-xs text-red-600",children:["المبلغ: ",yt.deficitAmount??0]})]}),yt.receivedWalletBalances&&Object.keys(yt.receivedWalletBalances).length>0&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"تفصيل المحافظ المستلمة"}),e.jsx("div",{className:"space-y-1",children:Object.entries(yt.receivedWalletBalances).map(([N,k])=>e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-gray-600",children:N}),e.jsx("span",{className:"font-semibold",children:k})]},N))})]}),yt.deliveredWalletBalances&&Object.keys(yt.deliveredWalletBalances).length>0&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"تفصيل المحافظ المسلّمة"}),e.jsx("div",{className:"space-y-1",children:Object.entries(yt.deliveredWalletBalances).map(([N,k])=>e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-gray-600",children:N}),e.jsx("span",{className:"font-semibold",children:k})]},N))})]})]}):e.jsx("div",{className:"text-xs text-gray-600",children:"لا يوجد تقرير محدد للعرض."}),e.jsx(Ge,{className:"flex gap-2 justify-between",children:e.jsx(h,{variant:"secondary",onClick:()=>Ia(!1),children:"إغلاق"})})]})}),e.jsx(ce,{open:Pe,onOpenChange:Ke,children:e.jsxs(de,{className:"sm:max-w-md",children:[e.jsx(me,{children:e.jsx(he,{children:"أدخل الرقم السري للدخول"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm",children:Ze?`${Ze.name} (${Ze.username})`:""}),e.jsx(U,{type:"password",autoComplete:"off",value:Ee,onChange:N=>Rt(N.target.value),placeholder:"أدخل الرقم السري"})]}),e.jsxs(Ge,{className:"flex gap-2 justify-between",children:[e.jsx(h,{variant:"secondary",onClick:()=>{Rt(""),zt(null),Ke(!1)},children:"إلغاء"}),e.jsx(h,{onClick:()=>{if(Ze){if(Ee.trim()!==Ze.password){f({title:"خطأ في الرقم السري",description:"الرقم السري للكاشير غير صحيح",variant:"destructive"});return}D({name:Ze.name,username:Ze.username}),Rt(""),Ke(!1),u(!1),s(),ft(!0)}},children:"دخول الورديه"})]})]})}),e.jsx(ce,{open:Ue,onOpenChange:ft,children:e.jsxs(de,{className:"sm:max-w-md",children:[e.jsx(me,{children:e.jsx(he,{children:"تسجيل أرصدة البداية والنقدية"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(H,{className:"mb-1 block",children:"الفلوس النقدية المستلمة عند الدخول"}),e.jsx(U,{type:"number",value:Dt,onChange:N=>be(N.target.value),placeholder:"أدخل قيمة النقدية في الدرج عند بداية الورديه"})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(H,{className:"mb-1 block",children:"أرصدة المحافظ المستلمة (إجمالي) عند الدخول"}),e.jsx(U,{type:"number",value:Number.isFinite(st)?st:0,onChange:N=>{const k=parseFloat(N.target.value);ms(Number.isFinite(k)?k:0)},placeholder:"أدخل إجمالي أرصدة المحافظ عند بداية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"يمكن إضافة التفصيل لاحقاً إن لزم، المهم تسجيل الإجمالي."})]})]}),e.jsx(Ge,{className:"flex gap-2 justify-between",children:e.jsx(h,{onClick:()=>{const N=parseFloat(Dt),k=st,K=Number.isFinite(N)&&N>=0,te=Number.isFinite(k)&&k>=0;if(!K||!te){f({title:"يرجى إدخال قيم صحيحة",description:"أدخل قيمًا رقمية غير سالبة للنقدية ولإجمالي أرصدة المحافظ",variant:"destructive"});return}try{localStorage.setItem("shiftInitialReceivedDrawerFunds",String(N)),localStorage.setItem("shiftInitialReceivedWalletBalancesTotal",String(k))}catch{}f({title:"تم تسجيل أرصدة البداية",description:"سُجّل إجمالي النقدية وأرصدة المحافظ لبداية الورديه"}),ft(!1)},children:"تأكيد وحفظ"})})]})}),e.jsx(ce,{open:ae,onOpenChange:N=>{N&&_(!0)},children:e.jsxs(de,{className:"sm:max-w-md",hideClose:!0,disableOutsideClose:!0,disableEscClose:!0,children:[e.jsx(me,{children:e.jsx(he,{children:"تسليم الورديه والخروج"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(h,{variant:W==="toUser"?"default":"secondary",onClick:()=>ne("toUser"),children:"تسليم إلى مستخدم آخر"}),e.jsx(h,{variant:W==="toAdmin"?"default":"secondary",onClick:()=>ne("toAdmin"),children:"تسليم إلى الأدمن الرئيسي"})]}),W==="toUser"&&e.jsxs("div",{className:"space-y-3",children:[Lt.length===0?e.jsx("div",{className:"text-sm text-gray-600",children:"لا يوجد مستخدمون مسجلون. قم بإضافة مستخدم أولاً."}):e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"اختر المستخدم الذي سيتسلم الورديه"}),e.jsx("div",{className:"space-y-2 max-h-40 overflow-auto",children:Lt.map((N,k)=>e.jsxs("div",{className:`flex items-center justify-between rounded border px-3 py-2 cursor-pointer ${(je==null?void 0:je.username)===N.username?"bg-indigo-50 border-indigo-200":""}`,onClick:()=>We(N),children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:N.name}),e.jsx("div",{className:"text-xs text-gray-500",children:N.username})]}),e.jsx("span",{className:"text-xs text-gray-400",children:"اختيار"})]},k))})]}),e.jsxs("div",{children:[e.jsx(H,{className:"mb-1 block",children:"كلمة سر المستخدم المحدد"}),e.jsx(U,{type:"password",autoComplete:"off",value:Me,onChange:N=>Qe(N.target.value),placeholder:"أدخل كلمة السر"})]}),G&&e.jsx("div",{className:"text-xs text-red-600",children:G})]}),W==="toAdmin"&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm text-gray-600",children:"أدخل كلمة مرور الحساب الرئيسي لتسليم الورديه والخروج إلى الأدمن."}),e.jsx(U,{type:"password",autoComplete:"off",value:se,onChange:N=>xe(N.target.value),placeholder:"كلمة المرور"}),re&&e.jsx("div",{className:"text-xs text-red-600",children:re})]})]}),e.jsx(Ge,{className:"flex gap-2 justify-between",children:e.jsx(h,{disabled:fe||!W,onClick:async()=>{if(W){Z(!0);try{const N=await m();if(W==="toUser"){if(!je){ue("يرجى اختيار المستخدم أولاً"),Z(!1);return}if(Me.trim()!==je.password){ue("كلمة السر غير صحيحة"),Z(!1);return}I(),D({name:je.name,username:je.username}),s(),rt(`${je.name} (${je.username})`);try{localStorage.setItem("lastHandoverToAdmin","false")}catch{}_(!1),ne(null),We(null),Qe(""),ue(""),u(!1),Et(N),Le(null),ht(""),ze(!0)}else if(W==="toAdmin"){X("");const k=(S==null?void 0:S.email)||"";if(!k){X("لا يوجد بريد للمستخدم الرئيسي للتحقق"),Z(!1);return}const{error:K}=await A(k,se);if(K){X("كلمة المرور غير صحيحة"),Z(!1);return}I(),D(null);try{localStorage.setItem("lastHandoverToAdmin","true")}catch{}xe(""),_(!1),u(!1),rt("الأدمن الرئيسي"),Et(N),Le(null),ht(""),ze(!0)}}catch{ue("حدث خطأ أثناء التسليم، حاول مرة أخرى")}finally{Z(!1)}}},children:"تأكيد التسليم"})})]})}),e.jsx(ce,{open:Q,onOpenChange:ze,children:e.jsxs(de,{className:"sm:max-w-lg",hideClose:!0,disableOutsideClose:!0,disableEscClose:!0,children:[e.jsx(me,{children:e.jsx(he,{children:"تقرير تسليم الورديه والخروج"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsxs("div",{className:"text-sm",children:["تم تسليم الورديه إلى: ",e.jsx("span",{className:"font-semibold",children:gt})]}),v&&e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["بداية الورديه: ",new Date(v).toLocaleString("ar-EG")]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نهاية الورديه: ",new Date().toLocaleString("ar-EG")]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(H,{className:"mb-1 block",children:"الفلوس النقدية المستلمة"}),e.jsx(U,{type:"number",value:Dt,readOnly:!0,disabled:!0,placeholder:"قيمة مسجلة عند بداية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"قيمة غير قابلة للتعديل؛ تُسجّل عند الدخول."})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(H,{className:"mb-1 block",children:"أرصدة المحافظ المستلمة (إجمالي)"}),e.jsx(U,{type:"number",value:st,readOnly:!0,disabled:!0,placeholder:"إجمالي مسجل عند بداية الورديه"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(H,{className:"mb-1 block",children:"الفلوس النقدية المسلمة"}),e.jsx(U,{type:"number",value:L,onChange:N=>{const k=parseFloat(N.target.value);ye(Number.isFinite(k)?k:0)},placeholder:"أدخل قيمة النقدية المسلمة عند نهاية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"ادخال يدوي لقيمة النقدية المسلّمة عند نهاية الورديه"})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(H,{className:"mb-1 block",children:"أرصدة المحافظ المسلمة (إجمالي)"}),e.jsx(U,{type:"number",value:Oe,onChange:N=>{const k=parseFloat(N.target.value);at(Number.isFinite(k)?k:0)},placeholder:"أدخل إجمالي أرصدة المحافظ المسلّمة"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"يمكنك إدخال الإجمالي يدوياً؛ التفصيل يُحفظ إن لزم"})]})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-1",children:"أرباح الوردية"}),e.jsx("div",{className:["text-sm",(L??0)+(Oe??0)-((parseFloat(Dt||"0")||0)+(st??0))>=0?"text-green-700":"text-red-700"].join(" "),children:Math.round(((L??0)+(Oe??0)-((parseFloat(Dt||"0")||0)+(st??0)))*100)/100}),e.jsx("div",{className:"text-xs text-gray-600",children:"محسوبة: (المسلّم − المستلم) للنقدية + المحافظ"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"هل يوجد عجز؟"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(h,{variant:St==="no"?"default":"secondary",onClick:()=>Le("no"),children:"لا"}),e.jsx(h,{variant:St==="yes"?"default":"secondary",onClick:()=>Le("yes"),children:"نعم"})]}),St==="yes"&&e.jsxs("div",{children:[e.jsx(H,{className:"mb-1 block",children:"مبلغ العجز"}),e.jsx(U,{type:"number",value:Ct,onChange:N=>ht(N.target.value),placeholder:"أدخل مبلغ العجز"})]})]})]}),e.jsx(Ge,{className:"flex gap-2 justify-between",children:e.jsx(h,{onClick:()=>{const N=St==="yes",k=parseFloat(Ct)||0;(async()=>await E(mt,N,k))(),f({title:"تم إضافة إيصال تسليم الورديه",description:"أُضيف الإيصال إلى المعاملات الأخيرة بعنوان إيصال تسليم وردية"}),ze(!1)},children:"تأكيد وحفظ الإيصال"})})]})})]})},Ph=({open:i,onOpenChange:u})=>{const{shiftUser:c,endShift:p,setShiftUser:v}=Sr(),[D,s]=n.useState(""),[I,M]=n.useState(""),[S,A]=n.useState([]),{user:P}=Us();n.useEffect(()=>{(async()=>{try{if(P!=null&&P.uid){const w=$e(J,"profiles",P.uid,"cashierUsers","list"),T=await da(w);if(T.exists()){const V=T.data(),O=Array.isArray(V==null?void 0:V.users)?V.users:[];if(O&&O.length>0){A(O);return}}}}catch{}try{const w=`cashierUsers_${(P==null?void 0:P.uid)||"default"}`;let T=localStorage.getItem(w);if(!T){const V=localStorage.getItem("cashierUsers");V&&(T=V)}A(T?JSON.parse(T):[])}catch{A([])}})()},[i,P==null?void 0:P.uid]),n.useEffect(()=>{if(!i||!(P!=null&&P.uid))return;const w=$e(J,"profiles",P.uid,"cashierUsers","list"),T=Bs(w,V=>{if(V.exists()){const O=V.data(),q=Array.isArray(O==null?void 0:O.users)?O.users:[];if(q&&q.length>0)A(q);else try{const Y=`cashierUsers_${(P==null?void 0:P.uid)||"default"}`;let ae=localStorage.getItem(Y);if(!ae){const _=localStorage.getItem("cashierUsers");_&&(ae=_)}A(ae?JSON.parse(ae):[])}catch{A([])}}},V=>{console.warn("ShiftProfileDialog cashierUsers snapshot error:",V)});return()=>T()},[i,P==null?void 0:P.uid]);const f=async()=>{if(M(""),!c)return;const w=S.find(T=>T.username===c.username);if(!w){M("لا يوجد مستخدم مطابق لهذه الوردية");return}if(D.trim()!==w.password){M("الرقم السري غير صحيح");return}p(),v(null),s(""),u(!1)};return e.jsx(ce,{open:i,onOpenChange:w=>{s(""),M(""),u(w)},children:e.jsxs(de,{className:"sm:max-w-md",children:[e.jsx(me,{children:e.jsx(he,{children:"بروفيل الوردية"})}),c?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"rounded-lg border p-3 bg-gradient-to-r from-blue-50 to-indigo-50",children:[e.jsx("div",{className:"text-sm font-semibold text-gray-800",children:c.name}),e.jsx("div",{className:"text-xs text-gray-600",children:c.username})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{className:"block",children:"أدخل الرقم السري لتسليم الوردية"}),e.jsx(U,{type:"password",value:D,onChange:w=>s(w.target.value),placeholder:"الرقم السري للمستخدم",dir:"ltr"}),I&&e.jsx("div",{className:"text-red-600 text-xs",children:I})]})]}):e.jsx("div",{className:"text-sm text-gray-600",children:"لا يوجد مستخدم وردية نشط حالياً"}),e.jsxs(Ge,{className:"flex justify-between",children:[e.jsx(h,{variant:"outline",onClick:()=>u(!1),children:"إغلاق"}),e.jsx(h,{onClick:f,disabled:!c,children:"تسليم الوردية"})]})]})})},kh=({open:i,onOpenChange:u})=>e.jsx(ce,{open:i,onOpenChange:u,children:e.jsxs(de,{className:"sm:max-w-lg rounded-2xl",children:[e.jsxs(me,{children:[e.jsxs(he,{className:"text-right flex items-center gap-2 justify-end",children:[e.jsx(ji,{className:"w-5 h-5"}),"سجل التغييرات الأخيرة"]}),e.jsx(ss,{className:"text-right",children:"هذه أبرز التحسينات التي تمت مؤخرًا في الواجهة."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(jo,{className:"w-5 h-5 text-amber-600 mt-1"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold",children:"تحسين نافذة تعديل المديونية"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"استبدال نافذة الإدخال القديمة (prompt) بحوار أنيق لإدخال المبلغ مع تأكيد."})]})]}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Nm,{className:"w-5 h-5 text-violet-600 mt-1"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold",children:"تحديث شاشة التحميل"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:'تغيير النص إلى "صلي علي النبي" مع خط عربي جميل ونبض لطيف.'})]})]}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(ji,{className:"w-5 h-5 text-green-600 mt-1"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold",children:"بطاقات الأرباح وعدد العمليات"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"إضافة بطاقات عرض أرباح الفترة الحالية وعدد العمليات في تفاصيل المحفظة."})]})]}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(ji,{className:"w-5 h-5 text-blue-600 mt-1"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold",children:"إصلاح تمرير نافذة اليومية"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"منع تمرير الصفحة الخلفية عند فتح نافذة اليومية لراحة الاستخدام."})]})]})]}),e.jsx("div",{className:"flex justify-end gap-2 mt-6",children:e.jsx(h,{variant:"secondary",onClick:()=>u(!1),children:"إغلاق"})})]})});class Ua{static async processTransfer(u){const{amount:c,currentCashBalance:p,currentWalletBalances:v,wallets:D,selectedWalletId:s}=u;if(c<=0)return{success:!1,newCashBalance:p,newWalletBalances:v,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(s&&!u.skipRemoteLimitsCheck)try{const A=await As.canPerformOperation(s,c,"transfer");if(!A.canPerform)return{success:!1,newCashBalance:p,newWalletBalances:v,message:A.message||"تم تجاوز الحد الأقصى",error:"LIMIT_EXCEEDED"}}catch(A){return console.error("خطأ في التحقق من حدود التحويل:",A),{success:!1,newCashBalance:p,newWalletBalances:v,message:"خطأ في التحقق من حدود التحويل",error:"LIMIT_CHECK_ERROR"}}if(c<=0)return{success:!1,newCashBalance:p,newWalletBalances:v,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(s){const A=Math.max(v[s]||0,0);if(A<c){const P=D.find(f=>f.id===s);return{success:!1,newCashBalance:p,newWalletBalances:v,message:`رصيد غير كافي في المحفظة${P?` ${P.name}`:""}. المتاح: ${A} جنيه، المطلوب: ${c} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"}}}else{const A=Ua.calculateTotalWalletBalance(v);if(A<c)return{success:!1,newCashBalance:p,newWalletBalances:v,message:`رصيد غير كافي في المحافظ. الرصيد المتاح: ${A} جنيه، المبلغ المطلوب: ${c} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"}}const I={...v};if(s){const A=I[s]||0;I[s]=A-c}else{let A=c;for(const P of D){if(A<=0)break;const f=Math.max(I[P.id]||0,0),w=Math.min(f,A);w>0&&(I[P.id]=(I[P.id]||0)-w,A-=w)}}const M=p+c;if(s)try{const A=As.updateUsage(s,c,"transfer");u.nonBlockingUsageUpdate?A.catch(P=>console.error("خطأ في تحديث استخدام المحفظة:",P)):await A}catch(A){console.error("خطأ في تحديث استخدام المحفظة:",A)}let S="تم التحويل بنجاح";if(s){const A=I[s]||0;A<0&&(S=`تم التحويل بنجاح مع تحذير: رصيد محفظة ${s} أصبح ${A} جنيه.`)}return{success:!0,newCashBalance:M,newWalletBalances:I,message:S}}static processDeposit(u){const{amount:c,currentCashBalance:p,currentWalletBalances:v,wallets:D}=u;if(c<=0)return{success:!1,newCashBalance:p,newWalletBalances:v,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};const s=this.calculateTotalWalletBalance(v);if(s<c)return{success:!1,newCashBalance:p,newWalletBalances:v,message:`رصيد غير كافي في المحافظ. الرصيد المتاح: ${s} جنيه، المبلغ المطلوب: ${c} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"};const I=p+c,M={...v};let S=c;const A=D.find(f=>f.isDefault);if(A&&M[A.id]>=S)M[A.id]-=S,S=0;else for(const f of D){if(S<=0)break;const w=M[f.id]||0;if(w>0){const T=Math.min(w,S);M[f.id]=w-T,S-=T}}const P=S>0?`تم الإيداع جزئياً. تم إيداع ${c-S} جنيه في صندوق النقدية`:`تم الإيداع بنجاح. تم إضافة ${c} جنيه إلى صندوق النقدية`;return{success:!0,newCashBalance:I,newWalletBalances:M,message:P}}static async processWithdraw(u){const{amount:c,currentCashBalance:p,currentWalletBalances:v,wallets:D,selectedWalletId:s}=u;if(c<=0)return{success:!1,newCashBalance:p,newWalletBalances:v,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(s&&!u.skipRemoteLimitsCheck)try{const A=await As.canPerformOperation(s,c,"withdraw");if(!A.canPerform)return{success:!1,newCashBalance:p,newWalletBalances:v,message:A.message||"تم تجاوز الحد الأقصى",error:"LIMIT_EXCEEDED"}}catch(A){return console.error("خطأ في التحقق من حدود السحب:",A),{success:!1,newCashBalance:p,newWalletBalances:v,message:"خطأ في التحقق من حدود السحب",error:"LIMIT_CHECK_ERROR"}}if(p<c)return{success:!1,newCashBalance:p,newWalletBalances:v,message:`رصيد غير كافي في صندوق النقدية. الرصيد المتاح: ${p} جنيه، المبلغ المطلوب: ${c} جنيه`,error:"INSUFFICIENT_CASH_BALANCE"};const I=p-c,M={...v},S=s?D.find(A=>A.id===s):D.find(A=>A.isDefault)||D[0];if(S){const A=M[S.id]||0;M[S.id]=A+c}else return{success:!1,newCashBalance:p,newWalletBalances:v,message:"لا توجد محافظ متاحة لإضافة المبلغ إليها",error:"NO_WALLETS_AVAILABLE"};if(s)try{const A=As.updateUsage(s,c,"withdraw");u.nonBlockingUsageUpdate?A.catch(P=>console.error("خطأ في تحديث استخدام المحفظة:",P)):await A}catch(A){console.error("خطأ في تحديث استخدام المحفظة:",A)}return{success:!0,newCashBalance:I,newWalletBalances:M,message:`تم السحب بنجاح. تم إضافة ${c} جنيه إلى محفظة ${(S==null?void 0:S.name)||""}`}}static validateOperation(u,c){return u<=0?{valid:!1,error:"المبلغ يجب أن يكون أكبر من الصفر"}:!c||c.length===0?{valid:!1,error:"لا توجد محافظ متاحة"}:{valid:!0}}static calculateTotalWalletBalance(u){return Object.values(u).reduce((c,p)=>c+Math.max(p,0),0)}static deductFromWalletsAddToCash(u,c,p,v){return this.processTransfer({amount:u,currentCashBalance:c,currentWalletBalances:p,wallets:v})}static deductFromWalletsAddToCashDeposit(u,c,p,v){return this.processDeposit({amount:u,currentCashBalance:c,currentWalletBalances:p,wallets:v})}static deductFromCashAddToWallets(u,c,p,v){return this.processWithdraw({amount:u,currentCashBalance:c,currentWalletBalances:p,wallets:v})}static applyTransactionResult(u,c,p){u.success&&(c(u.newCashBalance),p(u.newWalletBalances))}static validateTransaction(u,c,p,v){if(u<=0)return{isValid:!1,error:"المبلغ يجب أن يكون أكبر من الصفر"};if(c==="transfer"){const D=this.calculateTotalWalletBalance(v);if(D<u)return{isValid:!1,error:`الرصيد المتاح في المحافظ (${D} جنيه) غير كافي للمبلغ المطلوب (${u} جنيه)`}}else if(c==="withdraw"){if(p<u)return{isValid:!1,error:`الرصيد المتاح في صندوق النقدية (${p} جنيه) غير كافي للمبلغ المطلوب (${u} جنيه)`}}else if(c==="deposit"){const D=this.calculateTotalWalletBalance(v);if(D<u)return{isValid:!1,error:`الرصيد المتاح في المحافظ (${D} جنيه) غير كافي للمبلغ المطلوب (${u} جنيه)`}}return{isValid:!0}}static getDeductionPreview(u,c,p){const v=[];let D=u;for(const s of p){if(D<=0)break;const I=c[s.id]||0,M=Math.min(Math.max(I,0),D);M>0&&(v.push({walletId:s.id,walletName:s.name,currentBalance:I,deductedAmount:M,newBalance:I-M}),D-=M)}return v}}let fr=null;function Oh(){const i=window;if(!fr){const u=i.AudioContext||i.webkitAudioContext;fr=new u}return fr.state==="suspended"&&fr.resume(),fr}function Eh(i,u,c){const p=c/1e3,v=Math.floor(i.sampleRate*p),D=i.createBuffer(1,v,i.sampleRate),s=D.getChannelData(0);for(let A=0;A<v;A++)s[A]=(Math.random()*2-1)*.6;const I=i.createBufferSource();I.buffer=D;const M=i.createBiquadFilter();M.type="highpass",M.frequency.value=1500,M.Q.value=.7;const S=i.createGain();S.gain.setValueAtTime(1e-4,u),S.gain.exponentialRampToValueAtTime(.4,u+.015),S.gain.exponentialRampToValueAtTime(1e-4,u+p),I.connect(M),M.connect(S),S.connect(i.destination),I.start(u),I.stop(u+p+.01)}function _h(i,u,c,p,v,D="triangle"){const s=i.createOscillator(),I=i.createGain();s.type=D;const M=v/1e3;s.frequency.setValueAtTime(c,u),s.frequency.linearRampToValueAtTime(p,u+M),I.gain.setValueAtTime(1e-4,u),I.gain.exponentialRampToValueAtTime(.25,u+.02),I.gain.exponentialRampToValueAtTime(1e-4,u+M),s.connect(I),I.connect(i.destination),s.start(u),s.stop(u+M+.02)}function Wh(){try{const i=Oh(),u=i.currentTime;Eh(i,u,90),_h(i,u+.12,1900,1100,180,"sawtooth")}catch{}}function Fh(i){if(!i)return!1;const c=i.replace(/[^0-9٠-٩]/g,"").replace(/[٠-٩]/g,p=>"0123456789"["٠١٢٣٤٥٦٧٨٩".indexOf(p)]);return/^(010|011|012|015)[0-9]{8}$/.test(c)}function Mh({userId:i}){const[u,c]=Ve.useState(null),[p,v]=Ve.useState("");return null}const Bu=()=>{var Hl,Gl,Ql,Zl,Xl,eo;console.log("🔥 UserDashboardPage component is loading...");const{toast:i}=Ps(),u=n.useRef(null),[c,p]=n.useState(0),v=async()=>{var r,l,o;const t="alkaptin678678@gmail.com",a=(l=(r=$a.currentUser)==null?void 0:r.email)==null?void 0:l.toLowerCase();if(!a||a!==t){i({title:"قيد التطوير",description:"هذه الميزة غير متاحة حالياً."});return}if(!Ur||!zr||!qr){i({title:"بيانات ناقصة",description:"أدخل رقم الموبايل، الشركة والمبلغ",variant:"destructive"});return}try{Il(!0);const d=await((o=$a.currentUser)==null?void 0:o.getIdToken()),x=await fetch("/api/topup",{method:"POST",headers:{"Content-Type":"application/json",...d?{Authorization:`Bearer ${d}`}:{}},body:JSON.stringify({phone:Ur,countryCode:"EG",operator:zr,amount:Number(qr),useLocalAmount:!0})}),g=await x.json().catch(()=>({}));x.ok&&(g!=null&&g.success)?(i({title:"تم الشحن",description:(g==null?void 0:g.message)||"تم تنفيذ عملية الشحن بنجاح"}),li(!1),jl(""),Sl(""),Dl("")):i({title:"فشل الشحن",description:(g==null?void 0:g.message)||"حدث خطأ أثناء طلب الشحن",variant:"destructive"})}catch(d){console.error("Topup request error:",d),i({title:"خطأ غير متوقع",description:"تعذّر تنفيذ عملية الشحن. حاول لاحقاً.",variant:"destructive"})}finally{Il(!1)}},{signOut:D,user:s,profile:I}=Us(),M=((s==null?void 0:s.email)||"").toLowerCase()==="vodafonecash00@gmail.com",S=bo(),A=fo(),P=rm(),{isShiftActive:f,shiftUser:w}=Sr(),{shopId:T,shopName:V}=vn(),O=nm();(()=>{try{return!!window.electronAPI||typeof navigator<"u"&&navigator.userAgent.toLowerCase().includes("electron")||typeof window<"u"&&window.location&&window.location.protocol==="file:"}catch{return!1}})();const[q,Y]=n.useState(!1),[ae,_]=n.useState(!1),[W,ne]=n.useState(!1),[se,xe]=n.useState(!1),[re,X]=n.useState([]),[Se,Ae]=n.useState(""),[je,We]=n.useState(""),[Me,Qe]=n.useState(""),[G,ue]=n.useState(""),[fe,Z]=n.useState(!1),[Q,ze]=n.useState(!1),[mt,Et]=n.useState(null),[St,Le]=n.useState(""),[Ct,ht]=n.useState(""),[Dt,be]=n.useState(!1);n.useEffect(()=>{const t=P==null?void 0:P.shopId;if(t&&(s!=null&&s.uid))try{const a=`selectedShopId_${s.uid}`;localStorage.setItem(a,String(t)),window.dispatchEvent(new Event("selectedShopIdChanged"))}catch{}},[P==null?void 0:P.shopId,s==null?void 0:s.uid]);const[st,ms]=n.useState([]),[_t,Wt]=n.useState(()=>{try{return localStorage.getItem("cashySelectedDevice")||null}catch{return null}}),L=t=>!!(t&&st.some(a=>a.id===t));async function ye(){const t=window.electronAPI,a=_t||"";if(!t||typeof t.sendUssd!="function")return null;if(!a)return i({title:"الجهاز غير محدد",description:"اتصل بالموبايل أولاً ثم اختر الجهاز من القائمة",variant:"destructive"}),null;if(L(a))return a;try{const d=st.find(x=>x&&x.id&&!String(x.id).includes(":"));if(d&&d.id)return Wt(d.id),d.id}catch{}const r=a.includes(":")?a.split(":").slice(0,2).join(":"):"";if(r&&typeof t.connectWifi=="function"){try{await t.connectWifi(r)}catch{}if(await new Promise(d=>setTimeout(d,250)),L(a))return a}const l=a.split(":")[0],o=st.find(d=>(d.id.startsWith(l)||d.id.includes(l))&&d.id.includes(":"));if(o!=null&&o.id){const d=o.id.split(":").slice(0,2).join(":");if(!L(o.id)&&typeof t.connectWifi=="function"){try{await t.connectWifi(d)}catch{}await new Promise(x=>setTimeout(x,250))}if(L(o.id))return Wt(o.id),o.id}return i({title:"الجهاز غير متصل",description:"فعّل Wireless debugging أو استخدم اتصال Wi‑Fi ثم أعد المحاولة",variant:"destructive"}),null}n.useEffect(()=>{const t=window.electronAPI;t&&typeof t.onAdbDevices=="function"&&t.onAdbDevices(a=>{var o;const r=Array.isArray(a)?a:[];ms(r);const l=(()=>{try{return localStorage.getItem("cashySelectedDevice")||""}catch{return""}})();l&&r.some(d=>d.id===l)?Wt(l):(o=r[0])!=null&&o.id?Wt(d=>d||r[0].id):Wt(null)})},[]);function Oe(t,a){try{const r=Zt==null?void 0:Zt(),l=(r==null?void 0:r.phone)||"";if(!l){i({title:"يجب اختيار محفظة",description:"اختر محفظة المُرسل أولاً",variant:"destructive"});return}mm(l,t,a),i({title:"تم إرسال كود التحويل",description:"تم تنفيذ الاتصال مباشرة على الهاتف"}),ga(!1),Ea(!1)}catch(r){const l=(r==null?void 0:r.message)||"تعذر إرسال الكود — تحقق من البيانات";throw i({title:"فشل الإرسال",description:l,variant:"destructive"}),r}}const at=async()=>{var r;if(!xs||!xs.receiver||!xs.amount){i({title:"بيانات غير مكتملة",description:"تأكد من إدخال رقم المستقبل والمبلغ قبل الإرسال",variant:"destructive"});return}const t=String(xs.receiver),a=Math.round(Number(xs.amount));fa(!0);try{if((r=no)!=null&&r.isNativePlatform&&no.getPlatform()==="android"){const o=Zt==null?void 0:Zt(),d=(o==null?void 0:o.phone)||"";if(!d){i({title:"يجب اختيار محفظة",description:"اختر محفظة المُرسل أولاً",variant:"destructive"}),fa(!1);return}const x=io(d,t,a);if(!x){i({title:"رقم غير مدعوم",description:"تحقق من بداية الرقم 010/011/012/015",variant:"destructive"}),fa(!1);return}dm(x),i({title:"تم إرسال كود التحويل",description:"تم تنفيذ الاتصال مباشرة على الهاتف"}),ga(!1),Ea(!1);return}const l=window.electronAPI;if(l&&typeof l.sendUssd=="function"&&_t){const o=Zt==null?void 0:Zt(),d=(o==null?void 0:o.phone)||"";if(!d){i({title:"يجب اختيار محفظة",description:"اختر محفظة المُرسل أولاً",variant:"destructive"}),fa(!1);return}const x=await ye();if(!x){fa(!1);return}const g=io(d,t,a);if(!g){i({title:"رقم غير مدعوم",description:"تحقق من بداية الرقم 010/011/012/015",variant:"destructive"}),fa(!1);return}try{const C=typeof l.pickSimAutomatically=="function"?await l.pickSimAutomatically(x,d):{deviceId:x,slot:0},y=`${C.deviceId}:sim${C.slot}`;Oc(y),await l.sendUssd(y,g)}catch{try{await l.sendUssd(x,g)}catch(y){const j=x.includes(":")?x.split(":").slice(0,2).join(":"):"";if(j&&typeof l.connectWifi=="function")await l.connectWifi(j),await l.sendUssd(x,g);else throw y}}i({title:"تم إرسال كود التحويل",description:"تم التنفيذ بنجاح"}),ga(!1),Ea(!0)}else Oe(t,a)}catch(l){const o=l&&l.message?l.message:"حدث خطأ غير متوقع أثناء الإرسال";i({title:"خطأ أثناء الإرسال",description:`الجهاز: ${Xi||_t||"غير معروف"} — ${o}`,variant:"destructive"})}finally{fa(!1)}},kt=async(t,a)=>{const r=window.electronAPI;try{if(r&&typeof r.enterPin=="function"&&t){await r.enterPin(t,a),Ea(!1);return}const l=String((I==null?void 0:I.bridgeLink)||"").trim(),o=String((I==null?void 0:I.bridgeDeviceId)||"").trim()||void 0;if(!l){i({title:"الرابط غير مُعدّ",description:"احفظ رابط الجسر أولاً",variant:"destructive"});return}const d=String((xs==null?void 0:xs.receiver)||os||"").replace(/\D/g,""),x=Math.max(1,Math.round(Number((xs==null?void 0:xs.amount)||$t||0))||0),g=String(a||"").replace(/\D/g,""),y=(j=>{let B=(j||"").trim();return B=B.replace(/\/+$/,""),/^https?:\/\//i.test(B)||(B=`https://${B}`),B})(l);Ea(!1)}catch(l){const o=(l==null?void 0:l.message)||"حدث خطأ أثناء إدخال الرقم السري";i({title:"فشل الإدخال",description:o,variant:"destructive"})}};console.log("🔥 UserDashboardPage - user:",s?"exists":"null");const[pt,gt]=n.useState(!0),[rt,Ue]=n.useState(!0),[ft,it]=n.useState(!1),[Lt,It]=n.useState(!1),[R,we]=n.useState(""),[Pe,Ke]=n.useState(""),[Ee,Rt]=n.useState(""),[Ze,zt]=n.useState([]),[Gt,is]=n.useState(!1),[nt,Ns]=n.useState(null),[yt,zs]=n.useState(""),[ua,Ia]=n.useState(!1),[Aa,ks]=n.useState(!1),[Ta,ls]=n.useState(!1),[qa,m]=n.useState(!1),[E,F]=n.useState(""),[N,k]=n.useState(""),[K,te]=n.useState([]),[pe,le]=n.useState(!1),[Ie,ve]=n.useState(0),[oe,Qt]=n.useState(!1),[vt,Fe]=n.useState(null),[Je,Bt]=n.useState(!1),[qt,Va]=n.useState(""),[os,Pa]=n.useState(""),[$t,Ja]=n.useState(""),[xa,Oi]=n.useState(""),[bn,ka]=n.useState(!1),[wn,Nn]=n.useState(""),[rc,pa]=n.useState(""),[Ei,_i]=n.useState(""),[jn,nc]=n.useState(""),[Os,Sn]=n.useState(null),[ic,Wi]=n.useState(!1),[lc,Fi]=n.useState(!1),[oc,Dr]=n.useState(!1),[cc,Dn]=n.useState(!1),[Mi,Cn]=n.useState(null),[hs,In]=n.useState(""),[us,An]=n.useState(""),[Li,dc]=n.useState(""),[mc,Cr]=n.useState(!1),[Lh,Rh]=n.useState(null),[js,Ri]=n.useState(null),Ir=t=>{const a="٠١٢٣٤٥٦٧٨٩",r="۰۱۲۳۴۵۶۷۸۹";return(t||"").split("").map(l=>{const o=a.indexOf(l);if(o>-1)return String(o);const d=r.indexOf(l);return d>-1?String(d):l}).join("")},[tt,Tn]=n.useState(()=>{try{const t=localStorage.getItem("commissionMode")||localStorage.getItem("commissionMode_default");return t?t==="add":!0}catch{return!0}}),[ie,Bi]=n.useState("transfer"),[Xe,Fs]=n.useState([]),[qs,Pn]=n.useState("all");n.useEffect(()=>{try{if(localStorage.setItem("commissionMode",tt?"add":"deduct"),s!=null&&s.uid){const t=`commissionMode_${s.uid}`;localStorage.setItem(t,tt?"add":"deduct")}}catch{}},[tt,s==null?void 0:s.uid]),n.useEffect(()=>{try{const t=s!=null&&s.uid?localStorage.getItem(`commissionMode_${s.uid}`):null,a=localStorage.getItem("commissionMode"),r=localStorage.getItem("commissionMode_default"),l=t??a??r;l&&Tn(l==="add")}catch{}},[s==null?void 0:s.uid]);const[kn,Ka]=n.useState(!1),[hc,uc]=n.useState(null),Ar=Ve.useRef(""),$i=Ve.useRef(0);n.useEffect(()=>{const t=a=>{var l;if(kn)return;try{const o=document.activeElement;if(o){const d=(l=o.tagName)==null?void 0:l.toLowerCase();if(d==="input"||d==="textarea"||d==="select"||d==="button"||o.isContentEditable===!0)return}}catch{}const r=Date.now();if(a.key==="Enter"){const o=(Ar.current||"").trim();Ar.current="",o&&(uc(o),Ka(!0));return}a.key.length===1&&(r-($i.current||0)>100&&(Ar.current=""),Ar.current+=a.key,$i.current=r)};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[kn]);const[xc,pc]=n.useState(!1),[gc,Bh]=n.useState(null),[ee,On]=n.useState("");n.useEffect(()=>{if(!bn)return;const t=Zt(),a=parseFloat($t||"0")||0;let r=0;if(ie==="transfer"){if((t==null?void 0:t.defaultTransferCommission)!=null){const o=Number(t.defaultTransferCommission)||0;r=Math.round(o*a/1e3*100)/100}else{const o=us&&us.trim()!==""?parseFloat(us):0;r=Math.max(0,o)}const l=a+r;pa((l||0).toString())}else{if((t==null?void 0:t.defaultWithdrawCommission)!=null){const o=Number(t.defaultWithdrawCommission)||0;r=Math.round(o*a/1e3*100)/100}else{const o=hs&&hs.trim()!==""?parseFloat(hs):Math.round(a*.01*100)/100;r=Math.max(0,o)}const l=tt?a:Math.max(0,Math.round((a-r)*100)/100);pa((l||0).toString())}},[bn,$t,us,hs,ee,tt,ie]);const Zt=()=>{var a,r;let t=Re.find(l=>l.id===ee);if(!t)try{const l=localStorage.getItem(ui());if(l){const o=JSON.parse(l);if(Array.isArray(o)&&o.length>0){const x=localStorage.getItem(`selectedWallet_${(s==null?void 0:s.uid)||"default"}`)||((a=o.find(g=>g.isDefault))==null?void 0:a.id)||((r=o[0])==null?void 0:r.id);t=o.find(g=>g.id===x)}}}catch{}return t};n.useLayoutEffect(()=>{try{const t=`wallets_${(s==null?void 0:s.uid)||"default"}`;let a=localStorage.getItem(t);if(!a){const r=Object.keys(localStorage).find(l=>l.startsWith("wallets_"));r&&(a=localStorage.getItem(r)||null)}if(a){const r=JSON.parse(a);if(Array.isArray(r)&&r.length>0){Ya(r);const l=`selectedWallet_${(s==null?void 0:s.uid)||"default"}`,o=localStorage.getItem(l),d=o&&r.find(x=>x.id===o)||r.find(x=>x.isDefault)||r[0];d&&(On(d.id),Va(d.phone))}}}catch(t){console.error("تهيئة فورية للمحافظ من التخزين المحلي فشلت:",t)}},[]),n.useEffect(()=>{console.log("🔍 selectedWallet state changed to:",ee)},[ee]),n.useEffect(()=>{kl()},[s==null?void 0:s.uid]),n.useEffect(()=>{fd()},[]);const[Re,Ya]=n.useState(()=>{try{const t=Object.keys(localStorage).find(r=>r.startsWith("wallets_")),a=t?localStorage.getItem(t):null;if(a){const r=JSON.parse(a);if(Array.isArray(r))return r}}catch{}return[]}),[Ui,fc]=n.useState(""),zi=(()=>{const t=Ui.replace(/\D/g,"");return t?Re.filter(a=>(a.phone||"").replace(/\D/g,"").includes(t)):Re})(),[yc,$h]=n.useState(null),[vc,qi]=n.useState(!1),[bc,Tr]=n.useState(!1),[wc,Nc]=n.useState(null),[Uh,jc]=n.useState([]),[zh,qh]=n.useState([]),[Sc,Ha]=n.useState(!1),[En,Vi]=n.useState("daily"),[Ji,Ga]=n.useState([]),Dc=async t=>{try{if(!s)return;const a=Ds(),r=fs(),l=localStorage.getItem(a),o=localStorage.getItem(r);let d=l?parseFloat(l):lt,x=o?JSON.parse(o):{...Be};const g=t.amount||t.transferredAmount||t.withdrawnAmount||t.withdrawnAmountDetailed||0;if(t.type==="send"&&(t.fromWallet||ee)){d-=t.commission||0;const j=t.fromWallet||ee;x[j]=(x[j]||0)+g}else if(t.type==="withdraw"&&(t.fromWallet||ee)){d+=g,d-=t.commission||0;const j=t.fromWallet||ee;x[j]=Math.max(0,(x[j]||0)-g)}Jt(d),Xt(x),localStorage.setItem(a,d.toString()),localStorage.setItem(r,JSON.stringify(x));const C={cashBalance:d,walletBalances:x,lastUpdated:new Date().toISOString()},y=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(y,JSON.stringify(C));try{await De.updateUserData(s.uid,C),localStorage.removeItem(y),ke(!1)}catch(j){console.warn("تعذر حفظ الأرصدة في Firebase بعد الحذف (مزامنة تلقائية):",j),ke(!0)}try{const j=t.fromWallet||ee,B=await As.getWalletLimits(s.uid,j);if(B){const $={...B};t.type==="send"?($.dailyTransferUsed=Math.max(0,(B.dailyTransferUsed||0)-g),$.monthlyTransferUsed=Math.max(0,(B.monthlyTransferUsed||0)-g)):($.dailyWithdrawUsed=Math.max(0,(B.dailyWithdrawUsed||0)-g),$.monthlyWithdrawUsed=Math.max(0,(B.monthlyWithdrawUsed||0)-g)),await As.updateWalletLimits(s.uid,j,$)}}catch(j){console.warn("تعذر تحديث حدود المحفظة بعد الحذف (مزامنة):",j)}try{ts.removeTransactionEffects(t,s.uid)}catch(j){console.warn("تعذر تحديث التقارير بعد الحذف (مزامنة):",j)}}catch(a){console.warn("خطأ أثناء تطبيق تأثيرات الحذف محليًا:",a)}},Cc=async t=>{try{const a=Xe.find(l=>l.id===t);if(!a||!s)return;const r=Xe.filter(l=>l.id!==t);Fs(r);try{await De.removeUserTransaction(s.uid,t),await gr.permanentlyDeleteTransaction(t,s.uid)}catch(l){console.warn("تعذر الحذف النهائي من قواعد البيانات أثناء حذف الإيصال:",l)}try{const l=Ds(),o=fs(),d=localStorage.getItem(l),x=localStorage.getItem(o);let g=d?parseFloat(d):lt,C=x?JSON.parse(x):{...Be};const y=a.amount||a.transferredAmount||a.withdrawnAmount||a.withdrawnAmountDetailed||0;if(a.type==="send"&&(a.fromWallet||ee)){g-=a.commission||0;const $=a.fromWallet||ee;C[$]=(C[$]||0)+y}else if(a.type==="withdraw"&&(a.fromWallet||ee)){g+=y,g-=a.commission||0;const $=a.fromWallet||ee;C[$]=Math.max(0,(C[$]||0)-y)}Jt(g),Xt(C),localStorage.setItem(l,g.toString()),localStorage.setItem(o,JSON.stringify(C));const j={cashBalance:g,walletBalances:C,lastUpdated:new Date().toISOString()},B=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(B,JSON.stringify(j)),s!=null&&s.uid?De.updateUserData(s.uid,j).then(()=>{localStorage.removeItem(B),ke(!1)}).catch($=>{console.warn("تعذر حفظ الأرصدة في Firebase بعد الحذف، تم الاحتفاظ محليًا:",$),ke(!0)}):ke(!0)}catch(l){console.warn("تعذر عكس تأثير الأرصدة بعد الحذف:",l)}try{const l=a.fromWallet||ee,o=await As.getWalletLimits(s.uid,l);if(o){const d=a.amount||a.transferredAmount||a.withdrawnAmount||a.withdrawnAmountDetailed||0,x={...o};a.type==="send"?(x.dailyTransferUsed=Math.max(0,(o.dailyTransferUsed||0)-d),x.monthlyTransferUsed=Math.max(0,(o.monthlyTransferUsed||0)-d)):(x.dailyWithdrawUsed=Math.max(0,(o.dailyWithdrawUsed||0)-d),x.monthlyWithdrawUsed=Math.max(0,(o.monthlyWithdrawUsed||0)-d)),await As.updateWalletLimits(s.uid,l,x)}}catch(l){console.warn("تعذر تحديث حدود المحفظة بعد الحذف:",l)}try{ts.removeTransactionEffects(a,s.uid)}catch(l){console.warn("تعذر تحديث التقارير بعد الحذف:",l)}i({title:"تم الحذف نهائيًا",description:"تم حذف الإيصال نهائيًا وعكس تأثيراته على الأرصدة والحدود والتقارير."}),Tr(!1)}catch(a){console.error("خطأ أثناء حذف الإيصال:",a),i({title:"خطأ في حذف الإيصال",description:"حدث خطأ غير متوقع أثناء الحذف.",variant:"destructive"})}},Ic=async t=>{var a;try{const r=Xe.find(l=>l.id===t);if(!r||!s)return;try{const l=(a=vt==null?void 0:vt.subscription)==null?void 0:a.planType;if(l===cs.ZERO){const{dailyOperationCountService:o}=await dt(async()=>{const{dailyOperationCountService:g}=await import("./dailyOperationCountService-BUlwZZKI.js");return{dailyOperationCountService:g}},__vite__mapDeps([2,0,1]),import.meta.url),d=r.type==="send"?"transfer":"withdraw";if(!(await o.checkAndIncrement(s.uid,d,5)).allowed){i({title:"تم بلوغ حد باقة الزيرو",description:"مسموح بحد أقصى 5 تأكيدات يوميًا للتحويل/السحب. جرّب غدًا أو قم بالترقية.",variant:"destructive"});return}}else if(l===cs.TAHWEELA){const{dailyOperationCountService:o}=await dt(async()=>{const{dailyOperationCountService:g}=await import("./dailyOperationCountService-BUlwZZKI.js");return{dailyOperationCountService:g}},__vite__mapDeps([2,0,1]),import.meta.url),d=r.type==="send"?"transfer":"withdraw";if(!(await o.checkAndIncrementCombined(s.uid,d,40)).allowed){i({title:"تم بلوغ حد باقة تحويله",description:"هذه الباقة تسمح بحد أقصى 40 عملية تحويل/سحب يومياً.",variant:"destructive"});return}}}catch(l){console.warn("تعذر التحقق من حد التأكيد اليومي:",l)}await Ls($e(J,"userTransactions",t),{status:"completed",confirmedAt:new Date}),Fs(l=>l.map(o=>o.id===t?{...o,status:"completed"}:o)),i({title:"تم الإكمال",description:"تم وسم المعاملة كمكتملة."}),Tr(!1)}catch(r){console.error("خطأ أثناء إكمال الإيصال:",r),i({title:"فشل الإكمال",description:"حدث خطأ غير متوقع أثناء تحديث الحالة.",variant:"destructive"})}};n.useEffect(()=>{if(s)try{const t=et(_e(J,"deletedTransactions"),Ce("userId","==",s.uid)),a=Bs(t,r=>{r.docChanges().forEach(l=>{if(l.type!=="added")return;const o=l.doc.data(),d=o==null?void 0:o.originalTransactionId;d&&Fs(x=>{const g=x.find(y=>y.id===d);return g?((async()=>await Dc(g))(),x.filter(y=>y.id!==d)):x})})},r=>{console.warn("فشل الاشتراك في deletedTransactions:",r)});return()=>a()}catch(t){console.warn("تعذر إنشاء مستمع deletedTransactions:",t)}},[s==null?void 0:s.uid]),n.useEffect(()=>{if(s)try{const t=$e(J,"users",s.uid),a=Bs(t,async r=>{if(!r.exists())return;const l=r.data();if(l!=null&&l.reportsData)try{await ts.syncReportsDataFromFirebase(s.uid),jc(hr())}catch(o){console.warn("تعذر مزامنة reportsData من السحابة:",o)}},r=>{console.warn("فشل الاشتراك في users.reportsData:",r)});return()=>a()}catch(t){console.warn("تعذر إنشاء مستمع users.reportsData:",t)}},[s==null?void 0:s.uid]);const[Ki,Ac]=n.useState(""),Yi=jh(Ki,300),[Pr,Hi]=n.useState(""),[kr,Gi]=n.useState(""),[Vs,Vh]=n.useState(""),[_n,Oa]=n.useState(!1),[Qi,Qa]=n.useState(!1),[Tc,ga]=n.useState(!1),[Vt,Wn]=n.useState(null),[xs,Pc]=n.useState(null),[Zi,fa]=n.useState(!1),[kc,Ea]=n.useState(!1),[Xi,Oc]=n.useState(""),[Ec,Fn]=n.useState(!1),el=!1,[_c,Or]=n.useState(!1),[Wc,Er]=n.useState(!1),[Fc,_r]=n.useState(!1),[Mc,tl]=n.useState(!0),[Za,Lc]=n.useState(!1),[Rc,Wr]=n.useState(!1),[Bc,sl]=n.useState(()=>{try{const t=s!=null&&s.uid?`dailyReportsLockEnabled_${s==null?void 0:s.uid}`:"dailyReportsLockEnabled";return(localStorage.getItem(t)??localStorage.getItem("dailyReportsLockEnabled"))==="true"}catch{return!1}}),[$c,Mn]=n.useState(!1);n.useEffect(()=>{try{const t=s!=null&&s.uid?`dailyReportsLockEnabled_${s==null?void 0:s.uid}`:"dailyReportsLockEnabled",a=localStorage.getItem(t)??localStorage.getItem("dailyReportsLockEnabled");sl(a==="true")}catch{}},[s==null?void 0:s.uid]);const[Uc,_a]=n.useState(!1),[zc,Ln]=n.useState(!1),[qc,al]=n.useState(()=>{try{const t=s==null?void 0:s.uid,a=t?`debtsPinRequired_${t}`:"debtsPinRequired";return(localStorage.getItem(a)??localStorage.getItem("debtsPinRequired"))==="true"}catch{return!1}}),[Vc,rl]=n.useState(!1),[nl,Jc]=n.useState(null),[At,ps]=n.useState([]),[Rn,il]=n.useState(""),[Bn,ll]=n.useState(""),[$n,ol]=n.useState(""),[ge,Xa]=n.useState(null),[Kc,ea]=n.useState(!1),[Yc,er]=n.useState(!1),[ya,cl]=n.useState(null),[dl,Un]=n.useState(""),[Fr,ml]=n.useState(null),[Jh,Kh]=n.useState(!1),[Hc,zn]=n.useState(!1),[hl,qn]=n.useState(""),[Vn,tr]=n.useState(!1),[ul,Jn]=n.useState(1),Gc=O?10:20,Kn=Ve.useMemo(()=>At.slice(0,ul*Gc),[At,ul]);n.useEffect(()=>{Vn&&Jn(1)},[Vn]);const Yn=async()=>{if(ot){i({title:"غير متاح",description:"إدارة الديون/الأجل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"});return}try{const t=await ns.hasMasterPin(s==null?void 0:s.uid);qc&&t?Ln(!0):_a(!0)}catch{_a(!0)}};n.useEffect(()=>{try{const t=s==null?void 0:s.uid,a=t?`debtsPinRequired_${t}`:"debtsPinRequired",r=localStorage.getItem(a)??localStorage.getItem("debtsPinRequired");(r==="true"||r==="false")&&al(r==="true")}catch{}},[s==null?void 0:s.uid]);const[Qc,Hn]=n.useState(!1),[Js,Gn]=n.useState([]),[Qn,xl]=n.useState(""),[Zn,pl]=n.useState(""),[Xn,gl]=n.useState(""),[fl,yl]=n.useState(""),[Zc,sr]=n.useState(!1),[Wa,ei]=n.useState(null),[gs,ar]=n.useState(null),[Mr,ti]=n.useState(""),[Xc,Fa]=n.useState(!1),[vl,Lr]=n.useState(0),[vs,ta]=n.useState(null),[va,si]=n.useState(""),[qe,ed]=n.useState(null),Ss=async t=>{try{const a=JSON.stringify(t);localStorage.setItem(Vr(),a);try{localStorage.setItem(Pl(),a)}catch{}try{localStorage.setItem(di(),Date.now().toString())}catch{}s!=null&&s.uid&&De.updateUserData(s.uid,{debts:t}).then(()=>{try{localStorage.removeItem(`debts_unsynced_${s.uid}`)}catch{}}).catch(()=>{ke(!0);try{localStorage.setItem(`debts_unsynced_${s.uid}`,"true")}catch{}})}catch(a){console.error("خطأ في حفظ الديون:",a)}},td=async()=>{try{const t=Vr(),a=Pl(),r=di(),l=localStorage.getItem(t),o=localStorage.getItem(a),d=localStorage.getItem(r),x=d?Number(d):0,g=y=>{if(!y)return null;try{const j=JSON.parse(y);return Array.isArray(j)?j.map(B=>{var $;return{...B,createdAt:($=B.createdAt)!=null&&$.toDate?B.createdAt.toDate():new Date(B.createdAt),partialPayments:Array.isArray(B.partialPayments)?B.partialPayments.map(z=>{var Ne;return{amount:Number(z.amount)||0,paidAt:(Ne=z.paidAt)!=null&&Ne.toDate?z.paidAt.toDate():new Date(z.paidAt)}}):[]}}):[]}catch(j){return console.warn("فشل في تحليل ديون localStorage:",j),null}};let C=g(l);if(!C||C.length===0){const y=g(o);if(y&&y.length>0&&(C=y,ps(y),s!=null&&s.uid))try{await Ss(y),localStorage.removeItem(a)}catch(j){console.warn("تعذر ترحيل الديون من المفتاح الافتراضي:",j)}}if(C&&C.length>0&&ps(C),s!=null&&s.uid)try{const y=`debts_unsynced_${s.uid}`,j=localStorage.getItem(y)==="true",B=await da($e(J,"users",s.uid));if(B.exists()){const $=B.data(),z=$.debts&&Array.isArray($.debts)?$.debts.map(wt=>{var Ft;return{...wt,createdAt:(Ft=wt.createdAt)!=null&&Ft.toDate?wt.createdAt.toDate():new Date(wt.createdAt),partialPayments:Array.isArray(wt.partialPayments)?wt.partialPayments.map(sa=>{var Ys;return{amount:Number(sa.amount)||0,paidAt:(Ys=sa.paidAt)!=null&&Ys.toDate?sa.paidAt.toDate():new Date(sa.paidAt)}}):[]}}):[],Ne=x&&Date.now()-x<12e4,He=j||Ne?C||[]:z&&z.length>0?z:C||[];ps(He);try{localStorage.setItem(t,JSON.stringify(He))}catch{}((z==null?void 0:z.length)||0)===0&&((He==null?void 0:He.length)||0)>0&&await De.updateUserData(s.uid,{debts:He})}else C&&C.length>0&&await De.saveUserData(s.uid,{debts:C})}catch(y){console.warn("تعذر تحميل الديون من Firebase، الاعتماد على المحلي:",y)}}catch(t){console.error("خطأ في تحميل الديون:",t)}};n.useEffect(()=>{try{window.exportDebts=()=>{try{return JSON.stringify(At||[])}catch{return"[]"}},window.importDebts=async t=>{try{const a=JSON.parse(t);if(!Array.isArray(a))throw new Error("صيغة غير صحيحة — يجب أن تكون مصفوفة");return await Ss(a),{ok:!0,count:a.length}}catch(a){return console.error("فشل استيراد الديون:",a),{ok:!1,error:String(a)}}},window.fixWalletsForCurrentUser=async t=>{try{if(!(s!=null&&s.uid))throw new Error("يجب تسجيل الدخول أولاً");return await(await dt(async()=>{const{merchantWalletService:r}=await import("./index-BaJ4CYlQ.js").then(l=>l.bi);return{merchantWalletService:r}},__vite__mapDeps([0,1]),import.meta.url)).merchantWalletService.reassignByMsisdns(t,s.uid)}catch(a){return console.error("فشل إصلاح المحافظ للمستخدم الحالي:",a),{updated:0,failed:(t==null?void 0:t.length)||0,error:String(a)}}}}catch{}},[At,s==null?void 0:s.uid]),n.useEffect(()=>{if(!(s!=null&&s.uid))return;const t=$e(J,"users",s.uid),a=Bs(t,r=>{if(!r.exists())return;const l=r.data(),o=Array.isArray(l==null?void 0:l.debts)?l.debts:[],d=`debts_unsynced_${s.uid}`,x=localStorage.getItem(d)==="true",g=localStorage.getItem(di()),C=g?Number(g):0,y=C&&Date.now()-C<12e4;if(!(x||y))try{const j=o.map(B=>{var $;return{...B,createdAt:($=B.createdAt)!=null&&$.toDate?B.createdAt.toDate():new Date(B.createdAt),partialPayments:Array.isArray(B.partialPayments)?B.partialPayments.map(z=>{var Ne;return{amount:Number(z.amount)||0,paidAt:(Ne=z.paidAt)!=null&&Ne.toDate?z.paidAt.toDate():new Date(z.paidAt)}}):[]}});ps(j);try{localStorage.setItem(Vr(),JSON.stringify(j))}catch{}}catch(j){console.warn("تعذر تحليل الديون من التحديثات الحية:",j)}},r=>{console.warn("خطأ في الاشتراك الحي لديون المستخدم:",r)});return()=>a()},[s==null?void 0:s.uid]);const sd=async()=>{if(s!=null&&s.uid){console.log("🔄 إعادة فحص حالة المستخدم...");try{await new Promise(a=>setTimeout(a,500));const t=await da($e(J,"users",s.uid));if(t.exists()){const r=t.data().isActive===!0,l=await br.checkTrialValidity(s.uid),o=l.isValid&&!l.isExpired;console.log("📊 حالة المستخدم:",{isActive:r,isOnTrial:o,hoursRemaining:l.hoursRemaining}),gt(r||o),le(o),ve(l.hoursRemaining),Qt(l.hasUsedTrial),ls(!r&&!o),console.log("✅ تم تحديث حالة المستخدم بنجاح:",{userIsActive:r||o,isOnFreeTrial:o})}}catch(t){console.error("خطأ في إعادة فحص حالة المستخدم:",t)}}},ad=async()=>{console.log("🎉 تم بدء التجربة المجانية، إعادة فحص حالة المستخدم..."),await sd()},rd=async()=>{if(s!=null&&s.uid)try{Bt(!0);const t=await ki(s.uid);Fe(t)}catch(t){console.error("خطأ في جلب بيانات الاشتراك:",t)}finally{Bt(!1)}},[Yh,Hh]=n.useState(!1),[nd,ai]=n.useState(!1),[lt,Jt]=n.useState(0),[Be,Xt]=n.useState({}),[id,bl]=n.useState(!1),[ld,wl]=n.useState(!1),[od,ri]=n.useState(!1),[cd,Rr]=n.useState(!1),[Nl,ni]=n.useState(""),[dd,rr]=n.useState(!1),[md,Br]=n.useState(!1),[ii,$r]=n.useState(""),[hd,li]=n.useState(!1),[Ur,jl]=n.useState(""),[zr,Sl]=n.useState(""),[qr,Dl]=n.useState(""),[Cl,Il]=n.useState(!1),[oi,ci]=n.useState(!1),[ud,Al]=n.useState(!1),[Tl,xd]=n.useState([]);n.useEffect(()=>{(async()=>{try{if(!(s!=null&&s.uid)||!oi)return;try{await xr.trimToMaxCount(s.uid,30)}catch{}const t=await xr.getByUser(s.uid,30);xd(t)}catch{}})()},[s==null?void 0:s.uid,oi]);const fs=()=>{const t=T||(I==null?void 0:I.shopId)||"main";return`walletBalances_${(s==null?void 0:s.uid)||"default"}_${t}`},Ds=()=>{const t=T||(I==null?void 0:I.shopId)||"main";return`cashBalance_${(s==null?void 0:s.uid)||"default"}_${t}`},Vr=()=>{const t=T||(I==null?void 0:I.shopId)||"main";return`debts_${(s==null?void 0:s.uid)||"default"}_${t}`},pd=()=>{const t=T||(I==null?void 0:I.shopId)||"main";return`customers_${(s==null?void 0:s.uid)||"default"}_${t}`},Pl=()=>`debts_default_${T||(I==null?void 0:I.shopId)||"main"}`,di=()=>{const t=T||(I==null?void 0:I.shopId)||"main";return`debts_last_write_${(s==null?void 0:s.uid)||"default"}_${t}`},mi=()=>`shopExpenses_${T||(I==null?void 0:I.shopId)||(s==null?void 0:s.uid)||"default"}`,kl=()=>{try{const t=localStorage.getItem(mi());if(t){const a=JSON.parse(t);zt(a.map(r=>({...r,createdAt:new Date(r.createdAt)})))}}catch(t){console.error("خطأ أثناء تحميل مصروفات المحل من التخزين:",t)}},Ol=async t=>{try{localStorage.setItem(mi(),JSON.stringify(t)),zt(t)}catch(a){console.error("خطأ أثناء حفظ مصروفات المحل في التخزين:",a)}},gd=async t=>{try{const a=Ze.filter(r=>r.id!==t);await Ol(a);try{if(s!=null&&s.uid&&t){const{doc:r,deleteDoc:l}=await dt(async()=>{const{doc:x,deleteDoc:g}=await import("./index-BaJ4CYlQ.js").then(C=>C.bg);return{doc:x,deleteDoc:g}},__vite__mapDeps([0,1]),import.meta.url),{db:o}=await dt(async()=>{const{db:x}=await import("./index-BaJ4CYlQ.js").then(g=>g.bh);return{db:x}},__vite__mapDeps([0,1]),import.meta.url),d=r(o,"shop_expenses",t);await l(d)}}catch(r){console.warn("تعذر حذف المصروف من السحابة الآن، تم الحذف محليًا وسيبقى مخزّنًا دون هذا الإيصال:",r)}i({title:"تم الحذف",description:"تم حذف إيصال المصروف نهائيًا."})}catch(a){console.error("خطأ أثناء الحذف النهائي لإيصال المصروف:",a),i({title:"فشل الحذف",description:"تعذر حذف الإيصال. حاول مرة أخرى.",variant:"destructive"})}};Ve.useEffect(()=>{let t;return(async()=>{try{if(!(s!=null&&s.uid)){kl();return}const{collection:a,query:r,where:l,onSnapshot:o}=await dt(async()=>{const{collection:C,query:y,where:j,onSnapshot:B}=await import("./index-BaJ4CYlQ.js").then($=>$.bg);return{collection:C,query:y,where:j,onSnapshot:B}},__vite__mapDeps([0,1]),import.meta.url),{db:d}=await dt(async()=>{const{db:C}=await import("./index-BaJ4CYlQ.js").then(y=>y.bh);return{db:C}},__vite__mapDeps([0,1]),import.meta.url),x=T||(I==null?void 0:I.shopId),g=x?r(a(d,"shop_expenses"),l("shopId","==",x)):r(a(d,"shop_expenses"),l("userId","==",s.uid));t=o(g,async C=>{const j=C.docs.map(B=>{var Ne;const $=B.data(),z=(Ne=$.createdAt)!=null&&Ne.toDate?$.createdAt.toDate():$.createdAt?new Date($.createdAt):new Date;return{id:B.id,name:String($.name||""),amount:Number($.amount||0),notes:$.notes?String($.notes):void 0,source:$.source==="wallet"?"wallet":"cash",walletId:$.walletId?String($.walletId):void 0,createdAt:z}}).sort((B,$)=>$.createdAt.getTime()-B.createdAt.getTime());zt(j);try{localStorage.setItem(mi(),JSON.stringify(j))}catch{}})}catch(a){console.error("خطأ في مزامنة مصروفات المحل من Firestore:",a)}})(),()=>t==null?void 0:t()},[s==null?void 0:s.uid,I==null?void 0:I.shopId,T]);const Jr=()=>`deficiencies_${T||(I==null?void 0:I.shopId)||(s==null?void 0:s.uid)||"default-shop"}`,fd=()=>{try{const t=Jr(),a=`deficiencies_${(s==null?void 0:s.uid)||"default"}`;if(a!==t){const l=localStorage.getItem(a),o=localStorage.getItem(t);if(l)try{const d=JSON.parse(l)||[],x=o?JSON.parse(o):[],g=Array.isArray(x)?[...x]:[],C=(y,j)=>y.some(B=>(B==null?void 0:B.id)&&(j==null?void 0:j.id)&&String(B.id)===String(j.id)||String((B==null?void 0:B.name)||"")===String((j==null?void 0:j.name)||"")&&String((B==null?void 0:B.status)||"pending")===String((j==null?void 0:j.status)||"pending"));if(Array.isArray(d))for(const y of d)C(g,y)||g.push(y);localStorage.setItem(t,JSON.stringify(g));try{localStorage.removeItem(a)}catch{}}catch{}}const r=localStorage.getItem(t);if(r){const l=JSON.parse(r);te(l.map(o=>({...o,createdAt:new Date(o.createdAt)})))}}catch(t){console.error("خطأ أثناء تحميل النواقص من التخزين:",t)}},hi=async t=>{try{localStorage.setItem(Jr(),JSON.stringify(t)),te(t)}catch(a){console.error("خطأ أثناء حفظ النواقص في التخزين:",a)}};Ve.useEffect(()=>{let t;return(async()=>{try{if(!(s!=null&&s.uid))return;const{collection:a,query:r,where:l,orderBy:o,onSnapshot:d}=await dt(async()=>{const{collection:y,query:j,where:B,orderBy:$,onSnapshot:z}=await import("./index-BaJ4CYlQ.js").then(Ne=>Ne.bg);return{collection:y,query:j,where:B,orderBy:$,onSnapshot:z}},__vite__mapDeps([0,1]),import.meta.url),{db:x}=await dt(async()=>{const{db:y}=await import("./index-BaJ4CYlQ.js").then(j=>j.bh);return{db:y}},__vite__mapDeps([0,1]),import.meta.url),g=T||(I==null?void 0:I.shopId)||s.uid||"default-shop",C=r(a(x,"deficiencies"),l("shopId","==",g),o("createdAt","desc"));t=d(C,async y=>{const j=y.docs.map(B=>{var Ne;const $=B.data(),z=(Ne=$.createdAt)!=null&&Ne.toDate?$.createdAt.toDate():$.createdAt?new Date($.createdAt):new Date;return{id:B.id,name:String($.name||""),quantity:Number($.quantity||1),status:$.status==="purchased"?"purchased":"pending",createdAt:z}});te(j);try{localStorage.setItem(Jr(),JSON.stringify(j))}catch{}},y=>{console.warn("فشل الاشتراك في النواقص من Firestore:",y)})}catch(a){console.warn("فشل إعداد مزامنة النواقص من Firestore:",a)}})(),()=>{try{t&&t()}catch{}}},[s==null?void 0:s.uid,I==null?void 0:I.shopId,T]);const yd=async t=>{try{localStorage.setItem(pd(),JSON.stringify(t)),Gn(t),s!=null&&s.uid&&await De.updateUserData(s.uid,{customers:t})}catch(a){console.error("خطأ أثناء حفظ العملاء في التخزين:",a)}},vd=async()=>{try{if(s!=null&&s.uid){const t=await da($e(J,"users",s.uid));if(t.exists()){const a=t.data();if(a.customers&&Array.isArray(a.customers)){const r=a.customers.map(l=>{var o;return{...l,createdAt:(o=l.createdAt)!=null&&o.toDate?l.createdAt.toDate():new Date(l.createdAt)}});Gn(r);return}}}Gn([])}catch(t){console.error("خطأ أثناء تحميل العملاء من Firestore:",t)}},Ma=()=>{const t=T||(I==null?void 0:I.shopId)||"main";return`transactions_${(s==null?void 0:s.uid)||"default"}_${t}`},ui=()=>{const t=T||(I==null?void 0:I.shopId)||"main";return`wallets_${(s==null?void 0:s.uid)||"default"}_${t}`},xi=()=>{const t=T||(I==null?void 0:I.shopId)||"main";return`selectedWallet_${(s==null?void 0:s.uid)||"default"}_${t}`},[pi,Kr]=n.useState(""),[ys,El]=n.useState(""),Ms=Ve.useMemo(()=>{const t=vt;if(!t)return!1;const a=im(t),r=t.planType??t.plan??null,l=typeof r=="string"?r.toLowerCase():null,o=l==="monthly"||l==="quarterly"||l==="yearly"||l==="lifetime"||r===cs.MONTHLY||r===cs.QUARTERLY||r===cs.YEARLY||r===cs.LIFETIME;return a&&o},[vt]),ot=Ve.useMemo(()=>{var l,o;const t=vt;if(!t)return!1;const a=((l=t.subscription)==null?void 0:l.planType)??((o=t.subscription)==null?void 0:o.plan)??t.planType??t.plan??null,r=typeof a=="string"?a.toLowerCase():null;return a===cs.ZERO||r==="zero"},[vt]),Ot=Ve.useMemo(()=>{var l,o;const t=vt;if(!t)return!1;const a=((l=t.subscription)==null?void 0:l.planType)??((o=t.subscription)==null?void 0:o.plan)??t.planType??t.plan??null,r=typeof a=="string"?String(a).trim().toLowerCase():null;return a===cs.TAHWEELA||r==="tahweela"||r==="تحويله"},[vt]),bd=()=>{if(!Ms){i({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}Y(!0)},[Gh,Qh]=n.useState(!1),[wd,Nd]=n.useState(!1),[jd,Sd]=n.useState(!1),[Dd,Cd]=n.useState(!1),[Id,nr]=n.useState(!1),[ba,Yr]=n.useState(""),[ir,Hr]=n.useState(""),[_l,Gr]=n.useState(!1),[La,lr]=n.useState(null),[Qr,Zr]=n.useState(""),[Ad,Wl]=n.useState(!1),[Zh,Xh]=n.useState(!1),[Td,Xr]=n.useState(!1),[Fl,gi]=n.useState(""),[Ml,fi]=n.useState(""),[Ll,Rl]=n.useState(!1),Bl=async()=>{if(s!=null&&s.uid)try{const t=`userData_${s.uid}`,a=localStorage.getItem(t),r=`debts_unsynced_${s.uid}`,l=localStorage.getItem(Vr()),o=localStorage.getItem(r)==="true";if(a){const d=JSON.parse(a);console.log("🔄 مزامنة البيانات المحلية مع Firebase...",d);const x={lastSynced:new Date().toISOString()};typeof d.cashBalance=="number"&&(x.cashBalance=d.cashBalance),d.walletBalances&&typeof d.walletBalances=="object"&&(x.walletBalances=d.walletBalances),await De.updateUserData(s.uid,x),localStorage.removeItem(t),ke(!1),console.log("✅ تمت المزامنة بنجاح وحذف البيانات المحلية")}else console.log("لا توجد بيانات محلية تحتاج للمزامنة");if(o&&l)try{const d=JSON.parse(l)||[];await De.updateUserData(s.uid,{debts:d});try{localStorage.removeItem(r)}catch{}ke(!1),console.log("✅ تمت مزامنة الديون مع Firebase")}catch(d){console.error("❌ فشل مزامنة الديون:",d),ke(!0)}}catch(t){console.error("❌ فشل في مزامنة البيانات:",t),i({title:"فشل في المزامنة",description:"حدث خطأ أثناء مزامنة البيانات مع الخادم",variant:"destructive"})}},[Ra,en]=n.useState({keepLastCount:30,intervalDays:7,lastResetAt:null});n.useEffect(()=>{(async()=>{if(s!=null&&s.uid)try{const a=await De.getUserData(s.uid),r=(a==null?void 0:a.recentReset)||{},l=Number(r==null?void 0:r.keepLastCount)>0?Number(r.keepLastCount):30,o=Number(r==null?void 0:r.intervalDays)>0?Number(r.intervalDays):7,d=y=>y instanceof Date?y:typeof(y==null?void 0:y.toDate)=="function"?y.toDate():y?new Date(String(y)):null,x=r!=null&&r.lastResetAt?d(r.lastResetAt):null,g=new Date;!x||g.getTime()-x.getTime()>=o*24*60*60*1e3?(await De.updateUserData(s.uid,{recentReset:{keepLastCount:l,intervalDays:o,lastResetAt:g}}),en({keepLastCount:l,intervalDays:o,lastResetAt:g})):en({keepLastCount:l,intervalDays:o,lastResetAt:x})}catch{en({keepLastCount:30,intervalDays:7,lastResetAt:null})}})()},[s==null?void 0:s.uid]);const $l=Ve.useMemo(()=>{const t=Xe||[],a=Ra.keepLastCount??30;return[...t].sort((l,o)=>{const d=x=>x instanceof Date?x:typeof(x==null?void 0:x.toDate)=="function"?x.toDate():new Date(String(x));return d(o.createdAt).getTime()-d(l.createdAt).getTime()}).slice(0,a)},[Xe,Ra.keepLastCount]),Pd=Ve.useMemo(()=>Math.max(0,((Xe==null?void 0:Xe.length)||0)-(Ra.keepLastCount||30)),[Xe==null?void 0:Xe.length,Ra.keepLastCount]),Ul=Ve.useCallback(()=>{let t=$l;const a=Yi.trim();if(a&&(t=t.filter(r=>r.senderPhone&&r.senderPhone.includes(a)||r.receiverPhone&&r.receiverPhone.includes(a))),Pr){const r=new Date(Pr);t=t.filter(l=>{const o=new Date(l.createdAt);if(kr){const[d,x]=kr.split(":"),g=new Date(r);g.setHours(parseInt(d),parseInt(x),0,0);const C=new Date(g);return C.setHours(C.getHours()+1),o>=g&&o<C}else return o.toDateString()===r.toDateString()})}try{t=[...t].sort((r,l)=>{const o=new Date(r.createdAt||0).getTime();return new Date(l.createdAt||0).getTime()-o})}catch{}return t},[$l,Yi,Pr,kr]),[kd,tn]=n.useState(!1),[zl,sn]=n.useState(""),[Od,an]=n.useState(!1),[yi,vi]=n.useState(""),[Ed,ke]=n.useState(!1);Re.reduce((t,a)=>t+(Be[a.id]||0),0);const _d=async t=>await ns.verifyMasterPin(t,s==null?void 0:s.uid),rn=async t=>await ns.verifyMasterPin(t,s==null?void 0:s.uid);n.useEffect(()=>{if(!(s!=null&&s.uid))return;console.log("🚀 استعادة البيانات من localStorage عند تحميل الصفحة للمستخدم:",s.uid);const t=`walletBalances_${s.uid}`,a=localStorage.getItem(t);if(a)try{const o=JSON.parse(a);console.log("📱 استعادة أرصدة المحافظ من localStorage:",o),Xt(o)}catch(o){console.error("خطأ في قراءة أرصدة المحافظ من localStorage:",o)}const r=`cashBalance_${s.uid}`;let l=localStorage.getItem(r);if(!l){const o=`userCashBalance_${s.uid}`,d=localStorage.getItem(o);if(d){l=d;try{localStorage.setItem(r,d),localStorage.removeItem(o)}catch{}}}if(l){const o=parseFloat(l);console.log("💰 استعادة رصيد الدرج النقدي من localStorage:",o),Jt(o)}},[s==null?void 0:s.uid]);const ql=async()=>{try{if(!ee)return;const t=await As.autoResetLimitsIfNeeded(ee);ed(t)}catch(t){console.error("خطأ في جلب حدود المحفظة المختارة:",t)}};n.useEffect(()=>{ql()},[ee]),n.useEffect(()=>{const t=a=>{var r;(r=a==null?void 0:a.detail)!=null&&r.walletId&&a.detail.walletId===ee&&ql()};return window.addEventListener("walletLimitsUpdated",t),()=>window.removeEventListener("walletLimitsUpdated",t)},[ee]),n.useEffect(()=>{if(S.state){if(console.log("Location state:",S.state),S.state.openDebtDialog&&(Yn(),window.history.replaceState({},document.title)),S.state.openSalesDialog&&(ot||Ot?i({title:"غير متاح",description:"بيانات المبيعات غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ka(!0),window.history.replaceState({},document.title)),S.state.openMaintenanceDialog&&(ot||Ot?i({title:"غير متاح",description:"الصيانة غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Er(!0),window.history.replaceState({},document.title)),S.state.openCreditCardsDialog&&(console.log("Opening credit cards dialog"),ot||Ot?i({title:"غير متاح",description:"كروت الائتمان غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Or(!0),window.history.replaceState({},document.title)),S.state.openShopExpensesDialog&&(ot||Ot?i({title:"غير متاح",description:"مصروفات المحل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):ns.hasMasterPin()?It(!0):it(!0),window.history.replaceState({},document.title)),S.state.openDeficienciesDialog&&(ot||Ot?i({title:"غير متاح",description:"النواقص غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):m(!0),window.history.replaceState({},document.title)),S.state.openTransactionSection){const t=document.getElementById("transaction-section");t&&t.scrollIntoView({behavior:"smooth"}),S.state.transactionType&&Bi(S.state.transactionType),S.state.startNewTransaction&&(Pa(""),Ja(""),In(""),An(""),console.log("🔒 Starting new transaction without changing wallet selection")),S.state.focusWalletSelection&&setTimeout(()=>{const a=document.querySelector('[data-testid="wallet-select"]');a&&a.focus()},500),window.history.replaceState({},document.title)}S.state.openCashierShiftModal&&(!Ms||Ot?i({title:"غير متاح",description:"وردية الكاشير متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"}):Y(!0),window.history.replaceState({},document.title)),S.state.openMachineDailyDialog&&(!Ms||Ot?i({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"}):_r(!0),window.history.replaceState({},document.title))}},[S.state,Re,Ot]),n.useEffect(()=>{S.pathname==="/user/dashboard"&&sessionStorage.getItem("previousPath")==="/user/add-wallet"&&(console.log("🔄 Returned from wallet addition page - reloading wallets"),or(),sessionStorage.removeItem("previousPath")),sessionStorage.setItem("previousPath",S.pathname)},[S.pathname,s==null?void 0:s.uid]),n.useEffect(()=>{if(!(s!=null&&s.uid))return;console.log("🔥 Setting up real-time user activation listener for:",s.uid);const t=$e(J,"users",s.uid),a=Bs(t,r=>{if(r.exists()){const l=r.data(),o=l.isActive===!0;console.log("🔥 Real-time user status update:",{userId:s.uid,isActive:o,subscription:l.subscription}),o&&!pt?(console.log("🎉 User activated! Redirecting to dashboard..."),gt(!0),ls(!1),Ue(!1)):!o&&pt&&(console.log("❌ User deactivated! Showing activation modal..."),gt(!1),ls(!0))}},r=>{console.error("❌ Error in real-time user listener:",r)});return()=>{console.log("🔥 Cleaning up real-time user listener"),a()}},[s==null?void 0:s.uid,pt]),n.useEffect(()=>{if(!(s!=null&&s.uid))return;const t=r=>{const{userId:l}=r.detail;l===s.uid&&(console.log("🎉 Subscription activation event received for current user!"),gt(!0),ls(!1),Ue(!1),setTimeout(()=>{console.log("✅ User activation completed - data updated")},1e3))},a=r=>{const{userId:l,isActive:o}=r.detail;l===s.uid&&(console.log("🔄 User subscription update event received:",{userId:l,isActive:o}),o&&!pt&&(gt(!0),ls(!1),Ue(!1),setTimeout(()=>{console.log("✅ User subscription updated - data refreshed")},1e3)))};return window.addEventListener("subscriptionActivated",t),window.addEventListener("userSubscriptionUpdated",a),()=>{window.removeEventListener("subscriptionActivated",t),window.removeEventListener("userSubscriptionUpdated",a)}},[s==null?void 0:s.uid,pt]),n.useEffect(()=>{const t=a=>{var d;const r=a.target,l=(d=r==null?void 0:r.tagName)==null?void 0:d.toLowerCase();if(!(l==="input"||l==="textarea"||l==="select"||((r==null?void 0:r.isContentEditable)??!1))&&!(a.ctrlKey||a.altKey||a.metaKey)&&!a.repeat){if((ot||Ot)&&a.key>="1"&&a.key<="9"){a.preventDefault();return}switch(a.key){case"1":break;case"2":Fn(!0);break;case"3":ot||Ot?i({title:"غير متاح",description:"كروت الائتمان غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Or(!0);break;case"4":Ms?Y(!0):i({title:"غير متاح",description:"وردية الكاشير متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});break;case"5":ot||Ot?i({title:"غير متاح",description:"بيانات المبيعات غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ka(!0);break;case"6":Yn();break;case"7":ot||Ot?i({title:"غير متاح",description:"الصيانة غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Er(!0);break;case"8":Ms?_r(!0):i({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});break;case"9":ot||Ot?i({title:"غير متاح",description:"مصروفات المحل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):ns.hasMasterPin()?It(!0):it(!0);break}}};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[ot,Ot,Ms]),n.useEffect(()=>{console.log("🔥 useEffect loadUserData started",{user:s==null?void 0:s.uid,isCheckingActivation:rt}),(async()=>{try{if(!(s!=null&&s.uid)){console.log("🔥 No user UID, setting isCheckingActivation to false"),Ue(!1);return}try{const d=await da($e(J,"users",s.uid));if(d.exists()){const g=d.data().isActive===!0,C=await br.checkTrialValidity(s.uid),y=C.isValid&&!C.isExpired;gt(g||y),le(y),ve(C.hoursRemaining),Qt(C.hasUsedTrial),ls(!g&&!y),console.log("📊 حالة المستخدم:",{isActive:g,isOnTrial:y,hoursRemaining:C.hoursRemaining,hasUsedTrial:C.hasUsedTrial})}else gt(!1),ls(!0)}catch(d){console.error("خطأ في فحص حالة تفعيل المستخدم:",d),gt(!1),ls(!0)}finally{Ue(!1)}if(console.log("🔄 بدء تحميل بيانات المستخدم من Firebase...",{userId:s==null?void 0:s.uid}),s!=null&&s.uid){const d=await De.getUserData(s.uid);if(console.log("📥 البيانات المحملة من Firebase:",d),d){const x=(d==null?void 0:d.walletBalances)||{};console.log("🏛️ اعتماد Firebase كمصدر الحقيقة لأرصدة المحافظ"),Xt(x),(d==null?void 0:d.cashBalance)!==void 0&&(console.log("💰 تحميل رصيد الدرج النقدي من Firebase:",d.cashBalance),Jt(d.cashBalance));try{const g=s!=null&&s.uid?await gr.getDeletedTransactionsByUser(s.uid):[];Ga(g||[]),console.log("🗑️ تم تحميل المعاملات المحذوفة من Firebase:",(g==null?void 0:g.length)||0)}catch(g){console.error("خطأ في تحميل المعاملات المحذوفة من Firebase:",g),Ga([])}}else{console.log("⚠️ لا توجد بيانات مستخدم في Firebase، سيتم استخدام قيم افتراضية بدون localStorage"),Xt({});try{const x=s!=null&&s.uid?await gr.getDeletedTransactionsByUser(s.uid):[];Ga(x||[])}catch{Ga([])}}}console.log("🔄 بدء تحميل المحافظ من Firebase...");try{const d=await Ws.getByMerchantId((s==null?void 0:s.uid)||"");if(d&&d.length>0){console.log("✅ تم العثور على محافظ في Firebase:",d.length);const g=d.filter(j=>j.isActive===!0).map(j=>({id:j.id,name:j.label||"محفظة بدون اسم",phone:j.msisdn,isDefault:!1,monthlyWithdrawalLimit:j.monthlyWithdrawalLimit??j.withdrawLimit??2e5,monthlyTransferLimit:j.monthlyTransferLimit??j.transferLimit??2e5,defaultTransferCommission:j.defaultTransferCommission!=null?Number(j.defaultTransferCommission):null,defaultWithdrawCommission:j.defaultWithdrawCommission!=null?Number(j.defaultWithdrawCommission):null}));Ya(g);const C=localStorage.getItem(xi());let y=null;C&&g.find(j=>j.id===C)?y=g.find(j=>j.id===C):y=g[0],y&&(On(y.id),Va(y.phone)),console.log("🔄 تم تحديث المحافظ من Firebase وحفظها في localStorage")}else console.log("⚠️ لا توجد محافظ في Firebase. سيتم عرض قائمة فارغة بدون أي استرجاع محلي."),Ya([])}catch(d){console.error("خطأ في تحميل المحافظ من Firebase:",d),Ya([])}const o=s!=null&&s.uid?await De.getUserTransactions(s.uid):[];if(o&&o.length>0){console.log("📊 تم تحميل المعاملات من Firebase:",o.length);const d=o.map(j=>({...j,createdAt:new Date(j.createdAt),senderPhone:j.senderMsisdn||j.senderPhone||"",receiverPhone:j.receiverMsisdn||j.receiverPhone||"",type:j.txnType==="send"?"send":j.txnType==="receive"?"withdraw":j.type||"withdraw",status:j.status==="confirmed"?"completed":j.status||"completed"})),x=Ji.map(j=>j.id||j.originalTransactionId);let g=[];try{const j=et(_e(J,"deletedTransactions"),Ce("userId","==",(s==null?void 0:s.uid)||""),Ce("permanent","==",!0));g=(await ct(j)).docs.map($=>{const z=$.data();return String(z.originalTransactionId||z.transactionId||$.id||"")}).filter(Boolean)}catch{}const C=new Set(g),y=d.filter(j=>{var He;const B=String(j.id||""),$=String(j.transactionId||""),z=String(j.reference||j.transactionReference||((He=j.receipt)==null?void 0:He.reference)||""),Ne=x.includes(B),bt=C.has(B)||$&&C.has($);return!Ne&&!bt});console.log("✅ تم فلترة المعاملات المحذوفة:",{total:o.length,deleted:x.length,active:y.length});{const j=z=>{var Ne;return String((z==null?void 0:z.transactionId)||(z==null?void 0:z.id)||`${(z==null?void 0:z.transactionReference)||((Ne=z==null?void 0:z.receipt)==null?void 0:Ne.reference)||"ref"}-${new Date((z==null?void 0:z.createdAt)||0).getTime()}`)},B=new Set,$=[];for(const z of y){const Ne=j(z);B.has(Ne)||(B.add(Ne),$.push(z))}Fs($);try{localStorage.setItem(Ma(),JSON.stringify($))}catch(z){console.warn("تعذر حفظ المعاملات في التخزين المحلي بعد التحميل من Firebase:",z)}}}await Bl()}catch(o){console.error("خطأ في تحميل بيانات المستخدم من Firebase:",o)}})().then(async()=>{await l(),await a(),await r()});const a=async()=>{try{if(!(s!=null&&s.uid))return;const o=await Ws.getByMerchantId(s.uid);await Promise.all(o.map(d=>sh.autoResetLimitsIfNeeded(d.id)))}catch(o){console.error("خطأ في التصفير التلقائي للحدود:",o)}},r=async()=>{try{await ts.syncReportsDataFromFirebase(s==null?void 0:s.uid);const o=ts.getReportsData(s==null?void 0:s.uid);if((o.lastDailyResetDate?ts.shouldResetDailyReports(o.lastDailyResetDate):!1)&&(s!=null&&s.uid)&&o.lastDailyResetDate){const g=new Date(o.lastDailyResetDate),C=g.toDateString(),y=Xe.filter(He=>new Date(He.createdAt).toDateString()===C&&He.status==="completed"),j=y.length,B=y.reduce((He,wt)=>He+wt.amount,0),$=y.filter(dr).reduce((He,wt)=>{const Ft=wt.withdrawnAmount!==void 0?wt.withdrawnAmount:wt.amount;return He+Ft},0),z=y.filter(mr).reduce((He,wt)=>{const Ft=wt.sentAmount!==void 0?wt.sentAmount:wt.amount;return He+Ft},0),Ne=y.reduce((He,wt)=>He+ts.calculateTransactionProfit(wt),0),bt=new Date(g).toISOString().slice(0,10);await xr.add({userId:s.uid,reportDate:bt,totalTransactions:j,totalAmount:Number(B.toFixed(2)),totalWithdrawn:Number($.toFixed(2)),totalSent:Number(z.toFixed(2)),profit:Number(Ne.toFixed(2)),walletId:null})}const x=ts.autoResetReportsIfNeeded(s==null?void 0:s.uid);(x.dailyReset||x.monthlyReset)&&console.log("تم التصفير التلقائي:",x)}catch(o){console.error("خطأ في التصفير التلقائي للتقارير:",o)}},l=async()=>{try{if(!(s!=null&&s.uid))return;const o=new Date;if(o.getDate()!==1)return;const d=`${o.getFullYear()}-${o.getMonth()+1}`,x=`lastMonthlyDbCleanup:${s.uid}`;if(localStorage.getItem(x)===d)return;const C=new Date(o.getFullYear(),o.getMonth(),1,0,0,0,0),y=$=>$ instanceof Date?$:typeof($==null?void 0:$.toDate)=="function"?$.toDate():new Date(String($));let j=[];try{const $=et(_e(J,"userTransactions"),Ce("userId","==",s.uid),Ce("createdAt","<",C));j=(await ct($)).docs}catch{const $=et(_e(J,"userTransactions"),Ce("userId","==",s.uid));j=(await ct($)).docs.filter(Ne=>{var bt;return y((bt=Ne.data())==null?void 0:bt.createdAt)<C})}await Promise.allSettled(j.map($=>ws($.ref)));let B=[];try{const $=et(_e(J,"transactions"),Ce("userId","==",s.uid),Ce("createdAt","<",C));B=(await ct($)).docs}catch{const $=et(_e(J,"transactions"),Ce("userId","==",s.uid));B=(await ct($)).docs.filter(Ne=>{var bt;return y((bt=Ne.data())==null?void 0:bt.createdAt)<C})}await Promise.allSettled(B.map($=>ws($.ref)));try{localStorage.setItem(x,d)}catch{}console.log("✅ تم تنظيف قاعدة البيانات شهريًا (Firebase فقط):",{userTransactionsDeleted:j.length,globalTransactionsDeleted:B.length,monthStart:C})}catch(o){console.error("فشل التنظيف الشهري التلقائي لقاعدة البيانات:",o)}};rd(),td(),vd(),console.log("🔥 useEffect loadUserData completed")},[s==null?void 0:s.uid]);const or=async()=>{var t;if(s!=null&&s.uid)try{const a=await Ws.getByMerchantId(s.uid);if(a&&a.length>0){const l=a.filter(o=>o.isActive===!0).map(o=>({id:o.id,name:o.label||"محفظة بدون اسم",phone:o.msisdn,isDefault:!1,monthlyWithdrawalLimit:o.monthlyWithdrawalLimit??o.withdrawLimit??2e5,monthlyTransferLimit:o.monthlyTransferLimit??o.transferLimit??2e5,defaultTransferCommission:o.defaultTransferCommission!=null?Number(o.defaultTransferCommission):void 0,defaultWithdrawCommission:o.defaultWithdrawCommission!=null?Number(o.defaultWithdrawCommission):void 0}));if(Ya(l),s!=null&&s.uid){const o=localStorage.getItem(xi());if(!!(ee&&l.find(x=>x.id===ee)))console.log("🔒 Preserving current wallet selection:",ee);else{const g=(o&&l.find(C=>C.id===o)?o:null)||((t=l[0])==null?void 0:t.id);g&&(console.log("🔄 Fixing invalid wallet selection:",g),cr(g))}}console.log("🔄 تم تحديث المحافظ من Firebase:",l.length)}}catch(a){console.error("خطأ في تحميل المحافظ من Firebase:",a)}};n.useEffect(()=>{const t=S.pathname;sessionStorage.getItem("previousPath")==="/user/add-wallet"&&t==="/user/dashboard"&&(console.log("🔄 Returning from add wallet page - reloading wallets"),console.log("🔒 Current wallet before add-wallet return reload:",ee),or(),sessionStorage.removeItem("previousPath")),sessionStorage.setItem("previousPath",t)},[S.pathname,s==null?void 0:s.uid]),n.useEffect(()=>{const t=()=>{console.log("🔄 Window focused - reloading wallets"),console.log("🔒 Current wallet before focus reload:",ee),or().then(()=>{console.log("🔒 Wallet preserved after focus reload:",ee)})};return window.addEventListener("focus",t),()=>{window.removeEventListener("focus",t)}},[s==null?void 0:s.uid,ee,Re]);const cr=(t,a="unknown")=>{console.log(`🎯 setWalletSelection called from ${a} with walletId:`,t),console.log("🔍 Previous selectedWallet:",ee),On(t);const r=Re.find(l=>l.id===t);r&&(Va(r.phone),console.log("✅ Wallet set successfully:",t,"Phone:",r.phone)),s!=null&&s.uid&&(localStorage.setItem(xi(),t),console.log("💾 Saved wallet to localStorage:",t))};n.useEffect(()=>{const t=()=>{or()};try{window.addEventListener("wallets:activation-updated",t)}catch{}return()=>{try{window.removeEventListener("wallets:activation-updated",t)}catch{}}},[s==null?void 0:s.uid]);const Wd=t=>{if(t==="__add_wallet"){A("/user/add-wallet");return}if(t==="__view_wallets"){Dr(!0);return}Bm.isEnabled(s==null?void 0:s.uid)?(Cn(t),Dn(!0)):cr(t,"walletSelectionNoPin")},nn=t=>{console.log("🔄 handleTransactionTypeChange called with type:",t),console.log("🔍 Current selectedWallet before change:",ee),console.log("🔍 Available wallets count:",Re.length),Bi(t),Pa(""),Ja(""),In(""),An(""),console.log("✅ Transaction type changed to:",t,"- Wallet selection preserved:",ee),setTimeout(()=>{const a=document.getElementById("transaction-section");a&&a.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})},100)};n.useEffect(()=>{const t=a=>{const r=a.target;if(!!r&&(r.tagName==="INPUT"||r.tagName==="TEXTAREA"||r.tagName==="SELECT"||r.isContentEditable)||(a.key==="ArrowLeft"?(a.preventDefault(),nn("withdraw")):a.key==="ArrowRight"&&(a.preventDefault(),nn("transfer"))),a.key==="Enter"){const o=ie==="transfer"?"transferSubmitButton":"withdrawSubmitButton",d=document.getElementById(o);d&&!d.disabled&&(a.preventDefault(),d.click())}};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[ie]);const Vl=t=>{Nc((r=>({id:r.id,type:r.type==="send"?"transfer":"withdraw",sender_msisdn:r.senderPhone,receiver_msisdn:r.receiverPhone,amount:r.amount,commission:r.commission||0,fee:(r==null?void 0:r.fee)??0,status:r.status==="failed"?"failed":r.status==="completed"?"completed":"pending",createdAt:new Date(r.createdAt).toISOString(),updatedAt:new Date(r.createdAt).toISOString(),shopName:V??(I==null?void 0:I.shopName)??(s==null?void 0:s.displayName)??"المحل",cashierName:(r==null?void 0:r.cashierName)??null,commissionMode:(r==null?void 0:r.commissionMode)??(r.type==="send"||tt?"add":"deduct"),totalCharged:(r==null?void 0:r.totalCharged)??(r.type==="send"?Number(r.amount||0)+Number(r.commission||0)+Number((r==null?void 0:r.fee)||0):tt?Number(r.amount||0)+Number(r.commission||0):Number(r.amount||0)),note:(r==null?void 0:r.note)??(r==null?void 0:r.notes)??void 0}))(t)),Tr(!0)},Fd=async t=>{var r;if(!(s!=null&&s.uid)){i({title:"خطأ في المصادقة",description:"يجب تسجيل الدخول أولاً لحذف المعاملات",variant:"destructive"});return}const a=Xe.find(l=>l.id===t);if(!a){i({title:"خطأ في الحذف",description:"لم يتم العثور على المعاملة المطلوب حذفها",variant:"destructive"});return}try{console.log("🗑️ بدء عملية حذف المعاملة:",t),console.log("🔄 حذف المعاملة نهائياً من Firebase...",{transactionId:a.id,userId:s.uid,transactionData:a}),await De.removeUserTransaction(s.uid,a.id),console.log("✅ تم حذف المعاملة نهائياً من Firebase userTransactions");try{await gr.saveDeletedTransaction({...a,userId:s.uid,originalTransactionId:a.id,transactionId:a.transactionId||a.id,reference:a.reference||a.transactionReference||((r=a.receipt)==null?void 0:r.reference),deletedAt:new Date().toISOString(),permanent:!0}),console.log("✅ تم حفظ المعاملة في سجل المحذوفات مع تاريخ الحذف")}catch(d){console.warn("⚠️ فشل في حفظ المعاملة في سجل المحذوفات، لكن الحذف من Firebase نجح:",d)}try{await gr.permanentlyDeleteTransaction(a.id,s.uid)}catch(d){console.warn("⚠️ فشل وسم الحذف النهائي أو التنظيف الإضافي:",d)}const l=[...Ji,a],o=Xe.filter(d=>d.id!==t);Ga(l),Fs(o),qi(!1),console.log("✅ تم تحديث الحالة بعد الحذف من Firebase (بدون نسخ محلية)");try{const d=a.fromWallet;if(d){const{walletDailyLimitsService:x}=await dt(async()=>{const{walletDailyLimitsService:C}=await import("./walletDailyLimitsService-CbdZ_7wZ.js");return{walletDailyLimitsService:C}},__vite__mapDeps([3,0,1]),import.meta.url),g=await x.getWalletLimits(d);if(g){const C=a.type==="send",y={updatedAt:(await dt(async()=>{const{serverTimestamp:Ne}=await import("./index-BaJ4CYlQ.js").then(bt=>bt.bg);return{serverTimestamp:Ne}},__vite__mapDeps([0,1]),import.meta.url)).serverTimestamp()};C?(y.dailyTransferUsed=Math.max(0,(g.dailyTransferUsed||0)-a.amount),y.monthlyTransferUsed=Math.max(0,(g.monthlyTransferUsed||0)-a.amount)):(y.dailyWithdrawUsed=Math.max(0,(g.dailyWithdrawUsed||0)-a.amount),y.monthlyWithdrawUsed=Math.max(0,(g.monthlyWithdrawUsed||0)-a.amount));const{doc:j,setDoc:B}=await dt(async()=>{const{doc:Ne,setDoc:bt}=await import("./index-BaJ4CYlQ.js").then(He=>He.bg);return{doc:Ne,setDoc:bt}},__vite__mapDeps([0,1]),import.meta.url),{db:$}=await dt(async()=>{const{db:Ne}=await import("./index-BaJ4CYlQ.js").then(bt=>bt.bh);return{db:Ne}},__vite__mapDeps([0,1]),import.meta.url),z=j($,"walletLimits",d);await B(z,y,{merge:!0})}}}catch(d){console.warn("فشل استرجاع حدود المحفظة بعد الحذف:",d)}try{const{ProfitService:d}=await dt(async()=>{const{ProfitService:j}=await import("./profitService-Bj9jIfaS.js").then(B=>B.p);return{ProfitService:j}},__vite__mapDeps([4,0,1]),import.meta.url),{ReportsService:x}=await dt(async()=>{const{ReportsService:j}=await import("./profitService-Bj9jIfaS.js").then(B=>B.a);return{ReportsService:j}},__vite__mapDeps([4,0,1]),import.meta.url),C={txnType:a.type==="send"?"send":"receive",amount:a.amount,commission:a.commission||0,createdAt:a.createdAt,status:"confirmed"},y=d.calculateProfitFromTransaction(C);y>0&&d.addProfit(-y,s.uid);try{x.removeTransactionEffects(a,s.uid)}catch{}}catch(d){console.warn("فشل تحديث الأرباح/التقارير بعد الحذف:",d)}i({title:"تم حذف المعاملة نهائياً",description:"تم حذف المعاملة نهائياً من النظام. يمكنك العثور عليها في قائمة المحذوفات"})}catch(l){console.error("❌ خطأ في حذف المعاملة من Firebase:",l);let o="فشل في حذف المعاملة من الخادم. يرجى المحاولة مرة أخرى";l instanceof Error&&(l.message.includes("network")||l.message.includes("offline")?o="مشكلة في الاتصال بالإنترنت. تحقق من الاتصال وحاول مرة أخرى":l.message.includes("permission")||l.message.includes("unauthorized")?o="ليس لديك صلاحية لحذف هذه المعاملة":l.message.includes("not-found")&&(o="المعاملة غير موجودة أو تم حذفها مسبقاً")),i({title:"خطأ في الحذف",description:o,variant:"destructive"})}},dr=t=>{const a=t.type,r=t.txnType;return a==="withdraw"||a==="withdrawal"||a==="receive"||r==="receive"},mr=t=>{const a=t.type,r=t.txnType;return a==="send"||a==="transfer"||r==="send"},hr=(t,a)=>{const r=new Date().toDateString();let l=Xe.filter(y=>new Date(y.createdAt).toDateString()===r&&y.status==="completed");Vs&&Vs.trim()!==""&&(l=l.filter(y=>y.senderPhone&&y.senderPhone.includes(Vs)||y.receiverPhone&&y.receiverPhone.includes(Vs)));const o=ts.filterVisibleTransactions(l,"daily",s==null?void 0:s.uid),d=o.length,x=o.reduce((y,j)=>y+j.amount,0),g=o.filter(dr).reduce((y,j)=>{const B=j.withdrawnAmount!==void 0?j.withdrawnAmount:j.amount;return y+B},0),C=o.filter(mr).reduce((y,j)=>{const B=j.sentAmount!==void 0?j.sentAmount:j.amount;return y+B},0);return{totalTransactions:d,totalAmount:x,totalWithdrawn:g,totalSent:C}},ur=t=>{const a=new Date().getMonth(),r=new Date().getFullYear();let l=Xe.filter(y=>{const j=new Date(y.createdAt);return j.getMonth()===a&&j.getFullYear()===r&&y.status==="completed"});Vs&&Vs.trim()!==""&&(l=l.filter(y=>y.senderPhone&&y.senderPhone.includes(Vs)||y.receiverPhone&&y.receiverPhone.includes(Vs)));const o=ts.filterVisibleTransactions(l,"monthly",s==null?void 0:s.uid),d=o.length,x=o.reduce((y,j)=>y+j.amount,0),g=o.filter(dr).reduce((y,j)=>{const B=j.withdrawnAmount!==void 0?j.withdrawnAmount:j.amount;return y+B},0),C=o.filter(mr).reduce((y,j)=>{const B=j.sentAmount!==void 0?j.sentAmount:j.amount;return y+B},0);return{totalTransactions:d,totalAmount:x,totalWithdrawn:g,totalSent:C}},Md=t=>{const a=new Date().getMonth(),r=new Date().getFullYear(),l=Xe.filter(x=>{const g=new Date(x.createdAt);return g.getMonth()===a&&g.getFullYear()===r&&x.status==="completed"&&x.fromWallet===t}),o=l.filter(dr).reduce((x,g)=>{const C=g.withdrawnAmount||g.amount;return x+C},0),d=l.filter(mr).reduce((x,g)=>{const C=g.sentAmount||g.amount;return x+C},0);return{totalWithdrawn:o,totalTransferred:d}},Ld=t=>{const a=new Date,r=a.getDate(),l=a.getMonth(),o=a.getFullYear(),d=Xe.filter(C=>{const y=new Date(C.createdAt);return y.getDate()===r&&y.getMonth()===l&&y.getFullYear()===o&&C.status==="completed"&&C.fromWallet===t}),x=d.filter(dr).reduce((C,y)=>{const j=y.withdrawnAmount||y.amount;return C+j},0),g=d.filter(mr).reduce((C,y)=>{const j=y.sentAmount||y.amount;return C+j},0);return{totalWithdrawn:x,totalTransferred:g}},Jl=Ve.useMemo(()=>ur(),[Xe,ee,Vs]);Jl.totalWithdrawn,Jl.totalSent;const Ks=Ve.useMemo(()=>Md(ee),[Xe,ee]);n.useEffect(()=>{try{if(!ee||Re.length===0)return;const t=Re.find(z=>z.id===ee);if(!t)return;const a=(qe==null?void 0:qe.monthlyWithdrawLimit)??(t==null?void 0:t.monthlyWithdrawalLimit)??2e5,r=(qe==null?void 0:qe.monthlyTransferLimit)??(t==null?void 0:t.monthlyTransferLimit)??2e5,l=parseFloat($t||"0")||0,o=(Ks==null?void 0:Ks.totalWithdrawn)??(qe==null?void 0:qe.monthlyWithdrawUsed)??0,d=(Ks==null?void 0:Ks.totalTransferred)??(qe==null?void 0:qe.monthlyTransferUsed)??0,x=o+(ie==="withdraw"?l:0),g=d+(ie==="transfer"?l:0),C=.85,y=Math.floor(Math.max(a,1)*C),j=Math.floor(Math.max(r,1)*C),B=(()=>{const z=new Date;return`${z.getFullYear()}-${String(z.getMonth()+1).padStart(2,"0")}`})(),$=`monthlyLimitWarnShown:${ee}:${B}`;if(x>=y){const z=`${$}:withdraw`;if(!(localStorage.getItem(z)==="true")){Ri({type:"withdraw",used:x,limit:a,walletName:t.name}),Cr(!0);try{localStorage.setItem(z,"true")}catch{}return}}if(g>=j){const z=`${$}:transfer`;if(!(localStorage.getItem(z)==="true")){Ri({type:"transfer",used:g,limit:r,walletName:t.name}),Cr(!0);try{localStorage.setItem(z,"true")}catch{}return}}}catch{}},[ee,Re,qe,Ks,ie,$t]);const Kl=async()=>{Wh(),console.log("🔄 بدء عملية التحويل/السحب"),console.log("📊 البيانات المدخلة:",{senderPhone:qt,receiverPhone:os,amount:$t,transactionType:ie});const t=()=>{ie==="transfer"?Oa(!0):Qa(!0)},a=()=>{ie==="transfer"?Oa(!1):Qa(!1)};if(t(),!qt||!$t){console.log("❌ خطأ: بيانات ناقصة"),i({title:"خطأ في البيانات",description:"يرجى ملء جميع الحقول المطلوبة",variant:"destructive"}),a();return}if(ie==="transfer"&&!os&&!M){console.log("❌ خطأ: رقم المستقبل مفقود"),i({title:"خطأ في البيانات",description:"يرجى إدخال رقم المستقبل",variant:"destructive"}),a();return}if(ie==="transfer"&&!M&&!Fh(os)){i({title:"رقم المستقبل غير صالح",description:"اكتب رقم صحيح مكون من 11 رقم ويبدأ بـ 015 أو 010 أو 012 أو 011",variant:"destructive"}),a();return}const r=parseFloat($t);if(console.log("💰 المبلغ المحول:",r),r<=0){console.log("❌ خطأ: مبلغ غير صحيح"),i({title:"خطأ في المبلغ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"}),a();return}if(ot)try{const Te=new Date,Tt=Te.getFullYear(),Cs=String(Te.getMonth()+1).padStart(2,"0"),Kt=String(Te.getDate()).padStart(2,"0"),Gs=`zeroPlanDailyConfirmCount:${(s==null?void 0:s.uid)||"default"}:${Tt}-${Cs}-${Kt}`,Es=localStorage.getItem(Gs);if((Es&&parseInt(Es,10)||0)>=10){i({title:"حد التأكيد اليومي",description:"باقة زيرو تسمح بـ 10 تأكيدات تحويل/سحب يومياً فقط.",variant:"destructive"}),a();return}}catch(Te){console.warn("فشل قراءة عداد تأكيدات باقة زيرو من التخزين المحلي:",Te)}const l=Re.find(Te=>Te.id===ee);if(!l){i({title:"خطأ في المحفظة",description:"يرجى اختيار محفظة صحيحة",variant:"destructive"}),a();return}const o=Ks;if(console.log("📈 فحص الحدود الشهرية للمحفظة المختارة"),console.log("📊 الإحصائيات الشهرية للمحفظة:",{walletId:ee,walletName:l.name,currentWithdrawn:o.totalWithdrawn,currentTransferred:o.totalTransferred,withdrawalLimit:l.monthlyWithdrawalLimit,transferLimit:l.monthlyTransferLimit}),ie==="withdraw"){if(console.log("🏧 فحص حد السحب الشهري للمحفظة"),console.log(`💸 المسحوب حالياً من المحفظة: ${o.totalWithdrawn}, المبلغ الجديد: ${r}, الحد الأقصى: ${l.monthlyWithdrawalLimit}`),o.totalWithdrawn+r>l.monthlyWithdrawalLimit){console.log("❌ تجاوز حد السحب الشهري للمحفظة"),i({title:"تجاوز حد السحب الشهري",description:`لا يمكن سحب أكثر من ${l.monthlyWithdrawalLimit} جنيه شهرياً من محفظة ${l.name}`,variant:"destructive"}),a();return}}else if(console.log("💸 فحص حد التحويل الشهري للمحفظة"),console.log(`📤 المحول حالياً من المحفظة: ${o.totalTransferred}, المبلغ الجديد: ${r}, الحد الأقصى: ${l.monthlyTransferLimit}`),o.totalTransferred+r>l.monthlyTransferLimit){console.log("❌ تجاوز حد التحويل الشهري للمحفظة"),i({title:"تجاوز حد التحويل الشهري",description:`لا يمكن تحويل أكثر من ${l.monthlyTransferLimit} جنيه شهرياً من محفظة ${l.name}`,variant:"destructive"}),a();return}const d=(I==null?void 0:I.shopName)||(s==null?void 0:s.displayName)||"محل كاشي لينك",x={id:Date.now().toString(),type:ie==="transfer"?"send":ie==="deposit"?"deposit":"withdraw",senderPhone:qt,receiverPhone:ie==="transfer"?os:qt,amount:r,status:"completed",createdAt:new Date,withdrawnAmount:ie==="withdraw"?r:void 0,sentAmount:ie==="transfer"?r:void 0,depositedAmount:void 0,fromWallet:ee,senderNumber:qt,senderName:qt,shopName:(l==null?void 0:l.name)||"المحفظة الرئيسية",transferredAmount:ie==="transfer"?r:void 0,receiverNumber:ie==="transfer"?os:void 0,withdrawnAmountDetailed:ie==="withdraw"?r:void 0,depositedAmountDetailed:void 0,merchantShopName:d,transactionReference:`TXN-${Date.now()}`,commission:0,notes:ie==="transfer"?void 0:xa&&xa.trim()!==""?xa.trim():void 0};f&&(w!=null&&w.name||w!=null&&w.username)&&(x.cashierName=(w==null?void 0:w.name)||(w==null?void 0:w.username));const g=Ua.validateTransaction(r,ie,lt,Be);if(!g.isValid){i({title:"خطأ في العملية",description:g.error,variant:"destructive"}),a();return}g.warning&&i({title:"تحذير",description:g.warning,variant:"destructive"});let C;if(ie==="transfer")if((l==null?void 0:l.defaultTransferCommission)!=null){const Te=Number(l.defaultTransferCommission)||0;C=Math.round(Te*r/1e3*100)/100}else us&&us.trim()!==""?C=Math.max(0,parseFloat(us)):C=0;else if((l==null?void 0:l.defaultWithdrawCommission)!=null){const Te=Number(l.defaultWithdrawCommission)||0;C=Math.round(Te*r/1e3*100)/100}else hs&&hs.trim()!==""?C=Math.max(0,parseFloat(hs)):C=Math.round(r*.01*100)/100;if(x.commission=C,ie!=="transfer"&&!tt&&C>=r){i({title:"خطأ في العمولة",description:"العمولة أكبر من أو تساوي المبلغ المدخل",variant:"destructive"}),a();return}const y=ie==="transfer"||tt?r:Math.round((r-C)*100)/100;x.amount=y,x.withdrawnAmount=ie==="withdraw"?y:void 0,x.sentAmount=ie==="transfer"?y:void 0,x.transferredAmount=ie==="transfer"?y:void 0,x.withdrawnAmountDetailed=ie==="withdraw"?y:void 0;let j;const B=ie==="transfer"&&!!Os,$=ie==="withdraw"&&!!Os,z=B||$;let Ne=null;const bt=Ir(qt||"").replace(/\D/g,""),He=Ir(os||"").replace(/\D/g,""),wt=ie==="transfer"&&(bt.startsWith("010")&&(He.startsWith("011")||He.startsWith("012")||He.startsWith("015"))||bt.startsWith("012")&&He.startsWith("010")||bt.startsWith("011")&&He.startsWith("010")||bt.startsWith("015")&&He.startsWith("010")),Ft=wt?Math.max(0,parseFloat(Li||"0")):0,sa=Math.round(C*100)/100;if(x.commission=sa,wt&&!z&&Ft<=0){i({title:"خطأ",description:"أدخل رسوم التحويل لعمليات 010 → 011/012/015 أو 012 → 010 أو 011 → 010 أو 015 → 010",variant:"destructive"}),a();return}if(ie==="transfer"&&!z){const Te=Number(Be[ee]||0),Tt=Number(y)+Number(Ft);if(Te<Tt){i({title:"رصيد المحفظة غير كافٍ",description:`الرصيد الحالي ${Te} لا يكفي لخصم ${Tt}`,variant:"destructive"}),a();return}}if(z)if(B){const Te=Ua.validateTransaction(y,"transfer",lt,Be);Te.isValid?j={success:!0,newCashBalance:lt,newWalletBalances:Be}:j={success:!1,newCashBalance:lt,newWalletBalances:Be,message:Te.error||"رصيد غير كافٍ للتحويل المؤجل",error:"INSUFFICIENT_WALLET_BALANCE"}}else j={success:!0,newCashBalance:lt,newWalletBalances:Be};else ie==="transfer"?j=await Ua.processTransfer({amount:y,currentCashBalance:lt,currentWalletBalances:Be,wallets:Re,selectedWalletId:ee,skipRemoteLimitsCheck:!1,nonBlockingUsageUpdate:!0}):j=await Ua.processWithdraw({amount:y,currentCashBalance:lt,currentWalletBalances:Be,wallets:Re,selectedWalletId:ee,skipRemoteLimitsCheck:!1,nonBlockingUsageUpdate:!0});if(!j.success){i({title:"فشل في العملية",description:j.error||j.message,variant:"destructive"}),a();return}let Ys=z?lt:j.newCashBalance,Hs=z?Be:j.newWalletBalances;if(!z&&ie==="transfer"&&Ft>0){const Te=Number(Hs[ee]||0);Hs={...Hs,[ee]:Math.round((Te-Number(Ft))*100)/100}}if(z&&$){const Te=Re.find(Kt=>Kt.id===ee)??Re.find(Kt=>Kt.isDefault)??Re[0],Tt=(Te==null?void 0:Te.id)||ee;if(Tt!==ee)try{cr(Tt)}catch{}const Cs=Number(Be[Tt]||0);Hs={...Be,[Tt]:Math.round((Cs+Number(y))*100)/100};try{const Kt=`walletEffectsAppliedOnCreation_${(s==null?void 0:s.uid)||"default"}`,Gs=localStorage.getItem(Kt),Es=Gs?JSON.parse(Gs):[];x!=null&&x.id&&!Es.includes(x.id)&&(Es.push(x.id),localStorage.setItem(Kt,JSON.stringify(Es)))}catch{}}if(z&&B){const Te=Re.find(Kt=>Kt.id===ee)??Re.find(Kt=>Kt.isDefault)??Re[0],Tt=(Te==null?void 0:Te.id)||ee;if(Tt!==ee)try{cr(Tt)}catch{}const Cs=Number(Be[Tt]||0);Hs={...Be,[Tt]:Math.round((Cs-Number(y)-Number(Ft))*100)/100}}if((B||$)&&Os&&!ic){const Te={id:`DEBT-${Date.now()}`,debtorName:Os.debtorName,amount:Os.amount,reason:Os.notes||"",customerId:Os.customerId,mobile:Os.mobile,status:"pending",createdAt:new Date};Ne=Te.id;const Tt=[Te,...At];ps(Tt);try{await Ss(Tt)}catch(Cs){console.error("⚠️ فشل حفظ الدين المؤجل محلياً:",Cs)}i({title:"تم إضافة الدين",description:"أضيف إلى إيصالات الديون حتى يتم السداد",variant:"default"})}if(!z){const Te=Math.max(0,Number(C))+Math.max(0,Number(Ft));Te>0&&(Ys=Math.round((Ys+Te)*100)/100,console.log(`💰 تم إضافة عمولة/رسوم ${Te} جنيه لدرج النقدية`))}console.log("⚡ تحديث الواجهة فوراً بدون حجب باستخدام startTransition...");const to=[x,...Xe];Ve.startTransition(()=>{Jt(Ys),Xt(Hs),z&&(x.status="pending"),Fs(to)});try{setTimeout(()=>{try{localStorage.setItem(Ma(),JSON.stringify(to))}catch{}},0)}catch{}if(ot)try{const Te=new Date,Tt=Te.getFullYear(),Cs=String(Te.getMonth()+1).padStart(2,"0"),Kt=String(Te.getDate()).padStart(2,"0"),Gs=`zeroPlanDailyConfirmCount:${(s==null?void 0:s.uid)||"default"}:${Tt}-${Cs}-${Kt}`,Es=localStorage.getItem(Gs),on=Es&&parseInt(Es,10)||0;localStorage.setItem(Gs,String(on+1))}catch{}if(setTimeout(()=>{try{localStorage.setItem(Ds(),Ys.toString()),localStorage.setItem(fs(),JSON.stringify(Hs))}catch{}},0),(async()=>{try{console.log("🔄 بدء حفظ المعاملة في Firebase في الخلفية...");const Te={shopId:T||(I==null?void 0:I.shopId)||(s==null?void 0:s.uid)||"default-shop",lineId:ee||"default-line",merchantUserId:(s==null?void 0:s.uid)||null,provider:"vodafone_cash",txnType:ie==="transfer"?"send":"receive",amount:y,commission:sa,fee:Ft,profit:0,senderMsisdn:qt,receiverMsisdn:ie==="transfer"?os:qt,note:ie==="transfer"?void 0:xa&&xa.trim()!==""?xa.trim():void 0,status:z?"pending":"confirmed",linkedDebtId:Ne||void 0,createdBy:(s==null?void 0:s.uid)||null,walletEffectAppliedOnCreation:!!(z&&$)},Tt={...Te,status:z?"pending":"completed",commissionMode:ie==="transfer"||tt?"add":"deduct",totalCharged:ie==="transfer"?y+sa+Ft:tt?y+C:y,walletEffectAppliedOnCreation:!!(z&&$),createdAt:new Date},{ProfitService:Cs}=await dt(async()=>{const{ProfitService:Kd}=await import("./profitService-Bj9jIfaS.js").then(Yd=>Yd.p);return{ProfitService:Kd}},__vite__mapDeps([4,0,1]),import.meta.url),Kt=Cs.calculateProfitFromTransaction(Tt);Kt>0&&(Cs.addProfit(Kt,s==null?void 0:s.uid),console.log("✅ تم إضافة الربح:",Kt,"جنيه"));const Gs=await yn.create(Te);await Promise.all([...s!=null&&s.uid?[De.updateUserData(s.uid,{cashBalance:Ys,walletBalances:Hs,lastUpdated:new Date().toISOString()})]:[],...s!=null&&s.uid?[De.saveUserTransaction(s.uid,{...Tt,transactionType:ie,fromWallet:ee,toWallet:ie==="transfer"?B?null:"cash":null,cashierName:f&&((w==null?void 0:w.name)||(w==null?void 0:w.username))||"الحساب الرئيسي",linkedDebtId:Ne||void 0,transactionId:Gs,description:`${ie==="transfer"?"تحويل":"سحب"} ${y} من ${ee} ${ie==="transfer"?B?"":"إلى الدرج النقدي":""} — عمولة: ${C} (${ie==="transfer"||tt?"مضافة":"مخصومة"})${Ft>0?` — رسوم: ${Ft}`:""}${z?" — دين مؤجل (قيد المراجعة)":""}`})]:[]]),console.log("✅ تم حفظ جميع البيانات في Firebase بنجاح");const Es=`userData_${s==null?void 0:s.uid}`,on={cashBalance:Ys,walletBalances:Hs,lastUpdated:new Date().toISOString()};localStorage.setItem(Es,JSON.stringify(on))}catch(Te){console.error("❌ خطأ في حفظ المعاملة في Firebase (في الخلفية):",Te),i({title:"تحذير",description:"تم تنفيذ العملية محلياً، لكن فشلت المزامنة مع الخادم. ستتم المحاولة مرة أخرى تلقائياً.",variant:"destructive"})}})(),ie==="transfer"){Oa(!0);const Te=Number(r)+Number(C)+Math.max(0,Number(Ft));Wn({type:"transfer",amount:Math.max(0,Math.round(Te*100)/100)}),Pc({receiver:os,amount:r}),ga(!0),setTimeout(()=>{Oa(!1)},2e3)}else{Qa(!0);const Te=tt?Number(r):Math.max(0,Math.round((Number(r)-Number(C))*100)/100);Wn({type:"withdraw",amount:Math.max(0,Math.round(Te*100)/100)}),ga(!0),setTimeout(()=>{Qa(!1)},2e3)}Pa(""),Ja(""),Oi(""),Sn(null),Nn(""),pa(""),_i(""),Wi(!1)},ln=Ve.useMemo(()=>new Intl.DateTimeFormat("ar-EG"),[]),Yl=Ve.useMemo(()=>new Intl.DateTimeFormat("ar-EG",{hour:"2-digit",minute:"2-digit"}),[]),Rd=Ve.useMemo(()=>{try{return At.reduce((t,a)=>{const r=Number(a.paidAmount||0),l=Math.max(0,Number(a.amount||0)-r);return t+l},0)}catch{return 0}},[At]),bi=Ve.useMemo(()=>Ul().filter(a=>qs==="all"?!0:qs==="send"?a.type==="send":qs==="receive"?a.type==="receive":qs==="withdraw"?a.type==="withdraw":qs!=="deleted"),[Ul,qs]),Bd=()=>{if(En==="daily"){const t=ts.resetReportsManually("daily",Xe,s==null?void 0:s.uid);Ha(!1),i({title:"تم تصفير المعاملات اليومية",description:`تم إخفاء ${t.length} معاملة من تقارير اليوم (الحدود لم تتأثر)`})}else{const t=ts.resetReportsManually("monthly",Xe,s==null?void 0:s.uid);Ha(!1),i({title:"تم تصفير المعاملات الشهرية",description:`تم إخفاء ${t.length} معاملة من تقارير الشهر (الحدود لم تتأثر)`})}},$d=()=>En==="daily"?"تصفير المعاملات اليومية":"تصفير المعاملات الشهرية",Ud=()=>En==="daily"?"أدخل الرقم السري الرئيسي لتصفير جميع معاملات اليوم":"أدخل الرقم السري الرئيسي لتصفير جميع معاملات الشهر",zd=t=>{El(t),ri(!0)},qd=t=>{Jt(t),localStorage.setItem(Ds(),t.toString()),bl(!1),i({title:"تم تحديث الرصيد النقدي",description:`تم تحديث الرصيد النقدي إلى ${t} جنيه`})},Vd=async t=>{var x;if(!ys){console.warn("لا يوجد معرف محفظة محدد لتعديل الرصيد");return}const a={...Be,[ys]:t};Xt(a);const r=new Date().toISOString(),l={walletBalances:a,lastUpdated:r},o=`userData_${s==null?void 0:s.uid}`;try{localStorage.setItem(o,JSON.stringify(l)),localStorage.setItem(fs(),JSON.stringify(a)),localStorage.setItem(`walletBalances_backup_${r}`,JSON.stringify(a))}catch{}try{s!=null&&s.uid&&await De.updateUserData(s.uid,l)}catch(g){console.error("خطأ أثناء حفظ رصيد المحفظة في Firebase:",g)}wl(!1);const d=((x=Re.find(g=>g.id===ys))==null?void 0:x.name)||"المحفظة";i({title:"تم تحديث رصيد المحفظة",description:`تم تحديث رصيد ${d} إلى ${t.toLocaleString()} جنيه`})},Jd=async t=>{var a;if(console.log("💰 بدء تحديث رصيد المحفظة"),console.log("📊 معرف المحفظة المحررة:",ys),console.log("💵 المبلغ المضاف/المخصوم:",t),ys){const r=Be[ys]||0;console.log("💰 الرصيد الحالي:",r);const l=r+t;console.log("💰 الرصيد الجديد:",l);const o={...Be,[ys]:l};console.log("📊 الأرصدة المحدثة:",o),Xt(o);const d=new Date().toISOString(),x={walletBalances:o,lastUpdated:d},g=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(g,JSON.stringify(x)),localStorage.setItem(fs(),JSON.stringify(o)),localStorage.setItem(`walletBalances_backup_${d}`,JSON.stringify(o));try{if(s!=null&&s.uid){console.log("🔄 حفظ البيانات في Firebase...");try{await De.updateUserData(s.uid,x),console.log("✅ تم حفظ الأرصدة في Firebase بنجاح"),setTimeout(()=>{localStorage.removeItem(g),console.log("🧹 تم حذف النسخة المحلية المؤقتة بعد دقيقة واحدة")},6e4)}catch(B){console.error("❌ فشل في حفظ البيانات في Firebase:",B),ke(!0)}}else console.log("⚠️ المستخدم غير مسجل دخول، حفظ في localStorage"),localStorage.setItem(fs(),JSON.stringify(o));const C=((a=Re.find(B=>B.id===ys))==null?void 0:a.name)||"المحفظة",y=t>0?"إضافة":"خصم",j=Math.abs(t);i({title:`تم ${y} مبلغ ${y==="إضافة"?"إلى":"من"} رصيد المحفظة`,description:`تم ${y} ${j} جنيه ${y==="إضافة"?"إلى":"من"} رصيد ${C}. الرصيد الجديد: ${l.toLocaleString()} جنيه`})}catch(C){if(console.error("❌ فشل في حفظ البيانات في Firebase:",C),localStorage.setItem(fs(),JSON.stringify(o)),s!=null&&s.uid){const y=`userData_${s.uid}`,j={walletBalances:o,lastUpdated:new Date().toISOString()};localStorage.setItem(y,JSON.stringify(j)),ke(!0)}i({title:"تم حفظ البيانات محلياً",description:"تم حفظ التغييرات محلياً وسيتم مزامنتها مع الخادم لاحقاً",variant:"default"})}}else console.log("❌ لا يوجد معرف محفظة للتحرير");setTimeout(()=>{const l=Object.keys(localStorage).filter(o=>o.startsWith("walletBalances_backup_")).sort();l.length>5&&l.slice(0,l.length-5).forEach(d=>{localStorage.removeItem(d),console.log("🗑️ حذف النسخة الاحتياطية القديمة:",d)})},5e3),ri(!1),El("")};return console.log("🔥 UserDashboardPage - Render conditions:",{isCheckingActivation:rt,isUserActive:pt,showActivationModal:Ta}),!rt&&!pt?(console.log("🔥 UserDashboardPage - Showing activation modal"),e.jsx("div",{className:"user-dashboard min-h-screen bg-background flex items-center justify-center",children:e.jsx(xo,{isOpen:!0,onClose:()=>{}})})):rt?(console.log("🔥 UserDashboardPage - Showing loading screen"),e.jsx(lm,{})):(console.log("🔥 UserDashboardPage - Rendering main dashboard"),e.jsxs("div",{className:"user-dashboard min-h-screen px-2 sm:px-4 py-2 sm:py-4 relative bg-gray-50 bg-[radial-gradient(140%_140%_at_10%_10%,#f3f4f6_0%,#e5e7eb_45%,#d1d5db_100%)]",children:[e.jsx(Mh,{userId:s==null?void 0:s.uid}),e.jsxs("div",{className:"max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-3 sm:gap-6 relative z-10",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-2 sm:space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 sm:grid-cols-2 sm:gap-3 fade-in-up",children:[!Za&&e.jsxs(xt,{className:"monthly-stats-card bg-gradient-to-br from-purple-50 via-purple-25 to-white border border-purple-200/60 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 group relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-purple-500/5 to-purple-600/3 opacity-0 group-hover:opacity-100 transition-opacity duration-300"}),e.jsx("div",{className:"absolute top-0 right-0 w-20 sm:w-32 h-20 sm:h-32 bg-gradient-to-br from-purple-300/15 to-transparent rounded-full -translate-y-8 sm:-translate-y-16 translate-x-8 sm:translate-x-16 group-hover:scale-110 transition-transform duration-300"}),e.jsx(Ht,{className:"monthly-stats-header pb-2 sm:pb-1 lg:pb-1 px-3 sm:px-3 lg:px-2 pt-3 sm:pt-2 lg:pt-1 relative z-10",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(ds,{className:"text-xs font-bold text-purple-800 flex items-center gap-1.5 sm:gap-1",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"w-2.5 sm:w-2 h-2.5 sm:h-2 bg-gradient-to-r from-purple-500 to-purple-600 rounded-full shadow-sm"}),e.jsx("div",{className:"absolute inset-0 w-2.5 sm:w-2 h-2.5 sm:h-2 bg-purple-400 rounded-full opacity-60 animate-pulse"})]}),e.jsx("span",{className:"text-xs",children:"الشهر"})]}),e.jsxs("div",{className:"flex items-center gap-1 sm:gap-1",children:[e.jsx("div",{className:"hidden"}),e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>{Vi("monthly"),Ha(!0)},className:"monthly-stat-action h-7 w-7 sm:h-6 sm:w-6 p-0 bg-gradient-to-r from-purple-100 to-purple-200 text-purple-700 hover:from-purple-200 hover:to-purple-300 hover:text-purple-800 rounded-lg sm:rounded-md transition-all duration-300 hover:scale-105 shadow-sm hover:shadow-md",title:"تصفير معاملات الشهر",children:e.jsx(Yt,{className:"h-3 w-3 sm:h-2.5 sm:w-2.5"})}),e.jsx("div",{className:"monthly-stat-action p-1.5 sm:p-1 bg-gradient-to-r from-purple-100 to-purple-200 rounded-lg sm:rounded-md",children:e.jsx(pr,{className:"h-3 w-3 sm:h-2.5 sm:w-2.5 text-purple-600"})})]})]})}),!Za&&e.jsxs(Nt,{className:"space-y-0.5 sm:space-y-1 lg:space-y-0 pt-0 px-2 sm:px-3 lg:px-2 pb-1.5 sm:pb-2 lg:pb-1 relative z-10",children:[e.jsxs("div",{className:"stat-row stat-row--monthly flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-purple-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"stat-label stat-label--monthly text-xs font-semibold text-purple-700",children:"عدد المعاملات:"}),e.jsx("span",{className:"stat-value stat-value--monthly font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:ur().totalTransactions})]}),e.jsxs("div",{className:"stat-row stat-row--monthly flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-purple-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"stat-label stat-label--monthly text-xs font-semibold text-purple-700",children:"إجمالي المبالغ:"}),e.jsx("span",{className:"stat-value stat-value--monthly font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:ur().totalAmount.toFixed(2)})]}),e.jsxs("div",{className:"stat-row stat-row--monthly flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-purple-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"stat-label stat-label--monthly text-xs font-semibold text-purple-700",children:"المسحوب:"}),e.jsx("span",{className:"stat-value stat-value--monthly font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:ur().totalWithdrawn.toFixed(2)})]}),e.jsxs("div",{className:"stat-row stat-row--monthly flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-purple-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"stat-label stat-label--monthly text-xs font-semibold text-purple-700",children:"المرسل:"}),e.jsx("span",{className:"stat-value stat-value--monthly font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:ur().totalSent.toFixed(2)})]}),e.jsxs("div",{className:"stat-row stat-row--monthly flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-purple-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"stat-label stat-label--monthly text-xs font-semibold text-purple-700",children:"الأرباح:"}),e.jsx(Dh,{userId:s==null?void 0:s.uid,transactions:Xe})]})]}),Mc&&e.jsx("div",{className:"monthly-overlay absolute inset-0 z-20 bg-yellow-100/60 backdrop-blur-sm rounded-xl border border-yellow-300/70 flex items-center justify-center p-0 pointer-events-auto",children:e.jsxs(h,{size:"sm",variant:"ghost",onClick:async()=>{if(ot){i({title:"غير متاح",description:"تقارير الشهر غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"});return}Wr(!0)},className:"px-2.5 py-1 rounded-full bg-gradient-to-r from-yellow-500 to-yellow-600 text-black hover:from-yellow-600 hover:to-yellow-700 shadow-md flex items-center gap-1 text-[11px] font-semibold",title:"عرض تقارير الشهر (يتطلب الرقم السري)",children:[e.jsx("span",{children:"عرض تقارير الشهر"}),e.jsx(jt,{className:"h-2.5 w-2.5"})]})})]}),e.jsx(rs,{open:Rc,onOpenChange:Wr,mode:"verify",title:"الرقم السري لفتح تقارير الشهر",description:"لا يمكن الاطلاع على إحصائيات الشهر إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{if(ot){i({title:"غير متاح",description:"تقارير الشهر غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}),Wr(!1),tl(!0);return}tl(!1),Wr(!1)},userId:s==null?void 0:s.uid}),((Hl=vt==null?void 0:vt.subscription)==null?void 0:Hl.planType)!==cs.TAHWEELA&&e.jsxs(xt,{className:"daily-stats-card bg-gradient-to-br from-blue-50 via-blue-25 to-white border border-blue-200/60 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 group relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/5 to-blue-600/3 opacity-0 group-hover:opacity-100 transition-opacity duration-300"}),e.jsx("div",{className:"absolute top-0 right-0 w-20 sm:w-32 h-20 sm:h-32 bg-gradient-to-br from-blue-300/15 to-transparent rounded-full -translate-y-8 sm:-translate-y-16 translate-x-8 sm:translate-x-16 group-hover:scale-110 transition-transform duration-300"}),e.jsx(Ht,{className:"daily-stats-header pb-2 sm:pb-3 lg:pb-1 px-3 sm:px-4 lg:px-2 pt-3 sm:pt-4 lg:pt-1 relative z-10",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(ds,{className:"text-sm sm:text-base font-bold text-blue-800 flex items-center gap-1.5 sm:gap-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"w-2.5 sm:w-3 h-2.5 sm:h-3 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full shadow-sm"}),e.jsx("div",{className:"absolute inset-0 w-2.5 sm:w-3 h-2.5 sm:h-3 bg-blue-400 rounded-full opacity-60 animate-pulse"})]}),e.jsx("span",{className:"text-xs sm:text-sm",children:"اليوم"})]}),e.jsxs("div",{className:"flex items-center gap-1 sm:gap-1.5",children:[e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>{Vi("daily"),Ha(!0)},className:"daily-stat-action h-7 w-7 sm:h-8 sm:w-8 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded-lg transition-all duration-300 hover:scale-105 shadow-sm hover:shadow-md",title:"تصفير معاملات اليوم",children:e.jsx(Yt,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"})}),e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>Lc(t=>!t),className:"daily-stat-action h-7 w-7 sm:h-8 sm:w-8 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded-lg transition-all duration-300 hover:scale-105 shadow-sm hover:shadow-md",title:Za?"توسيع اليوم والشهر":"طي اليوم والشهر",children:Za?e.jsx(wr,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"}):e.jsx(mn,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"})}),e.jsx("div",{className:"p-1.5 sm:p-2 bg-gradient-to-r from-blue-100 to-blue-200 rounded-lg",children:e.jsx(pr,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5 text-blue-600"})})]})]})}),!Za&&e.jsxs(Nt,{className:"space-y-0 pt-0 px-2 pb-1 relative z-10",children:[e.jsxs("div",{className:"stat-row flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-blue-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"stat-label text-xs font-semibold text-blue-700",children:"عدد المعاملات:"}),e.jsx("span",{className:"stat-value font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:hr().totalTransactions})]}),e.jsxs("div",{className:"stat-row flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-blue-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"stat-label text-xs font-semibold text-blue-700",children:"إجمالي المبالغ:"}),e.jsx("span",{className:"stat-value font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:hr().totalAmount.toFixed(2)})]}),e.jsxs("div",{className:"stat-row flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-blue-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"stat-label text-xs font-semibold text-blue-700",children:"المسحوب:"}),e.jsx("span",{className:"stat-value font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:hr().totalWithdrawn.toFixed(2)})]}),e.jsxs("div",{className:"stat-row flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from_gray-100 to-blue-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"stat-label text-xs font-semibold text-blue-700",children:"المرسل:"}),e.jsx("span",{className:"stat-value font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:hr().totalSent.toFixed(2)})]}),e.jsxs("div",{className:"stat-row flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-blue-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"stat-label text-xs font-semibold text-blue-700",children:"الأرباح:"}),e.jsx(Ah,{userId:s==null?void 0:s.uid})]})]}),Bc&&e.jsx("div",{className:"absolute inset-0 z-20 bg-yellow-100/60 backdrop-blur-sm rounded-xl border border-yellow-300/70 flex items-center justify-center p-0 pointer-events-auto",children:e.jsxs(h,{size:"sm",variant:"ghost",onClick:()=>Mn(!0),className:"px-2.5 py-1 rounded-full bg-gradient-to-r from-yellow-300 to-yellow-400 text-black hover:from-yellow-400 hover:to-yellow-500 shadow-md flex items-center gap-1 text-[11px] font-semibold",title:"عرض تقارير اليوم (يتطلب الرقم السري)",children:[e.jsx("span",{children:"عرض تقارير اليوم"}),e.jsx(jt,{className:"h-2.5 w-2.5"})]})})]}),e.jsx(rs,{open:$c,onOpenChange:Mn,mode:"verify",title:"الرقم السري لفتح تقارير اليوم",description:"لا يمكن الاطلاع على تقارير اليوم إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{sl(!1),Mn(!1)},userId:s==null?void 0:s.uid})]}),e.jsxs(xt,{className:"balance-bar bg-white border-2 border-gray-200/50 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 group relative overflow-hidden   transform fade-in-up mb-6",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-emerald-500/5 via-blue-500/5 to-emerald-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-200"}),e.jsx("div",{className:"absolute top-0 left-0 w-40 h-40 bg-gradient-to-br from-emerald-300/10 to-transparent rounded-full -translate-y-20 -translate-x-20 group-hover:scale-150 transition-transform duration-200"}),e.jsx("div",{className:"absolute bottom-0 right-0 w-40 h-40 bg-gradient-to-br from-blue-300/10 to-transparent rounded-full translate-y-20 translate-x-20 group-hover:scale-150 transition-transform duration-200"}),e.jsx(Nt,{className:"p-3 relative z-10",children:e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"bg-emerald-50 border-2 border-emerald-200/50 p-1 rounded-xl shadow-lg hover:shadow-md transition-all duration-200 group/cash relative overflow-hidden ",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-emerald-500/10 to-transparent opacity-0 group-hover/cash:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex items-center justify-between relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-emerald-100 to-emerald-200 rounded-lg shadow-sm",children:e.jsx(Pt,{className:"h-1.5 w-1.5 text-emerald-600"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] font-bold text-emerald-800",children:"الفلوس النقدية"}),e.jsxs("span",{className:"text-[10px] font-extrabold text-emerald-700 bg-gradient-to-r from-emerald-100 to-emerald-200 px-1 py-0.5 rounded-lg shadow-sm",children:[lt.toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(h,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-green-100 to-green-200 text-green-700 hover:from-green-200 hover:to-green-300 hover:text-green-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>nr(!0),children:e.jsx(as,{className:"h-2 w-2"})}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-emerald-100 to-emerald-200 text-emerald-700 hover:from-emerald-200 hover:to-emerald-300 hover:text-emerald-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>Wl(!0),title:"تفاصيل الفلوس النقدية",children:e.jsx(mo,{className:"h-2 w-2"})}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800 rounded-xl transition-all duration-300  hover:rotate-12 shadow-md hover:shadow-lg",onClick:()=>an(!0),children:e.jsx(Yt,{className:"h-2 w-2"})})]})]})]}),e.jsxs("div",{className:"bg-blue-50 border-2 border-blue-200/50 p-1 rounded-xl shadow-lg hover:shadow-md transition-all duration-200 group/wallet relative overflow-hidden ",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/10 to-transparent opacity-0 group-hover/wallet:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex items-center justify-between relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-blue-100 to-blue-200 rounded-lg shadow-sm",children:e.jsx(Rs,{className:"h-1.5 w-1.5 text-blue-600"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] font-bold text-blue-800",children:"الأرصدة علي المحافظ"}),e.jsxs("span",{className:"text-[10px] font-extrabold text-blue-700 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-lg shadow-sm",children:[Object.values(Be).reduce((t,a)=>t+a,0).toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(h,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-green-100 to-green-200 text-green-700 hover:from-green-200 hover:to-green-300 hover:text-green-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>Xr(!0),title:"إضافة أموال لإجمالي المحفظة",children:e.jsx(as,{className:"h-2 w-2"})}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800 rounded-xl transition-all duration-300  hover:rotate-12 shadow-md hover:shadow-lg",onClick:()=>{tn(!0),sn("")},title:"تصفير إجمالي المحفظة",children:e.jsx(Yt,{className:"h-2 w-2"})})]})]})]}),e.jsxs("div",{className:"col-span-2 sm:col-span-1 bg-indigo-50 border-2 border-indigo-200/50 p-1 rounded-xl shadow-lg hover:shadow-md transition-all duration-200 group/selwallet relative overflow-hidden ",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-indigo-500/10 to-transparent opacity-0 group-hover/selwallet:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex items-center justify-between relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-indigo-100 to-indigo-200 rounded-lg shadow-sm",children:e.jsx(Rs,{className:"h-1.5 w-1.5 text-indigo-600"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] font-bold text-indigo-800",children:"رصيد المحفظه"}),e.jsxs("span",{className:"text-[10px] font-extrabold text-indigo-700 bg-gradient-to-r from-indigo-100 to-indigo-200 px-1 py-0.5 rounded-lg shadow-sm",children:[(ee&&Be[ee]||0).toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(h,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-green-100 to-green-200 text-green-700 hover:from-green-200 hover:to-green-300 hover:text-green-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>{if(!ee){i({title:"اختر محفظة",description:"يرجى اختيار محفظة من اختيار المحافظ بالأعلى أولاً",variant:"destructive"});return}zd(ee)},title:"إضافة/خصم إلى رصيد المحفظة المختارة",children:e.jsx(as,{className:"h-2 w-2"})}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800 rounded-xl transition-all duration-300  hover:rotate-12 shadow-md hover:shadow-lg",onClick:()=>{if(!ee){i({title:"اختر محفظة",description:"يرجى اختيار محفظة لتصفير رصيدها فقط",variant:"destructive"});return}Rr(!0)},title:"تصفير رصيد المحفظة المختارة",children:e.jsx(Yt,{className:"h-2 w-2"})})]})]})]})]})})]}),e.jsxs(xt,{className:"bg-gradient-to-br from-gray-50 via-white to-slate-50 border border-gray-200/60 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 group relative overflow-hidden fade-in-up",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-gray-500/5 to-slate-600/3 opacity-0 group-hover:opacity-100 transition-opacity duration-300"}),e.jsxs(Ht,{className:`pb-2 px-4 pt-4 relative z-10 ${O?"sticky top-0 z-20 bg-white/90 backdrop-blur supports-[backdrop-filter]:bg-white/60":""}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(ds,{className:"text-sm font-bold flex items-center gap-2 text-gray-800",children:[!O&&e.jsx("div",{className:"p-1.5 sm:p-2 bg-gradient-to-r from-gray-100 to-slate-200 rounded-lg",children:e.jsx(pr,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5 text-gray-600"})}),e.jsx("span",{className:"bg-gradient-to-r from-gray-600 to-slate-600 bg-clip-text text-transparent",children:"المعاملات الأخيرة"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[!O&&e.jsxs("div",{className:"flex items-center gap-0.5 bg-gray-50 rounded px-1 py-0.5 border border-gray-200 hover:border-blue-300 transition-all duration-200 group relative overflow-hidden max-w-[140px] md:max-w-[220px]",children:[e.jsx(jm,{className:"h-2 w-2 text-gray-400 group-hover:text-blue-600 transition-colors"}),e.jsx(U,{placeholder:"بحث...",value:Ki,onChange:t=>Ac(t.target.value),className:"h-3 text-[8px] border-0 bg-transparent focus:ring-0 focus:outline-none text-gray-700 placeholder:text-gray-400"})]}),!O&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-green-600 mb-1",children:"شحن"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-green-50 text-green-600 hover:bg-green-100 border border-green-200 ring-3 ring-green-300 transition-all duration-200 hover:scale-105 active:bg-green-600 active:text-white active:border-green-600",onClick:()=>{i({title:"قيد التطوير",description:"هذه الميزة غير متاحة حالياً."})},title:"شحن الرصيد",children:e.jsx(jr,{className:"h-5 w-5 text-green-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"حاسبة"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>Fn(!0),title:"آلة حاسبة",children:e.jsx(To,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"كروت"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>{ot||Ot?i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):Or(!0)},title:"كروت الائتمان",children:e.jsx(jr,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-blue-600 mb-1",children:"تقاريرك"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-blue-50 text-blue-600 hover:bg-blue-100 border border-blue-200 ring-3 ring-blue-300 transition-all duration-200 hover:scale-105 active:bg-blue-600 active:text-white active:border-blue-600",onClick:()=>{if(ot||Ot){i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"});return}Al(!0)},title:"تقاريرك",children:e.jsx(qm,{className:"h-5 w-5 text-blue-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-blue-600 mb-1",children:"الوردية"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-blue-50 text-blue-600 hover:bg-blue-100 border border-blue-200 ring-3 ring-blue-300 transition-all duration-200 hover:scale-105 active:bg-blue-600 active:text-white active:border-blue-600",onClick:bd,title:f&&(w!=null&&w.name||w!=null&&w.username)?`بروفيل الوردية: ${(w==null?void 0:w.name)||(w==null?void 0:w.username)}`:"وردية الكاشير",children:e.jsx(Ii,{className:"h-5 w-5 text-blue-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"المبيعات"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>{ot||Ot?i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):Ka(!0)},title:"بيانات المبيعات",children:e.jsx(oo,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600",children:"الديون"}),At.filter(t=>t.status==="pending").length>0&&e.jsx("span",{className:"h-4 w-4 rounded-full bg-red-600 text-white text-[10px] flex items-center justify-center ring-2 ring-white",children:At.filter(t=>t.status==="pending").length})]}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>{Yn()},title:"الديون",children:e.jsx(om,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-amber-700 mb-1",children:"الصيانة"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-amber-50 text-amber-700 hover:bg-amber-100 border border-amber-200 ring-3 ring-amber-300 transition-all duration-200 hover:scale-105 active:bg-amber-600 active:text-white active:border-amber-600",onClick:()=>{ot||Ot?i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):Er(!0)},title:"الصيانة",children:e.jsx(jo,{className:"h-5 w-5 text-amber-700"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-yellow-500 mb-1",children:"المكنة"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-violet-50 text-violet-700 hover:bg-violet-100 border border-violet-200 ring-3 ring-violet-300 transition-all duration-200 hover:scale-105 active:bg-violet-700 active:text-white active:border-violet-700",onClick:()=>{!Ms||Ot?i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):_r(!0)},title:"يومية المكنة",children:e.jsx(Eo,{className:"h-5 w-5 text-yellow-500"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-orange-600 mb-1",children:"مصروفات"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-orange-50 text-orange-600 hover:bg-orange-100 border border-orange-200 ring-3 ring-orange-300 transition-all duration-200 hover:scale-105 active:bg-orange-600 active:text-white active:border-orange-600",onClick:()=>{ot||Ot?i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):ns.hasMasterPin()?It(!0):it(!0)},title:"مصروفات المحل",children:e.jsx(un,{className:"h-5 w-5 text-orange-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-rose-600 mb-1",children:"النواقص"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-rose-50 text-rose-600 hover:bg-rose-100 border border-rose-200 ring-3 ring-rose-300 transition-all duration-200 hover:scale-105 active:bg-rose-600 active:text-white active:border-rose-600",onClick:()=>{ot||Ot?i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):m(!0)},title:"النواقص",children:e.jsx(ro,{className:"h-5 w-5 text-rose-600"})})]})]})]})]}),!O&&e.jsx("div",{className:"mt-2 w-full",children:e.jsxs("div",{className:"filters-bar flex items-center justify-center gap-3 bg-gray-50 rounded-md p-3 border border-gray-200",children:[e.jsx(h,{variant:"ghost",size:"sm",className:`btn-filter-send h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${qs==="send"?"bg-green-600 text-white border-green-600":"text-green-700 border-green-300 hover:bg-green-50"}`,onClick:()=>Pn("send"),title:"تصفية التحويل",children:"التحويل"}),e.jsx(h,{variant:"ghost",size:"sm",className:`btn-filter-withdraw h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${qs==="withdraw"?"bg-red-600 text-white border-red-600":"text-red-700 border-red-300 hover:bg-red-50"}`,onClick:()=>Pn("withdraw"),title:"تصفية السحب",children:"السحب"}),e.jsx(h,{variant:"ghost",size:"sm",className:`btn-filter-all h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${qs==="all"?"bg-green-600 text-white border-green-600":"text-green-700 border-green-300 hover:bg-green-50"}`,onClick:()=>Pn("all"),title:"عرض الكل",children:"الكل"}),e.jsxs("div",{className:"relative ml-1",children:[e.jsxs(h,{variant:"ghost",size:"sm",className:"h-8 px-3 text-[12px] rounded-full border bg-red-50 text-red-700 border-red-300 hover:bg-red-100",onClick:()=>rr(!0),title:"تصفير المعاملات الأخيرة",children:[e.jsx(Yt,{className:"h-3.5 w-3.5 mr-1"}),"تصفير"]}),Pd>0&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 h-2 w-2 rounded-full bg-red-500 ring-2 ring-white"})]})]})})]}),el,e.jsxs(Nt,{className:"space-y-2 pt-0 px-4 pb-4 relative z-10",children:[bi.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(pr,{className:"h-12 w-12 mx-auto mb-2 text-gray-300"}),e.jsx("p",{className:"text-sm",children:"لا توجد معاملات حتى الآن"})]}):O?e.jsx("div",{className:"overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400 transition-colors max-h-[310px]",children:e.jsx("div",{className:"space-y-2 pr-2",children:bi.map(t=>e.jsxs("div",{className:"receipts-row flex items-center justify-between p-3 rounded-lg border cursor-pointer transition-all duration-200",onClick:()=>Vl(t),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[t.status==="completed"&&e.jsx(ha,{className:`h-4 w-4 ${t.type==="withdraw"?"text-red-500":"text-green-500"}`}),t.status==="pending"&&e.jsx(Zs,{className:"h-4 w-4 text-yellow-500"}),t.status==="failed"&&e.jsx(pn,{className:"h-4 w-4 text-red-500"})]}),e.jsxs("div",{children:[(()=>{const a=(t==null?void 0:t.type)==="report"||((t==null?void 0:t.title)||"").includes("إيصال تسليم وردية"),r=((t==null?void 0:t.title)||"").includes("إيصال إضافة نقدية");return e.jsx("p",{className:`font-medium text-sm ${a||r?"text-gray-800":t.type==="send"?"text-green-700":"text-red-700"}`,children:a?"إيصال تسليم وردية":r?`إيصال إضافة نقدية - ${bs(t.amount)} جنيه`:(t.type==="send"?"تحويل":"سحب")+` - ${bs(t.amount)} جنيه`})})(),e.jsxs("p",{className:"text-[10px] text-gray-700",children:["تمت بواسطة: ",(t==null?void 0:t.cashierName)??"الحساب الرئيسي"]}),(()=>{const a=(t==null?void 0:t.type)==="report"||((t==null?void 0:t.title)||"").includes("إيصال تسليم وردية"),r=((t==null?void 0:t.title)||"").includes("إيصال إضافة نقدية");return e.jsx("p",{className:`text-xs ${a||r?"text-gray-500":t.type==="send"?"text-green-600":"text-red-500"}`,children:a?`تم التسليم إلى: ${t.receiverPhone}`:r?t.notes?`ملاحظة: ${t.notes}`:"تمت إضافة نقدية للدرج":`من ${t.senderPhone}${t.type==="send"?` إلى ${t.receiverPhone}`:""}`})})(),e.jsxs("p",{className:"text-xs text-gray-400",children:[ln.format(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt))," - ",Yl.format(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt))]})]})]}),e.jsx(Mt,{variant:t.status==="completed"?"default":t.status==="pending"?"secondary":"destructive",className:`text-xs ${t.status==="completed"?t.type==="withdraw"?"bg-red-100 text-red-700 border-red-300":t.type==="send"?"bg-green-100 text-green-700 border-green-300":"":""}`,children:t.status==="completed"?"مكتمل":t.status==="pending"?"قيد المعالجة":"فشل"})]},t.id))})}):e.jsx("div",{className:"overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400 transition-colors max-h-[calc(100dvh-300px)]",children:e.jsx("div",{className:"space-y-2 pr-2",children:bi.map(t=>e.jsxs("div",{className:"receipts-row flex items-center justify-between p-3 rounded-lg border cursor-pointer transition-all duration-200",onClick:()=>Vl(t),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[t.status==="completed"&&e.jsx(ha,{className:`h-4 w-4 ${t.type==="withdraw"?"text-red-500":"text-green-500"}`}),t.status==="pending"&&e.jsx(Zs,{className:"h-4 w-4 text-yellow-500"}),t.status==="failed"&&e.jsx(pn,{className:"h-4 w-4 text-red-500"})]}),e.jsxs("div",{children:[(()=>{const a=(t==null?void 0:t.type)==="report"||((t==null?void 0:t.title)||"").includes("إيصال تسليم وردية"),r=((t==null?void 0:t.title)||"").includes("إيصال إضافة نقدية");return e.jsx("p",{className:`font-medium text-sm ${a||r?"text-gray-800":t.type==="send"?"text-green-700":"text-red-700"}`,children:a?"إيصال تسليم وردية":r?`إيصال إضافة نقدية - ${bs(t.amount)} جنيه`:(t.type==="send"?"تحويل":"سحب")+` - ${bs(t.amount)} جنيه`})})(),e.jsxs("p",{className:"text-[10px] text-gray-700",children:["تمت بواسطة: ",(t==null?void 0:t.cashierName)??"الحساب الرئيسي"]}),(()=>{const a=(t==null?void 0:t.type)==="report"||((t==null?void 0:t.title)||"").includes("إيصال تسليم وردية"),r=((t==null?void 0:t.title)||"").includes("إيصال إضافة نقدية");return e.jsx("p",{className:`text-xs ${a||r?"text-gray-500":t.type==="send"?"text-green-600":"text-red-500"}`,children:a?`تم التسليم إلى: ${t.receiverPhone}`:r?t.notes?`ملاحظة: ${t.notes}`:"تمت إضافة نقدية للدرج":`من ${t.senderPhone}${t.type==="send"?` إلى ${t.receiverPhone}`:""}`})})(),e.jsxs("p",{className:"text-xs text-gray-400",children:[ln.format(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt))," - ",Yl.format(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt))]})]})]}),e.jsx(Mt,{variant:t.status==="completed"?"default":t.status==="pending"?"secondary":"destructive",className:`text-xs ${t.status==="completed"?t.type==="withdraw"?"bg-red-100 text-red-700 border-red-300":t.type==="send"?"bg-green-100 text-green-700 border-green-300":"":""}`,children:t.status==="completed"?"مكتمل":t.status==="pending"?"قيد المعالجة":"فشل"})]},t.id))})}),O&&e.jsxs("div",{className:"mt-2 flex justify-end",children:[e.jsxs(h,{variant:"ghost",size:"sm",className:"h-7 px-2 text-[11px] rounded-full border bg-red-50 text-red-700 border-red-300 hover:bg-red-100",onClick:()=>rr(!0),title:"تصفير المعاملات الأخيرة",children:[e.jsx(Yt,{className:"h-3 w-3 mr-1"}),"تصفير"]}),(s==null?void 0:s.uid)&&localStorage.getItem(`recentTransactionsResetAt:${s.uid}`)&&e.jsx("span",{className:"inline-block h-1.5 w-1.5 rounded-full bg-red-500 ml-1 align-middle"})]})]})]})]}),e.jsx(Cm,{isOpen:bc,onClose:()=>Tr(!1),transaction:wc,onPrint:()=>window.print(),onDelete:Cc,onComplete:Ic}),e.jsxs("div",{className:"space-y-1 fade-in-right w-full lg:w-[92%] xl:w-[95%] mx-auto",children:[e.jsxs(xt,{id:"transaction-section",className:"bg-gradient-to-br from-white via-blue-50/30 to-indigo-50/50 border border-blue-200/40 rounded-lg shadow-lg hover:shadow-lg transition-all duration-200 group relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/5 via-indigo-500/3 to-purple-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-200"}),e.jsx("div",{className:"absolute top-0 right-0 w-32 h-32 sm:w-28 sm:h-28 lg:w-20 lg:h-20 bg-gradient-to-bl from-blue-400/10 to-transparent rounded-full  "}),e.jsx("div",{className:"absolute bottom-0 left-0 w-24 h-24 bg-gradient-to-tr from-indigo-400/10 to-transparent rounded-full  ",style:{animationDelay:"1s"}}),e.jsx(Ht,{className:"sticky top-0 z-20 bg-white/80 backdrop-blur supports-[backdrop-filter]:bg-white/60 pb-0.5 px-3 pt-1 lg:pt-0.5 lg:pb-0.5 lg:px-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(ds,{className:"text-sm font-bold flex items-center gap-2 text-gray-800",children:[e.jsxs("div",{className:"relative",children:[e.jsx(ha,{className:"h-1 w-1 text-emerald-500 "}),e.jsx("div",{className:"absolute inset-0 h-1 w-1 bg-emerald-400 rounded-full opacity-20 "})]}),e.jsx("span",{className:"bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent",children:"إجراء معاملة جديدة"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[pe&&e.jsx("div",{className:"hidden md:flex items-center gap-1 bg-gradient-to-r from-emerald-50 to-green-50 hover:from-emerald-100 hover:to-green-100 border border-emerald-200 text-emerald-800 text-sm transition-all duration-300 hover:scale-105 h-9 px-3 rounded-xl shadow-sm",children:e.jsxs("span",{className:"text-sm font-semibold whitespace-nowrap",children:["تجربة: ",Ie," ",Ie>=3&&Ie<=10?"ساعات":Ie===2?"ساعتين":"ساعة"]})}),e.jsxs("div",{className:"top-icons-bar hidden md:flex items-center gap-2 bg-gradient-to-r from-gray-50 to-slate-50 hover:from-gray-100 hover:to-slate-100 border border-gray-200 transition-all duration-300 hover:scale-105 h-9 px-3 rounded-xl shadow-sm",children:[e.jsx(rh,{}),e.jsx(h,{variant:"ghost",size:"icon",className:"h-8 w-8",title:"إدارة الفروع",onClick:()=>{i({title:"قيد التطوير",description:"الميزة غير متاحة حالياً"})},children:e.jsx(ko,{className:"h-5 w-5"})}),e.jsx(Sm,{})]})]}),Ed&&e.jsxs(h,{variant:"outline",size:"sm",className:"hidden flex items-center gap-1.5 sm:gap-2 bg-gradient-to-r from-cyan-50 to-blue-50 hover:from-cyan-100 hover:to-blue-100 border-cyan-200 text-cyan-800 text-xs sm:text-sm transition-all duration-300 hover:scale-105 hover:shadow-lg h-10 sm:h-12 px-4 sm:px-5 rounded-xl min-w-[44px] touch-manipulation",onClick:Bl,title:"مزامنة البيانات المحفوظة محلياً مع الخادم",children:[e.jsx($m,{className:"h-3.5 w-3.5 sm:h-4 sm:w-4 animate-spin"}),e.jsx("span",{className:"text-xs sm:text-sm font-semibold whitespace-nowrap",children:"مزامنة"})]})]})}),e.jsx(ce,{open:se,onOpenChange:xe,children:e.jsxs(de,{className:"sm:max-w-lg",children:[e.jsxs(me,{children:[e.jsx(he,{children:"إدارة الفروع"}),e.jsx(ss,{children:"أضف فروع جديدة وأدِر الدخول لكل فرع"}),e.jsx("div",{className:"flex items-center justify-end gap-2 mt-2",children:e.jsx(h,{variant:"outline",size:"sm",onClick:()=>{try{const t=s!=null&&s.uid?`selectedShopId_${s.uid}`:"selectedShopId";localStorage.removeItem(t);try{window.dispatchEvent(new Event("selectedShopIdChanged"))}catch{}i({title:"تم الخروج من الفرع"}),A(`/branch/${String(b.shopId)}/dashboard`)}catch{}},children:"الخروج من الفرع"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx(H,{children:"اسم المدير"}),e.jsx(U,{value:Se,onChange:t=>Ae(t.target.value),placeholder:"اكتب اسم المدير"})]}),e.jsxs("div",{children:[e.jsx(H,{children:"اسم الفرع"}),e.jsx(U,{value:je,onChange:t=>We(t.target.value),placeholder:"اكتب اسم الفرع"})]}),e.jsxs("div",{children:[e.jsx(H,{children:"اسم المستخدم للدخول"}),e.jsx(U,{value:Me,onChange:t=>Qe(t.target.value),placeholder:"مثال: branch1"})]}),e.jsxs("div",{children:[e.jsx(H,{children:"كلمة السر"}),e.jsx(U,{type:"password",value:G,onChange:t=>ue(t.target.value),placeholder:"••••••"})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(h,{variant:"outline",onClick:()=>{Ae(""),We(""),Qe(""),ue("")},children:"مسح"}),e.jsx(h,{className:"bg-indigo-600 hover:bg-indigo-700",disabled:fe,onClick:async()=>{if(!(s!=null&&s.uid))return;const t=Se.trim(),a=je.trim(),r=Me.trim(),l=G.trim();if(!t||!a||!r||!l){i({title:"يرجى ملء جميع الحقول"});return}try{Z(!0);let o="";try{o=(await Ts(_e(J,"shops"),{name:a,ownerId:s.uid,createdAt:Ye(),updatedAt:Ye(),isActive:!0})).id}catch{o=(await Ts(_e(J,"users",s.uid,"shops"),{name:a,ownerId:s.uid,createdAt:Ye(),updatedAt:Ye(),isActive:!0})).id}const d=x=>{try{return btoa(unescape(encodeURIComponent(x)))}catch{return btoa(x)}};try{await Ts(_e(J,"branches"),{ownerId:s.uid,shopId:o,branchName:a,managerName:t,loginUsername:r,passwordEncoded:d(l),createdAt:Ye()})}catch{await Ts(_e(J,"users",s.uid,"branches"),{ownerId:s.uid,shopId:o,branchName:a,managerName:t,loginUsername:r,passwordEncoded:d(l),createdAt:Ye()})}try{const x=et(_e(J,"branches"),Ce("ownerId","==",s.uid));let C=(await ct(x)).docs.map(y=>({id:y.id,...y.data()}));if(C.length===0){const y=et(_e(J,"users",s.uid,"branches"));C=(await ct(y)).docs.map(B=>({id:B.id,...B.data()}))}X(C)}catch{try{const x=et(_e(J,"users",s.uid,"branches")),C=(await ct(x)).docs.map(y=>({id:y.id,...y.data()}));X(C)}catch{}}Ae(""),We(""),Qe(""),ue(""),i({title:"تم إضافة الفرع بنجاح"})}catch{i({title:"تعذّر إضافة الفرع"})}finally{Z(!1)}},children:"إضافة فرع"})]}),e.jsxs("div",{className:"border-t pt-3",children:[e.jsx("h4",{className:"text-sm font-semibold mb-2",children:"الفروع الحالية"}),fe?e.jsx("div",{className:"text-sm text-gray-500",children:"جارٍ التحميل..."}):re.length===0?e.jsx("div",{className:"text-sm text-gray-500",children:"لا يوجد فروع بعد"}):e.jsx("div",{className:"space-y-2",children:re.map(t=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded-lg bg-white",children:[e.jsxs("div",{className:"text-sm",children:[e.jsx("div",{className:"font-medium",children:t.branchName}),e.jsxs("div",{className:"text-gray-600",children:["مدير: ",t.managerName]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(h,{size:"sm",className:"bg-blue-600 hover:bg-blue-700",onClick:()=>{Et(t),Le(String(t.loginUsername||"")),ht(""),ze(!0)},children:"دخول الفرع"}),e.jsx(h,{size:"sm",variant:"destructive",onClick:async()=>{if(confirm("هل أنت متأكد من حذف الفرع؟ سيتم حذف بيانات الفرع المرتبطة."))try{try{await ws($e(J,"branches",t.id))}catch{}try{await ws($e(J,"users",(s==null?void 0:s.uid)||"","branches",t.id))}catch{}if(t.shopId){try{await ws($e(J,"shops",String(t.shopId)))}catch{}try{await ws($e(J,"users",(s==null?void 0:s.uid)||"","shops",String(t.shopId)))}catch{}}X(a=>a.filter(r=>r.id!==t.id)),i({title:"تم حذف الفرع"})}catch{i({title:"تعذّر حذف الفرع"})}},children:"حذف الفرع"})]})]},t.id))})]})]})]})}),e.jsx(ce,{open:Q,onOpenChange:ze,children:e.jsxs(de,{className:"sm:max-w-md",children:[e.jsxs(me,{children:[e.jsx(he,{children:"دخول الفرع"}),e.jsx(ss,{children:"أدخل بيانات الدخول للفرع المحدد"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx(H,{children:"اسم المستخدم"}),e.jsx(U,{value:St,onChange:t=>Le(t.target.value),placeholder:"اسم المستخدم"})]}),e.jsxs("div",{children:[e.jsx(H,{children:"كلمة السر"}),e.jsx(U,{type:"password",value:Ct,onChange:t=>ht(t.target.value),placeholder:"••••••"})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(h,{variant:"outline",onClick:()=>{Le(""),ht("")},children:"مسح"}),e.jsx(h,{className:"bg-blue-600 hover:bg-blue-700",disabled:Dt,onClick:async()=>{const t=mt;if(!t){ze(!1);return}const a=String(t.loginUsername||"");let r="";try{const d=String(t.passwordEncoded||"");r=d?decodeURIComponent(escape(atob(d))):""}catch{try{r=t.passwordEncoded?atob(String(t.passwordEncoded)):""}catch{r=""}}const l=St.trim(),o=Ct.trim();if(!l||!o){i({title:"يرجى إدخال اسم المستخدم وكلمة السر"});return}if(l!==a||o!==r){i({title:"بيانات الدخول غير صحيحة",variant:"destructive"});return}try{be(!0);const d=s!=null&&s.uid?`selectedShopId_${s.uid}`:"selectedShopId";localStorage.setItem(d,String(t.shopId)),i({title:"تم الدخول إلى الفرع",description:String(t.branchName||"")}),ze(!1),xe(!1),A("/user/dashboard")}catch{}be(!1)},children:"دخول"})]})]})]})}),e.jsxs(Nt,{ref:u,className:"space-y-1 px-2 pb-2 relative z-10 transition-transform duration-200 ease-out will-change-transform",style:{transform:c?`translateY(${c}px)`:void 0},onFocusCapture:t=>{const a=t.target;if(!((a==null?void 0:a.id)==="transferExtraFeeInput")){p(0);return}const l=document.getElementById("transferSubmitButton");if(l){const o=l.getBoundingClientRect(),d=window.innerHeight;if(o.bottom>d){const x=o.bottom-d,g=Math.min(x,220);p(-g)}else p(0)}else p(0)},onBlurCapture:t=>{t.currentTarget.contains(t.relatedTarget)||p(0)},children:[e.jsxs("div",{className:"transaction-type-tabs grid grid-cols-2 gap-0.5 p-0.5 bg-gradient-to-r from-gray-50 to-slate-50 rounded-xl border border-gray-200/50 fade-in-up w-full lg:w-[92%] xl:w-[95%] mx-auto ",children:[e.jsxs(h,{variant:ie==="transfer"?"default":"ghost",onClick:()=>nn("transfer"),className:`text-xs font-semibold transition-all duration-300 hover:scale-105 h-7 rounded-lg px-2 ${ie==="transfer"?"bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg hover:shadow-md hover:from-blue-600 hover:to-indigo-700":"text-gray-600 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 hover:text-blue-700 hover:border-blue-200"}`,children:[e.jsx(pr,{className:"h-1 w-1 mr-1"}),"تحويل"]}),e.jsxs(h,{variant:ie==="withdraw"?"default":"ghost",onClick:()=>nn("withdraw"),className:`text-xs font-semibold transition-all duration-300 hover:scale-105 h-7 rounded-lg px-2 ${ie==="withdraw"?"bg-gradient-to-r from-emerald-500 to-green-600 text-white shadow-lg hover:shadow-md hover:from-emerald-600 hover:to-green-700":"text-gray-600 hover:bg-gradient-to-r hover:from-emerald-50 hover:to-green-50 hover:text-emerald-700 hover:border-emerald-200"}`,children:[e.jsx(gn,{className:"h-1 w-1 mr-1"}),"سحب"]})]}),e.jsxs("div",{className:"fade-in-up",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("label",{className:"text-sm font-semibold text-gray-700 block flex items-center gap-2",children:[e.jsx(Rs,{className:"h-1 w-1 text-blue-600"}),"اختيار المحفظة"]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsxs(h,{variant:"ghost",size:"sm",className:"h-6 rounded-md px-2 text-[10px] bg-emerald-50 text-emerald-700 hover:bg-emerald-100 border border-emerald-200",onClick:()=>A("/user/add-wallet"),title:"إضافة محفظة",children:[e.jsx(as,{className:"h-3 w-3 mr-1"}),"إضافة محفظة"]}),e.jsxs(h,{variant:"ghost",size:"sm",className:"h-6 rounded-md px-2 text-[10px] bg-indigo-50 text-indigo-700 hover:bg-indigo-100 border border-indigo-200",onClick:()=>{Dr(!0)},title:"المحافظ",children:[e.jsx(Rs,{className:"h-3 w-3 mr-1"}),"المحافظ"]})]})]}),Re.length>0?e.jsxs(na,{value:ee,onValueChange:Wd,children:[e.jsx(ia,{"data-testid":"wallet-select",className:"selected-number-card w-full h-12 text-sm bg-gradient-to-r from-white to-gray-50 border-2 border-gray-200 hover:border-blue-400 focus:border-blue-500 rounded-xl transition-all duration-300 hover:shadow-md focus:shadow-lg",children:e.jsx(la,{placeholder:"اختر محفظة للمعاملة",className:"text-gray-600"})}),e.jsxs(oa,{className:"rounded-xl border-2 border-gray-200 shadow-md z-[9999]",children:[e.jsx("div",{"data-fixed-header":"true",className:"sticky top-0 z-10 bg-white p-2 border-b border-gray-200",children:e.jsx(U,{value:Ui,onChange:t=>fc(t.target.value),placeholder:"ابحث برقم المحفظة",className:"h-6 text-xs"})}),e.jsx("div",{className:"pr-1",children:zi.length===0?e.jsx("div",{className:"text-xs text-gray-500 p-2",children:"لا توجد نتائج مطابقة"}):zi.map(t=>e.jsx(_s,{value:t.id,className:"rounded-lg hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 transition-all duration-200",children:e.jsxs("div",{className:"flex items-center gap-1 py-1 w-full justify-between",children:[e.jsx("div",{className:"p-1 bg-gradient-to-r from-blue-100 to-indigo-100 rounded-lg",children:e.jsx(Rs,{className:"h-1 w-1 text-blue-600"})}),e.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"text-sm font-medium text-gray-800",children:t.name}),e.jsxs("span",{className:"text-sm font-semibold text-red-600",children:["(",t.phone,")"]})]}),t.isDefault&&e.jsx(Mt,{variant:"secondary",className:"text-[10px] bg-gradient-to-r from-emerald-100 to-green-100 text-emerald-700 border-emerald-200",children:"افتراضي"})]}),e.jsx("div",{className:"ml-auto flex flex-col items-end gap-1"})]})},t.id))})]})]}):e.jsx("div",{className:"rounded-xl border-2 border-dashed border-gray-200 bg-gray-50 px-3 py-3 text-xs text-gray-600",children:"لا توجد محافظ حتى الآن. اضغط “إضافة محفظة” لإضافة أول محفظة."})]}),e.jsx(ce,{open:lc,onOpenChange:Fi,children:e.jsxs(de,{className:"sm:max-w-3xl w-[95vw] sm:w-auto max-h-[80vh] overflow-y-auto",children:[e.jsx(me,{children:e.jsx(he,{children:"عرض المحافظ"})}),e.jsx("div",{className:"mt-2",children:e.jsx(Lm,{showAddButton:!1,showUsageBars:!1,showLimitCards:!1,showEditButton:!0})})]})}),e.jsx(rs,{open:oc,onOpenChange:Dr,mode:"verify",title:"الرقم السري لفتح المحافظ",description:"أدخل الرقم السري الرئيسي لعرض وإدارة المحافظ",onSuccess:()=>{Dr(!1),Fi(!0)},userId:s==null?void 0:s.uid}),e.jsx(rs,{open:cc,onOpenChange:t=>{Dn(t),t||Cn(null)},mode:"verify",title:"تأكيد تغيير المحفظة",description:"أدخل الرقم السري الرئيسي لتغيير المحفظة المختارة",onSuccess:()=>{Mi&&(cr(Mi,"walletSelectionPin"),Cn(null)),Dn(!1)},userId:s==null?void 0:s.uid}),e.jsx(ce,{open:mc,onOpenChange:Cr,children:e.jsxs(de,{className:"sm:max-w-md",children:[e.jsx(me,{children:e.jsxs(he,{className:"flex items-center gap-2 text-red-700",children:[e.jsx(ro,{className:"h-5 w-5 text-red-600"}),"تحذير حد شهري للمحفظة"]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"p-3 rounded-md border bg-red-50 border-red-200",children:[e.jsxs("p",{className:"text-sm text-red-800",children:["المحفظة: ",e.jsx("span",{className:"font-semibold",children:(js==null?void 0:js.walletName)||""})]}),e.jsxs("p",{className:"text-sm text-red-800",children:["الاستخدام الشهري (",(js==null?void 0:js.type)==="withdraw"?"سحب":"تحويل","):",e.jsxs("span",{className:"font-mono",children:[" ",Number((js==null?void 0:js.used)||0).toLocaleString("en-US")," "]})," جنيه"]}),e.jsxs("p",{className:"text-sm text-red-800",children:["الحد الشهري: ",e.jsx("span",{className:"font-mono",children:Number((js==null?void 0:js.limit)||0).toLocaleString("en-US")})," جنيه"]}),e.jsx("p",{className:"text-sm font-semibold text-red-900 mt-1",children:"تم الوصول إلى 85% من الحد الشهري — يرجى الحذر قبل الاستمرار."})]}),e.jsx("div",{className:"flex justify-end gap-2",children:e.jsx(h,{variant:"outline",onClick:()=>Cr(!1),children:"حسناً"})})]})]})}),ee&&Re.length>0&&(()=>{var wt;const t=Re.find(Ft=>Ft.id===ee),a=Ks,r=Ld(ee),l=(qe==null?void 0:qe.monthlyWithdrawLimit)??(t==null?void 0:t.monthlyWithdrawalLimit)??2e5,o=(qe==null?void 0:qe.monthlyTransferLimit)??(t==null?void 0:t.monthlyTransferLimit)??2e5,d=a.totalWithdrawn??(qe==null?void 0:qe.monthlyWithdrawUsed)??0,x=a.totalTransferred??(qe==null?void 0:qe.monthlyTransferUsed)??0,g=((wt=vt==null?void 0:vt.subscription)==null?void 0:wt.planType)===cs.TAHWEELA,C=g?0:(qe==null?void 0:qe.dailyWithdrawLimit)??1e5,y=g?0:(qe==null?void 0:qe.dailyTransferLimit)??6e4,j=g?0:r.totalWithdrawn??(qe==null?void 0:qe.dailyWithdrawUsed)??0,B=g?0:r.totalTransferred??(qe==null?void 0:qe.dailyTransferUsed)??0,$=parseFloat($t||"0")||0,z=d+(ie==="withdraw"?$:0),Ne=x+(ie==="transfer"?$:0),bt=j+(ie==="withdraw"?$:0),He=B+(ie==="transfer"?$:0);return t?e.jsxs("div",{className:"fade-in-up mb-2 space-y-2",children:[e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-1 rounded-md border border-gray-200 shadow-sm hover:shadow-md transition-all duration-300",children:[e.jsxs("div",{className:"text-[10px] text-gray-600 font-medium mb-1 text-center",children:["الحدود الشهرية: ",t.name]}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-red-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-red-400 to-red-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(z/Math.max(l,1)*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-blue-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-400 to-blue-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(Ne/Math.max(o,1)*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-[10px] text-red-600 font-medium",children:["متبقي سحب: ",Math.max(l-z,0).toLocaleString("en-US")," جنيه"]}),e.jsxs("div",{className:"text-[10px] text-blue-600 font-medium",children:["متبقي تحويل: ",Math.max(o-Ne,0).toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-1 rounded-md border border-gray-200 shadow-sm hover:shadow-md transition-all duration-300",children:[e.jsxs("div",{className:"text-[10px] text-gray-600 font-medium mb-1 text-center",children:["الحدود اليومية: ",t.name]}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-orange-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-orange-400 to-orange-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(bt/Math.max(C,1)*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-green-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-green-400 to-green-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(He/Math.max(y,1)*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-[10px] text-orange-600 font-medium",children:["متبقي سحب يومي: ",Math.max(C-bt,0).toLocaleString("en-US")," جنيه"]}),e.jsxs("div",{className:"text-[10px] text-green-600 font-medium",children:["متبقي تحويل يومي: ",Math.max(y-He,0).toLocaleString("en-US")," جنيه"]})]})]})]}):null})(),ie==="transfer"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المرسل"}),e.jsxs("div",{className:"relative",children:[e.jsx(Qs,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(U,{value:qt,onChange:t=>Va(t.target.value),onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("receiverPhoneInput");if(a)a.focus();else{const r=document.getElementById("amountInput");r==null||r.focus()}}},placeholder:"01030302038",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]})]}),!M&&e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المستقبل"}),e.jsxs("div",{className:"relative",children:[e.jsx(Qs,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(U,{id:"receiverPhoneInput",value:os,onChange:t=>{Pa(t.target.value),_n&&Oa(!1)},onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("amountInput");a==null||a.focus()}},inputMode:"numeric",maxLength:11,placeholder:"أدخل رقم المستقبل",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المستقبل"}),e.jsxs("div",{className:"relative",children:[e.jsx(Qs,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(U,{value:ee&&((Gl=Re.find(t=>t.id===ee))==null?void 0:Gl.phone)||"",readOnly:!0,placeholder:"اختر محفظة أولاً",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base bg-gray-50 transition-all duration-300"})]})]}),ie==="transfer"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"المبلغ (جنيه)"}),e.jsxs("div",{className:"relative flex items-center gap-2",children:[e.jsx(Pt,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(U,{id:"amountInput",value:$t,onChange:t=>{Ja(t.target.value),_n&&Oa(!1)},onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("transferCommissionInput");if(a)a.focus();else{const r=document.getElementById("quickDebtButton");r==null||r.focus()}}},placeholder:"أدخل المبلغ",type:"number",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),Os?e.jsxs("div",{className:"mt-2 text-xs text-green-700 bg-green-50 border border-green-200 rounded px-2 py-1 flex items-center gap-2",children:[e.jsxs("span",{children:["تم إدخال تفاصيل الأجل لـ ",Os.debtorName," بمبلغ ",Os.amount," جنيه"]}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"h-6 px-2",onClick:()=>Sn(null),children:"إلغاء"})]}):null]}),(()=>{if(M)return null;const t=Zt();return t&&t.defaultTransferCommission!=null?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة التحويل (تلقائية)"}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["سيتم تطبيق عمولة التحويل الافتراضية لكل ألف: ",t==null?void 0:t.defaultTransferCommission," جنيه لكل ألف"]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(h,{id:"quickDebtButton",type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const r=Zt(),l=(r==null?void 0:r.defaultTransferCommission)!=null?Number(r.defaultTransferCommission):0,o=parseFloat($t||"0")||0,d=Math.round((l||0)*o/1e3*100)/100,x=o+d;pa((x||0).toString()),ot?i({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):ka(!0)},children:"أجل"}),e.jsx(h,{type:"button",variant:"outline",size:"icon",className:"hidden",title:tt?"العمولة تُضاف":"العمولة تُخصم",children:tt?e.jsx(as,{className:"h-4 w-4 text-green-600"}):e.jsx(ja,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"hidden",children:tt?"العمولة تُضاف":"العمولة تُخصم"})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة التحويل على العملية (جنيه)"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(Pt,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-orange-500"}),e.jsx(U,{id:"transferCommissionInput",value:us,onChange:r=>An(r.target.value),placeholder:"أدخل عمولة التحويل",type:"number",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),e.jsx(h,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const r=Zt(),l=parseFloat($t||"0")||0;let o=0;if((r==null?void 0:r.defaultTransferCommission)!=null){const x=Number(r.defaultTransferCommission)||0;o=Math.round(x*l/1e3*100)/100}else{const x=us&&us.trim()!==""?parseFloat(us):0;o=Math.max(0,x)}const d=l+o;pa((d||0).toString()),ot?i({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):ka(!0)},children:"أجل"}),e.jsx(h,{type:"button",variant:"outline",size:"icon",className:"hidden",title:tt?"العمولة تُضاف":"العمولة تُخصم",children:tt?e.jsx(as,{className:"h-4 w-4 text-green-600"}):e.jsx(ja,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"hidden",children:tt?"العمولة تُضاف":"العمولة تُخصم"})]}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"يمكنك إدخال عمولة العملية الإجمالية (اختياري)"})]})})(),(()=>{const t=Ir(qt||"").replace(/\D/g,""),a=Ir(os||"").replace(/\D/g,"");return ie==="transfer"&&(t.startsWith("010")&&(a.startsWith("011")||a.startsWith("012")||a.startsWith("015"))||t.startsWith("012")&&a.startsWith("010")||t.startsWith("011")&&a.startsWith("010")||t.startsWith("015")&&a.startsWith("010"))?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رسوم التحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Pt,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-orange-500"}),e.jsx(U,{id:"transferExtraFeeInput",value:Li,onChange:l=>dc(l.target.value),placeholder:"أدخل رسوم التحويل",type:"number",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),e.jsx("div",{className:"hidden",children:"تُخصم من المحفظة وتضاف للدرج — لعمليات 010 → 011/012/015 أو 012 → 010 أو 011 → 010 أو 015 → 010"})]}):null})(),e.jsx("div",{className:"sticky bottom-0 z-10 pt-2 bg-white/80 backdrop-blur supports-[backdrop-filter]:bg-white/60",children:e.jsx(h,{id:"transferSubmitButton",onClick:Kl,className:"btn-transfer-confirm w-full font-medium h-11 lg:h-12 text-sm lg:text-base btn-bounce hover-glow transition-all duration-300 text-white",children:_n?"تم التحويل بنجاح":"تأكيد التحويل"})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"مبلغ السحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(gn,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-green-500"}),e.jsx(U,{id:"amountInput",value:$t,onChange:t=>{Ja(t.target.value),Qi&&Qa(!1)},onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("manualWithdrawCommissionInput");if(a)a.focus();else{const r=document.getElementById("withdrawSubmitButton");r==null||r.focus()}}},placeholder:"أدخل مبلغ السحب",type:"number",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]})]}),(()=>{const t=Zt();return t&&t.defaultWithdrawCommission!=null?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة السحب (تلقائية)"}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["سيتم تطبيق عمولة السحب الافتراضية لكل ألف: ",t==null?void 0:t.defaultWithdrawCommission," جنيه لكل ألف"]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(h,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const r=Zt(),l=parseFloat($t||"0")||0,o=(r==null?void 0:r.defaultWithdrawCommission)!=null&&Number(r.defaultWithdrawCommission)||0,d=Math.round(o*l/1e3*100)/100,x=tt?l+d:l;pa((x||0).toString()),ot?i({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):ka(!0)},children:"أجل"}),e.jsx(h,{type:"button",variant:"outline",size:"icon",className:"h-8 w-8",onClick:()=>Tn(r=>!r),title:tt?"العمولة تُضاف إلى الدين":"العمولة تُخصم من الدين",children:tt?e.jsx(as,{className:"h-4 w-4"}):e.jsx(ja,{className:"h-4 w-4"})}),e.jsx("span",{className:"text-xs text-gray-600",children:tt?"العمولة تُضاف":"العمولة تُخصم"})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة السحب على العملية (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Pt,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-orange-500"}),e.jsx(U,{id:"manualWithdrawCommissionInput",value:hs,onChange:r=>In(r.target.value),onKeyDown:r=>{if(r.key==="Enter"){const l=document.getElementById("withdrawSubmitButton");l==null||l.focus()}},placeholder:"أدخل العمولة المطلوبة",type:"number",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"أدخل العمولة الإجمالية لإتمام عملية السحب"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(h,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const r=Zt(),l=parseFloat($t||"0")||0;let o=0;if((r==null?void 0:r.defaultWithdrawCommission)!=null){const x=Number(r.defaultWithdrawCommission)||0;o=Math.round(x*l/1e3*100)/100}else{const x=hs&&hs.trim()!==""?parseFloat(hs):Math.round(l*.01*100)/100;o=Math.max(0,x)}const d=tt?l+o:l;pa((d||0).toString()),ot?i({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):ka(!0)},children:"أجل"}),e.jsx(h,{type:"button",variant:"outline",size:"icon",title:tt?"العمولة تُضاف":"العمولة تُخصم",onClick:()=>Tn(r=>!r),children:tt?e.jsx(as,{className:"h-4 w-4 text-green-600"}):e.jsx(ja,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"text-xs text-gray-600",children:tt?"العمولة تُضاف":"العمولة تُخصم"})]})]})})(),(I==null?void 0:I.showWithdrawNote)&&e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"ملاحظة السحب (اختياري)"}),e.jsxs("div",{className:"relative",children:[e.jsx(cm,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(U,{id:"withdrawNoteInput",value:xa,onChange:t=>Oi(t.target.value),onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("withdrawSubmitButton");a==null||a.focus()}},placeholder:"أدخل ملاحظة للسحب (اختياري)",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]})]}),e.jsx("div",{className:"sticky bottom-0 z-10 pt-2 bg-white/80 backdrop-blur supports-[backdrop-filter]:bg-white/60",children:e.jsx(h,{id:"withdrawSubmitButton",onClick:Kl,className:"w-full font-medium h-11 lg:h-12 text-sm lg:text-base btn-bounce hover-glow transition-all duration-300 bg-green-600 hover:bg-green-700 text-white",children:Qi?"تم السحب بنجاح":"تأكيد السحب"})})]}),e.jsx(ce,{open:bn,onOpenChange:ka,children:e.jsxs(de,{children:[e.jsxs(me,{children:[e.jsx(he,{children:"تحويل مؤجل"}),e.jsx(ss,{children:"أدخل بيانات صاحب الدين والمبلغ والملاحظات ثم اضغط حفظ"})]}),e.jsxs("div",{className:"space-y-3",children:[Js&&Js.length>0?e.jsxs("div",{children:[e.jsx(H,{children:"اختيار عميل"}),e.jsxs(na,{value:jn,onValueChange:t=>{nc(t);const a=Js.find(r=>r.id===t);a&&Nn(a.name)},children:[e.jsx(ia,{className:"w-full",children:e.jsx(la,{placeholder:"اختر عميل"})}),e.jsx(oa,{children:Js.map(t=>e.jsxs(_s,{value:t.id,children:[t.name,t.mobile?` — ${t.mobile}`:""]},t.id))})]})]}):e.jsx("div",{className:"text-xs text-gray-500",children:"لا يوجد عملاء مُسجلين حالياً. يمكنك إضافة عميل من نافذة الديون."}),e.jsxs("div",{children:[e.jsx(H,{htmlFor:"quickDebtName",children:"اسم صاحب الدين"}),e.jsx(U,{id:"quickDebtName",value:wn,onChange:t=>Nn(t.target.value),placeholder:"اكتب الاسم"})]}),e.jsxs("div",{children:[e.jsx(H,{htmlFor:"quickDebtAmount",children:"المبلغ (محسوب تلقائياً)"}),e.jsx(U,{id:"quickDebtAmount",type:"number",value:rc,readOnly:!0,placeholder:"المبلغ + عمولة التحويل"})]}),e.jsxs("div",{children:[e.jsx(H,{htmlFor:"quickDebtNotes",children:"ملاحظات"}),e.jsx(U,{id:"quickDebtNotes",value:Ei,onChange:t=>_i(t.target.value),placeholder:"اكتب ملاحظات (اختياري)"})]})]}),e.jsx(Ge,{children:e.jsx(h,{type:"button",variant:"default",className:"bg-green-600 text-white hover:bg-green-700",onClick:()=>{const t=Zt(),a=parseFloat(($t||"").toString())||0;let r=0;if(ie==="transfer")if((t==null?void 0:t.defaultTransferCommission)!=null){const d=Number(t.defaultTransferCommission)||0;r=Math.round(d*a/1e3*100)/100}else{const d=us&&us.trim()!==""?parseFloat(us):0;r=Math.max(0,d)}else if((t==null?void 0:t.defaultWithdrawCommission)!=null){const d=Number(t.defaultWithdrawCommission)||0;r=Math.round(d*a/1e3*100)/100}else{const d=hs&&hs.trim()!==""?parseFloat(hs):Math.round(a*.01*100)/100;r=Math.max(0,d)}let l=0;if(ie==="withdraw"?l=tt?a:Math.max(0,Math.round((a-r)*100)/100):l=Math.max(0,Math.round((a+r)*100)/100),!wn||isNaN(l)||l<=0){i({title:"خطأ في بيانات الأجل",description:"يرجى إدخال الاسم والمبلغ بشكل صحيح",variant:"destructive"});return}const o=Js.find(d=>d.id===jn);Sn({debtorName:wn,amount:l,notes:Ei,customerId:jn||void 0,mobile:o==null?void 0:o.mobile}),Wi(!1),ka(!1),i({title:"تم حفظ بيانات الأجل",description:"سيتم إضافة الدين عند تأكيد العملية",variant:"default"})},children:"حفظ"})})]})})]})]}),e.jsx(xt,{className:"bg-gradient-to-br from-red-50 to-red-100 border-red-200 fade-in-up card-float",children:e.jsxs(Nt,{className:"p-3 text-center",children:[e.jsx("div",{className:"text-red-600 font-medium text-[10px] mb-1",children:"⚠️ تحذير من التحويل"}),e.jsx("div",{className:"text-[10px] text-red-700",children:"لا يمكن إلغاء أي عملية بعد تأكيدها للمحافظة على الأمان"})]})})]})]}),e.jsx(Gm,{isOpen:xc,onClose:()=>pc(!1),initialEditingWallet:gc,onWalletUpdate:async()=>{try{await or()}catch(t){console.error("Error reloading wallets after update:",t)}}}),e.jsx(Qm,{isOpen:vc,onClose:()=>qi(!1),transaction:yc,onDelete:Fd}),e.jsx(rs,{open:Sc,onOpenChange:Ha,onSuccess:Bd,title:$d(),description:Ud(),mode:"verify"}),e.jsx(ho,{open:id,onOpenChange:bl,onSuccess:qd,title:"تعديل الرصيد النقدي في الدرج",description:"أدخل الرقم السري والمبلغ الجديد لتعديل الرصيد النقدي في الدرج",currentBalance:lt,balanceLabel:"الرصيد النقدي",userId:s==null?void 0:s.uid}),e.jsx(ho,{open:ld,onOpenChange:wl,onSuccess:Vd,title:"تعديل رصيد المحفظة",description:"أدخل الرقم السري والمبلغ الجديد لتعديل رصيد المحفظة",currentBalance:ys&&Be[ys]||0,balanceLabel:`رصيد ${((Ql=Re.find(t=>t.id===ys))==null?void 0:Ql.name)||"المحفظة"}`,userId:s==null?void 0:s.uid}),e.jsx(th,{open:od,onOpenChange:ri,onSuccess:Jd,title:"إضافة أو خصم مبلغ من رصيد المحفظة",description:"أدخل الرقم السري والمبلغ المراد إضافته أو خصمه من رصيد المحفظة",currentBalance:ys&&Be[ys]||0,balanceLabel:`رصيد ${((Zl=Re.find(t=>t.id===ys))==null?void 0:Zl.name)||"المحفظة"}`,userId:s==null?void 0:s.uid}),e.jsx(Zm,{open:wd,onOpenChange:Nd,userId:s==null?void 0:s.uid}),e.jsx(Xm,{open:jd,onOpenChange:Sd,userId:s==null?void 0:s.uid}),e.jsx(eh,{open:Dd,onOpenChange:Cd}),e.jsx(ce,{open:md,onOpenChange:Br,children:e.jsxs(de,{className:"sm:max-w-md",children:[e.jsx(me,{children:e.jsx(he,{className:"text-right",children:"تعديل الدرج النقدية"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(H,{htmlFor:"amount",className:"text-right block",children:"المبلغ"}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx(U,{id:"amount",type:"number",placeholder:"أدخل المبلغ",value:ii,onChange:t=>$r(t.target.value),className:"text-right flex-1",dir:"rtl",min:"0"}),e.jsxs("div",{className:"flex gap-1",children:[e.jsxs(h,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white px-3 py-2",onClick:async()=>{if(!await rn(pi)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}const t=parseFloat(ii);if(isNaN(t)||t<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const a=lt+t;Jt(a);const r={cashBalance:a,lastUpdated:new Date().toISOString()},l=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(l,JSON.stringify(r)),s!=null&&s.uid?De.updateUserData(s.uid,r).then(()=>{console.log("✅ تم حفظ رصيد الدرج النقدي في Firebase بنجاح"),localStorage.removeItem(l),ke(!1)}).catch(o=>{console.error("❌ خطأ في حفظ الرصيد في Firebase:",o),ke(!0)}):ke(!0),i({title:"تم بنجاح",description:`تم إضافة ${t} جنيه إلى الدرج النقدية وحفظه في السحابة`}),Br(!1),$r(""),Kr("")},children:[e.jsx(as,{className:"h-1 w-1 mr-1"}),"إضافة"]}),e.jsxs(h,{type:"button",size:"sm",className:"bg-red-600 hover:bg-red-700 text-white px-3 py-2",onClick:async()=>{if(!await rn(pi)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}const t=parseFloat(ii);if(isNaN(t)||t<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const a=lt-t;Jt(a);const r={cashBalance:a,lastUpdated:new Date().toISOString()},l=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(l,JSON.stringify(r)),s!=null&&s.uid?De.updateUserData(s.uid,r).then(()=>{console.log("✅ تم حفظ رصيد الدرج النقدي في Firebase بنجاح"),localStorage.removeItem(l),ke(!1)}).catch(o=>{console.error("❌ خطأ في حفظ الرصيد في Firebase:",o),ke(!0)}):ke(!0),i({title:"تم بنجاح",description:`تم خصم ${t} جنيه من الدرج النقدية وحفظه في السحابة`}),Br(!1),$r(""),Kr("")},children:[e.jsx(ja,{className:"h-1 w-1 mr-1"}),"خصم"]})]})]}),e.jsxs("p",{className:"text-[10px] text-gray-500 text-right",children:["الرصيد الحالي: ",lt.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(H,{htmlFor:"pin",className:"text-right block",children:"الرقم السري"}),e.jsx(U,{id:"pin",type:"password",placeholder:"أدخل الرقم السري",value:pi,onChange:t=>Kr(t.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsx(Ge,{className:"flex gap-2",children:e.jsx(h,{variant:"outline",onClick:()=>{Br(!1),$r(""),Kr("")},children:"إلغاء"})})]})}),e.jsx(ce,{open:kd,onOpenChange:tn,children:e.jsxs(de,{className:"sm:max-w-md",children:[e.jsx(me,{children:e.jsx(he,{className:"text-right text-red-600",children:"تصفير إجمالي المحفظة"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-red-50 rounded-lg border border-red-200",children:[e.jsx("p",{className:"text-red-800 font-medium mb-2",children:"تحذير!"}),e.jsx("p",{className:"text-red-700 text-sm",children:"سيتم تصفير جميع أرصدة المحافظ إلى صفر. هذا الإجراء لا يمكن التراجع عنه."}),e.jsxs("p",{className:"text-red-600 text-sm mt-2",children:["الرصيد الحالي: ",Object.values(Be).reduce((t,a)=>t+a,0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(H,{htmlFor:"resetWalletTotalPin",className:"text-right block",children:"الرقم السري الرئيسي"}),e.jsx(U,{id:"resetWalletTotalPin",type:"password",placeholder:"أدخل الرقم السري الرئيسي",value:zl,onChange:t=>sn(t.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsxs(Ge,{className:"flex gap-2",children:[e.jsx(h,{variant:"outline",onClick:()=>{tn(!1),sn("")},children:"إلغاء"}),e.jsx(h,{variant:"destructive",onClick:async()=>{if(!await ns.verifyMasterPin(zl,s==null?void 0:s.uid)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}try{const a={};Object.keys(Be).forEach(d=>{a[d]=0}),Xt(a),localStorage.setItem(fs(),JSON.stringify(a)),tn(!1),sn("");const r=new Date().toISOString(),l={walletBalances:a,lastUpdated:r},o=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(o,JSON.stringify(l)),s!=null&&s.uid?De.updateUserData(s.uid,l).then(()=>{localStorage.removeItem(o),ke(!1)}).catch(d=>{console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",d),ke(!0),i({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):ke(!0),setTimeout(()=>{Xt({...a})},100)}catch(a){console.error("خطأ في تصفير أرصدة المحافظ:",a),i({title:"خطأ",description:"حدث خطأ أثناء تصفير المحافظ",variant:"destructive"})}},children:"تصفير المحفظة"})]})]})}),e.jsx(ce,{open:cd,onOpenChange:Rr,children:e.jsxs(de,{className:"sm:max-w-md",children:[e.jsx(me,{children:e.jsx(he,{className:"text-right text-red-600",children:"تصفير رصيد المحفظة المختارة"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-red-50 rounded-lg border border-red-200",children:[e.jsx("p",{className:"text-red-800 font-medium mb-2",children:"تحذير!"}),e.jsx("p",{className:"text-red-700 text-sm",children:"سيتم تصفير رصيد المحفظة المحددة إلى صفر. هذا الإجراء لا يمكن التراجع عنه."}),e.jsxs("p",{className:"text-red-600 text-sm mt-2",children:["المحفظة: ",((Xl=Re.find(t=>t.id===ee))==null?void 0:Xl.name)||ee]}),e.jsxs("p",{className:"text-red-600 text-sm",children:["الرصيد الحالي: ",(ee&&Be[ee]?Be[ee]:0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(H,{htmlFor:"resetSelectedWalletPin",className:"text-right block",children:"الرقم السري الرئيسي"}),e.jsx(U,{id:"resetSelectedWalletPin",type:"password",autoComplete:"off",placeholder:"أدخل الرقم السري الرئيسي",value:Nl,onChange:t=>ni(t.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsxs(Ge,{className:"flex gap-2",children:[e.jsx(h,{variant:"outline",onClick:()=>{Rr(!1),ni("")},children:"إلغاء"}),e.jsx(h,{variant:"destructive",onClick:async()=>{var a;if(!ee){i({title:"اختر محفظة",description:"يرجى اختيار محفظة أولاً",variant:"destructive"});return}if(!await ns.verifyMasterPin(Nl,s==null?void 0:s.uid)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}try{const r={...Be};r[ee]=0,Xt(r),localStorage.setItem(fs(),JSON.stringify(r)),Rr(!1),ni("");const l=new Date().toISOString(),o={walletBalances:r,lastUpdated:l},d=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(d,JSON.stringify(o)),s!=null&&s.uid?De.updateUserData(s.uid,o).then(()=>{localStorage.removeItem(d),ke(!1)}).catch(x=>{console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",x),ke(!0),i({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):ke(!0),i({title:"تم التصفير بنجاح",description:`تم تصفير رصيد المحفظة ${((a=Re.find(x=>x.id===ee))==null?void 0:a.name)||ee}`})}catch(r){console.error("خطأ في تصفير رصيد المحفظة المختارة:",r),i({title:"خطأ",description:"حدث خطأ أثناء تصفير رصيد المحفظة المختارة",variant:"destructive"})}},children:"تصفير المحفظة"})]})]})}),e.jsx(ce,{open:Td,onOpenChange:Xr,children:e.jsxs(de,{className:"sm:max-w-md",children:[e.jsx(me,{children:e.jsxs(he,{className:"text-right text-green-600 flex items-center gap-2 justify-end",children:[e.jsx(as,{className:"h-4 w-4"}),"إضافة أموال لإجمالي المحفظة"]})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-green-50 rounded-lg border border-green-200",children:[e.jsx("p",{className:"text-green-800 font-medium mb-2",children:"إضافة أموال"}),e.jsx("p",{className:"text-green-700 text-sm",children:"سيتم إضافة المبلغ المحدد إلى إجمالي المحفظة بشكل متناسب على جميع المحافظ."}),e.jsxs("p",{className:"text-green-600 text-sm mt-2",children:["الرصيد الحالي: ",Object.values(Be).reduce((t,a)=>t+a,0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"addWalletTotalAmount",className:"text-right block",children:"المبلغ المراد إضافته"}),e.jsx(U,{id:"addWalletTotalAmount",type:"number",placeholder:"أدخل المبلغ",value:Fl,onChange:t=>gi(t.target.value),className:"text-right",dir:"rtl"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"addWalletTotalPin",className:"text-right block",children:"الرقم السري للتأكيد"}),e.jsx(U,{id:"addWalletTotalPin",type:"password",autoComplete:"off",placeholder:"أدخل الرقم السري",value:Ml,onChange:t=>fi(t.target.value),className:"text-right",dir:"rtl"})]})]})]}),e.jsxs(Ge,{className:"flex gap-2",children:[e.jsx(h,{variant:"outline",onClick:()=>{Xr(!1),gi(""),fi("")},children:"إلغاء"}),e.jsx(h,{variant:"default",className:"bg-green-600 hover:bg-green-700",disabled:Ll,onClick:async()=>{const t=parseFloat(Fl);if(!t||t<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}if(!await _d(Ml)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}Rl(!0);try{const a=Object.values(Be).reduce((r,l)=>r+l,0);if(a===0){const r=Object.keys(Be),l=t/r.length,o={};r.forEach(d=>{o[d]=l}),Xt(o),localStorage.setItem(fs(),JSON.stringify(o)),s!=null&&s.uid?await De.updateUserData(s.uid,{walletBalances:o,lastUpdated:new Date().toISOString()}):ke(!0)}else{const r={};Object.entries(Be).forEach(([l,o])=>{const d=o/a,x=t*d;r[l]=o+x}),Xt(r),localStorage.setItem(fs(),JSON.stringify(r)),s!=null&&s.uid?await De.updateUserData(s.uid,{walletBalances:r,lastUpdated:new Date().toISOString()}):ke(!0)}setTimeout(()=>{Xt(r=>({...r}))},100),Xr(!1),gi(""),fi("")}catch(a){console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",a),i({title:"خطأ",description:"حدث خطأ أثناء حفظ البيانات",variant:"destructive"})}finally{Rl(!1)}},children:Ll?"جاري الإضافة...":"إضافة الأموال"})]})]})}),e.jsx(ce,{open:Od,onOpenChange:an,children:e.jsxs(de,{className:"sm:max-w-[425px]",children:[e.jsx(me,{children:e.jsxs(he,{className:"text-red-600 flex items-center gap-2",children:[e.jsx(Yt,{className:"h-1 w-1"}),"تصفير الرصيد النقدي"]})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-3",children:e.jsx("p",{className:"text-sm text-red-700",children:"⚠️ تحذير: سيتم تصفير الرصيد النقدي في الدرج إلى صفر. هذا الإجراء لا يمكن التراجع عنه."})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(H,{htmlFor:"resetCashPin",children:"الرقم السري الرئيسي"}),e.jsx(U,{id:"resetCashPin",type:"password",autoComplete:"off",placeholder:"أدخل الرقم السري الرئيسي",value:yi,onChange:t=>vi(t.target.value)})]})]}),e.jsxs(Ge,{children:[e.jsx(h,{variant:"outline",onClick:()=>{an(!1),vi("")},children:"إلغاء"}),e.jsx(h,{variant:"destructive",onClick:async()=>{if(!yi){i({title:"خطأ",description:"يرجى إدخال الرقم السري",variant:"destructive"});return}if(!await ns.verifyMasterPin(yi,s==null?void 0:s.uid)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}try{Jt(0),an(!1),vi("");const a={cashBalance:0,lastUpdated:new Date().toISOString()};localStorage.setItem(Ds(),"0");const r=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(r,JSON.stringify(a)),s!=null&&s.uid?De.updateUserData(s.uid,a).then(()=>{localStorage.removeItem(r),ke(!1)}).catch(l=>{console.error("خطأ في حفظ الرصيد في Firebase:",l),ke(!0),i({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):ke(!0)}catch(a){console.error("خطأ في تصفير الرصيد النقدي:",a),i({title:"خطأ",description:"حدث خطأ أثناء تصفير الرصيد النقدي",variant:"destructive"})}},children:"تصفير الرصيد"})]})]})}),e.jsx(lh,{open:Ad,onOpenChange:Wl,userId:s==null?void 0:s.uid,cashBalance:lt,walletBalances:Be,transactions:Xe}),e.jsx(ce,{open:Id,onOpenChange:nr,children:e.jsxs(de,{className:"sm:max-w-[425px]",children:[e.jsx(me,{children:e.jsxs(he,{className:"text-green-600 flex items-center gap-2",children:[e.jsx(as,{className:"h-4 w-4"}),"إضافة أموال للدرج"]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-3",children:e.jsx("p",{className:"text-sm text-green-700",children:"💰 سيتم إضافة المبلغ المحدد إلى الرصيد النقدي في الدرج"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"addCashAmount",children:"المبلغ المراد إضافته"}),e.jsx(U,{id:"addCashAmount",type:"number",placeholder:"أدخل المبلغ",value:ba,onChange:t=>Yr(t.target.value),min:"0",step:"0.01"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{className:"text-right",children:"هل تريد إضافة ملاحظة؟"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(h,{type:"button",variant:La==="yes"?"default":"outline",onClick:()=>lr("yes"),className:"flex-1",children:"نعم"}),e.jsx(h,{type:"button",variant:La==="no"?"default":"outline",onClick:async()=>{if(lr("no"),!ba||parseFloat(ba)<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح أكبر من صفر",variant:"destructive"});return}if(!ir){i({title:"خطأ",description:"يرجى إدخال الرقم السري",variant:"destructive"});return}if(!await rn(ir)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}Gr(!0);try{const t=parseFloat(ba),a=lt+t;Jt(a),localStorage.setItem(Ds(),a.toString());const r={cashBalance:a,lastUpdated:new Date().toISOString()},l=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(l,JSON.stringify(r)),s!=null&&s.uid?(await De.updateUserData(s.uid,r),localStorage.removeItem(l),ke(!1)):ke(!0);const o={id:Date.now().toString(),type:"receive",senderPhone:"إضافة نقدية",receiverPhone:"",amount:t,status:"completed",createdAt:new Date,title:"إيصال إضافة نقدية"};try{s!=null&&s.uid&&De.saveLocalReceipt(s.uid,o)}catch{}const d=[o,...Xe];Fs(d);try{localStorage.setItem(Ma(),JSON.stringify(d))}catch{}try{if(s!=null&&s.uid){const x={txnType:"receive",amount:t,status:"confirmed",senderMsisdn:"إضافة نقدية",receiverMsisdn:"",title:"إيصال إضافة نقدية",merchantUserId:s.uid,createdBy:s.uid,shopId:(I==null?void 0:I.shopId)||void 0};await De.saveUserTransaction(s.uid,x);const g=I==null?void 0:I.shopId;if(g){const C=$e(J,"dashboardData",g);try{await Ls(C,{cashBalance:a})}catch{}}}}catch{}nr(!1),Yr(""),Hr(""),lr(null),Zr("")}catch(t){console.error("خطأ في حفظ الرصيد في Firebase:",t),Jt(lt),localStorage.setItem("cashBalance",lt.toString()),i({title:"خطأ",description:"حدث خطأ أثناء حفظ البيانات، يرجى المحاولة مرة أخرى",variant:"destructive"})}finally{Gr(!1)}},className:"flex-1",children:"لا"})]})]}),La==="yes"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"addCashNote",children:"الملاحظة"}),e.jsx(U,{id:"addCashNote",type:"text",placeholder:"اكتب الملاحظة",value:Qr,onChange:t=>Zr(t.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"addCashPin",children:"الرقم السري لدرج النقدية"}),e.jsx(U,{id:"addCashPin",type:"password",placeholder:"أدخل الرقم السري",value:ir,onChange:t=>Hr(t.target.value)})]})]}),e.jsxs(Ge,{children:[e.jsx(h,{variant:"outline",onClick:()=>{nr(!1),Yr(""),Hr(""),lr(null),Zr("")},children:"إلغاء"}),e.jsx(h,{variant:"default",className:"bg-green-600 hover:bg-green-700",disabled:_l,onClick:async()=>{if(!ba||parseFloat(ba)<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح أكبر من صفر",variant:"destructive"});return}if(!ir){i({title:"خطأ",description:"يرجى إدخال الرقم السري",variant:"destructive"});return}if(!await rn(ir)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}if(La==="yes"&&Qr.trim().length===0){i({title:"تنبيه",description:"أدخل الملاحظة أو اختر لا",variant:"destructive"});return}Gr(!0);try{const t=parseFloat(ba),a=lt+t;Jt(a),localStorage.setItem(Ds(),a.toString());const r={cashBalance:a,lastUpdated:new Date().toISOString()},l=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(l,JSON.stringify(r)),s!=null&&s.uid?(await De.updateUserData(s.uid,r),localStorage.removeItem(l),ke(!1)):ke(!0);const o={id:Date.now().toString(),type:"receive",senderPhone:"إضافة نقدية",receiverPhone:"",amount:t,status:"completed",createdAt:new Date,notes:La==="yes"?Qr.trim():void 0,title:"إيصال إضافة نقدية"};try{s!=null&&s.uid&&De.saveLocalReceipt(s.uid,o)}catch{}const d=[o,...Xe];Fs(d);try{localStorage.setItem(Ma(),JSON.stringify(d))}catch{}try{if(s!=null&&s.uid){const x={txnType:"receive",amount:t,status:"confirmed",senderMsisdn:"إضافة نقدية",receiverMsisdn:"",note:La==="yes"?Qr.trim():void 0,title:"إيصال إضافة نقدية",merchantUserId:s.uid,createdBy:s.uid,shopId:(I==null?void 0:I.shopId)||void 0};await De.saveUserTransaction(s.uid,x);const g=I==null?void 0:I.shopId;if(g){const C=$e(J,"dashboardData",g);try{await Ls(C,{cashBalance:a})}catch{}}}}catch{}nr(!1),Yr(""),Hr(""),lr(null),Zr("")}catch(t){console.error("خطأ في حفظ الرصيد في Firebase:",t),Jt(lt),localStorage.setItem("cashBalance",lt.toString()),i({title:"خطأ",description:"حدث خطأ أثناء حفظ البيانات، يرجى المحاولة مرة أخرى",variant:"destructive"})}finally{Gr(!1)}},children:_l?"جاري الإضافة...":"إضافة الأموال"})]})]})}),e.jsx(ce,{open:nd,onOpenChange:ai,children:e.jsxs(de,{className:"sm:max-w-md",children:[e.jsx(me,{children:e.jsx(he,{className:"text-right",children:"اختيار التاريخ والوقت للبحث"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(H,{htmlFor:"search-date",className:"text-right block",children:"التاريخ"}),e.jsx(U,{id:"search-date",type:"date",value:Pr,onChange:t=>Hi(t.target.value),className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(H,{htmlFor:"search-time",className:"text-right block",children:"الوقت (اختياري)"}),e.jsx(U,{id:"search-time",type:"time",value:kr,onChange:t=>Gi(t.target.value),className:"text-right",placeholder:"اختر الوقت للبحث في ساعة محددة"}),e.jsx("p",{className:"text-[10px] text-gray-500 text-right",children:"إذا لم تختر وقتاً محدداً، سيتم البحث في كامل اليوم"})]})]}),e.jsxs(Ge,{className:"flex justify-between",children:[e.jsx(h,{variant:"outline",onClick:()=>{Hi(""),Gi(""),ai(!1)},children:"مسح"}),e.jsx(h,{onClick:()=>ai(!1),children:"تطبيق"})]})]})}),e.jsx(xo,{isOpen:Ta&&!rt,onClose:()=>ls(!1),onTrialStarted:ad}),e.jsx(nh,{isOpen:Ec,onClose:()=>Fn(!1)}),e.jsx(ih,{isOpen:kn,onClose:()=>Ka(!1),initialBarcode:hc}),e.jsx(Im,{isOpen:_c,onClose:()=>Or(!1)}),e.jsx(Am,{open:Wc,onOpenChange:Er}),e.jsx(Nh,{open:Fc,onOpenChange:t=>{if(t&&!Ms){i({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});return}_r(t)}}),e.jsx(Th,{open:q,onOpenChange:t=>{if(t&&!Ms){i({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}Y(t)}}),e.jsx(Ph,{open:ae,onOpenChange:t=>{if(t&&!Ms){i({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}_(t)}}),e.jsx(rs,{open:ud,onOpenChange:Al,onSuccess:()=>ci(!0),title:"تقاريرك",description:"أدخل الرقم السري الرئيسي للوصول إلى تقاريرك",mode:"verify"}),e.jsx(ce,{open:oi,onOpenChange:ci,children:e.jsxs(de,{className:"sm:max-w-xl",children:[e.jsxs(me,{children:[e.jsxs(he,{className:"flex items-center gap-2",children:[e.jsx(oo,{className:"h-4 w-4 text-blue-600"}),"تقارير اليوم"]}),e.jsx(ss,{children:"ملخص معاملات اليوم محفوظ لآخر 30 يومًا مع أرشفة في السحابة"})]}),e.jsxs("div",{className:"space-y-4",children:[(()=>{const t=new Date().toDateString(),a=Xe.filter(g=>{const C=new Date(g.createdAt).toDateString(),y=String(g.status||"completed").toLowerCase();return C===t&&(y==="completed"||y==="confirmed")}),r=a.length,l=a.reduce((g,C)=>g+Number(C.amount||0),0),o=a.filter(g=>g.type==="withdraw").reduce((g,C)=>g+Number(C.amount||0),0),d=a.filter(g=>g.type==="send").reduce((g,C)=>g+Number(C.amount||0),0),x=a.reduce((g,C)=>g+Number(ts.calculateTransactionProfit(C)||0),0);return e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded-lg p-3 bg-gradient-to-r from-blue-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-blue-700",children:"عدد المعاملات"}),e.jsx("div",{className:"text-lg font-bold text-blue-800",children:r})]}),e.jsxs("div",{className:"rounded-lg p-3 bg-gradient-to-r from-indigo-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-indigo-700",children:"إجمالي المبالغ"}),e.jsx("div",{className:"text-lg font-bold text-indigo-800",children:Number(l).toFixed(2)})]}),e.jsxs("div",{className:"rounded-lg p-3 bg-gradient-to-r from-red-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-red-700",children:"المبالغ المسحوبة"}),e.jsx("div",{className:"text-lg font-bold text-red-800",children:Number(o).toFixed(2)})]}),e.jsxs("div",{className:"rounded-lg p-3 bg-gradient-to-r from-green-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-green-700",children:"المبالغ المرسلة"}),e.jsx("div",{className:"text-lg font-bold text-green-800",children:Number(d).toFixed(2)})]}),e.jsxs("div",{className:"col-span-2 rounded-lg p-3 bg-gradient-to-r from-amber-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-amber-700",children:"الأرباح"}),e.jsx("div",{className:"text-lg font-bold text-amber-800",children:Number(x).toFixed(2)})]})]})})(),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(h,{variant:"default",onClick:async()=>{try{if(!(s!=null&&s.uid))return;const t=new Date,a=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),l=String(t.getDate()).padStart(2,"0"),o=`${a}-${r}-${l}`,d=t.toDateString(),x=Xe.filter($=>{const z=new Date($.createdAt).toDateString(),Ne=String($.status||"completed").toLowerCase();return z===d&&(Ne==="completed"||Ne==="confirmed")}),g=x.length,C=x.reduce(($,z)=>$+Number(z.amount||0),0),y=x.filter($=>$.type==="withdraw").reduce(($,z)=>$+Number(z.amount||0),0),j=x.filter($=>$.type==="send").reduce(($,z)=>$+Number(z.amount||0),0),B=x.reduce(($,z)=>$+Number(ts.calculateTransactionProfit(z)||0),0);await xr.add({userId:s.uid,reportDate:o,totalTransactions:g,totalAmount:Number(C.toFixed(2)),totalWithdrawn:Number(y.toFixed(2)),totalSent:Number(j.toFixed(2)),profit:Number(B.toFixed(2)),walletId:null});try{await xr.trimToMaxCount(s.uid,30)}catch{}i({title:"تم الأرشفة",description:`تم حفظ تقرير ${o}`})}catch{i({title:"فشل الأرشفة",description:"تعذر حفظ التقرير",variant:"destructive"})}},children:"أرشفة اليوم"}),e.jsx(h,{variant:"outline",onClick:()=>ci(!1),children:"إغلاق"})]}),e.jsx("div",{className:"mt-2 border-t pt-2",children:e.jsx("div",{className:"space-y-2 max-h-[40vh] overflow-auto",children:Tl.length===0?e.jsx("div",{className:"text-xs text-muted-foreground",children:"لا توجد تقارير محفوظة"}):Tl.map(t=>e.jsxs("div",{className:"border rounded-md p-2 bg-gradient-to-r from-white/80 to-blue-50/70",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{className:"font-bold text-blue-800",children:t.reportDate}),e.jsxs("div",{className:"text-xs text-blue-700",children:["عدد المعاملات: ",t.totalTransactions]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-1",children:[e.jsxs("div",{className:"text-xs text-blue-800",children:["إجمالي المبالغ: ",e.jsx("span",{className:"font-semibold",children:Number(t.totalAmount).toFixed(2)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["المسحوب: ",e.jsx("span",{className:"font-semibold",children:Number(t.totalWithdrawn).toFixed(2)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["المرسل: ",e.jsx("span",{className:"font-semibold",children:Number(t.totalSent).toFixed(2)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["الربح: ",e.jsx("span",{className:"font-semibold",children:Number(t.profit??0).toFixed(2)})]})]})]},t.id||`${t.userId}-${t.reportDate}`))})})]})]})}),e.jsx(ce,{open:hd,onOpenChange:t=>{if(t){i({title:"قيد التطوير",description:"هذه الميزة غير متاحة حالياً."});return}li(!1)},children:e.jsxs(de,{dir:"rtl",className:"sm:max-w-md w-[95vw] sm:w-auto rounded-2xl border border-emerald-200 shadow-xl bg-gradient-to-br from-white via-green-50 to-emerald-50 backdrop-blur-md data-[state=open]:animate-in data-[state=open]:fade-in-0 data-[state=open]:zoom-in-90 data-[state=open]:slide-in-from-bottom-8 duration-300",children:[e.jsxs(me,{children:[e.jsx(he,{className:"text-right text-green-700",children:"شحن رصيد الموبايل"}),e.jsx(ss,{className:"text-right text-gray-600",children:"أدخل البيانات ثم اضغط تأكيد"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx(H,{htmlFor:"topupPhone",className:"text-right block",children:"رقم الموبايل"}),e.jsx(U,{id:"topupPhone",value:Ur,onChange:t=>jl(t.target.value),placeholder:"010xxxxxxx",className:"text-right"})]}),e.jsxs("div",{children:[e.jsx(H,{className:"text-right block",children:"شركة التشغيل"}),e.jsxs(na,{value:zr,onValueChange:Sl,children:[e.jsx(ia,{className:"text-right",children:e.jsx(la,{placeholder:"اختر الشركة"})}),e.jsxs(oa,{children:[e.jsx(_s,{value:"vodafone",children:"فودافون"}),e.jsx(_s,{value:"orange",children:"أورنج"}),e.jsx(_s,{value:"etisalat",children:"اتصالات"}),e.jsx(_s,{value:"we",children:"WE"})]})]})]}),e.jsxs("div",{children:[e.jsx(H,{htmlFor:"topupAmount",className:"text-right block",children:"المبلغ بالجنيه"}),e.jsx(U,{id:"topupAmount",type:"number",value:qr,onChange:t=>Dl(t.target.value?Number(t.target.value):""),placeholder:"50",className:"text-right"})]})]}),e.jsxs(Ge,{className:"flex gap-2 justify-between",children:[e.jsx(h,{variant:"outline",onClick:()=>li(!1),className:"border-gray-300",children:"إلغاء"}),e.jsx(h,{onClick:v,disabled:Cl||!Ur||!zr||!qr,className:"bg-emerald-600 hover:bg-emerald-700 text-white",children:Cl?"جارٍ التنفيذ...":"تأكيد الشحن"})]})]})}),e.jsx(rs,{open:zc,onOpenChange:Ln,mode:"verify",title:"الرقم السري الرئيسي لفتح الديون",description:"أدخل الرقم السري الرئيسي لفتح صفحة الديون",onSuccess:()=>{Ln(!1),_a(!0)}}),e.jsx(rs,{open:Vc,onOpenChange:rl,mode:"verify",title:"تأكيد تغيير طلب الرقم السري للديون",description:"أدخل الرقم السري الرئيسي لتفعيل أو إلغاء طلب الرقم السري عند فتح الديون",onSuccess:async()=>{if(nl!==null){const t=nl;al(t);try{const a=s==null?void 0:s.uid,r=a?`debtsPinRequired_${a}`:"debtsPinRequired";localStorage.setItem(r,String(t)),a&&await De.updateUserData(a,{debtsPinRequired:t})}catch{}i({title:t?"تم تفعيل طلب الرقم السري للديون":"تم إلغاء طلب الرقم السري للديون",description:t?"سيُطلب الرقم السري الرئيسي عند فتح نافذة الديون.":"يمكن فتح نافذة الديون بدون طلب الرقم السري."})}Jc(null),rl(!1)}}),e.jsx(wm,{open:dd,onOpenChange:rr,title:"تأكيد كلمة المرور لتصفير المعاملات الأخيرة",description:"سيتم حذف كل المعاملات السابقة نهائيًا من حسابك وFirebase.",onSuccess:async()=>{try{if(!(s!=null&&s.uid)){rr(!1);return}const t=new Date,a=l=>l instanceof Date?l:typeof(l==null?void 0:l.toDate)=="function"?l.toDate():new Date(String(l)),r=Xe.filter(l=>a(l.createdAt)<t);await De.updateUserData(s.uid,{recentReset:{keepLastCount:Ra.keepLastCount??30,intervalDays:Ra.intervalDays??7,lastResetAt:t}}),en(l=>({...l,lastResetAt:t})),i({title:"تم إخفاء المعاملات السابقة",description:"تم إخفاء كل الإيصالات الأقدم من وقت التصفير من العرض بدون التأثير على تقارير اليوم/الشهر أو الحدود."})}catch(t){console.error("فشل تنفيذ التصفير النهائي:",t),i({title:"فشل التصفير",description:"تحقق من الاتصال ثم أعد المحاولة.",variant:"destructive"})}finally{rr(!1)}}}),e.jsx(rs,{open:Lt,onOpenChange:It,mode:"verify",title:"الرقم السري لفتح مصروفات المحل",description:"أدخل الرقم السري الرئيسي لفتح نافذة مصروفات المحل",onSuccess:()=>{It(!1),it(!0)}}),e.jsx(ce,{open:Uc,onOpenChange:_a,children:e.jsxs(de,{className:"sm:max-w-[425px]",children:[e.jsxs(me,{className:"flex items-center justify-between",children:[e.jsx(he,{className:"text-right",children:"إدارة الديون"}),e.jsxs("div",{className:"flex items-center gap-1 text-orange-700",children:[e.jsx(mo,{className:"h-4 w-4"}),e.jsxs("span",{className:"text-xs font-bold",children:[Rd," جنيه"]})]})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(H,{htmlFor:"debtorName",className:"text-right col-span-1",children:"اسم المديون"}),e.jsx(U,{id:"debtorName",value:Rn,onChange:t=>il(t.target.value),className:"col-span-3 text-right",placeholder:"أدخل اسم المديون"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(H,{htmlFor:"debtAmount",className:"text-right col-span-1",children:"المبلغ"}),e.jsx(U,{id:"debtAmount",type:"number",value:Bn,onChange:t=>ll(t.target.value),className:"col-span-3 text-right",placeholder:"أدخل المبلغ"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(H,{htmlFor:"debtReason",className:"text-right col-span-1",children:"سبب الدين"}),e.jsx(U,{id:"debtReason",value:$n,onChange:t=>ol(t.target.value),className:"col-span-3 text-right",placeholder:"أدخل سبب الدين"})]})]}),e.jsx(Ge,{children:e.jsx(h,{onClick:()=>{if(Rn&&Bn&&$n){const t={id:Date.now().toString(),debtorName:Rn,amount:parseFloat(Bn),reason:$n,status:"pending",createdAt:new Date,paidAmount:0,partialPayments:[]};ei(t),sr(!0)}else i({title:"بيانات غير مكتملة",description:"يرجى إدخال الاسم والمبلغ والسبب",variant:"destructive"})},className:"bg-orange-500 hover:bg-orange-600",children:"حفظ"})}),e.jsx("div",{className:"mt-2",children:e.jsx(h,{variant:"outline",className:"w-full",onClick:()=>tr(!0),children:"إيصالات الديون"})}),e.jsx("div",{className:"mt-2",children:e.jsx(h,{variant:"outline",className:"w-full",onClick:()=>Hn(!0),children:"إضافة عميل"})})]})}),e.jsx(ce,{open:Vn,onOpenChange:tr,children:e.jsxs(de,{className:"sm:max-w-[520px]",children:[e.jsxs(me,{children:[e.jsx(he,{className:"text-right",children:"إيصالات الديون"}),e.jsx(ss,{className:"text-right",children:"اختر دينًا لعرض إيصاله بالتفصيل"})]}),At.length>0?e.jsxs("div",{className:"max-h-64 overflow-y-auto space-y-2",onScroll:t=>{const a=t.currentTarget;Kn.length<At.length&&a.scrollTop+a.clientHeight>=a.scrollHeight-50&&Jn(r=>r+1)},children:[Kn.map(t=>e.jsx("div",{onClick:()=>{Xa(t),ea(!0),tr(!1),_a(!1)},className:"p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium",children:t.debtorName}),e.jsx("p",{className:"text-sm text-gray-600",children:t.reason}),e.jsx("p",{className:"text-sm text-gray-500",children:ln.format(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt))})]}),e.jsxs("div",{className:"text-left",children:[e.jsxs("p",{className:"font-bold text-lg",children:[t.amount," جنيه"]}),e.jsx(Mt,{variant:t.status==="paid"?"default":"secondary",className:t.status==="paid"?"bg-green-500":"bg-yellow-500",children:t.status==="paid"?"مدفوع":"قيد المراجعة"})]})]})},t.id)),Kn.length<At.length&&e.jsx("div",{className:"flex justify-center pt-1",children:e.jsx(h,{variant:"outline",size:"sm",onClick:()=>Jn(t=>t+1),children:"تحميل المزيد"})})]}):e.jsx("div",{className:"text-center text-sm text-gray-500",children:"لا توجد ديون مسجلة"}),e.jsxs(Ge,{className:"flex justify-between mt-3",children:[e.jsx(h,{variant:"destructive",onClick:async()=>{try{if(!At||At.length===0){i({title:"لا توجد ديون",description:"القائمة فارغة بالفعل."});return}if(!window.confirm("هل تريد حذف كل إيصالات الديون؟ هذا الإجراء لا يمكن التراجع عنه."))return;const a=[];ps(a),Xa(null),await Ss(a),i({title:"تم حذف كل إيصالات الديون",description:"تم تفريغ القائمة بالكامل."}),tr(!1)}catch(t){console.error("تعذر حذف كل إيصالات الديون:",t),i({title:"فشل الحذف",description:"حدث خطأ أثناء الحذف، حاول مرة أخرى.",variant:"destructive"})}},children:"حذف كل الإيصالات"}),e.jsx(h,{variant:"outline",onClick:()=>tr(!1),children:"إغلاق"})]})]})}),e.jsx(ce,{open:Qc,onOpenChange:Hn,children:e.jsxs(de,{className:"sm:max-w-[480px]",children:[e.jsxs(me,{children:[e.jsx(he,{className:"text-right",children:"إضافة عميل"}),e.jsx(ss,{className:"text-right",children:"أدخل بيانات العميل ثم يمكنك تسجيل مبلغ دين عليه"})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(H,{htmlFor:"customerName",className:"text-right col-span-1",children:"اسم العميل"}),e.jsx(U,{id:"customerName",value:Qn,onChange:t=>xl(t.target.value),className:"col-span-3 text-right",placeholder:"اكتب اسم العميل"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(H,{htmlFor:"customerMobile",className:"text-right col-span-1",children:"رقم الموبايل"}),e.jsx(U,{id:"customerMobile",value:Zn,onChange:t=>pl(t.target.value),className:"col-span-3 text-right",placeholder:"اكتب رقم الموبايل"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(h,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{if(!Qn||!Zn){i({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم العميل ورقم الموبايل",variant:"destructive"});return}const t={id:Date.now().toString(),name:Qn.trim(),mobile:Zn.trim(),createdAt:new Date},a=[t,...Js];await yd(a),xl(""),pl(""),i({title:"تمت إضافة العميل",description:`تم إضافة ${t.name}`})},children:"إضافة"})}),e.jsxs("div",{className:"border-t pt-4 space-y-3",children:[e.jsx(H,{className:"text-right block",children:"إضافة مبلغ على عميل"}),Js.length>0?e.jsxs("div",{className:"space-y-3",children:[e.jsxs(na,{value:Xn,onValueChange:gl,children:[e.jsx(ia,{className:"w-full",children:e.jsx(la,{placeholder:"اختر عميل"})}),e.jsx(oa,{children:Js.map(t=>e.jsxs(_s,{value:t.id,children:[t.name," — ",t.mobile]},t.id))})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(H,{htmlFor:"customerDebtAmount",className:"text-right col-span-1",children:"المبلغ"}),e.jsx(U,{id:"customerDebtAmount",type:"number",value:fl,onChange:t=>yl(t.target.value),className:"col-span-3 text-right",placeholder:"أدخل المبلغ"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(h,{className:"bg-orange-600 hover:bg-orange-700",onClick:async()=>{const t=parseFloat(fl);if(!Xn){i({title:"اختر عميل",description:"يرجى اختيار عميل أولاً",variant:"destructive"});return}if(isNaN(t)||t<=0){i({title:"قيمة غير صحيحة",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const a=Js.find(o=>o.id===Xn);if(!a)return;const r={id:Date.now().toString(),debtorName:a.name,customerId:a.id,mobile:a.mobile,amount:Number(t.toFixed(2)),reason:"دين عميل",status:"pending",createdAt:new Date,paidAmount:0,partialPayments:[]},l=[...At,r];ps(l),await Ss(l),gl(""),yl(""),i({title:"تم تسجيل المبلغ على العميل",description:`تمت إضافة ${r.amount} جنيه للعميل ${a.name}`})},children:"إضافة المبلغ"})})]}):e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد عملاء مسجلين. أضف عميلًا أولاً."})]})]}),e.jsx(Ge,{className:"flex justify-end",children:e.jsx(h,{variant:"outline",onClick:()=>Hn(!1),children:"إغلاق"})})]})}),e.jsx(ce,{open:ft,onOpenChange:it,children:e.jsxs(de,{className:"sm:max-w-[520px]",children:[e.jsxs(me,{children:[e.jsx(he,{className:"text-right",children:"مصروفات المحل"}),e.jsx(ss,{className:"text-right",children:"أدخل تفاصيل المصروف ثم اختر مصدر الخصم."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(H,{htmlFor:"expenseName",className:"text-right col-span-1",children:"اسم المصروف"}),e.jsx(U,{id:"expenseName",value:R,onChange:t=>we(t.target.value),className:"col-span-3 text-right",placeholder:"مثال: كهرباء، صيانة، مشتريات"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(H,{htmlFor:"expenseAmount",className:"text-right col-span-1",children:"تمن المصروف"}),e.jsx(U,{id:"expenseAmount",type:"number",value:Pe,onChange:t=>Ke(t.target.value),className:"col-span-3 text-right",placeholder:"0.00"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(H,{htmlFor:"expenseNotes",className:"text-right col-span-1",children:"ملاحظات"}),e.jsx(U,{id:"expenseNotes",value:Ee,onChange:t=>Rt(t.target.value),className:"col-span-3 text-right",placeholder:"معلومات إضافية إن وجدت"})]})]}),e.jsxs(Ge,{className:"flex justify-between",children:[e.jsx(h,{className:"bg-orange-600 hover:bg-orange-700",onClick:()=>{if(!R||!Pe){i({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم المصروف وقيمته",variant:"destructive"});return}is(!0)},children:"إضافة مصروف"}),e.jsx(h,{variant:"outline",onClick:()=>ks(!0),children:"إيصالات المصاريف"})]})]})}),e.jsx(ce,{open:Aa,onOpenChange:ks,children:e.jsxs(de,{className:"sm:max-w-[420px]",dir:"rtl",children:[e.jsxs(me,{children:[e.jsx(he,{className:"text-right",children:"إيصالات المصاريف"}),e.jsx(ss,{className:"text-right",children:"آخر المصاريف المسجلة"})]}),Ze.length>0?e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:Ze.map(t=>e.jsx("div",{className:"p-2 border rounded-lg bg-white hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium text-sm",children:t.name}),e.jsx("p",{className:"text-[11px] text-gray-600",children:t.notes||"بدون ملاحظات"}),e.jsx("p",{className:"text-[10px] text-gray-500",children:new Date(t.createdAt).toLocaleString("ar-EG")})]}),e.jsxs("div",{className:"text-left flex items-start gap-2",children:[e.jsxs("div",{className:"text-left",children:[e.jsxs("p",{className:"font-bold text-sm",children:[t.amount," جنيه"]}),e.jsx(Mt,{variant:"secondary",className:t.source==="cash"?"bg-blue-100 text-blue-700":"bg-purple-100 text-purple-700",children:t.source==="cash"?"من النقدية":`من المحفظة${t.walletId?` (${t.walletId})`:""}`})]}),e.jsxs(h,{variant:"destructive",size:"sm",className:"shrink-0",onClick:()=>gd(t.id),title:"حذف نهائي",children:[e.jsx(Yt,{className:"w-4 h-4 ml-1"}),"حذف"]})]})]})},t.id))}):e.jsx("p",{className:"text-sm text-gray-500 text-center",children:"لا توجد مصاريف مسجلة بعد"})]})}),e.jsx(ce,{open:Gt,onOpenChange:is,children:e.jsxs(de,{className:"sm:max-w-[480px]",children:[e.jsx(me,{children:e.jsx(he,{className:"text-right",children:"اختيار مصدر خصم المصروف"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600 text-right",children:"اختر هل تريد خصم مبلغ المصروف من الرصيد النقدي في الدرج أم من إحدى المحافظ."}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsx(h,{variant:nt==="cash"?"default":"outline",className:nt==="cash"?"bg-blue-600 hover:bg-blue-700 text-white":"",onClick:()=>Ns("cash"),children:"الفلوس النقدية"}),e.jsx(h,{variant:nt==="wallet"?"default":"outline",className:nt==="wallet"?"bg-purple-600 hover:bg-purple-700 text-white":"",onClick:()=>Ns("wallet"),children:"أرصدة المحافظ"}),e.jsx(h,{variant:nt==="fawry"?"default":"outline",className:nt==="fawry"?"bg-amber-600 hover:bg-amber-700 text-white":"",onClick:()=>Ns("fawry"),children:"فوري"})]}),nt==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{className:"text-right block",children:"اختر المحفظة للخصم"}),e.jsxs(na,{value:yt,onValueChange:zs,children:[e.jsx(ia,{className:"w-full",children:e.jsx(la,{placeholder:"اختر محفظة"})}),e.jsx(oa,{children:Re.map(t=>e.jsx(_s,{value:t.id,children:t.phone||t.name||t.id},t.id))})]})]})]}),e.jsxs(Ge,{className:"flex justify-between",children:[e.jsx(h,{variant:"outline",onClick:()=>{is(!1),Ns(null),zs("")},children:"إلغاء"}),e.jsx(h,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{const t=Number(Pe);if(isNaN(t)||t<=0){i({title:"قيمة غير صحيحة",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}if(!nt){i({title:"اختر مصدر الخصم",description:"يرجى اختيار النقدية أو المحفظة",variant:"destructive"});return}try{if(nt==="cash"){const o=Number((lt-t).toFixed(2));Jt(o),localStorage.setItem(Ds(),o.toString());const d={cashBalance:o,lastUpdated:new Date().toISOString()},x=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(x,JSON.stringify(d)),s!=null&&s.uid?(await De.updateUserData(s.uid,d),localStorage.removeItem(x),ke(!1)):ke(!0)}else if(nt==="wallet"){if(!yt){i({title:"اختر محفظة",description:"يرجى اختيار محفظة للخصم",variant:"destructive"});return}const o=Be[yt]||0,d=Number((o-t).toFixed(2)),x={...Be,[yt]:d};Xt(x);const g=new Date().toISOString(),C={walletBalances:x,lastUpdated:g},y=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(y,JSON.stringify(C)),localStorage.setItem(fs(),JSON.stringify(x)),localStorage.setItem(`walletBalances_backup_${g}`,JSON.stringify(x)),s!=null&&s.uid&&await De.updateUserData(s.uid,C)}}catch(o){console.error("خطأ أثناء تحديث الأرصدة عند حفظ المصروف:",o)}let a=Date.now().toString();try{if(s!=null&&s.uid){const{addDoc:o,collection:d,serverTimestamp:x}=await dt(async()=>{const{addDoc:y,collection:j,serverTimestamp:B}=await import("./index-BaJ4CYlQ.js").then($=>$.bg);return{addDoc:y,collection:j,serverTimestamp:B}},__vite__mapDeps([0,1]),import.meta.url),{db:g}=await dt(async()=>{const{db:y}=await import("./index-BaJ4CYlQ.js").then(j=>j.bh);return{db:y}},__vite__mapDeps([0,1]),import.meta.url);a=(await o(d(g,"shop_expenses"),{userId:s.uid,shopId:T||(I==null?void 0:I.shopId)||s.uid||"default-shop",name:R,amount:t,notes:Ee||"",source:nt,walletId:nt==="wallet"?yt:null,createdAt:x()})).id}}catch(o){console.error("خطأ أثناء حفظ المصروف في Firestore:",o)}const r={id:a,name:R,amount:t,notes:Ee,source:nt,walletId:nt==="wallet"?yt:void 0,createdAt:new Date},l=[...Ze,r];await Ol(l),we(""),Ke(""),Rt(""),Ns(null),zs(""),is(!1),it(!0),ks(!0),i({title:"تم إضافة المصروف",description:nt==="cash"?"تم الخصم من النقدية":nt==="wallet"?"تم الخصم من أرصدة المحافظ":"تم تسجيل الدفع عبر فوري"})},children:"تأكيد الخصم"})]})]})}),e.jsx(ce,{open:qa,onOpenChange:m,children:e.jsxs(de,{className:"sm:max-w-[520px]",children:[e.jsxs(me,{children:[e.jsx(he,{className:"text-right",children:"النواقص"}),e.jsx(ss,{className:"text-right",children:"سجل العناصر الناقصة التي تحتاج شراء وتابع حالتها."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(H,{htmlFor:"deficiencyName",className:"text-right col-span-1",children:"اسم العنصر"}),e.jsx(U,{id:"deficiencyName",value:E,onChange:t=>F(t.target.value),className:"col-span-3 text-right",placeholder:"مثال: سكر، زيت، مناديل"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(H,{htmlFor:"deficiencyQuantity",className:"text-right col-span-1",children:"الكمية"}),e.jsx(U,{id:"deficiencyQuantity",type:"number",value:N,onChange:t=>k(t.target.value),className:"col-span-3 text-right",placeholder:"1"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(h,{className:"bg-rose-600 hover:bg-rose-700",onClick:()=>{if(ot){i({title:"غير متاح",description:"النواقص غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"});return}const t=parseInt(N||"1",10);if(!E){i({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم العنصر",variant:"destructive"});return}if(isNaN(t)||t<=0){i({title:"كمية غير صحيحة",description:"يرجى إدخال كمية صحيحة",variant:"destructive"});return}(async()=>{if(s!=null&&s.uid)try{const{collection:r,addDoc:l,serverTimestamp:o}=await dt(async()=>{const{collection:g,addDoc:C,serverTimestamp:y}=await import("./index-BaJ4CYlQ.js").then(j=>j.bg);return{collection:g,addDoc:C,serverTimestamp:y}},__vite__mapDeps([0,1]),import.meta.url),{db:d}=await dt(async()=>{const{db:g}=await import("./index-BaJ4CYlQ.js").then(C=>C.bh);return{db:g}},__vite__mapDeps([0,1]),import.meta.url),x=await l(r(d,"deficiencies"),{userId:s.uid,shopId:T||(I==null?void 0:I.shopId)||s.uid||"default-shop",name:E,quantity:t,status:"pending",createdAt:o()});try{const g=Jr(),C=localStorage.getItem(g),y=C?JSON.parse(C):[],j=Array.isArray(y)?y:[],B=j.some(Ne=>String((Ne==null?void 0:Ne.id)||"")===x.id),$={id:x.id,name:E,quantity:t,status:"pending",createdAt:new Date().toISOString()},z=B?j:[...j,$];localStorage.setItem(g,JSON.stringify(z))}catch{}F(""),k(""),i({title:"تمت الإضافة",description:"تمت إضافة العنصر إلى قائمة النواقص"});return}catch(r){console.warn("فشل حفظ النواقص إلى Firestore، سيُستخدم التخزين المحلي:",r)}const a={id:Date.now().toString(),name:E,quantity:t,status:"pending",createdAt:new Date};te(r=>{const l=[...r,a];return hi(l),l}),F(""),k(""),i({title:"تمت الإضافة",description:"تمت إضافة العنصر إلى قائمة النواقص"})})()},children:"إضافة للنواقص"})}),K.length>0?e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:K.map(t=>e.jsx("div",{className:"p-2 border rounded-lg bg-white hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium text-sm",children:t.name}),e.jsxs("p",{className:"text-[11px] text-gray-600",children:["الكمية: ",t.quantity]}),e.jsx("p",{className:"text-[10px] text-gray-500",children:new Date(t.createdAt).toLocaleString("ar-EG")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Mt,{variant:"secondary",className:t.status==="pending"?"bg-rose-100 text-rose-700":"bg-green-100 text-green-700",children:t.status==="pending"?"قيد الشراء":"تم الشراء"}),e.jsx(h,{variant:"outline",className:t.status==="pending"?"text-green-700 border-green-300 hover:bg-green-50":"text-rose-700 border-rose-300 hover:bg-rose-50",onClick:()=>{(async()=>{const a=t.status==="pending"?"purchased":"pending";if(s!=null&&s.uid)try{const{doc:r,updateDoc:l,serverTimestamp:o}=await dt(async()=>{const{doc:x,updateDoc:g,serverTimestamp:C}=await import("./index-BaJ4CYlQ.js").then(y=>y.bg);return{doc:x,updateDoc:g,serverTimestamp:C}},__vite__mapDeps([0,1]),import.meta.url),{db:d}=await dt(async()=>{const{db:x}=await import("./index-BaJ4CYlQ.js").then(g=>g.bh);return{db:x}},__vite__mapDeps([0,1]),import.meta.url);await l(r(d,"deficiencies",t.id),{status:a,updatedAt:o()});return}catch(r){console.warn("فشل تحديث حالة النواقص على Firestore، استخدام التخزين المحلي:",r)}te(r=>{const l=r.map(o=>o.id===t.id?{...o,status:a}:o);return hi(l),l})})()},title:t.status==="pending"?"تم الشراء":"إلغاء الشراء",children:t.status==="pending"?"تم الشراء":"إلغاء الشراء"}),e.jsx(h,{variant:"outline",className:"text-red-700 border-red-300 hover:bg-red-50",onClick:()=>{(async()=>{if(s!=null&&s.uid)try{const{doc:a,deleteDoc:r}=await dt(async()=>{const{doc:o,deleteDoc:d}=await import("./index-BaJ4CYlQ.js").then(x=>x.bg);return{doc:o,deleteDoc:d}},__vite__mapDeps([0,1]),import.meta.url),{db:l}=await dt(async()=>{const{db:o}=await import("./index-BaJ4CYlQ.js").then(d=>d.bh);return{db:o}},__vite__mapDeps([0,1]),import.meta.url);await r(a(l,"deficiencies",t.id));return}catch(a){console.warn("فشل حذف عنصر النواقص من Firestore، استخدام التخزين المحلي:",a)}te(a=>{const r=a.filter(l=>l.id!==t.id);return hi(r),r})})()},title:"حذف",children:"حذف"})]})]})},t.id))}):e.jsx("p",{className:"text-sm text-gray-500 text-center",children:"لا توجد عناصر مسجلة في النواقص"})]}),e.jsx(Ge,{className:"flex justify-end",children:e.jsx(h,{variant:"outline",onClick:()=>m(!1),children:"إغلاق"})})]})}),e.jsx(ce,{open:Zc,onOpenChange:sr,children:e.jsxs(de,{className:"sm:max-w-[480px]",children:[e.jsx(me,{children:e.jsx(he,{className:"text-right",children:"اختيار مصدر خصم الدين"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600 text-right",children:"اختر هل تريد خصم مبلغ الدين من الرصيد النقدي في الدرج أم من إحدى المحافظ أو تسجيله بدون خصم."}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsx(h,{variant:gs==="cash"?"default":"outline",className:gs==="cash"?"bg-blue-600 hover:bg-blue-700 text-white":"",onClick:()=>ar("cash"),children:"الفلوس النقدية"}),e.jsx(h,{variant:gs==="wallet"?"default":"outline",className:gs==="wallet"?"bg-purple-600 hover:bg-purple-700 text-white":"",onClick:()=>ar("wallet"),children:"أرصدة المحافظ"}),e.jsx(h,{variant:gs==="none"?"default":"outline",className:gs==="none"?"bg-gray-600 hover:bg-gray-700 text-white":"",onClick:()=>ar("none"),children:"بدون خصم"})]}),gs==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{className:"text-right block",children:"اختر المحفظة للخصم"}),e.jsxs(na,{value:Mr,onValueChange:ti,children:[e.jsx(ia,{className:"w-full",children:e.jsx(la,{placeholder:"اختر محفظة"})}),e.jsx(oa,{children:Re.map(t=>e.jsx(_s,{value:t.id,children:t.phone||t.name||t.id},t.id))})]})]})]}),e.jsxs(Ge,{className:"flex justify-between",children:[e.jsx(h,{variant:"outline",onClick:()=>{sr(!1),ei(null),ar(null),ti("")},children:"إلغاء"}),e.jsx(h,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{const t=!!Fr&&!Wa,a=Number(t?Fr.delta:(Wa==null?void 0:Wa.amount)||0);if(!gs){i({title:"اختر مصدر الخصم",description:"يرجى اختيار النقدية أو المحفظة",variant:"destructive"});return}try{if(gs==="cash"){const r=Number((lt-a).toFixed(2));Jt(r),localStorage.setItem(Ds(),r.toString());const l=new Date().toISOString(),o={cashBalance:r,lastUpdated:l},d=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(d,JSON.stringify(o)),s!=null&&s.uid?await De.updateUserData(s.uid,o).then(()=>{localStorage.removeItem(d),ke(!1)}).catch(()=>{ke(!0)}):ke(!0)}else if(gs==="wallet"){if(!Mr){i({title:"اختر محفظة",description:"يرجى اختيار محفظة للخصم",variant:"destructive"});return}const r=Be[Mr]||0,l=Number((r-a).toFixed(2)),o={...Be,[Mr]:l};Xt(o);const d=new Date().toISOString(),x={walletBalances:o,lastUpdated:d},g=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(g,JSON.stringify(x)),localStorage.setItem(fs(),JSON.stringify(o)),localStorage.setItem(`walletBalances_backup_${d}`,JSON.stringify(o)),s!=null&&s.uid&&await De.updateUserData(s.uid,x)}}catch(r){console.error("خطأ أثناء تحديث الأرصدة عند حفظ/تعديل الدين:",r)}if(t){if(!ge)return;const r=Number(ge.amount||0),l=Number(ge.paidAmount||0),o=Number(Fr.delta||0);if(Fr.type==="decrease"){const d=Math.max(l,r-o);if(d===r)i({title:"لا يمكن الإنقاص أكثر",description:"المبلغ لا يمكن أن يقل عن المدفوع."});else{const x=l>=d,g={...ge,amount:Number(d.toFixed(2)),status:x?"paid":"pending"},C=At.map(y=>y.id===ge.id?g:y);ps(C),Xa(g),await Ss(C);try{x&&(s!=null&&s.uid)&&(async()=>{const y=et(_e(J,"userTransactions"),Ce("userId","==",s.uid),Ce("linkedDebtId","==",ge.id),Ce("status","==","pending")),j=await ct(y);await Promise.allSettled(j.docs.map(B=>Ls(B.ref,{status:"completed",confirmedAt:new Date})))})().catch(y=>console.error("تعذر تحديث حالة المعاملات المرتبطة بالدين بعد الإنقاص:",y))}catch(y){console.error("تعذر تجهيز تحديث حالة المعاملات المرتبطة بعد الإنقاص:",y)}i({title:"تم إنقاص المبلغ",description:`المبلغ الجديد: ${d} جنيه`})}}else{const d=r+o,x=l>=d,g={...ge,amount:Number(d.toFixed(2)),status:x?"paid":"pending"},C=At.map(y=>y.id===ge.id?g:y);ps(C),Xa(g),await Ss(C),i({title:"تم زيادة المبلغ",description:`المبلغ الجديد: ${d} جنيه`})}}else if(Wa){const r=[...At,Wa];ps(r),await Ss(r)}il(""),ll(""),ol(""),_a(!1),sr(!1),ei(null),ml(null),ar(null),ti(""),i({title:t?"تم تطبيق الخصم وتعديل الدين":gs==="none"?"تم حفظ الدين بدون خصم":"تم حفظ الدين وخصم المبلغ",description:gs==="none"?"لم يتم الخصم من الدرج أو المحافظ":gs==="cash"?`تم خصم ${a} من الرصيد النقدي`:`تم خصم ${a} من رصيد المحفظة`})},children:"تأكيد الخصم"})]})]})}),e.jsx(ce,{open:Kc,onOpenChange:ea,children:e.jsxs(de,{className:"sm:max-w-[425px]",children:[e.jsx(me,{children:e.jsx(he,{className:"text-right",children:"إيصال الدين"})}),ge&&e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"text-center border-b pb-4",children:[e.jsx("h2",{className:"text-xl font-bold",children:"إيصال دين"}),e.jsx("p",{className:"text-sm text-gray-500",children:ln.format(ge.createdAt instanceof Date?ge.createdAt:new Date(ge.createdAt))})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"اسم المديون:"}),e.jsx("span",{children:ge.debtorName})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"font-medium",children:"المبلغ:"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(h,{variant:"outline",className:"h-8 w-8 p-0","aria-label":"إنقاص الدين",onClick:()=>{cl("decrease"),Un(""),ea(!1),er(!0)},children:"−"}),e.jsxs("span",{className:"font-bold text-lg",children:[ge.amount," جنيه"]}),e.jsx(h,{variant:"outline",className:"h-8 w-8 p-0","aria-label":"زيادة الدين",onClick:()=>{cl("increase"),Un(""),ea(!1),er(!0)},children:"+"})]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"سبب الدين:"}),e.jsx("span",{children:ge.reason})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"الحالة:"}),e.jsx(Mt,{variant:ge.status==="paid"?"default":"secondary",className:ge.status==="paid"?"bg-green-500":"bg-yellow-500",children:ge.status==="paid"?"مدفوع":"مؤجل"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"المبلغ المتبقي:"}),e.jsxs("span",{className:"font-bold text-lg",children:[Math.max(0,Number(ge.amount||0)-Number(ge.paidAmount||0))," جنيه"]})]}),ge.paidAmount?e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"إجمالي المدفوع:"}),e.jsxs("span",{className:"text-green-700",children:[ge.paidAmount," جنيه"]})]}):null,e.jsxs("div",{className:"mt-3 p-3 border rounded-lg bg-gray-50",children:[Hc?e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"partialAmount",className:"text-right block",children:"المبلغ المراد دفعه"}),e.jsx(U,{id:"partialAmount",type:"number",value:hl,onChange:t=>qn(t.target.value),className:"text-right",placeholder:"أدخل المبلغ"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(h,{variant:"outline",onClick:()=>{zn(!1),qn("")},children:"إلغاء"}),e.jsx(h,{className:"bg-blue-600 hover:bg-blue-700",onClick:async()=>{const t=parseFloat(hl);if(!ge||isNaN(t)||t<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const a=Math.max(0,Number(ge.amount||0)-Number(ge.paidAmount||0));if(t>a){i({title:"مبلغ زائد",description:"المبلغ المدفوع أكبر من المتبقي",variant:"destructive"});return}const r=Number(((ge.paidAmount||0)+t).toFixed(2)),l=r>=Number(ge.amount||0),o={...ge,amount:Number(ge.amount||0),paidAmount:r,status:l?"paid":"pending",partialPayments:[...ge.partialPayments||[],{amount:t,paidAt:new Date}]},d=At.map(x=>x.id===ge.id?o:x);ps(d),Xa(o),await Ss(d);try{o.status==="paid"&&(s!=null&&s.uid)&&(async()=>{const x=et(_e(J,"userTransactions"),Ce("userId","==",s.uid),Ce("linkedDebtId","==",ge.id),Ce("status","==","pending")),g=await ct(x);await Promise.allSettled(g.docs.map(C=>Ls(C.ref,{status:"completed",confirmedAt:new Date})))})().catch(x=>console.error("تعذر تحديث حالة المعاملات المرتبطة بالدين:",x))}catch(x){console.error("تعذر تجهيز تحديث حالة المعاملات المرتبطة:",x)}try{const x=Ma(),g=localStorage.getItem(x);if(g){const y=(JSON.parse(g)||[]).map(j=>(j==null?void 0:j.linkedDebtId)===ge.id&&(j==null?void 0:j.status)==="pending"?{...j,status:"completed",confirmedAt:new Date}:j);localStorage.setItem(x,JSON.stringify(y)),Fs(j=>j.map(B=>(B==null?void 0:B.linkedDebtId)===ge.id&&(B==null?void 0:B.status)==="pending"?{...B,status:"completed",confirmedAt:new Date}:B))}}catch(x){console.warn("فشل تحديث حالة المعاملات المرتبطة محلياً بعد سداد الدين:",x)}Lr(t),ta("cash"),Fa(!0),zn(!1),qn(""),i({title:"تم تسجيل دفع جزء",description:`تم دفع ${t} جنيه بتاريخ ${new Date().toLocaleString("ar-EG")}`})},children:"دفع"})]})]}):e.jsx(h,{variant:"outline",className:"w-full",onClick:()=>zn(!0),children:"دفع جزء"}),ge.partialPayments&&ge.partialPayments.length>0&&e.jsxs("div",{className:"mt-3 text-xs text-gray-600",children:[e.jsx("p",{className:"font-medium mb-1",children:"سجل الدفعات الجزئية:"}),e.jsx("div",{className:"space-y-1 max-h-24 overflow-y-auto",children:ge.partialPayments.map((t,a)=>e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{children:["دفع: ",t.amount," جنيه"]}),e.jsx("span",{children:new Date(t.paidAt).toLocaleString("ar-EG")})]},a))})]})]})]})]}),e.jsxs(Ge,{className:"flex gap-2 justify-center",children:[e.jsx(h,{onClick:async()=>{if(ge){const t=At.map(a=>a.id===ge.id?{...a,status:"pending"}:a);ps(t),await Ss(t),ea(!1),i({title:"تم تحديث حالة الدين",description:"تم تعيين الدين كمؤجل"})}},variant:"outline",className:"bg-yellow-500 hover:bg-yellow-600 text-white",children:"مؤجل"}),e.jsx(h,{onClick:async()=>{if(ge){const a=Math.max(0,Number(ge.amount||0)-Number(ge.paidAmount||0)),r=At.map(l=>l.id===ge.id?{...l,amount:Number(l.amount||0),paidAmount:Number(((l.paidAmount||0)+a).toFixed(2)),status:"paid",partialPayments:[...l.partialPayments||[],...a>0?[{amount:a,paidAt:new Date}]:[]]}:l);ps(r),a>0&&(Lr(a),ta("cash"),Fa(!0)),await Ss(r);try{s!=null&&s.uid&&(ge!=null&&ge.id)&&(async()=>{const l=et(_e(J,"userTransactions"),Ce("userId","==",s.uid),Ce("linkedDebtId","==",ge.id),Ce("status","==","pending")),o=await ct(l);await Promise.allSettled(o.docs.map(d=>Ls(d.ref,{status:"completed",confirmedAt:new Date})))})().catch(l=>console.error("تعذر تحديث حالة المعاملات المرتبطة بالدين:",l))}catch(l){console.error("تعذر تجهيز تحديث حالة المعاملات المرتبطة:",l)}try{const l=Ma(),o=localStorage.getItem(l);if(o){const x=(JSON.parse(o)||[]).map(g=>(g==null?void 0:g.linkedDebtId)===ge.id&&(g==null?void 0:g.status)==="pending"?{...g,status:"completed",confirmedAt:new Date}:g);localStorage.setItem(l,JSON.stringify(x)),Fs(g=>g.map(C=>(C==null?void 0:C.linkedDebtId)===ge.id&&(C==null?void 0:C.status)==="pending"?{...C,status:"completed",confirmedAt:new Date}:C))}}catch(l){console.warn("فشل تحديث حالة المعاملات المرتبطة محلياً بعد سداد الدين:",l)}ea(!1),i({title:"تم تحديث حالة الدين",description:"تم تعيين الدين كمدفوع"})}},className:"bg-green-500 hover:bg-green-600",children:"مدفوع"}),e.jsx(h,{onClick:async()=>{if(ge){const t=At.filter(a=>a.id!==ge.id);ps(t),await Ss(t),ea(!1),i({title:"تم حذف الدين",description:"تم حذف الدين بنجاح"})}},variant:"destructive",children:"حذف"})]})]})}),e.jsx(ce,{open:Yc,onOpenChange:er,children:e.jsxs(de,{className:"sm:max-w-md rounded-2xl shadow-elegant border border-gray-200",children:[e.jsxs(me,{children:[e.jsx(he,{className:`text-right ${ya==="decrease"?"text-red-600":"text-green-600"}`,children:ya==="decrease"?"إنقاص مبلغ الدين":ya==="increase"?"زيادة مبلغ الدين":"تعديل مبلغ الدين"}),e.jsxs(ss,{className:"text-right",children:["أدخل المبلغ ثم اضغط تأكيد لإتمام ",ya==="decrease"?"الإنقاص":"الزيادة","."]})]}),e.jsxs("div",{className:"grid gap-4 py-2",children:[e.jsx(H,{htmlFor:"debtAdjustAmount",className:"text-right",children:"المبلغ (جنيه)"}),e.jsx(U,{id:"debtAdjustAmount",type:"number",placeholder:"0.00",value:dl,onChange:t=>Un(t.target.value)}),ge&&e.jsxs("div",{className:"text-right text-sm text-muted-foreground",children:["المبلغ الحالي: ",e.jsx("span",{className:"font-semibold",children:Number(ge.amount||0).toFixed(2)})," جنيه"]})]}),e.jsxs(Ge,{className:"flex gap-2",children:[e.jsx(h,{variant:"secondary",onClick:()=>{er(!1),ea(!0)},children:"إلغاء"}),e.jsx(h,{className:ya==="decrease"?"bg-red-600 hover:bg-red-700":"bg-green-600 hover:bg-green-700",onClick:async()=>{try{if(!ge||!ya)return;const t=Number(parseFloat(dl||"0").toFixed(2));if(!t||isNaN(t)||t<=0){i({title:"قيمة غير صالحة",description:"يرجى إدخال مبلغ أكبر من صفر",variant:"destructive"});return}ml({debtId:ge.id,delta:t,type:ya}),er(!1),sr(!0)}catch(t){console.error("فشل تجهيز تعديل مبلغ الدين:",t),i({title:"خطأ",description:"تعذّر تجهيز تعديل مبلغ الدين",variant:"destructive"})}},children:"تأكيد"})]})]})}),e.jsx(ce,{open:Xc,onOpenChange:Fa,children:e.jsxs(de,{className:"sm:max-w-[480px]",children:[e.jsxs(me,{children:[e.jsx(he,{className:"text-right",children:"اختيار إضافة مبلغ السداد"}),e.jsx(ss,{className:"text-right",children:"هل تريد إضافة مبلغ السداد إلى الفلوس النقدية أم إلى إحدى المحافظ؟"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex flex-wrap gap-2 justify-center",children:[e.jsx(h,{variant:vs==="cash"?"default":"outline",className:vs==="cash"?"bg-blue-600 text-white":"",size:"sm",onClick:()=>ta("cash"),children:"الفلوس النقدية"}),e.jsx(h,{variant:vs==="wallet"?"default":"outline",className:vs==="wallet"?"bg-blue-600 text-white":"",size:"sm",onClick:()=>ta("wallet"),children:"أرصدة المحافظ"}),e.jsx(h,{variant:vs==="fawry"?"default":"outline",className:vs==="fawry"?"bg-amber-600 text-white":"",size:"sm",onClick:()=>ta("fawry"),children:"فوري"}),e.jsx(h,{variant:vs==="none"?"default":"outline",className:vs==="none"?"bg-gray-600 text-white":"",size:"sm",onClick:()=>ta("none"),children:"بدون إضافة"})]}),vs==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-right",children:"اختر المحفظة"}),e.jsxs("select",{className:"w-full border rounded p-2 text-right",value:va,onChange:t=>si(t.target.value),children:[e.jsx("option",{value:"",children:"— اختر محفظة —"}),Re&&Re.length>0?Re.map(t=>e.jsx("option",{value:t.id,children:t.phone||t.name||t.id},t.id)):Object.keys(Be||{}).map(t=>{var a,r,l,o,d,x;return e.jsx("option",{value:t,children:((a=Re.find(g=>g.id===t))==null?void 0:a.phone)||((l=(r=JSON.parse(localStorage.getItem(ui())||"[]"))==null?void 0:r.find(g=>g.id===t))==null?void 0:l.phone)||((d=(o=JSON.parse(localStorage.getItem(ui())||"[]"))==null?void 0:o.find(g=>g.id===t))==null?void 0:d.name)||((x=Re.find(g=>g.id===t))==null?void 0:x.name)||t},t)})]})]}),e.jsxs("div",{className:"text-right text-sm text-gray-600",children:["المبلغ المراد إضافته: ",e.jsxs("span",{className:"font-bold",children:[vl," جنيه"]})]})]}),e.jsxs(Ge,{className:"flex flex-wrap justify-between gap-2",children:[e.jsx(h,{variant:"outline",onClick:()=>{Fa(!1),Lr(0),ta(null),si("")},children:"إلغاء"}),e.jsx(h,{onClick:async()=>{var t,a;try{const r=vl;if(!r||r<=0){Fa(!1);return}if(vs==="cash"){const l=lt+r;Jt(l),localStorage.setItem(Ds(),l.toString());const o={cashBalance:l,lastUpdated:new Date().toISOString()},d=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(d,JSON.stringify(o)),s!=null&&s.uid?(De.updateUserData(s.uid,o).catch(()=>ke(!0)),localStorage.removeItem(d),ke(!1)):ke(!0),i({title:"تمت إضافة مبلغ السداد",description:`تمت إضافة ${r} جنيه إلى الفلوس النقدية`})}else if(vs==="wallet"){if(!va){i({title:"اختر محفظة أولاً",description:"يرجى اختيار المحفظة لإضافة مبلغ السداد إليها",variant:"destructive"});return}const l={...Be,[va]:(Be[va]||0)+r};Xt(l);const o=(lt||0)-r;Jt(o),localStorage.setItem(Ds(),o.toString());const d=new Date().toISOString(),x={walletBalances:l,cashBalance:o,lastUpdated:d},g=`userData_${s==null?void 0:s.uid}`;if(localStorage.setItem(g,JSON.stringify(x)),localStorage.setItem(fs(),JSON.stringify(l)),localStorage.setItem(`walletBalances_backup_${d}`,JSON.stringify(l)),s!=null&&s.uid){De.updateUserData(s.uid,x).catch(()=>ke(!0));try{localStorage.removeItem(g)}catch{}ke(!1)}else ke(!0);i({title:"تمت إضافة مبلغ السداد",description:`تمت إضافة ${r} جنيه إلى المحفظة ${((t=Re.find(C=>C.id===va))==null?void 0:t.phone)||((a=Re.find(C=>C.id===va))==null?void 0:a.name)||va} وتم خصم نفس المبلغ من درج النقدية`})}else if(vs==="none"){const l=(lt||0)-r;Jt(l),localStorage.setItem(Ds(),l.toString());const o={cashBalance:l,lastUpdated:new Date().toISOString()},d=`userData_${s==null?void 0:s.uid}`;if(localStorage.setItem(d,JSON.stringify(o)),s!=null&&s.uid){De.updateUserData(s.uid,o).catch(()=>ke(!0));try{localStorage.removeItem(d)}catch{}ke(!1)}else ke(!0);i({title:"تم تسجيل السداد",description:`تم خصم ${r} جنيه من درج النقدية بدون إضافة للمحافظ`})}else if(vs==="fawry")i({title:"تم تسجيل سداد عبر فوري",description:`تم تسجيل ${r} جنيه كسداد عبر فوري بدون تعديل الأرصدة`});else{i({title:"اختر مصدر الإضافة",description:"يرجى اختيار إضافة المبلغ إلى النقدية أو المحفظة",variant:"destructive"});return}}catch(r){console.error("خطأ أثناء إضافة مبلغ السداد:",r),i({title:"حدث خطأ",description:"تعذر إضافة مبلغ السداد، حاول مرة أخرى",variant:"destructive"})}finally{Fa(!1),Lr(0),ta(null),si("")}},className:"bg-green-600 hover:bg-green-700",children:"تأكيد الإضافة"})]})]})}),e.jsx(ce,{open:Tc,onOpenChange:ga,children:e.jsxs(de,{hideClose:!0,className:"post-confirm-card sm:max-w-[420px] w-[90vw] rounded-2xl bg-gradient-to-br from-white via-indigo-50 to-blue-50 shadow-2xl border border-indigo-100",children:[e.jsxs(me,{children:[e.jsx(he,{className:"text-right text-2xl font-bold",children:(Vt==null?void 0:Vt.type)==="transfer"?"مبلغ يجب استلامه":"مبلغ يجب تسليمه"}),e.jsx(ss,{className:"text-right text-gray-600",children:(Vt==null?void 0:Vt.type)==="transfer"?"هذا هو المبلغ الواجب استلامه من العميل بعد التأكيد.":"هذا هو المبلغ الواجب تسليمه للعميل بعد التأكيد."})]}),e.jsxs("div",{className:"py-3 flex flex-col items-center gap-1.5",children:[e.jsxs("div",{className:"text-xl sm:text-2xl font-bold text-blue-700 tracking-wide",children:[bs((Vt==null?void 0:Vt.amount)||0)," جنيه"]}),e.jsx("div",{className:"text-sm text-gray-500 text-right w-full",children:(Vt==null?void 0:Vt.type)==="transfer"?"المبلغ المعروض شامل عمولة التحويل.":tt?"العمولة مضافة ولا تؤثر على قيمة التسليم.":"العمولة مخصومة من المبلغ المسلّم للعميل."})]}),e.jsxs(Ge,{className:"flex justify-end gap-2",children:[(Vt==null?void 0:Vt.type)==="transfer"&&e.jsx(h,{variant:"outline",id:"sendCodeBtn",onClick:at,disabled:Zi,className:"btn-transfer-confirm",children:Zi?"جارٍ الإرسال...":"إرسال كود التحويل"}),e.jsx(h,{onClick:()=>{ga(!1),Wn(null)},className:"bg-green-600 hover:bg-green-700 text-white",children:(Vt==null?void 0:Vt.type)==="transfer"?"تم الاستلام":"تم التسليم"})]})]})}),e.jsx(Rm,{open:kc,onClose:()=>Ea(!1),onSubmit:kt,deviceId:Xi||_t||"",recipientMsisdn:String(ie==="transfer"?(xs==null?void 0:xs.receiver)||os||"":((eo=Re.find(t=>t.id===ee))==null?void 0:eo.phone)||"").replace(/\D/g,"")}),e.jsx(kh,{open:W,onOpenChange:ne}),el]}))};export{Bu as default};
