const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-CtI5CTI7.js","assets/index-DlBM-tqJ.css","assets/walletDailyLimitsService-BPucvIOt.js","assets/profitService-D4-kgAVt.js","assets/reportsService-Czc76COW.js"])))=>i.map(i=>d[i]);
var Xo=Object.defineProperty;var Zo=(l,u,o)=>u in l?Xo(l,u,{enumerable:!0,configurable:!0,writable:!0,value:o}):l[u]=o;var cn=(l,u,o)=>Zo(l,typeof u!="symbol"?u+"":u,o);import{c as ms,A as ec,B as tc,u as Ps,r as n,j as e,a8 as Ia,U as aa,a6 as Ts,aY as gr,C as zs,d as hs,a as $l,a7 as Tt,a1 as Rl,a0 as Ul,_ as Is,aO as mr,R as tt,F as Sa,n as sc,S as ys,X as Ta,q as Rs,f as bs,g as xt,a4 as Bt,h as Us,a9 as jn,$ as ra,k as cs,v as ea,aV as ac,a5 as kl,G as rc,H as _l,K as nc,aZ as lc,y as Ks,aB as Pl,a_ as zl,Q as Ce,D as ic,az as oc,aU as cc,p as dc,m as mc,Z as Na,aC as hc,aD as uc,aT as xc,e as Al,aA as lr,w as ir}from"./index-CtI5CTI7.js";import{C as st,a as wt,b as Mt,d as nt}from"./card-KvawPZcs.js";import{B as d,b as Jl}from"./button-4cbJeGJ1.js";import{I as L}from"./input-DsRFHxSE.js";import{B as jt}from"./badge-CkNVDxem.js";import{S as Bs,a as Ms,b as Ls,c as $s,d as os,C as Nn,e as Kl}from"./select-BN0I1EI2.js";import{D as me,a as he,b as ue,c as xe,g as ql,T as pc,O as gc,W as fc,C as vc,h as bc,i as yc,j as Vl,R as jc,P as Nc,e as Zt,d as Pe}from"./dialog-Dmww2FHL.js";import{L as q}from"./label-DPf6zPLX.js";import{M as es,a as Vt}from"./MasterPinDialog-CO-RB_pM.js";import{walletDailyLimitsService as js}from"./walletDailyLimitsService-BPucvIOt.js";import{T as Ut,P as hr}from"./progress-83w-Ryil.js";import{W as ds}from"./wallet-CmVmA9qa.js";import{S as Yl}from"./star-CcEsJ8OT.js";import{S as Hl}from"./square-pen-BKLh7Pfl.js";import{P as Ns}from"./phone-BT-iPFCG.js";import{A as Gl}from"./arrow-left-Dp7D3W3Z.js";import{a as gn,S as wc}from"./separator-C-1vncBm.js";import{C as ks}from"./calendar-Clti5EEM.js";import{C as fn}from"./chart-column-j2jhdHEt.js";import{D as lt}from"./dollar-sign-CFNn-mZ2.js";import{A as dn}from"./activity-Dp3Jm3-3.js";import{C as qs}from"./circle-alert-CxwfSdyU.js";import{C as wn}from"./circle-x-DMJhAi5s.js";import{C as ur}from"./circle-check-big-CA6NzfIi.js";import{a as Ve,E as St}from"./eye-Cwy6ormp.js";import{S as Sc}from"./store-CDgC0yZv.js";import{A as Dc}from"./arrow-right-CHFsCGOY.js";import{U as vn}from"./user-Bg5JeDV3.js";import{c as Cc,C as Ql,a as Ic,R as Tc,P as Ol,b as kc,M as Pc}from"./PasswordConfirmDialog-BbJLOD6K.js";import{L as Js}from"./lock-DNR6Csbs.js";import{M as _s}from"./minus-grW84as4.js";import{w as Ac,W as Oc}from"./WalletsManagement-Czi6Tez9.js";import{reportsService as Rt}from"./reportsService-Czc76COW.js";import{N as Wc,P as Fc}from"./NotificationBell-D8_YsKJl.js";import{S as mn}from"./shield-D5FWDzQe.js";import{G as Ec}from"./gift-Cwr4v6CN.js";import{ProfitService as ts}from"./profitService-D4-kgAVt.js";import{D as Bc}from"./index.esm-Ce2ozw2n.js";import{R as Mc}from"./refresh-cw-Cvhdbn7f.js";import"./index-DD5Z90BH.js";import"./Combination-DZzoSRHd.js";import"./index-Dky5NDcE.js";import"./whatsappService-C9NN3eXA.js";import"./dropdown-menu-Cu3Md5iB.js";import"./index-CdbC5net.js";import"./avatars-CM8TTLQb.js";import"./broadcastService-CM9nTMw9.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xr=ms("ArrowDownLeft",[["path",{d:"M17 7 7 17",key:"15tmo1"}],["path",{d:"M17 17H7V7",key:"1org7z"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Xl=ms("ArrowRightLeft",[["path",{d:"m16 3 4 4-4 4",key:"1x1c3m"}],["path",{d:"M20 7H4",key:"zbl0bi"}],["path",{d:"m8 21-4-4 4-4",key:"h9nckh"}],["path",{d:"M4 17h16",key:"g4d7ey"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Lc=ms("Award",[["path",{d:"m15.477 12.89 1.515 8.526a.5.5 0 0 1-.81.47l-3.58-2.687a1 1 0 0 0-1.197 0l-3.586 2.686a.5.5 0 0 1-.81-.469l1.514-8.526",key:"1yiouv"}],["circle",{cx:"12",cy:"8",r:"6",key:"1vp47v"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $c=ms("Banknote",[["rect",{width:"20",height:"12",x:"2",y:"6",rx:"2",key:"9lu3g6"}],["circle",{cx:"12",cy:"12",r:"2",key:"1c9p78"}],["path",{d:"M6 12h.01M18 12h.01",key:"113zkx"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Rc=ms("BookOpen",[["path",{d:"M12 7v14",key:"1akyts"}],["path",{d:"M3 18a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h5a4 4 0 0 1 4 4 4 4 0 0 1 4-4h5a1 1 0 0 1 1 1v13a1 1 0 0 1-1 1h-6a3 3 0 0 0-3 3 3 3 0 0 0-3-3z",key:"ruj8y"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Zl=ms("Building",[["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",ry:"2",key:"76otgf"}],["path",{d:"M9 22v-4h6v4",key:"r93iot"}],["path",{d:"M8 6h.01",key:"1dz90k"}],["path",{d:"M16 6h.01",key:"1x0f13"}],["path",{d:"M12 6h.01",key:"1vi96p"}],["path",{d:"M12 10h.01",key:"1nrarc"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M16 10h.01",key:"1m94wz"}],["path",{d:"M16 14h.01",key:"1gbofw"}],["path",{d:"M8 10h.01",key:"19clt8"}],["path",{d:"M8 14h.01",key:"6423bh"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pr=ms("IdCard",[["path",{d:"M16 10h2",key:"8sgtl7"}],["path",{d:"M16 14h2",key:"epxaof"}],["path",{d:"M6.17 15a3 3 0 0 1 5.66 0",key:"n6f512"}],["circle",{cx:"9",cy:"11",r:"2",key:"yxgjnd"}],["rect",{x:"2",y:"5",width:"20",height:"14",rx:"2",key:"qneu4z"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const bn=ms("Info",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const or=ms("Package",[["path",{d:"M11 21.73a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73z",key:"1a0edw"}],["path",{d:"M12 22V12",key:"d0xqtd"}],["path",{d:"m3.3 7 7.703 4.734a2 2 0 0 0 1.994 0L20.7 7",key:"yx3hmr"}],["path",{d:"m7.5 4.27 9 5.15",key:"1c824w"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Da=ms("TrendingDown",[["polyline",{points:"22 17 13.5 8.5 8.5 13.5 2 7",key:"1r2t7k"}],["polyline",{points:"16 17 22 17 22 11",key:"11uiuu"}]]),Uc=async(l={})=>{try{return(await ec(tc,"getLastTransactions")(l)).data}catch(u){throw console.error("Error getting last transactions:",u),u.code==="functions/unauthenticated"?new Error("يجب تسجيل الدخول للوصول إلى المعاملات"):u.code==="functions/invalid-argument"?new Error("بيانات الاستعلام غير صالحة: "+u.message):u.code==="functions/permission-denied"?new Error("ليس لديك صلاحية للوصول إلى هذه المعاملات: "+u.message):new Error("حدث خطأ أثناء جلب المعاملات: "+(u.message||"خطأ غير معروف"))}},_c=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],zc=({isOpen:l,onClose:u,onWalletSelect:o,onEditWallet:x,onDeleteWallet:y})=>{const{user:v}=Ps(),[t,E]=n.useState([]),[T,g]=n.useState(!1),m=()=>`wallets_${(v==null?void 0:v.uid)||"default"}`,w=()=>{try{const I=m(),R=localStorage.getItem(I);if(R){const re=JSON.parse(R);if(Array.isArray(re)&&re.length>0)return re}const ee="wallets_default",$=localStorage.getItem(ee);if($){const re=JSON.parse($);if(Array.isArray(re)&&re.length>0){localStorage.setItem(I,$);try{localStorage.removeItem(ee)}catch{}return re}}const C=Object.keys(localStorage).filter(re=>re.startsWith("wallets_")&&re!==I);let _=null,Z=null;for(const re of C)try{const ce=localStorage.getItem(re);if(!ce)continue;const J=JSON.parse(ce);Array.isArray(J)&&J.length>0&&(!_||J.length>((_==null?void 0:_.length)||0))&&(_=J,Z=re)}catch{}if(_&&Z){localStorage.setItem(I,JSON.stringify(_));try{localStorage.removeItem(Z)}catch{}return _}}catch(I){console.warn("WalletsViewPage migration failed:",I)}return null},b=async(I,R)=>{const ee=new Date().getMonth(),$=new Date().getFullYear(),C=R.filter(J=>{const V=new Date(J.createdAt);return V.getMonth()===ee&&V.getFullYear()===$&&J.lineId===I}),_=J=>{const V=J.type;return J.txnType==="receive"||V==="withdraw"||V==="withdrawal"||V==="receive"},Z=J=>{const V=J.type;return J.txnType==="send"||V==="send"||V==="transfer"},re=C.filter(_).reduce((J,V)=>{const Ae=V.withdrawnAmount!==void 0?V.withdrawnAmount:V.amount;return J+(Ae||0)},0),ce=C.filter(Z).reduce((J,V)=>{const Ae=V.sentAmount!==void 0?V.sentAmount:V.amount;return J+(Ae||0)},0);return{withdrawalUsage:re,transferUsage:ce}},B=I=>{const R=new Date().toISOString().split("T")[0],ee=I.lastResetDate;if(!ee)return{...I,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:R};const $=new Date(ee),C=new Date;return $.getMonth()!==C.getMonth()||$.getFullYear()!==C.getFullYear()?{...I,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:R}:I};n.useEffect(()=>{if(!(v!=null&&v.uid)||!l)return;(async()=>{g(!0);try{const R=await Ts.getByMerchantId(v.uid),ee=await gr.getByUserId(v.uid),C=(await Promise.all(R.map(async _=>{const{withdrawalUsage:Z,transferUsage:re}=await b(_.id,ee);return{id:_.id,name:_.label||"محفظة بدون اسم",phone:_.msisdn,nationalId:_.nationalId||"",isDefault:!1,monthlyWithdrawalLimit:_.withdrawLimit||2e5,monthlyTransferLimit:_.transferLimit||2e5,monthlyWithdrawalUsage:Z,monthlyTransferUsage:re,lastResetDate:new Date().toISOString().split("T")[0],walletProvider:_.walletProvider||""}}))).map(B);if(E(C),!C||C.length===0){const _=w();_&&_.length>0&&E(_.map(B))}}catch(R){console.error("Error loading wallets:",R);const ee=w();ee&&E(ee.map($=>({...$,phone:$.phone||$.phoneNumber,monthlyWithdrawalLimit:$.monthlyWithdrawalLimit||2e5,monthlyTransferLimit:$.monthlyTransferLimit||2e5})))}finally{g(!1)}})()},[v==null?void 0:v.uid,l]);const U=I=>_c.find(R=>R.id===I),X=(I,R)=>R>0?Math.min(I/R*100,100):0,M=I=>new Intl.NumberFormat("ar-EG").format(I);return e.jsx(me,{open:l,onOpenChange:u,children:e.jsxs(he,{className:"max-w-6xl max-h-[90vh] overflow-y-auto",children:[e.jsx(ue,{className:"pb-4",children:e.jsxs(xe,{className:"flex items-center gap-2 text-lg",children:[e.jsx(ds,{className:"h-5 w-5"}),"الاطلاع على جميع المحافظ",e.jsxs(jt,{variant:"secondary",className:"mr-2",children:[t.length," محفظة"]})]})}),T?e.jsx("div",{className:"flex justify-center items-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-600",children:"جاري تحميل المحافظ..."})]})}):t.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(ds,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"لا توجد محافظ مضافة حتى الآن"})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:t.map(I=>{const R=U(I.walletProvider||""),ee=X(I.monthlyWithdrawalUsage||0,I.monthlyWithdrawalLimit),$=X(I.monthlyTransferUsage||0,I.monthlyTransferLimit);return e.jsxs(st,{className:"cursor-pointer hover:shadow-lg transition-shadow border-2 hover:border-blue-300",onClick:()=>o(I),children:[e.jsx(wt,{className:"pb-3",children:e.jsxs(Mt,{className:"flex items-center justify-between text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ia,{className:"h-4 w-4"}),e.jsx("span",{children:I.name})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[I.isDefault&&e.jsxs(jt,{variant:"default",className:"text-xs",children:[e.jsx(Yl,{className:"h-3 w-3 mr-1"}),"افتراضية"]}),e.jsx(d,{variant:"ghost",size:"sm",onClick:C=>{C.stopPropagation(),x==null||x(I)},className:"h-7 px-2",children:e.jsx(Hl,{className:"h-4 w-4"})}),e.jsx(d,{variant:"ghost",size:"sm",onClick:C=>{C.stopPropagation(),y==null||y(I.id)},className:"h-7 px-2 text-destructive hover:text-destructive",children:e.jsx(Ut,{className:"h-4 w-4"})})]})]})}),e.jsxs(nt,{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Ns,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"font-mono",children:I.phone})]}),I.nationalId&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(pr,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"font-mono",children:I.nationalId})]}),R&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Zl,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{children:R.name})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Da,{className:"h-3 w-3 text-red-500"}),"السحب الشهري"]}),e.jsxs("span",{className:"font-mono",children:[M(I.monthlyWithdrawalUsage||0)," / ",M(I.monthlyWithdrawalLimit)]})]}),e.jsx(hr,{value:ee,className:"h-2"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(aa,{className:"h-3 w-3 text-green-500"}),"التحويل الشهري"]}),e.jsxs("span",{className:"font-mono",children:[M(I.monthlyTransferUsage||0)," / ",M(I.monthlyTransferLimit)]})]}),e.jsx(hr,{value:$,className:"h-2"})]}),e.jsx(d,{variant:"outline",size:"sm",className:"w-full text-xs",onClick:C=>{C.stopPropagation(),o(I)},children:"عرض التفاصيل الكاملة"})]})]},I.id)})}),e.jsx("div",{className:"flex justify-end pt-4 border-t",children:e.jsxs(d,{onClick:u,variant:"outline",children:[e.jsx(Gl,{className:"h-4 w-4 mr-2"}),"إغلاق"]})})]})})},Jc=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],Kc=({wallet:l,isOpen:u,onClose:o,onBack:x})=>{const{user:y}=Ps(),[v,t]=n.useState([]),[E,T]=n.useState(!1),[g,m]=n.useState("month");if(n.useEffect(()=>{if(!l||!(y!=null&&y.uid)||!u)return;(async()=>{T(!0);try{const Be=(await gr.getByUserId(y.uid)).filter(Ge=>Ge.walletId===l.id).sort((Ge,kt)=>new Date(kt.createdAt).getTime()-new Date(Ge.createdAt).getTime());t(Be)}catch(le){console.error("Error loading transactions:",le)}finally{T(!1)}})()},[l,y==null?void 0:y.uid,u]),!l)return null;const w=H=>Jc.find(le=>le.id===H),b=(H,le)=>le>0?Math.min(H/le*100,100):0,B=H=>new Intl.NumberFormat("ar-EG").format(H),U=H=>new Date(H).toLocaleDateString("ar-EG",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}),M=(()=>{const H=new Date;let le;switch(g){case"week":le=new Date(H.getTime()-7*24*60*60*1e3);break;case"month":le=new Date(H.getFullYear(),H.getMonth(),1);break;default:return v}return v.filter(Be=>new Date(Be.createdAt)>=le)})(),I=H=>{const le=H.type,Be=H.txnType;return le==="withdraw"||le==="withdrawal"||le==="receive"||Be==="receive"},R=H=>{const le=H.type,Be=H.txnType;return le==="send"||le==="transfer"||Be==="send"},ee=M.filter(H=>I(H)&&H.status==="completed").reduce((H,le)=>{const Be=le.withdrawnAmount!==void 0?le.withdrawnAmount:le.amount;return H+(Be||0)},0),$=M.filter(H=>R(H)&&H.status==="completed").reduce((H,le)=>{const Be=le.sentAmount!==void 0?le.sentAmount:le.amount;return H+(Be||0)},0),C=M.filter(H=>H.type==="deposit"&&H.status==="completed").reduce((H,le)=>H+le.amount,0),_=w(l.walletProvider||""),Z=b(l.monthlyWithdrawalUsage||0,l.monthlyWithdrawalLimit),re=b(l.monthlyTransferUsage||0,l.monthlyTransferLimit),ce=H=>{switch(H){case"withdrawal":return e.jsx(Da,{className:"h-4 w-4 text-red-500"});case"transfer":return e.jsx(aa,{className:"h-4 w-4 text-blue-500"});case"deposit":return e.jsx(lt,{className:"h-4 w-4 text-green-500"});default:return e.jsx(dn,{className:"h-4 w-4 text-gray-500"})}},J=H=>{switch(H){case"completed":return e.jsx(ur,{className:"h-4 w-4 text-green-500"});case"pending":return e.jsx(zs,{className:"h-4 w-4 text-yellow-500"});case"failed":return e.jsx(wn,{className:"h-4 w-4 text-red-500"});default:return e.jsx(qs,{className:"h-4 w-4 text-gray-500"})}},V=H=>{switch(H){case"withdrawal":return"سحب";case"transfer":return"تحويل";case"deposit":return"إيداع";default:return"معاملة"}},Ae=H=>{switch(H){case"completed":return"مكتملة";case"pending":return"قيد الانتظار";case"failed":return"فاشلة";default:return"غير محدد"}};return e.jsx(me,{open:u,onOpenChange:o,children:e.jsxs(he,{className:"max-w-6xl max-h-[90vh] overflow-y-auto",children:[e.jsx(ue,{className:"pb-4",children:e.jsxs(xe,{className:"flex items-center gap-2 text-lg",children:[e.jsx(Ia,{className:"h-5 w-5"}),"تفاصيل المحفظة: ",l.name,l.isDefault&&e.jsxs(jt,{variant:"default",className:"mr-2",children:[e.jsx(Yl,{className:"h-3 w-3 mr-1"}),"افتراضية"]})]})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-1 space-y-4",children:[e.jsxs(st,{children:[e.jsx(wt,{children:e.jsxs(Mt,{className:"text-sm flex items-center gap-2",children:[e.jsx(pr,{className:"h-4 w-4"}),"المعلومات الأساسية"]})}),e.jsxs(nt,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Ns,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-mono",children:l.phone})]}),l.nationalId&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(pr,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-mono",children:l.nationalId})]}),_&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Zl,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{children:_.name})]}),e.jsxs("div",{className:"text-xs text-gray-600 pr-6",children:[e.jsxs("div",{children:["المالك: ",_.ownerName]}),e.jsxs("div",{className:"font-mono",children:["الرقم القومي: ",_.nationalId]})]})]}),l.lastResetDate&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(ks,{className:"h-4 w-4 text-gray-500"}),e.jsxs("span",{children:["آخر إعادة تعيين: ",new Date(l.lastResetDate).toLocaleDateString("ar-EG")]})]})]})]}),e.jsxs(st,{children:[e.jsx(wt,{children:e.jsxs(Mt,{className:"text-sm flex items-center gap-2",children:[e.jsx(fn,{className:"h-4 w-4"}),"حدود الاستخدام الشهري"]})}),e.jsxs(nt,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Da,{className:"h-3 w-3 text-red-500"}),"السحب الشهري"]}),e.jsxs("span",{className:"font-mono",children:[B(l.monthlyWithdrawalUsage||0)," / ",B(l.monthlyWithdrawalLimit)]})]}),e.jsx(hr,{value:Z,className:"h-2"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["متبقي: ",B(l.monthlyWithdrawalLimit-(l.monthlyWithdrawalUsage||0))," جنيه"]})]}),e.jsx(gn,{}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(aa,{className:"h-3 w-3 text-green-500"}),"التحويل الشهري"]}),e.jsxs("span",{className:"font-mono",children:[B(l.monthlyTransferUsage||0)," / ",B(l.monthlyTransferLimit)]})]}),e.jsx(hr,{value:re,className:"h-2"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["متبقي: ",B(l.monthlyTransferLimit-(l.monthlyTransferUsage||0))," جنيه"]})]})]})]})]}),e.jsxs("div",{className:"lg:col-span-2 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsx(st,{children:e.jsxs(nt,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(Da,{className:"h-5 w-5 text-red-500"})}),e.jsx("div",{className:"text-lg font-bold",children:B(ee)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي السحب"})]})}),e.jsx(st,{children:e.jsxs(nt,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(aa,{className:"h-5 w-5 text-blue-500"})}),e.jsx("div",{className:"text-lg font-bold",children:B($)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي التحويل"})]})}),e.jsx(st,{children:e.jsxs(nt,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(lt,{className:"h-5 w-5 text-green-500"})}),e.jsx("div",{className:"text-lg font-bold",children:B(C)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي الإيداع"})]})})]}),e.jsxs(st,{children:[e.jsx(wt,{children:e.jsxs(Mt,{className:"text-sm flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(dn,{className:"h-4 w-4"}),"سجل المعاملات"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(d,{size:"sm",variant:g==="week"?"default":"outline",onClick:()=>m("week"),className:"text-xs",children:"أسبوع"}),e.jsx(d,{size:"sm",variant:g==="month"?"default":"outline",onClick:()=>m("month"),className:"text-xs",children:"شهر"}),e.jsx(d,{size:"sm",variant:g==="all"?"default":"outline",onClick:()=>m("all"),className:"text-xs",children:"الكل"})]})]})}),e.jsx(nt,{children:E?e.jsx("div",{className:"flex justify-center items-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-600",children:"جاري تحميل المعاملات..."})]})}):M.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(dn,{className:"h-8 w-8 text-gray-400 mx-auto mb-2"}),e.jsx("p",{className:"text-gray-600",children:"لا توجد معاملات في هذه الفترة"})]}):e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:M.map(H=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[ce(H.type),e.jsxs("div",{children:[e.jsxs("div",{className:"text-sm font-medium",children:[V(H.type)," - ",B(H.amount)," جنيه"]}),e.jsx("div",{className:"text-xs text-gray-600",children:U(H.createdAt)}),H.description&&e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:H.description})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[J(H.status),e.jsx("span",{className:"text-xs",children:Ae(H.status)})]})]},H.id))})})]})]})]}),e.jsxs("div",{className:"flex justify-between pt-4 border-t",children:[e.jsxs(d,{onClick:x,variant:"outline",children:[e.jsx(Gl,{className:"h-4 w-4 mr-2"}),"العودة للمحافظ"]}),e.jsx(d,{onClick:o,variant:"outline",children:"إغلاق"})]})]})})},hn=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],qc=({isOpen:l,onClose:u,onWalletUpdate:o,initialEditingWallet:x})=>{const{toast:y}=hs(),{user:v}=Ps(),t=$l(),[E,T]=n.useState([]),[g,m]=n.useState(!1),[w,b]=n.useState(null),[B,U]=n.useState(""),[X,M]=n.useState(""),[I,R]=n.useState(""),[ee,$]=n.useState(""),[C,_]=n.useState("200000"),[Z,re]=n.useState("200000"),[ce,J]=n.useState("100000"),[V,Ae]=n.useState("60000"),[H,le]=n.useState(!1),[Be,Ge]=n.useState(null),[kt,Je]=n.useState(!1),[Wt,pt]=n.useState(!1),[Lt,Qe]=n.useState(!1),[at,Me]=n.useState(null),gt=()=>`wallets_${(v==null?void 0:v.uid)||"default"}`;n.useEffect(()=>{x&&(b(x),m(!0),U(x.name||""),M(x.phone||""),R(x.nationalId||""),$(x.walletProvider||""),_((x.monthlyWithdrawalLimit||2e5).toString()),re((x.monthlyTransferLimit||2e5).toString()),J((x.dailyWithdrawalLimit||1e5).toString()),Ae((x.dailyTransferLimit||6e4).toString()),le(!!x.isDefault))},[x]);const Pt=A=>{const se=new Date,pe=se.getMonth(),ke=se.getFullYear();if(!A.lastResetDate)return{...A,monthlyWithdrawalUsage:A.monthlyWithdrawalUsage||0,monthlyTransferUsage:A.monthlyTransferUsage||0,lastResetDate:se.toISOString().split("T")[0]};const Oe=new Date(A.lastResetDate),rt=Oe.getMonth(),O=Oe.getFullYear();return pe!==rt||ke!==O?{...A,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:se.toISOString().split("T")[0]}:A},At=async(A,se)=>{const pe=new Date().getMonth(),ke=new Date().getFullYear(),Oe=se.filter(te=>{const z=new Date(te.createdAt);return z.getMonth()===pe&&z.getFullYear()===ke&&te.lineId===A}),rt=Oe.filter(te=>te.txnType==="receive").reduce((te,z)=>te+(z.amount||0),0),O=Oe.filter(te=>te.txnType==="send").reduce((te,z)=>te+(z.amount||0),0);return{withdrawalUsage:rt,transferUsage:O}},Yt=async(A,se)=>{const pe=new Date,ke=pe.getDate(),Oe=pe.getMonth(),rt=pe.getFullYear(),O=se.filter(Ne=>{const Le=new Date(Ne.createdAt);return Le.getDate()===ke&&Le.getMonth()===Oe&&Le.getFullYear()===rt&&Ne.lineId===A}),te=O.filter(Ne=>Ne.txnType==="receive").reduce((Ne,Le)=>Ne+(Le.amount||0),0),z=O.filter(Ne=>Ne.txnType==="send").reduce((Ne,Le)=>Ne+(Le.amount||0),0);return{withdrawalUsage:te,transferUsage:z}};n.useEffect(()=>{(async()=>{if(!(v!=null&&v.uid)){console.log("No user authenticated, skipping wallet loading"),Je(!1);return}console.log("Loading wallets for user:",v.uid),Je(!0);try{const{auth:se}=await Is(async()=>{const{auth:z}=await import("./index-CtI5CTI7.js").then(Ne=>Ne.b0);return{auth:z}},__vite__mapDeps([0,1]));let pe=0;const ke=5;for(;!se.currentUser&&pe<ke;)console.log(`Waiting for auth state... attempt ${pe+1}`),await new Promise(z=>setTimeout(z,1e3)),pe++;if(!se.currentUser)throw console.error("User not authenticated in Firebase Auth after retries"),new Error("not authenticated");console.log("Firebase Auth User:",se.currentUser.uid),console.log("Context User:",v.uid),console.log("Fetching wallets from Firebase...");const Oe=await Ts.getByMerchantId(v.uid);console.log("Fetched wallets:",Oe),console.log("Fetching transactions from Firebase...");const rt=await gr.getByUserId(v.uid);console.log("Fetched transactions:",rt);const te=(await Promise.all(Oe.map(async z=>{const{withdrawalUsage:Ne,transferUsage:Le}=await At(z.id,rt),{withdrawalUsage:Ht,transferUsage:Dt}=await Yt(z.id,rt);return{id:z.id,name:z.label||"محفظة بدون اسم",phone:z.msisdn,isDefault:!1,monthlyWithdrawalLimit:z.withdrawLimit||2e5,monthlyTransferLimit:z.transferLimit||2e5,dailyWithdrawalLimit:z.dailyWithdrawLimit||1e5,dailyTransferLimit:z.dailyTransferLimit||6e4,monthlyWithdrawalUsage:Ne,monthlyTransferUsage:Le,dailyWithdrawalUsage:Ht,dailyTransferUsage:Dt,lastResetDate:new Date().toISOString().split("T")[0],defaultTransferCommission:z.defaultTransferCommission!=null?Number(z.defaultTransferCommission):null,defaultWithdrawCommission:z.defaultWithdrawCommission!=null?Number(z.defaultWithdrawCommission):null}}))).map(Pt);T(te),console.log("Wallets loaded successfully:",te)}catch(se){console.error("Error loading wallets:",se),console.log("تم تحميل المحافظ من البيانات المحفوظة محلياً");const pe=localStorage.getItem(gt());if(pe){const ke=JSON.parse(pe);T(ke.map(Oe=>({...Oe,phone:Oe.phone||Oe.phoneNumber,monthlyWithdrawalLimit:Oe.monthlyWithdrawalLimit||2e5,monthlyTransferLimit:Oe.monthlyTransferLimit||2e5})))}}finally{Je(!1)}})()},[v==null?void 0:v.uid]);const Ue=()=>{U(""),M(""),R(""),$(""),_("200000"),re("200000"),J("100000"),Ae("60000"),le(!1),b(null),m(!1)},ss=async()=>{if(!B.trim()||!X.trim()||!ee.trim()){y({title:"خطأ",description:"يرجى ملء جميع الحقول المطلوبة",variant:"destructive"});return}if(!(v!=null&&v.uid)){y({title:"خطأ",description:"يجب تسجيل الدخول أولاً",variant:"destructive"});return}Je(!0);try{if(w){await Ts.update(w.id,{label:B.trim(),msisdn:X.trim(),withdrawLimit:parseInt(C),transferLimit:parseInt(Z),dailyWithdrawLimit:parseInt(ce),dailyTransferLimit:parseInt(V)}),await js.setLimits(w.id,{dailyTransferLimit:parseInt(V||"0"),dailyWithdrawLimit:parseInt(ce||"0"),monthlyTransferLimit:parseInt(Z||"0"),monthlyWithdrawLimit:parseInt(C||"0")});const A=E.map(se=>se.id===w.id?{...se,name:B.trim(),phone:X.trim(),nationalId:I.trim(),walletProvider:ee,monthlyWithdrawalLimit:parseInt(C),monthlyTransferLimit:parseInt(Z),dailyWithdrawalLimit:parseInt(ce),dailyTransferLimit:parseInt(V)}:se);T(A),localStorage.setItem(gt(),JSON.stringify(A)),y({title:"تم التحديث",description:"تم تحديث المحفظة بنجاح"})}else{const A={merchantUserId:v.uid,provider:ee,msisdn:X.trim(),label:B.trim(),isActive:!0,dailyLimit:2e5,monthlyLimit:2e5,withdrawLimit:parseInt(C),transferLimit:parseInt(Z),dailyTransferLimit:parseInt(V),dailyWithdrawLimit:parseInt(ce),dailyUsage:0,monthlyUsage:0,transferUsage:0,withdrawUsage:0},se=await Ts.create(A);await js.setLimits(se,{dailyTransferLimit:parseInt(V||"0"),dailyWithdrawLimit:parseInt(ce||"0"),monthlyTransferLimit:parseInt(Z||"0"),monthlyWithdrawLimit:parseInt(C||"0")});const pe=new Date().toISOString().split("T")[0],ke={id:se,name:B.trim(),phone:X.trim(),nationalId:I.trim(),walletProvider:ee,isDefault:H,monthlyWithdrawalLimit:parseInt(C),monthlyTransferLimit:parseInt(Z),dailyWithdrawalLimit:parseInt(ce),dailyTransferLimit:parseInt(V),monthlyWithdrawalUsage:0,monthlyTransferUsage:0,dailyWithdrawalUsage:0,dailyTransferUsage:0,lastResetDate:pe,defaultTransferCommission:null,defaultWithdrawCommission:null},Oe=[...E,ke];T(Oe),localStorage.setItem(gt(),JSON.stringify(Oe)),y({title:"تم الإنشاء",description:"تم إنشاء المحفظة بنجاح"})}o&&o(),Ue(),m(!1),b(null)}catch(A){console.error("Error saving wallet:",A),y({title:"خطأ",description:"حدث خطأ أثناء حفظ المحفظة",variant:"destructive"})}finally{Je(!1)}},_t=A=>{b(A),U(A.name),M(A.phone),R(A.nationalId||""),$(A.walletProvider||""),_(A.monthlyWithdrawalLimit.toString()),re(A.monthlyTransferLimit.toString()),le(A.isDefault),m(!0)},as=async A=>{const se=E.find(pe=>pe.id===A);if(se!=null&&se.isDefault){y({title:"تحذير",description:"لا يمكن حذف المحفظة الافتراضية",variant:"destructive"});return}if(!(v!=null&&v.uid)){y({title:"خطأ",description:"يجب تسجيل الدخول أولاً",variant:"destructive"});return}Je(!0);try{await Ts.delete(A);const pe=E.filter(ke=>ke.id!==A);T(pe),localStorage.setItem(gt(),JSON.stringify(pe)),o&&o(),y({title:"تم الحذف",description:"تم حذف المحفظة بنجاح"})}catch(pe){console.error("Error deleting wallet:",pe),y({title:"خطأ",description:"حدث خطأ أثناء حذف المحفظة",variant:"destructive"})}finally{Je(!1)}},Ft=A=>{const se=E.map(pe=>({...pe,isDefault:pe.id===A}));T(se),localStorage.setItem(gt(),JSON.stringify(se)),o&&o(),y({title:"تم تحديث المحفظة الافتراضية",description:"تم تعيين المحفظة كافتراضية بنجاح"})};return e.jsxs(me,{open:l,onOpenChange:u,children:[e.jsxs(he,{className:"max-w-4xl max-h-[80vh] overflow-y-auto",children:[e.jsx(ue,{className:"pb-2",children:e.jsxs(xe,{className:"flex items-center gap-1 text-sm",children:[e.jsx(ds,{className:"h-3 w-3"}),"إدارة المحافظ"]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h3",{className:"text-sm font-semibold",children:["المحافظ المتاحة (",E.length,")"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(d,{onClick:()=>Qe(!0),className:"flex items-center gap-1 h-6 px-2 text-xs",size:"sm",variant:"outline",children:[e.jsx(Ve,{className:"h-3 w-3"}),"الاطلاع على المحافظ"]}),e.jsxs(d,{onClick:()=>{u(),t("/user/add-wallet")},className:"flex items-center gap-1 h-6 px-2 text-xs",size:"sm",children:[e.jsx(Tt,{className:"h-3 w-3"}),"إضافة محفظة جديدة"]})]})]}),(g||w)&&e.jsxs(st,{className:"border-2 border-blue-200 bg-blue-50",children:[e.jsx(wt,{className:"pb-1",children:e.jsx(Mt,{className:"text-sm",children:w?"تعديل المحفظة":"إضافة محفظة جديدة"})}),e.jsxs(nt,{className:"space-y-2 pt-1",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"شركة المحفظة"}),e.jsx("div",{className:"flex gap-1 items-center",children:e.jsxs(Bs,{value:ee,onValueChange:$,children:[e.jsx(Ms,{className:"h-6 text-xs flex-1",children:e.jsx(Ls,{placeholder:"اختر شركة المحفظة"})}),e.jsx($s,{children:hn.map(A=>e.jsx(os,{value:A.id,className:"text-xs",children:e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsx("span",{children:A.name}),e.jsx("button",{type:"button",className:"h-4 w-4 p-0 ml-2 flex items-center justify-center hover:bg-blue-100 rounded",onClick:se=>{se.preventDefault(),se.stopPropagation(),Ge(A.id)},children:e.jsx(bn,{className:"h-3 w-3 text-blue-500 hover:text-blue-700"})})]})},A.id))})]})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"اسم المحفظة"}),e.jsx(L,{value:B,onChange:A=>U(A.target.value),placeholder:"مثال: محفظة العمل",className:"h-6 text-xs"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"رقم الهاتف"}),e.jsxs("div",{className:"relative",children:[e.jsx(Ns,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(L,{value:X,onChange:A=>M(A.target.value),placeholder:"01030302038",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الرقم القومي للخط"}),e.jsxs("div",{className:"relative",children:[e.jsx(pr,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(L,{value:I,onChange:A=>R(A.target.value),placeholder:"29012345678901",maxLength:14,className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد الشهري للسحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(lt,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(L,{type:"number",value:C,onChange:A=>_(A.target.value),placeholder:"200000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد الشهري للتحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(lt,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(L,{type:"number",value:Z,onChange:A=>re(A.target.value),placeholder:"200000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد اليومي للسحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Da,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-red-400"}),e.jsx(L,{type:"number",value:ce,onChange:A=>J(A.target.value),placeholder:"100000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد اليومي للتحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(aa,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-blue-400"}),e.jsx(L,{type:"number",value:V,onChange:A=>Ae(A.target.value),placeholder:"60000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",id:"isDefault",checked:H,onChange:A=>le(A.target.checked),className:"rounded w-3 h-3"}),e.jsx("label",{htmlFor:"isDefault",className:"text-xs font-medium text-gray-700",children:"تعيين كمحفظة افتراضية"})]}),e.jsx("div",{className:"border-t pt-2 mt-2",children:e.jsxs("div",{className:"flex items-center gap-1 mb-2",children:[e.jsx(Rl,{className:"h-3 w-3 text-gray-600"}),e.jsx("label",{className:"text-xs font-medium text-gray-700",children:"إعدادات العمولة"})]})}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(d,{onClick:ss,className:"flex-1 h-6 text-xs",size:"sm",children:w?"تحديث المحفظة":"إضافة المحفظة"}),e.jsx(d,{variant:"outline",onClick:Ue,className:"h-6 text-xs",size:"sm",children:"إلغاء"})]})]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2",children:E.map(A=>{var se;return e.jsxs(st,{className:`${A.isDefault?"border-green-300 bg-green-50":""}`,children:[e.jsx(wt,{className:"pb-1",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Mt,{className:"text-sm flex items-center gap-1",children:[e.jsx(ds,{className:"h-3 w-3"}),A.name]}),A.isDefault&&e.jsx(jt,{variant:"default",className:"bg-green-600 text-xs px-1 py-0",children:"افتراضية"})]})}),e.jsxs(nt,{className:"space-y-1 pt-0",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Ns,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"text-xs",children:A.phone})]}),A.walletProvider&&e.jsx("div",{className:"text-xs text-blue-600 mt-1",children:((se=hn.find(pe=>pe.id===A.walletProvider))==null?void 0:se.name)||A.walletProvider}),e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-2 rounded-md border border-gray-200 shadow-sm space-y-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-gray-600 mb-1",children:"الحدود الشهرية"}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-red-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-red-400 to-red-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((A.monthlyWithdrawalUsage||0)/A.monthlyWithdrawalLimit*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-blue-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-400 to-blue-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((A.monthlyTransferUsage||0)/A.monthlyTransferLimit*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-xs text-red-600 font-medium",children:["متبقي سحب: ",Math.max(A.monthlyWithdrawalLimit-(A.monthlyWithdrawalUsage||0),0)," جنيه"]}),e.jsxs("div",{className:"text-xs text-blue-600 font-medium",children:["متبقي تحويل: ",Math.max(A.monthlyTransferLimit-(A.monthlyTransferUsage||0),0)," جنيه"]})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-gray-600 mb-1",children:"الحدود اليومية"}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-orange-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-orange-400 to-orange-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((A.dailyWithdrawalUsage||0)/A.dailyWithdrawalLimit*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-green-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-green-400 to-green-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((A.dailyTransferUsage||0)/A.dailyTransferLimit*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-xs text-orange-600 font-medium",children:["متبقي سحب يومي: ",Math.max(A.dailyWithdrawalLimit-(A.dailyWithdrawalUsage||0),0)," جنيه"]}),e.jsxs("div",{className:"text-xs text-green-600 font-medium",children:["متبقي تحويل يومي: ",Math.max(A.dailyTransferLimit-(A.dailyTransferUsage||0),0)," جنيه"]})]})]})]}),e.jsxs("div",{className:"flex gap-1 pt-1",children:[e.jsxs(d,{size:"sm",variant:"outline",onClick:()=>_t(A),className:"flex-1 h-5 text-xs px-1",children:[e.jsx(Hl,{className:"h-2 w-2 mr-0.5"}),"تعديل"]}),!A.isDefault&&e.jsxs(e.Fragment,{children:[e.jsx(d,{size:"sm",variant:"outline",onClick:()=>Ft(A.id),className:"flex-1 h-5 text-xs px-1",children:"جعلها افتراضية"}),e.jsx(d,{size:"sm",variant:"destructive",onClick:()=>as(A.id),className:"h-5 px-1",children:e.jsx(Ut,{className:"h-2 w-2"})})]})]})]})]},A.id)})}),E.length===0&&e.jsx("div",{className:"text-center py-4 text-gray-500 text-xs",children:"لا توجد محافظ متاحة. قم بإضافة محفظة جديدة للبدء."})]}),Be&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-800",children:"معلومات صاحب المحفظة"}),e.jsx("button",{onClick:()=>Ge(null),className:"h-8 w-8 p-0 flex items-center justify-center hover:bg-gray-100 rounded-full transition-colors",children:e.jsx(Ul,{className:"h-4 w-4 text-gray-500"})})]}),(()=>{const A=hn.find(se=>se.id===Be);return A?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-center mb-6",children:e.jsx("div",{className:"bg-blue-100 p-3 rounded-lg inline-block",children:e.jsx("h4",{className:"font-bold text-blue-700 text-lg",children:A.name})})}),e.jsx("div",{className:"bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-200",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-white p-3 rounded-lg shadow-sm",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full mr-2"}),e.jsx("span",{className:"font-semibold text-gray-700",children:"اسم صاحب المحفظة:"})]}),e.jsx("p",{className:"text-gray-900 font-medium text-lg mr-4",children:A.ownerName})]}),e.jsxs("div",{className:"bg-white p-3 rounded-lg shadow-sm",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full mr-2"}),e.jsx("span",{className:"font-semibold text-gray-700",children:"الرقم القومي:"})]}),e.jsx("p",{className:"text-gray-900 font-mono text-lg mr-4 tracking-wider",children:A.nationalId})]})]})}),e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 p-3 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(bn,{className:"h-4 w-4 text-yellow-600 mr-2"}),e.jsx("span",{className:"text-sm text-yellow-800 font-medium",children:"هذه البيانات مسجلة رسمياً في النظام لهذه المحفظة"})]})})]}):null})()]})})]}),e.jsx(es,{open:Lt,onOpenChange:Qe,mode:"verify",title:"إدخال الرقم السري الرئيسي",description:"لا يمكن الاطلاع على المحافظ إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{Qe(!1),pt(!0)}}),e.jsx(zc,{isOpen:Wt,onClose:()=>pt(!1),onWalletSelect:A=>{Me(A),pt(!1)},onEditWallet:A=>{t(`/user/add-wallet?edit=1&id=${A.id}`),pt(!1)},onDeleteWallet:async A=>{try{if(await Ts.delete(A),T(se=>{const pe=se.filter(ke=>ke.id!==A);try{localStorage.setItem(gt(),JSON.stringify(pe))}catch(ke){console.error("Failed to update localStorage wallets after delete:",ke)}return pe}),o)try{await o()}catch(se){console.error("onWalletUpdate callback failed:",se)}}catch(se){console.error("Error deleting wallet:",se)}}}),e.jsx(Kc,{wallet:at,isOpen:!!at,onClose:()=>Me(null),onBack:()=>{Me(null),pt(!0)}})]})},Vc=({isOpen:l,onClose:u,transaction:o,onDelete:x})=>{if(!o)return null;const y=g=>{switch(g){case"completed":return e.jsx(ur,{className:"h-5 w-5 text-green-500"});case"pending":return e.jsx(zs,{className:"h-5 w-5 text-yellow-500"});case"failed":return e.jsx(wn,{className:"h-5 w-5 text-red-500"});default:return e.jsx(zs,{className:"h-5 w-5 text-gray-500"})}},v=g=>{switch(g){case"completed":return"مكتملة";case"pending":return"قيد الانتظار";case"failed":return"فاشلة";default:return"غير معروف"}},t=g=>{switch(g){case"withdraw":return"سحب";case"send":return"إرسال";case"receive":return"استقبال";default:return"تحويل"}},E=()=>{const g=!!o.senderNumber,m=!!o.senderName,w=g?"الرقم المرسل:":m?"الرقم الراسل:":"رقم المحفظة:",b=g?o.senderNumber:m?o.senderName:o.senderPhone,B=`
      <div style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 500px; margin: 0 auto; padding: 30px; background: #fff;">
        <!-- Header -->
        <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #2563eb; padding-bottom: 20px;">
          <h1 style="color: #2563eb; margin-bottom: 5px; font-size: 28px;">إيصال المعاملة</h1>
          <p style="color: #666; font-size: 16px; margin: 0;">رقم المرجع: ${o.transactionReference||o.id}</p>
          <p style="color: #888; font-size: 14px; margin: 5px 0 0 0;">${new Date().toLocaleString("ar-EG")}</p>
        </div>
        
        <!-- Shop Info -->
        <div style="background: #f8fafc; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
          <h3 style="color: #1e293b; margin: 0 0 15px 0; font-size: 18px;">معلومات المحل</h3>
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span style="font-weight: 600; color: #475569;">اسم المحل:</span>
            <span style="color: #1e293b;">${o.merchantShopName||o.shopName||"غير محدد"}</span>
          </div>
        </div>
        
        <!-- Transaction Details -->
        <div style="background: #fff; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
          <h3 style="color: #1e293b; margin: 0 0 15px 0; font-size: 18px;">تفاصيل المعاملة</h3>
          
          <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
            <span style="font-weight: 600; color: #475569;">نوع المعاملة:</span>
            <span style="color: #2563eb; font-weight: 600;">${t(o.type)}</span>
          </div>
          
          <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
            <span style="font-weight: 600; color: #475569;">الحالة:</span>
            <span style="color: ${o.status==="completed"?"#16a34a":o.status==="pending"?"#ca8a04":"#dc2626"}; font-weight: 600;">
              ${v(o.status)}
            </span>
          </div>

          ${o!=null&&o.cashierName?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الكاشير:</span>
              <span style="color: #1e293b;">${o.cashierName}</span>
            </div>
          `:""}
          
          ${o.type!=="withdraw"?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">${w}</span>
              <span style="color: #1e293b;">${b}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الرقم المستقبل:</span>
              <span style="color: #1e293b;">${o.receiverNumber||o.receiverPhone}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">المبلغ المحول:</span>
              <span style="color: #2563eb; font-weight: bold; font-size: 16px;">${o.transferredAmount||o.amount} جنيه</span>
            </div>
          `:`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">رقم المحفظة:</span>
              <span style="color: #1e293b;">${o.senderPhone}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">المبلغ المسحوب:</span>
              <span style="color: #dc2626; font-weight: bold; font-size: 16px;">${o.withdrawnAmountDetailed||o.withdrawnAmount||o.amount} جنيه</span>
            </div>
          `}
          
          ${o.commission?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">العمولة:</span>
              <span style="color: #f59e0b; font-weight: 600;">${o.commission} جنيه</span>
            </div>
          `:""}
          ${o!=null&&o.fee&&Number(o.fee)>0?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الرسوم:</span>
              <span style="color: #64748b; font-weight: 600;">${o.fee} جنيه</span>
            </div>
          `:""}
          
          <div style="display: flex; justify-content: space-between; padding: 8px 0;">
            <span style="font-weight: 600; color: #475569;">التاريخ والوقت:</span>
            <span style="color: #1e293b;">${o.createdAt.toLocaleString("ar-EG")}</span>
          </div>
        </div>
        
        <!-- Total Amount -->
        <div style="background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); border-radius: 12px; padding: 20px; margin-bottom: 20px; text-align: center;">
          <h3 style="color: white; margin: 0 0 10px 0; font-size: 16px;">إجمالي المبلغ</h3>
          <p style="color: white; font-size: 24px; font-weight: bold; margin: 0;">
            ${o.type==="withdraw"?"-":""}${o.amount} جنيه
          </p>
        </div>
        
        
        
        
        <!-- Footer -->
        <div style="text-align: center; color: #64748b; font-size: 12px; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
          <p style="margin: 0 0 5px 0;">شكراً لاستخدام خدماتنا</p>
          <p style="margin: 0;">تم إنشاء الإيصال في: ${new Date().toLocaleString("ar-EG")}</p>
        </div>
      </div>
    `,U=window.open("","_blank");U&&(U.document.write(`
        <html>
          <head>
            <title>إيصال المعاملة - ${o.transactionReference||o.id}</title>
            <meta charset="UTF-8">
            <style>
              body { 
                margin: 0; 
                padding: 20px; 
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: #f8fafc;
              }
              @media print {
                body { 
                  margin: 0; 
                  background: white;
                }
              }
            </style>
          </head>
          <body>
            ${B}
          </body>
        </html>
      `),U.document.close(),U.print())},T=()=>{window.confirm("هل أنت متأكد من حذف هذه المعاملة؟ لا يمكن التراجع عن هذا الإجراء.")&&(x(o.id),u())};return e.jsx(me,{open:l,onOpenChange:u,children:e.jsxs(he,{className:"w-[92vw] sm:w-auto sm:max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx(ue,{children:e.jsxs(xe,{className:"flex items-center gap-2 text-xl",children:[e.jsx(mr,{className:"h-6 w-6 text-blue-600"}),"إيصال المعاملة المفصل"]})}),e.jsxs("div",{className:"space-y-6",children:[e.jsx(st,{className:"bg-gradient-to-r from-blue-50 to-indigo-50 border-blue-200",children:e.jsxs(wt,{className:"text-center pb-2",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 mb-2",children:[y(o.status),e.jsx(jt,{variant:o.status==="completed"?"default":"secondary",className:"text-sm",children:v(o.status)})]}),e.jsxs("h3",{className:"text-2xl font-bold text-blue-600",children:[o.type==="withdraw"?"-":"",o.amount," جنيه"]}),e.jsxs("p",{className:"text-sm text-gray-600",children:["رقم المرجع: ",o.transactionReference||o.id]})]})}),e.jsxs(st,{children:[e.jsx(wt,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Sc,{className:"h-5 w-5 text-green-600"}),e.jsx("h4",{className:"font-semibold text-lg",children:"معلومات المحل"})]})}),e.jsxs(nt,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"اسم المحل:"}),e.jsx("span",{className:"text-gray-900",children:o.merchantShopName||o.shopName||"غير محدد"})]}),(o==null?void 0:o.cashierName)&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"الكاشير:"}),e.jsx("span",{className:"text-gray-900",children:o.cashierName})]})]})]}),e.jsxs(st,{children:[e.jsx(wt,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ia,{className:"h-5 w-5 text-blue-600"}),e.jsx("h4",{className:"font-semibold text-lg",children:"تفاصيل المعاملة"})]})}),e.jsx(nt,{className:"space-y-3",children:e.jsxs("div",{className:"grid grid-cols-1 gap-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-blue-700",children:"نوع المعاملة:"}),e.jsx(jt,{variant:"outline",className:"bg-blue-100 text-blue-800",children:t(o.type)})]}),o.type!=="withdraw"?e.jsxs(e.Fragment,{children:[(()=>{const g=!!o.senderNumber,m=!!o.senderName,w=g?"الرقم المرسل:":m?"الرقم الراسل:":"رقم المحفظة:",b=g?o.senderNumber:m?o.senderName:o.senderPhone,B=g?vn:Ns;return e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(B,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:w})]}),e.jsx("span",{className:"text-gray-900 font-mono",children:b})]})})(),e.jsx("div",{className:"flex items-center justify-center p-2",children:e.jsx(Dc,{className:"h-6 w-6 text-blue-500"})}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-green-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(vn,{className:"h-4 w-4 text-green-500"}),e.jsx("span",{className:"font-medium text-green-700",children:"الرقم المستقبل:"})]}),e.jsx("span",{className:"text-green-900 font-mono",children:o.receiverNumber||o.receiverPhone})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(lt,{className:"h-4 w-4 text-blue-500"}),e.jsx("span",{className:"font-medium text-blue-700",children:"المبلغ المحول:"})]}),e.jsxs("span",{className:"text-blue-900 font-bold text-lg",children:[o.transferredAmount||o.amount," جنيه"]})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ns,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:"رقم المحفظة:"})]}),e.jsx("span",{className:"text-gray-900 font-mono",children:o.senderPhone})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-red-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(lt,{className:"h-4 w-4 text-red-500"}),e.jsx("span",{className:"font-medium text-red-700",children:"المبلغ المسحوب:"})]}),e.jsxs("span",{className:"text-red-900 font-bold text-lg",children:[o.withdrawnAmountDetailed||o.withdrawnAmount||o.amount," جنيه"]})]})]}),o.commission&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-yellow-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-yellow-700",children:"العمولة:"}),e.jsxs("span",{className:"text-yellow-900 font-semibold",children:[o.commission," جنيه"]})]}),(o==null?void 0:o.fee)&&Number(o.fee)>0&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"الرسوم:"}),e.jsxs("span",{className:"text-gray-900 font-semibold",children:[o.fee," جنيه"]})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ks,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:"التاريخ والوقت:"})]}),e.jsx("span",{className:"text-gray-900",children:o.createdAt.toLocaleString("ar-EG")})]})]})})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs(d,{onClick:E,className:"flex-1 bg-blue-600 hover:bg-blue-700 text-white",size:"lg",children:[e.jsx(Cc,{className:"h-5 w-5 mr-2"}),"طباعة الإيصال"]}),e.jsxs(d,{onClick:T,variant:"destructive",className:"flex-1",size:"lg",children:[e.jsx(Ut,{className:"h-5 w-5 mr-2"}),"حذف المعاملة"]})]}),e.jsx(d,{onClick:u,variant:"outline",className:"w-full",size:"lg",children:"إغلاق الإيصال"})]})]})})};function Wl({open:l,onOpenChange:u,onSuccess:o,title:x,description:y,currentBalance:v,balanceLabel:t,userId:E}){const[T,g]=n.useState(""),[m,w]=n.useState(v.toString()),[b,B]=n.useState(!1),[U,X]=n.useState(""),[M,I]=n.useState(!1),R=Vt.hasMasterPin(),ee=async C=>{C.preventDefault(),X(""),I(!0);try{const _=parseFloat(m);if(isNaN(_)||_<0){X("يرجى إدخال مبلغ صحيح"),I(!1);return}R?Vt.verifyMasterPin(T)?(o(_),u(!1),g(""),w("")):X("الرقم السري غير صحيح"):X("لم يتم تعيين رقم سري رئيسي. يرجى تعيين رقم سري رئيسي أولاً من إعدادات التطبيق")}catch{X("حدث خطأ أثناء التحقق من الرقم السري")}finally{I(!1)}},$=()=>{g(""),w(v.toString()),X(""),u(!1)};return tt.useEffect(()=>{l&&w(v.toString())},[v,l]),e.jsx(me,{open:l,onOpenChange:$,children:e.jsxs(he,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ue,{children:e.jsxs(xe,{className:"flex items-center gap-2 text-right",children:[e.jsx(lt,{className:"h-5 w-5"}),x]})}),e.jsxs("form",{onSubmit:ee,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:y}),e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg",children:[e.jsxs(q,{className:"text-sm font-medium text-gray-700",children:[t," الحالي"]}),e.jsxs("div",{className:"text-lg font-bold text-gray-900 mt-1",children:[v.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"newAmount",className:"text-right",children:"المبلغ الجديد"}),e.jsx(L,{id:"newAmount",type:"number",step:"0.01",min:"0",value:m,onChange:C=>w(C.target.value),placeholder:"أدخل المبلغ الجديد",className:"text-right",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"pin",className:"text-right",children:"الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(L,{id:"pin",type:b?"text":"password",value:T,onChange:C=>g(C.target.value),placeholder:"أدخل الرقم السري",className:"text-right pr-10",required:!0}),e.jsx(d,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>B(!b),children:b?e.jsx(St,{className:"h-4 w-4"}):e.jsx(Ve,{className:"h-4 w-4"})})]})]}),U&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-red-600 bg-red-50 p-2 rounded",children:[e.jsx(qs,{className:"h-4 w-4"}),U]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(d,{type:"button",variant:"outline",onClick:$,className:"flex-1",children:"إلغاء"}),e.jsx(d,{type:"submit",disabled:M||!T||!m,className:"flex-1",children:M?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"جاري التحديث..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Js,{className:"h-4 w-4 mr-2"}),"تحديث الرصيد"]})})]})]})]})})}class Ca{static getSecretKey(u){return u?`${this.SECRET_KEY_BASE}_${u}`:this.SECRET_KEY_BASE}static setSecretPin(u,o){const x=btoa(u);this.secretCache.set(this.getSecretKey(o),x)}static hasSecretPin(u){return this.secretCache.has(this.getSecretKey(u))}static verifySecretPin(u,o){const x=this.secretCache.get(this.getSecretKey(o));if(!x)return!1;try{return atob(x)===u}catch{return!1}}static clearSecretPin(u){this.secretCache.delete(this.getSecretKey(u))}}cn(Ca,"SECRET_KEY_BASE","dashboard_secret_pin"),cn(Ca,"secretCache",new Map);function Yc({open:l,onOpenChange:u,userId:o}){const[x,y]=n.useState(""),[v,t]=n.useState(""),[E,T]=n.useState(""),[g,m]=n.useState(!1),[w,b]=n.useState(!1),[B,U]=n.useState(!1),[X,M]=n.useState(""),[I,R]=n.useState(!1),{toast:ee}=hs(),$=Ca.hasSecretPin(o),C=async Z=>{Z.preventDefault(),M(""),R(!0);try{if(!v||v.length<4){M("يجب أن يكون الرقم السري 4 أرقام على الأقل"),R(!1);return}if(v!==E){M("الرقم السري الجديد وتأكيده غير متطابقين"),R(!1);return}if($){if(!x){M("يرجى إدخال الرقم السري الحالي"),R(!1);return}if(!Ca.verifySecretPin(x,o)){M("الرقم السري الحالي غير صحيح"),R(!1);return}}Ca.setSecretPin(v,o),ee({title:$?"تم تغيير الرقم السري":"تم تعيين الرقم السري",description:$?"تم تغيير الرقم السري بنجاح":"تم تعيين الرقم السري بنجاح"}),_()}catch{M("حدث خطأ أثناء حفظ الرقم السري")}finally{R(!1)}},_=()=>{y(""),t(""),T(""),M(""),m(!1),b(!1),U(!1),u(!1)};return e.jsx(me,{open:l,onOpenChange:_,children:e.jsxs(he,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ue,{children:e.jsxs(xe,{className:"flex items-center gap-2 text-right",children:[e.jsx(Rl,{className:"h-5 w-5"}),$?"تغيير الرقم السري":"تعيين الرقم السري"]})}),e.jsxs("form",{onSubmit:C,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:$?"أدخل الرقم السري الحالي والرقم السري الجديد لتغييره":"أدخل الرقم السري الجديد الذي تريد استخدامه في عمليات التعديل"}),$&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي"}),e.jsxs("div",{className:"relative",children:[e.jsx(L,{id:"currentPin",type:g?"text":"password",autoComplete:"off",value:x,onChange:Z=>y(Z.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(d,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>m(!g),children:g?e.jsx(St,{className:"h-4 w-4"}):e.jsx(Ve,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(L,{id:"newPin",type:w?"text":"password",autoComplete:"off",value:v,onChange:Z=>t(Z.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(d,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>b(!w),children:w?e.jsx(St,{className:"h-4 w-4"}):e.jsx(Ve,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(L,{id:"confirmPin",type:B?"text":"password",autoComplete:"off",value:E,onChange:Z=>T(Z.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(d,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>U(!B),children:B?e.jsx(St,{className:"h-4 w-4"}):e.jsx(Ve,{className:"h-4 w-4"})})]})]}),X&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(qs,{className:"h-4 w-4"}),X]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(d,{type:"submit",disabled:I,className:"flex-1",children:[e.jsx(Js,{className:"h-4 w-4 mr-2"}),I?"جاري الحفظ...":$?"تغيير الرقم السري":"تعيين الرقم السري"]}),e.jsx(d,{type:"button",variant:"outline",onClick:_,disabled:I,children:"إلغاء"})]})]})]})})}const un=new Map;function Hc({open:l,onOpenChange:u,userId:o}){const[x,y]=n.useState(""),[v,t]=n.useState(""),[E,T]=n.useState(""),[g,m]=n.useState(!1),[w,b]=n.useState(!1),[B,U]=n.useState(!1),[X,M]=n.useState(""),[I,R]=n.useState(!1),{toast:ee}=hs(),$=o?`cash_drawer_pin_${o}`:"cash_drawer_pin",C=()=>un.has($),_=J=>{const V=un.get($);if(!V)return!1;try{return atob(V)===J}catch{return!1}},Z=J=>{const V=btoa(J);un.set($,V)},re=async J=>{J.preventDefault(),M(""),R(!0);try{if(!v||v.length<4){M("يجب أن يكون الرقم السري 4 أرقام على الأقل"),R(!1);return}if(v!==E){M("الرقم السري الجديد وتأكيده غير متطابقين"),R(!1);return}if(C()){if(!x){M("يرجى إدخال الرقم السري الحالي لدرج النقدية"),R(!1);return}if(!_(x)){M("الرقم السري الحالي لدرج النقدية غير صحيح"),R(!1);return}}Z(v),ee({title:C()?"تم تغيير رقم درج النقدية":"تم تعيين رقم درج النقدية",description:C()?"تم تغيير الرقم السري لدرج النقدية بنجاح":"تم تعيين الرقم السري لدرج النقدية بنجاح"}),ce()}catch{M("حدث خطأ أثناء حفظ الرقم السري لدرج النقدية")}finally{R(!1)}},ce=()=>{y(""),t(""),T(""),M(""),m(!1),b(!1),U(!1),u(!1)};return e.jsx(me,{open:l,onOpenChange:ce,children:e.jsxs(he,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ue,{children:e.jsxs(xe,{className:"flex items-center gap-2 text-right",children:[e.jsx(lt,{className:"h-5 w-5 text-green-600"}),C()?"تغيير رقم درج النقدية":"تعيين رقم درج النقدية"]})}),e.jsxs("form",{onSubmit:re,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:C()?"أدخل الرقم السري الحالي والرقم السري الجديد لدرج النقدية":"أدخل الرقم السري الجديد الذي تريد استخدامه لحماية درج النقدية"}),C()&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي لدرج النقدية"}),e.jsxs("div",{className:"relative",children:[e.jsx(L,{id:"currentPin",type:g?"text":"password",autoComplete:"off",value:x,onChange:J=>y(J.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(d,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>m(!g),children:g?e.jsx(St,{className:"h-4 w-4"}):e.jsx(Ve,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد لدرج النقدية"}),e.jsxs("div",{className:"relative",children:[e.jsx(L,{id:"newPin",type:w?"text":"password",autoComplete:"off",value:v,onChange:J=>t(J.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(d,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>b(!w),children:w?e.jsx(St,{className:"h-4 w-4"}):e.jsx(Ve,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(L,{id:"confirmPin",type:B?"text":"password",autoComplete:"off",value:E,onChange:J=>T(J.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(d,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>U(!B),children:B?e.jsx(St,{className:"h-4 w-4"}):e.jsx(Ve,{className:"h-4 w-4"})})]})]}),X&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(qs,{className:"h-4 w-4"}),X]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(d,{type:"submit",disabled:I,className:"flex-1 bg-green-600 hover:bg-green-700",children:[e.jsx(Js,{className:"h-4 w-4 mr-2"}),I?"جاري الحفظ...":C()?"تغيير رقم درج النقدية":"تعيين رقم درج النقدية"]}),e.jsx(d,{type:"button",variant:"outline",onClick:ce,disabled:I,children:"إلغاء"})]})]}),e.jsx("div",{className:"text-xs text-gray-500 text-center mt-2",children:"💰 هذا الرقم السري خاص بحماية درج النقدية فقط"})]})})}const xn=new Map;function Gc({open:l,onOpenChange:u,userId:o}){const[x,y]=n.useState(""),[v,t]=n.useState(""),[E,T]=n.useState(""),[g,m]=n.useState(!1),[w,b]=n.useState(!1),[B,U]=n.useState(!1),[X,M]=n.useState(""),[I,R]=n.useState(!1),{toast:ee}=hs(),$=o?`wallet_total_pin_${o}`:"wallet_total_pin",C=()=>xn.has($),_=J=>{const V=xn.get($);if(!V)return!1;try{return atob(V)===J}catch{return!1}},Z=J=>{const V=btoa(J);xn.set($,V)},re=async J=>{J.preventDefault(),M(""),R(!0);try{if(!v||v.length<4){M("يجب أن يكون الرقم السري 4 أرقام على الأقل"),R(!1);return}if(v!==E){M("الرقم السري الجديد وتأكيده غير متطابقين"),R(!1);return}if(C()){if(!x){M("يرجى إدخال الرقم السري الحالي لإجمالي المحفظة"),R(!1);return}if(!_(x)){M("الرقم السري الحالي لإجمالي المحفظة غير صحيح"),R(!1);return}}Z(v),ee({title:C()?"تم تغيير رقم إجمالي المحفظة":"تم تعيين رقم إجمالي المحفظة",description:C()?"تم تغيير الرقم السري لإجمالي المحفظة بنجاح":"تم تعيين الرقم السري لإجمالي المحفظة بنجاح"}),ce()}catch{M("حدث خطأ أثناء حفظ الرقم السري لإجمالي المحفظة")}finally{R(!1)}},ce=()=>{y(""),t(""),T(""),M(""),m(!1),b(!1),U(!1),u(!1)};return e.jsx(me,{open:l,onOpenChange:ce,children:e.jsxs(he,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ue,{children:e.jsxs(xe,{className:"flex items-center gap-2 text-right",children:[e.jsx(ds,{className:"h-5 w-5 text-blue-600"}),C()?"تغيير رقم إجمالي المحفظة":"تعيين رقم إجمالي المحفظة"]})}),e.jsxs("form",{onSubmit:re,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:C()?"أدخل الرقم السري الحالي والرقم السري الجديد لإجمالي المحفظة":"أدخل الرقم السري الجديد الذي تريد استخدامه لحماية إجمالي المحفظة"}),C()&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي لإجمالي المحفظة"}),e.jsxs("div",{className:"relative",children:[e.jsx(L,{id:"currentPin",type:g?"text":"password",autoComplete:"off",value:x,onChange:J=>y(J.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(d,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>m(!g),children:g?e.jsx(St,{className:"h-4 w-4"}):e.jsx(Ve,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد لإجمالي المحفظة"}),e.jsxs("div",{className:"relative",children:[e.jsx(L,{id:"newPin",type:w?"text":"password",autoComplete:"off",value:v,onChange:J=>t(J.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(d,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>b(!w),children:w?e.jsx(St,{className:"h-4 w-4"}):e.jsx(Ve,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(L,{id:"confirmPin",type:B?"text":"password",autoComplete:"off",value:E,onChange:J=>T(J.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(d,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>U(!B),children:B?e.jsx(St,{className:"h-4 w-4"}):e.jsx(Ve,{className:"h-4 w-4"})})]})]}),X&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(qs,{className:"h-4 w-4"}),X]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(d,{type:"submit",disabled:I,className:"flex-1 bg-blue-600 hover:bg-blue-700",children:[e.jsx(Js,{className:"h-4 w-4 mr-2"}),I?"جاري الحفظ...":C()?"تغيير رقم إجمالي المحفظة":"تعيين رقم إجمالي المحفظة"]}),e.jsx(d,{type:"button",variant:"outline",onClick:ce,disabled:I,children:"إلغاء"})]})]}),e.jsx("div",{className:"text-xs text-gray-500 text-center mt-2",children:"💼 هذا الرقم السري خاص بحماية إجمالي المحفظة فقط"})]})})}function Qc({open:l,onOpenChange:u,onSuccess:o,title:x,description:y,currentBalance:v,balanceLabel:t,userId:E}){const[T,g]=n.useState(""),[m,w]=n.useState(""),[b,B]=n.useState("add"),[U,X]=n.useState(!1),[M,I]=n.useState(""),[R,ee]=n.useState(!1),$=Vt.hasMasterPin(),C=async re=>{re.preventDefault(),I(""),ee(!0);try{const ce=parseFloat(m);if(isNaN(ce)||ce<=0){I("يرجى إدخال مبلغ صحيح أكبر من صفر"),ee(!1);return}if(b==="subtract"&&ce>v){I("لا يمكن خصم مبلغ أكبر من الرصيد الحالي"),ee(!1);return}if($)if(Vt.verifyMasterPin(T)){const J=b==="add"?ce:-ce;_(),o(J)}else I("الرقم السري غير صحيح");else I("لم يتم تعيين رقم سري رئيسي. يرجى تعيين رقم سري رئيسي أولاً من إعدادات التطبيق")}catch{I("حدث خطأ أثناء التحقق من الرقم السري")}finally{ee(!1)}},_=()=>{g(""),w(""),B("add"),I(""),u(!1)},Z=()=>{const re=parseFloat(m)||0;return b==="add"?v+re:v-re};return e.jsx(me,{open:l,onOpenChange:_,children:e.jsxs(he,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ue,{children:e.jsxs(xe,{className:"flex items-center gap-2 text-right",children:[b==="add"?e.jsx(Tt,{className:"h-5 w-5 text-green-600"}):e.jsx(_s,{className:"h-5 w-5 text-red-600"}),x]})}),e.jsxs("form",{onSubmit:C,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:y}),e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg",children:[e.jsxs(q,{className:"text-sm font-medium text-gray-700",children:[t," الحالي"]}),e.jsxs("div",{className:"text-lg font-bold text-gray-900 mt-1",children:[v.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{className:"text-right",children:"نوع العملية"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(d,{type:"button",variant:b==="add"?"default":"outline",onClick:()=>B("add"),className:"flex-1 flex items-center gap-2",children:[e.jsx(Tt,{className:"h-4 w-4"}),"إضافة"]}),e.jsxs(d,{type:"button",variant:b==="subtract"?"default":"outline",onClick:()=>B("subtract"),className:"flex-1 flex items-center gap-2",children:[e.jsx(_s,{className:"h-4 w-4"}),"خصم"]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(q,{htmlFor:"amount",className:"text-right",children:["المبلغ المراد ",b==="add"?"إضافته":"خصمه"]}),e.jsx(L,{id:"amount",type:"number",step:"0.01",min:"0.01",value:m,onChange:re=>w(re.target.value),placeholder:`أدخل المبلغ المراد ${b==="add"?"إضافته":"خصمه"}`,className:"text-right",required:!0})]}),m&&!isNaN(parseFloat(m))&&e.jsxs("div",{className:`p-3 rounded-lg ${b==="add"?"bg-green-50 border border-green-200":"bg-red-50 border border-red-200"}`,children:[e.jsx(q,{className:"text-sm font-medium text-gray-700",children:"الرصيد الجديد المتوقع"}),e.jsxs("div",{className:`text-lg font-bold mt-1 ${b==="add"?"text-green-700":"text-red-700"}`,children:[Z().toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"pin",className:"text-right",children:"الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(L,{id:"pin",type:U?"text":"password",autoComplete:"off",value:T,onChange:re=>g(re.target.value),placeholder:"أدخل الرقم السري",className:"text-right pr-10",required:!0}),e.jsx(d,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>X(!U),children:U?e.jsx(St,{className:"h-4 w-4"}):e.jsx(Ve,{className:"h-4 w-4"})})]})]}),M&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-red-600 bg-red-50 p-2 rounded",children:[e.jsx(qs,{className:"h-4 w-4"}),M]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(d,{type:"button",variant:"outline",onClick:_,className:"flex-1",children:"إلغاء"}),e.jsx(d,{type:"submit",disabled:R||!T||!m,className:`flex-1 ${b==="add"?"bg-green-600 hover:bg-green-700":"bg-red-600 hover:bg-red-700"}`,children:R?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"جاري التحديث..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Js,{className:"h-4 w-4 mr-2"}),b==="add"?"إضافة المبلغ":"خصم المبلغ"]})})]})]})]})})}const Fl=({isOpen:l,onClose:u,onTrialStarted:o})=>{const{user:x}=Ps(),[y,v]=n.useState(!1),[t,E]=n.useState(!1),[T,g]=n.useState(""),[m,w]=n.useState(24);n.useEffect(()=>{const U=async()=>{if(x!=null&&x.uid){const M=await Sa.getTrialData(x.uid);E(M.hasUsedFreeTrial)}},X=async()=>{try{const M=await Sa.getTrialDurationHours();w(M)}catch{}};l&&(U(),X())},[l,x]);const b=async()=>{if(x!=null&&x.uid){v(!0);try{const U=await Sa.startFreeTrial(x.uid);U.success?(g(U.message),window.location.href="/user/dashboard"):g(U.message||"تعذر تفعيل التجربة المجانية")}catch{g("حدث خطأ أثناء تفعيل التجربة المجانية")}finally{v(!1)}}},B=async()=>{if(x!=null&&x.uid){v(!0);try{await sc(x.uid,ys.ZERO,x.uid),window.location.href="/user/dashboard"}catch{g("حدث خطأ أثناء تفعيل باقة الزيرو")}finally{v(!1)}}};return e.jsxs(e.Fragment,{children:[l&&e.jsx("div",{className:"fixed inset-0 z-40",style:{background:"rgba(0, 0, 0, 0.15)",backdropFilter:"blur(3px)",WebkitBackdropFilter:"blur(3px)",pointerEvents:"auto"}}),e.jsx(me,{open:l,onOpenChange:()=>{},children:e.jsxs(he,{className:"sm:max-w-lg z-50 border-0 shadow-2xl",style:{position:"fixed",top:"50%",left:"50%",transform:"translate(-50%, -50%)",pointerEvents:"auto",background:"linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 0.95) 100%)",backdropFilter:"blur(10px)",WebkitBackdropFilter:"blur(10px)",borderRadius:"20px",border:"1px solid rgba(255, 255, 255, 0.3)"},children:[e.jsxs(ue,{className:"text-center pb-0 pt-0",children:[e.jsx("div",{className:"flex justify-center mb-1",children:e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-0 rounded-full",style:{background:"linear-gradient(135deg, #f59e0b, #d97706)",filter:"blur(8px)",opacity:.3}}),e.jsx("div",{className:"relative bg-gradient-to-br from-orange-400 to-orange-600 p-2 rounded-full",children:e.jsx(mn,{className:"h-12 w-12 text-white"})})]})}),e.jsx(xe,{className:"text-2xl font-bold bg-gradient-to-r from-gray-800 to-gray-600 bg-clip-text text-transparent text-center mt-0 mb-0 leading-tight",children:"تفعيل الحساب مطلوب"})]}),e.jsxs("div",{className:"text-center pt-6 pb-0 px-2",children:[e.jsxs("div",{className:"bg-gradient-to-r from-orange-50 to-amber-50 rounded-xl p-6 mb-6 border border-orange-100",children:[e.jsx("p",{className:"text-gray-700 text-lg leading-relaxed font-medium",children:"حسابك في انتظار التفعيل من قبل المسؤول"}),e.jsx("p",{className:"text-sm font-semibold text-orange-700 mt-3 mb-3 bg-orange-100 p-3 rounded-lg border border-orange-200",children:"للتفعيل السريع: تواصل مع الإدارة عبر واتساب فقط على الرقم التالي"}),e.jsxs("div",{className:"bg-green-50 p-4 rounded-lg border border-green-200 mt-3",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"text-base font-bold text-green-700",children:"واتساب الإدارة:"}),e.jsx("a",{href:"https://wa.me/201000392539",target:"_blank",rel:"noopener noreferrer",className:"text-lg font-bold text-green-600 hover:text-green-700 underline",children:"01000392539"})]}),e.jsx("p",{className:"text-sm text-green-600 mt-2 text-center",children:"اضغط على الرقم للتواصل المباشر عبر واتساب"})]})]}),!t&&e.jsxs("div",{className:"bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-4 mb-4 border border-green-200",children:[e.jsxs("div",{className:"flex items-center justify-center mb-2",children:[e.jsx(mn,{className:"h-5 w-5 text-green-600 ml-2"}),e.jsx("span",{className:"text-green-700 font-semibold",children:"باقة الزيرو المجانية الدائمة"})]}),e.jsx("p",{className:"text-green-600 text-sm text-center",children:"فعل باقة الزيرو الان واستمتع ب 10 عمليات سحب وتحويل يوميا"})]}),T&&e.jsx("div",{className:`rounded-xl p-4 mb-4 text-center ${T.includes("تم تفعيل")?"bg-green-50 border border-green-200 text-green-700":"bg-red-50 border border-red-200 text-red-700"}`,children:e.jsx("p",{className:"font-medium",children:T})}),e.jsxs("div",{className:"flex items-center justify-center space-x-2 text-sm text-gray-500 mb-0",children:[e.jsxs("div",{className:"flex space-x-1",children:[e.jsx("div",{className:"w-2 h-2 bg-orange-400 rounded-full animate-pulse"}),e.jsx("div",{className:"w-2 h-2 bg-orange-400 rounded-full animate-pulse",style:{animationDelay:"0.2s"}}),e.jsx("div",{className:"w-2 h-2 bg-orange-400 rounded-full animate-pulse",style:{animationDelay:"0.4s"}})]}),e.jsx("span",{className:"mr-2",children:"في انتظار التفعيل"})]})]}),e.jsxs("div",{className:"flex flex-col space-y-3 pb-2",children:[!t&&!T.includes("تم تفعيل")&&e.jsxs(e.Fragment,{children:[e.jsxs(d,{onClick:b,disabled:y,className:"w-full max-w-2xl mx-auto relative bg-gradient-to-r from-blue-600 to-indigo-600 hover:brightness-110 text-white px-10 py-4 rounded-2xl font-bold text-xl ring-2 ring-blue-300 ring-offset-1 shadow-2xl hover:shadow-3xl transition-all duration-500 transform hover:scale-110 hover:-translate-y-1 disabled:opacity-50 disabled:cursor-not-allowed overflow-hidden group focus-visible:outline-none focus-visible:ring-4 focus-visible:ring-blue-300",style:{boxShadow:"0 15px 35px rgba(59, 130, 246, 0.4), 0 5px 15px rgba(0, 0, 0, 0.1)"},children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-white/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"}),e.jsx("div",{className:"absolute -top-1 -left-1 w-3 h-3 bg-yellow-400 rounded-full animate-ping"}),e.jsx("div",{className:"absolute -top-1 -right-1 w-2 h-2 bg-green-400 rounded-full animate-pulse"}),y?e.jsxs("div",{className:"flex items-center relative z-10",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-white ml-3"}),e.jsx("span",{className:"bg-gradient-to-r from-white to-gray-100 bg-clip-text text-transparent",children:"جاري التفعيل..."})]}):e.jsxs("div",{className:"flex items-center relative z-10",children:[e.jsx(Ec,{className:"h-6 w-6 ml-3 animate-bounce"}),e.jsx("span",{className:"bg-gradient-to-r from-white to-gray-100 bg-clip-text text-transparent",children:`التجربة المجانية لمدة ${m} ${m>=3&&m<=10?"ساعات":m===2?"ساعتين":"ساعة"}`})]})]}),e.jsxs(d,{onClick:B,disabled:y,className:"w-full max-w-2xl mx-auto relative bg-gradient-to-r from-green-600 to-emerald-600 hover:brightness-110 text-white px-10 py-4 rounded-2xl font-bold text-xl ring-2 ring-emerald-300 ring-offset-1 shadow-2xl hover:shadow-3xl transition-all duration-500 transform hover:scale-110 hover:-translate-y-1 disabled:opacity-50 disabled:cursor-not-allowed overflow-hidden group focus-visible:outline-none focus-visible:ring-4 focus-visible:ring-emerald-300",style:{boxShadow:"0 15px 35px rgba(99, 102, 241, 0.4), 0 5px 15px rgba(0, 0, 0, 0.1)"},children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-white/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"}),e.jsx("div",{className:"absolute -top-1 -left-1 w-3 h-3 bg-yellow-400 rounded-full animate-ping"}),e.jsx("div",{className:"absolute -top-1 -right-1 w-2 h-2 bg-green-400 rounded-full animate-pulse"}),y?e.jsxs("div",{className:"flex items-center relative z-10",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-white ml-3"}),e.jsx("span",{className:"bg-gradient-to-r from-white to-gray-100 bg-clip-text text-transparent",children:"جاري التفعيل..."})]}):e.jsxs("div",{className:"flex items-center relative z-10",children:[e.jsx(mn,{className:"h-6 w-6 ml-3 animate-bounce"}),e.jsx("span",{className:"bg-gradient-to-r from-white to-gray-100 bg-clip-text text-transparent",children:"فعّل باقة الزيرو الآن"})]})]})]}),e.jsx(d,{onClick:u,variant:"outline",className:"border-2 border-gray-300 hover:border-gray-400 text-gray-700 hover:text-gray-800 px-10 py-3 rounded-xl font-semibold text-lg transition-all duration-300 transform hover:scale-105",children:t?"فهمت":"إغلاق"})]})]})})]})};function Xc({isOpen:l,onClose:u}){const[o,x]=n.useState("0"),[y,v]=n.useState(null),[t,E]=n.useState(null),[T,g]=n.useState(!1),m=$=>{T?(x($),g(!1)):x(o==="0"?$:o+$)},w=$=>{const C=parseFloat(o);if(y===null)v(C);else if(t){const Z=b(y||0,C,t);x(String(Z)),v(Z)}g(!0),E($)},b=($,C,_)=>{switch(_){case"+":return $+C;case"-":return $-C;case"×":return $*C;case"÷":return C===0?0:$/C;case"=":return C;default:return C}},B=()=>{const $=parseFloat(o);if(y!==null&&t){const C=b(y,$,t);x(String(C)),v(null),E(null),g(!0)}},U=()=>{x("0"),v(null),E(null),g(!1)},X=()=>{x("0")},M=()=>{T?(x("0."),g(!1)):o.indexOf(".")===-1&&x(o+".")},I=()=>{o!=="0"&&x(o.charAt(0)==="-"?o.slice(1):"-"+o)},R=()=>{const $=parseFloat(o);x(String($/100))},ee=$=>{const C=$.key;$.preventDefault(),C>="0"&&C<="9"?m(C):C==="+"?w("+"):C==="-"?w("-"):C==="*"?w("×"):C==="/"?w("÷"):C==="Enter"||C==="="?B():C==="Escape"||C==="c"||C==="C"?U():C==="Backspace"?X():C==="."?M():C==="%"&&R()};return n.useEffect(()=>(l?document.addEventListener("keydown",ee):document.removeEventListener("keydown",ee),()=>{document.removeEventListener("keydown",ee)}),[l,o,y,t,T]),e.jsx(me,{open:l,onOpenChange:$=>!$&&u(),children:e.jsxs(he,{className:"sm:max-w-md",children:[e.jsx(ue,{children:e.jsxs(xe,{className:"flex items-center gap-2 text-right",children:[e.jsx(Ql,{className:"h-5 w-5"}),"آلة حاسبة"]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-gray-900 text-white p-4 rounded-lg text-right",children:e.jsx("div",{className:"text-3xl font-mono font-bold min-h-[3rem] flex items-center justify-end overflow-hidden",children:o})}),e.jsxs("div",{className:"grid grid-cols-4 gap-2",children:[e.jsx(d,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:U,children:"AC"}),e.jsx(d,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:X,children:"CE"}),e.jsx(d,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:R,children:"%"}),e.jsx(d,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>w("÷"),children:"÷"}),e.jsx(d,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>m("7"),children:"7"}),e.jsx(d,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>m("8"),children:"8"}),e.jsx(d,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>m("9"),children:"9"}),e.jsx(d,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>w("×"),children:"×"}),e.jsx(d,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>m("4"),children:"4"}),e.jsx(d,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>m("5"),children:"5"}),e.jsx(d,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>m("6"),children:"6"}),e.jsx(d,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>w("-"),children:"-"}),e.jsx(d,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>m("1"),children:"1"}),e.jsx(d,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>m("2"),children:"2"}),e.jsx(d,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>m("3"),children:"3"}),e.jsx(d,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>w("+"),children:"+"}),e.jsx(d,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50 col-span-2",onClick:()=>m("0"),children:"0"}),e.jsx(d,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:M,children:"."}),e.jsx(d,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:B,children:"="})]}),e.jsx(d,{variant:"outline",className:"w-full h-10 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:I,children:"+/-"})]})]})})}function Zc({isOpen:l,onClose:u,initialBarcode:o}){const[x,y]=n.useState([]),[v,t]=n.useState({productName:"",price:"",wholesalePrice:"",quantity:"",barcode:"",serialNumber:""}),[E,T]=n.useState(!1);n.useState(null);const{toast:g}=hs(),{user:m,profile:w}=Ps(),{isShiftActive:b,shiftUser:B}=Ta(),[U,X]=n.useState([]),[M,I]=n.useState({}),[R,ee]=n.useState({});n.useState({});const[$,C]=n.useState(""),[_,Z]=n.useState(!1),[re,ce]=n.useState({}),[J,V]=n.useState(!1),[Ae,H]=n.useState(!0),[le,Be]=n.useState(!1),Ge=tt.useRef(""),kt=tt.useRef(0),[Je,Wt]=n.useState(0),[pt,Lt]=n.useState(0),[Qe,at]=n.useState(!1),[Me,gt]=n.useState(!0),[Pt,At]=n.useState(!1),[Yt,Ue]=n.useState(!1),[ss,_t]=n.useState("التحقق قبل العملية"),[as,Ft]=n.useState("أدخل الرقم السري الرئيسي للمتابعة"),A=tt.useRef(null),se=(h,P,K)=>{_t(h),Ft(P),A.current=K,Ue(!0)},[pe,ke]=n.useState(""),Oe=n.useMemo(()=>{const h=pe.trim().toLowerCase();return h?U.filter(P=>P.name.toLowerCase().includes(h)):U},[U,pe]);n.useEffect(()=>{l&&(m!=null&&m.uid)&&(O(),Me||z())},[l,m==null?void 0:m.uid,Me]),n.useEffect(()=>{if(!l)return;const h=P=>{const K=Date.now();if(P.key==="Enter"){const de=(Ge.current||"").trim();Ge.current="",de&&Nt(de);return}P.key.length===1&&(K-(kt.current||0)>100&&(Ge.current=""),Ge.current+=P.key,kt.current=K)};return window.addEventListener("keydown",h),()=>window.removeEventListener("keydown",h)},[l,U]),n.useEffect(()=>{l&&o&&Nt(o)},[l,o]);const rt=async()=>{if(m!=null&&m.uid)try{const h=w==null?void 0:w.shopId;let P,K=[];if(h){const de=Rs(bs(xt,"products"),Bt("shopId","==",h),Bt("userId","==",m.uid));if(P=await Us(de),K=P.docs.map(ne=>({id:ne.id,name:String(ne.data().name??""),sellingPrice:Number(ne.data().sellingPrice??0),wholesalePrice:Number(ne.data().wholesalePrice??0),quantity:Number(ne.data().quantity??0),barcode:String(ne.data().barcode??""),serialNumber:String(ne.data().serialNumber??"")})),K.length===0){const ne=Rs(bs(xt,"products"),Bt("userId","==",m.uid)),Ie=(await Us(ne)).docs.map($e=>({id:$e.id,name:String($e.data().name??""),sellingPrice:Number($e.data().sellingPrice??0),wholesalePrice:Number($e.data().wholesalePrice??0),quantity:Number($e.data().quantity??0),barcode:String($e.data().barcode??""),serialNumber:String($e.data().serialNumber??"")}));Ie.length>0&&(K=Ie,g({title:"تم استرجاع المنتجات",description:"عثرنا على منتجات محفوظة لك خارج المتجر الحالي وقمنا بعرضها."}))}}else{const de=Rs(bs(xt,"products"),Bt("userId","==",m.uid));P=await Us(de),K=P.docs.map(ne=>({id:ne.id,name:String(ne.data().name??""),sellingPrice:Number(ne.data().sellingPrice??0),wholesalePrice:Number(ne.data().wholesalePrice??0),quantity:Number(ne.data().quantity??0),barcode:String(ne.data().barcode??""),serialNumber:String(ne.data().serialNumber??"")}))}if(X(K),w!=null&&w.shopId&&K.length>0){const de=K.filter(ne=>{const _e=((P==null?void 0:P.docs)||[]).find($e=>$e.id===ne.id);return!(!!_e&&!!_e.data().shopId)});if(de.length>0)try{await Promise.all(de.map(ne=>ra(cs(xt,"products",ne.id),{shopId:w.shopId,updatedAt:ea()}))),g({title:"تم ترتيب المنتجات",description:"تم ربط بعض المنتجات غير المربوطة بمتجرك الحالي تلقائياً."})}catch(ne){console.warn("تعذّر ترحيل shopId لبعض المنتجات:",ne)}}}catch(h){console.error("Error loading shop products:",h)}};n.useEffect(()=>{l&&(m!=null&&m.uid)&&(rt(),z())},[l,m==null?void 0:m.uid,w==null?void 0:w.shopId]);const O=()=>{if(!(m!=null&&m.uid)){console.log("No user authenticated, cannot load sales data");return}const h=new Date().toISOString().split("T")[0],P=localStorage.getItem(`salesData_${m.uid}_${h}`);y(P?JSON.parse(P):[])},te=h=>{if(!(m!=null&&m.uid)){console.log("No user authenticated, cannot save sales data");return}const P=new Date().toISOString().split("T")[0];localStorage.setItem(`salesData_${m.uid}_${P}`,JSON.stringify(h)),y(h)},z=async()=>{if(m!=null&&m.uid)try{const h=new Date,P=new Date(h.getFullYear(),h.getMonth(),1),K=new Date(h.getFullYear(),h.getMonth()+1,0),de=mt=>mt.toISOString().split("T")[0],ne=de(P),_e=de(K),Ie=Rs(bs(xt,"dailySales"),Bt("userId","==",m.uid),Bt("date",">=",ne),Bt("date","<=",_e)),$e=await Us(Ie);let Fe=0,ot=0;if(!$e.empty)$e.forEach(mt=>{const Ke=mt.data(),us=Number(Ke.sellingPrice??0),Ye=Number(Ke.quantity??0),rs=Number(Ke.profit??(Number(Ke.sellingPrice??0)-Number(Ke.wholesalePrice??0))*Ye);Fe+=us*Ye,ot+=rs});else{const mt=Rs(bs(xt,"dailySales"),Bt("userId","==",m.uid));(await Us(mt)).forEach(us=>{const Ye=us.data(),rs=String(Ye.date??"").slice(0,10);if(rs>=ne&&rs<=_e){const la=Number(Ye.sellingPrice??0),As=Number(Ye.quantity??0),Vs=Number(Ye.profit??(Number(Ye.sellingPrice??0)-Number(Ye.wholesalePrice??0))*As);Fe+=la*As,ot+=Vs}}),(Fe>0||ot>0)&&g({title:"تم استرجاع تقارير الشهر",description:"تم حساب التقارير باستخدام مسار احتياطي للتواريخ القديمة."})}Wt(Fe),Lt(ot)}catch(h){console.error("Error loading monthly stats:",h)}},Ne=async h=>{if(m!=null&&m.uid)try{const P=((h.price??0)-(h.wholesalePrice??0))*(h.quantity??0),K=b&&B?"cashier":"admin",de=K==="cashier"?(B==null?void 0:B.name)||"كاشير":(w==null?void 0:w.fullName)||(m==null?void 0:m.displayName)||"الحساب الرئيسي",ne=K==="cashier"&&(B==null?void 0:B.username)||null;await kl(bs(xt,"dailySales"),{userId:m.uid,productName:h.productName,quantity:h.quantity,wholesalePrice:h.wholesalePrice??null,sellingPrice:h.price,profit:P,date:h.date,time:h.time,performedByType:K,performedByName:de,performedByUsername:ne,serialNumber:h.serialNumber??null,barcode:h.barcode??null,createdAt:ea()})}catch(P){console.error("Error saving sale:",P)}},Le=async h=>{const P=M[h.id]||"",K=parseInt(P);if(isNaN(K)||K<=0){g({title:"كمية غير صالحة",description:"أدخل كمية صحيحة للبيـع",variant:"destructive"});return}if(K>h.quantity){g({title:"كمية أكبر من المتاح",description:"الكمية المطلوب بيعها تتجاوز المخزون المتاح",variant:"destructive"});return}const de=new Date,ne=b&&B?"cashier":"admin",_e=ne==="cashier"?(B==null?void 0:B.name)||"كاشير":(w==null?void 0:w.fullName)||(m==null?void 0:m.displayName)||"الحساب الرئيسي",Ie=ne==="cashier"&&(B==null?void 0:B.username)||null,$e=(h.serialNumber||"").trim(),Fe={id:Date.now().toString(),productName:h.name,price:h.sellingPrice,wholesalePrice:h.wholesalePrice,quantity:K,date:de.toISOString().split("T")[0],time:de.toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit"}),performedByType:ne,performedByName:_e,performedByUsername:Ie,serialNumber:$e||void 0,barcode:h.barcode};try{te([...x,Fe]),await Ne(Fe);const ot=h.quantity-K;await ra(cs(xt,"products",h.id),{quantity:ot,updatedAt:ea()}),X(mt=>mt.map(Ke=>Ke.id===h.id?{...Ke,quantity:ot}:Ke)),I(mt=>({...mt,[h.id]:""})),g({title:"تم البيع",description:`تم بيع ${K} قطعة من ${h.name}`})}catch(ot){console.error("Error selling product:",ot),g({title:"فشل البيع",description:"تعذّر تنفيذ عملية البيع",variant:"destructive"})}},Ht=async h=>{try{I(P=>({...P,[h.id]:"1"})),await Le(h)}catch(P){console.error("Error selling by barcode:",P)}},Dt=async h=>{if(b){g({title:"غير مسموح في وضع الكاشير",description:"لا يمكن إضافة قطع أثناء الورديه",variant:"destructive"});return}const P=R[h.id]||"",K=parseInt(P);if(isNaN(K)||K<=0){g({title:"كمية غير صالحة",description:"أدخل كمية صحيحة للإضافة",variant:"destructive"});return}se("تأكيد إضافة قطع","لا يمكن إضافة قطع إلا بإدخال الرقم السري الرئيسي",async()=>{try{const de=h.quantity+K;await ra(cs(xt,"products",h.id),{quantity:de,updatedAt:ea()}),X(ne=>ne.map(_e=>_e.id===h.id?{..._e,quantity:de}:_e)),ee(ne=>({...ne,[h.id]:""})),g({title:"تمت الإضافة",description:`تمت إضافة ${K} قطعة إلى ${h.name}`})}catch(de){console.error("Error adding pieces:",de),g({title:"فشل الإضافة",description:"تعذّر إضافة الكمية إلى المخزون",variant:"destructive"})}})},zt=async h=>{if(!(m!=null&&m.uid))return;if(b){g({title:"غير مسموح في وضع الكاشير",description:"لا يمكن حذف المنتجات أثناء الورديه",variant:"destructive"});return}window.confirm(`هل تريد حذف المنتج "${h.name}"؟`)&&se("تأكيد حذف منتج","لا يمكن حذف المنتجات إلا بإدخال الرقم السري الرئيسي",async()=>{try{await ac(cs(xt,"products",h.id)),X(K=>K.filter(de=>de.id!==h.id)),g({title:"تم الحذف",description:`تم حذف المنتج ${h.name}`})}catch(K){console.error("Error deleting product:",K),g({title:"فشل الحذف",description:"تعذّر حذف المنتج",variant:"destructive"})}})},Re=async()=>{try{if(!(m!=null&&m.uid)){g({title:"خطأ",description:"غير مسجّل دخول",variant:"destructive"});return}if(b){g({title:"غير مسموح في وضع الكاشير",description:"لا يمكن إضافة منتجات أثناء الورديه",variant:"destructive"});return}const h=v.productName.trim(),P=parseFloat(v.price),K=parseFloat(v.wholesalePrice||"0"),de=parseInt(v.quantity);if(!h||isNaN(P)||isNaN(de)){g({title:"بيانات غير مكتملة",description:"أدخل اسم المنتج والسعر والكمية",variant:"destructive"});return}const ne={name:h,sellingPrice:P,wholesalePrice:isNaN(K)?0:K,quantity:isNaN(de)?0:de,userId:m.uid,createdAt:ea(),updatedAt:ea()},_e=(v.barcode||"").trim();_e&&(ne.barcode=_e);const Ie=(v.serialNumber||"").trim();Ie&&(ne.serialNumber=Ie),w!=null&&w.shopId&&(ne.shopId=w.shopId);const $e=await kl(bs(xt,"products"),ne);X(Fe=>[{id:$e.id,name:h,sellingPrice:P,wholesalePrice:isNaN(K)?0:K,quantity:isNaN(de)?0:de,barcode:(v.barcode||"").trim()||"",serialNumber:(v.serialNumber||"").trim()||""},...Fe]),t({productName:"",price:"",wholesalePrice:"",quantity:"",barcode:"",serialNumber:""}),g({title:"تمت الإضافة",description:`تم إضافة المنتج ${h} بنجاح`})}catch(h){console.error("createProduct error",h),g({title:"فشل الإضافة",description:"تعذّر إضافة المنتج. حاول مجددًا",variant:"destructive"})}},Nt=async h=>{const P=(h||"").trim();if(!P)return;const K=U.find(de=>(de.barcode||"")===P);if(!K){g({title:"باركود غير معروف",description:"لم يتم العثور على منتج بهذا الباركود"});return}await Ht(K)},it=()=>{const h=Object.entries(re).map(([Fe,ot])=>{const mt=Number(ot),Ke=U.find(us=>us.id===Fe);return!Ke||!mt||mt<=0?null:{name:Ke.name,qty:mt,price:Ke.sellingPrice,total:mt*Ke.sellingPrice}}).filter(Boolean);if(h.length===0){g({title:"لم يتم اختيار منتجات",description:"فعّل وضع الفاتورة واختر منتجات وكميات للطباعة"});return}const P=(w==null?void 0:w.shopName)||(m==null?void 0:m.displayName)||"المحل",K=(w==null?void 0:w.phone)||(m==null?void 0:m.phoneNumber)||"",de=h.reduce((Fe,ot)=>Fe+ot.total,0),ne=new Date().toLocaleString("ar-EG"),_e=h.map(Fe=>`
        <tr>
          <td style="border:1px solid #ddd;padding:6px">${Fe.name}</td>
          <td style="border:1px solid #ddd;padding:6px;text-align:center">${Fe.qty}</td>
          <td style="border:1px solid #ddd;padding:6px;text-align:center">${ut(Fe.price)}</td>
          <td style="border:1px solid #ddd;padding:6px;text-align:center;font-weight:bold;color:#0a7">${ut(Fe.total)}</td>
        </tr>
      `).join(""),Ie=`
      <html>
        <head>
          <meta charset="utf-8" />
          <title>فاتورة</title>
          <style>
            body { font-family: Tahoma, Arial, sans-serif; direction: rtl; }
            .header { text-align: center; margin-bottom: 12px; }
            .header h2 { margin: 0; }
            .meta { text-align: center; color: #555; margin-bottom: 8px; }
            table { width: 100%; border-collapse: collapse; }
            .total { text-align: left; font-weight: bold; margin-top: 10px; }
          </style>
        </head>
        <body>
          <div class="header">
            <h2>${P}</h2>
            ${K?`<div class="meta">رقم التليفون: ${K}</div>`:""}
            <div class="meta">التاريخ: ${ne}</div>
          </div>
          <table>
            <thead>
              <tr>
                <th style="border:1px solid #ddd;padding:6px">المنتج</th>
                <th style="border:1px solid #ddd;padding:6px">الكمية</th>
                <th style="border:1px solid #ddd;padding:6px">السعر</th>
                <th style="border:1px solid #ddd;padding:6px">الإجمالي</th>
              </tr>
            </thead>
            <tbody>
              ${_e}
            </tbody>
          </table>
          <div class="total">الإجمالي الكلي: ${ut(de)}</div>
        </body>
      </html>
    `,$e=window.open("","_blank");$e&&($e.document.write(Ie),$e.document.close(),$e.focus(),$e.print(),$e.close())};return e.jsxs(me,{open:l,onOpenChange:u,children:[e.jsxs(he,{className:"max-w-7xl md:max-w-6xl lg:max-w-7xl w-[95vw] md:w-[90vw] h-[95vh] md:h-[90vh] p-0 overflow-y-auto",children:[e.jsx(ue,{className:"px-3 md:px-6 py-3 md:py-4 border-b bg-gradient-to-r from-blue-50 to-purple-50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 md:gap-3",children:[e.jsx("div",{className:"p-1.5 md:p-2 bg-blue-100 rounded-lg",children:e.jsx(fn,{className:"h-5 w-5 md:h-6 md:w-6 text-blue-600"})}),e.jsxs("div",{children:[e.jsx(xe,{className:"text-lg md:text-xl font-bold text-gray-800",children:"📊 بيانات المبيعات اليومية"}),e.jsxs("p",{className:"text-xs md:text-sm text-gray-600 mt-1 hidden sm:block",children:["إدارة وتتبع مبيعات اليوم - ",new Date().toLocaleDateString("ar-EG")]})]})]}),e.jsx("div",{className:"flex items-center gap-1 md:gap-2",children:e.jsx(d,{variant:"ghost",size:"sm",onClick:u,className:"h-8 w-8 md:h-9 md:w-9",children:e.jsx(Ul,{className:"h-4 w-4"})})})]})}),e.jsxs("div",{className:"flex flex-col md:flex-row h-full",dir:"rtl",children:[e.jsxs("div",{className:"w-full md:w-72 lg:w-80 bg-white/50 border-r",children:[e.jsxs("div",{className:"p-3 md:p-4 border-b bg-white/30",children:[e.jsxs("h3",{className:"font-semibold text-gray-800 mb-3 flex items-center gap-2 text-sm md:text-base",children:[e.jsx(lt,{className:"h-4 w-4 text-green-600"}),"ملخص المبيعات"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 md:gap-3",children:[e.jsxs("div",{className:"bg-blue-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-blue-600",children:ut(x.reduce((h,P)=>h+P.price*P.quantity,0))}),e.jsx("div",{className:"text-xs md:text-sm text-blue-600",children:"إجمالي المبيعات"})]}),e.jsxs("div",{className:"relative bg-green-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsxs("div",{className:Ae?"filter blur-sm pointer-events-none":"",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-green-600",children:ut(x.reduce((h,P)=>h+(P.price-(P.wholesalePrice??0))*P.quantity,0))}),e.jsx("div",{className:"text-xs md:text-sm text-green-600",children:"إجمالي الأرباح"})]}),Ae&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx(d,{size:"sm",variant:"ghost",onClick:()=>Be(!0),className:"bg-white/80 hover:bg-white text-green-700 border border-green-200",children:"عرض الأرباح"})})]}),e.jsxs("div",{className:"bg-yellow-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-yellow-600",children:ta(U.length)}),e.jsx("div",{className:"text-xs md:text-sm text-yellow-600",children:"عدد المنتجات"})]}),e.jsxs("div",{className:"bg-purple-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-purple-600",children:ta(x.length)}),e.jsx("div",{className:"text-xs md:text-sm text-purple-600",children:"عدد المبيعات"})]})]}),e.jsxs("div",{className:"relative mb-2",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-1 md:gap-2 text-xs md:text-sm font-semibold text-indigo-700",children:[e.jsx(ks,{className:"h-3 w-3 md:h-4 md:w-4"}),e.jsx(fn,{className:"h-3 w-3 md:h-4 md:w-4"}),e.jsx("span",{children:"تقارير الشهر"})]}),e.jsx(d,{size:"sm",variant:"ghost",onClick:()=>At(h=>!h),className:"h-6 w-6 p-0 rounded-full",title:Pt?"إظهار التقارير":"إخفاء التقارير",children:Pt?e.jsx(Nn,{className:"h-4 w-4"}):e.jsx(Kl,{className:"h-4 w-4"})})]}),e.jsx("div",{className:Pt?"overflow-hidden max-h-0 transition-[max-height] duration-300":"overflow-hidden transition-[max-height] duration-300 max-h-[400px]",children:e.jsxs("div",{className:Me?"grid grid-cols-2 gap-2 md:gap-4 filter blur-sm pointer-events-none":"grid grid-cols-2 gap-2 md:gap-4",children:[e.jsxs("div",{className:"bg-indigo-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-indigo-600",children:ut(Je)}),e.jsx("div",{className:"text-xs md:text-sm text-indigo-600",children:"مبيعات الشهر"})]}),e.jsxs("div",{className:"bg-pink-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-pink-600",children:ut(pt)}),e.jsx("div",{className:"text-xs md:text-sm text-pink-600",children:"أرباح الشهر"})]})]})}),!Pt&&Me&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center rounded-lg bg-yellow-100/60",children:e.jsxs(d,{size:"sm",variant:"ghost",onClick:async()=>{try{if(await isZeroPlan()){g({title:"الخطة زيرو",description:"التقارير الشهرية غير متاحة في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}catch{}at(!0)},className:"flex items-center gap-2 bg-yellow-200/70 hover:bg-yellow-300 text-yellow-900 px-3 py-2 rounded-xl shadow-md hover:shadow-lg transition-all",title:"عرض تقارير الشهر",children:[e.jsx(Ve,{className:"h-5 w-5 md:h-7 md:w-7"}),e.jsx("span",{className:"text-xs md:text-sm",children:"عرض تقارير الشهر"})]})})]})]}),e.jsx("div",{className:"p-3 md:p-4 border-b bg-white/30",children:e.jsxs("h3",{className:"font-semibold text-gray-800 mb-3 flex items-center gap-2 text-sm md:text-base",children:[e.jsx(or,{className:"h-4 w-4 text-indigo-600"}),"إحصائيات المنتجات"]})}),e.jsx("div",{className:"p-3 md:p-4 flex-1 overflow-y-auto hidden md:block",children:e.jsxs("h3",{className:"font-semibold text-gray-800 mb-3 flex items-center gap-2",children:[e.jsx(bn,{className:"h-4 w-4 text-blue-600"}),"نصائح للمبيعات"]})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto transition-all duration-300 ease-in-out scrollbar-thin scrollbar-thumb-blue-300 scrollbar-track-blue-100 hover:scrollbar-thumb-blue-400",children:e.jsxs("div",{className:"p-3 md:p-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 md:mb-6 gap-2",children:[e.jsxs("h2",{className:"text-base md:text-lg font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(Rc,{className:"h-4 w-4 md:h-5 md:w-5 text-blue-600"}),"سجل المبيعات (",x.length," عنصر)"]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs md:text-sm text-gray-600",children:[e.jsx(ks,{className:"h-3 w-3 md:h-4 md:w-4"}),e.jsx("span",{className:"hidden sm:inline",children:new Date().toLocaleDateString("ar-EG")}),e.jsx(zs,{className:"h-3 w-3 md:h-4 md:w-4 ml-2"}),e.jsx("span",{children:new Date().toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit"})})]})]}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-3 md:p-4 mb-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("h3",{className:"text-sm md:text-base font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(Tt,{className:"h-4 w-4 text-emerald-600"}),"إضافة منتج جديد"]}),e.jsxs(d,{size:"sm",variant:"ghost",className:"h-8",onClick:()=>{if(b){g({title:"غير مسموح في وضع الكاشير",description:"لا يمكن إضافة منتج أثناء الورديه",variant:"destructive"});return}se("فتح نموذج إضافة منتج","أدخل الرقم السري الرئيسي لفتح نموذج الإضافة",()=>T(!0))},children:[e.jsx(Tt,{className:"h-4 w-4 text-emerald-600"}),"إضافة منتج"]})]}),E&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx(q,{htmlFor:"new-product-name",className:"text-xs md:text-sm",children:"اسم المنتج"}),e.jsx(L,{id:"new-product-name",value:v.productName,onChange:h=>t(P=>({...P,productName:h.target.value})),placeholder:"أدخل اسم المنتج"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx(q,{htmlFor:"new-product-price",className:"text-xs md:text-sm",children:"سعر البيع (ج.م)"}),e.jsx(L,{type:"number",id:"new-product-price",value:v.price,onChange:h=>t(P=>({...P,price:h.target.value})),placeholder:"0.00"})]}),e.jsxs("div",{children:[e.jsx(q,{htmlFor:"new-product-wholesale",className:"text-xs md:text-sm",children:"سعر الجملة (ج.م)"}),e.jsx(L,{type:"number",id:"new-product-wholesale",value:v.wholesalePrice||"",onChange:h=>t(P=>({...P,wholesalePrice:h.target.value})),placeholder:"0.00"})]})]}),e.jsxs("div",{children:[e.jsx(q,{htmlFor:"new-product-qty",className:"text-xs md:text-sm",children:"الكمية"}),e.jsx(L,{type:"number",id:"new-product-qty",value:v.quantity,onChange:h=>t(P=>({...P,quantity:h.target.value})),placeholder:"1"})]}),e.jsxs("div",{children:[e.jsx(q,{htmlFor:"new-product-barcode",className:"text-xs md:text-sm",children:"باركود المنتج (اختياري)"}),e.jsx(L,{id:"new-product-barcode",value:v.barcode||"",onChange:h=>t(P=>({...P,barcode:h.target.value})),placeholder:"أدخل/امسح الباركود"})]}),e.jsxs("div",{children:[e.jsx(q,{htmlFor:"new-product-serial",className:"text-xs md:text-sm",children:"سيريال الجهاز (اختياري)"}),e.jsx(L,{id:"new-product-serial",value:v.serialNumber||"",onChange:h=>t(P=>({...P,serialNumber:h.target.value})),placeholder:"أدخل سيريال الجهاز"})]}),e.jsx(d,{className:"h-9 w-full md:w-auto",onClick:Re,children:"إضافة المنتج"})]})]}),e.jsx("div",{id:"shop-products-section",className:"bg-white rounded-lg border border-gray-200 overflow-hidden mb-4",children:e.jsxs("div",{className:"mb-4",children:[e.jsxs("h3",{className:"text-sm md:text-base font-semibold text-gray-800 mb-2 flex items-center gap-2",children:[e.jsx(or,{className:"h-4 w-4 text-green-600"}),"منتجات المحل"]}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(d,{variant:_?"default":"outline",size:"sm",onClick:()=>Z(h=>!h),children:_?"وضع الفاتورة: مفعل":"تفعيل وضع الفاتورة"}),e.jsx(d,{size:"sm",className:"bg-indigo-600 hover:bg-indigo-700 text-white",disabled:Object.keys(re).filter(h=>(re[h]||0)>0).length===0,onClick:it,children:"طباعة فاتورة"})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(L,{value:pe,onChange:h=>ke(h.target.value),placeholder:"ابحث عن منتج...",className:"h-9 w-full md:w-72 text-sm","aria-label":"البحث عن منتج من منتجات المحل"}),e.jsx(L,{value:$,onChange:h=>C(h.target.value),onKeyDown:async h=>{if(h.key!=="Enter")return;const P=$.trim();P&&(await Nt(P),C(""))},placeholder:"مرّر ماسح الباركود هنا (اختياري)",className:"h-9 w-full md:w-64 text-sm","aria-label":"مسح الباركود لإضافة المنتج تلقائياً"}),pe&&e.jsx(d,{variant:"ghost",size:"sm",className:"h-9",onClick:()=>ke(""),children:"مسح"})]}),e.jsx("div",{className:"overflow-x-auto border border-gray-200 rounded-lg hidden md:block",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"المنتج"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"سعر البيع"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("span",{children:"سعر الجملة"}),e.jsx(d,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>V(h=>!h),"aria-label":J?"إخفاء سعر الجملة":"إظهار سعر الجملة",children:J?e.jsx(St,{className:"h-4 w-4"}):e.jsx(Ve,{className:"h-4 w-4"})})]})}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"المتاح"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"بيع"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:Oe.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"px-3 py-3 text-center text-gray-500",children:U.length===0?"لا توجد منتجات بعد، أضف منتجاً من النموذج أعلاه":"لا توجد نتائج مطابقة للبحث"})}):Oe.map(h=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-3 py-2 font-medium text-gray-900",children:h.name}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:ut(h.sellingPrice)}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:e.jsx("span",{className:J?"":"blur-sm select-none",children:ut(h.wholesalePrice)})}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:ta(h.quantity)}),e.jsx("td",{className:"px-3 py-2",children:e.jsxs("div",{className:"flex items-center gap-2 flex-nowrap",children:[e.jsx(L,{value:M[h.id]||"",onChange:P=>I(K=>({...K,[h.id]:P.target.value})),type:"number",placeholder:"عدد القطع للبيع",className:"h-8 w-28 text-sm"}),e.jsx(d,{size:"sm",className:"h-8 min-w-[64px]",onClick:()=>Le(h),children:"بيع"}),_&&e.jsx(L,{value:re[h.id]??"",onChange:P=>{const K=parseInt(P.target.value||"0");ce(de=>({...de,[h.id]:isNaN(K)?0:K}))},type:"number",placeholder:"كمية للفاتورة",className:"h-8 w-24 text-sm"}),e.jsx(L,{value:R[h.id]||"",onChange:P=>ee(K=>({...K,[h.id]:P.target.value})),type:"number",placeholder:"عدد للإضافة",className:"h-8 w-28 text-sm",disabled:b}),e.jsxs("div",{className:"inline-flex items-center gap-2 flex-nowrap",children:[e.jsx(d,{size:"sm",variant:"outline",className:"h-8 whitespace-nowrap",onClick:()=>Dt(h),disabled:b,title:b?"غير مسموح في وضع الكاشير":void 0,children:"إضافة قطع جديدة"}),e.jsx(d,{size:"sm",variant:"destructive",className:"h-8",onClick:()=>zt(h),title:"حذف المنتج",disabled:b,children:e.jsx(Ut,{className:"h-4 w-4"})})]})]})})]},h.id))})]})}),e.jsx("div",{className:"block md:hidden space-y-3",children:Oe.length===0?e.jsx("div",{className:"text-center text-gray-500 text-sm",children:U.length===0?"لا توجد منتجات بعد، أضف منتجاً من النموذج أعلاه":"لا توجد نتائج مطابقة للبحث"}):Oe.map(h=>e.jsxs("div",{className:"bg-white rounded-xl p-3 border border-gray-200 shadow-sm",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"font-semibold text-gray-900 text-sm break-words",children:h.name}),e.jsx(d,{size:"sm",variant:"destructive",className:"h-8 min-w-[44px] touch-manipulation",onClick:()=>zt(h),title:"حذف المنتج",disabled:b,children:e.jsx(Ut,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-2 text-xs text-gray-700",children:[e.jsx("div",{className:"text-gray-600",children:"سعر البيع"}),e.jsx("div",{className:"text-right font-medium",children:ut(h.sellingPrice)}),e.jsxs("div",{className:"text-gray-600 inline-flex items-center gap-1",children:[e.jsx("span",{children:"سعر الجملة"}),e.jsx(d,{variant:"ghost",size:"icon",className:"h-5 w-5",onClick:()=>V(P=>!P),"aria-label":J?"إخفاء سعر الجملة":"إظهار سعر الجملة",children:J?e.jsx(St,{className:"h-4 w-4"}):e.jsx(Ve,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"text-right font-medium",children:e.jsx("span",{className:J?"":"blur-sm select-none",children:ut(h.wholesalePrice)})}),e.jsx("div",{className:"text-gray-600",children:"المتاح"}),e.jsx("div",{className:"text-right font-medium",children:ta(h.quantity)})]}),e.jsxs("div",{className:"mt-3 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(L,{value:M[h.id]||"",onChange:P=>I(K=>({...K,[h.id]:P.target.value})),type:"number",placeholder:"عدد القطع للبيع",className:"h-9 flex-1 text-sm","aria-label":`عدد القطع للبيع لـ ${h.name}`}),e.jsx(d,{size:"sm",className:"h-9 min-w-[64px]",onClick:()=>Le(h),children:"بيع"})]}),_&&e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(L,{value:re[h.id]??"",onChange:P=>{const K=parseInt(P.target.value||"0");ce(de=>({...de,[h.id]:isNaN(K)?0:K}))},type:"number",placeholder:"كمية للفاتورة",className:"h-9 flex-1 text-sm","aria-label":`كمية للفاتورة لـ ${h.name}`})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(L,{value:R[h.id]||"",onChange:P=>ee(K=>({...K,[h.id]:P.target.value})),type:"number",placeholder:"عدد للإضافة",className:"h-9 flex-1 text-sm","aria-label":`عدد القطع للإضافة لـ ${h.name}`,disabled:b}),e.jsx(d,{size:"sm",variant:"outline",className:"h-9 min-w-[64px]",onClick:()=>Dt(h),disabled:b,title:b?"غير مسموح في وضع الكاشير":void 0,children:"إضافة"})]})]})]},h.id))})]})}),x.length===0?e.jsxs("div",{className:"text-center py-8 md:py-12",children:[e.jsx("div",{className:"w-16 h-16 md:w-24 md:h-24 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center",children:e.jsx(or,{className:"h-8 w-8 md:h-12 md:w-12 text-gray-400"})}),e.jsx("h3",{className:"text-base md:text-lg font-medium text-gray-900 mb-2",children:"لا توجد مبيعات اليوم"}),e.jsx("p",{className:"text-sm text-gray-500",children:"ابدأ ببيع منتج من القائمة أعلاه"})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"block md:hidden",children:e.jsx("div",{className:"max-h-[70vh] overflow-y-auto space-y-3 p-3",children:x.map(h=>e.jsxs("div",{className:"bg-white rounded-xl p-4 border border-gray-200 shadow-sm",children:[e.jsx("div",{className:"mb-3",children:e.jsx("h4",{className:"font-semibold text-gray-900 text-base break-words",children:h.productName})}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-2 text-sm text-gray-700",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(lt,{className:"h-4 w-4 text-blue-600"}),e.jsx("span",{className:"text-gray-600",children:"سعر البيع"})]}),e.jsx("div",{className:"text-right font-medium",children:ut(h.price)}),typeof h.wholesalePrice=="number"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(lt,{className:"h-4 w-4 text-indigo-600"}),e.jsxs("span",{className:"text-gray-600 inline-flex items-center gap-1",children:["سعر الجملة",e.jsx(d,{variant:"ghost",size:"icon",className:"h-5 w-5",onClick:()=>V(P=>!P),"aria-label":J?"إخفاء سعر الجملة":"إظهار سعر الجملة",children:J?e.jsx(St,{className:"h-4 w-4"}):e.jsx(Ve,{className:"h-4 w-4"})})]})]}),e.jsx("div",{className:"text-right font-medium",children:e.jsx("span",{className:J?"":"blur-sm select-none",children:ut(h.wholesalePrice)})})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(or,{className:"h-4 w-4 text-emerald-600"}),e.jsx("span",{className:"text-gray-600",children:"الكمية"})]}),e.jsx("div",{className:"text-right font-medium",children:ta(h.quantity)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(aa,{className:"h-4 w-4 text-purple-600"}),e.jsx("span",{className:"text-gray-600",children:"الربح"})]}),e.jsx("div",{className:"text-right font-semibold text-purple-700",children:ut(((h.price??0)-(h.wholesalePrice??0))*(h.quantity??0))}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(lt,{className:"h-4 w-4 text-green-600"}),e.jsx("span",{className:"text-gray-600",children:"الإجمالي"})]}),e.jsx("div",{className:"text-right font-bold text-green-700",children:ut(h.price*h.quantity)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Lc,{className:"h-4 w-4 text-amber-600"}),e.jsx("span",{className:"text-gray-600",children:"المنفذ"})]}),e.jsx("div",{className:"text-right text-gray-700",children:h.performedByName??"-"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ks,{className:"h-4 w-4 text-blue-600"}),e.jsx("span",{className:"text-gray-600",children:"التاريخ"})]}),e.jsx("div",{className:"text-right text-gray-600",children:El(h.date)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(zs,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"text-gray-600",children:"الوقت"})]}),e.jsx("div",{className:"text-right text-gray-600",children:h.time})]})]},h.id))})}),e.jsx("div",{className:"hidden md:block overflow-x-auto max-h-96 overflow-y-auto scrollbar-thin scrollbar-thumb-green-300 scrollbar-track-green-100 hover:scrollbar-thumb-green-400",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"المنتج"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"سعر البيع (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("span",{children:"سعر الجملة (ج.م)"}),e.jsx(d,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>V(h=>!h),"aria-label":J?"إخفاء سعر الجملة":"إظهار سعر الجملة",children:J?e.jsx(St,{className:"h-4 w-4"}):e.jsx(Ve,{className:"h-4 w-4"})})]})}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الكمية"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الإجمالي (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الربح (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"التاريخ"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الوقت"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"المنفذ"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:x.map((h,P)=>e.jsxs("tr",{className:P%2===0?"bg-white":"bg-gray-50/50",children:[e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-gray-900",children:h.productName}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:ut(h.price)}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:typeof h.wholesalePrice=="number"?e.jsx("span",{className:J?"":"blur-sm select-none",children:ut(h.wholesalePrice)}):"-"}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:ta(h.quantity)}),e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-green-600",children:ut(h.price*h.quantity)}),e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-purple-600",children:ut(((h.price??0)-(h.wholesalePrice??0))*(h.quantity??0))}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-500",children:El(h.date)}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-500",children:h.time}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:h.performedByName??"-"})]},h.id))})]})})]}),e.jsxs("div",{className:"mt-4 md:mt-6 text-xs text-gray-500 text-center bg-gray-50/50 p-2 md:p-3 rounded border border-gray-200/40 space-y-1",children:[e.jsx("p",{className:"font-medium text-gray-600",children:"💰 نظام إدارة المبيعات اليومية"}),e.jsxs("p",{className:"hidden sm:block",children:["• يتم حفظ البيانات تلقائياً لليوم الحالي: ",new Date().toLocaleDateString("ar-EG")]}),e.jsx("p",{children:"• يمكنك إضافة وتعديل وحذف المنتجات حسب الحاجة"}),e.jsx("p",{className:"hidden sm:block",children:"• يتم حفظ البيانات محلياً وعلى Firebase لتعزيز الأمان"})]})]})})]})]}),e.jsx(es,{open:le,onOpenChange:Be,mode:"verify",title:"قفل إجمالي الأرباح",description:"أدخل الرقم السري الرئيسي لعرض إجمالي الأرباح",onSuccess:()=>{H(!1),Be(!1)}}),e.jsx(es,{open:Qe,onOpenChange:at,mode:"verify",title:"قفل إحصائيات الشهر",description:"لا يمكن الاطلاع على تقارير الشهر إلا بإدخال الرقم السري الرئيسي",onSuccess:async()=>{try{const h=m==null?void 0:m.uid;if(h){const P=await jn(h),K=(P==null?void 0:P.planType)??(P==null?void 0:P.plan)??null,de=typeof K=="string"?K.toLowerCase():null;if(K===ys.ZERO||de==="zero"){g({title:"الخطة زيرو",description:"التقارير الشهرية غير متاحة في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}}catch{}gt(!1),at(!1),z()}}),e.jsx(es,{open:Yt,onOpenChange:Ue,mode:"verify",title:ss,description:as,onSuccess:()=>{const h=A.current;A.current=null,Ue(!1),h&&h()}})]})}const ta=l=>new Intl.NumberFormat("ar-EG").format(Number(l||0)),ut=l=>`${new Intl.NumberFormat("ar-EG",{minimumFractionDigits:2,maximumFractionDigits:2}).format(Number(l||0))} ج.م`,El=l=>{try{const u=new Date(l);return isNaN(u.getTime())?new Date(`${l}T00:00:00`).toLocaleDateString("ar-EG"):u.toLocaleDateString("ar-EG")}catch{return l}};function ei({size:l=24,className:u,...o}){return e.jsxs("svg",{width:l,height:l,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",className:u,...o,children:[e.jsx("rect",{x:"5",y:"2.5",width:"14",height:"19",rx:"2.5",stroke:"currentColor",strokeWidth:"1.5"}),e.jsx("rect",{x:"7",y:"4.5",width:"10",height:"5.5",rx:"1",stroke:"currentColor",strokeWidth:"1.2"}),e.jsx("path",{d:"M9.5 11.5h5",stroke:"currentColor",strokeWidth:"1.4",strokeLinecap:"round"}),e.jsx("circle",{cx:"8.5",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"12",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"15.5",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"8.5",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"12",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"15.5",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("rect",{x:"8",y:"19",width:"9",height:"1.8",rx:"0.6",stroke:"currentColor",strokeWidth:"1"})]})}var ti="AlertDialog",[ed,Cm]=rc(ti,[ql]),ws=ql(),si=l=>{const{__scopeAlertDialog:u,...o}=l,x=ws(u);return e.jsx(jc,{...x,...o,modal:!0})};si.displayName=ti;var td="AlertDialogTrigger",sd=n.forwardRef((l,u)=>{const{__scopeAlertDialog:o,...x}=l,y=ws(o);return e.jsx(pc,{...y,...x,ref:u})});sd.displayName=td;var ad="AlertDialogPortal",ai=l=>{const{__scopeAlertDialog:u,...o}=l,x=ws(u);return e.jsx(Nc,{...x,...o})};ai.displayName=ad;var rd="AlertDialogOverlay",ri=n.forwardRef((l,u)=>{const{__scopeAlertDialog:o,...x}=l,y=ws(o);return e.jsx(gc,{...y,...x,ref:u})});ri.displayName=rd;var na="AlertDialogContent",[nd,ld]=ed(na),id=lc("AlertDialogContent"),ni=n.forwardRef((l,u)=>{const{__scopeAlertDialog:o,children:x,...y}=l,v=ws(o),t=n.useRef(null),E=_l(u,t),T=n.useRef(null);return e.jsx(fc,{contentName:na,titleName:li,docsSlug:"alert-dialog",children:e.jsx(nd,{scope:o,cancelRef:T,children:e.jsxs(vc,{role:"alertdialog",...v,...y,ref:E,onOpenAutoFocus:nc(y.onOpenAutoFocus,g=>{var m;g.preventDefault(),(m=T.current)==null||m.focus({preventScroll:!0})}),onPointerDownOutside:g=>g.preventDefault(),onInteractOutside:g=>g.preventDefault(),children:[e.jsx(id,{children:x}),e.jsx(cd,{contentRef:t})]})})})});ni.displayName=na;var li="AlertDialogTitle",ii=n.forwardRef((l,u)=>{const{__scopeAlertDialog:o,...x}=l,y=ws(o);return e.jsx(bc,{...y,...x,ref:u})});ii.displayName=li;var oi="AlertDialogDescription",ci=n.forwardRef((l,u)=>{const{__scopeAlertDialog:o,...x}=l,y=ws(o);return e.jsx(yc,{...y,...x,ref:u})});ci.displayName=oi;var od="AlertDialogAction",di=n.forwardRef((l,u)=>{const{__scopeAlertDialog:o,...x}=l,y=ws(o);return e.jsx(Vl,{...y,...x,ref:u})});di.displayName=od;var mi="AlertDialogCancel",hi=n.forwardRef((l,u)=>{const{__scopeAlertDialog:o,...x}=l,{cancelRef:y}=ld(mi,o),v=ws(o),t=_l(u,y);return e.jsx(Vl,{...v,...x,ref:t})});hi.displayName=mi;var cd=({contentRef:l})=>{const u=`\`${na}\` requires a description for the component to be accessible for screen reader users.

You can add a description to the \`${na}\` by passing a \`${oi}\` component as a child, which also benefits sighted users by adding visible context to the dialog.

Alternatively, you can use your own component as a description by assigning it an \`id\` and passing the same value to the \`aria-describedby\` prop in \`${na}\`. If the description is confusing or duplicative for sighted users, you can use the \`@radix-ui/react-visually-hidden\` primitive as a wrapper around your description component.

For more information, see https://radix-ui.com/primitives/docs/components/alert-dialog`;return n.useEffect(()=>{var x;document.getElementById((x=l.current)==null?void 0:x.getAttribute("aria-describedby"))||console.warn(u)},[u,l]),null},dd=si,md=ai,ui=ri,xi=ni,pi=di,gi=hi,fi=ii,vi=ci;const hd=dd,ud=md,bi=n.forwardRef(({className:l,...u},o)=>e.jsx(ui,{className:Ks("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",l),...u,ref:o}));bi.displayName=ui.displayName;const yi=n.forwardRef(({className:l,...u},o)=>e.jsxs(ud,{children:[e.jsx(bi,{}),e.jsx(xi,{ref:o,className:Ks("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",l),...u})]}));yi.displayName=xi.displayName;const ji=({className:l,...u})=>e.jsx("div",{className:Ks("flex flex-col space-y-2 text-center sm:text-left",l),...u});ji.displayName="AlertDialogHeader";const Ni=n.forwardRef(({className:l,...u},o)=>e.jsx(fi,{ref:o,className:Ks("text-lg font-semibold",l),...u}));Ni.displayName=fi.displayName;const wi=n.forwardRef(({className:l,...u},o)=>e.jsx(vi,{ref:o,className:Ks("text-sm text-muted-foreground",l),...u}));wi.displayName=vi.displayName;const yn=n.forwardRef(({className:l,...u},o)=>e.jsx(pi,{ref:o,className:Ks(Jl(),l),...u}));yn.displayName=pi.displayName;const Si=n.forwardRef(({className:l,...u},o)=>e.jsx(gi,{ref:o,className:Ks(Jl({variant:"outline"}),"mt-2 sm:mt-0",l),...u}));Si.displayName=gi.displayName;const ze=l=>{try{return l.toLocaleString("en-US",{maximumFractionDigits:2})}catch{return String(l)}},Bl=l=>{try{return(l?new Date(l):new Date).toLocaleString("en-GB",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}catch{return new Date().toISOString()}},cr="machine_daily_opening_values",Ml="machine_daily_receipts",Ll="machine_daily_transfer_receipts",pn="machine_daily_opening_snapshot";function xd({open:l,onOpenChange:u}){const{toast:o}=hs(),{shiftUser:x}=Ta(),[y,v]=n.useState(""),[t,E]=n.useState(""),[T,g]=n.useState(""),[m,w]=n.useState(null),[b,B]=n.useState(null),[U,X]=n.useState(null),[M,I]=n.useState(null),[R,ee]=n.useState(!1),[$,C]=n.useState(!1),[_,Z]=n.useState(""),[re,ce]=n.useState(""),[J,V]=n.useState(null),[Ae,H]=n.useState(()=>{try{const O=localStorage.getItem(Ml),te=O?JSON.parse(O):[];return Array.isArray(te)?te:[]}catch{return[]}}),[le,Be]=n.useState(()=>{try{const O=localStorage.getItem(Ll),te=O?JSON.parse(O):[];return Array.isArray(te)?te:[]}catch{return[]}}),[Ge,kt]=n.useState(!1),[Je,Wt]=n.useState(""),[pt,Lt]=n.useState(""),[Qe,at]=n.useState(!1),[Me,gt]=n.useState(null);n.useEffect(()=>{if(l)try{const O=localStorage.getItem(cr);if(O){const z=JSON.parse(O);typeof(z==null?void 0:z.openingBase)=="number"&&w(z.openingBase),typeof(z==null?void 0:z.openingAir)=="number"&&B(z.openingAir),typeof(z==null?void 0:z.drawerCash)=="number"&&X(z.drawerCash)}const te=localStorage.getItem(pn);if(te){const z=JSON.parse(te);typeof(z==null?void 0:z.openingBase)=="number"&&typeof(z==null?void 0:z.openingAir)=="number"&&I({openingBase:z.openingBase,openingAir:z.openingAir,drawerCash:z.drawerCash||0})}}catch{}},[l]),n.useEffect(()=>{try{localStorage.setItem(Ml,JSON.stringify(Ae))}catch{}},[Ae]),n.useEffect(()=>{try{localStorage.setItem(Ll,JSON.stringify(le))}catch{}},[le]);const Pt=n.useMemo(()=>(x==null?void 0:x.displayName)||(x==null?void 0:x.name)||(x==null?void 0:x.username)||void 0,[x]),At=n.useMemo(()=>le.reduce((O,te)=>O+(te.profit||0),0),[le]),Yt=n.useMemo(()=>le.reduce((O,te)=>O+(te.wholesalePrice||0),0),[le]),Ue=()=>{le.length!==0&&(Be([]),o({title:"تم حذف الإيصالات",description:"تم مسح كل إيصالات التحويل."}))},ss=()=>{Ae.length!==0&&(H([]),o({title:"تم حذف الإيصالات",description:"تم مسح كل إيصالات الماكينة."}))},_t=O=>{H(te=>te.filter(z=>z.id!==O)),o({title:"تم حذف الإيصال",description:"تم إزالة إيصال الماكينة المحدد."})},as=()=>{w(null),B(null),X(null),I(null),v(""),E(""),g("");try{localStorage.removeItem(cr),localStorage.removeItem(pn)}catch{}o({title:"تم التصفير",description:"يمكنك الآن إدخال رصيد افتتاحي جديد."})},Ft=()=>{const O=parseFloat(y||"0"),te=parseFloat(t||"0"),z=parseFloat(T||"0");if(isNaN(O)||isNaN(te)||isNaN(z)){o({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة للرصيد الافتتاحي وفلوس الدرج.",variant:"destructive"});return}if(O<0||te<0||z<0){o({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}w(O),B(te),X(z);try{localStorage.setItem(cr,JSON.stringify({openingBase:O,openingAir:te,drawerCash:z})),localStorage.setItem(pn,JSON.stringify({openingBase:O,openingAir:te,drawerCash:z})),I({openingBase:O,openingAir:te,drawerCash:z})}catch{}o({title:"تم تسجيل البيانات",description:`الافتتاحي الأساسي: ${ze(O)}، الهواء: ${ze(te)}، فلوس الدرج: ${ze(z)}`})},A=()=>{if(m==null||b==null){o({title:"سجل الرصيد الافتتاحي أولاً",description:'يرجى الضغط على زر "إضافة" بعد إدخال الافتتاحي.'});return}C(!0)},se=()=>{const O=parseFloat(_||"0"),te=parseFloat(re||"0");if(isNaN(O)||isNaN(te)){o({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة لرصيد التسليم.",variant:"destructive"});return}if(O<0||te<0){o({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}const z=(M==null?void 0:M.openingBase)??(m||0),Ne=(M==null?void 0:M.openingAir)??(b||0),Le=z+Ne,Dt=O+te-Le;V(Dt);const zt={id:`${Date.now()}`,openingBase:z,openingAir:Ne,deliveryBase:O,deliveryAir:te,netResult:Dt,createdAt:new Date().toISOString(),cashierName:Pt,requiredDrawerNoProfit:Dt<0?Math.round(-Dt*100)/100:0};H(Re=>[zt,...Re]),o({title:"تم إنشاء إيصال تسليم",description:`الناتج النهائي: ${ze(Dt)}`})},pe=()=>{const O=parseFloat(Je||"0"),te=parseFloat(pt||"0");if(!Number.isFinite(O)||!Number.isFinite(te)){o({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة لسعر الجملة وسعر التجزئة.",variant:"destructive"});return}if(O<0||te<0){o({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}if(m==null||b==null){o({title:"سجل الرصيد الافتتاحي أولاً",description:'يرجى إدخال الرصيد الأساسي ورصيد الهواء ثم الضغط "إضافة".'});return}const z=Math.round((te-O)*100)/100;gt({wholesalePrice:O,retailPrice:te,profit:z}),at(!0)},ke=O=>{if(!Me)return;const te={id:`transfer_${Date.now()}`,wholesalePrice:Me.wholesalePrice,retailPrice:Me.retailPrice,profit:Me.profit,createdAt:new Date().toISOString(),cashierName:Pt,deductFrom:O},z=Me.wholesalePrice,Ne=m??0,Le=b??0,Ht=U??0;if(z>(O==="base"?Ne:Le)){o({title:"رصيد غير كافٍ",description:"لا يوجد رصيد كافٍ للخصم بسعر الجملة.",variant:"destructive"});return}const zt=O==="base"?Math.round((Ne-z)*100)/100:Ne,Re=O==="air"?Math.round((Le-z)*100)/100:Le,Nt=Math.round((Ht+Me.retailPrice)*100)/100;w(zt),B(Re),X(Nt);try{localStorage.setItem(cr,JSON.stringify({openingBase:zt,openingAir:Re,drawerCash:Nt}))}catch{}Be(it=>[te,...it]),kt(!1),Wt(""),Lt(""),gt(null),at(!1),o({title:"تم تسجيل تحويل",description:`الربح الفوري: ${ze(te.profit)} | خصم المخزون: -${ze(z)} (${O==="base"?"الأساسي":"الهواء"}) | درج: +${ze(Me.retailPrice)}`})},Oe=()=>{v(""),E(""),C(!1),Z(""),ce(""),V(null)},rt=O=>{O||Oe(),u(O)};return e.jsxs(me,{open:l,onOpenChange:rt,children:[e.jsxs(he,{className:"w-[92vw] sm:w-auto sm:max-w-2xl max-h-[85vh] overflow-y-auto",children:[e.jsxs(ue,{className:"space-y-2",children:[e.jsx(xe,{className:"flex items-center justify-between text-right",children:e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(ei,{className:"h-5 w-5 text-yellow-500"}),"يومية المكنة"]})}),e.jsx(Zt,{className:"text-right",children:'أدخل الرصيد الافتتاحي، ثم في نهاية اليوم قم بإدخال رصيد التسليم لإنشاء إيصال منظم باسم "إيصالات ماكينة".'})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-6",children:[e.jsxs(st,{children:[e.jsx(wt,{className:"pb-2",children:e.jsxs(Mt,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-right",children:"الرصيد الافتتاحي"}),e.jsx(d,{variant:"ghost",size:"sm",onClick:()=>ee(O=>!O),className:"flex items-center gap-1",children:e.jsx(Nn,{className:`h-4 w-4 transition-transform ${R?"rotate-180":""}`})})]})}),e.jsxs("div",{className:"flex items-center justify-between px-6",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(d,{variant:"outline",onClick:()=>kt(!0),disabled:m==null||b==null,className:"border-violet-300 text-violet-700",children:"تحويل"})}),m!=null&&b!=null&&e.jsxs(jt,{className:"bg-violet-100 text-violet-700 border border-violet-200",children:["تم التسجيل: أساسي ",ze(m)," | هواء ",ze(b)," | درج ",ze(U??0)]})]}),e.jsxs(nt,{className:`space-y-4 ${R?"":"hidden"}`,children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الرصيد الأساسي"}),e.jsx(L,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:y,onChange:O=>v(O.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"رصيد الهواء"}),e.jsx(L,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:t,onChange:O=>E(O.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"فلوس الدرج"}),e.jsx(L,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:T,onChange:O=>g(O.target.value),placeholder:"0.00",className:"text-right"})]})]}),e.jsxs("div",{className:"flex items-center justify-end",children:[e.jsx(d,{variant:"outline",className:"mr-2",onClick:as,children:"تصفير"}),e.jsx(d,{onClick:Ft,className:"bg-violet-600 hover:bg-violet-700",children:"إضافة"})]})]})]}),e.jsxs(st,{children:[e.jsx(wt,{className:"pb-2",children:e.jsxs(Mt,{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-right",children:"إيصالات تحويل"}),e.jsxs(jt,{className:"bg-green-100 text-green-700 border border-green-200",children:["ربح: ",ze(At)]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(d,{variant:"outline",size:"sm",onClick:Ue,className:"border-red-300 text-red-700 hover:bg-red-50",children:"حذف الإيصالات"}),e.jsx(mr,{className:"h-4 w-4 text-gray-500"})]})]})}),e.jsx(nt,{className:"space-y-3",children:le.length===0?e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد تحويلات مسجلة."}):e.jsx("div",{className:"space-y-3 max-h-52 overflow-y-auto pr-1",children:le.map(O=>e.jsxs("div",{className:"rounded-lg border p-3 grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"سعر الجملة"}),e.jsx("p",{className:"text-sm",children:ze(O.wholesalePrice)})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"سعر التجزئة"}),e.jsx("p",{className:"text-sm",children:ze(O.retailPrice)})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"الربح الفوري"}),e.jsx("p",{className:"text-sm text-green-700",children:ze(O.profit)}),O.deductFrom&&e.jsx("div",{className:"mt-1",children:e.jsxs("span",{className:"text-[11px] bg-violet-100 text-violet-700 border border-violet-200 rounded px-2 py-0.5",children:["الخصم من: ",O.deductFrom==="base"?"الأساسي":"الهواء"]})}),e.jsxs("div",{className:"flex items-center justify-end gap-2 text-xs text-gray-500",children:[e.jsx(ks,{className:"h-3 w-3"}),e.jsx("span",{children:Bl(O.createdAt)}),O.cashierName&&e.jsxs(e.Fragment,{children:[e.jsx(gn,{orientation:"vertical",className:"h-3"}),e.jsxs("span",{children:["الكاشير: ",O.cashierName]})]})]})]})]},O.id))})})]}),e.jsxs(st,{children:[e.jsx(wt,{className:"pb-2",children:e.jsx(Mt,{className:"text-right",children:"نهاية اليوم"})}),e.jsx(nt,{className:"space-y-4",children:$?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الرصيد الأساسي الحالي"}),e.jsx(L,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:_,onChange:O=>Z(O.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"رصيد الهواء الحالي"}),e.jsx(L,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:re,onChange:O=>ce(O.target.value),placeholder:"0.00",className:"text-right"})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(d,{variant:"secondary",onClick:()=>C(!1),children:"إلغاء"}),e.jsx(d,{onClick:se,className:"bg-green-600 hover:bg-green-700",children:"تسليم"})]}),J!=null&&e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{className:"text-right",children:e.jsxs(jt,{className:J>=0?"bg-green-100 text-green-700 border border-green-200":"bg-red-100 text-red-700 border border-red-200",children:["الناتج النهائي: ",ze(J)]})}),e.jsxs("div",{className:"mt-2 flex items-center justify-end gap-2",children:[e.jsxs(jt,{className:"bg-blue-100 text-blue-700 border border-blue-200",children:["المجموع النهائي: ",ze(parseFloat(_||"0")+parseFloat(re||"0"))]}),e.jsxs(jt,{className:"bg-amber-100 text-amber-700 border border-amber-200",children:["مطلوب من الدرج (بدون أرباح): ",ze(Yt)]})]})]})]}):e.jsx("div",{className:"flex justify-end",children:e.jsx(d,{variant:"outline",onClick:A,className:"border-violet-300 text-violet-700",children:"تسليم يومية"})})})]}),e.jsxs(st,{children:[e.jsx(wt,{className:"pb-2",children:e.jsxs(Mt,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-right",children:"إيصالات ماكينة"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(d,{variant:"outline",size:"sm",onClick:ss,className:"border-red-300 text-red-700 hover:bg-red-50",children:"حذف الإيصالات"}),e.jsx(mr,{className:"h-4 w-4 text-gray-500"})]})]})}),e.jsx(nt,{className:"space-y-3",children:Ae.length===0?e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد إيصالات حتى الآن."}):e.jsx("div",{className:"space-y-3",children:Ae.map(O=>e.jsxs("div",{className:"rounded-lg border p-3 grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"الافتتاحي"}),e.jsxs("p",{className:"text-sm",children:["أساسي: ",ze(O.openingBase)]}),e.jsxs("p",{className:"text-sm",children:["هواء: ",ze(O.openingAir)]})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"التسليم"}),e.jsxs("p",{className:"text-sm",children:["أساسي: ",ze(O.deliveryBase)]}),e.jsxs("p",{className:"text-sm",children:["هواء: ",ze(O.deliveryAir)]})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("div",{className:"flex items-center justify-end",children:e.jsxs(d,{variant:"outline",size:"sm",onClick:()=>_t(O.id),className:"border-red-300 text-red-700 hover:bg-red-50",children:[e.jsx(Ut,{className:"h-3 w-3 mr-1"})," حذف"]})}),e.jsx("p",{className:"text-xs text-gray-500",children:"النتيجة"}),e.jsx("p",{className:`text-sm ${O.netResult>=0?"text-green-700":"text-red-700"}`,children:ze(O.netResult)}),e.jsxs("div",{className:"mt-1 flex items-center justify-end gap-2",children:[e.jsxs("span",{className:"text-[11px] bg-blue-100 text-blue-700 border border-blue-200 rounded px-2 py-0.5",children:["المجموع النهائي: ",ze(O.deliveryBase+O.deliveryAir)]}),typeof O.requiredDrawerNoProfit=="number"&&e.jsxs("span",{className:"text-[11px] bg-amber-100 text-amber-700 border border-amber-200 rounded px-2 py-0.5",children:["مطلوب من الدرج (بدون أرباح): ",ze(O.requiredDrawerNoProfit||0)]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2 text-xs text-gray-500",children:[e.jsx(ks,{className:"h-3 w-3"}),e.jsx("span",{children:Bl(O.createdAt)}),O.cashierName&&e.jsxs(e.Fragment,{children:[e.jsx(gn,{orientation:"vertical",className:"h-3"}),e.jsxs("span",{children:["الكاشير: ",O.cashierName]})]})]})]})]},O.id))})})]})]}),e.jsxs(Pe,{className:"flex items-center justify-between",children:[e.jsx(d,{variant:"outline",onClick:()=>rt(!1),children:"إغلاق"}),e.jsxs("div",{className:"text-xs text-gray-500 flex items-center gap-1",children:[e.jsx(zs,{className:"h-3 w-3"}),e.jsx("span",{children:"يسجل التاريخ والوقت تلقائياً لكل إيصال"})]})]})]}),e.jsx(me,{open:Ge,onOpenChange:kt,children:e.jsxs(he,{className:"sm:max-w-sm",children:[e.jsx(ue,{children:e.jsx(xe,{children:"تحويل رصيد"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"سعر الجملة"}),e.jsx(L,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:Je,onChange:O=>Wt(O.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"سعر التجزئة"}),e.jsx(L,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:pt,onChange:O=>Lt(O.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsx("div",{className:"text-right",children:e.jsxs(jt,{className:"bg-green-100 text-green-700 border border-green-200",children:["الربح الفوري: ",ze(parseFloat(pt||"0")-parseFloat(Je||"0")||0)]})})]}),e.jsxs(Pe,{className:"flex items-center justify-end gap-2",children:[e.jsx(d,{variant:"secondary",onClick:()=>kt(!1),children:"إلغاء"}),e.jsx(d,{onClick:pe,className:"bg-violet-600 hover:bg-violet-700",children:"تحويل"})]})]})}),e.jsx(hd,{open:Qe,onOpenChange:at,children:e.jsxs(yi,{children:[e.jsxs(ji,{children:[e.jsx(Ni,{children:"اختيار مصدر الخصم"}),e.jsx(wi,{children:"هل يتم الخصم من الرصيد الأساسي أم من رصيد الهواء؟"})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2 mt-4",children:[e.jsx(Si,{onClick:()=>at(!1),children:"رجوع"}),e.jsx(yn,{onClick:()=>ke("base"),children:"خصم من الأساسي"}),e.jsx(yn,{onClick:()=>ke("air"),children:"خصم من الهواء"})]})]})})]})}function pd(l,u=300){const[o,x]=tt.useState(l);return tt.useEffect(()=>{const y=setTimeout(()=>x(l),u);return()=>clearTimeout(y)},[l,u]),o}const gd=({userId:l,transactions:u})=>{const[o,x]=n.useState(!1),[y,v]=n.useState(!1),[t,E]=n.useState(!1),[T,g]=n.useState({monthlyWithdrawalProfit:0,monthlyTransferProfit:0,lastUpdated:new Date}),{userSubscription:m}=Ps();n.useEffect(()=>{l&&o&&t&&w()},[l,o,t]);const w=async()=>{if(l)try{if(Array.isArray(u)&&u.length>0){const I=new Date,R=I.getMonth(),ee=I.getFullYear(),$=Rt.filterVisibleTransactions(u,"monthly",l);let C=0,_=0;$.forEach(Z=>{const re=new Date(Z.createdAt),ce=String(Z.status||"confirmed").toLowerCase();if(re.getMonth()!==R||re.getFullYear()!==ee||ce!=="completed"&&ce!=="confirmed")return;const J=(Z.type||Z.txnType||"").toLowerCase(),V={type:J==="withdrawal"?"withdraw":J,amount:Number(Z.amount||0),commission:Z.commission};V.type==="withdraw"?C+=ts.calculateProfitFromTransaction(V):(V.type==="send"||V.type==="receive"||V.type==="transfer")&&(_+=ts.calculateProfitFromTransaction(V))}),g({monthlyWithdrawalProfit:Math.round(C*100)/100,monthlyTransferProfit:Math.round(_*100)/100,lastUpdated:new Date});return}const M=ts.getWithdrawTransferProfits(l);g({monthlyWithdrawalProfit:M.monthlyWithdrawProfit||0,monthlyTransferProfit:M.monthlyTransferProfit||0,lastUpdated:new Date})}catch(M){console.error("Error loading profit data:",M)}},b=M=>`${M.toFixed(2)} ج.م`,B=async()=>{try{const M=(m==null?void 0:m.subscription)||null,I=(M==null?void 0:M.planType)??(M==null?void 0:M.plan)??null,R=typeof I=="string"?I.toLowerCase():null;if(I===ys.ZERO||R==="zero"||R==="0"||I===0)return!0}catch{}try{if(l){const M=await jn(l),I=(M==null?void 0:M.planType)??(M==null?void 0:M.plan)??null,R=typeof I=="string"?I.toLowerCase():null;if(I===ys.ZERO||R==="zero"||R==="0"||I===0)return!0}}catch{}return!1},U=async()=>{try{if(await B()){Pl({title:"الخطة زيرو",description:"عرض الأرباح الشهرية غير متاح في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}catch{}v(!0)},X=async()=>{try{if(await B()){Pl({title:"الخطة زيرو",description:"عرض الأرباح الشهرية غير متاح في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"}),v(!1);return}}catch{}E(!0),x(!0),v(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(d,{size:"sm",variant:"ghost",onClick:U,className:"h-2 w-2 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded transition-all duration-300 hover:scale-110 shadow-sm hover:shadow-md",title:"عرض الأرباح الشهرية",children:e.jsx(Ve,{className:"h-1.5 w-1.5"})}),e.jsx(me,{open:o,onOpenChange:x,children:e.jsxs(he,{className:"max-w-[220px] mx-auto bg-white border border-gray-200 shadow-md rounded sm:max-w-[180px] sm:bg-gradient-to-br sm:from-purple-50 sm:to-white sm:border-2 sm:border-purple-200 sm:shadow-2xl sm:rounded-2xl",children:[e.jsx(ue,{className:"text-center pb-0 border-b-0 sm:pb-2 sm:border-b sm:border-purple-200",children:e.jsxs(xe,{className:"text-xs font-bold text-purple-800 flex items-center justify-center gap-0 mb-0 leading-tight tracking-tight sm:text-xs sm:gap-1 sm:mb-0 sm:leading-normal sm:tracking-normal",children:[e.jsx(ks,{className:"h-2 w-2 text-purple-600 sm:h-3 sm:w-3"}),"شهري"]})}),e.jsxs("div",{className:"space-y-0 py-0 sm:space-y-2 sm:py-2",children:[e.jsx("div",{className:"bg-yellow-50 p-0.5 rounded border border-yellow-200 sm:bg-gradient-to-r sm:from-yellow-50 sm:to-yellow-100 sm:p-2 sm:rounded-xl sm:shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-[10px] sm:text-xs font-semibold text-yellow-900",children:"أرباح فوري"}),e.jsx("span",{className:"text-[10px] sm:text-xs font-bold text-yellow-900",children:b((T.monthlyWithdrawalProfit??0)+(T.monthlyTransferProfit??0))})]})}),e.jsx("div",{className:"bg-red-50 p-0.5 rounded border border-red-200 sm:bg-gradient-to-r sm:from-red-50 sm:to-red-100 sm:p-2 sm:rounded-xl sm:shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1 sm:gap-2",children:[e.jsx(xr,{className:"h-2 w-2 text-red-600 sm:h-3 sm:w-3"}),e.jsx("span",{className:"text-[10px] sm:text-xs",children:"سحب"})]}),e.jsx("span",{className:"text-[10px] sm:text-xs font-bold text-red-700",children:b(T.monthlyWithdrawalProfit)})]})}),e.jsx("div",{className:"bg-blue-50 p-0.5 rounded border border-blue-200 sm:bg-gradient-to-r sm:from-blue-50 sm:to-blue-100 sm:p-2 sm:rounded-xl sm:shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1 sm:gap-2",children:[e.jsx(Xl,{className:"h-2 w-2 text-blue-600 sm:h-3 sm:w-3"}),e.jsx("span",{className:"text-[10px] sm:text-xs",children:"تحويل"})]}),e.jsx("span",{className:"text-[10px] sm:text-xs font-bold text-blue-700",children:b(T.monthlyTransferProfit)})]})}),e.jsx("div",{className:"bg-purple-50 p-0.5 rounded border border-purple-200 sm:bg-gradient-to-r sm:from-purple-50 sm:to-purple-100 sm:p-2 sm:rounded-xl sm:shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1 sm:gap-2",children:[e.jsx(lt,{className:"h-2 w-2 text-purple-600 sm:h-3 sm:w-3"}),e.jsx("span",{className:"text-[10px] sm:text-xs",children:"إجمالي"})]}),e.jsx("span",{className:"text-[10px] sm:text-xs font-bold text-purple-700",children:b(T.monthlyWithdrawalProfit+T.monthlyTransferProfit)})]})})]}),!t&&e.jsx("div",{className:"absolute inset-0 bg-yellow-200/70 backdrop-blur-sm flex items-center justify-center rounded sm:rounded-2xl border border-yellow-300 pointer-events-auto",children:e.jsx(d,{size:"sm",variant:"ghost",onClick:()=>v(!0),className:"p-2 bg-yellow-300/80 text-yellow-900 hover:bg-yellow-400/90 rounded-full shadow-sm hover:shadow-md transition-all duration-300",title:"إدخال الرقم السري الرئيسي",children:e.jsx(Ve,{className:"h-4 w-4"})})}),e.jsx("div",{className:"flex justify-center pt-0 border-t-0 sm:pt-2 sm:border-t sm:border-purple-200",children:e.jsx(d,{onClick:()=>x(!1),className:"bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-xl text-sm sm:bg-gradient-to-r sm:from-purple-600 sm:to-purple-700 sm:hover:from-purple-700 sm:hover:to-purple-800 sm:px-4 sm:py-1 sm:rounded-xl sm:shadow-lg sm:hover:shadow-xl sm:transition-all sm:duration-300",children:"إغلاق"})})]})}),e.jsx(es,{open:y,onOpenChange:v,onSuccess:X,description:"لا يمكن الاطلاع على الأرباح الشهرية إلا بإدخال الرقم السري الرئيسي"})]})},fd=l=>e.jsx(gd,{...l});function vd({open:l,onOpenChange:u,onSuccess:o,userId:x}){const[y,v]=n.useState(""),[t,E]=n.useState(""),[T,g]=n.useState(!1),[m,w]=n.useState(!1),[b,B]=n.useState(""),[U,X]=n.useState(!1),{toast:M}=hs(),I=ts.hasProfitPin(x),R=()=>{v(""),E(""),B(""),g(!1),w(!1),u(!1)},ee=async $=>{$.preventDefault(),B(""),X(!0);try{if(I){if(!ts.verifyProfitPin(y,x)){B("الرقم السري غير صحيح"),X(!1);return}}else{if(y.length<4){B("يجب أن يكون الرقم السري 4 أرقام على الأقل"),X(!1);return}if(y!==t){B("الرقم السري غير متطابق"),X(!1);return}ts.setProfitPin(y,x)}M({title:"نجح العملية",description:I?"تم التحقق من الرقم السري بنجاح":"تم إنشاء رقم سري الأرباح بنجاح"}),o(),R()}catch{B("حدث خطأ أثناء معالجة الرقم السري")}finally{X(!1)}};return e.jsx(me,{open:l,onOpenChange:u,children:e.jsxs(he,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ue,{children:e.jsxs(xe,{className:"flex items-center gap-2 text-lg font-semibold",children:[e.jsx(Js,{className:"h-5 w-5 text-green-600"}),I?"أدخل رقم سري الأرباح":"إنشاء رقم سري للأرباح"]})}),e.jsxs("form",{onSubmit:ee,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-gray-600 bg-blue-50 p-3 rounded-lg",children:I?"أدخل الرقم السري لعرض بيانات الأرباح":"قم بإنشاء رقم سري لحماية بيانات الأرباح. يمكنك تغييره لاحقاً من إعدادات البروفيل."}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"pin",children:I?"الرقم السري":"الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(L,{id:"pin",type:T?"text":"password",value:y,onChange:$=>v($.target.value),placeholder:I?"أدخل الرقم السري":"أدخل رقم سري جديد (4 أرقام على الأقل)",className:"pr-10",dir:"ltr",autoComplete:"off",required:!0}),e.jsx(d,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>g(!T),children:T?e.jsx(St,{className:"h-4 w-4"}):e.jsx(Ve,{className:"h-4 w-4"})})]})]}),!I&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"confirmPin",children:"تأكيد الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(L,{id:"confirmPin",type:m?"text":"password",value:t,onChange:$=>E($.target.value),placeholder:"أعد إدخال الرقم السري",className:"pr-10",dir:"ltr",autoComplete:"off",required:!0}),e.jsx(d,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>w(!m),children:m?e.jsx(St,{className:"h-4 w-4"}):e.jsx(Ve,{className:"h-4 w-4"})})]})]}),b&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(qs,{className:"h-4 w-4"}),b]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(d,{type:"submit",disabled:U,className:"flex-1 bg-green-600 hover:bg-green-700",children:[e.jsx(Js,{className:"h-4 w-4 mr-2"}),U?"جاري المعالجة...":I?"عرض الأرباح":"إنشاء وعرض الأرباح"]}),e.jsx(d,{type:"button",variant:"outline",onClick:R,disabled:U,children:"إلغاء"})]})]})]})})}const bd=({userId:l,transactions:u})=>{const[o,x]=n.useState(!1),[y,v]=n.useState(!1),[t,E]=n.useState(!1),[T,g]=n.useState({dailyWithdrawalProfit:0,dailyTransferProfit:0,lastUpdated:new Date});n.useEffect(()=>{l&&o&&t&&m()},[l,o,t]);const m=async()=>{if(l)try{if(Array.isArray(u)&&u.length>0){const X=new Date,M=Rt.filterVisibleTransactions(u,"daily",l);let I=0,R=0;M.forEach(ee=>{const $=new Date(ee.createdAt),C=String(ee.status||"confirmed").toLowerCase();if($.toDateString()!==X.toDateString()||C!=="completed"&&C!=="confirmed")return;const _=(ee.type||ee.txnType||"").toLowerCase(),Z={type:_==="withdrawal"?"withdraw":_,amount:Number(ee.amount||0),commission:ee.commission};Z.type==="withdraw"?I+=ts.calculateProfitFromTransaction(Z):(Z.type==="send"||Z.type==="receive"||Z.type==="transfer")&&(R+=ts.calculateProfitFromTransaction(Z))}),g({dailyWithdrawalProfit:Math.round(I*100)/100,dailyTransferProfit:Math.round(R*100)/100,lastUpdated:new Date});try{ts.updateProfitsFromTransactions(u,l)}catch{}return}const U=ts.getWithdrawTransferProfits(l);g({dailyWithdrawalProfit:U.dailyWithdrawProfit||0,dailyTransferProfit:U.dailyTransferProfit||0,lastUpdated:new Date})}catch(U){console.error("Error loading profit data:",U)}},w=U=>`${U.toFixed(2)} ج.م`,b=()=>{ts.hasProfitPin(l),v(!0)},B=()=>{E(!0),x(!0),v(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(d,{size:"sm",variant:"ghost",onClick:b,className:"h-2 w-2 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded transition-all duration-300 hover:scale-110 shadow-sm hover:shadow-md",title:"عرض الأرباح اليومية",children:e.jsx(Ve,{className:"h-1.5 w-1.5"})}),e.jsx(me,{open:o,onOpenChange:x,children:e.jsxs(he,{className:"max-w-[220px] mx-auto bg-white border border-gray-200 shadow-md rounded sm:max-w-[180px] sm:bg-gradient-to-br sm:from-blue-50 sm:to-white sm:border-2 sm:border-blue-200 sm:shadow-2xl sm:rounded-2xl",children:[e.jsx(ue,{className:"text-center pb-0 border-b-0 sm:pb-2 sm:border-b sm:border-blue-200",children:e.jsxs(xe,{className:"text-xs font-bold text-blue-800 flex items-center justify-center gap-0 mb-0 leading-tight tracking-tight sm:text-sm sm:gap-1 sm:mb-0 sm:leading-normal sm:tracking-normal",children:[e.jsx(lt,{className:"h-2 w-2 text-blue-600 sm:h-3 sm:w-3"}),"يومي"]})}),e.jsxs("div",{className:"space-y-0 py-0 sm:space-y-4 sm:py-4",children:[e.jsx("div",{className:"bg-yellow-50 p-2 rounded border border-yellow-200 sm:bg-gradient-to-r sm:from-yellow-50 sm:to-yellow-100 sm:p-4 sm:rounded-xl sm:shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-0 sm:gap-2",children:[e.jsx(lt,{className:"h-3 w-3 text-yellow-600 sm:h-5 sm:w-5"}),e.jsx("span",{className:"font-medium text-yellow-800 text-xs sm:text-base",children:"أرباح فوري"})]}),e.jsx("span",{className:"font-bold text-sm text-yellow-900 bg-white px-0 py-0.5 rounded text-center sm:text-lg sm:px-3 sm:py-1",children:w((T.dailyWithdrawalProfit??0)+(T.dailyTransferProfit??0))})]})}),e.jsx("div",{className:"bg-red-50 p-2 rounded border border-red-200 sm:bg-gradient-to-r sm:from-red-50 sm:to-red-100 sm:p-4 sm:rounded-xl sm:shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-0 sm:gap-2",children:[e.jsx(xr,{className:"h-3 w-3 text-red-600 sm:h-5 sm:w-5"}),e.jsx("span",{className:"font-medium text-red-800 text-xs sm:text-base",children:"سحب"})]}),e.jsx("span",{className:"font-bold text-sm text-red-900 bg-white px-0 py-0.5 rounded text-center sm:text-lg sm:px-3 sm:py-1",children:w(T.dailyWithdrawalProfit)})]})}),e.jsx("div",{className:"bg-green-50 p-0.5 rounded border border-green-200 sm:bg-gradient-to-r sm:from-green-50 sm:to-green-100 sm:p-2 sm:rounded-xl sm:shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between h-4 sm:h-auto",children:[e.jsxs("div",{className:"flex items-center gap-0 sm:gap-1",children:[e.jsx(Xl,{className:"h-2 w-2 text-green-600 sm:h-3 sm:w-3"}),e.jsx("span",{className:"font-medium text-green-800 text-xs leading-tight tracking-tighter sm:font-semibold sm:text-xs sm:leading-normal sm:tracking-normal",children:"تحويل"})]}),e.jsx("span",{className:"font-bold text-xs text-green-900 bg-white px-0 py-0 rounded text-center leading-tight tracking-tighter sm:text-sm sm:px-2 sm:py-0.5 sm:leading-normal sm:tracking-normal",children:w(T.dailyTransferProfit)})]})}),e.jsx("div",{className:"bg-blue-50 p-0.5 rounded border border-blue-200 sm:bg-gradient-to-r sm:from-blue-50 sm:to-blue-100 sm:p-2 sm:rounded-xl sm:shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between h-4 sm:h-auto",children:[e.jsxs("div",{className:"flex items-center gap-0 sm:gap-1",children:[e.jsx(lt,{className:"h-2 w-2 text-blue-600 sm:h-3 sm:w-3"}),e.jsx("span",{className:"font-medium text-blue-800 text-xs leading-tight tracking-tighter sm:font-semibold sm:text-xs sm:leading-normal sm:tracking-normal",children:"مجموع"})]}),e.jsx("span",{className:"font-bold text-xs text-blue-900 bg-white px-0 py-0 rounded text-center leading-tight tracking-tighter sm:text-sm sm:px-2 sm:py-0.5 sm:leading-normal sm:tracking-normal",children:w(T.dailyWithdrawalProfit+T.dailyTransferProfit)})]})})]}),e.jsx("div",{className:"flex justify-center pt-0 border-t-0 sm:pt-2 sm:border-t sm:border-blue-200",children:e.jsx(d,{onClick:()=>x(!1),className:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-xl text-sm sm:bg-gradient-to-r sm:from-blue-600 sm:to-blue-700 sm:hover:from-blue-700 sm:hover:to-blue-800 sm:px-4 sm:py-1 sm:rounded-xl sm:shadow-lg sm:hover:shadow-xl sm:transition-all sm:duration-300 sm:text-xs",children:"إغلاق"})})]})}),e.jsx(vd,{open:y,onOpenChange:v,onSuccess:B,userId:l})]})},yd=l=>e.jsx(bd,{...l}),dr=l=>Number(l||0).toFixed(2),jd=({open:l,onOpenChange:u,userId:o})=>{const{toast:x}=hs(),[y,v]=tt.useState([]),[t,E]=tt.useState(!1),[T,g]=tt.useState("");tt.useEffect(()=>{(async()=>{if(!(!l||!o))try{E(!0);const B=[...await zl.getByUser(o)].sort((U,X)=>U.reportDate<X.reportDate?1:-1);v(B)}catch(b){console.error("Failed to load daily archive history:",b),x({title:"فشل تحميل الأرشيف",description:"تعذر تحميل أرشيف التقارير اليومية",variant:"destructive"})}finally{E(!1)}})()},[l,o]);const m=tt.useMemo(()=>{if(!T)return y;const w=T.trim();return y.filter(b=>b.reportDate.includes(w))},[y,T]);return e.jsx(me,{open:l,onOpenChange:u,children:e.jsxs(he,{className:"sm:max-w-xl",children:[e.jsxs(ue,{children:[e.jsx(xe,{children:"أرشيف التقارير اليومية"}),e.jsx(Zt,{children:"يعرض جميع الأيام المؤرشفة مع ملخص لكل يوم."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"archive-search",children:"بحث بالتاريخ (YYYY-MM-DD)"}),e.jsx(L,{id:"archive-search",placeholder:"مثال: 2025-10-19",value:T,onChange:w=>g(w.target.value)})]}),e.jsx("div",{className:"mt-3 space-y-2 max-h-[50vh] overflow-auto",children:t?e.jsx("div",{className:"text-sm text-muted-foreground",children:"جاري التحميل..."}):m.length===0?e.jsx("div",{className:"text-sm text-muted-foreground",children:"لا توجد تقارير مؤرشفة حتى الآن"}):m.map(w=>e.jsxs("div",{className:"border rounded-md p-2 bg-gradient-to-r from-white/80 to-blue-50/70",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{className:"font-bold text-blue-800",children:w.reportDate}),e.jsxs("div",{className:"text-xs text-blue-700",children:["عدد المعاملات: ",w.totalTransactions]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-1",children:[e.jsxs("div",{className:"text-xs text-blue-800",children:["إجمالي المبالغ: ",e.jsx("span",{className:"font-semibold",children:dr(w.totalAmount)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["المسحوب: ",e.jsx("span",{className:"font-semibold",children:dr(w.totalWithdrawn)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["المرسل: ",e.jsx("span",{className:"font-semibold",children:dr(w.totalSent)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["الربح: ",e.jsx("span",{className:"font-semibold",children:dr(w.profit)})]})]})]},w.id||`${w.userId}-${w.reportDate}`))}),e.jsx(Pe,{children:e.jsx(d,{variant:"outline",onClick:()=>u(!1),children:"إغلاق"})})]})})},Nd=({open:l,onOpenChange:u})=>{var Vs;const{shiftUser:o,isShiftActive:x,shiftStartAt:y,setShiftUser:v,startShift:t,endShift:E}=Ta(),{userSubscription:T,user:g,signIn:m,profile:w}=Ps(),{toast:b}=hs(),[B,U]=n.useState((o==null?void 0:o.name)||""),[X,M]=n.useState((o==null?void 0:o.username)||""),[I,R]=n.useState(""),[ee,$]=n.useState(!1),[C,_]=n.useState(null),[Z,re]=n.useState(""),[ce,J]=n.useState("");n.useState(!1);const[V,Ae]=n.useState(null),[H,le]=n.useState(""),[Be,Ge]=n.useState(""),[kt,Je]=n.useState(!1),[Wt,pt]=n.useState(!1),[Lt,Qe]=n.useState({totalTransfers:0,totalWithdrawals:0}),[at,Me]=n.useState(null),[gt,Pt]=n.useState(""),[At,Yt]=n.useState(""),[Ue,ss]=n.useState(0),[_t,as]=n.useState({}),[Ft,A]=n.useState(0),[se,pe]=n.useState(0),[ke,Oe]=n.useState({}),[rt,O]=n.useState(""),[te,z]=n.useState(!1),[Ne,Le]=n.useState(()=>{try{const F=localStorage.getItem("cashierUsers");return F?JSON.parse(F):[]}catch{return[]}}),Ht=(Vs=T==null?void 0:T.subscription)==null?void 0:Vs.planType,Dt=Ht==="yearly"?2:Ht==="lifetime"?4:Number.POSITIVE_INFINITY;n.useEffect(()=>{try{localStorage.setItem("cashierUsers",JSON.stringify(Ne))}catch{}},[Ne]);const[zt,Re]=n.useState(!1),[Nt,it]=n.useState(""),[h,P]=n.useState(null),[K,de]=n.useState([]),[ne,_e]=n.useState(!1),[Ie,$e]=n.useState(null),[Fe,ot]=n.useState(!1),[mt,Ke]=n.useState(!1),us=F=>{const ge=(o==null?void 0:o.username)===F;let ft=!1;try{ft=localStorage.getItem("lastHandoverToAdmin")==="true"}catch{}if(ge&&!(ge&&!x&&(rt==="الأدمن الرئيسي"||ft))){b({title:"لا يمكن الحذف",description:"لا يمكنك حذف مستخدم الوردية أثناء كونها نشطة أو قبل تسليمها للأدمن الرئيسي"});return}const He=`هل أنت متأكد من حذف المستخدم ${F}؟

هذا الإجراء لا يمكن التراجع عنه.`;window.confirm(He)&&(Le(Ct=>Ct.filter(Ys=>Ys.username!==F)),ge&&v(null),b({title:"تم حذف المستخدم",description:F}))},Ye=()=>{if(!B.trim()||!X.trim()||!I.trim())return;if(Ne.length>=Dt){b({title:"وصلت الحد الأقصى للمستخدمين",description:`هذه الباقة تسمح بإضافة ${Number.isFinite(Dt)?Dt:"عدد غير محدود"} كاشير فقط`,variant:"destructive"});return}const F={name:B.trim(),username:X.trim(),password:I.trim()};Le(ge=>[F,...ge]),U(""),M(""),R("")},rs=()=>{$(!0),_(null),Ae(null),le(""),Ge("")},la=async()=>{try{let F=[];try{g!=null&&g.uid&&(F=await Ce.getUserTransactions(g.uid))}catch{}if(!F||F.length===0)try{const we=await Uc({merchantUserId:g==null?void 0:g.uid,limit:200});F=(we==null?void 0:we.transactions)||[]}catch{}const ge=y?new Date(y):null,ft=new Date,Te=we=>{const ie=we.type,Gt=we.txnType;return ie==="withdraw"||ie==="withdrawal"||ie==="receive"||Gt==="receive"},Jt=we=>{const ie=we.type,Gt=we.txnType;return ie==="send"||ie==="transfer"||Gt==="send"},He=we=>{if(!we)return null;if(we instanceof Date)return we;try{const ie=new Date(we);return Number.isNaN(ie.getTime())?null:ie}catch{return null}},Ct=we=>{const ie=He(we.createdAt||we.created_at||we.timestamp);return!ie||ge&&ie<ge?!1:ie<=ft},Ys=we=>we==="completed"||we==="confirmed",ka=F.filter(we=>Ys(we.status)&&Ct(we)),ns=ka.filter(we=>Te(we)).reduce((we,ie)=>{const Gt=ie.withdrawnAmount??ie.receivedAmount??ie.amount??0;return we+(Number(Gt)||0)},0);return{totalTransfers:ka.filter(we=>Jt(we)).reduce((we,ie)=>{const Gt=ie.sentAmount??ie.transferredAmount??ie.amount??0;return we+(Number(Gt)||0)},0),totalWithdrawals:ns}}catch{return{totalTransfers:0,totalWithdrawals:0}}};n.useEffect(()=>{if(Wt){try{const F=localStorage.getItem("shiftInitialReceivedDrawerFunds");F!==null&&Yt(F)}catch{}try{const F=localStorage.getItem("shiftInitialReceivedWalletBalancesTotal");if(F!==null){const ge=parseFloat(F);ss(Number.isFinite(ge)?ge:0)}}catch{}}},[Wt]),n.useEffect(()=>{if(!l&&!ne)return;(async()=>{try{const ft=((g!=null&&g.uid?await Ce.getUserTransactions(g.uid):[])||[]).filter(Te=>(Te==null?void 0:Te.type)==="report"||((Te==null?void 0:Te.title)||"").includes("إيصال تسليم وردية"));ft.sort((Te,Jt)=>{const He=new Date(Te.createdAt||0).getTime();return new Date(Jt.createdAt||0).getTime()-He}),de(ft)}catch{de([])}})()},[l,Wt,ne,g==null?void 0:g.uid]);const As=async(F,ge,ft)=>{try{let Te=0,Jt=0;try{const Ct=parseFloat(localStorage.getItem("shiftInitialReceivedDrawerFunds")||"0");Te=Number.isFinite(Ct)?Ct:0}catch{}try{const Ct=parseFloat(localStorage.getItem("shiftInitialReceivedWalletBalancesTotal")||"0");Jt=Number.isFinite(Ct)?Ct:0}catch{}const He={id:`shift_receipt_${Date.now()}`,type:"report",senderPhone:(o==null?void 0:o.username)||"cashier",receiverPhone:rt||"admin",amount:0,status:"completed",createdAt:new Date().toISOString(),title:"إيصال تسليم وردية",cashierName:(o==null?void 0:o.name)||(o==null?void 0:o.username)||null,deficit:ge,deficitAmount:ge?ft:0,shiftStartAt:y,receivedDrawerFunds:Te,receivedWalletBalancesTotal:Jt,receivedWalletBalances:_t,deliveredDrawerFunds:Ft||0,deliveredWalletBalancesTotal:se||0,deliveredWalletBalances:ke,shiftProfit:Math.round(((Ft||0)+(se||0)-(Te+Jt))*100)/100};g!=null&&g.uid&&await Ce.saveUserTransaction(g.uid,He),de(Ct=>[He,...Ct||[]])}catch{}};return e.jsxs(e.Fragment,{children:[e.jsx(me,{open:l,onOpenChange:u,children:e.jsxs(he,{className:"sm:max-w-md",children:[e.jsx(ue,{children:e.jsx(xe,{children:x?"تسليم الورديه والخروج":"إضافة مستخدم وردية"})}),x?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsx("div",{className:"text-sm",children:"المستخدم الحالي للوردية:"}),e.jsxs("div",{className:"font-semibold text-sm",children:[o==null?void 0:o.name," (",o==null?void 0:o.username,")"]})]}),e.jsx("div",{className:"text-xs text-gray-600",children:'لإنهاء الوردية والخروج، اضغط "تسليم الورديه والخروج" وسيُطلب الرقم السري.'})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-xs text-gray-600",children:'لاستكمال إضافة مستخدم جديد اضغط الزر أسفل "إضافة مستخدم جديد" لفتح النموذج.'}),Ne.length>0&&e.jsxs("div",{className:"mt-4 border-t pt-3",children:[e.jsx("div",{className:"text-sm font-medium mb-2",children:"المستخدمون المسجلون"}),e.jsx("div",{className:"space-y-2 max-h-48 overflow-auto",children:Ne.map((F,ge)=>e.jsxs("div",{className:"flex items-center justify-between rounded border px-3 py-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:F.name}),e.jsx("div",{className:"text-xs text-gray-500",children:F.username})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(d,{size:"sm",className:"w-full sm:w-auto",onClick:()=>{P(F),Re(!0)},children:"دخول"}),e.jsx(d,{size:"sm",className:"w-full sm:w-auto",variant:"destructive",onClick:()=>us(F.username),children:"حذف"})]})]},ge))})]})]}),e.jsx(Pe,{className:"flex flex-wrap gap-2 justify-between",children:x?e.jsx("div",{className:"flex flex-wrap gap-2",children:e.jsx(d,{className:"w-full sm:w-auto",variant:"destructive",onClick:rs,children:"تسليم الورديه والخروج"})}):e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(d,{className:"w-full sm:w-auto",onClick:()=>Ke(!0),children:"إضافة مستخدم جديد"}),e.jsx(d,{className:"w-full sm:w-auto",variant:"outline",onClick:()=>_e(!0),children:"إيصالات التسليم"})]})})]})}),e.jsx(me,{open:mt,onOpenChange:Ke,children:e.jsxs(he,{className:"sm:max-w-md",children:[e.jsx(ue,{children:e.jsx(xe,{children:"إضافة مستخدم جديد"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(q,{className:"mb-1 block",children:"الاسم"}),e.jsx(L,{value:B,onChange:F=>U(F.target.value),placeholder:"أدخل الاسم"})]}),e.jsxs("div",{children:[e.jsx(q,{className:"mb-1 block",children:"اسم المستخدم"}),e.jsx(L,{value:X,onChange:F=>M(F.target.value),placeholder:"أدخل اسم المستخدم"})]}),e.jsxs("div",{children:[e.jsx(q,{className:"mb-1 block",children:"الرقم السري"}),e.jsx(L,{type:"password",autoComplete:"new-password",value:I,onChange:F=>R(F.target.value),placeholder:"أدخل الرقم السري"})]}),e.jsx("div",{className:"text-xs text-gray-500",children:"المستخدم يمكنه: التحويل، السحب، اختيار المحفظة فقط."})]}),e.jsxs(Pe,{className:"flex gap-2 justify-between",children:[e.jsx(d,{variant:"secondary",onClick:()=>{Ke(!1)},children:"إلغاء"}),e.jsx(d,{onClick:()=>{!B.trim()||!X.trim()||!I.trim()||(Ye(),Ke(!1))},children:"حفظ المستخدم"})]})]})}),e.jsx(me,{open:ne,onOpenChange:_e,children:e.jsxs(he,{className:"sm:max-w-lg",children:[e.jsx(ue,{children:e.jsx(xe,{children:"إيصالات التسليم"})}),K.length===0?e.jsx("div",{className:"text-xs text-gray-600",children:"لا توجد إيصالات تسليم محفوظة بعد."}):e.jsx("div",{className:"space-y-2 max-h-[60vh] overflow-auto",children:K.map(F=>e.jsxs("div",{className:"rounded border px-3 py-2 cursor-pointer hover:bg-gray-50",onClick:()=>{$e(F),ot(!0)},children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm font-semibold",children:new Date(F.createdAt).toLocaleString("ar-EG")}),e.jsxs("div",{className:"text-xs text-gray-500",children:["إلى: ",F.receiverPhone]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-1",children:[e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مسلّمة: ",F.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مسلّمة (إجمالي): ",F.deliveredWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مستلمة: ",F.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مستلمة (إجمالي): ",F.receivedWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مسلّمة: ",F.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مسلّمة (إجمالي): ",F.deliveredWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مستلمة: ",F.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مستلمة (إجمالي): ",F.receivedWalletBalancesTotal??0]}),e.jsxs("div",{className:["text-xs",(F.shiftProfit??(F.deliveredDrawerFunds??0)+(F.deliveredWalletBalancesTotal??0)-(F.receivedDrawerFunds??0)-(F.receivedWalletBalancesTotal??0))>=0?"text-green-700":"text-red-700"].join(" "),children:["أرباح الوردية: ",F.shiftProfit??(F.deliveredDrawerFunds??0)+(F.deliveredWalletBalancesTotal??0)-(F.receivedDrawerFunds??0)-(F.receivedWalletBalancesTotal??0)]})]}),F.deficit&&e.jsxs("div",{className:"text-xs text-red-600 mt-1",children:["عجز: ",F.deficitAmount??0]})]},F.id))}),e.jsx(Pe,{className:"flex gap-2 justify-between",children:e.jsx(d,{variant:"secondary",onClick:()=>_e(!1),children:"إغلاق"})})]})}),e.jsx(me,{open:Fe,onOpenChange:ot,children:e.jsxs(he,{className:"sm:max-w-md",children:[e.jsx(ue,{children:e.jsx(xe,{children:"إيصال تسليم وردية"})}),Ie?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsxs("div",{className:"text-sm",children:["التاريخ: ",new Date(Ie.createdAt).toLocaleString("ar-EG")]}),e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["تم التسليم إلى: ",Ie.receiverPhone]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"المستلم عند الدخول"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية: ",Ie.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["أرصدة المحافظ (إجمالي): ",Ie.receivedWalletBalancesTotal??0]})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"المسلّم عند الخروج"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية: ",Ie.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["أرصدة المحافظ (إجمالي): ",Ie.deliveredWalletBalancesTotal??0]})]})]}),Ie.deficit&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2 text-red-600",children:"عجز"}),e.jsxs("div",{className:"text-xs text-red-600",children:["المبلغ: ",Ie.deficitAmount??0]})]}),Ie.receivedWalletBalances&&Object.keys(Ie.receivedWalletBalances).length>0&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"تفصيل المحافظ المستلمة"}),e.jsx("div",{className:"space-y-1",children:Object.entries(Ie.receivedWalletBalances).map(([F,ge])=>e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-gray-600",children:F}),e.jsx("span",{className:"font-semibold",children:ge})]},F))})]}),Ie.deliveredWalletBalances&&Object.keys(Ie.deliveredWalletBalances).length>0&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"تفصيل المحافظ المسلّمة"}),e.jsx("div",{className:"space-y-1",children:Object.entries(Ie.deliveredWalletBalances).map(([F,ge])=>e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-gray-600",children:F}),e.jsx("span",{className:"font-semibold",children:ge})]},F))})]})]}):e.jsx("div",{className:"text-xs text-gray-600",children:"لا يوجد تقرير محدد للعرض."}),e.jsx(Pe,{className:"flex gap-2 justify-between",children:e.jsx(d,{variant:"secondary",onClick:()=>ot(!1),children:"إغلاق"})})]})}),e.jsx(me,{open:zt,onOpenChange:Re,children:e.jsxs(he,{className:"sm:max-w-md",children:[e.jsx(ue,{children:e.jsx(xe,{children:"أدخل الرقم السري للدخول"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm",children:h?`${h.name} (${h.username})`:""}),e.jsx(L,{type:"password",autoComplete:"off",value:Nt,onChange:F=>it(F.target.value),placeholder:"أدخل الرقم السري"})]}),e.jsxs(Pe,{className:"flex gap-2 justify-between",children:[e.jsx(d,{variant:"secondary",onClick:()=>{it(""),P(null),Re(!1)},children:"إلغاء"}),e.jsx(d,{onClick:()=>{if(h){if(Nt.trim()!==h.password){b({title:"خطأ في الرقم السري",description:"الرقم السري للكاشير غير صحيح",variant:"destructive"});return}v({name:h.name,username:h.username}),it(""),Re(!1),u(!1),t(),z(!0)}},children:"دخول الورديه"})]})]})}),e.jsx(me,{open:te,onOpenChange:z,children:e.jsxs(he,{className:"sm:max-w-md",children:[e.jsx(ue,{children:e.jsx(xe,{children:"تسجيل أرصدة البداية والنقدية"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(q,{className:"mb-1 block",children:"الفلوس النقدية المستلمة عند الدخول"}),e.jsx(L,{type:"number",value:At,onChange:F=>Yt(F.target.value),placeholder:"أدخل قيمة النقدية في الدرج عند بداية الورديه"})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(q,{className:"mb-1 block",children:"أرصدة المحافظ المستلمة (إجمالي) عند الدخول"}),e.jsx(L,{type:"number",value:Number.isFinite(Ue)?Ue:0,onChange:F=>{const ge=parseFloat(F.target.value);ss(Number.isFinite(ge)?ge:0)},placeholder:"أدخل إجمالي أرصدة المحافظ عند بداية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"يمكن إضافة التفصيل لاحقاً إن لزم، المهم تسجيل الإجمالي."})]})]}),e.jsx(Pe,{className:"flex gap-2 justify-between",children:e.jsx(d,{onClick:()=>{const F=parseFloat(At),ge=Ue,ft=Number.isFinite(F)&&F>=0,Te=Number.isFinite(ge)&&ge>=0;if(!ft||!Te){b({title:"يرجى إدخال قيم صحيحة",description:"أدخل قيمًا رقمية غير سالبة للنقدية ولإجمالي أرصدة المحافظ",variant:"destructive"});return}try{localStorage.setItem("shiftInitialReceivedDrawerFunds",String(F)),localStorage.setItem("shiftInitialReceivedWalletBalancesTotal",String(ge))}catch{}b({title:"تم تسجيل أرصدة البداية",description:"سُجّل إجمالي النقدية وأرصدة المحافظ لبداية الورديه"}),z(!1)},children:"تأكيد وحفظ"})})]})}),e.jsx(me,{open:ee,onOpenChange:F=>{F&&$(!0)},children:e.jsxs(he,{className:"sm:max-w-md",hideClose:!0,disableOutsideClose:!0,disableEscClose:!0,children:[e.jsx(ue,{children:e.jsx(xe,{children:"تسليم الورديه والخروج"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(d,{variant:C==="toUser"?"default":"secondary",onClick:()=>_("toUser"),children:"تسليم إلى مستخدم آخر"}),e.jsx(d,{variant:C==="toAdmin"?"default":"secondary",onClick:()=>_("toAdmin"),children:"تسليم إلى الأدمن الرئيسي"})]}),C==="toUser"&&e.jsxs("div",{className:"space-y-3",children:[Ne.length===0?e.jsx("div",{className:"text-sm text-gray-600",children:"لا يوجد مستخدمون مسجلون. قم بإضافة مستخدم أولاً."}):e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"اختر المستخدم الذي سيتسلم الورديه"}),e.jsx("div",{className:"space-y-2 max-h-40 overflow-auto",children:Ne.map((F,ge)=>e.jsxs("div",{className:`flex items-center justify-between rounded border px-3 py-2 cursor-pointer ${(V==null?void 0:V.username)===F.username?"bg-indigo-50 border-indigo-200":""}`,onClick:()=>Ae(F),children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:F.name}),e.jsx("div",{className:"text-xs text-gray-500",children:F.username})]}),e.jsx("span",{className:"text-xs text-gray-400",children:"اختيار"})]},ge))})]}),e.jsxs("div",{children:[e.jsx(q,{className:"mb-1 block",children:"كلمة سر المستخدم المحدد"}),e.jsx(L,{type:"password",autoComplete:"off",value:H,onChange:F=>le(F.target.value),placeholder:"أدخل كلمة السر"})]}),Be&&e.jsx("div",{className:"text-xs text-red-600",children:Be})]}),C==="toAdmin"&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm text-gray-600",children:"أدخل كلمة مرور الحساب الرئيسي لتسليم الورديه والخروج إلى الأدمن."}),e.jsx(L,{type:"password",autoComplete:"off",value:Z,onChange:F=>re(F.target.value),placeholder:"كلمة المرور"}),ce&&e.jsx("div",{className:"text-xs text-red-600",children:ce})]})]}),e.jsx(Pe,{className:"flex gap-2 justify-between",children:e.jsx(d,{disabled:kt||!C,onClick:async()=>{if(C){Je(!0);try{const F=await la();if(C==="toUser"){if(!V){Ge("يرجى اختيار المستخدم أولاً"),Je(!1);return}if(H.trim()!==V.password){Ge("كلمة السر غير صحيحة"),Je(!1);return}E(),v({name:V.name,username:V.username}),t(),O(`${V.name} (${V.username})`);try{localStorage.setItem("lastHandoverToAdmin","false")}catch{}$(!1),_(null),Ae(null),le(""),Ge(""),u(!1),Qe(F),Me(null),Pt(""),pt(!0)}else if(C==="toAdmin"){J("");const ge=(g==null?void 0:g.email)||"";if(!ge){J("لا يوجد بريد للمستخدم الرئيسي للتحقق"),Je(!1);return}const{error:ft}=await m(ge,Z);if(ft){J("كلمة المرور غير صحيحة"),Je(!1);return}E(),v(null);try{localStorage.setItem("lastHandoverToAdmin","true")}catch{}re(""),$(!1),u(!1),O("الأدمن الرئيسي"),Qe(F),Me(null),Pt(""),pt(!0)}}catch{Ge("حدث خطأ أثناء التسليم، حاول مرة أخرى")}finally{Je(!1)}}},children:"تأكيد التسليم"})})]})}),e.jsx(me,{open:Wt,onOpenChange:pt,children:e.jsxs(he,{className:"sm:max-w-lg",hideClose:!0,disableOutsideClose:!0,disableEscClose:!0,children:[e.jsx(ue,{children:e.jsx(xe,{children:"تقرير تسليم الورديه والخروج"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsxs("div",{className:"text-sm",children:["تم تسليم الورديه إلى: ",e.jsx("span",{className:"font-semibold",children:rt})]}),y&&e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["بداية الورديه: ",new Date(y).toLocaleString("ar-EG")]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نهاية الورديه: ",new Date().toLocaleString("ar-EG")]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(q,{className:"mb-1 block",children:"الفلوس النقدية المستلمة"}),e.jsx(L,{type:"number",value:At,readOnly:!0,disabled:!0,placeholder:"قيمة مسجلة عند بداية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"قيمة غير قابلة للتعديل؛ تُسجّل عند الدخول."})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(q,{className:"mb-1 block",children:"أرصدة المحافظ المستلمة (إجمالي)"}),e.jsx(L,{type:"number",value:Ue,readOnly:!0,disabled:!0,placeholder:"إجمالي مسجل عند بداية الورديه"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(q,{className:"mb-1 block",children:"الفلوس النقدية المسلمة"}),e.jsx(L,{type:"number",value:Ft,onChange:F=>{const ge=parseFloat(F.target.value);A(Number.isFinite(ge)?ge:0)},placeholder:"أدخل قيمة النقدية المسلمة عند نهاية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"ادخال يدوي لقيمة النقدية المسلّمة عند نهاية الورديه"})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(q,{className:"mb-1 block",children:"أرصدة المحافظ المسلمة (إجمالي)"}),e.jsx(L,{type:"number",value:se,onChange:F=>{const ge=parseFloat(F.target.value);pe(Number.isFinite(ge)?ge:0)},placeholder:"أدخل إجمالي أرصدة المحافظ المسلّمة"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"يمكنك إدخال الإجمالي يدوياً؛ التفصيل يُحفظ إن لزم"})]})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-1",children:"أرباح الوردية"}),e.jsx("div",{className:["text-sm",(Ft??0)+(se??0)-((parseFloat(At||"0")||0)+(Ue??0))>=0?"text-green-700":"text-red-700"].join(" "),children:Math.round(((Ft??0)+(se??0)-((parseFloat(At||"0")||0)+(Ue??0)))*100)/100}),e.jsx("div",{className:"text-xs text-gray-600",children:"محسوبة: (المسلّم − المستلم) للنقدية + المحافظ"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"هل يوجد عجز؟"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(d,{variant:at==="no"?"default":"secondary",onClick:()=>Me("no"),children:"لا"}),e.jsx(d,{variant:at==="yes"?"default":"secondary",onClick:()=>Me("yes"),children:"نعم"})]}),at==="yes"&&e.jsxs("div",{children:[e.jsx(q,{className:"mb-1 block",children:"مبلغ العجز"}),e.jsx(L,{type:"number",value:gt,onChange:F=>Pt(F.target.value),placeholder:"أدخل مبلغ العجز"})]})]})]}),e.jsx(Pe,{className:"flex gap-2 justify-between",children:e.jsx(d,{onClick:()=>{const F=at==="yes",ge=parseFloat(gt)||0;(async()=>await As(Lt,F,ge))(),b({title:"تم إضافة إيصال تسليم الورديه",description:"أُضيف الإيصال إلى المعاملات الأخيرة بعنوان إيصال تسليم وردية"}),pt(!1)},children:"تأكيد وحفظ الإيصال"})})]})})]})},wd=({open:l,onOpenChange:u})=>{const{shiftUser:o,endShift:x,setShiftUser:y}=Ta(),[v,t]=n.useState(""),[E,T]=n.useState(""),[g,m]=n.useState([]);n.useEffect(()=>{try{const b=localStorage.getItem("cashierUsers");m(b?JSON.parse(b):[])}catch{m([])}},[l]);const w=async()=>{if(T(""),!o)return;const b=g.find(B=>B.username===o.username);if(!b){T("لا يوجد مستخدم مطابق لهذه الوردية");return}if(v.trim()!==b.password){T("الرقم السري غير صحيح");return}x(),y(null),t(""),u(!1)};return e.jsx(me,{open:l,onOpenChange:b=>{t(""),T(""),u(b)},children:e.jsxs(he,{className:"sm:max-w-md",children:[e.jsx(ue,{children:e.jsx(xe,{children:"بروفيل الوردية"})}),o?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"rounded-lg border p-3 bg-gradient-to-r from-blue-50 to-indigo-50",children:[e.jsx("div",{className:"text-sm font-semibold text-gray-800",children:o.name}),e.jsx("div",{className:"text-xs text-gray-600",children:o.username})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{className:"block",children:"أدخل الرقم السري لتسليم الوردية"}),e.jsx(L,{type:"password",value:v,onChange:b=>t(b.target.value),placeholder:"الرقم السري للمستخدم",dir:"ltr"}),E&&e.jsx("div",{className:"text-red-600 text-xs",children:E})]})]}):e.jsx("div",{className:"text-sm text-gray-600",children:"لا يوجد مستخدم وردية نشط حالياً"}),e.jsxs(Pe,{className:"flex justify-between",children:[e.jsx(d,{variant:"outline",onClick:()=>u(!1),children:"إغلاق"}),e.jsx(d,{onClick:w,disabled:!o,children:"تسليم الوردية"})]})]})})};class sa{static async processTransfer(u){const{amount:o,currentCashBalance:x,currentWalletBalances:y,wallets:v,selectedWalletId:t}=u;if(o<=0)return{success:!1,newCashBalance:x,newWalletBalances:y,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(t&&!u.skipRemoteLimitsCheck)try{const m=await js.canPerformOperation(t,o,"transfer");if(!m.canPerform)return{success:!1,newCashBalance:x,newWalletBalances:y,message:m.message||"تجاوز حد التحويل المسموح",error:"LIMIT_EXCEEDED"}}catch(m){return console.error("خطأ في التحقق من حدود التحويل:",m),{success:!1,newCashBalance:x,newWalletBalances:y,message:"خطأ في التحقق من حدود التحويل",error:"LIMIT_CHECK_ERROR"}}if(o<=0)return{success:!1,newCashBalance:x,newWalletBalances:y,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(t){const m=Math.max(y[t]||0,0);if(m<o){const w=v.find(b=>b.id===t);return{success:!1,newCashBalance:x,newWalletBalances:y,message:`رصيد غير كافي في المحفظة${w?` ${w.name}`:""}. المتاح: ${m} جنيه، المطلوب: ${o} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"}}}else{const m=sa.calculateTotalWalletBalance(y);if(m<o)return{success:!1,newCashBalance:x,newWalletBalances:y,message:`رصيد غير كافي في المحافظ. الرصيد المتاح: ${m} جنيه، المبلغ المطلوب: ${o} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"}}const E={...y};if(t){const m=E[t]||0;E[t]=m-o}else{let m=o;for(const w of v){if(m<=0)break;const b=Math.max(E[w.id]||0,0),B=Math.min(b,m);B>0&&(E[w.id]=(E[w.id]||0)-B,m-=B)}}const T=x+o;if(t)try{const m=js.updateUsage(t,o,"transfer");u.nonBlockingUsageUpdate?m.catch(w=>console.error("خطأ في تحديث استخدام المحفظة:",w)):await m}catch(m){console.error("خطأ في تحديث استخدام المحفظة:",m)}let g="تم التحويل بنجاح";if(t){const m=E[t]||0;m<0&&(g=`تم التحويل بنجاح مع تحذير: رصيد محفظة ${t} أصبح ${m} جنيه.`)}return{success:!0,newCashBalance:T,newWalletBalances:E,message:g}}static processDeposit(u){const{amount:o,currentCashBalance:x,currentWalletBalances:y,wallets:v}=u;if(o<=0)return{success:!1,newCashBalance:x,newWalletBalances:y,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};const t=this.calculateTotalWalletBalance(y);if(t<o)return{success:!1,newCashBalance:x,newWalletBalances:y,message:`رصيد غير كافي في المحافظ. الرصيد المتاح: ${t} جنيه، المبلغ المطلوب: ${o} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"};const E=x+o,T={...y};let g=o;const m=v.find(b=>b.isDefault);if(m&&T[m.id]>=g)T[m.id]-=g,g=0;else for(const b of v){if(g<=0)break;const B=T[b.id]||0;if(B>0){const U=Math.min(B,g);T[b.id]=B-U,g-=U}}const w=g>0?`تم الإيداع جزئياً. تم إيداع ${o-g} جنيه في صندوق النقدية`:`تم الإيداع بنجاح. تم إضافة ${o} جنيه إلى صندوق النقدية`;return{success:!0,newCashBalance:E,newWalletBalances:T,message:w}}static async processWithdraw(u){const{amount:o,currentCashBalance:x,currentWalletBalances:y,wallets:v,selectedWalletId:t}=u;if(o<=0)return{success:!1,newCashBalance:x,newWalletBalances:y,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(t&&!u.skipRemoteLimitsCheck)try{const m=await js.canPerformOperation(t,o,"withdraw");if(!m.canPerform)return{success:!1,newCashBalance:x,newWalletBalances:y,message:m.reason||"تم تجاوز الحد المسموح للسحب",error:"LIMIT_EXCEEDED"}}catch(m){return console.error("خطأ في التحقق من حدود السحب:",m),{success:!1,newCashBalance:x,newWalletBalances:y,message:"خطأ في التحقق من حدود السحب",error:"LIMIT_CHECK_ERROR"}}if(x<o)return{success:!1,newCashBalance:x,newWalletBalances:y,message:`رصيد غير كافي في صندوق النقدية. الرصيد المتاح: ${x} جنيه، المبلغ المطلوب: ${o} جنيه`,error:"INSUFFICIENT_CASH_BALANCE"};const E=x-o,T={...y},g=t?v.find(m=>m.id===t):v.find(m=>m.isDefault)||v[0];if(g){const m=T[g.id]||0;T[g.id]=m+o}else return{success:!1,newCashBalance:x,newWalletBalances:y,message:"لا توجد محافظ متاحة لإضافة المبلغ إليها",error:"NO_WALLETS_AVAILABLE"};if(t)try{const m=js.updateUsage(t,o,"withdraw");u.nonBlockingUsageUpdate?m.catch(w=>console.error("خطأ في تحديث استخدام المحفظة:",w)):await m}catch(m){console.error("خطأ في تحديث استخدام المحفظة:",m)}return{success:!0,newCashBalance:E,newWalletBalances:T,message:`تم السحب بنجاح. تم إضافة ${o} جنيه إلى محفظة ${(g==null?void 0:g.name)||""}`}}static validateOperation(u,o){return u<=0?{valid:!1,error:"المبلغ يجب أن يكون أكبر من الصفر"}:!o||o.length===0?{valid:!1,error:"لا توجد محافظ متاحة"}:{valid:!0}}static calculateTotalWalletBalance(u){return Object.values(u).reduce((o,x)=>o+Math.max(x,0),0)}static deductFromWalletsAddToCash(u,o,x,y){return this.processTransfer({amount:u,currentCashBalance:o,currentWalletBalances:x,wallets:y})}static deductFromWalletsAddToCashDeposit(u,o,x,y){return this.processDeposit({amount:u,currentCashBalance:o,currentWalletBalances:x,wallets:y})}static deductFromCashAddToWallets(u,o,x,y){return this.processWithdraw({amount:u,currentCashBalance:o,currentWalletBalances:x,wallets:y})}static applyTransactionResult(u,o,x){u.success&&(o(u.newCashBalance),x(u.newWalletBalances))}static validateTransaction(u,o,x,y){if(u<=0)return{isValid:!1,error:"المبلغ يجب أن يكون أكبر من الصفر"};if(o==="transfer"){const v=this.calculateTotalWalletBalance(y);if(v<u)return{isValid:!1,error:`الرصيد المتاح في المحافظ (${v} جنيه) غير كافي للمبلغ المطلوب (${u} جنيه)`}}else if(o==="withdraw"){if(x<u)return{isValid:!1,error:`الرصيد المتاح في صندوق النقدية (${x} جنيه) غير كافي للمبلغ المطلوب (${u} جنيه)`}}else if(o==="deposit"){const v=this.calculateTotalWalletBalance(y);if(v<u)return{isValid:!1,error:`الرصيد المتاح في المحافظ (${v} جنيه) غير كافي للمبلغ المطلوب (${u} جنيه)`}}return{isValid:!0}}static getDeductionPreview(u,o,x){const y=[];let v=u;for(const t of x){if(v<=0)break;const E=o[t.id]||0,T=Math.min(Math.max(E,0),v);T>0&&(y.push({walletId:t.id,walletName:t.name,currentBalance:E,deductedAmount:T,newBalance:E-T}),v-=T)}return y}}let wa=null;function Sd(){const l=window;if(!wa){const u=l.AudioContext||l.webkitAudioContext;wa=new u}return wa.state==="suspended"&&wa.resume(),wa}function Dd(l,u,o){const x=o/1e3,y=Math.floor(l.sampleRate*x),v=l.createBuffer(1,y,l.sampleRate),t=v.getChannelData(0);for(let m=0;m<y;m++)t[m]=(Math.random()*2-1)*.6;const E=l.createBufferSource();E.buffer=v;const T=l.createBiquadFilter();T.type="highpass",T.frequency.value=1500,T.Q.value=.7;const g=l.createGain();g.gain.setValueAtTime(1e-4,u),g.gain.exponentialRampToValueAtTime(.4,u+.015),g.gain.exponentialRampToValueAtTime(1e-4,u+x),E.connect(T),T.connect(g),g.connect(l.destination),E.start(u),E.stop(u+x+.01)}function Cd(l,u,o,x,y,v="triangle"){const t=l.createOscillator(),E=l.createGain();t.type=v;const T=y/1e3;t.frequency.setValueAtTime(o,u),t.frequency.linearRampToValueAtTime(x,u+T),E.gain.setValueAtTime(1e-4,u),E.gain.exponentialRampToValueAtTime(.25,u+.02),E.gain.exponentialRampToValueAtTime(1e-4,u+T),t.connect(E),E.connect(l.destination),t.start(u),t.stop(u+T+.02)}function Id(){try{const l=Sd(),u=l.currentTime;Dd(l,u,90),Cd(l,u+.12,1900,1100,180,"sawtooth")}catch{}}function Td(l){if(!l)return!1;const o=l.replace(/[^0-9٠-٩]/g,"").replace(/[٠-٩]/g,x=>"0123456789"["٠١٢٣٤٥٦٧٨٩".indexOf(x)]);return/^(010|011|012|015)[0-9]{8}$/.test(o)}const Im=()=>{var Dl,Cl,Il,Tl;console.log("🔥 UserDashboardPage component is loading...");const{toast:l}=hs(),u=n.useRef(null),[o,x]=n.useState(0),y=async()=>{var r,i,c;const s="alkaptin678678@gmail.com",a=(i=(r=Al.currentUser)==null?void 0:r.email)==null?void 0:i.toLowerCase();if(!a||a!==s){l({title:"قيد التطوير",description:"هذه الميزة غير متاحة حالياً."});return}if(!qa||!Va||!Ya){l({title:"بيانات ناقصة",description:"أدخل رقم الموبايل، الشركة والمبلغ",variant:"destructive"});return}try{rl(!0);const p=await((c=Al.currentUser)==null?void 0:c.getIdToken()),f=await fetch("/api/topup",{method:"POST",headers:{"Content-Type":"application/json",...p?{Authorization:`Bearer ${p}`}:{}},body:JSON.stringify({phone:qa,countryCode:"EG",operator:Va,amount:Number(Ya),useLocalAmount:!0})}),N=await f.json().catch(()=>({}));f.ok&&(N!=null&&N.success)?(l({title:"تم الشحن",description:(N==null?void 0:N.message)||"تم تنفيذ عملية الشحن بنجاح"}),qr(!1),el(""),tl(""),sl("")):l({title:"فشل الشحن",description:(N==null?void 0:N.message)||"حدث خطأ أثناء طلب الشحن",variant:"destructive"})}catch(p){console.error("Topup request error:",p),l({title:"خطأ غير متوقع",description:"تعذّر تنفيذ عملية الشحن. حاول لاحقاً.",variant:"destructive"})}finally{rl(!1)}},{signOut:v,user:t,profile:E}=Ps(),T=((t==null?void 0:t.email)||"").toLowerCase()==="vodafonecash00@gmail.com",g=ic(),m=$l(),{isShiftActive:w,shiftUser:b}=Ta(),{shopName:B}=oc(),U=cc(),[X,M]=n.useState(!1),[I,R]=n.useState(!1);async function ee(s,a){const r=String(s||"").replace(/\D/g,"");if(!r||r.length!==11||!r.startsWith("01"))throw l({title:"رقم غير صالح",description:"أدخل رقم مستقبل بصيغة 01XXXXXXXXX",variant:"destructive"}),new Error("Invalid receiver msisdn");const i=Math.round(Number(a||0));if(!i||i<=0)throw l({title:"مبلغ غير صالح",description:"أدخل مبلغاً صحيحاً أكبر من صفر",variant:"destructive"}),new Error("Invalid amount");const c=document.getElementById("ngrokLink"),p=((c==null?void 0:c.value)||"").trim()||String((E==null?void 0:E.transferCodeLink)||"").trim();if(!p)throw l({title:"الرابط غير مُعدّ",description:"احفظ رابط الجسر في صفحة الإعدادات أو أدخله هنا مباشرة.",variant:"destructive"}),new Error("Missing bridge link");const D=`${(We=>{let be=(We||"").trim();return be=be.replace(/\/+$/,""),/^https?:\/\//i.test(be)||(be=`https://${be}`),be})(p)}/sendUSSD`,S=`*9*7*${r}*${i}#`,j=document.getElementById("bridgeDeviceId"),W=((j==null?void 0:j.value)||"").trim()||String((E==null?void 0:E.bridgeDeviceId)||"").trim(),G=W?{device:W,deviceId:W,code:S}:{code:S};let k=null,Y="",Se=null;try{k=await fetch(D,{method:"POST",headers:{"Content-Type":"application/json","ngrok-skip-browser-warning":"true"},body:JSON.stringify(G)}),Y=await k.text();try{Se=JSON.parse(Y)}catch{Se=null}}catch{k=null}if(!k||!k.ok||Se&&Se.success===!1)try{const We=`${D}?code=${encodeURIComponent(S)}${W?`&device=${encodeURIComponent(W)}`:""}`,be=await fetch(We,{method:"GET",headers:{"ngrok-skip-browser-warning":"true"}}),Zs=await be.text();let It=null;try{It=JSON.parse(Zs)}catch{}if(be.ok&&(!It||It.success!==!1)){l({title:"تم إرسال كود التحويل",description:(It==null?void 0:It.message)||"تم التنفيذ بنجاح"});return}const Kt=(It==null?void 0:It.message)||Zs||Y||`HTTP ${be.status}`;throw l({title:"فشل الإرسال",description:Kt,variant:"destructive"}),new Error(Kt)}catch(We){const be=(Se==null?void 0:Se.message)||Y||(We==null?void 0:We.message)||"تعذّر الاتصال بالجسر";throw l({title:"فشل الإرسال",description:be,variant:"destructive"}),new Error(be)}l({title:"تم إرسال كود التحويل",description:(Se==null?void 0:Se.message)||"تم التنفيذ بنجاح"})}console.log("🔥 UserDashboardPage - user:",t?"exists":"null");const[$,C]=n.useState(!0),[_,Z]=n.useState(!0),[re,ce]=n.useState(!1),[J,V]=n.useState(!1),[Ae,H]=n.useState(""),[le,Be]=n.useState(""),[Ge,kt]=n.useState(""),[Je,Wt]=n.useState([]),[pt,Lt]=n.useState(!1),[Qe,at]=n.useState(null),[Me,gt]=n.useState("");n.useState(!1);const[Pt,At]=n.useState(!1),[Yt,Ue]=n.useState(!1),[ss,_t]=n.useState(!1),[as,Ft]=n.useState(""),[A,se]=n.useState(""),[pe,ke]=n.useState([]),[Oe,rt]=n.useState(!1),[O,te]=n.useState(0),[z,Ne]=n.useState(!1),[Le,Ht]=n.useState(null),[Dt,zt]=n.useState(!1),[Re,Nt]=n.useState(""),[it,h]=n.useState(""),[P,K]=n.useState(""),[de,ne]=n.useState(!1),[_e,Ie]=n.useState(""),[$e,Fe]=n.useState(""),[ot,mt]=n.useState(""),[Ke,us]=n.useState(""),[Ye,rs]=n.useState(null),[la,As]=n.useState(!1),[Vs,F]=n.useState(!1),[ge,ft]=n.useState(!1),[Te,Jt]=n.useState(""),[He,Ct]=n.useState(""),[Ys,ka]=n.useState(""),ns=s=>{const a="٠١٢٣٤٥٦٧٨٩",r="۰۱۲۳۴۵۶۷۸۹";return(s||"").split("").map(i=>{const c=a.indexOf(i);if(c>-1)return String(c);const p=r.indexOf(i);return p>-1?String(p):i}).join("")},Sn=s=>{const a=ns(s||"").replace(/\D/g,"");return a?a.startsWith("201")&&a.length===12?"0"+a.slice(2):a.startsWith("00201")&&a.length===14?"0"+a.slice(4):(a.startsWith("01")&&a.length===11,a):""},we=async()=>{try{const s=await fetch("/api/pending_sms");if(!s.ok)throw new Error("فشل الاتصال بواجهة /api/pending_sms");const a=await s.json();if(!Array.isArray(a)||a.length===0){l({title:"مفيش رسائل جديدة",description:"لا توجد SMS معلقة حالياً"});return}const r=a[0]||{},i=r.msisdn||r.address||"",c=Sn(i);if(c){const N=c.replace(/\D/g,""),D=ye.find(S=>ns(S.phone||"").replace(/\D/g,"")===N);if(D){Hs(D.id),Nt(D.phone);try{const S=`selectedWallet_${(t==null?void 0:t.uid)||"default"}`;localStorage.setItem(S,D.id)}catch{}}}const p=r.amount??r.value??r.amountEgp??"";let f="";if(typeof p=="number")f=String(p);else if(typeof p=="string"&&p.trim()!==""){const N=parseFloat(ns(p).replace(/[^0-9.]/g,""));Number.isNaN(N)||(f=String(N))}else if(r.message||r.body){const D=ns(String(r.message||r.body)).match(/([0-9]+(?:\.[0-9]+)?)/);D&&(f=D[1])}K(f||""),fr("withdraw"),l({title:"تم الملء تلقائياً",description:"تم اختيار المحفظة وإدخال المبلغ من آخر SMS"})}catch(s){l({title:"فشل جلب الرسائل",description:(s==null?void 0:s.message)||"خطأ غير معروف",variant:"destructive"})}},[ie,Gt]=n.useState(()=>{try{const s=localStorage.getItem("commissionMode")||localStorage.getItem("commissionMode_default");return s?s==="add":!0}catch{return!0}}),[ae,fr]=n.useState("transfer"),[vt,Ss]=n.useState([]),[xs,vr]=n.useState("all");n.useEffect(()=>{try{if(localStorage.setItem("commissionMode",ie?"add":"deduct"),t!=null&&t.uid){const s=`commissionMode_${t.uid}`;localStorage.setItem(s,ie?"add":"deduct")}}catch{}},[ie,t==null?void 0:t.uid]),n.useEffect(()=>{try{const s=t!=null&&t.uid?localStorage.getItem(`commissionMode_${t.uid}`):null,a=localStorage.getItem("commissionMode"),r=localStorage.getItem("commissionMode_default"),i=s??a??r;i&&Gt(i==="add")}catch{}},[t==null?void 0:t.uid]);const[br,ia]=n.useState(!1),[Di,Ci]=n.useState(null),Pa=tt.useRef(""),Dn=tt.useRef(0);n.useEffect(()=>{const s=a=>{if(br)return;const r=Date.now();if(a.key==="Enter"){const i=(Pa.current||"").trim();Pa.current="",i&&(Ci(i),ia(!0));return}a.key.length===1&&(r-(Dn.current||0)>100&&(Pa.current=""),Pa.current+=a.key,Dn.current=r)};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[br]);const[Ii,Ti]=n.useState(!1),[ki,kd]=n.useState(null),[Q,Hs]=n.useState("");n.useEffect(()=>{if(!de)return;const s=Ds(),a=parseFloat(P||"0")||0;let r=0;if(ae==="transfer"){if((s==null?void 0:s.defaultTransferCommission)!=null){const c=Number(s.defaultTransferCommission)||0;r=Math.round(c*a/1e3*100)/100}else{const c=He&&He.trim()!==""?parseFloat(He):0;r=Math.max(0,c)}const i=a+r;Fe((i||0).toString())}else{if((s==null?void 0:s.defaultWithdrawCommission)!=null){const c=Number(s.defaultWithdrawCommission)||0;r=Math.round(c*a/1e3*100)/100}else{const c=Te&&Te.trim()!==""?parseFloat(Te):Math.round(a*.01*100)/100;r=Math.max(0,c)}const i=ie?a:Math.max(0,Math.round((a-r)*100)/100);Fe((i||0).toString())}},[de,P,He,Te,Q,ie,ae]);const Ds=()=>{var a,r;let s=ye.find(i=>i.id===Q);if(!s)try{const i=localStorage.getItem(Xs());if(i){const c=JSON.parse(i);if(Array.isArray(c)&&c.length>0){const f=localStorage.getItem(`selectedWallet_${(t==null?void 0:t.uid)||"default"}`)||((a=c.find(N=>N.isDefault))==null?void 0:a.id)||((r=c[0])==null?void 0:r.id);s=c.find(N=>N.id===f)}}}catch{}return s};n.useLayoutEffect(()=>{try{const s=`wallets_${(t==null?void 0:t.uid)||"default"}`;let a=localStorage.getItem(s);if(!a){const r=Object.keys(localStorage).find(i=>i.startsWith("wallets_"));r&&(a=localStorage.getItem(r)||null)}if(a){const r=JSON.parse(a);if(Array.isArray(r)&&r.length>0){ps(r);const i=`selectedWallet_${(t==null?void 0:t.uid)||"default"}`,c=localStorage.getItem(i),p=c&&r.find(f=>f.id===c)||r.find(f=>f.isDefault)||r[0];p&&(Hs(p.id),Nt(p.phone))}}}catch(s){console.error("تهيئة فورية للمحافظ من التخزين المحلي فشلت:",s)}},[]),n.useEffect(()=>{console.log("🔍 selectedWallet state changed to:",Q)},[Q]),n.useEffect(()=>{jo()},[]),n.useEffect(()=>{wo()},[]);const[ye,ps]=n.useState(()=>{try{const s=Object.keys(localStorage).find(r=>r.startsWith("wallets_")),a=s?localStorage.getItem(s):null;if(a){const r=JSON.parse(a);if(Array.isArray(r))return r}}catch{}return[]}),[Cn,Pi]=n.useState(""),In=(()=>{const s=Cn.replace(/\D/g,"");return s?ye.filter(a=>(a.phone||"").replace(/\D/g,"").includes(s)):ye})(),[Ai,Pd]=n.useState(null),[Oi,Tn]=n.useState(!1),[Wi,Aa]=n.useState(!1),[Fi,Ei]=n.useState(null);n.useState([]),n.useState([]);const[Bi,oa]=n.useState(!1),[yr,kn]=n.useState("daily"),[Mi,Pn]=n.useState(!1),[Li,jr]=n.useState(!1),[An,Os]=n.useState([]),$i=async s=>{try{const a=vt.find(i=>i.id===s);if(!a||!t)return;const r=vt.filter(i=>i.id!==s);Ss(r);try{await Ce.removeUserTransaction(t.uid,s),await lr.permanentlyDeleteTransaction(s,t.uid)}catch(i){console.warn("تعذر الحذف النهائي من قواعد البيانات أثناء حذف الإيصال:",i)}try{const i=dt(),c=ct(),p=localStorage.getItem(i),f=localStorage.getItem(c);let N=p?parseFloat(p):Xe,D=f?JSON.parse(f):{...je};const S=a.amount||a.transferredAmount||a.withdrawnAmount||a.withdrawnAmountDetailed||0;if(a.type==="send"&&(a.fromWallet||Q)){N-=a.commission||0;const G=a.fromWallet||Q;D[G]=(D[G]||0)+S}else if(a.type==="withdraw"&&(a.fromWallet||Q)){N+=S,N-=a.commission||0;const G=a.fromWallet||Q;D[G]=Math.max(0,(D[G]||0)-S)}ht(N),Ze(D),localStorage.setItem(i,N.toString()),localStorage.setItem(c,JSON.stringify(D));const j={cashBalance:N,walletBalances:D,lastUpdated:new Date().toISOString()},W=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(W,JSON.stringify(j)),t!=null&&t.uid?Ce.updateUserData(t.uid,j).then(()=>{localStorage.removeItem(W),ve(!1)}).catch(G=>{console.warn("تعذر حفظ الأرصدة في Firebase بعد الحذف، تم الاحتفاظ محليًا:",G),ve(!0)}):ve(!0)}catch(i){console.warn("تعذر عكس تأثير الأرصدة بعد الحذف:",i)}try{const i=a.fromWallet||Q,c=await js.getWalletLimits(t.uid,i);if(c){const p=a.amount||a.transferredAmount||a.withdrawnAmount||a.withdrawnAmountDetailed||0,f={...c};a.type==="send"?(f.dailyTransferUsed=Math.max(0,(c.dailyTransferUsed||0)-p),f.monthlyTransferUsed=Math.max(0,(c.monthlyTransferUsed||0)-p)):(f.dailyWithdrawUsed=Math.max(0,(c.dailyWithdrawUsed||0)-p),f.monthlyWithdrawUsed=Math.max(0,(c.monthlyWithdrawUsed||0)-p)),await js.updateWalletLimits(t.uid,i,f)}}catch(i){console.warn("تعذر تحديث حدود المحفظة بعد الحذف:",i)}try{Rt.removeTransactionEffects(a,t.uid)}catch(i){console.warn("تعذر تحديث التقارير بعد الحذف:",i)}l({title:"تم الحذف نهائيًا",description:"تم حذف الإيصال نهائيًا وعكس تأثيراته على الأرصدة والحدود والتقارير."}),Aa(!1)}catch(a){console.error("خطأ أثناء حذف الإيصال:",a),l({title:"خطأ في حذف الإيصال",description:"حدث خطأ غير متوقع أثناء الحذف.",variant:"destructive"})}},Ri=async s=>{try{if(!vt.find(r=>r.id===s)||!t)return;await ra(cs(xt,"userTransactions",s),{status:"completed",confirmedAt:new Date}),Ss(r=>r.map(i=>i.id===s?{...i,status:"completed"}:i)),l({title:"تم الإكمال",description:"تم وسم المعاملة كمكتملة."}),Aa(!1)}catch(a){console.error("خطأ أثناء إكمال الإيصال:",a),l({title:"فشل الإكمال",description:"حدث خطأ غير متوقع أثناء تحديث الحالة.",variant:"destructive"})}},[On,Ui]=n.useState(""),Wn=pd(On,300),[Oa,Fn]=n.useState(""),[Wa,En]=n.useState(""),[Cs,Ad]=n.useState(""),[Nr,Gs]=n.useState(!1),[Bn,ca]=n.useState(!1),[_i,Fa]=n.useState(!1),[bt,wr]=n.useState(null),[da,zi]=n.useState(null),[Mn,Ln]=n.useState(!1),[Ji,Sr]=n.useState(!1),[Ki,Ea]=n.useState(!1),[qi,Ba]=n.useState(!1),[Vi,Ma]=n.useState(!1),[Yi,$n]=n.useState(!0),[ma,Hi]=n.useState(!1),[Gi,La]=n.useState(!1),[Qi,Rn]=n.useState(()=>{try{const s=t!=null&&t.uid?`dailyReportsLockEnabled_${t==null?void 0:t.uid}`:"dailyReportsLockEnabled";return(localStorage.getItem(s)??localStorage.getItem("dailyReportsLockEnabled"))==="true"}catch{return!1}}),[Xi,Dr]=n.useState(!1);n.useEffect(()=>{try{const s=t!=null&&t.uid?`dailyReportsLockEnabled_${t==null?void 0:t.uid}`:"dailyReportsLockEnabled",a=localStorage.getItem(s)??localStorage.getItem("dailyReportsLockEnabled");Rn(a==="true")}catch{}},[t==null?void 0:t.uid]);const[Zi,$a]=n.useState(!1),[eo,ha]=n.useState(!1),[Ot,Qt]=n.useState([]),[Cr,Un]=n.useState(""),[Ir,_n]=n.useState(""),[Tr,zn]=n.useState(""),[fe,kr]=n.useState(null),[to,ua]=n.useState(!1);n.useState(!1);const[so,Pr]=n.useState(!1),[Jn,Ar]=n.useState(""),[ao,xa]=n.useState(!1),[ro,Or]=n.useState(!1),[gs,Wr]=n.useState([]),[Fr,Kn]=n.useState(""),[Er,qn]=n.useState(""),[Br,Vn]=n.useState(""),[Yn,Hn]=n.useState(""),[no,Ra]=n.useState(!1),[Mr,Lr]=n.useState(null),[$t,pa]=n.useState(null),[Ua,$r]=n.useState(""),[lo,Qs]=n.useState(!1),[Gn,_a]=n.useState(0),[ls,Ws]=n.useState(null),[Fs,Rr]=n.useState(""),[qe,io]=n.useState(null),fs=async s=>{try{const a=JSON.stringify(s);localStorage.setItem(Vr(),a);try{localStorage.setItem(ll(),a)}catch{}t!=null&&t.uid&&Ce.updateUserData(t.uid,{debts:s}).then(()=>{try{localStorage.removeItem(`debts_unsynced_${t.uid}`)}catch{}}).catch(()=>{ve(!0);try{localStorage.setItem(`debts_unsynced_${t.uid}`,"true")}catch{}})}catch(a){console.error("خطأ في حفظ الديون:",a)}},oo=async()=>{try{const s=Vr(),a=ll(),r=localStorage.getItem(s),i=localStorage.getItem(a),c=f=>{if(!f)return null;try{const N=JSON.parse(f);return Array.isArray(N)?N.map(D=>{var S;return{...D,createdAt:(S=D.createdAt)!=null&&S.toDate?D.createdAt.toDate():new Date(D.createdAt),partialPayments:Array.isArray(D.partialPayments)?D.partialPayments.map(j=>{var W;return{amount:Number(j.amount)||0,paidAt:(W=j.paidAt)!=null&&W.toDate?j.paidAt.toDate():new Date(j.paidAt)}}):[]}}):[]}catch(N){return console.warn("فشل في تحليل ديون localStorage:",N),null}};let p=c(r);if(!p||p.length===0){const f=c(i);if(f&&f.length>0&&(p=f,Qt(f),t!=null&&t.uid))try{await fs(f),localStorage.removeItem(a)}catch(N){console.warn("تعذر ترحيل الديون من المفتاح الافتراضي:",N)}}if(p&&p.length>0&&Qt(p),t!=null&&t.uid)try{const f=await ir(cs(xt,"users",t.uid));if(f.exists()){const N=f.data(),D=N.debts&&Array.isArray(N.debts)?N.debts.map(j=>{var W;return{...j,createdAt:(W=j.createdAt)!=null&&W.toDate?j.createdAt.toDate():new Date(j.createdAt),partialPayments:Array.isArray(j.partialPayments)?j.partialPayments.map(G=>{var k;return{amount:Number(G.amount)||0,paidAt:(k=G.paidAt)!=null&&k.toDate?G.paidAt.toDate():new Date(G.paidAt)}}):[]}}):[],S=D&&D.length>0?D:p||[];Qt(S);try{localStorage.setItem(s,JSON.stringify(S))}catch{}((D==null?void 0:D.length)||0)===0&&((S==null?void 0:S.length)||0)>0&&await Ce.updateUserData(t.uid,{debts:S})}else p&&p.length>0&&await Ce.saveUserData(t.uid,{debts:p})}catch(f){console.warn("تعذر تحميل الديون من Firebase، الاعتماد على المحلي:",f)}}catch(s){console.error("خطأ في تحميل الديون:",s)}},co=async()=>{if(t!=null&&t.uid){console.log("🔄 إعادة فحص حالة المستخدم...");try{await new Promise(a=>setTimeout(a,500));const s=await ir(cs(xt,"users",t.uid));if(s.exists()){const r=s.data().isActive===!0,i=await Sa.checkTrialValidity(t.uid),c=i.isValid&&!i.isExpired;console.log("📊 حالة المستخدم:",{isActive:r,isOnTrial:c,hoursRemaining:i.hoursRemaining}),C(r||c),rt(c),te(i.hoursRemaining),Ne(i.hasUsedTrial),Ue(!r&&!c),console.log("✅ تم تحديث حالة المستخدم بنجاح:",{userIsActive:r||c,isOnFreeTrial:c})}}catch(s){console.error("خطأ في إعادة فحص حالة المستخدم:",s)}}},mo=async()=>{console.log("🎉 تم بدء التجربة المجانية، إعادة فحص حالة المستخدم..."),await co()},ho=async()=>{if(t!=null&&t.uid)try{zt(!0);const s=await jn(t.uid);Ht(s)}catch(s){console.error("خطأ في جلب بيانات الاشتراك:",s)}finally{zt(!1)}};n.useState(!1);const[uo,Ur]=n.useState(!1),[Xe,ht]=n.useState(0),[je,Ze]=n.useState({}),[xo,Qn]=n.useState(!1),[po,Xn]=n.useState(!1),[go,_r]=n.useState(!1),[fo,za]=n.useState(!1),[Zn,zr]=n.useState(""),[vo,Jr]=n.useState(!1),[bo,Ja]=n.useState(!1),[Kr,Ka]=n.useState(""),[yo,qr]=n.useState(!1),[qa,el]=n.useState(""),[Va,tl]=n.useState(""),[Ya,sl]=n.useState(""),[al,rl]=n.useState(!1),ct=()=>`walletBalances_${(t==null?void 0:t.uid)||"default"}`,dt=()=>`cashBalance_${(t==null?void 0:t.uid)||"default"}`,Vr=()=>`debts_${(t==null?void 0:t.uid)||"default"}`,nl=()=>`customers_${(t==null?void 0:t.uid)||"default"}`,ll=()=>"debts_default",il=()=>`shopExpenses_${(t==null?void 0:t.uid)||"default"}`,jo=()=>{try{const s=localStorage.getItem(il());if(s){const a=JSON.parse(s);Wt(a.map(r=>({...r,createdAt:new Date(r.createdAt)})))}}catch(s){console.error("خطأ أثناء تحميل مصروفات المحل من التخزين:",s)}},No=async s=>{try{localStorage.setItem(il(),JSON.stringify(s)),Wt(s)}catch(a){console.error("خطأ أثناء حفظ مصروفات المحل في التخزين:",a)}},ol=()=>`deficiencies_${(t==null?void 0:t.uid)||"default"}`,wo=()=>{try{const s=localStorage.getItem(ol());if(s){const a=JSON.parse(s);ke(a.map(r=>({...r,createdAt:new Date(r.createdAt)})))}}catch(s){console.error("خطأ أثناء تحميل النواقص من التخزين:",s)}},Yr=async s=>{try{localStorage.setItem(ol(),JSON.stringify(s)),ke(s)}catch(a){console.error("خطأ أثناء حفظ النواقص في التخزين:",a)}},So=async s=>{try{localStorage.setItem(nl(),JSON.stringify(s)),Wr(s),t!=null&&t.uid&&await Ce.updateUserData(t.uid,{customers:s})}catch(a){console.error("خطأ أثناء حفظ العملاء في التخزين:",a)}},Do=async()=>{try{if(t!=null&&t.uid){const a=await ir(cs(xt,"users",t.uid));if(a.exists()){const r=a.data();if(r.customers&&Array.isArray(r.customers)){const i=r.customers.map(c=>{var p;return{...c,createdAt:(p=c.createdAt)!=null&&p.toDate?c.createdAt.toDate():new Date(c.createdAt)}});Wr(i);return}}}const s=localStorage.getItem(nl());if(s){const a=JSON.parse(s);Wr(a.map(r=>({...r,createdAt:new Date(r.createdAt)})))}}catch(s){console.error("خطأ أثناء تحميل العملاء من التخزين:",s)}},ga=()=>`transactions_${(t==null?void 0:t.uid)||"default"}`,fa=()=>`deletedTransactions_${(t==null?void 0:t.uid)||"default"}`,Xs=()=>`wallets_${(t==null?void 0:t.uid)||"default"}`,Es=()=>`selectedWallet_${(t==null?void 0:t.uid)||"default"}`,Hr=()=>{try{const s=Xs(),a=localStorage.getItem(s);if(a){const r=JSON.parse(a);if(Array.isArray(r)&&r.length>0)return r}}catch(s){console.warn("loadWalletsFromLocalWithMigration failed:",s)}return null},Gr=s=>{try{const a=Es(),r=localStorage.getItem(a);if(r&&s.find(i=>i.id===r))return r}catch{}return null},[Qr,Ha]=n.useState(""),[Et,cl]=n.useState(""),is=tt.useMemo(()=>{const s=Le;if(!s)return!1;const a=dc(s),r=s.planType??s.plan??null,i=typeof r=="string"?r.toLowerCase():null,c=i==="monthly"||i==="quarterly"||i==="yearly"||i==="lifetime"||r===ys.MONTHLY||r===ys.QUARTERLY||r===ys.YEARLY||r===ys.LIFETIME;return a&&c},[Le]),Ee=tt.useMemo(()=>{const s=Le;if(!s)return!1;const a=s.planType??s.plan??null,r=typeof a=="string"?a.toLowerCase():null;return a===ys.ZERO||r==="zero"},[Le]),Co=()=>{if(!is){l({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}M(!0)};n.useState(!1);const[Io,To]=n.useState(!1),[ko,Po]=n.useState(!1),[Ao,Oo]=n.useState(!1),[Wo,Ga]=n.useState(!1),[Qa,Xr]=n.useState(""),[Zr,en]=n.useState(""),[dl,ml]=n.useState(!1),[Fo,Xa]=n.useState(!1),[hl,tn]=n.useState(""),[ul,sn]=n.useState(""),[xl,pl]=n.useState(!1),gl=async()=>{if(t!=null&&t.uid)try{const s=`userData_${t.uid}`,a=localStorage.getItem(s),r=`debts_unsynced_${t.uid}`,i=localStorage.getItem(Vr()),c=localStorage.getItem(r)==="true";if(a){const p=JSON.parse(a);console.log("🔄 مزامنة البيانات المحلية مع Firebase...",p);const f={lastSynced:new Date().toISOString()};typeof p.cashBalance=="number"&&(f.cashBalance=p.cashBalance),p.walletBalances&&typeof p.walletBalances=="object"&&(f.walletBalances=p.walletBalances),await Ce.updateUserData(t.uid,f),localStorage.removeItem(s),ve(!1),console.log("✅ تمت المزامنة بنجاح وحذف البيانات المحلية")}else console.log("لا توجد بيانات محلية تحتاج للمزامنة");if(c&&i)try{const p=JSON.parse(i)||[];await Ce.updateUserData(t.uid,{debts:p});try{localStorage.removeItem(r)}catch{}ve(!1),console.log("✅ تمت مزامنة الديون مع Firebase")}catch(p){console.error("❌ فشل مزامنة الديون:",p),ve(!0)}}catch(s){console.error("❌ فشل في مزامنة البيانات:",s),l({title:"فشل في المزامنة",description:"حدث خطأ أثناء مزامنة البيانات مع الخادم",variant:"destructive"})}},fl=t!=null&&t.uid?`recentTransactionsResetAt:${t.uid}`:null,an=tt.useMemo(()=>{if(!fl)return null;try{const s=localStorage.getItem(fl);return s?new Date(s):null}catch{return null}},[t==null?void 0:t.uid]),vl=tt.useMemo(()=>{const s=vt||[];return an?s.filter(a=>new Date(a.createdAt)>=an):s},[vt,an]),bl=tt.useCallback(()=>{let s=vl;const a=Wn.trim();if(a&&(s=s.filter(r=>r.senderPhone&&r.senderPhone.includes(a)||r.receiverPhone&&r.receiverPhone.includes(a))),Oa){const r=new Date(Oa);s=s.filter(i=>{const c=new Date(i.createdAt);if(Wa){const[p,f]=Wa.split(":"),N=new Date(r);N.setHours(parseInt(p),parseInt(f),0,0);const D=new Date(N);return D.setHours(D.getHours()+1),c>=N&&c<D}else return c.toDateString()===r.toDateString()})}try{s=[...s].sort((r,i)=>{const c=new Date(r.createdAt||0).getTime();return new Date(i.createdAt||0).getTime()-c})}catch{}return s},[vl,Wn,Oa,Wa]),[Eo,Za]=n.useState(!1),[yl,er]=n.useState(""),[Bo,tr]=n.useState(!1),[rn,nn]=n.useState(""),[Mo,ve]=n.useState(!1);ye.reduce((s,a)=>s+(je[a.id]||0),0);const Lo=s=>Vt.verifyMasterPin(s),ln=s=>Vt.verifyMasterPin(s);n.useEffect(()=>{if(!(t!=null&&t.uid))return;console.log("🚀 استعادة البيانات من localStorage عند تحميل الصفحة للمستخدم:",t.uid);const s=`walletBalances_${t.uid}`,a=localStorage.getItem(s);if(a)try{const c=JSON.parse(a);console.log("📱 استعادة أرصدة المحافظ من localStorage:",c),Ze(c)}catch(c){console.error("خطأ في قراءة أرصدة المحافظ من localStorage:",c)}const r=`cashBalance_${t.uid}`;let i=localStorage.getItem(r);if(!i){const c=`userCashBalance_${t.uid}`,p=localStorage.getItem(c);if(p){i=p;try{localStorage.setItem(r,p),localStorage.removeItem(c)}catch{}}}if(i){const c=parseFloat(i);console.log("💰 استعادة رصيد الدرج النقدي من localStorage:",c),ht(c)}},[t==null?void 0:t.uid]);const jl=async()=>{try{if(!Q)return;const s=await js.autoResetLimitsIfNeeded(Q);io(s)}catch(s){console.error("خطأ في جلب حدود المحفظة المختارة:",s)}};n.useEffect(()=>{jl()},[Q]),n.useEffect(()=>{const s=a=>{var r;(r=a==null?void 0:a.detail)!=null&&r.walletId&&a.detail.walletId===Q&&jl()};return window.addEventListener("walletLimitsUpdated",s),()=>window.removeEventListener("walletLimitsUpdated",s)},[Q]),n.useEffect(()=>{if(g.state){if(console.log("Location state:",g.state),g.state.openDebtDialog&&(Ee?l({title:"غير متاح",description:"الديون/الأجل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):ha(!0),window.history.replaceState({},document.title)),g.state.openSalesDialog&&(Ee?l({title:"غير متاح",description:"بيانات المبيعات غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):ia(!0),window.history.replaceState({},document.title)),g.state.openMaintenanceDialog&&(Ee?l({title:"غير متاح",description:"الصيانة غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ba(!0),window.history.replaceState({},document.title)),g.state.openCreditCardsDialog&&(console.log("Opening credit cards dialog"),Ee?l({title:"غير متاح",description:"كروت الائتمان غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ea(!0),window.history.replaceState({},document.title)),g.state.openShopExpensesDialog&&(Ee?l({title:"غير متاح",description:"مصروفات المحل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Vt.hasMasterPin()?V(!0):ce(!0),window.history.replaceState({},document.title)),g.state.openDeficienciesDialog&&(Ee?l({title:"غير متاح",description:"النواقص غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):_t(!0),window.history.replaceState({},document.title)),g.state.openTransactionSection){const s=document.getElementById("transaction-section");s&&s.scrollIntoView({behavior:"smooth"}),g.state.transactionType&&fr(g.state.transactionType),g.state.startNewTransaction&&(h(""),K(""),Jt(""),Ct(""),console.log("🔒 Starting new transaction without changing wallet selection")),g.state.focusWalletSelection&&setTimeout(()=>{const a=document.querySelector('[data-testid="wallet-select"]');a&&a.focus()},500),window.history.replaceState({},document.title)}g.state.openCashierShiftModal&&(is?M(!0):l({title:"غير متاح",description:"وردية الكاشير متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"}),window.history.replaceState({},document.title)),g.state.openMachineDailyDialog&&(is?Ma(!0):l({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"}),window.history.replaceState({},document.title))}},[g.state,ye]),n.useEffect(()=>{var s;if(t!=null&&t.uid)try{const a=Hr();if(a&&a.length>0){ps(a);const r=Gr(a)||localStorage.getItem(Es()),i=r&&a.find(c=>c.id===r)?r:(s=a[0])==null?void 0:s.id;i&&!Q&&va(i,"localStorageHydration")}}catch(a){console.error("خطأ في تهيئة المحافظ من التخزين المحلي:",a)}},[t==null?void 0:t.uid]),n.useEffect(()=>{g.pathname==="/user/dashboard"&&sessionStorage.getItem("previousPath")==="/user/add-wallet"&&(console.log("🔄 Returned from wallet addition page - reloading wallets"),sr(),sessionStorage.removeItem("previousPath")),sessionStorage.setItem("previousPath",g.pathname)},[g.pathname,t==null?void 0:t.uid]),n.useEffect(()=>{if(!(t!=null&&t.uid))return;console.log("🔥 Setting up real-time user activation listener for:",t.uid);const s=cs(xt,"users",t.uid),a=mc(s,r=>{if(r.exists()){const i=r.data(),c=i.isActive===!0;console.log("🔥 Real-time user status update:",{userId:t.uid,isActive:c,subscription:i.subscription}),c&&!$?(console.log("🎉 User activated! Redirecting to dashboard..."),C(!0),Ue(!1),Z(!1)):!c&&$&&(console.log("❌ User deactivated! Showing activation modal..."),C(!1),Ue(!0))}},r=>{console.error("❌ Error in real-time user listener:",r)});return()=>{console.log("🔥 Cleaning up real-time user listener"),a()}},[t==null?void 0:t.uid,$]),n.useEffect(()=>{if(!(t!=null&&t.uid))return;const s=r=>{const{userId:i}=r.detail;i===t.uid&&(console.log("🎉 Subscription activation event received for current user!"),C(!0),Ue(!1),Z(!1),setTimeout(()=>{console.log("✅ User activation completed - data updated")},1e3))},a=r=>{const{userId:i,isActive:c}=r.detail;i===t.uid&&(console.log("🔄 User subscription update event received:",{userId:i,isActive:c}),c&&!$&&(C(!0),Ue(!1),Z(!1),setTimeout(()=>{console.log("✅ User subscription updated - data refreshed")},1e3)))};return window.addEventListener("subscriptionActivated",s),window.addEventListener("userSubscriptionUpdated",a),()=>{window.removeEventListener("subscriptionActivated",s),window.removeEventListener("userSubscriptionUpdated",a)}},[t==null?void 0:t.uid,$]),n.useEffect(()=>{const s=a=>{var p;const r=a.target,i=(p=r==null?void 0:r.tagName)==null?void 0:p.toLowerCase();if(!(i==="input"||i==="textarea"||i==="select"||((r==null?void 0:r.isContentEditable)??!1))&&!(a.ctrlKey||a.altKey||a.metaKey)&&!a.repeat){if(Ee&&a.key>="1"&&a.key<="9"){a.preventDefault();return}switch(a.key){case"1":break;case"2":Sr(!0);break;case"3":Ee?l({title:"غير متاح",description:"كروت الائتمان غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ea(!0);break;case"4":is?M(!0):l({title:"غير متاح",description:"وردية الكاشير متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});break;case"5":Ee?l({title:"غير متاح",description:"بيانات المبيعات غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):ia(!0);break;case"6":Ee?l({title:"غير متاح",description:"الديون/الأجل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):ha(!0);break;case"7":Ee?l({title:"غير متاح",description:"الصيانة غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ba(!0);break;case"8":is?Ma(!0):l({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});break;case"9":Ee?l({title:"غير متاح",description:"مصروفات المحل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Vt.hasMasterPin()?V(!0):ce(!0);break}}};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[Ee,is]),n.useEffect(()=>{console.log("🔥 useEffect loadUserData started",{user:t==null?void 0:t.uid,isCheckingActivation:_}),(async()=>{try{if(!(t!=null&&t.uid)){console.log("🔥 No user UID, setting isCheckingActivation to false"),Z(!1);return}let i=!1;const c=`userData_${t==null?void 0:t.uid}`,p=localStorage.getItem(c);if(p)try{const j=JSON.parse(p);j.walletBalances&&(Ze(j.walletBalances),i=!0,console.log("⚡ تحميل فوري لأرصدة المحافظ من بيانات المستخدم:",j.walletBalances))}catch(j){console.error("خطأ في قراءة بيانات المستخدم من localStorage:",j)}if(!i){const j=localStorage.getItem(ct());if(j)try{const W=JSON.parse(j);Ze(W),i=!0,console.log("⚡ تحميل فوري لأرصدة المحافظ من النسخة الاحتياطية:",W)}catch(W){console.error("خطأ في قراءة أرصدة المحافظ من localStorage:",W)}}if(!i){const W=Object.keys(localStorage).filter(G=>G.startsWith("walletBalances_backup_")).sort().reverse();for(const G of W)try{const k=localStorage.getItem(G);if(k){const Y=JSON.parse(k);Ze(Y),i=!0,console.log("⚡ تحميل فوري لأرصدة المحافظ من النسخة الاحتياطية بالتوقيت:",Y);break}}catch(k){console.error("خطأ في قراءة النسخة الاحتياطية:",k);continue}}let f=localStorage.getItem(dt());if(!f&&(t!=null&&t.uid)){const j=`userCashBalance_${t.uid}`,W=localStorage.getItem(j);if(W){f=W;try{localStorage.setItem(dt(),W),localStorage.removeItem(j)}catch{}}}f&&(ht(parseFloat(f)),console.log("⚡ تحميل فوري لرصيد الدرج النقدي من localStorage:",f));try{const j=await ir(cs(xt,"users",t.uid));if(j.exists()){const G=j.data().isActive===!0,k=await Sa.checkTrialValidity(t.uid),Y=k.isValid&&!k.isExpired;C(G||Y),rt(Y),te(k.hoursRemaining),Ne(k.hasUsedTrial),Ue(!G&&!Y),console.log("📊 حالة المستخدم:",{isActive:G,isOnTrial:Y,hoursRemaining:k.hoursRemaining,hasUsedTrial:k.hasUsedTrial})}else C(!1),Ue(!0)}catch(j){console.error("خطأ في فحص حالة تفعيل المستخدم:",j),C(!1),Ue(!0)}finally{Z(!1)}console.log("🔄 بدء تحميل بيانات المستخدم من Firebase...",{userId:t==null?void 0:t.uid});const N=localStorage.getItem(c);let D=!1;if(N)try{const j=JSON.parse(N),W=new Date(j.lastUpdated);(new Date().getTime()-W.getTime())/(1e3*60)<1&&(D=!0,console.log("⚡ توجد تغييرات محلية حديثة (أقل من دقيقة)، تجنب إعادة التحميل من Firebase"),j.walletBalances&&Ze(j.walletBalances),j.cashBalance!==void 0&&ht(j.cashBalance))}catch(j){console.error("خطأ في قراءة البيانات المحلية:",j)}if(N&&!D)try{const j=JSON.parse(N),W=new Date(j.lastUpdated);(new Date().getTime()-W.getTime())/(1e3*60)>10&&(console.log("🗑️ حذف البيانات المحلية القديمة (أكثر من 10 دقائق)"),localStorage.removeItem(c))}catch(j){console.error("خطأ في حذف البيانات المحلية القديمة:",j)}if(!D&&(t!=null&&t.uid)){const j=await Ce.getUserData(t.uid);if(console.log("📥 البيانات المحملة من Firebase:",j),j){const W=(j==null?void 0:j.walletBalances)||{},G=j!=null&&j.lastUpdated?new Date(j.lastUpdated):null;let k=null,Y=null;try{const De=localStorage.getItem(c);De&&(k=JSON.parse(De),k!=null&&k.lastUpdated&&(Y=new Date(k.lastUpdated)))}catch(De){console.error("خطأ في قراءة بيانات النسخة المحلية للمقارنة:",De)}if(!!(Y&&(!G||Y>G))&&(k!=null&&k.walletBalances)){console.log("⚖️ تفضيل الأرصدة المحلية الأحدث على Firebase"),Ze(k.walletBalances);try{localStorage.setItem(ct(),JSON.stringify(k.walletBalances))}catch{}try{await Ce.updateUserData(t.uid,{walletBalances:k.walletBalances,lastUpdated:Y.toISOString()})}catch(De){console.error("فشل مزامنة الأرصدة المحلية الأحدث إلى Firebase:",De),ve(!0)}}else{console.log("🏛️ اعتماد Firebase كمصدر الحقيقة لأرصدة المحافظ"),Ze(W);try{localStorage.setItem(ct(),JSON.stringify(W))}catch{}}if((j==null?void 0:j.cashBalance)!==void 0){console.log("💰 تحميل رصيد الدرج النقدي من Firebase:",j.cashBalance),ht(j.cashBalance);try{localStorage.setItem(dt(),j.cashBalance.toString())}catch{}}try{const De=t!=null&&t.uid?await lr.getDeletedTransactionsByUser(t.uid):[];if(De&&De.length>0)Os(De),console.log("🗑️ تم تحميل المعاملات المحذوفة من Firebase:",De.length);else{const We=localStorage.getItem(fa());if(We)try{const be=JSON.parse(We);Os(be),console.log("🗑️ تم تحميل المعاملات المحذوفة من localStorage:",be.length)}catch(be){console.error("خطأ في قراءة المعاملات المحذوفة من localStorage:",be)}}}catch(De){console.error("خطأ في تحميل المعاملات المحذوفة من Firebase:",De);const We=localStorage.getItem(fa());if(We)try{const be=JSON.parse(We);Os(be),console.log("🗑️ تم تحميل المعاملات المحذوفة من localStorage (fallback):",be.length)}catch(be){console.error("خطأ في قراءة المعاملات المحذوفة من localStorage:",be)}}}else{console.log("⚠️ لا توجد بيانات مستخدم في Firebase، محاولة استعادة من localStorage");const W=localStorage.getItem(ct());if(W)try{const k=JSON.parse(W);console.log("📱 استعادة أرصدة المحافظ من localStorage:",k),Ze(k)}catch(k){console.error("خطأ في قراءة أرصدة المحافظ من localStorage:",k)}let G=localStorage.getItem(dt());if(!G&&(t!=null&&t.uid)){const k=`userCashBalance_${t.uid}`,Y=localStorage.getItem(k);if(Y){G=Y;try{localStorage.setItem(dt(),Y),localStorage.removeItem(k)}catch{}}}G&&(ht(parseFloat(G)),console.log("💰 استعادة رصيد الدرج النقدي من localStorage:",G));try{const k=t!=null&&t.uid?await lr.getDeletedTransactionsByUser(t.uid):[];if(k&&k.length>0)Os(k),console.log("🗑️ تم تحميل المعاملات المحذوفة من Firebase:",k.length);else{const Y=localStorage.getItem(fa());if(Y)try{const Se=JSON.parse(Y);Os(Se),console.log("🗑️ تم تحميل المعاملات المحذوفة من localStorage:",Se.length)}catch(Se){console.error("خطأ في قراءة المعاملات المحذوفة من localStorage:",Se)}}}catch(k){console.error("خطأ في تحميل المعاملات المحذوفة من Firebase:",k);const Y=localStorage.getItem(fa());if(Y)try{const Se=JSON.parse(Y);Os(Se),console.log("🗑️ تم تحميل المعاملات المحذوفة من localStorage (fallback):",Se.length)}catch(Se){console.error("خطأ في قراءة المعاملات المحذوفة من localStorage:",Se)}}}}console.log("🔄 بدء تحميل المحافظ من Firebase...");try{const j=await Ts.getByMerchantId((t==null?void 0:t.uid)||"");if(j&&j.length>0){console.log("✅ تم العثور على محافظ في Firebase:",j.length);const W=j.map(Y=>({id:Y.id,name:Y.label||"محفظة بدون اسم",phone:Y.msisdn,isDefault:!1,monthlyWithdrawalLimit:Y.monthlyWithdrawalLimit??Y.withdrawLimit??2e5,monthlyTransferLimit:Y.monthlyTransferLimit??Y.transferLimit??2e5,defaultTransferCommission:Y.defaultTransferCommission!=null?Number(Y.defaultTransferCommission):null,defaultWithdrawCommission:Y.defaultWithdrawCommission!=null?Number(Y.defaultWithdrawCommission):null}));ps(W),localStorage.setItem(Xs(),JSON.stringify(W));const G=localStorage.getItem(Es());let k=null;G&&W.find(Y=>Y.id===G)?k=W.find(Y=>Y.id===G):k=W[0],k&&(Hs(k.id),Nt(k.phone)),console.log("🔄 تم تحديث المحافظ من Firebase وحفظها في localStorage")}else{console.log("⚠️ لا توجد محافظ في Firebase، محاولة التحميل من localStorage...");const W=Hr();if(W&&W.length>0)try{console.log("📱 تم العثور على محافظ محلية بعد الهجرة:",W.length),ps(W);const G=Gr(W)||localStorage.getItem(Es());let k=null;G&&W.find(Y=>Y.id===G)?k=W.find(Y=>Y.id===G):k=W.find(Y=>Y.isDefault)||W[0],k&&(Hs(k.id),Nt(k.phone))}catch(G){console.error("خطأ في معالجة المحافظ بعد الهجرة:",G)}else console.log("⚠️ لا توجد محافظ محلية، لن نقوم بإنشاء محافظ افتراضية."),ps([])}}catch(j){console.error("خطأ في تحميل المحافظ من Firebase:",j);const W=Hr();if(W&&W.length>0)try{console.log("📱 استخدام المحافظ من localStorage بعد الهجرة:",W.length),ps(W);const G=Gr(W)||localStorage.getItem(Es());let k=null;G&&W.find(Y=>Y.id===G)?k=W.find(Y=>Y.id===G):k=W.find(Y=>Y.isDefault)||W[0],k&&(Hs(k.id),Nt(k.phone))}catch(G){console.error("خطأ في قراءة المحافظ من localStorage بعد الهجرة:",G),ps([])}else console.log("⚠️ لا توجد محافظ محلية، لن يتم إنشاء محافظ افتراضية"),ps([])}const S=t!=null&&t.uid?await Ce.getUserTransactions(t.uid):[];if(S&&S.length>0){console.log("📊 تم تحميل المعاملات من Firebase:",S.length);const j=S.map(k=>({...k,createdAt:new Date(k.createdAt),senderPhone:k.senderMsisdn||k.senderPhone||"",receiverPhone:k.receiverMsisdn||k.receiverPhone||"",type:k.txnType==="send"?"send":k.txnType==="receive"?"withdraw":k.type||"withdraw",status:k.status==="confirmed"?"completed":k.status||"completed"})),W=An.map(k=>k.id||k.originalTransactionId),G=j.filter(k=>!W.includes(k.id));console.log("✅ تم فلترة المعاملات المحذوفة:",{total:S.length,deleted:W.length,active:G.length}),Ss(G)}await gl()}catch(i){console.error("خطأ في تحميل بيانات المستخدم من Firebase:",i);let c=localStorage.getItem(dt());if(!c&&(t!=null&&t.uid)){const f=`userCashBalance_${t.uid}`,N=localStorage.getItem(f);if(N){c=N;try{localStorage.setItem(dt(),N),localStorage.removeItem(f)}catch{}}}c&&ht(parseFloat(c));const p=localStorage.getItem(ct());if(p)try{const f=JSON.parse(p);Ze(f),console.log("📱 تم استعادة أرصدة المحافظ من localStorage:",f)}catch(f){console.error("خطأ في قراءة أرصدة المحافظ من localStorage:",f)}}})().then(async()=>{await a(),await r()});const a=async()=>{try{for(const i of ye)await Ac.autoResetLimitsIfNeeded(i.phone)}catch(i){console.error("خطأ في التصفير التلقائي للحدود:",i)}},r=async()=>{try{await Rt.syncReportsDataFromFirebase(t==null?void 0:t.uid);const i=Rt.getReportsData(t==null?void 0:t.uid);if((i.lastDailyResetDate?Rt.shouldResetDailyReports(i.lastDailyResetDate):!1)&&(t!=null&&t.uid)&&i.lastDailyResetDate){const f=new Date(i.lastDailyResetDate),N=f.toDateString();let D=vt.filter(De=>new Date(De.createdAt).toDateString()===N&&De.status==="completed");const S=Rt.filterVisibleTransactions(D,"daily",t==null?void 0:t.uid),j=S.length,W=S.reduce((De,We)=>De+We.amount,0),G=S.filter(ba).reduce((De,We)=>{const be=We.withdrawnAmount!==void 0?We.withdrawnAmount:We.amount;return De+be},0),k=S.filter(ya).reduce((De,We)=>{const be=We.sentAmount!==void 0?We.sentAmount:We.amount;return De+be},0),Y=S.reduce((De,We)=>De+Rt.calculateTransactionProfit(We),0),Se=new Date(f).toISOString().slice(0,10);await zl.add({userId:t.uid,reportDate:Se,totalTransactions:j,totalAmount:Number(W.toFixed(2)),totalWithdrawn:Number(G.toFixed(2)),totalSent:Number(k.toFixed(2)),profit:Number(Y.toFixed(2)),walletId:null}),l({title:"تم أرشفة تقارير اليوم",description:Se})}const p=Rt.autoResetReportsIfNeeded(t==null?void 0:t.uid);(p.dailyReset||p.monthlyReset)&&console.log("تم التصفير التلقائي:",p)}catch(i){console.error("خطأ في التصفير التلقائي للتقارير:",i)}};ho(),oo(),Do(),console.log("🔥 useEffect loadUserData completed")},[t==null?void 0:t.uid]);const sr=async()=>{var s;if(t!=null&&t.uid)try{const a=await Ts.getByMerchantId(t.uid);if(a&&a.length>0){const r=a.map(i=>({id:i.id,name:i.label||"محفظة بدون اسم",phone:i.msisdn,isDefault:!1,monthlyWithdrawalLimit:i.monthlyWithdrawalLimit??i.withdrawLimit??2e5,monthlyTransferLimit:i.monthlyTransferLimit??i.transferLimit??2e5,defaultTransferCommission:i.defaultTransferCommission!=null?Number(i.defaultTransferCommission):void 0,defaultWithdrawCommission:i.defaultWithdrawCommission!=null?Number(i.defaultWithdrawCommission):void 0}));if(ps(r),localStorage.setItem(Xs(),JSON.stringify(r)),t!=null&&t.uid){const i=localStorage.getItem(Es());if(!!(Q&&r.find(p=>p.id===Q)))console.log("🔒 Preserving current wallet selection:",Q);else{const f=(i&&r.find(N=>N.id===i)?i:null)||((s=r[0])==null?void 0:s.id);f&&(console.log("🔄 Fixing invalid wallet selection:",f),va(f))}}console.log("🔄 تم تحديث المحافظ من Firebase:",r.length)}}catch(a){console.error("خطأ في تحميل المحافظ من Firebase:",a)}};n.useEffect(()=>{const s=g.pathname;sessionStorage.getItem("previousPath")==="/user/add-wallet"&&s==="/user/dashboard"&&(console.log("🔄 Returning from add wallet page - reloading wallets"),console.log("🔒 Current wallet before add-wallet return reload:",Q),sr(),sessionStorage.removeItem("previousPath")),sessionStorage.setItem("previousPath",s)},[g.pathname,t==null?void 0:t.uid]),n.useEffect(()=>{const s=()=>{console.log("🔄 Window focused - reloading wallets"),console.log("🔒 Current wallet before focus reload:",Q),sr().then(()=>{console.log("🔒 Wallet preserved after focus reload:",Q)})};return window.addEventListener("focus",s),()=>{window.removeEventListener("focus",s)}},[t==null?void 0:t.uid,Q,ye]);const va=(s,a="unknown")=>{console.log(`🎯 setWalletSelection called from ${a} with walletId:`,s),console.log("🔍 Previous selectedWallet:",Q),Hs(s);const r=ye.find(i=>i.id===s);r&&(Nt(r.phone),console.log("✅ Wallet set successfully:",s,"Phone:",r.phone)),t!=null&&t.uid&&(localStorage.setItem(Es(),s),console.log("💾 Saved wallet to localStorage:",s))},$o=s=>{if(s==="__add_wallet"){m("/user/add-wallet");return}if(s==="__view_wallets"){ft(!0);return}va(s,"handleWalletChange")},ar=s=>{console.log("🔄 handleTransactionTypeChange called with type:",s),console.log("🔍 Current selectedWallet before change:",Q),console.log("🔍 Available wallets count:",ye.length),fr(s),h(""),K(""),Jt(""),Ct(""),console.log("✅ Transaction type changed to:",s,"- Wallet selection preserved:",Q),setTimeout(()=>{const a=document.getElementById("transaction-section");a&&a.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})},100)};n.useEffect(()=>{const s=a=>{const r=a.target;if(!!r&&(r.tagName==="INPUT"||r.tagName==="TEXTAREA"||r.tagName==="SELECT"||r.isContentEditable)||(a.key==="ArrowLeft"?(a.preventDefault(),ar("withdraw")):a.key==="ArrowRight"&&(a.preventDefault(),ar("transfer"))),a.key==="Enter"){const c=ae==="transfer"?"transferSubmitButton":"withdrawSubmitButton",p=document.getElementById(c);p&&!p.disabled&&(a.preventDefault(),p.click())}};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[ae]);const Ro=s=>{Ei((r=>({id:r.id,type:r.type==="send"?"transfer":"withdraw",sender_msisdn:r.senderPhone,receiver_msisdn:r.receiverPhone,amount:r.amount,commission:r.commission||0,fee:(r==null?void 0:r.fee)??0,status:r.status==="failed"?"failed":r.status==="completed"?"completed":"pending",createdAt:new Date(r.createdAt).toISOString(),updatedAt:new Date(r.createdAt).toISOString(),shopName:B??(E==null?void 0:E.shopName)??(t==null?void 0:t.displayName)??"المحل",cashierName:(r==null?void 0:r.cashierName)??null,commissionMode:(r==null?void 0:r.commissionMode)??(r.type==="send"||ie?"add":"deduct"),totalCharged:(r==null?void 0:r.totalCharged)??(r.type==="send"?Number(r.amount||0)+Number(r.commission||0)+Number((r==null?void 0:r.fee)||0):ie?Number(r.amount||0)+Number(r.commission||0):Number(r.amount||0))}))(s)),Aa(!0)},Uo=async s=>{if(!(t!=null&&t.uid)){l({title:"خطأ في المصادقة",description:"يجب تسجيل الدخول أولاً لحذف المعاملات",variant:"destructive"});return}const a=vt.find(r=>r.id===s);if(!a){l({title:"خطأ في الحذف",description:"لم يتم العثور على المعاملة المطلوب حذفها",variant:"destructive"});return}try{console.log("🗑️ بدء عملية حذف المعاملة:",s),console.log("🔄 حذف المعاملة نهائياً من Firebase...",{transactionId:a.id,userId:t.uid,transactionData:a}),await Ce.removeUserTransaction(t.uid,a.id),console.log("✅ تم حذف المعاملة نهائياً من Firebase userTransactions");try{await lr.saveDeletedTransaction({...a,userId:t.uid,originalTransactionId:a.id,deletedAt:new Date().toISOString()}),console.log("✅ تم حفظ المعاملة في سجل المحذوفات مع تاريخ الحذف")}catch(c){console.warn("⚠️ فشل في حفظ المعاملة في سجل المحذوفات، لكن الحذف من Firebase نجح:",c)}const r=[...An,a],i=vt.filter(c=>c.id!==s);Os(r),Ss(i),Tn(!1),localStorage.setItem(fa(),JSON.stringify(r)),localStorage.setItem(ga(),JSON.stringify(i)),console.log("✅ تم تحديث البيانات المحلية بنجاح بعد الحذف من Firebase");try{let c=localStorage.getItem(dt());if(!c&&(t!=null&&t.uid)){const D=`userCashBalance_${t.uid}`,S=localStorage.getItem(D);if(S){c=S;try{localStorage.setItem(dt(),S),localStorage.removeItem(D)}catch{}}}const p=localStorage.getItem(ct());let f=c?parseFloat(c):0,N=p?JSON.parse(p):{};if(a.type==="send"){const D=a.commission||0;f-=D;const S=a.fromWallet||Object.keys(N)[0];if(S){const j=N[S]||0;N[S]=j+a.amount}}else if(a.type==="withdraw"){const D=a.commission||0;f+=a.amount,f-=D;const S=a.fromWallet||Object.keys(N)[0];if(S){const j=N[S]||0;N[S]=Math.max(0,j-a.amount)}}localStorage.setItem(dt(),f.toString()),localStorage.setItem(ct(),JSON.stringify(N))}catch(c){console.warn("فشل عكس تأثير الأرصدة محليًا بعد الحذف:",c)}try{const c=a.fromWallet;if(c){const{walletDailyLimitsService:p}=await Is(async()=>{const{walletDailyLimitsService:N}=await import("./walletDailyLimitsService-BPucvIOt.js");return{walletDailyLimitsService:N}},__vite__mapDeps([2,0,1])),f=await p.getWalletLimits(c);if(f){const N=a.type==="send",D={updatedAt:(await Is(async()=>{const{serverTimestamp:k}=await import("./index-CtI5CTI7.js").then(Y=>Y.a$);return{serverTimestamp:k}},__vite__mapDeps([0,1]))).serverTimestamp()};N?(D.dailyTransferUsed=Math.max(0,(f.dailyTransferUsed||0)-a.amount),D.monthlyTransferUsed=Math.max(0,(f.monthlyTransferUsed||0)-a.amount)):(D.dailyWithdrawUsed=Math.max(0,(f.dailyWithdrawUsed||0)-a.amount),D.monthlyWithdrawUsed=Math.max(0,(f.monthlyWithdrawUsed||0)-a.amount));const{doc:S,setDoc:j}=await Is(async()=>{const{doc:k,setDoc:Y}=await import("./index-CtI5CTI7.js").then(Se=>Se.a$);return{doc:k,setDoc:Y}},__vite__mapDeps([0,1])),{db:W}=await Is(async()=>{const{db:k}=await import("./index-CtI5CTI7.js").then(Y=>Y.b0);return{db:k}},__vite__mapDeps([0,1])),G=S(W,"walletLimits",c);await j(G,D,{merge:!0})}}}catch(c){console.warn("فشل استرجاع حدود المحفظة بعد الحذف:",c)}try{const{ProfitService:c}=await Is(async()=>{const{ProfitService:S}=await import("./profitService-D4-kgAVt.js");return{ProfitService:S}},__vite__mapDeps([3,4,0,1])),{ReportsService:p}=await Is(async()=>{const{ReportsService:S}=await import("./reportsService-Czc76COW.js");return{ReportsService:S}},__vite__mapDeps([4,0,1])),N={txnType:a.type==="send"?"send":"receive",amount:a.amount,commission:a.commission||0,createdAt:a.createdAt,status:"confirmed"},D=c.calculateProfitFromTransaction(N);D>0&&c.addProfit(-D,t.uid);try{p.removeTransactionEffects(a,t.uid)}catch{}}catch(c){console.warn("فشل تحديث الأرباح/التقارير بعد الحذف:",c)}l({title:"تم حذف المعاملة نهائياً",description:"تم حذف المعاملة نهائياً من النظام. يمكنك العثور عليها في قائمة المحذوفات"})}catch(r){console.error("❌ خطأ في حذف المعاملة من Firebase:",r);let i="فشل في حذف المعاملة من الخادم. يرجى المحاولة مرة أخرى";r instanceof Error&&(r.message.includes("network")||r.message.includes("offline")?i="مشكلة في الاتصال بالإنترنت. تحقق من الاتصال وحاول مرة أخرى":r.message.includes("permission")||r.message.includes("unauthorized")?i="ليس لديك صلاحية لحذف هذه المعاملة":r.message.includes("not-found")&&(i="المعاملة غير موجودة أو تم حذفها مسبقاً")),l({title:"خطأ في الحذف",description:i,variant:"destructive"})}},ba=s=>{const a=s.type,r=s.txnType;return a==="withdraw"||a==="withdrawal"||a==="receive"||r==="receive"},ya=s=>{const a=s.type,r=s.txnType;return a==="send"||a==="transfer"||r==="send"},rr=(s,a)=>{const r=new Date().toDateString();let i=vt.filter(S=>new Date(S.createdAt).toDateString()===r&&S.status==="completed");Cs&&Cs.trim()!==""&&(i=i.filter(S=>S.senderPhone&&S.senderPhone.includes(Cs)||S.receiverPhone&&S.receiverPhone.includes(Cs)));const c=Rt.filterVisibleTransactions(i,"daily",t==null?void 0:t.uid),p=c.length,f=c.reduce((S,j)=>S+j.amount,0),N=c.filter(ba).reduce((S,j)=>{const W=j.withdrawnAmount!==void 0?j.withdrawnAmount:j.amount;return S+W},0),D=c.filter(ya).reduce((S,j)=>{const W=j.sentAmount!==void 0?j.sentAmount:j.amount;return S+W},0);return{totalTransactions:p,totalAmount:f,totalWithdrawn:N,totalSent:D}},ja=s=>{const a=new Date().getMonth(),r=new Date().getFullYear();let i=vt.filter(S=>{const j=new Date(S.createdAt);return j.getMonth()===a&&j.getFullYear()===r&&S.status==="completed"});Cs&&Cs.trim()!==""&&(i=i.filter(S=>S.senderPhone&&S.senderPhone.includes(Cs)||S.receiverPhone&&S.receiverPhone.includes(Cs)));const c=Rt.filterVisibleTransactions(i,"monthly",t==null?void 0:t.uid),p=c.length,f=c.reduce((S,j)=>S+j.amount,0),N=c.filter(ba).reduce((S,j)=>{const W=j.withdrawnAmount!==void 0?j.withdrawnAmount:j.amount;return S+W},0),D=c.filter(ya).reduce((S,j)=>{const W=j.sentAmount!==void 0?j.sentAmount:j.amount;return S+W},0);return{totalTransactions:p,totalAmount:f,totalWithdrawn:N,totalSent:D}},Nl=s=>{const a=new Date().getMonth(),r=new Date().getFullYear(),i=vt.filter(f=>{const N=new Date(f.createdAt);return N.getMonth()===a&&N.getFullYear()===r&&f.status==="completed"&&f.fromWallet===s}),c=i.filter(ba).reduce((f,N)=>{const D=N.withdrawnAmount||N.amount;return f+D},0),p=i.filter(ya).reduce((f,N)=>{const D=N.sentAmount||N.amount;return f+D},0);return{totalWithdrawn:c,totalTransferred:p}},_o=s=>{const a=new Date,r=a.getDate(),i=a.getMonth(),c=a.getFullYear(),p=vt.filter(D=>{const S=new Date(D.createdAt);return S.getDate()===r&&S.getMonth()===i&&S.getFullYear()===c&&D.status==="completed"&&D.fromWallet===s}),f=p.filter(ba).reduce((D,S)=>{const j=S.withdrawnAmount||S.amount;return D+j},0),N=p.filter(ya).reduce((D,S)=>{const j=S.sentAmount||S.amount;return D+j},0);return{totalWithdrawn:f,totalTransferred:N}};ja(),n.useEffect(()=>{const s=localStorage.getItem(ga());if(s){const r=JSON.parse(s).map(i=>({...i,createdAt:new Date(i.createdAt)}));Ss(r)}},[]),n.useEffect(()=>{vt.length>0&&localStorage.setItem(ga(),JSON.stringify(vt))},[vt]);const wl=async()=>{Id(),console.log("🔄 بدء عملية التحويل/السحب"),console.log("📊 البيانات المدخلة:",{senderPhone:Re,receiverPhone:it,amount:P,transactionType:ae});const s=()=>{ae==="transfer"?Gs(!0):ca(!0)},a=()=>{ae==="transfer"?Gs(!1):ca(!1)};if(s(),!Re||!P){console.log("❌ خطأ: بيانات ناقصة"),l({title:"خطأ في البيانات",description:"يرجى ملء جميع الحقول المطلوبة",variant:"destructive"}),a();return}if(ae==="transfer"&&!it&&!T){console.log("❌ خطأ: رقم المستقبل مفقود"),l({title:"خطأ في البيانات",description:"يرجى إدخال رقم المستقبل",variant:"destructive"}),a();return}if(ae==="transfer"&&!T&&!Td(it)){l({title:"رقم المستقبل غير صالح",description:"اكتب رقم صحيح مكون من 11 رقم ويبدأ بـ 015 أو 010 أو 012 أو 011",variant:"destructive"}),a();return}const r=parseFloat(P);if(console.log("💰 المبلغ المحول:",r),r<=0){console.log("❌ خطأ: مبلغ غير صحيح"),l({title:"خطأ في المبلغ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"}),a();return}if(Ee)try{const oe=new Date,et=oe.getFullYear(),qt=String(oe.getMonth()+1).padStart(2,"0"),yt=String(oe.getDate()).padStart(2,"0"),vs=`zeroPlanDailyConfirmCount:${(t==null?void 0:t.uid)||"default"}:${et}-${qt}-${yt}`,Xt=localStorage.getItem(vs);if((Xt&&parseInt(Xt,10)||0)>=10){l({title:"حد التأكيد اليومي",description:"باقة زيرو تسمح بـ 10 تأكيدات تحويل/سحب يومياً فقط.",variant:"destructive"}),a();return}}catch(oe){console.warn("فشل قراءة عداد تأكيدات باقة زيرو من التخزين المحلي:",oe)}const i=ye.find(oe=>oe.id===Q);if(!i){l({title:"خطأ في المحفظة",description:"يرجى اختيار محفظة صحيحة",variant:"destructive"}),a();return}const c=Nl(Q);if(console.log("📈 فحص الحدود الشهرية للمحفظة المختارة"),console.log("📊 الإحصائيات الشهرية للمحفظة:",{walletId:Q,walletName:i.name,currentWithdrawn:c.totalWithdrawn,currentTransferred:c.totalTransferred,withdrawalLimit:i.monthlyWithdrawalLimit,transferLimit:i.monthlyTransferLimit}),ae==="withdraw"){if(console.log("🏧 فحص حد السحب الشهري للمحفظة"),console.log(`💸 المسحوب حالياً من المحفظة: ${c.totalWithdrawn}, المبلغ الجديد: ${r}, الحد الأقصى: ${i.monthlyWithdrawalLimit}`),c.totalWithdrawn+r>i.monthlyWithdrawalLimit){console.log("❌ تجاوز حد السحب الشهري للمحفظة"),l({title:"تجاوز حد السحب الشهري",description:`لا يمكن سحب أكثر من ${i.monthlyWithdrawalLimit} جنيه شهرياً من محفظة ${i.name}`,variant:"destructive"}),a();return}}else if(console.log("💸 فحص حد التحويل الشهري للمحفظة"),console.log(`📤 المحول حالياً من المحفظة: ${c.totalTransferred}, المبلغ الجديد: ${r}, الحد الأقصى: ${i.monthlyTransferLimit}`),c.totalTransferred+r>i.monthlyTransferLimit){console.log("❌ تجاوز حد التحويل الشهري للمحفظة"),l({title:"تجاوز حد التحويل الشهري",description:`لا يمكن تحويل أكثر من ${i.monthlyTransferLimit} جنيه شهرياً من محفظة ${i.name}`,variant:"destructive"}),a();return}const p=(E==null?void 0:E.shopName)||(t==null?void 0:t.displayName)||"محل كاشي لينك",f={id:Date.now().toString(),type:ae==="transfer"?"send":ae==="deposit"?"deposit":"withdraw",senderPhone:Re,receiverPhone:ae==="transfer"?it:Re,amount:r,status:"completed",createdAt:new Date,withdrawnAmount:ae==="withdraw"?r:void 0,sentAmount:ae==="transfer"?r:void 0,depositedAmount:void 0,fromWallet:Q,senderNumber:Re,senderName:Re,shopName:(i==null?void 0:i.name)||"المحفظة الرئيسية",transferredAmount:ae==="transfer"?r:void 0,receiverNumber:ae==="transfer"?it:void 0,withdrawnAmountDetailed:ae==="withdraw"?r:void 0,depositedAmountDetailed:void 0,merchantShopName:p,transactionReference:`TXN-${Date.now()}`,commission:0,notes:ae==="transfer"?`تحويل من ${Re} إلى ${it}`:`سحب نقدي من محفظة ${Re}`};w&&(b!=null&&b.name||b!=null&&b.username)&&(f.cashierName=(b==null?void 0:b.name)||(b==null?void 0:b.username));const N=sa.validateTransaction(r,ae,Xe,je);if(!N.isValid){l({title:"خطأ في العملية",description:N.error,variant:"destructive"}),a();return}N.warning&&l({title:"تحذير",description:N.warning,variant:"destructive"});let D;if(ae==="transfer")if((i==null?void 0:i.defaultTransferCommission)!=null){const oe=Number(i.defaultTransferCommission)||0;D=Math.round(oe*r/1e3*100)/100}else He&&He.trim()!==""?D=Math.max(0,parseFloat(He)):D=0;else if((i==null?void 0:i.defaultWithdrawCommission)!=null){const oe=Number(i.defaultWithdrawCommission)||0;D=Math.round(oe*r/1e3*100)/100}else Te&&Te.trim()!==""?D=Math.max(0,parseFloat(Te)):D=Math.round(r*.01*100)/100;if(f.commission=D,ae!=="transfer"&&!ie&&D>=r){l({title:"خطأ في العمولة",description:"العمولة أكبر من أو تساوي المبلغ المدخل",variant:"destructive"}),a();return}const S=ae==="transfer"||ie?r:Math.round((r-D)*100)/100;f.amount=S,f.withdrawnAmount=ae==="withdraw"?S:void 0,f.sentAmount=ae==="transfer"?S:void 0,f.transferredAmount=ae==="transfer"?S:void 0,f.withdrawnAmountDetailed=ae==="withdraw"?S:void 0;let j;const W=ae==="transfer"&&!!Ye,G=ae==="withdraw"&&!!Ye,k=W||G;let Y=null;const Se=ns(Re||"").replace(/\D/g,""),De=ns(it||"").replace(/\D/g,""),We=ae==="transfer"&&(Se.startsWith("010")&&(De.startsWith("011")||De.startsWith("012")||De.startsWith("015"))||Se.startsWith("012")&&De.startsWith("010")||Se.startsWith("011")&&De.startsWith("010")||Se.startsWith("015")&&De.startsWith("010")),be=We?Math.max(0,parseFloat(Ys||"0")):0,Zs=Math.round(D*100)/100;if(f.commission=Zs,We&&!k&&be<=0){l({title:"خطأ",description:"أدخل رسوم التحويل لعمليات 010 → 011/012/015 أو 012 → 010 أو 011 → 010 أو 015 → 010",variant:"destructive"}),a();return}if(ae==="transfer"&&!k){const oe=Number(je[Q]||0),et=Number(S)+Number(be);if(oe<et){l({title:"رصيد المحفظة غير كافٍ",description:`الرصيد الحالي ${oe} لا يكفي لخصم ${et}`,variant:"destructive"}),a();return}}if(k)if(W){const oe=sa.validateTransaction(S,"transfer",Xe,je);oe.isValid?j={success:!0,newCashBalance:Xe,newWalletBalances:je}:j={success:!1,newCashBalance:Xe,newWalletBalances:je,message:oe.error||"رصيد غير كافٍ للتحويل المؤجل",error:"INSUFFICIENT_WALLET_BALANCE"}}else j={success:!0,newCashBalance:Xe,newWalletBalances:je};else ae==="transfer"?j=await sa.processTransfer({amount:S,currentCashBalance:Xe,currentWalletBalances:je,wallets:ye,selectedWalletId:Q,skipRemoteLimitsCheck:!0,nonBlockingUsageUpdate:!0}):j=await sa.processWithdraw({amount:S,currentCashBalance:Xe,currentWalletBalances:je,wallets:ye,selectedWalletId:Q,skipRemoteLimitsCheck:!0,nonBlockingUsageUpdate:!0});if(!j.success){l({title:"فشل في العملية",description:j.error||j.message,variant:"destructive"}),a();return}let It=k?Xe:j.newCashBalance,Kt=k?je:j.newWalletBalances;if(!k&&ae==="transfer"&&be>0){const oe=Number(Kt[Q]||0);Kt={...Kt,[Q]:Math.round((oe-Number(be))*100)/100}}if(k&&G){const oe=ye.find(yt=>yt.id===Q)??ye.find(yt=>yt.isDefault)??ye[0],et=(oe==null?void 0:oe.id)||Q;if(et!==Q)try{va(et)}catch{}const qt=Number(je[et]||0);Kt={...je,[et]:Math.round((qt+Number(S))*100)/100};try{const yt=`walletEffectsAppliedOnCreation_${(t==null?void 0:t.uid)||"default"}`,vs=localStorage.getItem(yt),Xt=vs?JSON.parse(vs):[];f!=null&&f.id&&!Xt.includes(f.id)&&(Xt.push(f.id),localStorage.setItem(yt,JSON.stringify(Xt)))}catch{}}if(k&&W){const oe=ye.find(yt=>yt.id===Q)??ye.find(yt=>yt.isDefault)??ye[0],et=(oe==null?void 0:oe.id)||Q;if(et!==Q)try{va(et)}catch{}const qt=Number(je[et]||0);Kt={...je,[et]:Math.round((qt-Number(S)-Number(be))*100)/100}}if((W||G)&&Ye&&!la){const oe={id:`DEBT-${Date.now()}`,debtorName:Ye.debtorName,amount:Ye.amount,reason:Ye.notes||"",customerId:Ye.customerId,mobile:Ye.mobile,status:"pending",createdAt:new Date};Y=oe.id;const et=[oe,...Ot];Qt(et);try{await fs(et)}catch(qt){console.error("⚠️ فشل حفظ الدين المؤجل محلياً:",qt)}l({title:"تم إضافة الدين",description:"أضيف إلى إيصالات الديون حتى يتم السداد",variant:"default"})}if(!k){const oe=Math.max(0,Number(D))+Math.max(0,Number(be));oe>0&&(It=Math.round((It+oe)*100)/100,console.log(`💰 تم إضافة عمولة/رسوم ${oe} جنيه لدرج النقدية`))}if(console.log("⚡ تحديث الواجهة فوراً..."),ht(It),Ze(Kt),k&&(f.status="pending"),Ss(oe=>[f,...oe]),Ee)try{const oe=new Date,et=oe.getFullYear(),qt=String(oe.getMonth()+1).padStart(2,"0"),yt=String(oe.getDate()).padStart(2,"0"),vs=`zeroPlanDailyConfirmCount:${(t==null?void 0:t.uid)||"default"}:${et}-${qt}-${yt}`,Xt=localStorage.getItem(vs),nr=Xt&&parseInt(Xt,10)||0;localStorage.setItem(vs,String(nr+1))}catch{}if(localStorage.setItem(dt(),It.toString()),localStorage.setItem(ct(),JSON.stringify(Kt)),(async()=>{try{console.log("🔄 بدء حفظ المعاملة في Firebase في الخلفية...");const oe={shopId:(E==null?void 0:E.shopId)||(t==null?void 0:t.uid)||"default-shop",lineId:Q||"default-line",merchantUserId:(t==null?void 0:t.uid)||null,provider:"vodafone_cash",txnType:ae==="transfer"?"send":"receive",amount:S,commission:Zs,fee:be,profit:0,senderMsisdn:Re,receiverMsisdn:ae==="transfer"?it:Re,note:ae==="transfer"?`تحويل من ${Re} إلى ${it}`:`سحب ${S} جنيه من ${(i==null?void 0:i.name)||"المحفظة الرئيسية"}`,status:k?"pending":"confirmed",linkedDebtId:Y||void 0,createdBy:(t==null?void 0:t.uid)||null,walletEffectAppliedOnCreation:!!(k&&G)},et={...oe,status:k?"pending":"completed",commissionMode:ae==="transfer"||ie?"add":"deduct",totalCharged:ae==="transfer"?S+Zs+be:ie?S+D:S,walletEffectAppliedOnCreation:!!(k&&G),createdAt:new Date},{ProfitService:qt}=await Is(async()=>{const{ProfitService:nr}=await import("./profitService-D4-kgAVt.js");return{ProfitService:nr}},__vite__mapDeps([3,4,0,1])),yt=qt.calculateProfitFromTransaction(et);yt>0&&(qt.addProfit(yt,t==null?void 0:t.uid),console.log("✅ تم إضافة الربح:",yt,"جنيه")),await Promise.all([...t!=null&&t.uid?[Ce.updateUserData(t.uid,{cashBalance:It,walletBalances:Kt,lastUpdated:new Date().toISOString()})]:[],gr.create(oe),...t!=null&&t.uid?[Ce.saveUserTransaction(t.uid,{...et,transactionType:ae,fromWallet:Q,toWallet:ae==="transfer"?W?null:"cash":null,cashierName:w&&((b==null?void 0:b.name)||(b==null?void 0:b.username))||"الحساب الرئيسي",linkedDebtId:Y||void 0,description:`${ae==="transfer"?"تحويل":"سحب"} ${S} من ${Q} ${ae==="transfer"?W?"":"إلى الدرج النقدي":""} — عمولة: ${D} (${ae==="transfer"||ie?"مضافة":"مخصومة"})${be>0?` — رسوم: ${be}`:""}${k?" — دين مؤجل (قيد المراجعة)":""}`})]:[]]),console.log("✅ تم حفظ جميع البيانات في Firebase بنجاح");const vs=`userData_${t==null?void 0:t.uid}`,Xt={cashBalance:It,walletBalances:Kt,lastUpdated:new Date().toISOString()};localStorage.setItem(vs,JSON.stringify(Xt))}catch(oe){console.error("❌ خطأ في حفظ المعاملة في Firebase (في الخلفية):",oe),l({title:"تحذير",description:"تم تنفيذ العملية محلياً، لكن فشلت المزامنة مع الخادم. ستتم المحاولة مرة أخرى تلقائياً.",variant:"destructive"})}})(),ae==="transfer"){Gs(!0);const oe=Number(r)+Number(D)+Math.max(0,Number(be));wr({type:"transfer",amount:Math.max(0,Math.round(oe*100)/100)}),zi({receiver:it,amount:r}),Fa(!0),setTimeout(()=>{Gs(!1)},2e3)}else{ca(!0);const oe=ie?Number(r):Math.max(0,Math.round((Number(r)-Number(D))*100)/100);wr({type:"withdraw",amount:Math.max(0,Math.round(oe*100)/100)}),Fa(!0),setTimeout(()=>{ca(!1)},2e3)}h(""),K(""),rs(null),Ie(""),Fe(""),mt(""),As(!1)},on=tt.useMemo(()=>new Intl.DateTimeFormat("ar-EG"),[]),zo=tt.useMemo(()=>new Intl.DateTimeFormat("ar-EG",{hour:"2-digit",minute:"2-digit"}),[]),Jo=tt.useMemo(()=>{try{return Ot.reduce((s,a)=>{const r=Number(a.paidAmount||0),i=Math.max(0,Number(a.amount||0)-r);return s+i},0)}catch{return 0}},[Ot]),Sl=tt.useMemo(()=>bl().filter(a=>xs==="all"?!0:xs==="send"?a.type==="send":xs==="receive"?a.type==="receive":xs==="withdraw"?a.type==="withdraw":xs!=="deleted"),[bl,xs]),Ko=()=>{if(yr==="daily"){const s=Rt.resetReportsManually("daily",vt,t==null?void 0:t.uid);oa(!1),l({title:"تم تصفير المعاملات اليومية",description:`تم إخفاء ${s.length} معاملة من تقارير اليوم (الحدود لم تتأثر)`})}else{const s=Rt.resetReportsManually("monthly",vt,t==null?void 0:t.uid);oa(!1),l({title:"تم تصفير المعاملات الشهرية",description:`تم إخفاء ${s.length} معاملة من تقارير الشهر (الحدود لم تتأثر)`})}},qo=()=>yr==="daily"?"تصفير المعاملات اليومية":"تصفير المعاملات الشهرية",Vo=()=>yr==="daily"?"أدخل الرقم السري الرئيسي لتصفير جميع معاملات اليوم":"أدخل الرقم السري الرئيسي لتصفير جميع معاملات الشهر",Yo=s=>{cl(s),_r(!0)},Ho=s=>{ht(s),localStorage.setItem(dt(),s.toString()),Qn(!1),l({title:"تم تحديث الرصيد النقدي",description:`تم تحديث الرصيد النقدي إلى ${s} جنيه`})},Go=async s=>{var f;if(!Et){console.warn("لا يوجد معرف محفظة محدد لتعديل الرصيد");return}const a={...je,[Et]:s};Ze(a);const r=new Date().toISOString(),i={walletBalances:a,lastUpdated:r},c=`userData_${t==null?void 0:t.uid}`;try{localStorage.setItem(c,JSON.stringify(i)),localStorage.setItem(ct(),JSON.stringify(a)),localStorage.setItem(`walletBalances_backup_${r}`,JSON.stringify(a))}catch{}try{t!=null&&t.uid&&await Ce.updateUserData(t.uid,i)}catch(N){console.error("خطأ أثناء حفظ رصيد المحفظة في Firebase:",N)}Xn(!1);const p=((f=ye.find(N=>N.id===Et))==null?void 0:f.name)||"المحفظة";l({title:"تم تحديث رصيد المحفظة",description:`تم تحديث رصيد ${p} إلى ${s.toLocaleString()} جنيه`})},Qo=async s=>{var a;if(console.log("💰 بدء تحديث رصيد المحفظة"),console.log("📊 معرف المحفظة المحررة:",Et),console.log("💵 المبلغ المضاف/المخصوم:",s),Et){const r=je[Et]||0;console.log("💰 الرصيد الحالي:",r);const i=r+s;console.log("💰 الرصيد الجديد:",i);const c={...je,[Et]:i};console.log("📊 الأرصدة المحدثة:",c),Ze(c);const p=new Date().toISOString(),f={walletBalances:c,lastUpdated:p},N=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(N,JSON.stringify(f)),localStorage.setItem(ct(),JSON.stringify(c)),localStorage.setItem(`walletBalances_backup_${p}`,JSON.stringify(c));try{if(t!=null&&t.uid){console.log("🔄 حفظ البيانات في Firebase...");try{await Ce.updateUserData(t.uid,f),console.log("✅ تم حفظ الأرصدة في Firebase بنجاح"),setTimeout(()=>{localStorage.removeItem(N),console.log("🧹 تم حذف النسخة المحلية المؤقتة بعد دقيقة واحدة")},6e4)}catch(W){console.error("❌ فشل في حفظ البيانات في Firebase:",W),ve(!0)}}else console.log("⚠️ المستخدم غير مسجل دخول، حفظ في localStorage"),localStorage.setItem(ct(),JSON.stringify(c));const D=((a=ye.find(W=>W.id===Et))==null?void 0:a.name)||"المحفظة",S=s>0?"إضافة":"خصم",j=Math.abs(s);l({title:`تم ${S} مبلغ ${S==="إضافة"?"إلى":"من"} رصيد المحفظة`,description:`تم ${S} ${j} جنيه ${S==="إضافة"?"إلى":"من"} رصيد ${D}. الرصيد الجديد: ${i.toLocaleString()} جنيه`})}catch(D){if(console.error("❌ فشل في حفظ البيانات في Firebase:",D),localStorage.setItem(ct(),JSON.stringify(c)),t!=null&&t.uid){const S=`userData_${t.uid}`,j={walletBalances:c,lastUpdated:new Date().toISOString()};localStorage.setItem(S,JSON.stringify(j)),ve(!0)}l({title:"تم حفظ البيانات محلياً",description:"تم حفظ التغييرات محلياً وسيتم مزامنتها مع الخادم لاحقاً",variant:"default"})}}else console.log("❌ لا يوجد معرف محفظة للتحرير");setTimeout(()=>{const i=Object.keys(localStorage).filter(c=>c.startsWith("walletBalances_backup_")).sort();i.length>5&&i.slice(0,i.length-5).forEach(p=>{localStorage.removeItem(p),console.log("🗑️ حذف النسخة الاحتياطية القديمة:",p)})},5e3),_r(!1),cl("")};return console.log("🔥 UserDashboardPage - Render conditions:",{isCheckingActivation:_,isUserActive:$,showActivationModal:Yt}),!_&&!$?(console.log("🔥 UserDashboardPage - Showing activation modal"),e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center",children:e.jsx(Fl,{isOpen:!0,onClose:()=>{}})})):_?(console.log("🔥 UserDashboardPage - Showing loading screen"),e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center",children:e.jsx("div",{className:"text-center",children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"w-3 h-3 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 animate-bounce",style:{animationDelay:"0ms"}}),e.jsx("span",{className:"w-3 h-3 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 animate-bounce",style:{animationDelay:"150ms"}}),e.jsx("span",{className:"w-3 h-3 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 animate-bounce",style:{animationDelay:"300ms"}})]})})})):(console.log("🔥 UserDashboardPage - Rendering main dashboard"),e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-gray-50 via-blue-50/30 to-indigo-50/20 px-2 sm:px-4 py-2 sm:py-4 relative overflow-hidden",children:[e.jsxs("div",{className:"absolute inset-0 overflow-hidden pointer-events-none",children:[e.jsx("div",{className:"absolute top-10 sm:top-20 left-2 sm:left-10 w-32 sm:w-72 h-32 sm:h-72 bg-blue-400/8 rounded-full blur-3xl"}),e.jsx("div",{className:"absolute bottom-10 sm:bottom-20 right-2 sm:right-10 w-40 sm:w-96 h-40 sm:h-96 bg-purple-400/8 rounded-full blur-3xl",style:{animationDelay:"2s"}}),e.jsx("div",{className:"absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-36 sm:w-80 h-36 sm:h-80 bg-indigo-400/5 rounded-full blur-3xl",style:{animationDelay:"4s"}})]}),e.jsxs("div",{className:"max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-3 sm:gap-6 relative z-10",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-2 sm:space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 sm:grid-cols-2 sm:gap-3 fade-in-up",children:[!ma&&e.jsxs(st,{className:"bg-gradient-to-br from-purple-50 via-purple-25 to-white border border-purple-200/60 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 group relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-purple-500/5 to-purple-600/3 opacity-0 group-hover:opacity-100 transition-opacity duration-300"}),e.jsx("div",{className:"absolute top-0 right-0 w-20 sm:w-32 h-20 sm:h-32 bg-gradient-to-br from-purple-300/15 to-transparent rounded-full -translate-y-8 sm:-translate-y-16 translate-x-8 sm:translate-x-16 group-hover:scale-110 transition-transform duration-300"}),e.jsx(wt,{className:"pb-2 sm:pb-1 lg:pb-1 px-3 sm:px-3 lg:px-2 pt-3 sm:pt-2 lg:pt-1 relative z-10",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Mt,{className:"text-xs font-bold text-purple-800 flex items-center gap-1.5 sm:gap-1",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"w-2.5 sm:w-2 h-2.5 sm:h-2 bg-gradient-to-r from-purple-500 to-purple-600 rounded-full shadow-sm"}),e.jsx("div",{className:"absolute inset-0 w-2.5 sm:w-2 h-2.5 sm:h-2 bg-purple-400 rounded-full opacity-60 animate-pulse"})]}),e.jsx("span",{className:"text-xs",children:"الشهر"})]}),e.jsxs("div",{className:"flex items-center gap-1 sm:gap-1",children:[e.jsx("div",{className:"hidden"}),e.jsx(d,{size:"sm",variant:"ghost",onClick:()=>{kn("monthly"),oa(!0)},className:"h-7 w-7 sm:h-6 sm:w-6 p-0 bg-gradient-to-r from-purple-100 to-purple-200 text-purple-700 hover:from-purple-200 hover:to-purple-300 hover:text-purple-800 rounded-lg sm:rounded-md transition-all duration-300 hover:scale-105 shadow-sm hover:shadow-md",title:"تصفير معاملات الشهر",children:e.jsx(Ut,{className:"h-3 w-3 sm:h-2.5 sm:w-2.5"})}),e.jsx("div",{className:"p-1.5 sm:p-1 bg-gradient-to-r from-purple-100 to-purple-200 rounded-lg sm:rounded-md",children:e.jsx(Na,{className:"h-3 w-3 sm:h-2.5 sm:w-2.5 text-purple-600"})})]})]})}),!ma&&e.jsxs(nt,{className:"space-y-0.5 sm:space-y-1 lg:space-y-0 pt-0 px-2 sm:px-3 lg:px-2 pb-1.5 sm:pb-2 lg:pb-1 relative z-10",children:[e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-purple-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-purple-700",children:"عدد المعاملات:"}),e.jsx("span",{className:"font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:ja().totalTransactions})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-purple-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-purple-700",children:"إجمالي المبالغ:"}),e.jsx("span",{className:"font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:ja().totalAmount.toFixed(2)})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-purple-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-purple-700",children:"المسحوب:"}),e.jsx("span",{className:"font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:ja().totalWithdrawn.toFixed(2)})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-purple-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-purple-700",children:"المرسل:"}),e.jsx("span",{className:"font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:ja().totalSent.toFixed(2)})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-purple-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-purple-700",children:"الأرباح:"}),e.jsx(fd,{userId:t==null?void 0:t.uid,transactions:vt})]})]}),Yi&&e.jsx("div",{className:"absolute inset-0 z-20 bg-yellow-100/60 backdrop-blur-sm rounded-xl border border-yellow-300/70 flex items-center justify-center p-0 pointer-events-auto",children:e.jsxs(d,{size:"sm",variant:"ghost",onClick:async()=>{if(Ee){l({title:"غير متاح",description:"تقارير الشهر غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"});return}La(!0)},className:"px-2.5 py-1 rounded-full bg-gradient-to-r from-yellow-300 to-yellow-400 text-black hover:from-yellow-400 hover:to-yellow-500 shadow-md flex items-center gap-1 text-[11px] font-semibold",title:"عرض تقارير الشهر (يتطلب الرقم السري)",children:[e.jsx("span",{children:"عرض تقارير الشهر"}),e.jsx(Ve,{className:"h-2.5 w-2.5"})]})})]}),e.jsx(es,{open:Gi,onOpenChange:La,mode:"verify",title:"الرقم السري لفتح تقارير الشهر",description:"لا يمكن الاطلاع على إحصائيات الشهر إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{if(Ee){l({title:"غير متاح",description:"تقارير الشهر غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}),La(!1),$n(!0);return}$n(!1),La(!1)},userId:t==null?void 0:t.uid}),e.jsxs(st,{className:"bg-gradient-to-br from-blue-50 via-blue-25 to-white border border-blue-200/60 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 group relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/5 to-blue-600/3 opacity-0 group-hover:opacity-100 transition-opacity duration-300"}),e.jsx("div",{className:"absolute top-0 right-0 w-20 sm:w-32 h-20 sm:h-32 bg-gradient-to-br from-blue-300/15 to-transparent rounded-full -translate-y-8 sm:-translate-y-16 translate-x-8 sm:translate-x-16 group-hover:scale-110 transition-transform duration-300"}),e.jsx(wt,{className:"pb-2 sm:pb-3 lg:pb-1 px-3 sm:px-4 lg:px-2 pt-3 sm:pt-4 lg:pt-1 relative z-10",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Mt,{className:"text-sm sm:text-base font-bold text-blue-800 flex items-center gap-1.5 sm:gap-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"w-2.5 sm:w-3 h-2.5 sm:h-3 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full shadow-sm"}),e.jsx("div",{className:"absolute inset-0 w-2.5 sm:w-3 h-2.5 sm:h-3 bg-blue-400 rounded-full opacity-60 animate-pulse"})]}),e.jsx("span",{className:"text-xs sm:text-sm",children:"اليوم"})]}),e.jsxs("div",{className:"flex items-center gap-1 sm:gap-1.5",children:[e.jsx(d,{size:"sm",variant:"ghost",onClick:()=>{kn("daily"),oa(!0)},className:"h-7 w-7 sm:h-8 sm:w-8 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded-lg transition-all duration-300 hover:scale-105 shadow-sm hover:shadow-md",title:"تصفير معاملات اليوم",children:e.jsx(Ut,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"})}),e.jsx(d,{size:"sm",variant:"ghost",onClick:()=>jr(!0),className:"h-7 w-7 sm:h-8 sm:w-8 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded-lg transition-all duration-300 hover:scale-105 shadow-sm hover:shadow-md",title:"أرشيف التقارير اليومية",children:e.jsx(Bc,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"})}),e.jsx(d,{size:"sm",variant:"ghost",onClick:()=>Hi(s=>!s),className:"h-7 w-7 sm:h-8 sm:w-8 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded-lg transition-all duration-300 hover:scale-105 shadow-sm hover:shadow-md",title:ma?"توسيع اليوم والشهر":"طي اليوم والشهر",children:ma?e.jsx(Nn,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"}):e.jsx(Kl,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"})}),e.jsx("div",{className:"p-1.5 sm:p-2 bg-gradient-to-r from-blue-100 to-blue-200 rounded-lg",children:e.jsx(Na,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5 text-blue-600"})})]})]})}),!ma&&e.jsxs(nt,{className:"space-y-0 pt-0 px-2 pb-1 relative z-10",children:[e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-blue-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-blue-700",children:"عدد المعاملات:"}),e.jsx("span",{className:"font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:rr().totalTransactions})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-blue-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-blue-700",children:"إجمالي المبالغ:"}),e.jsx("span",{className:"font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:rr().totalAmount.toFixed(2)})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-blue-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-blue-700",children:"المسحوب:"}),e.jsx("span",{className:"font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:rr().totalWithdrawn.toFixed(2)})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-blue-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-blue-700",children:"المرسل:"}),e.jsx("span",{className:"font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:rr().totalSent.toFixed(2)})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-blue-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-blue-700",children:"الأرباح:"}),e.jsx(yd,{userId:t==null?void 0:t.uid})]})]}),Qi&&e.jsx("div",{className:"absolute inset-0 z-20 bg-yellow-100/60 backdrop-blur-sm rounded-xl border border-yellow-300/70 flex items-center justify-center p-0 pointer-events-auto",children:e.jsxs(d,{size:"sm",variant:"ghost",onClick:()=>Dr(!0),className:"px-2.5 py-1 rounded-full bg-gradient-to-r from-yellow-300 to-yellow-400 text-black hover:from-yellow-400 hover:to-yellow-500 shadow-md flex items-center gap-1 text-[11px] font-semibold",title:"عرض تقارير اليوم (يتطلب الرقم السري)",children:[e.jsx("span",{children:"عرض تقارير اليوم"}),e.jsx(Ve,{className:"h-2.5 w-2.5"})]})})]}),e.jsx(es,{open:Xi,onOpenChange:Dr,mode:"verify",title:"الرقم السري لفتح تقارير اليوم",description:"لا يمكن الاطلاع على تقارير اليوم إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{Rn(!1),Dr(!1)},userId:t==null?void 0:t.uid})]}),e.jsxs(st,{className:"bg-white border-2 border-gray-200/50 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 group relative overflow-hidden   transform fade-in-up mb-6",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-emerald-500/5 via-blue-500/5 to-emerald-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-200"}),e.jsx("div",{className:"absolute top-0 left-0 w-40 h-40 bg-gradient-to-br from-emerald-300/10 to-transparent rounded-full -translate-y-20 -translate-x-20 group-hover:scale-150 transition-transform duration-200"}),e.jsx("div",{className:"absolute bottom-0 right-0 w-40 h-40 bg-gradient-to-br from-blue-300/10 to-transparent rounded-full translate-y-20 translate-x-20 group-hover:scale-150 transition-transform duration-200"}),e.jsx(nt,{className:"p-3 relative z-10",children:e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"bg-emerald-50 border-2 border-emerald-200/50 p-1 rounded-xl shadow-lg hover:shadow-md transition-all duration-200 group/cash relative overflow-hidden ",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-emerald-500/10 to-transparent opacity-0 group-hover/cash:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex items-center justify-between relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-emerald-100 to-emerald-200 rounded-lg shadow-sm",children:e.jsx(lt,{className:"h-1.5 w-1.5 text-emerald-600"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] font-bold text-emerald-800",children:"الفلوس النقدية"}),e.jsxs("span",{className:"text-[10px] font-extrabold text-emerald-700 bg-gradient-to-r from-emerald-100 to-emerald-200 px-1 py-0.5 rounded-lg shadow-sm",children:[Xe.toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(d,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-green-100 to-green-200 text-green-700 hover:from-green-200 hover:to-green-300 hover:text-green-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>Ga(!0),children:e.jsx(Tt,{className:"h-2 w-2"})}),e.jsx(d,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800 rounded-xl transition-all duration-300  hover:rotate-12 shadow-md hover:shadow-lg",onClick:()=>tr(!0),children:e.jsx(Ut,{className:"h-2 w-2"})})]})]})]}),e.jsxs("div",{className:"bg-blue-50 border-2 border-blue-200/50 p-1 rounded-xl shadow-lg hover:shadow-md transition-all duration-200 group/wallet relative overflow-hidden ",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/10 to-transparent opacity-0 group-hover/wallet:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex items-center justify-between relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-blue-100 to-blue-200 rounded-lg shadow-sm",children:e.jsx(ds,{className:"h-1.5 w-1.5 text-blue-600"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] font-bold text-blue-800",children:"الأرصدة علي المحافظ"}),e.jsxs("span",{className:"text-[10px] font-extrabold text-blue-700 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-lg shadow-sm",children:[Object.values(je).reduce((s,a)=>s+a,0).toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(d,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-green-100 to-green-200 text-green-700 hover:from-green-200 hover:to-green-300 hover:text-green-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>Xa(!0),title:"إضافة أموال لإجمالي المحفظة",children:e.jsx(Tt,{className:"h-2 w-2"})}),e.jsx(d,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800 rounded-xl transition-all duration-300  hover:rotate-12 shadow-md hover:shadow-lg",onClick:()=>{Za(!0),er("")},title:"تصفير إجمالي المحفظة",children:e.jsx(Ut,{className:"h-2 w-2"})})]})]})]}),e.jsxs("div",{className:"col-span-2 sm:col-span-1 bg-indigo-50 border-2 border-indigo-200/50 p-1 rounded-xl shadow-lg hover:shadow-md transition-all duration-200 group/selwallet relative overflow-hidden ",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-indigo-500/10 to-transparent opacity-0 group-hover/selwallet:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex items-center justify-between relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-indigo-100 to-indigo-200 rounded-lg shadow-sm",children:e.jsx(ds,{className:"h-1.5 w-1.5 text-indigo-600"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] font-bold text-indigo-800",children:"رصيد المحفظه"}),e.jsxs("span",{className:"text-[10px] font-extrabold text-indigo-700 bg-gradient-to-r from-indigo-100 to-indigo-200 px-1 py-0.5 rounded-lg shadow-sm",children:[(Q&&je[Q]||0).toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(d,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-green-100 to-green-200 text-green-700 hover:from-green-200 hover:to-green-300 hover:text-green-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>{if(!Q){l({title:"اختر محفظة",description:"يرجى اختيار محفظة من اختيار المحافظ بالأعلى أولاً",variant:"destructive"});return}Yo(Q)},title:"إضافة/خصم إلى رصيد المحفظة المختارة",children:e.jsx(Tt,{className:"h-2 w-2"})}),e.jsx(d,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800 rounded-xl transition-all duration-300  hover:rotate-12 shadow-md hover:shadow-lg",onClick:()=>{if(!Q){l({title:"اختر محفظة",description:"يرجى اختيار محفظة لتصفير رصيدها فقط",variant:"destructive"});return}za(!0)},title:"تصفير رصيد المحفظة المختارة",children:e.jsx(Ut,{className:"h-2 w-2"})})]})]})]})]})})]}),e.jsxs(st,{className:"bg-gradient-to-br from-gray-50 via-white to-slate-50 border border-gray-200/60 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 group relative overflow-hidden fade-in-up",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-gray-500/5 to-slate-600/3 opacity-0 group-hover:opacity-100 transition-opacity duration-300"}),e.jsxs(wt,{className:"pb-2 px-4 pt-4 relative z-10",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Mt,{className:"text-sm font-bold flex items-center gap-2 text-gray-800",children:[!U&&e.jsx("div",{className:"p-1.5 sm:p-2 bg-gradient-to-r from-gray-100 to-slate-200 rounded-lg",children:e.jsx(Na,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5 text-gray-600"})}),e.jsx("span",{className:"bg-gradient-to-r from-gray-600 to-slate-600 bg-clip-text text-transparent",children:"المعاملات الأخيرة"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[!U&&e.jsxs("div",{className:"flex items-center gap-0.5 bg-gray-50 rounded px-1 py-0.5 border border-gray-200 hover:border-blue-300 transition-all duration-200 group relative overflow-hidden max-w-[140px] md:max-w-[220px]",children:[e.jsx(wc,{className:"h-2 w-2 text-gray-400 group-hover:text-blue-600 transition-colors"}),e.jsx(L,{placeholder:"بحث...",value:On,onChange:s=>Ui(s.target.value),className:"h-3 text-[8px] border-0 bg-transparent focus:ring-0 focus:outline-none text-gray-700 placeholder:text-gray-400"})]}),!U&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-green-600 mb-1",children:"شحن"}),e.jsx(d,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-green-50 text-green-600 hover:bg-green-100 border border-green-200 ring-3 ring-green-300 transition-all duration-200 hover:scale-105",onClick:()=>{l({title:"قيد التطوير",description:"هذه الميزة غير متاحة حالياً."})},title:"شحن الرصيد",children:e.jsx(Ia,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"حاسبة"}),e.jsx(d,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105",onClick:()=>Sr(!0),title:"آلة حاسبة",children:e.jsx(Ql,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"كروت"}),e.jsx(d,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105",onClick:()=>{Ee?l({title:"غير متاح",description:"كروت الائتمان غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ea(!0)},title:"كروت الائتمان",children:e.jsx(Ia,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-blue-600 mb-1",children:"الوردية"}),e.jsx(d,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-blue-50 text-blue-600 hover:bg-blue-100 border border-blue-200 ring-3 ring-blue-300 transition-all duration-200 hover:scale-105",onClick:Co,title:w&&(b!=null&&b.name||b!=null&&b.username)?`بروفيل الوردية: ${(b==null?void 0:b.name)||(b==null?void 0:b.username)}`:"وردية الكاشير",children:e.jsx(vn,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"المبيعات"}),e.jsx(d,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105",onClick:()=>{Ee?l({title:"غير متاح",description:"بيانات المبيعات غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):ia(!0)},title:"بيانات المبيعات",children:e.jsx(Ic,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsxs("div",{className:"flex items-center gap-1 mb-1",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600",children:"الديون"}),Ot.filter(s=>s.status==="pending").length>0&&e.jsx("span",{className:"h-4 w-4 rounded-full bg-red-600 text-white text-[10px] flex items-center justify-center ring-2 ring-white",children:Ot.filter(s=>s.status==="pending").length})]}),e.jsx(d,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105",onClick:()=>{Ee?l({title:"غير متاح",description:"إدارة الديون/الأجل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):ha(!0)},title:"الديون",children:e.jsx(hc,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-amber-700 mb-1",children:"الصيانة"}),e.jsx(d,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-amber-50 text-amber-700 hover:bg-amber-100 border border-amber-200 ring-3 ring-amber-300 transition-all duration-200 hover:scale-105",onClick:()=>{Ee?l({title:"غير متاح",description:"الصيانة غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ba(!0)},title:"الصيانة",children:e.jsx(uc,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-yellow-500 mb-1",children:"المكنة"}),e.jsx(d,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-violet-50 text-violet-700 hover:bg-violet-100 border border-violet-200 ring-3 ring-violet-300 transition-all duration-200 hover:scale-105",onClick:()=>{is?Ma(!0):l({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"})},title:"يومية المكنة",children:e.jsx(ei,{className:"h-5 w-5 text-yellow-500"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-orange-600 mb-1",children:"مصروفات"}),e.jsx(d,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-orange-50 text-orange-600 hover:bg-orange-100 border border-orange-200 ring-3 ring-orange-300 transition-all duration-200 hover:scale-105",onClick:()=>{Ee?l({title:"غير متاح",description:"مصروفات المحل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Vt.hasMasterPin()?V(!0):ce(!0)},title:"مصروفات المحل",children:e.jsx(mr,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-rose-600 mb-1",children:"النواقص"}),e.jsx(d,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-rose-50 text-rose-600 hover:bg-rose-100 border border-rose-200 ring-3 ring-rose-300 transition-all duration-200 hover:scale-105",onClick:()=>{Ee?l({title:"غير متاح",description:"النواقص غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):_t(!0)},title:"النواقص",children:e.jsx(xc,{className:"h-5 w-5"})})]})]})]})]}),!U&&e.jsx("div",{className:"mt-2 w-full",children:e.jsxs("div",{className:"flex items-center justify-center gap-3 bg-gray-50 rounded-md p-3 border border-gray-200",children:[e.jsx(d,{variant:"ghost",size:"sm",className:`h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${xs==="send"?"bg-green-600 text-white border-green-600":"text-green-700 border-green-300 hover:bg-green-50"}`,onClick:()=>vr("send"),title:"تصفية التحويل",children:"التحويل"}),e.jsx(d,{variant:"ghost",size:"sm",className:`h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${xs==="withdraw"?"bg-red-600 text-white border-red-600":"text-red-700 border-red-300 hover:bg-red-50"}`,onClick:()=>vr("withdraw"),title:"تصفية السحب",children:"السحب"}),e.jsx(d,{variant:"ghost",size:"sm",className:`h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${xs==="all"?"bg-green-600 text-white border-green-600":"text-green-700 border-green-300 hover:bg-green-50"}`,onClick:()=>vr("all"),title:"عرض الكل",children:"الكل"}),e.jsxs("div",{className:"relative ml-1",children:[e.jsxs(d,{variant:"ghost",size:"sm",className:"h-8 px-3 text-[12px] rounded-full border bg-red-50 text-red-700 border-red-300 hover:bg-red-100",onClick:()=>Jr(!0),title:"تصفير المعاملات الأخيرة",children:[e.jsx(Ut,{className:"h-3.5 w-3.5 mr-1"}),"تصفير"]}),(t==null?void 0:t.uid)&&localStorage.getItem(`recentTransactionsResetAt:${t.uid}`)&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 h-2 w-2 rounded-full bg-red-500 ring-2 ring-white"})]})]})})]}),e.jsx(nt,{className:"space-y-2 pt-0 px-4 pb-4 relative z-10",children:Sl.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(Na,{className:"h-12 w-12 mx-auto mb-2 text-gray-300"}),e.jsx("p",{className:"text-sm",children:"لا توجد معاملات حتى الآن"})]}):e.jsx("div",{className:"max-h-[210px] overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400 transition-colors",children:e.jsx("div",{className:"space-y-2 pr-2",children:Sl.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gradient-to-r from-white/70 to-gray-50/70 rounded-lg hover:from-white/90 hover:to-gray-50/90 transition-all duration-300 border border-gray-100/60 cursor-pointer hover:shadow-sm",onClick:()=>Ro(s),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[s.status==="completed"&&e.jsx(ur,{className:"h-4 w-4 text-green-500"}),s.status==="pending"&&e.jsx(zs,{className:"h-4 w-4 text-yellow-500"}),s.status==="failed"&&e.jsx(wn,{className:"h-4 w-4 text-red-500"})]}),e.jsxs("div",{children:[(()=>{const a=(s==null?void 0:s.type)==="report"||((s==null?void 0:s.title)||"").includes("إيصال تسليم وردية");return e.jsx("p",{className:"font-medium text-sm text-gray-800",children:a?"إيصال تسليم وردية":(s.type==="send"?"تحويل":"سحب")+` - ${s.amount.toLocaleString()} جنيه`})})(),e.jsxs("p",{className:"text-[10px] text-gray-700",children:["تمت بواسطة: ",(s==null?void 0:s.cashierName)??"الحساب الرئيسي"]}),(()=>{const a=(s==null?void 0:s.type)==="report"||((s==null?void 0:s.title)||"").includes("إيصال تسليم وردية");return e.jsx("p",{className:"text-xs text-gray-500",children:a?`تم التسليم إلى: ${s.receiverPhone}`:`من ${s.senderPhone}${s.type==="send"?` إلى ${s.receiverPhone}`:""}`})})(),e.jsxs("p",{className:"text-xs text-gray-400",children:[on.format(s.createdAt instanceof Date?s.createdAt:new Date(s.createdAt))," - ",zo.format(s.createdAt instanceof Date?s.createdAt:new Date(s.createdAt))]})]})]}),e.jsx(jt,{variant:s.status==="completed"?"default":s.status==="pending"?"secondary":"destructive",className:"text-xs",children:s.status==="completed"?"مكتمل":s.status==="pending"?"قيد المعالجة":"فشل"})]},s.id))})})})]})]}),e.jsx(Tc,{isOpen:Wi,onClose:()=>Aa(!1),transaction:Fi,onPrint:()=>window.print(),onDelete:$i,onComplete:Ri}),e.jsxs("div",{className:"space-y-1 fade-in-right w-full lg:w-5/6 mx-auto",children:[e.jsxs(st,{id:"transaction-section",className:"bg-gradient-to-br from-white via-blue-50/30 to-indigo-50/50 border border-blue-200/40 rounded-lg shadow-lg hover:shadow-lg transition-all duration-200 group relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/5 via-indigo-500/3 to-purple-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-200"}),e.jsx("div",{className:"absolute top-0 right-0 w-32 h-32 sm:w-28 sm:h-28 lg:w-20 lg:h-20 bg-gradient-to-bl from-blue-400/10 to-transparent rounded-full  "}),e.jsx("div",{className:"absolute bottom-0 left-0 w-24 h-24 bg-gradient-to-tr from-indigo-400/10 to-transparent rounded-full  ",style:{animationDelay:"1s"}}),e.jsx(wt,{className:"sticky top-0 z-20 bg-white/80 backdrop-blur supports-[backdrop-filter]:bg-white/60 pb-0.5 px-3 pt-1 lg:pt-0.5 lg:pb-0.5 lg:px-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Mt,{className:"text-sm font-bold flex items-center gap-2 text-gray-800",children:[e.jsxs("div",{className:"relative",children:[e.jsx(ur,{className:"h-1 w-1 text-emerald-500 "}),e.jsx("div",{className:"absolute inset-0 h-1 w-1 bg-emerald-400 rounded-full opacity-20 "})]}),e.jsx("span",{className:"bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent",children:"إجراء معاملة جديدة"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[Oe&&e.jsx("div",{className:"hidden md:flex items-center gap-1 bg-gradient-to-r from-emerald-50 to-green-50 hover:from-emerald-100 hover:to-green-100 border border-emerald-200 text-emerald-800 text-sm transition-all duration-300 hover:scale-105 h-9 px-3 rounded-xl shadow-sm",children:e.jsxs("span",{className:"text-sm font-semibold whitespace-nowrap",children:["تجربة: ",O," ",O>=3&&O<=10?"ساعات":O===2?"ساعتين":"ساعة"]})}),e.jsxs("div",{className:"hidden md:flex items-center gap-2 bg-gradient-to-r from-gray-50 to-slate-50 hover:from-gray-100 hover:to-slate-100 border border-gray-200 transition-all duration-300 hover:scale-105 h-9 px-3 rounded-xl shadow-sm",children:[e.jsx(Wc,{}),e.jsx(Fc,{})]})]}),Mo&&e.jsxs(d,{variant:"outline",size:"sm",className:"hidden flex items-center gap-1.5 sm:gap-2 bg-gradient-to-r from-cyan-50 to-blue-50 hover:from-cyan-100 hover:to-blue-100 border-cyan-200 text-cyan-800 text-xs sm:text-sm transition-all duration-300 hover:scale-105 hover:shadow-lg h-10 sm:h-12 px-4 sm:px-5 rounded-xl min-w-[44px] touch-manipulation",onClick:gl,title:"مزامنة البيانات المحفوظة محلياً مع الخادم",children:[e.jsx(Mc,{className:"h-3.5 w-3.5 sm:h-4 sm:w-4 animate-spin"}),e.jsx("span",{className:"text-xs sm:text-sm font-semibold whitespace-nowrap",children:"مزامنة"})]})]})}),e.jsxs(nt,{ref:u,className:"space-y-1 px-2 pb-2 relative z-10 transition-transform duration-200 ease-out will-change-transform",style:{transform:o?`translateY(${o}px)`:void 0},onFocusCapture:s=>{const a=s.target;if(!((a==null?void 0:a.id)==="transferExtraFeeInput")){x(0);return}const i=document.getElementById("transferSubmitButton");if(i){const c=i.getBoundingClientRect(),p=window.innerHeight;if(c.bottom>p){const f=c.bottom-p,N=Math.min(f,220);x(-N)}else x(0)}else x(0)},onBlurCapture:s=>{s.currentTarget.contains(s.relatedTarget)||x(0)},children:[e.jsxs("div",{className:"grid grid-cols-2 gap-0.5 p-0.5 bg-gradient-to-r from-gray-50 to-slate-50 rounded-xl border border-gray-200/50 fade-in-up w-full lg:w-5/6 mx-auto ",children:[e.jsxs(d,{variant:ae==="transfer"?"default":"ghost",onClick:()=>ar("transfer"),className:`text-xs font-semibold transition-all duration-300 hover:scale-105 h-7 rounded-lg px-2 ${ae==="transfer"?"bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg hover:shadow-md hover:from-blue-600 hover:to-indigo-700":"text-gray-600 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 hover:text-blue-700 hover:border-blue-200"}`,children:[e.jsx(Na,{className:"h-1 w-1 mr-1"}),"تحويل"]}),e.jsxs(d,{variant:ae==="withdraw"?"default":"ghost",onClick:()=>ar("withdraw"),className:`text-xs font-semibold transition-all duration-300 hover:scale-105 h-7 rounded-lg px-2 ${ae==="withdraw"?"bg-gradient-to-r from-emerald-500 to-green-600 text-white shadow-lg hover:shadow-md hover:from-emerald-600 hover:to-green-700":"text-gray-600 hover:bg-gradient-to-r hover:from-emerald-50 hover:to-green-50 hover:text-emerald-700 hover:border-emerald-200"}`,children:[e.jsx(xr,{className:"h-1 w-1 mr-1"}),"سحب"]})]}),e.jsxs("div",{className:"fade-in-up",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("label",{className:"text-sm font-semibold text-gray-700 block flex items-center gap-2",children:[e.jsx(ds,{className:"h-1 w-1 text-blue-600"}),"اختيار المحفظة"]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsxs(d,{variant:"ghost",size:"sm",className:"h-6 rounded-md px-2 text-[10px] bg-emerald-50 text-emerald-700 hover:bg-emerald-100 border border-emerald-200",onClick:()=>m("/user/add-wallet"),title:"إضافة محفظة",children:[e.jsx(Tt,{className:"h-3 w-3 mr-1"}),"إضافة محفظة"]}),e.jsxs(d,{variant:"ghost",size:"sm",className:"h-6 rounded-md px-2 text-[10px] bg-indigo-50 text-indigo-700 hover:bg-indigo-100 border border-indigo-200",onClick:()=>ft(!0),title:"المحافظ",children:[e.jsx(ds,{className:"h-3 w-3 mr-1"}),"المحافظ"]})]})]}),ye.length>0?e.jsxs(Bs,{value:Q,onValueChange:$o,children:[e.jsx(Ms,{"data-testid":"wallet-select",className:"w-full h-12 text-sm bg-gradient-to-r from-white to-gray-50 border-2 border-gray-200 hover:border-blue-400 focus:border-blue-500 rounded-xl transition-all duration-300 hover:shadow-md focus:shadow-lg",children:e.jsx(Ls,{placeholder:"اختر محفظة للمعاملة",className:"text-gray-600"})}),e.jsxs($s,{className:"rounded-xl border-2 border-gray-200 shadow-md z-[9999]",children:[e.jsx("div",{"data-fixed-header":"true",className:"sticky top-0 z-10 bg-white p-2 border-b border-gray-200",children:e.jsx(L,{value:Cn,onChange:s=>Pi(s.target.value),placeholder:"ابحث برقم المحفظة",className:"h-6 text-xs"})}),e.jsx("div",{className:"pr-1",children:In.length===0?e.jsx("div",{className:"text-xs text-gray-500 p-2",children:"لا توجد نتائج مطابقة"}):In.map(s=>e.jsx(os,{value:s.id,className:"rounded-lg hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 transition-all duration-200",children:e.jsxs("div",{className:"flex items-center gap-1 py-1 w-full justify-between",children:[e.jsx("div",{className:"p-1 bg-gradient-to-r from-blue-100 to-indigo-100 rounded-lg",children:e.jsx(ds,{className:"h-1 w-1 text-blue-600"})}),e.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-sm font-medium text-gray-800",children:s.name}),e.jsxs("span",{className:"text-[10px] text-gray-500",children:["(",s.phone,")"]})]}),s.isDefault&&e.jsx(jt,{variant:"secondary",className:"text-[10px] bg-gradient-to-r from-emerald-100 to-green-100 text-emerald-700 border-emerald-200",children:"افتراضي"})]}),e.jsx("div",{className:"ml-auto flex flex-col items-end gap-1"})]})},s.id))})]})]}):e.jsx("div",{className:"rounded-xl border-2 border-dashed border-gray-200 bg-gray-50 px-3 py-3 text-xs text-gray-600",children:"لا توجد محافظ حتى الآن. اضغط “إضافة محفظة” لإضافة أول محفظة."})]}),e.jsx(me,{open:Vs,onOpenChange:F,children:e.jsxs(he,{className:"sm:max-w-3xl w-[95vw] sm:w-auto max-h-[80vh] overflow-y-auto",children:[e.jsx(ue,{children:e.jsx(xe,{children:"عرض المحافظ"})}),e.jsx("div",{className:"mt-2",children:e.jsx(Oc,{showAddButton:!1,showUsageBars:!1,showLimitCards:!1,showEditButton:!0})})]})}),e.jsx(es,{open:ge,onOpenChange:ft,mode:"verify",title:"الرقم السري لفتح المحافظ",description:"أدخل الرقم السري الرئيسي لعرض وإدارة المحافظ",onSuccess:()=>{ft(!1),F(!0)},userId:t==null?void 0:t.uid}),Q&&ye.length>0&&(()=>{const s=ye.find(De=>De.id===Q),a=Nl(Q),r=_o(Q),i=(qe==null?void 0:qe.monthlyWithdrawLimit)??(s==null?void 0:s.monthlyWithdrawalLimit)??2e5,c=(qe==null?void 0:qe.monthlyTransferLimit)??(s==null?void 0:s.monthlyTransferLimit)??2e5,p=a.totalWithdrawn??(qe==null?void 0:qe.monthlyWithdrawUsed)??0,f=a.totalTransferred??(qe==null?void 0:qe.monthlyTransferUsed)??0,N=(qe==null?void 0:qe.dailyWithdrawLimit)??1e5,D=(qe==null?void 0:qe.dailyTransferLimit)??6e4,S=r.totalWithdrawn??(qe==null?void 0:qe.dailyWithdrawUsed)??0,j=r.totalTransferred??(qe==null?void 0:qe.dailyTransferUsed)??0,W=parseFloat(P||"0")||0,G=p+(ae==="withdraw"?W:0),k=f+(ae==="transfer"?W:0),Y=S+(ae==="withdraw"?W:0),Se=j+(ae==="transfer"?W:0);return s?e.jsxs("div",{className:"fade-in-up mb-2 space-y-2",children:[e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-1 rounded-md border border-gray-200 shadow-sm hover:shadow-md transition-all duration-300",children:[e.jsxs("div",{className:"text-[10px] text-gray-600 font-medium mb-1 text-center",children:["الحدود الشهرية: ",s.name]}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-red-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-red-400 to-red-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(G/Math.max(i,1)*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-blue-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-400 to-blue-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(k/Math.max(c,1)*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-[10px] text-red-600 font-medium",children:["متبقي سحب: ",Math.max(i-G,0).toLocaleString("en-US")," جنيه"]}),e.jsxs("div",{className:"text-[10px] text-blue-600 font-medium",children:["متبقي تحويل: ",Math.max(c-k,0).toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-1 rounded-md border border-gray-200 shadow-sm hover:shadow-md transition-all duration-300",children:[e.jsxs("div",{className:"text-[10px] text-gray-600 font-medium mb-1 text-center",children:["الحدود اليومية: ",s.name]}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-orange-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-orange-400 to-orange-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(Y/Math.max(N,1)*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-green-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-green-400 to-green-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(Se/Math.max(D,1)*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-[10px] text-orange-600 font-medium",children:["متبقي سحب يومي: ",Math.max(N-Y,0).toLocaleString("en-US")," جنيه"]}),e.jsxs("div",{className:"text-[10px] text-green-600 font-medium",children:["متبقي تحويل يومي: ",Math.max(D-Se,0).toLocaleString("en-US")," جنيه"]})]})]})]}):null})(),ae==="transfer"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المرسل"}),e.jsxs("div",{className:"relative",children:[e.jsx(Ns,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(L,{value:Re,onChange:s=>Nt(s.target.value),onKeyDown:s=>{if(s.key==="Enter"){const a=document.getElementById("receiverPhoneInput");if(a)a.focus();else{const r=document.getElementById("amountInput");r==null||r.focus()}}},placeholder:"01030302038",className:"pl-10 h-10 text-sm transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]})]}),!T&&e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المستقبل"}),e.jsxs("div",{className:"relative",children:[e.jsx(Ns,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(L,{id:"receiverPhoneInput",value:it,onChange:s=>{h(s.target.value),Nr&&Gs(!1)},onKeyDown:s=>{if(s.key==="Enter"){const a=document.getElementById("amountInput");a==null||a.focus()}},inputMode:"numeric",maxLength:11,placeholder:"أدخل رقم المستقبل",className:"pl-10 h-10 text-sm transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المستقبل"}),e.jsxs("div",{className:"relative",children:[e.jsx(Ns,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(L,{value:Q&&((Dl=ye.find(s=>s.id===Q))==null?void 0:Dl.phone)||"",readOnly:!0,placeholder:"اختر محفظة أولاً",className:"pl-10 h-10 text-sm bg-gray-50 transition-all duration-300"})]})]}),ae==="transfer"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"المبلغ (جنيه)"}),e.jsxs("div",{className:"relative flex items-center gap-2",children:[e.jsx(lt,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(L,{id:"amountInput",value:P,onChange:s=>{K(s.target.value),Nr&&Gs(!1)},onKeyDown:s=>{if(s.key==="Enter"){const a=document.getElementById("transferCommissionInput");if(a)a.focus();else{const r=document.getElementById("quickDebtButton");r==null||r.focus()}}},placeholder:"أدخل المبلغ",type:"number",className:"pl-10 h-10 text-sm transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),Ye?e.jsxs("div",{className:"mt-2 text-xs text-green-700 bg-green-50 border border-green-200 rounded px-2 py-1 flex items-center gap-2",children:[e.jsxs("span",{children:["تم إدخال تفاصيل الأجل لـ ",Ye.debtorName," بمبلغ ",Ye.amount," جنيه"]}),e.jsx(d,{type:"button",variant:"ghost",size:"sm",className:"h-6 px-2",onClick:()=>rs(null),children:"إلغاء"})]}):null]}),(()=>{if(T)return null;const s=Ds();return s&&s.defaultTransferCommission!=null?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة التحويل (تلقائية)"}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["سيتم تطبيق عمولة التحويل الافتراضية لكل ألف: ",s==null?void 0:s.defaultTransferCommission," جنيه لكل ألف"]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(d,{id:"quickDebtButton",type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const r=Ds(),i=(r==null?void 0:r.defaultTransferCommission)!=null?Number(r.defaultTransferCommission):0,c=parseFloat(P||"0")||0,p=Math.round((i||0)*c/1e3*100)/100,f=c+p;Fe((f||0).toString()),Ee?l({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):ne(!0)},children:"أجل"}),e.jsx(d,{type:"button",variant:"outline",size:"icon",className:"hidden",title:ie?"العمولة تُضاف":"العمولة تُخصم",children:ie?e.jsx(Tt,{className:"h-4 w-4 text-green-600"}):e.jsx(_s,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"hidden",children:ie?"العمولة تُضاف":"العمولة تُخصم"})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة التحويل على العملية (جنيه)"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(lt,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-orange-500"}),e.jsx(L,{id:"transferCommissionInput",value:He,onChange:r=>Ct(r.target.value),placeholder:"أدخل عمولة التحويل",type:"number",className:"pl-10 h-10 text-sm transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),e.jsx(d,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const r=Ds(),i=parseFloat(P||"0")||0;let c=0;if((r==null?void 0:r.defaultTransferCommission)!=null){const f=Number(r.defaultTransferCommission)||0;c=Math.round(f*i/1e3*100)/100}else{const f=He&&He.trim()!==""?parseFloat(He):0;c=Math.max(0,f)}const p=i+c;Fe((p||0).toString()),Ee?l({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):ne(!0)},children:"أجل"}),e.jsx(d,{type:"button",variant:"outline",size:"icon",className:"hidden",title:ie?"العمولة تُضاف":"العمولة تُخصم",children:ie?e.jsx(Tt,{className:"h-4 w-4 text-green-600"}):e.jsx(_s,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"hidden",children:ie?"العمولة تُضاف":"العمولة تُخصم"})]}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"يمكنك إدخال عمولة العملية الإجمالية (اختياري)"})]})})(),(()=>{const s=ns(Re||"").replace(/\D/g,""),a=ns(it||"").replace(/\D/g,"");return ae==="transfer"&&(s.startsWith("010")&&(a.startsWith("011")||a.startsWith("012")||a.startsWith("015"))||s.startsWith("012")&&a.startsWith("010")||s.startsWith("011")&&a.startsWith("010")||s.startsWith("015")&&a.startsWith("010"))?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رسوم التحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(lt,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-orange-500"}),e.jsx(L,{id:"transferExtraFeeInput",value:Ys,onChange:i=>ka(i.target.value),placeholder:"أدخل رسوم التحويل",type:"number",className:"pl-10 h-10 text-sm transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),e.jsx("div",{className:"hidden",children:"تُخصم من المحفظة وتضاف للدرج — لعمليات 010 → 011/012/015 أو 012 → 010 أو 011 → 010 أو 015 → 010"})]}):null})(),e.jsx("div",{className:"sticky bottom-0 z-10 pt-2 bg-white/80 backdrop-blur supports-[backdrop-filter]:bg-white/60",children:e.jsx(d,{id:"transferSubmitButton",onClick:wl,className:"w-full font-medium h-10 text-sm btn-bounce hover-glow transition-all duration-300 bg-blue-600 hover:bg-blue-700 text-white",children:Nr?"تم التحويل بنجاح":"تأكيد التحويل"})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"مبلغ السحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(xr,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-green-500"}),e.jsx(L,{id:"amountInput",value:P,onChange:s=>{K(s.target.value),Bn&&ca(!1)},onKeyDown:s=>{if(s.key==="Enter"){const a=document.getElementById("manualWithdrawCommissionInput");if(a)a.focus();else{const r=document.getElementById("withdrawSubmitButton");r==null||r.focus()}}},placeholder:"أدخل مبلغ السحب",type:"number",className:"pl-10 h-10 text-sm transition-all duration-300 hover:border-blue-400 focus:border-blue-500"}),e.jsx("div",{className:"mt-2",children:e.jsx(d,{id:"prefillBtn",type:"button",variant:"outline",size:"sm",onClick:we,children:"Use latest SMS"})})]})]}),(()=>{const s=Ds();return s&&s.defaultWithdrawCommission!=null?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة السحب (تلقائية)"}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["سيتم تطبيق عمولة السحب الافتراضية لكل ألف: ",s==null?void 0:s.defaultWithdrawCommission," جنيه لكل ألف"]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(d,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const r=Ds(),i=parseFloat(P||"0")||0,c=(r==null?void 0:r.defaultWithdrawCommission)!=null&&Number(r.defaultWithdrawCommission)||0,p=Math.round(c*i/1e3*100)/100,f=ie?i+p:i;Fe((f||0).toString()),Ee?l({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):ne(!0)},children:"أجل"}),e.jsx(d,{type:"button",variant:"outline",size:"icon",className:"h-8 w-8",onClick:()=>Gt(r=>!r),title:ie?"العمولة تُضاف إلى الدين":"العمولة تُخصم من الدين",children:ie?e.jsx(Tt,{className:"h-4 w-4"}):e.jsx(_s,{className:"h-4 w-4"})}),e.jsx("span",{className:"text-xs text-gray-600",children:ie?"العمولة تُضاف":"العمولة تُخصم"})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة السحب على العملية (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(lt,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-orange-500"}),e.jsx(L,{id:"manualWithdrawCommissionInput",value:Te,onChange:r=>Jt(r.target.value),onKeyDown:r=>{if(r.key==="Enter"){const i=document.getElementById("withdrawSubmitButton");i==null||i.focus()}},placeholder:"أدخل العمولة المطلوبة",type:"number",className:"pl-10 h-10 text-sm transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"أدخل العمولة الإجمالية لإتمام عملية السحب"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(d,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const r=Ds(),i=parseFloat(P||"0")||0;let c=0;if((r==null?void 0:r.defaultWithdrawCommission)!=null){const f=Number(r.defaultWithdrawCommission)||0;c=Math.round(f*i/1e3*100)/100}else{const f=Te&&Te.trim()!==""?parseFloat(Te):Math.round(i*.01*100)/100;c=Math.max(0,f)}const p=ie?i+c:i;Fe((p||0).toString()),Ee?l({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):ne(!0)},children:"أجل"}),e.jsx(d,{type:"button",variant:"outline",size:"icon",title:ie?"العمولة تُضاف":"العمولة تُخصم",onClick:()=>Gt(r=>!r),children:ie?e.jsx(Tt,{className:"h-4 w-4 text-green-600"}):e.jsx(_s,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"text-xs text-gray-600",children:ie?"العمولة تُضاف":"العمولة تُخصم"})]})]})})(),e.jsx("div",{className:"sticky bottom-0 z-10 pt-2 bg-white/80 backdrop-blur supports-[backdrop-filter]:bg-white/60",children:e.jsx(d,{id:"withdrawSubmitButton",onClick:wl,className:"w-full font-medium h-10 text-sm btn-bounce hover-glow transition-all duration-300 bg-green-600 hover:bg-green-700 text-white",children:Bn?"تم السحب بنجاح":"تأكيد السحب"})})]}),e.jsx(me,{open:de,onOpenChange:ne,children:e.jsxs(he,{children:[e.jsxs(ue,{children:[e.jsx(xe,{children:"تحويل مؤجل"}),e.jsx(Zt,{children:"أدخل بيانات صاحب الدين والمبلغ والملاحظات ثم اضغط حفظ"})]}),e.jsxs("div",{className:"space-y-3",children:[gs&&gs.length>0?e.jsxs("div",{children:[e.jsx(q,{children:"اختيار عميل"}),e.jsxs(Bs,{value:Ke,onValueChange:s=>{us(s);const a=gs.find(r=>r.id===s);a&&Ie(a.name)},children:[e.jsx(Ms,{className:"w-full",children:e.jsx(Ls,{placeholder:"اختر عميل"})}),e.jsx($s,{children:gs.map(s=>e.jsxs(os,{value:s.id,children:[s.name,s.mobile?` — ${s.mobile}`:""]},s.id))})]})]}):e.jsx("div",{className:"text-xs text-gray-500",children:"لا يوجد عملاء مُسجلين حالياً. يمكنك إضافة عميل من نافذة الديون."}),e.jsxs("div",{children:[e.jsx(q,{htmlFor:"quickDebtName",children:"اسم صاحب الدين"}),e.jsx(L,{id:"quickDebtName",value:_e,onChange:s=>Ie(s.target.value),placeholder:"اكتب الاسم"})]}),e.jsxs("div",{children:[e.jsx(q,{htmlFor:"quickDebtAmount",children:"المبلغ (محسوب تلقائياً)"}),e.jsx(L,{id:"quickDebtAmount",type:"number",value:$e,readOnly:!0,placeholder:"المبلغ + عمولة التحويل"})]}),e.jsxs("div",{children:[e.jsx(q,{htmlFor:"quickDebtNotes",children:"ملاحظات"}),e.jsx(L,{id:"quickDebtNotes",value:ot,onChange:s=>mt(s.target.value),placeholder:"اكتب ملاحظات (اختياري)"})]})]}),e.jsx(Pe,{children:e.jsx(d,{type:"button",onClick:()=>{const s=Ds(),a=parseFloat((P||"").toString())||0;let r=0;if(ae==="transfer")if((s==null?void 0:s.defaultTransferCommission)!=null){const p=Number(s.defaultTransferCommission)||0;r=Math.round(p*a/1e3*100)/100}else{const p=He&&He.trim()!==""?parseFloat(He):0;r=Math.max(0,p)}else if((s==null?void 0:s.defaultWithdrawCommission)!=null){const p=Number(s.defaultWithdrawCommission)||0;r=Math.round(p*a/1e3*100)/100}else{const p=Te&&Te.trim()!==""?parseFloat(Te):Math.round(a*.01*100)/100;r=Math.max(0,p)}let i=0;if(ae==="withdraw"?i=ie?a:Math.max(0,Math.round((a-r)*100)/100):i=Math.max(0,Math.round((a+r)*100)/100),!_e||isNaN(i)||i<=0){l({title:"خطأ في بيانات الأجل",description:"يرجى إدخال الاسم والمبلغ بشكل صحيح",variant:"destructive"});return}const c=gs.find(p=>p.id===Ke);rs({debtorName:_e,amount:i,notes:ot,customerId:Ke||void 0,mobile:c==null?void 0:c.mobile}),As(!1),ne(!1),l({title:"تم حفظ بيانات الأجل",description:"سيتم إضافة الدين عند تأكيد العملية",variant:"default"})},children:"حفظ"})})]})})]})]}),e.jsx(st,{className:"bg-gradient-to-br from-red-50 to-red-100 border-red-200 fade-in-up card-float",children:e.jsxs(nt,{className:"p-3 text-center",children:[e.jsx("div",{className:"text-red-600 font-medium text-[10px] mb-1",children:"⚠️ تحذير من التحويل"}),e.jsx("div",{className:"text-[10px] text-red-700",children:"لا يمكن إلغاء أي عملية بعد تأكيدها للمحافظة على الأمان"})]})})]})]}),e.jsx(qc,{isOpen:Ii,onClose:()=>Ti(!1),initialEditingWallet:ki,onWalletUpdate:async()=>{try{await sr()}catch(s){console.error("Error reloading wallets after update:",s)}}}),e.jsx(Vc,{isOpen:Oi,onClose:()=>Tn(!1),transaction:Ai,onDelete:Uo}),e.jsx(es,{open:Bi,onOpenChange:oa,onSuccess:Ko,title:qo(),description:Vo(),mode:"verify"}),e.jsx(Ol,{open:Li,onOpenChange:jr,onSuccess:()=>{jr(!1),Pn(!0)},title:"حماية أرشيف التقارير اليومية",description:"أدخل كلمة مرور تسجيل الدخول للوصول إلى الأرشيف"}),e.jsx(jd,{open:Mi,onOpenChange:Pn,userId:t==null?void 0:t.uid}),e.jsx(Wl,{open:xo,onOpenChange:Qn,onSuccess:Ho,title:"تعديل الرصيد النقدي في الدرج",description:"أدخل الرقم السري والمبلغ الجديد لتعديل الرصيد النقدي في الدرج",currentBalance:Xe,balanceLabel:"الرصيد النقدي",userId:t==null?void 0:t.uid}),e.jsx(Wl,{open:po,onOpenChange:Xn,onSuccess:Go,title:"تعديل رصيد المحفظة",description:"أدخل الرقم السري والمبلغ الجديد لتعديل رصيد المحفظة",currentBalance:Et&&je[Et]||0,balanceLabel:`رصيد ${((Cl=ye.find(s=>s.id===Et))==null?void 0:Cl.name)||"المحفظة"}`,userId:t==null?void 0:t.uid}),e.jsx(Qc,{open:go,onOpenChange:_r,onSuccess:Qo,title:"إضافة أو خصم مبلغ من رصيد المحفظة",description:"أدخل الرقم السري والمبلغ المراد إضافته أو خصمه من رصيد المحفظة",currentBalance:Et&&je[Et]||0,balanceLabel:`رصيد ${((Il=ye.find(s=>s.id===Et))==null?void 0:Il.name)||"المحفظة"}`,userId:t==null?void 0:t.uid}),e.jsx(Yc,{open:Io,onOpenChange:To,userId:t==null?void 0:t.uid}),e.jsx(Hc,{open:ko,onOpenChange:Po,userId:t==null?void 0:t.uid}),e.jsx(Gc,{open:Ao,onOpenChange:Oo}),e.jsx(me,{open:bo,onOpenChange:Ja,children:e.jsxs(he,{className:"sm:max-w-md",children:[e.jsx(ue,{children:e.jsx(xe,{className:"text-right",children:"تعديل الدرج النقدية"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(q,{htmlFor:"amount",className:"text-right block",children:"المبلغ"}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx(L,{id:"amount",type:"number",placeholder:"أدخل المبلغ",value:Kr,onChange:s=>Ka(s.target.value),className:"text-right flex-1",dir:"rtl",min:"0"}),e.jsxs("div",{className:"flex gap-1",children:[e.jsxs(d,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white px-3 py-2",onClick:()=>{if(!ln(Qr)){l({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}const s=parseFloat(Kr);if(isNaN(s)||s<=0){l({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const a=Xe+s;ht(a);const r={cashBalance:a,lastUpdated:new Date().toISOString()},i=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(i,JSON.stringify(r)),t!=null&&t.uid?Ce.updateUserData(t.uid,r).then(()=>{console.log("✅ تم حفظ رصيد الدرج النقدي في Firebase بنجاح"),localStorage.removeItem(i),ve(!1)}).catch(c=>{console.error("❌ خطأ في حفظ الرصيد في Firebase:",c),ve(!0)}):ve(!0),l({title:"تم بنجاح",description:`تم إضافة ${s} جنيه إلى الدرج النقدية وحفظه في السحابة`}),Ja(!1),Ka(""),Ha("")},children:[e.jsx(Tt,{className:"h-1 w-1 mr-1"}),"إضافة"]}),e.jsxs(d,{type:"button",size:"sm",className:"bg-red-600 hover:bg-red-700 text-white px-3 py-2",onClick:()=>{if(!ln(Qr)){l({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}const s=parseFloat(Kr);if(isNaN(s)||s<=0){l({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const a=Xe-s;ht(a);const r={cashBalance:a,lastUpdated:new Date().toISOString()},i=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(i,JSON.stringify(r)),t!=null&&t.uid?Ce.updateUserData(t.uid,r).then(()=>{console.log("✅ تم حفظ رصيد الدرج النقدي في Firebase بنجاح"),localStorage.removeItem(i),ve(!1)}).catch(c=>{console.error("❌ خطأ في حفظ الرصيد في Firebase:",c),ve(!0)}):ve(!0),l({title:"تم بنجاح",description:`تم خصم ${s} جنيه من الدرج النقدية وحفظه في السحابة`}),Ja(!1),Ka(""),Ha("")},children:[e.jsx(_s,{className:"h-1 w-1 mr-1"}),"خصم"]})]})]}),e.jsxs("p",{className:"text-[10px] text-gray-500 text-right",children:["الرصيد الحالي: ",Xe.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(q,{htmlFor:"pin",className:"text-right block",children:"الرقم السري"}),e.jsx(L,{id:"pin",type:"password",placeholder:"أدخل الرقم السري",value:Qr,onChange:s=>Ha(s.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsx(Pe,{className:"flex gap-2",children:e.jsx(d,{variant:"outline",onClick:()=>{Ja(!1),Ka(""),Ha("")},children:"إلغاء"})})]})}),e.jsx(me,{open:Eo,onOpenChange:Za,children:e.jsxs(he,{className:"sm:max-w-md",children:[e.jsx(ue,{children:e.jsx(xe,{className:"text-right text-red-600",children:"تصفير إجمالي المحفظة"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-red-50 rounded-lg border border-red-200",children:[e.jsx("p",{className:"text-red-800 font-medium mb-2",children:"تحذير!"}),e.jsx("p",{className:"text-red-700 text-sm",children:"سيتم تصفير جميع أرصدة المحافظ إلى صفر. هذا الإجراء لا يمكن التراجع عنه."}),e.jsxs("p",{className:"text-red-600 text-sm mt-2",children:["الرصيد الحالي: ",Object.values(je).reduce((s,a)=>s+a,0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(q,{htmlFor:"resetWalletTotalPin",className:"text-right block",children:"الرقم السري الرئيسي"}),e.jsx(L,{id:"resetWalletTotalPin",type:"password",placeholder:"أدخل الرقم السري الرئيسي",value:yl,onChange:s=>er(s.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsxs(Pe,{className:"flex gap-2",children:[e.jsx(d,{variant:"outline",onClick:()=>{Za(!1),er("")},children:"إلغاء"}),e.jsx(d,{variant:"destructive",onClick:async()=>{if(!await Vt.verifyMasterPin(yl,t==null?void 0:t.uid)){l({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}try{const a={};Object.keys(je).forEach(p=>{a[p]=0}),Ze(a),localStorage.setItem(ct(),JSON.stringify(a)),Za(!1),er("");const r=new Date().toISOString(),i={walletBalances:a,lastUpdated:r},c=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(c,JSON.stringify(i)),t!=null&&t.uid?Ce.updateUserData(t.uid,i).then(()=>{localStorage.removeItem(c),ve(!1)}).catch(p=>{console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",p),ve(!0),l({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):ve(!0),setTimeout(()=>{Ze({...a})},100)}catch(a){console.error("خطأ في تصفير أرصدة المحافظ:",a),l({title:"خطأ",description:"حدث خطأ أثناء تصفير المحافظ",variant:"destructive"})}},children:"تصفير المحفظة"})]})]})}),e.jsx(me,{open:fo,onOpenChange:za,children:e.jsxs(he,{className:"sm:max-w-md",children:[e.jsx(ue,{children:e.jsx(xe,{className:"text-right text-red-600",children:"تصفير رصيد المحفظة المختارة"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-red-50 rounded-lg border border-red-200",children:[e.jsx("p",{className:"text-red-800 font-medium mb-2",children:"تحذير!"}),e.jsx("p",{className:"text-red-700 text-sm",children:"سيتم تصفير رصيد المحفظة المحددة إلى صفر. هذا الإجراء لا يمكن التراجع عنه."}),e.jsxs("p",{className:"text-red-600 text-sm mt-2",children:["المحفظة: ",((Tl=ye.find(s=>s.id===Q))==null?void 0:Tl.name)||Q]}),e.jsxs("p",{className:"text-red-600 text-sm",children:["الرصيد الحالي: ",(Q&&je[Q]?je[Q]:0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(q,{htmlFor:"resetSelectedWalletPin",className:"text-right block",children:"الرقم السري الرئيسي"}),e.jsx(L,{id:"resetSelectedWalletPin",type:"password",autoComplete:"off",placeholder:"أدخل الرقم السري الرئيسي",value:Zn,onChange:s=>zr(s.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsxs(Pe,{className:"flex gap-2",children:[e.jsx(d,{variant:"outline",onClick:()=>{za(!1),zr("")},children:"إلغاء"}),e.jsx(d,{variant:"destructive",onClick:async()=>{var a;if(!Q){l({title:"اختر محفظة",description:"يرجى اختيار محفظة أولاً",variant:"destructive"});return}if(!await Vt.verifyMasterPin(Zn,t==null?void 0:t.uid)){l({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}try{const r={...je};r[Q]=0,Ze(r),localStorage.setItem(ct(),JSON.stringify(r)),za(!1),zr("");const i=new Date().toISOString(),c={walletBalances:r,lastUpdated:i},p=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(p,JSON.stringify(c)),t!=null&&t.uid?Ce.updateUserData(t.uid,c).then(()=>{localStorage.removeItem(p),ve(!1)}).catch(f=>{console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",f),ve(!0),l({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):ve(!0),l({title:"تم التصفير بنجاح",description:`تم تصفير رصيد المحفظة ${((a=ye.find(f=>f.id===Q))==null?void 0:a.name)||Q}`})}catch(r){console.error("خطأ في تصفير رصيد المحفظة المختارة:",r),l({title:"خطأ",description:"حدث خطأ أثناء تصفير رصيد المحفظة المختارة",variant:"destructive"})}},children:"تصفير المحفظة"})]})]})}),e.jsx(me,{open:Fo,onOpenChange:Xa,children:e.jsxs(he,{className:"sm:max-w-md",children:[e.jsx(ue,{children:e.jsxs(xe,{className:"text-right text-green-600 flex items-center gap-2 justify-end",children:[e.jsx(Tt,{className:"h-4 w-4"}),"إضافة أموال لإجمالي المحفظة"]})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-green-50 rounded-lg border border-green-200",children:[e.jsx("p",{className:"text-green-800 font-medium mb-2",children:"إضافة أموال"}),e.jsx("p",{className:"text-green-700 text-sm",children:"سيتم إضافة المبلغ المحدد إلى إجمالي المحفظة بشكل متناسب على جميع المحافظ."}),e.jsxs("p",{className:"text-green-600 text-sm mt-2",children:["الرصيد الحالي: ",Object.values(je).reduce((s,a)=>s+a,0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"addWalletTotalAmount",className:"text-right block",children:"المبلغ المراد إضافته"}),e.jsx(L,{id:"addWalletTotalAmount",type:"number",placeholder:"أدخل المبلغ",value:hl,onChange:s=>tn(s.target.value),className:"text-right",dir:"rtl"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"addWalletTotalPin",className:"text-right block",children:"الرقم السري للتأكيد"}),e.jsx(L,{id:"addWalletTotalPin",type:"password",autoComplete:"off",placeholder:"أدخل الرقم السري",value:ul,onChange:s=>sn(s.target.value),className:"text-right",dir:"rtl"})]})]})]}),e.jsxs(Pe,{className:"flex gap-2",children:[e.jsx(d,{variant:"outline",onClick:()=>{Xa(!1),tn(""),sn("")},children:"إلغاء"}),e.jsx(d,{variant:"default",className:"bg-green-600 hover:bg-green-700",disabled:xl,onClick:async()=>{const s=parseFloat(hl);if(!s||s<=0){l({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}if(!Lo(ul)){l({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}pl(!0);try{const a=Object.values(je).reduce((r,i)=>r+i,0);if(a===0){const r=Object.keys(je),i=s/r.length,c={};r.forEach(p=>{c[p]=i}),Ze(c),localStorage.setItem(ct(),JSON.stringify(c)),t!=null&&t.uid?await Ce.updateUserData(t.uid,{walletBalances:c,lastUpdated:new Date().toISOString()}):ve(!0)}else{const r={};Object.entries(je).forEach(([i,c])=>{const p=c/a,f=s*p;r[i]=c+f}),Ze(r),localStorage.setItem(ct(),JSON.stringify(r)),t!=null&&t.uid?await Ce.updateUserData(t.uid,{walletBalances:r,lastUpdated:new Date().toISOString()}):ve(!0)}setTimeout(()=>{Ze(r=>({...r}))},100),Xa(!1),tn(""),sn("")}catch(a){console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",a),l({title:"خطأ",description:"حدث خطأ أثناء حفظ البيانات",variant:"destructive"})}finally{pl(!1)}},children:xl?"جاري الإضافة...":"إضافة الأموال"})]})]})}),e.jsx(me,{open:Bo,onOpenChange:tr,children:e.jsxs(he,{className:"sm:max-w-[425px]",children:[e.jsx(ue,{children:e.jsxs(xe,{className:"text-red-600 flex items-center gap-2",children:[e.jsx(Ut,{className:"h-1 w-1"}),"تصفير الرصيد النقدي"]})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-3",children:e.jsx("p",{className:"text-sm text-red-700",children:"⚠️ تحذير: سيتم تصفير الرصيد النقدي في الدرج إلى صفر. هذا الإجراء لا يمكن التراجع عنه."})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(q,{htmlFor:"resetCashPin",children:"الرقم السري الرئيسي"}),e.jsx(L,{id:"resetCashPin",type:"password",autoComplete:"off",placeholder:"أدخل الرقم السري الرئيسي",value:rn,onChange:s=>nn(s.target.value)})]})]}),e.jsxs(Pe,{children:[e.jsx(d,{variant:"outline",onClick:()=>{tr(!1),nn("")},children:"إلغاء"}),e.jsx(d,{variant:"destructive",onClick:async()=>{if(!rn){l({title:"خطأ",description:"يرجى إدخال الرقم السري",variant:"destructive"});return}if(!await Vt.verifyMasterPin(rn,t==null?void 0:t.uid)){l({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}try{ht(0),tr(!1),nn("");const a={cashBalance:0,lastUpdated:new Date().toISOString()};localStorage.setItem(dt(),"0");const r=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(r,JSON.stringify(a)),t!=null&&t.uid?Ce.updateUserData(t.uid,a).then(()=>{localStorage.removeItem(r),ve(!1)}).catch(i=>{console.error("خطأ في حفظ الرصيد في Firebase:",i),ve(!0),l({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):ve(!0)}catch(a){console.error("خطأ في تصفير الرصيد النقدي:",a),l({title:"خطأ",description:"حدث خطأ أثناء تصفير الرصيد النقدي",variant:"destructive"})}},children:"تصفير الرصيد"})]})]})}),e.jsx(me,{open:Wo,onOpenChange:Ga,children:e.jsxs(he,{className:"sm:max-w-[425px]",children:[e.jsx(ue,{children:e.jsxs(xe,{className:"text-green-600 flex items-center gap-2",children:[e.jsx(Tt,{className:"h-4 w-4"}),"إضافة أموال للدرج"]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-3",children:e.jsx("p",{className:"text-sm text-green-700",children:"💰 سيتم إضافة المبلغ المحدد إلى الرصيد النقدي في الدرج"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"addCashAmount",children:"المبلغ المراد إضافته"}),e.jsx(L,{id:"addCashAmount",type:"number",placeholder:"أدخل المبلغ",value:Qa,onChange:s=>Xr(s.target.value),min:"0",step:"0.01"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"addCashPin",children:"الرقم السري لدرج النقدية"}),e.jsx(L,{id:"addCashPin",type:"password",placeholder:"أدخل الرقم السري",value:Zr,onChange:s=>en(s.target.value)})]})]}),e.jsxs(Pe,{children:[e.jsx(d,{variant:"outline",onClick:()=>{Ga(!1),Xr(""),en("")},children:"إلغاء"}),e.jsx(d,{variant:"default",className:"bg-green-600 hover:bg-green-700",disabled:dl,onClick:async()=>{if(!Qa||parseFloat(Qa)<=0){l({title:"خطأ",description:"يرجى إدخال مبلغ صحيح أكبر من صفر",variant:"destructive"});return}if(!Zr){l({title:"خطأ",description:"يرجى إدخال الرقم السري",variant:"destructive"});return}if(!ln(Zr)){l({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}ml(!0);try{const s=parseFloat(Qa),a=Xe+s;ht(a),localStorage.setItem(dt(),a.toString());const r={cashBalance:a,lastUpdated:new Date().toISOString()},i=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(i,JSON.stringify(r)),t!=null&&t.uid?(await Ce.updateUserData(t.uid,r),localStorage.removeItem(i),ve(!1)):ve(!0),Ga(!1),Xr(""),en("")}catch(s){console.error("خطأ في حفظ الرصيد في Firebase:",s),ht(Xe),localStorage.setItem("cashBalance",Xe.toString()),l({title:"خطأ",description:"حدث خطأ أثناء حفظ البيانات، يرجى المحاولة مرة أخرى",variant:"destructive"})}finally{ml(!1)}},children:dl?"جاري الإضافة...":"إضافة الأموال"})]})]})}),e.jsx(me,{open:uo,onOpenChange:Ur,children:e.jsxs(he,{className:"sm:max-w-md",children:[e.jsx(ue,{children:e.jsx(xe,{className:"text-right",children:"اختيار التاريخ والوقت للبحث"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(q,{htmlFor:"search-date",className:"text-right block",children:"التاريخ"}),e.jsx(L,{id:"search-date",type:"date",value:Oa,onChange:s=>Fn(s.target.value),className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(q,{htmlFor:"search-time",className:"text-right block",children:"الوقت (اختياري)"}),e.jsx(L,{id:"search-time",type:"time",value:Wa,onChange:s=>En(s.target.value),className:"text-right",placeholder:"اختر الوقت للبحث في ساعة محددة"}),e.jsx("p",{className:"text-[10px] text-gray-500 text-right",children:"إذا لم تختر وقتاً محدداً، سيتم البحث في كامل اليوم"})]})]}),e.jsxs(Pe,{className:"flex justify-between",children:[e.jsx(d,{variant:"outline",onClick:()=>{Fn(""),En(""),Ur(!1)},children:"مسح"}),e.jsx(d,{onClick:()=>Ur(!1),children:"تطبيق"})]})]})}),e.jsx(Fl,{isOpen:Yt&&!_,onClose:()=>Ue(!1),onTrialStarted:mo}),e.jsx(Xc,{isOpen:Ji,onClose:()=>Sr(!1)}),e.jsx(Zc,{isOpen:br,onClose:()=>ia(!1),initialBarcode:Di}),e.jsx(kc,{isOpen:Ki,onClose:()=>Ea(!1)}),e.jsx(Pc,{open:qi,onOpenChange:Ba}),e.jsx(xd,{open:Vi,onOpenChange:s=>{if(s&&!is){l({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});return}Ma(s)}}),e.jsx(Nd,{open:X,onOpenChange:s=>{if(s&&!is){l({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}M(s)}}),e.jsx(wd,{open:I,onOpenChange:s=>{if(s&&!is){l({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}R(s)}}),e.jsx(me,{open:yo,onOpenChange:s=>{if(s){l({title:"قيد التطوير",description:"هذه الميزة غير متاحة حالياً."});return}qr(!1)},children:e.jsxs(he,{dir:"rtl",className:"sm:max-w-md w-[95vw] sm:w-auto rounded-2xl border border-emerald-200 shadow-xl bg-gradient-to-br from-white via-green-50 to-emerald-50 backdrop-blur-md data-[state=open]:animate-in data-[state=open]:fade-in-0 data-[state=open]:zoom-in-90 data-[state=open]:slide-in-from-bottom-8 duration-300",children:[e.jsxs(ue,{children:[e.jsx(xe,{className:"text-right text-green-700",children:"شحن رصيد الموبايل"}),e.jsx(Zt,{className:"text-right text-gray-600",children:"أدخل البيانات ثم اضغط تأكيد"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx(q,{htmlFor:"topupPhone",className:"text-right block",children:"رقم الموبايل"}),e.jsx(L,{id:"topupPhone",value:qa,onChange:s=>el(s.target.value),placeholder:"010xxxxxxx",className:"text-right"})]}),e.jsxs("div",{children:[e.jsx(q,{className:"text-right block",children:"شركة التشغيل"}),e.jsxs(Bs,{value:Va,onValueChange:tl,children:[e.jsx(Ms,{className:"text-right",children:e.jsx(Ls,{placeholder:"اختر الشركة"})}),e.jsxs($s,{children:[e.jsx(os,{value:"vodafone",children:"فودافون"}),e.jsx(os,{value:"orange",children:"أورنج"}),e.jsx(os,{value:"etisalat",children:"اتصالات"}),e.jsx(os,{value:"we",children:"WE"})]})]})]}),e.jsxs("div",{children:[e.jsx(q,{htmlFor:"topupAmount",className:"text-right block",children:"المبلغ بالجنيه"}),e.jsx(L,{id:"topupAmount",type:"number",value:Ya,onChange:s=>sl(s.target.value?Number(s.target.value):""),placeholder:"50",className:"text-right"})]})]}),e.jsxs(Pe,{className:"flex gap-2 justify-between",children:[e.jsx(d,{variant:"outline",onClick:()=>qr(!1),className:"border-gray-300",children:"إلغاء"}),e.jsx(d,{onClick:y,disabled:al||!qa||!Va||!Ya,className:"bg-emerald-600 hover:bg-emerald-700 text-white",children:al?"جارٍ التنفيذ...":"تأكيد الشحن"})]})]})}),e.jsx(es,{open:eo,onOpenChange:ha,mode:"verify",title:"الرقم السري الرئيسي لفتح الديون",description:"أدخل الرقم السري الرئيسي لفتح صفحة الديون",onSuccess:()=>{ha(!1),$a(!0)}}),e.jsx(Ol,{open:vo,onOpenChange:Jr,title:"تأكيد كلمة المرور لتصفير المعاملات الأخيرة",description:"لن يتم حذف الإيصالات؛ سنبدأ القائمة من الآن.",onSuccess:()=>{try{t!=null&&t.uid&&(localStorage.setItem(`recentTransactionsResetAt:${t.uid}`,new Date().toISOString()),l({title:"تم التصفير",description:"تم بدء قائمة المعاملات من الآن."}))}catch{}Jr(!1)}}),e.jsx(es,{open:J,onOpenChange:V,mode:"verify",title:"الرقم السري لفتح مصروفات المحل",description:"أدخل الرقم السري الرئيسي لفتح نافذة مصروفات المحل",onSuccess:()=>{V(!1),ce(!0)}}),e.jsx(me,{open:Zi,onOpenChange:$a,children:e.jsxs(he,{className:"sm:max-w-[425px]",children:[e.jsxs(ue,{className:"flex items-center justify-between",children:[e.jsx(xe,{className:"text-right",children:"إدارة الديون"}),e.jsxs("div",{className:"flex items-center gap-1 text-orange-700",children:[e.jsx($c,{className:"h-4 w-4"}),e.jsxs("span",{className:"text-xs font-bold",children:[Jo," جنيه"]})]})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(q,{htmlFor:"debtorName",className:"text-right col-span-1",children:"اسم المديون"}),e.jsx(L,{id:"debtorName",value:Cr,onChange:s=>Un(s.target.value),className:"col-span-3 text-right",placeholder:"أدخل اسم المديون"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(q,{htmlFor:"debtAmount",className:"text-right col-span-1",children:"المبلغ"}),e.jsx(L,{id:"debtAmount",type:"number",value:Ir,onChange:s=>_n(s.target.value),className:"col-span-3 text-right",placeholder:"أدخل المبلغ"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(q,{htmlFor:"debtReason",className:"text-right col-span-1",children:"سبب الدين"}),e.jsx(L,{id:"debtReason",value:Tr,onChange:s=>zn(s.target.value),className:"col-span-3 text-right",placeholder:"أدخل سبب الدين"})]})]}),e.jsx(Pe,{children:e.jsx(d,{onClick:()=>{if(Cr&&Ir&&Tr){const s={id:Date.now().toString(),debtorName:Cr,amount:parseFloat(Ir),reason:Tr,status:"pending",createdAt:new Date,paidAmount:0,partialPayments:[]};Lr(s),Ra(!0)}else l({title:"بيانات غير مكتملة",description:"يرجى إدخال الاسم والمبلغ والسبب",variant:"destructive"})},className:"bg-orange-500 hover:bg-orange-600",children:"حفظ"})}),e.jsx("div",{className:"mt-2",children:e.jsx(d,{variant:"outline",className:"w-full",onClick:()=>xa(!0),children:"إيصالات الديون"})}),e.jsx("div",{className:"mt-2",children:e.jsx(d,{variant:"outline",className:"w-full",onClick:()=>Or(!0),children:"إضافة عميل"})})]})}),e.jsx(me,{open:ao,onOpenChange:xa,children:e.jsxs(he,{className:"sm:max-w-[520px]",children:[e.jsxs(ue,{children:[e.jsx(xe,{className:"text-right",children:"إيصالات الديون"}),e.jsx(Zt,{className:"text-right",children:"اختر دينًا لعرض إيصاله بالتفصيل"})]}),Ot.length>0?e.jsx("div",{className:"max-h-64 overflow-y-auto space-y-2",children:Ot.map(s=>e.jsx("div",{onClick:()=>{kr(s),ua(!0),xa(!1),$a(!1)},className:"p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium",children:s.debtorName}),e.jsx("p",{className:"text-sm text-gray-600",children:s.reason}),e.jsx("p",{className:"text-sm text-gray-500",children:on.format(s.createdAt instanceof Date?s.createdAt:new Date(s.createdAt))})]}),e.jsxs("div",{className:"text-left",children:[e.jsxs("p",{className:"font-bold text-lg",children:[s.amount," جنيه"]}),e.jsx(jt,{variant:s.status==="paid"?"default":"secondary",className:s.status==="paid"?"bg-green-500":"bg-yellow-500",children:s.status==="paid"?"مدفوع":"قيد المراجعة"})]})]})},s.id))}):e.jsx("div",{className:"text-center text-sm text-gray-500",children:"لا توجد ديون مسجلة"}),e.jsxs(Pe,{className:"flex justify-between mt-3",children:[e.jsx(d,{variant:"destructive",onClick:async()=>{try{if(!Ot||Ot.length===0){l({title:"لا توجد ديون",description:"القائمة فارغة بالفعل."});return}if(!window.confirm("هل تريد حذف كل إيصالات الديون؟ هذا الإجراء لا يمكن التراجع عنه."))return;const a=[];Qt(a),kr(null),await fs(a),l({title:"تم حذف كل إيصالات الديون",description:"تم تفريغ القائمة بالكامل."}),xa(!1)}catch(s){console.error("تعذر حذف كل إيصالات الديون:",s),l({title:"فشل الحذف",description:"حدث خطأ أثناء الحذف، حاول مرة أخرى.",variant:"destructive"})}},children:"حذف كل الإيصالات"}),e.jsx(d,{variant:"outline",onClick:()=>xa(!1),children:"إغلاق"})]})]})}),e.jsx(me,{open:ro,onOpenChange:Or,children:e.jsxs(he,{className:"sm:max-w-[480px]",children:[e.jsxs(ue,{children:[e.jsx(xe,{className:"text-right",children:"إضافة عميل"}),e.jsx(Zt,{className:"text-right",children:"أدخل بيانات العميل ثم يمكنك تسجيل مبلغ دين عليه"})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(q,{htmlFor:"customerName",className:"text-right col-span-1",children:"اسم العميل"}),e.jsx(L,{id:"customerName",value:Fr,onChange:s=>Kn(s.target.value),className:"col-span-3 text-right",placeholder:"اكتب اسم العميل"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(q,{htmlFor:"customerMobile",className:"text-right col-span-1",children:"رقم الموبايل"}),e.jsx(L,{id:"customerMobile",value:Er,onChange:s=>qn(s.target.value),className:"col-span-3 text-right",placeholder:"اكتب رقم الموبايل"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(d,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{if(!Fr||!Er){l({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم العميل ورقم الموبايل",variant:"destructive"});return}const s={id:Date.now().toString(),name:Fr.trim(),mobile:Er.trim(),createdAt:new Date},a=[s,...gs];await So(a),Kn(""),qn(""),l({title:"تمت إضافة العميل",description:`تم إضافة ${s.name}`})},children:"إضافة"})}),e.jsxs("div",{className:"border-t pt-4 space-y-3",children:[e.jsx(q,{className:"text-right block",children:"إضافة مبلغ على عميل"}),gs.length>0?e.jsxs("div",{className:"space-y-3",children:[e.jsxs(Bs,{value:Br,onValueChange:Vn,children:[e.jsx(Ms,{className:"w-full",children:e.jsx(Ls,{placeholder:"اختر عميل"})}),e.jsx($s,{children:gs.map(s=>e.jsxs(os,{value:s.id,children:[s.name," — ",s.mobile]},s.id))})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(q,{htmlFor:"customerDebtAmount",className:"text-right col-span-1",children:"المبلغ"}),e.jsx(L,{id:"customerDebtAmount",type:"number",value:Yn,onChange:s=>Hn(s.target.value),className:"col-span-3 text-right",placeholder:"أدخل المبلغ"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(d,{className:"bg-orange-600 hover:bg-orange-700",onClick:async()=>{const s=parseFloat(Yn);if(!Br){l({title:"اختر عميل",description:"يرجى اختيار عميل أولاً",variant:"destructive"});return}if(isNaN(s)||s<=0){l({title:"قيمة غير صحيحة",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const a=gs.find(c=>c.id===Br);if(!a)return;const r={id:Date.now().toString(),debtorName:a.name,customerId:a.id,mobile:a.mobile,amount:Number(s.toFixed(2)),reason:"دين عميل",status:"pending",createdAt:new Date,paidAmount:0,partialPayments:[]},i=[...Ot,r];Qt(i),await fs(i),Vn(""),Hn(""),l({title:"تم تسجيل المبلغ على العميل",description:`تمت إضافة ${r.amount} جنيه للعميل ${a.name}`})},children:"إضافة المبلغ"})})]}):e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد عملاء مسجلين. أضف عميلًا أولاً."})]})]}),e.jsx(Pe,{className:"flex justify-end",children:e.jsx(d,{variant:"outline",onClick:()=>Or(!1),children:"إغلاق"})})]})}),e.jsx(me,{open:re,onOpenChange:ce,children:e.jsxs(he,{className:"sm:max-w-[520px]",children:[e.jsxs(ue,{children:[e.jsx(xe,{className:"text-right",children:"مصروفات المحل"}),e.jsx(Zt,{className:"text-right",children:"أدخل تفاصيل المصروف ثم اختر مصدر الخصم."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(q,{htmlFor:"expenseName",className:"text-right col-span-1",children:"اسم المصروف"}),e.jsx(L,{id:"expenseName",value:Ae,onChange:s=>H(s.target.value),className:"col-span-3 text-right",placeholder:"مثال: كهرباء، صيانة، مشتريات"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(q,{htmlFor:"expenseAmount",className:"text-right col-span-1",children:"تمن المصروف"}),e.jsx(L,{id:"expenseAmount",type:"number",value:le,onChange:s=>Be(s.target.value),className:"col-span-3 text-right",placeholder:"0.00"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(q,{htmlFor:"expenseNotes",className:"text-right col-span-1",children:"ملاحظات"}),e.jsx(L,{id:"expenseNotes",value:Ge,onChange:s=>kt(s.target.value),className:"col-span-3 text-right",placeholder:"معلومات إضافية إن وجدت"})]})]}),e.jsxs(Pe,{className:"flex justify-between",children:[e.jsx(d,{className:"bg-orange-600 hover:bg-orange-700",onClick:()=>{if(!Ae||!le){l({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم المصروف وقيمته",variant:"destructive"});return}Lt(!0)},children:"إضافة مصروف"}),e.jsx(d,{variant:"outline",onClick:()=>At(!0),children:"إيصالات المصاريف"})]})]})}),e.jsx(me,{open:Pt,onOpenChange:At,children:e.jsxs(he,{className:"sm:max-w-[420px]",dir:"rtl",children:[e.jsxs(ue,{children:[e.jsx(xe,{className:"text-right",children:"إيصالات المصاريف"}),e.jsx(Zt,{className:"text-right",children:"آخر المصاريف المسجلة"})]}),Je.length>0?e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:Je.map(s=>e.jsx("div",{className:"p-2 border rounded-lg bg-white hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium text-sm",children:s.name}),e.jsx("p",{className:"text-[11px] text-gray-600",children:s.notes||"بدون ملاحظات"}),e.jsx("p",{className:"text-[10px] text-gray-500",children:new Date(s.createdAt).toLocaleString("ar-EG")})]}),e.jsxs("div",{className:"text-left",children:[e.jsxs("p",{className:"font-bold text-sm",children:[s.amount," جنيه"]}),e.jsx(jt,{variant:"secondary",className:s.source==="cash"?"bg-blue-100 text-blue-700":"bg-purple-100 text-purple-700",children:s.source==="cash"?"من النقدية":`من المحفظة${s.walletId?` (${s.walletId})`:""}`})]})]})},s.id))}):e.jsx("p",{className:"text-sm text-gray-500 text-center",children:"لا توجد مصاريف مسجلة بعد"})]})}),e.jsx(me,{open:pt,onOpenChange:Lt,children:e.jsxs(he,{className:"sm:max-w-[480px]",children:[e.jsx(ue,{children:e.jsx(xe,{className:"text-right",children:"اختيار مصدر خصم المصروف"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600 text-right",children:"اختر هل تريد خصم مبلغ المصروف من الرصيد النقدي في الدرج أم من إحدى المحافظ."}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsx(d,{variant:Qe==="cash"?"default":"outline",className:Qe==="cash"?"bg-blue-600 hover:bg-blue-700 text-white":"",onClick:()=>at("cash"),children:"الفلوس النقدية"}),e.jsx(d,{variant:Qe==="wallet"?"default":"outline",className:Qe==="wallet"?"bg-purple-600 hover:bg-purple-700 text-white":"",onClick:()=>at("wallet"),children:"أرصدة المحافظ"})]}),Qe==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{className:"text-right block",children:"اختر المحفظة للخصم"}),e.jsxs(Bs,{value:Me,onValueChange:gt,children:[e.jsx(Ms,{className:"w-full",children:e.jsx(Ls,{placeholder:"اختر محفظة"})}),e.jsx($s,{children:ye.map(s=>e.jsx(os,{value:s.id,children:s.phone||s.name||s.id},s.id))})]})]})]}),e.jsxs(Pe,{className:"flex justify-between",children:[e.jsx(d,{variant:"outline",onClick:()=>{Lt(!1),at(null),gt("")},children:"إلغاء"}),e.jsx(d,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{const s=Number(le);if(isNaN(s)||s<=0){l({title:"قيمة غير صحيحة",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}if(!Qe){l({title:"اختر مصدر الخصم",description:"يرجى اختيار النقدية أو المحفظة",variant:"destructive"});return}try{if(Qe==="cash"){const i=Number((Xe-s).toFixed(2));ht(i),localStorage.setItem(dt(),i.toString());const c={cashBalance:i,lastUpdated:new Date().toISOString()},p=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(p,JSON.stringify(c)),t!=null&&t.uid?(await Ce.updateUserData(t.uid,c),localStorage.removeItem(p),ve(!1)):ve(!0)}else if(Qe==="wallet"){if(!Me){l({title:"اختر محفظة",description:"يرجى اختيار محفظة للخصم",variant:"destructive"});return}const i=je[Me]||0,c=Number((i-s).toFixed(2)),p={...je,[Me]:c};Ze(p);const f=new Date().toISOString(),N={walletBalances:p,lastUpdated:f},D=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(D,JSON.stringify(N)),localStorage.setItem(ct(),JSON.stringify(p)),localStorage.setItem(`walletBalances_backup_${f}`,JSON.stringify(p)),t!=null&&t.uid&&await Ce.updateUserData(t.uid,N)}}catch(i){console.error("خطأ أثناء تحديث الأرصدة عند حفظ المصروف:",i)}const a={id:Date.now().toString(),name:Ae,amount:s,notes:Ge,source:Qe,walletId:Qe==="wallet"?Me:void 0,createdAt:new Date},r=[...Je,a];await No(r),H(""),Be(""),kt(""),at(null),gt(""),Lt(!1),ce(!0),At(!0),l({title:"تم إضافة المصروف",description:Qe==="cash"?"تم الخصم من النقدية":"تم الخصم من أرصدة المحافظ"})},children:"تأكيد الخصم"})]})]})}),e.jsx(me,{open:ss,onOpenChange:_t,children:e.jsxs(he,{className:"sm:max-w-[520px]",children:[e.jsxs(ue,{children:[e.jsx(xe,{className:"text-right",children:"النواقص"}),e.jsx(Zt,{className:"text-right",children:"سجل العناصر الناقصة التي تحتاج شراء وتابع حالتها."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(q,{htmlFor:"deficiencyName",className:"text-right col-span-1",children:"اسم العنصر"}),e.jsx(L,{id:"deficiencyName",value:as,onChange:s=>Ft(s.target.value),className:"col-span-3 text-right",placeholder:"مثال: سكر، زيت، مناديل"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(q,{htmlFor:"deficiencyQuantity",className:"text-right col-span-1",children:"الكمية"}),e.jsx(L,{id:"deficiencyQuantity",type:"number",value:A,onChange:s=>se(s.target.value),className:"col-span-3 text-right",placeholder:"1"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(d,{className:"bg-rose-600 hover:bg-rose-700",onClick:()=>{if(Ee){l({title:"غير متاح",description:"النواقص غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"});return}const s=parseInt(A||"1",10);if(!as){l({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم العنصر",variant:"destructive"});return}if(isNaN(s)||s<=0){l({title:"كمية غير صحيحة",description:"يرجى إدخال كمية صحيحة",variant:"destructive"});return}const a={id:Date.now().toString(),name:as,quantity:s,status:"pending",createdAt:new Date};ke(r=>{const i=[...r,a];return Yr(i),i}),Ft(""),se(""),l({title:"تمت الإضافة",description:"تمت إضافة العنصر إلى قائمة النواقص"})},children:"إضافة للنواقص"})}),pe.length>0?e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:pe.map(s=>e.jsx("div",{className:"p-2 border rounded-lg bg-white hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium text-sm",children:s.name}),e.jsxs("p",{className:"text-[11px] text-gray-600",children:["الكمية: ",s.quantity]}),e.jsx("p",{className:"text-[10px] text-gray-500",children:new Date(s.createdAt).toLocaleString("ar-EG")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(jt,{variant:"secondary",className:s.status==="pending"?"bg-rose-100 text-rose-700":"bg-green-100 text-green-700",children:s.status==="pending"?"قيد الشراء":"تم الشراء"}),e.jsx(d,{variant:"outline",className:s.status==="pending"?"text-green-700 border-green-300 hover:bg-green-50":"text-rose-700 border-rose-300 hover:bg-rose-50",onClick:()=>{ke(a=>{const r=a.map(i=>i.id===s.id?{...i,status:i.status==="pending"?"purchased":"pending"}:i);return Yr(r),r})},title:s.status==="pending"?"تم الشراء":"إلغاء الشراء",children:s.status==="pending"?"تم الشراء":"إلغاء الشراء"}),e.jsx(d,{variant:"outline",className:"text-red-700 border-red-300 hover:bg-red-50",onClick:()=>{ke(a=>{const r=a.filter(i=>i.id!==s.id);return Yr(r),r})},title:"حذف",children:"حذف"})]})]})},s.id))}):e.jsx("p",{className:"text-sm text-gray-500 text-center",children:"لا توجد عناصر مسجلة في النواقص"})]}),e.jsx(Pe,{className:"flex justify-end",children:e.jsx(d,{variant:"outline",onClick:()=>_t(!1),children:"إغلاق"})})]})}),e.jsx(me,{open:no,onOpenChange:Ra,children:e.jsxs(he,{className:"sm:max-w-[480px]",children:[e.jsx(ue,{children:e.jsx(xe,{className:"text-right",children:"اختيار مصدر خصم الدين"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600 text-right",children:"اختر هل تريد خصم مبلغ الدين من الرصيد النقدي في الدرج أم من إحدى المحافظ أو تسجيله بدون خصم."}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsx(d,{variant:$t==="cash"?"default":"outline",className:$t==="cash"?"bg-blue-600 hover:bg-blue-700 text-white":"",onClick:()=>pa("cash"),children:"الفلوس النقدية"}),e.jsx(d,{variant:$t==="wallet"?"default":"outline",className:$t==="wallet"?"bg-purple-600 hover:bg-purple-700 text-white":"",onClick:()=>pa("wallet"),children:"أرصدة المحافظ"}),e.jsx(d,{variant:$t==="none"?"default":"outline",className:$t==="none"?"bg-gray-600 hover:bg-gray-700 text-white":"",onClick:()=>pa("none"),children:"بدون خصم"})]}),$t==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{className:"text-right block",children:"اختر المحفظة للخصم"}),e.jsxs(Bs,{value:Ua,onValueChange:$r,children:[e.jsx(Ms,{className:"w-full",children:e.jsx(Ls,{placeholder:"اختر محفظة"})}),e.jsx($s,{children:ye.map(s=>e.jsx(os,{value:s.id,children:s.phone||s.name||s.id},s.id))})]})]})]}),e.jsxs(Pe,{className:"flex justify-between",children:[e.jsx(d,{variant:"outline",onClick:()=>{Ra(!1),Lr(null),pa(null),$r("")},children:"إلغاء"}),e.jsx(d,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{if(!Mr)return;const s=Number(Mr.amount);if(!$t){l({title:"اختر مصدر الخصم",description:"يرجى اختيار النقدية أو المحفظة",variant:"destructive"});return}try{if($t==="cash"){const r=Number((Xe-s).toFixed(2));ht(r),localStorage.setItem(dt(),r.toString());const i=new Date().toISOString(),c={cashBalance:r,lastUpdated:i},p=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(p,JSON.stringify(c)),t!=null&&t.uid?await Ce.updateUserData(t.uid,c).then(()=>{localStorage.removeItem(p),ve(!1)}).catch(()=>{ve(!0)}):ve(!0)}else if($t==="wallet"){if(!Ua){l({title:"اختر محفظة",description:"يرجى اختيار محفظة للخصم",variant:"destructive"});return}const r=je[Ua]||0,i=Number((r-s).toFixed(2)),c={...je,[Ua]:i};Ze(c);const p=new Date().toISOString(),f={walletBalances:c,lastUpdated:p},N=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(N,JSON.stringify(f)),localStorage.setItem(ct(),JSON.stringify(c)),localStorage.setItem(`walletBalances_backup_${p}`,JSON.stringify(c)),t!=null&&t.uid&&await Ce.updateUserData(t.uid,f)}}catch(r){console.error("خطأ أثناء تحديث الأرصدة عند حفظ الدين:",r)}const a=[...Ot,Mr];Qt(a),await fs(a),Un(""),_n(""),zn(""),$a(!1),Ra(!1),Lr(null),pa(null),$r(""),l($t==="none"?{title:"تم حفظ الدين بدون خصم",description:"لم يتم الخصم من الدرج أو المحافظ"}:{title:"تم حفظ الدين وخصم المبلغ",description:$t==="cash"?`تم خصم ${s} من الرصيد النقدي`:`تم خصم ${s} من رصيد المحفظة`})},children:"تأكيد الخصم وحفظ الدين"})]})]})}),e.jsx(me,{open:to,onOpenChange:ua,children:e.jsxs(he,{className:"sm:max-w-[425px] z-[60]",children:[e.jsx(ue,{children:e.jsx(xe,{className:"text-right",children:"إيصال الدين"})}),fe&&e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"text-center border-b pb-4",children:[e.jsx("h2",{className:"text-xl font-bold",children:"إيصال دين"}),e.jsx("p",{className:"text-sm text-gray-500",children:on.format(fe.createdAt instanceof Date?fe.createdAt:new Date(fe.createdAt))})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"اسم المديون:"}),e.jsx("span",{children:fe.debtorName})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"المبلغ:"}),e.jsxs("span",{className:"font-bold text-lg",children:[fe.amount," جنيه"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"سبب الدين:"}),e.jsx("span",{children:fe.reason})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"الحالة:"}),e.jsx(jt,{variant:fe.status==="paid"?"default":"secondary",className:fe.status==="paid"?"bg-green-500":"bg-yellow-500",children:fe.status==="paid"?"مدفوع":"مؤجل"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"المبلغ المتبقي:"}),e.jsxs("span",{className:"font-bold text-lg",children:[Math.max(0,Number(fe.amount||0)-Number(fe.paidAmount||0))," جنيه"]})]}),fe.paidAmount?e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"إجمالي المدفوع:"}),e.jsxs("span",{className:"text-green-700",children:[fe.paidAmount," جنيه"]})]}):null,e.jsxs("div",{className:"mt-3 p-3 border rounded-lg bg-gray-50",children:[so?e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"partialAmount",className:"text-right block",children:"المبلغ المراد دفعه"}),e.jsx(L,{id:"partialAmount",type:"number",value:Jn,onChange:s=>Ar(s.target.value),className:"text-right",placeholder:"أدخل المبلغ"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(d,{variant:"outline",onClick:()=>{Pr(!1),Ar("")},children:"إلغاء"}),e.jsx(d,{className:"bg-blue-600 hover:bg-blue-700",onClick:async()=>{const s=parseFloat(Jn);if(!fe||isNaN(s)||s<=0){l({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const a=Math.max(0,Number(fe.amount||0)-Number(fe.paidAmount||0));if(s>a){l({title:"مبلغ زائد",description:"المبلغ المدفوع أكبر من المتبقي",variant:"destructive"});return}const r=Number(((fe.paidAmount||0)+s).toFixed(2)),i=r>=Number(fe.amount||0),c={...fe,amount:Number(fe.amount||0),paidAmount:r,status:i?"paid":"pending",partialPayments:[...fe.partialPayments||[],{amount:s,paidAt:new Date}]},p=Ot.map(f=>f.id===fe.id?c:f);Qt(p),kr(c),await fs(p);try{c.status==="paid"&&(t!=null&&t.uid)&&(async()=>{const f=Rs(bs(xt,"userTransactions"),Bt("userId","==",t.uid),Bt("linkedDebtId","==",fe.id),Bt("status","==","pending")),N=await Us(f);await Promise.allSettled(N.docs.map(D=>ra(D.ref,{status:"completed",confirmedAt:new Date})))})().catch(f=>console.error("تعذر تحديث حالة المعاملات المرتبطة بالدين:",f))}catch(f){console.error("تعذر تجهيز تحديث حالة المعاملات المرتبطة:",f)}try{const f=ga(),N=localStorage.getItem(f);if(N){const S=(JSON.parse(N)||[]).map(j=>(j==null?void 0:j.linkedDebtId)===fe.id&&(j==null?void 0:j.status)==="pending"?{...j,status:"completed",confirmedAt:new Date}:j);localStorage.setItem(f,JSON.stringify(S)),Ss(j=>j.map(W=>(W==null?void 0:W.linkedDebtId)===fe.id&&(W==null?void 0:W.status)==="pending"?{...W,status:"completed",confirmedAt:new Date}:W))}}catch(f){console.warn("فشل تحديث حالة المعاملات المرتبطة محلياً بعد سداد الدين:",f)}_a(s),Ws("cash"),Qs(!0),Pr(!1),Ar(""),l({title:"تم تسجيل دفع جزء",description:`تم دفع ${s} جنيه بتاريخ ${new Date().toLocaleString("ar-EG")}`})},children:"دفع"})]})]}):e.jsx(d,{variant:"outline",className:"w-full",onClick:()=>Pr(!0),children:"دفع جزء"}),fe.partialPayments&&fe.partialPayments.length>0&&e.jsxs("div",{className:"mt-3 text-xs text-gray-600",children:[e.jsx("p",{className:"font-medium mb-1",children:"سجل الدفعات الجزئية:"}),e.jsx("div",{className:"space-y-1 max-h-24 overflow-y-auto",children:fe.partialPayments.map((s,a)=>e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{children:["دفع: ",s.amount," جنيه"]}),e.jsx("span",{children:new Date(s.paidAt).toLocaleString("ar-EG")})]},a))})]})]})]})]}),e.jsxs(Pe,{className:"flex gap-2 justify-center",children:[e.jsx(d,{onClick:async()=>{if(fe){const s=Ot.map(a=>a.id===fe.id?{...a,status:"pending"}:a);Qt(s),await fs(s),ua(!1),l({title:"تم تحديث حالة الدين",description:"تم تعيين الدين كمؤجل"})}},variant:"outline",className:"bg-yellow-500 hover:bg-yellow-600 text-white",children:"مؤجل"}),e.jsx(d,{onClick:async()=>{if(fe){const a=Math.max(0,Number(fe.amount||0)-Number(fe.paidAmount||0)),r=Ot.map(i=>i.id===fe.id?{...i,amount:Number(i.amount||0),paidAmount:Number(((i.paidAmount||0)+a).toFixed(2)),status:"paid",partialPayments:[...i.partialPayments||[],...a>0?[{amount:a,paidAt:new Date}]:[]]}:i);Qt(r),a>0&&(_a(a),Ws("cash"),Qs(!0)),await fs(r);try{t!=null&&t.uid&&(fe!=null&&fe.id)&&(async()=>{const i=Rs(bs(xt,"userTransactions"),Bt("userId","==",t.uid),Bt("linkedDebtId","==",fe.id),Bt("status","==","pending")),c=await Us(i);await Promise.allSettled(c.docs.map(p=>ra(p.ref,{status:"completed",confirmedAt:new Date})))})().catch(i=>console.error("تعذر تحديث حالة المعاملات المرتبطة بالدين:",i))}catch(i){console.error("تعذر تجهيز تحديث حالة المعاملات المرتبطة:",i)}try{const i=ga(),c=localStorage.getItem(i);if(c){const f=(JSON.parse(c)||[]).map(N=>(N==null?void 0:N.linkedDebtId)===fe.id&&(N==null?void 0:N.status)==="pending"?{...N,status:"completed",confirmedAt:new Date}:N);localStorage.setItem(i,JSON.stringify(f)),Ss(N=>N.map(D=>(D==null?void 0:D.linkedDebtId)===fe.id&&(D==null?void 0:D.status)==="pending"?{...D,status:"completed",confirmedAt:new Date}:D))}}catch(i){console.warn("فشل تحديث حالة المعاملات المرتبطة محلياً بعد سداد الدين:",i)}ua(!1),l({title:"تم تحديث حالة الدين",description:"تم تعيين الدين كمدفوع"})}},className:"bg-green-500 hover:bg-green-600",children:"مدفوع"}),e.jsx(d,{onClick:async()=>{if(fe){const s=Ot.filter(a=>a.id!==fe.id);Qt(s),await fs(s),ua(!1),l({title:"تم حذف الدين",description:"تم حذف الدين بنجاح"})}},variant:"destructive",children:"حذف"})]})]})}),e.jsx(me,{open:lo,onOpenChange:Qs,children:e.jsxs(he,{className:"sm:max-w-[425px]",children:[e.jsxs(ue,{children:[e.jsx(xe,{className:"text-right",children:"اختيار إضافة مبلغ السداد"}),e.jsx(Zt,{className:"text-right",children:"هل تريد إضافة مبلغ السداد إلى الفلوس النقدية أم إلى إحدى المحافظ؟"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(d,{variant:ls==="cash"?"default":"outline",className:ls==="cash"?"bg-blue-600 text-white":"",onClick:()=>Ws("cash"),children:"الفلوس النقدية"}),e.jsx(d,{variant:ls==="wallet"?"default":"outline",className:ls==="wallet"?"bg-blue-600 text-white":"",onClick:()=>Ws("wallet"),children:"أرصدة المحافظ"}),e.jsx(d,{variant:ls==="none"?"default":"outline",className:ls==="none"?"bg-gray-600 text-white":"",onClick:()=>Ws("none"),children:"بدون إضافة"})]}),ls==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-right",children:"اختر المحفظة"}),e.jsxs("select",{className:"w-full border rounded p-2 text-right",value:Fs,onChange:s=>Rr(s.target.value),children:[e.jsx("option",{value:"",children:"— اختر محفظة —"}),ye&&ye.length>0?ye.map(s=>e.jsx("option",{value:s.id,children:s.phone||s.name||s.id},s.id)):Object.keys(je||{}).map(s=>{var a,r,i,c,p,f;return e.jsx("option",{value:s,children:((a=ye.find(N=>N.id===s))==null?void 0:a.phone)||((i=(r=JSON.parse(localStorage.getItem(Xs())||"[]"))==null?void 0:r.find(N=>N.id===s))==null?void 0:i.phone)||((p=(c=JSON.parse(localStorage.getItem(Xs())||"[]"))==null?void 0:c.find(N=>N.id===s))==null?void 0:p.name)||((f=ye.find(N=>N.id===s))==null?void 0:f.name)||s},s)})]})]}),e.jsxs("div",{className:"text-right text-sm text-gray-600",children:["المبلغ المراد إضافته: ",e.jsxs("span",{className:"font-bold",children:[Gn," جنيه"]})]})]}),e.jsxs(Pe,{className:"flex justify-end",children:[e.jsx(d,{variant:"outline",onClick:()=>{Qs(!1),_a(0),Ws(null),Rr("")},children:"إلغاء"}),e.jsx(d,{onClick:async()=>{var s,a;try{const r=Gn;if(!r||r<=0){Qs(!1);return}if(ls==="cash"){const i=Xe+r;ht(i),localStorage.setItem(dt(),i.toString());const c={cashBalance:i,lastUpdated:new Date().toISOString()},p=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(p,JSON.stringify(c)),t!=null&&t.uid?(Ce.updateUserData(t.uid,c).catch(()=>ve(!0)),localStorage.removeItem(p),ve(!1)):ve(!0),l({title:"تمت إضافة مبلغ السداد",description:`تمت إضافة ${r} جنيه إلى الفلوس النقدية`})}else if(ls==="wallet"){if(!Fs){l({title:"اختر محفظة أولاً",description:"يرجى اختيار المحفظة لإضافة مبلغ السداد إليها",variant:"destructive"});return}const i={...je,[Fs]:(je[Fs]||0)+r};Ze(i);const c=(Xe||0)-r;ht(c),localStorage.setItem(dt(),c.toString());const p=new Date().toISOString(),f={walletBalances:i,cashBalance:c,lastUpdated:p},N=`userData_${t==null?void 0:t.uid}`;if(localStorage.setItem(N,JSON.stringify(f)),localStorage.setItem(ct(),JSON.stringify(i)),localStorage.setItem(`walletBalances_backup_${p}`,JSON.stringify(i)),t!=null&&t.uid){Ce.updateUserData(t.uid,f).catch(()=>ve(!0));try{localStorage.removeItem(N)}catch{}ve(!1)}else ve(!0);l({title:"تمت إضافة مبلغ السداد",description:`تمت إضافة ${r} جنيه إلى المحفظة ${((s=ye.find(D=>D.id===Fs))==null?void 0:s.phone)||((a=ye.find(D=>D.id===Fs))==null?void 0:a.name)||Fs} وتم خصم نفس المبلغ من درج النقدية`})}else if(ls==="none"){const i=(Xe||0)-r;ht(i),localStorage.setItem(dt(),i.toString());const c={cashBalance:i,lastUpdated:new Date().toISOString()},p=`userData_${t==null?void 0:t.uid}`;if(localStorage.setItem(p,JSON.stringify(c)),t!=null&&t.uid){Ce.updateUserData(t.uid,c).catch(()=>ve(!0));try{localStorage.removeItem(p)}catch{}ve(!1)}else ve(!0);l({title:"تم تسجيل السداد",description:`تم خصم ${r} جنيه من درج النقدية بدون إضافة للمحافظ`})}else{l({title:"اختر مصدر الإضافة",description:"يرجى اختيار إضافة المبلغ إلى النقدية أو المحفظة",variant:"destructive"});return}}catch(r){console.error("خطأ أثناء إضافة مبلغ السداد:",r),l({title:"حدث خطأ",description:"تعذر إضافة مبلغ السداد، حاول مرة أخرى",variant:"destructive"})}finally{Qs(!1),_a(0),Ws(null),Rr("")}},className:"bg-green-600 hover:bg-green-700",children:"تأكيد الإضافة"})]})]})}),e.jsx(me,{open:_i,onOpenChange:Fa,children:e.jsxs(he,{hideClose:!0,className:"sm:max-w-[420px] w-[90vw] rounded-2xl bg-gradient-to-br from-white via-indigo-50 to-blue-50 shadow-2xl border border-indigo-100",children:[e.jsxs(ue,{children:[e.jsx(xe,{className:"text-right text-2xl font-bold",children:(bt==null?void 0:bt.type)==="transfer"?"مبلغ يجب استلامه":"مبلغ يجب تسليمه"}),e.jsx(Zt,{className:"text-right text-gray-600",children:(bt==null?void 0:bt.type)==="transfer"?"هذا هو المبلغ الواجب استلامه من العميل بعد التأكيد.":"هذا هو المبلغ الواجب تسليمه للعميل بعد التأكيد."})]}),e.jsxs("div",{className:"py-4 flex flex-col items-center gap-2",children:[e.jsxs("div",{className:"text-4xl font-extrabold text-blue-700 tracking-wider",children:[bt==null?void 0:bt.amount," جنيه"]}),e.jsx("div",{className:"text-sm text-gray-500 text-right w-full",children:(bt==null?void 0:bt.type)==="transfer"?"المبلغ المعروض شامل عمولة التحويل.":ie?"العمولة مضافة ولا تؤثر على قيمة التسليم.":"العمولة مخصومة من المبلغ المسلّم للعميل."})]}),e.jsxs(Pe,{className:"flex justify-end gap-2",children:[(bt==null?void 0:bt.type)==="transfer"&&e.jsx(d,{variant:"outline",id:"sendCodeBtn",onClick:async()=>{if(!da||!da.receiver||!da.amount){l({title:"بيانات غير مكتملة",description:"تأكد من إدخال رقم المستقبل والمبلغ قبل الإرسال",variant:"destructive"});return}const s=String(da.receiver),a=Math.round(Number(da.amount));Ln(!0);try{await ee(s,a)}catch(r){const i=r&&r.message?r.message:"حدث خطأ غير متوقع أثناء الإرسال";l({title:"خطأ أثناء الإرسال",description:i,variant:"destructive"})}finally{Ln(!1)}},disabled:Mn,children:Mn?"جارٍ الإرسال...":"إرسال كود التحويل"}),e.jsx(d,{onClick:()=>{Fa(!1),wr(null)},className:"bg-green-600 hover:bg-green-700 text-white",children:(bt==null?void 0:bt.type)==="transfer"?"تم الاستلام":"تم التسليم"})]})]})})]}))};export{Im as default};
