import{r as i,z as oe,j as e,P as M,D as ie,at as R,v as F,u as T,d as de,G as le,H as ce,aD as ue,a as me,Q as fe,Y as we,U as he}from"./index-B5n92zOC.js";import{L as pe,D as xe,a as ve,b as ge,c as je,d as U,e as S}from"./dropdown-menu-BUlvubWb.js";import{B as j}from"./button-FeyfJZ27.js";import{D as Pe,a as Ne,b as ye,c as Se,d as be,e as Ce}from"./dialog-DWoQrafE.js";import{I as A}from"./input-BuCYb69R.js";import{L}from"./label-BQI93MKC.js";import{M as Ee}from"./MasterPinDialog-QpwG2jOl.js";import{E as I,a as D}from"./eye-B6Ir0EyV.js";import{g as Ae}from"./avatars-0dbCB7hN.js";import{K as Le}from"./key-round-BNZ_nsUw.js";import{S as Ie}from"./shield-GIlM90pW.js";var z={exports:{}},B={};/**
 * @license React
 * use-sync-external-store-shim.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var P=i;function De(r,a){return r===a&&(r!==0||1/r===1/a)||r!==r&&a!==a}var ke=typeof Object.is=="function"?Object.is:De,Re=P.useState,Me=P.useEffect,Fe=P.useLayoutEffect,_e=P.useDebugValue;function Oe(r,a){var s=a(),o=Re({inst:{value:s,getSnapshot:a}}),t=o[0].inst,n=o[1];return Fe(function(){t.value=s,t.getSnapshot=a,k(t)&&n({inst:t})},[r,s,a]),Me(function(){return k(t)&&n({inst:t}),r(function(){k(t)&&n({inst:t})})},[r]),_e(s),s}function k(r){var a=r.getSnapshot;r=r.value;try{var s=a();return!ke(r,s)}catch{return!0}}function Ue(r,a){return a()}var $e=typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"?Ue:Oe;B.useSyncExternalStore=P.useSyncExternalStore!==void 0?P.useSyncExternalStore:$e;z.exports=B;var Te=z.exports;function ze(){return Te.useSyncExternalStore(Be,()=>!0,()=>!1)}function Be(){return()=>{}}var _="Avatar",[He,ts]=oe(_),[qe,H]=He(_),q=i.forwardRef((r,a)=>{const{__scopeAvatar:s,...o}=r,[t,n]=i.useState("idle");return e.jsx(qe,{scope:s,imageLoadingStatus:t,onImageLoadingStatusChange:n,children:e.jsx(M.span,{...o,ref:a})})});q.displayName=_;var G="AvatarImage",K=i.forwardRef((r,a)=>{const{__scopeAvatar:s,src:o,onLoadingStatusChange:t=()=>{},...n}=r,m=H(G,s),l=Ge(o,n),c=ie(w=>{t(w),m.onImageLoadingStatusChange(w)});return R(()=>{l!=="idle"&&c(l)},[l,c]),l==="loaded"?e.jsx(M.img,{...n,ref:a,src:o}):null});K.displayName=G;var V="AvatarFallback",W=i.forwardRef((r,a)=>{const{__scopeAvatar:s,delayMs:o,...t}=r,n=H(V,s),[m,l]=i.useState(o===void 0);return i.useEffect(()=>{if(o!==void 0){const c=window.setTimeout(()=>l(!0),o);return()=>window.clearTimeout(c)}},[o]),m&&n.imageLoadingStatus!=="loaded"?e.jsx(M.span,{...t,ref:a}):null});W.displayName=V;function $(r,a){return r?a?(r.src!==a&&(r.src=a),r.complete&&r.naturalWidth>0?"loaded":"loading"):"error":"idle"}function Ge(r,{referrerPolicy:a,crossOrigin:s}){const o=ze(),t=i.useRef(null),n=o?(t.current||(t.current=new window.Image),t.current):null,[m,l]=i.useState(()=>$(n,r));return R(()=>{l($(n,r))},[n,r]),R(()=>{const c=x=>()=>{l(x)};if(!n)return;const w=c("loaded"),p=c("error");return n.addEventListener("load",w),n.addEventListener("error",p),a&&(n.referrerPolicy=a),typeof s=="string"&&(n.crossOrigin=s),()=>{n.removeEventListener("load",w),n.removeEventListener("error",p)}},[n,s,a]),m}var Q=q,Y=K,J=W;const X=i.forwardRef(({className:r,...a},s)=>e.jsx(Q,{ref:s,className:F("relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",r),...a}));X.displayName=Q.displayName;const Z=i.forwardRef(({className:r,...a},s)=>e.jsx(Y,{ref:s,className:F("aspect-square h-full w-full",r),...a}));Z.displayName=Y.displayName;const ee=i.forwardRef(({className:r,...a},s)=>e.jsx(J,{ref:s,className:F("flex h-full w-full items-center justify-center rounded-full bg-muted",r),...a}));ee.displayName=J.displayName;function Ke({open:r,onOpenChange:a}){const{user:s}=T(),{toast:o}=de(),[t,n]=i.useState(!1),[m,l]=i.useState(!1),[c,w]=i.useState(!1),[p,x]=i.useState(!1),[se,N]=i.useState(!1),[ae,y]=i.useState(!1),[f,b]=i.useState({currentPassword:"",newPassword:"",confirmPassword:""}),[h,v]=i.useState({currentPassword:"",newPassword:"",confirmPassword:""}),re=()=>{const d={currentPassword:"",newPassword:"",confirmPassword:""};return f.currentPassword||(d.currentPassword="كلمة المرور الحالية مطلوبة"),f.newPassword?f.newPassword.length<6&&(d.newPassword="كلمة المرور يجب أن تكون 6 أحرف على الأقل"):d.newPassword="كلمة المرور الجديدة مطلوبة",f.confirmPassword?f.newPassword!==f.confirmPassword&&(d.confirmPassword="كلمات المرور غير متطابقة"):d.confirmPassword="تأكيد كلمة المرور مطلوب",v(d),!Object.values(d).some(u=>u!=="")},te=async d=>{if(d.preventDefault(),!(!re()||!s||!s.email)){n(!0);try{const u=le.credential(s.email,f.currentPassword);await ce(s,u),y(!0),N(!0),o({title:"تأكيد الهوية",description:"أدخل الرقم السري الرئيسي لتأكيد تغيير كلمة المرور"})}catch(u){console.error("خطأ في تغيير كلمة المرور:",u);let g="حدث خطأ أثناء تغيير كلمة المرور";if(u.code==="auth/wrong-password"){v(E=>({...E,currentPassword:"كلمة المرور الحالية غير صحيحة"}));return}else if(u.code==="auth/weak-password"){v(E=>({...E,newPassword:"كلمة المرور ضعيفة جداً"}));return}else u.code==="auth/requires-recent-login"&&(g="يجب تسجيل الدخول مرة أخرى لتغيير كلمة المرور");o({title:"خطأ في تغيير كلمة المرور",description:g,variant:"destructive"})}finally{n(!1)}}},ne=async()=>{if(s){n(!0);try{await ue(s,f.newPassword),o({title:"تم تغيير كلمة المرور بنجاح",description:"تم تحديث كلمة المرور الخاصة بك بنجاح"}),b({currentPassword:"",newPassword:"",confirmPassword:""}),v({currentPassword:"",newPassword:"",confirmPassword:""}),N(!1),y(!1),a(!1)}catch(d){console.error("خطأ في تحديث كلمة المرور:",d);let u="حدث خطأ أثناء تغيير كلمة المرور";d.code==="auth/requires-recent-login"&&(u="انتهت جلسة المصادقة. يرجى إعادة إدخال كلمة المرور الحالية"),o({title:"خطأ في تغيير كلمة المرور",description:u,variant:"destructive"})}finally{n(!1)}}},C=d=>u=>{b(g=>({...g,[d]:u.target.value})),h[d]&&v(g=>({...g,[d]:""}))},O=()=>{b({currentPassword:"",newPassword:"",confirmPassword:""}),v({currentPassword:"",newPassword:"",confirmPassword:""}),N(!1),y(!1),a(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(Pe,{open:r,onOpenChange:O,children:e.jsxs(Ne,{className:"sm:max-w-[425px]",children:[e.jsxs(ye,{children:[e.jsx(Se,{children:"تغيير كلمة المرور"}),e.jsx(be,{children:"أدخل كلمة المرور الحالية وكلمة المرور الجديدة لتحديث حسابك"})]}),e.jsxs("form",{onSubmit:te,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(L,{htmlFor:"currentPassword",children:"كلمة المرور الحالية"}),e.jsxs("div",{className:"relative",children:[e.jsx(A,{id:"currentPassword",type:m?"text":"password",value:f.currentPassword,onChange:C("currentPassword"),className:h.currentPassword?"border-red-500":"",autoComplete:"off",disabled:t}),e.jsx(j,{type:"button",variant:"ghost",size:"sm",className:"absolute right-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>l(!m),disabled:t,children:m?e.jsx(I,{className:"h-4 w-4"}):e.jsx(D,{className:"h-4 w-4"})})]}),h.currentPassword&&e.jsx("p",{className:"text-sm text-red-500",children:h.currentPassword})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(L,{htmlFor:"newPassword",children:"كلمة المرور الجديدة"}),e.jsxs("div",{className:"relative",children:[e.jsx(A,{id:"newPassword",type:c?"text":"password",value:f.newPassword,onChange:C("newPassword"),className:h.newPassword?"border-red-500":"",autoComplete:"new-password",disabled:t}),e.jsx(j,{type:"button",variant:"ghost",size:"sm",className:"absolute right-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>w(!c),disabled:t,children:c?e.jsx(I,{className:"h-4 w-4"}):e.jsx(D,{className:"h-4 w-4"})})]}),h.newPassword&&e.jsx("p",{className:"text-sm text-red-500",children:h.newPassword})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(L,{htmlFor:"confirmPassword",children:"تأكيد كلمة المرور الجديدة"}),e.jsxs("div",{className:"relative",children:[e.jsx(A,{id:"confirmPassword",type:p?"text":"password",value:f.confirmPassword,onChange:C("confirmPassword"),className:h.confirmPassword?"border-red-500":"",autoComplete:"new-password",disabled:t}),e.jsx(j,{type:"button",variant:"ghost",size:"sm",className:"absolute right-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>x(!p),disabled:t,children:p?e.jsx(I,{className:"h-4 w-4"}):e.jsx(D,{className:"h-4 w-4"})})]}),h.confirmPassword&&e.jsx("p",{className:"text-sm text-red-500",children:h.confirmPassword})]}),e.jsxs(Ce,{children:[e.jsx(j,{type:"button",variant:"outline",onClick:O,disabled:t,children:"إلغاء"}),e.jsxs(j,{type:"submit",disabled:t,children:[t&&e.jsx(pe,{className:"mr-2 h-4 w-4 animate-spin"}),"تغيير كلمة المرور"]})]})]})]})}),e.jsx(Ee,{open:se&&ae,onOpenChange:d=>{N(d),d||y(!1)},mode:"verify",title:"التحقق من الرقم السري الرئيسي",description:"لا يمكن تغيير كلمة المرور إلا بعد التحقق من الرقم السري الرئيسي",onSuccess:ne,onCancel:()=>{N(!1),y(!1)}})]})}function ns({className:r}){const{user:a,profile:s,signOut:o}=T(),t=me(),[n,m]=i.useState(!1),{isShiftActive:l}=fe();if(!a)return null;const c=()=>s!=null&&s.fullName?s==null?void 0:s.fullName.split(" ").map(x=>x.charAt(0)).join("").toUpperCase().slice(0,2):a.email?a.email.charAt(0).toUpperCase():"U",w=s!=null&&s.avatarId?Ae(s.avatarId):null;i.useEffect(()=>{console.log("Profile updated in ProfileIcon:",s==null?void 0:s.avatarId)},[s==null?void 0:s.avatarId]);const p=async()=>{try{await o()}catch(x){console.error("خطأ في تسجيل الخروج:",x)}};return e.jsxs(e.Fragment,{children:[e.jsxs(xe,{children:[e.jsx(ve,{asChild:!0,children:e.jsx(j,{variant:"ghost",disabled:l,title:l?"غير متاح أثناء وجود وردية كاشير نشطة":void 0,className:`relative h-8 w-8 rounded-full p-0 hover:bg-transparent focus:ring-1 focus:ring-primary focus:ring-offset-1 transition-all duration-200 disabled:opacity-60 disabled:cursor-not-allowed ${r}`,children:e.jsx(X,{className:"h-8 w-8 border border-border shadow-sm hover:shadow-md transition-all duration-200 hover:scale-105",children:w?e.jsx("div",{className:"w-full h-full flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-blue-900/20 dark:to-indigo-900/20 rounded-full overflow-hidden",children:e.jsx("div",{className:"w-full h-full flex items-center justify-center scale-[2.5]",children:w.component})}):e.jsxs(e.Fragment,{children:[e.jsx(Z,{src:a.photoURL||void 0,alt:(s==null?void 0:s.fullName)||a.email||"المستخدم",className:"object-cover"}),e.jsx(ee,{className:"bg-gradient-to-br from-primary to-primary/80 text-primary-foreground font-semibold text-lg border-0",children:c()})]})})})}),e.jsxs(ge,{className:"w-64",align:"end",forceMount:!0,children:[e.jsx(je,{className:"font-normal",children:e.jsxs("div",{className:"flex flex-col space-y-1",children:[e.jsx("p",{className:"text-sm font-medium leading-none",children:(s==null?void 0:s.fullName)||"المستخدم"}),e.jsx("p",{className:"text-xs leading-none text-muted-foreground",children:a.email}),(s==null?void 0:s.role)&&e.jsxs("p",{className:"text-xs leading-none text-muted-foreground",children:["الدور: ",s.role==="staff"?"موظف":s.role==="merchant"?"تاجر":"مستخدم"]})]})}),e.jsx(U,{}),e.jsxs(S,{onClick:()=>m(!0),className:"cursor-pointer",children:[e.jsx(Le,{className:"mr-2 h-4 w-4"}),e.jsx("span",{children:"تغيير كلمة المرور"})]}),e.jsxs(S,{onClick:()=>t("/profile-settings"),className:"cursor-pointer",children:[e.jsx(we,{className:"mr-2 h-4 w-4"}),e.jsx("span",{children:"إعدادات البروفيل"})]}),((s==null?void 0:s.role)==="admin"||(s==null?void 0:s.role)==="staff")&&e.jsxs(S,{onClick:()=>t("/admin"),className:"cursor-pointer",children:[e.jsx(Ie,{className:"mr-2 h-4 w-4"}),e.jsx("span",{children:"لوحة الإدارة"})]}),e.jsx(U,{}),e.jsxs(S,{onClick:p,className:"cursor-pointer text-red-600 focus:text-red-600",children:[e.jsx(he,{className:"mr-2 h-4 w-4"}),e.jsx("span",{children:"تسجيل الخروج"})]})]})]}),e.jsx(Ke,{open:n,onOpenChange:m})]})}export{ns as P};
