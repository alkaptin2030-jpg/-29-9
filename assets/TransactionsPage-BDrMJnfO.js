const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./dailyOperationCountService-BXyL2urC.js","./index-BVcORkm_.js","./index-CmANKWis.css","./walletDailyLimitsService-CDZx_5WI.js","./profitService-C1zUBRqP.js"])))=>i.map(i=>d[i]);
import{J as os,r as u,a6 as is,j as t,a1 as ls,a3 as Te,a4 as Ie,as as cs,Y as Ge,u as bt,B as T,p as mt,C as ze,aM as v,z as we,ar as ds,a as ms,R as _e,aN as us,ab as ps,v as se,f as L,w as Le,q as G,e as X,an as B,aO as hs,ay as U,aP as ve,_ as xs,aa as Me,K as ae,I as We,aq as ut,aQ as fs,aR as gs,d as Fe,g as ye,aS as pt,a9 as J,O as Be}from"./index-BVcORkm_.js";import{C as bs,a as vs,b as ys,d as js}from"./card-DZvQb2Fl.js";import{D as Ue,a as $e,b as Ve,c as qe,e as Ns}from"./dialog-DCAvj8nd.js";import{u as ws,S as Ts,a as Cs,b as Ds,c as As,d as je}from"./select-S3swZa8Z.js";import{B as Ne}from"./badge-D5ZAaey-.js";import{c as vt,R as Ss,I as Rs}from"./index-CS-9fVJN.js";import{u as Ps}from"./Combination-DBULCMgD.js";import{A as ht,a as xt,C as ks,b as Os,f as M,M as Es,c as Is,R as _s}from"./MaintenanceDialog-DrstdSkz.js";import{M as yt,P as Ls}from"./MasterPinDialog-BUBg7aNX.js";import{r as ft,P as re}from"./profitService-C1zUBRqP.js";import{D as Ms}from"./dollar-sign-DEbrlUOx.js";import{C as jt}from"./calendar-WokOEVtk.js";import{A as Ws}from"./arrow-left-DxRCvl9Z.js";import{S as Fs}from"./separator-CcwqKuf0.js";import{T as gt}from"./progress-DsU2O6QF.js";import{C as Bs}from"./circle-x-Ca0XOoOt.js";import{C as zs}from"./circle-check-big-DtKb2gx1.js";import"./index-DY_oAuHZ.js";import"./whatsappService-B2f8FTPH.js";import"./download-CfCD4goG.js";import"./label-qrv_4OSF.js";import"./circle-alert-BDF3hCtM.js";import"./shield-BT8vhQfD.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Us=os("BatteryCharging",[["path",{d:"M15 7h1a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2h-2",key:"1sdynx"}],["path",{d:"M6 7H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h1",key:"1gkd3k"}],["path",{d:"m11 7-3 5h4l-3 5",key:"b4a64w"}],["line",{x1:"22",x2:"22",y1:"11",y2:"13",key:"4dh1rd"}]]);var Ce="Tabs",[$s]=ls(Ce,[vt]),Nt=vt(),[Vs,Xe]=$s(Ce),wt=u.forwardRef((p,s)=>{const{__scopeTabs:h,value:x,onValueChange:A,defaultValue:S,orientation:C="horizontal",dir:W,activationMode:y="automatic",...k}=p,D=ws(W),[j,F]=is({prop:x,onChange:A,defaultProp:S??"",caller:Ce});return t.jsx(Vs,{scope:h,baseId:Ps(),value:j,onValueChange:F,orientation:C,dir:D,activationMode:y,children:t.jsx(Te.div,{dir:D,"data-orientation":C,...k,ref:s})})});wt.displayName=Ce;var Tt="TabsList",Ct=u.forwardRef((p,s)=>{const{__scopeTabs:h,loop:x=!0,...A}=p,S=Xe(Tt,h),C=Nt(h);return t.jsx(Ss,{asChild:!0,...C,orientation:S.orientation,dir:S.dir,loop:x,children:t.jsx(Te.div,{role:"tablist","aria-orientation":S.orientation,...A,ref:s})})});Ct.displayName=Tt;var Dt="TabsTrigger",At=u.forwardRef((p,s)=>{const{__scopeTabs:h,value:x,disabled:A=!1,...S}=p,C=Xe(Dt,h),W=Nt(h),y=Pt(C.baseId,x),k=kt(C.baseId,x),D=x===C.value;return t.jsx(Rs,{asChild:!0,...W,focusable:!A,active:D,children:t.jsx(Te.button,{type:"button",role:"tab","aria-selected":D,"aria-controls":k,"data-state":D?"active":"inactive","data-disabled":A?"":void 0,disabled:A,id:y,...S,ref:s,onMouseDown:Ie(p.onMouseDown,j=>{!A&&j.button===0&&j.ctrlKey===!1?C.onValueChange(x):j.preventDefault()}),onKeyDown:Ie(p.onKeyDown,j=>{[" ","Enter"].includes(j.key)&&C.onValueChange(x)}),onFocus:Ie(p.onFocus,()=>{const j=C.activationMode!=="manual";!D&&!A&&j&&C.onValueChange(x)})})})});At.displayName=Dt;var St="TabsContent",Rt=u.forwardRef((p,s)=>{const{__scopeTabs:h,value:x,forceMount:A,children:S,...C}=p,W=Xe(St,h),y=Pt(W.baseId,x),k=kt(W.baseId,x),D=x===W.value,j=u.useRef(D);return u.useEffect(()=>{const F=requestAnimationFrame(()=>j.current=!1);return()=>cancelAnimationFrame(F)},[]),t.jsx(cs,{present:A||D,children:({present:F})=>t.jsx(Te.div,{"data-state":D?"active":"inactive","data-orientation":W.orientation,role:"tabpanel","aria-labelledby":y,hidden:!F,id:k,tabIndex:0,...C,ref:s,style:{...p.style,animationDuration:j.current?"0s":void 0},children:F&&S})})});Rt.displayName=St;function Pt(p,s){return`${p}-trigger-${s}`}function kt(p,s){return`${p}-content-${s}`}var qs=wt,Ot=Ct,Et=At,It=Rt;const Gs=qs,_t=u.forwardRef(({className:p,...s},h)=>t.jsx(Ot,{ref:h,className:Ge("inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",p),...s}));_t.displayName=Ot.displayName;const ne=u.forwardRef(({className:p,...s},h)=>t.jsx(Et,{ref:h,className:Ge("inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm",p),...s}));ne.displayName=Et.displayName;const oe=u.forwardRef(({className:p,...s},h)=>t.jsx(It,{ref:h,className:Ge("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",p),...s}));oe.displayName=It.displayName;const Xs=({userId:p,transactions:s=[]})=>{const[h,x]=u.useState(!1),[A,S]=u.useState(!1),[C,W]=u.useState(!1),[y,k]=u.useState({dailyWithdraw:0,dailyTransfer:0,monthlyWithdraw:0,monthlyTransfer:0,lastUpdated:new Date}),{userSubscription:D}=bt();u.useEffect(()=>{p&&h&&C&&Q()},[p,h,C]);const j=N=>`${N.toFixed(2)} ج.م`,F=async()=>{try{const N=(D==null?void 0:D.subscription)||null,P=(N==null?void 0:N.planType)??(N==null?void 0:N.plan)??null,I=typeof P=="string"?P.toLowerCase():null;if(P===we.ZERO||I==="zero"||I==="0"||P===0)return!0}catch{}try{if(p){const N=await ds(p),P=(N==null?void 0:N.planType)??(N==null?void 0:N.plan)??null,I=typeof P=="string"?P.toLowerCase():null;if(P===we.ZERO||I==="zero"||I==="0"||P===0)return!0}}catch{}return!1},Y=async()=>{try{if(await F()){v({title:"الخطة زيرو",description:"عرض إجمالي الأرباح غير متاح في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}catch{}S(!0)},_=async()=>{try{if(await F()){v({title:"الخطة زيرو",description:"عرض إجمالي الأرباح غير متاح في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"}),S(!1);return}}catch{}W(!0),x(!0),S(!1)},Q=async()=>{if(p)try{if(Array.isArray(s)&&s.length>0){const P=new Date,I=P.getMonth(),ie=P.getFullYear(),$=ft.filterVisibleTransactions(s,"daily",p),De=ft.filterVisibleTransactions(s,"monthly",p);let z=0,le=0,Ae=0,ce=0;$.forEach(O=>{const Z=new Date(O.createdAt),H=String(O.status||"confirmed").toLowerCase();if(Z.toDateString()!==P.toDateString()||H!=="completed"&&H!=="confirmed")return;const V=(O.type||O.txnType||"").toLowerCase(),E={type:V==="withdrawal"?"withdraw":V,amount:Number(O.amount||0),commission:O.commission};E.type==="withdraw"?z+=re.calculateProfitFromTransaction(E):(E.type==="send"||E.type==="receive"||E.type==="transfer")&&(le+=re.calculateProfitFromTransaction(E))}),De.forEach(O=>{const Z=new Date(O.createdAt),H=String(O.status||"confirmed").toLowerCase();if(Z.getMonth()!==I||Z.getFullYear()!==ie||H!=="completed"&&H!=="confirmed")return;const V=(O.type||O.txnType||"").toLowerCase(),E={type:V==="withdrawal"?"withdraw":V,amount:Number(O.amount||0),commission:O.commission};E.type==="withdraw"?Ae+=re.calculateProfitFromTransaction(E):(E.type==="send"||E.type==="receive"||E.type==="transfer")&&(ce+=re.calculateProfitFromTransaction(E))}),k({dailyWithdraw:Math.round(z*100)/100,dailyTransfer:Math.round(le*100)/100,monthlyWithdraw:Math.round(Ae*100)/100,monthlyTransfer:Math.round(ce*100)/100,lastUpdated:new Date});return}const N=re.getWithdrawTransferProfits(p);k({dailyWithdraw:N.dailyWithdrawProfit||0,dailyTransfer:N.dailyTransferProfit||0,monthlyWithdraw:N.monthlyWithdrawProfit||0,monthlyTransfer:N.monthlyTransferProfit||0,lastUpdated:new Date})}catch(N){console.error("Error loading total profits:",N)}};return t.jsxs(t.Fragment,{children:[t.jsx(T,{size:"sm",variant:"ghost",onClick:Y,className:"h-2 w-2 p-0 bg-gradient-to-r from-blue-100 to-purple-200 text-purple-700 hover:from-blue-200 hover:to-purple-300 hover:text-purple-800 rounded transition-all duration-300 hover:scale-110 shadow-sm hover:shadow-md",title:"عرض إجمالي الأرباح",children:t.jsx(mt,{className:"h-1.5 w-1.5"})}),t.jsx(Ue,{open:h,onOpenChange:x,children:t.jsxs($e,{className:"max-w-[240px] mx-auto bg-white border border-gray-200 shadow-md rounded sm:max-w-[220px] sm:bg-gradient-to-br sm:from-purple-50 sm:to-white sm:border-2 sm:border-purple-200 sm:shadow-2xl sm:rounded-2xl",children:[t.jsx(Ve,{className:"text-center pb-0 border-b-0 sm:pb-2 sm:border-b sm:border-purple-200",children:t.jsxs(qe,{className:"text-xs font-bold text-purple-800 flex items-center justify-center gap-1 mb-0 leading-tight tracking-tight sm:text-xs sm:gap-1 sm:mb-0 sm:leading-normal sm:tracking-normal",children:[t.jsx(Ms,{className:"h-2 w-2 text-purple-600 sm:h-3 sm:w-3"}),"إجمالي الأرباح (فوري)"]})}),t.jsxs("div",{className:"space-y-1 py-1 sm:space-y-2 sm:py-2",children:[t.jsxs("div",{className:"bg-blue-50 p-1 rounded border border-blue-200 sm:bg-gradient-to-r sm:from-blue-50 sm:to-blue-100 sm:p-2 sm:rounded-xl sm:shadow-sm",children:[t.jsxs("div",{className:"flex items-center justify-between mb-1",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(ze,{className:"h-2 w-2 text-blue-600"}),t.jsx("span",{className:"text-[10px] font-semibold text-blue-800",children:"يومي"})]}),t.jsx("span",{className:"text-[10px] font-bold text-blue-900",children:j((y.dailyWithdraw??0)+(y.dailyTransfer??0))})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-1",children:[t.jsxs("div",{className:"flex items-center justify-between bg-red-50 p-0.5 rounded border border-red-200",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(ht,{className:"h-2 w-2 text-red-600"}),t.jsx("span",{className:"text-[10px] text-red-800",children:"سحب"})]}),t.jsx("span",{className:"text-[10px] font-bold text-red-700",children:j(y.dailyWithdraw)})]}),t.jsxs("div",{className:"flex items-center justify-between bg-green-50 p-0.5 rounded border border-green-200",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(xt,{className:"h-2 w-2 text-green-600"}),t.jsx("span",{className:"text-[10px] text-green-800",children:"تحويل"})]}),t.jsx("span",{className:"text-[10px] font-bold text-green-700",children:j(y.dailyTransfer)})]})]})]}),t.jsxs("div",{className:"bg-purple-50 p-1 rounded border border-purple-200 sm:bg-gradient-to-r sm:from-purple-50 sm:to-purple-100 sm:p-2 sm:rounded-xl sm:shadow-sm",children:[t.jsxs("div",{className:"flex items-center justify-between mb-1",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(jt,{className:"h-2 w-2 text-purple-600"}),t.jsx("span",{className:"text-[10px] font-semibold text-purple-800",children:"شهري"})]}),t.jsx("span",{className:"text-[10px] font-bold text-purple-900",children:j((y.monthlyWithdraw??0)+(y.monthlyTransfer??0))})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-1",children:[t.jsxs("div",{className:"flex items-center justify-between bg-red-50 p-0.5 rounded border border-red-200",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(ht,{className:"h-2 w-2 text-red-600"}),t.jsx("span",{className:"text-[10px] text-red-800",children:"سحب"})]}),t.jsx("span",{className:"text-[10px] font-bold text-red-700",children:j(y.monthlyWithdraw)})]}),t.jsxs("div",{className:"flex items-center justify-between bg-blue-50 p-0.5 rounded border border-blue-200",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(xt,{className:"h-2 w-2 text-blue-600"}),t.jsx("span",{className:"text-[10px] text-blue-800",children:"تحويل"})]}),t.jsx("span",{className:"text-[10px] font-bold text-blue-700",children:j(y.monthlyTransfer)})]})]})]})]}),!C&&t.jsx("div",{className:"absolute inset-0 bg-yellow-200/70 backdrop-blur-sm flex items-center justify-center rounded sm:rounded-2xl border border-yellow-300 pointer-events-auto",children:t.jsx(T,{size:"sm",variant:"ghost",onClick:()=>S(!0),className:"p-2 bg-yellow-300/80 text-yellow-900 hover:bg-yellow-400/90 rounded-full shadow-sm hover:shadow-md transition-all duration-300",title:"إدخال الرقم السري الرئيسي",children:t.jsx(mt,{className:"h-4 w-4"})})}),t.jsx("div",{className:"flex justify-center pt-1 border-t-0 sm:pt-2 sm:border-t sm:border-purple-200",children:t.jsx(T,{onClick:()=>x(!1),className:"bg-purple-600 hover:bg-purple-700 text-white px-4 py-1 rounded-xl text-xs sm:bg-gradient-to-r sm:from-purple-600 sm:to-purple-700 sm:hover:from-purple-700 sm:hover:to-purple-800 sm:px-4 sm:py-1 sm:rounded-xl sm:shadow-lg sm:hover:shadow-xl sm:transition-all sm:duration-300",children:"إغلاق"})})]})}),t.jsx(yt,{open:A,onOpenChange:S,onSuccess:_,description:"لا يمكن الاطلاع على إجمالي الأرباح إلا بإدخال الرقم السري الرئيسي"})]})},Js=p=>t.jsx(Xs,{...p}),ba=()=>{var it,lt,ct,dt;const p=ms(),{user:s,profile:h,userSubscription:x}=bt(),A=_e.useMemo(()=>{var n,a,o,r;const e=((n=x==null?void 0:x.subscription)==null?void 0:n.planType)??((a=x==null?void 0:x.subscription)==null?void 0:a.plan)??((o=h==null?void 0:h.subscription)==null?void 0:o.planType)??((r=h==null?void 0:h.subscription)==null?void 0:r.plan)??null;return e===we.ZERO||String(e).toLowerCase()==="zero"},[(it=x==null?void 0:x.subscription)==null?void 0:it.planType,(lt=x==null?void 0:x.subscription)==null?void 0:lt.plan,(ct=h==null?void 0:h.subscription)==null?void 0:ct.planType,(dt=h==null?void 0:h.subscription)==null?void 0:dt.plan]),{shopName:S}=us(),{isShiftActive:C,shiftUser:W}=ps(),[y,k]=u.useState([]),[D,j]=u.useState([]),[F,Y]=u.useState(!1),[_,Q]=u.useState(null),[N,P]=u.useState("all"),[I,ie]=u.useState(""),[$,De]=u.useState(""),[z,le]=u.useState(""),[Ae,ce]=u.useState(!1),[O,Z]=u.useState(!1),[H,V]=u.useState(!1),[E,Lt]=u.useState(!1),[Mt,Se]=u.useState(!1),[Wt,Je]=u.useState(!1),[Ft,Ye]=u.useState(!1),[Bt,Re]=u.useState(!1),[zt,Ut]=u.useState(null),[$t,de]=u.useState(!1),[K,me]=u.useState({keepLastCount:20,intervalDays:7,lastResetAt:null});u.useEffect(()=>{(async()=>{if(s!=null&&s.uid)try{const n=await U.getUserData(s.uid),a=(n==null?void 0:n.recentReset)||{},o=Number(a==null?void 0:a.keepLastCount)>0?Number(a.keepLastCount):20,r=Number(a==null?void 0:a.intervalDays)>0?Number(a.intervalDays):7,c=l=>l instanceof Date?l:typeof(l==null?void 0:l.toDate)=="function"?l.toDate():l?new Date(String(l)):null,i=a!=null&&a.lastResetAt?c(a.lastResetAt):null,m=new Date;!i||m.getTime()-i.getTime()>=r*24*60*60*1e3?(await U.updateUserData(s.uid,{recentReset:{keepLastCount:o,intervalDays:r,lastResetAt:m}}),me({keepLastCount:o,intervalDays:r,lastResetAt:m})):me({keepLastCount:o,intervalDays:r,lastResetAt:i})}catch{me({keepLastCount:20,intervalDays:7,lastResetAt:null})}})()},[s==null?void 0:s.uid]);const[Vt,ue]=u.useState(!1),[pe,Ze]=u.useState(""),[ee,He]=u.useState(""),[he,Ke]=u.useState(""),[Qe,et]=u.useState(!1),[tt,xe]=u.useState(0);u.useEffect(()=>{if(!(s!=null&&s.uid)){xe(0);return}const e=se(L,"users",s.uid),n=Le(e,a=>{try{const o=a.exists()?a.data():{},c=(Array.isArray(o==null?void 0:o.debts)?o.debts:[]).filter(i=>(i==null?void 0:i.status)==="pending"&&(Number(i==null?void 0:i.amount)||0)>0).length;xe(c)}catch{xe(0)}},a=>{console.warn("فشل الاشتراك في ديون المستخدم من Firestore:",a),xe(0)});return()=>n()},[s==null?void 0:s.uid]),u.useEffect(()=>{qt(),Gt()},[s]),u.useEffect(()=>{(async()=>{try{if(!(s!=null&&s.uid))return;const n=new Date;if(n.getDate()!==1)return;const a=`${n.getFullYear()}-${n.getMonth()+1}`,o=`lastMonthlyDbCleanup:${s.uid}`;if(localStorage.getItem(o)===a)return;const c=new Date(n.getFullYear(),n.getMonth(),1,0,0,0,0),i=l=>l instanceof Date?l:typeof(l==null?void 0:l.toDate)=="function"?l.toDate():new Date(String(l));let m=[];try{const l=G(X(L,"userTransactions"),B("userId","==",s.uid),B("createdAt","<",c));m=(await ye(l)).docs}catch{const l=G(X(L,"userTransactions"),B("userId","==",s.uid));m=(await ye(l)).docs.filter(g=>{var b;return i((b=g.data())==null?void 0:b.createdAt)<c})}await Promise.allSettled(m.map(l=>pt(l.ref)));let d=[];try{const l=G(X(L,"transactions"),B("userId","==",s.uid),B("createdAt","<",c));d=(await ye(l)).docs}catch{const l=G(X(L,"transactions"),B("userId","==",s.uid));d=(await ye(l)).docs.filter(g=>{var b;return i((b=g.data())==null?void 0:b.createdAt)<c})}await Promise.allSettled(d.map(l=>pt(l.ref)));try{localStorage.setItem(o,a)}catch{}console.log("✅ تنظيف شهري (TransactionsPage):",{userTransactionsDeleted:m.length,globalTransactionsDeleted:d.length,monthStart:c})}catch(n){console.error("فشل التنظيف الشهري التلقائي (TransactionsPage):",n)}})()},[s==null?void 0:s.uid]),u.useEffect(()=>{if(!(s!=null&&s.uid))return;let e=null,n=!1;const a=r=>{const c=r.map(i=>{const m=i.data(),d=m==null?void 0:m.createdAt,l=d!=null&&d.toDate?d.toDate():d instanceof Date?d:new Date(d);return{id:i.id,...m,createdAt:l}}).filter(i=>(i==null?void 0:i.status)!=="cancelled"&&!(i!=null&&i.isDeleted)).filter(i=>!((i==null?void 0:i.type)==="report"||((i==null?void 0:i.title)||"").includes("إيصال تسليم وردية"))).sort((i,m)=>{const d=i.createdAt?new Date(i.createdAt).getTime():0;return(m.createdAt?new Date(m.createdAt).getTime():0)-d});k(c.map(ke))},o=()=>{const r=G(X(L,"userTransactions"),B("userId","==",s.uid));e=Le(r,c=>{try{a(c.docs)}catch(i){console.error("خطأ في معالجة بيانات الاشتراك الاحتياطي:",i)}},c=>{console.error("خطأ في الاشتراك الاحتياطي لمعاملات المستخدم:",c)})};(async()=>{try{const r=G(X(L,"userTransactions"),B("userId","==",s.uid)),c=await hs(r);if(c&&c.docs&&c.docs.length>0)try{a(c.docs)}catch{}}catch{}})();try{const r=G(X(L,"userTransactions"),B("userId","==",s.uid));e=Le(r,{includeMetadataChanges:!0},c=>{try{a(c.docs)}catch(i){console.error("خطأ في معالجة بيانات الاشتراك:",i)}},c=>{if(console.error("خطأ في الاشتراك لمعاملات المستخدم:",c),!n){n=!0;try{e&&e()}catch{}o()}})}catch(r){console.error("فشل إعداد الاشتراك الفوري لمعاملات المستخدم، بدء السقوط الاحتياطي:",r),o()}return()=>{try{e&&e()}catch{}}},[s==null?void 0:s.uid]);const qt=async()=>{try{if(!s)return;const n=(await U.getUserTransactions(s.uid)).map(a=>({...a,createdAt:a.createdAt instanceof Date?a.createdAt:new Date(a.createdAt)})).filter(a=>!((a==null?void 0:a.type)==="report"||((a==null?void 0:a.title)||"").includes("إيصال تسليم وردية")));k(n.map(ke))}catch(e){console.error("خطأ في تحميل معاملات المستخدم من Firestore:",e),v({title:"فشل جلب معاملات المستخدم",description:"قد تكون المشكلة صلاحيات Firestore أو اتصال الشبكة. سيتم عرض المتاح محليًا إن وُجد. جرّب تسجيل الدخول مجددًا أو افتح صفحة اختبار المصادقة.",variant:"destructive"})}},Gt=async()=>{try{if(!s)return;const n=(await ve.getDeletedTransactionsByUser(s.uid)).map(a=>({...a,createdAt:a.createdAt instanceof Date?a.createdAt:new Date(a.createdAt)}));j(n.map(ke))}catch(e){console.error("خطأ في تحميل المعاملات المحذوفة من Firestore:",e),v({title:"فشل جلب المعاملات المحذوفة",description:"تحقق من الصلاحيات والاتصال. يمكن مراجعة صفحة اختبار المصادقة للتشخيص.",variant:"destructive"})}},te=_e.useMemo(()=>{const e=K.keepLastCount??20;return[...y].sort((a,o)=>o.createdAt.getTime()-a.createdAt.getTime()).slice(0,e)},[y,K.keepLastCount]),Xt=_e.useMemo(()=>Math.max(0,((y==null?void 0:y.length)||0)-(K.keepLastCount||20)),[y==null?void 0:y.length,K.keepLastCount]),st=te.filter(e=>{const n=!I||e.senderPhone.includes(I)||e.receiverPhone.includes(I),a=!$||e.createdAt.toDateString()===new Date($).toDateString(),o=!z||e.createdAt.toTimeString().startsWith(z);return n&&a&&o}),fe=(e,n)=>{switch(e){case"completed":return t.jsx(zs,{className:`h-4 w-4 ${n==="withdraw"?"text-red-500":"text-green-500"}`});case"pending":return t.jsx(ze,{className:"h-4 w-4 text-yellow-500"});case"cancelled":return t.jsx(Bs,{className:"h-4 w-4 text-red-500"});default:return t.jsx(ze,{className:"h-4 w-4 text-gray-500"})}},Pe=e=>{switch(e){case"completed":return"مكتمل";case"pending":return"قيد المراجعة";case"cancelled":return"ملغي";default:return"غير معروف"}},ke=e=>{const n=((e==null?void 0:e.status)??"").toString().toLowerCase(),a=n==="confirmed"||n==="success"||n==="completed"?"completed":n==="failed"||n==="error"||n==="cancelled"||n==="canceled"?"cancelled":"pending",r=((e==null?void 0:e.type)??(e==null?void 0:e.txnType)??"").toString().toLowerCase()==="withdraw"?"withdraw":"send",c=(e==null?void 0:e.senderPhone)??(e==null?void 0:e.senderMsisdn)??(e==null?void 0:e.sender_msisdn)??(e==null?void 0:e.sender)??(e==null?void 0:e.from)??"",i=(e==null?void 0:e.receiverPhone)??(e==null?void 0:e.receiverMsisdn)??(e==null?void 0:e.receiver_msisdn)??(e==null?void 0:e.receiver)??(e==null?void 0:e.to)??"",m=e==null?void 0:e.createdAt,d=m instanceof Date?m:m!=null&&m.toDate?m.toDate():new Date(m);return{id:e==null?void 0:e.id,senderPhone:c||"غير معروف",receiverPhone:i||"غير معروف",amount:Number((e==null?void 0:e.amount)??0),status:a,type:r,createdAt:d,commission:(e==null?void 0:e.commission)??void 0,withdrawnAmount:(e==null?void 0:e.withdrawnAmount)??void 0,sentAmount:(e==null?void 0:e.sentAmount)??void 0,fromWallet:(e==null?void 0:e.fromWallet)??(e==null?void 0:e.walletId)??void 0,cashierName:(e==null?void 0:e.cashierName)??(e==null?void 0:e.createdByName)??(e==null?void 0:e.cashier)??void 0,commissionMode:(e==null?void 0:e.commissionMode)??(e==null?void 0:e.commission_mode)??void 0,totalCharged:(e==null?void 0:e.totalCharged)??void 0,walletEffectAppliedOnCreation:(e==null?void 0:e.walletEffectAppliedOnCreation)??(e==null?void 0:e.effectsAppliedOnCreation)??(e==null?void 0:e.effectAppliedOnCreation)??!1,fee:(e==null?void 0:e.fee)??void 0}},Jt=e=>({id:e.id,type:e.type==="send"?"transfer":"withdraw",sender_msisdn:e.senderPhone,receiver_msisdn:e.receiverPhone,amount:e.amount,commission:e.commission||0,status:e.status==="cancelled"?"failed":e.status,createdAt:e.createdAt.toISOString(),updatedAt:e.createdAt.toISOString(),shopName:S??(h==null?void 0:h.shopName)??(s==null?void 0:s.displayName)??"المحل",cashierName:(e==null?void 0:e.cashierName)??null,commissionMode:(e==null?void 0:e.commissionMode)??void 0,totalCharged:(e==null?void 0:e.totalCharged)??void 0,fee:(e==null?void 0:e.fee)??void 0,note:(e==null?void 0:e.note)??(e==null?void 0:e.notes)??void 0}),Oe=e=>{const n=Jt(e);Ut(n),Re(!0)},Yt=e=>{Q(e),Y(!0)},Zt=async()=>{_&&(await Ht(_.id),Y(!1),Q(null))},Ht=async e=>{try{const n=D.find(r=>r.id===e);if(!n||!s)return;const a=await U.saveUserTransaction(s.uid,{...n,userId:s.uid,status:"completed",cashierName:n.cashierName??"الحساب الرئيسي"});await ve.permanentlyDeleteTransaction(e,s.uid);const o={...n,id:a};k(r=>[...r,o]),j(r=>r.filter(c=>c.id!==e)),v({title:"تم الاسترجاع",description:"تم استرجاع الإيصال إلى حسابك."})}catch(n){console.error("خطأ في استرجاع المعاملة من Firestore:",n),v({title:"فشل الاسترجاع",description:"تحقق من الاتصال ثم أعد المحاولة.",variant:"destructive"})}},Kt=async e=>{try{if(!s)return;j(n=>n.filter(a=>a.id!==e)),await ve.permanentlyDeleteTransaction(e,s.uid),await U.removeUserTransaction(s.uid,e),v({title:"تم الحذف نهائيًا",description:"الإيصال لن يعود بعد التحديث."})}catch(n){console.error("فشل الحذف النهائي للمعاملة:",n),v({title:"خطأ في الحذف النهائي",description:"تحقق من الاتصال ثم أعد المحاولة.",variant:"destructive"})}},at=async e=>{var n,a,o;try{const r=y.find(f=>f.id===e);if(!r||!s)return;try{if(((n=x==null?void 0:x.subscription)==null?void 0:n.planType)===we.ZERO){const{dailyOperationCountService:g}=await J(async()=>{const{dailyOperationCountService:R}=await import("./dailyOperationCountService-BXyL2urC.js");return{dailyOperationCountService:R}},__vite__mapDeps([0,1,2]),import.meta.url),b=r.type==="send"?"transfer":"withdraw";if(!(await g.checkAndIncrement(s.uid,b,5)).allowed){v({title:"تم بلوغ حد باقة الزيرو",description:"مسموح بحد أقصى 5 تأكيدات يوميًا للتحويل/السحب. جرّب غدًا أو قم بالترقية.",variant:"destructive"});return}}}catch(f){console.warn("تعذر التحقق من حد التأكيد اليومي:",f)}const c=await Me.getById(s.uid);if(!(c!=null&&c.shopId))throw new Error("لا يمكن تحديد معرف المتجر (shopId) للمستخدم");const i=se(L,"dashboardData",c.shopId),m=await ae(i);let d=m.exists()?Number(((a=m.data())==null?void 0:a.cashBalance)||0):0,l=m.exists()?((o=m.data())==null?void 0:o.walletBalances)||{}:{};if(r.type==="withdraw"){const f=r.fromWallet||Object.keys(l)[0],g=Number(r.withdrawnAmount??r.amount??0),b=Number(r.commission??0);if(!!!(r!=null&&r.walletEffectAppliedOnCreation)&&f&&g>0){const R=l[f]||0;l[f]=R+g}d=d-g+b,await Be(i,{cashBalance:d,walletBalances:l})}await Be(se(L,"userTransactions",e),{status:"completed",confirmedAt:new Date}),k(f=>f.map(g=>g.id===e?{...g,status:"completed"}:g)),v({title:"تم الإكمال",description:"تم وسم المعاملة كمكتملة."}),Re(!1)}catch(r){console.error("خطأ في إكمال المعاملة:",r),v({title:"فشل الإكمال",description:"تحقق من الاتصال ثم أعد المحاولة.",variant:"destructive"})}},rt=async e=>{var n,a;try{const o=y.find(r=>r.id===e);if(!o||!s)return;k(r=>r.filter(c=>c.id!==e)),j(r=>[{...o},...r]);try{await U.removeUserTransaction(s.uid,e),await ve.saveDeletedTransaction({...o,userId:s.uid,originalTransactionId:e,reference:o==null?void 0:o.reference})}catch(r){console.warn("تعذر الحذف النهائي من قواعد البيانات في هذه الخطوة، سيتم الحذف من لائحة المحذوفات عند التنفيذ اليدوي للحذف النهائي:",r)}try{const r=await Me.getById(s.uid);if(!(r!=null&&r.shopId))throw new Error("لا يمكن تحديد معرف المتجر (shopId) للمستخدم");const c=se(L,"dashboardData",r.shopId),i=await ae(c);let m=i.exists()?Number(((n=i.data())==null?void 0:n.cashBalance)||0):0,d=i.exists()?((a=i.data())==null?void 0:a.walletBalances)||{}:{};const l=Number(o.withdrawnAmount??o.amount??0),f=Number(o.commission??0),g=o.fromWallet||Object.keys(d)[0],b=!!(o!=null&&o.walletEffectAppliedOnCreation);if(o.type==="send"){const w=Number(o.fee??0),R=f+w;if(m-=R,g&&l>0){const q=d[g]||0;d[g]=q+l}}else if(o.type==="withdraw"){if(o.status==="completed"){if(m=m+l-f,g&&l>0){const w=d[g]||0;d[g]=w-l}}else if(g&&b&&l>0){const w=d[g]||0;d[g]=w-l}}await Be(c,{cashBalance:m,walletBalances:d})}catch(r){console.warn("فشل عكس تأثير الأرصدة محليًا:",r)}try{const r=o.fromWallet;if(r){const{walletDailyLimitsService:c}=await J(async()=>{const{walletDailyLimitsService:m}=await import("./walletDailyLimitsService-CDZx_5WI.js");return{walletDailyLimitsService:m}},__vite__mapDeps([3,1,2]),import.meta.url),i=await c.getWalletLimits(r);if(i){const m=o.type==="send",d={updatedAt:(await J(async()=>{const{serverTimestamp:w}=await import("./index-BVcORkm_.js").then(R=>R.bg);return{serverTimestamp:w}},__vite__mapDeps([1,2]),import.meta.url)).serverTimestamp()};m?(d.dailyTransferUsed=Math.max(0,(i.dailyTransferUsed||0)-o.amount),d.monthlyTransferUsed=Math.max(0,(i.monthlyTransferUsed||0)-o.amount)):(d.dailyWithdrawUsed=Math.max(0,(i.dailyWithdrawUsed||0)-o.amount),d.monthlyWithdrawUsed=Math.max(0,(i.monthlyWithdrawUsed||0)-o.amount));const{doc:l,setDoc:f}=await J(async()=>{const{doc:w,setDoc:R}=await import("./index-BVcORkm_.js").then(q=>q.bg);return{doc:w,setDoc:R}},__vite__mapDeps([1,2]),import.meta.url),{db:g}=await J(async()=>{const{db:w}=await import("./index-BVcORkm_.js").then(R=>R.bh);return{db:w}},__vite__mapDeps([1,2]),import.meta.url),b=l(g,"walletLimits",r);await f(b,d,{merge:!0})}}}catch(r){console.warn("فشل استرجاع حدود المحفظة:",r)}try{const{ProfitService:r}=await J(async()=>{const{ProfitService:l}=await import("./profitService-C1zUBRqP.js").then(f=>f.p);return{ProfitService:l}},__vite__mapDeps([4,1,2]),import.meta.url),{ReportsService:c}=await J(async()=>{const{ReportsService:l}=await import("./profitService-C1zUBRqP.js").then(f=>f.a);return{ReportsService:l}},__vite__mapDeps([4,1,2]),import.meta.url),m={txnType:o.type==="send"?"send":"receive",amount:o.amount,commission:o.commission||0,createdAt:o.createdAt,status:"confirmed"},d=r.calculateProfitFromTransaction(m);d>0&&r.addProfit(-d,s.uid);try{c.removeTransactionEffects(o,s.uid)}catch{}}catch(r){console.warn("فشل تحديث التقارير/الأرباح بعد الحذف:",r)}}catch(o){console.error("خطأ أثناء حذف الإيصال:",o)}},nt=u.useRef(!1),ot=xs();u.useEffect(()=>{!(new URLSearchParams(ot.search).get("autoTestBalances")==="1")||nt.current||(nt.current=!0,(async()=>{var a,o,r,c,i,m;try{if(!s)return;const d=await Me.getById(s.uid);if(!(d!=null&&d.shopId)){console.warn("autoTest: لا يوجد shopId للمستخدم، سيتم إيقاف الاختبار.");return}const l=se(L,"dashboardData",d.shopId),f=await ae(l),g=f.exists()?Number(((a=f.data())==null?void 0:a.cashBalance)||0):0,b=f.exists()?((o=f.data())==null?void 0:o.walletBalances)||{}:{},w=Object.keys(b)[0]||void 0,R=100,q=5,Ee=await U.saveUserTransaction(s.uid,{senderPhone:"auto-test-sender",receiverPhone:"auto-test-receiver",amount:R,status:"pending",type:"withdraw",createdAt:new Date,reference:`AUTO-${Date.now()}`,commission:q,withdrawnAmount:R,fromWallet:w,cashierName:"AutoTest",commissionMode:"add",totalCharged:R+q,walletEffectAppliedOnCreation:!1});console.log("autoTest: تم إنشاء إيصال سحب تجريبي:",Ee),await at(Ee);const ge=await ae(l),es=ge.exists()?Number(((r=ge.data())==null?void 0:r.cashBalance)||0):0,ts=ge.exists()?((c=ge.data())==null?void 0:c.walletBalances)||{}:{},ss=g-R+q,as=w?Number(b[w]||0)+R:void 0;console.log("autoTest: توقع الدرج بعد الإكمال:",ss,"فعلي:",es),w&&console.log("autoTest: توقع المحفظة بعد الإكمال:",as,"فعلي:",ts[w]),await rt(Ee);const be=await ae(l),rs=be.exists()?Number(((i=be.data())==null?void 0:i.cashBalance)||0):0,ns=be.exists()?((m=be.data())==null?void 0:m.walletBalances)||{}:{};console.log("autoTest: تحقق نهائي — الدرج قبل/بعد الحذف:",g,rs),w&&console.log("autoTest: تحقق نهائي — المحفظة قبل/بعد الحذف:",b[w]||0,ns[w]||0),v({title:"اختبار الأرصدة (Firestore فقط)",description:"تم إنشاء/إكمال/حذف إيصال تجريبي والتحقق من الأرصدة.",variant:"default"})}catch(d){console.error("autoTest: فشل اختبار الأرصدة:",d),v({title:"فشل اختبار الأرصدة",description:"تحقق من الاتصال ووجود shopId والمحافظ في Firestore.",variant:"destructive"})}})())},[ot.search,s]);const Qt=async()=>{var a,o,r;const e="alkaptin678678@gmail.com",n=(o=(a=Fe.currentUser)==null?void 0:a.email)==null?void 0:o.toLowerCase();if(!n||n!==e){v({title:"قيد الإنشاء",description:"ميزة الشحن متاحة لهذا الحساب فقط حالياً."});return}if(!pe||!ee||!he){v({title:"بيانات ناقصة",description:"يرجى إدخال رقم وشركة والمبلغ",variant:"destructive"});return}et(!0);try{const i={vodafone_eg:"Vodafone",orange_eg:"Orange",etisalat_eg:"Etisalat",we_eg:"WE"}[ee]??ee,m=new AbortController,d=setTimeout(()=>m.abort(),15e3),l=await((r=Fe.currentUser)==null?void 0:r.getIdToken()),f=await fetch("/api/topup",{method:"POST",headers:{"Content-Type":"application/json",...l?{Authorization:`Bearer ${l}`}:{}},body:JSON.stringify({phone:pe,countryCode:"EG",operator:i,amount:Number(he),useLocalAmount:!0}),signal:m.signal});clearTimeout(d);const g=await f.text();let b;try{b=JSON.parse(g)}catch{b={success:!1,message:g||"فشل قراءة استجابة الخادم"}}f.ok&&(b!=null&&b.success)?(v({title:"تم الشحن",description:(b==null?void 0:b.message)||"تم تنفيذ عملية الشحن بنجاح"}),ue(!1),Ze(""),He(""),Ke("")):v({title:"فشل الشحن",description:(b==null?void 0:b.message)||"حدث خطأ أثناء طلب الشحن",variant:"destructive"})}catch(c){console.error("Topup request error:",c),(c==null?void 0:c.name)==="AbortError"?v({title:"انتهت المهلة",description:"الخادم لم يستجب في الوقت المحدد. تأكد أن السيرفر يعمل.",variant:"destructive"}):v({title:"خطأ في الاتصال",description:"تعذر الاتصال بالخادم. حاول لاحقاً.",variant:"destructive"})}finally{et(!1)}};return t.jsxs("div",{className:"fixed inset-0 overscroll-y-none overflow-y-auto bg-background p-4",children:[t.jsxs("div",{className:"max-w-4xl mx-auto",children:[t.jsxs("div",{className:"flex items-center gap-4 mb-6",children:[t.jsxs(T,{variant:"ghost",size:"sm",onClick:()=>p("/user/dashboard"),className:"flex items-center gap-2 text-gray-600 hover:text-gray-800",children:[t.jsx(Ws,{className:"h-4 w-4"}),"العودة"]}),t.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:"المعاملات"})]}),t.jsxs(bs,{className:"card-modern fade-in-up",children:[t.jsxs(vs,{className:"pb-2 px-3 pt-3",children:[t.jsx(ys,{className:"text-sm font-bold",children:"المعاملات الأخيرة"}),t.jsxs("div",{className:"flex items-center gap-0.5 mt-1 relative",children:[t.jsxs("div",{className:"flex items-center gap-0.5 flex-1 bg-gray-50 rounded px-1 py-0.5 border border-gray-200 hover:border-blue-300 transition-all duration-200 group relative overflow-hidden max-w-[140px] md:max-w-[220px]",children:[t.jsx(Fs,{className:"h-2 w-2 text-gray-400 group-hover:text-blue-600 transition-colors"}),t.jsx(We,{placeholder:"بحث...",value:I,onChange:e=>ie(e.target.value),className:"h-3 text-[8px] border-0 bg-transparent focus:ring-0 focus:outline-none text-gray-700 placeholder:text-gray-400"})]}),t.jsxs("div",{className:"hidden md:flex items-center gap-1",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(Js,{userId:s==null?void 0:s.uid,transactions:y}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"أرباح"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(T,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 rounded bg-emerald-50 text-emerald-600 hover:bg-emerald-100 border border-emerald-200 hover:border-emerald-300 transition-all duration-200 hover:scale-105",onClick:()=>{v({title:"قيد الإنشاء",description:"هذه الميزة قيد الإنشاء حالياً."})},title:"نافذة شحن سريعة",children:t.jsx(ut,{className:"h-2.5 w-2.5"})}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"شحن"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(T,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 rounded bg-blue-50 text-blue-600 hover:bg-blue-100 border border-blue-200 hover:border-blue-300 transition-all duration-200 hover:scale-105",onClick:()=>ce(!0),title:"آلة حاسبة",children:t.jsx(ks,{className:"h-2.5 w-2.5"})}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"حاسبة"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(T,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 rounded bg-green-50 text-green-600 hover:bg-green-100 border border-green-200 hover:border-green-300 transition-all duration-200 hover:scale-105",onClick:()=>{if(A){v({title:"الخطة الحالية لا تسمح",description:"بيانات المبيعات غير متاحة في خطة زيرو. قم بالترقية."});return}Z(!0)},title:"بيانات المبيعات",children:t.jsx(Os,{className:"h-2.5 w-2.5"})}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"مبيعات"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsxs(T,{variant:"ghost",size:"sm",className:`h-5 w-5 p-0 rounded border transition-all duration-200 hover:scale-105 ${$||z?"bg-purple-100 text-purple-600 border-purple-300":"bg-purple-50 text-purple-600 hover:bg-purple-100 border-purple-200 hover:border-purple-300"}`,onClick:()=>V(!0),title:"اختيار التاريخ",children:[t.jsx(jt,{className:"h-2.5 w-2.5"}),($||z)&&t.jsx("div",{className:"absolute -top-0.5 -right-0.5 h-1 w-1 bg-purple-500 rounded-full"})]}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"تاريخ"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(T,{variant:"ghost",size:"sm",className:"relative h-5 w-5 p-0 rounded bg-orange-50 text-orange-600 hover:bg-orange-100 border border-orange-200 hover:border-orange-300 transition-all duration-200 hover:scale-105",onClick:()=>{if(A){v({title:"الخطة الحالية لا تسمح",description:"إدارة الديون غير متاحة في خطة زيرو. قم بالترقية."});return}Se(!0)},title:"إدارة الديون",children:t.jsxs("div",{className:"relative inline-flex items-center justify-center h-full w-full",children:[t.jsx(fs,{className:"h-2.5 w-2.5"}),tt>0&&t.jsx("div",{className:"absolute -top-1 -right-1 z-10 min-w-[12px] h-[12px] px-[2px] bg-red-600 text-white rounded-full text-[8px] leading-[12px] flex items-center justify-center pointer-events-none ring-1 ring-white",children:tt})]})}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"ديون"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(T,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 rounded bg-amber-50 text-amber-700 hover:bg-amber-100 border border-amber-200 hover:border-amber-300 transition-all duration-200 hover:scale-105",onClick:()=>{if(A){v({title:"الخطة الحالية لا تسمح",description:"الصيانة غير متاحة في خطة زيرو. قم بالترقية."});return}Ye(!0)},title:"الصيانة",children:t.jsx(gs,{className:"h-2.5 w-2.5"})}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"صيانه"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(T,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 rounded bg-violet-50 text-violet-600 hover:bg-violet-100 border border-violet-200 hover:border-violet-300 transition-all duration-200 hover:scale-105",onClick:()=>{p("/user/dashboard",{state:{openCashierShiftModal:!0}})},title:"يومية المكنة",children:t.jsx(Us,{className:"h-2.5 w-2.5"})}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"المكنة"})]}),t.jsxs("div",{className:"hidden sm:flex items-center gap-1",children:[t.jsx(T,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 rounded bg-indigo-50 text-indigo-600 hover:bg-indigo-100 border border-indigo-200 hover:border-indigo-300 transition-all duration-200 hover:scale-105",onClick:()=>{if(A){v({title:"الخطة الحالية لا تسمح",description:"الفيز الائتمانية غير متاحة في خطة زيرو. قم بالترقية."});return}Je(!0)},title:"الفيز الائتمانية",children:t.jsx(ut,{className:"h-2.5 w-2.5"})}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"فيز"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsxs(T,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 rounded bg-red-50 text-red-600 hover:bg-red-100 border border-red-200 hover:border-red-300 transition-all duration-200 hover:scale-105 relative",onClick:()=>{de(!0)},title:"تصفير المعاملات الأخيرة",children:[t.jsx(gt,{className:"h-2.5 w-2.5"}),Xt>0&&t.jsx("div",{className:"absolute -top-0.5 -right-0.5 h-1 w-1 bg-red-500 rounded-full"})]}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"تصفير"})]}),(I||$||z)&&t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(T,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 rounded bg-red-50 text-red-500 hover:bg-red-100 border border-red-200 hover:border-red-300 transition-all duration-200 hover:scale-105",onClick:()=>{ie(""),De(""),le("")},title:"مسح",children:t.jsx("span",{className:"text-[10px] font-bold",children:"×"})}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"مسح"})]})]})]})]}),t.jsx(js,{className:"px-3 pb-3",children:t.jsxs(Gs,{value:N,onValueChange:P,className:"w-full",children:[t.jsxs(_t,{className:"hidden sm:grid w-full grid-cols-4 h-10 text-sm bg-gradient-to-r from-gray-50 via-blue-50/30 to-purple-50/30 border border-gray-200/60 rounded-md p-1 shadow-sm relative overflow-hidden",children:[t.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-blue-500/5 via-purple-500/5 to-pink-500/5 opacity-0 hover:opacity-100 transition-all duration-200"}),t.jsxs(ne,{value:"all",className:"text-sm relative z-10 rounded transition-all duration-300  data-[state=active]:bg-gradient-to-r data-[state=active]:from-blue-500 data-[state=active]:to-blue-600 data-[state=active]:text-white data-[state=active]:shadow-md data-[state=active]:shadow-blue-200/50 hover:bg-blue-50/80 hover:text-blue-700 group",children:[t.jsx("span",{className:"relative z-10",children:"الكل"}),t.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-blue-500/10 to-purple-500/10 opacity-0 group-hover:opacity-100 transition-all duration-300 rounded"})]}),t.jsxs(ne,{value:"send",className:"text-sm relative z-10 rounded transition-all duration-300  data-[state=active]:bg-gradient-to-r data-[state=active]:from-green-500 data-[state=active]:to-emerald-600 data-[state=active]:text-white data-[state=active]:shadow-md data-[state=active]:shadow-green-200/50 hover:bg-green-50/80 hover:text-green-700 group",children:[t.jsx("span",{className:"relative z-10",children:"مرسل"}),t.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-green-500/10 to-emerald-500/10 opacity-0 group-hover:opacity-100 transition-all duration-300 rounded"})]}),t.jsxs(ne,{value:"withdraw",className:"text-sm relative z-10 rounded transition-all duration-300  data-[state=active]:bg-gradient-to-r data-[state=active]:from-orange-500 data-[state=active]:to-amber-600 data-[state=active]:text-white data-[state=active]:shadow-md data-[state=active]:shadow-orange-200/50 hover:bg-orange-50/80 hover:text-orange-700 group",children:[t.jsx("span",{className:"relative z-10",children:"سحب"}),t.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-orange-500/10 to-amber-500/10 opacity-0 group-hover:opacity-100 transition-all duration-300 rounded"})]}),t.jsxs(ne,{value:"deleted",className:"text-sm relative z-10 rounded transition-all duration-300  data-[state=active]:bg-gradient-to-r data-[state=active]:from-red-500 data-[state=active]:to-rose-600 data-[state=active]:text-white data-[state=active]:shadow-md data-[state=active]:shadow-red-200/50 hover:bg-red-50/80 hover:text-red-700 group",children:[t.jsx("span",{className:"relative z-10",children:"محذوف"}),t.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-red-500/10 to-rose-500/10 opacity-0 group-hover:opacity-100 transition-all duration-300 rounded"})]})]}),t.jsx(oe,{value:"all",className:"mt-2",children:st.length===0?t.jsx("div",{className:"text-center py-4 text-gray-500 fade-in-up tab-stagger-item text-[10px]",children:"لا توجد معاملات محفوظة بعد"}):t.jsx("div",{className:"space-y-1 fade-in-up tab-content-smooth max-h-[600px] overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400",children:st.map((e,n)=>t.jsxs("div",{className:"flex items-center justify-between p-3 bg-white rounded-lg border hover:shadow-md cursor-pointer transition-all duration-200",onClick:()=>Oe(e),children:[t.jsxs("div",{className:"flex items-center gap-1",children:[fe(e.status,e.type),t.jsxs("div",{children:[t.jsx("p",{className:`font-medium text-sm ${e.type==="withdraw"?"text-red-700":"text-green-700"}`,children:e.type==="withdraw"?e.receiverPhone:`${e.senderPhone} → ${e.receiverPhone}`}),e.type==="withdraw"&&t.jsxs(t.Fragment,{children:[t.jsxs("p",{className:"text-sm font-semibold text-red-600",children:[M(e.amount)," جنيه"]}),t.jsxs("p",{className:"text-xs text-red-600",children:["عمولة: ",M(e.commission||0)," جنيه"]})]}),t.jsxs("p",{className:`text-[10px] ${e.type==="withdraw"?"text-red-700":"text-green-700"}`,children:["تمت بواسطة: ",e.cashierName??"الحساب الرئيسي"]}),t.jsx("p",{className:`text-sm ${e.type==="withdraw"?"text-red-500":"text-green-600"}`,children:e.createdAt.toLocaleString("en-GB")})]})]}),t.jsxs("div",{className:"text-right",children:[e.type!=="withdraw"&&t.jsxs("p",{className:"font-bold text-sm text-green-700",children:[M(e.amount)," جنيه"]}),e.withdrawnAmount&&t.jsxs("p",{className:"text-sm text-red-600",children:["مسحوب: ",M(e.withdrawnAmount)," جنيه"]}),e.sentAmount&&t.jsxs("p",{className:"text-sm text-green-600",children:["مرسل: ",M(e.sentAmount)," جنيه"]}),t.jsx(Ne,{variant:e.status==="completed"?"default":"secondary",className:`text-sm ${e.status==="completed"?e.type==="withdraw"?"bg-red-100 text-red-800 border-red-300":e.type==="send"?"bg-green-100 text-green-800 border-green-300":"":e.type==="withdraw"?"bg-red-100 text-red-800":""}`,children:e.type==="withdraw"?"سحب":Pe(e.status)})]})]},e.id))})}),t.jsx(oe,{value:"send",className:"mt-2",children:te.filter(e=>e.type==="send").length===0?t.jsx("div",{className:"text-center py-4 text-gray-500 fade-in-up tab-stagger-item text-[10px]",children:"لا توجد معاملات إرسال محفوظة بعد"}):t.jsx("div",{className:"space-y-1 fade-in-up tab-content-smooth max-h-[600px] overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400",children:te.filter(e=>e.type==="send").map((e,n)=>t.jsxs("div",{className:"flex items-center justify-between p-3 bg-white rounded-lg border hover:shadow-md cursor-pointer transition-all duration-200",onClick:()=>Oe(e),children:[t.jsxs("div",{className:"flex items-center gap-1",children:[fe(e.status,e.type),t.jsxs("div",{children:[t.jsxs("p",{className:"font-medium text-sm text-green-700",children:[e.senderPhone," → ",e.receiverPhone]}),t.jsxs("p",{className:"text-[10px] text-green-700",children:["تمت بواسطة: ",e.cashierName??"الحساب الرئيسي"]}),t.jsx("p",{className:"text-sm text-green-600",children:e.createdAt.toLocaleString("ar-EG")})]})]}),t.jsxs("div",{className:"text-right",children:[t.jsxs("p",{className:"font-bold text-sm text-green-700",children:[M(e.amount)," جنيه"]}),e.sentAmount&&t.jsxs("p",{className:"text-sm text-green-600",children:["مرسل: ",M(e.sentAmount)," جنيه"]}),t.jsx(Ne,{variant:e.status==="completed"?"default":"secondary",className:`text-sm ${e.status==="completed"?"bg-green-100 text-green-800 border-green-300":""}`,children:Pe(e.status)})]})]},e.id))})}),t.jsx(oe,{value:"withdraw",className:"mt-2",children:te.filter(e=>e.type==="withdraw").length===0?t.jsx("div",{className:"text-center py-4 text-gray-500 fade-in-up tab-stagger-item text-[10px]",children:"لا توجد معاملات سحب محفوظة بعد"}):t.jsx("div",{className:"space-y-1 max-h-[600px] overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400",children:te.filter(e=>e.type==="withdraw").map((e,n)=>t.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer",onClick:()=>Oe(e),children:[t.jsxs("div",{className:"flex items-center gap-1",children:[fe(e.status,e.type),t.jsxs("div",{children:[t.jsx("p",{className:"font-medium text-sm text-red-700",children:e.receiverPhone}),t.jsxs("p",{className:"text-[10px] text-red-700",children:["تمت بواسطة: ",e.cashierName??"الحساب الرئيسي"]}),t.jsx("p",{className:"text-sm text-red-500",children:e.createdAt.toLocaleString("ar-EG")})]})]}),t.jsxs("div",{className:"text-right",children:[t.jsxs("p",{className:"font-bold text-sm text-red-700",children:[M(e.amount)," جنيه"]}),e.withdrawnAmount&&t.jsxs("p",{className:"text-sm text-red-600",children:["مسحوب: ",M(e.withdrawnAmount)," جنيه"]}),t.jsx(Ne,{variant:e.status==="completed"?"default":"secondary",className:`text-sm ${e.status==="completed"?"bg-red-100 text-red-800 border-red-300":"bg-red-100 text-red-800"}`,children:Pe(e.status)})]})]},e.id))})}),t.jsx(oe,{value:"deleted",className:"mt-2",children:D.length===0?t.jsx("div",{className:"text-center py-4 text-gray-500 fade-in-up tab-stagger-item text-[10px]",children:"لا توجد معاملات محذوفة"}):t.jsx("div",{className:"space-y-1 max-h-[600px] overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400",children:D.map((e,n)=>t.jsxs("div",{className:"flex items-center justify-between p-3 bg-red-50 rounded-lg border border-red-200",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[fe(e.status,e.type),t.jsxs("div",{children:[t.jsx("p",{className:"font-medium text-sm text-red-700",children:e.type==="withdraw"?e.receiverPhone:`${e.senderPhone} → ${e.receiverPhone}`}),e.type==="withdraw"&&t.jsxs(t.Fragment,{children:[t.jsxs("p",{className:"text-sm font-semibold text-red-600",children:[M(e.amount)," جنيه"]}),t.jsxs("p",{className:"text-xs text-orange-500",children:["عمولة: ",M(e.commission||0)," جنيه"]})]}),t.jsxs("p",{className:"text-[10px] text-red-700",children:["تمت بواسطة: ",e.cashierName??"الحساب الرئيسي"]}),t.jsx("p",{className:"text-sm text-red-500",children:e.createdAt.toLocaleString("ar-EG")})]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("div",{className:"text-right mr-2",children:[e.type!=="withdraw"&&t.jsxs("p",{className:"font-bold text-sm text-red-700",children:[M(e.amount)," جنيه"]}),t.jsx(Ne,{variant:"secondary",className:"text-[10px] bg-red-100 text-red-800",children:"محذوف"})]}),t.jsx(T,{variant:"ghost",size:"sm",className:"text-green-600 hover:bg-green-100 h-10 sm:h-12 px-4 sm:px-5 min-w-[44px] touch-manipulation",onClick:()=>Yt(e),children:t.jsx("span",{className:"text-xs sm:text-sm",children:"استرجاع"})}),t.jsx(T,{variant:"ghost",size:"sm",className:"text-red-600 hover:bg-red-100 h-10 sm:h-12 px-3 sm:px-4 min-w-[44px] touch-manipulation",onClick:()=>Kt(e.id),children:t.jsx(gt,{className:"h-4 w-4 sm:h-5 sm:w-5"})})]})]},e.id))})})]})})]}),t.jsx(Es,{open:Ft,onOpenChange:Ye})]}),t.jsx(Is,{isOpen:Wt,onClose:()=>Je(!1)}),t.jsx(yt,{open:Mt,onOpenChange:Se,mode:"verify",title:"الرقم السري الرئيسي لفتح الديون",description:"أدخل الرقم السري الرئيسي لفتح صفحة الديون",onSuccess:()=>{Se(!1),Lt(!0)}}),t.jsx(Ls,{open:$t,onOpenChange:de,title:"تأكيد كلمة المرور لتصفير المعاملات الأخيرة",description:"سيتم حذف كل المعاملات السابقة نهائيًا من حسابك وFirebase.",onSuccess:async()=>{try{if(!(s!=null&&s.uid)){de(!1);return}const e=new Date,n=a=>a instanceof Date?a:typeof(a==null?void 0:a.toDate)=="function"?a.toDate():new Date(String(a));await U.updateUserData(s.uid,{recentReset:{keepLastCount:K.keepLastCount??20,intervalDays:K.intervalDays??7,lastResetAt:e}}),me(a=>({...a,lastResetAt:e})),v({title:"تم إخفاء المعاملات السابقة",description:"تم إخفاء كل الإيصالات الأقدم من وقت التصفير من العرض بدون التأثير على التقارير اليومية/الشهرية أو الحدود."})}catch(e){console.error("فشل تنفيذ التصفير النهائي:",e),v({title:"فشل التصفير",description:"تحقق من الاتصال ثم أعد المحاولة.",variant:"destructive"})}finally{de(!1)}}}),t.jsx(Ue,{open:Vt,onOpenChange:e=>{var n,a;if(e){const o="alkaptin678678@gmail.com",r=(a=(n=Fe.currentUser)==null?void 0:n.email)==null?void 0:a.toLowerCase();if(!r||r!==o){v({title:"قيد الإنشاء",description:"هذه الميزة قيد الإنشاء حالياً."});return}ue(!0)}else ue(!1)},children:t.jsxs($e,{dir:"rtl",className:"sm:max-w-md",children:[t.jsx(Ve,{children:t.jsx(qe,{children:"شحن رصيد الموبايل"})}),t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-right mb-1",children:"رقم الموبايل"}),t.jsx(We,{value:pe,onChange:e=>Ze(e.target.value),placeholder:"01XXXXXXXXX",dir:"ltr"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-right mb-1",children:"الشركة"}),t.jsxs(Ts,{value:ee,onValueChange:He,children:[t.jsx(Cs,{className:"w-full",children:t.jsx(Ds,{placeholder:"اختر الشركة"})}),t.jsxs(As,{children:[t.jsx(je,{value:"vodafone_eg",children:"فودافون"}),t.jsx(je,{value:"orange_eg",children:"أورنج"}),t.jsx(je,{value:"etisalat_eg",children:"اتصالات"}),t.jsx(je,{value:"we_eg",children:"WE"})]})]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-right mb-1",children:"المبلغ بالجنيه"}),t.jsx(We,{type:"number",min:1,value:he,onChange:e=>Ke(e.target.value?Number(e.target.value):""),placeholder:"50"})]}),t.jsxs("div",{className:"flex items-center justify-between gap-2 pt-2",children:[t.jsx(T,{variant:"outline",onClick:()=>ue(!1),children:"إلغاء"}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(T,{variant:"secondary",onClick:()=>p("/topup"),children:"صفحة الشحن الكاملة"}),t.jsx(T,{onClick:Qt,disabled:Qe||!pe||!ee||!he,children:Qe?"جارٍ التنفيذ...":"تأكيد الشحن"})]})]})]})]})}),t.jsx(Ue,{open:F,onOpenChange:Y,children:t.jsxs($e,{className:"sm:max-w-[460px]",children:[t.jsxs(Ve,{children:[t.jsx(qe,{children:"تأكيد استرجاع الإيصال"}),t.jsx(Ns,{children:"سيتم إعادة الإيصال إلى قائمة المعاملات الحالية."})]}),_&&t.jsxs("div",{className:"mt-2 space-y-2 text-sm",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"المبلغ"}),t.jsxs("span",{className:"font-bold",children:[_.amount," جنيه"]})]}),_.type==="withdraw"?t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"العميل"}),t.jsx("span",{className:"font-medium",children:_.receiverPhone})]}):t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"من → إلى"}),t.jsxs("span",{className:"font-medium",children:[_.senderPhone," → ",_.receiverPhone]})]}),t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"الكاشير"}),t.jsx("span",{className:"font-medium",children:_.cashierName??"الحساب الرئيسي"})]}),t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"التاريخ"}),t.jsx("span",{className:"font-medium",children:_.createdAt.toLocaleString("ar-EG")})]})]}),t.jsxs("div",{className:"flex items-center justify-between gap-2 pt-3",children:[t.jsx(T,{variant:"outline",onClick:()=>{Y(!1),Q(null)},children:"إلغاء"}),t.jsx(T,{onClick:Zt,children:"تأكيد الاسترجاع"})]})]})}),t.jsx(_s,{isOpen:Bt,onClose:()=>Re(!1),transaction:zt,onPrint:()=>window.print(),onDelete:rt,onComplete:at})]})};export{ba as default};
