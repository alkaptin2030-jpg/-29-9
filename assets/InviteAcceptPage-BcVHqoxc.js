import{E,a as S,u as B,r as c,k as m,j as e,t as R,G as k,e as D,g as p,v as g,B as u,H as L}from"./index-B05GXhax.js";import{C as P,a as U,b as F,d as H}from"./card-DnZtAmLe.js";import{B as v}from"./button-DNYNxb0H.js";import{I as M}from"./input-DE-9RJ6u.js";import{L as T}from"./label-CVapxVb2.js";function J(){const{token:h}=E(),w=S(),{user:i}=B(),[l,d]=c.useState(!1),[a,N]=c.useState(null),[x,n]=c.useState(null),[f,y]=c.useState(""),o=c.useMemo(()=>h?m(p,"managerInvites",h):null,[h]);c.useEffect(()=>{(async()=>{if(o)try{const s=await R(o);if(!s.exists()){n("رابط الدعوة غير صالح أو تم استخدامه مسبقًا.");return}const r=s.data();if(r!=null&&r.expiresAt&&Date.now()>r.expiresAt){n("انتهت صلاحية الدعوة. يرجى التواصل مع المسؤول لإعادة الإرسال.");return}if(r!=null&&r.status&&r.status!=="pending"){n("تم استخدام هذه الدعوة سابقًا.");return}N({id:s.id,...r})}catch(s){n((s==null?void 0:s.message)||"تعذّر تحميل بيانات الدعوة.")}})()},[o]);const j=async t=>{if(!(!o||!a)){d(!0),n(null);try{const s=`${a.shopName}-${Math.random().toString(36).slice(2,8)}`.replace(/\s+/g,"-").toLowerCase(),r=m(p,"shops",s);await g(r,{name:a.shopName,ownerId:t,createdAt:u(),createdBy:a.createdBy||t},{merge:!0});const C=m(p,"profiles",t);await g(C,{userId:t,role:"merchant",approved:!0,shopId:s,displayName:a.managerName,updatedAt:u()},{merge:!0});const b=m(p,"users",t);await g(b,{role:"merchant",isActive:!0,shopId:s,updatedAt:u()},{merge:!0}),await L(o,{status:"accepted",acceptedAt:u(),managerUid:t,shopId:s}),w("/merchant",{replace:!0})}catch(s){n((s==null?void 0:s.message)||"تعذّر إكمال الدعوة.")}finally{d(!1)}}},A=async()=>{if(a){d(!0),n(null);try{const t=a.email;if(!t){n("لا تحتوي الدعوة على بريد إلكتروني صالح.");return}const s=await k(D,t,f);await j(s.user.uid)}catch(t){n((t==null?void 0:t.message)||"تعذّر إنشاء الحساب.")}finally{d(!1)}}},I=async()=>{if(!(!i||!a)){if(i.email!==a.email){n("البريد المسجّل لا يطابق البريد في الدعوة.");return}await j(i.uid)}};return e.jsx("div",{className:"container mx-auto p-4 max-w-xl",children:e.jsxs(P,{children:[e.jsx(U,{children:e.jsx(F,{children:"قبول دعوة مدير متجر"})}),e.jsxs(H,{children:[!a&&!x&&e.jsx("p",{className:"text-sm",children:"جاري تحميل بيانات الدعوة..."}),x&&e.jsx("p",{className:"text-sm text-red-600",children:x}),a&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("p",{className:"text-sm",children:["الدعوة موجهة إلى: ",e.jsx("strong",{children:a.email})]}),e.jsxs("p",{className:"text-sm",children:["اسم المدير: ",e.jsx("strong",{children:a.managerName})]}),e.jsxs("p",{className:"text-sm",children:["اسم المتجر: ",e.jsx("strong",{children:a.shopName})]}),!i&&e.jsxs("div",{className:"grid gap-2 mt-4",children:[e.jsx(T,{htmlFor:"password",children:"اختر كلمة المرور لحسابك"}),e.jsx(M,{id:"password",type:"password",value:f,onChange:t=>y(t.target.value),placeholder:"••••••••"}),e.jsx(v,{onClick:A,disabled:l||!f,children:l?"جاري إنشاء الحساب...":"إنشاء حساب وقبول الدعوة"})]}),i&&e.jsxs("div",{className:"mt-4",children:[e.jsxs("p",{className:"text-sm mb-2",children:["أنت مسجّل الدخول كـ ",e.jsx("strong",{children:i.email})]}),e.jsx(v,{onClick:I,disabled:l,children:l?"جاري الإكمال...":"قبول الدعوة لهذا الحساب"})]})]})]})]})})}export{J as default};
