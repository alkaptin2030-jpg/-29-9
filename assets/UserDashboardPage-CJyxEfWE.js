const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-5EflPS7Y.js","./index-DTUj2xQR.css","./dailyOperationCountService-CGiiympf.js","./walletDailyLimitsService-Byppxers.js","./profitService-B_O8unCh.js"])))=>i.map(i=>d[i]);
var Jd=Object.defineProperty;var Kd=(i,u,o)=>u in i?Jd(i,u,{enumerable:!0,configurable:!0,writable:!0,value:o}):i[u]=o;var bi=(i,u,o)=>Kd(i,typeof u!="symbol"?u+"":u,o);import{J as Bs,h as Yd,i as Hd,u as $s,r as n,c as As,j as e,B as h,ao as Es,aq as Nr,b8 as fn,b9 as eo,a8 as yr,C as Qs,a as po,p as Nt,ap as as,I as U,ai as go,ax as fo,a9 as ft,b2 as hn,U as Ci,A as Gd,R as qe,E as Xt,n as ja,aN as Na,v as ze,f as K,H as Ds,s as Ge,d as Ba,a0 as ba,K as ca,q as ot,e as Ee,an as De,g as ut,_ as yo,w as Rs,k as Is,F as vr,y as Qd,z as Fs,ab as jr,aE as yn,l as on,ar as Pi,O as Ms,ay as Ae,aJ as vs,a5 as vo,a1 as Zd,a4 as Xd,ba as em,Y as Sa,bb as bo,aD as to,aI as wo,bc as tm,ac as sm,bd as ur,D as am,ah as rm,af as xr,aH as nm,b5 as so,M as im,aG as pr,ad as ao,be as ro,aT as lm,bf as om}from"./index-5EflPS7Y.js";import{C as yt,a as Jt,b as cs,d as wt}from"./card-DXPppts9.js";import{B as Ot}from"./badge-DZ4fmRLR.js";import{S as ra,a as na,b as ia,c as la,d as Os,e as br,f as dn}from"./select-3q_346E_.js";import{D as de,a as me,b as he,c as ue,f as cm,e as ss,d as rt,g as No,R as dm,P as mm,W as hm,C as um,T as xm,h as pm,i as jo,O as gm,j as fm}from"./dialog-CY7KVlhj.js";import{L as H}from"./label-BbMWBagC.js";import{M as rs,a as ns,P as ym}from"./MasterPinDialog-DQOde7Hj.js";import{walletDailyLimitsService as Cs}from"./walletDailyLimitsService-Byppxers.js";import{W as Ls}from"./wallet-NIRbOtei.js";import{S as So,a as vm}from"./star-D4Uw9DR7.js";import{S as Do}from"./square-pen-DVq8unyz.js";import{T as Vt,P as no}from"./progress-CZ6HS10G.js";import{P as Gs}from"./phone-32lCvTTa.js";import{A as Co}from"./arrow-left-BVSspWOA.js";import{a as Ii,S as bm}from"./separator-CyutvTNL.js";import{C as da}from"./calendar-BU1uXyDN.js";import{C as un}from"./chart-column-BlRvdiwo.js";import{D as At}from"./dollar-sign-Cmw8CMzs.js";import{A as cn,P as wm}from"./ProfileIcon-hWPGCzqD.js";import{C as Da}from"./circle-alert-L2Owt6-y.js";import{C as xn}from"./circle-x-BJ7R2vQm.js";import{C as ma}from"./circle-check-big-DzztOUK9.js";import{f as ys,P as Nm,C as Io,a as ki,A as pn,b as io,R as jm,c as Sm,M as Dm}from"./MaintenanceDialog-xOpK61Iw.js";import{S as Ao}from"./store-Cv8kdbYl.js";import{r as Zt,P as oa}from"./profitService-B_O8unCh.js";import{a as Cm,E as Im}from"./broadcastService-Bof4v1SY.js";import{B as lo,T as Am}from"./textarea-BAl1sXqW.js";import{D as Tm,a as Pm,b as km,c as Om,d as Em}from"./dropdown-menu-CJa_lzny.js";import{S as wi}from"./shield-Aq4l2F3b.js";import{G as _m}from"./gift-DNdE2rEQ.js";import{W as Wm}from"./WalletsManagement-CoAIDop2.js";import{P as Fm,w as Mm}from"./walletSelectionPinService-DsJwE7rO.js";import{R as Lm}from"./refresh-cw-CqBeElke.js";import"./Combination-vrlhZqzc.js";import"./index-R9UGA7TY.js";import"./avatars-B3bU3TqP.js";import"./whatsappService-e_9Fvgqq.js";import"./download-BQPqh6Fo.js";import"./index-BCcWEWHS.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Rm=Bs("Award",[["path",{d:"m15.477 12.89 1.515 8.526a.5.5 0 0 1-.81.47l-3.58-2.687a1 1 0 0 0-1.197 0l-3.586 2.686a.5.5 0 0 1-.81-.469l1.514-8.526",key:"1yiouv"}],["circle",{cx:"12",cy:"8",r:"6",key:"1vp47v"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const oo=Bs("Banknote",[["rect",{width:"20",height:"12",x:"2",y:"6",rx:"2",key:"9lu3g6"}],["circle",{cx:"12",cy:"12",r:"2",key:"1c9p78"}],["path",{d:"M6 12h.01M18 12h.01",key:"113zkx"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Bm=Bs("BookOpen",[["path",{d:"M12 7v14",key:"1akyts"}],["path",{d:"M3 18a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h5a4 4 0 0 1 4 4 4 4 0 0 1 4-4h5a1 1 0 0 1 1 1v13a1 1 0 0 1-1 1h-6a3 3 0 0 0-3 3 3 3 0 0 0-3-3z",key:"ruj8y"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const To=Bs("Building",[["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",ry:"2",key:"76otgf"}],["path",{d:"M9 22v-4h6v4",key:"r93iot"}],["path",{d:"M8 6h.01",key:"1dz90k"}],["path",{d:"M16 6h.01",key:"1x0f13"}],["path",{d:"M12 6h.01",key:"1vi96p"}],["path",{d:"M12 10h.01",key:"1nrarc"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M16 10h.01",key:"1m94wz"}],["path",{d:"M16 14h.01",key:"1gbofw"}],["path",{d:"M8 10h.01",key:"19clt8"}],["path",{d:"M8 14h.01",key:"6423bh"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const gn=Bs("IdCard",[["path",{d:"M16 10h2",key:"8sgtl7"}],["path",{d:"M16 14h2",key:"epxaof"}],["path",{d:"M6.17 15a3 3 0 0 1 5.66 0",key:"n6f512"}],["circle",{cx:"9",cy:"11",r:"2",key:"yxgjnd"}],["rect",{x:"2",y:"5",width:"20",height:"14",rx:"2",key:"qneu4z"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ai=Bs("Info",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ni=Bs("ListChecks",[["path",{d:"m3 17 2 2 4-4",key:"1jhpwq"}],["path",{d:"m3 7 2 2 4-4",key:"1obspn"}],["path",{d:"M13 6h8",key:"15sg57"}],["path",{d:"M13 12h8",key:"h98zly"}],["path",{d:"M13 18h8",key:"oe0vm4"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $m=Bs("Notebook",[["path",{d:"M2 6h4",key:"aawbzj"}],["path",{d:"M2 10h4",key:"l0bgd4"}],["path",{d:"M2 14h4",key:"1gsvsf"}],["path",{d:"M2 18h4",key:"1bu2t1"}],["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",key:"1nb95v"}],["path",{d:"M16 2v20",key:"rotuqe"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fr=Bs("Package",[["path",{d:"M11 21.73a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73z",key:"1a0edw"}],["path",{d:"M12 22V12",key:"d0xqtd"}],["path",{d:"m3.3 7 7.703 4.734a2 2 0 0 0 1.994 0L20.7 7",key:"yx3hmr"}],["path",{d:"m7.5 4.27 9 5.15",key:"1c824w"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const mn=Bs("TrendingDown",[["polyline",{points:"22 17 13.5 8.5 8.5 13.5 2 7",key:"1r2t7k"}],["polyline",{points:"16 17 22 17 22 11",key:"11uiuu"}]]),Um=async(i={})=>{try{return(await Yd(Hd,"getLastTransactions")(i)).data}catch(u){throw console.error("Error getting last transactions:",u),u.code==="functions/unauthenticated"?new Error("يجب تسجيل الدخول للوصول إلى المعاملات"):u.code==="functions/invalid-argument"?new Error("بيانات الاستعلام غير صالحة: "+u.message):u.code==="functions/permission-denied"?new Error("ليس لديك صلاحية للوصول إلى هذه المعاملات: "+u.message):new Error("حدث خطأ أثناء جلب المعاملات: "+(u.message||"خطأ غير معروف"))}},zm=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],qm=({isOpen:i,onClose:u,onWalletSelect:o,onEditWallet:p,onDeleteWallet:v})=>{const{user:j}=$s(),[s,D]=n.useState([]),[B,C]=n.useState(!1),[A,T]=n.useState([]),[g,y]=n.useState(!1),{toast:P}=As(),q=async(E,_)=>{const oe=new Date().getMonth(),ee=new Date().getFullYear(),fe=_.filter(we=>{const Te=new Date(we.createdAt);return Te.getMonth()===oe&&Te.getFullYear()===ee&&(we.lineId===E||we.fromWallet===E)}),se=we=>{const Te=we.type;return we.txnType==="receive"||Te==="withdraw"||Te==="withdrawal"||Te==="receive"},te=we=>{const Te=we.type;return we.txnType==="send"||Te==="send"||Te==="transfer"},ye=fe.filter(se).reduce((we,Te)=>{const Me=Te.withdrawnAmount!==void 0?Te.withdrawnAmount:Te.amount;return we+(Me||0)},0),We=fe.filter(te).reduce((we,Te)=>{const Me=Te.sentAmount!==void 0?Te.sentAmount:Te.amount;return we+(Me||0)},0);return{withdrawalUsage:ye,transferUsage:We}},M=E=>{const _=new Date().toISOString().split("T")[0],oe=E.lastResetDate;if(!oe)return{...E,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:_};const ee=new Date(oe),fe=new Date;return ee.getMonth()!==fe.getMonth()||ee.getFullYear()!==fe.getFullYear()?{...E,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:_}:E};n.useEffect(()=>{if(!(j!=null&&j.uid)||!i)return;(async()=>{y(!0);try{const _=await Es.getByMerchantId(j.uid),oe=await fn.getByUserId(j.uid),fe=(await Promise.all(_.map(async se=>{const{withdrawalUsage:te,transferUsage:ye}=await q(se.id,oe),We=await Cs.getWalletLimits(se.id);return{id:se.id,name:se.label||"محفظة بدون اسم",phone:se.msisdn,nationalId:se.nationalId||"",isDefault:!1,isActive:se.isActive===!0,monthlyWithdrawalLimit:(We==null?void 0:We.monthlyWithdrawLimit)??se.withdrawLimit??2e5,monthlyTransferLimit:(We==null?void 0:We.monthlyTransferLimit)??se.transferLimit??2e5,monthlyWithdrawalUsage:(We==null?void 0:We.monthlyWithdrawUsed)??te??0,monthlyTransferUsage:(We==null?void 0:We.monthlyTransferUsed)??ye??0,lastResetDate:new Date().toISOString().split("T")[0],walletProvider:se.walletProvider||""}}))).map(M);D(fe)}catch(_){console.error("Error loading wallets:",_),P({title:"فشل جلب بيانات المحافظ",description:"قد تكون المشكلة بسبب الصلاحيات أو الاتصال. سيتم عرض البيانات المحلية إن وُجدت. جرّب تسجيل الدخول مجددًا أو افتح صفحة اختبار المصادقة من القائمة.",variant:"destructive"})}finally{y(!1)}})()},[j==null?void 0:j.uid,i]);const V=E=>zm.find(_=>_.id===E),J=(E,_)=>_>0?Math.min(E/_*100,100):0,re=E=>new Intl.NumberFormat("ar-EG").format(E);return e.jsx(de,{open:i,onOpenChange:u,children:e.jsxs(me,{className:"max-w-6xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(he,{className:"pb-4",children:[e.jsxs(ue,{className:"flex items-center gap-2 text-lg",children:[e.jsx(Ls,{className:"h-5 w-5"}),"الاطلاع على جميع المحافظ",e.jsxs(Ot,{variant:"secondary",className:"mr-2",children:[s.length," محفظة"]})]}),e.jsx("div",{className:"flex items-center gap-2 mt-2",children:B?e.jsxs(e.Fragment,{children:[e.jsx(h,{size:"sm",onClick:async()=>{try{if(!(j!=null&&j.uid))return;const E=s.map(_=>Es.update(_.id,{isActive:A.includes(_.id)}));await Promise.all(E),D(_=>_.map(oe=>({...oe,isActive:A.includes(oe.id)}))),C(!1),P({title:"تم تفعيل المحافظ",description:"فقط المحافظ المحددة ستظهر في الاختيار الخارجي"});try{window.dispatchEvent(new CustomEvent("wallets:activation-updated"))}catch{}}catch(E){console.error("Error activating wallets:",E),P({title:"فشل التفعيل",description:"تعذر تفعيل المحافظ المحددة",variant:"destructive"})}},className:"h-7",children:"تفعيل المحافظ"}),e.jsx(h,{variant:"ghost",size:"sm",onClick:()=>{C(!1),T([])},className:"h-7",children:"إلغاء"})]}):e.jsx(h,{variant:"outline",size:"sm",onClick:()=>C(!0),className:"h-7",children:"تحديد المحافظ"})})]}),g?e.jsx("div",{className:"flex justify-center items-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-600",children:"جاري تحميل المحافظ..."})]})}):s.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Ls,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"لا توجد محافظ مضافة حتى الآن"})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:s.map(E=>{const _=V(E.walletProvider||"");J(E.monthlyWithdrawalUsage||0,E.monthlyWithdrawalLimit),J(E.monthlyTransferUsage||0,E.monthlyTransferLimit);const oe=A.includes(E.id),ee=B?`cursor-pointer transition-shadow border-2 ${oe?"border-blue-500 shadow-lg":"hover:border-blue-300"}`:"cursor-pointer hover:shadow-lg transition-shadow border-2 hover:border-blue-300";return e.jsxs(yt,{className:ee,onClick:()=>{B?T(fe=>fe.includes(E.id)?fe.filter(se=>se!==E.id):[...fe,E.id]):o(E)},children:[e.jsx(Jt,{className:"pb-3",children:e.jsxs(cs,{className:"flex items-center justify-between text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Nr,{className:"h-4 w-4"}),e.jsx("span",{children:E.name})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[E.isActive&&e.jsx(Ot,{variant:"default",className:"text-xs",children:"نشطة"}),E.isDefault&&e.jsxs(Ot,{variant:"default",className:"text-xs",children:[e.jsx(So,{className:"h-3 w-3 mr-1"}),"افتراضية"]}),e.jsx(h,{variant:"ghost",size:"sm",onClick:fe=>{fe.stopPropagation(),p==null||p(E)},className:"h-7 px-2",children:e.jsx(Do,{className:"h-4 w-4"})}),e.jsx(h,{variant:"ghost",size:"sm",onClick:fe=>{fe.stopPropagation(),v==null||v(E.id)},className:"h-7 px-2 text-destructive hover:text-destructive",children:e.jsx(Vt,{className:"h-4 w-4"})})]})]})}),e.jsxs(wt,{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Gs,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"font-mono",children:E.phone})]}),E.nationalId&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(gn,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"font-mono",children:E.nationalId})]}),_&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(To,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{children:_.name})]})]}),(()=>{const fe=E.monthlyWithdrawalLimit,se=E.monthlyTransferLimit,te=E.monthlyWithdrawalUsage||0,ye=E.monthlyTransferUsage||0,We=Math.max(fe-te,0),we=Math.max(se-ye,0);return e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-2 rounded-md border border-gray-200 shadow-sm space-y-2",children:[e.jsxs("div",{className:"text-xs text-gray-600 font-medium text-center",children:["الحدود الشهرية: ",(_==null?void 0:_.name)||E.walletProvider," - ",E.phone]}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-red-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-red-400 to-red-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(te/Math.max(fe,1)*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-blue-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-400 to-blue-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(ye/Math.max(se,1)*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-1",children:[e.jsxs("div",{className:"text-xs text-red-600 font-medium",children:["متبقي سحب: ",re(We)," جنيه"]}),e.jsxs("div",{className:"text-xs text-blue-600 font-medium",children:["متبقي تحويل: ",re(we)," جنيه"]})]})]})})(),e.jsx(h,{variant:"outline",size:"sm",className:"w-full text-xs",onClick:fe=>{fe.stopPropagation(),o(E)},children:"عرض التفاصيل الكاملة"})]})]},E.id)})}),e.jsx("div",{className:"flex justify-end pt-4 border-t",children:e.jsxs(h,{onClick:u,variant:"outline",children:[e.jsx(Co,{className:"h-4 w-4 mr-2"}),"إغلاق"]})})]})})},Vm=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],Jm=({wallet:i,isOpen:u,onClose:o,onBack:p})=>{const{user:v}=$s(),[j,s]=n.useState([]),[D,B]=n.useState(!1),[C,A]=n.useState("month"),{toast:T}=As();if(n.useEffect(()=>{if(!i||!(v!=null&&v.uid)||!u)return;(async()=>{B(!0);try{const Qe=(await fn.getByUserId(v.uid)).filter(Q=>Q.walletId===i.id).sort((Q,Ne)=>new Date(Ne.createdAt).getTime()-new Date(Q.createdAt).getTime());s(Qe)}catch(ne){console.error("Error loading transactions:",ne),T({title:"فشل جلب معاملات المحفظة",description:"قد تكون المشكلة بسبب صلاحيات Firestore أو الاتصال. تم عرض ما أمكن محليًا. جرّب تسجيل الدخول مجددًا أو صفحة اختبار المصادقة.",variant:"destructive"})}finally{B(!1)}})()},[i,v==null?void 0:v.uid,u]),!i)return null;const g=G=>Vm.find(ne=>ne.id===G),y=(G,ne)=>ne>0?Math.min(G/ne*100,100):0,P=G=>new Intl.NumberFormat("ar-EG").format(G),q=G=>new Date(G).toLocaleDateString("ar-EG",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}),V=(()=>{const G=new Date;let ne;switch(C){case"week":ne=new Date(G.getTime()-7*24*60*60*1e3);break;case"month":ne=new Date(G.getFullYear(),G.getMonth(),1);break;default:return j}return j.filter(Qe=>new Date(Qe.createdAt)>=ne)})(),J=G=>{const ne=G.type,Qe=G.txnType;return ne==="withdraw"||ne==="withdrawal"||ne==="receive"||Qe==="receive"},re=G=>{const ne=G.type,Qe=G.txnType;return ne==="send"||ne==="transfer"||Qe==="send"},E=V.filter(G=>J(G)&&G.status==="completed").reduce((G,ne)=>{const Qe=ne.withdrawnAmount!==void 0?ne.withdrawnAmount:ne.amount;return G+(Qe||0)},0),_=V.filter(G=>re(G)&&G.status==="completed").reduce((G,ne)=>{const Qe=ne.sentAmount!==void 0?ne.sentAmount:ne.amount;return G+(Qe||0)},0),oe=V.filter(G=>G.type==="deposit"&&G.status==="completed").reduce((G,ne)=>G+ne.amount,0),ee=V.filter(G=>G.status==="completed"),fe=ee.length,se=ee.reduce((G,ne)=>{if(J(ne)){const Qe=ne.withdrawnAmount??ne.receivedAmount??ne.amount??0;return G+eo(Number(Qe)||0,"receive")}if(re(ne)){const Qe=ne.sentAmount??ne.transferredAmount??ne.amount??0;return G+eo(Number(Qe)||0,"send")}return G},0),te=g(i.walletProvider||""),ye=y(i.monthlyWithdrawalUsage||0,i.monthlyWithdrawalLimit),We=y(i.monthlyTransferUsage||0,i.monthlyTransferLimit),we=G=>{switch(G){case"withdrawal":return e.jsx(mn,{className:"h-4 w-4 text-red-500"});case"transfer":return e.jsx(yr,{className:"h-4 w-4 text-blue-500"});case"deposit":return e.jsx(At,{className:"h-4 w-4 text-green-500"});default:return e.jsx(cn,{className:"h-4 w-4 text-gray-500"})}},Te=G=>{switch(G){case"completed":return e.jsx(ma,{className:"h-4 w-4 text-green-500"});case"pending":return e.jsx(Qs,{className:"h-4 w-4 text-yellow-500"});case"failed":return e.jsx(xn,{className:"h-4 w-4 text-red-500"});default:return e.jsx(Da,{className:"h-4 w-4 text-gray-500"})}},Me=G=>{switch(G){case"withdrawal":return"سحب";case"transfer":return"تحويل";case"deposit":return"إيداع";default:return"معاملة"}},et=G=>{switch(G){case"completed":return"مكتملة";case"pending":return"قيد الانتظار";case"failed":return"فاشلة";default:return"غير محدد"}};return e.jsx(de,{open:u,onOpenChange:o,children:e.jsxs(me,{className:"max-w-6xl max-h-[90vh] overflow-y-auto",children:[e.jsx(he,{className:"pb-4",children:e.jsxs(ue,{className:"flex items-center gap-2 text-lg",children:[e.jsx(Nr,{className:"h-5 w-5"}),"تفاصيل المحفظة: ",i.name,i.isDefault&&e.jsxs(Ot,{variant:"default",className:"mr-2",children:[e.jsx(So,{className:"h-3 w-3 mr-1"}),"افتراضية"]})]})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-1 space-y-4",children:[e.jsxs(yt,{children:[e.jsx(Jt,{children:e.jsxs(cs,{className:"text-sm flex items-center gap-2",children:[e.jsx(gn,{className:"h-4 w-4"}),"المعلومات الأساسية"]})}),e.jsxs(wt,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Gs,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-mono",children:i.phone})]}),i.nationalId&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(gn,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-mono",children:i.nationalId})]}),te&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(To,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{children:te.name})]}),e.jsxs("div",{className:"text-xs text-gray-600 pr-6",children:[e.jsxs("div",{children:["المالك: ",te.ownerName]}),e.jsxs("div",{className:"font-mono",children:["الرقم القومي: ",te.nationalId]})]})]}),i.lastResetDate&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(da,{className:"h-4 w-4 text-gray-500"}),e.jsxs("span",{children:["آخر إعادة تعيين: ",new Date(i.lastResetDate).toLocaleDateString("ar-EG")]})]})]})]}),e.jsxs(yt,{children:[e.jsx(Jt,{children:e.jsxs(cs,{className:"text-sm flex items-center gap-2",children:[e.jsx(un,{className:"h-4 w-4"}),"حدود الاستخدام الشهري"]})}),e.jsxs(wt,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(mn,{className:"h-3 w-3 text-red-500"}),"السحب الشهري"]}),e.jsxs("span",{className:"font-mono",children:[P(i.monthlyWithdrawalUsage||0)," / ",P(i.monthlyWithdrawalLimit)]})]}),e.jsx(no,{value:ye,className:"h-2"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["متبقي: ",P(i.monthlyWithdrawalLimit-(i.monthlyWithdrawalUsage||0))," جنيه"]})]}),e.jsx(Ii,{}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(yr,{className:"h-3 w-3 text-green-500"}),"التحويل الشهري"]}),e.jsxs("span",{className:"font-mono",children:[P(i.monthlyTransferUsage||0)," / ",P(i.monthlyTransferLimit)]})]}),e.jsx(no,{value:We,className:"h-2"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["متبقي: ",P(i.monthlyTransferLimit-(i.monthlyTransferUsage||0))," جنيه"]})]})]})]})]}),e.jsxs("div",{className:"lg:col-span-2 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-5 gap-4",children:[e.jsx(yt,{children:e.jsxs(wt,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(mn,{className:"h-5 w-5 text-red-500"})}),e.jsx("div",{className:"text-lg font-bold",children:P(E)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي السحب"})]})}),e.jsx(yt,{children:e.jsxs(wt,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(yr,{className:"h-5 w-5 text-blue-500"})}),e.jsx("div",{className:"text-lg font-bold",children:P(_)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي التحويل"})]})}),e.jsx(yt,{children:e.jsxs(wt,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(At,{className:"h-5 w-5 text-green-500"})}),e.jsx("div",{className:"text-lg font-bold",children:P(oe)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي الإيداع"})]})}),e.jsx(yt,{children:e.jsxs(wt,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(un,{className:"h-5 w-5 text-emerald-600"})}),e.jsx("div",{className:"text-lg font-bold",children:P(se)}),e.jsx("div",{className:"text-xs text-gray-600",children:"أرباح الفترة"})]})}),e.jsx(yt,{children:e.jsxs(wt,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(cn,{className:"h-5 w-5 text-purple-600"})}),e.jsx("div",{className:"text-lg font-bold",children:P(fe)}),e.jsx("div",{className:"text-xs text-gray-600",children:"عدد العمليات"})]})})]}),e.jsxs(yt,{children:[e.jsx(Jt,{children:e.jsxs(cs,{className:"text-sm flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(cn,{className:"h-4 w-4"}),"سجل المعاملات"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(h,{size:"sm",variant:C==="week"?"default":"outline",onClick:()=>A("week"),className:"text-xs",children:"أسبوع"}),e.jsx(h,{size:"sm",variant:C==="month"?"default":"outline",onClick:()=>A("month"),className:"text-xs",children:"شهر"}),e.jsx(h,{size:"sm",variant:C==="all"?"default":"outline",onClick:()=>A("all"),className:"text-xs",children:"الكل"})]})]})}),e.jsx(wt,{children:D?e.jsx("div",{className:"flex justify-center items-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-600",children:"جاري تحميل المعاملات..."})]})}):V.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(cn,{className:"h-8 w-8 text-gray-400 mx-auto mb-2"}),e.jsx("p",{className:"text-gray-600",children:"لا توجد معاملات في هذه الفترة"})]}):e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:V.map(G=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[we(G.type),e.jsxs("div",{children:[e.jsxs("div",{className:"text-sm font-medium",children:[Me(G.type)," - ",P(G.amount)," جنيه"]}),e.jsx("div",{className:"text-xs text-gray-600",children:q(G.createdAt)}),G.description&&e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:G.description})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[Te(G.status),e.jsx("span",{className:"text-xs",children:et(G.status)})]})]},G.id))})})]})]})]}),e.jsxs("div",{className:"flex justify-between pt-4 border-t",children:[e.jsxs(h,{onClick:p,variant:"outline",children:[e.jsx(Co,{className:"h-4 w-4 mr-2"}),"العودة للمحافظ"]}),e.jsx(h,{onClick:o,variant:"outline",children:"إغلاق"})]})]})})},ji=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],Km=({isOpen:i,onClose:u,onWalletUpdate:o,initialEditingWallet:p})=>{const{toast:v}=As(),{user:j}=$s(),s=po(),[D,B]=n.useState([]),[C,A]=n.useState(!1),[T,g]=n.useState(null),[y,P]=n.useState(""),[q,M]=n.useState(""),[V,J]=n.useState(""),[re,E]=n.useState(""),[_,oe]=n.useState("200000"),[ee,fe]=n.useState("200000"),[se,te]=n.useState("100000"),[ye,We]=n.useState("60000"),[we,Te]=n.useState(!1),[Me,et]=n.useState(null),[G,ne]=n.useState(!1),[Qe,Q]=n.useState(!1),[Ne,Ze]=n.useState(!1),[es,Re]=n.useState(null),nt=()=>`wallets_${(j==null?void 0:j.uid)||"default"}`;n.useEffect(()=>{p&&(g(p),A(!0),P(p.name||""),M(p.phone||""),J(p.nationalId||""),E(p.walletProvider||""),oe((p.monthlyWithdrawalLimit||2e5).toString()),fe((p.monthlyTransferLimit||2e5).toString()),te((p.dailyWithdrawalLimit||1e5).toString()),We((p.dailyTransferLimit||6e4).toString()),Te(!!p.isDefault))},[p]);const Ie=W=>{const ae=new Date,Fe=ae.getMonth(),st=ae.getFullYear();if(!W.lastResetDate)return{...W,monthlyWithdrawalUsage:W.monthlyWithdrawalUsage||0,monthlyTransferUsage:W.monthlyTransferUsage||0,lastResetDate:ae.toISOString().split("T")[0]};const jt=new Date(W.lastResetDate),Kt=jt.getMonth(),Dt=jt.getFullYear();return Fe!==Kt||st!==Dt?{...W,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:ae.toISOString().split("T")[0]}:W},Le=async(W,ae)=>{const Fe=new Date().getMonth(),st=new Date().getFullYear(),jt=ae.filter(at=>{const Ue=new Date(at.createdAt);return Ue.getMonth()===Fe&&Ue.getFullYear()===st&&at.lineId===W}),Kt=jt.filter(at=>at.txnType==="receive").reduce((at,Ue)=>at+(Ue.amount||0),0),Dt=jt.filter(at=>at.txnType==="send").reduce((at,Ue)=>at+(Ue.amount||0),0);return{withdrawalUsage:Kt,transferUsage:Dt}},ct=async(W,ae)=>{const Fe=new Date,st=Fe.getDate(),jt=Fe.getMonth(),Kt=Fe.getFullYear(),Dt=ae.filter(xt=>{const Et=new Date(xt.createdAt);return Et.getDate()===st&&Et.getMonth()===jt&&Et.getFullYear()===Kt&&xt.lineId===W}),at=Dt.filter(xt=>xt.txnType==="receive").reduce((xt,Et)=>xt+(Et.amount||0),0),Ue=Dt.filter(xt=>xt.txnType==="send").reduce((xt,Et)=>xt+(Et.amount||0),0);return{withdrawalUsage:at,transferUsage:Ue}};n.useEffect(()=>{(async()=>{if(!(j!=null&&j.uid)){console.log("No user authenticated, skipping wallet loading"),ne(!1);return}console.log("Loading wallets for user:",j.uid),ne(!0);try{const{auth:ae}=await ft(async()=>{const{auth:Ue}=await import("./index-5EflPS7Y.js").then(xt=>xt.bh);return{auth:Ue}},__vite__mapDeps([0,1]),import.meta.url);let Fe=0;const st=5;for(;!ae.currentUser&&Fe<st;)console.log(`Waiting for auth state... attempt ${Fe+1}`),await new Promise(Ue=>setTimeout(Ue,1e3)),Fe++;if(!ae.currentUser)throw console.error("User not authenticated in Firebase Auth after retries"),new Error("not authenticated");console.log("Firebase Auth User:",ae.currentUser.uid),console.log("Context User:",j.uid),console.log("Fetching wallets from Firebase...");const jt=await Es.getByMerchantId(j.uid);console.log("Fetched wallets:",jt),console.log("Fetching transactions from Firebase...");const Kt=await fn.getByUserId(j.uid);console.log("Fetched transactions:",Kt);const at=(await Promise.all(jt.map(async Ue=>{const{withdrawalUsage:xt,transferUsage:Et}=await Le(Ue.id,Kt),{withdrawalUsage:_t,transferUsage:Wt}=await ct(Ue.id,Kt);return{id:Ue.id,name:Ue.label||"محفظة بدون اسم",phone:Ue.msisdn,isDefault:!1,monthlyWithdrawalLimit:Ue.withdrawLimit||2e5,monthlyTransferLimit:Ue.transferLimit||2e5,dailyWithdrawalLimit:Ue.dailyWithdrawLimit||1e5,dailyTransferLimit:Ue.dailyTransferLimit||6e4,monthlyWithdrawalUsage:xt,monthlyTransferUsage:Et,dailyWithdrawalUsage:_t,dailyTransferUsage:Wt,lastResetDate:new Date().toISOString().split("T")[0],defaultTransferCommission:Ue.defaultTransferCommission!=null?Number(Ue.defaultTransferCommission):null,defaultWithdrawCommission:Ue.defaultWithdrawCommission!=null?Number(Ue.defaultWithdrawCommission):null}}))).map(Ie);B(at),console.log("Wallets loaded successfully:",at)}catch(ae){console.error("Error loading wallets:",ae),B([])}finally{ne(!1)}})()},[j==null?void 0:j.uid]);const tt=()=>{P(""),M(""),J(""),E(""),oe("200000"),fe("200000"),te("100000"),We("60000"),Te(!1),g(null),A(!1)},xe=async()=>{if(!y.trim()||!q.trim()||!re.trim()){v({title:"خطأ",description:"يرجى ملء جميع الحقول المطلوبة",variant:"destructive"});return}if(!(j!=null&&j.uid)){v({title:"خطأ",description:"يجب تسجيل الدخول أولاً",variant:"destructive"});return}ne(!0);try{if(T){await Es.update(T.id,{label:y.trim(),msisdn:q.trim(),withdrawLimit:parseInt(_),transferLimit:parseInt(ee),dailyWithdrawLimit:parseInt(se),dailyTransferLimit:parseInt(ye)}),await Cs.setLimits(T.id,{dailyTransferLimit:parseInt(ye||"0"),dailyWithdrawLimit:parseInt(se||"0"),monthlyTransferLimit:parseInt(ee||"0"),monthlyWithdrawLimit:parseInt(_||"0")});const W=D.map(ae=>ae.id===T.id?{...ae,name:y.trim(),phone:q.trim(),nationalId:V.trim(),walletProvider:re,monthlyWithdrawalLimit:parseInt(_),monthlyTransferLimit:parseInt(ee),dailyWithdrawalLimit:parseInt(se),dailyTransferLimit:parseInt(ye)}:ae);B(W),localStorage.setItem(nt(),JSON.stringify(W)),v({title:"تم التحديث",description:"تم تحديث المحفظة بنجاح"})}else{const W={merchantUserId:j.uid,provider:re,msisdn:q.trim(),label:y.trim(),isActive:!0,dailyLimit:2e5,monthlyLimit:2e5,withdrawLimit:parseInt(_),transferLimit:parseInt(ee),dailyTransferLimit:parseInt(ye),dailyWithdrawLimit:parseInt(se),dailyUsage:0,monthlyUsage:0,transferUsage:0,withdrawUsage:0},ae=await Es.create(W);await Cs.setLimits(ae,{dailyTransferLimit:parseInt(ye||"0"),dailyWithdrawLimit:parseInt(se||"0"),monthlyTransferLimit:parseInt(ee||"0"),monthlyWithdrawLimit:parseInt(_||"0")});const Fe=new Date().toISOString().split("T")[0],st={id:ae,name:y.trim(),phone:q.trim(),nationalId:V.trim(),walletProvider:re,isDefault:we,monthlyWithdrawalLimit:parseInt(_),monthlyTransferLimit:parseInt(ee),dailyWithdrawalLimit:parseInt(se),dailyTransferLimit:parseInt(ye),monthlyWithdrawalUsage:0,monthlyTransferUsage:0,dailyWithdrawalUsage:0,dailyTransferUsage:0,lastResetDate:Fe,defaultTransferCommission:null,defaultWithdrawCommission:null},jt=[...D,st];B(jt),localStorage.setItem(nt(),JSON.stringify(jt)),v({title:"تم الإنشاء",description:"تم إنشاء المحفظة بنجاح"})}o&&o(),tt(),A(!1),g(null)}catch(W){console.error("Error saving wallet:",W),v({title:"خطأ",description:"حدث خطأ أثناء حفظ المحفظة",variant:"destructive"})}finally{ne(!1)}},Ye=W=>{g(W),P(W.name),M(W.phone),J(W.nationalId||""),E(W.walletProvider||""),oe(W.monthlyWithdrawalLimit.toString()),fe(W.monthlyTransferLimit.toString()),Te(W.isDefault),A(!0)},Tt=async W=>{const ae=D.find(Fe=>Fe.id===W);if(ae!=null&&ae.isDefault){v({title:"تحذير",description:"لا يمكن حذف المحفظة الافتراضية",variant:"destructive"});return}if(!(j!=null&&j.uid)){v({title:"خطأ",description:"يجب تسجيل الدخول أولاً",variant:"destructive"});return}ne(!0);try{await Es.delete(W);const Fe=D.filter(st=>st.id!==W);B(Fe),localStorage.setItem(nt(),JSON.stringify(Fe)),o&&o(),v({title:"تم الحذف",description:"تم حذف المحفظة بنجاح"})}catch(Fe){console.error("Error deleting wallet:",Fe),v({title:"خطأ",description:"حدث خطأ أثناء حذف المحفظة",variant:"destructive"})}finally{ne(!1)}},vt=W=>{const ae=D.map(Fe=>({...Fe,isDefault:Fe.id===W}));B(ae),localStorage.setItem(nt(),JSON.stringify(ae)),o&&o(),v({title:"تم تحديث المحفظة الافتراضية",description:"تم تعيين المحفظة كافتراضية بنجاح"})};return e.jsxs(de,{open:i,onOpenChange:u,children:[e.jsxs(me,{className:"max-w-4xl max-h-[80vh] overflow-y-auto",children:[e.jsx(he,{className:"pb-2",children:e.jsxs(ue,{className:"flex items-center gap-1 text-sm",children:[e.jsx(Ls,{className:"h-3 w-3"}),"إدارة المحافظ"]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h3",{className:"text-sm font-semibold",children:["المحافظ المتاحة (",D.length,")"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(h,{onClick:()=>{Ze(!0)},className:"flex items-center gap-1 h-6 px-2 text-xs",size:"sm",variant:"outline",children:[e.jsx(Nt,{className:"h-3 w-3"}),"الاطلاع على المحافظ"]}),e.jsxs(h,{onClick:()=>{u(),s("/user/add-wallet")},className:"flex items-center gap-1 h-6 px-2 text-xs",size:"sm",children:[e.jsx(as,{className:"h-3 w-3"}),"إضافة محفظة جديدة"]})]})]}),(C||T)&&e.jsxs(yt,{className:"border-2 border-blue-200 bg-blue-50",children:[e.jsx(Jt,{className:"pb-1",children:e.jsx(cs,{className:"text-sm",children:T?"تعديل المحفظة":"إضافة محفظة جديدة"})}),e.jsxs(wt,{className:"space-y-2 pt-1",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"شركة المحفظة"}),e.jsx("div",{className:"flex gap-1 items-center",children:e.jsxs(ra,{value:re,onValueChange:E,children:[e.jsx(na,{className:"h-6 text-xs flex-1",children:e.jsx(ia,{placeholder:"اختر شركة المحفظة"})}),e.jsx(la,{children:ji.map(W=>e.jsx(Os,{value:W.id,className:"text-xs",children:e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsx("span",{children:W.name}),e.jsx("button",{type:"button",className:"h-4 w-4 p-0 ml-2 flex items-center justify-center hover:bg-blue-100 rounded",onClick:ae=>{ae.preventDefault(),ae.stopPropagation(),et(W.id)},children:e.jsx(Ai,{className:"h-3 w-3 text-blue-500 hover:text-blue-700"})})]})},W.id))})]})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"اسم المحفظة"}),e.jsx(U,{value:y,onChange:W=>P(W.target.value),placeholder:"مثال: محفظة العمل",className:"h-6 text-xs"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"رقم الهاتف"}),e.jsxs("div",{className:"relative",children:[e.jsx(Gs,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(U,{value:q,onChange:W=>M(W.target.value),placeholder:"01030302038",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الرقم القومي للخط"}),e.jsxs("div",{className:"relative",children:[e.jsx(gn,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(U,{value:V,onChange:W=>J(W.target.value),placeholder:"29012345678901",maxLength:14,className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد الشهري للسحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(At,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(U,{type:"number",value:_,onChange:W=>oe(W.target.value),placeholder:"200000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد الشهري للتحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(At,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(U,{type:"number",value:ee,onChange:W=>fe(W.target.value),placeholder:"200000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد اليومي للسحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(mn,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-red-400"}),e.jsx(U,{type:"number",value:se,onChange:W=>te(W.target.value),placeholder:"100000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد اليومي للتحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(yr,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-blue-400"}),e.jsx(U,{type:"number",value:ye,onChange:W=>We(W.target.value),placeholder:"60000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",id:"isDefault",checked:we,onChange:W=>Te(W.target.checked),className:"rounded w-3 h-3"}),e.jsx("label",{htmlFor:"isDefault",className:"text-xs font-medium text-gray-700",children:"تعيين كمحفظة افتراضية"})]}),e.jsx("div",{className:"border-t pt-2 mt-2",children:e.jsxs("div",{className:"flex items-center gap-1 mb-2",children:[e.jsx(go,{className:"h-3 w-3 text-gray-600"}),e.jsx("label",{className:"text-xs font-medium text-gray-700",children:"إعدادات العمولة"})]})}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(h,{onClick:xe,className:"flex-1 h-6 text-xs",size:"sm",children:T?"تحديث المحفظة":"إضافة المحفظة"}),e.jsx(h,{variant:"outline",onClick:tt,className:"h-6 text-xs",size:"sm",children:"إلغاء"})]})]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2",children:D.map(W=>{var ae;return e.jsxs(yt,{className:`${W.isDefault?"border-green-300 bg-green-50":""}`,children:[e.jsx(Jt,{className:"pb-1",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(cs,{className:"text-sm flex items-center gap-1",children:[e.jsx(Ls,{className:"h-3 w-3"}),W.name]}),W.isDefault&&e.jsx(Ot,{variant:"default",className:"bg-green-600 text-xs px-1 py-0",children:"افتراضية"})]})}),e.jsxs(wt,{className:"space-y-1 pt-0",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Gs,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"text-xs",children:W.phone})]}),W.walletProvider&&e.jsx("div",{className:"text-xs text-blue-600 mt-1",children:((ae=ji.find(Fe=>Fe.id===W.walletProvider))==null?void 0:ae.name)||W.walletProvider}),e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-2 rounded-md border border-gray-200 shadow-sm space-y-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-gray-600 mb-1",children:"الحدود الشهرية"}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-red-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-red-400 to-red-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((W.monthlyWithdrawalUsage||0)/W.monthlyWithdrawalLimit*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-blue-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-400 to-blue-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((W.monthlyTransferUsage||0)/W.monthlyTransferLimit*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-xs text-red-600 font-medium",children:["متبقي سحب: ",Math.max(W.monthlyWithdrawalLimit-(W.monthlyWithdrawalUsage||0),0)," جنيه"]}),e.jsxs("div",{className:"text-xs text-blue-600 font-medium",children:["متبقي تحويل: ",Math.max(W.monthlyTransferLimit-(W.monthlyTransferUsage||0),0)," جنيه"]})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-gray-600 mb-1",children:"الحدود اليومية"}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-orange-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-orange-400 to-orange-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((W.dailyWithdrawalUsage||0)/W.dailyWithdrawalLimit*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-green-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-green-400 to-green-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((W.dailyTransferUsage||0)/W.dailyTransferLimit*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-xs text-orange-600 font-medium",children:["متبقي سحب يومي: ",Math.max(W.dailyWithdrawalLimit-(W.dailyWithdrawalUsage||0),0)," جنيه"]}),e.jsxs("div",{className:"text-xs text-green-600 font-medium",children:["متبقي تحويل يومي: ",Math.max(W.dailyTransferLimit-(W.dailyTransferUsage||0),0)," جنيه"]})]})]})]}),e.jsxs("div",{className:"flex gap-1 pt-1",children:[e.jsxs(h,{size:"sm",variant:"outline",onClick:()=>Ye(W),className:"flex-1 h-5 text-xs px-1",children:[e.jsx(Do,{className:"h-2 w-2 mr-0.5"}),"تعديل"]}),!W.isDefault&&e.jsxs(e.Fragment,{children:[e.jsx(h,{size:"sm",variant:"outline",onClick:()=>vt(W.id),className:"flex-1 h-5 text-xs px-1",children:"جعلها افتراضية"}),e.jsx(h,{size:"sm",variant:"destructive",onClick:()=>Tt(W.id),className:"h-5 px-1",children:e.jsx(Vt,{className:"h-2 w-2"})})]})]})]})]},W.id)})}),D.length===0&&e.jsx("div",{className:"text-center py-4 text-gray-500 text-xs",children:"لا توجد محافظ متاحة. قم بإضافة محفظة جديدة للبدء."})]}),Me&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-800",children:"معلومات صاحب المحفظة"}),e.jsx("button",{onClick:()=>et(null),className:"h-8 w-8 p-0 flex items-center justify-center hover:bg-gray-100 rounded-full transition-colors",children:e.jsx(fo,{className:"h-4 w-4 text-gray-500"})})]}),(()=>{const W=ji.find(ae=>ae.id===Me);return W?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-center mb-6",children:e.jsx("div",{className:"bg-blue-100 p-3 rounded-lg inline-block",children:e.jsx("h4",{className:"font-bold text-blue-700 text-lg",children:W.name})})}),e.jsx("div",{className:"bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-200",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-white p-3 rounded-lg shadow-sm",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full mr-2"}),e.jsx("span",{className:"font-semibold text-gray-700",children:"اسم صاحب المحفظة:"})]}),e.jsx("p",{className:"text-gray-900 font-medium text-lg mr-4",children:W.ownerName})]}),e.jsxs("div",{className:"bg-white p-3 rounded-lg shadow-sm",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full mr-2"}),e.jsx("span",{className:"font-semibold text-gray-700",children:"الرقم القومي:"})]}),e.jsx("p",{className:"text-gray-900 font-mono text-lg mr-4 tracking-wider",children:W.nationalId})]})]})}),e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 p-3 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(Ai,{className:"h-4 w-4 text-yellow-600 mr-2"}),e.jsx("span",{className:"text-sm text-yellow-800 font-medium",children:"هذه البيانات مسجلة رسمياً في النظام لهذه المحفظة"})]})})]}):null})()]})})]}),e.jsx(rs,{open:Ne,onOpenChange:Ze,mode:"verify",title:"إدخال الرقم السري الرئيسي",description:"لا يمكن الاطلاع على المحافظ إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{Ze(!1),Q(!0)}}),e.jsx(qm,{isOpen:Qe,onClose:()=>Q(!1),onWalletSelect:W=>{Re(W),Q(!1)},onEditWallet:W=>{s(`/user/add-wallet?edit=1&id=${W.id}`),Q(!1)},onDeleteWallet:async W=>{try{if(await Es.delete(W),B(ae=>{const Fe=ae.filter(st=>st.id!==W);try{localStorage.setItem(nt(),JSON.stringify(Fe))}catch(st){console.error("Failed to update localStorage wallets after delete:",st)}return Fe}),o)try{await o()}catch(ae){console.error("onWalletUpdate callback failed:",ae)}}catch(ae){console.error("Error deleting wallet:",ae)}}}),e.jsx(Jm,{wallet:es,isOpen:!!es,onClose:()=>Re(null),onBack:()=>{Re(null),Q(!0)}})]})},Ym=({isOpen:i,onClose:u,transaction:o,onDelete:p})=>{if(!o)return null;const v=C=>{switch(C){case"completed":return e.jsx(ma,{className:"h-5 w-5 text-green-500"});case"pending":return e.jsx(Qs,{className:"h-5 w-5 text-yellow-500"});case"failed":return e.jsx(xn,{className:"h-5 w-5 text-red-500"});default:return e.jsx(Qs,{className:"h-5 w-5 text-gray-500"})}},j=C=>{switch(C){case"completed":return"مكتملة";case"pending":return"قيد الانتظار";case"failed":return"فاشلة";default:return"غير معروف"}},s=C=>{switch(C){case"withdraw":return"سحب";case"send":return"إرسال";case"receive":return"استقبال";default:return"تحويل"}},D=()=>{const C=!!o.senderNumber,A=!!o.senderName,T=C?"الرقم المرسل:":A?"الرقم الراسل:":"رقم المحفظة:",g=C?o.senderNumber:A?o.senderName:o.senderPhone,y=`
      <div style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 500px; margin: 0 auto; padding: 30px; background: #fff;">
        <!-- Header -->
        <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #2563eb; padding-bottom: 20px;">
          <h1 style="color: #2563eb; margin-bottom: 5px; font-size: 28px;">إيصال المعاملة</h1>
          <p style="color: #666; font-size: 16px; margin: 0;">رقم المرجع: ${o.transactionReference||o.id}</p>
          <p style="color: #888; font-size: 14px; margin: 5px 0 0 0;">${new Date().toLocaleString("ar-EG")}</p>
        </div>
        
        <!-- Shop Info -->
        <div style="background: #f8fafc; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
          <h3 style="color: #1e293b; margin: 0 0 15px 0; font-size: 18px;">معلومات المحل</h3>
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span style="font-weight: 600; color: #475569;">اسم المحل:</span>
            <span style="color: #1e293b;">${o.merchantShopName||o.shopName||"غير محدد"}</span>
          </div>
        </div>
        
        <!-- Transaction Details -->
        <div style="background: #fff; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
          <h3 style="color: #1e293b; margin: 0 0 15px 0; font-size: 18px;">تفاصيل المعاملة</h3>
          
          <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
            <span style="font-weight: 600; color: #475569;">نوع المعاملة:</span>
            <span style="color: #2563eb; font-weight: 600;">${s(o.type)}</span>
          </div>
          
          <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
            <span style="font-weight: 600; color: #475569;">الحالة:</span>
            <span style="color: ${o.status==="completed"?"#16a34a":o.status==="pending"?"#ca8a04":"#dc2626"}; font-weight: 600;">
              ${j(o.status)}
            </span>
          </div>

          ${o!=null&&o.cashierName?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الكاشير:</span>
              <span style="color: #1e293b;">${o.cashierName}</span>
            </div>
          `:""}
          
          ${o.type!=="withdraw"?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">${T}</span>
              <span style="color: #1e293b;">${g}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الرقم المستقبل:</span>
              <span style="color: #1e293b;">${o.receiverNumber||o.receiverPhone}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">المبلغ المحول:</span>
              <span style="color: #2563eb; font-weight: bold; font-size: 16px;">${ys(o.transferredAmount||o.amount)} جنيه</span>
            </div>
          `:`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">رقم المحفظة:</span>
              <span style="color: #1e293b;">${o.senderPhone}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">المبلغ المسحوب:</span>
              <span style="color: #dc2626; font-weight: bold; font-size: 16px;">${ys(o.withdrawnAmountDetailed||o.withdrawnAmount||o.amount)} جنيه</span>
            </div>
          `}
          
          ${o.commission?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">العمولة:</span>
              <span style="color: #f59e0b; font-weight: 600;">${ys(o.commission||0)} جنيه</span>
            </div>
          `:""}
          ${o!=null&&o.fee&&Number(o.fee)>0?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الرسوم:</span>
              <span style="color: #64748b; font-weight: 600;">${ys(o.fee||0)} جنيه</span>
            </div>
          `:""}
          
          <div style="display: flex; justify-content: space-between; padding: 8px 0;">
            <span style="font-weight: 600; color: #475569;">التاريخ والوقت:</span>
            <span style="color: #1e293b;">${o.createdAt.toLocaleString("ar-EG")}</span>
          </div>
        </div>
        
        <!-- Total Amount -->
        <div style="background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); border-radius: 12px; padding: 20px; margin-bottom: 20px; text-align: center;">
          <h3 style="color: white; margin: 0 0 10px 0; font-size: 16px;">إجمالي المبلغ</h3>
          <p style="color: white; font-size: 24px; font-weight: bold; margin: 0;">
            ${o.type==="withdraw"?"-":""}${ys(o.amount)} جنيه
          </p>
        </div>
        
        
        
        
        <!-- Footer -->
        <div style="text-align: center; color: #64748b; font-size: 12px; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
          <p style="margin: 0 0 5px 0;">شكراً لاستخدام خدماتنا</p>
          <p style="margin: 0;">تم إنشاء الإيصال في: ${new Date().toLocaleString("ar-EG")}</p>
        </div>
      </div>
    `,P=window.open("","_blank");P&&(P.document.write(`
        <html>
          <head>
            <title>إيصال المعاملة - ${o.transactionReference||o.id}</title>
            <meta charset="UTF-8">
            <style>
              body { 
                margin: 0; 
                padding: 20px; 
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: #f8fafc;
              }
              @media print {
                body { 
                  margin: 0; 
                  background: white;
                }
              }
            </style>
          </head>
          <body>
            ${y}
          </body>
        </html>
      `),P.document.close(),P.print())},B=()=>{window.confirm("هل أنت متأكد من حذف هذه المعاملة؟ لا يمكن التراجع عن هذا الإجراء.")&&(p(o.id),u())};return e.jsx(de,{open:i,onOpenChange:u,children:e.jsxs(me,{className:"w-[92vw] sm:w-auto sm:max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx(he,{children:e.jsxs(ue,{className:"flex items-center gap-2 text-xl",children:[e.jsx(hn,{className:"h-6 w-6 text-blue-600"}),"إيصال المعاملة المفصل"]})}),e.jsxs("div",{className:"space-y-6",children:[e.jsx(yt,{className:"bg-gradient-to-r from-blue-50 to-indigo-50 border-blue-200",children:e.jsxs(Jt,{className:"text-center pb-2",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 mb-2",children:[v(o.status),e.jsx(Ot,{variant:o.status==="completed"?"default":"secondary",className:"text-sm",children:j(o.status)})]}),e.jsxs("h3",{className:"text-2xl font-bold text-blue-600",children:[o.type==="withdraw"?"-":"",ys(o.amount)," جنيه"]}),e.jsxs("p",{className:"text-sm text-gray-600",children:["رقم المرجع: ",o.transactionReference||o.id]})]})}),e.jsxs(yt,{children:[e.jsx(Jt,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ao,{className:"h-5 w-5 text-green-600"}),e.jsx("h4",{className:"font-semibold text-lg",children:"معلومات المحل"})]})}),e.jsxs(wt,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"اسم المحل:"}),e.jsx("span",{className:"text-gray-900",children:o.merchantShopName||o.shopName||"غير محدد"})]}),(o==null?void 0:o.cashierName)&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"الكاشير:"}),e.jsx("span",{className:"text-gray-900",children:o.cashierName})]})]})]}),e.jsxs(yt,{children:[e.jsx(Jt,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Nr,{className:"h-5 w-5 text-blue-600"}),e.jsx("h4",{className:"font-semibold text-lg",children:"تفاصيل المعاملة"})]})}),e.jsx(wt,{className:"space-y-3",children:e.jsxs("div",{className:"grid grid-cols-1 gap-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-blue-700",children:"نوع المعاملة:"}),e.jsx(Ot,{variant:"outline",className:"bg-blue-100 text-blue-800",children:s(o.type)})]}),o.type!=="withdraw"?e.jsxs(e.Fragment,{children:[(()=>{const C=!!o.senderNumber,A=!!o.senderName,T=C?"الرقم المرسل:":A?"الرقم الراسل:":"رقم المحفظة:",g=C?o.senderNumber:A?o.senderName:o.senderPhone,y=C?Ci:Gs;return e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(y,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:T})]}),e.jsx("span",{className:"text-gray-900 font-mono",children:g})]})})(),e.jsx("div",{className:"flex items-center justify-center p-2",children:e.jsx(Gd,{className:"h-6 w-6 text-blue-500"})}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-green-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ci,{className:"h-4 w-4 text-green-500"}),e.jsx("span",{className:"font-medium text-green-700",children:"الرقم المستقبل:"})]}),e.jsx("span",{className:"text-green-900 font-mono",children:o.receiverNumber||o.receiverPhone})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(At,{className:"h-4 w-4 text-blue-500"}),e.jsx("span",{className:"font-medium text-blue-700",children:"المبلغ المحول:"})]}),e.jsxs("span",{className:"text-blue-900 font-bold text-lg",children:[ys(o.transferredAmount||o.amount)," جنيه"]})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Gs,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:"رقم المحفظة:"})]}),e.jsx("span",{className:"text-gray-900 font-mono",children:o.senderPhone})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-red-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(At,{className:"h-4 w-4 text-red-500"}),e.jsx("span",{className:"font-medium text-red-700",children:"المبلغ المسحوب:"})]}),e.jsxs("span",{className:"text-red-900 font-bold text-lg",children:[ys(o.withdrawnAmountDetailed||o.withdrawnAmount||o.amount)," جنيه"]})]})]}),o.commission&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-yellow-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-yellow-700",children:"العمولة:"}),e.jsxs("span",{className:"text-yellow-900 font-semibold",children:[o.commission," جنيه"]})]}),(o==null?void 0:o.fee)&&Number(o.fee)>0&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"الرسوم:"}),e.jsxs("span",{className:"text-gray-900 font-semibold",children:[o.fee," جنيه"]})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(da,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:"التاريخ والوقت:"})]}),e.jsx("span",{className:"text-gray-900",children:o.createdAt.toLocaleString("ar-EG")})]})]})})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs(h,{onClick:D,className:"flex-1 bg-blue-600 hover:bg-blue-700 text-white",size:"lg",children:[e.jsx(Nm,{className:"h-5 w-5 mr-2"}),"طباعة الإيصال"]}),e.jsxs(h,{onClick:B,variant:"destructive",className:"flex-1",size:"lg",children:[e.jsx(Vt,{className:"h-5 w-5 mr-2"}),"حذف المعاملة"]})]}),e.jsx(h,{onClick:u,variant:"outline",className:"w-full",size:"lg",children:"إغلاق الإيصال"})]})]})})};function co({open:i,onOpenChange:u,onSuccess:o,title:p,description:v,currentBalance:j,balanceLabel:s,userId:D}){const[B,C]=n.useState(""),[A,T]=n.useState(j.toString()),[g,y]=n.useState(!1),[P,q]=n.useState(""),[M,V]=n.useState(!1),J=async E=>{E.preventDefault(),q(""),V(!0);try{const _=parseFloat(A);if(isNaN(_)||_<0){q("يرجى إدخال مبلغ صحيح"),V(!1);return}await ns.hasMasterPin(D)?await ns.verifyMasterPin(B,D)?(o(_),u(!1),C(""),T("")):q("الرقم السري غير صحيح"):q("لم يتم تعيين رقم سري رئيسي. يرجى تعيين رقم سري رئيسي أولاً من إعدادات التطبيق")}catch{q("حدث خطأ أثناء التحقق من الرقم السري")}finally{V(!1)}},re=()=>{C(""),T(j.toString()),q(""),u(!1)};return qe.useEffect(()=>{i&&T(j.toString())},[j,i]),e.jsx(de,{open:i,onOpenChange:re,children:e.jsxs(me,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(he,{children:e.jsxs(ue,{className:"flex items-center gap-2 text-right",children:[e.jsx(At,{className:"h-5 w-5"}),p]})}),e.jsxs("form",{onSubmit:J,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:v}),e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg",children:[e.jsxs(H,{className:"text-sm font-medium text-gray-700",children:[s," الحالي"]}),e.jsxs("div",{className:"text-lg font-bold text-gray-900 mt-1",children:[j.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"newAmount",className:"text-right",children:"المبلغ الجديد"}),e.jsx(U,{id:"newAmount",type:"number",step:"0.01",min:"0",value:A,onChange:E=>T(E.target.value),placeholder:"أدخل المبلغ الجديد",className:"text-right",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"pin",className:"text-right",children:"الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"pin",type:g?"text":"password",value:B,onChange:E=>C(E.target.value),placeholder:"أدخل الرقم السري",className:"text-right pr-10",required:!0}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>y(!g),children:g?e.jsx(Xt,{className:"h-4 w-4"}):e.jsx(Nt,{className:"h-4 w-4"})})]})]}),P&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-red-600 bg-red-50 p-2 rounded",children:[e.jsx(Da,{className:"h-4 w-4"}),P]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(h,{type:"button",variant:"outline",onClick:re,className:"flex-1",children:"إلغاء"}),e.jsx(h,{type:"submit",disabled:M||!B||!A,className:"flex-1",children:M?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"جاري التحديث..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ja,{className:"h-4 w-4 mr-2"}),"تحديث الرصيد"]})})]})]})]})})}class wr{static getSecretKey(u){return u?`${this.SECRET_KEY_BASE}_${u}`:this.SECRET_KEY_BASE}static setSecretPin(u,o){const p=btoa(u);this.secretCache.set(this.getSecretKey(o),p)}static hasSecretPin(u){return this.secretCache.has(this.getSecretKey(u))}static verifySecretPin(u,o){const p=this.secretCache.get(this.getSecretKey(o));if(!p)return!1;try{return atob(p)===u}catch{return!1}}static clearSecretPin(u){this.secretCache.delete(this.getSecretKey(u))}}bi(wr,"SECRET_KEY_BASE","dashboard_secret_pin"),bi(wr,"secretCache",new Map);function Hm({open:i,onOpenChange:u,userId:o}){const[p,v]=n.useState(""),[j,s]=n.useState(""),[D,B]=n.useState(""),[C,A]=n.useState(!1),[T,g]=n.useState(!1),[y,P]=n.useState(!1),[q,M]=n.useState(""),[V,J]=n.useState(!1),{toast:re}=As(),E=wr.hasSecretPin(o),_=async ee=>{ee.preventDefault(),M(""),J(!0);try{if(!j||j.length<4){M("يجب أن يكون الرقم السري 4 أرقام على الأقل"),J(!1);return}if(j!==D){M("الرقم السري الجديد وتأكيده غير متطابقين"),J(!1);return}if(E){if(!p){M("يرجى إدخال الرقم السري الحالي"),J(!1);return}if(!wr.verifySecretPin(p,o)){M("الرقم السري الحالي غير صحيح"),J(!1);return}}wr.setSecretPin(j,o),re({title:E?"تم تغيير الرقم السري":"تم تعيين الرقم السري",description:E?"تم تغيير الرقم السري بنجاح":"تم تعيين الرقم السري بنجاح"}),oe()}catch{M("حدث خطأ أثناء حفظ الرقم السري")}finally{J(!1)}},oe=()=>{v(""),s(""),B(""),M(""),A(!1),g(!1),P(!1),u(!1)};return e.jsx(de,{open:i,onOpenChange:oe,children:e.jsxs(me,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(he,{children:e.jsxs(ue,{className:"flex items-center gap-2 text-right",children:[e.jsx(go,{className:"h-5 w-5"}),E?"تغيير الرقم السري":"تعيين الرقم السري"]})}),e.jsxs("form",{onSubmit:_,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:E?"أدخل الرقم السري الحالي والرقم السري الجديد لتغييره":"أدخل الرقم السري الجديد الذي تريد استخدامه في عمليات التعديل"}),E&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"currentPin",type:C?"text":"password",autoComplete:"off",value:p,onChange:ee=>v(ee.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>A(!C),children:C?e.jsx(Xt,{className:"h-4 w-4"}):e.jsx(Nt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"newPin",type:T?"text":"password",autoComplete:"off",value:j,onChange:ee=>s(ee.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>g(!T),children:T?e.jsx(Xt,{className:"h-4 w-4"}):e.jsx(Nt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"confirmPin",type:y?"text":"password",autoComplete:"off",value:D,onChange:ee=>B(ee.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>P(!y),children:y?e.jsx(Xt,{className:"h-4 w-4"}):e.jsx(Nt,{className:"h-4 w-4"})})]})]}),q&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(Da,{className:"h-4 w-4"}),q]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(h,{type:"submit",disabled:V,className:"flex-1",children:[e.jsx(ja,{className:"h-4 w-4 mr-2"}),V?"جاري الحفظ...":E?"تغيير الرقم السري":"تعيين الرقم السري"]}),e.jsx(h,{type:"button",variant:"outline",onClick:oe,disabled:V,children:"إلغاء"})]})]})]})})}const Si=new Map;function Gm({open:i,onOpenChange:u,userId:o}){const[p,v]=n.useState(""),[j,s]=n.useState(""),[D,B]=n.useState(""),[C,A]=n.useState(!1),[T,g]=n.useState(!1),[y,P]=n.useState(!1),[q,M]=n.useState(""),[V,J]=n.useState(!1),{toast:re}=As(),E=o?`cash_drawer_pin_${o}`:"cash_drawer_pin",_=()=>Si.has(E),oe=te=>{const ye=Si.get(E);if(!ye)return!1;try{return atob(ye)===te}catch{return!1}},ee=te=>{const ye=btoa(te);Si.set(E,ye)},fe=async te=>{te.preventDefault(),M(""),J(!0);try{if(!j||j.length<4){M("يجب أن يكون الرقم السري 4 أرقام على الأقل"),J(!1);return}if(j!==D){M("الرقم السري الجديد وتأكيده غير متطابقين"),J(!1);return}if(_()){if(!p){M("يرجى إدخال الرقم السري الحالي لدرج النقدية"),J(!1);return}if(!oe(p)){M("الرقم السري الحالي لدرج النقدية غير صحيح"),J(!1);return}}ee(j),re({title:_()?"تم تغيير رقم درج النقدية":"تم تعيين رقم درج النقدية",description:_()?"تم تغيير الرقم السري لدرج النقدية بنجاح":"تم تعيين الرقم السري لدرج النقدية بنجاح"}),se()}catch{M("حدث خطأ أثناء حفظ الرقم السري لدرج النقدية")}finally{J(!1)}},se=()=>{v(""),s(""),B(""),M(""),A(!1),g(!1),P(!1),u(!1)};return e.jsx(de,{open:i,onOpenChange:se,children:e.jsxs(me,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(he,{children:e.jsxs(ue,{className:"flex items-center gap-2 text-right",children:[e.jsx(At,{className:"h-5 w-5 text-green-600"}),_()?"تغيير رقم درج النقدية":"تعيين رقم درج النقدية"]})}),e.jsxs("form",{onSubmit:fe,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:_()?"أدخل الرقم السري الحالي والرقم السري الجديد لدرج النقدية":"أدخل الرقم السري الجديد الذي تريد استخدامه لحماية درج النقدية"}),_()&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي لدرج النقدية"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"currentPin",type:C?"text":"password",autoComplete:"off",value:p,onChange:te=>v(te.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>A(!C),children:C?e.jsx(Xt,{className:"h-4 w-4"}):e.jsx(Nt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد لدرج النقدية"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"newPin",type:T?"text":"password",autoComplete:"off",value:j,onChange:te=>s(te.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>g(!T),children:T?e.jsx(Xt,{className:"h-4 w-4"}):e.jsx(Nt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"confirmPin",type:y?"text":"password",autoComplete:"off",value:D,onChange:te=>B(te.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>P(!y),children:y?e.jsx(Xt,{className:"h-4 w-4"}):e.jsx(Nt,{className:"h-4 w-4"})})]})]}),q&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(Da,{className:"h-4 w-4"}),q]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(h,{type:"submit",disabled:V,className:"flex-1 bg-green-600 hover:bg-green-700",children:[e.jsx(ja,{className:"h-4 w-4 mr-2"}),V?"جاري الحفظ...":_()?"تغيير رقم درج النقدية":"تعيين رقم درج النقدية"]}),e.jsx(h,{type:"button",variant:"outline",onClick:se,disabled:V,children:"إلغاء"})]})]}),e.jsx("div",{className:"text-xs text-gray-500 text-center mt-2",children:"💰 هذا الرقم السري خاص بحماية درج النقدية فقط"})]})})}const Di=new Map;function Qm({open:i,onOpenChange:u,userId:o}){const[p,v]=n.useState(""),[j,s]=n.useState(""),[D,B]=n.useState(""),[C,A]=n.useState(!1),[T,g]=n.useState(!1),[y,P]=n.useState(!1),[q,M]=n.useState(""),[V,J]=n.useState(!1),{toast:re}=As(),E=o?`wallet_total_pin_${o}`:"wallet_total_pin",_=()=>Di.has(E),oe=te=>{const ye=Di.get(E);if(!ye)return!1;try{return atob(ye)===te}catch{return!1}},ee=te=>{const ye=btoa(te);Di.set(E,ye)},fe=async te=>{te.preventDefault(),M(""),J(!0);try{if(!j||j.length<4){M("يجب أن يكون الرقم السري 4 أرقام على الأقل"),J(!1);return}if(j!==D){M("الرقم السري الجديد وتأكيده غير متطابقين"),J(!1);return}if(_()){if(!p){M("يرجى إدخال الرقم السري الحالي لإجمالي المحفظة"),J(!1);return}if(!oe(p)){M("الرقم السري الحالي لإجمالي المحفظة غير صحيح"),J(!1);return}}ee(j),re({title:_()?"تم تغيير رقم إجمالي المحفظة":"تم تعيين رقم إجمالي المحفظة",description:_()?"تم تغيير الرقم السري لإجمالي المحفظة بنجاح":"تم تعيين الرقم السري لإجمالي المحفظة بنجاح"}),se()}catch{M("حدث خطأ أثناء حفظ الرقم السري لإجمالي المحفظة")}finally{J(!1)}},se=()=>{v(""),s(""),B(""),M(""),A(!1),g(!1),P(!1),u(!1)};return e.jsx(de,{open:i,onOpenChange:se,children:e.jsxs(me,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(he,{children:e.jsxs(ue,{className:"flex items-center gap-2 text-right",children:[e.jsx(Ls,{className:"h-5 w-5 text-blue-600"}),_()?"تغيير رقم إجمالي المحفظة":"تعيين رقم إجمالي المحفظة"]})}),e.jsxs("form",{onSubmit:fe,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:_()?"أدخل الرقم السري الحالي والرقم السري الجديد لإجمالي المحفظة":"أدخل الرقم السري الجديد الذي تريد استخدامه لحماية إجمالي المحفظة"}),_()&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي لإجمالي المحفظة"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"currentPin",type:C?"text":"password",autoComplete:"off",value:p,onChange:te=>v(te.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>A(!C),children:C?e.jsx(Xt,{className:"h-4 w-4"}):e.jsx(Nt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد لإجمالي المحفظة"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"newPin",type:T?"text":"password",autoComplete:"off",value:j,onChange:te=>s(te.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>g(!T),children:T?e.jsx(Xt,{className:"h-4 w-4"}):e.jsx(Nt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"confirmPin",type:y?"text":"password",autoComplete:"off",value:D,onChange:te=>B(te.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>P(!y),children:y?e.jsx(Xt,{className:"h-4 w-4"}):e.jsx(Nt,{className:"h-4 w-4"})})]})]}),q&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(Da,{className:"h-4 w-4"}),q]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(h,{type:"submit",disabled:V,className:"flex-1 bg-blue-600 hover:bg-blue-700",children:[e.jsx(ja,{className:"h-4 w-4 mr-2"}),V?"جاري الحفظ...":_()?"تغيير رقم إجمالي المحفظة":"تعيين رقم إجمالي المحفظة"]}),e.jsx(h,{type:"button",variant:"outline",onClick:se,disabled:V,children:"إلغاء"})]})]}),e.jsx("div",{className:"text-xs text-gray-500 text-center mt-2",children:"💼 هذا الرقم السري خاص بحماية إجمالي المحفظة فقط"})]})})}function Zm({open:i,onOpenChange:u,onSuccess:o,title:p,description:v,currentBalance:j,balanceLabel:s,userId:D}){const[B,C]=n.useState(""),[A,T]=n.useState(""),[g,y]=n.useState("add"),[P,q]=n.useState(!1),[M,V]=n.useState(""),[J,re]=n.useState(!1),[E,_]=n.useState(!1);n.useEffect(()=>{let se=!0;return(async()=>{const te=await ns.hasMasterPin(D);se&&_(te)})(),()=>{se=!1}},[D,i]);const oe=async se=>{se.preventDefault(),V(""),re(!0);try{const te=parseFloat(A);if(isNaN(te)||te<=0){V("يرجى إدخال مبلغ صحيح أكبر من صفر"),re(!1);return}if(g==="subtract"&&te>j){V("لا يمكن خصم مبلغ أكبر من الرصيد الحالي"),re(!1);return}if(E)if(await ns.verifyMasterPin(B,D)){const We=g==="add"?te:-te;ee(),o(We)}else V("الرقم السري غير صحيح");else V("لم يتم تعيين الرقم السري الرئيسي. يرجى تعيينه من إعدادات البروفيل أولاً")}catch{V("حدث خطأ أثناء التحقق من الرقم السري")}finally{re(!1)}},ee=()=>{C(""),T(""),y("add"),V(""),u(!1)},fe=()=>{const se=parseFloat(A)||0;return g==="add"?j+se:j-se};return e.jsx(de,{open:i,onOpenChange:ee,children:e.jsxs(me,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(he,{children:e.jsxs(ue,{className:"flex items-center gap-2 text-right",children:[g==="add"?e.jsx(as,{className:"h-5 w-5 text-green-600"}):e.jsx(Na,{className:"h-5 w-5 text-red-600"}),p]})}),e.jsxs("form",{onSubmit:oe,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:v}),e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg",children:[e.jsxs(H,{className:"text-sm font-medium text-gray-700",children:[s," الحالي"]}),e.jsxs("div",{className:"text-lg font-bold text-gray-900 mt-1",children:[j.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{className:"text-right",children:"نوع العملية"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(h,{type:"button",variant:g==="add"?"default":"outline",onClick:()=>y("add"),className:"flex-1 flex items-center gap-2",children:[e.jsx(as,{className:"h-4 w-4"}),"إضافة"]}),e.jsxs(h,{type:"button",variant:g==="subtract"?"default":"outline",onClick:()=>y("subtract"),className:"flex-1 flex items-center gap-2",children:[e.jsx(Na,{className:"h-4 w-4"}),"خصم"]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(H,{htmlFor:"amount",className:"text-right",children:["المبلغ المراد ",g==="add"?"إضافته":"خصمه"]}),e.jsx(U,{id:"amount",type:"number",step:"0.01",min:"0.01",value:A,onChange:se=>T(se.target.value),placeholder:`أدخل المبلغ المراد ${g==="add"?"إضافته":"خصمه"}`,className:"text-right",required:!0})]}),A&&!isNaN(parseFloat(A))&&e.jsxs("div",{className:`p-3 rounded-lg ${g==="add"?"bg-green-50 border border-green-200":"bg-red-50 border border-red-200"}`,children:[e.jsx(H,{className:"text-sm font-medium text-gray-700",children:"الرصيد الجديد المتوقع"}),e.jsxs("div",{className:`text-lg font-bold mt-1 ${g==="add"?"text-green-700":"text-red-700"}`,children:[fe().toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"pin",className:"text-right",children:"الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"pin",type:P?"text":"password",autoComplete:"off",value:B,onChange:se=>C(se.target.value),placeholder:"أدخل الرقم السري",className:"text-right pr-10",required:!0}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>q(!P),children:P?e.jsx(Xt,{className:"h-4 w-4"}):e.jsx(Nt,{className:"h-4 w-4"})})]})]}),M&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-red-600 bg-red-50 p-2 rounded",children:[e.jsx(Da,{className:"h-4 w-4"}),M]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(h,{type:"button",variant:"outline",onClick:ee,className:"flex-1",children:"إلغاء"}),e.jsx(h,{type:"submit",disabled:J||!B||!A,className:`flex-1 ${g==="add"?"bg-green-600 hover:bg-green-700":"bg-red-600 hover:bg-red-700"}`,children:J?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"جاري التحديث..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ja,{className:"h-4 w-4 mr-2"}),g==="add"?"إضافة المبلغ":"خصم المبلغ"]})})]})]})]})})}const mo={BASE_URL:"./",DEV:!1,MODE:"production",PROD:!0,SSR:!1,VITE_APP_VERSION:"0.0.0",VITE_DEV_MODE:"true",VITE_ENABLE_OFFLINE_PERSISTENCE:"false",VITE_FIREBASE_API_KEY:"AIzaSyA33RTf43u2QE2OsK1RepQHSKrSet9ZI0s",VITE_FIREBASE_APP_ID:"1:483702062341:web:b1ff06ad175cb7ae428b6c",VITE_FIREBASE_AUTH_DOMAIN:"voda-c6abd.firebaseapp.com",VITE_FIREBASE_AUTH_EMULATOR_URL:"http://localhost:9099",VITE_FIREBASE_FIRESTORE_EMULATOR_HOST:"localhost:8080",VITE_FIREBASE_FUNCTIONS_EMULATOR_HOST:"localhost:5001",VITE_FIREBASE_MEASUREMENT_ID:"G-CV6QGH7G7P",VITE_FIREBASE_MESSAGING_SENDER_ID:"483702062341",VITE_FIREBASE_PROJECT_ID:"voda-c6abd",VITE_FIREBASE_STORAGE_BUCKET:"voda-c6abd.appspot.com",VITE_FORCE_HASH_ROUTER:"true",VITE_SHOP_ID:"demo-shop-001",VITE_SHOP_NAME:"محل كاشي لينك التجريبي",VITE_SHOW_ENV_BANNER:"true",VITE_USE_EMULATORS:"false",VITE_USE_FIREBASE_EMULATOR:"false"},sa=i=>typeof i=="string"&&i.trim().length>0,Xm={getCurrentMonthId(){const i=new Date;return`${i.getFullYear()}-${String(i.getMonth()+1).padStart(2,"0")}`},async getWalletUsage(i){var u;try{if(!sa(i))return console.error("Error getting wallet usage: invalid walletId",i),null;const o=ze(K,"walletLimits",i),p=await ca(o);if(p.exists()){const j=p.data();return{walletId:i,used_transfer:j.monthlyTransferUsed??j.used_transfer??0,used_withdraw:j.monthlyWithdrawUsed??j.used_withdraw??0,monthly_limit:j.monthlyLimit??j.monthlyTransferLimit??j.monthlyWithdrawLimit??2e5,last_reset:j.lastMonthlyReset??j.last_reset??null,updatedAt:j.updatedAt||ba.now()}}const v={walletId:i,used_transfer:0,used_withdraw:0,monthly_limit:2e5,last_reset:null,updatedAt:ba.now()};return await Ds(o,{monthlyTransferUsed:0,monthlyWithdrawUsed:0,monthlyTransferLimit:2e5,monthlyWithdrawLimit:2e5,lastMonthlyReset:null,updatedAt:Ge(),ownerId:(u=Ba.currentUser)==null?void 0:u.uid}),v}catch(o){return console.error("Error getting wallet usage:",o),{walletId:i,used_transfer:0,used_withdraw:0,monthly_limit:2e5,last_reset:null,updatedAt:ba.now()}}},shouldResetLimits(i){const u=new Date,o=u.getDate();if(!i)return!0;if(o===1){const p=i.toDate(),v=u.getMonth(),j=u.getFullYear();return p.getMonth()!==v||p.getFullYear()!==j}return!1},async autoResetLimitsIfNeeded(i){try{if(!sa(i))return console.error("خطأ في التصفير التلقائي للحدود: walletId غير صالح",i),!1;typeof import.meta<"u";const u=await this.getWalletUsage(i);return u&&this.shouldResetLimits(u.last_reset)?(console.log(`🔄 تصفير تلقائي للحدود للمحفظة ${i} - اليوم الأول من الشهر`),await this.resetWalletUsage(i)):!1}catch(u){return console.error("خطأ في التصفير التلقائي للحدود:",u),!1}},async resetWalletUsage(i){try{if(!sa(i))return console.error("خطأ في تصفير استخدام المحفظة: walletId غير صالح",i),!1;const u=ze(K,"walletLimits",i);return await Ds(u,{monthlyTransferUsed:0,monthlyWithdrawUsed:0,lastMonthlyReset:Ge(),updatedAt:Ge()},{merge:!0}),console.log(`🔄 تم تصفير استخدام المحفظة ${i} بنجاح`),!0}catch(u){return console.error("خطأ في تصفير استخدام المحفظة:",u),!1}},async calculateUsageFromTransactions(i){var u,o;try{if(!sa(i))return console.error("خطأ في حساب الاستخدام من المعاملات: walletId غير صالح",i),{used_transfer:0,used_withdraw:0};const p=ze(K,"walletLimits",i),v=new Date;let j=ba.fromDate(new Date(v.getFullYear(),v.getMonth(),1));try{const A=await ca(p);j=A.exists()?((u=A.data())==null?void 0:u.lastMonthlyReset)??((o=A.data())==null?void 0:o.last_reset)??j:j}catch{}const s=ot(Ee(K,"tx"),De("uid","==",i),...j?[De("createdAt",">=",j)]:[]),D=await ut(s);let B=0,C=0;return D.forEach(A=>{const T=A.data();T.status==="completed"&&(T.type==="transfer"?B+=T.amount:T.type==="withdraw"&&(C+=T.amount))}),{used_transfer:B,used_withdraw:C}}catch(p){return console.error("خطأ في حساب الاستخدام من المعاملات:",p),{used_transfer:0,used_withdraw:0}}},async getWalletUsageWithRefresh(i){var u,o;try{if(!sa(i))return console.error("خطأ في الحصول على الاستخدام مع التحديث: walletId غير صالح",i),null;typeof import.meta<"u";const p=await this.getWalletUsage(i);if(!p){const j=await this.calculateUsageFromTransactions(i),s=ze(K,"walletLimits",i);try{await Ds(s,{monthlyTransferUsed:j.used_transfer,monthlyWithdrawUsed:j.used_withdraw,updatedAt:Ge(),ownerId:(u=Ba.currentUser)==null?void 0:u.uid},{merge:!0})}catch{}return{walletId:i,used_transfer:j.used_transfer,used_withdraw:j.used_withdraw,monthly_limit:2e5,last_reset:null,updatedAt:ba.now()}}const v=await this.calculateUsageFromTransactions(i);if(p.used_transfer!==v.used_transfer||p.used_withdraw!==v.used_withdraw){const j=ze(K,"walletLimits",i);try{await Ds(j,{monthlyTransferUsed:v.used_transfer,monthlyWithdrawUsed:v.used_withdraw,updatedAt:Ge(),ownerId:(o=Ba.currentUser)==null?void 0:o.uid},{merge:!0})}catch{}return await this.getWalletUsage(i)}return p}catch(p){return console.error("خطأ في الحصول على الاستخدام مع التحديث:",p),{walletId:i,used_transfer:0,used_withdraw:0,monthly_limit:2e5,last_reset:null,updatedAt:ba.now()}}},calculateRemaining(i){return{remainingTransfer:Math.max(0,i.monthly_limit-i.used_transfer),remainingWithdraw:Math.max(0,i.monthly_limit-i.used_withdraw)}},async canPerformOperation(i,u,o){try{if(!sa(i))return console.error("Error checking operation limits: invalid walletId",i),{canPerform:!1,message:"walletId غير صالح"};const p=await this.getWalletUsageWithRefresh(i);if(!p)return{canPerform:!1,message:"لا يمكن العثور على بيانات الاستخدام للمحفظة"};const v=this.calculateRemaining(p);return o==="transfer"&&u>v.remainingTransfer?{canPerform:!1,message:`تجاوز حد التحويل المسموح. المتبقي: ${v.remainingTransfer.toLocaleString()} ج.م من أصل ${p.monthly_limit.toLocaleString()} ج.م`,remaining:v.remainingTransfer}:o==="withdraw"&&u>v.remainingWithdraw?{canPerform:!1,message:`تجاوز حد السحب المسموح. المتبقي: ${v.remainingWithdraw.toLocaleString()} ج.م من أصل ${p.monthly_limit.toLocaleString()} ج.م`,remaining:v.remainingWithdraw}:{canPerform:!0}}catch(p){return console.error("Error checking operation limits:",p),{canPerform:!1,message:"خطأ في التحقق من الحدود"}}},async updateUsage(i,u,o){var p;try{if(!sa(i))throw new Error("walletId غير صالح");const v=await this.getWalletUsageWithRefresh(i);if(!v)throw new Error("لا يمكن العثور على بيانات الاستخدام للمحفظة");const j=await this.canPerformOperation(i,u,o);if(!j.canPerform)throw new Error(j.message||"لا يمكن إجراء العملية");const s=o==="transfer"?v.used_transfer+u:v.used_transfer,D=o==="withdraw"?v.used_withdraw+u:v.used_withdraw,B=ze(K,"walletLimits",v.walletId);try{await Ds(B,{monthlyTransferUsed:s,monthlyWithdrawUsed:D,updatedAt:Ge(),ownerId:(p=Ba.currentUser)==null?void 0:p.uid},{merge:!0})}catch{}let C=await this.getWalletUsageWithRefresh(i);return C||(C={walletId:i,used_transfer:s,used_withdraw:D,monthly_limit:v.monthly_limit,last_reset:v.last_reset,updatedAt:ba.now()}),C}catch(v){throw console.error("Error updating wallet usage:",v),v}},async resetWalletUsageManually(i){try{if(!sa(i))throw new Error("walletId غير صالح");const u=ze(K,"walletLimits",i),o={walletId:i,used_transfer:0,used_withdraw:0,monthly_limit:0,last_reset:null,updatedAt:new Date};return Ds(u,{monthlyTransferUsed:0,monthlyWithdrawUsed:0,lastMonthlyReset:Ge(),updatedAt:Ge()},{merge:!0}).catch(p=>{console.error("خطأ في حفظ تصفير الاستخدام في Firebase:",p)}),console.log(`✅ تم تصفير استخدام المحفظة ${i} بنجاح`),o}catch(u){throw console.error("Error resetting wallet usage:",u),u}},async getAllWalletsUsage(i){try{const o=(await Es.getByMerchantId(i)).map(v=>this.getWalletUsageWithRefresh(v.id));return(await Promise.all(o)).filter(v=>v!==null)}catch(u){return console.error("Error getting all wallets usage:",u),[]}}};function eh(i){return i?`readBroadcastIds_${i}`:"readBroadcastIds_guest"}function th({className:i}){const{user:u,profile:o,isSubscriptionActive:p}=$s(),v=yo(),[j,s]=n.useState([]),[D,B]=n.useState(new Set),[C,A]=n.useState(!1),[T,g]=n.useState(""),[y,P]=n.useState(!1),[q,M]=n.useState(null),[V,J]=n.useState("none"),[re,E]=n.useState(null),[_,oe]=n.useState(!1);n.useRef(new Set),n.useRef(!1);const ee=n.useRef(null),fe=n.useRef(null);n.useRef(null);const[se,te]=n.useState({position:"fixed",top:0,left:0,zIndex:1e4}),ye=!1,We=n.useMemo(()=>{const Q=["global"];return u!=null&&u.uid&&Q.push(`user:${u.uid}`),o!=null&&o.shopId&&Q.push(`shop:${o.shopId}`),Q},[u==null?void 0:u.uid,o==null?void 0:o.shopId]),we=eh(u==null?void 0:u.uid),Te=n.useMemo(()=>{var Ze;const Q=(Ze=v==null?void 0:v.pathname)==null?void 0:Ze.includes("/user/pending-approval");return!!(u!=null&&u.uid)&&!Q},[u==null?void 0:u.uid,v==null?void 0:v.pathname]);n.useEffect(()=>{try{const Q=localStorage.getItem(we);if(Q){const Ne=JSON.parse(Q);Array.isArray(Ne)&&B(new Set(Ne.filter(Boolean)))}else B(new Set)}catch(Q){console.warn("Failed to load read ids",Q),B(new Set)}},[we]),n.useEffect(()=>{if(!Te){s([]);return}const Q=Cm(We,Ne=>{s(Ne)});return()=>Q()},[We,Te]),n.useEffect(()=>{},[j]),n.useEffect(()=>()=>{ee.current&&clearTimeout(ee.current)},[]);const Me=j.reduce((Q,Ne)=>Q+(Ne.id&&!D.has(Ne.id)?1:0),0),et=Q=>{if(!Q||D.has(Q))return;const Ne=new Set(D);Ne.add(Q),B(Ne);try{localStorage.setItem(we,JSON.stringify(Array.from(Ne)))}catch{}},G=()=>{const Q=j.map(Ze=>Ze.id).filter(Boolean),Ne=new Set(D);Q.forEach(Ze=>Ne.add(Ze)),B(Ne);try{localStorage.setItem(we,JSON.stringify(Array.from(Ne)))}catch{}},ne=(Q,Ne)=>{Q&&window.open(Q,"_blank"),Ne&&et(Ne)};n.useEffect(()=>{},[_]);const Qe=async()=>{if(!(u!=null&&u.uid)){alert("يرجى تسجيل الدخول لإرسال الطلب.");return}const Q=T.trim();if(!Q){alert("يرجى كتابة سبب طلب التحدث.");return}try{P(!0),M(null);const Ne=o!=null&&o.fullName&&o.fullName.trim()?o.fullName.trim():u.email?u.email.split("@")[0]:"مستخدم",Ze=(o==null?void 0:o.phone)||null;await Is(Ee(K,"waiting_list"),{userId:u.uid,name:Ne,phone:Ze,reason:Q,status:"pending",createdAt:Ge()}),M("تم إرسال طلبك إلى قائمة الانتظار بنجاح ✅"),g(""),setTimeout(()=>A(!1),900)}catch(Ne){console.error("فشل إرسال طلب قائمة الانتظار:",Ne),alert("حدث خطأ أثناء إرسال الطلب. حاول مرة أخرى.")}finally{P(!1)}};return n.useEffect(()=>{if(!(u!=null&&u.uid)){J("none");return}let Q=null;try{const Ne=ot(Ee(K,"waiting_list"),De("userId","==",u.uid));Q=Rs(Ne,Ze=>{const es=Ze.docs.map(Ie=>({id:Ie.id,...Ie.data()})).sort((Ie,Le)=>{var xe,Ye,Tt,vt,W,ae;const ct=((Ye=(xe=Ie==null?void 0:Ie.createdAt)==null?void 0:xe.toMillis)==null?void 0:Ye.call(xe))??((Tt=Ie==null?void 0:Ie.createdAt)==null?void 0:Tt.seconds)*1e3??0;return(((W=(vt=Le==null?void 0:Le.createdAt)==null?void 0:vt.toMillis)==null?void 0:W.call(vt))??((ae=Le==null?void 0:Le.createdAt)==null?void 0:ae.seconds)*1e3??0)-ct});if(es.length===0){J("none");return}const Re=es[0],nt=(Re==null?void 0:Re.contacted)===!0||(Re==null?void 0:Re.status)==="contacted";J(nt?"contacted":"pending")})}catch(Ne){console.warn("⚠️ فشل الاشتراك في waiting_list للمستخدم:",Ne),J("none")}return()=>{Q&&Q()}},[u==null?void 0:u.uid]),Te?e.jsxs("div",{className:`relative inline-flex items-center gap-2 ${i||""}`,ref:fe,children:[e.jsxs(Tm,{onOpenChange:Q=>{Q&&Me>0&&G()},children:[e.jsx(Pm,{asChild:!0,children:e.jsx(h,{variant:"ghost",className:"relative h-8 w-8 rounded-full p-0 hover:bg-transparent focus:ring-1 focus:ring-primary focus:ring-offset-1 transition-all",title:"الإشعارات",children:e.jsxs("div",{className:"relative h-8 w-8 rounded-full bg-primary/10 flex items-center justify-center border border-border shadow-sm hover:shadow-md",children:[e.jsx(lo,{className:"h-4 w-4 text-primary"}),Me>0&&e.jsx("span",{className:"absolute -top-1 -right-1 min-w-[18px] h-[18px] px-1 rounded-full bg-red-500 text-white text-[10px] font-bold flex items-center justify-center shadow",children:Me})]})})}),e.jsxs(km,{className:"w-80",align:"end",forceMount:!0,children:[e.jsxs(Om,{className:"flex items-center justify-between",children:[e.jsx("span",{children:"الإشعارات"}),j.length>0&&e.jsxs(h,{variant:"outline",size:"sm",className:"h-7 text-xs",onClick:G,children:[e.jsx(ma,{className:"h-3 w-3 mr-1"}),"تمييز الكل كمقروء"]})]}),e.jsx(Em,{}),j.length===0?e.jsx("div",{className:"p-3 text-sm text-muted-foreground",children:"لا توجد إشعارات حالياً"}):e.jsx("div",{className:"max-h-64 overflow-y-auto pr-1",children:j.map(Q=>{const Ne=Q.id?!D.has(Q.id):!1;return e.jsx("div",{className:`px-2 py-2 rounded-md ${Ne?"bg-primary/5":""}`,children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(lo,{className:`h-4 w-4 ${Ne?"text-primary":"text-muted-foreground"}`}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-sm font-medium",children:Q.title||"إشعار"}),e.jsx("div",{className:"text-xs text-muted-foreground whitespace-pre-line",children:Q.message}),Q.linkUrl&&e.jsxs(h,{variant:"link",className:"px-0 h-6 text-xs",onClick:()=>ne(Q.linkUrl,Q.id),children:["فتح الرابط ",e.jsx(Im,{className:"h-3 w-3 ml-1"})]})]}),Ne?e.jsx(h,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>et(Q.id),title:"تمييز كمقروء",children:e.jsx(ma,{className:"h-4 w-4 text-primary"})}):e.jsx(h,{variant:"ghost",size:"icon",className:"h-6 w-6",disabled:!0,title:"مقروء",children:e.jsx(ma,{className:"h-4 w-4 text-muted-foreground"})})]})},Q.id)})})]})]}),e.jsxs(de,{open:C,onOpenChange:A,children:[e.jsx(cm,{asChild:!0,children:e.jsx(h,{variant:"ghost",size:"icon",className:"h-8 w-8 rounded-full hover:bg-transparent focus:ring-1 focus:ring-primary/60 focus:ring-offset-1",title:"قائمة الانتظار",children:e.jsx(Qs,{className:`h-4 w-4 ${V==="pending"?"text-red-600":V==="contacted"?"text-green-600":"text-muted-foreground"}`})})}),e.jsxs(me,{className:"max-w-md border border-purple-200/50 shadow-xl bg-gradient-to-br from-purple-50 to-blue-50",children:[e.jsxs(he,{children:[e.jsx(ue,{children:"طلب التحدث"}),e.jsx(ss,{children:"يرجى كتابة سبب طلب التحدث ليصل للإدارة في قسم قائمة الانتظار."})]}),e.jsxs("div",{className:"grid gap-3",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"سبب الطلب"}),e.jsx(Am,{value:T,onChange:Q=>g(Q.target.value),placeholder:"اكتب سبب طلب التحدث هنا...",className:"min-h-[120px] text-right"}),q&&e.jsx("div",{className:"text-sm text-green-700 bg-green-50 border border-green-200 rounded-md p-2",children:q})]}),e.jsxs(rt,{children:[e.jsx(h,{variant:"outline",onClick:()=>A(!1),disabled:y,children:"إلغاء"}),e.jsx(h,{onClick:Qe,disabled:y,className:"bg-gradient-to-r from-green-600 to-emerald-600 text-white",children:y?"جارٍ الإرسال...":"إرسال"})]})]})]}),ye]}):null}const ho=({isOpen:i,onClose:u,onTrialStarted:o})=>{const{user:p}=$s(),[v,j]=n.useState(!1),[s,D]=n.useState(!1),[B,C]=n.useState(""),[A,T]=n.useState(24);n.useEffect(()=>{const P=async()=>{if(p!=null&&p.uid){const M=await vr.getTrialData(p.uid);D(M.hasUsedFreeTrial)}},q=async()=>{try{const M=await vr.getTrialDurationHours();T(M)}catch{}};i&&(P(),q())},[i,p]);const g=async()=>{if(p!=null&&p.uid){j(!0);try{const P=await vr.startFreeTrial(p.uid);P.success?(C(P.message),window.location.href="/user/dashboard"):C(P.message||"تعذر تفعيل التجربة المجانية")}catch{C("حدث خطأ أثناء تفعيل التجربة المجانية")}finally{j(!1)}}},y=async()=>{if(p!=null&&p.uid){j(!0);try{await Qd(p.uid,Fs.ZERO,p.uid),window.location.href="/user/dashboard"}catch{C("حدث خطأ أثناء تفعيل باقة الزيرو")}finally{j(!1)}}};return e.jsxs(e.Fragment,{children:[i&&e.jsx("div",{className:"fixed inset-0 z-40",style:{background:"rgba(0, 0, 0, 0.15)",pointerEvents:"auto"}}),e.jsx(de,{open:i,onOpenChange:()=>{},children:e.jsxs(me,{className:"sm:max-w-lg z-50 border-0 shadow-2xl",style:{position:"fixed",top:"50%",left:"50%",transform:"translate(-50%, -50%)",pointerEvents:"auto",background:"linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 0.95) 100%)",borderRadius:"20px",border:"1px solid rgba(255, 255, 255, 0.3)"},children:[e.jsxs(he,{className:"text-center pb-0 pt-0",children:[e.jsx("div",{className:"flex justify-center mb-1",children:e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-0 rounded-full",style:{background:"linear-gradient(135deg, #f59e0b, #d97706)",filter:"blur(8px)",opacity:.3}}),e.jsx("div",{className:"relative bg-gradient-to-br from-orange-400 to-orange-600 p-2 rounded-full",children:e.jsx(wi,{className:"h-12 w-12 text-white"})})]})}),e.jsx(ue,{className:"text-2xl font-bold bg-gradient-to-r from-gray-800 to-gray-600 bg-clip-text text-transparent text-center mt-0 mb-0 leading-tight",children:"تفعيل الحساب مطلوب"})]}),e.jsxs("div",{className:"text-center pt-6 pb-0 px-2",children:[e.jsxs("div",{className:"bg-gradient-to-r from-orange-50 to-amber-50 rounded-xl p-6 mb-6 border border-orange-100",children:[e.jsx("p",{className:"text-gray-700 text-lg leading-relaxed font-medium",children:"حسابك في انتظار التفعيل من قبل المسؤول"}),e.jsx("p",{className:"text-sm font-semibold text-orange-700 mt-3 mb-3 bg-orange-100 p-3 rounded-lg border border-orange-200",children:"للتفعيل السريع: تواصل مع الإدارة عبر واتساب فقط على الرقم التالي"}),e.jsxs("div",{className:"bg-green-50 p-4 rounded-lg border border-green-200 mt-3",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"text-base font-bold text-green-700",children:"واتساب الإدارة:"}),e.jsx("a",{href:"https://wa.me/201000392539",target:"_blank",rel:"noopener noreferrer",className:"text-lg font-bold text-green-600 hover:text-green-700 underline",children:"01000392539"})]}),e.jsx("p",{className:"text-sm text-green-600 mt-2 text-center",children:"اضغط على الرقم للتواصل المباشر عبر واتساب"})]})]}),!s&&e.jsxs("div",{className:"bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-4 mb-4 border border-green-200",children:[e.jsxs("div",{className:"flex items-center justify-center mb-2",children:[e.jsx(wi,{className:"h-5 w-5 text-green-600 ml-2"}),e.jsx("span",{className:"text-green-700 font-semibold",children:"باقة الزيرو المجانية الدائمة"})]}),e.jsx("p",{className:"text-green-600 text-sm text-center",children:"فعل باقة الزيرو الان واستمتع ب 10 عمليات سحب وتحويل يوميا"})]}),B&&e.jsx("div",{className:`rounded-xl p-4 mb-4 text-center ${B.includes("تم تفعيل")?"bg-green-50 border border-green-200 text-green-700":"bg-red-50 border border-red-200 text-red-700"}`,children:e.jsx("p",{className:"font-medium",children:B})}),e.jsxs("div",{className:"flex items-center justify-center space-x-2 text-sm text-gray-500 mb-0",children:[e.jsxs("div",{className:"flex space-x-1",children:[e.jsx("div",{className:"w-2 h-2 bg-orange-400 rounded-full animate-pulse"}),e.jsx("div",{className:"w-2 h-2 bg-orange-400 rounded-full animate-pulse",style:{animationDelay:"0.2s"}}),e.jsx("div",{className:"w-2 h-2 bg-orange-400 rounded-full animate-pulse",style:{animationDelay:"0.4s"}})]}),e.jsx("span",{className:"mr-2",children:"في انتظار التفعيل"})]})]}),e.jsxs("div",{className:"flex flex-col space-y-3 pb-2",children:[!s&&!B.includes("تم تفعيل")&&e.jsxs(e.Fragment,{children:[e.jsxs(h,{onClick:g,disabled:v,className:"w-full max-w-2xl mx-auto relative bg-gradient-to-r from-blue-600 to-indigo-600 hover:brightness-110 text-white px-10 py-4 rounded-2xl font-bold text-xl ring-2 ring-blue-300 ring-offset-1 shadow-2xl hover:shadow-3xl transition-all duration-500 transform hover:scale-110 hover:-translate-y-1 disabled:opacity-50 disabled:cursor-not-allowed overflow-hidden group focus-visible:outline-none focus-visible:ring-4 focus-visible:ring-blue-300",style:{boxShadow:"0 15px 35px rgba(59, 130, 246, 0.4), 0 5px 15px rgba(0, 0, 0, 0.1)"},children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-white/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"}),e.jsx("div",{className:"absolute -top-1 -left-1 w-3 h-3 bg-yellow-400 rounded-full animate-ping"}),e.jsx("div",{className:"absolute -top-1 -right-1 w-2 h-2 bg-green-400 rounded-full animate-pulse"}),v?e.jsxs("div",{className:"flex items-center relative z-10",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-white ml-3"}),e.jsx("span",{className:"bg-gradient-to-r from-white to-gray-100 bg-clip-text text-transparent",children:"جاري التفعيل..."})]}):e.jsxs("div",{className:"flex items-center relative z-10",children:[e.jsx(_m,{className:"h-6 w-6 ml-3 animate-bounce"}),e.jsx("span",{className:"bg-gradient-to-r from-white to-gray-100 bg-clip-text text-transparent",children:`التجربة المجانية لمدة ${A} ${A>=3&&A<=10?"ساعات":A===2?"ساعتين":"ساعة"}`})]})]}),e.jsxs(h,{onClick:y,disabled:v,className:"w-full max-w-2xl mx-auto relative bg-gradient-to-r from-green-600 to-emerald-600 hover:brightness-110 text-white px-10 py-4 rounded-2xl font-bold text-xl ring-2 ring-emerald-300 ring-offset-1 shadow-2xl hover:shadow-3xl transition-all duration-500 transform hover:scale-110 hover:-translate-y-1 disabled:opacity-50 disabled:cursor-not-allowed overflow-hidden group focus-visible:outline-none focus-visible:ring-4 focus-visible:ring-emerald-300",style:{boxShadow:"0 15px 35px rgba(99, 102, 241, 0.4), 0 5px 15px rgba(0, 0, 0, 0.1)"},children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-white/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"}),e.jsx("div",{className:"absolute -top-1 -left-1 w-3 h-3 bg-yellow-400 rounded-full animate-ping"}),e.jsx("div",{className:"absolute -top-1 -right-1 w-2 h-2 bg-green-400 rounded-full animate-pulse"}),v?e.jsxs("div",{className:"flex items-center relative z-10",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-white ml-3"}),e.jsx("span",{className:"bg-gradient-to-r from-white to-gray-100 bg-clip-text text-transparent",children:"جاري التفعيل..."})]}):e.jsxs("div",{className:"flex items-center relative z-10",children:[e.jsx(wi,{className:"h-6 w-6 ml-3 animate-bounce"}),e.jsx("span",{className:"bg-gradient-to-r from-white to-gray-100 bg-clip-text text-transparent",children:"فعّل باقة الزيرو الآن"})]})]})]}),e.jsx(h,{onClick:u,variant:"outline",className:"border-2 border-gray-300 hover:border-gray-400 text-gray-700 hover:text-gray-800 px-10 py-3 rounded-xl font-semibold text-lg transition-all duration-300 transform hover:scale-105",children:s?"فهمت":"إغلاق"})]})]})})]})};function sh({isOpen:i,onClose:u}){const[o,p]=n.useState("0"),[v,j]=n.useState(null),[s,D]=n.useState(null),[B,C]=n.useState(!1),A=E=>{B?(p(E),C(!1)):p(o==="0"?E:o+E)},T=E=>{const _=parseFloat(o);if(v===null)j(_);else if(s){const ee=g(v||0,_,s);p(String(ee)),j(ee)}C(!0),D(E)},g=(E,_,oe)=>{switch(oe){case"+":return E+_;case"-":return E-_;case"×":return E*_;case"÷":return _===0?0:E/_;case"=":return _;default:return _}},y=()=>{const E=parseFloat(o);if(v!==null&&s){const _=g(v,E,s);p(String(_)),j(null),D(null),C(!0)}},P=()=>{p("0"),j(null),D(null),C(!1)},q=()=>{p("0")},M=()=>{B?(p("0."),C(!1)):o.indexOf(".")===-1&&p(o+".")},V=()=>{o!=="0"&&p(o.charAt(0)==="-"?o.slice(1):"-"+o)},J=()=>{const E=parseFloat(o);p(String(E/100))},re=E=>{const _=E.key;E.preventDefault(),_>="0"&&_<="9"?A(_):_==="+"?T("+"):_==="-"?T("-"):_==="*"?T("×"):_==="/"?T("÷"):_==="Enter"||_==="="?y():_==="Escape"||_==="c"||_==="C"?P():_==="Backspace"?q():_==="."?M():_==="%"&&J()};return n.useEffect(()=>(i?document.addEventListener("keydown",re):document.removeEventListener("keydown",re),()=>{document.removeEventListener("keydown",re)}),[i,o,v,s,B]),e.jsx(de,{open:i,onOpenChange:E=>!E&&u(),children:e.jsxs(me,{className:"sm:max-w-md",children:[e.jsx(he,{children:e.jsxs(ue,{className:"flex items-center gap-2 text-right",children:[e.jsx(Io,{className:"h-5 w-5"}),"آلة حاسبة"]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-gray-900 text-white p-4 rounded-lg text-right",children:e.jsx("div",{className:"text-3xl font-mono font-bold min-h-[3rem] flex items-center justify-end overflow-hidden",children:o})}),e.jsxs("div",{className:"grid grid-cols-4 gap-2",children:[e.jsx(h,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:P,children:"AC"}),e.jsx(h,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:q,children:"CE"}),e.jsx(h,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:J,children:"%"}),e.jsx(h,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>T("÷"),children:"÷"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>A("7"),children:"7"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>A("8"),children:"8"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>A("9"),children:"9"}),e.jsx(h,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>T("×"),children:"×"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>A("4"),children:"4"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>A("5"),children:"5"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>A("6"),children:"6"}),e.jsx(h,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>T("-"),children:"-"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>A("1"),children:"1"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>A("2"),children:"2"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>A("3"),children:"3"}),e.jsx(h,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>T("+"),children:"+"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50 col-span-2",onClick:()=>A("0"),children:"0"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:M,children:"."}),e.jsx(h,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:y,children:"="})]}),e.jsx(h,{variant:"outline",className:"w-full h-10 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:V,children:"+/-"})]})]})})}function ah({isOpen:i,onClose:u,initialBarcode:o}){const[p,v]=n.useState([]),[j,s]=n.useState({productName:"",price:"",wholesalePrice:"",quantity:"",barcode:"",serialNumber:""}),[D,B]=n.useState(!1),[C,A]=n.useState(null),{toast:T}=As(),{user:g,profile:y}=$s(),{isShiftActive:P,shiftUser:q}=jr(),{shopId:M}=yn(),[V,J]=n.useState([]),[re,E]=n.useState({}),[_,oe]=n.useState({}),[ee,fe]=n.useState({}),[se,te]=n.useState(""),[ye,We]=n.useState(!1),[we,Te]=n.useState({}),[Me,et]=n.useState(!1),[G,ne]=n.useState(!0),[Qe,Q]=n.useState(!1),Ne=qe.useRef(""),Ze=qe.useRef(0),[es,Re]=n.useState(0),[nt,Ie]=n.useState(0),[Le,ct]=n.useState(!1),[tt,xe]=n.useState(!0),[Ye,Tt]=n.useState(!1),[vt,W]=n.useState(!0),[ae,Fe]=n.useState(!0),[st,jt]=n.useState({}),[Kt,Dt]=n.useState(!1),[at,Ue]=n.useState("التحقق قبل العملية"),[xt,Et]=n.useState("أدخل الرقم السري الرئيسي للمتابعة"),_t=qe.useRef(null),Wt=(d,O,L)=>{Ue(d),Et(O),_t.current=L,Dt(!0)},[Pt,R]=n.useState(""),je=n.useMemo(()=>{const d=Pt.trim().toLowerCase();return d?V.filter(O=>O.name.toLowerCase().includes(d)):V},[V,Pt]),Pe=()=>new Date().toISOString().split("T")[0];n.useEffect(()=>{i&&(g!=null&&g.uid)&&(Ft(),tt||Yt())},[i,g==null?void 0:g.uid,tt]),n.useEffect(()=>{if(!(!i||!(g!=null&&g.uid)))try{const d=Pe(),O=new Intl.DateTimeFormat("en-CA",{timeZone:"Africa/Cairo"}).format(new Date),L=k=>{try{const X=k.docs.map(ve=>{const ce=ve.data();return{id:String(ce.clientId||ve.id),productName:String(ce.productName||""),price:Number(ce.sellingPrice||0),wholesalePrice:typeof ce.wholesalePrice=="number"?ce.wholesalePrice:Number(ce.wholesalePrice||0),quantity:Number(ce.quantity||0),date:String(ce.date||d),time:String(ce.time||""),performedByType:ce.performedByType||void 0,performedByName:ce.performedByName||void 0,performedByUsername:ce.performedByUsername||null,serialNumber:ce.serialNumber||void 0,barcode:ce.barcode||void 0,firestoreId:ve.id}}).filter(ve=>{const ce=String((ve==null?void 0:ve.date)||"").slice(0,10);return ce===d||ce===O}),pe=(p||[]).filter(ve=>!ve.firestoreId),le={};[...X,...pe].forEach(ve=>{le[ve.id]=ve});const Ce=Object.values(le);it(Ce)}catch{}};let N;try{const k=M||(y==null?void 0:y.shopId)||null,Y=ot(Ee(K,"dailySales"),De("userId","==",g.uid),...k?[De("shopId","==",k)]:[]);N=Rs(Y,L,()=>{try{N&&N()}catch{}const X=ot(Ee(K,"users",g.uid,"dailySales"),...k?[De("shopId","==",k)]:[]);N=Rs(X,L)})}catch{const k=M||(y==null?void 0:y.shopId)||null,Y=ot(Ee(K,"users",g.uid,"dailySales"),...k?[De("shopId","==",k)]:[]);N=Rs(Y,L)}return()=>{try{N&&N()}catch{}}}catch{}},[i,g==null?void 0:g.uid]),n.useEffect(()=>{if(!i)return;const d=O=>{const L=Date.now();if(O.key==="Enter"){const N=(Ne.current||"").trim();Ne.current="",N&&ls(N);return}O.key.length===1&&(L-(Ze.current||0)>100&&(Ne.current=""),Ne.current+=O.key,Ze.current=L)};return window.addEventListener("keydown",d),()=>window.removeEventListener("keydown",d)},[i,V]),n.useEffect(()=>{i&&o&&ls(o)},[i,o]);const He=async()=>{if(g!=null&&g.uid)try{const d=y==null?void 0:y.shopId;let O,L=[];if(d){const N=ot(Ee(K,"products"),De("shopId","==",d),De("userId","==",g.uid));if(O=await ut(N),L=O.docs.map(k=>({id:k.id,name:String(k.data().name??""),sellingPrice:Number(k.data().sellingPrice??0),wholesalePrice:Number(k.data().wholesalePrice??0),quantity:Number(k.data().quantity??0),barcode:String(k.data().barcode??""),serialNumber:String(k.data().serialNumber??"")})),L.length===0){const k=ot(Ee(K,"products"),De("userId","==",g.uid)),X=(await ut(k)).docs.map(pe=>({id:pe.id,name:String(pe.data().name??""),sellingPrice:Number(pe.data().sellingPrice??0),wholesalePrice:Number(pe.data().wholesalePrice??0),quantity:Number(pe.data().quantity??0),barcode:String(pe.data().barcode??""),serialNumber:String(pe.data().serialNumber??"")}));X.length>0&&(L=X,T({title:"تم استرجاع المنتجات",description:"عثرنا على منتجات محفوظة لك خارج المتجر الحالي وقمنا بعرضها."}))}}else{const N=ot(Ee(K,"products"),De("userId","==",g.uid));O=await ut(N),L=O.docs.map(k=>({id:k.id,name:String(k.data().name??""),sellingPrice:Number(k.data().sellingPrice??0),wholesalePrice:Number(k.data().wholesalePrice??0),quantity:Number(k.data().quantity??0),barcode:String(k.data().barcode??""),serialNumber:String(k.data().serialNumber??"")}))}if(J(L),y!=null&&y.shopId&&L.length>0){const N=L.filter(k=>{const Y=((O==null?void 0:O.docs)||[]).find(pe=>pe.id===k.id);return!(!!Y&&!!Y.data().shopId)});if(N.length>0)try{await Promise.all(N.map(k=>Ms(ze(K,"products",k.id),{shopId:y.shopId,updatedAt:Ge()}))),T({title:"تم ترتيب المنتجات",description:"تم ربط بعض المنتجات غير المربوطة بمتجرك الحالي تلقائياً."})}catch(k){console.warn("تعذّر ترحيل shopId لبعض المنتجات:",k)}}}catch(d){console.error("Error loading shop products:",d)}};n.useEffect(()=>{i&&(g!=null&&g.uid)&&(He(),Yt(),Ft(),bs())},[i,g==null?void 0:g.uid,y==null?void 0:y.shopId]);const Oe=()=>{const d=new Date,O=d.getFullYear(),L=String(d.getMonth()+1).padStart(2,"0"),N=String(d.getDate()).padStart(2,"0");return`${O}-${L}-${N}`},Ft=()=>{if(!(g!=null&&g.uid)){console.log("No user authenticated, cannot load sales data");return}const d=M||(y==null?void 0:y.shopId)||"main",O=`salesData_all_${g.uid}_${d}`,L=localStorage.getItem(O);if(L)try{v(JSON.parse(L))}catch{}const N=Oe(),k=`salesData_${g.uid}_${d}_${N}`,Y=localStorage.getItem(k);if(Y){const Ce=JSON.parse(Y);v(Ce);try{localStorage.setItem(O,JSON.stringify(Ce))}catch{}}const X=new Date().toISOString().split("T")[0],pe=`salesData_${g.uid}_${d}_${X}`,le=localStorage.getItem(pe);if(le){const Ce=JSON.parse(le);v(Ce);try{localStorage.setItem(k,le),localStorage.setItem(O,le)}catch{}}v([]),Bt()},it=d=>{if(!(g!=null&&g.uid)){console.log("No user authenticated, cannot save sales data");return}const O=M||(y==null?void 0:y.shopId)||"main",L=Oe(),N=`salesData_${g.uid}_${O}_${L}`,k=`salesData_all_${g.uid}_${O}`;localStorage.setItem(N,JSON.stringify(d));try{const Y=localStorage.getItem(k),X=Y?JSON.parse(Y):[],pe={};[...Array.isArray(X)?X:[],...d].forEach(le=>{pe[le.id]=le}),localStorage.setItem(k,JSON.stringify(Object.values(pe)))}catch{}v(d)},Bt=async()=>{if(g!=null&&g.uid)try{const d=M||(y==null?void 0:y.shopId)||null,O=new Date().toISOString().split("T")[0],L=new Intl.DateTimeFormat("en-CA",{timeZone:"Africa/Cairo"}).format(new Date);let N,k;try{const ve=ot(Ee(K,"dailySales"),De("userId","==",g.uid),...d?[De("shopId","==",d)]:[]);N=await ut(ve)}catch{}try{const ve=ot(Ee(K,"users",g.uid,"dailySales"),...d?[De("shopId","==",d)]:[]);k=await ut(ve)}catch{}const pe=[...N?N.docs:[],...k?k.docs:[]].map(ve=>{const ce=ve.data();return{id:String(ce.clientId||ve.id),firestoreId:ve.id,productName:String(ce.productName||""),price:Number(ce.sellingPrice||0),wholesalePrice:ce.wholesalePrice!==void 0?Number(ce.wholesalePrice):null,quantity:Number(ce.quantity||0),date:String(ce.date||O),time:String(ce.time||""),serialNumber:ce.serialNumber||void 0,barcode:ce.barcode||void 0,performedByType:ce.performedByType||void 0,performedByName:ce.performedByName||void 0,performedByUsername:ce.performedByUsername||void 0}}).filter(ve=>{const ce=String((ve==null?void 0:ve.date)||"").slice(0,10);return ce===O||ce===L}),le={};[...p,...pe].forEach(ve=>{le[ve.id]=ve});const Ce=Object.values(le);it(Ce)}catch{}},Yt=async()=>{if(g!=null&&g.uid)try{const d=new Date,O=new Date(d.getFullYear(),d.getMonth(),1),L=new Date(d.getFullYear(),d.getMonth()+1,0),N=ve=>ve.toISOString().split("T")[0],k=N(O),Y=N(L),X=M||(y==null?void 0:y.shopId)||null;let pe;try{const ve=ot(Ee(K,"dailySales"),De("userId","==",g.uid),...X?[De("shopId","==",X)]:[]);pe=await ut(ve)}catch{const ve=ot(Ee(K,"users",g.uid,"dailySales"),...X?[De("shopId","==",X)]:[]);pe=await ut(ve)}let le=0,Ce=0;pe.forEach(ve=>{const ce=ve.data(),Ht=String(ce.date??"").slice(0,10);if(Ht>=k&&Ht<=Y){const ts=Number(ce.sellingPrice??0),_e=Number(ce.quantity??0),Ke=Number(ce.profit??(Number(ce.sellingPrice??0)-Number(ce.wholesalePrice??0))*_e);le+=ts*_e,Ce+=Ke}}),Re(le),Ie(Ce)}catch(d){console.error("Error loading monthly stats:",d)}},is=async d=>{if(!(g!=null&&g.uid))return null;try{const O=((d.price??0)-(d.wholesalePrice??0))*(d.quantity??0),L=P&&q?"cashier":"admin",N=L==="cashier"?(q==null?void 0:q.name)||"كاشير":(y==null?void 0:y.fullName)||(g==null?void 0:g.displayName)||"الحساب الرئيسي",k=L==="cashier"&&(q==null?void 0:q.username)||null,Y=await Is(Ee(K,"dailySales"),{userId:g.uid,clientId:d.id,productName:d.productName,quantity:d.quantity,wholesalePrice:d.wholesalePrice??null,sellingPrice:d.price,profit:O,date:d.date,time:d.time,performedByType:L,performedByName:N,performedByUsername:k,serialNumber:d.serialNumber??null,barcode:d.barcode??null,...y!=null&&y.shopId?{shopId:y.shopId}:M?{shopId:M}:{},createdAt:Ge()});try{await Ds(ze(K,"users",g.uid,"dailySales",Y.id),{userId:g.uid,clientId:d.id,productName:d.productName,quantity:d.quantity,wholesalePrice:d.wholesalePrice??null,sellingPrice:d.price,profit:O,date:d.date,time:d.time,performedByType:L,performedByName:N,performedByUsername:k,serialNumber:d.serialNumber??null,barcode:d.barcode??null,...y!=null&&y.shopId?{shopId:y.shopId}:M?{shopId:M}:{},createdAt:Ge()})}catch{}return Y.id}catch{try{const O=await Is(Ee(K,"users",g.uid,"dailySales"),{userId:g.uid,clientId:d.id,productName:d.productName,quantity:d.quantity,wholesalePrice:d.wholesalePrice??null,sellingPrice:d.price,profit,date:d.date,time:d.time,performedByType,performedByName,performedByUsername,serialNumber:d.serialNumber??null,barcode:d.barcode??null,...y!=null&&y.shopId?{shopId:y.shopId}:M?{shopId:M}:{},createdAt:Ge()});try{await Ds(ze(K,"dailySales",O.id),{userId:g.uid,clientId:d.id,productName:d.productName,quantity:d.quantity,wholesalePrice:d.wholesalePrice??null,sellingPrice:d.price,profit,date:d.date,time:d.time,performedByType,performedByName,performedByUsername,serialNumber:d.serialNumber??null,barcode:d.barcode??null,...y!=null&&y.shopId?{shopId:y.shopId}:M?{shopId:M}:{},createdAt:Ge()})}catch{}return O.id}catch(O){return console.error("Error saving sale:",O),null}}},mt=()=>{const d=M||(y==null?void 0:y.shopId)||"main";return`cashBalance_${(g==null?void 0:g.uid)||"default"}_${d}`},bs=async()=>{if(!(g!=null&&g.uid))return;const d=p.filter(O=>!O.firestoreId);if(d.length!==0)for(const O of d)try{let L;try{const k=ot(Ee(K,"dailySales"),De("userId","==",g.uid),De("clientId","==",O.id),on(1));L=await ut(k)}catch{const k=ot(Ee(K,"users",g.uid,"dailySales"),De("clientId","==",O.id),on(1));L=await ut(k)}if(!L.empty){const k=L.docs[0].id,Y=p.map(X=>X.id===O.id?{...X,firestoreId:k}:X);it(Y);continue}const N=await is(O);if(N){const k=p.map(Y=>Y.id===O.id?{...Y,firestoreId:N}:Y);it(k)}}catch{}},bt=async d=>{try{if(g!=null&&g.uid)try{const le=Ee(K,"deficiencies"),Ce=await Is(le,{shopId:(y==null?void 0:y.shopId)||g.uid||"default-shop",name:d,quantity:1,status:"pending",createdAt:Ge()});try{const ve=`deficiencies_${(y==null?void 0:y.shopId)||(g==null?void 0:g.uid)||"default-shop"}`,ce=localStorage.getItem(ve),Ht=ce?JSON.parse(ce):[],ts=Array.isArray(Ht)?Ht:[],_e=ts.some($t=>String(($t==null?void 0:$t.id)||"")===Ce.id),Ke={id:Ce.id,name:d,quantity:1,status:"pending",createdAt:new Date().toISOString()},Mt=_e?ts:[...ts,Ke];localStorage.setItem(ve,JSON.stringify(Mt))}catch{}T({title:"تمت الإضافة للنواقص",description:`المنتج ${d} نفد من المخزون وتمت إضافته للنواقص`});return}catch(le){console.warn("Failed to add deficiency to Firestore, falling back to local storage:",le)}const O=`deficiencies_${(y==null?void 0:y.shopId)||(g==null?void 0:g.uid)||"default-shop"}`,L=localStorage.getItem(O),N=L?JSON.parse(L):[],k=Array.isArray(N)?N:[];if(k.some(le=>String((le==null?void 0:le.name)||"").trim()===d&&String((le==null?void 0:le.status)||"pending")==="pending"))return;const X={id:Date.now().toString(),name:d,quantity:1,status:"pending",createdAt:new Date().toISOString()},pe=[...k,X];localStorage.setItem(O,JSON.stringify(pe)),T({title:"تمت الإضافة للنواقص",description:`المنتج ${d} نفد من المخزون وتمت إضافته للنواقص`})}catch(O){console.error("Error adding deficiency for out-of-stock:",O)}},Us=async d=>{const O=re[d.id]||"",L=parseInt(O);if(isNaN(L)||L<=0){T({title:"كمية غير صالحة",description:"أدخل كمية صحيحة للبيـع",variant:"destructive"});return}if(L>d.quantity){T({title:"كمية أكبر من المتاح",description:"الكمية المطلوب بيعها تتجاوز المخزون المتاح",variant:"destructive"});return}const N=new Date,k=P&&q?"cashier":"admin",Y=k==="cashier"?(q==null?void 0:q.name)||"كاشير":(y==null?void 0:y.fullName)||(g==null?void 0:g.displayName)||"الحساب الرئيسي",X=k==="cashier"&&(q==null?void 0:q.username)||null,pe=(d.serialNumber||"").trim(),le=st[d.id]||"",Ce=parseFloat(le),ve=!isNaN(Ce)&&Ce>0?Ce:d.sellingPrice,ce={id:Date.now().toString(),productName:d.name,price:ve,wholesalePrice:d.wholesalePrice,quantity:L,date:N.toISOString().split("T")[0],time:N.toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit"}),performedByType:k,performedByName:Y,performedByUsername:X,serialNumber:pe||void 0,barcode:d.barcode};try{const Ht=await is(ce),ts=Ht?{...ce,firestoreId:Ht}:ce;it([...p,ts]);const _e=d.quantity-L;await Ms(ze(K,"products",d.id),{quantity:_e,updatedAt:Ge()}),J(Ke=>Ke.map(Mt=>Mt.id===d.id?{...Mt,quantity:_e}:Mt)),E(Ke=>({...Ke,[d.id]:""})),jt(Ke=>({...Ke,[d.id]:""})),_e===0&&bt(d.name);try{const Ke=ve*L,Mt=mt(),$t=localStorage.getItem(Mt),os=($t?parseFloat($t):0)+Ke;localStorage.setItem(Mt,os.toString());const Ta=`userData_${g==null?void 0:g.uid}`,Lt={cashBalance:os,lastUpdated:new Date().toISOString()};localStorage.setItem(Ta,JSON.stringify(Lt)),g!=null&&g.uid&&Ae.updateUserData(g.uid,Lt).catch(()=>{})}catch(Ke){console.warn("تعذر تحديث رصيد الدرج النقدي بعد البيع:",Ke)}T({title:"تم البيع",description:`تم بيع ${L} قطعة من ${d.name}`})}catch(Ht){console.error("Error selling product:",Ht),T({title:"فشل البيع",description:"تعذّر تنفيذ عملية البيع",variant:"destructive"})}},ha=async d=>{if(!(g!=null&&g.uid))return;if(P){T({title:"غير مسموح في وضع الكاشير",description:"لا يمكن حذف إيصالات البيع أثناء الورديه",variant:"destructive"});return}window.confirm(`هل تريد حذف إيصال بيع للمنتج "${d.productName}"؟ سيتم عكس المخزون والرصيد.`)&&Wt("تأكيد حذف إيصال بيع","أدخل الرقم السري الرئيسي لحذف الإيصال وعكس الآثار",async()=>{try{try{const L=(d.price??0)*(d.quantity??0),N=mt(),k=localStorage.getItem(N),X=(k?parseFloat(k):0)-L;localStorage.setItem(N,X.toString());const pe=`userData_${g==null?void 0:g.uid}`,le={cashBalance:X,lastUpdated:new Date().toISOString()};localStorage.setItem(pe,JSON.stringify(le)),g!=null&&g.uid&&Ae.updateUserData(g.uid,le).catch(()=>{})}catch(L){console.warn("تعذر عكس رصيد الدرج النقدي عند حذف الإيصال:",L)}try{const L=V.find(N=>d.barcode&&N.barcode===d.barcode||N.name===d.productName);if(L){const N=(L.quantity||0)+(d.quantity||0);await Ms(ze(K,"products",L.id),{quantity:N,updatedAt:Ge()}),J(k=>k.map(Y=>Y.id===L.id?{...Y,quantity:N}:Y))}}catch(L){console.warn("تعذر عكس المخزون عند حذف الإيصال:",L)}try{if(d.firestoreId){try{await vs(ze(K,"dailySales",d.firestoreId))}catch{}try{await vs(ze(K,"users",g.uid,"dailySales",d.firestoreId))}catch{}}else{let L;try{const N=ot(Ee(K,"dailySales"),De("userId","==",g.uid),De("date","==",d.date),De("productName","==",d.productName),on(5));L=await ut(N)}catch{const N=ot(Ee(K,"users",g.uid,"dailySales"),De("date","==",d.date),De("productName","==",d.productName),on(5));L=await ut(N)}if(!L.empty){const N=L.docs.find(k=>{const Y=k.data();return Number((Y==null?void 0:Y.sellingPrice)??0)===Number(d.price??0)&&Number((Y==null?void 0:Y.quantity)??0)===Number(d.quantity??0)&&String((Y==null?void 0:Y.time)??"")===String(d.time??"")})||L.docs[0];N&&await vs(N.ref)}}}catch(L){console.warn("تعذر حذف سجل البيع من Firestore:",L)}try{const L=Oe(),N=`salesData_${g.uid}_${L}`,k=`salesData_all_${g.uid}`,Y=p.filter(Ce=>Ce.id!==d.id);localStorage.setItem(N,JSON.stringify(Y));const X=localStorage.getItem(k),pe=X?JSON.parse(X):[],le=(Array.isArray(pe)?pe:[]).filter(Ce=>(Ce==null?void 0:Ce.id)!==d.id);localStorage.setItem(k,JSON.stringify(le)),v(Y)}catch(L){console.warn("تعذر تحديث التخزين المحلي بعد الحذف:",L)}try{tt||await Yt()}catch{}T({title:"تم حذف الإيصال",description:`تم حذف إيصال بيع للمنتج ${d.productName} وتم عكس الآثار`})}catch(L){console.error("Error deleting sale:",L),T({title:"فشل حذف الإيصال",description:"تعذّر حذف إيصال البيع",variant:"destructive"})}})},Ca=async d=>{try{E(O=>({...O,[d.id]:"1"})),await Us(d)}catch(O){console.error("Error selling by barcode:",O)}},Ia=async d=>{if(P){T({title:"غير مسموح في وضع الكاشير",description:"لا يمكن إضافة قطع أثناء الورديه",variant:"destructive"});return}const O=_[d.id]||"",L=parseInt(O);if(isNaN(L)||L<=0){T({title:"كمية غير صالحة",description:"أدخل كمية صحيحة للإضافة",variant:"destructive"});return}Wt("تأكيد إضافة قطع","لا يمكن إضافة قطع إلا بإدخال الرقم السري الرئيسي",async()=>{try{const N=d.quantity+L;await Ms(ze(K,"products",d.id),{quantity:N,updatedAt:Ge()}),J(k=>k.map(Y=>Y.id===d.id?{...Y,quantity:N}:Y)),oe(k=>({...k,[d.id]:""})),T({title:"تمت الإضافة",description:`تمت إضافة ${L} قطعة إلى ${d.name}`})}catch(N){console.error("Error adding pieces:",N),T({title:"فشل الإضافة",description:"تعذّر إضافة الكمية إلى المخزون",variant:"destructive"})}})},Ts=async d=>{if(!(g!=null&&g.uid))return;if(P){T({title:"غير مسموح في وضع الكاشير",description:"لا يمكن حذف المنتجات أثناء الورديه",variant:"destructive"});return}window.confirm(`هل تريد حذف المنتج "${d.name}"؟`)&&Wt("تأكيد حذف منتج","لا يمكن حذف المنتجات إلا بإدخال الرقم السري الرئيسي",async()=>{try{await vs(ze(K,"products",d.id)),J(L=>L.filter(N=>N.id!==d.id)),T({title:"تم الحذف",description:`تم حذف المنتج ${d.name}`})}catch(L){console.error("Error deleting product:",L),T({title:"فشل الحذف",description:"تعذّر حذف المنتج",variant:"destructive"})}})},Aa=async()=>{try{if(!(g!=null&&g.uid)){T({title:"خطأ",description:"غير مسجّل دخول",variant:"destructive"});return}if(P){T({title:"غير مسموح في وضع الكاشير",description:"لا يمكن إضافة منتجات أثناء الورديه",variant:"destructive"});return}const d=j.productName.trim(),O=parseFloat(j.price),L=parseFloat(j.wholesalePrice||"0"),N=parseInt(j.quantity);if(!d||isNaN(O)||isNaN(N)){T({title:"بيانات غير مكتملة",description:"أدخل اسم المنتج والسعر والكمية",variant:"destructive"});return}const k={name:d,sellingPrice:O,wholesalePrice:isNaN(L)?0:L,quantity:isNaN(N)?0:N,userId:g.uid,createdAt:Ge(),updatedAt:Ge()},Y=(j.barcode||"").trim();Y&&(k.barcode=Y);const X=(j.serialNumber||"").trim();X&&(k.serialNumber=X),y!=null&&y.shopId&&(k.shopId=y.shopId);const pe=await Is(Ee(K,"products"),k);J(le=>[{id:pe.id,name:d,sellingPrice:O,wholesalePrice:isNaN(L)?0:L,quantity:isNaN(N)?0:N,barcode:(j.barcode||"").trim()||"",serialNumber:(j.serialNumber||"").trim()||""},...le]),s({productName:"",price:"",wholesalePrice:"",quantity:"",barcode:"",serialNumber:""}),T({title:"تمت الإضافة",description:`تم إضافة المنتج ${d} بنجاح`})}catch(d){console.error("createProduct error",d),T({title:"فشل الإضافة",description:"تعذّر إضافة المنتج. حاول مجددًا",variant:"destructive"})}},ls=async d=>{const O=(d||"").trim();if(!O)return;const L=V.find(N=>(N.barcode||"")===O);if(!L){T({title:"باركود غير معروف",description:"لم يتم العثور على منتج بهذا الباركود"});return}await Ca(L)},za=()=>{const d=Object.entries(we).map(([le,Ce])=>{const ve=Number(Ce),ce=V.find(Ht=>Ht.id===le);return!ce||!ve||ve<=0?null:{name:ce.name,qty:ve,price:ce.sellingPrice,total:ve*ce.sellingPrice}}).filter(Boolean);if(d.length===0){T({title:"لم يتم اختيار منتجات",description:"فعّل وضع الفاتورة واختر منتجات وكميات للطباعة"});return}const O=(y==null?void 0:y.shopName)||(g==null?void 0:g.displayName)||"المحل",L=(y==null?void 0:y.phone)||(g==null?void 0:g.phoneNumber)||"",N=d.reduce((le,Ce)=>le+Ce.total,0),k=new Date().toLocaleString("ar-EG"),Y=d.map(le=>`
        <tr>
          <td style="border:1px solid #ddd;padding:6px">${le.name}</td>
          <td style="border:1px solid #ddd;padding:6px;text-align:center">${le.qty}</td>
          <td style="border:1px solid #ddd;padding:6px;text-align:center">${Rt(le.price)}</td>
          <td style="border:1px solid #ddd;padding:6px;text-align:center;font-weight:bold;color:#0a7">${Rt(le.total)}</td>
        </tr>
      `).join(""),X=`
      <html>
        <head>
          <meta charset="utf-8" />
          <title>فاتورة</title>
          <style>
            body { font-family: Tahoma, Arial, sans-serif; direction: rtl; }
            .header { text-align: center; margin-bottom: 12px; }
            .header h2 { margin: 0; }
            .meta { text-align: center; color: #555; margin-bottom: 8px; }
            table { width: 100%; border-collapse: collapse; }
            .total { text-align: left; font-weight: bold; margin-top: 10px; }
          </style>
        </head>
        <body>
          <div class="header">
            <h2>${O}</h2>
            ${L?`<div class="meta">رقم التليفون: ${L}</div>`:""}
            <div class="meta">التاريخ: ${k}</div>
          </div>
          <table>
            <thead>
              <tr>
                <th style="border:1px solid #ddd;padding:6px">المنتج</th>
                <th style="border:1px solid #ddd;padding:6px">الكمية</th>
                <th style="border:1px solid #ddd;padding:6px">السعر</th>
                <th style="border:1px solid #ddd;padding:6px">الإجمالي</th>
              </tr>
            </thead>
            <tbody>
              ${Y}
            </tbody>
          </table>
          <div class="total">الإجمالي الكلي: ${Rt(N)}</div>
        </body>
      </html>
    `,pe=window.open("","_blank");pe&&(pe.document.write(X),pe.document.close(),pe.focus(),pe.print(),pe.close())};return e.jsxs(de,{open:i,onOpenChange:u,children:[e.jsxs(me,{className:"max-w-none w-[100vw] md:w-[100vw] lg:w-[100vw] max-h-[85vh] md:h-[100dvh] md:max-h-[100dvh] p-0 overflow-y-auto",children:[e.jsx(he,{className:"px-3 md:px-6 py-3 md:py-4 border-b bg-gradient-to-r from-blue-50 to-purple-50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 md:gap-3",children:[e.jsx("div",{className:"p-1.5 md:p-2 bg-blue-100 rounded-lg",children:e.jsx(un,{className:"h-5 w-5 md:h-6 md:w-6 text-blue-600"})}),e.jsxs("div",{children:[e.jsx(ue,{className:"text-lg md:text-xl font-bold text-gray-800",children:"📊 بيانات المبيعات اليومية"}),e.jsxs("p",{className:"text-xs md:text-sm text-gray-600 mt-1 hidden sm:block",children:["إدارة وتتبع مبيعات اليوم - ",new Date().toLocaleDateString("ar-EG")]})]})]}),e.jsxs("div",{className:"flex items-center gap-1 md:gap-2",children:[e.jsx(h,{variant:"outline",size:"sm",onClick:()=>bs(),className:"text-xs md:text-sm",children:"استرجاع الإيصالات"}),e.jsx(h,{variant:"ghost",size:"sm",onClick:u,className:"h-8 w-8 md:h-9 md:w-9",children:e.jsx(fo,{className:"h-4 w-4"})})]})]})}),e.jsxs("div",{className:"flex flex-col md:flex-row h-full",dir:"rtl",children:[e.jsxs("div",{className:"w-full md:w-72 lg:w-80 bg-white/50 border-r",children:[e.jsxs("div",{className:"p-3 md:p-4 border-b bg-white/30",children:[e.jsxs("h3",{className:"font-semibold text-gray-800 mb-3 flex items-center gap-2 text-sm md:text-base",children:[e.jsx(At,{className:"h-4 w-4 text-green-600"}),"ملخص المبيعات"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 md:gap-3",children:[e.jsxs("div",{className:"bg-blue-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-blue-600",children:Rt(p.reduce((d,O)=>d+O.price*O.quantity,0))}),e.jsx("div",{className:"text-xs md:text-sm text-blue-600",children:"إجمالي المبيعات"})]}),e.jsxs("div",{className:"relative bg-green-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsxs("div",{className:G?"filter blur-sm pointer-events-none":"",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-green-600",children:Rt(p.reduce((d,O)=>d+(O.price-(O.wholesalePrice??0))*O.quantity,0))}),e.jsx("div",{className:"text-xs md:text-sm text-green-600",children:"إجمالي الأرباح"})]}),G&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>Q(!0),className:"bg-white/80 hover:bg-white text-green-700 border border-green-200",children:"عرض الأرباح"})})]}),e.jsxs("div",{className:"bg-yellow-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-yellow-600",children:Ra(V.length)}),e.jsx("div",{className:"text-xs md:text-sm text-yellow-600",children:"عدد المنتجات"})]}),e.jsxs("div",{className:"bg-purple-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-purple-600",children:Ra(p.length)}),e.jsx("div",{className:"text-xs md:text-sm text-purple-600",children:"عدد المبيعات"})]})]}),e.jsxs("div",{className:"relative mb-2",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-1 md:gap-2 text-xs md:text-sm font-semibold text-indigo-700",children:[e.jsx(da,{className:"h-3 w-3 md:h-4 md:w-4"}),e.jsx(un,{className:"h-3 w-3 md:h-4 md:w-4"}),e.jsx("span",{children:"تقارير الشهر"})]}),e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>Tt(d=>!d),className:"h-6 w-6 p-0 rounded-full",title:Ye?"إظهار التقارير":"إخفاء التقارير",children:Ye?e.jsx(br,{className:"h-4 w-4"}):e.jsx(dn,{className:"h-4 w-4"})})]}),e.jsx("div",{className:Ye?"overflow-hidden max-h-0 transition-[max-height] duration-300":"overflow-hidden transition-[max-height] duration-300 max-h-[400px]",children:e.jsxs("div",{className:tt?"grid grid-cols-2 gap-2 md:gap-4 filter blur-sm pointer-events-none":"grid grid-cols-2 gap-2 md:gap-4",children:[e.jsxs("div",{className:"bg-indigo-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-indigo-600",children:Rt(es)}),e.jsx("div",{className:"text-xs md:text-sm text-indigo-600",children:"مبيعات الشهر"})]}),e.jsxs("div",{className:"bg-pink-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-pink-600",children:Rt(nt)}),e.jsx("div",{className:"text-xs md:text-sm text-pink-600",children:"أرباح الشهر"})]})]})}),!Ye&&tt&&e.jsx("div",{className:"absolute left-0 right-0 top-7 md:top-10 bottom-0 flex items-center justify-center rounded-lg bg-yellow-100/60",children:e.jsxs(h,{size:"sm",variant:"ghost",onClick:async()=>{try{if(await isZeroPlan()){T({title:"الخطة زيرو",description:"التقارير الشهرية غير متاحة في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}catch{}ct(!0)},className:"flex items-center gap-2 bg-yellow-200/70 hover:bg-yellow-300 text-yellow-900 px-3 py-2 rounded-xl shadow-md hover:shadow-lg transition-all btn-monthly-reports",title:"عرض تقارير الشهر",children:[e.jsx(Nt,{className:"h-5 w-5 md:h-7 md:w-7"}),e.jsx("span",{className:"text-xs md:text-sm",children:"عرض تقارير الشهر"})]})})]})]}),e.jsxs("div",{className:"p-3 md:p-4 border-b bg-white/30",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("h3",{className:"font-semibold text-gray-800 flex items-center gap-2 text-sm md:text-base",children:[e.jsx(fr,{className:"h-4 w-4 text-indigo-600"}),"إحصائيات المنتجات"]}),e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>W(d=>!d),className:"h-6 w-6 p-0 rounded-full",title:vt?"إظهار القسم":"إخفاء القسم",children:vt?e.jsx(br,{className:"h-4 w-4"}):e.jsx(dn,{className:"h-4 w-4"})})]}),e.jsx("div",{className:vt?"overflow-hidden max-h-0 transition-[max-height] duration-300":"overflow-hidden transition-[max-height] duration-300 max-h-[400px]"})]}),e.jsxs("div",{className:"p-3 md:p-4 flex-1 hidden md:block",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("h3",{className:"font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(Ai,{className:"h-4 w-4 text-blue-600"}),"نصائح للمبيعات"]}),e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>Fe(d=>!d),className:"h-6 w-6 p-0 rounded-full",title:ae?"إظهار القسم":"إخفاء القسم",children:ae?e.jsx(br,{className:"h-4 w-4"}):e.jsx(dn,{className:"h-4 w-4"})})]}),e.jsx("div",{className:ae?"overflow-hidden max-h-0 transition-[max-height] duration-300":"overflow-hidden transition-[max-height] duration-300 max-h-[400px]"})]})]}),e.jsx("div",{className:"flex-1 overflow-y-visible transition-all duration-300 ease-in-out",children:e.jsxs("div",{className:"p-3 md:p-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 md:mb-6 gap-2",children:[e.jsxs("h2",{className:"text-base md:text-lg font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(Bm,{className:"h-4 w-4 md:h-5 md:w-5 text-blue-600"}),"سجل المبيعات (",p.length," عنصر)"]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs md:text-sm text-gray-600",children:[e.jsx(da,{className:"h-3 w-3 md:h-4 md:w-4"}),e.jsx("span",{className:"hidden sm:inline",children:new Date().toLocaleDateString("ar-EG")}),e.jsx(Qs,{className:"h-3 w-3 md:h-4 md:w-4 ml-2"}),e.jsx("span",{children:new Date().toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit"})})]})]}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-3 md:p-4 mb-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("h3",{className:"text-sm md:text-base font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(as,{className:"h-4 w-4 text-emerald-600"}),"إضافة منتج جديد"]}),e.jsxs(h,{size:"sm",variant:"ghost",className:"h-8",onClick:()=>{if(P){T({title:"غير مسموح في وضع الكاشير",description:"لا يمكن إضافة منتج أثناء الورديه",variant:"destructive"});return}Wt("فتح نموذج إضافة منتج","أدخل الرقم السري الرئيسي لفتح نموذج الإضافة",()=>B(!0))},children:[e.jsx(as,{className:"h-4 w-4 text-emerald-600"}),"إضافة منتج"]})]}),D&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx(H,{htmlFor:"new-product-name",className:"text-xs md:text-sm",children:"اسم المنتج"}),e.jsx(U,{id:"new-product-name",value:j.productName,onChange:d=>s(O=>({...O,productName:d.target.value})),placeholder:"أدخل اسم المنتج"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx(H,{htmlFor:"new-product-price",className:"text-xs md:text-sm",children:"سعر البيع (ج.م)"}),e.jsx(U,{type:"number",id:"new-product-price",value:j.price,onChange:d=>s(O=>({...O,price:d.target.value})),placeholder:"0.00"})]}),e.jsxs("div",{children:[e.jsx(H,{htmlFor:"new-product-wholesale",className:"text-xs md:text-sm",children:"سعر الجملة (ج.م)"}),e.jsx(U,{type:"number",id:"new-product-wholesale",value:j.wholesalePrice||"",onChange:d=>s(O=>({...O,wholesalePrice:d.target.value})),placeholder:"0.00"})]})]}),e.jsxs("div",{children:[e.jsx(H,{htmlFor:"new-product-qty",className:"text-xs md:text-sm",children:"الكمية"}),e.jsx(U,{type:"number",id:"new-product-qty",value:j.quantity,onChange:d=>s(O=>({...O,quantity:d.target.value})),placeholder:"1"})]}),e.jsxs("div",{children:[e.jsx(H,{htmlFor:"new-product-barcode",className:"text-xs md:text-sm",children:"باركود المنتج (اختياري)"}),e.jsx(U,{id:"new-product-barcode",value:j.barcode||"",onChange:d=>s(O=>({...O,barcode:d.target.value})),placeholder:"أدخل/امسح الباركود"})]}),e.jsxs("div",{children:[e.jsx(H,{htmlFor:"new-product-serial",className:"text-xs md:text-sm",children:"سيريال الجهاز (اختياري)"}),e.jsx(U,{id:"new-product-serial",value:j.serialNumber||"",onChange:d=>s(O=>({...O,serialNumber:d.target.value})),placeholder:"أدخل سيريال الجهاز"})]}),e.jsx(h,{className:"h-9 w-full md:w-auto bg-indigo-600 hover:bg-indigo-700 text-white",onClick:Aa,children:"إضافة المنتج"})]})]}),e.jsx("div",{id:"shop-products-section",className:"bg-white rounded-lg border border-gray-200 overflow-hidden mb-4",children:e.jsxs("div",{className:"mb-4",children:[e.jsxs("h3",{className:"text-sm md:text-base font-semibold text-gray-800 mb-2 flex items-center gap-2",children:[e.jsx(fr,{className:"h-4 w-4 text-green-600"}),"منتجات المحل"]}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(h,{variant:ye?"default":"outline",size:"sm",onClick:()=>We(d=>!d),children:ye?"وضع الفاتورة: مفعل":"تفعيل وضع الفاتورة"}),e.jsx(h,{size:"sm",className:"bg-indigo-600 hover:bg-indigo-700 text-white",disabled:Object.keys(we).filter(d=>(we[d]||0)>0).length===0,onClick:za,children:"طباعة فاتورة"})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(U,{value:Pt,onChange:d=>R(d.target.value),placeholder:"ابحث عن منتج...",className:"h-9 w-full md:w-72 text-sm","aria-label":"البحث عن منتج من منتجات المحل"}),e.jsx(U,{value:se,onChange:d=>te(d.target.value),onKeyDown:async d=>{if(d.key!=="Enter")return;const O=se.trim();O&&(await ls(O),te(""))},placeholder:"مرّر ماسح الباركود هنا (اختياري)",className:"h-9 w-full md:w-64 text-sm","aria-label":"مسح الباركود لإضافة المنتج تلقائياً"}),Pt&&e.jsx(h,{variant:"ghost",size:"sm",className:"h-9",onClick:()=>R(""),children:"مسح"})]}),e.jsx("div",{className:"overflow-x-auto border border-gray-200 rounded-lg hidden md:block",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"المنتج"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"سعر البيع"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("span",{children:"سعر الجملة"}),e.jsx(h,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>et(d=>!d),"aria-label":Me?"إخفاء سعر الجملة":"إظهار سعر الجملة",children:Me?e.jsx(Xt,{className:"h-4 w-4"}):e.jsx(Nt,{className:"h-4 w-4"})})]})}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"المتاح"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"بيع"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:je.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"px-3 py-3 text-center text-gray-500",children:V.length===0?"لا توجد منتجات بعد، أضف منتجاً من النموذج أعلاه":"لا توجد نتائج مطابقة للبحث"})}):je.map(d=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-3 py-2 font-medium text-gray-900",children:d.name}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:Rt(d.sellingPrice)}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:e.jsx("span",{className:Me?"":"blur-sm select-none",children:Rt(d.wholesalePrice)})}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:Ra(d.quantity)}),e.jsx("td",{className:"px-3 py-2",children:e.jsxs("div",{className:"flex items-center gap-2 flex-nowrap",children:[e.jsx(U,{value:re[d.id]||"",onChange:O=>E(L=>({...L,[d.id]:O.target.value})),type:"number",placeholder:"عدد القطع للبيع",className:"h-8 w-28 text-sm"}),e.jsx(U,{value:st[d.id]||"",onChange:O=>jt(L=>({...L,[d.id]:O.target.value})),type:"number",placeholder:"سعر بيع اختياري",className:"h-8 w-32 text-sm","aria-label":`سعر بيع اختياري لـ ${d.name}`}),e.jsx(h,{size:"sm",className:"h-8 min-w-[64px] bg-indigo-600 hover:bg-indigo-700 text-white",onClick:()=>Us(d),children:"بيع"}),ye&&e.jsx(U,{value:we[d.id]??"",onChange:O=>{const L=parseInt(O.target.value||"0");Te(N=>({...N,[d.id]:isNaN(L)?0:L}))},type:"number",placeholder:"كمية للفاتورة",className:"h-8 w-24 text-sm"}),e.jsx(U,{value:_[d.id]||"",onChange:O=>oe(L=>({...L,[d.id]:O.target.value})),type:"number",placeholder:"عدد للإضافة",className:"h-8 w-28 text-sm",disabled:P}),e.jsxs("div",{className:"inline-flex items-center gap-2 flex-nowrap",children:[e.jsx(h,{size:"sm",variant:"outline",className:"h-8 whitespace-nowrap",onClick:()=>Ia(d),disabled:P,title:P?"غير مسموح في وضع الكاشير":void 0,children:"إضافة قطع جديدة"}),e.jsx(h,{size:"sm",variant:"destructive",className:"h-8",onClick:()=>Ts(d),title:"حذف المنتج",disabled:P,children:e.jsx(Vt,{className:"h-4 w-4"})})]})]})})]},d.id))})]})}),e.jsx("div",{className:"block md:hidden space-y-3",children:je.length===0?e.jsx("div",{className:"text-center text-gray-500 text-sm",children:V.length===0?"لا توجد منتجات بعد، أضف منتجاً من النموذج أعلاه":"لا توجد نتائج مطابقة للبحث"}):je.map(d=>e.jsxs("div",{className:"bg-white rounded-xl p-3 border border-gray-200 shadow-sm",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"font-semibold text-gray-900 text-sm break-words",children:d.name}),e.jsx(h,{size:"sm",variant:"destructive",className:"h-8 min-w-[44px] touch-manipulation",onClick:()=>Ts(d),title:"حذف المنتج",disabled:P,children:e.jsx(Vt,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-2 text-xs text-gray-700",children:[e.jsx("div",{className:"text-gray-600",children:"سعر البيع"}),e.jsx("div",{className:"text-right font-medium",children:Rt(d.sellingPrice)}),e.jsxs("div",{className:"text-gray-600 inline-flex items-center gap-1",children:[e.jsx("span",{children:"سعر الجملة"}),e.jsx(h,{variant:"ghost",size:"icon",className:"h-5 w-5",onClick:()=>et(O=>!O),"aria-label":Me?"إخفاء سعر الجملة":"إظهار سعر الجملة",children:Me?e.jsx(Xt,{className:"h-4 w-4"}):e.jsx(Nt,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"text-right font-medium",children:e.jsx("span",{className:Me?"":"blur-sm select-none",children:Rt(d.wholesalePrice)})}),e.jsx("div",{className:"text-gray-600",children:"المتاح"}),e.jsx("div",{className:"text-right font-medium",children:Ra(d.quantity)})]}),e.jsxs("div",{className:"mt-3 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(U,{value:re[d.id]||"",onChange:O=>E(L=>({...L,[d.id]:O.target.value})),type:"number",placeholder:"عدد القطع للبيع",className:"h-9 flex-1 text-sm","aria-label":`عدد القطع للبيع لـ ${d.name}`}),e.jsx(U,{value:st[d.id]||"",onChange:O=>jt(L=>({...L,[d.id]:O.target.value})),type:"number",placeholder:"سعر بيع اختياري",className:"h-9 w-28 text-sm","aria-label":`سعر بيع اختياري لـ ${d.name}`}),e.jsx(h,{size:"sm",className:"h-9 min-w-[64px] bg-indigo-600 hover:bg-indigo-700 text-white",onClick:()=>Us(d),children:"بيع"})]}),ye&&e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(U,{value:we[d.id]??"",onChange:O=>{const L=parseInt(O.target.value||"0");Te(N=>({...N,[d.id]:isNaN(L)?0:L}))},type:"number",placeholder:"كمية للفاتورة",className:"h-9 flex-1 text-sm","aria-label":`كمية للفاتورة لـ ${d.name}`})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(U,{value:_[d.id]||"",onChange:O=>oe(L=>({...L,[d.id]:O.target.value})),type:"number",placeholder:"عدد للإضافة",className:"h-9 flex-1 text-sm","aria-label":`عدد القطع للإضافة لـ ${d.name}`,disabled:P}),e.jsx(h,{size:"sm",variant:"outline",className:"h-9 min-w-[64px]",onClick:()=>Ia(d),disabled:P,title:P?"غير مسموح في وضع الكاشير":void 0,children:"إضافة"})]})]})]},d.id))})]})}),p.length===0?e.jsxs("div",{className:"text-center py-8 md:py-12",children:[e.jsx("div",{className:"w-16 h-16 md:w-24 md:h-24 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center",children:e.jsx(fr,{className:"h-8 w-8 md:h-12 md:w-12 text-gray-400"})}),e.jsx("h3",{className:"text-base md:text-lg font-medium text-gray-900 mb-2",children:"لا توجد مبيعات اليوم"}),e.jsx("p",{className:"text-sm text-gray-500",children:"ابدأ ببيع منتج من القائمة أعلاه"})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"block md:hidden",children:e.jsx("div",{className:"max-h-[70vh] overflow-y-auto space-y-3 p-3",children:p.map(d=>e.jsxs("div",{className:"bg-white rounded-xl p-4 border border-gray-200 shadow-sm",children:[e.jsx("div",{className:"mb-3",children:e.jsx("h4",{className:"font-semibold text-gray-900 text-base break-words",children:d.productName})}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-2 text-sm text-gray-700",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(At,{className:"h-4 w-4 text-blue-600"}),e.jsx("span",{className:"text-gray-600",children:"سعر البيع"})]}),e.jsx("div",{className:"text-right font-medium",children:Rt(d.price)}),typeof d.wholesalePrice=="number"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(At,{className:"h-4 w-4 text-indigo-600"}),e.jsxs("span",{className:"text-gray-600 inline-flex items-center gap-1",children:["سعر الجملة",e.jsx(h,{variant:"ghost",size:"icon",className:"h-5 w-5",onClick:()=>et(O=>!O),"aria-label":Me?"إخفاء سعر الجملة":"إظهار سعر الجملة",children:Me?e.jsx(Xt,{className:"h-4 w-4"}):e.jsx(Nt,{className:"h-4 w-4"})})]})]}),e.jsx("div",{className:"text-right font-medium",children:e.jsx("span",{className:Me?"":"blur-sm select-none",children:Rt(d.wholesalePrice)})})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(fr,{className:"h-4 w-4 text-emerald-600"}),e.jsx("span",{className:"text-gray-600",children:"الكمية"})]}),e.jsx("div",{className:"text-right font-medium",children:Ra(d.quantity)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(yr,{className:"h-4 w-4 text-purple-600"}),e.jsx("span",{className:"text-gray-600",children:"الربح"})]}),e.jsx("div",{className:"text-right font-semibold text-purple-700",children:Rt(((d.price??0)-(d.wholesalePrice??0))*(d.quantity??0))}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(At,{className:"h-4 w-4 text-green-600"}),e.jsx("span",{className:"text-gray-600",children:"الإجمالي"})]}),e.jsx("div",{className:"text-right font-bold text-green-700",children:Rt(d.price*d.quantity)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Rm,{className:"h-4 w-4 text-amber-600"}),e.jsx("span",{className:"text-gray-600",children:"المنفذ"})]}),e.jsx("div",{className:"text-right text-gray-700",children:d.performedByName??"-"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(da,{className:"h-4 w-4 text-blue-600"}),e.jsx("span",{className:"text-gray-600",children:"التاريخ"})]}),e.jsx("div",{className:"text-right text-gray-600",children:uo(d.date)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Qs,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"text-gray-600",children:"الوقت"})]}),e.jsx("div",{className:"text-right text-gray-600",children:d.time})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-end gap-2",children:[e.jsx(h,{size:"sm",variant:"outline",onClick:()=>ha(d),disabled:P,title:P?"غير مسموح في وضع الكاشير":"مرتجع",className:"h-8 border-red-300 text-red-600 hover:bg-red-50",children:"مرتجع"}),e.jsxs(h,{size:"sm",variant:"destructive",onClick:()=>ha(d),disabled:P,title:P?"غير مسموح في وضع الكاشير":"حذف الإيصال",className:"h-8",children:[e.jsx(Vt,{className:"h-4 w-4"}),e.jsx("span",{className:"ml-1",children:"حذف الإيصال"})]})]})]},d.id))})}),e.jsx("div",{className:"hidden md:block overflow-x-auto max-h-96 overflow-y-auto scrollbar-thin scrollbar-thumb-green-300 scrollbar-track-green-100 hover:scrollbar-thumb-green-400",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"المنتج"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"سعر البيع (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("span",{children:"سعر الجملة (ج.م)"}),e.jsx(h,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>et(d=>!d),"aria-label":Me?"إخفاء سعر الجملة":"إظهار سعر الجملة",children:Me?e.jsx(Xt,{className:"h-4 w-4"}):e.jsx(Nt,{className:"h-4 w-4"})})]})}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الكمية"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الإجمالي (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الربح (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"التاريخ"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الوقت"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"المنفذ"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"إجراءات"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:p.map((d,O)=>e.jsxs("tr",{className:O%2===0?"bg-white":"bg-gray-50/50",children:[e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-gray-900",children:d.productName}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:Rt(d.price)}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:typeof d.wholesalePrice=="number"?e.jsx("span",{className:Me?"":"blur-sm select-none",children:Rt(d.wholesalePrice)}):"-"}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:Ra(d.quantity)}),e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-green-600",children:Rt(d.price*d.quantity)}),e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-purple-600",children:Rt(((d.price??0)-(d.wholesalePrice??0))*(d.quantity??0))}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-500",children:uo(d.date)}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-500",children:d.time}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:d.performedByName??"-"}),e.jsx("td",{className:"px-4 py-3 text-sm text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(h,{size:"sm",variant:"outline",onClick:()=>ha(d),disabled:P,title:P?"غير مسموح في وضع الكاشير":"مرتجع",className:"h-8 border-red-300 text-red-600 hover:bg-red-50",children:"مرتجع"}),e.jsx(h,{size:"sm",variant:"destructive",onClick:()=>ha(d),disabled:P,title:P?"غير مسموح في وضع الكاشير":"حذف الإيصال",className:"h-8",children:e.jsx(Vt,{className:"h-4 w-4"})})]})})]},d.id))})]})})]})]})})]})]}),e.jsx(rs,{open:Qe,onOpenChange:Q,mode:"verify",title:"قفل إجمالي الأرباح",description:"أدخل الرقم السري الرئيسي لعرض إجمالي الأرباح",onSuccess:()=>{ne(!1),Q(!1)}}),e.jsx(rs,{open:Le,onOpenChange:ct,mode:"verify",title:"قفل إحصائيات الشهر",description:"لا يمكن الاطلاع على تقارير الشهر إلا بإدخال الرقم السري الرئيسي",onSuccess:async()=>{try{const d=g==null?void 0:g.uid;if(d){const O=await Pi(d),L=(O==null?void 0:O.planType)??(O==null?void 0:O.plan)??null,N=typeof L=="string"?L.toLowerCase():null;if(L===Fs.ZERO||N==="zero"){T({title:"الخطة زيرو",description:"التقارير الشهرية غير متاحة في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}}catch{}xe(!1),ct(!1),Yt()}}),e.jsx(rs,{open:Kt,onOpenChange:Dt,mode:"verify",title:at,description:xt,onSuccess:()=>{const d=_t.current;_t.current=null,Dt(!1),d&&d()}})]})}const Ra=i=>new Intl.NumberFormat("ar-EG").format(Number(i||0)),Rt=i=>`${new Intl.NumberFormat("ar-EG",{minimumFractionDigits:2,maximumFractionDigits:2}).format(Number(i||0))} ج.م`,uo=i=>{try{const u=new Date(i);return isNaN(u.getTime())?new Date(`${i}T00:00:00`).toLocaleDateString("ar-EG"):u.toLocaleDateString("ar-EG")}catch{return i}},rh=({open:i,onOpenChange:u,userId:o,cashBalance:p,walletBalances:v,transactions:j})=>{const[s,D]=qe.useState(0),[B,C]=qe.useState(0),[A,T]=qe.useState(0),[g,y]=qe.useState(0),[P,q]=qe.useState(p||0),[M,V]=qe.useState(!1),[J,re]=qe.useState(null),{toast:E}=As(),{shopId:_}=yn()||{},[oe,ee]=qe.useState(!1),[fe,se]=qe.useState(""),[te,ye]=qe.useState(!1),[We,we]=qe.useState(!1),[Te,Me]=qe.useState(""),et=Re=>`${new Intl.NumberFormat("ar-EG").format(Number(Re||0))} جنيه`;qe.useEffect(()=>{const Re=async()=>{try{if(!o){D(0);return}const Le=new Date,ct=Le.getFullYear(),tt=String(Le.getMonth()+1).padStart(2,"0"),xe=String(Le.getDate()).padStart(2,"0"),Ye=`${ct}-${tt}-${xe}`;let Tt;try{const W=ot(Ee(K,"dailySales"),De("userId","==",o),..._?[De("shopId","==",_)]:[],De("date","==",Ye));Tt=await ut(W)}catch{const W=ot(Ee(K,"users",o,"dailySales"),..._?[De("shopId","==",_)]:[],De("date","==",Ye));Tt=await ut(W)}let vt=0;Tt.forEach(W=>{const ae=W.data(),Fe=Number(ae.sellingPrice??0),st=Number(ae.quantity??0);Fe>0&&st>0&&(vt+=Fe*st)}),D(vt)}catch(Le){console.warn("فشل تحميل مبيعات الإكسسوار لليوم:",Le)}},nt=()=>{try{if(!Array.isArray(j)||j.length===0||!o){C(0);return}const Le=Zt.filterVisibleTransactions(j,"daily",o),ct=new Date().toDateString(),tt=Le.reduce((xe,Ye)=>{const Tt=String(Ye.status||"confirmed").toLowerCase();if(new Date(Ye.createdAt).toDateString()!==ct||Tt!=="completed"&&Tt!=="confirmed")return xe;const W=(Ye.type||Ye.txnType||"").toLowerCase(),ae=String(Ye.toWallet||"").toLowerCase(),Fe=Number(Ye.amount||0);return(W==="send"||W==="transfer")&&ae==="cash"&&Fe>0?xe+Fe:xe},0);C(tt)}catch(Le){console.warn("فشل حساب فلوس فوري لليوم:",Le)}},Ie=async()=>{try{if(!o){T(0),y(0);return}const Le=await Ae.getUserData(o),ct=new Date().toISOString().slice(0,10),tt=(Le==null?void 0:Le.dailyReceipts)||{};tt!=null&&tt.date&&String(tt.date).slice(0,10)===ct?(T(Number(tt.accessory||0)),y(Number(tt.fawry||0))):(T(0),y(0)),q(Number((Le==null?void 0:Le.cashBalance)||p||0))}catch{T(0),y(0)}};i&&(Re(),nt(),Ie())},[i,o,j,p,_]);const G=Math.max(0,Number(s)-Number(A)),ne=Math.max(0,Number(B)-Number(g)),Qe=async Re=>{if(!o)return;const nt=new Date().toISOString().slice(0,10);try{const Ie=Re==="accessory"?G:ne;if(Ie<=0){E({title:"لا يوجد مبلغ لتأكيد استلامه",variant:"default"});return}const Le=Math.max(0,Number(P)-Ie);q(Le),Re==="accessory"?T(ct=>ct+Ie):y(ct=>ct+Ie),await Ae.updateUserData(o,{cashBalance:Le,dailyReceipts:{date:nt,accessory:Re==="accessory"?A+Ie:A,fawry:Re==="fawry"?g+Ie:g}});try{localStorage.setItem(`cashBalance_${o}`,String(Le))}catch{}E({title:"تم الاستلام",description:`تم خصم ${Ie.toFixed(2)} من الدرج وتصفير البند`})}catch{E({title:"خطأ",description:"تعذر تنفيذ عملية تم الاستلام",variant:"destructive"})}},Q=()=>{se(""),Me(""),ee(!0)},Ne=()=>{if(!fe.trim()){E({title:"سبب الخصم مطلوب",variant:"destructive"});return}ee(!1),ye(!0)},Ze=()=>{ye(!1),we(!0)},es=async()=>{try{if(!o)return;const Re=Math.max(0,Number(Te||0));if(!Number.isFinite(Re)||Re<=0){E({title:"مبلغ غير صالح",description:"أدخل مبلغ خصم صحيح أكبر من الصفر",variant:"destructive"});return}const nt=Math.max(0,Number(P)-Re);q(nt),await Ae.updateUserData(o,{cashBalance:nt});try{localStorage.setItem(`cashBalance_${o}`,String(nt))}catch{}const Ie={title:"ايصال خصم من الفلوس النقديه",type:"cash_deduction",amount:Re,status:"completed",createdAt:new Date,note:fe,cashierName:"الحساب الرئيسي"};try{await Ae.saveUserTransaction(o,Ie)}catch{}E({title:"تم الخصم",description:`تم خصم ${Re.toFixed(2)} من الدرج`}),we(!1),Me(""),se("")}catch{E({title:"فشل الخصم",description:"تعذر تنفيذ عملية الخصم",variant:"destructive"})}};return e.jsx(de,{open:i,onOpenChange:u,children:e.jsxs(me,{className:"sm:max-w-lg animate-in fade-in-90 zoom-in-95 slide-in-from-top-4",dir:"rtl",children:[e.jsx(he,{children:e.jsxs(ue,{className:"flex items-center gap-2 text-right",children:[e.jsx(At,{className:"h-5 w-5 text-emerald-600"}),"تفاصيل الفلوس النقدية"]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between bg-amber-50 border border-amber-200 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-amber-800 font-bold text-sm",children:[e.jsx(At,{className:"h-4 w-4"}),"مجموع الفلوس النقدية (الدرج)"]}),e.jsx("div",{className:"text-amber-700 font-extrabold text-sm",children:et(P)})]}),e.jsxs("div",{className:"flex items-center justify-between bg-blue-50 border border-blue-200 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-blue-800 font-bold text-sm",children:[e.jsx(fr,{className:"h-4 w-4"}),"فلوس الإكسسوار (اليوم)"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-blue-700 font-extrabold text-sm",children:et(G)}),e.jsx(h,{size:"sm",variant:"ghost",className:"h-6 px-2 rounded-lg bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800",onClick:()=>{re("accessory"),V(!0)},children:"تم الاستلام"})]})]}),e.jsxs("div",{className:"flex items-center justify-between bg-indigo-50 border border-indigo-200 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-indigo-800 font-bold text-sm",children:[e.jsx(ki,{className:"h-4 w-4"}),"فلوس فوري إلى الدرج (اليوم)"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-indigo-700 font-extrabold text-sm",children:et(ne)}),e.jsx(h,{size:"sm",variant:"ghost",className:"h-6 px-2 rounded-lg bg-gradient-to-r from-indigo-100 to-indigo-200 text-indigo-700 hover:from-indigo-200 hover:to-indigo-300 hover:text-indigo-800",onClick:()=>{re("fawry"),V(!0)},children:"تم الاستلام"})]})]}),e.jsxs("div",{className:"flex items-center justify-between bg-red-50 border border-red-200 rounded-lg p-2",children:[e.jsx("div",{className:"flex items-center gap-2 text-red-800 font-bold text-sm",children:"خصم فلوس من الفلوس النقديه"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(h,{size:"sm",variant:"ghost",className:"h-6 px-2 rounded-lg bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800",onClick:Q,children:"خصم"})})]})]}),e.jsx(rs,{open:M,onOpenChange:V,mode:"verify",title:"تأكيد الرقم السري لعملية تم الاستلام",description:"يرجى إدخال الرقم السري الرئيسي لتأكيد استلام المبلغ",onSuccess:()=>{J&&(Qe(J),re(null)),V(!1)}}),e.jsx(de,{open:oe,onOpenChange:ee,children:e.jsxs(me,{className:"sm:max-w-sm",children:[e.jsx(he,{children:e.jsx(ue,{children:"سبب الخصم"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"deduct-reason",children:"اكتب سبب الخصم"}),e.jsx(U,{id:"deduct-reason",value:fe,onChange:Re=>se(Re.target.value),placeholder:"سبب الخصم"})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-3",children:[e.jsx(h,{variant:"outline",onClick:()=>ee(!1),children:"إلغاء"}),e.jsx(h,{onClick:Ne,className:"bg-red-600 hover:bg-red-700",children:"متابعة"})]})]})}),e.jsx(rs,{open:te,onOpenChange:ye,mode:"verify",title:"تأكيد الرقم السري لعملية الخصم",description:"يرجى إدخال الرقم السري الرئيسي لمتابعة الخصم",onSuccess:Ze}),e.jsx(de,{open:We,onOpenChange:we,children:e.jsxs(me,{className:"sm:max-w-sm",children:[e.jsx(he,{children:e.jsx(ue,{children:"مبلغ الخصم"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"deduct-amount",children:"أدخل مبلغ الخصم"}),e.jsx(U,{id:"deduct-amount",type:"number",value:Te,onChange:Re=>Me(Re.target.value),placeholder:"0.00"})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-3",children:[e.jsx(h,{variant:"outline",onClick:()=>we(!1),children:"إلغاء"}),e.jsx(h,{onClick:es,className:"bg-red-600 hover:bg-red-700",children:"تأكيد الخصم"})]})]})})]})})};function Po({size:i=24,className:u,...o}){return e.jsxs("svg",{width:i,height:i,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",className:u,...o,children:[e.jsx("rect",{x:"5",y:"2.5",width:"14",height:"19",rx:"2.5",stroke:"currentColor",strokeWidth:"1.5"}),e.jsx("rect",{x:"7",y:"4.5",width:"10",height:"5.5",rx:"1",stroke:"currentColor",strokeWidth:"1.2"}),e.jsx("path",{d:"M9.5 11.5h5",stroke:"currentColor",strokeWidth:"1.4",strokeLinecap:"round"}),e.jsx("circle",{cx:"8.5",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"12",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"15.5",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"8.5",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"12",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"15.5",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("rect",{x:"8",y:"19",width:"9",height:"1.8",rx:"0.6",stroke:"currentColor",strokeWidth:"1"})]})}var ko="AlertDialog",[nh]=Zd(ko,[No]),Zs=No(),Oo=i=>{const{__scopeAlertDialog:u,...o}=i,p=Zs(u);return e.jsx(dm,{...p,...o,modal:!0})};Oo.displayName=ko;var ih="AlertDialogTrigger",lh=n.forwardRef((i,u)=>{const{__scopeAlertDialog:o,...p}=i,v=Zs(o);return e.jsx(fm,{...v,...p,ref:u})});lh.displayName=ih;var oh="AlertDialogPortal",Eo=i=>{const{__scopeAlertDialog:u,...o}=i,p=Zs(u);return e.jsx(mm,{...p,...o})};Eo.displayName=oh;var ch="AlertDialogOverlay",_o=n.forwardRef((i,u)=>{const{__scopeAlertDialog:o,...p}=i,v=Zs(o);return e.jsx(gm,{...v,...p,ref:u})});_o.displayName=ch;var Ua="AlertDialogContent",[dh,mh]=nh(Ua),hh=em("AlertDialogContent"),Wo=n.forwardRef((i,u)=>{const{__scopeAlertDialog:o,children:p,...v}=i,j=Zs(o),s=n.useRef(null),D=vo(u,s),B=n.useRef(null);return e.jsx(hm,{contentName:Ua,titleName:Fo,docsSlug:"alert-dialog",children:e.jsx(dh,{scope:o,cancelRef:B,children:e.jsxs(um,{role:"alertdialog",...j,...v,ref:D,onOpenAutoFocus:Xd(v.onOpenAutoFocus,C=>{var A;C.preventDefault(),(A=B.current)==null||A.focus({preventScroll:!0})}),onPointerDownOutside:C=>C.preventDefault(),onInteractOutside:C=>C.preventDefault(),children:[e.jsx(hh,{children:p}),e.jsx(xh,{contentRef:s})]})})})});Wo.displayName=Ua;var Fo="AlertDialogTitle",Mo=n.forwardRef((i,u)=>{const{__scopeAlertDialog:o,...p}=i,v=Zs(o);return e.jsx(xm,{...v,...p,ref:u})});Mo.displayName=Fo;var Lo="AlertDialogDescription",Ro=n.forwardRef((i,u)=>{const{__scopeAlertDialog:o,...p}=i,v=Zs(o);return e.jsx(pm,{...v,...p,ref:u})});Ro.displayName=Lo;var uh="AlertDialogAction",Bo=n.forwardRef((i,u)=>{const{__scopeAlertDialog:o,...p}=i,v=Zs(o);return e.jsx(jo,{...v,...p,ref:u})});Bo.displayName=uh;var $o="AlertDialogCancel",Uo=n.forwardRef((i,u)=>{const{__scopeAlertDialog:o,...p}=i,{cancelRef:v}=mh($o,o),j=Zs(o),s=vo(u,v);return e.jsx(jo,{...j,...p,ref:s})});Uo.displayName=$o;var xh=({contentRef:i})=>{const u=`\`${Ua}\` requires a description for the component to be accessible for screen reader users.

You can add a description to the \`${Ua}\` by passing a \`${Lo}\` component as a child, which also benefits sighted users by adding visible context to the dialog.

Alternatively, you can use your own component as a description by assigning it an \`id\` and passing the same value to the \`aria-describedby\` prop in \`${Ua}\`. If the description is confusing or duplicative for sighted users, you can use the \`@radix-ui/react-visually-hidden\` primitive as a wrapper around your description component.

For more information, see https://radix-ui.com/primitives/docs/components/alert-dialog`;return n.useEffect(()=>{var p;document.getElementById((p=i.current)==null?void 0:p.getAttribute("aria-describedby"))||console.warn(u)},[u,i]),null},ph=Oo,gh=Eo,zo=_o,qo=Wo,Vo=Bo,Jo=Uo,Ko=Mo,Yo=Ro;const fh=ph,yh=gh,Ho=n.forwardRef(({className:i,...u},o)=>e.jsx(zo,{className:Sa("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",i),...u,ref:o}));Ho.displayName=zo.displayName;const Go=n.forwardRef(({className:i,...u},o)=>e.jsxs(yh,{children:[e.jsx(Ho,{}),e.jsx(qo,{ref:o,className:Sa("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",i),...u})]}));Go.displayName=qo.displayName;const Qo=({className:i,...u})=>e.jsx("div",{className:Sa("flex flex-col space-y-2 text-center sm:text-left",i),...u});Qo.displayName="AlertDialogHeader";const Zo=n.forwardRef(({className:i,...u},o)=>e.jsx(Ko,{ref:o,className:Sa("text-lg font-semibold",i),...u}));Zo.displayName=Ko.displayName;const Xo=n.forwardRef(({className:i,...u},o)=>e.jsx(Yo,{ref:o,className:Sa("text-sm text-muted-foreground",i),...u}));Xo.displayName=Yo.displayName;const Ti=n.forwardRef(({className:i,...u},o)=>e.jsx(Vo,{ref:o,className:Sa(bo(),i),...u}));Ti.displayName=Vo.displayName;const ec=n.forwardRef(({className:i,...u},o)=>e.jsx(Jo,{ref:o,className:Sa(bo({variant:"outline"}),"mt-2 sm:mt-0",i),...u}));ec.displayName=Jo.displayName;const gt=i=>{try{return i.toLocaleString("en-US",{maximumFractionDigits:2})}catch{return String(i)}},xo=i=>{try{return(i?new Date(i):new Date).toLocaleString("en-GB",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}catch{return new Date().toISOString()}},aa="machine_daily_opening_values",wa="machine_daily_opening_snapshot";function vh({open:i,onOpenChange:u}){const{toast:o}=As(),{shiftUser:p}=jr(),{shopId:v,shopName:j}=yn();n.useEffect(()=>{try{if(i){const R=document.body.style.overflow;document.body.setAttribute("data-prev-overflow",R),document.body.style.overflow="hidden"}else{const R=document.body.getAttribute("data-prev-overflow")||"";document.body.style.overflow=R,document.body.removeAttribute("data-prev-overflow")}}catch{}return()=>{try{const R=document.body.getAttribute("data-prev-overflow")||"";document.body.style.overflow=R,document.body.removeAttribute("data-prev-overflow")}catch{}}},[i]);const[s,D]=n.useState(""),[B,C]=n.useState(""),[A,T]=n.useState(""),[g,y]=n.useState(null),[P,q]=n.useState(null),[M,V]=n.useState(null),[J,re]=n.useState(null),[E,_]=n.useState(!1),[oe,ee]=n.useState(!1),[fe,se]=n.useState(""),[te,ye]=n.useState(""),[We,we]=n.useState(null),[Te,Me]=n.useState([]),[et,G]=n.useState([]),[ne,Qe]=n.useState(!1),[Q,Ne]=n.useState(""),[Ze,es]=n.useState(""),[Re,nt]=n.useState(!1),[Ie,Le]=n.useState(null),[ct,tt]=n.useState([]),[xe,Ye]=n.useState(null),[Tt,vt]=n.useState("");n.useEffect(()=>{if(i)try{const R=xe?`${aa}_${xe}`:aa,je=xe?`${wa}_${xe}`:wa,Pe=localStorage.getItem(R);if(Pe){const Oe=JSON.parse(Pe);typeof(Oe==null?void 0:Oe.openingBase)=="number"&&y(Oe.openingBase),typeof(Oe==null?void 0:Oe.openingAir)=="number"&&q(Oe.openingAir),typeof(Oe==null?void 0:Oe.drawerCash)=="number"&&V(Oe.drawerCash)}else y(null),q(null),V(null);const He=localStorage.getItem(je);if(He){const Oe=JSON.parse(He);typeof(Oe==null?void 0:Oe.openingBase)=="number"&&typeof(Oe==null?void 0:Oe.openingAir)=="number"?re({openingBase:Oe.openingBase,openingAir:Oe.openingAir,drawerCash:Oe.drawerCash||0}):re(null)}else re(null)}catch{}},[i,xe]),n.useEffect(()=>{(async()=>{try{if(!i||!v)return;const{getDocs:R,query:je}=await ft(async()=>{const{getDocs:Ft,query:it}=await import("./index-5EflPS7Y.js").then(Bt=>Bt.bg);return{getDocs:Ft,query:it}},__vite__mapDeps([0,1]),import.meta.url),Pe=Ee(K,"shops",v,"machines"),Oe=(await R(je(Pe))).docs.map(Ft=>({id:Ft.id,name:String(Ft.data().name||"ماكينة")}));tt(Oe),!xe&&Oe.length>0&&Ye(Oe[0].id)}catch(R){console.error("Load machines error:",R)}})()},[i,v]);const W=n.useMemo(()=>(p==null?void 0:p.displayName)||(p==null?void 0:p.name)||(p==null?void 0:p.username)||void 0,[p]),ae=n.useMemo(()=>et.reduce((R,je)=>R+(je.profit||0),0),[et]),Fe=n.useMemo(()=>et.reduce((R,je)=>R+(je.wholesalePrice||0),0),[et]),st=()=>{et.length!==0&&(G([]),o({title:"تم حذف الإيصالات",description:"تم مسح كل إيصالات التحويل."}))},jt=()=>{Te.length!==0&&(Me([]),o({title:"تم حذف الإيصالات",description:"تم مسح كل إيصالات الماكينة."}))},Kt=R=>{Me(je=>je.filter(Pe=>Pe.id!==R)),o({title:"تم حذف الإيصال",description:"تم إزالة إيصال الماكينة المحدد."})},Dt=()=>{y(null),q(null),V(null),re(null),D(""),C(""),T("");try{const R=xe?`${aa}_${xe}`:aa,je=xe?`${wa}_${xe}`:wa;localStorage.removeItem(R),localStorage.removeItem(je)}catch{}o({title:"تم التصفير",description:"يمكنك الآن إدخال رصيد افتتاحي جديد."})},at=async()=>{var He;const R=parseFloat(s||"0"),je=parseFloat(B||"0"),Pe=parseFloat(A||"0");if(isNaN(R)||isNaN(je)||isNaN(Pe)){o({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة للرصيد الافتتاحي وفلوس الدرج.",variant:"destructive"});return}if(R<0||je<0||Pe<0){o({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}y(R),q(je),V(Pe);try{const Oe=xe?`${aa}_${xe}`:aa,Ft=xe?`${wa}_${xe}`:wa;if(localStorage.setItem(Oe,JSON.stringify({openingBase:R,openingAir:je,drawerCash:Pe})),localStorage.setItem(Ft,JSON.stringify({openingBase:R,openingAir:je,drawerCash:Pe})),re({openingBase:R,openingAir:je,drawerCash:Pe}),v&&xe){const it=ze(K,"shops",v,"machines",xe);await Ds(it,{name:((He=ct.find(Bt=>Bt.id===xe))==null?void 0:He.name)||"ماكينة",openingBase:R,openingAir:je,drawerCash:Pe,cashierName:W,shopName:j||null,updatedAt:Ge()},{merge:!0})}}catch{}o({title:"تم تسجيل البيانات",description:`الافتتاحي الأساسي: ${gt(R)}، الهواء: ${gt(je)}، فلوس الدرج: ${gt(Pe)}`})},Ue=()=>{if(g==null||P==null){o({title:"سجل الرصيد الافتتاحي أولاً",description:'يرجى الضغط على زر "إضافة" بعد إدخال الافتتاحي.'});return}ee(!0)},xt=()=>{const R=parseFloat(fe||"0"),je=parseFloat(te||"0");if(isNaN(R)||isNaN(je)){o({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة لرصيد التسليم.",variant:"destructive"});return}if(R<0||je<0){o({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}const Pe=(J==null?void 0:J.openingBase)??(g||0),He=(J==null?void 0:J.openingAir)??(P||0),Oe=Pe+He,it=R+je-Oe;we(it);const Bt={id:`${Date.now()}`,openingBase:Pe,openingAir:He,deliveryBase:R,deliveryAir:je,netResult:it,createdAt:new Date().toISOString(),cashierName:W,requiredDrawerNoProfit:it<0?Math.round(-it*100)/100:0};(async()=>{try{v&&xe&&(await Is(Ee(K,"shops",v,"machines",xe,"deliveries"),{cashierName:W,openingBase:Pe,openingAir:He,deliveryBase:R,deliveryAir:je,netResult:it,createdAt:Ge()}),await Ds(ze(K,"shops",v,"machines",xe),{lastDeliveryAt:Ge(),updatedAt:Ge()},{merge:!0}))}catch(Yt){console.error("Persist delivery error:",Yt)}})(),Me(Yt=>[Bt,...Yt]),o({title:"تم إنشاء إيصال تسليم",description:`الناتج النهائي: ${gt(it)}`})},Et=()=>{const R=parseFloat(Q||"0"),je=parseFloat(Ze||"0");if(!Number.isFinite(R)||!Number.isFinite(je)){o({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة لسعر الجملة وسعر التجزئة.",variant:"destructive"});return}if(R<0||je<0){o({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}if(g==null||P==null){o({title:"سجل الرصيد الافتتاحي أولاً",description:'يرجى إدخال الرصيد الأساسي ورصيد الهواء ثم الضغط "إضافة".'});return}const Pe=Math.round((je-R)*100)/100;Le({wholesalePrice:R,retailPrice:je,profit:Pe}),nt(!0)},_t=async R=>{if(!Ie)return;const je={id:`transfer_${Date.now()}`,wholesalePrice:Ie.wholesalePrice,retailPrice:Ie.retailPrice,profit:Ie.profit,createdAt:new Date().toISOString(),cashierName:W,deductFrom:R},Pe=Ie.wholesalePrice,He=g??0,Oe=P??0,Ft=M??0;if(Pe>(R==="base"?He:Oe)){o({title:"رصيد غير كافٍ",description:"لا يوجد رصيد كافٍ للخصم بسعر الجملة.",variant:"destructive"});return}const Bt=R==="base"?Math.round((He-Pe)*100)/100:He,Yt=R==="air"?Math.round((Oe-Pe)*100)/100:Oe,is=Math.round((Ft+Ie.retailPrice)*100)/100;y(Bt),q(Yt),V(is);try{if(localStorage.setItem(aa,JSON.stringify({openingBase:Bt,openingAir:Yt,drawerCash:is})),v&&xe){const mt=ze(K,"shops",v,"machines",xe);await Ds(mt,{openingBase:Bt,openingAir:Yt,drawerCash:is,cashierName:W,updatedAt:Ge()},{merge:!0}),await Is(Ee(K,"shops",v,"machines",xe,"transfers"),{wholesalePrice:Ie.wholesalePrice,retailPrice:Ie.retailPrice,profit:Ie.profit,deductFrom:R,cashierName:W,createdAt:Ge()})}}catch{}G(mt=>[je,...mt]),Qe(!1),Ne(""),es(""),Le(null),nt(!1),o({title:"تم تسجيل تحويل",description:`الربح الفوري: ${gt(je.profit)} | خصم المخزون: -${gt(Pe)} (${R==="base"?"الأساسي":"الهواء"}) | درج: +${gt(Ie.retailPrice)}`})},Wt=()=>{D(""),C(""),ee(!1),se(""),ye(""),we(null)},Pt=R=>{R||Wt(),u(R)};return e.jsxs(de,{open:i,onOpenChange:Pt,children:[e.jsxs(me,{className:"w-screen h-[100vh] overflow-hidden rounded-none p-0 flex flex-col dark:bg-[#121212]",children:[e.jsxs(he,{className:"sticky top-0 bg-white dark:bg-[#0F0F0F] z-20 border-b border-gray-200 dark:border-[#333] px-4 py-3",children:[e.jsx(ue,{className:"flex items-center justify-between text-right",children:e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(Po,{className:"h-5 w-5 text-yellow-500"}),"يومية المكنة"]})}),e.jsx(ss,{className:"text-right",children:'أدخل الرصيد الافتتاحي، ثم في نهاية اليوم قم بإدخال رصيد التسليم لإنشاء إيصال منظم باسم "إيصالات ماكينة".'})]}),e.jsxs("div",{className:"px-4 py-3 overflow-y-auto flex-1 grid grid-cols-1 gap-6",children:[e.jsxs(yt,{children:[e.jsx(Jt,{className:"pb-2",children:e.jsxs(cs,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-right",children:"اختيار ماكينة"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(h,{variant:"destructive",onClick:async()=>{try{if(!v||!xe)return;const R=ze(K,"shops",v,"machines",xe);try{const Pe=await ut(Ee(K,"shops",v,"machines",xe,"transfers"));await Promise.all(Pe.docs.map(He=>vs(He.ref)))}catch{}try{const Pe=await ut(Ee(K,"shops",v,"machines",xe,"deliveries"));await Promise.all(Pe.docs.map(He=>vs(He.ref)))}catch{}await vs(R),tt(Pe=>Pe.filter(He=>He.id!==xe));const je=ct.find(Pe=>Pe.id!==xe);Ye(je?je.id:null);try{const Pe=`${aa}_${xe}`,He=`${wa}_${xe}`;localStorage.removeItem(Pe),localStorage.removeItem(He)}catch{}o({title:"تم حذف الماكينة",description:"تمت الإزالة نهائيًا."})}catch{o({title:"فشل الحذف",description:"تعذر حذف الماكينة.",variant:"destructive"})}},disabled:!xe,title:"حذف الماكينة",children:e.jsx(Vt,{className:"h-4 w-4"})})})]})}),e.jsx(wt,{className:"space-y-3",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 items-end",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الماكينة الحالية"}),e.jsxs(ra,{value:xe??"",onValueChange:R=>Ye(R),children:[e.jsx(na,{className:"text-right",children:e.jsx(ia,{placeholder:"اختر ماكينة"})}),e.jsx(la,{children:ct.map(R=>e.jsx(Os,{value:R.id,children:R.name},R.id))})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-2",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"إنشاء ماكينة جديدة"}),e.jsx(U,{value:Tt,onChange:R=>vt(R.target.value),placeholder:"اسم الماكينة",className:"text-right"})]}),e.jsx("div",{className:"flex justify-end md:justify-start",children:e.jsx(h,{onClick:async()=>{try{if(!v){o({title:"لا يوجد محل",description:"يرجى التأكد من تحميل بيانات المحل.",variant:"destructive"});return}const R=(Tt||"").trim();if(!R){o({title:"اسم الماكينة مطلوب",description:"أدخل اسم للماكينة الجديدة.",variant:"destructive"});return}const je=await Is(Ee(K,"shops",v,"machines"),{name:R,shopId:v,createdAt:Ge(),updatedAt:Ge(),isActive:!0}),Pe={id:je.id,name:R};tt(He=>[Pe,...He]),Ye(je.id),vt(""),o({title:"تم إنشاء ماكينة",description:`تمت إضافة ${R}`})}catch(R){console.error("Create machine error:",R),o({title:"خطأ في الإنشاء",description:"تعذر إنشاء الماكينة.",variant:"destructive"})}},className:"bg-violet-600 hover:bg-violet-700",children:"إضافة"})})]})]})})]}),e.jsxs(yt,{children:[e.jsx(Jt,{className:"pb-2",children:e.jsxs(cs,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-right",children:"الرصيد الافتتاحي"}),e.jsx(h,{variant:"ghost",size:"sm",onClick:()=>_(R=>!R),className:"flex items-center gap-1",children:e.jsx(br,{className:`h-4 w-4 transition-transform ${E?"rotate-180":""}`})})]})}),e.jsxs("div",{className:"flex items-center justify-between px-6",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(h,{variant:"outline",onClick:()=>Qe(!0),disabled:g==null||P==null,className:"border-violet-300 text-violet-700",children:"تحويل"})}),g!=null&&P!=null&&e.jsxs(Ot,{className:"bg-violet-100 text-violet-700 border border-violet-200",children:["تم التسجيل: أساسي ",gt(g)," | هواء ",gt(P)," | درج ",gt(M??0)]})]}),e.jsxs(wt,{className:`space-y-4 ${E?"":"hidden"}`,children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الرصيد الأساسي"}),e.jsx(U,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:s,onChange:R=>D(R.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"رصيد الهواء"}),e.jsx(U,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:B,onChange:R=>C(R.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"فلوس الدرج"}),e.jsx(U,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:A,onChange:R=>T(R.target.value),placeholder:"0.00",className:"text-right"})]})]}),e.jsxs("div",{className:"flex items-center justify-end",children:[e.jsx(h,{variant:"outline",className:"mr-2",onClick:Dt,children:"تصفير"}),e.jsx(h,{onClick:at,className:"bg-violet-600 hover:bg-violet-700",children:"إضافة"})]})]})]}),e.jsxs(yt,{children:[e.jsx(Jt,{className:"pb-2",children:e.jsxs(cs,{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-right",children:"إيصالات تحويل"}),e.jsxs(Ot,{className:"bg-green-100 text-green-700 border border-green-200",children:["ربح: ",gt(ae)]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(h,{variant:"outline",size:"sm",onClick:st,className:"border-red-300 text-red-700 hover:bg-red-50",children:"حذف الإيصالات"}),e.jsx(hn,{className:"h-4 w-4 text-gray-500"})]})]})}),e.jsx(wt,{className:"space-y-3",children:et.length===0?e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد تحويلات مسجلة."}):e.jsx("div",{className:"space-y-3 max-h-52 overflow-y-auto pr-1",children:et.map(R=>e.jsxs("div",{className:"rounded-lg border p-3 grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"سعر الجملة"}),e.jsx("p",{className:"text-sm",children:gt(R.wholesalePrice)})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"سعر التجزئة"}),e.jsx("p",{className:"text-sm",children:gt(R.retailPrice)})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"الربح الفوري"}),e.jsx("p",{className:"text-sm text-green-700",children:gt(R.profit)}),R.deductFrom&&e.jsx("div",{className:"mt-1",children:e.jsxs("span",{className:"text-[11px] bg-violet-100 text-violet-700 border border-violet-200 rounded px-2 py-0.5",children:["الخصم من: ",R.deductFrom==="base"?"الأساسي":"الهواء"]})}),e.jsxs("div",{className:"flex items-center justify-end gap-2 text-xs text-gray-500",children:[e.jsx(da,{className:"h-3 w-3"}),e.jsx("span",{children:xo(R.createdAt)}),R.cashierName&&e.jsxs(e.Fragment,{children:[e.jsx(Ii,{orientation:"vertical",className:"h-3"}),e.jsxs("span",{children:["الكاشير: ",R.cashierName]})]})]})]})]},R.id))})})]}),e.jsxs(yt,{children:[e.jsx(Jt,{className:"pb-2",children:e.jsx(cs,{className:"text-right",children:"نهاية اليوم"})}),e.jsx(wt,{className:"space-y-4",children:oe?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الرصيد الأساسي الحالي"}),e.jsx(U,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:fe,onChange:R=>se(R.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"رصيد الهواء الحالي"}),e.jsx(U,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:te,onChange:R=>ye(R.target.value),placeholder:"0.00",className:"text-right"})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(h,{variant:"secondary",onClick:()=>ee(!1),children:"إلغاء"}),e.jsx(h,{onClick:xt,className:"bg-green-600 hover:bg-green-700",children:"تسليم"})]}),We!=null&&e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{className:"text-right",children:e.jsxs(Ot,{className:We>=0?"bg-green-100 text-green-700 border border-green-200":"bg-red-100 text-red-700 border border-red-200",children:["الناتج النهائي: ",gt(We)]})}),e.jsxs("div",{className:"mt-2 flex items-center justify-end gap-2",children:[e.jsxs(Ot,{className:"bg-blue-100 text-blue-700 border border-blue-200",children:["المجموع النهائي: ",gt(parseFloat(fe||"0")+parseFloat(te||"0"))]}),e.jsxs(Ot,{className:"bg-amber-100 text-amber-700 border border-amber-200",children:["مطلوب من الدرج (بدون أرباح): ",gt(Fe)]})]})]})]}):e.jsx("div",{className:"flex justify-end",children:e.jsx(h,{variant:"outline",onClick:Ue,className:"border-violet-300 text-violet-700",children:"تسليم يومية"})})})]}),e.jsxs(yt,{children:[e.jsx(Jt,{className:"pb-2",children:e.jsxs(cs,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-right",children:"إيصالات ماكينة"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(h,{variant:"outline",size:"sm",onClick:jt,className:"border-red-300 text-red-700 hover:bg-red-50",children:"حذف الإيصالات"}),e.jsx(hn,{className:"h-4 w-4 text-gray-500"})]})]})}),e.jsx(wt,{className:"space-y-3",children:Te.length===0?e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد إيصالات حتى الآن."}):e.jsx("div",{className:"space-y-3",children:Te.map(R=>e.jsxs("div",{className:"rounded-lg border p-3 grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"الافتتاحي"}),e.jsxs("p",{className:"text-sm",children:["أساسي: ",gt(R.openingBase)]}),e.jsxs("p",{className:"text-sm",children:["هواء: ",gt(R.openingAir)]})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"التسليم"}),e.jsxs("p",{className:"text-sm",children:["أساسي: ",gt(R.deliveryBase)]}),e.jsxs("p",{className:"text-sm",children:["هواء: ",gt(R.deliveryAir)]})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("div",{className:"flex items-center justify-end",children:e.jsxs(h,{variant:"outline",size:"sm",onClick:()=>Kt(R.id),className:"border-red-300 text-red-700 hover:bg-red-50",children:[e.jsx(Vt,{className:"h-3 w-3 mr-1"})," حذف"]})}),e.jsx("p",{className:"text-xs text-gray-500",children:"النتيجة"}),e.jsx("p",{className:`text-sm ${R.netResult>=0?"text-green-700":"text-red-700"}`,children:gt(R.netResult)}),e.jsxs("div",{className:"mt-1 flex items-center justify-end gap-2",children:[e.jsxs("span",{className:"text-[11px] bg-blue-100 text-blue-700 border border-blue-200 rounded px-2 py-0.5",children:["المجموع النهائي: ",gt(R.deliveryBase+R.deliveryAir)]}),typeof R.requiredDrawerNoProfit=="number"&&e.jsxs("span",{className:"text-[11px] bg-amber-100 text-amber-700 border border-amber-200 rounded px-2 py-0.5",children:["مطلوب من الدرج (بدون أرباح): ",gt(R.requiredDrawerNoProfit||0)]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2 text-xs text-gray-500",children:[e.jsx(da,{className:"h-3 w-3"}),e.jsx("span",{children:xo(R.createdAt)}),R.cashierName&&e.jsxs(e.Fragment,{children:[e.jsx(Ii,{orientation:"vertical",className:"h-3"}),e.jsxs("span",{children:["الكاشير: ",R.cashierName]})]})]})]})]},R.id))})})]})]}),e.jsxs(rt,{className:"sticky bottom-0 bg-white dark:bg-[#0F0F0F] z-20 border-t border-gray-200 dark:border-[#333] px-4 py-3 flex items-center justify-between",children:[e.jsx(h,{variant:"outline",onClick:()=>Pt(!1),children:"إغلاق"}),e.jsxs("div",{className:"text-xs text-gray-500 flex items-center gap-1",children:[e.jsx(Qs,{className:"h-3 w-3"}),e.jsx("span",{children:"يسجل التاريخ والوقت تلقائياً لكل إيصال"})]})]})]}),e.jsx(de,{open:ne,onOpenChange:Qe,children:e.jsxs(me,{className:"sm:max-w-sm",children:[e.jsx(he,{children:e.jsx(ue,{children:"تحويل رصيد"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"سعر الجملة"}),e.jsx(U,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:Q,onChange:R=>Ne(R.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"سعر التجزئة"}),e.jsx(U,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:Ze,onChange:R=>es(R.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsx("div",{className:"text-right",children:e.jsxs(Ot,{className:"bg-green-100 text-green-700 border border-green-200",children:["الربح الفوري: ",gt(parseFloat(Ze||"0")-parseFloat(Q||"0")||0)]})})]}),e.jsxs(rt,{className:"flex items-center justify-end gap-2",children:[e.jsx(h,{variant:"secondary",onClick:()=>Qe(!1),children:"إلغاء"}),e.jsx(h,{onClick:Et,className:"bg-violet-600 hover:bg-violet-700",children:"تحويل"})]})]})}),e.jsx(fh,{open:Re,onOpenChange:nt,children:e.jsxs(Go,{children:[e.jsxs(Qo,{children:[e.jsx(Zo,{children:"اختيار مصدر الخصم"}),e.jsx(Xo,{children:"هل يتم الخصم من الرصيد الأساسي أم من رصيد الهواء؟"})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2 mt-4",children:[e.jsx(ec,{onClick:()=>nt(!1),children:"رجوع"}),e.jsx(Ti,{onClick:()=>_t("base"),children:"خصم من الأساسي"}),e.jsx(Ti,{onClick:()=>_t("air"),children:"خصم من الهواء"})]})]})})]})}function bh(i,u=300){const[o,p]=qe.useState(i);return qe.useEffect(()=>{const v=setTimeout(()=>p(i),u);return()=>clearTimeout(v)},[i,u]),o}const wh=({userId:i,transactions:u})=>{const[o,p]=n.useState(!1),[v,j]=n.useState(!1),[s,D]=n.useState(!1),[B,C]=n.useState({monthlyWithdrawalProfit:0,monthlyTransferProfit:0,lastUpdated:new Date}),{userSubscription:A}=$s();n.useEffect(()=>{i&&o&&s&&T()},[i,o,s]);const T=async()=>{if(i)try{if(Array.isArray(u)&&u.length>0){const V=new Date,J=V.getMonth(),re=V.getFullYear(),E=Zt.filterVisibleTransactions(u,"monthly",i);let _=0,oe=0;E.forEach(ee=>{const fe=new Date(ee.createdAt),se=String(ee.status||"confirmed").toLowerCase();if(fe.getMonth()!==J||fe.getFullYear()!==re||se!=="completed"&&se!=="confirmed")return;const te=(ee.type||ee.txnType||"").toLowerCase(),ye={type:te==="withdrawal"?"withdraw":te,amount:Number(ee.amount||0),commission:ee.commission};ye.type==="withdraw"?_+=oa.calculateProfitFromTransaction(ye):(ye.type==="send"||ye.type==="receive"||ye.type==="transfer")&&(oe+=oa.calculateProfitFromTransaction(ye))}),C({monthlyWithdrawalProfit:Math.round(_*100)/100,monthlyTransferProfit:Math.round(oe*100)/100,lastUpdated:new Date});return}const M=oa.getWithdrawTransferProfits(i);C({monthlyWithdrawalProfit:M.monthlyWithdrawProfit||0,monthlyTransferProfit:M.monthlyTransferProfit||0,lastUpdated:new Date})}catch(M){console.error("Error loading profit data:",M)}},g=M=>`${M.toFixed(2)} ج.م`,y=async()=>{try{const M=(A==null?void 0:A.subscription)||null,V=(M==null?void 0:M.planType)??(M==null?void 0:M.plan)??null,J=typeof V=="string"?V.toLowerCase():null;if(V===Fs.ZERO||J==="zero"||J==="0"||V===0)return!0}catch{}try{if(i){const M=await Pi(i),V=(M==null?void 0:M.planType)??(M==null?void 0:M.plan)??null,J=typeof V=="string"?V.toLowerCase():null;if(V===Fs.ZERO||J==="zero"||J==="0"||V===0)return!0}}catch{}return!1},P=async()=>{try{if(await y()){to({title:"الخطة زيرو",description:"عرض الأرباح الشهرية غير متاح في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}catch{}j(!0)},q=async()=>{try{if(await y()){to({title:"الخطة زيرو",description:"عرض الأرباح الشهرية غير متاح في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"}),j(!1);return}}catch{}D(!0),p(!0),j(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(h,{size:"sm",variant:"ghost",onClick:P,className:"h-2 w-2 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded transition-all duration-300 hover:scale-110 shadow-sm hover:shadow-md",title:"عرض الأرباح الشهرية",children:e.jsx(Nt,{className:"h-1.5 w-1.5"})}),e.jsx(de,{open:o,onOpenChange:p,children:e.jsxs(me,{className:"max-w-[220px] mx-auto bg-white border border-gray-200 shadow-md rounded sm:max-w-[180px] sm:bg-gradient-to-br sm:from-purple-50 sm:to-white sm:border-2 sm:border-purple-200 sm:shadow-2xl sm:rounded-2xl",children:[e.jsx(he,{className:"text-center pb-0 border-b-0 sm:pb-2 sm:border-b sm:border-purple-200",children:e.jsxs(ue,{className:"text-xs font-bold text-purple-800 flex items-center justify-center gap-0 mb-0 leading-tight tracking-tight sm:text-xs sm:gap-1 sm:mb-0 sm:leading-normal sm:tracking-normal",children:[e.jsx(da,{className:"h-2 w-2 text-purple-600 sm:h-3 sm:w-3"}),"شهري"]})}),e.jsx("div",{className:"py-0 sm:py-3",children:e.jsxs("div",{className:"rounded-xl border border-purple-300 bg-white overflow-hidden",children:[e.jsx("div",{className:"p-2 sm:p-3 bg-red-50 border-b border-purple-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(pn,{className:"h-3 w-3 text-red-600"}),e.jsx("span",{className:"font-medium text-red-800 text-xs",children:"سحب"})]}),e.jsx("span",{className:"font-bold text-sm text-red-900 bg-white px-2 py-0.5 rounded",children:g(B.monthlyWithdrawalProfit)})]})}),e.jsx("div",{className:"p-2 sm:p-3 bg-blue-50 border-b border-purple-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ki,{className:"h-3 w-3 text-blue-600"}),e.jsx("span",{className:"font-medium text-blue-800 text-xs",children:"تحويل"})]}),e.jsx("span",{className:"font-bold text-sm text-blue-900 bg-white px-2 py-0.5 rounded",children:g(B.monthlyTransferProfit)})]})}),e.jsx("div",{className:"p-2 sm:p-3 bg-purple-50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(At,{className:"h-3 w-3 text-purple-600"}),e.jsx("span",{className:"font-medium text-purple-800 text-xs",children:"إجمالي"})]}),e.jsx("span",{className:"font-bold text-sm text-purple-900 bg-white px-2 py-0.5 rounded",children:g(B.monthlyWithdrawalProfit+B.monthlyTransferProfit)})]})})]})}),!s&&e.jsx("div",{className:"absolute inset-0 bg-yellow-200/70 backdrop-blur-sm flex items-center justify-center rounded sm:rounded-2xl border border-yellow-300 pointer-events-auto",children:e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>j(!0),className:"p-2 bg-yellow-300/80 text-yellow-900 hover:bg-yellow-400/90 rounded-full shadow-sm hover:shadow-md transition-all duration-300",title:"إدخال الرقم السري الرئيسي",children:e.jsx(Nt,{className:"h-4 w-4"})})}),e.jsx("div",{className:"flex justify-center pt-0 border-t-0 sm:pt-2 sm:border-t sm:border-purple-200",children:e.jsx(h,{onClick:()=>p(!1),className:"bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-xl text-sm sm:bg-gradient-to-r sm:from-purple-600 sm:to-purple-700 sm:hover:from-purple-700 sm:hover:to-purple-800 sm:px-4 sm:py-1 sm:rounded-xl sm:shadow-lg sm:hover:shadow-xl sm:transition-all sm:duration-300",children:"إغلاق"})})]})}),e.jsx(rs,{open:v,onOpenChange:j,onSuccess:q,description:"لا يمكن الاطلاع على الأرباح الشهرية إلا بإدخال الرقم السري الرئيسي"})]})},Nh=i=>e.jsx(wh,{...i});function jh({open:i,onOpenChange:u,onSuccess:o,userId:p}){const[v,j]=n.useState(""),[s,D]=n.useState(""),[B,C]=n.useState(!1),[A,T]=n.useState(!1),[g,y]=n.useState(""),[P,q]=n.useState(!1),[M,V]=n.useState(!1),{toast:J}=As();n.useEffect(()=>{let _=!0;return(async()=>{const oe=await ns.hasMasterPin(p);_&&V(oe)})(),()=>{_=!1}},[p,i]);const re=()=>{j(""),D(""),y(""),C(!1),T(!1),u(!1)},E=async _=>{_.preventDefault(),y(""),q(!0);try{if(M){if(!await ns.verifyMasterPin(v,p)){y("الرقم السري غير صحيح"),q(!1);return}}else{if(v.length<4){y("يجب أن يكون الرقم السري 4 أرقام على الأقل"),q(!1);return}if(v!==s){y("الرقم السري غير متطابق"),q(!1);return}if(!await ns.createMasterPin(v,p)){y("تعذر إنشاء الرقم السري الرئيسي"),q(!1);return}}J({title:"نجح العملية",description:M?"تم التحقق من الرقم السري الرئيسي بنجاح":"تم إنشاء الرقم السري الرئيسي بنجاح"}),o(),re()}catch{y("حدث خطأ أثناء معالجة الرقم السري")}finally{q(!1)}};return e.jsx(de,{open:i,onOpenChange:u,children:e.jsxs(me,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(he,{children:e.jsxs(ue,{className:"flex items-center gap-2 text-lg font-semibold",children:[e.jsx(ja,{className:"h-5 w-5 text-green-600"}),M?"أدخل الرقم السري الرئيسي":"إنشاء الرقم السري الرئيسي"]})}),e.jsxs("form",{onSubmit:E,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-gray-600 bg-blue-50 p-3 rounded-lg",children:M?"أدخل الرقم السري الرئيسي لعرض بيانات الأرباح":"قم بإنشاء الرقم السري الرئيسي لحماية بيانات الأرباح. يمكنك تغييره لاحقاً من إعدادات البروفيل."}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"pin",children:M?"الرقم السري الرئيسي":"الرقم السري الرئيسي الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"pin",type:B?"text":"password",value:v,onChange:_=>j(_.target.value),placeholder:M?"أدخل الرقم السري":"أدخل رقم سري جديد (4 أرقام على الأقل)",className:"pr-10",dir:"ltr",autoComplete:"off",required:!0}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>C(!B),children:B?e.jsx(Xt,{className:"h-4 w-4"}):e.jsx(Nt,{className:"h-4 w-4"})})]})]}),!M&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"confirmPin",children:"تأكيد الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{id:"confirmPin",type:A?"text":"password",value:s,onChange:_=>D(_.target.value),placeholder:"أعد إدخال الرقم السري",className:"pr-10",dir:"ltr",autoComplete:"off",required:!0}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>T(!A),children:A?e.jsx(Xt,{className:"h-4 w-4"}):e.jsx(Nt,{className:"h-4 w-4"})})]})]}),g&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(Da,{className:"h-4 w-4"}),g]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(h,{type:"submit",disabled:P,className:"flex-1 bg-green-600 hover:bg-green-700",children:[e.jsx(ja,{className:"h-4 w-4 mr-2"}),P?"جاري المعالجة...":M?"عرض الأرباح":"إنشاء وعرض الأرباح"]}),e.jsx(h,{type:"button",variant:"outline",onClick:re,disabled:P,children:"إلغاء"})]})]})]})})}const Sh=({userId:i,transactions:u})=>{const[o,p]=n.useState(!1),[v,j]=n.useState(!1),[s,D]=n.useState(!1),[B,C]=n.useState({dailyWithdrawalProfit:0,dailyTransferProfit:0,lastUpdated:new Date});n.useEffect(()=>{i&&o&&s&&A()},[i,o,s]);const A=async()=>{if(i)try{if(Array.isArray(u)&&u.length>0){const q=new Date,M=Zt.filterVisibleTransactions(u,"daily",i);let V=0,J=0;M.forEach(re=>{const E=new Date(re.createdAt),_=String(re.status||"confirmed").toLowerCase();if(E.toDateString()!==q.toDateString()||_!=="completed"&&_!=="confirmed")return;const oe=(re.type||re.txnType||"").toLowerCase(),ee={type:oe==="withdrawal"?"withdraw":oe,amount:Number(re.amount||0),commission:re.commission};ee.type==="withdraw"?V+=oa.calculateProfitFromTransaction(ee):(ee.type==="send"||ee.type==="receive"||ee.type==="transfer")&&(J+=oa.calculateProfitFromTransaction(ee))}),C({dailyWithdrawalProfit:Math.round(V*100)/100,dailyTransferProfit:Math.round(J*100)/100,lastUpdated:new Date});try{oa.updateProfitsFromTransactions(u,i)}catch{}return}const P=oa.getWithdrawTransferProfits(i);C({dailyWithdrawalProfit:P.dailyWithdrawProfit||0,dailyTransferProfit:P.dailyTransferProfit||0,lastUpdated:new Date})}catch(P){console.error("Error loading profit data:",P)}},T=P=>`${P.toFixed(2)} ج.م`,g=()=>{oa.hasProfitPin(i),j(!0)},y=()=>{D(!0),p(!0),j(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(h,{size:"sm",variant:"ghost",onClick:g,className:"h-2 w-2 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded transition-all duration-300 hover:scale-110 shadow-sm hover:shadow-md",title:"عرض الأرباح اليومية",children:e.jsx(Nt,{className:"h-1.5 w-1.5"})}),e.jsx(de,{open:o,onOpenChange:p,children:e.jsxs(me,{className:"max-w-[220px] mx-auto bg-white border border-gray-200 shadow-md rounded sm:max-w-[180px] sm:bg-gradient-to-br sm:from-blue-50 sm:to-white sm:border-2 sm:border-blue-200 sm:shadow-2xl sm:rounded-2xl",children:[e.jsx(he,{className:"text-center pb-0 border-b-0 sm:pb-2 sm:border-b sm:border-blue-200",children:e.jsxs(ue,{className:"text-xs font-bold text-blue-800 flex items-center justify-center gap-0 mb-0 leading-tight tracking-tight sm:text-sm sm:gap-1 sm:mb-0 sm:leading-normal sm:tracking-normal",children:[e.jsx(At,{className:"h-2 w-2 text-blue-600 sm:h-3 sm:w-3"}),"يومي"]})}),e.jsx("div",{className:"py-0 sm:py-3",children:e.jsxs("div",{className:"rounded-xl border border-blue-300 bg-white overflow-hidden",children:[e.jsx("div",{className:"p-2 sm:p-3 bg-red-50 border-b border-blue-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(pn,{className:"h-3 w-3 text-red-600"}),e.jsx("span",{className:"font-medium text-red-800 text-xs",children:"سحب"})]}),e.jsx("span",{className:"font-bold text-sm text-red-900 bg-white px-2 py-0.5 rounded",children:T(B.dailyWithdrawalProfit)})]})}),e.jsx("div",{className:"p-2 sm:p-3 bg-green-50 border-b border-blue-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ki,{className:"h-3 w-3 text-green-600"}),e.jsx("span",{className:"font-medium text-green-800 text-xs",children:"تحويل"})]}),e.jsx("span",{className:"font-bold text-sm text-green-900 bg-white px-2 py-0.5 rounded",children:T(B.dailyTransferProfit)})]})}),e.jsx("div",{className:"p-2 sm:p-3 bg-blue-50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(At,{className:"h-3 w-3 text-blue-600"}),e.jsx("span",{className:"font-medium text-blue-800 text-xs",children:"إجمالي"})]}),e.jsx("span",{className:"font-bold text-sm text-blue-900 bg-white px-2 py-0.5 rounded",children:T(B.dailyWithdrawalProfit+B.dailyTransferProfit)})]})})]})}),e.jsx("div",{className:"flex justify-center pt-0 border-t-0 sm:pt-2 sm:border-t sm:border-blue-200",children:e.jsx(h,{onClick:()=>p(!1),className:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-xl text-sm sm:bg-gradient-to-r sm:from-blue-600 sm:to-blue-700 sm:hover:from-blue-700 sm:hover:to-blue-800 sm:px-4 sm:py-1 sm:rounded-xl sm:shadow-lg sm:hover:shadow-xl sm:transition-all sm:duration-300 sm:text-xs",children:"إغلاق"})})]})}),e.jsx(jh,{open:v,onOpenChange:j,onSuccess:y,userId:i})]})},Dh=i=>e.jsx(Sh,{...i}),Ch=({open:i,onOpenChange:u})=>{var L;const{shiftUser:o,isShiftActive:p,shiftStartAt:v,setShiftUser:j,startShift:s,endShift:D}=jr(),{userSubscription:B,user:C,signIn:A,profile:T}=$s(),{toast:g}=As(),[y,P]=n.useState((o==null?void 0:o.name)||""),[q,M]=n.useState((o==null?void 0:o.username)||""),[V,J]=n.useState(""),[re,E]=n.useState(!1),[_,oe]=n.useState(null),[ee,fe]=n.useState(""),[se,te]=n.useState(""),[ye,We]=n.useState(!1),[we,Te]=n.useState(null),[Me,et]=n.useState(""),[G,ne]=n.useState(""),[Qe,Q]=n.useState(!1),[Ne,Ze]=n.useState(!1),[es,Re]=n.useState({totalTransfers:0,totalWithdrawals:0}),[nt,Ie]=n.useState(null),[Le,ct]=n.useState(""),[tt,xe]=n.useState(""),[Ye,Tt]=n.useState(0),[vt,W]=n.useState({}),[ae,Fe]=n.useState(0),[st,jt]=n.useState(0),[Kt,Dt]=n.useState({}),[at,Ue]=n.useState(""),[xt,Et]=n.useState(!1),_t=()=>`cashierUsers_${(C==null?void 0:C.uid)||"default"}`,[Wt,Pt]=n.useState(()=>{try{let N=localStorage.getItem(_t());if(!N){const k=localStorage.getItem("cashierUsers");k&&(N=k)}return N?JSON.parse(N):[]}catch{return[]}});n.useEffect(()=>{(async()=>{try{if(!(C!=null&&C.uid))return;const N=ze(K,"profiles",C.uid,"cashierUsers","list"),k=await ca(N);if(k.exists()){const Y=k.data(),X=Array.isArray(Y==null?void 0:Y.users)?Y.users:[];X&&X.length>0&&Pt(X)}}catch{}})()},[C==null?void 0:C.uid]),n.useEffect(()=>{if(!(C!=null&&C.uid))return;const N=ze(K,"profiles",C.uid,"cashierUsers","list"),k=Rs(N,Y=>{try{if(Y.exists()){const X=Y.data(),pe=Array.isArray(X==null?void 0:X.users)?X.users:[];if(pe&&pe.length>0)Pt(pe);else try{const le=localStorage.getItem(_t()),Ce=le?JSON.parse(le):[];Pt(Ce)}catch{Pt([])}}}catch{}},Y=>{console.warn("cashierUsers realtime subscription error:",Y)});return()=>k()},[C==null?void 0:C.uid]);const R=(L=B==null?void 0:B.subscription)==null?void 0:L.planType,je=R==="yearly"?2:R==="lifetime"?4:Number.POSITIVE_INFINITY;n.useEffect(()=>{try{localStorage.setItem(_t(),JSON.stringify(Wt));try{localStorage.removeItem("cashierUsers")}catch{}}catch{}(async()=>{try{if(!(C!=null&&C.uid))return;const N=ze(K,"profiles",C.uid,"cashierUsers","list");await Ds(N,{users:Wt},{merge:!0})}catch{}})()},[Wt]);const[Pe,He]=n.useState(!1),[Oe,Ft]=n.useState(""),[it,Bt]=n.useState(null),[Yt,is]=n.useState([]),[mt,bs]=n.useState(!1),[bt,Us]=n.useState(null),[ha,Ca]=n.useState(!1),[Ia,Ts]=n.useState(!1),Aa=N=>{const k=(o==null?void 0:o.username)===N;let Y=!1;try{Y=localStorage.getItem("lastHandoverToAdmin")==="true"}catch{}if(k&&!(k&&!p&&(at==="الأدمن الرئيسي"||Y))){g({title:"لا يمكن الحذف",description:"لا يمكنك حذف مستخدم الوردية أثناء كونها نشطة أو قبل تسليمها للأدمن الرئيسي"});return}const le=`هل أنت متأكد من حذف المستخدم ${N}؟

هذا الإجراء لا يمكن التراجع عنه.`;window.confirm(le)&&(Pt(Ce=>Ce.filter(ve=>ve.username!==N)),k&&j(null),g({title:"تم حذف المستخدم",description:N}))},ls=()=>{if(!y.trim()||!q.trim()||!V.trim())return;if(Wt.length>=je){g({title:"وصلت الحد الأقصى للمستخدمين",description:`هذه الباقة تسمح بإضافة ${Number.isFinite(je)?je:"عدد غير محدود"} كاشير فقط`,variant:"destructive"});return}const N={name:y.trim(),username:q.trim(),password:V.trim()};Pt(k=>[N,...k]),P(""),M(""),J("")},za=()=>{E(!0),oe(null),Te(null),et(""),ne("")},d=async()=>{try{let N=[];try{C!=null&&C.uid&&(N=await Ae.getUserTransactions(C.uid))}catch{}if(!N||N.length===0)try{const _e=await Um({merchantUserId:C==null?void 0:C.uid,limit:200});N=(_e==null?void 0:_e.transactions)||[]}catch{}const k=v?new Date(v):null,Y=new Date,X=_e=>{const Ke=_e.type,Mt=_e.txnType;return Ke==="withdraw"||Ke==="withdrawal"||Ke==="receive"||Mt==="receive"},pe=_e=>{const Ke=_e.type,Mt=_e.txnType;return Ke==="send"||Ke==="transfer"||Mt==="send"},le=_e=>{if(!_e)return null;if(_e instanceof Date)return _e;try{const Ke=new Date(_e);return Number.isNaN(Ke.getTime())?null:Ke}catch{return null}},Ce=_e=>{const Ke=le(_e.createdAt||_e.created_at||_e.timestamp);return!Ke||k&&Ke<k?!1:Ke<=Y},ve=_e=>_e==="completed"||_e==="confirmed",ce=N.filter(_e=>ve(_e.status)&&Ce(_e)),Ht=ce.filter(_e=>X(_e)).reduce((_e,Ke)=>{const Mt=Ke.withdrawnAmount??Ke.receivedAmount??Ke.amount??0;return _e+(Number(Mt)||0)},0);return{totalTransfers:ce.filter(_e=>pe(_e)).reduce((_e,Ke)=>{const Mt=Ke.sentAmount??Ke.transferredAmount??Ke.amount??0;return _e+(Number(Mt)||0)},0),totalWithdrawals:Ht}}catch{return{totalTransfers:0,totalWithdrawals:0}}};n.useEffect(()=>{if(Ne){try{const N=localStorage.getItem("shiftInitialReceivedDrawerFunds");N!==null&&xe(N)}catch{}try{const N=localStorage.getItem("shiftInitialReceivedWalletBalancesTotal");if(N!==null){const k=parseFloat(N);Tt(Number.isFinite(k)?k:0)}}catch{}}},[Ne]),n.useEffect(()=>{if(!i&&!mt)return;(async()=>{try{const Y=((C!=null&&C.uid?await Ae.getUserTransactions(C.uid):[])||[]).filter(X=>(X==null?void 0:X.type)==="report"||((X==null?void 0:X.title)||"").includes("إيصال تسليم وردية"));Y.sort((X,pe)=>{const le=new Date(X.createdAt||0).getTime();return new Date(pe.createdAt||0).getTime()-le}),is(Y)}catch{is([])}})()},[i,Ne,mt,C==null?void 0:C.uid]);const O=async(N,k,Y)=>{try{let X=0,pe=0;try{const Ce=parseFloat(localStorage.getItem("shiftInitialReceivedDrawerFunds")||"0");X=Number.isFinite(Ce)?Ce:0}catch{}try{const Ce=parseFloat(localStorage.getItem("shiftInitialReceivedWalletBalancesTotal")||"0");pe=Number.isFinite(Ce)?Ce:0}catch{}const le={id:`shift_receipt_${Date.now()}`,type:"report",senderPhone:(o==null?void 0:o.username)||"cashier",receiverPhone:at||"admin",amount:0,status:"completed",createdAt:new Date().toISOString(),title:"إيصال تسليم وردية",cashierName:(o==null?void 0:o.name)||(o==null?void 0:o.username)||null,deficit:k,deficitAmount:k?Y:0,shiftStartAt:v,receivedDrawerFunds:X,receivedWalletBalancesTotal:pe,receivedWalletBalances:vt,deliveredDrawerFunds:ae||0,deliveredWalletBalancesTotal:st||0,deliveredWalletBalances:Kt,shiftProfit:Math.round(((ae||0)+(st||0)-(X+pe))*100)/100};C!=null&&C.uid&&await Ae.saveUserTransaction(C.uid,le),is(Ce=>[le,...Ce||[]])}catch{}};return e.jsxs(e.Fragment,{children:[e.jsx(de,{open:i,onOpenChange:u,children:e.jsxs(me,{className:"sm:max-w-md",children:[e.jsx(he,{children:e.jsx(ue,{children:p?"تسليم الورديه والخروج":"إضافة مستخدم وردية"})}),p?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsx("div",{className:"text-sm",children:"المستخدم الحالي للوردية:"}),e.jsxs("div",{className:"font-semibold text-sm",children:[o==null?void 0:o.name," (",o==null?void 0:o.username,")"]})]}),e.jsx("div",{className:"text-xs text-gray-600",children:'لإنهاء الوردية والخروج، اضغط "تسليم الورديه والخروج" وسيُطلب الرقم السري.'})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-xs text-gray-600",children:'لاستكمال إضافة مستخدم جديد اضغط الزر أسفل "إضافة مستخدم جديد" لفتح النموذج.'}),Wt.length>0&&e.jsxs("div",{className:"mt-4 border-t pt-3",children:[e.jsx("div",{className:"text-sm font-medium mb-2",children:"المستخدمون المسجلون"}),e.jsx("div",{className:"space-y-2 max-h-48 overflow-auto",children:Wt.map((N,k)=>e.jsxs("div",{className:"flex items-center justify-between rounded border px-3 py-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:N.name}),e.jsx("div",{className:"text-xs text-gray-500",children:N.username})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(h,{size:"sm",className:"w-full sm:w-auto",onClick:()=>{Bt(N),He(!0)},children:"دخول"}),e.jsx(h,{size:"sm",className:"w-full sm:w-auto",variant:"destructive",onClick:()=>Aa(N.username),children:"حذف"})]})]},k))})]})]}),e.jsx(rt,{className:"flex flex-wrap gap-2 justify-between",children:p?e.jsx("div",{className:"flex flex-wrap gap-2",children:e.jsx(h,{className:"w-full sm:w-auto",variant:"destructive",onClick:za,children:"تسليم الورديه والخروج"})}):e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(h,{className:"w-full sm:w-auto",onClick:()=>Ts(!0),children:"إضافة مستخدم جديد"}),e.jsx(h,{className:"w-full sm:w-auto",variant:"outline",onClick:()=>bs(!0),children:"إيصالات التسليم"})]})})]})}),e.jsx(de,{open:Ia,onOpenChange:Ts,children:e.jsxs(me,{className:"sm:max-w-md",children:[e.jsx(he,{children:e.jsx(ue,{children:"إضافة مستخدم جديد"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(H,{className:"mb-1 block",children:"الاسم"}),e.jsx(U,{value:y,onChange:N=>P(N.target.value),placeholder:"أدخل الاسم"})]}),e.jsxs("div",{children:[e.jsx(H,{className:"mb-1 block",children:"اسم المستخدم"}),e.jsx(U,{value:q,onChange:N=>M(N.target.value),placeholder:"أدخل اسم المستخدم"})]}),e.jsxs("div",{children:[e.jsx(H,{className:"mb-1 block",children:"الرقم السري"}),e.jsx(U,{type:"password",autoComplete:"new-password",value:V,onChange:N=>J(N.target.value),placeholder:"أدخل الرقم السري"})]}),e.jsx("div",{className:"text-xs text-gray-500",children:"المستخدم يمكنه: التحويل، السحب، اختيار المحفظة فقط."})]}),e.jsxs(rt,{className:"flex gap-2 justify-between",children:[e.jsx(h,{variant:"secondary",onClick:()=>{Ts(!1)},children:"إلغاء"}),e.jsx(h,{onClick:()=>{!y.trim()||!q.trim()||!V.trim()||(ls(),Ts(!1))},children:"حفظ المستخدم"})]})]})}),e.jsx(de,{open:mt,onOpenChange:bs,children:e.jsxs(me,{className:"sm:max-w-lg",children:[e.jsx(he,{children:e.jsx(ue,{children:"إيصالات التسليم"})}),Yt.length===0?e.jsx("div",{className:"text-xs text-gray-600",children:"لا توجد إيصالات تسليم محفوظة بعد."}):e.jsx("div",{className:"space-y-2 max-h-[60vh] overflow-auto",children:Yt.map(N=>e.jsxs("div",{className:"rounded border px-3 py-2 cursor-pointer hover:bg-gray-50",onClick:()=>{Us(N),Ca(!0)},children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm font-semibold",children:new Date(N.createdAt).toLocaleString("ar-EG")}),e.jsxs("div",{className:"text-xs text-gray-500",children:["إلى: ",N.receiverPhone]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-1",children:[e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مسلّمة: ",N.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مسلّمة (إجمالي): ",N.deliveredWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مستلمة: ",N.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مستلمة (إجمالي): ",N.receivedWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مسلّمة: ",N.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مسلّمة (إجمالي): ",N.deliveredWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مستلمة: ",N.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مستلمة (إجمالي): ",N.receivedWalletBalancesTotal??0]}),e.jsxs("div",{className:["text-xs",(N.shiftProfit??(N.deliveredDrawerFunds??0)+(N.deliveredWalletBalancesTotal??0)-(N.receivedDrawerFunds??0)-(N.receivedWalletBalancesTotal??0))>=0?"text-green-700":"text-red-700"].join(" "),children:["أرباح الوردية: ",N.shiftProfit??(N.deliveredDrawerFunds??0)+(N.deliveredWalletBalancesTotal??0)-(N.receivedDrawerFunds??0)-(N.receivedWalletBalancesTotal??0)]})]}),N.deficit&&e.jsxs("div",{className:"text-xs text-red-600 mt-1",children:["عجز: ",N.deficitAmount??0]})]},N.id))}),e.jsx(rt,{className:"flex gap-2 justify-between",children:e.jsx(h,{variant:"secondary",onClick:()=>bs(!1),children:"إغلاق"})})]})}),e.jsx(de,{open:ha,onOpenChange:Ca,children:e.jsxs(me,{className:"sm:max-w-md",children:[e.jsx(he,{children:e.jsx(ue,{children:"إيصال تسليم وردية"})}),bt?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsxs("div",{className:"text-sm",children:["التاريخ: ",new Date(bt.createdAt).toLocaleString("ar-EG")]}),e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["تم التسليم إلى: ",bt.receiverPhone]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"المستلم عند الدخول"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية: ",bt.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["أرصدة المحافظ (إجمالي): ",bt.receivedWalletBalancesTotal??0]})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"المسلّم عند الخروج"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية: ",bt.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["أرصدة المحافظ (إجمالي): ",bt.deliveredWalletBalancesTotal??0]})]})]}),bt.deficit&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2 text-red-600",children:"عجز"}),e.jsxs("div",{className:"text-xs text-red-600",children:["المبلغ: ",bt.deficitAmount??0]})]}),bt.receivedWalletBalances&&Object.keys(bt.receivedWalletBalances).length>0&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"تفصيل المحافظ المستلمة"}),e.jsx("div",{className:"space-y-1",children:Object.entries(bt.receivedWalletBalances).map(([N,k])=>e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-gray-600",children:N}),e.jsx("span",{className:"font-semibold",children:k})]},N))})]}),bt.deliveredWalletBalances&&Object.keys(bt.deliveredWalletBalances).length>0&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"تفصيل المحافظ المسلّمة"}),e.jsx("div",{className:"space-y-1",children:Object.entries(bt.deliveredWalletBalances).map(([N,k])=>e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-gray-600",children:N}),e.jsx("span",{className:"font-semibold",children:k})]},N))})]})]}):e.jsx("div",{className:"text-xs text-gray-600",children:"لا يوجد تقرير محدد للعرض."}),e.jsx(rt,{className:"flex gap-2 justify-between",children:e.jsx(h,{variant:"secondary",onClick:()=>Ca(!1),children:"إغلاق"})})]})}),e.jsx(de,{open:Pe,onOpenChange:He,children:e.jsxs(me,{className:"sm:max-w-md",children:[e.jsx(he,{children:e.jsx(ue,{children:"أدخل الرقم السري للدخول"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm",children:it?`${it.name} (${it.username})`:""}),e.jsx(U,{type:"password",autoComplete:"off",value:Oe,onChange:N=>Ft(N.target.value),placeholder:"أدخل الرقم السري"})]}),e.jsxs(rt,{className:"flex gap-2 justify-between",children:[e.jsx(h,{variant:"secondary",onClick:()=>{Ft(""),Bt(null),He(!1)},children:"إلغاء"}),e.jsx(h,{onClick:()=>{if(it){if(Oe.trim()!==it.password){g({title:"خطأ في الرقم السري",description:"الرقم السري للكاشير غير صحيح",variant:"destructive"});return}j({name:it.name,username:it.username}),Ft(""),He(!1),u(!1),s(),Et(!0)}},children:"دخول الورديه"})]})]})}),e.jsx(de,{open:xt,onOpenChange:Et,children:e.jsxs(me,{className:"sm:max-w-md",children:[e.jsx(he,{children:e.jsx(ue,{children:"تسجيل أرصدة البداية والنقدية"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(H,{className:"mb-1 block",children:"الفلوس النقدية المستلمة عند الدخول"}),e.jsx(U,{type:"number",value:tt,onChange:N=>xe(N.target.value),placeholder:"أدخل قيمة النقدية في الدرج عند بداية الورديه"})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(H,{className:"mb-1 block",children:"أرصدة المحافظ المستلمة (إجمالي) عند الدخول"}),e.jsx(U,{type:"number",value:Number.isFinite(Ye)?Ye:0,onChange:N=>{const k=parseFloat(N.target.value);Tt(Number.isFinite(k)?k:0)},placeholder:"أدخل إجمالي أرصدة المحافظ عند بداية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"يمكن إضافة التفصيل لاحقاً إن لزم، المهم تسجيل الإجمالي."})]})]}),e.jsx(rt,{className:"flex gap-2 justify-between",children:e.jsx(h,{onClick:()=>{const N=parseFloat(tt),k=Ye,Y=Number.isFinite(N)&&N>=0,X=Number.isFinite(k)&&k>=0;if(!Y||!X){g({title:"يرجى إدخال قيم صحيحة",description:"أدخل قيمًا رقمية غير سالبة للنقدية ولإجمالي أرصدة المحافظ",variant:"destructive"});return}try{localStorage.setItem("shiftInitialReceivedDrawerFunds",String(N)),localStorage.setItem("shiftInitialReceivedWalletBalancesTotal",String(k))}catch{}g({title:"تم تسجيل أرصدة البداية",description:"سُجّل إجمالي النقدية وأرصدة المحافظ لبداية الورديه"}),Et(!1)},children:"تأكيد وحفظ"})})]})}),e.jsx(de,{open:re,onOpenChange:N=>{N&&E(!0)},children:e.jsxs(me,{className:"sm:max-w-md",hideClose:!0,disableOutsideClose:!0,disableEscClose:!0,children:[e.jsx(he,{children:e.jsx(ue,{children:"تسليم الورديه والخروج"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(h,{variant:_==="toUser"?"default":"secondary",onClick:()=>oe("toUser"),children:"تسليم إلى مستخدم آخر"}),e.jsx(h,{variant:_==="toAdmin"?"default":"secondary",onClick:()=>oe("toAdmin"),children:"تسليم إلى الأدمن الرئيسي"})]}),_==="toUser"&&e.jsxs("div",{className:"space-y-3",children:[Wt.length===0?e.jsx("div",{className:"text-sm text-gray-600",children:"لا يوجد مستخدمون مسجلون. قم بإضافة مستخدم أولاً."}):e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"اختر المستخدم الذي سيتسلم الورديه"}),e.jsx("div",{className:"space-y-2 max-h-40 overflow-auto",children:Wt.map((N,k)=>e.jsxs("div",{className:`flex items-center justify-between rounded border px-3 py-2 cursor-pointer ${(we==null?void 0:we.username)===N.username?"bg-indigo-50 border-indigo-200":""}`,onClick:()=>Te(N),children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:N.name}),e.jsx("div",{className:"text-xs text-gray-500",children:N.username})]}),e.jsx("span",{className:"text-xs text-gray-400",children:"اختيار"})]},k))})]}),e.jsxs("div",{children:[e.jsx(H,{className:"mb-1 block",children:"كلمة سر المستخدم المحدد"}),e.jsx(U,{type:"password",autoComplete:"off",value:Me,onChange:N=>et(N.target.value),placeholder:"أدخل كلمة السر"})]}),G&&e.jsx("div",{className:"text-xs text-red-600",children:G})]}),_==="toAdmin"&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm text-gray-600",children:"أدخل كلمة مرور الحساب الرئيسي لتسليم الورديه والخروج إلى الأدمن."}),e.jsx(U,{type:"password",autoComplete:"off",value:ee,onChange:N=>fe(N.target.value),placeholder:"كلمة المرور"}),se&&e.jsx("div",{className:"text-xs text-red-600",children:se})]})]}),e.jsx(rt,{className:"flex gap-2 justify-between",children:e.jsx(h,{disabled:Qe||!_,onClick:async()=>{if(_){Q(!0);try{const N=await d();if(_==="toUser"){if(!we){ne("يرجى اختيار المستخدم أولاً"),Q(!1);return}if(Me.trim()!==we.password){ne("كلمة السر غير صحيحة"),Q(!1);return}D(),j({name:we.name,username:we.username}),s(),Ue(`${we.name} (${we.username})`);try{localStorage.setItem("lastHandoverToAdmin","false")}catch{}E(!1),oe(null),Te(null),et(""),ne(""),u(!1),Re(N),Ie(null),ct(""),Ze(!0)}else if(_==="toAdmin"){te("");const k=(C==null?void 0:C.email)||"";if(!k){te("لا يوجد بريد للمستخدم الرئيسي للتحقق"),Q(!1);return}const{error:Y}=await A(k,ee);if(Y){te("كلمة المرور غير صحيحة"),Q(!1);return}D(),j(null);try{localStorage.setItem("lastHandoverToAdmin","true")}catch{}fe(""),E(!1),u(!1),Ue("الأدمن الرئيسي"),Re(N),Ie(null),ct(""),Ze(!0)}}catch{ne("حدث خطأ أثناء التسليم، حاول مرة أخرى")}finally{Q(!1)}}},children:"تأكيد التسليم"})})]})}),e.jsx(de,{open:Ne,onOpenChange:Ze,children:e.jsxs(me,{className:"sm:max-w-lg",hideClose:!0,disableOutsideClose:!0,disableEscClose:!0,children:[e.jsx(he,{children:e.jsx(ue,{children:"تقرير تسليم الورديه والخروج"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsxs("div",{className:"text-sm",children:["تم تسليم الورديه إلى: ",e.jsx("span",{className:"font-semibold",children:at})]}),v&&e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["بداية الورديه: ",new Date(v).toLocaleString("ar-EG")]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نهاية الورديه: ",new Date().toLocaleString("ar-EG")]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(H,{className:"mb-1 block",children:"الفلوس النقدية المستلمة"}),e.jsx(U,{type:"number",value:tt,readOnly:!0,disabled:!0,placeholder:"قيمة مسجلة عند بداية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"قيمة غير قابلة للتعديل؛ تُسجّل عند الدخول."})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(H,{className:"mb-1 block",children:"أرصدة المحافظ المستلمة (إجمالي)"}),e.jsx(U,{type:"number",value:Ye,readOnly:!0,disabled:!0,placeholder:"إجمالي مسجل عند بداية الورديه"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(H,{className:"mb-1 block",children:"الفلوس النقدية المسلمة"}),e.jsx(U,{type:"number",value:ae,onChange:N=>{const k=parseFloat(N.target.value);Fe(Number.isFinite(k)?k:0)},placeholder:"أدخل قيمة النقدية المسلمة عند نهاية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"ادخال يدوي لقيمة النقدية المسلّمة عند نهاية الورديه"})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(H,{className:"mb-1 block",children:"أرصدة المحافظ المسلمة (إجمالي)"}),e.jsx(U,{type:"number",value:st,onChange:N=>{const k=parseFloat(N.target.value);jt(Number.isFinite(k)?k:0)},placeholder:"أدخل إجمالي أرصدة المحافظ المسلّمة"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"يمكنك إدخال الإجمالي يدوياً؛ التفصيل يُحفظ إن لزم"})]})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-1",children:"أرباح الوردية"}),e.jsx("div",{className:["text-sm",(ae??0)+(st??0)-((parseFloat(tt||"0")||0)+(Ye??0))>=0?"text-green-700":"text-red-700"].join(" "),children:Math.round(((ae??0)+(st??0)-((parseFloat(tt||"0")||0)+(Ye??0)))*100)/100}),e.jsx("div",{className:"text-xs text-gray-600",children:"محسوبة: (المسلّم − المستلم) للنقدية + المحافظ"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"هل يوجد عجز؟"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(h,{variant:nt==="no"?"default":"secondary",onClick:()=>Ie("no"),children:"لا"}),e.jsx(h,{variant:nt==="yes"?"default":"secondary",onClick:()=>Ie("yes"),children:"نعم"})]}),nt==="yes"&&e.jsxs("div",{children:[e.jsx(H,{className:"mb-1 block",children:"مبلغ العجز"}),e.jsx(U,{type:"number",value:Le,onChange:N=>ct(N.target.value),placeholder:"أدخل مبلغ العجز"})]})]})]}),e.jsx(rt,{className:"flex gap-2 justify-between",children:e.jsx(h,{onClick:()=>{const N=nt==="yes",k=parseFloat(Le)||0;(async()=>await O(es,N,k))(),g({title:"تم إضافة إيصال تسليم الورديه",description:"أُضيف الإيصال إلى المعاملات الأخيرة بعنوان إيصال تسليم وردية"}),Ze(!1)},children:"تأكيد وحفظ الإيصال"})})]})})]})},Ih=({open:i,onOpenChange:u})=>{const{shiftUser:o,endShift:p,setShiftUser:v}=jr(),[j,s]=n.useState(""),[D,B]=n.useState(""),[C,A]=n.useState([]),{user:T}=$s();n.useEffect(()=>{(async()=>{try{if(T!=null&&T.uid){const y=ze(K,"profiles",T.uid,"cashierUsers","list"),P=await ca(y);if(P.exists()){const q=P.data(),M=Array.isArray(q==null?void 0:q.users)?q.users:[];if(M&&M.length>0){A(M);return}}}}catch{}try{const y=`cashierUsers_${(T==null?void 0:T.uid)||"default"}`;let P=localStorage.getItem(y);if(!P){const q=localStorage.getItem("cashierUsers");q&&(P=q)}A(P?JSON.parse(P):[])}catch{A([])}})()},[i,T==null?void 0:T.uid]),n.useEffect(()=>{if(!i||!(T!=null&&T.uid))return;const y=ze(K,"profiles",T.uid,"cashierUsers","list"),P=Rs(y,q=>{if(q.exists()){const M=q.data(),V=Array.isArray(M==null?void 0:M.users)?M.users:[];if(V&&V.length>0)A(V);else try{const J=`cashierUsers_${(T==null?void 0:T.uid)||"default"}`;let re=localStorage.getItem(J);if(!re){const E=localStorage.getItem("cashierUsers");E&&(re=E)}A(re?JSON.parse(re):[])}catch{A([])}}},q=>{console.warn("ShiftProfileDialog cashierUsers snapshot error:",q)});return()=>P()},[i,T==null?void 0:T.uid]);const g=async()=>{if(B(""),!o)return;const y=C.find(P=>P.username===o.username);if(!y){B("لا يوجد مستخدم مطابق لهذه الوردية");return}if(j.trim()!==y.password){B("الرقم السري غير صحيح");return}p(),v(null),s(""),u(!1)};return e.jsx(de,{open:i,onOpenChange:y=>{s(""),B(""),u(y)},children:e.jsxs(me,{className:"sm:max-w-md",children:[e.jsx(he,{children:e.jsx(ue,{children:"بروفيل الوردية"})}),o?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"rounded-lg border p-3 bg-gradient-to-r from-blue-50 to-indigo-50",children:[e.jsx("div",{className:"text-sm font-semibold text-gray-800",children:o.name}),e.jsx("div",{className:"text-xs text-gray-600",children:o.username})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{className:"block",children:"أدخل الرقم السري لتسليم الوردية"}),e.jsx(U,{type:"password",value:j,onChange:y=>s(y.target.value),placeholder:"الرقم السري للمستخدم",dir:"ltr"}),D&&e.jsx("div",{className:"text-red-600 text-xs",children:D})]})]}):e.jsx("div",{className:"text-sm text-gray-600",children:"لا يوجد مستخدم وردية نشط حالياً"}),e.jsxs(rt,{className:"flex justify-between",children:[e.jsx(h,{variant:"outline",onClick:()=>u(!1),children:"إغلاق"}),e.jsx(h,{onClick:g,disabled:!o,children:"تسليم الوردية"})]})]})})},Ah=({open:i,onOpenChange:u})=>e.jsx(de,{open:i,onOpenChange:u,children:e.jsxs(me,{className:"sm:max-w-lg rounded-2xl",children:[e.jsxs(he,{children:[e.jsxs(ue,{className:"text-right flex items-center gap-2 justify-end",children:[e.jsx(Ni,{className:"w-5 h-5"}),"سجل التغييرات الأخيرة"]}),e.jsx(ss,{className:"text-right",children:"هذه أبرز التحسينات التي تمت مؤخرًا في الواجهة."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(wo,{className:"w-5 h-5 text-amber-600 mt-1"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold",children:"تحسين نافذة تعديل المديونية"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"استبدال نافذة الإدخال القديمة (prompt) بحوار أنيق لإدخال المبلغ مع تأكيد."})]})]}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(vm,{className:"w-5 h-5 text-violet-600 mt-1"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold",children:"تحديث شاشة التحميل"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:'تغيير النص إلى "صلي علي النبي" مع خط عربي جميل ونبض لطيف.'})]})]}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Ni,{className:"w-5 h-5 text-green-600 mt-1"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold",children:"بطاقات الأرباح وعدد العمليات"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"إضافة بطاقات عرض أرباح الفترة الحالية وعدد العمليات في تفاصيل المحفظة."})]})]}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Ni,{className:"w-5 h-5 text-blue-600 mt-1"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold",children:"إصلاح تمرير نافذة اليومية"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"منع تمرير الصفحة الخلفية عند فتح نافذة اليومية لراحة الاستخدام."})]})]})]}),e.jsx("div",{className:"flex justify-end gap-2 mt-6",children:e.jsx(h,{variant:"secondary",onClick:()=>u(!1),children:"إغلاق"})})]})});class $a{static async processTransfer(u){const{amount:o,currentCashBalance:p,currentWalletBalances:v,wallets:j,selectedWalletId:s}=u;if(o<=0)return{success:!1,newCashBalance:p,newWalletBalances:v,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(s&&!u.skipRemoteLimitsCheck)try{const A=await Cs.canPerformOperation(s,o,"transfer");if(!A.canPerform)return{success:!1,newCashBalance:p,newWalletBalances:v,message:A.message||"تم تجاوز الحد الأقصى",error:"LIMIT_EXCEEDED"}}catch(A){return console.error("خطأ في التحقق من حدود التحويل:",A),{success:!1,newCashBalance:p,newWalletBalances:v,message:"خطأ في التحقق من حدود التحويل",error:"LIMIT_CHECK_ERROR"}}if(o<=0)return{success:!1,newCashBalance:p,newWalletBalances:v,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(s){const A=Math.max(v[s]||0,0);if(A<o){const T=j.find(g=>g.id===s);return{success:!1,newCashBalance:p,newWalletBalances:v,message:`رصيد غير كافي في المحفظة${T?` ${T.name}`:""}. المتاح: ${A} جنيه، المطلوب: ${o} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"}}}else{const A=$a.calculateTotalWalletBalance(v);if(A<o)return{success:!1,newCashBalance:p,newWalletBalances:v,message:`رصيد غير كافي في المحافظ. الرصيد المتاح: ${A} جنيه، المبلغ المطلوب: ${o} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"}}const D={...v};if(s){const A=D[s]||0;D[s]=A-o}else{let A=o;for(const T of j){if(A<=0)break;const g=Math.max(D[T.id]||0,0),y=Math.min(g,A);y>0&&(D[T.id]=(D[T.id]||0)-y,A-=y)}}const B=p+o;if(s)try{const A=Cs.updateUsage(s,o,"transfer");u.nonBlockingUsageUpdate?A.catch(T=>console.error("خطأ في تحديث استخدام المحفظة:",T)):await A}catch(A){console.error("خطأ في تحديث استخدام المحفظة:",A)}let C="تم التحويل بنجاح";if(s){const A=D[s]||0;A<0&&(C=`تم التحويل بنجاح مع تحذير: رصيد محفظة ${s} أصبح ${A} جنيه.`)}return{success:!0,newCashBalance:B,newWalletBalances:D,message:C}}static processDeposit(u){const{amount:o,currentCashBalance:p,currentWalletBalances:v,wallets:j}=u;if(o<=0)return{success:!1,newCashBalance:p,newWalletBalances:v,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};const s=this.calculateTotalWalletBalance(v);if(s<o)return{success:!1,newCashBalance:p,newWalletBalances:v,message:`رصيد غير كافي في المحافظ. الرصيد المتاح: ${s} جنيه، المبلغ المطلوب: ${o} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"};const D=p+o,B={...v};let C=o;const A=j.find(g=>g.isDefault);if(A&&B[A.id]>=C)B[A.id]-=C,C=0;else for(const g of j){if(C<=0)break;const y=B[g.id]||0;if(y>0){const P=Math.min(y,C);B[g.id]=y-P,C-=P}}const T=C>0?`تم الإيداع جزئياً. تم إيداع ${o-C} جنيه في صندوق النقدية`:`تم الإيداع بنجاح. تم إضافة ${o} جنيه إلى صندوق النقدية`;return{success:!0,newCashBalance:D,newWalletBalances:B,message:T}}static async processWithdraw(u){const{amount:o,currentCashBalance:p,currentWalletBalances:v,wallets:j,selectedWalletId:s}=u;if(o<=0)return{success:!1,newCashBalance:p,newWalletBalances:v,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(s&&!u.skipRemoteLimitsCheck)try{const A=await Cs.canPerformOperation(s,o,"withdraw");if(!A.canPerform)return{success:!1,newCashBalance:p,newWalletBalances:v,message:A.message||"تم تجاوز الحد الأقصى",error:"LIMIT_EXCEEDED"}}catch(A){return console.error("خطأ في التحقق من حدود السحب:",A),{success:!1,newCashBalance:p,newWalletBalances:v,message:"خطأ في التحقق من حدود السحب",error:"LIMIT_CHECK_ERROR"}}if(p<o)return{success:!1,newCashBalance:p,newWalletBalances:v,message:`رصيد غير كافي في صندوق النقدية. الرصيد المتاح: ${p} جنيه، المبلغ المطلوب: ${o} جنيه`,error:"INSUFFICIENT_CASH_BALANCE"};const D=p-o,B={...v},C=s?j.find(A=>A.id===s):j.find(A=>A.isDefault)||j[0];if(C){const A=B[C.id]||0;B[C.id]=A+o}else return{success:!1,newCashBalance:p,newWalletBalances:v,message:"لا توجد محافظ متاحة لإضافة المبلغ إليها",error:"NO_WALLETS_AVAILABLE"};if(s)try{const A=Cs.updateUsage(s,o,"withdraw");u.nonBlockingUsageUpdate?A.catch(T=>console.error("خطأ في تحديث استخدام المحفظة:",T)):await A}catch(A){console.error("خطأ في تحديث استخدام المحفظة:",A)}return{success:!0,newCashBalance:D,newWalletBalances:B,message:`تم السحب بنجاح. تم إضافة ${o} جنيه إلى محفظة ${(C==null?void 0:C.name)||""}`}}static validateOperation(u,o){return u<=0?{valid:!1,error:"المبلغ يجب أن يكون أكبر من الصفر"}:!o||o.length===0?{valid:!1,error:"لا توجد محافظ متاحة"}:{valid:!0}}static calculateTotalWalletBalance(u){return Object.values(u).reduce((o,p)=>o+Math.max(p,0),0)}static deductFromWalletsAddToCash(u,o,p,v){return this.processTransfer({amount:u,currentCashBalance:o,currentWalletBalances:p,wallets:v})}static deductFromWalletsAddToCashDeposit(u,o,p,v){return this.processDeposit({amount:u,currentCashBalance:o,currentWalletBalances:p,wallets:v})}static deductFromCashAddToWallets(u,o,p,v){return this.processWithdraw({amount:u,currentCashBalance:o,currentWalletBalances:p,wallets:v})}static applyTransactionResult(u,o,p){u.success&&(o(u.newCashBalance),p(u.newWalletBalances))}static validateTransaction(u,o,p,v){if(u<=0)return{isValid:!1,error:"المبلغ يجب أن يكون أكبر من الصفر"};if(o==="transfer"){const j=this.calculateTotalWalletBalance(v);if(j<u)return{isValid:!1,error:`الرصيد المتاح في المحافظ (${j} جنيه) غير كافي للمبلغ المطلوب (${u} جنيه)`}}else if(o==="withdraw"){if(p<u)return{isValid:!1,error:`الرصيد المتاح في صندوق النقدية (${p} جنيه) غير كافي للمبلغ المطلوب (${u} جنيه)`}}else if(o==="deposit"){const j=this.calculateTotalWalletBalance(v);if(j<u)return{isValid:!1,error:`الرصيد المتاح في المحافظ (${j} جنيه) غير كافي للمبلغ المطلوب (${u} جنيه)`}}return{isValid:!0}}static getDeductionPreview(u,o,p){const v=[];let j=u;for(const s of p){if(j<=0)break;const D=o[s.id]||0,B=Math.min(Math.max(D,0),j);B>0&&(v.push({walletId:s.id,walletName:s.name,currentBalance:D,deductedAmount:B,newBalance:D-B}),j-=B)}return v}}let gr=null;function Th(){const i=window;if(!gr){const u=i.AudioContext||i.webkitAudioContext;gr=new u}return gr.state==="suspended"&&gr.resume(),gr}function Ph(i,u,o){const p=o/1e3,v=Math.floor(i.sampleRate*p),j=i.createBuffer(1,v,i.sampleRate),s=j.getChannelData(0);for(let A=0;A<v;A++)s[A]=(Math.random()*2-1)*.6;const D=i.createBufferSource();D.buffer=j;const B=i.createBiquadFilter();B.type="highpass",B.frequency.value=1500,B.Q.value=.7;const C=i.createGain();C.gain.setValueAtTime(1e-4,u),C.gain.exponentialRampToValueAtTime(.4,u+.015),C.gain.exponentialRampToValueAtTime(1e-4,u+p),D.connect(B),B.connect(C),C.connect(i.destination),D.start(u),D.stop(u+p+.01)}function kh(i,u,o,p,v,j="triangle"){const s=i.createOscillator(),D=i.createGain();s.type=j;const B=v/1e3;s.frequency.setValueAtTime(o,u),s.frequency.linearRampToValueAtTime(p,u+B),D.gain.setValueAtTime(1e-4,u),D.gain.exponentialRampToValueAtTime(.25,u+.02),D.gain.exponentialRampToValueAtTime(1e-4,u+B),s.connect(D),D.connect(i.destination),s.start(u),s.stop(u+B+.02)}function Oh(){try{const i=Th(),u=i.currentTime;Ph(i,u,90),kh(i,u+.12,1900,1100,180,"sawtooth")}catch{}}function Eh(i){if(!i)return!1;const o=i.replace(/[^0-9٠-٩]/g,"").replace(/[٠-٩]/g,p=>"0123456789"["٠١٢٣٤٥٦٧٨٩".indexOf(p)]);return/^(010|011|012|015)[0-9]{8}$/.test(o)}function _h({userId:i}){const[u,o]=qe.useState(null),[p,v]=qe.useState("");return null}const Mu=()=>{var Yl,Hl,Gl,Ql,Zl;console.log("🔥 UserDashboardPage component is loading...");const{toast:i}=As(),u=n.useRef(null),[o,p]=n.useState(0),v=async()=>{var r,l,c;const t="alkaptin678678@gmail.com",a=(l=(r=Ba.currentUser)==null?void 0:r.email)==null?void 0:l.toLowerCase();if(!a||a!==t){i({title:"قيد التطوير",description:"هذه الميزة غير متاحة حالياً."});return}if(!$r||!Ur||!zr){i({title:"بيانات ناقصة",description:"أدخل رقم الموبايل، الشركة والمبلغ",variant:"destructive"});return}try{Cl(!0);const m=await((c=Ba.currentUser)==null?void 0:c.getIdToken()),x=await fetch("/api/topup",{method:"POST",headers:{"Content-Type":"application/json",...m?{Authorization:`Bearer ${m}`}:{}},body:JSON.stringify({phone:$r,countryCode:"EG",operator:Ur,amount:Number(zr),useLocalAmount:!0})}),f=await x.json().catch(()=>({}));x.ok&&(f!=null&&f.success)?(i({title:"تم الشحن",description:(f==null?void 0:f.message)||"تم تنفيذ عملية الشحن بنجاح"}),ii(!1),Nl(""),jl(""),Sl("")):i({title:"فشل الشحن",description:(f==null?void 0:f.message)||"حدث خطأ أثناء طلب الشحن",variant:"destructive"})}catch(m){console.error("Topup request error:",m),i({title:"خطأ غير متوقع",description:"تعذّر تنفيذ عملية الشحن. حاول لاحقاً.",variant:"destructive"})}finally{Cl(!1)}},{signOut:j,user:s,profile:D}=$s(),B=((s==null?void 0:s.email)||"").toLowerCase()==="vodafonecash00@gmail.com",C=yo(),A=po(),T=tm(),{isShiftActive:g,shiftUser:y}=jr(),{shopId:P,shopName:q}=yn(),M=sm();(()=>{try{return!!window.electronAPI||typeof navigator<"u"&&navigator.userAgent.toLowerCase().includes("electron")||typeof window<"u"&&window.location&&window.location.protocol==="file:"}catch{return!1}})();const[V,J]=n.useState(!1),[re,E]=n.useState(!1),[_,oe]=n.useState(!1),[ee,fe]=n.useState(!1),[se,te]=n.useState([]),[ye,We]=n.useState(""),[we,Te]=n.useState(""),[Me,et]=n.useState(""),[G,ne]=n.useState(""),[Qe,Q]=n.useState(!1),[Ne,Ze]=n.useState(!1),[es,Re]=n.useState(null),[nt,Ie]=n.useState(""),[Le,ct]=n.useState(""),[tt,xe]=n.useState(!1);n.useEffect(()=>{const t=T==null?void 0:T.shopId;if(t&&(s!=null&&s.uid))try{const a=`selectedShopId_${s.uid}`;localStorage.setItem(a,String(t)),window.dispatchEvent(new Event("selectedShopIdChanged"))}catch{}},[T==null?void 0:T.shopId,s==null?void 0:s.uid]);const[Ye,Tt]=n.useState([]),[vt,W]=n.useState(()=>{try{return localStorage.getItem("cashySelectedDevice")||null}catch{return null}}),ae=t=>!!(t&&Ye.some(a=>a.id===t));async function Fe(){const t=window.electronAPI,a=vt||"";if(!t||typeof t.sendUssd!="function")return null;if(!a)return i({title:"الجهاز غير محدد",description:"اتصل بالموبايل أولاً ثم اختر الجهاز من القائمة",variant:"destructive"}),null;if(ae(a))return a;try{const m=Ye.find(x=>x&&x.id&&!String(x.id).includes(":"));if(m&&m.id)return W(m.id),m.id}catch{}const r=a.includes(":")?a.split(":").slice(0,2).join(":"):"";if(r&&typeof t.connectWifi=="function"){try{await t.connectWifi(r)}catch{}if(await new Promise(m=>setTimeout(m,250)),ae(a))return a}const l=a.split(":")[0],c=Ye.find(m=>(m.id.startsWith(l)||m.id.includes(l))&&m.id.includes(":"));if(c!=null&&c.id){const m=c.id.split(":").slice(0,2).join(":");if(!ae(c.id)&&typeof t.connectWifi=="function"){try{await t.connectWifi(m)}catch{}await new Promise(x=>setTimeout(x,250))}if(ae(c.id))return W(c.id),c.id}return i({title:"الجهاز غير متصل",description:"فعّل Wireless debugging أو استخدم اتصال Wi‑Fi ثم أعد المحاولة",variant:"destructive"}),null}n.useEffect(()=>{const t=window.electronAPI;t&&typeof t.onAdbDevices=="function"&&t.onAdbDevices(a=>{var c;const r=Array.isArray(a)?a:[];Tt(r);const l=(()=>{try{return localStorage.getItem("cashySelectedDevice")||""}catch{return""}})();l&&r.some(m=>m.id===l)?W(l):(c=r[0])!=null&&c.id?W(m=>m||r[0].id):W(null)})},[]);function st(t,a){try{const r=Gt==null?void 0:Gt(),l=(r==null?void 0:r.phone)||"";if(!l){i({title:"يجب اختيار محفظة",description:"اختر محفظة المُرسل أولاً",variant:"destructive"});return}om(l,t,a),i({title:"تم إرسال كود التحويل",description:"تم تنفيذ الاتصال مباشرة على الهاتف"}),pa(!1),Oa(!1)}catch(r){const l=(r==null?void 0:r.message)||"تعذر إرسال الكود — تحقق من البيانات";throw i({title:"فشل الإرسال",description:l,variant:"destructive"}),r}}const jt=async()=>{var r;if(!hs||!hs.receiver||!hs.amount){i({title:"بيانات غير مكتملة",description:"تأكد من إدخال رقم المستقبل والمبلغ قبل الإرسال",variant:"destructive"});return}const t=String(hs.receiver),a=Math.round(Number(hs.amount));ga(!0);try{if((r=ao)!=null&&r.isNativePlatform&&ao.getPlatform()==="android"){const c=Gt==null?void 0:Gt(),m=(c==null?void 0:c.phone)||"";if(!m){i({title:"يجب اختيار محفظة",description:"اختر محفظة المُرسل أولاً",variant:"destructive"}),ga(!1);return}const x=ro(m,t,a);if(!x){i({title:"رقم غير مدعوم",description:"تحقق من بداية الرقم 010/011/012/015",variant:"destructive"}),ga(!1);return}lm(x),i({title:"تم إرسال كود التحويل",description:"تم تنفيذ الاتصال مباشرة على الهاتف"}),pa(!1),Oa(!1);return}const l=window.electronAPI;if(l&&typeof l.sendUssd=="function"&&vt){const c=Gt==null?void 0:Gt(),m=(c==null?void 0:c.phone)||"";if(!m){i({title:"يجب اختيار محفظة",description:"اختر محفظة المُرسل أولاً",variant:"destructive"}),ga(!1);return}const x=await Fe();if(!x){ga(!1);return}const f=ro(m,t,a);if(!f){i({title:"رقم غير مدعوم",description:"تحقق من بداية الرقم 010/011/012/015",variant:"destructive"}),ga(!1);return}try{const I=typeof l.pickSimAutomatically=="function"?await l.pickSimAutomatically(x,m):{deviceId:x,slot:0},w=`${I.deviceId}:sim${I.slot}`;Tc(w),await l.sendUssd(w,f)}catch{try{await l.sendUssd(x,f)}catch(w){const S=x.includes(":")?x.split(":").slice(0,2).join(":"):"";if(S&&typeof l.connectWifi=="function")await l.connectWifi(S),await l.sendUssd(x,f);else throw w}}i({title:"تم إرسال كود التحويل",description:"تم التنفيذ بنجاح"}),pa(!1),Oa(!0)}else st(t,a)}catch(l){const c=l&&l.message?l.message:"حدث خطأ غير متوقع أثناء الإرسال";i({title:"خطأ أثناء الإرسال",description:`الجهاز: ${Xi||vt||"غير معروف"} — ${c}`,variant:"destructive"})}finally{ga(!1)}},Kt=async(t,a)=>{const r=window.electronAPI;try{if(r&&typeof r.enterPin=="function"&&t){await r.enterPin(t,a),Oa(!1);return}const l=String((D==null?void 0:D.bridgeLink)||"").trim(),c=String((D==null?void 0:D.bridgeDeviceId)||"").trim()||void 0;if(!l){i({title:"الرابط غير مُعدّ",description:"احفظ رابط الجسر أولاً",variant:"destructive"});return}const m=String((hs==null?void 0:hs.receiver)||os||"").replace(/\D/g,""),x=Math.max(1,Math.round(Number((hs==null?void 0:hs.amount)||Lt||0))||0),f=String(a||"").replace(/\D/g,""),w=(S=>{let F=(S||"").trim();return F=F.replace(/\/+$/,""),/^https?:\/\//i.test(F)||(F=`https://${F}`),F})(l);Oa(!1)}catch(l){const c=(l==null?void 0:l.message)||"حدث خطأ أثناء إدخال الرقم السري";i({title:"فشل الإدخال",description:c,variant:"destructive"})}};console.log("🔥 UserDashboardPage - user:",s?"exists":"null");const[Dt,at]=n.useState(!0),[Ue,xt]=n.useState(!0),[Et,_t]=n.useState(!1),[Wt,Pt]=n.useState(!1),[R,je]=n.useState(""),[Pe,He]=n.useState(""),[Oe,Ft]=n.useState(""),[it,Bt]=n.useState([]),[Yt,is]=n.useState(!1),[mt,bs]=n.useState(null),[bt,Us]=n.useState(""),[ha,Ca]=n.useState(!1),[Ia,Ts]=n.useState(!1),[Aa,ls]=n.useState(!1),[za,d]=n.useState(!1),[O,L]=n.useState(""),[N,k]=n.useState(""),[Y,X]=n.useState([]),[pe,le]=n.useState(!1),[Ce,ve]=n.useState(0),[ce,Ht]=n.useState(!1),[ts,_e]=n.useState(null),[Ke,Mt]=n.useState(!1),[$t,qa]=n.useState(""),[os,Ta]=n.useState(""),[Lt,Va]=n.useState(""),[ua,Oi]=n.useState(""),[vn,Pa]=n.useState(!1),[bn,wn]=n.useState(""),[tc,xa]=n.useState(""),[Ei,_i]=n.useState(""),[Nn,sc]=n.useState(""),[Ps,jn]=n.useState(null),[ac,Wi]=n.useState(!1),[rc,Fi]=n.useState(!1),[nc,Sr]=n.useState(!1),[ic,Sn]=n.useState(!1),[Mi,Dn]=n.useState(null),[ds,Cn]=n.useState(""),[ms,In]=n.useState(""),[Li,lc]=n.useState(""),[oc,Dr]=n.useState(!1),[Wh,Fh]=n.useState(null),[ws,Ri]=n.useState(null),Cr=t=>{const a="٠١٢٣٤٥٦٧٨٩",r="۰۱۲۳۴۵۶۷۸۹";return(t||"").split("").map(l=>{const c=a.indexOf(l);if(c>-1)return String(c);const m=r.indexOf(l);return m>-1?String(m):l}).join("")},[dt,An]=n.useState(()=>{try{const t=localStorage.getItem("commissionMode")||localStorage.getItem("commissionMode_default");return t?t==="add":!0}catch{return!0}}),[ie,Bi]=n.useState("transfer"),[lt,_s]=n.useState([]),[zs,Tn]=n.useState("all");n.useEffect(()=>{try{if(localStorage.setItem("commissionMode",dt?"add":"deduct"),s!=null&&s.uid){const t=`commissionMode_${s.uid}`;localStorage.setItem(t,dt?"add":"deduct")}}catch{}},[dt,s==null?void 0:s.uid]),n.useEffect(()=>{try{const t=s!=null&&s.uid?localStorage.getItem(`commissionMode_${s.uid}`):null,a=localStorage.getItem("commissionMode"),r=localStorage.getItem("commissionMode_default"),l=t??a??r;l&&An(l==="add")}catch{}},[s==null?void 0:s.uid]);const[Pn,Ja]=n.useState(!1),[cc,dc]=n.useState(null),Ir=qe.useRef(""),$i=qe.useRef(0);n.useEffect(()=>{const t=a=>{var l;if(Pn)return;try{const c=document.activeElement;if(c){const m=(l=c.tagName)==null?void 0:l.toLowerCase();if(m==="input"||m==="textarea"||m==="select"||m==="button"||c.isContentEditable===!0)return}}catch{}const r=Date.now();if(a.key==="Enter"){const c=(Ir.current||"").trim();Ir.current="",c&&(dc(c),Ja(!0));return}a.key.length===1&&(r-($i.current||0)>100&&(Ir.current=""),Ir.current+=a.key,$i.current=r)};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[Pn]);const[mc,hc]=n.useState(!1),[uc,Mh]=n.useState(null),[Z,kn]=n.useState("");n.useEffect(()=>{if(!vn)return;const t=Gt(),a=parseFloat(Lt||"0")||0;let r=0;if(ie==="transfer"){if((t==null?void 0:t.defaultTransferCommission)!=null){const c=Number(t.defaultTransferCommission)||0;r=Math.round(c*a/1e3*100)/100}else{const c=ms&&ms.trim()!==""?parseFloat(ms):0;r=Math.max(0,c)}const l=a+r;xa((l||0).toString())}else{if((t==null?void 0:t.defaultWithdrawCommission)!=null){const c=Number(t.defaultWithdrawCommission)||0;r=Math.round(c*a/1e3*100)/100}else{const c=ds&&ds.trim()!==""?parseFloat(ds):Math.round(a*.01*100)/100;r=Math.max(0,c)}const l=dt?a:Math.max(0,Math.round((a-r)*100)/100);xa((l||0).toString())}},[vn,Lt,ms,ds,Z,dt,ie]);const Gt=()=>{var a,r;let t=Be.find(l=>l.id===Z);if(!t)try{const l=localStorage.getItem(hi());if(l){const c=JSON.parse(l);if(Array.isArray(c)&&c.length>0){const x=localStorage.getItem(`selectedWallet_${(s==null?void 0:s.uid)||"default"}`)||((a=c.find(f=>f.isDefault))==null?void 0:a.id)||((r=c[0])==null?void 0:r.id);t=c.find(f=>f.id===x)}}}catch{}return t};n.useLayoutEffect(()=>{try{const t=`wallets_${(s==null?void 0:s.uid)||"default"}`;let a=localStorage.getItem(t);if(!a){const r=Object.keys(localStorage).find(l=>l.startsWith("wallets_"));r&&(a=localStorage.getItem(r)||null)}if(a){const r=JSON.parse(a);if(Array.isArray(r)&&r.length>0){Ka(r);const l=`selectedWallet_${(s==null?void 0:s.uid)||"default"}`,c=localStorage.getItem(l),m=c&&r.find(x=>x.id===c)||r.find(x=>x.isDefault)||r[0];m&&(kn(m.id),qa(m.phone))}}}catch(t){console.error("تهيئة فورية للمحافظ من التخزين المحلي فشلت:",t)}},[]),n.useEffect(()=>{console.log("🔍 selectedWallet state changed to:",Z)},[Z]),n.useEffect(()=>{Pl()},[s==null?void 0:s.uid]),n.useEffect(()=>{xd()},[]);const[Be,Ka]=n.useState(()=>{try{const t=Object.keys(localStorage).find(r=>r.startsWith("wallets_")),a=t?localStorage.getItem(t):null;if(a){const r=JSON.parse(a);if(Array.isArray(r))return r}}catch{}return[]}),[Ui,xc]=n.useState(""),zi=(()=>{const t=Ui.replace(/\D/g,"");return t?Be.filter(a=>(a.phone||"").replace(/\D/g,"").includes(t)):Be})(),[pc,Lh]=n.useState(null),[gc,qi]=n.useState(!1),[fc,Ar]=n.useState(!1),[yc,vc]=n.useState(null),[Rh,bc]=n.useState([]),[Bh,$h]=n.useState([]),[wc,Ya]=n.useState(!1),[On,Vi]=n.useState("daily"),[Ji,Ha]=n.useState([]),Nc=async t=>{try{if(!s)return;const a=js(),r=ps(),l=localStorage.getItem(a),c=localStorage.getItem(r);let m=l?parseFloat(l):ht,x=c?JSON.parse(c):{...$e};const f=t.amount||t.transferredAmount||t.withdrawnAmount||t.withdrawnAmountDetailed||0;if(t.type==="send"&&(t.fromWallet||Z)){m-=t.commission||0;const S=t.fromWallet||Z;x[S]=(x[S]||0)+f}else if(t.type==="withdraw"&&(t.fromWallet||Z)){m+=f,m-=t.commission||0;const S=t.fromWallet||Z;x[S]=Math.max(0,(x[S]||0)-f)}zt(m),Qt(x),localStorage.setItem(a,m.toString()),localStorage.setItem(r,JSON.stringify(x));const I={cashBalance:m,walletBalances:x,lastUpdated:new Date().toISOString()},w=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(w,JSON.stringify(I));try{await Ae.updateUserData(s.uid,I),localStorage.removeItem(w),ke(!1)}catch(S){console.warn("تعذر حفظ الأرصدة في Firebase بعد الحذف (مزامنة تلقائية):",S),ke(!0)}try{const S=t.fromWallet||Z,F=await Cs.getWalletLimits(s.uid,S);if(F){const $={...F};t.type==="send"?($.dailyTransferUsed=Math.max(0,(F.dailyTransferUsed||0)-f),$.monthlyTransferUsed=Math.max(0,(F.monthlyTransferUsed||0)-f)):($.dailyWithdrawUsed=Math.max(0,(F.dailyWithdrawUsed||0)-f),$.monthlyWithdrawUsed=Math.max(0,(F.monthlyWithdrawUsed||0)-f)),await Cs.updateWalletLimits(s.uid,S,$)}}catch(S){console.warn("تعذر تحديث حدود المحفظة بعد الحذف (مزامنة):",S)}try{Zt.removeTransactionEffects(t,s.uid)}catch(S){console.warn("تعذر تحديث التقارير بعد الحذف (مزامنة):",S)}}catch(a){console.warn("خطأ أثناء تطبيق تأثيرات الحذف محليًا:",a)}},jc=async t=>{try{const a=lt.find(l=>l.id===t);if(!a||!s)return;const r=lt.filter(l=>l.id!==t);_s(r);try{await Ae.removeUserTransaction(s.uid,t),await pr.permanentlyDeleteTransaction(t,s.uid)}catch(l){console.warn("تعذر الحذف النهائي من قواعد البيانات أثناء حذف الإيصال:",l)}try{const l=js(),c=ps(),m=localStorage.getItem(l),x=localStorage.getItem(c);let f=m?parseFloat(m):ht,I=x?JSON.parse(x):{...$e};const w=a.amount||a.transferredAmount||a.withdrawnAmount||a.withdrawnAmountDetailed||0;if(a.type==="send"&&(a.fromWallet||Z)){f-=a.commission||0;const $=a.fromWallet||Z;I[$]=(I[$]||0)+w}else if(a.type==="withdraw"&&(a.fromWallet||Z)){f+=w,f-=a.commission||0;const $=a.fromWallet||Z;I[$]=Math.max(0,(I[$]||0)-w)}zt(f),Qt(I),localStorage.setItem(l,f.toString()),localStorage.setItem(c,JSON.stringify(I));const S={cashBalance:f,walletBalances:I,lastUpdated:new Date().toISOString()},F=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(F,JSON.stringify(S)),s!=null&&s.uid?Ae.updateUserData(s.uid,S).then(()=>{localStorage.removeItem(F),ke(!1)}).catch($=>{console.warn("تعذر حفظ الأرصدة في Firebase بعد الحذف، تم الاحتفاظ محليًا:",$),ke(!0)}):ke(!0)}catch(l){console.warn("تعذر عكس تأثير الأرصدة بعد الحذف:",l)}try{const l=a.fromWallet||Z,c=await Cs.getWalletLimits(s.uid,l);if(c){const m=a.amount||a.transferredAmount||a.withdrawnAmount||a.withdrawnAmountDetailed||0,x={...c};a.type==="send"?(x.dailyTransferUsed=Math.max(0,(c.dailyTransferUsed||0)-m),x.monthlyTransferUsed=Math.max(0,(c.monthlyTransferUsed||0)-m)):(x.dailyWithdrawUsed=Math.max(0,(c.dailyWithdrawUsed||0)-m),x.monthlyWithdrawUsed=Math.max(0,(c.monthlyWithdrawUsed||0)-m)),await Cs.updateWalletLimits(s.uid,l,x)}}catch(l){console.warn("تعذر تحديث حدود المحفظة بعد الحذف:",l)}try{Zt.removeTransactionEffects(a,s.uid)}catch(l){console.warn("تعذر تحديث التقارير بعد الحذف:",l)}i({title:"تم الحذف نهائيًا",description:"تم حذف الإيصال نهائيًا وعكس تأثيراته على الأرصدة والحدود والتقارير."}),Ar(!1)}catch(a){console.error("خطأ أثناء حذف الإيصال:",a),i({title:"خطأ في حذف الإيصال",description:"حدث خطأ غير متوقع أثناء الحذف.",variant:"destructive"})}},Sc=async t=>{var a;try{const r=lt.find(l=>l.id===t);if(!r||!s)return;try{if(((a=ts==null?void 0:ts.subscription)==null?void 0:a.planType)===Fs.ZERO){const{dailyOperationCountService:c}=await ft(async()=>{const{dailyOperationCountService:f}=await import("./dailyOperationCountService-CGiiympf.js");return{dailyOperationCountService:f}},__vite__mapDeps([2,0,1]),import.meta.url),m=r.type==="send"?"transfer":"withdraw";if(!(await c.checkAndIncrement(s.uid,m,5)).allowed){i({title:"تم بلوغ حد باقة الزيرو",description:"مسموح بحد أقصى 5 تأكيدات يوميًا للتحويل/السحب. جرّب غدًا أو قم بالترقية.",variant:"destructive"});return}}}catch(l){console.warn("تعذر التحقق من حد التأكيد اليومي:",l)}await Ms(ze(K,"userTransactions",t),{status:"completed",confirmedAt:new Date}),_s(l=>l.map(c=>c.id===t?{...c,status:"completed"}:c)),i({title:"تم الإكمال",description:"تم وسم المعاملة كمكتملة."}),Ar(!1)}catch(r){console.error("خطأ أثناء إكمال الإيصال:",r),i({title:"فشل الإكمال",description:"حدث خطأ غير متوقع أثناء تحديث الحالة.",variant:"destructive"})}};n.useEffect(()=>{if(s)try{const t=ot(Ee(K,"deletedTransactions"),De("userId","==",s.uid)),a=Rs(t,r=>{r.docChanges().forEach(l=>{if(l.type!=="added")return;const c=l.doc.data(),m=c==null?void 0:c.originalTransactionId;m&&_s(x=>{const f=x.find(w=>w.id===m);return f?((async()=>await Nc(f))(),x.filter(w=>w.id!==m)):x})})},r=>{console.warn("فشل الاشتراك في deletedTransactions:",r)});return()=>a()}catch(t){console.warn("تعذر إنشاء مستمع deletedTransactions:",t)}},[s==null?void 0:s.uid]),n.useEffect(()=>{if(s)try{const t=ze(K,"users",s.uid),a=Rs(t,async r=>{if(!r.exists())return;const l=r.data();if(l!=null&&l.reportsData)try{await Zt.syncReportsDataFromFirebase(s.uid),bc(mr())}catch(c){console.warn("تعذر مزامنة reportsData من السحابة:",c)}},r=>{console.warn("فشل الاشتراك في users.reportsData:",r)});return()=>a()}catch(t){console.warn("تعذر إنشاء مستمع users.reportsData:",t)}},[s==null?void 0:s.uid]);const[Ki,Dc]=n.useState(""),Yi=bh(Ki,300),[Tr,Hi]=n.useState(""),[Pr,Gi]=n.useState(""),[qs,Uh]=n.useState(""),[En,ka]=n.useState(!1),[Qi,Ga]=n.useState(!1),[Cc,pa]=n.useState(!1),[Ut,_n]=n.useState(null),[hs,Ic]=n.useState(null),[Zi,ga]=n.useState(!1),[Ac,Oa]=n.useState(!1),[Xi,Tc]=n.useState(""),[Pc,Wn]=n.useState(!1),[kc,kr]=n.useState(!1),[Oc,Or]=n.useState(!1),[Ec,Er]=n.useState(!1),[_c,el]=n.useState(!0),[Qa,Wc]=n.useState(!1),[Fc,_r]=n.useState(!1),[Mc,tl]=n.useState(()=>{try{const t=s!=null&&s.uid?`dailyReportsLockEnabled_${s==null?void 0:s.uid}`:"dailyReportsLockEnabled";return(localStorage.getItem(t)??localStorage.getItem("dailyReportsLockEnabled"))==="true"}catch{return!1}}),[Lc,Fn]=n.useState(!1);n.useEffect(()=>{try{const t=s!=null&&s.uid?`dailyReportsLockEnabled_${s==null?void 0:s.uid}`:"dailyReportsLockEnabled",a=localStorage.getItem(t)??localStorage.getItem("dailyReportsLockEnabled");tl(a==="true")}catch{}},[s==null?void 0:s.uid]);const[Rc,Ea]=n.useState(!1),[Bc,Mn]=n.useState(!1),[$c,sl]=n.useState(()=>{try{const t=s==null?void 0:s.uid,a=t?`debtsPinRequired_${t}`:"debtsPinRequired";return(localStorage.getItem(a)??localStorage.getItem("debtsPinRequired"))==="true"}catch{return!1}}),[Uc,al]=n.useState(!1),[rl,zc]=n.useState(null),[Ct,us]=n.useState([]),[Ln,nl]=n.useState(""),[Rn,il]=n.useState(""),[Bn,ll]=n.useState(""),[ge,Za]=n.useState(null),[qc,Xs]=n.useState(!1),[Vc,Xa]=n.useState(!1),[fa,ol]=n.useState(null),[cl,$n]=n.useState(""),[Wr,dl]=n.useState(null),[zh,qh]=n.useState(!1),[Jc,Un]=n.useState(!1),[ml,zn]=n.useState(""),[qn,er]=n.useState(!1),[hl,Vn]=n.useState(1),Kc=M?10:20,Jn=qe.useMemo(()=>Ct.slice(0,hl*Kc),[Ct,hl]);n.useEffect(()=>{qn&&Vn(1)},[qn]);const Kn=async()=>{if(pt){i({title:"غير متاح",description:"إدارة الديون/الأجل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"});return}try{const t=await ns.hasMasterPin(s==null?void 0:s.uid);$c&&t?Mn(!0):Ea(!0)}catch{Ea(!0)}};n.useEffect(()=>{try{const t=s==null?void 0:s.uid,a=t?`debtsPinRequired_${t}`:"debtsPinRequired",r=localStorage.getItem(a)??localStorage.getItem("debtsPinRequired");(r==="true"||r==="false")&&sl(r==="true")}catch{}},[s==null?void 0:s.uid]);const[Yc,Yn]=n.useState(!1),[Vs,Hn]=n.useState([]),[Gn,ul]=n.useState(""),[Qn,xl]=n.useState(""),[Zn,pl]=n.useState(""),[gl,fl]=n.useState(""),[Hc,tr]=n.useState(!1),[_a,Xn]=n.useState(null),[xs,sr]=n.useState(null),[Fr,ei]=n.useState(""),[Gc,Wa]=n.useState(!1),[yl,Mr]=n.useState(0),[fs,ea]=n.useState(null),[ya,ti]=n.useState(""),[Ve,Qc]=n.useState(null),Ns=async t=>{try{const a=JSON.stringify(t);localStorage.setItem(qr(),a);try{localStorage.setItem(Tl(),a)}catch{}try{localStorage.setItem(ci(),Date.now().toString())}catch{}s!=null&&s.uid&&Ae.updateUserData(s.uid,{debts:t}).then(()=>{try{localStorage.removeItem(`debts_unsynced_${s.uid}`)}catch{}}).catch(()=>{ke(!0);try{localStorage.setItem(`debts_unsynced_${s.uid}`,"true")}catch{}})}catch(a){console.error("خطأ في حفظ الديون:",a)}},Zc=async()=>{try{const t=qr(),a=Tl(),r=ci(),l=localStorage.getItem(t),c=localStorage.getItem(a),m=localStorage.getItem(r),x=m?Number(m):0,f=w=>{if(!w)return null;try{const S=JSON.parse(w);return Array.isArray(S)?S.map(F=>{var $;return{...F,createdAt:($=F.createdAt)!=null&&$.toDate?F.createdAt.toDate():new Date(F.createdAt),partialPayments:Array.isArray(F.partialPayments)?F.partialPayments.map(z=>{var be;return{amount:Number(z.amount)||0,paidAt:(be=z.paidAt)!=null&&be.toDate?z.paidAt.toDate():new Date(z.paidAt)}}):[]}}):[]}catch(S){return console.warn("فشل في تحليل ديون localStorage:",S),null}};let I=f(l);if(!I||I.length===0){const w=f(c);if(w&&w.length>0&&(I=w,us(w),s!=null&&s.uid))try{await Ns(w),localStorage.removeItem(a)}catch(S){console.warn("تعذر ترحيل الديون من المفتاح الافتراضي:",S)}}if(I&&I.length>0&&us(I),s!=null&&s.uid)try{const w=`debts_unsynced_${s.uid}`,S=localStorage.getItem(w)==="true",F=await ca(ze(K,"users",s.uid));if(F.exists()){const $=F.data(),z=$.debts&&Array.isArray($.debts)?$.debts.map(St=>{var kt;return{...St,createdAt:(kt=St.createdAt)!=null&&kt.toDate?St.createdAt.toDate():new Date(St.createdAt),partialPayments:Array.isArray(St.partialPayments)?St.partialPayments.map(ta=>{var Ks;return{amount:Number(ta.amount)||0,paidAt:(Ks=ta.paidAt)!=null&&Ks.toDate?ta.paidAt.toDate():new Date(ta.paidAt)}}):[]}}):[],be=x&&Date.now()-x<12e4,Xe=S||be?I||[]:z&&z.length>0?z:I||[];us(Xe);try{localStorage.setItem(t,JSON.stringify(Xe))}catch{}((z==null?void 0:z.length)||0)===0&&((Xe==null?void 0:Xe.length)||0)>0&&await Ae.updateUserData(s.uid,{debts:Xe})}else I&&I.length>0&&await Ae.saveUserData(s.uid,{debts:I})}catch(w){console.warn("تعذر تحميل الديون من Firebase، الاعتماد على المحلي:",w)}}catch(t){console.error("خطأ في تحميل الديون:",t)}};n.useEffect(()=>{try{window.exportDebts=()=>{try{return JSON.stringify(Ct||[])}catch{return"[]"}},window.importDebts=async t=>{try{const a=JSON.parse(t);if(!Array.isArray(a))throw new Error("صيغة غير صحيحة — يجب أن تكون مصفوفة");return await Ns(a),{ok:!0,count:a.length}}catch(a){return console.error("فشل استيراد الديون:",a),{ok:!1,error:String(a)}}},window.fixWalletsForCurrentUser=async t=>{try{if(!(s!=null&&s.uid))throw new Error("يجب تسجيل الدخول أولاً");return await(await ft(async()=>{const{merchantWalletService:r}=await import("./index-5EflPS7Y.js").then(l=>l.bi);return{merchantWalletService:r}},__vite__mapDeps([0,1]),import.meta.url)).merchantWalletService.reassignByMsisdns(t,s.uid)}catch(a){return console.error("فشل إصلاح المحافظ للمستخدم الحالي:",a),{updated:0,failed:(t==null?void 0:t.length)||0,error:String(a)}}}}catch{}},[Ct,s==null?void 0:s.uid]),n.useEffect(()=>{if(!(s!=null&&s.uid))return;const t=ze(K,"users",s.uid),a=Rs(t,r=>{if(!r.exists())return;const l=r.data(),c=Array.isArray(l==null?void 0:l.debts)?l.debts:[],m=`debts_unsynced_${s.uid}`,x=localStorage.getItem(m)==="true",f=localStorage.getItem(ci()),I=f?Number(f):0,w=I&&Date.now()-I<12e4;if(!(x||w))try{const S=c.map(F=>{var $;return{...F,createdAt:($=F.createdAt)!=null&&$.toDate?F.createdAt.toDate():new Date(F.createdAt),partialPayments:Array.isArray(F.partialPayments)?F.partialPayments.map(z=>{var be;return{amount:Number(z.amount)||0,paidAt:(be=z.paidAt)!=null&&be.toDate?z.paidAt.toDate():new Date(z.paidAt)}}):[]}});us(S);try{localStorage.setItem(qr(),JSON.stringify(S))}catch{}}catch(S){console.warn("تعذر تحليل الديون من التحديثات الحية:",S)}},r=>{console.warn("خطأ في الاشتراك الحي لديون المستخدم:",r)});return()=>a()},[s==null?void 0:s.uid]);const Xc=async()=>{if(s!=null&&s.uid){console.log("🔄 إعادة فحص حالة المستخدم...");try{await new Promise(a=>setTimeout(a,500));const t=await ca(ze(K,"users",s.uid));if(t.exists()){const r=t.data().isActive===!0,l=await vr.checkTrialValidity(s.uid),c=l.isValid&&!l.isExpired;console.log("📊 حالة المستخدم:",{isActive:r,isOnTrial:c,hoursRemaining:l.hoursRemaining}),at(r||c),le(c),ve(l.hoursRemaining),Ht(l.hasUsedTrial),ls(!r&&!c),console.log("✅ تم تحديث حالة المستخدم بنجاح:",{userIsActive:r||c,isOnFreeTrial:c})}}catch(t){console.error("خطأ في إعادة فحص حالة المستخدم:",t)}}},ed=async()=>{console.log("🎉 تم بدء التجربة المجانية، إعادة فحص حالة المستخدم..."),await Xc()},td=async()=>{if(s!=null&&s.uid)try{Mt(!0);const t=await Pi(s.uid);_e(t)}catch(t){console.error("خطأ في جلب بيانات الاشتراك:",t)}finally{Mt(!1)}},[Vh,Jh]=n.useState(!1),[sd,si]=n.useState(!1),[ht,zt]=n.useState(0),[$e,Qt]=n.useState({}),[ad,vl]=n.useState(!1),[rd,bl]=n.useState(!1),[nd,ai]=n.useState(!1),[id,Lr]=n.useState(!1),[wl,ri]=n.useState(""),[ld,ar]=n.useState(!1),[od,Rr]=n.useState(!1),[ni,Br]=n.useState(""),[cd,ii]=n.useState(!1),[$r,Nl]=n.useState(""),[Ur,jl]=n.useState(""),[zr,Sl]=n.useState(""),[Dl,Cl]=n.useState(!1),[li,oi]=n.useState(!1),[dd,Il]=n.useState(!1),[Al,md]=n.useState([]);n.useEffect(()=>{(async()=>{try{if(!(s!=null&&s.uid)||!li)return;try{await ur.trimToMaxCount(s.uid,30)}catch{}const t=await ur.getByUser(s.uid,30);md(t)}catch{}})()},[s==null?void 0:s.uid,li]);const ps=()=>{const t=P||(D==null?void 0:D.shopId)||"main";return`walletBalances_${(s==null?void 0:s.uid)||"default"}_${t}`},js=()=>{const t=P||(D==null?void 0:D.shopId)||"main";return`cashBalance_${(s==null?void 0:s.uid)||"default"}_${t}`},qr=()=>{const t=P||(D==null?void 0:D.shopId)||"main";return`debts_${(s==null?void 0:s.uid)||"default"}_${t}`},hd=()=>{const t=P||(D==null?void 0:D.shopId)||"main";return`customers_${(s==null?void 0:s.uid)||"default"}_${t}`},Tl=()=>`debts_default_${P||(D==null?void 0:D.shopId)||"main"}`,ci=()=>{const t=P||(D==null?void 0:D.shopId)||"main";return`debts_last_write_${(s==null?void 0:s.uid)||"default"}_${t}`},di=()=>`shopExpenses_${P||(D==null?void 0:D.shopId)||(s==null?void 0:s.uid)||"default"}`,Pl=()=>{try{const t=localStorage.getItem(di());if(t){const a=JSON.parse(t);Bt(a.map(r=>({...r,createdAt:new Date(r.createdAt)})))}}catch(t){console.error("خطأ أثناء تحميل مصروفات المحل من التخزين:",t)}},kl=async t=>{try{localStorage.setItem(di(),JSON.stringify(t)),Bt(t)}catch(a){console.error("خطأ أثناء حفظ مصروفات المحل في التخزين:",a)}},ud=async t=>{try{const a=it.filter(r=>r.id!==t);await kl(a);try{if(s!=null&&s.uid&&t){const{doc:r,deleteDoc:l}=await ft(async()=>{const{doc:x,deleteDoc:f}=await import("./index-5EflPS7Y.js").then(I=>I.bg);return{doc:x,deleteDoc:f}},__vite__mapDeps([0,1]),import.meta.url),{db:c}=await ft(async()=>{const{db:x}=await import("./index-5EflPS7Y.js").then(f=>f.bh);return{db:x}},__vite__mapDeps([0,1]),import.meta.url),m=r(c,"shop_expenses",t);await l(m)}}catch(r){console.warn("تعذر حذف المصروف من السحابة الآن، تم الحذف محليًا وسيبقى مخزّنًا دون هذا الإيصال:",r)}i({title:"تم الحذف",description:"تم حذف إيصال المصروف نهائيًا."})}catch(a){console.error("خطأ أثناء الحذف النهائي لإيصال المصروف:",a),i({title:"فشل الحذف",description:"تعذر حذف الإيصال. حاول مرة أخرى.",variant:"destructive"})}};qe.useEffect(()=>{let t;return(async()=>{try{if(!(s!=null&&s.uid)){Pl();return}const{collection:a,query:r,where:l,onSnapshot:c}=await ft(async()=>{const{collection:I,query:w,where:S,onSnapshot:F}=await import("./index-5EflPS7Y.js").then($=>$.bg);return{collection:I,query:w,where:S,onSnapshot:F}},__vite__mapDeps([0,1]),import.meta.url),{db:m}=await ft(async()=>{const{db:I}=await import("./index-5EflPS7Y.js").then(w=>w.bh);return{db:I}},__vite__mapDeps([0,1]),import.meta.url),x=P||(D==null?void 0:D.shopId),f=x?r(a(m,"shop_expenses"),l("shopId","==",x)):r(a(m,"shop_expenses"),l("userId","==",s.uid));t=c(f,async I=>{const S=I.docs.map(F=>{var be;const $=F.data(),z=(be=$.createdAt)!=null&&be.toDate?$.createdAt.toDate():$.createdAt?new Date($.createdAt):new Date;return{id:F.id,name:String($.name||""),amount:Number($.amount||0),notes:$.notes?String($.notes):void 0,source:$.source==="wallet"?"wallet":"cash",walletId:$.walletId?String($.walletId):void 0,createdAt:z}}).sort((F,$)=>$.createdAt.getTime()-F.createdAt.getTime());Bt(S);try{localStorage.setItem(di(),JSON.stringify(S))}catch{}})}catch(a){console.error("خطأ في مزامنة مصروفات المحل من Firestore:",a)}})(),()=>t==null?void 0:t()},[s==null?void 0:s.uid,D==null?void 0:D.shopId,P]);const Vr=()=>`deficiencies_${P||(D==null?void 0:D.shopId)||(s==null?void 0:s.uid)||"default-shop"}`,xd=()=>{try{const t=Vr(),a=`deficiencies_${(s==null?void 0:s.uid)||"default"}`;if(a!==t){const l=localStorage.getItem(a),c=localStorage.getItem(t);if(l)try{const m=JSON.parse(l)||[],x=c?JSON.parse(c):[],f=Array.isArray(x)?[...x]:[],I=(w,S)=>w.some(F=>(F==null?void 0:F.id)&&(S==null?void 0:S.id)&&String(F.id)===String(S.id)||String((F==null?void 0:F.name)||"")===String((S==null?void 0:S.name)||"")&&String((F==null?void 0:F.status)||"pending")===String((S==null?void 0:S.status)||"pending"));if(Array.isArray(m))for(const w of m)I(f,w)||f.push(w);localStorage.setItem(t,JSON.stringify(f));try{localStorage.removeItem(a)}catch{}}catch{}}const r=localStorage.getItem(t);if(r){const l=JSON.parse(r);X(l.map(c=>({...c,createdAt:new Date(c.createdAt)})))}}catch(t){console.error("خطأ أثناء تحميل النواقص من التخزين:",t)}},mi=async t=>{try{localStorage.setItem(Vr(),JSON.stringify(t)),X(t)}catch(a){console.error("خطأ أثناء حفظ النواقص في التخزين:",a)}};qe.useEffect(()=>{let t;return(async()=>{try{if(!(s!=null&&s.uid))return;const{collection:a,query:r,where:l,orderBy:c,onSnapshot:m}=await ft(async()=>{const{collection:w,query:S,where:F,orderBy:$,onSnapshot:z}=await import("./index-5EflPS7Y.js").then(be=>be.bg);return{collection:w,query:S,where:F,orderBy:$,onSnapshot:z}},__vite__mapDeps([0,1]),import.meta.url),{db:x}=await ft(async()=>{const{db:w}=await import("./index-5EflPS7Y.js").then(S=>S.bh);return{db:w}},__vite__mapDeps([0,1]),import.meta.url),f=P||(D==null?void 0:D.shopId)||s.uid||"default-shop",I=r(a(x,"deficiencies"),l("shopId","==",f),c("createdAt","desc"));t=m(I,async w=>{const S=w.docs.map(F=>{var be;const $=F.data(),z=(be=$.createdAt)!=null&&be.toDate?$.createdAt.toDate():$.createdAt?new Date($.createdAt):new Date;return{id:F.id,name:String($.name||""),quantity:Number($.quantity||1),status:$.status==="purchased"?"purchased":"pending",createdAt:z}});X(S);try{localStorage.setItem(Vr(),JSON.stringify(S))}catch{}},w=>{console.warn("فشل الاشتراك في النواقص من Firestore:",w)})}catch(a){console.warn("فشل إعداد مزامنة النواقص من Firestore:",a)}})(),()=>{try{t&&t()}catch{}}},[s==null?void 0:s.uid,D==null?void 0:D.shopId,P]);const pd=async t=>{try{localStorage.setItem(hd(),JSON.stringify(t)),Hn(t),s!=null&&s.uid&&await Ae.updateUserData(s.uid,{customers:t})}catch(a){console.error("خطأ أثناء حفظ العملاء في التخزين:",a)}},gd=async()=>{try{if(s!=null&&s.uid){const t=await ca(ze(K,"users",s.uid));if(t.exists()){const a=t.data();if(a.customers&&Array.isArray(a.customers)){const r=a.customers.map(l=>{var c;return{...l,createdAt:(c=l.createdAt)!=null&&c.toDate?l.createdAt.toDate():new Date(l.createdAt)}});Hn(r);return}}}Hn([])}catch(t){console.error("خطأ أثناء تحميل العملاء من Firestore:",t)}},Fa=()=>{const t=P||(D==null?void 0:D.shopId)||"main";return`transactions_${(s==null?void 0:s.uid)||"default"}_${t}`},hi=()=>{const t=P||(D==null?void 0:D.shopId)||"main";return`wallets_${(s==null?void 0:s.uid)||"default"}_${t}`},ui=()=>{const t=P||(D==null?void 0:D.shopId)||"main";return`selectedWallet_${(s==null?void 0:s.uid)||"default"}_${t}`},[xi,Jr]=n.useState(""),[gs,Ol]=n.useState(""),Ws=qe.useMemo(()=>{const t=ts;if(!t)return!1;const a=am(t),r=t.planType??t.plan??null,l=typeof r=="string"?r.toLowerCase():null,c=l==="monthly"||l==="quarterly"||l==="yearly"||l==="lifetime"||r===Fs.MONTHLY||r===Fs.QUARTERLY||r===Fs.YEARLY||r===Fs.LIFETIME;return a&&c},[ts]),pt=qe.useMemo(()=>{const t=ts;if(!t)return!1;const a=t.planType??t.plan??null,r=typeof a=="string"?a.toLowerCase():null;return a===Fs.ZERO||r==="zero"},[ts]),fd=()=>{if(!Ws){i({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}J(!0)},[Kh,Yh]=n.useState(!1),[yd,vd]=n.useState(!1),[bd,wd]=n.useState(!1),[Nd,jd]=n.useState(!1),[Sd,rr]=n.useState(!1),[va,Kr]=n.useState(""),[nr,Yr]=n.useState(""),[El,Hr]=n.useState(!1),[Ma,ir]=n.useState(null),[Gr,Qr]=n.useState(""),[Dd,_l]=n.useState(!1),[Hh,Gh]=n.useState(!1),[Cd,Zr]=n.useState(!1),[Wl,pi]=n.useState(""),[Fl,gi]=n.useState(""),[Ml,Ll]=n.useState(!1),Rl=async()=>{if(s!=null&&s.uid)try{const t=`userData_${s.uid}`,a=localStorage.getItem(t),r=`debts_unsynced_${s.uid}`,l=localStorage.getItem(qr()),c=localStorage.getItem(r)==="true";if(a){const m=JSON.parse(a);console.log("🔄 مزامنة البيانات المحلية مع Firebase...",m);const x={lastSynced:new Date().toISOString()};typeof m.cashBalance=="number"&&(x.cashBalance=m.cashBalance),m.walletBalances&&typeof m.walletBalances=="object"&&(x.walletBalances=m.walletBalances),await Ae.updateUserData(s.uid,x),localStorage.removeItem(t),ke(!1),console.log("✅ تمت المزامنة بنجاح وحذف البيانات المحلية")}else console.log("لا توجد بيانات محلية تحتاج للمزامنة");if(c&&l)try{const m=JSON.parse(l)||[];await Ae.updateUserData(s.uid,{debts:m});try{localStorage.removeItem(r)}catch{}ke(!1),console.log("✅ تمت مزامنة الديون مع Firebase")}catch(m){console.error("❌ فشل مزامنة الديون:",m),ke(!0)}}catch(t){console.error("❌ فشل في مزامنة البيانات:",t),i({title:"فشل في المزامنة",description:"حدث خطأ أثناء مزامنة البيانات مع الخادم",variant:"destructive"})}},[La,Xr]=n.useState({keepLastCount:30,intervalDays:7,lastResetAt:null});n.useEffect(()=>{(async()=>{if(s!=null&&s.uid)try{const a=await Ae.getUserData(s.uid),r=(a==null?void 0:a.recentReset)||{},l=Number(r==null?void 0:r.keepLastCount)>0?Number(r.keepLastCount):30,c=Number(r==null?void 0:r.intervalDays)>0?Number(r.intervalDays):7,m=w=>w instanceof Date?w:typeof(w==null?void 0:w.toDate)=="function"?w.toDate():w?new Date(String(w)):null,x=r!=null&&r.lastResetAt?m(r.lastResetAt):null,f=new Date;!x||f.getTime()-x.getTime()>=c*24*60*60*1e3?(await Ae.updateUserData(s.uid,{recentReset:{keepLastCount:l,intervalDays:c,lastResetAt:f}}),Xr({keepLastCount:l,intervalDays:c,lastResetAt:f})):Xr({keepLastCount:l,intervalDays:c,lastResetAt:x})}catch{Xr({keepLastCount:30,intervalDays:7,lastResetAt:null})}})()},[s==null?void 0:s.uid]);const Bl=qe.useMemo(()=>{const t=lt||[],a=La.keepLastCount??30;return[...t].sort((l,c)=>{const m=x=>x instanceof Date?x:typeof(x==null?void 0:x.toDate)=="function"?x.toDate():new Date(String(x));return m(c.createdAt).getTime()-m(l.createdAt).getTime()}).slice(0,a)},[lt,La.keepLastCount]),Id=qe.useMemo(()=>Math.max(0,((lt==null?void 0:lt.length)||0)-(La.keepLastCount||30)),[lt==null?void 0:lt.length,La.keepLastCount]),$l=qe.useCallback(()=>{let t=Bl;const a=Yi.trim();if(a&&(t=t.filter(r=>r.senderPhone&&r.senderPhone.includes(a)||r.receiverPhone&&r.receiverPhone.includes(a))),Tr){const r=new Date(Tr);t=t.filter(l=>{const c=new Date(l.createdAt);if(Pr){const[m,x]=Pr.split(":"),f=new Date(r);f.setHours(parseInt(m),parseInt(x),0,0);const I=new Date(f);return I.setHours(I.getHours()+1),c>=f&&c<I}else return c.toDateString()===r.toDateString()})}try{t=[...t].sort((r,l)=>{const c=new Date(r.createdAt||0).getTime();return new Date(l.createdAt||0).getTime()-c})}catch{}return t},[Bl,Yi,Tr,Pr]),[Ad,en]=n.useState(!1),[Ul,tn]=n.useState(""),[Td,sn]=n.useState(!1),[fi,yi]=n.useState(""),[Pd,ke]=n.useState(!1);Be.reduce((t,a)=>t+($e[a.id]||0),0);const kd=async t=>await ns.verifyMasterPin(t,s==null?void 0:s.uid),an=async t=>await ns.verifyMasterPin(t,s==null?void 0:s.uid);n.useEffect(()=>{if(!(s!=null&&s.uid))return;console.log("🚀 استعادة البيانات من localStorage عند تحميل الصفحة للمستخدم:",s.uid);const t=`walletBalances_${s.uid}`,a=localStorage.getItem(t);if(a)try{const c=JSON.parse(a);console.log("📱 استعادة أرصدة المحافظ من localStorage:",c),Qt(c)}catch(c){console.error("خطأ في قراءة أرصدة المحافظ من localStorage:",c)}const r=`cashBalance_${s.uid}`;let l=localStorage.getItem(r);if(!l){const c=`userCashBalance_${s.uid}`,m=localStorage.getItem(c);if(m){l=m;try{localStorage.setItem(r,m),localStorage.removeItem(c)}catch{}}}if(l){const c=parseFloat(l);console.log("💰 استعادة رصيد الدرج النقدي من localStorage:",c),zt(c)}},[s==null?void 0:s.uid]);const zl=async()=>{try{if(!Z)return;const t=await Cs.autoResetLimitsIfNeeded(Z);Qc(t)}catch(t){console.error("خطأ في جلب حدود المحفظة المختارة:",t)}};n.useEffect(()=>{zl()},[Z]),n.useEffect(()=>{const t=a=>{var r;(r=a==null?void 0:a.detail)!=null&&r.walletId&&a.detail.walletId===Z&&zl()};return window.addEventListener("walletLimitsUpdated",t),()=>window.removeEventListener("walletLimitsUpdated",t)},[Z]),n.useEffect(()=>{if(C.state){if(console.log("Location state:",C.state),C.state.openDebtDialog&&(Kn(),window.history.replaceState({},document.title)),C.state.openSalesDialog&&(pt?i({title:"غير متاح",description:"بيانات المبيعات غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ja(!0),window.history.replaceState({},document.title)),C.state.openMaintenanceDialog&&(pt?i({title:"غير متاح",description:"الصيانة غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Or(!0),window.history.replaceState({},document.title)),C.state.openCreditCardsDialog&&(console.log("Opening credit cards dialog"),pt?i({title:"غير متاح",description:"كروت الائتمان غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):kr(!0),window.history.replaceState({},document.title)),C.state.openShopExpensesDialog&&(pt?i({title:"غير متاح",description:"مصروفات المحل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):ns.hasMasterPin()?Pt(!0):_t(!0),window.history.replaceState({},document.title)),C.state.openDeficienciesDialog&&(pt?i({title:"غير متاح",description:"النواقص غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):d(!0),window.history.replaceState({},document.title)),C.state.openTransactionSection){const t=document.getElementById("transaction-section");t&&t.scrollIntoView({behavior:"smooth"}),C.state.transactionType&&Bi(C.state.transactionType),C.state.startNewTransaction&&(Ta(""),Va(""),Cn(""),In(""),console.log("🔒 Starting new transaction without changing wallet selection")),C.state.focusWalletSelection&&setTimeout(()=>{const a=document.querySelector('[data-testid="wallet-select"]');a&&a.focus()},500),window.history.replaceState({},document.title)}C.state.openCashierShiftModal&&(Ws?J(!0):i({title:"غير متاح",description:"وردية الكاشير متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"}),window.history.replaceState({},document.title)),C.state.openMachineDailyDialog&&(Ws?Er(!0):i({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"}),window.history.replaceState({},document.title))}},[C.state,Be]),n.useEffect(()=>{C.pathname==="/user/dashboard"&&sessionStorage.getItem("previousPath")==="/user/add-wallet"&&(console.log("🔄 Returned from wallet addition page - reloading wallets"),lr(),sessionStorage.removeItem("previousPath")),sessionStorage.setItem("previousPath",C.pathname)},[C.pathname,s==null?void 0:s.uid]),n.useEffect(()=>{if(!(s!=null&&s.uid))return;console.log("🔥 Setting up real-time user activation listener for:",s.uid);const t=ze(K,"users",s.uid),a=Rs(t,r=>{if(r.exists()){const l=r.data(),c=l.isActive===!0;console.log("🔥 Real-time user status update:",{userId:s.uid,isActive:c,subscription:l.subscription}),c&&!Dt?(console.log("🎉 User activated! Redirecting to dashboard..."),at(!0),ls(!1),xt(!1)):!c&&Dt&&(console.log("❌ User deactivated! Showing activation modal..."),at(!1),ls(!0))}},r=>{console.error("❌ Error in real-time user listener:",r)});return()=>{console.log("🔥 Cleaning up real-time user listener"),a()}},[s==null?void 0:s.uid,Dt]),n.useEffect(()=>{if(!(s!=null&&s.uid))return;const t=r=>{const{userId:l}=r.detail;l===s.uid&&(console.log("🎉 Subscription activation event received for current user!"),at(!0),ls(!1),xt(!1),setTimeout(()=>{console.log("✅ User activation completed - data updated")},1e3))},a=r=>{const{userId:l,isActive:c}=r.detail;l===s.uid&&(console.log("🔄 User subscription update event received:",{userId:l,isActive:c}),c&&!Dt&&(at(!0),ls(!1),xt(!1),setTimeout(()=>{console.log("✅ User subscription updated - data refreshed")},1e3)))};return window.addEventListener("subscriptionActivated",t),window.addEventListener("userSubscriptionUpdated",a),()=>{window.removeEventListener("subscriptionActivated",t),window.removeEventListener("userSubscriptionUpdated",a)}},[s==null?void 0:s.uid,Dt]),n.useEffect(()=>{const t=a=>{var m;const r=a.target,l=(m=r==null?void 0:r.tagName)==null?void 0:m.toLowerCase();if(!(l==="input"||l==="textarea"||l==="select"||((r==null?void 0:r.isContentEditable)??!1))&&!(a.ctrlKey||a.altKey||a.metaKey)&&!a.repeat){if(pt&&a.key>="1"&&a.key<="9"){a.preventDefault();return}switch(a.key){case"1":break;case"2":Wn(!0);break;case"3":pt?i({title:"غير متاح",description:"كروت الائتمان غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):kr(!0);break;case"4":Ws?J(!0):i({title:"غير متاح",description:"وردية الكاشير متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});break;case"5":pt?i({title:"غير متاح",description:"بيانات المبيعات غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ja(!0);break;case"6":Kn();break;case"7":pt?i({title:"غير متاح",description:"الصيانة غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Or(!0);break;case"8":Ws?Er(!0):i({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});break;case"9":pt?i({title:"غير متاح",description:"مصروفات المحل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):ns.hasMasterPin()?Pt(!0):_t(!0);break}}};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[pt,Ws]),n.useEffect(()=>{console.log("🔥 useEffect loadUserData started",{user:s==null?void 0:s.uid,isCheckingActivation:Ue}),(async()=>{try{if(!(s!=null&&s.uid)){console.log("🔥 No user UID, setting isCheckingActivation to false"),xt(!1);return}try{const m=await ca(ze(K,"users",s.uid));if(m.exists()){const f=m.data().isActive===!0,I=await vr.checkTrialValidity(s.uid),w=I.isValid&&!I.isExpired;at(f||w),le(w),ve(I.hoursRemaining),Ht(I.hasUsedTrial),ls(!f&&!w),console.log("📊 حالة المستخدم:",{isActive:f,isOnTrial:w,hoursRemaining:I.hoursRemaining,hasUsedTrial:I.hasUsedTrial})}else at(!1),ls(!0)}catch(m){console.error("خطأ في فحص حالة تفعيل المستخدم:",m),at(!1),ls(!0)}finally{xt(!1)}if(console.log("🔄 بدء تحميل بيانات المستخدم من Firebase...",{userId:s==null?void 0:s.uid}),s!=null&&s.uid){const m=await Ae.getUserData(s.uid);if(console.log("📥 البيانات المحملة من Firebase:",m),m){const x=(m==null?void 0:m.walletBalances)||{};console.log("🏛️ اعتماد Firebase كمصدر الحقيقة لأرصدة المحافظ"),Qt(x),(m==null?void 0:m.cashBalance)!==void 0&&(console.log("💰 تحميل رصيد الدرج النقدي من Firebase:",m.cashBalance),zt(m.cashBalance));try{const f=s!=null&&s.uid?await pr.getDeletedTransactionsByUser(s.uid):[];Ha(f||[]),console.log("🗑️ تم تحميل المعاملات المحذوفة من Firebase:",(f==null?void 0:f.length)||0)}catch(f){console.error("خطأ في تحميل المعاملات المحذوفة من Firebase:",f),Ha([])}}else{console.log("⚠️ لا توجد بيانات مستخدم في Firebase، سيتم استخدام قيم افتراضية بدون localStorage"),Qt({});try{const x=s!=null&&s.uid?await pr.getDeletedTransactionsByUser(s.uid):[];Ha(x||[])}catch{Ha([])}}}console.log("🔄 بدء تحميل المحافظ من Firebase...");try{const m=await Es.getByMerchantId((s==null?void 0:s.uid)||"");if(m&&m.length>0){console.log("✅ تم العثور على محافظ في Firebase:",m.length);const f=m.filter(S=>S.isActive===!0).map(S=>({id:S.id,name:S.label||"محفظة بدون اسم",phone:S.msisdn,isDefault:!1,monthlyWithdrawalLimit:S.monthlyWithdrawalLimit??S.withdrawLimit??2e5,monthlyTransferLimit:S.monthlyTransferLimit??S.transferLimit??2e5,defaultTransferCommission:S.defaultTransferCommission!=null?Number(S.defaultTransferCommission):null,defaultWithdrawCommission:S.defaultWithdrawCommission!=null?Number(S.defaultWithdrawCommission):null}));Ka(f);const I=localStorage.getItem(ui());let w=null;I&&f.find(S=>S.id===I)?w=f.find(S=>S.id===I):w=f[0],w&&(kn(w.id),qa(w.phone)),console.log("🔄 تم تحديث المحافظ من Firebase وحفظها في localStorage")}else console.log("⚠️ لا توجد محافظ في Firebase. سيتم عرض قائمة فارغة بدون أي استرجاع محلي."),Ka([])}catch(m){console.error("خطأ في تحميل المحافظ من Firebase:",m),Ka([])}const c=s!=null&&s.uid?await Ae.getUserTransactions(s.uid):[];if(c&&c.length>0){console.log("📊 تم تحميل المعاملات من Firebase:",c.length);const m=c.map(S=>({...S,createdAt:new Date(S.createdAt),senderPhone:S.senderMsisdn||S.senderPhone||"",receiverPhone:S.receiverMsisdn||S.receiverPhone||"",type:S.txnType==="send"?"send":S.txnType==="receive"?"withdraw":S.type||"withdraw",status:S.status==="confirmed"?"completed":S.status||"completed"})),x=Ji.map(S=>S.id||S.originalTransactionId);let f=[];try{const S=ot(Ee(K,"deletedTransactions"),De("userId","==",(s==null?void 0:s.uid)||""),De("permanent","==",!0));f=(await ut(S)).docs.map($=>{const z=$.data();return String(z.originalTransactionId||z.transactionId||$.id||"")}).filter(Boolean)}catch{}const I=new Set(f),w=m.filter(S=>{var Xe;const F=String(S.id||""),$=String(S.transactionId||""),z=String(S.reference||S.transactionReference||((Xe=S.receipt)==null?void 0:Xe.reference)||""),be=x.includes(F),Je=I.has(F)||$&&I.has($);return!be&&!Je});console.log("✅ تم فلترة المعاملات المحذوفة:",{total:c.length,deleted:x.length,active:w.length});{const S=z=>{var be;return String((z==null?void 0:z.reference)||(z==null?void 0:z.transactionReference)||((be=z==null?void 0:z.receipt)==null?void 0:be.reference)||(z==null?void 0:z.id))},F=new Map;for(const z of w){const be=S(z),Je=F.get(be);if(!Je)F.set(be,z);else{const Xe=()=>{if((z==null?void 0:z.status)==="completed"&&(Je==null?void 0:Je.status)!=="completed")return z;if((Je==null?void 0:Je.status)==="completed"&&(z==null?void 0:z.status)!=="completed")return Je;const St=new Date((z==null?void 0:z.createdAt)||0).getTime(),kt=new Date((Je==null?void 0:Je.createdAt)||0).getTime();return St>=kt?z:Je};F.set(be,Xe())}}const $=Array.from(F.values());_s($);try{localStorage.setItem(Fa(),JSON.stringify($))}catch(z){console.warn("تعذر حفظ المعاملات في التخزين المحلي بعد التحميل من Firebase:",z)}}}await Rl()}catch(c){console.error("خطأ في تحميل بيانات المستخدم من Firebase:",c)}})().then(async()=>{await l(),await a(),await r()});const a=async()=>{try{if(!(s!=null&&s.uid))return;const c=await Es.getByMerchantId(s.uid);await Promise.all(c.map(m=>Xm.autoResetLimitsIfNeeded(m.id)))}catch(c){console.error("خطأ في التصفير التلقائي للحدود:",c)}},r=async()=>{try{await Zt.syncReportsDataFromFirebase(s==null?void 0:s.uid);const c=Zt.getReportsData(s==null?void 0:s.uid);if((c.lastDailyResetDate?Zt.shouldResetDailyReports(c.lastDailyResetDate):!1)&&(s!=null&&s.uid)&&c.lastDailyResetDate){const f=new Date(c.lastDailyResetDate),I=f.toDateString(),w=lt.filter(Xe=>new Date(Xe.createdAt).toDateString()===I&&Xe.status==="completed"),S=w.length,F=w.reduce((Xe,St)=>Xe+St.amount,0),$=w.filter(cr).reduce((Xe,St)=>{const kt=St.withdrawnAmount!==void 0?St.withdrawnAmount:St.amount;return Xe+kt},0),z=w.filter(dr).reduce((Xe,St)=>{const kt=St.sentAmount!==void 0?St.sentAmount:St.amount;return Xe+kt},0),be=w.reduce((Xe,St)=>Xe+Zt.calculateTransactionProfit(St),0),Je=new Date(f).toISOString().slice(0,10);await ur.add({userId:s.uid,reportDate:Je,totalTransactions:S,totalAmount:Number(F.toFixed(2)),totalWithdrawn:Number($.toFixed(2)),totalSent:Number(z.toFixed(2)),profit:Number(be.toFixed(2)),walletId:null})}const x=Zt.autoResetReportsIfNeeded(s==null?void 0:s.uid);(x.dailyReset||x.monthlyReset)&&console.log("تم التصفير التلقائي:",x)}catch(c){console.error("خطأ في التصفير التلقائي للتقارير:",c)}},l=async()=>{try{if(!(s!=null&&s.uid))return;const c=new Date;if(c.getDate()!==1)return;const m=`${c.getFullYear()}-${c.getMonth()+1}`,x=`lastMonthlyDbCleanup:${s.uid}`;if(localStorage.getItem(x)===m)return;const I=new Date(c.getFullYear(),c.getMonth(),1,0,0,0,0),w=$=>$ instanceof Date?$:typeof($==null?void 0:$.toDate)=="function"?$.toDate():new Date(String($));let S=[];try{const $=ot(Ee(K,"userTransactions"),De("userId","==",s.uid),De("createdAt","<",I));S=(await ut($)).docs}catch{const $=ot(Ee(K,"userTransactions"),De("userId","==",s.uid));S=(await ut($)).docs.filter(be=>{var Je;return w((Je=be.data())==null?void 0:Je.createdAt)<I})}await Promise.allSettled(S.map($=>vs($.ref)));let F=[];try{const $=ot(Ee(K,"transactions"),De("userId","==",s.uid),De("createdAt","<",I));F=(await ut($)).docs}catch{const $=ot(Ee(K,"transactions"),De("userId","==",s.uid));F=(await ut($)).docs.filter(be=>{var Je;return w((Je=be.data())==null?void 0:Je.createdAt)<I})}await Promise.allSettled(F.map($=>vs($.ref)));try{localStorage.setItem(x,m)}catch{}console.log("✅ تم تنظيف قاعدة البيانات شهريًا (Firebase فقط):",{userTransactionsDeleted:S.length,globalTransactionsDeleted:F.length,monthStart:I})}catch(c){console.error("فشل التنظيف الشهري التلقائي لقاعدة البيانات:",c)}};td(),Zc(),gd(),console.log("🔥 useEffect loadUserData completed")},[s==null?void 0:s.uid]);const lr=async()=>{var t;if(s!=null&&s.uid)try{const a=await Es.getByMerchantId(s.uid);if(a&&a.length>0){const l=a.filter(c=>c.isActive===!0).map(c=>({id:c.id,name:c.label||"محفظة بدون اسم",phone:c.msisdn,isDefault:!1,monthlyWithdrawalLimit:c.monthlyWithdrawalLimit??c.withdrawLimit??2e5,monthlyTransferLimit:c.monthlyTransferLimit??c.transferLimit??2e5,defaultTransferCommission:c.defaultTransferCommission!=null?Number(c.defaultTransferCommission):void 0,defaultWithdrawCommission:c.defaultWithdrawCommission!=null?Number(c.defaultWithdrawCommission):void 0}));if(Ka(l),s!=null&&s.uid){const c=localStorage.getItem(ui());if(!!(Z&&l.find(x=>x.id===Z)))console.log("🔒 Preserving current wallet selection:",Z);else{const f=(c&&l.find(I=>I.id===c)?c:null)||((t=l[0])==null?void 0:t.id);f&&(console.log("🔄 Fixing invalid wallet selection:",f),or(f))}}console.log("🔄 تم تحديث المحافظ من Firebase:",l.length)}}catch(a){console.error("خطأ في تحميل المحافظ من Firebase:",a)}};n.useEffect(()=>{const t=C.pathname;sessionStorage.getItem("previousPath")==="/user/add-wallet"&&t==="/user/dashboard"&&(console.log("🔄 Returning from add wallet page - reloading wallets"),console.log("🔒 Current wallet before add-wallet return reload:",Z),lr(),sessionStorage.removeItem("previousPath")),sessionStorage.setItem("previousPath",t)},[C.pathname,s==null?void 0:s.uid]),n.useEffect(()=>{const t=()=>{console.log("🔄 Window focused - reloading wallets"),console.log("🔒 Current wallet before focus reload:",Z),lr().then(()=>{console.log("🔒 Wallet preserved after focus reload:",Z)})};return window.addEventListener("focus",t),()=>{window.removeEventListener("focus",t)}},[s==null?void 0:s.uid,Z,Be]);const or=(t,a="unknown")=>{console.log(`🎯 setWalletSelection called from ${a} with walletId:`,t),console.log("🔍 Previous selectedWallet:",Z),kn(t);const r=Be.find(l=>l.id===t);r&&(qa(r.phone),console.log("✅ Wallet set successfully:",t,"Phone:",r.phone)),s!=null&&s.uid&&(localStorage.setItem(ui(),t),console.log("💾 Saved wallet to localStorage:",t))};n.useEffect(()=>{const t=()=>{lr()};try{window.addEventListener("wallets:activation-updated",t)}catch{}return()=>{try{window.removeEventListener("wallets:activation-updated",t)}catch{}}},[s==null?void 0:s.uid]);const Od=t=>{if(t==="__add_wallet"){A("/user/add-wallet");return}if(t==="__view_wallets"){Sr(!0);return}Mm.isEnabled(s==null?void 0:s.uid)?(Dn(t),Sn(!0)):or(t,"walletSelectionNoPin")},rn=t=>{console.log("🔄 handleTransactionTypeChange called with type:",t),console.log("🔍 Current selectedWallet before change:",Z),console.log("🔍 Available wallets count:",Be.length),Bi(t),Ta(""),Va(""),Cn(""),In(""),console.log("✅ Transaction type changed to:",t,"- Wallet selection preserved:",Z),setTimeout(()=>{const a=document.getElementById("transaction-section");a&&a.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})},100)};n.useEffect(()=>{const t=a=>{const r=a.target;if(!!r&&(r.tagName==="INPUT"||r.tagName==="TEXTAREA"||r.tagName==="SELECT"||r.isContentEditable)||(a.key==="ArrowLeft"?(a.preventDefault(),rn("withdraw")):a.key==="ArrowRight"&&(a.preventDefault(),rn("transfer"))),a.key==="Enter"){const c=ie==="transfer"?"transferSubmitButton":"withdrawSubmitButton",m=document.getElementById(c);m&&!m.disabled&&(a.preventDefault(),m.click())}};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[ie]);const ql=t=>{vc((r=>({id:r.id,type:r.type==="send"?"transfer":"withdraw",sender_msisdn:r.senderPhone,receiver_msisdn:r.receiverPhone,amount:r.amount,commission:r.commission||0,fee:(r==null?void 0:r.fee)??0,status:r.status==="failed"?"failed":r.status==="completed"?"completed":"pending",createdAt:new Date(r.createdAt).toISOString(),updatedAt:new Date(r.createdAt).toISOString(),shopName:q??(D==null?void 0:D.shopName)??(s==null?void 0:s.displayName)??"المحل",cashierName:(r==null?void 0:r.cashierName)??null,commissionMode:(r==null?void 0:r.commissionMode)??(r.type==="send"||dt?"add":"deduct"),totalCharged:(r==null?void 0:r.totalCharged)??(r.type==="send"?Number(r.amount||0)+Number(r.commission||0)+Number((r==null?void 0:r.fee)||0):dt?Number(r.amount||0)+Number(r.commission||0):Number(r.amount||0)),note:(r==null?void 0:r.note)??(r==null?void 0:r.notes)??void 0}))(t)),Ar(!0)},Ed=async t=>{var r;if(!(s!=null&&s.uid)){i({title:"خطأ في المصادقة",description:"يجب تسجيل الدخول أولاً لحذف المعاملات",variant:"destructive"});return}const a=lt.find(l=>l.id===t);if(!a){i({title:"خطأ في الحذف",description:"لم يتم العثور على المعاملة المطلوب حذفها",variant:"destructive"});return}try{console.log("🗑️ بدء عملية حذف المعاملة:",t),console.log("🔄 حذف المعاملة نهائياً من Firebase...",{transactionId:a.id,userId:s.uid,transactionData:a}),await Ae.removeUserTransaction(s.uid,a.id),console.log("✅ تم حذف المعاملة نهائياً من Firebase userTransactions");try{await pr.saveDeletedTransaction({...a,userId:s.uid,originalTransactionId:a.id,transactionId:a.transactionId||a.id,reference:a.reference||a.transactionReference||((r=a.receipt)==null?void 0:r.reference),deletedAt:new Date().toISOString(),permanent:!0}),console.log("✅ تم حفظ المعاملة في سجل المحذوفات مع تاريخ الحذف")}catch(m){console.warn("⚠️ فشل في حفظ المعاملة في سجل المحذوفات، لكن الحذف من Firebase نجح:",m)}try{await pr.permanentlyDeleteTransaction(a.id,s.uid)}catch(m){console.warn("⚠️ فشل وسم الحذف النهائي أو التنظيف الإضافي:",m)}const l=[...Ji,a],c=lt.filter(m=>m.id!==t);Ha(l),_s(c),qi(!1),console.log("✅ تم تحديث الحالة بعد الحذف من Firebase (بدون نسخ محلية)");try{const m=a.fromWallet;if(m){const{walletDailyLimitsService:x}=await ft(async()=>{const{walletDailyLimitsService:I}=await import("./walletDailyLimitsService-Byppxers.js");return{walletDailyLimitsService:I}},__vite__mapDeps([3,0,1]),import.meta.url),f=await x.getWalletLimits(m);if(f){const I=a.type==="send",w={updatedAt:(await ft(async()=>{const{serverTimestamp:be}=await import("./index-5EflPS7Y.js").then(Je=>Je.bg);return{serverTimestamp:be}},__vite__mapDeps([0,1]),import.meta.url)).serverTimestamp()};I?(w.dailyTransferUsed=Math.max(0,(f.dailyTransferUsed||0)-a.amount),w.monthlyTransferUsed=Math.max(0,(f.monthlyTransferUsed||0)-a.amount)):(w.dailyWithdrawUsed=Math.max(0,(f.dailyWithdrawUsed||0)-a.amount),w.monthlyWithdrawUsed=Math.max(0,(f.monthlyWithdrawUsed||0)-a.amount));const{doc:S,setDoc:F}=await ft(async()=>{const{doc:be,setDoc:Je}=await import("./index-5EflPS7Y.js").then(Xe=>Xe.bg);return{doc:be,setDoc:Je}},__vite__mapDeps([0,1]),import.meta.url),{db:$}=await ft(async()=>{const{db:be}=await import("./index-5EflPS7Y.js").then(Je=>Je.bh);return{db:be}},__vite__mapDeps([0,1]),import.meta.url),z=S($,"walletLimits",m);await F(z,w,{merge:!0})}}}catch(m){console.warn("فشل استرجاع حدود المحفظة بعد الحذف:",m)}try{const{ProfitService:m}=await ft(async()=>{const{ProfitService:S}=await import("./profitService-B_O8unCh.js").then(F=>F.p);return{ProfitService:S}},__vite__mapDeps([4,0,1]),import.meta.url),{ReportsService:x}=await ft(async()=>{const{ReportsService:S}=await import("./profitService-B_O8unCh.js").then(F=>F.a);return{ReportsService:S}},__vite__mapDeps([4,0,1]),import.meta.url),I={txnType:a.type==="send"?"send":"receive",amount:a.amount,commission:a.commission||0,createdAt:a.createdAt,status:"confirmed"},w=m.calculateProfitFromTransaction(I);w>0&&m.addProfit(-w,s.uid);try{x.removeTransactionEffects(a,s.uid)}catch{}}catch(m){console.warn("فشل تحديث الأرباح/التقارير بعد الحذف:",m)}i({title:"تم حذف المعاملة نهائياً",description:"تم حذف المعاملة نهائياً من النظام. يمكنك العثور عليها في قائمة المحذوفات"})}catch(l){console.error("❌ خطأ في حذف المعاملة من Firebase:",l);let c="فشل في حذف المعاملة من الخادم. يرجى المحاولة مرة أخرى";l instanceof Error&&(l.message.includes("network")||l.message.includes("offline")?c="مشكلة في الاتصال بالإنترنت. تحقق من الاتصال وحاول مرة أخرى":l.message.includes("permission")||l.message.includes("unauthorized")?c="ليس لديك صلاحية لحذف هذه المعاملة":l.message.includes("not-found")&&(c="المعاملة غير موجودة أو تم حذفها مسبقاً")),i({title:"خطأ في الحذف",description:c,variant:"destructive"})}},cr=t=>{const a=t.type,r=t.txnType;return a==="withdraw"||a==="withdrawal"||a==="receive"||r==="receive"},dr=t=>{const a=t.type,r=t.txnType;return a==="send"||a==="transfer"||r==="send"},mr=(t,a)=>{const r=new Date().toDateString();let l=lt.filter(w=>new Date(w.createdAt).toDateString()===r&&w.status==="completed");qs&&qs.trim()!==""&&(l=l.filter(w=>w.senderPhone&&w.senderPhone.includes(qs)||w.receiverPhone&&w.receiverPhone.includes(qs)));const c=Zt.filterVisibleTransactions(l,"daily",s==null?void 0:s.uid),m=c.length,x=c.reduce((w,S)=>w+S.amount,0),f=c.filter(cr).reduce((w,S)=>{const F=S.withdrawnAmount!==void 0?S.withdrawnAmount:S.amount;return w+F},0),I=c.filter(dr).reduce((w,S)=>{const F=S.sentAmount!==void 0?S.sentAmount:S.amount;return w+F},0);return{totalTransactions:m,totalAmount:x,totalWithdrawn:f,totalSent:I}},hr=t=>{const a=new Date().getMonth(),r=new Date().getFullYear();let l=lt.filter(w=>{const S=new Date(w.createdAt);return S.getMonth()===a&&S.getFullYear()===r&&w.status==="completed"});qs&&qs.trim()!==""&&(l=l.filter(w=>w.senderPhone&&w.senderPhone.includes(qs)||w.receiverPhone&&w.receiverPhone.includes(qs)));const c=Zt.filterVisibleTransactions(l,"monthly",s==null?void 0:s.uid),m=c.length,x=c.reduce((w,S)=>w+S.amount,0),f=c.filter(cr).reduce((w,S)=>{const F=S.withdrawnAmount!==void 0?S.withdrawnAmount:S.amount;return w+F},0),I=c.filter(dr).reduce((w,S)=>{const F=S.sentAmount!==void 0?S.sentAmount:S.amount;return w+F},0);return{totalTransactions:m,totalAmount:x,totalWithdrawn:f,totalSent:I}},_d=t=>{const a=new Date().getMonth(),r=new Date().getFullYear(),l=lt.filter(x=>{const f=new Date(x.createdAt);return f.getMonth()===a&&f.getFullYear()===r&&x.status==="completed"&&x.fromWallet===t}),c=l.filter(cr).reduce((x,f)=>{const I=f.withdrawnAmount||f.amount;return x+I},0),m=l.filter(dr).reduce((x,f)=>{const I=f.sentAmount||f.amount;return x+I},0);return{totalWithdrawn:c,totalTransferred:m}},Wd=t=>{const a=new Date,r=a.getDate(),l=a.getMonth(),c=a.getFullYear(),m=lt.filter(I=>{const w=new Date(I.createdAt);return w.getDate()===r&&w.getMonth()===l&&w.getFullYear()===c&&I.status==="completed"&&I.fromWallet===t}),x=m.filter(cr).reduce((I,w)=>{const S=w.withdrawnAmount||w.amount;return I+S},0),f=m.filter(dr).reduce((I,w)=>{const S=w.sentAmount||w.amount;return I+S},0);return{totalWithdrawn:x,totalTransferred:f}},Vl=qe.useMemo(()=>hr(),[lt,Z,qs]);Vl.totalWithdrawn,Vl.totalSent;const Js=qe.useMemo(()=>_d(Z),[lt,Z]);n.useEffect(()=>{try{if(!Z||Be.length===0)return;const t=Be.find(z=>z.id===Z);if(!t)return;const a=(Ve==null?void 0:Ve.monthlyWithdrawLimit)??(t==null?void 0:t.monthlyWithdrawalLimit)??2e5,r=(Ve==null?void 0:Ve.monthlyTransferLimit)??(t==null?void 0:t.monthlyTransferLimit)??2e5,l=parseFloat(Lt||"0")||0,c=(Js==null?void 0:Js.totalWithdrawn)??(Ve==null?void 0:Ve.monthlyWithdrawUsed)??0,m=(Js==null?void 0:Js.totalTransferred)??(Ve==null?void 0:Ve.monthlyTransferUsed)??0,x=c+(ie==="withdraw"?l:0),f=m+(ie==="transfer"?l:0),I=.85,w=Math.floor(Math.max(a,1)*I),S=Math.floor(Math.max(r,1)*I),F=(()=>{const z=new Date;return`${z.getFullYear()}-${String(z.getMonth()+1).padStart(2,"0")}`})(),$=`monthlyLimitWarnShown:${Z}:${F}`;if(x>=w){const z=`${$}:withdraw`;if(!(localStorage.getItem(z)==="true")){Ri({type:"withdraw",used:x,limit:a,walletName:t.name}),Dr(!0);try{localStorage.setItem(z,"true")}catch{}return}}if(f>=S){const z=`${$}:transfer`;if(!(localStorage.getItem(z)==="true")){Ri({type:"transfer",used:f,limit:r,walletName:t.name}),Dr(!0);try{localStorage.setItem(z,"true")}catch{}return}}}catch{}},[Z,Be,Ve,Js,ie,Lt]);const Jl=async()=>{Oh(),console.log("🔄 بدء عملية التحويل/السحب"),console.log("📊 البيانات المدخلة:",{senderPhone:$t,receiverPhone:os,amount:Lt,transactionType:ie});const t=()=>{ie==="transfer"?ka(!0):Ga(!0)},a=()=>{ie==="transfer"?ka(!1):Ga(!1)};if(t(),!$t||!Lt){console.log("❌ خطأ: بيانات ناقصة"),i({title:"خطأ في البيانات",description:"يرجى ملء جميع الحقول المطلوبة",variant:"destructive"}),a();return}if(ie==="transfer"&&!os&&!B){console.log("❌ خطأ: رقم المستقبل مفقود"),i({title:"خطأ في البيانات",description:"يرجى إدخال رقم المستقبل",variant:"destructive"}),a();return}if(ie==="transfer"&&!B&&!Eh(os)){i({title:"رقم المستقبل غير صالح",description:"اكتب رقم صحيح مكون من 11 رقم ويبدأ بـ 015 أو 010 أو 012 أو 011",variant:"destructive"}),a();return}const r=parseFloat(Lt);if(console.log("💰 المبلغ المحول:",r),r<=0){console.log("❌ خطأ: مبلغ غير صحيح"),i({title:"خطأ في المبلغ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"}),a();return}if(pt)try{const Se=new Date,It=Se.getFullYear(),Ss=String(Se.getMonth()+1).padStart(2,"0"),qt=String(Se.getDate()).padStart(2,"0"),Hs=`zeroPlanDailyConfirmCount:${(s==null?void 0:s.uid)||"default"}:${It}-${Ss}-${qt}`,ks=localStorage.getItem(Hs);if((ks&&parseInt(ks,10)||0)>=10){i({title:"حد التأكيد اليومي",description:"باقة زيرو تسمح بـ 10 تأكيدات تحويل/سحب يومياً فقط.",variant:"destructive"}),a();return}}catch(Se){console.warn("فشل قراءة عداد تأكيدات باقة زيرو من التخزين المحلي:",Se)}const l=Be.find(Se=>Se.id===Z);if(!l){i({title:"خطأ في المحفظة",description:"يرجى اختيار محفظة صحيحة",variant:"destructive"}),a();return}const c=Js;if(console.log("📈 فحص الحدود الشهرية للمحفظة المختارة"),console.log("📊 الإحصائيات الشهرية للمحفظة:",{walletId:Z,walletName:l.name,currentWithdrawn:c.totalWithdrawn,currentTransferred:c.totalTransferred,withdrawalLimit:l.monthlyWithdrawalLimit,transferLimit:l.monthlyTransferLimit}),ie==="withdraw"){if(console.log("🏧 فحص حد السحب الشهري للمحفظة"),console.log(`💸 المسحوب حالياً من المحفظة: ${c.totalWithdrawn}, المبلغ الجديد: ${r}, الحد الأقصى: ${l.monthlyWithdrawalLimit}`),c.totalWithdrawn+r>l.monthlyWithdrawalLimit){console.log("❌ تجاوز حد السحب الشهري للمحفظة"),i({title:"تجاوز حد السحب الشهري",description:`لا يمكن سحب أكثر من ${l.monthlyWithdrawalLimit} جنيه شهرياً من محفظة ${l.name}`,variant:"destructive"}),a();return}}else if(console.log("💸 فحص حد التحويل الشهري للمحفظة"),console.log(`📤 المحول حالياً من المحفظة: ${c.totalTransferred}, المبلغ الجديد: ${r}, الحد الأقصى: ${l.monthlyTransferLimit}`),c.totalTransferred+r>l.monthlyTransferLimit){console.log("❌ تجاوز حد التحويل الشهري للمحفظة"),i({title:"تجاوز حد التحويل الشهري",description:`لا يمكن تحويل أكثر من ${l.monthlyTransferLimit} جنيه شهرياً من محفظة ${l.name}`,variant:"destructive"}),a();return}const m=(D==null?void 0:D.shopName)||(s==null?void 0:s.displayName)||"محل كاشي لينك",x={id:Date.now().toString(),type:ie==="transfer"?"send":ie==="deposit"?"deposit":"withdraw",senderPhone:$t,receiverPhone:ie==="transfer"?os:$t,amount:r,status:"completed",createdAt:new Date,withdrawnAmount:ie==="withdraw"?r:void 0,sentAmount:ie==="transfer"?r:void 0,depositedAmount:void 0,fromWallet:Z,senderNumber:$t,senderName:$t,shopName:(l==null?void 0:l.name)||"المحفظة الرئيسية",transferredAmount:ie==="transfer"?r:void 0,receiverNumber:ie==="transfer"?os:void 0,withdrawnAmountDetailed:ie==="withdraw"?r:void 0,depositedAmountDetailed:void 0,merchantShopName:m,transactionReference:`TXN-${Date.now()}`,commission:0,notes:ie==="transfer"?void 0:ua&&ua.trim()!==""?ua.trim():void 0};g&&(y!=null&&y.name||y!=null&&y.username)&&(x.cashierName=(y==null?void 0:y.name)||(y==null?void 0:y.username));const f=$a.validateTransaction(r,ie,ht,$e);if(!f.isValid){i({title:"خطأ في العملية",description:f.error,variant:"destructive"}),a();return}f.warning&&i({title:"تحذير",description:f.warning,variant:"destructive"});let I;if(ie==="transfer")if((l==null?void 0:l.defaultTransferCommission)!=null){const Se=Number(l.defaultTransferCommission)||0;I=Math.round(Se*r/1e3*100)/100}else ms&&ms.trim()!==""?I=Math.max(0,parseFloat(ms)):I=0;else if((l==null?void 0:l.defaultWithdrawCommission)!=null){const Se=Number(l.defaultWithdrawCommission)||0;I=Math.round(Se*r/1e3*100)/100}else ds&&ds.trim()!==""?I=Math.max(0,parseFloat(ds)):I=Math.round(r*.01*100)/100;if(x.commission=I,ie!=="transfer"&&!dt&&I>=r){i({title:"خطأ في العمولة",description:"العمولة أكبر من أو تساوي المبلغ المدخل",variant:"destructive"}),a();return}const w=ie==="transfer"||dt?r:Math.round((r-I)*100)/100;x.amount=w,x.withdrawnAmount=ie==="withdraw"?w:void 0,x.sentAmount=ie==="transfer"?w:void 0,x.transferredAmount=ie==="transfer"?w:void 0,x.withdrawnAmountDetailed=ie==="withdraw"?w:void 0;let S;const F=ie==="transfer"&&!!Ps,$=ie==="withdraw"&&!!Ps,z=F||$;let be=null;const Je=Cr($t||"").replace(/\D/g,""),Xe=Cr(os||"").replace(/\D/g,""),St=ie==="transfer"&&(Je.startsWith("010")&&(Xe.startsWith("011")||Xe.startsWith("012")||Xe.startsWith("015"))||Je.startsWith("012")&&Xe.startsWith("010")||Je.startsWith("011")&&Xe.startsWith("010")||Je.startsWith("015")&&Xe.startsWith("010")),kt=St?Math.max(0,parseFloat(Li||"0")):0,ta=Math.round(I*100)/100;if(x.commission=ta,St&&!z&&kt<=0){i({title:"خطأ",description:"أدخل رسوم التحويل لعمليات 010 → 011/012/015 أو 012 → 010 أو 011 → 010 أو 015 → 010",variant:"destructive"}),a();return}if(ie==="transfer"&&!z){const Se=Number($e[Z]||0),It=Number(w)+Number(kt);if(Se<It){i({title:"رصيد المحفظة غير كافٍ",description:`الرصيد الحالي ${Se} لا يكفي لخصم ${It}`,variant:"destructive"}),a();return}}if(z)if(F){const Se=$a.validateTransaction(w,"transfer",ht,$e);Se.isValid?S={success:!0,newCashBalance:ht,newWalletBalances:$e}:S={success:!1,newCashBalance:ht,newWalletBalances:$e,message:Se.error||"رصيد غير كافٍ للتحويل المؤجل",error:"INSUFFICIENT_WALLET_BALANCE"}}else S={success:!0,newCashBalance:ht,newWalletBalances:$e};else ie==="transfer"?S=await $a.processTransfer({amount:w,currentCashBalance:ht,currentWalletBalances:$e,wallets:Be,selectedWalletId:Z,skipRemoteLimitsCheck:!1,nonBlockingUsageUpdate:!0}):S=await $a.processWithdraw({amount:w,currentCashBalance:ht,currentWalletBalances:$e,wallets:Be,selectedWalletId:Z,skipRemoteLimitsCheck:!1,nonBlockingUsageUpdate:!0});if(!S.success){i({title:"فشل في العملية",description:S.error||S.message,variant:"destructive"}),a();return}let Ks=z?ht:S.newCashBalance,Ys=z?$e:S.newWalletBalances;if(!z&&ie==="transfer"&&kt>0){const Se=Number(Ys[Z]||0);Ys={...Ys,[Z]:Math.round((Se-Number(kt))*100)/100}}if(z&&$){const Se=Be.find(qt=>qt.id===Z)??Be.find(qt=>qt.isDefault)??Be[0],It=(Se==null?void 0:Se.id)||Z;if(It!==Z)try{or(It)}catch{}const Ss=Number($e[It]||0);Ys={...$e,[It]:Math.round((Ss+Number(w))*100)/100};try{const qt=`walletEffectsAppliedOnCreation_${(s==null?void 0:s.uid)||"default"}`,Hs=localStorage.getItem(qt),ks=Hs?JSON.parse(Hs):[];x!=null&&x.id&&!ks.includes(x.id)&&(ks.push(x.id),localStorage.setItem(qt,JSON.stringify(ks)))}catch{}}if(z&&F){const Se=Be.find(qt=>qt.id===Z)??Be.find(qt=>qt.isDefault)??Be[0],It=(Se==null?void 0:Se.id)||Z;if(It!==Z)try{or(It)}catch{}const Ss=Number($e[It]||0);Ys={...$e,[It]:Math.round((Ss-Number(w)-Number(kt))*100)/100}}if((F||$)&&Ps&&!ac){const Se={id:`DEBT-${Date.now()}`,debtorName:Ps.debtorName,amount:Ps.amount,reason:Ps.notes||"",customerId:Ps.customerId,mobile:Ps.mobile,status:"pending",createdAt:new Date};be=Se.id;const It=[Se,...Ct];us(It);try{await Ns(It)}catch(Ss){console.error("⚠️ فشل حفظ الدين المؤجل محلياً:",Ss)}i({title:"تم إضافة الدين",description:"أضيف إلى إيصالات الديون حتى يتم السداد",variant:"default"})}if(!z){const Se=Math.max(0,Number(I))+Math.max(0,Number(kt));Se>0&&(Ks=Math.round((Ks+Se)*100)/100,console.log(`💰 تم إضافة عمولة/رسوم ${Se} جنيه لدرج النقدية`))}console.log("⚡ تحديث الواجهة فوراً بدون حجب باستخدام startTransition...");const Xl=[x,...lt];qe.startTransition(()=>{zt(Ks),Qt(Ys),z&&(x.status="pending"),_s(Xl)});try{localStorage.setItem(Fa(),JSON.stringify(Xl))}catch(Se){console.warn("تعذر حفظ المعاملات في التخزين المحلي بعد إنشاء معاملة جديدة:",Se)}if(pt)try{const Se=new Date,It=Se.getFullYear(),Ss=String(Se.getMonth()+1).padStart(2,"0"),qt=String(Se.getDate()).padStart(2,"0"),Hs=`zeroPlanDailyConfirmCount:${(s==null?void 0:s.uid)||"default"}:${It}-${Ss}-${qt}`,ks=localStorage.getItem(Hs),ln=ks&&parseInt(ks,10)||0;localStorage.setItem(Hs,String(ln+1))}catch{}if(setTimeout(()=>{try{localStorage.setItem(js(),Ks.toString()),localStorage.setItem(ps(),JSON.stringify(Ys))}catch{}},0),(async()=>{try{console.log("🔄 بدء حفظ المعاملة في Firebase في الخلفية...");const Se={shopId:P||(D==null?void 0:D.shopId)||(s==null?void 0:s.uid)||"default-shop",lineId:Z||"default-line",merchantUserId:(s==null?void 0:s.uid)||null,provider:"vodafone_cash",txnType:ie==="transfer"?"send":"receive",amount:w,commission:ta,fee:kt,profit:0,senderMsisdn:$t,receiverMsisdn:ie==="transfer"?os:$t,note:ie==="transfer"?void 0:ua&&ua.trim()!==""?ua.trim():void 0,status:z?"pending":"confirmed",linkedDebtId:be||void 0,createdBy:(s==null?void 0:s.uid)||null,walletEffectAppliedOnCreation:!!(z&&$)},It={...Se,status:z?"pending":"completed",commissionMode:ie==="transfer"||dt?"add":"deduct",totalCharged:ie==="transfer"?w+ta+kt:dt?w+I:w,walletEffectAppliedOnCreation:!!(z&&$),createdAt:new Date},{ProfitService:Ss}=await ft(async()=>{const{ProfitService:qd}=await import("./profitService-B_O8unCh.js").then(Vd=>Vd.p);return{ProfitService:qd}},__vite__mapDeps([4,0,1]),import.meta.url),qt=Ss.calculateProfitFromTransaction(It);qt>0&&(Ss.addProfit(qt,s==null?void 0:s.uid),console.log("✅ تم إضافة الربح:",qt,"جنيه"));const Hs=await fn.create(Se);await Promise.all([...s!=null&&s.uid?[Ae.updateUserData(s.uid,{cashBalance:Ks,walletBalances:Ys,lastUpdated:new Date().toISOString()})]:[],...s!=null&&s.uid?[Ae.saveUserTransaction(s.uid,{...It,transactionType:ie,fromWallet:Z,toWallet:ie==="transfer"?F?null:"cash":null,cashierName:g&&((y==null?void 0:y.name)||(y==null?void 0:y.username))||"الحساب الرئيسي",linkedDebtId:be||void 0,transactionId:Hs,description:`${ie==="transfer"?"تحويل":"سحب"} ${w} من ${Z} ${ie==="transfer"?F?"":"إلى الدرج النقدي":""} — عمولة: ${I} (${ie==="transfer"||dt?"مضافة":"مخصومة"})${kt>0?` — رسوم: ${kt}`:""}${z?" — دين مؤجل (قيد المراجعة)":""}`})]:[]]),console.log("✅ تم حفظ جميع البيانات في Firebase بنجاح");const ks=`userData_${s==null?void 0:s.uid}`,ln={cashBalance:Ks,walletBalances:Ys,lastUpdated:new Date().toISOString()};localStorage.setItem(ks,JSON.stringify(ln))}catch(Se){console.error("❌ خطأ في حفظ المعاملة في Firebase (في الخلفية):",Se),i({title:"تحذير",description:"تم تنفيذ العملية محلياً، لكن فشلت المزامنة مع الخادم. ستتم المحاولة مرة أخرى تلقائياً.",variant:"destructive"})}})(),ie==="transfer"){ka(!0);const Se=Number(r)+Number(I)+Math.max(0,Number(kt));_n({type:"transfer",amount:Math.max(0,Math.round(Se*100)/100)}),Ic({receiver:os,amount:r}),pa(!0),setTimeout(()=>{ka(!1)},2e3)}else{Ga(!0);const Se=dt?Number(r):Math.max(0,Math.round((Number(r)-Number(I))*100)/100);_n({type:"withdraw",amount:Math.max(0,Math.round(Se*100)/100)}),pa(!0),setTimeout(()=>{Ga(!1)},2e3)}Ta(""),Va(""),Oi(""),jn(null),wn(""),xa(""),_i(""),Wi(!1)},nn=qe.useMemo(()=>new Intl.DateTimeFormat("ar-EG"),[]),Kl=qe.useMemo(()=>new Intl.DateTimeFormat("ar-EG",{hour:"2-digit",minute:"2-digit"}),[]),Fd=qe.useMemo(()=>{try{return Ct.reduce((t,a)=>{const r=Number(a.paidAmount||0),l=Math.max(0,Number(a.amount||0)-r);return t+l},0)}catch{return 0}},[Ct]),vi=qe.useMemo(()=>$l().filter(a=>zs==="all"?!0:zs==="send"?a.type==="send":zs==="receive"?a.type==="receive":zs==="withdraw"?a.type==="withdraw":zs!=="deleted"),[$l,zs]),Md=()=>{if(On==="daily"){const t=Zt.resetReportsManually("daily",lt,s==null?void 0:s.uid);Ya(!1),i({title:"تم تصفير المعاملات اليومية",description:`تم إخفاء ${t.length} معاملة من تقارير اليوم (الحدود لم تتأثر)`})}else{const t=Zt.resetReportsManually("monthly",lt,s==null?void 0:s.uid);Ya(!1),i({title:"تم تصفير المعاملات الشهرية",description:`تم إخفاء ${t.length} معاملة من تقارير الشهر (الحدود لم تتأثر)`})}},Ld=()=>On==="daily"?"تصفير المعاملات اليومية":"تصفير المعاملات الشهرية",Rd=()=>On==="daily"?"أدخل الرقم السري الرئيسي لتصفير جميع معاملات اليوم":"أدخل الرقم السري الرئيسي لتصفير جميع معاملات الشهر",Bd=t=>{Ol(t),ai(!0)},$d=t=>{zt(t),localStorage.setItem(js(),t.toString()),vl(!1),i({title:"تم تحديث الرصيد النقدي",description:`تم تحديث الرصيد النقدي إلى ${t} جنيه`})},Ud=async t=>{var x;if(!gs){console.warn("لا يوجد معرف محفظة محدد لتعديل الرصيد");return}const a={...$e,[gs]:t};Qt(a);const r=new Date().toISOString(),l={walletBalances:a,lastUpdated:r},c=`userData_${s==null?void 0:s.uid}`;try{localStorage.setItem(c,JSON.stringify(l)),localStorage.setItem(ps(),JSON.stringify(a)),localStorage.setItem(`walletBalances_backup_${r}`,JSON.stringify(a))}catch{}try{s!=null&&s.uid&&await Ae.updateUserData(s.uid,l)}catch(f){console.error("خطأ أثناء حفظ رصيد المحفظة في Firebase:",f)}bl(!1);const m=((x=Be.find(f=>f.id===gs))==null?void 0:x.name)||"المحفظة";i({title:"تم تحديث رصيد المحفظة",description:`تم تحديث رصيد ${m} إلى ${t.toLocaleString()} جنيه`})},zd=async t=>{var a;if(console.log("💰 بدء تحديث رصيد المحفظة"),console.log("📊 معرف المحفظة المحررة:",gs),console.log("💵 المبلغ المضاف/المخصوم:",t),gs){const r=$e[gs]||0;console.log("💰 الرصيد الحالي:",r);const l=r+t;console.log("💰 الرصيد الجديد:",l);const c={...$e,[gs]:l};console.log("📊 الأرصدة المحدثة:",c),Qt(c);const m=new Date().toISOString(),x={walletBalances:c,lastUpdated:m},f=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(f,JSON.stringify(x)),localStorage.setItem(ps(),JSON.stringify(c)),localStorage.setItem(`walletBalances_backup_${m}`,JSON.stringify(c));try{if(s!=null&&s.uid){console.log("🔄 حفظ البيانات في Firebase...");try{await Ae.updateUserData(s.uid,x),console.log("✅ تم حفظ الأرصدة في Firebase بنجاح"),setTimeout(()=>{localStorage.removeItem(f),console.log("🧹 تم حذف النسخة المحلية المؤقتة بعد دقيقة واحدة")},6e4)}catch(F){console.error("❌ فشل في حفظ البيانات في Firebase:",F),ke(!0)}}else console.log("⚠️ المستخدم غير مسجل دخول، حفظ في localStorage"),localStorage.setItem(ps(),JSON.stringify(c));const I=((a=Be.find(F=>F.id===gs))==null?void 0:a.name)||"المحفظة",w=t>0?"إضافة":"خصم",S=Math.abs(t);i({title:`تم ${w} مبلغ ${w==="إضافة"?"إلى":"من"} رصيد المحفظة`,description:`تم ${w} ${S} جنيه ${w==="إضافة"?"إلى":"من"} رصيد ${I}. الرصيد الجديد: ${l.toLocaleString()} جنيه`})}catch(I){if(console.error("❌ فشل في حفظ البيانات في Firebase:",I),localStorage.setItem(ps(),JSON.stringify(c)),s!=null&&s.uid){const w=`userData_${s.uid}`,S={walletBalances:c,lastUpdated:new Date().toISOString()};localStorage.setItem(w,JSON.stringify(S)),ke(!0)}i({title:"تم حفظ البيانات محلياً",description:"تم حفظ التغييرات محلياً وسيتم مزامنتها مع الخادم لاحقاً",variant:"default"})}}else console.log("❌ لا يوجد معرف محفظة للتحرير");setTimeout(()=>{const l=Object.keys(localStorage).filter(c=>c.startsWith("walletBalances_backup_")).sort();l.length>5&&l.slice(0,l.length-5).forEach(m=>{localStorage.removeItem(m),console.log("🗑️ حذف النسخة الاحتياطية القديمة:",m)})},5e3),ai(!1),Ol("")};return console.log("🔥 UserDashboardPage - Render conditions:",{isCheckingActivation:Ue,isUserActive:Dt,showActivationModal:Aa}),!Ue&&!Dt?(console.log("🔥 UserDashboardPage - Showing activation modal"),e.jsx("div",{className:"user-dashboard min-h-screen bg-background flex items-center justify-center",children:e.jsx(ho,{isOpen:!0,onClose:()=>{}})})):Ue?(console.log("🔥 UserDashboardPage - Showing loading screen"),e.jsx(rm,{})):(console.log("🔥 UserDashboardPage - Rendering main dashboard"),e.jsxs("div",{className:"user-dashboard min-h-screen px-2 sm:px-4 py-2 sm:py-4 relative bg-gray-50 bg-[radial-gradient(140%_140%_at_10%_10%,#f3f4f6_0%,#e5e7eb_45%,#d1d5db_100%)]",children:[e.jsx(_h,{userId:s==null?void 0:s.uid}),e.jsxs("div",{className:"max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-3 sm:gap-6 relative z-10",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-2 sm:space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 sm:grid-cols-2 sm:gap-3 fade-in-up",children:[!Qa&&e.jsxs(yt,{className:"monthly-stats-card bg-gradient-to-br from-purple-50 via-purple-25 to-white border border-purple-200/60 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 group relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-purple-500/5 to-purple-600/3 opacity-0 group-hover:opacity-100 transition-opacity duration-300"}),e.jsx("div",{className:"absolute top-0 right-0 w-20 sm:w-32 h-20 sm:h-32 bg-gradient-to-br from-purple-300/15 to-transparent rounded-full -translate-y-8 sm:-translate-y-16 translate-x-8 sm:translate-x-16 group-hover:scale-110 transition-transform duration-300"}),e.jsx(Jt,{className:"monthly-stats-header pb-2 sm:pb-1 lg:pb-1 px-3 sm:px-3 lg:px-2 pt-3 sm:pt-2 lg:pt-1 relative z-10",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(cs,{className:"text-xs font-bold text-purple-800 flex items-center gap-1.5 sm:gap-1",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"w-2.5 sm:w-2 h-2.5 sm:h-2 bg-gradient-to-r from-purple-500 to-purple-600 rounded-full shadow-sm"}),e.jsx("div",{className:"absolute inset-0 w-2.5 sm:w-2 h-2.5 sm:h-2 bg-purple-400 rounded-full opacity-60 animate-pulse"})]}),e.jsx("span",{className:"text-xs",children:"الشهر"})]}),e.jsxs("div",{className:"flex items-center gap-1 sm:gap-1",children:[e.jsx("div",{className:"hidden"}),e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>{Vi("monthly"),Ya(!0)},className:"monthly-stat-action h-7 w-7 sm:h-6 sm:w-6 p-0 bg-gradient-to-r from-purple-100 to-purple-200 text-purple-700 hover:from-purple-200 hover:to-purple-300 hover:text-purple-800 rounded-lg sm:rounded-md transition-all duration-300 hover:scale-105 shadow-sm hover:shadow-md",title:"تصفير معاملات الشهر",children:e.jsx(Vt,{className:"h-3 w-3 sm:h-2.5 sm:w-2.5"})}),e.jsx("div",{className:"monthly-stat-action p-1.5 sm:p-1 bg-gradient-to-r from-purple-100 to-purple-200 rounded-lg sm:rounded-md",children:e.jsx(xr,{className:"h-3 w-3 sm:h-2.5 sm:w-2.5 text-purple-600"})})]})]})}),!Qa&&e.jsxs(wt,{className:"space-y-0.5 sm:space-y-1 lg:space-y-0 pt-0 px-2 sm:px-3 lg:px-2 pb-1.5 sm:pb-2 lg:pb-1 relative z-10",children:[e.jsxs("div",{className:"stat-row stat-row--monthly flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-purple-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"stat-label stat-label--monthly text-xs font-semibold text-purple-700",children:"عدد المعاملات:"}),e.jsx("span",{className:"stat-value stat-value--monthly font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:hr().totalTransactions})]}),e.jsxs("div",{className:"stat-row stat-row--monthly flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-purple-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"stat-label stat-label--monthly text-xs font-semibold text-purple-700",children:"إجمالي المبالغ:"}),e.jsx("span",{className:"stat-value stat-value--monthly font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:hr().totalAmount.toFixed(2)})]}),e.jsxs("div",{className:"stat-row stat-row--monthly flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-purple-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"stat-label stat-label--monthly text-xs font-semibold text-purple-700",children:"المسحوب:"}),e.jsx("span",{className:"stat-value stat-value--monthly font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:hr().totalWithdrawn.toFixed(2)})]}),e.jsxs("div",{className:"stat-row stat-row--monthly flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-purple-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"stat-label stat-label--monthly text-xs font-semibold text-purple-700",children:"المرسل:"}),e.jsx("span",{className:"stat-value stat-value--monthly font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:hr().totalSent.toFixed(2)})]}),e.jsxs("div",{className:"stat-row stat-row--monthly flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-purple-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"stat-label stat-label--monthly text-xs font-semibold text-purple-700",children:"الأرباح:"}),e.jsx(Nh,{userId:s==null?void 0:s.uid,transactions:lt})]})]}),_c&&e.jsx("div",{className:"monthly-overlay absolute inset-0 z-20 bg-yellow-100/60 backdrop-blur-sm rounded-xl border border-yellow-300/70 flex items-center justify-center p-0 pointer-events-auto",children:e.jsxs(h,{size:"sm",variant:"ghost",onClick:async()=>{if(pt){i({title:"غير متاح",description:"تقارير الشهر غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"});return}_r(!0)},className:"px-2.5 py-1 rounded-full bg-gradient-to-r from-yellow-500 to-yellow-600 text-black hover:from-yellow-600 hover:to-yellow-700 shadow-md flex items-center gap-1 text-[11px] font-semibold",title:"عرض تقارير الشهر (يتطلب الرقم السري)",children:[e.jsx("span",{children:"عرض تقارير الشهر"}),e.jsx(Nt,{className:"h-2.5 w-2.5"})]})})]}),e.jsx(rs,{open:Fc,onOpenChange:_r,mode:"verify",title:"الرقم السري لفتح تقارير الشهر",description:"لا يمكن الاطلاع على إحصائيات الشهر إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{if(pt){i({title:"غير متاح",description:"تقارير الشهر غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}),_r(!1),el(!0);return}el(!1),_r(!1)},userId:s==null?void 0:s.uid}),e.jsxs(yt,{className:"daily-stats-card bg-gradient-to-br from-blue-50 via-blue-25 to-white border border-blue-200/60 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 group relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/5 to-blue-600/3 opacity-0 group-hover:opacity-100 transition-opacity duration-300"}),e.jsx("div",{className:"absolute top-0 right-0 w-20 sm:w-32 h-20 sm:h-32 bg-gradient-to-br from-blue-300/15 to-transparent rounded-full -translate-y-8 sm:-translate-y-16 translate-x-8 sm:translate-x-16 group-hover:scale-110 transition-transform duration-300"}),e.jsx(Jt,{className:"daily-stats-header pb-2 sm:pb-3 lg:pb-1 px-3 sm:px-4 lg:px-2 pt-3 sm:pt-4 lg:pt-1 relative z-10",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(cs,{className:"text-sm sm:text-base font-bold text-blue-800 flex items-center gap-1.5 sm:gap-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"w-2.5 sm:w-3 h-2.5 sm:h-3 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full shadow-sm"}),e.jsx("div",{className:"absolute inset-0 w-2.5 sm:w-3 h-2.5 sm:h-3 bg-blue-400 rounded-full opacity-60 animate-pulse"})]}),e.jsx("span",{className:"text-xs sm:text-sm",children:"اليوم"})]}),e.jsxs("div",{className:"flex items-center gap-1 sm:gap-1.5",children:[e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>{Vi("daily"),Ya(!0)},className:"daily-stat-action h-7 w-7 sm:h-8 sm:w-8 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded-lg transition-all duration-300 hover:scale-105 shadow-sm hover:shadow-md",title:"تصفير معاملات اليوم",children:e.jsx(Vt,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"})}),e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>Wc(t=>!t),className:"daily-stat-action h-7 w-7 sm:h-8 sm:w-8 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded-lg transition-all duration-300 hover:scale-105 shadow-sm hover:shadow-md",title:Qa?"توسيع اليوم والشهر":"طي اليوم والشهر",children:Qa?e.jsx(br,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"}):e.jsx(dn,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"})}),e.jsx("div",{className:"p-1.5 sm:p-2 bg-gradient-to-r from-blue-100 to-blue-200 rounded-lg",children:e.jsx(xr,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5 text-blue-600"})})]})]})}),!Qa&&e.jsxs(wt,{className:"space-y-0 pt-0 px-2 pb-1 relative z-10",children:[e.jsxs("div",{className:"stat-row flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-blue-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"stat-label text-xs font-semibold text-blue-700",children:"عدد المعاملات:"}),e.jsx("span",{className:"stat-value font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:mr().totalTransactions})]}),e.jsxs("div",{className:"stat-row flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-blue-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"stat-label text-xs font-semibold text-blue-700",children:"إجمالي المبالغ:"}),e.jsx("span",{className:"stat-value font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:mr().totalAmount.toFixed(2)})]}),e.jsxs("div",{className:"stat-row flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-blue-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"stat-label text-xs font-semibold text-blue-700",children:"المسحوب:"}),e.jsx("span",{className:"stat-value font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:mr().totalWithdrawn.toFixed(2)})]}),e.jsxs("div",{className:"stat-row flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from_gray-100 to-blue-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"stat-label text-xs font-semibold text-blue-700",children:"المرسل:"}),e.jsx("span",{className:"stat-value font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:mr().totalSent.toFixed(2)})]}),e.jsxs("div",{className:"stat-row flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-blue-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"stat-label text-xs font-semibold text-blue-700",children:"الأرباح:"}),e.jsx(Dh,{userId:s==null?void 0:s.uid})]})]}),Mc&&e.jsx("div",{className:"absolute inset-0 z-20 bg-yellow-100/60 backdrop-blur-sm rounded-xl border border-yellow-300/70 flex items-center justify-center p-0 pointer-events-auto",children:e.jsxs(h,{size:"sm",variant:"ghost",onClick:()=>Fn(!0),className:"px-2.5 py-1 rounded-full bg-gradient-to-r from-yellow-300 to-yellow-400 text-black hover:from-yellow-400 hover:to-yellow-500 shadow-md flex items-center gap-1 text-[11px] font-semibold",title:"عرض تقارير اليوم (يتطلب الرقم السري)",children:[e.jsx("span",{children:"عرض تقارير اليوم"}),e.jsx(Nt,{className:"h-2.5 w-2.5"})]})})]}),e.jsx(rs,{open:Lc,onOpenChange:Fn,mode:"verify",title:"الرقم السري لفتح تقارير اليوم",description:"لا يمكن الاطلاع على تقارير اليوم إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{tl(!1),Fn(!1)},userId:s==null?void 0:s.uid})]}),e.jsxs(yt,{className:"balance-bar bg-white border-2 border-gray-200/50 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 group relative overflow-hidden   transform fade-in-up mb-6",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-emerald-500/5 via-blue-500/5 to-emerald-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-200"}),e.jsx("div",{className:"absolute top-0 left-0 w-40 h-40 bg-gradient-to-br from-emerald-300/10 to-transparent rounded-full -translate-y-20 -translate-x-20 group-hover:scale-150 transition-transform duration-200"}),e.jsx("div",{className:"absolute bottom-0 right-0 w-40 h-40 bg-gradient-to-br from-blue-300/10 to-transparent rounded-full translate-y-20 translate-x-20 group-hover:scale-150 transition-transform duration-200"}),e.jsx(wt,{className:"p-3 relative z-10",children:e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"bg-emerald-50 border-2 border-emerald-200/50 p-1 rounded-xl shadow-lg hover:shadow-md transition-all duration-200 group/cash relative overflow-hidden ",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-emerald-500/10 to-transparent opacity-0 group-hover/cash:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex items-center justify-between relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-emerald-100 to-emerald-200 rounded-lg shadow-sm",children:e.jsx(At,{className:"h-1.5 w-1.5 text-emerald-600"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] font-bold text-emerald-800",children:"الفلوس النقدية"}),e.jsxs("span",{className:"text-[10px] font-extrabold text-emerald-700 bg-gradient-to-r from-emerald-100 to-emerald-200 px-1 py-0.5 rounded-lg shadow-sm",children:[ht.toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(h,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-green-100 to-green-200 text-green-700 hover:from-green-200 hover:to-green-300 hover:text-green-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>rr(!0),children:e.jsx(as,{className:"h-2 w-2"})}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-emerald-100 to-emerald-200 text-emerald-700 hover:from-emerald-200 hover:to-emerald-300 hover:text-emerald-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>_l(!0),title:"تفاصيل الفلوس النقدية",children:e.jsx(oo,{className:"h-2 w-2"})}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800 rounded-xl transition-all duration-300  hover:rotate-12 shadow-md hover:shadow-lg",onClick:()=>sn(!0),children:e.jsx(Vt,{className:"h-2 w-2"})})]})]})]}),e.jsxs("div",{className:"bg-blue-50 border-2 border-blue-200/50 p-1 rounded-xl shadow-lg hover:shadow-md transition-all duration-200 group/wallet relative overflow-hidden ",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/10 to-transparent opacity-0 group-hover/wallet:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex items-center justify-between relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-blue-100 to-blue-200 rounded-lg shadow-sm",children:e.jsx(Ls,{className:"h-1.5 w-1.5 text-blue-600"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] font-bold text-blue-800",children:"الأرصدة علي المحافظ"}),e.jsxs("span",{className:"text-[10px] font-extrabold text-blue-700 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-lg shadow-sm",children:[Object.values($e).reduce((t,a)=>t+a,0).toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(h,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-green-100 to-green-200 text-green-700 hover:from-green-200 hover:to-green-300 hover:text-green-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>Zr(!0),title:"إضافة أموال لإجمالي المحفظة",children:e.jsx(as,{className:"h-2 w-2"})}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800 rounded-xl transition-all duration-300  hover:rotate-12 shadow-md hover:shadow-lg",onClick:()=>{en(!0),tn("")},title:"تصفير إجمالي المحفظة",children:e.jsx(Vt,{className:"h-2 w-2"})})]})]})]}),e.jsxs("div",{className:"col-span-2 sm:col-span-1 bg-indigo-50 border-2 border-indigo-200/50 p-1 rounded-xl shadow-lg hover:shadow-md transition-all duration-200 group/selwallet relative overflow-hidden ",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-indigo-500/10 to-transparent opacity-0 group-hover/selwallet:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex items-center justify-between relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-indigo-100 to-indigo-200 rounded-lg shadow-sm",children:e.jsx(Ls,{className:"h-1.5 w-1.5 text-indigo-600"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] font-bold text-indigo-800",children:"رصيد المحفظه"}),e.jsxs("span",{className:"text-[10px] font-extrabold text-indigo-700 bg-gradient-to-r from-indigo-100 to-indigo-200 px-1 py-0.5 rounded-lg shadow-sm",children:[(Z&&$e[Z]||0).toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(h,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-green-100 to-green-200 text-green-700 hover:from-green-200 hover:to-green-300 hover:text-green-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>{if(!Z){i({title:"اختر محفظة",description:"يرجى اختيار محفظة من اختيار المحافظ بالأعلى أولاً",variant:"destructive"});return}Bd(Z)},title:"إضافة/خصم إلى رصيد المحفظة المختارة",children:e.jsx(as,{className:"h-2 w-2"})}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800 rounded-xl transition-all duration-300  hover:rotate-12 shadow-md hover:shadow-lg",onClick:()=>{if(!Z){i({title:"اختر محفظة",description:"يرجى اختيار محفظة لتصفير رصيدها فقط",variant:"destructive"});return}Lr(!0)},title:"تصفير رصيد المحفظة المختارة",children:e.jsx(Vt,{className:"h-2 w-2"})})]})]})]})]})})]}),e.jsxs(yt,{className:"bg-gradient-to-br from-gray-50 via-white to-slate-50 border border-gray-200/60 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 group relative overflow-hidden fade-in-up",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-gray-500/5 to-slate-600/3 opacity-0 group-hover:opacity-100 transition-opacity duration-300"}),e.jsxs(Jt,{className:`pb-2 px-4 pt-4 relative z-10 ${M?"sticky top-0 z-20 bg-white/90 backdrop-blur supports-[backdrop-filter]:bg-white/60":""}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(cs,{className:"text-sm font-bold flex items-center gap-2 text-gray-800",children:[!M&&e.jsx("div",{className:"p-1.5 sm:p-2 bg-gradient-to-r from-gray-100 to-slate-200 rounded-lg",children:e.jsx(xr,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5 text-gray-600"})}),e.jsx("span",{className:"bg-gradient-to-r from-gray-600 to-slate-600 bg-clip-text text-transparent",children:"المعاملات الأخيرة"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[!M&&e.jsxs("div",{className:"flex items-center gap-0.5 bg-gray-50 rounded px-1 py-0.5 border border-gray-200 hover:border-blue-300 transition-all duration-200 group relative overflow-hidden max-w-[140px] md:max-w-[220px]",children:[e.jsx(bm,{className:"h-2 w-2 text-gray-400 group-hover:text-blue-600 transition-colors"}),e.jsx(U,{placeholder:"بحث...",value:Ki,onChange:t=>Dc(t.target.value),className:"h-3 text-[8px] border-0 bg-transparent focus:ring-0 focus:outline-none text-gray-700 placeholder:text-gray-400"})]}),!M&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-green-600 mb-1",children:"شحن"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-green-50 text-green-600 hover:bg-green-100 border border-green-200 ring-3 ring-green-300 transition-all duration-200 hover:scale-105 active:bg-green-600 active:text-white active:border-green-600",onClick:()=>{i({title:"قيد التطوير",description:"هذه الميزة غير متاحة حالياً."})},title:"شحن الرصيد",children:e.jsx(Nr,{className:"h-5 w-5 text-green-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"حاسبة"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>Wn(!0),title:"آلة حاسبة",children:e.jsx(Io,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"كروت"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>{pt?i({title:"غير متاح",description:"كروت الائتمان غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):kr(!0)},title:"كروت الائتمان",children:e.jsx(Nr,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-blue-600 mb-1",children:"تقاريرك"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-blue-50 text-blue-600 hover:bg-blue-100 border border-blue-200 ring-3 ring-blue-300 transition-all duration-200 hover:scale-105 active:bg-blue-600 active:text-white active:border-blue-600",onClick:()=>Il(!0),title:"تقاريرك",children:e.jsx($m,{className:"h-5 w-5 text-blue-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-blue-600 mb-1",children:"الوردية"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-blue-50 text-blue-600 hover:bg-blue-100 border border-blue-200 ring-3 ring-blue-300 transition-all duration-200 hover:scale-105 active:bg-blue-600 active:text-white active:border-blue-600",onClick:fd,title:g&&(y!=null&&y.name||y!=null&&y.username)?`بروفيل الوردية: ${(y==null?void 0:y.name)||(y==null?void 0:y.username)}`:"وردية الكاشير",children:e.jsx(Ci,{className:"h-5 w-5 text-blue-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"المبيعات"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>{pt?i({title:"غير متاح",description:"بيانات المبيعات غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ja(!0)},title:"بيانات المبيعات",children:e.jsx(io,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600",children:"الديون"}),Ct.filter(t=>t.status==="pending").length>0&&e.jsx("span",{className:"h-4 w-4 rounded-full bg-red-600 text-white text-[10px] flex items-center justify-center ring-2 ring-white",children:Ct.filter(t=>t.status==="pending").length})]}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>{Kn()},title:"الديون",children:e.jsx(nm,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-amber-700 mb-1",children:"الصيانة"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-amber-50 text-amber-700 hover:bg-amber-100 border border-amber-200 ring-3 ring-amber-300 transition-all duration-200 hover:scale-105 active:bg-amber-600 active:text-white active:border-amber-600",onClick:()=>{pt?i({title:"غير متاح",description:"الصيانة غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Or(!0)},title:"الصيانة",children:e.jsx(wo,{className:"h-5 w-5 text-amber-700"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-yellow-500 mb-1",children:"المكنة"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-violet-50 text-violet-700 hover:bg-violet-100 border border-violet-200 ring-3 ring-violet-300 transition-all duration-200 hover:scale-105 active:bg-violet-700 active:text-white active:border-violet-700",onClick:()=>{Ws?Er(!0):i({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"})},title:"يومية المكنة",children:e.jsx(Po,{className:"h-5 w-5 text-yellow-500"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-orange-600 mb-1",children:"مصروفات"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-orange-50 text-orange-600 hover:bg-orange-100 border border-orange-200 ring-3 ring-orange-300 transition-all duration-200 hover:scale-105 active:bg-orange-600 active:text-white active:border-orange-600",onClick:()=>{pt?i({title:"غير متاح",description:"مصروفات المحل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):ns.hasMasterPin()?Pt(!0):_t(!0)},title:"مصروفات المحل",children:e.jsx(hn,{className:"h-5 w-5 text-orange-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-rose-600 mb-1",children:"النواقص"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-rose-50 text-rose-600 hover:bg-rose-100 border border-rose-200 ring-3 ring-rose-300 transition-all duration-200 hover:scale-105 active:bg-rose-600 active:text-white active:border-rose-600",onClick:()=>{pt?i({title:"غير متاح",description:"النواقص غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):d(!0)},title:"النواقص",children:e.jsx(so,{className:"h-5 w-5 text-rose-600"})})]})]})]})]}),!M&&e.jsx("div",{className:"mt-2 w-full",children:e.jsxs("div",{className:"filters-bar flex items-center justify-center gap-3 bg-gray-50 rounded-md p-3 border border-gray-200",children:[e.jsx(h,{variant:"ghost",size:"sm",className:`btn-filter-send h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${zs==="send"?"bg-green-600 text-white border-green-600":"text-green-700 border-green-300 hover:bg-green-50"}`,onClick:()=>Tn("send"),title:"تصفية التحويل",children:"التحويل"}),e.jsx(h,{variant:"ghost",size:"sm",className:`btn-filter-withdraw h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${zs==="withdraw"?"bg-red-600 text-white border-red-600":"text-red-700 border-red-300 hover:bg-red-50"}`,onClick:()=>Tn("withdraw"),title:"تصفية السحب",children:"السحب"}),e.jsx(h,{variant:"ghost",size:"sm",className:`btn-filter-all h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${zs==="all"?"bg-green-600 text-white border-green-600":"text-green-700 border-green-300 hover:bg-green-50"}`,onClick:()=>Tn("all"),title:"عرض الكل",children:"الكل"}),e.jsxs("div",{className:"relative ml-1",children:[e.jsxs(h,{variant:"ghost",size:"sm",className:"h-8 px-3 text-[12px] rounded-full border bg-red-50 text-red-700 border-red-300 hover:bg-red-100",onClick:()=>ar(!0),title:"تصفير المعاملات الأخيرة",children:[e.jsx(Vt,{className:"h-3.5 w-3.5 mr-1"}),"تصفير"]}),Id>0&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 h-2 w-2 rounded-full bg-red-500 ring-2 ring-white"})]})]})})]}),!1,e.jsxs(wt,{className:"space-y-2 pt-0 px-4 pb-4 relative z-10",children:[vi.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(xr,{className:"h-12 w-12 mx-auto mb-2 text-gray-300"}),e.jsx("p",{className:"text-sm",children:"لا توجد معاملات حتى الآن"})]}):M?e.jsx("div",{className:"overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400 transition-colors max-h-[310px]",children:e.jsx("div",{className:"space-y-2 pr-2",children:vi.map(t=>e.jsxs("div",{className:"receipts-row flex items-center justify-between p-3 rounded-lg border cursor-pointer transition-all duration-200",onClick:()=>ql(t),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[t.status==="completed"&&e.jsx(ma,{className:`h-4 w-4 ${t.type==="withdraw"?"text-red-500":"text-green-500"}`}),t.status==="pending"&&e.jsx(Qs,{className:"h-4 w-4 text-yellow-500"}),t.status==="failed"&&e.jsx(xn,{className:"h-4 w-4 text-red-500"})]}),e.jsxs("div",{children:[(()=>{const a=(t==null?void 0:t.type)==="report"||((t==null?void 0:t.title)||"").includes("إيصال تسليم وردية"),r=((t==null?void 0:t.title)||"").includes("إيصال إضافة نقدية");return e.jsx("p",{className:`font-medium text-sm ${a||r?"text-gray-800":t.type==="send"?"text-green-700":"text-red-700"}`,children:a?"إيصال تسليم وردية":r?`إيصال إضافة نقدية - ${ys(t.amount)} جنيه`:(t.type==="send"?"تحويل":"سحب")+` - ${ys(t.amount)} جنيه`})})(),e.jsxs("p",{className:"text-[10px] text-gray-700",children:["تمت بواسطة: ",(t==null?void 0:t.cashierName)??"الحساب الرئيسي"]}),(()=>{const a=(t==null?void 0:t.type)==="report"||((t==null?void 0:t.title)||"").includes("إيصال تسليم وردية"),r=((t==null?void 0:t.title)||"").includes("إيصال إضافة نقدية");return e.jsx("p",{className:`text-xs ${a||r?"text-gray-500":t.type==="send"?"text-green-600":"text-red-500"}`,children:a?`تم التسليم إلى: ${t.receiverPhone}`:r?t.notes?`ملاحظة: ${t.notes}`:"تمت إضافة نقدية للدرج":`من ${t.senderPhone}${t.type==="send"?` إلى ${t.receiverPhone}`:""}`})})(),e.jsxs("p",{className:"text-xs text-gray-400",children:[nn.format(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt))," - ",Kl.format(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt))]})]})]}),e.jsx(Ot,{variant:t.status==="completed"?"default":t.status==="pending"?"secondary":"destructive",className:`text-xs ${t.status==="completed"?t.type==="withdraw"?"bg-red-100 text-red-700 border-red-300":t.type==="send"?"bg-green-100 text-green-700 border-green-300":"":""}`,children:t.status==="completed"?"مكتمل":t.status==="pending"?"قيد المعالجة":"فشل"})]},t.id))})}):e.jsx("div",{className:"overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400 transition-colors max-h-[calc(100dvh-300px)]",children:e.jsx("div",{className:"space-y-2 pr-2",children:vi.map(t=>e.jsxs("div",{className:"receipts-row flex items-center justify-between p-3 rounded-lg border cursor-pointer transition-all duration-200",onClick:()=>ql(t),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[t.status==="completed"&&e.jsx(ma,{className:`h-4 w-4 ${t.type==="withdraw"?"text-red-500":"text-green-500"}`}),t.status==="pending"&&e.jsx(Qs,{className:"h-4 w-4 text-yellow-500"}),t.status==="failed"&&e.jsx(xn,{className:"h-4 w-4 text-red-500"})]}),e.jsxs("div",{children:[(()=>{const a=(t==null?void 0:t.type)==="report"||((t==null?void 0:t.title)||"").includes("إيصال تسليم وردية"),r=((t==null?void 0:t.title)||"").includes("إيصال إضافة نقدية");return e.jsx("p",{className:`font-medium text-sm ${a||r?"text-gray-800":t.type==="send"?"text-green-700":"text-red-700"}`,children:a?"إيصال تسليم وردية":r?`إيصال إضافة نقدية - ${ys(t.amount)} جنيه`:(t.type==="send"?"تحويل":"سحب")+` - ${ys(t.amount)} جنيه`})})(),e.jsxs("p",{className:"text-[10px] text-gray-700",children:["تمت بواسطة: ",(t==null?void 0:t.cashierName)??"الحساب الرئيسي"]}),(()=>{const a=(t==null?void 0:t.type)==="report"||((t==null?void 0:t.title)||"").includes("إيصال تسليم وردية"),r=((t==null?void 0:t.title)||"").includes("إيصال إضافة نقدية");return e.jsx("p",{className:`text-xs ${a||r?"text-gray-500":t.type==="send"?"text-green-600":"text-red-500"}`,children:a?`تم التسليم إلى: ${t.receiverPhone}`:r?t.notes?`ملاحظة: ${t.notes}`:"تمت إضافة نقدية للدرج":`من ${t.senderPhone}${t.type==="send"?` إلى ${t.receiverPhone}`:""}`})})(),e.jsxs("p",{className:"text-xs text-gray-400",children:[nn.format(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt))," - ",Kl.format(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt))]})]})]}),e.jsx(Ot,{variant:t.status==="completed"?"default":t.status==="pending"?"secondary":"destructive",className:`text-xs ${t.status==="completed"?t.type==="withdraw"?"bg-red-100 text-red-700 border-red-300":t.type==="send"?"bg-green-100 text-green-700 border-green-300":"":""}`,children:t.status==="completed"?"مكتمل":t.status==="pending"?"قيد المعالجة":"فشل"})]},t.id))})}),M&&e.jsxs("div",{className:"mt-2 flex justify-end",children:[e.jsxs(h,{variant:"ghost",size:"sm",className:"h-7 px-2 text-[11px] rounded-full border bg-red-50 text-red-700 border-red-300 hover:bg-red-100",onClick:()=>ar(!0),title:"تصفير المعاملات الأخيرة",children:[e.jsx(Vt,{className:"h-3 w-3 mr-1"}),"تصفير"]}),(s==null?void 0:s.uid)&&localStorage.getItem(`recentTransactionsResetAt:${s.uid}`)&&e.jsx("span",{className:"inline-block h-1.5 w-1.5 rounded-full bg-red-500 ml-1 align-middle"})]})]})]})]}),e.jsx(jm,{isOpen:fc,onClose:()=>Ar(!1),transaction:yc,onPrint:()=>window.print(),onDelete:jc,onComplete:Sc}),e.jsxs("div",{className:"space-y-1 fade-in-right w-full lg:w-[92%] xl:w-[95%] mx-auto",children:[e.jsxs(yt,{id:"transaction-section",className:"bg-gradient-to-br from-white via-blue-50/30 to-indigo-50/50 border border-blue-200/40 rounded-lg shadow-lg hover:shadow-lg transition-all duration-200 group relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/5 via-indigo-500/3 to-purple-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-200"}),e.jsx("div",{className:"absolute top-0 right-0 w-32 h-32 sm:w-28 sm:h-28 lg:w-20 lg:h-20 bg-gradient-to-bl from-blue-400/10 to-transparent rounded-full  "}),e.jsx("div",{className:"absolute bottom-0 left-0 w-24 h-24 bg-gradient-to-tr from-indigo-400/10 to-transparent rounded-full  ",style:{animationDelay:"1s"}}),e.jsx(Jt,{className:"sticky top-0 z-20 bg-white/80 backdrop-blur supports-[backdrop-filter]:bg-white/60 pb-0.5 px-3 pt-1 lg:pt-0.5 lg:pb-0.5 lg:px-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(cs,{className:"text-sm font-bold flex items-center gap-2 text-gray-800",children:[e.jsxs("div",{className:"relative",children:[e.jsx(ma,{className:"h-1 w-1 text-emerald-500 "}),e.jsx("div",{className:"absolute inset-0 h-1 w-1 bg-emerald-400 rounded-full opacity-20 "})]}),e.jsx("span",{className:"bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent",children:"إجراء معاملة جديدة"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[pe&&e.jsx("div",{className:"hidden md:flex items-center gap-1 bg-gradient-to-r from-emerald-50 to-green-50 hover:from-emerald-100 hover:to-green-100 border border-emerald-200 text-emerald-800 text-sm transition-all duration-300 hover:scale-105 h-9 px-3 rounded-xl shadow-sm",children:e.jsxs("span",{className:"text-sm font-semibold whitespace-nowrap",children:["تجربة: ",Ce," ",Ce>=3&&Ce<=10?"ساعات":Ce===2?"ساعتين":"ساعة"]})}),e.jsxs("div",{className:"top-icons-bar hidden md:flex items-center gap-2 bg-gradient-to-r from-gray-50 to-slate-50 hover:from-gray-100 hover:to-slate-100 border border-gray-200 transition-all duration-300 hover:scale-105 h-9 px-3 rounded-xl shadow-sm",children:[e.jsx(th,{}),e.jsx(h,{variant:"ghost",size:"icon",className:"h-8 w-8",title:"إدارة الفروع",onClick:()=>{i({title:"قيد التطوير",description:"الميزة غير متاحة حالياً"})},children:e.jsx(Ao,{className:"h-5 w-5"})}),e.jsx(wm,{})]})]}),Pd&&e.jsxs(h,{variant:"outline",size:"sm",className:"hidden flex items-center gap-1.5 sm:gap-2 bg-gradient-to-r from-cyan-50 to-blue-50 hover:from-cyan-100 hover:to-blue-100 border-cyan-200 text-cyan-800 text-xs sm:text-sm transition-all duration-300 hover:scale-105 hover:shadow-lg h-10 sm:h-12 px-4 sm:px-5 rounded-xl min-w-[44px] touch-manipulation",onClick:Rl,title:"مزامنة البيانات المحفوظة محلياً مع الخادم",children:[e.jsx(Lm,{className:"h-3.5 w-3.5 sm:h-4 sm:w-4 animate-spin"}),e.jsx("span",{className:"text-xs sm:text-sm font-semibold whitespace-nowrap",children:"مزامنة"})]})]})}),e.jsx(de,{open:ee,onOpenChange:fe,children:e.jsxs(me,{className:"sm:max-w-lg",children:[e.jsxs(he,{children:[e.jsx(ue,{children:"إدارة الفروع"}),e.jsx(ss,{children:"أضف فروع جديدة وأدِر الدخول لكل فرع"}),e.jsx("div",{className:"flex items-center justify-end gap-2 mt-2",children:e.jsx(h,{variant:"outline",size:"sm",onClick:()=>{try{const t=s!=null&&s.uid?`selectedShopId_${s.uid}`:"selectedShopId";localStorage.removeItem(t);try{window.dispatchEvent(new Event("selectedShopIdChanged"))}catch{}i({title:"تم الخروج من الفرع"}),A(`/branch/${String(b.shopId)}/dashboard`)}catch{}},children:"الخروج من الفرع"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx(H,{children:"اسم المدير"}),e.jsx(U,{value:ye,onChange:t=>We(t.target.value),placeholder:"اكتب اسم المدير"})]}),e.jsxs("div",{children:[e.jsx(H,{children:"اسم الفرع"}),e.jsx(U,{value:we,onChange:t=>Te(t.target.value),placeholder:"اكتب اسم الفرع"})]}),e.jsxs("div",{children:[e.jsx(H,{children:"اسم المستخدم للدخول"}),e.jsx(U,{value:Me,onChange:t=>et(t.target.value),placeholder:"مثال: branch1"})]}),e.jsxs("div",{children:[e.jsx(H,{children:"كلمة السر"}),e.jsx(U,{type:"password",value:G,onChange:t=>ne(t.target.value),placeholder:"••••••"})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(h,{variant:"outline",onClick:()=>{We(""),Te(""),et(""),ne("")},children:"مسح"}),e.jsx(h,{className:"bg-indigo-600 hover:bg-indigo-700",disabled:Qe,onClick:async()=>{if(!(s!=null&&s.uid))return;const t=ye.trim(),a=we.trim(),r=Me.trim(),l=G.trim();if(!t||!a||!r||!l){i({title:"يرجى ملء جميع الحقول"});return}try{Q(!0);let c="";try{c=(await Is(Ee(K,"shops"),{name:a,ownerId:s.uid,createdAt:Ge(),updatedAt:Ge(),isActive:!0})).id}catch{c=(await Is(Ee(K,"users",s.uid,"shops"),{name:a,ownerId:s.uid,createdAt:Ge(),updatedAt:Ge(),isActive:!0})).id}const m=x=>{try{return btoa(unescape(encodeURIComponent(x)))}catch{return btoa(x)}};try{await Is(Ee(K,"branches"),{ownerId:s.uid,shopId:c,branchName:a,managerName:t,loginUsername:r,passwordEncoded:m(l),createdAt:Ge()})}catch{await Is(Ee(K,"users",s.uid,"branches"),{ownerId:s.uid,shopId:c,branchName:a,managerName:t,loginUsername:r,passwordEncoded:m(l),createdAt:Ge()})}try{const x=ot(Ee(K,"branches"),De("ownerId","==",s.uid));let I=(await ut(x)).docs.map(w=>({id:w.id,...w.data()}));if(I.length===0){const w=ot(Ee(K,"users",s.uid,"branches"));I=(await ut(w)).docs.map(F=>({id:F.id,...F.data()}))}te(I)}catch{try{const x=ot(Ee(K,"users",s.uid,"branches")),I=(await ut(x)).docs.map(w=>({id:w.id,...w.data()}));te(I)}catch{}}We(""),Te(""),et(""),ne(""),i({title:"تم إضافة الفرع بنجاح"})}catch{i({title:"تعذّر إضافة الفرع"})}finally{Q(!1)}},children:"إضافة فرع"})]}),e.jsxs("div",{className:"border-t pt-3",children:[e.jsx("h4",{className:"text-sm font-semibold mb-2",children:"الفروع الحالية"}),Qe?e.jsx("div",{className:"text-sm text-gray-500",children:"جارٍ التحميل..."}):se.length===0?e.jsx("div",{className:"text-sm text-gray-500",children:"لا يوجد فروع بعد"}):e.jsx("div",{className:"space-y-2",children:se.map(t=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded-lg bg-white",children:[e.jsxs("div",{className:"text-sm",children:[e.jsx("div",{className:"font-medium",children:t.branchName}),e.jsxs("div",{className:"text-gray-600",children:["مدير: ",t.managerName]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(h,{size:"sm",className:"bg-blue-600 hover:bg-blue-700",onClick:()=>{Re(t),Ie(String(t.loginUsername||"")),ct(""),Ze(!0)},children:"دخول الفرع"}),e.jsx(h,{size:"sm",variant:"destructive",onClick:async()=>{if(confirm("هل أنت متأكد من حذف الفرع؟ سيتم حذف بيانات الفرع المرتبطة."))try{try{await vs(ze(K,"branches",t.id))}catch{}try{await vs(ze(K,"users",(s==null?void 0:s.uid)||"","branches",t.id))}catch{}if(t.shopId){try{await vs(ze(K,"shops",String(t.shopId)))}catch{}try{await vs(ze(K,"users",(s==null?void 0:s.uid)||"","shops",String(t.shopId)))}catch{}}te(a=>a.filter(r=>r.id!==t.id)),i({title:"تم حذف الفرع"})}catch{i({title:"تعذّر حذف الفرع"})}},children:"حذف الفرع"})]})]},t.id))})]})]})]})}),e.jsx(de,{open:Ne,onOpenChange:Ze,children:e.jsxs(me,{className:"sm:max-w-md",children:[e.jsxs(he,{children:[e.jsx(ue,{children:"دخول الفرع"}),e.jsx(ss,{children:"أدخل بيانات الدخول للفرع المحدد"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx(H,{children:"اسم المستخدم"}),e.jsx(U,{value:nt,onChange:t=>Ie(t.target.value),placeholder:"اسم المستخدم"})]}),e.jsxs("div",{children:[e.jsx(H,{children:"كلمة السر"}),e.jsx(U,{type:"password",value:Le,onChange:t=>ct(t.target.value),placeholder:"••••••"})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(h,{variant:"outline",onClick:()=>{Ie(""),ct("")},children:"مسح"}),e.jsx(h,{className:"bg-blue-600 hover:bg-blue-700",disabled:tt,onClick:async()=>{const t=es;if(!t){Ze(!1);return}const a=String(t.loginUsername||"");let r="";try{const m=String(t.passwordEncoded||"");r=m?decodeURIComponent(escape(atob(m))):""}catch{try{r=t.passwordEncoded?atob(String(t.passwordEncoded)):""}catch{r=""}}const l=nt.trim(),c=Le.trim();if(!l||!c){i({title:"يرجى إدخال اسم المستخدم وكلمة السر"});return}if(l!==a||c!==r){i({title:"بيانات الدخول غير صحيحة",variant:"destructive"});return}try{xe(!0);const m=s!=null&&s.uid?`selectedShopId_${s.uid}`:"selectedShopId";localStorage.setItem(m,String(t.shopId)),i({title:"تم الدخول إلى الفرع",description:String(t.branchName||"")}),Ze(!1),fe(!1),A("/user/dashboard")}catch{}xe(!1)},children:"دخول"})]})]})]})}),e.jsxs(wt,{ref:u,className:"space-y-1 px-2 pb-2 relative z-10 transition-transform duration-200 ease-out will-change-transform",style:{transform:o?`translateY(${o}px)`:void 0},onFocusCapture:t=>{const a=t.target;if(!((a==null?void 0:a.id)==="transferExtraFeeInput")){p(0);return}const l=document.getElementById("transferSubmitButton");if(l){const c=l.getBoundingClientRect(),m=window.innerHeight;if(c.bottom>m){const x=c.bottom-m,f=Math.min(x,220);p(-f)}else p(0)}else p(0)},onBlurCapture:t=>{t.currentTarget.contains(t.relatedTarget)||p(0)},children:[e.jsxs("div",{className:"transaction-type-tabs grid grid-cols-2 gap-0.5 p-0.5 bg-gradient-to-r from-gray-50 to-slate-50 rounded-xl border border-gray-200/50 fade-in-up w-full lg:w-[92%] xl:w-[95%] mx-auto ",children:[e.jsxs(h,{variant:ie==="transfer"?"default":"ghost",onClick:()=>rn("transfer"),className:`text-xs font-semibold transition-all duration-300 hover:scale-105 h-7 rounded-lg px-2 ${ie==="transfer"?"bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg hover:shadow-md hover:from-blue-600 hover:to-indigo-700":"text-gray-600 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 hover:text-blue-700 hover:border-blue-200"}`,children:[e.jsx(xr,{className:"h-1 w-1 mr-1"}),"تحويل"]}),e.jsxs(h,{variant:ie==="withdraw"?"default":"ghost",onClick:()=>rn("withdraw"),className:`text-xs font-semibold transition-all duration-300 hover:scale-105 h-7 rounded-lg px-2 ${ie==="withdraw"?"bg-gradient-to-r from-emerald-500 to-green-600 text-white shadow-lg hover:shadow-md hover:from-emerald-600 hover:to-green-700":"text-gray-600 hover:bg-gradient-to-r hover:from-emerald-50 hover:to-green-50 hover:text-emerald-700 hover:border-emerald-200"}`,children:[e.jsx(pn,{className:"h-1 w-1 mr-1"}),"سحب"]})]}),e.jsxs("div",{className:"fade-in-up",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("label",{className:"text-sm font-semibold text-gray-700 block flex items-center gap-2",children:[e.jsx(Ls,{className:"h-1 w-1 text-blue-600"}),"اختيار المحفظة"]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsxs(h,{variant:"ghost",size:"sm",className:"h-6 rounded-md px-2 text-[10px] bg-emerald-50 text-emerald-700 hover:bg-emerald-100 border border-emerald-200",onClick:()=>A("/user/add-wallet"),title:"إضافة محفظة",children:[e.jsx(as,{className:"h-3 w-3 mr-1"}),"إضافة محفظة"]}),e.jsxs(h,{variant:"ghost",size:"sm",className:"h-6 rounded-md px-2 text-[10px] bg-indigo-50 text-indigo-700 hover:bg-indigo-100 border border-indigo-200",onClick:()=>{Sr(!0)},title:"المحافظ",children:[e.jsx(Ls,{className:"h-3 w-3 mr-1"}),"المحافظ"]})]})]}),Be.length>0?e.jsxs(ra,{value:Z,onValueChange:Od,children:[e.jsx(na,{"data-testid":"wallet-select",className:"selected-number-card w-full h-12 text-sm bg-gradient-to-r from-white to-gray-50 border-2 border-gray-200 hover:border-blue-400 focus:border-blue-500 rounded-xl transition-all duration-300 hover:shadow-md focus:shadow-lg",children:e.jsx(ia,{placeholder:"اختر محفظة للمعاملة",className:"text-gray-600"})}),e.jsxs(la,{className:"rounded-xl border-2 border-gray-200 shadow-md z-[9999]",children:[e.jsx("div",{"data-fixed-header":"true",className:"sticky top-0 z-10 bg-white p-2 border-b border-gray-200",children:e.jsx(U,{value:Ui,onChange:t=>xc(t.target.value),placeholder:"ابحث برقم المحفظة",className:"h-6 text-xs"})}),e.jsx("div",{className:"pr-1",children:zi.length===0?e.jsx("div",{className:"text-xs text-gray-500 p-2",children:"لا توجد نتائج مطابقة"}):zi.map(t=>e.jsx(Os,{value:t.id,className:"rounded-lg hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 transition-all duration-200",children:e.jsxs("div",{className:"flex items-center gap-1 py-1 w-full justify-between",children:[e.jsx("div",{className:"p-1 bg-gradient-to-r from-blue-100 to-indigo-100 rounded-lg",children:e.jsx(Ls,{className:"h-1 w-1 text-blue-600"})}),e.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"text-sm font-medium text-gray-800",children:t.name}),e.jsxs("span",{className:"text-sm font-semibold text-red-600",children:["(",t.phone,")"]})]}),t.isDefault&&e.jsx(Ot,{variant:"secondary",className:"text-[10px] bg-gradient-to-r from-emerald-100 to-green-100 text-emerald-700 border-emerald-200",children:"افتراضي"})]}),e.jsx("div",{className:"ml-auto flex flex-col items-end gap-1"})]})},t.id))})]})]}):e.jsx("div",{className:"rounded-xl border-2 border-dashed border-gray-200 bg-gray-50 px-3 py-3 text-xs text-gray-600",children:"لا توجد محافظ حتى الآن. اضغط “إضافة محفظة” لإضافة أول محفظة."})]}),e.jsx(de,{open:rc,onOpenChange:Fi,children:e.jsxs(me,{className:"sm:max-w-3xl w-[95vw] sm:w-auto max-h-[80vh] overflow-y-auto",children:[e.jsx(he,{children:e.jsx(ue,{children:"عرض المحافظ"})}),e.jsx("div",{className:"mt-2",children:e.jsx(Wm,{showAddButton:!1,showUsageBars:!1,showLimitCards:!1,showEditButton:!0})})]})}),e.jsx(rs,{open:nc,onOpenChange:Sr,mode:"verify",title:"الرقم السري لفتح المحافظ",description:"أدخل الرقم السري الرئيسي لعرض وإدارة المحافظ",onSuccess:()=>{Sr(!1),Fi(!0)},userId:s==null?void 0:s.uid}),e.jsx(rs,{open:ic,onOpenChange:t=>{Sn(t),t||Dn(null)},mode:"verify",title:"تأكيد تغيير المحفظة",description:"أدخل الرقم السري الرئيسي لتغيير المحفظة المختارة",onSuccess:()=>{Mi&&(or(Mi,"walletSelectionPin"),Dn(null)),Sn(!1)},userId:s==null?void 0:s.uid}),e.jsx(de,{open:oc,onOpenChange:Dr,children:e.jsxs(me,{className:"sm:max-w-md",children:[e.jsx(he,{children:e.jsxs(ue,{className:"flex items-center gap-2 text-red-700",children:[e.jsx(so,{className:"h-5 w-5 text-red-600"}),"تحذير حد شهري للمحفظة"]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"p-3 rounded-md border bg-red-50 border-red-200",children:[e.jsxs("p",{className:"text-sm text-red-800",children:["المحفظة: ",e.jsx("span",{className:"font-semibold",children:(ws==null?void 0:ws.walletName)||""})]}),e.jsxs("p",{className:"text-sm text-red-800",children:["الاستخدام الشهري (",(ws==null?void 0:ws.type)==="withdraw"?"سحب":"تحويل","):",e.jsxs("span",{className:"font-mono",children:[" ",Number((ws==null?void 0:ws.used)||0).toLocaleString("en-US")," "]})," جنيه"]}),e.jsxs("p",{className:"text-sm text-red-800",children:["الحد الشهري: ",e.jsx("span",{className:"font-mono",children:Number((ws==null?void 0:ws.limit)||0).toLocaleString("en-US")})," جنيه"]}),e.jsx("p",{className:"text-sm font-semibold text-red-900 mt-1",children:"تم الوصول إلى 85% من الحد الشهري — يرجى الحذر قبل الاستمرار."})]}),e.jsx("div",{className:"flex justify-end gap-2",children:e.jsx(h,{variant:"outline",onClick:()=>Dr(!1),children:"حسناً"})})]})]})}),Z&&Be.length>0&&(()=>{const t=Be.find(Xe=>Xe.id===Z),a=Js,r=Wd(Z),l=(Ve==null?void 0:Ve.monthlyWithdrawLimit)??(t==null?void 0:t.monthlyWithdrawalLimit)??2e5,c=(Ve==null?void 0:Ve.monthlyTransferLimit)??(t==null?void 0:t.monthlyTransferLimit)??2e5,m=a.totalWithdrawn??(Ve==null?void 0:Ve.monthlyWithdrawUsed)??0,x=a.totalTransferred??(Ve==null?void 0:Ve.monthlyTransferUsed)??0,f=(Ve==null?void 0:Ve.dailyWithdrawLimit)??1e5,I=(Ve==null?void 0:Ve.dailyTransferLimit)??6e4,w=r.totalWithdrawn??(Ve==null?void 0:Ve.dailyWithdrawUsed)??0,S=r.totalTransferred??(Ve==null?void 0:Ve.dailyTransferUsed)??0,F=parseFloat(Lt||"0")||0,$=m+(ie==="withdraw"?F:0),z=x+(ie==="transfer"?F:0),be=w+(ie==="withdraw"?F:0),Je=S+(ie==="transfer"?F:0);return t?e.jsxs("div",{className:"fade-in-up mb-2 space-y-2",children:[e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-1 rounded-md border border-gray-200 shadow-sm hover:shadow-md transition-all duration-300",children:[e.jsxs("div",{className:"text-[10px] text-gray-600 font-medium mb-1 text-center",children:["الحدود الشهرية: ",t.name]}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-red-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-red-400 to-red-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min($/Math.max(l,1)*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-blue-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-400 to-blue-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(z/Math.max(c,1)*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-[10px] text-red-600 font-medium",children:["متبقي سحب: ",Math.max(l-$,0).toLocaleString("en-US")," جنيه"]}),e.jsxs("div",{className:"text-[10px] text-blue-600 font-medium",children:["متبقي تحويل: ",Math.max(c-z,0).toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-1 rounded-md border border-gray-200 shadow-sm hover:shadow-md transition-all duration-300",children:[e.jsxs("div",{className:"text-[10px] text-gray-600 font-medium mb-1 text-center",children:["الحدود اليومية: ",t.name]}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-orange-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-orange-400 to-orange-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(be/Math.max(f,1)*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-green-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-green-400 to-green-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(Je/Math.max(I,1)*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-[10px] text-orange-600 font-medium",children:["متبقي سحب يومي: ",Math.max(f-be,0).toLocaleString("en-US")," جنيه"]}),e.jsxs("div",{className:"text-[10px] text-green-600 font-medium",children:["متبقي تحويل يومي: ",Math.max(I-Je,0).toLocaleString("en-US")," جنيه"]})]})]})]}):null})(),ie==="transfer"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المرسل"}),e.jsxs("div",{className:"relative",children:[e.jsx(Gs,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(U,{value:$t,onChange:t=>qa(t.target.value),onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("receiverPhoneInput");if(a)a.focus();else{const r=document.getElementById("amountInput");r==null||r.focus()}}},placeholder:"01030302038",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]})]}),!B&&e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المستقبل"}),e.jsxs("div",{className:"relative",children:[e.jsx(Gs,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(U,{id:"receiverPhoneInput",value:os,onChange:t=>{Ta(t.target.value),En&&ka(!1)},onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("amountInput");a==null||a.focus()}},inputMode:"numeric",maxLength:11,placeholder:"أدخل رقم المستقبل",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المستقبل"}),e.jsxs("div",{className:"relative",children:[e.jsx(Gs,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(U,{value:Z&&((Yl=Be.find(t=>t.id===Z))==null?void 0:Yl.phone)||"",readOnly:!0,placeholder:"اختر محفظة أولاً",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base bg-gray-50 transition-all duration-300"})]})]}),ie==="transfer"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"المبلغ (جنيه)"}),e.jsxs("div",{className:"relative flex items-center gap-2",children:[e.jsx(At,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(U,{id:"amountInput",value:Lt,onChange:t=>{Va(t.target.value),En&&ka(!1)},onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("transferCommissionInput");if(a)a.focus();else{const r=document.getElementById("quickDebtButton");r==null||r.focus()}}},placeholder:"أدخل المبلغ",type:"number",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),Ps?e.jsxs("div",{className:"mt-2 text-xs text-green-700 bg-green-50 border border-green-200 rounded px-2 py-1 flex items-center gap-2",children:[e.jsxs("span",{children:["تم إدخال تفاصيل الأجل لـ ",Ps.debtorName," بمبلغ ",Ps.amount," جنيه"]}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"h-6 px-2",onClick:()=>jn(null),children:"إلغاء"})]}):null]}),(()=>{if(B)return null;const t=Gt();return t&&t.defaultTransferCommission!=null?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة التحويل (تلقائية)"}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["سيتم تطبيق عمولة التحويل الافتراضية لكل ألف: ",t==null?void 0:t.defaultTransferCommission," جنيه لكل ألف"]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(h,{id:"quickDebtButton",type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const r=Gt(),l=(r==null?void 0:r.defaultTransferCommission)!=null?Number(r.defaultTransferCommission):0,c=parseFloat(Lt||"0")||0,m=Math.round((l||0)*c/1e3*100)/100,x=c+m;xa((x||0).toString()),pt?i({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):Pa(!0)},children:"أجل"}),e.jsx(h,{type:"button",variant:"outline",size:"icon",className:"hidden",title:dt?"العمولة تُضاف":"العمولة تُخصم",children:dt?e.jsx(as,{className:"h-4 w-4 text-green-600"}):e.jsx(Na,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"hidden",children:dt?"العمولة تُضاف":"العمولة تُخصم"})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة التحويل على العملية (جنيه)"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(At,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-orange-500"}),e.jsx(U,{id:"transferCommissionInput",value:ms,onChange:r=>In(r.target.value),placeholder:"أدخل عمولة التحويل",type:"number",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),e.jsx(h,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const r=Gt(),l=parseFloat(Lt||"0")||0;let c=0;if((r==null?void 0:r.defaultTransferCommission)!=null){const x=Number(r.defaultTransferCommission)||0;c=Math.round(x*l/1e3*100)/100}else{const x=ms&&ms.trim()!==""?parseFloat(ms):0;c=Math.max(0,x)}const m=l+c;xa((m||0).toString()),pt?i({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):Pa(!0)},children:"أجل"}),e.jsx(h,{type:"button",variant:"outline",size:"icon",className:"hidden",title:dt?"العمولة تُضاف":"العمولة تُخصم",children:dt?e.jsx(as,{className:"h-4 w-4 text-green-600"}):e.jsx(Na,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"hidden",children:dt?"العمولة تُضاف":"العمولة تُخصم"})]}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"يمكنك إدخال عمولة العملية الإجمالية (اختياري)"})]})})(),(()=>{const t=Cr($t||"").replace(/\D/g,""),a=Cr(os||"").replace(/\D/g,"");return ie==="transfer"&&(t.startsWith("010")&&(a.startsWith("011")||a.startsWith("012")||a.startsWith("015"))||t.startsWith("012")&&a.startsWith("010")||t.startsWith("011")&&a.startsWith("010")||t.startsWith("015")&&a.startsWith("010"))?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رسوم التحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(At,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-orange-500"}),e.jsx(U,{id:"transferExtraFeeInput",value:Li,onChange:l=>lc(l.target.value),placeholder:"أدخل رسوم التحويل",type:"number",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),e.jsx("div",{className:"hidden",children:"تُخصم من المحفظة وتضاف للدرج — لعمليات 010 → 011/012/015 أو 012 → 010 أو 011 → 010 أو 015 → 010"})]}):null})(),e.jsx("div",{className:"sticky bottom-0 z-10 pt-2 bg-white/80 backdrop-blur supports-[backdrop-filter]:bg-white/60",children:e.jsx(h,{id:"transferSubmitButton",onClick:Jl,className:"btn-transfer-confirm w-full font-medium h-11 lg:h-12 text-sm lg:text-base btn-bounce hover-glow transition-all duration-300 text-white",children:En?"تم التحويل بنجاح":"تأكيد التحويل"})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"مبلغ السحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(pn,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-green-500"}),e.jsx(U,{id:"amountInput",value:Lt,onChange:t=>{Va(t.target.value),Qi&&Ga(!1)},onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("manualWithdrawCommissionInput");if(a)a.focus();else{const r=document.getElementById("withdrawSubmitButton");r==null||r.focus()}}},placeholder:"أدخل مبلغ السحب",type:"number",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]})]}),(()=>{const t=Gt();return t&&t.defaultWithdrawCommission!=null?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة السحب (تلقائية)"}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["سيتم تطبيق عمولة السحب الافتراضية لكل ألف: ",t==null?void 0:t.defaultWithdrawCommission," جنيه لكل ألف"]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(h,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const r=Gt(),l=parseFloat(Lt||"0")||0,c=(r==null?void 0:r.defaultWithdrawCommission)!=null&&Number(r.defaultWithdrawCommission)||0,m=Math.round(c*l/1e3*100)/100,x=dt?l+m:l;xa((x||0).toString()),pt?i({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):Pa(!0)},children:"أجل"}),e.jsx(h,{type:"button",variant:"outline",size:"icon",className:"h-8 w-8",onClick:()=>An(r=>!r),title:dt?"العمولة تُضاف إلى الدين":"العمولة تُخصم من الدين",children:dt?e.jsx(as,{className:"h-4 w-4"}):e.jsx(Na,{className:"h-4 w-4"})}),e.jsx("span",{className:"text-xs text-gray-600",children:dt?"العمولة تُضاف":"العمولة تُخصم"})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة السحب على العملية (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(At,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-orange-500"}),e.jsx(U,{id:"manualWithdrawCommissionInput",value:ds,onChange:r=>Cn(r.target.value),onKeyDown:r=>{if(r.key==="Enter"){const l=document.getElementById("withdrawSubmitButton");l==null||l.focus()}},placeholder:"أدخل العمولة المطلوبة",type:"number",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"أدخل العمولة الإجمالية لإتمام عملية السحب"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(h,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const r=Gt(),l=parseFloat(Lt||"0")||0;let c=0;if((r==null?void 0:r.defaultWithdrawCommission)!=null){const x=Number(r.defaultWithdrawCommission)||0;c=Math.round(x*l/1e3*100)/100}else{const x=ds&&ds.trim()!==""?parseFloat(ds):Math.round(l*.01*100)/100;c=Math.max(0,x)}const m=dt?l+c:l;xa((m||0).toString()),pt?i({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):Pa(!0)},children:"أجل"}),e.jsx(h,{type:"button",variant:"outline",size:"icon",title:dt?"العمولة تُضاف":"العمولة تُخصم",onClick:()=>An(r=>!r),children:dt?e.jsx(as,{className:"h-4 w-4 text-green-600"}):e.jsx(Na,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"text-xs text-gray-600",children:dt?"العمولة تُضاف":"العمولة تُخصم"})]})]})})(),(D==null?void 0:D.showWithdrawNote)&&e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"ملاحظة السحب (اختياري)"}),e.jsxs("div",{className:"relative",children:[e.jsx(im,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(U,{id:"withdrawNoteInput",value:ua,onChange:t=>Oi(t.target.value),onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("withdrawSubmitButton");a==null||a.focus()}},placeholder:"أدخل ملاحظة للسحب (اختياري)",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]})]}),e.jsx("div",{className:"sticky bottom-0 z-10 pt-2 bg-white/80 backdrop-blur supports-[backdrop-filter]:bg-white/60",children:e.jsx(h,{id:"withdrawSubmitButton",onClick:Jl,className:"w-full font-medium h-11 lg:h-12 text-sm lg:text-base btn-bounce hover-glow transition-all duration-300 bg-green-600 hover:bg-green-700 text-white",children:Qi?"تم السحب بنجاح":"تأكيد السحب"})})]}),e.jsx(de,{open:vn,onOpenChange:Pa,children:e.jsxs(me,{children:[e.jsxs(he,{children:[e.jsx(ue,{children:"تحويل مؤجل"}),e.jsx(ss,{children:"أدخل بيانات صاحب الدين والمبلغ والملاحظات ثم اضغط حفظ"})]}),e.jsxs("div",{className:"space-y-3",children:[Vs&&Vs.length>0?e.jsxs("div",{children:[e.jsx(H,{children:"اختيار عميل"}),e.jsxs(ra,{value:Nn,onValueChange:t=>{sc(t);const a=Vs.find(r=>r.id===t);a&&wn(a.name)},children:[e.jsx(na,{className:"w-full",children:e.jsx(ia,{placeholder:"اختر عميل"})}),e.jsx(la,{children:Vs.map(t=>e.jsxs(Os,{value:t.id,children:[t.name,t.mobile?` — ${t.mobile}`:""]},t.id))})]})]}):e.jsx("div",{className:"text-xs text-gray-500",children:"لا يوجد عملاء مُسجلين حالياً. يمكنك إضافة عميل من نافذة الديون."}),e.jsxs("div",{children:[e.jsx(H,{htmlFor:"quickDebtName",children:"اسم صاحب الدين"}),e.jsx(U,{id:"quickDebtName",value:bn,onChange:t=>wn(t.target.value),placeholder:"اكتب الاسم"})]}),e.jsxs("div",{children:[e.jsx(H,{htmlFor:"quickDebtAmount",children:"المبلغ (محسوب تلقائياً)"}),e.jsx(U,{id:"quickDebtAmount",type:"number",value:tc,readOnly:!0,placeholder:"المبلغ + عمولة التحويل"})]}),e.jsxs("div",{children:[e.jsx(H,{htmlFor:"quickDebtNotes",children:"ملاحظات"}),e.jsx(U,{id:"quickDebtNotes",value:Ei,onChange:t=>_i(t.target.value),placeholder:"اكتب ملاحظات (اختياري)"})]})]}),e.jsx(rt,{children:e.jsx(h,{type:"button",variant:"default",className:"bg-green-600 text-white hover:bg-green-700",onClick:()=>{const t=Gt(),a=parseFloat((Lt||"").toString())||0;let r=0;if(ie==="transfer")if((t==null?void 0:t.defaultTransferCommission)!=null){const m=Number(t.defaultTransferCommission)||0;r=Math.round(m*a/1e3*100)/100}else{const m=ms&&ms.trim()!==""?parseFloat(ms):0;r=Math.max(0,m)}else if((t==null?void 0:t.defaultWithdrawCommission)!=null){const m=Number(t.defaultWithdrawCommission)||0;r=Math.round(m*a/1e3*100)/100}else{const m=ds&&ds.trim()!==""?parseFloat(ds):Math.round(a*.01*100)/100;r=Math.max(0,m)}let l=0;if(ie==="withdraw"?l=dt?a:Math.max(0,Math.round((a-r)*100)/100):l=Math.max(0,Math.round((a+r)*100)/100),!bn||isNaN(l)||l<=0){i({title:"خطأ في بيانات الأجل",description:"يرجى إدخال الاسم والمبلغ بشكل صحيح",variant:"destructive"});return}const c=Vs.find(m=>m.id===Nn);jn({debtorName:bn,amount:l,notes:Ei,customerId:Nn||void 0,mobile:c==null?void 0:c.mobile}),Wi(!1),Pa(!1),i({title:"تم حفظ بيانات الأجل",description:"سيتم إضافة الدين عند تأكيد العملية",variant:"default"})},children:"حفظ"})})]})})]})]}),e.jsx(yt,{className:"bg-gradient-to-br from-red-50 to-red-100 border-red-200 fade-in-up card-float",children:e.jsxs(wt,{className:"p-3 text-center",children:[e.jsx("div",{className:"text-red-600 font-medium text-[10px] mb-1",children:"⚠️ تحذير من التحويل"}),e.jsx("div",{className:"text-[10px] text-red-700",children:"لا يمكن إلغاء أي عملية بعد تأكيدها للمحافظة على الأمان"})]})})]})]}),e.jsx(Km,{isOpen:mc,onClose:()=>hc(!1),initialEditingWallet:uc,onWalletUpdate:async()=>{try{await lr()}catch(t){console.error("Error reloading wallets after update:",t)}}}),e.jsx(Ym,{isOpen:gc,onClose:()=>qi(!1),transaction:pc,onDelete:Ed}),e.jsx(rs,{open:wc,onOpenChange:Ya,onSuccess:Md,title:Ld(),description:Rd(),mode:"verify"}),e.jsx(co,{open:ad,onOpenChange:vl,onSuccess:$d,title:"تعديل الرصيد النقدي في الدرج",description:"أدخل الرقم السري والمبلغ الجديد لتعديل الرصيد النقدي في الدرج",currentBalance:ht,balanceLabel:"الرصيد النقدي",userId:s==null?void 0:s.uid}),e.jsx(co,{open:rd,onOpenChange:bl,onSuccess:Ud,title:"تعديل رصيد المحفظة",description:"أدخل الرقم السري والمبلغ الجديد لتعديل رصيد المحفظة",currentBalance:gs&&$e[gs]||0,balanceLabel:`رصيد ${((Hl=Be.find(t=>t.id===gs))==null?void 0:Hl.name)||"المحفظة"}`,userId:s==null?void 0:s.uid}),e.jsx(Zm,{open:nd,onOpenChange:ai,onSuccess:zd,title:"إضافة أو خصم مبلغ من رصيد المحفظة",description:"أدخل الرقم السري والمبلغ المراد إضافته أو خصمه من رصيد المحفظة",currentBalance:gs&&$e[gs]||0,balanceLabel:`رصيد ${((Gl=Be.find(t=>t.id===gs))==null?void 0:Gl.name)||"المحفظة"}`,userId:s==null?void 0:s.uid}),e.jsx(Hm,{open:yd,onOpenChange:vd,userId:s==null?void 0:s.uid}),e.jsx(Gm,{open:bd,onOpenChange:wd,userId:s==null?void 0:s.uid}),e.jsx(Qm,{open:Nd,onOpenChange:jd}),e.jsx(de,{open:od,onOpenChange:Rr,children:e.jsxs(me,{className:"sm:max-w-md",children:[e.jsx(he,{children:e.jsx(ue,{className:"text-right",children:"تعديل الدرج النقدية"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(H,{htmlFor:"amount",className:"text-right block",children:"المبلغ"}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx(U,{id:"amount",type:"number",placeholder:"أدخل المبلغ",value:ni,onChange:t=>Br(t.target.value),className:"text-right flex-1",dir:"rtl",min:"0"}),e.jsxs("div",{className:"flex gap-1",children:[e.jsxs(h,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white px-3 py-2",onClick:async()=>{if(!await an(xi)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}const t=parseFloat(ni);if(isNaN(t)||t<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const a=ht+t;zt(a);const r={cashBalance:a,lastUpdated:new Date().toISOString()},l=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(l,JSON.stringify(r)),s!=null&&s.uid?Ae.updateUserData(s.uid,r).then(()=>{console.log("✅ تم حفظ رصيد الدرج النقدي في Firebase بنجاح"),localStorage.removeItem(l),ke(!1)}).catch(c=>{console.error("❌ خطأ في حفظ الرصيد في Firebase:",c),ke(!0)}):ke(!0),i({title:"تم بنجاح",description:`تم إضافة ${t} جنيه إلى الدرج النقدية وحفظه في السحابة`}),Rr(!1),Br(""),Jr("")},children:[e.jsx(as,{className:"h-1 w-1 mr-1"}),"إضافة"]}),e.jsxs(h,{type:"button",size:"sm",className:"bg-red-600 hover:bg-red-700 text-white px-3 py-2",onClick:async()=>{if(!await an(xi)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}const t=parseFloat(ni);if(isNaN(t)||t<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const a=ht-t;zt(a);const r={cashBalance:a,lastUpdated:new Date().toISOString()},l=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(l,JSON.stringify(r)),s!=null&&s.uid?Ae.updateUserData(s.uid,r).then(()=>{console.log("✅ تم حفظ رصيد الدرج النقدي في Firebase بنجاح"),localStorage.removeItem(l),ke(!1)}).catch(c=>{console.error("❌ خطأ في حفظ الرصيد في Firebase:",c),ke(!0)}):ke(!0),i({title:"تم بنجاح",description:`تم خصم ${t} جنيه من الدرج النقدية وحفظه في السحابة`}),Rr(!1),Br(""),Jr("")},children:[e.jsx(Na,{className:"h-1 w-1 mr-1"}),"خصم"]})]})]}),e.jsxs("p",{className:"text-[10px] text-gray-500 text-right",children:["الرصيد الحالي: ",ht.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(H,{htmlFor:"pin",className:"text-right block",children:"الرقم السري"}),e.jsx(U,{id:"pin",type:"password",placeholder:"أدخل الرقم السري",value:xi,onChange:t=>Jr(t.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsx(rt,{className:"flex gap-2",children:e.jsx(h,{variant:"outline",onClick:()=>{Rr(!1),Br(""),Jr("")},children:"إلغاء"})})]})}),e.jsx(de,{open:Ad,onOpenChange:en,children:e.jsxs(me,{className:"sm:max-w-md",children:[e.jsx(he,{children:e.jsx(ue,{className:"text-right text-red-600",children:"تصفير إجمالي المحفظة"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-red-50 rounded-lg border border-red-200",children:[e.jsx("p",{className:"text-red-800 font-medium mb-2",children:"تحذير!"}),e.jsx("p",{className:"text-red-700 text-sm",children:"سيتم تصفير جميع أرصدة المحافظ إلى صفر. هذا الإجراء لا يمكن التراجع عنه."}),e.jsxs("p",{className:"text-red-600 text-sm mt-2",children:["الرصيد الحالي: ",Object.values($e).reduce((t,a)=>t+a,0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(H,{htmlFor:"resetWalletTotalPin",className:"text-right block",children:"الرقم السري الرئيسي"}),e.jsx(U,{id:"resetWalletTotalPin",type:"password",placeholder:"أدخل الرقم السري الرئيسي",value:Ul,onChange:t=>tn(t.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsxs(rt,{className:"flex gap-2",children:[e.jsx(h,{variant:"outline",onClick:()=>{en(!1),tn("")},children:"إلغاء"}),e.jsx(h,{variant:"destructive",onClick:async()=>{if(!await ns.verifyMasterPin(Ul,s==null?void 0:s.uid)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}try{const a={};Object.keys($e).forEach(m=>{a[m]=0}),Qt(a),localStorage.setItem(ps(),JSON.stringify(a)),en(!1),tn("");const r=new Date().toISOString(),l={walletBalances:a,lastUpdated:r},c=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(c,JSON.stringify(l)),s!=null&&s.uid?Ae.updateUserData(s.uid,l).then(()=>{localStorage.removeItem(c),ke(!1)}).catch(m=>{console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",m),ke(!0),i({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):ke(!0),setTimeout(()=>{Qt({...a})},100)}catch(a){console.error("خطأ في تصفير أرصدة المحافظ:",a),i({title:"خطأ",description:"حدث خطأ أثناء تصفير المحافظ",variant:"destructive"})}},children:"تصفير المحفظة"})]})]})}),e.jsx(de,{open:id,onOpenChange:Lr,children:e.jsxs(me,{className:"sm:max-w-md",children:[e.jsx(he,{children:e.jsx(ue,{className:"text-right text-red-600",children:"تصفير رصيد المحفظة المختارة"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-red-50 rounded-lg border border-red-200",children:[e.jsx("p",{className:"text-red-800 font-medium mb-2",children:"تحذير!"}),e.jsx("p",{className:"text-red-700 text-sm",children:"سيتم تصفير رصيد المحفظة المحددة إلى صفر. هذا الإجراء لا يمكن التراجع عنه."}),e.jsxs("p",{className:"text-red-600 text-sm mt-2",children:["المحفظة: ",((Ql=Be.find(t=>t.id===Z))==null?void 0:Ql.name)||Z]}),e.jsxs("p",{className:"text-red-600 text-sm",children:["الرصيد الحالي: ",(Z&&$e[Z]?$e[Z]:0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(H,{htmlFor:"resetSelectedWalletPin",className:"text-right block",children:"الرقم السري الرئيسي"}),e.jsx(U,{id:"resetSelectedWalletPin",type:"password",autoComplete:"off",placeholder:"أدخل الرقم السري الرئيسي",value:wl,onChange:t=>ri(t.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsxs(rt,{className:"flex gap-2",children:[e.jsx(h,{variant:"outline",onClick:()=>{Lr(!1),ri("")},children:"إلغاء"}),e.jsx(h,{variant:"destructive",onClick:async()=>{var a;if(!Z){i({title:"اختر محفظة",description:"يرجى اختيار محفظة أولاً",variant:"destructive"});return}if(!await ns.verifyMasterPin(wl,s==null?void 0:s.uid)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}try{const r={...$e};r[Z]=0,Qt(r),localStorage.setItem(ps(),JSON.stringify(r)),Lr(!1),ri("");const l=new Date().toISOString(),c={walletBalances:r,lastUpdated:l},m=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(m,JSON.stringify(c)),s!=null&&s.uid?Ae.updateUserData(s.uid,c).then(()=>{localStorage.removeItem(m),ke(!1)}).catch(x=>{console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",x),ke(!0),i({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):ke(!0),i({title:"تم التصفير بنجاح",description:`تم تصفير رصيد المحفظة ${((a=Be.find(x=>x.id===Z))==null?void 0:a.name)||Z}`})}catch(r){console.error("خطأ في تصفير رصيد المحفظة المختارة:",r),i({title:"خطأ",description:"حدث خطأ أثناء تصفير رصيد المحفظة المختارة",variant:"destructive"})}},children:"تصفير المحفظة"})]})]})}),e.jsx(de,{open:Cd,onOpenChange:Zr,children:e.jsxs(me,{className:"sm:max-w-md",children:[e.jsx(he,{children:e.jsxs(ue,{className:"text-right text-green-600 flex items-center gap-2 justify-end",children:[e.jsx(as,{className:"h-4 w-4"}),"إضافة أموال لإجمالي المحفظة"]})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-green-50 rounded-lg border border-green-200",children:[e.jsx("p",{className:"text-green-800 font-medium mb-2",children:"إضافة أموال"}),e.jsx("p",{className:"text-green-700 text-sm",children:"سيتم إضافة المبلغ المحدد إلى إجمالي المحفظة بشكل متناسب على جميع المحافظ."}),e.jsxs("p",{className:"text-green-600 text-sm mt-2",children:["الرصيد الحالي: ",Object.values($e).reduce((t,a)=>t+a,0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"addWalletTotalAmount",className:"text-right block",children:"المبلغ المراد إضافته"}),e.jsx(U,{id:"addWalletTotalAmount",type:"number",placeholder:"أدخل المبلغ",value:Wl,onChange:t=>pi(t.target.value),className:"text-right",dir:"rtl"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"addWalletTotalPin",className:"text-right block",children:"الرقم السري للتأكيد"}),e.jsx(U,{id:"addWalletTotalPin",type:"password",autoComplete:"off",placeholder:"أدخل الرقم السري",value:Fl,onChange:t=>gi(t.target.value),className:"text-right",dir:"rtl"})]})]})]}),e.jsxs(rt,{className:"flex gap-2",children:[e.jsx(h,{variant:"outline",onClick:()=>{Zr(!1),pi(""),gi("")},children:"إلغاء"}),e.jsx(h,{variant:"default",className:"bg-green-600 hover:bg-green-700",disabled:Ml,onClick:async()=>{const t=parseFloat(Wl);if(!t||t<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}if(!await kd(Fl)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}Ll(!0);try{const a=Object.values($e).reduce((r,l)=>r+l,0);if(a===0){const r=Object.keys($e),l=t/r.length,c={};r.forEach(m=>{c[m]=l}),Qt(c),localStorage.setItem(ps(),JSON.stringify(c)),s!=null&&s.uid?await Ae.updateUserData(s.uid,{walletBalances:c,lastUpdated:new Date().toISOString()}):ke(!0)}else{const r={};Object.entries($e).forEach(([l,c])=>{const m=c/a,x=t*m;r[l]=c+x}),Qt(r),localStorage.setItem(ps(),JSON.stringify(r)),s!=null&&s.uid?await Ae.updateUserData(s.uid,{walletBalances:r,lastUpdated:new Date().toISOString()}):ke(!0)}setTimeout(()=>{Qt(r=>({...r}))},100),Zr(!1),pi(""),gi("")}catch(a){console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",a),i({title:"خطأ",description:"حدث خطأ أثناء حفظ البيانات",variant:"destructive"})}finally{Ll(!1)}},children:Ml?"جاري الإضافة...":"إضافة الأموال"})]})]})}),e.jsx(de,{open:Td,onOpenChange:sn,children:e.jsxs(me,{className:"sm:max-w-[425px]",children:[e.jsx(he,{children:e.jsxs(ue,{className:"text-red-600 flex items-center gap-2",children:[e.jsx(Vt,{className:"h-1 w-1"}),"تصفير الرصيد النقدي"]})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-3",children:e.jsx("p",{className:"text-sm text-red-700",children:"⚠️ تحذير: سيتم تصفير الرصيد النقدي في الدرج إلى صفر. هذا الإجراء لا يمكن التراجع عنه."})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(H,{htmlFor:"resetCashPin",children:"الرقم السري الرئيسي"}),e.jsx(U,{id:"resetCashPin",type:"password",autoComplete:"off",placeholder:"أدخل الرقم السري الرئيسي",value:fi,onChange:t=>yi(t.target.value)})]})]}),e.jsxs(rt,{children:[e.jsx(h,{variant:"outline",onClick:()=>{sn(!1),yi("")},children:"إلغاء"}),e.jsx(h,{variant:"destructive",onClick:async()=>{if(!fi){i({title:"خطأ",description:"يرجى إدخال الرقم السري",variant:"destructive"});return}if(!await ns.verifyMasterPin(fi,s==null?void 0:s.uid)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}try{zt(0),sn(!1),yi("");const a={cashBalance:0,lastUpdated:new Date().toISOString()};localStorage.setItem(js(),"0");const r=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(r,JSON.stringify(a)),s!=null&&s.uid?Ae.updateUserData(s.uid,a).then(()=>{localStorage.removeItem(r),ke(!1)}).catch(l=>{console.error("خطأ في حفظ الرصيد في Firebase:",l),ke(!0),i({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):ke(!0)}catch(a){console.error("خطأ في تصفير الرصيد النقدي:",a),i({title:"خطأ",description:"حدث خطأ أثناء تصفير الرصيد النقدي",variant:"destructive"})}},children:"تصفير الرصيد"})]})]})}),e.jsx(rh,{open:Dd,onOpenChange:_l,userId:s==null?void 0:s.uid,cashBalance:ht,walletBalances:$e,transactions:lt}),e.jsx(de,{open:Sd,onOpenChange:rr,children:e.jsxs(me,{className:"sm:max-w-[425px]",children:[e.jsx(he,{children:e.jsxs(ue,{className:"text-green-600 flex items-center gap-2",children:[e.jsx(as,{className:"h-4 w-4"}),"إضافة أموال للدرج"]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-3",children:e.jsx("p",{className:"text-sm text-green-700",children:"💰 سيتم إضافة المبلغ المحدد إلى الرصيد النقدي في الدرج"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"addCashAmount",children:"المبلغ المراد إضافته"}),e.jsx(U,{id:"addCashAmount",type:"number",placeholder:"أدخل المبلغ",value:va,onChange:t=>Kr(t.target.value),min:"0",step:"0.01"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{className:"text-right",children:"هل تريد إضافة ملاحظة؟"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(h,{type:"button",variant:Ma==="yes"?"default":"outline",onClick:()=>ir("yes"),className:"flex-1",children:"نعم"}),e.jsx(h,{type:"button",variant:Ma==="no"?"default":"outline",onClick:async()=>{if(ir("no"),!va||parseFloat(va)<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح أكبر من صفر",variant:"destructive"});return}if(!nr){i({title:"خطأ",description:"يرجى إدخال الرقم السري",variant:"destructive"});return}if(!await an(nr)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}Hr(!0);try{const t=parseFloat(va),a=ht+t;zt(a),localStorage.setItem(js(),a.toString());const r={cashBalance:a,lastUpdated:new Date().toISOString()},l=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(l,JSON.stringify(r)),s!=null&&s.uid?(await Ae.updateUserData(s.uid,r),localStorage.removeItem(l),ke(!1)):ke(!0);const m=[{id:Date.now().toString(),type:"receive",senderPhone:"إضافة نقدية",receiverPhone:"",amount:t,status:"completed",createdAt:new Date,title:"إيصال إضافة نقدية"},...lt];_s(m);try{localStorage.setItem(Fa(),JSON.stringify(m))}catch{}try{if(s!=null&&s.uid){const x={txnType:"receive",amount:t,status:"confirmed",senderMsisdn:"إضافة نقدية",receiverMsisdn:"",title:"إيصال إضافة نقدية",merchantUserId:s.uid,createdBy:s.uid,shopId:(D==null?void 0:D.shopId)||void 0};await Ae.saveUserTransaction(s.uid,x);const f=D==null?void 0:D.shopId;if(f){const I=ze(K,"dashboardData",f);try{await Ms(I,{cashBalance:a})}catch{}}}}catch{}rr(!1),Kr(""),Yr(""),ir(null),Qr("")}catch(t){console.error("خطأ في حفظ الرصيد في Firebase:",t),zt(ht),localStorage.setItem("cashBalance",ht.toString()),i({title:"خطأ",description:"حدث خطأ أثناء حفظ البيانات، يرجى المحاولة مرة أخرى",variant:"destructive"})}finally{Hr(!1)}},className:"flex-1",children:"لا"})]})]}),Ma==="yes"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"addCashNote",children:"الملاحظة"}),e.jsx(U,{id:"addCashNote",type:"text",placeholder:"اكتب الملاحظة",value:Gr,onChange:t=>Qr(t.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"addCashPin",children:"الرقم السري لدرج النقدية"}),e.jsx(U,{id:"addCashPin",type:"password",placeholder:"أدخل الرقم السري",value:nr,onChange:t=>Yr(t.target.value)})]})]}),e.jsxs(rt,{children:[e.jsx(h,{variant:"outline",onClick:()=>{rr(!1),Kr(""),Yr(""),ir(null),Qr("")},children:"إلغاء"}),e.jsx(h,{variant:"default",className:"bg-green-600 hover:bg-green-700",disabled:El,onClick:async()=>{if(!va||parseFloat(va)<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح أكبر من صفر",variant:"destructive"});return}if(!nr){i({title:"خطأ",description:"يرجى إدخال الرقم السري",variant:"destructive"});return}if(!await an(nr)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}if(Ma==="yes"&&Gr.trim().length===0){i({title:"تنبيه",description:"أدخل الملاحظة أو اختر لا",variant:"destructive"});return}Hr(!0);try{const t=parseFloat(va),a=ht+t;zt(a),localStorage.setItem(js(),a.toString());const r={cashBalance:a,lastUpdated:new Date().toISOString()},l=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(l,JSON.stringify(r)),s!=null&&s.uid?(await Ae.updateUserData(s.uid,r),localStorage.removeItem(l),ke(!1)):ke(!0);const m=[{id:Date.now().toString(),type:"receive",senderPhone:"إضافة نقدية",receiverPhone:"",amount:t,status:"completed",createdAt:new Date,notes:Ma==="yes"?Gr.trim():void 0,title:"إيصال إضافة نقدية"},...lt];_s(m);try{localStorage.setItem(Fa(),JSON.stringify(m))}catch{}try{if(s!=null&&s.uid){const x={txnType:"receive",amount:t,status:"confirmed",senderMsisdn:"إضافة نقدية",receiverMsisdn:"",note:Ma==="yes"?Gr.trim():void 0,title:"إيصال إضافة نقدية",merchantUserId:s.uid,createdBy:s.uid,shopId:(D==null?void 0:D.shopId)||void 0};await Ae.saveUserTransaction(s.uid,x);const f=D==null?void 0:D.shopId;if(f){const I=ze(K,"dashboardData",f);try{await Ms(I,{cashBalance:a})}catch{}}}}catch{}rr(!1),Kr(""),Yr(""),ir(null),Qr("")}catch(t){console.error("خطأ في حفظ الرصيد في Firebase:",t),zt(ht),localStorage.setItem("cashBalance",ht.toString()),i({title:"خطأ",description:"حدث خطأ أثناء حفظ البيانات، يرجى المحاولة مرة أخرى",variant:"destructive"})}finally{Hr(!1)}},children:El?"جاري الإضافة...":"إضافة الأموال"})]})]})}),e.jsx(de,{open:sd,onOpenChange:si,children:e.jsxs(me,{className:"sm:max-w-md",children:[e.jsx(he,{children:e.jsx(ue,{className:"text-right",children:"اختيار التاريخ والوقت للبحث"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(H,{htmlFor:"search-date",className:"text-right block",children:"التاريخ"}),e.jsx(U,{id:"search-date",type:"date",value:Tr,onChange:t=>Hi(t.target.value),className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(H,{htmlFor:"search-time",className:"text-right block",children:"الوقت (اختياري)"}),e.jsx(U,{id:"search-time",type:"time",value:Pr,onChange:t=>Gi(t.target.value),className:"text-right",placeholder:"اختر الوقت للبحث في ساعة محددة"}),e.jsx("p",{className:"text-[10px] text-gray-500 text-right",children:"إذا لم تختر وقتاً محدداً، سيتم البحث في كامل اليوم"})]})]}),e.jsxs(rt,{className:"flex justify-between",children:[e.jsx(h,{variant:"outline",onClick:()=>{Hi(""),Gi(""),si(!1)},children:"مسح"}),e.jsx(h,{onClick:()=>si(!1),children:"تطبيق"})]})]})}),e.jsx(ho,{isOpen:Aa&&!Ue,onClose:()=>ls(!1),onTrialStarted:ed}),e.jsx(sh,{isOpen:Pc,onClose:()=>Wn(!1)}),e.jsx(ah,{isOpen:Pn,onClose:()=>Ja(!1),initialBarcode:cc}),e.jsx(Sm,{isOpen:kc,onClose:()=>kr(!1)}),e.jsx(Dm,{open:Oc,onOpenChange:Or}),e.jsx(vh,{open:Ec,onOpenChange:t=>{if(t&&!Ws){i({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});return}Er(t)}}),e.jsx(Ch,{open:V,onOpenChange:t=>{if(t&&!Ws){i({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}J(t)}}),e.jsx(Ih,{open:re,onOpenChange:t=>{if(t&&!Ws){i({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}E(t)}}),e.jsx(rs,{open:dd,onOpenChange:Il,onSuccess:()=>oi(!0),title:"تقاريرك",description:"أدخل الرقم السري الرئيسي للوصول إلى تقاريرك",mode:"verify"}),e.jsx(de,{open:li,onOpenChange:oi,children:e.jsxs(me,{className:"sm:max-w-xl",children:[e.jsxs(he,{children:[e.jsxs(ue,{className:"flex items-center gap-2",children:[e.jsx(io,{className:"h-4 w-4 text-blue-600"}),"تقارير اليوم"]}),e.jsx(ss,{children:"ملخص معاملات اليوم محفوظ لآخر 30 يومًا مع أرشفة في السحابة"})]}),e.jsxs("div",{className:"space-y-4",children:[(()=>{const t=new Date().toDateString(),a=lt.filter(f=>{const I=new Date(f.createdAt).toDateString(),w=String(f.status||"completed").toLowerCase();return I===t&&(w==="completed"||w==="confirmed")}),r=a.length,l=a.reduce((f,I)=>f+Number(I.amount||0),0),c=a.filter(f=>f.type==="withdraw").reduce((f,I)=>f+Number(I.amount||0),0),m=a.filter(f=>f.type==="send").reduce((f,I)=>f+Number(I.amount||0),0),x=a.reduce((f,I)=>f+Number(Zt.calculateTransactionProfit(I)||0),0);return e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded-lg p-3 bg-gradient-to-r from-blue-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-blue-700",children:"عدد المعاملات"}),e.jsx("div",{className:"text-lg font-bold text-blue-800",children:r})]}),e.jsxs("div",{className:"rounded-lg p-3 bg-gradient-to-r from-indigo-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-indigo-700",children:"إجمالي المبالغ"}),e.jsx("div",{className:"text-lg font-bold text-indigo-800",children:Number(l).toFixed(2)})]}),e.jsxs("div",{className:"rounded-lg p-3 bg-gradient-to-r from-red-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-red-700",children:"المبالغ المسحوبة"}),e.jsx("div",{className:"text-lg font-bold text-red-800",children:Number(c).toFixed(2)})]}),e.jsxs("div",{className:"rounded-lg p-3 bg-gradient-to-r from-green-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-green-700",children:"المبالغ المرسلة"}),e.jsx("div",{className:"text-lg font-bold text-green-800",children:Number(m).toFixed(2)})]}),e.jsxs("div",{className:"col-span-2 rounded-lg p-3 bg-gradient-to-r from-amber-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-amber-700",children:"الأرباح"}),e.jsx("div",{className:"text-lg font-bold text-amber-800",children:Number(x).toFixed(2)})]})]})})(),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(h,{variant:"default",onClick:async()=>{try{if(!(s!=null&&s.uid))return;const t=new Date,a=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),l=String(t.getDate()).padStart(2,"0"),c=`${a}-${r}-${l}`,m=t.toDateString(),x=lt.filter($=>{const z=new Date($.createdAt).toDateString(),be=String($.status||"completed").toLowerCase();return z===m&&(be==="completed"||be==="confirmed")}),f=x.length,I=x.reduce(($,z)=>$+Number(z.amount||0),0),w=x.filter($=>$.type==="withdraw").reduce(($,z)=>$+Number(z.amount||0),0),S=x.filter($=>$.type==="send").reduce(($,z)=>$+Number(z.amount||0),0),F=x.reduce(($,z)=>$+Number(Zt.calculateTransactionProfit(z)||0),0);await ur.add({userId:s.uid,reportDate:c,totalTransactions:f,totalAmount:Number(I.toFixed(2)),totalWithdrawn:Number(w.toFixed(2)),totalSent:Number(S.toFixed(2)),profit:Number(F.toFixed(2)),walletId:null});try{await ur.trimToMaxCount(s.uid,30)}catch{}i({title:"تم الأرشفة",description:`تم حفظ تقرير ${c}`})}catch{i({title:"فشل الأرشفة",description:"تعذر حفظ التقرير",variant:"destructive"})}},children:"أرشفة اليوم"}),e.jsx(h,{variant:"outline",onClick:()=>oi(!1),children:"إغلاق"})]}),e.jsx("div",{className:"mt-2 border-t pt-2",children:e.jsx("div",{className:"space-y-2 max-h-[40vh] overflow-auto",children:Al.length===0?e.jsx("div",{className:"text-xs text-muted-foreground",children:"لا توجد تقارير محفوظة"}):Al.map(t=>e.jsxs("div",{className:"border rounded-md p-2 bg-gradient-to-r from-white/80 to-blue-50/70",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{className:"font-bold text-blue-800",children:t.reportDate}),e.jsxs("div",{className:"text-xs text-blue-700",children:["عدد المعاملات: ",t.totalTransactions]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-1",children:[e.jsxs("div",{className:"text-xs text-blue-800",children:["إجمالي المبالغ: ",e.jsx("span",{className:"font-semibold",children:Number(t.totalAmount).toFixed(2)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["المسحوب: ",e.jsx("span",{className:"font-semibold",children:Number(t.totalWithdrawn).toFixed(2)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["المرسل: ",e.jsx("span",{className:"font-semibold",children:Number(t.totalSent).toFixed(2)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["الربح: ",e.jsx("span",{className:"font-semibold",children:Number(t.profit??0).toFixed(2)})]})]})]},t.id||`${t.userId}-${t.reportDate}`))})})]})]})}),e.jsx(de,{open:cd,onOpenChange:t=>{if(t){i({title:"قيد التطوير",description:"هذه الميزة غير متاحة حالياً."});return}ii(!1)},children:e.jsxs(me,{dir:"rtl",className:"sm:max-w-md w-[95vw] sm:w-auto rounded-2xl border border-emerald-200 shadow-xl bg-gradient-to-br from-white via-green-50 to-emerald-50 backdrop-blur-md data-[state=open]:animate-in data-[state=open]:fade-in-0 data-[state=open]:zoom-in-90 data-[state=open]:slide-in-from-bottom-8 duration-300",children:[e.jsxs(he,{children:[e.jsx(ue,{className:"text-right text-green-700",children:"شحن رصيد الموبايل"}),e.jsx(ss,{className:"text-right text-gray-600",children:"أدخل البيانات ثم اضغط تأكيد"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx(H,{htmlFor:"topupPhone",className:"text-right block",children:"رقم الموبايل"}),e.jsx(U,{id:"topupPhone",value:$r,onChange:t=>Nl(t.target.value),placeholder:"010xxxxxxx",className:"text-right"})]}),e.jsxs("div",{children:[e.jsx(H,{className:"text-right block",children:"شركة التشغيل"}),e.jsxs(ra,{value:Ur,onValueChange:jl,children:[e.jsx(na,{className:"text-right",children:e.jsx(ia,{placeholder:"اختر الشركة"})}),e.jsxs(la,{children:[e.jsx(Os,{value:"vodafone",children:"فودافون"}),e.jsx(Os,{value:"orange",children:"أورنج"}),e.jsx(Os,{value:"etisalat",children:"اتصالات"}),e.jsx(Os,{value:"we",children:"WE"})]})]})]}),e.jsxs("div",{children:[e.jsx(H,{htmlFor:"topupAmount",className:"text-right block",children:"المبلغ بالجنيه"}),e.jsx(U,{id:"topupAmount",type:"number",value:zr,onChange:t=>Sl(t.target.value?Number(t.target.value):""),placeholder:"50",className:"text-right"})]})]}),e.jsxs(rt,{className:"flex gap-2 justify-between",children:[e.jsx(h,{variant:"outline",onClick:()=>ii(!1),className:"border-gray-300",children:"إلغاء"}),e.jsx(h,{onClick:v,disabled:Dl||!$r||!Ur||!zr,className:"bg-emerald-600 hover:bg-emerald-700 text-white",children:Dl?"جارٍ التنفيذ...":"تأكيد الشحن"})]})]})}),e.jsx(rs,{open:Bc,onOpenChange:Mn,mode:"verify",title:"الرقم السري الرئيسي لفتح الديون",description:"أدخل الرقم السري الرئيسي لفتح صفحة الديون",onSuccess:()=>{Mn(!1),Ea(!0)}}),e.jsx(rs,{open:Uc,onOpenChange:al,mode:"verify",title:"تأكيد تغيير طلب الرقم السري للديون",description:"أدخل الرقم السري الرئيسي لتفعيل أو إلغاء طلب الرقم السري عند فتح الديون",onSuccess:async()=>{if(rl!==null){const t=rl;sl(t);try{const a=s==null?void 0:s.uid,r=a?`debtsPinRequired_${a}`:"debtsPinRequired";localStorage.setItem(r,String(t)),a&&await Ae.updateUserData(a,{debtsPinRequired:t})}catch{}i({title:t?"تم تفعيل طلب الرقم السري للديون":"تم إلغاء طلب الرقم السري للديون",description:t?"سيُطلب الرقم السري الرئيسي عند فتح نافذة الديون.":"يمكن فتح نافذة الديون بدون طلب الرقم السري."})}zc(null),al(!1)}}),e.jsx(ym,{open:ld,onOpenChange:ar,title:"تأكيد كلمة المرور لتصفير المعاملات الأخيرة",description:"سيتم حذف كل المعاملات السابقة نهائيًا من حسابك وFirebase.",onSuccess:async()=>{try{if(!(s!=null&&s.uid)){ar(!1);return}const t=new Date,a=l=>l instanceof Date?l:typeof(l==null?void 0:l.toDate)=="function"?l.toDate():new Date(String(l)),r=lt.filter(l=>a(l.createdAt)<t);await Ae.updateUserData(s.uid,{recentReset:{keepLastCount:La.keepLastCount??30,intervalDays:La.intervalDays??7,lastResetAt:t}}),Xr(l=>({...l,lastResetAt:t})),i({title:"تم إخفاء المعاملات السابقة",description:"تم إخفاء كل الإيصالات الأقدم من وقت التصفير من العرض بدون التأثير على تقارير اليوم/الشهر أو الحدود."})}catch(t){console.error("فشل تنفيذ التصفير النهائي:",t),i({title:"فشل التصفير",description:"تحقق من الاتصال ثم أعد المحاولة.",variant:"destructive"})}finally{ar(!1)}}}),e.jsx(rs,{open:Wt,onOpenChange:Pt,mode:"verify",title:"الرقم السري لفتح مصروفات المحل",description:"أدخل الرقم السري الرئيسي لفتح نافذة مصروفات المحل",onSuccess:()=>{Pt(!1),_t(!0)}}),e.jsx(de,{open:Rc,onOpenChange:Ea,children:e.jsxs(me,{className:"sm:max-w-[425px]",children:[e.jsxs(he,{className:"flex items-center justify-between",children:[e.jsx(ue,{className:"text-right",children:"إدارة الديون"}),e.jsxs("div",{className:"flex items-center gap-1 text-orange-700",children:[e.jsx(oo,{className:"h-4 w-4"}),e.jsxs("span",{className:"text-xs font-bold",children:[Fd," جنيه"]})]})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(H,{htmlFor:"debtorName",className:"text-right col-span-1",children:"اسم المديون"}),e.jsx(U,{id:"debtorName",value:Ln,onChange:t=>nl(t.target.value),className:"col-span-3 text-right",placeholder:"أدخل اسم المديون"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(H,{htmlFor:"debtAmount",className:"text-right col-span-1",children:"المبلغ"}),e.jsx(U,{id:"debtAmount",type:"number",value:Rn,onChange:t=>il(t.target.value),className:"col-span-3 text-right",placeholder:"أدخل المبلغ"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(H,{htmlFor:"debtReason",className:"text-right col-span-1",children:"سبب الدين"}),e.jsx(U,{id:"debtReason",value:Bn,onChange:t=>ll(t.target.value),className:"col-span-3 text-right",placeholder:"أدخل سبب الدين"})]})]}),e.jsx(rt,{children:e.jsx(h,{onClick:()=>{if(Ln&&Rn&&Bn){const t={id:Date.now().toString(),debtorName:Ln,amount:parseFloat(Rn),reason:Bn,status:"pending",createdAt:new Date,paidAmount:0,partialPayments:[]};Xn(t),tr(!0)}else i({title:"بيانات غير مكتملة",description:"يرجى إدخال الاسم والمبلغ والسبب",variant:"destructive"})},className:"bg-orange-500 hover:bg-orange-600",children:"حفظ"})}),e.jsx("div",{className:"mt-2",children:e.jsx(h,{variant:"outline",className:"w-full",onClick:()=>er(!0),children:"إيصالات الديون"})}),e.jsx("div",{className:"mt-2",children:e.jsx(h,{variant:"outline",className:"w-full",onClick:()=>Yn(!0),children:"إضافة عميل"})})]})}),e.jsx(de,{open:qn,onOpenChange:er,children:e.jsxs(me,{className:"sm:max-w-[520px]",children:[e.jsxs(he,{children:[e.jsx(ue,{className:"text-right",children:"إيصالات الديون"}),e.jsx(ss,{className:"text-right",children:"اختر دينًا لعرض إيصاله بالتفصيل"})]}),Ct.length>0?e.jsxs("div",{className:"max-h-64 overflow-y-auto space-y-2",onScroll:t=>{const a=t.currentTarget;Jn.length<Ct.length&&a.scrollTop+a.clientHeight>=a.scrollHeight-50&&Vn(r=>r+1)},children:[Jn.map(t=>e.jsx("div",{onClick:()=>{Za(t),Xs(!0),er(!1),Ea(!1)},className:"p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium",children:t.debtorName}),e.jsx("p",{className:"text-sm text-gray-600",children:t.reason}),e.jsx("p",{className:"text-sm text-gray-500",children:nn.format(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt))})]}),e.jsxs("div",{className:"text-left",children:[e.jsxs("p",{className:"font-bold text-lg",children:[t.amount," جنيه"]}),e.jsx(Ot,{variant:t.status==="paid"?"default":"secondary",className:t.status==="paid"?"bg-green-500":"bg-yellow-500",children:t.status==="paid"?"مدفوع":"قيد المراجعة"})]})]})},t.id)),Jn.length<Ct.length&&e.jsx("div",{className:"flex justify-center pt-1",children:e.jsx(h,{variant:"outline",size:"sm",onClick:()=>Vn(t=>t+1),children:"تحميل المزيد"})})]}):e.jsx("div",{className:"text-center text-sm text-gray-500",children:"لا توجد ديون مسجلة"}),e.jsxs(rt,{className:"flex justify-between mt-3",children:[e.jsx(h,{variant:"destructive",onClick:async()=>{try{if(!Ct||Ct.length===0){i({title:"لا توجد ديون",description:"القائمة فارغة بالفعل."});return}if(!window.confirm("هل تريد حذف كل إيصالات الديون؟ هذا الإجراء لا يمكن التراجع عنه."))return;const a=[];us(a),Za(null),await Ns(a),i({title:"تم حذف كل إيصالات الديون",description:"تم تفريغ القائمة بالكامل."}),er(!1)}catch(t){console.error("تعذر حذف كل إيصالات الديون:",t),i({title:"فشل الحذف",description:"حدث خطأ أثناء الحذف، حاول مرة أخرى.",variant:"destructive"})}},children:"حذف كل الإيصالات"}),e.jsx(h,{variant:"outline",onClick:()=>er(!1),children:"إغلاق"})]})]})}),e.jsx(de,{open:Yc,onOpenChange:Yn,children:e.jsxs(me,{className:"sm:max-w-[480px]",children:[e.jsxs(he,{children:[e.jsx(ue,{className:"text-right",children:"إضافة عميل"}),e.jsx(ss,{className:"text-right",children:"أدخل بيانات العميل ثم يمكنك تسجيل مبلغ دين عليه"})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(H,{htmlFor:"customerName",className:"text-right col-span-1",children:"اسم العميل"}),e.jsx(U,{id:"customerName",value:Gn,onChange:t=>ul(t.target.value),className:"col-span-3 text-right",placeholder:"اكتب اسم العميل"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(H,{htmlFor:"customerMobile",className:"text-right col-span-1",children:"رقم الموبايل"}),e.jsx(U,{id:"customerMobile",value:Qn,onChange:t=>xl(t.target.value),className:"col-span-3 text-right",placeholder:"اكتب رقم الموبايل"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(h,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{if(!Gn||!Qn){i({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم العميل ورقم الموبايل",variant:"destructive"});return}const t={id:Date.now().toString(),name:Gn.trim(),mobile:Qn.trim(),createdAt:new Date},a=[t,...Vs];await pd(a),ul(""),xl(""),i({title:"تمت إضافة العميل",description:`تم إضافة ${t.name}`})},children:"إضافة"})}),e.jsxs("div",{className:"border-t pt-4 space-y-3",children:[e.jsx(H,{className:"text-right block",children:"إضافة مبلغ على عميل"}),Vs.length>0?e.jsxs("div",{className:"space-y-3",children:[e.jsxs(ra,{value:Zn,onValueChange:pl,children:[e.jsx(na,{className:"w-full",children:e.jsx(ia,{placeholder:"اختر عميل"})}),e.jsx(la,{children:Vs.map(t=>e.jsxs(Os,{value:t.id,children:[t.name," — ",t.mobile]},t.id))})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(H,{htmlFor:"customerDebtAmount",className:"text-right col-span-1",children:"المبلغ"}),e.jsx(U,{id:"customerDebtAmount",type:"number",value:gl,onChange:t=>fl(t.target.value),className:"col-span-3 text-right",placeholder:"أدخل المبلغ"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(h,{className:"bg-orange-600 hover:bg-orange-700",onClick:async()=>{const t=parseFloat(gl);if(!Zn){i({title:"اختر عميل",description:"يرجى اختيار عميل أولاً",variant:"destructive"});return}if(isNaN(t)||t<=0){i({title:"قيمة غير صحيحة",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const a=Vs.find(c=>c.id===Zn);if(!a)return;const r={id:Date.now().toString(),debtorName:a.name,customerId:a.id,mobile:a.mobile,amount:Number(t.toFixed(2)),reason:"دين عميل",status:"pending",createdAt:new Date,paidAmount:0,partialPayments:[]},l=[...Ct,r];us(l),await Ns(l),pl(""),fl(""),i({title:"تم تسجيل المبلغ على العميل",description:`تمت إضافة ${r.amount} جنيه للعميل ${a.name}`})},children:"إضافة المبلغ"})})]}):e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد عملاء مسجلين. أضف عميلًا أولاً."})]})]}),e.jsx(rt,{className:"flex justify-end",children:e.jsx(h,{variant:"outline",onClick:()=>Yn(!1),children:"إغلاق"})})]})}),e.jsx(de,{open:Et,onOpenChange:_t,children:e.jsxs(me,{className:"sm:max-w-[520px]",children:[e.jsxs(he,{children:[e.jsx(ue,{className:"text-right",children:"مصروفات المحل"}),e.jsx(ss,{className:"text-right",children:"أدخل تفاصيل المصروف ثم اختر مصدر الخصم."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(H,{htmlFor:"expenseName",className:"text-right col-span-1",children:"اسم المصروف"}),e.jsx(U,{id:"expenseName",value:R,onChange:t=>je(t.target.value),className:"col-span-3 text-right",placeholder:"مثال: كهرباء، صيانة، مشتريات"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(H,{htmlFor:"expenseAmount",className:"text-right col-span-1",children:"تمن المصروف"}),e.jsx(U,{id:"expenseAmount",type:"number",value:Pe,onChange:t=>He(t.target.value),className:"col-span-3 text-right",placeholder:"0.00"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(H,{htmlFor:"expenseNotes",className:"text-right col-span-1",children:"ملاحظات"}),e.jsx(U,{id:"expenseNotes",value:Oe,onChange:t=>Ft(t.target.value),className:"col-span-3 text-right",placeholder:"معلومات إضافية إن وجدت"})]})]}),e.jsxs(rt,{className:"flex justify-between",children:[e.jsx(h,{className:"bg-orange-600 hover:bg-orange-700",onClick:()=>{if(!R||!Pe){i({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم المصروف وقيمته",variant:"destructive"});return}is(!0)},children:"إضافة مصروف"}),e.jsx(h,{variant:"outline",onClick:()=>Ts(!0),children:"إيصالات المصاريف"})]})]})}),e.jsx(de,{open:Ia,onOpenChange:Ts,children:e.jsxs(me,{className:"sm:max-w-[420px]",dir:"rtl",children:[e.jsxs(he,{children:[e.jsx(ue,{className:"text-right",children:"إيصالات المصاريف"}),e.jsx(ss,{className:"text-right",children:"آخر المصاريف المسجلة"})]}),it.length>0?e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:it.map(t=>e.jsx("div",{className:"p-2 border rounded-lg bg-white hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium text-sm",children:t.name}),e.jsx("p",{className:"text-[11px] text-gray-600",children:t.notes||"بدون ملاحظات"}),e.jsx("p",{className:"text-[10px] text-gray-500",children:new Date(t.createdAt).toLocaleString("ar-EG")})]}),e.jsxs("div",{className:"text-left flex items-start gap-2",children:[e.jsxs("div",{className:"text-left",children:[e.jsxs("p",{className:"font-bold text-sm",children:[t.amount," جنيه"]}),e.jsx(Ot,{variant:"secondary",className:t.source==="cash"?"bg-blue-100 text-blue-700":"bg-purple-100 text-purple-700",children:t.source==="cash"?"من النقدية":`من المحفظة${t.walletId?` (${t.walletId})`:""}`})]}),e.jsxs(h,{variant:"destructive",size:"sm",className:"shrink-0",onClick:()=>ud(t.id),title:"حذف نهائي",children:[e.jsx(Vt,{className:"w-4 h-4 ml-1"}),"حذف"]})]})]})},t.id))}):e.jsx("p",{className:"text-sm text-gray-500 text-center",children:"لا توجد مصاريف مسجلة بعد"})]})}),e.jsx(de,{open:Yt,onOpenChange:is,children:e.jsxs(me,{className:"sm:max-w-[480px]",children:[e.jsx(he,{children:e.jsx(ue,{className:"text-right",children:"اختيار مصدر خصم المصروف"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600 text-right",children:"اختر هل تريد خصم مبلغ المصروف من الرصيد النقدي في الدرج أم من إحدى المحافظ."}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsx(h,{variant:mt==="cash"?"default":"outline",className:mt==="cash"?"bg-blue-600 hover:bg-blue-700 text-white":"",onClick:()=>bs("cash"),children:"الفلوس النقدية"}),e.jsx(h,{variant:mt==="wallet"?"default":"outline",className:mt==="wallet"?"bg-purple-600 hover:bg-purple-700 text-white":"",onClick:()=>bs("wallet"),children:"أرصدة المحافظ"}),e.jsx(h,{variant:mt==="fawry"?"default":"outline",className:mt==="fawry"?"bg-amber-600 hover:bg-amber-700 text-white":"",onClick:()=>bs("fawry"),children:"فوري"})]}),mt==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{className:"text-right block",children:"اختر المحفظة للخصم"}),e.jsxs(ra,{value:bt,onValueChange:Us,children:[e.jsx(na,{className:"w-full",children:e.jsx(ia,{placeholder:"اختر محفظة"})}),e.jsx(la,{children:Be.map(t=>e.jsx(Os,{value:t.id,children:t.phone||t.name||t.id},t.id))})]})]})]}),e.jsxs(rt,{className:"flex justify-between",children:[e.jsx(h,{variant:"outline",onClick:()=>{is(!1),bs(null),Us("")},children:"إلغاء"}),e.jsx(h,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{const t=Number(Pe);if(isNaN(t)||t<=0){i({title:"قيمة غير صحيحة",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}if(!mt){i({title:"اختر مصدر الخصم",description:"يرجى اختيار النقدية أو المحفظة",variant:"destructive"});return}try{if(mt==="cash"){const c=Number((ht-t).toFixed(2));zt(c),localStorage.setItem(js(),c.toString());const m={cashBalance:c,lastUpdated:new Date().toISOString()},x=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(x,JSON.stringify(m)),s!=null&&s.uid?(await Ae.updateUserData(s.uid,m),localStorage.removeItem(x),ke(!1)):ke(!0)}else if(mt==="wallet"){if(!bt){i({title:"اختر محفظة",description:"يرجى اختيار محفظة للخصم",variant:"destructive"});return}const c=$e[bt]||0,m=Number((c-t).toFixed(2)),x={...$e,[bt]:m};Qt(x);const f=new Date().toISOString(),I={walletBalances:x,lastUpdated:f},w=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(w,JSON.stringify(I)),localStorage.setItem(ps(),JSON.stringify(x)),localStorage.setItem(`walletBalances_backup_${f}`,JSON.stringify(x)),s!=null&&s.uid&&await Ae.updateUserData(s.uid,I)}}catch(c){console.error("خطأ أثناء تحديث الأرصدة عند حفظ المصروف:",c)}let a=Date.now().toString();try{if(s!=null&&s.uid){const{addDoc:c,collection:m,serverTimestamp:x}=await ft(async()=>{const{addDoc:w,collection:S,serverTimestamp:F}=await import("./index-5EflPS7Y.js").then($=>$.bg);return{addDoc:w,collection:S,serverTimestamp:F}},__vite__mapDeps([0,1]),import.meta.url),{db:f}=await ft(async()=>{const{db:w}=await import("./index-5EflPS7Y.js").then(S=>S.bh);return{db:w}},__vite__mapDeps([0,1]),import.meta.url);a=(await c(m(f,"shop_expenses"),{userId:s.uid,shopId:P||(D==null?void 0:D.shopId)||s.uid||"default-shop",name:R,amount:t,notes:Oe||"",source:mt,walletId:mt==="wallet"?bt:null,createdAt:x()})).id}}catch(c){console.error("خطأ أثناء حفظ المصروف في Firestore:",c)}const r={id:a,name:R,amount:t,notes:Oe,source:mt,walletId:mt==="wallet"?bt:void 0,createdAt:new Date},l=[...it,r];await kl(l),je(""),He(""),Ft(""),bs(null),Us(""),is(!1),_t(!0),Ts(!0),i({title:"تم إضافة المصروف",description:mt==="cash"?"تم الخصم من النقدية":mt==="wallet"?"تم الخصم من أرصدة المحافظ":"تم تسجيل الدفع عبر فوري"})},children:"تأكيد الخصم"})]})]})}),e.jsx(de,{open:za,onOpenChange:d,children:e.jsxs(me,{className:"sm:max-w-[520px]",children:[e.jsxs(he,{children:[e.jsx(ue,{className:"text-right",children:"النواقص"}),e.jsx(ss,{className:"text-right",children:"سجل العناصر الناقصة التي تحتاج شراء وتابع حالتها."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(H,{htmlFor:"deficiencyName",className:"text-right col-span-1",children:"اسم العنصر"}),e.jsx(U,{id:"deficiencyName",value:O,onChange:t=>L(t.target.value),className:"col-span-3 text-right",placeholder:"مثال: سكر، زيت، مناديل"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(H,{htmlFor:"deficiencyQuantity",className:"text-right col-span-1",children:"الكمية"}),e.jsx(U,{id:"deficiencyQuantity",type:"number",value:N,onChange:t=>k(t.target.value),className:"col-span-3 text-right",placeholder:"1"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(h,{className:"bg-rose-600 hover:bg-rose-700",onClick:()=>{if(pt){i({title:"غير متاح",description:"النواقص غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"});return}const t=parseInt(N||"1",10);if(!O){i({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم العنصر",variant:"destructive"});return}if(isNaN(t)||t<=0){i({title:"كمية غير صحيحة",description:"يرجى إدخال كمية صحيحة",variant:"destructive"});return}(async()=>{if(s!=null&&s.uid)try{const{collection:r,addDoc:l,serverTimestamp:c}=await ft(async()=>{const{collection:f,addDoc:I,serverTimestamp:w}=await import("./index-5EflPS7Y.js").then(S=>S.bg);return{collection:f,addDoc:I,serverTimestamp:w}},__vite__mapDeps([0,1]),import.meta.url),{db:m}=await ft(async()=>{const{db:f}=await import("./index-5EflPS7Y.js").then(I=>I.bh);return{db:f}},__vite__mapDeps([0,1]),import.meta.url),x=await l(r(m,"deficiencies"),{userId:s.uid,shopId:P||(D==null?void 0:D.shopId)||s.uid||"default-shop",name:O,quantity:t,status:"pending",createdAt:c()});try{const f=Vr(),I=localStorage.getItem(f),w=I?JSON.parse(I):[],S=Array.isArray(w)?w:[],F=S.some(be=>String((be==null?void 0:be.id)||"")===x.id),$={id:x.id,name:O,quantity:t,status:"pending",createdAt:new Date().toISOString()},z=F?S:[...S,$];localStorage.setItem(f,JSON.stringify(z))}catch{}L(""),k(""),i({title:"تمت الإضافة",description:"تمت إضافة العنصر إلى قائمة النواقص"});return}catch(r){console.warn("فشل حفظ النواقص إلى Firestore، سيُستخدم التخزين المحلي:",r)}const a={id:Date.now().toString(),name:O,quantity:t,status:"pending",createdAt:new Date};X(r=>{const l=[...r,a];return mi(l),l}),L(""),k(""),i({title:"تمت الإضافة",description:"تمت إضافة العنصر إلى قائمة النواقص"})})()},children:"إضافة للنواقص"})}),Y.length>0?e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:Y.map(t=>e.jsx("div",{className:"p-2 border rounded-lg bg-white hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium text-sm",children:t.name}),e.jsxs("p",{className:"text-[11px] text-gray-600",children:["الكمية: ",t.quantity]}),e.jsx("p",{className:"text-[10px] text-gray-500",children:new Date(t.createdAt).toLocaleString("ar-EG")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ot,{variant:"secondary",className:t.status==="pending"?"bg-rose-100 text-rose-700":"bg-green-100 text-green-700",children:t.status==="pending"?"قيد الشراء":"تم الشراء"}),e.jsx(h,{variant:"outline",className:t.status==="pending"?"text-green-700 border-green-300 hover:bg-green-50":"text-rose-700 border-rose-300 hover:bg-rose-50",onClick:()=>{(async()=>{const a=t.status==="pending"?"purchased":"pending";if(s!=null&&s.uid)try{const{doc:r,updateDoc:l,serverTimestamp:c}=await ft(async()=>{const{doc:x,updateDoc:f,serverTimestamp:I}=await import("./index-5EflPS7Y.js").then(w=>w.bg);return{doc:x,updateDoc:f,serverTimestamp:I}},__vite__mapDeps([0,1]),import.meta.url),{db:m}=await ft(async()=>{const{db:x}=await import("./index-5EflPS7Y.js").then(f=>f.bh);return{db:x}},__vite__mapDeps([0,1]),import.meta.url);await l(r(m,"deficiencies",t.id),{status:a,updatedAt:c()});return}catch(r){console.warn("فشل تحديث حالة النواقص على Firestore، استخدام التخزين المحلي:",r)}X(r=>{const l=r.map(c=>c.id===t.id?{...c,status:a}:c);return mi(l),l})})()},title:t.status==="pending"?"تم الشراء":"إلغاء الشراء",children:t.status==="pending"?"تم الشراء":"إلغاء الشراء"}),e.jsx(h,{variant:"outline",className:"text-red-700 border-red-300 hover:bg-red-50",onClick:()=>{(async()=>{if(s!=null&&s.uid)try{const{doc:a,deleteDoc:r}=await ft(async()=>{const{doc:c,deleteDoc:m}=await import("./index-5EflPS7Y.js").then(x=>x.bg);return{doc:c,deleteDoc:m}},__vite__mapDeps([0,1]),import.meta.url),{db:l}=await ft(async()=>{const{db:c}=await import("./index-5EflPS7Y.js").then(m=>m.bh);return{db:c}},__vite__mapDeps([0,1]),import.meta.url);await r(a(l,"deficiencies",t.id));return}catch(a){console.warn("فشل حذف عنصر النواقص من Firestore، استخدام التخزين المحلي:",a)}X(a=>{const r=a.filter(l=>l.id!==t.id);return mi(r),r})})()},title:"حذف",children:"حذف"})]})]})},t.id))}):e.jsx("p",{className:"text-sm text-gray-500 text-center",children:"لا توجد عناصر مسجلة في النواقص"})]}),e.jsx(rt,{className:"flex justify-end",children:e.jsx(h,{variant:"outline",onClick:()=>d(!1),children:"إغلاق"})})]})}),e.jsx(de,{open:Hc,onOpenChange:tr,children:e.jsxs(me,{className:"sm:max-w-[480px]",children:[e.jsx(he,{children:e.jsx(ue,{className:"text-right",children:"اختيار مصدر خصم الدين"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600 text-right",children:"اختر هل تريد خصم مبلغ الدين من الرصيد النقدي في الدرج أم من إحدى المحافظ أو تسجيله بدون خصم."}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsx(h,{variant:xs==="cash"?"default":"outline",className:xs==="cash"?"bg-blue-600 hover:bg-blue-700 text-white":"",onClick:()=>sr("cash"),children:"الفلوس النقدية"}),e.jsx(h,{variant:xs==="wallet"?"default":"outline",className:xs==="wallet"?"bg-purple-600 hover:bg-purple-700 text-white":"",onClick:()=>sr("wallet"),children:"أرصدة المحافظ"}),e.jsx(h,{variant:xs==="none"?"default":"outline",className:xs==="none"?"bg-gray-600 hover:bg-gray-700 text-white":"",onClick:()=>sr("none"),children:"بدون خصم"})]}),xs==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{className:"text-right block",children:"اختر المحفظة للخصم"}),e.jsxs(ra,{value:Fr,onValueChange:ei,children:[e.jsx(na,{className:"w-full",children:e.jsx(ia,{placeholder:"اختر محفظة"})}),e.jsx(la,{children:Be.map(t=>e.jsx(Os,{value:t.id,children:t.phone||t.name||t.id},t.id))})]})]})]}),e.jsxs(rt,{className:"flex justify-between",children:[e.jsx(h,{variant:"outline",onClick:()=>{tr(!1),Xn(null),sr(null),ei("")},children:"إلغاء"}),e.jsx(h,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{const t=!!Wr&&!_a,a=Number(t?Wr.delta:(_a==null?void 0:_a.amount)||0);if(!xs){i({title:"اختر مصدر الخصم",description:"يرجى اختيار النقدية أو المحفظة",variant:"destructive"});return}try{if(xs==="cash"){const r=Number((ht-a).toFixed(2));zt(r),localStorage.setItem(js(),r.toString());const l=new Date().toISOString(),c={cashBalance:r,lastUpdated:l},m=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(m,JSON.stringify(c)),s!=null&&s.uid?await Ae.updateUserData(s.uid,c).then(()=>{localStorage.removeItem(m),ke(!1)}).catch(()=>{ke(!0)}):ke(!0)}else if(xs==="wallet"){if(!Fr){i({title:"اختر محفظة",description:"يرجى اختيار محفظة للخصم",variant:"destructive"});return}const r=$e[Fr]||0,l=Number((r-a).toFixed(2)),c={...$e,[Fr]:l};Qt(c);const m=new Date().toISOString(),x={walletBalances:c,lastUpdated:m},f=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(f,JSON.stringify(x)),localStorage.setItem(ps(),JSON.stringify(c)),localStorage.setItem(`walletBalances_backup_${m}`,JSON.stringify(c)),s!=null&&s.uid&&await Ae.updateUserData(s.uid,x)}}catch(r){console.error("خطأ أثناء تحديث الأرصدة عند حفظ/تعديل الدين:",r)}if(t){if(!ge)return;const r=Number(ge.amount||0),l=Number(ge.paidAmount||0),c=Number(Wr.delta||0);if(Wr.type==="decrease"){const m=Math.max(l,r-c);if(m===r)i({title:"لا يمكن الإنقاص أكثر",description:"المبلغ لا يمكن أن يقل عن المدفوع."});else{const x=l>=m,f={...ge,amount:Number(m.toFixed(2)),status:x?"paid":"pending"},I=Ct.map(w=>w.id===ge.id?f:w);us(I),Za(f),await Ns(I);try{x&&(s!=null&&s.uid)&&(async()=>{const w=ot(Ee(K,"userTransactions"),De("userId","==",s.uid),De("linkedDebtId","==",ge.id),De("status","==","pending")),S=await ut(w);await Promise.allSettled(S.docs.map(F=>Ms(F.ref,{status:"completed",confirmedAt:new Date})))})().catch(w=>console.error("تعذر تحديث حالة المعاملات المرتبطة بالدين بعد الإنقاص:",w))}catch(w){console.error("تعذر تجهيز تحديث حالة المعاملات المرتبطة بعد الإنقاص:",w)}i({title:"تم إنقاص المبلغ",description:`المبلغ الجديد: ${m} جنيه`})}}else{const m=r+c,x=l>=m,f={...ge,amount:Number(m.toFixed(2)),status:x?"paid":"pending"},I=Ct.map(w=>w.id===ge.id?f:w);us(I),Za(f),await Ns(I),i({title:"تم زيادة المبلغ",description:`المبلغ الجديد: ${m} جنيه`})}}else if(_a){const r=[...Ct,_a];us(r),await Ns(r)}nl(""),il(""),ll(""),Ea(!1),tr(!1),Xn(null),dl(null),sr(null),ei(""),i({title:t?"تم تطبيق الخصم وتعديل الدين":xs==="none"?"تم حفظ الدين بدون خصم":"تم حفظ الدين وخصم المبلغ",description:xs==="none"?"لم يتم الخصم من الدرج أو المحافظ":xs==="cash"?`تم خصم ${a} من الرصيد النقدي`:`تم خصم ${a} من رصيد المحفظة`})},children:"تأكيد الخصم"})]})]})}),e.jsx(de,{open:qc,onOpenChange:Xs,children:e.jsxs(me,{className:"sm:max-w-[425px]",children:[e.jsx(he,{children:e.jsx(ue,{className:"text-right",children:"إيصال الدين"})}),ge&&e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"text-center border-b pb-4",children:[e.jsx("h2",{className:"text-xl font-bold",children:"إيصال دين"}),e.jsx("p",{className:"text-sm text-gray-500",children:nn.format(ge.createdAt instanceof Date?ge.createdAt:new Date(ge.createdAt))})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"اسم المديون:"}),e.jsx("span",{children:ge.debtorName})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"font-medium",children:"المبلغ:"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(h,{variant:"outline",className:"h-8 w-8 p-0","aria-label":"إنقاص الدين",onClick:()=>{ol("decrease"),$n(""),Xs(!1),Xa(!0)},children:"−"}),e.jsxs("span",{className:"font-bold text-lg",children:[ge.amount," جنيه"]}),e.jsx(h,{variant:"outline",className:"h-8 w-8 p-0","aria-label":"زيادة الدين",onClick:()=>{ol("increase"),$n(""),Xs(!1),Xa(!0)},children:"+"})]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"سبب الدين:"}),e.jsx("span",{children:ge.reason})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"الحالة:"}),e.jsx(Ot,{variant:ge.status==="paid"?"default":"secondary",className:ge.status==="paid"?"bg-green-500":"bg-yellow-500",children:ge.status==="paid"?"مدفوع":"مؤجل"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"المبلغ المتبقي:"}),e.jsxs("span",{className:"font-bold text-lg",children:[Math.max(0,Number(ge.amount||0)-Number(ge.paidAmount||0))," جنيه"]})]}),ge.paidAmount?e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"إجمالي المدفوع:"}),e.jsxs("span",{className:"text-green-700",children:[ge.paidAmount," جنيه"]})]}):null,e.jsxs("div",{className:"mt-3 p-3 border rounded-lg bg-gray-50",children:[Jc?e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"partialAmount",className:"text-right block",children:"المبلغ المراد دفعه"}),e.jsx(U,{id:"partialAmount",type:"number",value:ml,onChange:t=>zn(t.target.value),className:"text-right",placeholder:"أدخل المبلغ"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(h,{variant:"outline",onClick:()=>{Un(!1),zn("")},children:"إلغاء"}),e.jsx(h,{className:"bg-blue-600 hover:bg-blue-700",onClick:async()=>{const t=parseFloat(ml);if(!ge||isNaN(t)||t<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const a=Math.max(0,Number(ge.amount||0)-Number(ge.paidAmount||0));if(t>a){i({title:"مبلغ زائد",description:"المبلغ المدفوع أكبر من المتبقي",variant:"destructive"});return}const r=Number(((ge.paidAmount||0)+t).toFixed(2)),l=r>=Number(ge.amount||0),c={...ge,amount:Number(ge.amount||0),paidAmount:r,status:l?"paid":"pending",partialPayments:[...ge.partialPayments||[],{amount:t,paidAt:new Date}]},m=Ct.map(x=>x.id===ge.id?c:x);us(m),Za(c),await Ns(m);try{c.status==="paid"&&(s!=null&&s.uid)&&(async()=>{const x=ot(Ee(K,"userTransactions"),De("userId","==",s.uid),De("linkedDebtId","==",ge.id),De("status","==","pending")),f=await ut(x);await Promise.allSettled(f.docs.map(I=>Ms(I.ref,{status:"completed",confirmedAt:new Date})))})().catch(x=>console.error("تعذر تحديث حالة المعاملات المرتبطة بالدين:",x))}catch(x){console.error("تعذر تجهيز تحديث حالة المعاملات المرتبطة:",x)}try{const x=Fa(),f=localStorage.getItem(x);if(f){const w=(JSON.parse(f)||[]).map(S=>(S==null?void 0:S.linkedDebtId)===ge.id&&(S==null?void 0:S.status)==="pending"?{...S,status:"completed",confirmedAt:new Date}:S);localStorage.setItem(x,JSON.stringify(w)),_s(S=>S.map(F=>(F==null?void 0:F.linkedDebtId)===ge.id&&(F==null?void 0:F.status)==="pending"?{...F,status:"completed",confirmedAt:new Date}:F))}}catch(x){console.warn("فشل تحديث حالة المعاملات المرتبطة محلياً بعد سداد الدين:",x)}Mr(t),ea("cash"),Wa(!0),Un(!1),zn(""),i({title:"تم تسجيل دفع جزء",description:`تم دفع ${t} جنيه بتاريخ ${new Date().toLocaleString("ar-EG")}`})},children:"دفع"})]})]}):e.jsx(h,{variant:"outline",className:"w-full",onClick:()=>Un(!0),children:"دفع جزء"}),ge.partialPayments&&ge.partialPayments.length>0&&e.jsxs("div",{className:"mt-3 text-xs text-gray-600",children:[e.jsx("p",{className:"font-medium mb-1",children:"سجل الدفعات الجزئية:"}),e.jsx("div",{className:"space-y-1 max-h-24 overflow-y-auto",children:ge.partialPayments.map((t,a)=>e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{children:["دفع: ",t.amount," جنيه"]}),e.jsx("span",{children:new Date(t.paidAt).toLocaleString("ar-EG")})]},a))})]})]})]})]}),e.jsxs(rt,{className:"flex gap-2 justify-center",children:[e.jsx(h,{onClick:async()=>{if(ge){const t=Ct.map(a=>a.id===ge.id?{...a,status:"pending"}:a);us(t),await Ns(t),Xs(!1),i({title:"تم تحديث حالة الدين",description:"تم تعيين الدين كمؤجل"})}},variant:"outline",className:"bg-yellow-500 hover:bg-yellow-600 text-white",children:"مؤجل"}),e.jsx(h,{onClick:async()=>{if(ge){const a=Math.max(0,Number(ge.amount||0)-Number(ge.paidAmount||0)),r=Ct.map(l=>l.id===ge.id?{...l,amount:Number(l.amount||0),paidAmount:Number(((l.paidAmount||0)+a).toFixed(2)),status:"paid",partialPayments:[...l.partialPayments||[],...a>0?[{amount:a,paidAt:new Date}]:[]]}:l);us(r),a>0&&(Mr(a),ea("cash"),Wa(!0)),await Ns(r);try{s!=null&&s.uid&&(ge!=null&&ge.id)&&(async()=>{const l=ot(Ee(K,"userTransactions"),De("userId","==",s.uid),De("linkedDebtId","==",ge.id),De("status","==","pending")),c=await ut(l);await Promise.allSettled(c.docs.map(m=>Ms(m.ref,{status:"completed",confirmedAt:new Date})))})().catch(l=>console.error("تعذر تحديث حالة المعاملات المرتبطة بالدين:",l))}catch(l){console.error("تعذر تجهيز تحديث حالة المعاملات المرتبطة:",l)}try{const l=Fa(),c=localStorage.getItem(l);if(c){const x=(JSON.parse(c)||[]).map(f=>(f==null?void 0:f.linkedDebtId)===ge.id&&(f==null?void 0:f.status)==="pending"?{...f,status:"completed",confirmedAt:new Date}:f);localStorage.setItem(l,JSON.stringify(x)),_s(f=>f.map(I=>(I==null?void 0:I.linkedDebtId)===ge.id&&(I==null?void 0:I.status)==="pending"?{...I,status:"completed",confirmedAt:new Date}:I))}}catch(l){console.warn("فشل تحديث حالة المعاملات المرتبطة محلياً بعد سداد الدين:",l)}Xs(!1),i({title:"تم تحديث حالة الدين",description:"تم تعيين الدين كمدفوع"})}},className:"bg-green-500 hover:bg-green-600",children:"مدفوع"}),e.jsx(h,{onClick:async()=>{if(ge){const t=Ct.filter(a=>a.id!==ge.id);us(t),await Ns(t),Xs(!1),i({title:"تم حذف الدين",description:"تم حذف الدين بنجاح"})}},variant:"destructive",children:"حذف"})]})]})}),e.jsx(de,{open:Vc,onOpenChange:Xa,children:e.jsxs(me,{className:"sm:max-w-md rounded-2xl shadow-elegant border border-gray-200",children:[e.jsxs(he,{children:[e.jsx(ue,{className:`text-right ${fa==="decrease"?"text-red-600":"text-green-600"}`,children:fa==="decrease"?"إنقاص مبلغ الدين":fa==="increase"?"زيادة مبلغ الدين":"تعديل مبلغ الدين"}),e.jsxs(ss,{className:"text-right",children:["أدخل المبلغ ثم اضغط تأكيد لإتمام ",fa==="decrease"?"الإنقاص":"الزيادة","."]})]}),e.jsxs("div",{className:"grid gap-4 py-2",children:[e.jsx(H,{htmlFor:"debtAdjustAmount",className:"text-right",children:"المبلغ (جنيه)"}),e.jsx(U,{id:"debtAdjustAmount",type:"number",placeholder:"0.00",value:cl,onChange:t=>$n(t.target.value)}),ge&&e.jsxs("div",{className:"text-right text-sm text-muted-foreground",children:["المبلغ الحالي: ",e.jsx("span",{className:"font-semibold",children:Number(ge.amount||0).toFixed(2)})," جنيه"]})]}),e.jsxs(rt,{className:"flex gap-2",children:[e.jsx(h,{variant:"secondary",onClick:()=>{Xa(!1),Xs(!0)},children:"إلغاء"}),e.jsx(h,{className:fa==="decrease"?"bg-red-600 hover:bg-red-700":"bg-green-600 hover:bg-green-700",onClick:async()=>{try{if(!ge||!fa)return;const t=Number(parseFloat(cl||"0").toFixed(2));if(!t||isNaN(t)||t<=0){i({title:"قيمة غير صالحة",description:"يرجى إدخال مبلغ أكبر من صفر",variant:"destructive"});return}dl({debtId:ge.id,delta:t,type:fa}),Xa(!1),tr(!0)}catch(t){console.error("فشل تجهيز تعديل مبلغ الدين:",t),i({title:"خطأ",description:"تعذّر تجهيز تعديل مبلغ الدين",variant:"destructive"})}},children:"تأكيد"})]})]})}),e.jsx(de,{open:Gc,onOpenChange:Wa,children:e.jsxs(me,{className:"sm:max-w-[480px]",children:[e.jsxs(he,{children:[e.jsx(ue,{className:"text-right",children:"اختيار إضافة مبلغ السداد"}),e.jsx(ss,{className:"text-right",children:"هل تريد إضافة مبلغ السداد إلى الفلوس النقدية أم إلى إحدى المحافظ؟"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex flex-wrap gap-2 justify-center",children:[e.jsx(h,{variant:fs==="cash"?"default":"outline",className:fs==="cash"?"bg-blue-600 text-white":"",size:"sm",onClick:()=>ea("cash"),children:"الفلوس النقدية"}),e.jsx(h,{variant:fs==="wallet"?"default":"outline",className:fs==="wallet"?"bg-blue-600 text-white":"",size:"sm",onClick:()=>ea("wallet"),children:"أرصدة المحافظ"}),e.jsx(h,{variant:fs==="fawry"?"default":"outline",className:fs==="fawry"?"bg-amber-600 text-white":"",size:"sm",onClick:()=>ea("fawry"),children:"فوري"}),e.jsx(h,{variant:fs==="none"?"default":"outline",className:fs==="none"?"bg-gray-600 text-white":"",size:"sm",onClick:()=>ea("none"),children:"بدون إضافة"})]}),fs==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-right",children:"اختر المحفظة"}),e.jsxs("select",{className:"w-full border rounded p-2 text-right",value:ya,onChange:t=>ti(t.target.value),children:[e.jsx("option",{value:"",children:"— اختر محفظة —"}),Be&&Be.length>0?Be.map(t=>e.jsx("option",{value:t.id,children:t.phone||t.name||t.id},t.id)):Object.keys($e||{}).map(t=>{var a,r,l,c,m,x;return e.jsx("option",{value:t,children:((a=Be.find(f=>f.id===t))==null?void 0:a.phone)||((l=(r=JSON.parse(localStorage.getItem(hi())||"[]"))==null?void 0:r.find(f=>f.id===t))==null?void 0:l.phone)||((m=(c=JSON.parse(localStorage.getItem(hi())||"[]"))==null?void 0:c.find(f=>f.id===t))==null?void 0:m.name)||((x=Be.find(f=>f.id===t))==null?void 0:x.name)||t},t)})]})]}),e.jsxs("div",{className:"text-right text-sm text-gray-600",children:["المبلغ المراد إضافته: ",e.jsxs("span",{className:"font-bold",children:[yl," جنيه"]})]})]}),e.jsxs(rt,{className:"flex flex-wrap justify-between gap-2",children:[e.jsx(h,{variant:"outline",onClick:()=>{Wa(!1),Mr(0),ea(null),ti("")},children:"إلغاء"}),e.jsx(h,{onClick:async()=>{var t,a;try{const r=yl;if(!r||r<=0){Wa(!1);return}if(fs==="cash"){const l=ht+r;zt(l),localStorage.setItem(js(),l.toString());const c={cashBalance:l,lastUpdated:new Date().toISOString()},m=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(m,JSON.stringify(c)),s!=null&&s.uid?(Ae.updateUserData(s.uid,c).catch(()=>ke(!0)),localStorage.removeItem(m),ke(!1)):ke(!0),i({title:"تمت إضافة مبلغ السداد",description:`تمت إضافة ${r} جنيه إلى الفلوس النقدية`})}else if(fs==="wallet"){if(!ya){i({title:"اختر محفظة أولاً",description:"يرجى اختيار المحفظة لإضافة مبلغ السداد إليها",variant:"destructive"});return}const l={...$e,[ya]:($e[ya]||0)+r};Qt(l);const c=(ht||0)-r;zt(c),localStorage.setItem(js(),c.toString());const m=new Date().toISOString(),x={walletBalances:l,cashBalance:c,lastUpdated:m},f=`userData_${s==null?void 0:s.uid}`;if(localStorage.setItem(f,JSON.stringify(x)),localStorage.setItem(ps(),JSON.stringify(l)),localStorage.setItem(`walletBalances_backup_${m}`,JSON.stringify(l)),s!=null&&s.uid){Ae.updateUserData(s.uid,x).catch(()=>ke(!0));try{localStorage.removeItem(f)}catch{}ke(!1)}else ke(!0);i({title:"تمت إضافة مبلغ السداد",description:`تمت إضافة ${r} جنيه إلى المحفظة ${((t=Be.find(I=>I.id===ya))==null?void 0:t.phone)||((a=Be.find(I=>I.id===ya))==null?void 0:a.name)||ya} وتم خصم نفس المبلغ من درج النقدية`})}else if(fs==="none"){const l=(ht||0)-r;zt(l),localStorage.setItem(js(),l.toString());const c={cashBalance:l,lastUpdated:new Date().toISOString()},m=`userData_${s==null?void 0:s.uid}`;if(localStorage.setItem(m,JSON.stringify(c)),s!=null&&s.uid){Ae.updateUserData(s.uid,c).catch(()=>ke(!0));try{localStorage.removeItem(m)}catch{}ke(!1)}else ke(!0);i({title:"تم تسجيل السداد",description:`تم خصم ${r} جنيه من درج النقدية بدون إضافة للمحافظ`})}else if(fs==="fawry")i({title:"تم تسجيل سداد عبر فوري",description:`تم تسجيل ${r} جنيه كسداد عبر فوري بدون تعديل الأرصدة`});else{i({title:"اختر مصدر الإضافة",description:"يرجى اختيار إضافة المبلغ إلى النقدية أو المحفظة",variant:"destructive"});return}}catch(r){console.error("خطأ أثناء إضافة مبلغ السداد:",r),i({title:"حدث خطأ",description:"تعذر إضافة مبلغ السداد، حاول مرة أخرى",variant:"destructive"})}finally{Wa(!1),Mr(0),ea(null),ti("")}},className:"bg-green-600 hover:bg-green-700",children:"تأكيد الإضافة"})]})]})}),e.jsx(de,{open:Cc,onOpenChange:pa,children:e.jsxs(me,{hideClose:!0,className:"post-confirm-card sm:max-w-[420px] w-[90vw] rounded-2xl bg-gradient-to-br from-white via-indigo-50 to-blue-50 shadow-2xl border border-indigo-100",children:[e.jsxs(he,{children:[e.jsx(ue,{className:"text-right text-2xl font-bold",children:(Ut==null?void 0:Ut.type)==="transfer"?"مبلغ يجب استلامه":"مبلغ يجب تسليمه"}),e.jsx(ss,{className:"text-right text-gray-600",children:(Ut==null?void 0:Ut.type)==="transfer"?"هذا هو المبلغ الواجب استلامه من العميل بعد التأكيد.":"هذا هو المبلغ الواجب تسليمه للعميل بعد التأكيد."})]}),e.jsxs("div",{className:"py-3 flex flex-col items-center gap-1.5",children:[e.jsxs("div",{className:"text-xl sm:text-2xl font-bold text-blue-700 tracking-wide",children:[ys((Ut==null?void 0:Ut.amount)||0)," جنيه"]}),e.jsx("div",{className:"text-sm text-gray-500 text-right w-full",children:(Ut==null?void 0:Ut.type)==="transfer"?"المبلغ المعروض شامل عمولة التحويل.":dt?"العمولة مضافة ولا تؤثر على قيمة التسليم.":"العمولة مخصومة من المبلغ المسلّم للعميل."})]}),e.jsxs(rt,{className:"flex justify-end gap-2",children:[(Ut==null?void 0:Ut.type)==="transfer"&&e.jsx(h,{variant:"outline",id:"sendCodeBtn",onClick:jt,disabled:Zi,className:"btn-transfer-confirm",children:Zi?"جارٍ الإرسال...":"إرسال كود التحويل"}),e.jsx(h,{onClick:()=>{pa(!1),_n(null)},className:"bg-green-600 hover:bg-green-700 text-white",children:(Ut==null?void 0:Ut.type)==="transfer"?"تم الاستلام":"تم التسليم"})]})]})}),e.jsx(Fm,{open:Ac,onClose:()=>Oa(!1),onSubmit:Kt,deviceId:Xi||vt||"",recipientMsisdn:String(ie==="transfer"?(hs==null?void 0:hs.receiver)||os||"":((Zl=Be.find(t=>t.id===Z))==null?void 0:Zl.phone)||"").replace(/\D/g,"")}),e.jsx(Ah,{open:_,onOpenChange:oe}),!1]}))};export{Mu as default};
