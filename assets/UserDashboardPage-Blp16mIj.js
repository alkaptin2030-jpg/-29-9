const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-Bc0KmgLq.js","assets/index-BnIBmMzz.css","assets/walletDailyLimitsService-Dzg49hMn.js","assets/profitService-WOL_cZ8K.js","assets/reportsService-Bp1Io21u.js"])))=>i.map(i=>d[i]);
var Zo=Object.defineProperty;var Xo=(l,m,i)=>m in l?Zo(l,m,{enumerable:!0,configurable:!0,writable:!0,value:i}):l[m]=i;var ln=(l,m,i)=>Xo(l,typeof m!="symbol"?m+"":m,i);import{c as os,A as ec,B as tc,u as ys,r as a,j as e,a7 as Ca,Q as sa,a5 as Is,aY as ur,C as zs,d as cs,a as $l,a6 as kt,a0 as Rl,$ as Ul,_ as Cs,aO as cr,R as et,a4 as xn,f as ns,g as ht,v as Fs,F as wa,n as sc,S as fs,W as Ia,q as $s,a3 as Bt,h as Rs,a8 as yn,Z as aa,k as ls,aV as ac,G as rc,H as _l,K as nc,aZ as lc,y as Ks,aB as kl,a_ as zl,an as De,D as ic,az as oc,aU as cc,p as dc,m as mc,Y as ja,aC as hc,aD as uc,aT as xc,e as Al,aA as rr,w as nr}from"./index-Bc0KmgLq.js";import{C as tt,a as Dt,b as Lt,d as rt}from"./card-DCvwPkwF.js";import{B as c,b as Jl}from"./button-C9dJa-5M.js";import{I as R}from"./input-Bjc_Nieb.js";import{B as Nt}from"./badge-BHrwvl14.js";import{S as Es,a as Ms,b as Bs,c as Ls,d as rs,C as jn,e as Kl}from"./select-BiUzrBdR.js";import{D as me,a as he,b as ue,c as xe,f as pc,e as Vt,d as Ce,g as ql,T as gc,O as fc,W as vc,C as bc,h as yc,i as jc,j as Vl,R as Nc,P as wc}from"./dialog-CFDYDZsR.js";import{L as V}from"./label-TPVQqp1H.js";import{M as Xt,a as Yt}from"./MasterPinDialog-D2IqG1VJ.js";import{walletDailyLimitsService as vs}from"./walletDailyLimitsService-Dzg49hMn.js";import{T as _t,P as dr}from"./progress-XuO-xMsa.js";import{W as is}from"./wallet-BvrixK4H.js";import{S as Yl}from"./star-OhJjBMjV.js";import{S as Hl}from"./square-pen-ClIcUr4p.js";import{P as bs}from"./phone-DLKytyD3.js";import{A as Gl}from"./arrow-left-C861yiT6.js";import{a as pn,S as Sc}from"./separator-CW4lrfX_.js";import{C as Ts}from"./calendar-Cyt6QFbl.js";import{C as gn}from"./chart-column-Dy2I9CWj.js";import{D as nt}from"./dollar-sign-CYMwS7tY.js";import{A as on,B as Pl,T as Dc}from"./textarea-CtfMbrHD.js";import{C as qs}from"./circle-alert-BxB0O43n.js";import{C as Nn}from"./circle-x-E4Q2gbYg.js";import{C as _s}from"./circle-check-big-DAuL8CCJ.js";import{a as Ue,E as Ct}from"./eye-DLo0H5EI.js";import{S as Cc}from"./store-CoTsmKKB.js";import{A as Ic}from"./arrow-right-BS49TNsa.js";import{U as fn}from"./user-9Jc2reFZ.js";import{c as Tc,C as Ql,a as kc,R as Ac,P as Ol,b as Pc,M as Oc}from"./PasswordConfirmDialog-B3LYhmNu.js";import{L as Js}from"./lock-CXY8Ww2V.js";import{M as Us}from"./minus-BVZdu67O.js";import{w as Wc,W as Fc}from"./WalletsManagement-3Ft57pRY.js";import{reportsService as qt}from"./reportsService-Bp1Io21u.js";import{P as Ec}from"./ProfileIcon-C63vUq31.js";import{a as Mc,E as Bc}from"./broadcastService-D0fgSqOb.js";import{D as Lc,a as $c,b as Rc,c as Uc,d as _c}from"./dropdown-menu-CxsXzXTq.js";import{S as cn}from"./shield-QXyUSGcS.js";import{G as zc}from"./gift-U5fH9Cp2.js";import{ProfitService as es}from"./profitService-WOL_cZ8K.js";import{D as Jc}from"./index.esm-C-8jssIf.js";import{R as Kc}from"./refresh-cw-DB9P_Ko3.js";import"./index-GaIHoRb_.js";import"./Combination-3SXkyoBR.js";import"./index-CailvHQC.js";import"./whatsappService-Ctls2BhH.js";import"./avatars-DjRrutoh.js";import"./index-DCgbwvVD.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const mr=os("ArrowDownLeft",[["path",{d:"M17 7 7 17",key:"15tmo1"}],["path",{d:"M17 17H7V7",key:"1org7z"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Zl=os("ArrowRightLeft",[["path",{d:"m16 3 4 4-4 4",key:"1x1c3m"}],["path",{d:"M20 7H4",key:"zbl0bi"}],["path",{d:"m8 21-4-4 4-4",key:"h9nckh"}],["path",{d:"M4 17h16",key:"g4d7ey"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qc=os("Award",[["path",{d:"m15.477 12.89 1.515 8.526a.5.5 0 0 1-.81.47l-3.58-2.687a1 1 0 0 0-1.197 0l-3.586 2.686a.5.5 0 0 1-.81-.469l1.514-8.526",key:"1yiouv"}],["circle",{cx:"12",cy:"8",r:"6",key:"1vp47v"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Vc=os("Banknote",[["rect",{width:"20",height:"12",x:"2",y:"6",rx:"2",key:"9lu3g6"}],["circle",{cx:"12",cy:"12",r:"2",key:"1c9p78"}],["path",{d:"M6 12h.01M18 12h.01",key:"113zkx"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Yc=os("BookOpen",[["path",{d:"M12 7v14",key:"1akyts"}],["path",{d:"M3 18a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h5a4 4 0 0 1 4 4 4 4 0 0 1 4-4h5a1 1 0 0 1 1 1v13a1 1 0 0 1-1 1h-6a3 3 0 0 0-3 3 3 3 0 0 0-3-3z",key:"ruj8y"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Xl=os("Building",[["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",ry:"2",key:"76otgf"}],["path",{d:"M9 22v-4h6v4",key:"r93iot"}],["path",{d:"M8 6h.01",key:"1dz90k"}],["path",{d:"M16 6h.01",key:"1x0f13"}],["path",{d:"M12 6h.01",key:"1vi96p"}],["path",{d:"M12 10h.01",key:"1nrarc"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M16 10h.01",key:"1m94wz"}],["path",{d:"M16 14h.01",key:"1gbofw"}],["path",{d:"M8 10h.01",key:"19clt8"}],["path",{d:"M8 14h.01",key:"6423bh"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const hr=os("IdCard",[["path",{d:"M16 10h2",key:"8sgtl7"}],["path",{d:"M16 14h2",key:"epxaof"}],["path",{d:"M6.17 15a3 3 0 0 1 5.66 0",key:"n6f512"}],["circle",{cx:"9",cy:"11",r:"2",key:"yxgjnd"}],["rect",{x:"2",y:"5",width:"20",height:"14",rx:"2",key:"qneu4z"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const vn=os("Info",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const lr=os("Package",[["path",{d:"M11 21.73a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73z",key:"1a0edw"}],["path",{d:"M12 22V12",key:"d0xqtd"}],["path",{d:"m3.3 7 7.703 4.734a2 2 0 0 0 1.994 0L20.7 7",key:"yx3hmr"}],["path",{d:"m7.5 4.27 9 5.15",key:"1c824w"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Sa=os("TrendingDown",[["polyline",{points:"22 17 13.5 8.5 8.5 13.5 2 7",key:"1r2t7k"}],["polyline",{points:"16 17 22 17 22 11",key:"11uiuu"}]]),Hc=async(l={})=>{try{return(await ec(tc,"getLastTransactions")(l)).data}catch(m){throw console.error("Error getting last transactions:",m),m.code==="functions/unauthenticated"?new Error("يجب تسجيل الدخول للوصول إلى المعاملات"):m.code==="functions/invalid-argument"?new Error("بيانات الاستعلام غير صالحة: "+m.message):m.code==="functions/permission-denied"?new Error("ليس لديك صلاحية للوصول إلى هذه المعاملات: "+m.message):new Error("حدث خطأ أثناء جلب المعاملات: "+(m.message||"خطأ غير معروف"))}},Gc=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],Qc=({isOpen:l,onClose:m,onWalletSelect:i,onEditWallet:x,onDeleteWallet:b})=>{const{user:g}=ys(),[t,W]=a.useState([]),[S,p]=a.useState(!1),h=()=>`wallets_${(g==null?void 0:g.uid)||"default"}`,N=()=>{try{const D=h(),U=localStorage.getItem(D);if(U){const ee=JSON.parse(U);if(Array.isArray(ee)&&ee.length>0)return ee}const H="wallets_default",$=localStorage.getItem(H);if($){const ee=JSON.parse($);if(Array.isArray(ee)&&ee.length>0){localStorage.setItem(D,$);try{localStorage.removeItem(H)}catch{}return ee}}const C=Object.keys(localStorage).filter(ee=>ee.startsWith("wallets_")&&ee!==D);let _=null,ae=null;for(const ee of C)try{const fe=localStorage.getItem(ee);if(!fe)continue;const J=JSON.parse(fe);Array.isArray(J)&&J.length>0&&(!_||J.length>((_==null?void 0:_.length)||0))&&(_=J,ae=ee)}catch{}if(_&&ae){localStorage.setItem(D,JSON.stringify(_));try{localStorage.removeItem(ae)}catch{}return _}}catch(D){console.warn("WalletsViewPage migration failed:",D)}return null},y=async(D,U)=>{const H=new Date().getMonth(),$=new Date().getFullYear(),C=U.filter(J=>{const A=new Date(J.createdAt);return A.getMonth()===H&&A.getFullYear()===$&&J.lineId===D}),_=J=>{const A=J.type;return J.txnType==="receive"||A==="withdraw"||A==="withdrawal"||A==="receive"},ae=J=>{const A=J.type;return J.txnType==="send"||A==="send"||A==="transfer"},ee=C.filter(_).reduce((J,A)=>{const ne=A.withdrawnAmount!==void 0?A.withdrawnAmount:A.amount;return J+(ne||0)},0),fe=C.filter(ae).reduce((J,A)=>{const ne=A.sentAmount!==void 0?A.sentAmount:A.amount;return J+(ne||0)},0);return{withdrawalUsage:ee,transferUsage:fe}},F=D=>{const U=new Date().toISOString().split("T")[0],H=D.lastResetDate;if(!H)return{...D,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:U};const $=new Date(H),C=new Date;return $.getMonth()!==C.getMonth()||$.getFullYear()!==C.getFullYear()?{...D,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:U}:D};a.useEffect(()=>{if(!(g!=null&&g.uid)||!l)return;(async()=>{p(!0);try{const U=await Is.getByMerchantId(g.uid),H=await ur.getByUserId(g.uid),C=(await Promise.all(U.map(async _=>{const{withdrawalUsage:ae,transferUsage:ee}=await y(_.id,H);return{id:_.id,name:_.label||"محفظة بدون اسم",phone:_.msisdn,nationalId:_.nationalId||"",isDefault:!1,monthlyWithdrawalLimit:_.withdrawLimit||2e5,monthlyTransferLimit:_.transferLimit||2e5,monthlyWithdrawalUsage:ae,monthlyTransferUsage:ee,lastResetDate:new Date().toISOString().split("T")[0],walletProvider:_.walletProvider||""}}))).map(F);if(W(C),!C||C.length===0){const _=N();_&&_.length>0&&W(_.map(F))}}catch(U){console.error("Error loading wallets:",U);const H=N();H&&W(H.map($=>({...$,phone:$.phone||$.phoneNumber,monthlyWithdrawalLimit:$.monthlyWithdrawalLimit||2e5,monthlyTransferLimit:$.monthlyTransferLimit||2e5})))}finally{p(!1)}})()},[g==null?void 0:g.uid,l]);const z=D=>Gc.find(U=>U.id===D),Z=(D,U)=>U>0?Math.min(D/U*100,100):0,L=D=>new Intl.NumberFormat("ar-EG").format(D);return e.jsx(me,{open:l,onOpenChange:m,children:e.jsxs(he,{className:"max-w-6xl max-h-[90vh] overflow-y-auto",children:[e.jsx(ue,{className:"pb-4",children:e.jsxs(xe,{className:"flex items-center gap-2 text-lg",children:[e.jsx(is,{className:"h-5 w-5"}),"الاطلاع على جميع المحافظ",e.jsxs(Nt,{variant:"secondary",className:"mr-2",children:[t.length," محفظة"]})]})}),S?e.jsx("div",{className:"flex justify-center items-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-600",children:"جاري تحميل المحافظ..."})]})}):t.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(is,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"لا توجد محافظ مضافة حتى الآن"})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:t.map(D=>{const U=z(D.walletProvider||""),H=Z(D.monthlyWithdrawalUsage||0,D.monthlyWithdrawalLimit),$=Z(D.monthlyTransferUsage||0,D.monthlyTransferLimit);return e.jsxs(tt,{className:"cursor-pointer hover:shadow-lg transition-shadow border-2 hover:border-blue-300",onClick:()=>i(D),children:[e.jsx(Dt,{className:"pb-3",children:e.jsxs(Lt,{className:"flex items-center justify-between text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ca,{className:"h-4 w-4"}),e.jsx("span",{children:D.name})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[D.isDefault&&e.jsxs(Nt,{variant:"default",className:"text-xs",children:[e.jsx(Yl,{className:"h-3 w-3 mr-1"}),"افتراضية"]}),e.jsx(c,{variant:"ghost",size:"sm",onClick:C=>{C.stopPropagation(),x==null||x(D)},className:"h-7 px-2",children:e.jsx(Hl,{className:"h-4 w-4"})}),e.jsx(c,{variant:"ghost",size:"sm",onClick:C=>{C.stopPropagation(),b==null||b(D.id)},className:"h-7 px-2 text-destructive hover:text-destructive",children:e.jsx(_t,{className:"h-4 w-4"})})]})]})}),e.jsxs(rt,{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(bs,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"font-mono",children:D.phone})]}),D.nationalId&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(hr,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"font-mono",children:D.nationalId})]}),U&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Xl,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{children:U.name})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Sa,{className:"h-3 w-3 text-red-500"}),"السحب الشهري"]}),e.jsxs("span",{className:"font-mono",children:[L(D.monthlyWithdrawalUsage||0)," / ",L(D.monthlyWithdrawalLimit)]})]}),e.jsx(dr,{value:H,className:"h-2"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(sa,{className:"h-3 w-3 text-green-500"}),"التحويل الشهري"]}),e.jsxs("span",{className:"font-mono",children:[L(D.monthlyTransferUsage||0)," / ",L(D.monthlyTransferLimit)]})]}),e.jsx(dr,{value:$,className:"h-2"})]}),e.jsx(c,{variant:"outline",size:"sm",className:"w-full text-xs",onClick:C=>{C.stopPropagation(),i(D)},children:"عرض التفاصيل الكاملة"})]})]},D.id)})}),e.jsx("div",{className:"flex justify-end pt-4 border-t",children:e.jsxs(c,{onClick:m,variant:"outline",children:[e.jsx(Gl,{className:"h-4 w-4 mr-2"}),"إغلاق"]})})]})})},Zc=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],Xc=({wallet:l,isOpen:m,onClose:i,onBack:x})=>{const{user:b}=ys(),[g,t]=a.useState([]),[W,S]=a.useState(!1),[p,h]=a.useState("month");if(a.useEffect(()=>{if(!l||!(b!=null&&b.uid)||!m)return;(async()=>{S(!0);try{const Pe=(await ur.getByUserId(b.uid)).filter(Ve=>Ve.walletId===l.id).sort((Ve,It)=>new Date(It.createdAt).getTime()-new Date(Ve.createdAt).getTime());t(Pe)}catch(ie){console.error("Error loading transactions:",ie)}finally{S(!1)}})()},[l,b==null?void 0:b.uid,m]),!l)return null;const N=q=>Zc.find(ie=>ie.id===q),y=(q,ie)=>ie>0?Math.min(q/ie*100,100):0,F=q=>new Intl.NumberFormat("ar-EG").format(q),z=q=>new Date(q).toLocaleDateString("ar-EG",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}),L=(()=>{const q=new Date;let ie;switch(p){case"week":ie=new Date(q.getTime()-7*24*60*60*1e3);break;case"month":ie=new Date(q.getFullYear(),q.getMonth(),1);break;default:return g}return g.filter(Pe=>new Date(Pe.createdAt)>=ie)})(),D=q=>{const ie=q.type,Pe=q.txnType;return ie==="withdraw"||ie==="withdrawal"||ie==="receive"||Pe==="receive"},U=q=>{const ie=q.type,Pe=q.txnType;return ie==="send"||ie==="transfer"||Pe==="send"},H=L.filter(q=>D(q)&&q.status==="completed").reduce((q,ie)=>{const Pe=ie.withdrawnAmount!==void 0?ie.withdrawnAmount:ie.amount;return q+(Pe||0)},0),$=L.filter(q=>U(q)&&q.status==="completed").reduce((q,ie)=>{const Pe=ie.sentAmount!==void 0?ie.sentAmount:ie.amount;return q+(Pe||0)},0),C=L.filter(q=>q.type==="deposit"&&q.status==="completed").reduce((q,ie)=>q+ie.amount,0),_=N(l.walletProvider||""),ae=y(l.monthlyWithdrawalUsage||0,l.monthlyWithdrawalLimit),ee=y(l.monthlyTransferUsage||0,l.monthlyTransferLimit),fe=q=>{switch(q){case"withdrawal":return e.jsx(Sa,{className:"h-4 w-4 text-red-500"});case"transfer":return e.jsx(sa,{className:"h-4 w-4 text-blue-500"});case"deposit":return e.jsx(nt,{className:"h-4 w-4 text-green-500"});default:return e.jsx(on,{className:"h-4 w-4 text-gray-500"})}},J=q=>{switch(q){case"completed":return e.jsx(_s,{className:"h-4 w-4 text-green-500"});case"pending":return e.jsx(zs,{className:"h-4 w-4 text-yellow-500"});case"failed":return e.jsx(Nn,{className:"h-4 w-4 text-red-500"});default:return e.jsx(qs,{className:"h-4 w-4 text-gray-500"})}},A=q=>{switch(q){case"withdrawal":return"سحب";case"transfer":return"تحويل";case"deposit":return"إيداع";default:return"معاملة"}},ne=q=>{switch(q){case"completed":return"مكتملة";case"pending":return"قيد الانتظار";case"failed":return"فاشلة";default:return"غير محدد"}};return e.jsx(me,{open:m,onOpenChange:i,children:e.jsxs(he,{className:"max-w-6xl max-h-[90vh] overflow-y-auto",children:[e.jsx(ue,{className:"pb-4",children:e.jsxs(xe,{className:"flex items-center gap-2 text-lg",children:[e.jsx(Ca,{className:"h-5 w-5"}),"تفاصيل المحفظة: ",l.name,l.isDefault&&e.jsxs(Nt,{variant:"default",className:"mr-2",children:[e.jsx(Yl,{className:"h-3 w-3 mr-1"}),"افتراضية"]})]})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-1 space-y-4",children:[e.jsxs(tt,{children:[e.jsx(Dt,{children:e.jsxs(Lt,{className:"text-sm flex items-center gap-2",children:[e.jsx(hr,{className:"h-4 w-4"}),"المعلومات الأساسية"]})}),e.jsxs(rt,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(bs,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-mono",children:l.phone})]}),l.nationalId&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(hr,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-mono",children:l.nationalId})]}),_&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Xl,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{children:_.name})]}),e.jsxs("div",{className:"text-xs text-gray-600 pr-6",children:[e.jsxs("div",{children:["المالك: ",_.ownerName]}),e.jsxs("div",{className:"font-mono",children:["الرقم القومي: ",_.nationalId]})]})]}),l.lastResetDate&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Ts,{className:"h-4 w-4 text-gray-500"}),e.jsxs("span",{children:["آخر إعادة تعيين: ",new Date(l.lastResetDate).toLocaleDateString("ar-EG")]})]})]})]}),e.jsxs(tt,{children:[e.jsx(Dt,{children:e.jsxs(Lt,{className:"text-sm flex items-center gap-2",children:[e.jsx(gn,{className:"h-4 w-4"}),"حدود الاستخدام الشهري"]})}),e.jsxs(rt,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Sa,{className:"h-3 w-3 text-red-500"}),"السحب الشهري"]}),e.jsxs("span",{className:"font-mono",children:[F(l.monthlyWithdrawalUsage||0)," / ",F(l.monthlyWithdrawalLimit)]})]}),e.jsx(dr,{value:ae,className:"h-2"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["متبقي: ",F(l.monthlyWithdrawalLimit-(l.monthlyWithdrawalUsage||0))," جنيه"]})]}),e.jsx(pn,{}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(sa,{className:"h-3 w-3 text-green-500"}),"التحويل الشهري"]}),e.jsxs("span",{className:"font-mono",children:[F(l.monthlyTransferUsage||0)," / ",F(l.monthlyTransferLimit)]})]}),e.jsx(dr,{value:ee,className:"h-2"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["متبقي: ",F(l.monthlyTransferLimit-(l.monthlyTransferUsage||0))," جنيه"]})]})]})]})]}),e.jsxs("div",{className:"lg:col-span-2 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsx(tt,{children:e.jsxs(rt,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(Sa,{className:"h-5 w-5 text-red-500"})}),e.jsx("div",{className:"text-lg font-bold",children:F(H)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي السحب"})]})}),e.jsx(tt,{children:e.jsxs(rt,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(sa,{className:"h-5 w-5 text-blue-500"})}),e.jsx("div",{className:"text-lg font-bold",children:F($)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي التحويل"})]})}),e.jsx(tt,{children:e.jsxs(rt,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(nt,{className:"h-5 w-5 text-green-500"})}),e.jsx("div",{className:"text-lg font-bold",children:F(C)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي الإيداع"})]})})]}),e.jsxs(tt,{children:[e.jsx(Dt,{children:e.jsxs(Lt,{className:"text-sm flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(on,{className:"h-4 w-4"}),"سجل المعاملات"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(c,{size:"sm",variant:p==="week"?"default":"outline",onClick:()=>h("week"),className:"text-xs",children:"أسبوع"}),e.jsx(c,{size:"sm",variant:p==="month"?"default":"outline",onClick:()=>h("month"),className:"text-xs",children:"شهر"}),e.jsx(c,{size:"sm",variant:p==="all"?"default":"outline",onClick:()=>h("all"),className:"text-xs",children:"الكل"})]})]})}),e.jsx(rt,{children:W?e.jsx("div",{className:"flex justify-center items-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-600",children:"جاري تحميل المعاملات..."})]})}):L.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(on,{className:"h-8 w-8 text-gray-400 mx-auto mb-2"}),e.jsx("p",{className:"text-gray-600",children:"لا توجد معاملات في هذه الفترة"})]}):e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:L.map(q=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[fe(q.type),e.jsxs("div",{children:[e.jsxs("div",{className:"text-sm font-medium",children:[A(q.type)," - ",F(q.amount)," جنيه"]}),e.jsx("div",{className:"text-xs text-gray-600",children:z(q.createdAt)}),q.description&&e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:q.description})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[J(q.status),e.jsx("span",{className:"text-xs",children:ne(q.status)})]})]},q.id))})})]})]})]}),e.jsxs("div",{className:"flex justify-between pt-4 border-t",children:[e.jsxs(c,{onClick:x,variant:"outline",children:[e.jsx(Gl,{className:"h-4 w-4 mr-2"}),"العودة للمحافظ"]}),e.jsx(c,{onClick:i,variant:"outline",children:"إغلاق"})]})]})})},dn=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],ed=({isOpen:l,onClose:m,onWalletUpdate:i,initialEditingWallet:x})=>{const{toast:b}=cs(),{user:g}=ys(),t=$l(),[W,S]=a.useState([]),[p,h]=a.useState(!1),[N,y]=a.useState(null),[F,z]=a.useState(""),[Z,L]=a.useState(""),[D,U]=a.useState(""),[H,$]=a.useState(""),[C,_]=a.useState("200000"),[ae,ee]=a.useState("200000"),[fe,J]=a.useState("100000"),[A,ne]=a.useState("60000"),[q,ie]=a.useState(!1),[Pe,Ve]=a.useState(null),[It,_e]=a.useState(!1),[$t,st]=a.useState(!1),[lt,At]=a.useState(!1),[Ye,We]=a.useState(null),Tt=()=>`wallets_${(g==null?void 0:g.uid)||"default"}`;a.useEffect(()=>{x&&(y(x),h(!0),z(x.name||""),L(x.phone||""),U(x.nationalId||""),$(x.walletProvider||""),_((x.monthlyWithdrawalLimit||2e5).toString()),ee((x.monthlyTransferLimit||2e5).toString()),J((x.dailyWithdrawalLimit||1e5).toString()),ne((x.dailyTransferLimit||6e4).toString()),ie(!!x.isDefault))},[x]);const wt=P=>{const re=new Date,pe=re.getMonth(),Oe=re.getFullYear();if(!P.lastResetDate)return{...P,monthlyWithdrawalUsage:P.monthlyWithdrawalUsage||0,monthlyTransferUsage:P.monthlyTransferUsage||0,lastResetDate:re.toISOString().split("T")[0]};const Ie=new Date(P.lastResetDate),ze=Ie.getMonth(),M=Ie.getFullYear();return pe!==ze||Oe!==M?{...P,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:re.toISOString().split("T")[0]}:P},Ft=async(P,re)=>{const pe=new Date().getMonth(),Oe=new Date().getFullYear(),Ie=re.filter(le=>{const K=new Date(le.createdAt);return K.getMonth()===pe&&K.getFullYear()===Oe&&le.lineId===P}),ze=Ie.filter(le=>le.txnType==="receive").reduce((le,K)=>le+(K.amount||0),0),M=Ie.filter(le=>le.txnType==="send").reduce((le,K)=>le+(K.amount||0),0);return{withdrawalUsage:ze,transferUsage:M}},ft=async(P,re)=>{const pe=new Date,Oe=pe.getDate(),Ie=pe.getMonth(),ze=pe.getFullYear(),M=re.filter(Ne=>{const Le=new Date(Ne.createdAt);return Le.getDate()===Oe&&Le.getMonth()===Ie&&Le.getFullYear()===ze&&Ne.lineId===P}),le=M.filter(Ne=>Ne.txnType==="receive").reduce((Ne,Le)=>Ne+(Le.amount||0),0),K=M.filter(Ne=>Ne.txnType==="send").reduce((Ne,Le)=>Ne+(Le.amount||0),0);return{withdrawalUsage:le,transferUsage:K}};a.useEffect(()=>{(async()=>{if(!(g!=null&&g.uid)){console.log("No user authenticated, skipping wallet loading"),_e(!1);return}console.log("Loading wallets for user:",g.uid),_e(!0);try{const{auth:re}=await Cs(async()=>{const{auth:K}=await import("./index-Bc0KmgLq.js").then(Ne=>Ne.b0);return{auth:K}},__vite__mapDeps([0,1]));let pe=0;const Oe=5;for(;!re.currentUser&&pe<Oe;)console.log(`Waiting for auth state... attempt ${pe+1}`),await new Promise(K=>setTimeout(K,1e3)),pe++;if(!re.currentUser)throw console.error("User not authenticated in Firebase Auth after retries"),new Error("not authenticated");console.log("Firebase Auth User:",re.currentUser.uid),console.log("Context User:",g.uid),console.log("Fetching wallets from Firebase...");const Ie=await Is.getByMerchantId(g.uid);console.log("Fetched wallets:",Ie),console.log("Fetching transactions from Firebase...");const ze=await ur.getByUserId(g.uid);console.log("Fetched transactions:",ze);const le=(await Promise.all(Ie.map(async K=>{const{withdrawalUsage:Ne,transferUsage:Le}=await Ft(K.id,ze),{withdrawalUsage:ts,transferUsage:vt}=await ft(K.id,ze);return{id:K.id,name:K.label||"محفظة بدون اسم",phone:K.msisdn,isDefault:!1,monthlyWithdrawalLimit:K.withdrawLimit||2e5,monthlyTransferLimit:K.transferLimit||2e5,dailyWithdrawalLimit:K.dailyWithdrawLimit||1e5,dailyTransferLimit:K.dailyTransferLimit||6e4,monthlyWithdrawalUsage:Ne,monthlyTransferUsage:Le,dailyWithdrawalUsage:ts,dailyTransferUsage:vt,lastResetDate:new Date().toISOString().split("T")[0],defaultTransferCommission:K.defaultTransferCommission!=null?Number(K.defaultTransferCommission):null,defaultWithdrawCommission:K.defaultWithdrawCommission!=null?Number(K.defaultWithdrawCommission):null}}))).map(wt);S(le),console.log("Wallets loaded successfully:",le)}catch(re){console.error("Error loading wallets:",re),console.log("تم تحميل المحافظ من البيانات المحفوظة محلياً");const pe=localStorage.getItem(Tt());if(pe){const Oe=JSON.parse(pe);S(Oe.map(Ie=>({...Ie,phone:Ie.phone||Ie.phoneNumber,monthlyWithdrawalLimit:Ie.monthlyWithdrawalLimit||2e5,monthlyTransferLimit:Ie.monthlyTransferLimit||2e5})))}}finally{_e(!1)}})()},[g==null?void 0:g.uid]);const St=()=>{z(""),L(""),U(""),$(""),_("200000"),ee("200000"),J("100000"),ne("60000"),ie(!1),y(null),h(!1)},Rt=async()=>{if(!F.trim()||!Z.trim()||!H.trim()){b({title:"خطأ",description:"يرجى ملء جميع الحقول المطلوبة",variant:"destructive"});return}if(!(g!=null&&g.uid)){b({title:"خطأ",description:"يجب تسجيل الدخول أولاً",variant:"destructive"});return}_e(!0);try{if(N){await Is.update(N.id,{label:F.trim(),msisdn:Z.trim(),withdrawLimit:parseInt(C),transferLimit:parseInt(ae),dailyWithdrawLimit:parseInt(fe),dailyTransferLimit:parseInt(A)}),await vs.setLimits(N.id,{dailyTransferLimit:parseInt(A||"0"),dailyWithdrawLimit:parseInt(fe||"0"),monthlyTransferLimit:parseInt(ae||"0"),monthlyWithdrawLimit:parseInt(C||"0")});const P=W.map(re=>re.id===N.id?{...re,name:F.trim(),phone:Z.trim(),nationalId:D.trim(),walletProvider:H,monthlyWithdrawalLimit:parseInt(C),monthlyTransferLimit:parseInt(ae),dailyWithdrawalLimit:parseInt(fe),dailyTransferLimit:parseInt(A)}:re);S(P),localStorage.setItem(Tt(),JSON.stringify(P)),b({title:"تم التحديث",description:"تم تحديث المحفظة بنجاح"})}else{const P={merchantUserId:g.uid,provider:H,msisdn:Z.trim(),label:F.trim(),isActive:!0,dailyLimit:2e5,monthlyLimit:2e5,withdrawLimit:parseInt(C),transferLimit:parseInt(ae),dailyTransferLimit:parseInt(A),dailyWithdrawLimit:parseInt(fe),dailyUsage:0,monthlyUsage:0,transferUsage:0,withdrawUsage:0},re=await Is.create(P);await vs.setLimits(re,{dailyTransferLimit:parseInt(A||"0"),dailyWithdrawLimit:parseInt(fe||"0"),monthlyTransferLimit:parseInt(ae||"0"),monthlyWithdrawLimit:parseInt(C||"0")});const pe=new Date().toISOString().split("T")[0],Oe={id:re,name:F.trim(),phone:Z.trim(),nationalId:D.trim(),walletProvider:H,isDefault:q,monthlyWithdrawalLimit:parseInt(C),monthlyTransferLimit:parseInt(ae),dailyWithdrawalLimit:parseInt(fe),dailyTransferLimit:parseInt(A),monthlyWithdrawalUsage:0,monthlyTransferUsage:0,dailyWithdrawalUsage:0,dailyTransferUsage:0,lastResetDate:pe,defaultTransferCommission:null,defaultWithdrawCommission:null},Ie=[...W,Oe];S(Ie),localStorage.setItem(Tt(),JSON.stringify(Ie)),b({title:"تم الإنشاء",description:"تم إنشاء المحفظة بنجاح"})}i&&i(),St(),h(!1),y(null)}catch(P){console.error("Error saving wallet:",P),b({title:"خطأ",description:"حدث خطأ أثناء حفظ المحفظة",variant:"destructive"})}finally{_e(!1)}},Ht=P=>{y(P),z(P.name),L(P.phone),U(P.nationalId||""),$(P.walletProvider||""),_(P.monthlyWithdrawalLimit.toString()),ee(P.monthlyTransferLimit.toString()),ie(P.isDefault),h(!0)},ds=async P=>{const re=W.find(pe=>pe.id===P);if(re!=null&&re.isDefault){b({title:"تحذير",description:"لا يمكن حذف المحفظة الافتراضية",variant:"destructive"});return}if(!(g!=null&&g.uid)){b({title:"خطأ",description:"يجب تسجيل الدخول أولاً",variant:"destructive"});return}_e(!0);try{await Is.delete(P);const pe=W.filter(Oe=>Oe.id!==P);S(pe),localStorage.setItem(Tt(),JSON.stringify(pe)),i&&i(),b({title:"تم الحذف",description:"تم حذف المحفظة بنجاح"})}catch(pe){console.error("Error deleting wallet:",pe),b({title:"خطأ",description:"حدث خطأ أثناء حذف المحفظة",variant:"destructive"})}finally{_e(!1)}},Et=P=>{const re=W.map(pe=>({...pe,isDefault:pe.id===P}));S(re),localStorage.setItem(Tt(),JSON.stringify(re)),i&&i(),b({title:"تم تحديث المحفظة الافتراضية",description:"تم تعيين المحفظة كافتراضية بنجاح"})};return e.jsxs(me,{open:l,onOpenChange:m,children:[e.jsxs(he,{className:"max-w-4xl max-h-[80vh] overflow-y-auto",children:[e.jsx(ue,{className:"pb-2",children:e.jsxs(xe,{className:"flex items-center gap-1 text-sm",children:[e.jsx(is,{className:"h-3 w-3"}),"إدارة المحافظ"]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h3",{className:"text-sm font-semibold",children:["المحافظ المتاحة (",W.length,")"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(c,{onClick:()=>At(!0),className:"flex items-center gap-1 h-6 px-2 text-xs",size:"sm",variant:"outline",children:[e.jsx(Ue,{className:"h-3 w-3"}),"الاطلاع على المحافظ"]}),e.jsxs(c,{onClick:()=>{m(),t("/user/add-wallet")},className:"flex items-center gap-1 h-6 px-2 text-xs",size:"sm",children:[e.jsx(kt,{className:"h-3 w-3"}),"إضافة محفظة جديدة"]})]})]}),(p||N)&&e.jsxs(tt,{className:"border-2 border-blue-200 bg-blue-50",children:[e.jsx(Dt,{className:"pb-1",children:e.jsx(Lt,{className:"text-sm",children:N?"تعديل المحفظة":"إضافة محفظة جديدة"})}),e.jsxs(rt,{className:"space-y-2 pt-1",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"شركة المحفظة"}),e.jsx("div",{className:"flex gap-1 items-center",children:e.jsxs(Es,{value:H,onValueChange:$,children:[e.jsx(Ms,{className:"h-6 text-xs flex-1",children:e.jsx(Bs,{placeholder:"اختر شركة المحفظة"})}),e.jsx(Ls,{children:dn.map(P=>e.jsx(rs,{value:P.id,className:"text-xs",children:e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsx("span",{children:P.name}),e.jsx("button",{type:"button",className:"h-4 w-4 p-0 ml-2 flex items-center justify-center hover:bg-blue-100 rounded",onClick:re=>{re.preventDefault(),re.stopPropagation(),Ve(P.id)},children:e.jsx(vn,{className:"h-3 w-3 text-blue-500 hover:text-blue-700"})})]})},P.id))})]})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"اسم المحفظة"}),e.jsx(R,{value:F,onChange:P=>z(P.target.value),placeholder:"مثال: محفظة العمل",className:"h-6 text-xs"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"رقم الهاتف"}),e.jsxs("div",{className:"relative",children:[e.jsx(bs,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(R,{value:Z,onChange:P=>L(P.target.value),placeholder:"01030302038",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الرقم القومي للخط"}),e.jsxs("div",{className:"relative",children:[e.jsx(hr,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(R,{value:D,onChange:P=>U(P.target.value),placeholder:"29012345678901",maxLength:14,className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد الشهري للسحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(nt,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(R,{type:"number",value:C,onChange:P=>_(P.target.value),placeholder:"200000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد الشهري للتحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(nt,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(R,{type:"number",value:ae,onChange:P=>ee(P.target.value),placeholder:"200000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد اليومي للسحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Sa,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-red-400"}),e.jsx(R,{type:"number",value:fe,onChange:P=>J(P.target.value),placeholder:"100000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد اليومي للتحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(sa,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-blue-400"}),e.jsx(R,{type:"number",value:A,onChange:P=>ne(P.target.value),placeholder:"60000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",id:"isDefault",checked:q,onChange:P=>ie(P.target.checked),className:"rounded w-3 h-3"}),e.jsx("label",{htmlFor:"isDefault",className:"text-xs font-medium text-gray-700",children:"تعيين كمحفظة افتراضية"})]}),e.jsx("div",{className:"border-t pt-2 mt-2",children:e.jsxs("div",{className:"flex items-center gap-1 mb-2",children:[e.jsx(Rl,{className:"h-3 w-3 text-gray-600"}),e.jsx("label",{className:"text-xs font-medium text-gray-700",children:"إعدادات العمولة"})]})}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(c,{onClick:Rt,className:"flex-1 h-6 text-xs",size:"sm",children:N?"تحديث المحفظة":"إضافة المحفظة"}),e.jsx(c,{variant:"outline",onClick:St,className:"h-6 text-xs",size:"sm",children:"إلغاء"})]})]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2",children:W.map(P=>{var re;return e.jsxs(tt,{className:`${P.isDefault?"border-green-300 bg-green-50":""}`,children:[e.jsx(Dt,{className:"pb-1",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Lt,{className:"text-sm flex items-center gap-1",children:[e.jsx(is,{className:"h-3 w-3"}),P.name]}),P.isDefault&&e.jsx(Nt,{variant:"default",className:"bg-green-600 text-xs px-1 py-0",children:"افتراضية"})]})}),e.jsxs(rt,{className:"space-y-1 pt-0",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(bs,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"text-xs",children:P.phone})]}),P.walletProvider&&e.jsx("div",{className:"text-xs text-blue-600 mt-1",children:((re=dn.find(pe=>pe.id===P.walletProvider))==null?void 0:re.name)||P.walletProvider}),e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-2 rounded-md border border-gray-200 shadow-sm space-y-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-gray-600 mb-1",children:"الحدود الشهرية"}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-red-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-red-400 to-red-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((P.monthlyWithdrawalUsage||0)/P.monthlyWithdrawalLimit*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-blue-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-400 to-blue-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((P.monthlyTransferUsage||0)/P.monthlyTransferLimit*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-xs text-red-600 font-medium",children:["متبقي سحب: ",Math.max(P.monthlyWithdrawalLimit-(P.monthlyWithdrawalUsage||0),0)," جنيه"]}),e.jsxs("div",{className:"text-xs text-blue-600 font-medium",children:["متبقي تحويل: ",Math.max(P.monthlyTransferLimit-(P.monthlyTransferUsage||0),0)," جنيه"]})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-gray-600 mb-1",children:"الحدود اليومية"}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-orange-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-orange-400 to-orange-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((P.dailyWithdrawalUsage||0)/P.dailyWithdrawalLimit*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-green-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-green-400 to-green-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((P.dailyTransferUsage||0)/P.dailyTransferLimit*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-xs text-orange-600 font-medium",children:["متبقي سحب يومي: ",Math.max(P.dailyWithdrawalLimit-(P.dailyWithdrawalUsage||0),0)," جنيه"]}),e.jsxs("div",{className:"text-xs text-green-600 font-medium",children:["متبقي تحويل يومي: ",Math.max(P.dailyTransferLimit-(P.dailyTransferUsage||0),0)," جنيه"]})]})]})]}),e.jsxs("div",{className:"flex gap-1 pt-1",children:[e.jsxs(c,{size:"sm",variant:"outline",onClick:()=>Ht(P),className:"flex-1 h-5 text-xs px-1",children:[e.jsx(Hl,{className:"h-2 w-2 mr-0.5"}),"تعديل"]}),!P.isDefault&&e.jsxs(e.Fragment,{children:[e.jsx(c,{size:"sm",variant:"outline",onClick:()=>Et(P.id),className:"flex-1 h-5 text-xs px-1",children:"جعلها افتراضية"}),e.jsx(c,{size:"sm",variant:"destructive",onClick:()=>ds(P.id),className:"h-5 px-1",children:e.jsx(_t,{className:"h-2 w-2"})})]})]})]})]},P.id)})}),W.length===0&&e.jsx("div",{className:"text-center py-4 text-gray-500 text-xs",children:"لا توجد محافظ متاحة. قم بإضافة محفظة جديدة للبدء."})]}),Pe&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-800",children:"معلومات صاحب المحفظة"}),e.jsx("button",{onClick:()=>Ve(null),className:"h-8 w-8 p-0 flex items-center justify-center hover:bg-gray-100 rounded-full transition-colors",children:e.jsx(Ul,{className:"h-4 w-4 text-gray-500"})})]}),(()=>{const P=dn.find(re=>re.id===Pe);return P?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-center mb-6",children:e.jsx("div",{className:"bg-blue-100 p-3 rounded-lg inline-block",children:e.jsx("h4",{className:"font-bold text-blue-700 text-lg",children:P.name})})}),e.jsx("div",{className:"bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-200",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-white p-3 rounded-lg shadow-sm",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full mr-2"}),e.jsx("span",{className:"font-semibold text-gray-700",children:"اسم صاحب المحفظة:"})]}),e.jsx("p",{className:"text-gray-900 font-medium text-lg mr-4",children:P.ownerName})]}),e.jsxs("div",{className:"bg-white p-3 rounded-lg shadow-sm",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full mr-2"}),e.jsx("span",{className:"font-semibold text-gray-700",children:"الرقم القومي:"})]}),e.jsx("p",{className:"text-gray-900 font-mono text-lg mr-4 tracking-wider",children:P.nationalId})]})]})}),e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 p-3 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(vn,{className:"h-4 w-4 text-yellow-600 mr-2"}),e.jsx("span",{className:"text-sm text-yellow-800 font-medium",children:"هذه البيانات مسجلة رسمياً في النظام لهذه المحفظة"})]})})]}):null})()]})})]}),e.jsx(Xt,{open:lt,onOpenChange:At,mode:"verify",title:"إدخال الرقم السري الرئيسي",description:"لا يمكن الاطلاع على المحافظ إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{At(!1),st(!0)}}),e.jsx(Qc,{isOpen:$t,onClose:()=>st(!1),onWalletSelect:P=>{We(P),st(!1)},onEditWallet:P=>{t(`/user/add-wallet?edit=1&id=${P.id}`),st(!1)},onDeleteWallet:async P=>{try{if(await Is.delete(P),S(re=>{const pe=re.filter(Oe=>Oe.id!==P);try{localStorage.setItem(Tt(),JSON.stringify(pe))}catch(Oe){console.error("Failed to update localStorage wallets after delete:",Oe)}return pe}),i)try{await i()}catch(re){console.error("onWalletUpdate callback failed:",re)}}catch(re){console.error("Error deleting wallet:",re)}}}),e.jsx(Xc,{wallet:Ye,isOpen:!!Ye,onClose:()=>We(null),onBack:()=>{We(null),st(!0)}})]})},td=({isOpen:l,onClose:m,transaction:i,onDelete:x})=>{if(!i)return null;const b=p=>{switch(p){case"completed":return e.jsx(_s,{className:"h-5 w-5 text-green-500"});case"pending":return e.jsx(zs,{className:"h-5 w-5 text-yellow-500"});case"failed":return e.jsx(Nn,{className:"h-5 w-5 text-red-500"});default:return e.jsx(zs,{className:"h-5 w-5 text-gray-500"})}},g=p=>{switch(p){case"completed":return"مكتملة";case"pending":return"قيد الانتظار";case"failed":return"فاشلة";default:return"غير معروف"}},t=p=>{switch(p){case"withdraw":return"سحب";case"send":return"إرسال";case"receive":return"استقبال";default:return"تحويل"}},W=()=>{const p=!!i.senderNumber,h=!!i.senderName,N=p?"الرقم المرسل:":h?"الرقم الراسل:":"رقم المحفظة:",y=p?i.senderNumber:h?i.senderName:i.senderPhone,F=`
      <div style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 500px; margin: 0 auto; padding: 30px; background: #fff;">
        <!-- Header -->
        <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #2563eb; padding-bottom: 20px;">
          <h1 style="color: #2563eb; margin-bottom: 5px; font-size: 28px;">إيصال المعاملة</h1>
          <p style="color: #666; font-size: 16px; margin: 0;">رقم المرجع: ${i.transactionReference||i.id}</p>
          <p style="color: #888; font-size: 14px; margin: 5px 0 0 0;">${new Date().toLocaleString("ar-EG")}</p>
        </div>
        
        <!-- Shop Info -->
        <div style="background: #f8fafc; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
          <h3 style="color: #1e293b; margin: 0 0 15px 0; font-size: 18px;">معلومات المحل</h3>
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span style="font-weight: 600; color: #475569;">اسم المحل:</span>
            <span style="color: #1e293b;">${i.merchantShopName||i.shopName||"غير محدد"}</span>
          </div>
        </div>
        
        <!-- Transaction Details -->
        <div style="background: #fff; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
          <h3 style="color: #1e293b; margin: 0 0 15px 0; font-size: 18px;">تفاصيل المعاملة</h3>
          
          <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
            <span style="font-weight: 600; color: #475569;">نوع المعاملة:</span>
            <span style="color: #2563eb; font-weight: 600;">${t(i.type)}</span>
          </div>
          
          <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
            <span style="font-weight: 600; color: #475569;">الحالة:</span>
            <span style="color: ${i.status==="completed"?"#16a34a":i.status==="pending"?"#ca8a04":"#dc2626"}; font-weight: 600;">
              ${g(i.status)}
            </span>
          </div>

          ${i!=null&&i.cashierName?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الكاشير:</span>
              <span style="color: #1e293b;">${i.cashierName}</span>
            </div>
          `:""}
          
          ${i.type!=="withdraw"?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">${N}</span>
              <span style="color: #1e293b;">${y}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الرقم المستقبل:</span>
              <span style="color: #1e293b;">${i.receiverNumber||i.receiverPhone}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">المبلغ المحول:</span>
              <span style="color: #2563eb; font-weight: bold; font-size: 16px;">${i.transferredAmount||i.amount} جنيه</span>
            </div>
          `:`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">رقم المحفظة:</span>
              <span style="color: #1e293b;">${i.senderPhone}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">المبلغ المسحوب:</span>
              <span style="color: #dc2626; font-weight: bold; font-size: 16px;">${i.withdrawnAmountDetailed||i.withdrawnAmount||i.amount} جنيه</span>
            </div>
          `}
          
          ${i.commission?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">العمولة:</span>
              <span style="color: #f59e0b; font-weight: 600;">${i.commission} جنيه</span>
            </div>
          `:""}
          ${i!=null&&i.fee&&Number(i.fee)>0?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الرسوم:</span>
              <span style="color: #64748b; font-weight: 600;">${i.fee} جنيه</span>
            </div>
          `:""}
          
          <div style="display: flex; justify-content: space-between; padding: 8px 0;">
            <span style="font-weight: 600; color: #475569;">التاريخ والوقت:</span>
            <span style="color: #1e293b;">${i.createdAt.toLocaleString("ar-EG")}</span>
          </div>
        </div>
        
        <!-- Total Amount -->
        <div style="background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); border-radius: 12px; padding: 20px; margin-bottom: 20px; text-align: center;">
          <h3 style="color: white; margin: 0 0 10px 0; font-size: 16px;">إجمالي المبلغ</h3>
          <p style="color: white; font-size: 24px; font-weight: bold; margin: 0;">
            ${i.type==="withdraw"?"-":""}${i.amount} جنيه
          </p>
        </div>
        
        
        
        
        <!-- Footer -->
        <div style="text-align: center; color: #64748b; font-size: 12px; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
          <p style="margin: 0 0 5px 0;">شكراً لاستخدام خدماتنا</p>
          <p style="margin: 0;">تم إنشاء الإيصال في: ${new Date().toLocaleString("ar-EG")}</p>
        </div>
      </div>
    `,z=window.open("","_blank");z&&(z.document.write(`
        <html>
          <head>
            <title>إيصال المعاملة - ${i.transactionReference||i.id}</title>
            <meta charset="UTF-8">
            <style>
              body { 
                margin: 0; 
                padding: 20px; 
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: #f8fafc;
              }
              @media print {
                body { 
                  margin: 0; 
                  background: white;
                }
              }
            </style>
          </head>
          <body>
            ${F}
          </body>
        </html>
      `),z.document.close(),z.print())},S=()=>{window.confirm("هل أنت متأكد من حذف هذه المعاملة؟ لا يمكن التراجع عن هذا الإجراء.")&&(x(i.id),m())};return e.jsx(me,{open:l,onOpenChange:m,children:e.jsxs(he,{className:"w-[92vw] sm:w-auto sm:max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx(ue,{children:e.jsxs(xe,{className:"flex items-center gap-2 text-xl",children:[e.jsx(cr,{className:"h-6 w-6 text-blue-600"}),"إيصال المعاملة المفصل"]})}),e.jsxs("div",{className:"space-y-6",children:[e.jsx(tt,{className:"bg-gradient-to-r from-blue-50 to-indigo-50 border-blue-200",children:e.jsxs(Dt,{className:"text-center pb-2",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 mb-2",children:[b(i.status),e.jsx(Nt,{variant:i.status==="completed"?"default":"secondary",className:"text-sm",children:g(i.status)})]}),e.jsxs("h3",{className:"text-2xl font-bold text-blue-600",children:[i.type==="withdraw"?"-":"",i.amount," جنيه"]}),e.jsxs("p",{className:"text-sm text-gray-600",children:["رقم المرجع: ",i.transactionReference||i.id]})]})}),e.jsxs(tt,{children:[e.jsx(Dt,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Cc,{className:"h-5 w-5 text-green-600"}),e.jsx("h4",{className:"font-semibold text-lg",children:"معلومات المحل"})]})}),e.jsxs(rt,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"اسم المحل:"}),e.jsx("span",{className:"text-gray-900",children:i.merchantShopName||i.shopName||"غير محدد"})]}),(i==null?void 0:i.cashierName)&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"الكاشير:"}),e.jsx("span",{className:"text-gray-900",children:i.cashierName})]})]})]}),e.jsxs(tt,{children:[e.jsx(Dt,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ca,{className:"h-5 w-5 text-blue-600"}),e.jsx("h4",{className:"font-semibold text-lg",children:"تفاصيل المعاملة"})]})}),e.jsx(rt,{className:"space-y-3",children:e.jsxs("div",{className:"grid grid-cols-1 gap-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-blue-700",children:"نوع المعاملة:"}),e.jsx(Nt,{variant:"outline",className:"bg-blue-100 text-blue-800",children:t(i.type)})]}),i.type!=="withdraw"?e.jsxs(e.Fragment,{children:[(()=>{const p=!!i.senderNumber,h=!!i.senderName,N=p?"الرقم المرسل:":h?"الرقم الراسل:":"رقم المحفظة:",y=p?i.senderNumber:h?i.senderName:i.senderPhone,F=p?fn:bs;return e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(F,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:N})]}),e.jsx("span",{className:"text-gray-900 font-mono",children:y})]})})(),e.jsx("div",{className:"flex items-center justify-center p-2",children:e.jsx(Ic,{className:"h-6 w-6 text-blue-500"})}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-green-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(fn,{className:"h-4 w-4 text-green-500"}),e.jsx("span",{className:"font-medium text-green-700",children:"الرقم المستقبل:"})]}),e.jsx("span",{className:"text-green-900 font-mono",children:i.receiverNumber||i.receiverPhone})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(nt,{className:"h-4 w-4 text-blue-500"}),e.jsx("span",{className:"font-medium text-blue-700",children:"المبلغ المحول:"})]}),e.jsxs("span",{className:"text-blue-900 font-bold text-lg",children:[i.transferredAmount||i.amount," جنيه"]})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(bs,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:"رقم المحفظة:"})]}),e.jsx("span",{className:"text-gray-900 font-mono",children:i.senderPhone})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-red-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(nt,{className:"h-4 w-4 text-red-500"}),e.jsx("span",{className:"font-medium text-red-700",children:"المبلغ المسحوب:"})]}),e.jsxs("span",{className:"text-red-900 font-bold text-lg",children:[i.withdrawnAmountDetailed||i.withdrawnAmount||i.amount," جنيه"]})]})]}),i.commission&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-yellow-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-yellow-700",children:"العمولة:"}),e.jsxs("span",{className:"text-yellow-900 font-semibold",children:[i.commission," جنيه"]})]}),(i==null?void 0:i.fee)&&Number(i.fee)>0&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"الرسوم:"}),e.jsxs("span",{className:"text-gray-900 font-semibold",children:[i.fee," جنيه"]})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ts,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:"التاريخ والوقت:"})]}),e.jsx("span",{className:"text-gray-900",children:i.createdAt.toLocaleString("ar-EG")})]})]})})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs(c,{onClick:W,className:"flex-1 bg-blue-600 hover:bg-blue-700 text-white",size:"lg",children:[e.jsx(Tc,{className:"h-5 w-5 mr-2"}),"طباعة الإيصال"]}),e.jsxs(c,{onClick:S,variant:"destructive",className:"flex-1",size:"lg",children:[e.jsx(_t,{className:"h-5 w-5 mr-2"}),"حذف المعاملة"]})]}),e.jsx(c,{onClick:m,variant:"outline",className:"w-full",size:"lg",children:"إغلاق الإيصال"})]})]})})};function Wl({open:l,onOpenChange:m,onSuccess:i,title:x,description:b,currentBalance:g,balanceLabel:t,userId:W}){const[S,p]=a.useState(""),[h,N]=a.useState(g.toString()),[y,F]=a.useState(!1),[z,Z]=a.useState(""),[L,D]=a.useState(!1),U=Yt.hasMasterPin(),H=async C=>{C.preventDefault(),Z(""),D(!0);try{const _=parseFloat(h);if(isNaN(_)||_<0){Z("يرجى إدخال مبلغ صحيح"),D(!1);return}U?Yt.verifyMasterPin(S)?(i(_),m(!1),p(""),N("")):Z("الرقم السري غير صحيح"):Z("لم يتم تعيين رقم سري رئيسي. يرجى تعيين رقم سري رئيسي أولاً من إعدادات التطبيق")}catch{Z("حدث خطأ أثناء التحقق من الرقم السري")}finally{D(!1)}},$=()=>{p(""),N(g.toString()),Z(""),m(!1)};return et.useEffect(()=>{l&&N(g.toString())},[g,l]),e.jsx(me,{open:l,onOpenChange:$,children:e.jsxs(he,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ue,{children:e.jsxs(xe,{className:"flex items-center gap-2 text-right",children:[e.jsx(nt,{className:"h-5 w-5"}),x]})}),e.jsxs("form",{onSubmit:H,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:b}),e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg",children:[e.jsxs(V,{className:"text-sm font-medium text-gray-700",children:[t," الحالي"]}),e.jsxs("div",{className:"text-lg font-bold text-gray-900 mt-1",children:[g.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"newAmount",className:"text-right",children:"المبلغ الجديد"}),e.jsx(R,{id:"newAmount",type:"number",step:"0.01",min:"0",value:h,onChange:C=>N(C.target.value),placeholder:"أدخل المبلغ الجديد",className:"text-right",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"pin",className:"text-right",children:"الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"pin",type:y?"text":"password",value:S,onChange:C=>p(C.target.value),placeholder:"أدخل الرقم السري",className:"text-right pr-10",required:!0}),e.jsx(c,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>F(!y),children:y?e.jsx(Ct,{className:"h-4 w-4"}):e.jsx(Ue,{className:"h-4 w-4"})})]})]}),z&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-red-600 bg-red-50 p-2 rounded",children:[e.jsx(qs,{className:"h-4 w-4"}),z]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(c,{type:"button",variant:"outline",onClick:$,className:"flex-1",children:"إلغاء"}),e.jsx(c,{type:"submit",disabled:L||!S||!h,className:"flex-1",children:L?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"جاري التحديث..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Js,{className:"h-4 w-4 mr-2"}),"تحديث الرصيد"]})})]})]})]})})}class Da{static getSecretKey(m){return m?`${this.SECRET_KEY_BASE}_${m}`:this.SECRET_KEY_BASE}static setSecretPin(m,i){const x=btoa(m);this.secretCache.set(this.getSecretKey(i),x)}static hasSecretPin(m){return this.secretCache.has(this.getSecretKey(m))}static verifySecretPin(m,i){const x=this.secretCache.get(this.getSecretKey(i));if(!x)return!1;try{return atob(x)===m}catch{return!1}}static clearSecretPin(m){this.secretCache.delete(this.getSecretKey(m))}}ln(Da,"SECRET_KEY_BASE","dashboard_secret_pin"),ln(Da,"secretCache",new Map);function sd({open:l,onOpenChange:m,userId:i}){const[x,b]=a.useState(""),[g,t]=a.useState(""),[W,S]=a.useState(""),[p,h]=a.useState(!1),[N,y]=a.useState(!1),[F,z]=a.useState(!1),[Z,L]=a.useState(""),[D,U]=a.useState(!1),{toast:H}=cs(),$=Da.hasSecretPin(i),C=async ae=>{ae.preventDefault(),L(""),U(!0);try{if(!g||g.length<4){L("يجب أن يكون الرقم السري 4 أرقام على الأقل"),U(!1);return}if(g!==W){L("الرقم السري الجديد وتأكيده غير متطابقين"),U(!1);return}if($){if(!x){L("يرجى إدخال الرقم السري الحالي"),U(!1);return}if(!Da.verifySecretPin(x,i)){L("الرقم السري الحالي غير صحيح"),U(!1);return}}Da.setSecretPin(g,i),H({title:$?"تم تغيير الرقم السري":"تم تعيين الرقم السري",description:$?"تم تغيير الرقم السري بنجاح":"تم تعيين الرقم السري بنجاح"}),_()}catch{L("حدث خطأ أثناء حفظ الرقم السري")}finally{U(!1)}},_=()=>{b(""),t(""),S(""),L(""),h(!1),y(!1),z(!1),m(!1)};return e.jsx(me,{open:l,onOpenChange:_,children:e.jsxs(he,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ue,{children:e.jsxs(xe,{className:"flex items-center gap-2 text-right",children:[e.jsx(Rl,{className:"h-5 w-5"}),$?"تغيير الرقم السري":"تعيين الرقم السري"]})}),e.jsxs("form",{onSubmit:C,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:$?"أدخل الرقم السري الحالي والرقم السري الجديد لتغييره":"أدخل الرقم السري الجديد الذي تريد استخدامه في عمليات التعديل"}),$&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"currentPin",type:p?"text":"password",autoComplete:"off",value:x,onChange:ae=>b(ae.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(c,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>h(!p),children:p?e.jsx(Ct,{className:"h-4 w-4"}):e.jsx(Ue,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"newPin",type:N?"text":"password",autoComplete:"off",value:g,onChange:ae=>t(ae.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(c,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>y(!N),children:N?e.jsx(Ct,{className:"h-4 w-4"}):e.jsx(Ue,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"confirmPin",type:F?"text":"password",autoComplete:"off",value:W,onChange:ae=>S(ae.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(c,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>z(!F),children:F?e.jsx(Ct,{className:"h-4 w-4"}):e.jsx(Ue,{className:"h-4 w-4"})})]})]}),Z&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(qs,{className:"h-4 w-4"}),Z]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(c,{type:"submit",disabled:D,className:"flex-1",children:[e.jsx(Js,{className:"h-4 w-4 mr-2"}),D?"جاري الحفظ...":$?"تغيير الرقم السري":"تعيين الرقم السري"]}),e.jsx(c,{type:"button",variant:"outline",onClick:_,disabled:D,children:"إلغاء"})]})]})]})})}const mn=new Map;function ad({open:l,onOpenChange:m,userId:i}){const[x,b]=a.useState(""),[g,t]=a.useState(""),[W,S]=a.useState(""),[p,h]=a.useState(!1),[N,y]=a.useState(!1),[F,z]=a.useState(!1),[Z,L]=a.useState(""),[D,U]=a.useState(!1),{toast:H}=cs(),$=i?`cash_drawer_pin_${i}`:"cash_drawer_pin",C=()=>mn.has($),_=J=>{const A=mn.get($);if(!A)return!1;try{return atob(A)===J}catch{return!1}},ae=J=>{const A=btoa(J);mn.set($,A)},ee=async J=>{J.preventDefault(),L(""),U(!0);try{if(!g||g.length<4){L("يجب أن يكون الرقم السري 4 أرقام على الأقل"),U(!1);return}if(g!==W){L("الرقم السري الجديد وتأكيده غير متطابقين"),U(!1);return}if(C()){if(!x){L("يرجى إدخال الرقم السري الحالي لدرج النقدية"),U(!1);return}if(!_(x)){L("الرقم السري الحالي لدرج النقدية غير صحيح"),U(!1);return}}ae(g),H({title:C()?"تم تغيير رقم درج النقدية":"تم تعيين رقم درج النقدية",description:C()?"تم تغيير الرقم السري لدرج النقدية بنجاح":"تم تعيين الرقم السري لدرج النقدية بنجاح"}),fe()}catch{L("حدث خطأ أثناء حفظ الرقم السري لدرج النقدية")}finally{U(!1)}},fe=()=>{b(""),t(""),S(""),L(""),h(!1),y(!1),z(!1),m(!1)};return e.jsx(me,{open:l,onOpenChange:fe,children:e.jsxs(he,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ue,{children:e.jsxs(xe,{className:"flex items-center gap-2 text-right",children:[e.jsx(nt,{className:"h-5 w-5 text-green-600"}),C()?"تغيير رقم درج النقدية":"تعيين رقم درج النقدية"]})}),e.jsxs("form",{onSubmit:ee,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:C()?"أدخل الرقم السري الحالي والرقم السري الجديد لدرج النقدية":"أدخل الرقم السري الجديد الذي تريد استخدامه لحماية درج النقدية"}),C()&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي لدرج النقدية"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"currentPin",type:p?"text":"password",autoComplete:"off",value:x,onChange:J=>b(J.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(c,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>h(!p),children:p?e.jsx(Ct,{className:"h-4 w-4"}):e.jsx(Ue,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد لدرج النقدية"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"newPin",type:N?"text":"password",autoComplete:"off",value:g,onChange:J=>t(J.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(c,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>y(!N),children:N?e.jsx(Ct,{className:"h-4 w-4"}):e.jsx(Ue,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"confirmPin",type:F?"text":"password",autoComplete:"off",value:W,onChange:J=>S(J.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(c,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>z(!F),children:F?e.jsx(Ct,{className:"h-4 w-4"}):e.jsx(Ue,{className:"h-4 w-4"})})]})]}),Z&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(qs,{className:"h-4 w-4"}),Z]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(c,{type:"submit",disabled:D,className:"flex-1 bg-green-600 hover:bg-green-700",children:[e.jsx(Js,{className:"h-4 w-4 mr-2"}),D?"جاري الحفظ...":C()?"تغيير رقم درج النقدية":"تعيين رقم درج النقدية"]}),e.jsx(c,{type:"button",variant:"outline",onClick:fe,disabled:D,children:"إلغاء"})]})]}),e.jsx("div",{className:"text-xs text-gray-500 text-center mt-2",children:"💰 هذا الرقم السري خاص بحماية درج النقدية فقط"})]})})}const hn=new Map;function rd({open:l,onOpenChange:m,userId:i}){const[x,b]=a.useState(""),[g,t]=a.useState(""),[W,S]=a.useState(""),[p,h]=a.useState(!1),[N,y]=a.useState(!1),[F,z]=a.useState(!1),[Z,L]=a.useState(""),[D,U]=a.useState(!1),{toast:H}=cs(),$=i?`wallet_total_pin_${i}`:"wallet_total_pin",C=()=>hn.has($),_=J=>{const A=hn.get($);if(!A)return!1;try{return atob(A)===J}catch{return!1}},ae=J=>{const A=btoa(J);hn.set($,A)},ee=async J=>{J.preventDefault(),L(""),U(!0);try{if(!g||g.length<4){L("يجب أن يكون الرقم السري 4 أرقام على الأقل"),U(!1);return}if(g!==W){L("الرقم السري الجديد وتأكيده غير متطابقين"),U(!1);return}if(C()){if(!x){L("يرجى إدخال الرقم السري الحالي لإجمالي المحفظة"),U(!1);return}if(!_(x)){L("الرقم السري الحالي لإجمالي المحفظة غير صحيح"),U(!1);return}}ae(g),H({title:C()?"تم تغيير رقم إجمالي المحفظة":"تم تعيين رقم إجمالي المحفظة",description:C()?"تم تغيير الرقم السري لإجمالي المحفظة بنجاح":"تم تعيين الرقم السري لإجمالي المحفظة بنجاح"}),fe()}catch{L("حدث خطأ أثناء حفظ الرقم السري لإجمالي المحفظة")}finally{U(!1)}},fe=()=>{b(""),t(""),S(""),L(""),h(!1),y(!1),z(!1),m(!1)};return e.jsx(me,{open:l,onOpenChange:fe,children:e.jsxs(he,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ue,{children:e.jsxs(xe,{className:"flex items-center gap-2 text-right",children:[e.jsx(is,{className:"h-5 w-5 text-blue-600"}),C()?"تغيير رقم إجمالي المحفظة":"تعيين رقم إجمالي المحفظة"]})}),e.jsxs("form",{onSubmit:ee,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:C()?"أدخل الرقم السري الحالي والرقم السري الجديد لإجمالي المحفظة":"أدخل الرقم السري الجديد الذي تريد استخدامه لحماية إجمالي المحفظة"}),C()&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي لإجمالي المحفظة"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"currentPin",type:p?"text":"password",autoComplete:"off",value:x,onChange:J=>b(J.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(c,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>h(!p),children:p?e.jsx(Ct,{className:"h-4 w-4"}):e.jsx(Ue,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد لإجمالي المحفظة"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"newPin",type:N?"text":"password",autoComplete:"off",value:g,onChange:J=>t(J.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(c,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>y(!N),children:N?e.jsx(Ct,{className:"h-4 w-4"}):e.jsx(Ue,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"confirmPin",type:F?"text":"password",autoComplete:"off",value:W,onChange:J=>S(J.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(c,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>z(!F),children:F?e.jsx(Ct,{className:"h-4 w-4"}):e.jsx(Ue,{className:"h-4 w-4"})})]})]}),Z&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(qs,{className:"h-4 w-4"}),Z]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(c,{type:"submit",disabled:D,className:"flex-1 bg-blue-600 hover:bg-blue-700",children:[e.jsx(Js,{className:"h-4 w-4 mr-2"}),D?"جاري الحفظ...":C()?"تغيير رقم إجمالي المحفظة":"تعيين رقم إجمالي المحفظة"]}),e.jsx(c,{type:"button",variant:"outline",onClick:fe,disabled:D,children:"إلغاء"})]})]}),e.jsx("div",{className:"text-xs text-gray-500 text-center mt-2",children:"💼 هذا الرقم السري خاص بحماية إجمالي المحفظة فقط"})]})})}function nd({open:l,onOpenChange:m,onSuccess:i,title:x,description:b,currentBalance:g,balanceLabel:t,userId:W}){const[S,p]=a.useState(""),[h,N]=a.useState(""),[y,F]=a.useState("add"),[z,Z]=a.useState(!1),[L,D]=a.useState(""),[U,H]=a.useState(!1),$=Yt.hasMasterPin(),C=async ee=>{ee.preventDefault(),D(""),H(!0);try{const fe=parseFloat(h);if(isNaN(fe)||fe<=0){D("يرجى إدخال مبلغ صحيح أكبر من صفر"),H(!1);return}if(y==="subtract"&&fe>g){D("لا يمكن خصم مبلغ أكبر من الرصيد الحالي"),H(!1);return}if($)if(Yt.verifyMasterPin(S)){const J=y==="add"?fe:-fe;_(),i(J)}else D("الرقم السري غير صحيح");else D("لم يتم تعيين رقم سري رئيسي. يرجى تعيين رقم سري رئيسي أولاً من إعدادات التطبيق")}catch{D("حدث خطأ أثناء التحقق من الرقم السري")}finally{H(!1)}},_=()=>{p(""),N(""),F("add"),D(""),m(!1)},ae=()=>{const ee=parseFloat(h)||0;return y==="add"?g+ee:g-ee};return e.jsx(me,{open:l,onOpenChange:_,children:e.jsxs(he,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ue,{children:e.jsxs(xe,{className:"flex items-center gap-2 text-right",children:[y==="add"?e.jsx(kt,{className:"h-5 w-5 text-green-600"}):e.jsx(Us,{className:"h-5 w-5 text-red-600"}),x]})}),e.jsxs("form",{onSubmit:C,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:b}),e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg",children:[e.jsxs(V,{className:"text-sm font-medium text-gray-700",children:[t," الحالي"]}),e.jsxs("div",{className:"text-lg font-bold text-gray-900 mt-1",children:[g.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{className:"text-right",children:"نوع العملية"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(c,{type:"button",variant:y==="add"?"default":"outline",onClick:()=>F("add"),className:"flex-1 flex items-center gap-2",children:[e.jsx(kt,{className:"h-4 w-4"}),"إضافة"]}),e.jsxs(c,{type:"button",variant:y==="subtract"?"default":"outline",onClick:()=>F("subtract"),className:"flex-1 flex items-center gap-2",children:[e.jsx(Us,{className:"h-4 w-4"}),"خصم"]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(V,{htmlFor:"amount",className:"text-right",children:["المبلغ المراد ",y==="add"?"إضافته":"خصمه"]}),e.jsx(R,{id:"amount",type:"number",step:"0.01",min:"0.01",value:h,onChange:ee=>N(ee.target.value),placeholder:`أدخل المبلغ المراد ${y==="add"?"إضافته":"خصمه"}`,className:"text-right",required:!0})]}),h&&!isNaN(parseFloat(h))&&e.jsxs("div",{className:`p-3 rounded-lg ${y==="add"?"bg-green-50 border border-green-200":"bg-red-50 border border-red-200"}`,children:[e.jsx(V,{className:"text-sm font-medium text-gray-700",children:"الرصيد الجديد المتوقع"}),e.jsxs("div",{className:`text-lg font-bold mt-1 ${y==="add"?"text-green-700":"text-red-700"}`,children:[ae().toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"pin",className:"text-right",children:"الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"pin",type:z?"text":"password",autoComplete:"off",value:S,onChange:ee=>p(ee.target.value),placeholder:"أدخل الرقم السري",className:"text-right pr-10",required:!0}),e.jsx(c,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>Z(!z),children:z?e.jsx(Ct,{className:"h-4 w-4"}):e.jsx(Ue,{className:"h-4 w-4"})})]})]}),L&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-red-600 bg-red-50 p-2 rounded",children:[e.jsx(qs,{className:"h-4 w-4"}),L]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(c,{type:"button",variant:"outline",onClick:_,className:"flex-1",children:"إلغاء"}),e.jsx(c,{type:"submit",disabled:U||!S||!h,className:`flex-1 ${y==="add"?"bg-green-600 hover:bg-green-700":"bg-red-600 hover:bg-red-700"}`,children:U?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"جاري التحديث..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Js,{className:"h-4 w-4 mr-2"}),y==="add"?"إضافة المبلغ":"خصم المبلغ"]})})]})]})]})})}function ld(l){return l?`readBroadcastIds_${l}`:"readBroadcastIds_guest"}function id({className:l}){const{user:m,profile:i}=ys(),[x,b]=a.useState([]),[g,t]=a.useState(new Set),[W,S]=a.useState(!1),[p,h]=a.useState(""),[N,y]=a.useState(!1),[F,z]=a.useState(null);a.useState(null);const[Z,L]=a.useState(!1);a.useRef(new Set),a.useRef(!1);const D=a.useRef(null),U=a.useRef(null);a.useRef(null),a.useState({position:"fixed",top:0,left:0,zIndex:1e4});const H=!1,$=a.useMemo(()=>{const A=["global"];return m!=null&&m.uid&&A.push(`user:${m.uid}`),i!=null&&i.shopId&&A.push(`shop:${i.shopId}`),A},[m==null?void 0:m.uid,i==null?void 0:i.shopId]),C=ld(m==null?void 0:m.uid);a.useEffect(()=>{try{const A=localStorage.getItem(C);if(A){const ne=JSON.parse(A);Array.isArray(ne)&&t(new Set(ne.filter(Boolean)))}else t(new Set)}catch(A){console.warn("Failed to load read ids",A),t(new Set)}},[C]),a.useEffect(()=>{const A=Mc($,ne=>{b(ne)});return()=>A()},[$]),a.useEffect(()=>{},[x]),a.useEffect(()=>()=>{D.current&&clearTimeout(D.current)},[]);const _=x.reduce((A,ne)=>A+(ne.id&&!g.has(ne.id)?1:0),0),ae=A=>{if(!A||g.has(A))return;const ne=new Set(g);ne.add(A),t(ne);try{localStorage.setItem(C,JSON.stringify(Array.from(ne)))}catch{}},ee=()=>{const A=x.map(q=>q.id).filter(Boolean),ne=new Set(g);A.forEach(q=>ne.add(q)),t(ne);try{localStorage.setItem(C,JSON.stringify(Array.from(ne)))}catch{}},fe=(A,ne)=>{A&&window.open(A,"_blank"),ne&&ae(ne)};a.useEffect(()=>{},[Z]);const J=async()=>{if(!(m!=null&&m.uid)){alert("يرجى تسجيل الدخول لإرسال الطلب.");return}const A=p.trim();if(!A){alert("يرجى كتابة سبب طلب التحدث.");return}try{y(!0),z(null);const ne=i!=null&&i.fullName&&i.fullName.trim()?i.fullName.trim():m.email?m.email.split("@")[0]:"مستخدم",q=(i==null?void 0:i.phone)||null;await xn(ns(ht,"waiting_list"),{userId:m.uid,name:ne,phone:q,reason:A,status:"pending",createdAt:Fs()}),z("تم إرسال طلبك إلى قائمة الانتظار بنجاح ✅"),h(""),setTimeout(()=>S(!1),900)}catch(ne){console.error("فشل إرسال طلب قائمة الانتظار:",ne),alert("حدث خطأ أثناء إرسال الطلب. حاول مرة أخرى.")}finally{y(!1)}};return e.jsxs("div",{className:`relative inline-flex items-center gap-2 ${l||""}`,ref:U,children:[e.jsxs(Lc,{onOpenChange:A=>{A&&_>0&&ee()},children:[e.jsx($c,{asChild:!0,children:e.jsx(c,{variant:"ghost",className:"relative h-8 w-8 rounded-full p-0 hover:bg-transparent focus:ring-1 focus:ring-primary focus:ring-offset-1 transition-all",title:"الإشعارات",children:e.jsxs("div",{className:"relative h-8 w-8 rounded-full bg-primary/10 flex items-center justify-center border border-border shadow-sm hover:shadow-md",children:[e.jsx(Pl,{className:"h-4 w-4 text-primary"}),_>0&&e.jsx("span",{className:"absolute -top-1 -right-1 min-w-[18px] h-[18px] px-1 rounded-full bg-red-500 text-white text-[10px] font-bold flex items-center justify-center shadow",children:_})]})})}),e.jsxs(Rc,{className:"w-80",align:"end",forceMount:!0,children:[e.jsxs(Uc,{className:"flex items-center justify-between",children:[e.jsx("span",{children:"الإشعارات"}),x.length>0&&e.jsxs(c,{variant:"outline",size:"sm",className:"h-7 text-xs",onClick:ee,children:[e.jsx(_s,{className:"h-3 w-3 mr-1"}),"تمييز الكل كمقروء"]})]}),e.jsx(_c,{}),x.length===0?e.jsx("div",{className:"p-3 text-sm text-muted-foreground",children:"لا توجد إشعارات حالياً"}):e.jsx("div",{className:"max-h-64 overflow-y-auto pr-1",children:x.map(A=>{const ne=A.id?!g.has(A.id):!1;return e.jsx("div",{className:`px-2 py-2 rounded-md ${ne?"bg-primary/5":""}`,children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(Pl,{className:`h-4 w-4 ${ne?"text-primary":"text-muted-foreground"}`}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-sm font-medium",children:A.title||"إشعار"}),e.jsx("div",{className:"text-xs text-muted-foreground whitespace-pre-line",children:A.message}),A.linkUrl&&e.jsxs(c,{variant:"link",className:"px-0 h-6 text-xs",onClick:()=>fe(A.linkUrl,A.id),children:["فتح الرابط ",e.jsx(Bc,{className:"h-3 w-3 ml-1"})]})]}),ne?e.jsx(c,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>ae(A.id),title:"تمييز كمقروء",children:e.jsx(_s,{className:"h-4 w-4 text-primary"})}):e.jsx(c,{variant:"ghost",size:"icon",className:"h-6 w-6",disabled:!0,title:"مقروء",children:e.jsx(_s,{className:"h-4 w-4 text-muted-foreground"})})]})},A.id)})})]})]}),e.jsxs(me,{open:W,onOpenChange:S,children:[e.jsx(pc,{asChild:!0,children:e.jsx(c,{variant:"default",className:"h-8 px-3 rounded-full bg-gradient-to-r from-purple-600 to-blue-600 text-white shadow hover:opacity-90",title:"قائمة الانتظار",children:"قائمة الانتظار"})}),e.jsxs(he,{className:"max-w-md border border-purple-200/50 shadow-xl bg-gradient-to-br from-purple-50 to-blue-50",children:[e.jsxs(ue,{children:[e.jsx(xe,{children:"طلب التحدث"}),e.jsx(Vt,{children:"يرجى كتابة سبب طلب التحدث ليصل للإدارة في قسم قائمة الانتظار."})]}),e.jsxs("div",{className:"grid gap-3",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"سبب الطلب"}),e.jsx(Dc,{value:p,onChange:A=>h(A.target.value),placeholder:"اكتب سبب طلب التحدث هنا...",className:"min-h-[120px] text-right"}),F&&e.jsx("div",{className:"text-sm text-green-700 bg-green-50 border border-green-200 rounded-md p-2",children:F})]}),e.jsxs(Ce,{children:[e.jsx(c,{variant:"outline",onClick:()=>S(!1),disabled:N,children:"إلغاء"}),e.jsx(c,{onClick:J,disabled:N,className:"bg-gradient-to-r from-green-600 to-emerald-600 text-white",children:N?"جارٍ الإرسال...":"إرسال"})]})]})]}),H]})}const Fl=({isOpen:l,onClose:m,onTrialStarted:i})=>{const{user:x}=ys(),[b,g]=a.useState(!1),[t,W]=a.useState(!1),[S,p]=a.useState(""),[h,N]=a.useState(24);a.useEffect(()=>{const z=async()=>{if(x!=null&&x.uid){const L=await wa.getTrialData(x.uid);W(L.hasUsedFreeTrial)}},Z=async()=>{try{const L=await wa.getTrialDurationHours();N(L)}catch{}};l&&(z(),Z())},[l,x]);const y=async()=>{if(x!=null&&x.uid){g(!0);try{const z=await wa.startFreeTrial(x.uid);z.success?(p(z.message),window.location.href="/user/dashboard"):p(z.message||"تعذر تفعيل التجربة المجانية")}catch{p("حدث خطأ أثناء تفعيل التجربة المجانية")}finally{g(!1)}}},F=async()=>{if(x!=null&&x.uid){g(!0);try{await sc(x.uid,fs.ZERO,x.uid),window.location.href="/user/dashboard"}catch{p("حدث خطأ أثناء تفعيل باقة الزيرو")}finally{g(!1)}}};return e.jsxs(e.Fragment,{children:[l&&e.jsx("div",{className:"fixed inset-0 z-40",style:{background:"rgba(0, 0, 0, 0.15)",backdropFilter:"blur(3px)",WebkitBackdropFilter:"blur(3px)",pointerEvents:"auto"}}),e.jsx(me,{open:l,onOpenChange:()=>{},children:e.jsxs(he,{className:"sm:max-w-lg z-50 border-0 shadow-2xl",style:{position:"fixed",top:"50%",left:"50%",transform:"translate(-50%, -50%)",pointerEvents:"auto",background:"linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 0.95) 100%)",backdropFilter:"blur(10px)",WebkitBackdropFilter:"blur(10px)",borderRadius:"20px",border:"1px solid rgba(255, 255, 255, 0.3)"},children:[e.jsxs(ue,{className:"text-center pb-0 pt-0",children:[e.jsx("div",{className:"flex justify-center mb-1",children:e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-0 rounded-full",style:{background:"linear-gradient(135deg, #f59e0b, #d97706)",filter:"blur(8px)",opacity:.3}}),e.jsx("div",{className:"relative bg-gradient-to-br from-orange-400 to-orange-600 p-2 rounded-full",children:e.jsx(cn,{className:"h-12 w-12 text-white"})})]})}),e.jsx(xe,{className:"text-2xl font-bold bg-gradient-to-r from-gray-800 to-gray-600 bg-clip-text text-transparent text-center mt-0 mb-0 leading-tight",children:"تفعيل الحساب مطلوب"})]}),e.jsxs("div",{className:"text-center pt-6 pb-0 px-2",children:[e.jsxs("div",{className:"bg-gradient-to-r from-orange-50 to-amber-50 rounded-xl p-6 mb-6 border border-orange-100",children:[e.jsx("p",{className:"text-gray-700 text-lg leading-relaxed font-medium",children:"حسابك في انتظار التفعيل من قبل المسؤول"}),e.jsx("p",{className:"text-sm font-semibold text-orange-700 mt-3 mb-3 bg-orange-100 p-3 rounded-lg border border-orange-200",children:"للتفعيل السريع: تواصل مع الإدارة عبر واتساب فقط على الرقم التالي"}),e.jsxs("div",{className:"bg-green-50 p-4 rounded-lg border border-green-200 mt-3",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"text-base font-bold text-green-700",children:"واتساب الإدارة:"}),e.jsx("a",{href:"https://wa.me/201000392539",target:"_blank",rel:"noopener noreferrer",className:"text-lg font-bold text-green-600 hover:text-green-700 underline",children:"01000392539"})]}),e.jsx("p",{className:"text-sm text-green-600 mt-2 text-center",children:"اضغط على الرقم للتواصل المباشر عبر واتساب"})]})]}),!t&&e.jsxs("div",{className:"bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-4 mb-4 border border-green-200",children:[e.jsxs("div",{className:"flex items-center justify-center mb-2",children:[e.jsx(cn,{className:"h-5 w-5 text-green-600 ml-2"}),e.jsx("span",{className:"text-green-700 font-semibold",children:"باقة الزيرو المجانية الدائمة"})]}),e.jsx("p",{className:"text-green-600 text-sm text-center",children:"فعل باقة الزيرو الان واستمتع ب 10 عمليات سحب وتحويل يوميا"})]}),S&&e.jsx("div",{className:`rounded-xl p-4 mb-4 text-center ${S.includes("تم تفعيل")?"bg-green-50 border border-green-200 text-green-700":"bg-red-50 border border-red-200 text-red-700"}`,children:e.jsx("p",{className:"font-medium",children:S})}),e.jsxs("div",{className:"flex items-center justify-center space-x-2 text-sm text-gray-500 mb-0",children:[e.jsxs("div",{className:"flex space-x-1",children:[e.jsx("div",{className:"w-2 h-2 bg-orange-400 rounded-full animate-pulse"}),e.jsx("div",{className:"w-2 h-2 bg-orange-400 rounded-full animate-pulse",style:{animationDelay:"0.2s"}}),e.jsx("div",{className:"w-2 h-2 bg-orange-400 rounded-full animate-pulse",style:{animationDelay:"0.4s"}})]}),e.jsx("span",{className:"mr-2",children:"في انتظار التفعيل"})]})]}),e.jsxs("div",{className:"flex flex-col space-y-3 pb-2",children:[!t&&!S.includes("تم تفعيل")&&e.jsxs(e.Fragment,{children:[e.jsxs(c,{onClick:y,disabled:b,className:"w-full max-w-2xl mx-auto relative bg-gradient-to-r from-blue-600 to-indigo-600 hover:brightness-110 text-white px-10 py-4 rounded-2xl font-bold text-xl ring-2 ring-blue-300 ring-offset-1 shadow-2xl hover:shadow-3xl transition-all duration-500 transform hover:scale-110 hover:-translate-y-1 disabled:opacity-50 disabled:cursor-not-allowed overflow-hidden group focus-visible:outline-none focus-visible:ring-4 focus-visible:ring-blue-300",style:{boxShadow:"0 15px 35px rgba(59, 130, 246, 0.4), 0 5px 15px rgba(0, 0, 0, 0.1)"},children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-white/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"}),e.jsx("div",{className:"absolute -top-1 -left-1 w-3 h-3 bg-yellow-400 rounded-full animate-ping"}),e.jsx("div",{className:"absolute -top-1 -right-1 w-2 h-2 bg-green-400 rounded-full animate-pulse"}),b?e.jsxs("div",{className:"flex items-center relative z-10",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-white ml-3"}),e.jsx("span",{className:"bg-gradient-to-r from-white to-gray-100 bg-clip-text text-transparent",children:"جاري التفعيل..."})]}):e.jsxs("div",{className:"flex items-center relative z-10",children:[e.jsx(zc,{className:"h-6 w-6 ml-3 animate-bounce"}),e.jsx("span",{className:"bg-gradient-to-r from-white to-gray-100 bg-clip-text text-transparent",children:`التجربة المجانية لمدة ${h} ${h>=3&&h<=10?"ساعات":h===2?"ساعتين":"ساعة"}`})]})]}),e.jsxs(c,{onClick:F,disabled:b,className:"w-full max-w-2xl mx-auto relative bg-gradient-to-r from-green-600 to-emerald-600 hover:brightness-110 text-white px-10 py-4 rounded-2xl font-bold text-xl ring-2 ring-emerald-300 ring-offset-1 shadow-2xl hover:shadow-3xl transition-all duration-500 transform hover:scale-110 hover:-translate-y-1 disabled:opacity-50 disabled:cursor-not-allowed overflow-hidden group focus-visible:outline-none focus-visible:ring-4 focus-visible:ring-emerald-300",style:{boxShadow:"0 15px 35px rgba(99, 102, 241, 0.4), 0 5px 15px rgba(0, 0, 0, 0.1)"},children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-white/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"}),e.jsx("div",{className:"absolute -top-1 -left-1 w-3 h-3 bg-yellow-400 rounded-full animate-ping"}),e.jsx("div",{className:"absolute -top-1 -right-1 w-2 h-2 bg-green-400 rounded-full animate-pulse"}),b?e.jsxs("div",{className:"flex items-center relative z-10",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-white ml-3"}),e.jsx("span",{className:"bg-gradient-to-r from-white to-gray-100 bg-clip-text text-transparent",children:"جاري التفعيل..."})]}):e.jsxs("div",{className:"flex items-center relative z-10",children:[e.jsx(cn,{className:"h-6 w-6 ml-3 animate-bounce"}),e.jsx("span",{className:"bg-gradient-to-r from-white to-gray-100 bg-clip-text text-transparent",children:"فعّل باقة الزيرو الآن"})]})]})]}),e.jsx(c,{onClick:m,variant:"outline",className:"border-2 border-gray-300 hover:border-gray-400 text-gray-700 hover:text-gray-800 px-10 py-3 rounded-xl font-semibold text-lg transition-all duration-300 transform hover:scale-105",children:t?"فهمت":"إغلاق"})]})]})})]})};function od({isOpen:l,onClose:m}){const[i,x]=a.useState("0"),[b,g]=a.useState(null),[t,W]=a.useState(null),[S,p]=a.useState(!1),h=$=>{S?(x($),p(!1)):x(i==="0"?$:i+$)},N=$=>{const C=parseFloat(i);if(b===null)g(C);else if(t){const ae=y(b||0,C,t);x(String(ae)),g(ae)}p(!0),W($)},y=($,C,_)=>{switch(_){case"+":return $+C;case"-":return $-C;case"×":return $*C;case"÷":return C===0?0:$/C;case"=":return C;default:return C}},F=()=>{const $=parseFloat(i);if(b!==null&&t){const C=y(b,$,t);x(String(C)),g(null),W(null),p(!0)}},z=()=>{x("0"),g(null),W(null),p(!1)},Z=()=>{x("0")},L=()=>{S?(x("0."),p(!1)):i.indexOf(".")===-1&&x(i+".")},D=()=>{i!=="0"&&x(i.charAt(0)==="-"?i.slice(1):"-"+i)},U=()=>{const $=parseFloat(i);x(String($/100))},H=$=>{const C=$.key;$.preventDefault(),C>="0"&&C<="9"?h(C):C==="+"?N("+"):C==="-"?N("-"):C==="*"?N("×"):C==="/"?N("÷"):C==="Enter"||C==="="?F():C==="Escape"||C==="c"||C==="C"?z():C==="Backspace"?Z():C==="."?L():C==="%"&&U()};return a.useEffect(()=>(l?document.addEventListener("keydown",H):document.removeEventListener("keydown",H),()=>{document.removeEventListener("keydown",H)}),[l,i,b,t,S]),e.jsx(me,{open:l,onOpenChange:$=>!$&&m(),children:e.jsxs(he,{className:"sm:max-w-md",children:[e.jsx(ue,{children:e.jsxs(xe,{className:"flex items-center gap-2 text-right",children:[e.jsx(Ql,{className:"h-5 w-5"}),"آلة حاسبة"]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-gray-900 text-white p-4 rounded-lg text-right",children:e.jsx("div",{className:"text-3xl font-mono font-bold min-h-[3rem] flex items-center justify-end overflow-hidden",children:i})}),e.jsxs("div",{className:"grid grid-cols-4 gap-2",children:[e.jsx(c,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:z,children:"AC"}),e.jsx(c,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:Z,children:"CE"}),e.jsx(c,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:U,children:"%"}),e.jsx(c,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>N("÷"),children:"÷"}),e.jsx(c,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>h("7"),children:"7"}),e.jsx(c,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>h("8"),children:"8"}),e.jsx(c,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>h("9"),children:"9"}),e.jsx(c,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>N("×"),children:"×"}),e.jsx(c,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>h("4"),children:"4"}),e.jsx(c,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>h("5"),children:"5"}),e.jsx(c,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>h("6"),children:"6"}),e.jsx(c,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>N("-"),children:"-"}),e.jsx(c,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>h("1"),children:"1"}),e.jsx(c,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>h("2"),children:"2"}),e.jsx(c,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>h("3"),children:"3"}),e.jsx(c,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>N("+"),children:"+"}),e.jsx(c,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50 col-span-2",onClick:()=>h("0"),children:"0"}),e.jsx(c,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:L,children:"."}),e.jsx(c,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:F,children:"="})]}),e.jsx(c,{variant:"outline",className:"w-full h-10 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:D,children:"+/-"})]})]})})}function cd({isOpen:l,onClose:m,initialBarcode:i}){const[x,b]=a.useState([]),[g,t]=a.useState({productName:"",price:"",wholesalePrice:"",quantity:"",barcode:"",serialNumber:""}),[W,S]=a.useState(!1);a.useState(null);const{toast:p}=cs(),{user:h,profile:N}=ys(),{isShiftActive:y,shiftUser:F}=Ia(),[z,Z]=a.useState([]),[L,D]=a.useState({}),[U,H]=a.useState({});a.useState({});const[$,C]=a.useState(""),[_,ae]=a.useState(!1),[ee,fe]=a.useState({}),[J,A]=a.useState(!1),[ne,q]=a.useState(!0),[ie,Pe]=a.useState(!1),Ve=et.useRef(""),It=et.useRef(0),[_e,$t]=a.useState(0),[st,lt]=a.useState(0),[At,Ye]=a.useState(!1),[We,Tt]=a.useState(!0),[wt,Ft]=a.useState(!1),[ft,St]=a.useState(!1),[Rt,Ht]=a.useState("التحقق قبل العملية"),[ds,Et]=a.useState("أدخل الرقم السري الرئيسي للمتابعة"),P=et.useRef(null),re=(u,E,Y)=>{Ht(u),Et(E),P.current=Y,St(!0)},[pe,Oe]=a.useState(""),Ie=a.useMemo(()=>{const u=pe.trim().toLowerCase();return u?z.filter(E=>E.name.toLowerCase().includes(u)):z},[z,pe]);a.useEffect(()=>{l&&(h!=null&&h.uid)&&(M(),We||K())},[l,h==null?void 0:h.uid,We]),a.useEffect(()=>{if(!l)return;const u=E=>{const Y=Date.now();if(E.key==="Enter"){const ce=(Ve.current||"").trim();Ve.current="",ce&&He(ce);return}E.key.length===1&&(Y-(It.current||0)>100&&(Ve.current=""),Ve.current+=E.key,It.current=Y)};return window.addEventListener("keydown",u),()=>window.removeEventListener("keydown",u)},[l,z]),a.useEffect(()=>{l&&i&&He(i)},[l,i]);const ze=async()=>{if(h!=null&&h.uid)try{const u=N==null?void 0:N.shopId;let E,Y=[];if(u){const ce=$s(ns(ht,"products"),Bt("shopId","==",u),Bt("userId","==",h.uid));if(E=await Rs(ce),Y=E.docs.map(oe=>({id:oe.id,name:String(oe.data().name??""),sellingPrice:Number(oe.data().sellingPrice??0),wholesalePrice:Number(oe.data().wholesalePrice??0),quantity:Number(oe.data().quantity??0),barcode:String(oe.data().barcode??""),serialNumber:String(oe.data().serialNumber??"")})),Y.length===0){const oe=$s(ns(ht,"products"),Bt("userId","==",h.uid)),Te=(await Rs(oe)).docs.map(we=>({id:we.id,name:String(we.data().name??""),sellingPrice:Number(we.data().sellingPrice??0),wholesalePrice:Number(we.data().wholesalePrice??0),quantity:Number(we.data().quantity??0),barcode:String(we.data().barcode??""),serialNumber:String(we.data().serialNumber??"")}));Te.length>0&&(Y=Te,p({title:"تم استرجاع المنتجات",description:"عثرنا على منتجات محفوظة لك خارج المتجر الحالي وقمنا بعرضها."}))}}else{const ce=$s(ns(ht,"products"),Bt("userId","==",h.uid));E=await Rs(ce),Y=E.docs.map(oe=>({id:oe.id,name:String(oe.data().name??""),sellingPrice:Number(oe.data().sellingPrice??0),wholesalePrice:Number(oe.data().wholesalePrice??0),quantity:Number(oe.data().quantity??0),barcode:String(oe.data().barcode??""),serialNumber:String(oe.data().serialNumber??"")}))}if(Z(Y),N!=null&&N.shopId&&Y.length>0){const ce=Y.filter(oe=>{const Fe=((E==null?void 0:E.docs)||[]).find(we=>we.id===oe.id);return!(!!Fe&&!!Fe.data().shopId)});if(ce.length>0)try{await Promise.all(ce.map(oe=>aa(ls(ht,"products",oe.id),{shopId:N.shopId,updatedAt:Fs()}))),p({title:"تم ترتيب المنتجات",description:"تم ربط بعض المنتجات غير المربوطة بمتجرك الحالي تلقائياً."})}catch(oe){console.warn("تعذّر ترحيل shopId لبعض المنتجات:",oe)}}}catch(u){console.error("Error loading shop products:",u)}};a.useEffect(()=>{l&&(h!=null&&h.uid)&&(ze(),K())},[l,h==null?void 0:h.uid,N==null?void 0:N.shopId]);const M=()=>{if(!(h!=null&&h.uid)){console.log("No user authenticated, cannot load sales data");return}const u=new Date().toISOString().split("T")[0],E=localStorage.getItem(`salesData_${h.uid}_${u}`);b(E?JSON.parse(E):[])},le=u=>{if(!(h!=null&&h.uid)){console.log("No user authenticated, cannot save sales data");return}const E=new Date().toISOString().split("T")[0];localStorage.setItem(`salesData_${h.uid}_${E}`,JSON.stringify(u)),b(u)},K=async()=>{if(h!=null&&h.uid)try{const u=new Date,E=new Date(u.getFullYear(),u.getMonth(),1),Y=new Date(u.getFullYear(),u.getMonth()+1,0),ce=ot=>ot.toISOString().split("T")[0],oe=ce(E),Fe=ce(Y),Te=$s(ns(ht,"dailySales"),Bt("userId","==",h.uid),Bt("date",">=",oe),Bt("date","<=",Fe)),we=await Rs(Te);let Je=0,it=0;if(!we.empty)we.forEach(ot=>{const Ge=ot.data(),xt=Number(Ge.sellingPrice??0),Pt=Number(Ge.quantity??0),Ns=Number(Ge.profit??(Number(Ge.sellingPrice??0)-Number(Ge.wholesalePrice??0))*Pt);Je+=xt*Pt,it+=Ns});else{const ot=$s(ns(ht,"dailySales"),Bt("userId","==",h.uid));(await Rs(ot)).forEach(xt=>{const Pt=xt.data(),Ns=String(Pt.date??"").slice(0,10);if(Ns>=oe&&Ns<=Fe){const Vs=Number(Pt.sellingPrice??0),Ys=Number(Pt.quantity??0),ks=Number(Pt.profit??(Number(Pt.sellingPrice??0)-Number(Pt.wholesalePrice??0))*Ys);Je+=Vs*Ys,it+=ks}}),(Je>0||it>0)&&p({title:"تم استرجاع تقارير الشهر",description:"تم حساب التقارير باستخدام مسار احتياطي للتواريخ القديمة."})}$t(Je),lt(it)}catch(u){console.error("Error loading monthly stats:",u)}},Ne=async u=>{if(h!=null&&h.uid)try{const E=((u.price??0)-(u.wholesalePrice??0))*(u.quantity??0),Y=y&&F?"cashier":"admin",ce=Y==="cashier"?(F==null?void 0:F.name)||"كاشير":(N==null?void 0:N.fullName)||(h==null?void 0:h.displayName)||"الحساب الرئيسي",oe=Y==="cashier"&&(F==null?void 0:F.username)||null;await xn(ns(ht,"dailySales"),{userId:h.uid,productName:u.productName,quantity:u.quantity,wholesalePrice:u.wholesalePrice??null,sellingPrice:u.price,profit:E,date:u.date,time:u.time,performedByType:Y,performedByName:ce,performedByUsername:oe,serialNumber:u.serialNumber??null,barcode:u.barcode??null,createdAt:Fs()})}catch(E){console.error("Error saving sale:",E)}},Le=async u=>{const E=L[u.id]||"",Y=parseInt(E);if(isNaN(Y)||Y<=0){p({title:"كمية غير صالحة",description:"أدخل كمية صحيحة للبيـع",variant:"destructive"});return}if(Y>u.quantity){p({title:"كمية أكبر من المتاح",description:"الكمية المطلوب بيعها تتجاوز المخزون المتاح",variant:"destructive"});return}const ce=new Date,oe=y&&F?"cashier":"admin",Fe=oe==="cashier"?(F==null?void 0:F.name)||"كاشير":(N==null?void 0:N.fullName)||(h==null?void 0:h.displayName)||"الحساب الرئيسي",Te=oe==="cashier"&&(F==null?void 0:F.username)||null,we=(u.serialNumber||"").trim(),Je={id:Date.now().toString(),productName:u.name,price:u.sellingPrice,wholesalePrice:u.wholesalePrice,quantity:Y,date:ce.toISOString().split("T")[0],time:ce.toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit"}),performedByType:oe,performedByName:Fe,performedByUsername:Te,serialNumber:we||void 0,barcode:u.barcode};try{le([...x,Je]),await Ne(Je);const it=u.quantity-Y;await aa(ls(ht,"products",u.id),{quantity:it,updatedAt:Fs()}),Z(ot=>ot.map(Ge=>Ge.id===u.id?{...Ge,quantity:it}:Ge)),D(ot=>({...ot,[u.id]:""})),p({title:"تم البيع",description:`تم بيع ${Y} قطعة من ${u.name}`})}catch(it){console.error("Error selling product:",it),p({title:"فشل البيع",description:"تعذّر تنفيذ عملية البيع",variant:"destructive"})}},ts=async u=>{try{D(E=>({...E,[u.id]:"1"})),await Le(u)}catch(E){console.error("Error selling by barcode:",E)}},vt=async u=>{if(y){p({title:"غير مسموح في وضع الكاشير",description:"لا يمكن إضافة قطع أثناء الورديه",variant:"destructive"});return}const E=U[u.id]||"",Y=parseInt(E);if(isNaN(Y)||Y<=0){p({title:"كمية غير صالحة",description:"أدخل كمية صحيحة للإضافة",variant:"destructive"});return}re("تأكيد إضافة قطع","لا يمكن إضافة قطع إلا بإدخال الرقم السري الرئيسي",async()=>{try{const ce=u.quantity+Y;await aa(ls(ht,"products",u.id),{quantity:ce,updatedAt:Fs()}),Z(oe=>oe.map(Fe=>Fe.id===u.id?{...Fe,quantity:ce}:Fe)),H(oe=>({...oe,[u.id]:""})),p({title:"تمت الإضافة",description:`تمت إضافة ${Y} قطعة إلى ${u.name}`})}catch(ce){console.error("Error adding pieces:",ce),p({title:"فشل الإضافة",description:"تعذّر إضافة الكمية إلى المخزون",variant:"destructive"})}})},$e=async u=>{if(!(h!=null&&h.uid))return;if(y){p({title:"غير مسموح في وضع الكاشير",description:"لا يمكن حذف المنتجات أثناء الورديه",variant:"destructive"});return}window.confirm(`هل تريد حذف المنتج "${u.name}"؟`)&&re("تأكيد حذف منتج","لا يمكن حذف المنتجات إلا بإدخال الرقم السري الرئيسي",async()=>{try{await ac(ls(ht,"products",u.id)),Z(Y=>Y.filter(ce=>ce.id!==u.id)),p({title:"تم الحذف",description:`تم حذف المنتج ${u.name}`})}catch(Y){console.error("Error deleting product:",Y),p({title:"فشل الحذف",description:"تعذّر حذف المنتج",variant:"destructive"})}})},ut=async()=>{try{if(!(h!=null&&h.uid)){p({title:"خطأ",description:"غير مسجّل دخول",variant:"destructive"});return}if(y){p({title:"غير مسموح في وضع الكاشير",description:"لا يمكن إضافة منتجات أثناء الورديه",variant:"destructive"});return}const u=g.productName.trim(),E=parseFloat(g.price),Y=parseFloat(g.wholesalePrice||"0"),ce=parseInt(g.quantity);if(!u||isNaN(E)||isNaN(ce)){p({title:"بيانات غير مكتملة",description:"أدخل اسم المنتج والسعر والكمية",variant:"destructive"});return}const oe={name:u,sellingPrice:E,wholesalePrice:isNaN(Y)?0:Y,quantity:isNaN(ce)?0:ce,userId:h.uid,createdAt:Fs(),updatedAt:Fs()},Fe=(g.barcode||"").trim();Fe&&(oe.barcode=Fe);const Te=(g.serialNumber||"").trim();Te&&(oe.serialNumber=Te),N!=null&&N.shopId&&(oe.shopId=N.shopId);const we=await xn(ns(ht,"products"),oe);Z(Je=>[{id:we.id,name:u,sellingPrice:E,wholesalePrice:isNaN(Y)?0:Y,quantity:isNaN(ce)?0:ce,barcode:(g.barcode||"").trim()||"",serialNumber:(g.serialNumber||"").trim()||""},...Je]),t({productName:"",price:"",wholesalePrice:"",quantity:"",barcode:"",serialNumber:""}),p({title:"تمت الإضافة",description:`تم إضافة المنتج ${u} بنجاح`})}catch(u){console.error("createProduct error",u),p({title:"فشل الإضافة",description:"تعذّر إضافة المنتج. حاول مجددًا",variant:"destructive"})}},He=async u=>{const E=(u||"").trim();if(!E)return;const Y=z.find(ce=>(ce.barcode||"")===E);if(!Y){p({title:"باركود غير معروف",description:"لم يتم العثور على منتج بهذا الباركود"});return}await ts(Y)},zt=()=>{const u=Object.entries(ee).map(([Je,it])=>{const ot=Number(it),Ge=z.find(xt=>xt.id===Je);return!Ge||!ot||ot<=0?null:{name:Ge.name,qty:ot,price:Ge.sellingPrice,total:ot*Ge.sellingPrice}}).filter(Boolean);if(u.length===0){p({title:"لم يتم اختيار منتجات",description:"فعّل وضع الفاتورة واختر منتجات وكميات للطباعة"});return}const E=(N==null?void 0:N.shopName)||(h==null?void 0:h.displayName)||"المحل",Y=(N==null?void 0:N.phone)||(h==null?void 0:h.phoneNumber)||"",ce=u.reduce((Je,it)=>Je+it.total,0),oe=new Date().toLocaleString("ar-EG"),Fe=u.map(Je=>`
        <tr>
          <td style="border:1px solid #ddd;padding:6px">${Je.name}</td>
          <td style="border:1px solid #ddd;padding:6px;text-align:center">${Je.qty}</td>
          <td style="border:1px solid #ddd;padding:6px;text-align:center">${gt(Je.price)}</td>
          <td style="border:1px solid #ddd;padding:6px;text-align:center;font-weight:bold;color:#0a7">${gt(Je.total)}</td>
        </tr>
      `).join(""),Te=`
      <html>
        <head>
          <meta charset="utf-8" />
          <title>فاتورة</title>
          <style>
            body { font-family: Tahoma, Arial, sans-serif; direction: rtl; }
            .header { text-align: center; margin-bottom: 12px; }
            .header h2 { margin: 0; }
            .meta { text-align: center; color: #555; margin-bottom: 8px; }
            table { width: 100%; border-collapse: collapse; }
            .total { text-align: left; font-weight: bold; margin-top: 10px; }
          </style>
        </head>
        <body>
          <div class="header">
            <h2>${E}</h2>
            ${Y?`<div class="meta">رقم التليفون: ${Y}</div>`:""}
            <div class="meta">التاريخ: ${oe}</div>
          </div>
          <table>
            <thead>
              <tr>
                <th style="border:1px solid #ddd;padding:6px">المنتج</th>
                <th style="border:1px solid #ddd;padding:6px">الكمية</th>
                <th style="border:1px solid #ddd;padding:6px">السعر</th>
                <th style="border:1px solid #ddd;padding:6px">الإجمالي</th>
              </tr>
            </thead>
            <tbody>
              ${Fe}
            </tbody>
          </table>
          <div class="total">الإجمالي الكلي: ${gt(ce)}</div>
        </body>
      </html>
    `,we=window.open("","_blank");we&&(we.document.write(Te),we.document.close(),we.focus(),we.print(),we.close())};return e.jsxs(me,{open:l,onOpenChange:m,children:[e.jsxs(he,{className:"max-w-7xl md:max-w-6xl lg:max-w-7xl w-[95vw] md:w-[90vw] h-[95vh] md:h-[90vh] p-0 overflow-y-auto",children:[e.jsx(ue,{className:"px-3 md:px-6 py-3 md:py-4 border-b bg-gradient-to-r from-blue-50 to-purple-50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 md:gap-3",children:[e.jsx("div",{className:"p-1.5 md:p-2 bg-blue-100 rounded-lg",children:e.jsx(gn,{className:"h-5 w-5 md:h-6 md:w-6 text-blue-600"})}),e.jsxs("div",{children:[e.jsx(xe,{className:"text-lg md:text-xl font-bold text-gray-800",children:"📊 بيانات المبيعات اليومية"}),e.jsxs("p",{className:"text-xs md:text-sm text-gray-600 mt-1 hidden sm:block",children:["إدارة وتتبع مبيعات اليوم - ",new Date().toLocaleDateString("ar-EG")]})]})]}),e.jsx("div",{className:"flex items-center gap-1 md:gap-2",children:e.jsx(c,{variant:"ghost",size:"sm",onClick:m,className:"h-8 w-8 md:h-9 md:w-9",children:e.jsx(Ul,{className:"h-4 w-4"})})})]})}),e.jsxs("div",{className:"flex flex-col md:flex-row h-full",dir:"rtl",children:[e.jsxs("div",{className:"w-full md:w-72 lg:w-80 bg-white/50 border-r",children:[e.jsxs("div",{className:"p-3 md:p-4 border-b bg-white/30",children:[e.jsxs("h3",{className:"font-semibold text-gray-800 mb-3 flex items-center gap-2 text-sm md:text-base",children:[e.jsx(nt,{className:"h-4 w-4 text-green-600"}),"ملخص المبيعات"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 md:gap-3",children:[e.jsxs("div",{className:"bg-blue-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-blue-600",children:gt(x.reduce((u,E)=>u+E.price*E.quantity,0))}),e.jsx("div",{className:"text-xs md:text-sm text-blue-600",children:"إجمالي المبيعات"})]}),e.jsxs("div",{className:"relative bg-green-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsxs("div",{className:ne?"filter blur-sm pointer-events-none":"",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-green-600",children:gt(x.reduce((u,E)=>u+(E.price-(E.wholesalePrice??0))*E.quantity,0))}),e.jsx("div",{className:"text-xs md:text-sm text-green-600",children:"إجمالي الأرباح"})]}),ne&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx(c,{size:"sm",variant:"ghost",onClick:()=>Pe(!0),className:"bg-white/80 hover:bg-white text-green-700 border border-green-200",children:"عرض الأرباح"})})]}),e.jsxs("div",{className:"bg-yellow-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-yellow-600",children:ea(z.length)}),e.jsx("div",{className:"text-xs md:text-sm text-yellow-600",children:"عدد المنتجات"})]}),e.jsxs("div",{className:"bg-purple-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-purple-600",children:ea(x.length)}),e.jsx("div",{className:"text-xs md:text-sm text-purple-600",children:"عدد المبيعات"})]})]}),e.jsxs("div",{className:"relative mb-2",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-1 md:gap-2 text-xs md:text-sm font-semibold text-indigo-700",children:[e.jsx(Ts,{className:"h-3 w-3 md:h-4 md:w-4"}),e.jsx(gn,{className:"h-3 w-3 md:h-4 md:w-4"}),e.jsx("span",{children:"تقارير الشهر"})]}),e.jsx(c,{size:"sm",variant:"ghost",onClick:()=>Ft(u=>!u),className:"h-6 w-6 p-0 rounded-full",title:wt?"إظهار التقارير":"إخفاء التقارير",children:wt?e.jsx(jn,{className:"h-4 w-4"}):e.jsx(Kl,{className:"h-4 w-4"})})]}),e.jsx("div",{className:wt?"overflow-hidden max-h-0 transition-[max-height] duration-300":"overflow-hidden transition-[max-height] duration-300 max-h-[400px]",children:e.jsxs("div",{className:We?"grid grid-cols-2 gap-2 md:gap-4 filter blur-sm pointer-events-none":"grid grid-cols-2 gap-2 md:gap-4",children:[e.jsxs("div",{className:"bg-indigo-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-indigo-600",children:gt(_e)}),e.jsx("div",{className:"text-xs md:text-sm text-indigo-600",children:"مبيعات الشهر"})]}),e.jsxs("div",{className:"bg-pink-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-pink-600",children:gt(st)}),e.jsx("div",{className:"text-xs md:text-sm text-pink-600",children:"أرباح الشهر"})]})]})}),!wt&&We&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center rounded-lg bg-yellow-100/60",children:e.jsxs(c,{size:"sm",variant:"ghost",onClick:async()=>{try{if(await isZeroPlan()){p({title:"الخطة زيرو",description:"التقارير الشهرية غير متاحة في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}catch{}Ye(!0)},className:"flex items-center gap-2 bg-yellow-200/70 hover:bg-yellow-300 text-yellow-900 px-3 py-2 rounded-xl shadow-md hover:shadow-lg transition-all",title:"عرض تقارير الشهر",children:[e.jsx(Ue,{className:"h-5 w-5 md:h-7 md:w-7"}),e.jsx("span",{className:"text-xs md:text-sm",children:"عرض تقارير الشهر"})]})})]})]}),e.jsx("div",{className:"p-3 md:p-4 border-b bg-white/30",children:e.jsxs("h3",{className:"font-semibold text-gray-800 mb-3 flex items-center gap-2 text-sm md:text-base",children:[e.jsx(lr,{className:"h-4 w-4 text-indigo-600"}),"إحصائيات المنتجات"]})}),e.jsx("div",{className:"p-3 md:p-4 flex-1 overflow-y-auto hidden md:block",children:e.jsxs("h3",{className:"font-semibold text-gray-800 mb-3 flex items-center gap-2",children:[e.jsx(vn,{className:"h-4 w-4 text-blue-600"}),"نصائح للمبيعات"]})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto transition-all duration-300 ease-in-out scrollbar-thin scrollbar-thumb-blue-300 scrollbar-track-blue-100 hover:scrollbar-thumb-blue-400",children:e.jsxs("div",{className:"p-3 md:p-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 md:mb-6 gap-2",children:[e.jsxs("h2",{className:"text-base md:text-lg font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(Yc,{className:"h-4 w-4 md:h-5 md:w-5 text-blue-600"}),"سجل المبيعات (",x.length," عنصر)"]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs md:text-sm text-gray-600",children:[e.jsx(Ts,{className:"h-3 w-3 md:h-4 md:w-4"}),e.jsx("span",{className:"hidden sm:inline",children:new Date().toLocaleDateString("ar-EG")}),e.jsx(zs,{className:"h-3 w-3 md:h-4 md:w-4 ml-2"}),e.jsx("span",{children:new Date().toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit"})})]})]}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-3 md:p-4 mb-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("h3",{className:"text-sm md:text-base font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(kt,{className:"h-4 w-4 text-emerald-600"}),"إضافة منتج جديد"]}),e.jsxs(c,{size:"sm",variant:"ghost",className:"h-8",onClick:()=>{if(y){p({title:"غير مسموح في وضع الكاشير",description:"لا يمكن إضافة منتج أثناء الورديه",variant:"destructive"});return}re("فتح نموذج إضافة منتج","أدخل الرقم السري الرئيسي لفتح نموذج الإضافة",()=>S(!0))},children:[e.jsx(kt,{className:"h-4 w-4 text-emerald-600"}),"إضافة منتج"]})]}),W&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx(V,{htmlFor:"new-product-name",className:"text-xs md:text-sm",children:"اسم المنتج"}),e.jsx(R,{id:"new-product-name",value:g.productName,onChange:u=>t(E=>({...E,productName:u.target.value})),placeholder:"أدخل اسم المنتج"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx(V,{htmlFor:"new-product-price",className:"text-xs md:text-sm",children:"سعر البيع (ج.م)"}),e.jsx(R,{type:"number",id:"new-product-price",value:g.price,onChange:u=>t(E=>({...E,price:u.target.value})),placeholder:"0.00"})]}),e.jsxs("div",{children:[e.jsx(V,{htmlFor:"new-product-wholesale",className:"text-xs md:text-sm",children:"سعر الجملة (ج.م)"}),e.jsx(R,{type:"number",id:"new-product-wholesale",value:g.wholesalePrice||"",onChange:u=>t(E=>({...E,wholesalePrice:u.target.value})),placeholder:"0.00"})]})]}),e.jsxs("div",{children:[e.jsx(V,{htmlFor:"new-product-qty",className:"text-xs md:text-sm",children:"الكمية"}),e.jsx(R,{type:"number",id:"new-product-qty",value:g.quantity,onChange:u=>t(E=>({...E,quantity:u.target.value})),placeholder:"1"})]}),e.jsxs("div",{children:[e.jsx(V,{htmlFor:"new-product-barcode",className:"text-xs md:text-sm",children:"باركود المنتج (اختياري)"}),e.jsx(R,{id:"new-product-barcode",value:g.barcode||"",onChange:u=>t(E=>({...E,barcode:u.target.value})),placeholder:"أدخل/امسح الباركود"})]}),e.jsxs("div",{children:[e.jsx(V,{htmlFor:"new-product-serial",className:"text-xs md:text-sm",children:"سيريال الجهاز (اختياري)"}),e.jsx(R,{id:"new-product-serial",value:g.serialNumber||"",onChange:u=>t(E=>({...E,serialNumber:u.target.value})),placeholder:"أدخل سيريال الجهاز"})]}),e.jsx(c,{className:"h-9 w-full md:w-auto",onClick:ut,children:"إضافة المنتج"})]})]}),e.jsx("div",{id:"shop-products-section",className:"bg-white rounded-lg border border-gray-200 overflow-hidden mb-4",children:e.jsxs("div",{className:"mb-4",children:[e.jsxs("h3",{className:"text-sm md:text-base font-semibold text-gray-800 mb-2 flex items-center gap-2",children:[e.jsx(lr,{className:"h-4 w-4 text-green-600"}),"منتجات المحل"]}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(c,{variant:_?"default":"outline",size:"sm",onClick:()=>ae(u=>!u),children:_?"وضع الفاتورة: مفعل":"تفعيل وضع الفاتورة"}),e.jsx(c,{size:"sm",className:"bg-indigo-600 hover:bg-indigo-700 text-white",disabled:Object.keys(ee).filter(u=>(ee[u]||0)>0).length===0,onClick:zt,children:"طباعة فاتورة"})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(R,{value:pe,onChange:u=>Oe(u.target.value),placeholder:"ابحث عن منتج...",className:"h-9 w-full md:w-72 text-sm","aria-label":"البحث عن منتج من منتجات المحل"}),e.jsx(R,{value:$,onChange:u=>C(u.target.value),onKeyDown:async u=>{if(u.key!=="Enter")return;const E=$.trim();E&&(await He(E),C(""))},placeholder:"مرّر ماسح الباركود هنا (اختياري)",className:"h-9 w-full md:w-64 text-sm","aria-label":"مسح الباركود لإضافة المنتج تلقائياً"}),pe&&e.jsx(c,{variant:"ghost",size:"sm",className:"h-9",onClick:()=>Oe(""),children:"مسح"})]}),e.jsx("div",{className:"overflow-x-auto border border-gray-200 rounded-lg hidden md:block",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"المنتج"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"سعر البيع"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("span",{children:"سعر الجملة"}),e.jsx(c,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>A(u=>!u),"aria-label":J?"إخفاء سعر الجملة":"إظهار سعر الجملة",children:J?e.jsx(Ct,{className:"h-4 w-4"}):e.jsx(Ue,{className:"h-4 w-4"})})]})}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"المتاح"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"بيع"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:Ie.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"px-3 py-3 text-center text-gray-500",children:z.length===0?"لا توجد منتجات بعد، أضف منتجاً من النموذج أعلاه":"لا توجد نتائج مطابقة للبحث"})}):Ie.map(u=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-3 py-2 font-medium text-gray-900",children:u.name}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:gt(u.sellingPrice)}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:e.jsx("span",{className:J?"":"blur-sm select-none",children:gt(u.wholesalePrice)})}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:ea(u.quantity)}),e.jsx("td",{className:"px-3 py-2",children:e.jsxs("div",{className:"flex items-center gap-2 flex-nowrap",children:[e.jsx(R,{value:L[u.id]||"",onChange:E=>D(Y=>({...Y,[u.id]:E.target.value})),type:"number",placeholder:"عدد القطع للبيع",className:"h-8 w-28 text-sm"}),e.jsx(c,{size:"sm",className:"h-8 min-w-[64px]",onClick:()=>Le(u),children:"بيع"}),_&&e.jsx(R,{value:ee[u.id]??"",onChange:E=>{const Y=parseInt(E.target.value||"0");fe(ce=>({...ce,[u.id]:isNaN(Y)?0:Y}))},type:"number",placeholder:"كمية للفاتورة",className:"h-8 w-24 text-sm"}),e.jsx(R,{value:U[u.id]||"",onChange:E=>H(Y=>({...Y,[u.id]:E.target.value})),type:"number",placeholder:"عدد للإضافة",className:"h-8 w-28 text-sm",disabled:y}),e.jsxs("div",{className:"inline-flex items-center gap-2 flex-nowrap",children:[e.jsx(c,{size:"sm",variant:"outline",className:"h-8 whitespace-nowrap",onClick:()=>vt(u),disabled:y,title:y?"غير مسموح في وضع الكاشير":void 0,children:"إضافة قطع جديدة"}),e.jsx(c,{size:"sm",variant:"destructive",className:"h-8",onClick:()=>$e(u),title:"حذف المنتج",disabled:y,children:e.jsx(_t,{className:"h-4 w-4"})})]})]})})]},u.id))})]})}),e.jsx("div",{className:"block md:hidden space-y-3",children:Ie.length===0?e.jsx("div",{className:"text-center text-gray-500 text-sm",children:z.length===0?"لا توجد منتجات بعد، أضف منتجاً من النموذج أعلاه":"لا توجد نتائج مطابقة للبحث"}):Ie.map(u=>e.jsxs("div",{className:"bg-white rounded-xl p-3 border border-gray-200 shadow-sm",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"font-semibold text-gray-900 text-sm break-words",children:u.name}),e.jsx(c,{size:"sm",variant:"destructive",className:"h-8 min-w-[44px] touch-manipulation",onClick:()=>$e(u),title:"حذف المنتج",disabled:y,children:e.jsx(_t,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-2 text-xs text-gray-700",children:[e.jsx("div",{className:"text-gray-600",children:"سعر البيع"}),e.jsx("div",{className:"text-right font-medium",children:gt(u.sellingPrice)}),e.jsxs("div",{className:"text-gray-600 inline-flex items-center gap-1",children:[e.jsx("span",{children:"سعر الجملة"}),e.jsx(c,{variant:"ghost",size:"icon",className:"h-5 w-5",onClick:()=>A(E=>!E),"aria-label":J?"إخفاء سعر الجملة":"إظهار سعر الجملة",children:J?e.jsx(Ct,{className:"h-4 w-4"}):e.jsx(Ue,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"text-right font-medium",children:e.jsx("span",{className:J?"":"blur-sm select-none",children:gt(u.wholesalePrice)})}),e.jsx("div",{className:"text-gray-600",children:"المتاح"}),e.jsx("div",{className:"text-right font-medium",children:ea(u.quantity)})]}),e.jsxs("div",{className:"mt-3 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(R,{value:L[u.id]||"",onChange:E=>D(Y=>({...Y,[u.id]:E.target.value})),type:"number",placeholder:"عدد القطع للبيع",className:"h-9 flex-1 text-sm","aria-label":`عدد القطع للبيع لـ ${u.name}`}),e.jsx(c,{size:"sm",className:"h-9 min-w-[64px]",onClick:()=>Le(u),children:"بيع"})]}),_&&e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(R,{value:ee[u.id]??"",onChange:E=>{const Y=parseInt(E.target.value||"0");fe(ce=>({...ce,[u.id]:isNaN(Y)?0:Y}))},type:"number",placeholder:"كمية للفاتورة",className:"h-9 flex-1 text-sm","aria-label":`كمية للفاتورة لـ ${u.name}`})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(R,{value:U[u.id]||"",onChange:E=>H(Y=>({...Y,[u.id]:E.target.value})),type:"number",placeholder:"عدد للإضافة",className:"h-9 flex-1 text-sm","aria-label":`عدد القطع للإضافة لـ ${u.name}`,disabled:y}),e.jsx(c,{size:"sm",variant:"outline",className:"h-9 min-w-[64px]",onClick:()=>vt(u),disabled:y,title:y?"غير مسموح في وضع الكاشير":void 0,children:"إضافة"})]})]})]},u.id))})]})}),x.length===0?e.jsxs("div",{className:"text-center py-8 md:py-12",children:[e.jsx("div",{className:"w-16 h-16 md:w-24 md:h-24 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center",children:e.jsx(lr,{className:"h-8 w-8 md:h-12 md:w-12 text-gray-400"})}),e.jsx("h3",{className:"text-base md:text-lg font-medium text-gray-900 mb-2",children:"لا توجد مبيعات اليوم"}),e.jsx("p",{className:"text-sm text-gray-500",children:"ابدأ ببيع منتج من القائمة أعلاه"})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"block md:hidden",children:e.jsx("div",{className:"max-h-[70vh] overflow-y-auto space-y-3 p-3",children:x.map(u=>e.jsxs("div",{className:"bg-white rounded-xl p-4 border border-gray-200 shadow-sm",children:[e.jsx("div",{className:"mb-3",children:e.jsx("h4",{className:"font-semibold text-gray-900 text-base break-words",children:u.productName})}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-2 text-sm text-gray-700",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(nt,{className:"h-4 w-4 text-blue-600"}),e.jsx("span",{className:"text-gray-600",children:"سعر البيع"})]}),e.jsx("div",{className:"text-right font-medium",children:gt(u.price)}),typeof u.wholesalePrice=="number"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(nt,{className:"h-4 w-4 text-indigo-600"}),e.jsxs("span",{className:"text-gray-600 inline-flex items-center gap-1",children:["سعر الجملة",e.jsx(c,{variant:"ghost",size:"icon",className:"h-5 w-5",onClick:()=>A(E=>!E),"aria-label":J?"إخفاء سعر الجملة":"إظهار سعر الجملة",children:J?e.jsx(Ct,{className:"h-4 w-4"}):e.jsx(Ue,{className:"h-4 w-4"})})]})]}),e.jsx("div",{className:"text-right font-medium",children:e.jsx("span",{className:J?"":"blur-sm select-none",children:gt(u.wholesalePrice)})})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(lr,{className:"h-4 w-4 text-emerald-600"}),e.jsx("span",{className:"text-gray-600",children:"الكمية"})]}),e.jsx("div",{className:"text-right font-medium",children:ea(u.quantity)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(sa,{className:"h-4 w-4 text-purple-600"}),e.jsx("span",{className:"text-gray-600",children:"الربح"})]}),e.jsx("div",{className:"text-right font-semibold text-purple-700",children:gt(((u.price??0)-(u.wholesalePrice??0))*(u.quantity??0))}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(nt,{className:"h-4 w-4 text-green-600"}),e.jsx("span",{className:"text-gray-600",children:"الإجمالي"})]}),e.jsx("div",{className:"text-right font-bold text-green-700",children:gt(u.price*u.quantity)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(qc,{className:"h-4 w-4 text-amber-600"}),e.jsx("span",{className:"text-gray-600",children:"المنفذ"})]}),e.jsx("div",{className:"text-right text-gray-700",children:u.performedByName??"-"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ts,{className:"h-4 w-4 text-blue-600"}),e.jsx("span",{className:"text-gray-600",children:"التاريخ"})]}),e.jsx("div",{className:"text-right text-gray-600",children:El(u.date)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(zs,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"text-gray-600",children:"الوقت"})]}),e.jsx("div",{className:"text-right text-gray-600",children:u.time})]})]},u.id))})}),e.jsx("div",{className:"hidden md:block overflow-x-auto max-h-96 overflow-y-auto scrollbar-thin scrollbar-thumb-green-300 scrollbar-track-green-100 hover:scrollbar-thumb-green-400",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"المنتج"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"سعر البيع (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("span",{children:"سعر الجملة (ج.م)"}),e.jsx(c,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>A(u=>!u),"aria-label":J?"إخفاء سعر الجملة":"إظهار سعر الجملة",children:J?e.jsx(Ct,{className:"h-4 w-4"}):e.jsx(Ue,{className:"h-4 w-4"})})]})}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الكمية"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الإجمالي (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الربح (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"التاريخ"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الوقت"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"المنفذ"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:x.map((u,E)=>e.jsxs("tr",{className:E%2===0?"bg-white":"bg-gray-50/50",children:[e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-gray-900",children:u.productName}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:gt(u.price)}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:typeof u.wholesalePrice=="number"?e.jsx("span",{className:J?"":"blur-sm select-none",children:gt(u.wholesalePrice)}):"-"}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:ea(u.quantity)}),e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-green-600",children:gt(u.price*u.quantity)}),e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-purple-600",children:gt(((u.price??0)-(u.wholesalePrice??0))*(u.quantity??0))}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-500",children:El(u.date)}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-500",children:u.time}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:u.performedByName??"-"})]},u.id))})]})})]}),e.jsxs("div",{className:"mt-4 md:mt-6 text-xs text-gray-500 text-center bg-gray-50/50 p-2 md:p-3 rounded border border-gray-200/40 space-y-1",children:[e.jsx("p",{className:"font-medium text-gray-600",children:"💰 نظام إدارة المبيعات اليومية"}),e.jsxs("p",{className:"hidden sm:block",children:["• يتم حفظ البيانات تلقائياً لليوم الحالي: ",new Date().toLocaleDateString("ar-EG")]}),e.jsx("p",{children:"• يمكنك إضافة وتعديل وحذف المنتجات حسب الحاجة"}),e.jsx("p",{className:"hidden sm:block",children:"• يتم حفظ البيانات محلياً وعلى Firebase لتعزيز الأمان"})]})]})})]})]}),e.jsx(Xt,{open:ie,onOpenChange:Pe,mode:"verify",title:"قفل إجمالي الأرباح",description:"أدخل الرقم السري الرئيسي لعرض إجمالي الأرباح",onSuccess:()=>{q(!1),Pe(!1)}}),e.jsx(Xt,{open:At,onOpenChange:Ye,mode:"verify",title:"قفل إحصائيات الشهر",description:"لا يمكن الاطلاع على تقارير الشهر إلا بإدخال الرقم السري الرئيسي",onSuccess:async()=>{try{const u=h==null?void 0:h.uid;if(u){const E=await yn(u),Y=(E==null?void 0:E.planType)??(E==null?void 0:E.plan)??null,ce=typeof Y=="string"?Y.toLowerCase():null;if(Y===fs.ZERO||ce==="zero"){p({title:"الخطة زيرو",description:"التقارير الشهرية غير متاحة في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}}catch{}Tt(!1),Ye(!1),K()}}),e.jsx(Xt,{open:ft,onOpenChange:St,mode:"verify",title:Rt,description:ds,onSuccess:()=>{const u=P.current;P.current=null,St(!1),u&&u()}})]})}const ea=l=>new Intl.NumberFormat("ar-EG").format(Number(l||0)),gt=l=>`${new Intl.NumberFormat("ar-EG",{minimumFractionDigits:2,maximumFractionDigits:2}).format(Number(l||0))} ج.م`,El=l=>{try{const m=new Date(l);return isNaN(m.getTime())?new Date(`${l}T00:00:00`).toLocaleDateString("ar-EG"):m.toLocaleDateString("ar-EG")}catch{return l}};function ei({size:l=24,className:m,...i}){return e.jsxs("svg",{width:l,height:l,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",className:m,...i,children:[e.jsx("rect",{x:"5",y:"2.5",width:"14",height:"19",rx:"2.5",stroke:"currentColor",strokeWidth:"1.5"}),e.jsx("rect",{x:"7",y:"4.5",width:"10",height:"5.5",rx:"1",stroke:"currentColor",strokeWidth:"1.2"}),e.jsx("path",{d:"M9.5 11.5h5",stroke:"currentColor",strokeWidth:"1.4",strokeLinecap:"round"}),e.jsx("circle",{cx:"8.5",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"12",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"15.5",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"8.5",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"12",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"15.5",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("rect",{x:"8",y:"19",width:"9",height:"1.8",rx:"0.6",stroke:"currentColor",strokeWidth:"1"})]})}var ti="AlertDialog",[dd,Lm]=rc(ti,[ql]),js=ql(),si=l=>{const{__scopeAlertDialog:m,...i}=l,x=js(m);return e.jsx(Nc,{...x,...i,modal:!0})};si.displayName=ti;var md="AlertDialogTrigger",hd=a.forwardRef((l,m)=>{const{__scopeAlertDialog:i,...x}=l,b=js(i);return e.jsx(gc,{...b,...x,ref:m})});hd.displayName=md;var ud="AlertDialogPortal",ai=l=>{const{__scopeAlertDialog:m,...i}=l,x=js(m);return e.jsx(wc,{...x,...i})};ai.displayName=ud;var xd="AlertDialogOverlay",ri=a.forwardRef((l,m)=>{const{__scopeAlertDialog:i,...x}=l,b=js(i);return e.jsx(fc,{...b,...x,ref:m})});ri.displayName=xd;var ra="AlertDialogContent",[pd,gd]=dd(ra),fd=lc("AlertDialogContent"),ni=a.forwardRef((l,m)=>{const{__scopeAlertDialog:i,children:x,...b}=l,g=js(i),t=a.useRef(null),W=_l(m,t),S=a.useRef(null);return e.jsx(vc,{contentName:ra,titleName:li,docsSlug:"alert-dialog",children:e.jsx(pd,{scope:i,cancelRef:S,children:e.jsxs(bc,{role:"alertdialog",...g,...b,ref:W,onOpenAutoFocus:nc(b.onOpenAutoFocus,p=>{var h;p.preventDefault(),(h=S.current)==null||h.focus({preventScroll:!0})}),onPointerDownOutside:p=>p.preventDefault(),onInteractOutside:p=>p.preventDefault(),children:[e.jsx(fd,{children:x}),e.jsx(bd,{contentRef:t})]})})})});ni.displayName=ra;var li="AlertDialogTitle",ii=a.forwardRef((l,m)=>{const{__scopeAlertDialog:i,...x}=l,b=js(i);return e.jsx(yc,{...b,...x,ref:m})});ii.displayName=li;var oi="AlertDialogDescription",ci=a.forwardRef((l,m)=>{const{__scopeAlertDialog:i,...x}=l,b=js(i);return e.jsx(jc,{...b,...x,ref:m})});ci.displayName=oi;var vd="AlertDialogAction",di=a.forwardRef((l,m)=>{const{__scopeAlertDialog:i,...x}=l,b=js(i);return e.jsx(Vl,{...b,...x,ref:m})});di.displayName=vd;var mi="AlertDialogCancel",hi=a.forwardRef((l,m)=>{const{__scopeAlertDialog:i,...x}=l,{cancelRef:b}=gd(mi,i),g=js(i),t=_l(m,b);return e.jsx(Vl,{...g,...x,ref:t})});hi.displayName=mi;var bd=({contentRef:l})=>{const m=`\`${ra}\` requires a description for the component to be accessible for screen reader users.

You can add a description to the \`${ra}\` by passing a \`${oi}\` component as a child, which also benefits sighted users by adding visible context to the dialog.

Alternatively, you can use your own component as a description by assigning it an \`id\` and passing the same value to the \`aria-describedby\` prop in \`${ra}\`. If the description is confusing or duplicative for sighted users, you can use the \`@radix-ui/react-visually-hidden\` primitive as a wrapper around your description component.

For more information, see https://radix-ui.com/primitives/docs/components/alert-dialog`;return a.useEffect(()=>{var x;document.getElementById((x=l.current)==null?void 0:x.getAttribute("aria-describedby"))||console.warn(m)},[m,l]),null},yd=si,jd=ai,ui=ri,xi=ni,pi=di,gi=hi,fi=ii,vi=ci;const Nd=yd,wd=jd,bi=a.forwardRef(({className:l,...m},i)=>e.jsx(ui,{className:Ks("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",l),...m,ref:i}));bi.displayName=ui.displayName;const yi=a.forwardRef(({className:l,...m},i)=>e.jsxs(wd,{children:[e.jsx(bi,{}),e.jsx(xi,{ref:i,className:Ks("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",l),...m})]}));yi.displayName=xi.displayName;const ji=({className:l,...m})=>e.jsx("div",{className:Ks("flex flex-col space-y-2 text-center sm:text-left",l),...m});ji.displayName="AlertDialogHeader";const Ni=a.forwardRef(({className:l,...m},i)=>e.jsx(fi,{ref:i,className:Ks("text-lg font-semibold",l),...m}));Ni.displayName=fi.displayName;const wi=a.forwardRef(({className:l,...m},i)=>e.jsx(vi,{ref:i,className:Ks("text-sm text-muted-foreground",l),...m}));wi.displayName=vi.displayName;const bn=a.forwardRef(({className:l,...m},i)=>e.jsx(pi,{ref:i,className:Ks(Jl(),l),...m}));bn.displayName=pi.displayName;const Si=a.forwardRef(({className:l,...m},i)=>e.jsx(gi,{ref:i,className:Ks(Jl({variant:"outline"}),"mt-2 sm:mt-0",l),...m}));Si.displayName=gi.displayName;const Be=l=>{try{return l.toLocaleString("en-US",{maximumFractionDigits:2})}catch{return String(l)}},Ml=l=>{try{return(l?new Date(l):new Date).toLocaleString("en-GB",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}catch{return new Date().toISOString()}},ir="machine_daily_opening_values",Bl="machine_daily_receipts",Ll="machine_daily_transfer_receipts",un="machine_daily_opening_snapshot";function Sd({open:l,onOpenChange:m}){const{toast:i}=cs(),{shiftUser:x}=Ia(),[b,g]=a.useState(""),[t,W]=a.useState(""),[S,p]=a.useState(""),[h,N]=a.useState(null),[y,F]=a.useState(null),[z,Z]=a.useState(null),[L,D]=a.useState(null),[U,H]=a.useState(!1),[$,C]=a.useState(!1),[_,ae]=a.useState(""),[ee,fe]=a.useState(""),[J,A]=a.useState(null),[ne,q]=a.useState(()=>{try{const M=localStorage.getItem(Bl),le=M?JSON.parse(M):[];return Array.isArray(le)?le:[]}catch{return[]}}),[ie,Pe]=a.useState(()=>{try{const M=localStorage.getItem(Ll),le=M?JSON.parse(M):[];return Array.isArray(le)?le:[]}catch{return[]}}),[Ve,It]=a.useState(!1),[_e,$t]=a.useState(""),[st,lt]=a.useState(""),[At,Ye]=a.useState(!1),[We,Tt]=a.useState(null);a.useEffect(()=>{if(l)try{const M=localStorage.getItem(ir);if(M){const K=JSON.parse(M);typeof(K==null?void 0:K.openingBase)=="number"&&N(K.openingBase),typeof(K==null?void 0:K.openingAir)=="number"&&F(K.openingAir),typeof(K==null?void 0:K.drawerCash)=="number"&&Z(K.drawerCash)}const le=localStorage.getItem(un);if(le){const K=JSON.parse(le);typeof(K==null?void 0:K.openingBase)=="number"&&typeof(K==null?void 0:K.openingAir)=="number"&&D({openingBase:K.openingBase,openingAir:K.openingAir,drawerCash:K.drawerCash||0})}}catch{}},[l]),a.useEffect(()=>{try{localStorage.setItem(Bl,JSON.stringify(ne))}catch{}},[ne]),a.useEffect(()=>{try{localStorage.setItem(Ll,JSON.stringify(ie))}catch{}},[ie]);const wt=a.useMemo(()=>(x==null?void 0:x.displayName)||(x==null?void 0:x.name)||(x==null?void 0:x.username)||void 0,[x]),Ft=a.useMemo(()=>ie.reduce((M,le)=>M+(le.profit||0),0),[ie]),ft=a.useMemo(()=>ie.reduce((M,le)=>M+(le.wholesalePrice||0),0),[ie]),St=()=>{ie.length!==0&&(Pe([]),i({title:"تم حذف الإيصالات",description:"تم مسح كل إيصالات التحويل."}))},Rt=()=>{ne.length!==0&&(q([]),i({title:"تم حذف الإيصالات",description:"تم مسح كل إيصالات الماكينة."}))},Ht=M=>{q(le=>le.filter(K=>K.id!==M)),i({title:"تم حذف الإيصال",description:"تم إزالة إيصال الماكينة المحدد."})},ds=()=>{N(null),F(null),Z(null),D(null),g(""),W(""),p("");try{localStorage.removeItem(ir),localStorage.removeItem(un)}catch{}i({title:"تم التصفير",description:"يمكنك الآن إدخال رصيد افتتاحي جديد."})},Et=()=>{const M=parseFloat(b||"0"),le=parseFloat(t||"0"),K=parseFloat(S||"0");if(isNaN(M)||isNaN(le)||isNaN(K)){i({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة للرصيد الافتتاحي وفلوس الدرج.",variant:"destructive"});return}if(M<0||le<0||K<0){i({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}N(M),F(le),Z(K);try{localStorage.setItem(ir,JSON.stringify({openingBase:M,openingAir:le,drawerCash:K})),localStorage.setItem(un,JSON.stringify({openingBase:M,openingAir:le,drawerCash:K})),D({openingBase:M,openingAir:le,drawerCash:K})}catch{}i({title:"تم تسجيل البيانات",description:`الافتتاحي الأساسي: ${Be(M)}، الهواء: ${Be(le)}، فلوس الدرج: ${Be(K)}`})},P=()=>{if(h==null||y==null){i({title:"سجل الرصيد الافتتاحي أولاً",description:'يرجى الضغط على زر "إضافة" بعد إدخال الافتتاحي.'});return}C(!0)},re=()=>{const M=parseFloat(_||"0"),le=parseFloat(ee||"0");if(isNaN(M)||isNaN(le)){i({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة لرصيد التسليم.",variant:"destructive"});return}if(M<0||le<0){i({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}const K=(L==null?void 0:L.openingBase)??(h||0),Ne=(L==null?void 0:L.openingAir)??(y||0),Le=K+Ne,vt=M+le-Le;A(vt);const $e={id:`${Date.now()}`,openingBase:K,openingAir:Ne,deliveryBase:M,deliveryAir:le,netResult:vt,createdAt:new Date().toISOString(),cashierName:wt,requiredDrawerNoProfit:vt<0?Math.round(-vt*100)/100:0};q(ut=>[$e,...ut]),i({title:"تم إنشاء إيصال تسليم",description:`الناتج النهائي: ${Be(vt)}`})},pe=()=>{const M=parseFloat(_e||"0"),le=parseFloat(st||"0");if(!Number.isFinite(M)||!Number.isFinite(le)){i({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة لسعر الجملة وسعر التجزئة.",variant:"destructive"});return}if(M<0||le<0){i({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}if(h==null||y==null){i({title:"سجل الرصيد الافتتاحي أولاً",description:'يرجى إدخال الرصيد الأساسي ورصيد الهواء ثم الضغط "إضافة".'});return}const K=Math.round((le-M)*100)/100;Tt({wholesalePrice:M,retailPrice:le,profit:K}),Ye(!0)},Oe=M=>{if(!We)return;const le={id:`transfer_${Date.now()}`,wholesalePrice:We.wholesalePrice,retailPrice:We.retailPrice,profit:We.profit,createdAt:new Date().toISOString(),cashierName:wt,deductFrom:M},K=We.wholesalePrice,Ne=h??0,Le=y??0,ts=z??0;if(K>(M==="base"?Ne:Le)){i({title:"رصيد غير كافٍ",description:"لا يوجد رصيد كافٍ للخصم بسعر الجملة.",variant:"destructive"});return}const $e=M==="base"?Math.round((Ne-K)*100)/100:Ne,ut=M==="air"?Math.round((Le-K)*100)/100:Le,He=Math.round((ts+We.retailPrice)*100)/100;N($e),F(ut),Z(He);try{localStorage.setItem(ir,JSON.stringify({openingBase:$e,openingAir:ut,drawerCash:He}))}catch{}Pe(zt=>[le,...zt]),It(!1),$t(""),lt(""),Tt(null),Ye(!1),i({title:"تم تسجيل تحويل",description:`الربح الفوري: ${Be(le.profit)} | خصم المخزون: -${Be(K)} (${M==="base"?"الأساسي":"الهواء"}) | درج: +${Be(We.retailPrice)}`})},Ie=()=>{g(""),W(""),C(!1),ae(""),fe(""),A(null)},ze=M=>{M||Ie(),m(M)};return e.jsxs(me,{open:l,onOpenChange:ze,children:[e.jsxs(he,{className:"w-[92vw] sm:w-auto sm:max-w-2xl max-h-[85vh] overflow-y-auto",children:[e.jsxs(ue,{className:"space-y-2",children:[e.jsx(xe,{className:"flex items-center justify-between text-right",children:e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(ei,{className:"h-5 w-5 text-yellow-500"}),"يومية المكنة"]})}),e.jsx(Vt,{className:"text-right",children:'أدخل الرصيد الافتتاحي، ثم في نهاية اليوم قم بإدخال رصيد التسليم لإنشاء إيصال منظم باسم "إيصالات ماكينة".'})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-6",children:[e.jsxs(tt,{children:[e.jsx(Dt,{className:"pb-2",children:e.jsxs(Lt,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-right",children:"الرصيد الافتتاحي"}),e.jsx(c,{variant:"ghost",size:"sm",onClick:()=>H(M=>!M),className:"flex items-center gap-1",children:e.jsx(jn,{className:`h-4 w-4 transition-transform ${U?"rotate-180":""}`})})]})}),e.jsxs("div",{className:"flex items-center justify-between px-6",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(c,{variant:"outline",onClick:()=>It(!0),disabled:h==null||y==null,className:"border-violet-300 text-violet-700",children:"تحويل"})}),h!=null&&y!=null&&e.jsxs(Nt,{className:"bg-violet-100 text-violet-700 border border-violet-200",children:["تم التسجيل: أساسي ",Be(h)," | هواء ",Be(y)," | درج ",Be(z??0)]})]}),e.jsxs(rt,{className:`space-y-4 ${U?"":"hidden"}`,children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الرصيد الأساسي"}),e.jsx(R,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:b,onChange:M=>g(M.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"رصيد الهواء"}),e.jsx(R,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:t,onChange:M=>W(M.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"فلوس الدرج"}),e.jsx(R,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:S,onChange:M=>p(M.target.value),placeholder:"0.00",className:"text-right"})]})]}),e.jsxs("div",{className:"flex items-center justify-end",children:[e.jsx(c,{variant:"outline",className:"mr-2",onClick:ds,children:"تصفير"}),e.jsx(c,{onClick:Et,className:"bg-violet-600 hover:bg-violet-700",children:"إضافة"})]})]})]}),e.jsxs(tt,{children:[e.jsx(Dt,{className:"pb-2",children:e.jsxs(Lt,{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-right",children:"إيصالات تحويل"}),e.jsxs(Nt,{className:"bg-green-100 text-green-700 border border-green-200",children:["ربح: ",Be(Ft)]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(c,{variant:"outline",size:"sm",onClick:St,className:"border-red-300 text-red-700 hover:bg-red-50",children:"حذف الإيصالات"}),e.jsx(cr,{className:"h-4 w-4 text-gray-500"})]})]})}),e.jsx(rt,{className:"space-y-3",children:ie.length===0?e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد تحويلات مسجلة."}):e.jsx("div",{className:"space-y-3 max-h-52 overflow-y-auto pr-1",children:ie.map(M=>e.jsxs("div",{className:"rounded-lg border p-3 grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"سعر الجملة"}),e.jsx("p",{className:"text-sm",children:Be(M.wholesalePrice)})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"سعر التجزئة"}),e.jsx("p",{className:"text-sm",children:Be(M.retailPrice)})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"الربح الفوري"}),e.jsx("p",{className:"text-sm text-green-700",children:Be(M.profit)}),M.deductFrom&&e.jsx("div",{className:"mt-1",children:e.jsxs("span",{className:"text-[11px] bg-violet-100 text-violet-700 border border-violet-200 rounded px-2 py-0.5",children:["الخصم من: ",M.deductFrom==="base"?"الأساسي":"الهواء"]})}),e.jsxs("div",{className:"flex items-center justify-end gap-2 text-xs text-gray-500",children:[e.jsx(Ts,{className:"h-3 w-3"}),e.jsx("span",{children:Ml(M.createdAt)}),M.cashierName&&e.jsxs(e.Fragment,{children:[e.jsx(pn,{orientation:"vertical",className:"h-3"}),e.jsxs("span",{children:["الكاشير: ",M.cashierName]})]})]})]})]},M.id))})})]}),e.jsxs(tt,{children:[e.jsx(Dt,{className:"pb-2",children:e.jsx(Lt,{className:"text-right",children:"نهاية اليوم"})}),e.jsx(rt,{className:"space-y-4",children:$?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الرصيد الأساسي الحالي"}),e.jsx(R,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:_,onChange:M=>ae(M.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"رصيد الهواء الحالي"}),e.jsx(R,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:ee,onChange:M=>fe(M.target.value),placeholder:"0.00",className:"text-right"})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(c,{variant:"secondary",onClick:()=>C(!1),children:"إلغاء"}),e.jsx(c,{onClick:re,className:"bg-green-600 hover:bg-green-700",children:"تسليم"})]}),J!=null&&e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{className:"text-right",children:e.jsxs(Nt,{className:J>=0?"bg-green-100 text-green-700 border border-green-200":"bg-red-100 text-red-700 border border-red-200",children:["الناتج النهائي: ",Be(J)]})}),e.jsxs("div",{className:"mt-2 flex items-center justify-end gap-2",children:[e.jsxs(Nt,{className:"bg-blue-100 text-blue-700 border border-blue-200",children:["المجموع النهائي: ",Be(parseFloat(_||"0")+parseFloat(ee||"0"))]}),e.jsxs(Nt,{className:"bg-amber-100 text-amber-700 border border-amber-200",children:["مطلوب من الدرج (بدون أرباح): ",Be(ft)]})]})]})]}):e.jsx("div",{className:"flex justify-end",children:e.jsx(c,{variant:"outline",onClick:P,className:"border-violet-300 text-violet-700",children:"تسليم يومية"})})})]}),e.jsxs(tt,{children:[e.jsx(Dt,{className:"pb-2",children:e.jsxs(Lt,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-right",children:"إيصالات ماكينة"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(c,{variant:"outline",size:"sm",onClick:Rt,className:"border-red-300 text-red-700 hover:bg-red-50",children:"حذف الإيصالات"}),e.jsx(cr,{className:"h-4 w-4 text-gray-500"})]})]})}),e.jsx(rt,{className:"space-y-3",children:ne.length===0?e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد إيصالات حتى الآن."}):e.jsx("div",{className:"space-y-3",children:ne.map(M=>e.jsxs("div",{className:"rounded-lg border p-3 grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"الافتتاحي"}),e.jsxs("p",{className:"text-sm",children:["أساسي: ",Be(M.openingBase)]}),e.jsxs("p",{className:"text-sm",children:["هواء: ",Be(M.openingAir)]})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"التسليم"}),e.jsxs("p",{className:"text-sm",children:["أساسي: ",Be(M.deliveryBase)]}),e.jsxs("p",{className:"text-sm",children:["هواء: ",Be(M.deliveryAir)]})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("div",{className:"flex items-center justify-end",children:e.jsxs(c,{variant:"outline",size:"sm",onClick:()=>Ht(M.id),className:"border-red-300 text-red-700 hover:bg-red-50",children:[e.jsx(_t,{className:"h-3 w-3 mr-1"})," حذف"]})}),e.jsx("p",{className:"text-xs text-gray-500",children:"النتيجة"}),e.jsx("p",{className:`text-sm ${M.netResult>=0?"text-green-700":"text-red-700"}`,children:Be(M.netResult)}),e.jsxs("div",{className:"mt-1 flex items-center justify-end gap-2",children:[e.jsxs("span",{className:"text-[11px] bg-blue-100 text-blue-700 border border-blue-200 rounded px-2 py-0.5",children:["المجموع النهائي: ",Be(M.deliveryBase+M.deliveryAir)]}),typeof M.requiredDrawerNoProfit=="number"&&e.jsxs("span",{className:"text-[11px] bg-amber-100 text-amber-700 border border-amber-200 rounded px-2 py-0.5",children:["مطلوب من الدرج (بدون أرباح): ",Be(M.requiredDrawerNoProfit||0)]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2 text-xs text-gray-500",children:[e.jsx(Ts,{className:"h-3 w-3"}),e.jsx("span",{children:Ml(M.createdAt)}),M.cashierName&&e.jsxs(e.Fragment,{children:[e.jsx(pn,{orientation:"vertical",className:"h-3"}),e.jsxs("span",{children:["الكاشير: ",M.cashierName]})]})]})]})]},M.id))})})]})]}),e.jsxs(Ce,{className:"flex items-center justify-between",children:[e.jsx(c,{variant:"outline",onClick:()=>ze(!1),children:"إغلاق"}),e.jsxs("div",{className:"text-xs text-gray-500 flex items-center gap-1",children:[e.jsx(zs,{className:"h-3 w-3"}),e.jsx("span",{children:"يسجل التاريخ والوقت تلقائياً لكل إيصال"})]})]})]}),e.jsx(me,{open:Ve,onOpenChange:It,children:e.jsxs(he,{className:"sm:max-w-sm",children:[e.jsx(ue,{children:e.jsx(xe,{children:"تحويل رصيد"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"سعر الجملة"}),e.jsx(R,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:_e,onChange:M=>$t(M.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"سعر التجزئة"}),e.jsx(R,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:st,onChange:M=>lt(M.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsx("div",{className:"text-right",children:e.jsxs(Nt,{className:"bg-green-100 text-green-700 border border-green-200",children:["الربح الفوري: ",Be(parseFloat(st||"0")-parseFloat(_e||"0")||0)]})})]}),e.jsxs(Ce,{className:"flex items-center justify-end gap-2",children:[e.jsx(c,{variant:"secondary",onClick:()=>It(!1),children:"إلغاء"}),e.jsx(c,{onClick:pe,className:"bg-violet-600 hover:bg-violet-700",children:"تحويل"})]})]})}),e.jsx(Nd,{open:At,onOpenChange:Ye,children:e.jsxs(yi,{children:[e.jsxs(ji,{children:[e.jsx(Ni,{children:"اختيار مصدر الخصم"}),e.jsx(wi,{children:"هل يتم الخصم من الرصيد الأساسي أم من رصيد الهواء؟"})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2 mt-4",children:[e.jsx(Si,{onClick:()=>Ye(!1),children:"رجوع"}),e.jsx(bn,{onClick:()=>Oe("base"),children:"خصم من الأساسي"}),e.jsx(bn,{onClick:()=>Oe("air"),children:"خصم من الهواء"})]})]})})]})}function Dd(l,m=300){const[i,x]=et.useState(l);return et.useEffect(()=>{const b=setTimeout(()=>x(l),m);return()=>clearTimeout(b)},[l,m]),i}const Cd=({userId:l,transactions:m})=>{const[i,x]=a.useState(!1),[b,g]=a.useState(!1),[t,W]=a.useState(!1),[S,p]=a.useState({monthlyWithdrawalProfit:0,monthlyTransferProfit:0,lastUpdated:new Date}),{userSubscription:h}=ys();a.useEffect(()=>{l&&i&&t&&N()},[l,i,t]);const N=async()=>{if(l)try{if(Array.isArray(m)&&m.length>0){const D=new Date,U=D.getMonth(),H=D.getFullYear(),$=qt.filterVisibleTransactions(m,"monthly",l);let C=0,_=0;$.forEach(ae=>{const ee=new Date(ae.createdAt),fe=String(ae.status||"confirmed").toLowerCase();if(ee.getMonth()!==U||ee.getFullYear()!==H||fe!=="completed"&&fe!=="confirmed")return;const J=(ae.type||ae.txnType||"").toLowerCase(),A={type:J==="withdrawal"?"withdraw":J,amount:Number(ae.amount||0),commission:ae.commission};A.type==="withdraw"?C+=es.calculateProfitFromTransaction(A):(A.type==="send"||A.type==="receive"||A.type==="transfer")&&(_+=es.calculateProfitFromTransaction(A))}),p({monthlyWithdrawalProfit:Math.round(C*100)/100,monthlyTransferProfit:Math.round(_*100)/100,lastUpdated:new Date});return}const L=es.getWithdrawTransferProfits(l);p({monthlyWithdrawalProfit:L.monthlyWithdrawProfit||0,monthlyTransferProfit:L.monthlyTransferProfit||0,lastUpdated:new Date})}catch(L){console.error("Error loading profit data:",L)}},y=L=>`${L.toFixed(2)} ج.م`,F=async()=>{try{const L=(h==null?void 0:h.subscription)||null,D=(L==null?void 0:L.planType)??(L==null?void 0:L.plan)??null,U=typeof D=="string"?D.toLowerCase():null;if(D===fs.ZERO||U==="zero"||U==="0"||D===0)return!0}catch{}try{if(l){const L=await yn(l),D=(L==null?void 0:L.planType)??(L==null?void 0:L.plan)??null,U=typeof D=="string"?D.toLowerCase():null;if(D===fs.ZERO||U==="zero"||U==="0"||D===0)return!0}}catch{}return!1},z=async()=>{try{if(await F()){kl({title:"الخطة زيرو",description:"عرض الأرباح الشهرية غير متاح في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}catch{}g(!0)},Z=async()=>{try{if(await F()){kl({title:"الخطة زيرو",description:"عرض الأرباح الشهرية غير متاح في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"}),g(!1);return}}catch{}W(!0),x(!0),g(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(c,{size:"sm",variant:"ghost",onClick:z,className:"h-2 w-2 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded transition-all duration-300 hover:scale-110 shadow-sm hover:shadow-md",title:"عرض الأرباح الشهرية",children:e.jsx(Ue,{className:"h-1.5 w-1.5"})}),e.jsx(me,{open:i,onOpenChange:x,children:e.jsxs(he,{className:"max-w-[220px] mx-auto bg-white border border-gray-200 shadow-md rounded sm:max-w-[180px] sm:bg-gradient-to-br sm:from-purple-50 sm:to-white sm:border-2 sm:border-purple-200 sm:shadow-2xl sm:rounded-2xl",children:[e.jsx(ue,{className:"text-center pb-0 border-b-0 sm:pb-2 sm:border-b sm:border-purple-200",children:e.jsxs(xe,{className:"text-xs font-bold text-purple-800 flex items-center justify-center gap-0 mb-0 leading-tight tracking-tight sm:text-xs sm:gap-1 sm:mb-0 sm:leading-normal sm:tracking-normal",children:[e.jsx(Ts,{className:"h-2 w-2 text-purple-600 sm:h-3 sm:w-3"}),"شهري"]})}),e.jsxs("div",{className:"space-y-0 py-0 sm:space-y-2 sm:py-2",children:[e.jsx("div",{className:"bg-yellow-50 p-0.5 rounded border border-yellow-200 sm:bg-gradient-to-r sm:from-yellow-50 sm:to-yellow-100 sm:p-2 sm:rounded-xl sm:shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-[10px] sm:text-xs font-semibold text-yellow-900",children:"أرباح فوري"}),e.jsx("span",{className:"text-[10px] sm:text-xs font-bold text-yellow-900",children:y((S.monthlyWithdrawalProfit??0)+(S.monthlyTransferProfit??0))})]})}),e.jsx("div",{className:"bg-red-50 p-0.5 rounded border border-red-200 sm:bg-gradient-to-r sm:from-red-50 sm:to-red-100 sm:p-2 sm:rounded-xl sm:shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1 sm:gap-2",children:[e.jsx(mr,{className:"h-2 w-2 text-red-600 sm:h-3 sm:w-3"}),e.jsx("span",{className:"text-[10px] sm:text-xs",children:"سحب"})]}),e.jsx("span",{className:"text-[10px] sm:text-xs font-bold text-red-700",children:y(S.monthlyWithdrawalProfit)})]})}),e.jsx("div",{className:"bg-blue-50 p-0.5 rounded border border-blue-200 sm:bg-gradient-to-r sm:from-blue-50 sm:to-blue-100 sm:p-2 sm:rounded-xl sm:shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1 sm:gap-2",children:[e.jsx(Zl,{className:"h-2 w-2 text-blue-600 sm:h-3 sm:w-3"}),e.jsx("span",{className:"text-[10px] sm:text-xs",children:"تحويل"})]}),e.jsx("span",{className:"text-[10px] sm:text-xs font-bold text-blue-700",children:y(S.monthlyTransferProfit)})]})}),e.jsx("div",{className:"bg-purple-50 p-0.5 rounded border border-purple-200 sm:bg-gradient-to-r sm:from-purple-50 sm:to-purple-100 sm:p-2 sm:rounded-xl sm:shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1 sm:gap-2",children:[e.jsx(nt,{className:"h-2 w-2 text-purple-600 sm:h-3 sm:w-3"}),e.jsx("span",{className:"text-[10px] sm:text-xs",children:"إجمالي"})]}),e.jsx("span",{className:"text-[10px] sm:text-xs font-bold text-purple-700",children:y(S.monthlyWithdrawalProfit+S.monthlyTransferProfit)})]})})]}),!t&&e.jsx("div",{className:"absolute inset-0 bg-yellow-200/70 backdrop-blur-sm flex items-center justify-center rounded sm:rounded-2xl border border-yellow-300 pointer-events-auto",children:e.jsx(c,{size:"sm",variant:"ghost",onClick:()=>g(!0),className:"p-2 bg-yellow-300/80 text-yellow-900 hover:bg-yellow-400/90 rounded-full shadow-sm hover:shadow-md transition-all duration-300",title:"إدخال الرقم السري الرئيسي",children:e.jsx(Ue,{className:"h-4 w-4"})})}),e.jsx("div",{className:"flex justify-center pt-0 border-t-0 sm:pt-2 sm:border-t sm:border-purple-200",children:e.jsx(c,{onClick:()=>x(!1),className:"bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-xl text-sm sm:bg-gradient-to-r sm:from-purple-600 sm:to-purple-700 sm:hover:from-purple-700 sm:hover:to-purple-800 sm:px-4 sm:py-1 sm:rounded-xl sm:shadow-lg sm:hover:shadow-xl sm:transition-all sm:duration-300",children:"إغلاق"})})]})}),e.jsx(Xt,{open:b,onOpenChange:g,onSuccess:Z,description:"لا يمكن الاطلاع على الأرباح الشهرية إلا بإدخال الرقم السري الرئيسي"})]})},Id=l=>e.jsx(Cd,{...l});function Td({open:l,onOpenChange:m,onSuccess:i,userId:x}){const[b,g]=a.useState(""),[t,W]=a.useState(""),[S,p]=a.useState(!1),[h,N]=a.useState(!1),[y,F]=a.useState(""),[z,Z]=a.useState(!1),{toast:L}=cs(),D=es.hasProfitPin(x),U=()=>{g(""),W(""),F(""),p(!1),N(!1),m(!1)},H=async $=>{$.preventDefault(),F(""),Z(!0);try{if(D){if(!es.verifyProfitPin(b,x)){F("الرقم السري غير صحيح"),Z(!1);return}}else{if(b.length<4){F("يجب أن يكون الرقم السري 4 أرقام على الأقل"),Z(!1);return}if(b!==t){F("الرقم السري غير متطابق"),Z(!1);return}es.setProfitPin(b,x)}L({title:"نجح العملية",description:D?"تم التحقق من الرقم السري بنجاح":"تم إنشاء رقم سري الأرباح بنجاح"}),i(),U()}catch{F("حدث خطأ أثناء معالجة الرقم السري")}finally{Z(!1)}};return e.jsx(me,{open:l,onOpenChange:m,children:e.jsxs(he,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ue,{children:e.jsxs(xe,{className:"flex items-center gap-2 text-lg font-semibold",children:[e.jsx(Js,{className:"h-5 w-5 text-green-600"}),D?"أدخل رقم سري الأرباح":"إنشاء رقم سري للأرباح"]})}),e.jsxs("form",{onSubmit:H,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-gray-600 bg-blue-50 p-3 rounded-lg",children:D?"أدخل الرقم السري لعرض بيانات الأرباح":"قم بإنشاء رقم سري لحماية بيانات الأرباح. يمكنك تغييره لاحقاً من إعدادات البروفيل."}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"pin",children:D?"الرقم السري":"الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"pin",type:S?"text":"password",value:b,onChange:$=>g($.target.value),placeholder:D?"أدخل الرقم السري":"أدخل رقم سري جديد (4 أرقام على الأقل)",className:"pr-10",dir:"ltr",autoComplete:"off",required:!0}),e.jsx(c,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>p(!S),children:S?e.jsx(Ct,{className:"h-4 w-4"}):e.jsx(Ue,{className:"h-4 w-4"})})]})]}),!D&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"confirmPin",children:"تأكيد الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"confirmPin",type:h?"text":"password",value:t,onChange:$=>W($.target.value),placeholder:"أعد إدخال الرقم السري",className:"pr-10",dir:"ltr",autoComplete:"off",required:!0}),e.jsx(c,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>N(!h),children:h?e.jsx(Ct,{className:"h-4 w-4"}):e.jsx(Ue,{className:"h-4 w-4"})})]})]}),y&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(qs,{className:"h-4 w-4"}),y]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(c,{type:"submit",disabled:z,className:"flex-1 bg-green-600 hover:bg-green-700",children:[e.jsx(Js,{className:"h-4 w-4 mr-2"}),z?"جاري المعالجة...":D?"عرض الأرباح":"إنشاء وعرض الأرباح"]}),e.jsx(c,{type:"button",variant:"outline",onClick:U,disabled:z,children:"إلغاء"})]})]})]})})}const kd=({userId:l,transactions:m})=>{const[i,x]=a.useState(!1),[b,g]=a.useState(!1),[t,W]=a.useState(!1),[S,p]=a.useState({dailyWithdrawalProfit:0,dailyTransferProfit:0,lastUpdated:new Date});a.useEffect(()=>{l&&i&&t&&h()},[l,i,t]);const h=async()=>{if(l)try{if(Array.isArray(m)&&m.length>0){const Z=new Date,L=qt.filterVisibleTransactions(m,"daily",l);let D=0,U=0;L.forEach(H=>{const $=new Date(H.createdAt),C=String(H.status||"confirmed").toLowerCase();if($.toDateString()!==Z.toDateString()||C!=="completed"&&C!=="confirmed")return;const _=(H.type||H.txnType||"").toLowerCase(),ae={type:_==="withdrawal"?"withdraw":_,amount:Number(H.amount||0),commission:H.commission};ae.type==="withdraw"?D+=es.calculateProfitFromTransaction(ae):(ae.type==="send"||ae.type==="receive"||ae.type==="transfer")&&(U+=es.calculateProfitFromTransaction(ae))}),p({dailyWithdrawalProfit:Math.round(D*100)/100,dailyTransferProfit:Math.round(U*100)/100,lastUpdated:new Date});try{es.updateProfitsFromTransactions(m,l)}catch{}return}const z=es.getWithdrawTransferProfits(l);p({dailyWithdrawalProfit:z.dailyWithdrawProfit||0,dailyTransferProfit:z.dailyTransferProfit||0,lastUpdated:new Date})}catch(z){console.error("Error loading profit data:",z)}},N=z=>`${z.toFixed(2)} ج.م`,y=()=>{es.hasProfitPin(l),g(!0)},F=()=>{W(!0),x(!0),g(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(c,{size:"sm",variant:"ghost",onClick:y,className:"h-2 w-2 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded transition-all duration-300 hover:scale-110 shadow-sm hover:shadow-md",title:"عرض الأرباح اليومية",children:e.jsx(Ue,{className:"h-1.5 w-1.5"})}),e.jsx(me,{open:i,onOpenChange:x,children:e.jsxs(he,{className:"max-w-[220px] mx-auto bg-white border border-gray-200 shadow-md rounded sm:max-w-[180px] sm:bg-gradient-to-br sm:from-blue-50 sm:to-white sm:border-2 sm:border-blue-200 sm:shadow-2xl sm:rounded-2xl",children:[e.jsx(ue,{className:"text-center pb-0 border-b-0 sm:pb-2 sm:border-b sm:border-blue-200",children:e.jsxs(xe,{className:"text-xs font-bold text-blue-800 flex items-center justify-center gap-0 mb-0 leading-tight tracking-tight sm:text-sm sm:gap-1 sm:mb-0 sm:leading-normal sm:tracking-normal",children:[e.jsx(nt,{className:"h-2 w-2 text-blue-600 sm:h-3 sm:w-3"}),"يومي"]})}),e.jsxs("div",{className:"space-y-0 py-0 sm:space-y-4 sm:py-4",children:[e.jsx("div",{className:"bg-yellow-50 p-2 rounded border border-yellow-200 sm:bg-gradient-to-r sm:from-yellow-50 sm:to-yellow-100 sm:p-4 sm:rounded-xl sm:shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-0 sm:gap-2",children:[e.jsx(nt,{className:"h-3 w-3 text-yellow-600 sm:h-5 sm:w-5"}),e.jsx("span",{className:"font-medium text-yellow-800 text-xs sm:text-base",children:"أرباح فوري"})]}),e.jsx("span",{className:"font-bold text-sm text-yellow-900 bg-white px-0 py-0.5 rounded text-center sm:text-lg sm:px-3 sm:py-1",children:N((S.dailyWithdrawalProfit??0)+(S.dailyTransferProfit??0))})]})}),e.jsx("div",{className:"bg-red-50 p-2 rounded border border-red-200 sm:bg-gradient-to-r sm:from-red-50 sm:to-red-100 sm:p-4 sm:rounded-xl sm:shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-0 sm:gap-2",children:[e.jsx(mr,{className:"h-3 w-3 text-red-600 sm:h-5 sm:w-5"}),e.jsx("span",{className:"font-medium text-red-800 text-xs sm:text-base",children:"سحب"})]}),e.jsx("span",{className:"font-bold text-sm text-red-900 bg-white px-0 py-0.5 rounded text-center sm:text-lg sm:px-3 sm:py-1",children:N(S.dailyWithdrawalProfit)})]})}),e.jsx("div",{className:"bg-green-50 p-0.5 rounded border border-green-200 sm:bg-gradient-to-r sm:from-green-50 sm:to-green-100 sm:p-2 sm:rounded-xl sm:shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between h-4 sm:h-auto",children:[e.jsxs("div",{className:"flex items-center gap-0 sm:gap-1",children:[e.jsx(Zl,{className:"h-2 w-2 text-green-600 sm:h-3 sm:w-3"}),e.jsx("span",{className:"font-medium text-green-800 text-xs leading-tight tracking-tighter sm:font-semibold sm:text-xs sm:leading-normal sm:tracking-normal",children:"تحويل"})]}),e.jsx("span",{className:"font-bold text-xs text-green-900 bg-white px-0 py-0 rounded text-center leading-tight tracking-tighter sm:text-sm sm:px-2 sm:py-0.5 sm:leading-normal sm:tracking-normal",children:N(S.dailyTransferProfit)})]})}),e.jsx("div",{className:"bg-blue-50 p-0.5 rounded border border-blue-200 sm:bg-gradient-to-r sm:from-blue-50 sm:to-blue-100 sm:p-2 sm:rounded-xl sm:shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between h-4 sm:h-auto",children:[e.jsxs("div",{className:"flex items-center gap-0 sm:gap-1",children:[e.jsx(nt,{className:"h-2 w-2 text-blue-600 sm:h-3 sm:w-3"}),e.jsx("span",{className:"font-medium text-blue-800 text-xs leading-tight tracking-tighter sm:font-semibold sm:text-xs sm:leading-normal sm:tracking-normal",children:"مجموع"})]}),e.jsx("span",{className:"font-bold text-xs text-blue-900 bg-white px-0 py-0 rounded text-center leading-tight tracking-tighter sm:text-sm sm:px-2 sm:py-0.5 sm:leading-normal sm:tracking-normal",children:N(S.dailyWithdrawalProfit+S.dailyTransferProfit)})]})})]}),e.jsx("div",{className:"flex justify-center pt-0 border-t-0 sm:pt-2 sm:border-t sm:border-blue-200",children:e.jsx(c,{onClick:()=>x(!1),className:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-xl text-sm sm:bg-gradient-to-r sm:from-blue-600 sm:to-blue-700 sm:hover:from-blue-700 sm:hover:to-blue-800 sm:px-4 sm:py-1 sm:rounded-xl sm:shadow-lg sm:hover:shadow-xl sm:transition-all sm:duration-300 sm:text-xs",children:"إغلاق"})})]})}),e.jsx(Td,{open:b,onOpenChange:g,onSuccess:F,userId:l})]})},Ad=l=>e.jsx(kd,{...l}),or=l=>Number(l||0).toFixed(2),Pd=({open:l,onOpenChange:m,userId:i})=>{const{toast:x}=cs(),[b,g]=et.useState([]),[t,W]=et.useState(!1),[S,p]=et.useState("");et.useEffect(()=>{(async()=>{if(!(!l||!i))try{W(!0);const F=[...await zl.getByUser(i)].sort((z,Z)=>z.reportDate<Z.reportDate?1:-1);g(F)}catch(y){console.error("Failed to load daily archive history:",y),x({title:"فشل تحميل الأرشيف",description:"تعذر تحميل أرشيف التقارير اليومية",variant:"destructive"})}finally{W(!1)}})()},[l,i]);const h=et.useMemo(()=>{if(!S)return b;const N=S.trim();return b.filter(y=>y.reportDate.includes(N))},[b,S]);return e.jsx(me,{open:l,onOpenChange:m,children:e.jsxs(he,{className:"sm:max-w-xl",children:[e.jsxs(ue,{children:[e.jsx(xe,{children:"أرشيف التقارير اليومية"}),e.jsx(Vt,{children:"يعرض جميع الأيام المؤرشفة مع ملخص لكل يوم."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"archive-search",children:"بحث بالتاريخ (YYYY-MM-DD)"}),e.jsx(R,{id:"archive-search",placeholder:"مثال: 2025-10-19",value:S,onChange:N=>p(N.target.value)})]}),e.jsx("div",{className:"mt-3 space-y-2 max-h-[50vh] overflow-auto",children:t?e.jsx("div",{className:"text-sm text-muted-foreground",children:"جاري التحميل..."}):h.length===0?e.jsx("div",{className:"text-sm text-muted-foreground",children:"لا توجد تقارير مؤرشفة حتى الآن"}):h.map(N=>e.jsxs("div",{className:"border rounded-md p-2 bg-gradient-to-r from-white/80 to-blue-50/70",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{className:"font-bold text-blue-800",children:N.reportDate}),e.jsxs("div",{className:"text-xs text-blue-700",children:["عدد المعاملات: ",N.totalTransactions]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-1",children:[e.jsxs("div",{className:"text-xs text-blue-800",children:["إجمالي المبالغ: ",e.jsx("span",{className:"font-semibold",children:or(N.totalAmount)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["المسحوب: ",e.jsx("span",{className:"font-semibold",children:or(N.totalWithdrawn)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["المرسل: ",e.jsx("span",{className:"font-semibold",children:or(N.totalSent)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["الربح: ",e.jsx("span",{className:"font-semibold",children:or(N.profit)})]})]})]},N.id||`${N.userId}-${N.reportDate}`))}),e.jsx(Ce,{children:e.jsx(c,{variant:"outline",onClick:()=>m(!1),children:"إغلاق"})})]})})},Od=({open:l,onOpenChange:m})=>{var ks;const{shiftUser:i,isShiftActive:x,shiftStartAt:b,setShiftUser:g,startShift:t,endShift:W}=Ia(),{userSubscription:S,user:p,signIn:h,profile:N}=ys(),{toast:y}=cs(),[F,z]=a.useState((i==null?void 0:i.name)||""),[Z,L]=a.useState((i==null?void 0:i.username)||""),[D,U]=a.useState(""),[H,$]=a.useState(!1),[C,_]=a.useState(null),[ae,ee]=a.useState(""),[fe,J]=a.useState("");a.useState(!1);const[A,ne]=a.useState(null),[q,ie]=a.useState(""),[Pe,Ve]=a.useState(""),[It,_e]=a.useState(!1),[$t,st]=a.useState(!1),[lt,At]=a.useState({totalTransfers:0,totalWithdrawals:0}),[Ye,We]=a.useState(null),[Tt,wt]=a.useState(""),[Ft,ft]=a.useState(""),[St,Rt]=a.useState(0),[Ht,ds]=a.useState({}),[Et,P]=a.useState(0),[re,pe]=a.useState(0),[Oe,Ie]=a.useState({}),[ze,M]=a.useState(""),[le,K]=a.useState(!1),[Ne,Le]=a.useState(()=>{try{const B=localStorage.getItem("cashierUsers");return B?JSON.parse(B):[]}catch{return[]}}),ts=(ks=S==null?void 0:S.subscription)==null?void 0:ks.planType,vt=ts==="yearly"?2:ts==="lifetime"?4:Number.POSITIVE_INFINITY;a.useEffect(()=>{try{localStorage.setItem("cashierUsers",JSON.stringify(Ne))}catch{}},[Ne]);const[$e,ut]=a.useState(!1),[He,zt]=a.useState(""),[u,E]=a.useState(null),[Y,ce]=a.useState([]),[oe,Fe]=a.useState(!1),[Te,we]=a.useState(null),[Je,it]=a.useState(!1),[ot,Ge]=a.useState(!1),xt=B=>{const ge=(i==null?void 0:i.username)===B;let ke=!1;try{ke=localStorage.getItem("lastHandoverToAdmin")==="true"}catch{}if(ge&&!(ge&&!x&&(ze==="الأدمن الرئيسي"||ke))){y({title:"لا يمكن الحذف",description:"لا يمكنك حذف مستخدم الوردية أثناء كونها نشطة أو قبل تسليمها للأدمن الرئيسي"});return}const Jt=`هل أنت متأكد من حذف المستخدم ${B}؟

هذا الإجراء لا يمكن التراجع عنه.`;window.confirm(Jt)&&(Le(Ot=>Ot.filter(na=>na.username!==B)),ge&&g(null),y({title:"تم حذف المستخدم",description:B}))},Pt=()=>{if(!F.trim()||!Z.trim()||!D.trim())return;if(Ne.length>=vt){y({title:"وصلت الحد الأقصى للمستخدمين",description:`هذه الباقة تسمح بإضافة ${Number.isFinite(vt)?vt:"عدد غير محدود"} كاشير فقط`,variant:"destructive"});return}const B={name:F.trim(),username:Z.trim(),password:D.trim()};Le(ge=>[B,...ge]),z(""),L(""),U("")},Ns=()=>{$(!0),_(null),ne(null),ie(""),Ve("")},Vs=async()=>{try{let B=[];try{p!=null&&p.uid&&(B=await De.getUserTransactions(p.uid))}catch{}if(!B||B.length===0)try{const se=await Hc({merchantUserId:p==null?void 0:p.uid,limit:200});B=(se==null?void 0:se.transactions)||[]}catch{}const ge=b?new Date(b):null,ke=new Date,at=se=>{const Ee=se.type,X=se.txnType;return Ee==="withdraw"||Ee==="withdrawal"||Ee==="receive"||X==="receive"},Ke=se=>{const Ee=se.type,X=se.txnType;return Ee==="send"||Ee==="transfer"||X==="send"},Jt=se=>{if(!se)return null;if(se instanceof Date)return se;try{const Ee=new Date(se);return Number.isNaN(Ee.getTime())?null:Ee}catch{return null}},Ot=se=>{const Ee=Jt(se.createdAt||se.created_at||se.timestamp);return!Ee||ge&&Ee<ge?!1:Ee<=ke},na=se=>se==="completed"||se==="confirmed",Gt=B.filter(se=>na(se.status)&&Ot(se)),xr=Gt.filter(se=>at(se)).reduce((se,Ee)=>{const X=Ee.withdrawnAmount??Ee.receivedAmount??Ee.amount??0;return se+(Number(X)||0)},0);return{totalTransfers:Gt.filter(se=>Ke(se)).reduce((se,Ee)=>{const X=Ee.sentAmount??Ee.transferredAmount??Ee.amount??0;return se+(Number(X)||0)},0),totalWithdrawals:xr}}catch{return{totalTransfers:0,totalWithdrawals:0}}};a.useEffect(()=>{if($t){try{const B=localStorage.getItem("shiftInitialReceivedDrawerFunds");B!==null&&ft(B)}catch{}try{const B=localStorage.getItem("shiftInitialReceivedWalletBalancesTotal");if(B!==null){const ge=parseFloat(B);Rt(Number.isFinite(ge)?ge:0)}}catch{}}},[$t]),a.useEffect(()=>{if(!l&&!oe)return;(async()=>{try{const ke=((p!=null&&p.uid?await De.getUserTransactions(p.uid):[])||[]).filter(at=>(at==null?void 0:at.type)==="report"||((at==null?void 0:at.title)||"").includes("إيصال تسليم وردية"));ke.sort((at,Ke)=>{const Jt=new Date(at.createdAt||0).getTime();return new Date(Ke.createdAt||0).getTime()-Jt}),ce(ke)}catch{ce([])}})()},[l,$t,oe,p==null?void 0:p.uid]);const Ys=async(B,ge,ke)=>{try{let at=0,Ke=0;try{const Ot=parseFloat(localStorage.getItem("shiftInitialReceivedDrawerFunds")||"0");at=Number.isFinite(Ot)?Ot:0}catch{}try{const Ot=parseFloat(localStorage.getItem("shiftInitialReceivedWalletBalancesTotal")||"0");Ke=Number.isFinite(Ot)?Ot:0}catch{}const Jt={id:`shift_receipt_${Date.now()}`,type:"report",senderPhone:(i==null?void 0:i.username)||"cashier",receiverPhone:ze||"admin",amount:0,status:"completed",createdAt:new Date().toISOString(),title:"إيصال تسليم وردية",cashierName:(i==null?void 0:i.name)||(i==null?void 0:i.username)||null,deficit:ge,deficitAmount:ge?ke:0,shiftStartAt:b,receivedDrawerFunds:at,receivedWalletBalancesTotal:Ke,receivedWalletBalances:Ht,deliveredDrawerFunds:Et||0,deliveredWalletBalancesTotal:re||0,deliveredWalletBalances:Oe,shiftProfit:Math.round(((Et||0)+(re||0)-(at+Ke))*100)/100};p!=null&&p.uid&&await De.saveUserTransaction(p.uid,Jt),ce(Ot=>[Jt,...Ot||[]])}catch{}};return e.jsxs(e.Fragment,{children:[e.jsx(me,{open:l,onOpenChange:m,children:e.jsxs(he,{className:"sm:max-w-md",children:[e.jsx(ue,{children:e.jsx(xe,{children:x?"تسليم الورديه والخروج":"إضافة مستخدم وردية"})}),x?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsx("div",{className:"text-sm",children:"المستخدم الحالي للوردية:"}),e.jsxs("div",{className:"font-semibold text-sm",children:[i==null?void 0:i.name," (",i==null?void 0:i.username,")"]})]}),e.jsx("div",{className:"text-xs text-gray-600",children:'لإنهاء الوردية والخروج، اضغط "تسليم الورديه والخروج" وسيُطلب الرقم السري.'})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-xs text-gray-600",children:'لاستكمال إضافة مستخدم جديد اضغط الزر أسفل "إضافة مستخدم جديد" لفتح النموذج.'}),Ne.length>0&&e.jsxs("div",{className:"mt-4 border-t pt-3",children:[e.jsx("div",{className:"text-sm font-medium mb-2",children:"المستخدمون المسجلون"}),e.jsx("div",{className:"space-y-2 max-h-48 overflow-auto",children:Ne.map((B,ge)=>e.jsxs("div",{className:"flex items-center justify-between rounded border px-3 py-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:B.name}),e.jsx("div",{className:"text-xs text-gray-500",children:B.username})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(c,{size:"sm",className:"w-full sm:w-auto",onClick:()=>{E(B),ut(!0)},children:"دخول"}),e.jsx(c,{size:"sm",className:"w-full sm:w-auto",variant:"destructive",onClick:()=>xt(B.username),children:"حذف"})]})]},ge))})]})]}),e.jsx(Ce,{className:"flex flex-wrap gap-2 justify-between",children:x?e.jsx("div",{className:"flex flex-wrap gap-2",children:e.jsx(c,{className:"w-full sm:w-auto",variant:"destructive",onClick:Ns,children:"تسليم الورديه والخروج"})}):e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(c,{className:"w-full sm:w-auto",onClick:()=>Ge(!0),children:"إضافة مستخدم جديد"}),e.jsx(c,{className:"w-full sm:w-auto",variant:"outline",onClick:()=>Fe(!0),children:"إيصالات التسليم"})]})})]})}),e.jsx(me,{open:ot,onOpenChange:Ge,children:e.jsxs(he,{className:"sm:max-w-md",children:[e.jsx(ue,{children:e.jsx(xe,{children:"إضافة مستخدم جديد"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(V,{className:"mb-1 block",children:"الاسم"}),e.jsx(R,{value:F,onChange:B=>z(B.target.value),placeholder:"أدخل الاسم"})]}),e.jsxs("div",{children:[e.jsx(V,{className:"mb-1 block",children:"اسم المستخدم"}),e.jsx(R,{value:Z,onChange:B=>L(B.target.value),placeholder:"أدخل اسم المستخدم"})]}),e.jsxs("div",{children:[e.jsx(V,{className:"mb-1 block",children:"الرقم السري"}),e.jsx(R,{type:"password",autoComplete:"new-password",value:D,onChange:B=>U(B.target.value),placeholder:"أدخل الرقم السري"})]}),e.jsx("div",{className:"text-xs text-gray-500",children:"المستخدم يمكنه: التحويل، السحب، اختيار المحفظة فقط."})]}),e.jsxs(Ce,{className:"flex gap-2 justify-between",children:[e.jsx(c,{variant:"secondary",onClick:()=>{Ge(!1)},children:"إلغاء"}),e.jsx(c,{onClick:()=>{!F.trim()||!Z.trim()||!D.trim()||(Pt(),Ge(!1))},children:"حفظ المستخدم"})]})]})}),e.jsx(me,{open:oe,onOpenChange:Fe,children:e.jsxs(he,{className:"sm:max-w-lg",children:[e.jsx(ue,{children:e.jsx(xe,{children:"إيصالات التسليم"})}),Y.length===0?e.jsx("div",{className:"text-xs text-gray-600",children:"لا توجد إيصالات تسليم محفوظة بعد."}):e.jsx("div",{className:"space-y-2 max-h-[60vh] overflow-auto",children:Y.map(B=>e.jsxs("div",{className:"rounded border px-3 py-2 cursor-pointer hover:bg-gray-50",onClick:()=>{we(B),it(!0)},children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm font-semibold",children:new Date(B.createdAt).toLocaleString("ar-EG")}),e.jsxs("div",{className:"text-xs text-gray-500",children:["إلى: ",B.receiverPhone]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-1",children:[e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مسلّمة: ",B.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مسلّمة (إجمالي): ",B.deliveredWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مستلمة: ",B.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مستلمة (إجمالي): ",B.receivedWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مسلّمة: ",B.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مسلّمة (إجمالي): ",B.deliveredWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مستلمة: ",B.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مستلمة (إجمالي): ",B.receivedWalletBalancesTotal??0]}),e.jsxs("div",{className:["text-xs",(B.shiftProfit??(B.deliveredDrawerFunds??0)+(B.deliveredWalletBalancesTotal??0)-(B.receivedDrawerFunds??0)-(B.receivedWalletBalancesTotal??0))>=0?"text-green-700":"text-red-700"].join(" "),children:["أرباح الوردية: ",B.shiftProfit??(B.deliveredDrawerFunds??0)+(B.deliveredWalletBalancesTotal??0)-(B.receivedDrawerFunds??0)-(B.receivedWalletBalancesTotal??0)]})]}),B.deficit&&e.jsxs("div",{className:"text-xs text-red-600 mt-1",children:["عجز: ",B.deficitAmount??0]})]},B.id))}),e.jsx(Ce,{className:"flex gap-2 justify-between",children:e.jsx(c,{variant:"secondary",onClick:()=>Fe(!1),children:"إغلاق"})})]})}),e.jsx(me,{open:Je,onOpenChange:it,children:e.jsxs(he,{className:"sm:max-w-md",children:[e.jsx(ue,{children:e.jsx(xe,{children:"إيصال تسليم وردية"})}),Te?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsxs("div",{className:"text-sm",children:["التاريخ: ",new Date(Te.createdAt).toLocaleString("ar-EG")]}),e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["تم التسليم إلى: ",Te.receiverPhone]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"المستلم عند الدخول"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية: ",Te.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["أرصدة المحافظ (إجمالي): ",Te.receivedWalletBalancesTotal??0]})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"المسلّم عند الخروج"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية: ",Te.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["أرصدة المحافظ (إجمالي): ",Te.deliveredWalletBalancesTotal??0]})]})]}),Te.deficit&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2 text-red-600",children:"عجز"}),e.jsxs("div",{className:"text-xs text-red-600",children:["المبلغ: ",Te.deficitAmount??0]})]}),Te.receivedWalletBalances&&Object.keys(Te.receivedWalletBalances).length>0&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"تفصيل المحافظ المستلمة"}),e.jsx("div",{className:"space-y-1",children:Object.entries(Te.receivedWalletBalances).map(([B,ge])=>e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-gray-600",children:B}),e.jsx("span",{className:"font-semibold",children:ge})]},B))})]}),Te.deliveredWalletBalances&&Object.keys(Te.deliveredWalletBalances).length>0&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"تفصيل المحافظ المسلّمة"}),e.jsx("div",{className:"space-y-1",children:Object.entries(Te.deliveredWalletBalances).map(([B,ge])=>e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-gray-600",children:B}),e.jsx("span",{className:"font-semibold",children:ge})]},B))})]})]}):e.jsx("div",{className:"text-xs text-gray-600",children:"لا يوجد تقرير محدد للعرض."}),e.jsx(Ce,{className:"flex gap-2 justify-between",children:e.jsx(c,{variant:"secondary",onClick:()=>it(!1),children:"إغلاق"})})]})}),e.jsx(me,{open:$e,onOpenChange:ut,children:e.jsxs(he,{className:"sm:max-w-md",children:[e.jsx(ue,{children:e.jsx(xe,{children:"أدخل الرقم السري للدخول"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm",children:u?`${u.name} (${u.username})`:""}),e.jsx(R,{type:"password",autoComplete:"off",value:He,onChange:B=>zt(B.target.value),placeholder:"أدخل الرقم السري"})]}),e.jsxs(Ce,{className:"flex gap-2 justify-between",children:[e.jsx(c,{variant:"secondary",onClick:()=>{zt(""),E(null),ut(!1)},children:"إلغاء"}),e.jsx(c,{onClick:()=>{if(u){if(He.trim()!==u.password){y({title:"خطأ في الرقم السري",description:"الرقم السري للكاشير غير صحيح",variant:"destructive"});return}g({name:u.name,username:u.username}),zt(""),ut(!1),m(!1),t(),K(!0)}},children:"دخول الورديه"})]})]})}),e.jsx(me,{open:le,onOpenChange:K,children:e.jsxs(he,{className:"sm:max-w-md",children:[e.jsx(ue,{children:e.jsx(xe,{children:"تسجيل أرصدة البداية والنقدية"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(V,{className:"mb-1 block",children:"الفلوس النقدية المستلمة عند الدخول"}),e.jsx(R,{type:"number",value:Ft,onChange:B=>ft(B.target.value),placeholder:"أدخل قيمة النقدية في الدرج عند بداية الورديه"})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(V,{className:"mb-1 block",children:"أرصدة المحافظ المستلمة (إجمالي) عند الدخول"}),e.jsx(R,{type:"number",value:Number.isFinite(St)?St:0,onChange:B=>{const ge=parseFloat(B.target.value);Rt(Number.isFinite(ge)?ge:0)},placeholder:"أدخل إجمالي أرصدة المحافظ عند بداية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"يمكن إضافة التفصيل لاحقاً إن لزم، المهم تسجيل الإجمالي."})]})]}),e.jsx(Ce,{className:"flex gap-2 justify-between",children:e.jsx(c,{onClick:()=>{const B=parseFloat(Ft),ge=St,ke=Number.isFinite(B)&&B>=0,at=Number.isFinite(ge)&&ge>=0;if(!ke||!at){y({title:"يرجى إدخال قيم صحيحة",description:"أدخل قيمًا رقمية غير سالبة للنقدية ولإجمالي أرصدة المحافظ",variant:"destructive"});return}try{localStorage.setItem("shiftInitialReceivedDrawerFunds",String(B)),localStorage.setItem("shiftInitialReceivedWalletBalancesTotal",String(ge))}catch{}y({title:"تم تسجيل أرصدة البداية",description:"سُجّل إجمالي النقدية وأرصدة المحافظ لبداية الورديه"}),K(!1)},children:"تأكيد وحفظ"})})]})}),e.jsx(me,{open:H,onOpenChange:B=>{B&&$(!0)},children:e.jsxs(he,{className:"sm:max-w-md",hideClose:!0,disableOutsideClose:!0,disableEscClose:!0,children:[e.jsx(ue,{children:e.jsx(xe,{children:"تسليم الورديه والخروج"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(c,{variant:C==="toUser"?"default":"secondary",onClick:()=>_("toUser"),children:"تسليم إلى مستخدم آخر"}),e.jsx(c,{variant:C==="toAdmin"?"default":"secondary",onClick:()=>_("toAdmin"),children:"تسليم إلى الأدمن الرئيسي"})]}),C==="toUser"&&e.jsxs("div",{className:"space-y-3",children:[Ne.length===0?e.jsx("div",{className:"text-sm text-gray-600",children:"لا يوجد مستخدمون مسجلون. قم بإضافة مستخدم أولاً."}):e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"اختر المستخدم الذي سيتسلم الورديه"}),e.jsx("div",{className:"space-y-2 max-h-40 overflow-auto",children:Ne.map((B,ge)=>e.jsxs("div",{className:`flex items-center justify-between rounded border px-3 py-2 cursor-pointer ${(A==null?void 0:A.username)===B.username?"bg-indigo-50 border-indigo-200":""}`,onClick:()=>ne(B),children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:B.name}),e.jsx("div",{className:"text-xs text-gray-500",children:B.username})]}),e.jsx("span",{className:"text-xs text-gray-400",children:"اختيار"})]},ge))})]}),e.jsxs("div",{children:[e.jsx(V,{className:"mb-1 block",children:"كلمة سر المستخدم المحدد"}),e.jsx(R,{type:"password",autoComplete:"off",value:q,onChange:B=>ie(B.target.value),placeholder:"أدخل كلمة السر"})]}),Pe&&e.jsx("div",{className:"text-xs text-red-600",children:Pe})]}),C==="toAdmin"&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm text-gray-600",children:"أدخل كلمة مرور الحساب الرئيسي لتسليم الورديه والخروج إلى الأدمن."}),e.jsx(R,{type:"password",autoComplete:"off",value:ae,onChange:B=>ee(B.target.value),placeholder:"كلمة المرور"}),fe&&e.jsx("div",{className:"text-xs text-red-600",children:fe})]})]}),e.jsx(Ce,{className:"flex gap-2 justify-between",children:e.jsx(c,{disabled:It||!C,onClick:async()=>{if(C){_e(!0);try{const B=await Vs();if(C==="toUser"){if(!A){Ve("يرجى اختيار المستخدم أولاً"),_e(!1);return}if(q.trim()!==A.password){Ve("كلمة السر غير صحيحة"),_e(!1);return}W(),g({name:A.name,username:A.username}),t(),M(`${A.name} (${A.username})`);try{localStorage.setItem("lastHandoverToAdmin","false")}catch{}$(!1),_(null),ne(null),ie(""),Ve(""),m(!1),At(B),We(null),wt(""),st(!0)}else if(C==="toAdmin"){J("");const ge=(p==null?void 0:p.email)||"";if(!ge){J("لا يوجد بريد للمستخدم الرئيسي للتحقق"),_e(!1);return}const{error:ke}=await h(ge,ae);if(ke){J("كلمة المرور غير صحيحة"),_e(!1);return}W(),g(null);try{localStorage.setItem("lastHandoverToAdmin","true")}catch{}ee(""),$(!1),m(!1),M("الأدمن الرئيسي"),At(B),We(null),wt(""),st(!0)}}catch{Ve("حدث خطأ أثناء التسليم، حاول مرة أخرى")}finally{_e(!1)}}},children:"تأكيد التسليم"})})]})}),e.jsx(me,{open:$t,onOpenChange:st,children:e.jsxs(he,{className:"sm:max-w-lg",hideClose:!0,disableOutsideClose:!0,disableEscClose:!0,children:[e.jsx(ue,{children:e.jsx(xe,{children:"تقرير تسليم الورديه والخروج"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsxs("div",{className:"text-sm",children:["تم تسليم الورديه إلى: ",e.jsx("span",{className:"font-semibold",children:ze})]}),b&&e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["بداية الورديه: ",new Date(b).toLocaleString("ar-EG")]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نهاية الورديه: ",new Date().toLocaleString("ar-EG")]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(V,{className:"mb-1 block",children:"الفلوس النقدية المستلمة"}),e.jsx(R,{type:"number",value:Ft,readOnly:!0,disabled:!0,placeholder:"قيمة مسجلة عند بداية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"قيمة غير قابلة للتعديل؛ تُسجّل عند الدخول."})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(V,{className:"mb-1 block",children:"أرصدة المحافظ المستلمة (إجمالي)"}),e.jsx(R,{type:"number",value:St,readOnly:!0,disabled:!0,placeholder:"إجمالي مسجل عند بداية الورديه"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(V,{className:"mb-1 block",children:"الفلوس النقدية المسلمة"}),e.jsx(R,{type:"number",value:Et,onChange:B=>{const ge=parseFloat(B.target.value);P(Number.isFinite(ge)?ge:0)},placeholder:"أدخل قيمة النقدية المسلمة عند نهاية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"ادخال يدوي لقيمة النقدية المسلّمة عند نهاية الورديه"})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(V,{className:"mb-1 block",children:"أرصدة المحافظ المسلمة (إجمالي)"}),e.jsx(R,{type:"number",value:re,onChange:B=>{const ge=parseFloat(B.target.value);pe(Number.isFinite(ge)?ge:0)},placeholder:"أدخل إجمالي أرصدة المحافظ المسلّمة"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"يمكنك إدخال الإجمالي يدوياً؛ التفصيل يُحفظ إن لزم"})]})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-1",children:"أرباح الوردية"}),e.jsx("div",{className:["text-sm",(Et??0)+(re??0)-((parseFloat(Ft||"0")||0)+(St??0))>=0?"text-green-700":"text-red-700"].join(" "),children:Math.round(((Et??0)+(re??0)-((parseFloat(Ft||"0")||0)+(St??0)))*100)/100}),e.jsx("div",{className:"text-xs text-gray-600",children:"محسوبة: (المسلّم − المستلم) للنقدية + المحافظ"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"هل يوجد عجز؟"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(c,{variant:Ye==="no"?"default":"secondary",onClick:()=>We("no"),children:"لا"}),e.jsx(c,{variant:Ye==="yes"?"default":"secondary",onClick:()=>We("yes"),children:"نعم"})]}),Ye==="yes"&&e.jsxs("div",{children:[e.jsx(V,{className:"mb-1 block",children:"مبلغ العجز"}),e.jsx(R,{type:"number",value:Tt,onChange:B=>wt(B.target.value),placeholder:"أدخل مبلغ العجز"})]})]})]}),e.jsx(Ce,{className:"flex gap-2 justify-between",children:e.jsx(c,{onClick:()=>{const B=Ye==="yes",ge=parseFloat(Tt)||0;(async()=>await Ys(lt,B,ge))(),y({title:"تم إضافة إيصال تسليم الورديه",description:"أُضيف الإيصال إلى المعاملات الأخيرة بعنوان إيصال تسليم وردية"}),st(!1)},children:"تأكيد وحفظ الإيصال"})})]})})]})},Wd=({open:l,onOpenChange:m})=>{const{shiftUser:i,endShift:x,setShiftUser:b}=Ia(),[g,t]=a.useState(""),[W,S]=a.useState(""),[p,h]=a.useState([]);a.useEffect(()=>{try{const y=localStorage.getItem("cashierUsers");h(y?JSON.parse(y):[])}catch{h([])}},[l]);const N=async()=>{if(S(""),!i)return;const y=p.find(F=>F.username===i.username);if(!y){S("لا يوجد مستخدم مطابق لهذه الوردية");return}if(g.trim()!==y.password){S("الرقم السري غير صحيح");return}x(),b(null),t(""),m(!1)};return e.jsx(me,{open:l,onOpenChange:y=>{t(""),S(""),m(y)},children:e.jsxs(he,{className:"sm:max-w-md",children:[e.jsx(ue,{children:e.jsx(xe,{children:"بروفيل الوردية"})}),i?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"rounded-lg border p-3 bg-gradient-to-r from-blue-50 to-indigo-50",children:[e.jsx("div",{className:"text-sm font-semibold text-gray-800",children:i.name}),e.jsx("div",{className:"text-xs text-gray-600",children:i.username})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{className:"block",children:"أدخل الرقم السري لتسليم الوردية"}),e.jsx(R,{type:"password",value:g,onChange:y=>t(y.target.value),placeholder:"الرقم السري للمستخدم",dir:"ltr"}),W&&e.jsx("div",{className:"text-red-600 text-xs",children:W})]})]}):e.jsx("div",{className:"text-sm text-gray-600",children:"لا يوجد مستخدم وردية نشط حالياً"}),e.jsxs(Ce,{className:"flex justify-between",children:[e.jsx(c,{variant:"outline",onClick:()=>m(!1),children:"إغلاق"}),e.jsx(c,{onClick:N,disabled:!i,children:"تسليم الوردية"})]})]})})};class ta{static async processTransfer(m){const{amount:i,currentCashBalance:x,currentWalletBalances:b,wallets:g,selectedWalletId:t}=m;if(i<=0)return{success:!1,newCashBalance:x,newWalletBalances:b,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(t&&!m.skipRemoteLimitsCheck)try{const h=await vs.canPerformOperation(t,i,"transfer");if(!h.canPerform)return{success:!1,newCashBalance:x,newWalletBalances:b,message:h.message||"تجاوز حد التحويل المسموح",error:"LIMIT_EXCEEDED"}}catch(h){return console.error("خطأ في التحقق من حدود التحويل:",h),{success:!1,newCashBalance:x,newWalletBalances:b,message:"خطأ في التحقق من حدود التحويل",error:"LIMIT_CHECK_ERROR"}}if(i<=0)return{success:!1,newCashBalance:x,newWalletBalances:b,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(t){const h=Math.max(b[t]||0,0);if(h<i){const N=g.find(y=>y.id===t);return{success:!1,newCashBalance:x,newWalletBalances:b,message:`رصيد غير كافي في المحفظة${N?` ${N.name}`:""}. المتاح: ${h} جنيه، المطلوب: ${i} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"}}}else{const h=ta.calculateTotalWalletBalance(b);if(h<i)return{success:!1,newCashBalance:x,newWalletBalances:b,message:`رصيد غير كافي في المحافظ. الرصيد المتاح: ${h} جنيه، المبلغ المطلوب: ${i} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"}}const W={...b};if(t){const h=W[t]||0;W[t]=h-i}else{let h=i;for(const N of g){if(h<=0)break;const y=Math.max(W[N.id]||0,0),F=Math.min(y,h);F>0&&(W[N.id]=(W[N.id]||0)-F,h-=F)}}const S=x+i;if(t)try{const h=vs.updateUsage(t,i,"transfer");m.nonBlockingUsageUpdate?h.catch(N=>console.error("خطأ في تحديث استخدام المحفظة:",N)):await h}catch(h){console.error("خطأ في تحديث استخدام المحفظة:",h)}let p="تم التحويل بنجاح";if(t){const h=W[t]||0;h<0&&(p=`تم التحويل بنجاح مع تحذير: رصيد محفظة ${t} أصبح ${h} جنيه.`)}return{success:!0,newCashBalance:S,newWalletBalances:W,message:p}}static processDeposit(m){const{amount:i,currentCashBalance:x,currentWalletBalances:b,wallets:g}=m;if(i<=0)return{success:!1,newCashBalance:x,newWalletBalances:b,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};const t=this.calculateTotalWalletBalance(b);if(t<i)return{success:!1,newCashBalance:x,newWalletBalances:b,message:`رصيد غير كافي في المحافظ. الرصيد المتاح: ${t} جنيه، المبلغ المطلوب: ${i} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"};const W=x+i,S={...b};let p=i;const h=g.find(y=>y.isDefault);if(h&&S[h.id]>=p)S[h.id]-=p,p=0;else for(const y of g){if(p<=0)break;const F=S[y.id]||0;if(F>0){const z=Math.min(F,p);S[y.id]=F-z,p-=z}}const N=p>0?`تم الإيداع جزئياً. تم إيداع ${i-p} جنيه في صندوق النقدية`:`تم الإيداع بنجاح. تم إضافة ${i} جنيه إلى صندوق النقدية`;return{success:!0,newCashBalance:W,newWalletBalances:S,message:N}}static async processWithdraw(m){const{amount:i,currentCashBalance:x,currentWalletBalances:b,wallets:g,selectedWalletId:t}=m;if(i<=0)return{success:!1,newCashBalance:x,newWalletBalances:b,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(t&&!m.skipRemoteLimitsCheck)try{const h=await vs.canPerformOperation(t,i,"withdraw");if(!h.canPerform)return{success:!1,newCashBalance:x,newWalletBalances:b,message:h.reason||"تم تجاوز الحد المسموح للسحب",error:"LIMIT_EXCEEDED"}}catch(h){return console.error("خطأ في التحقق من حدود السحب:",h),{success:!1,newCashBalance:x,newWalletBalances:b,message:"خطأ في التحقق من حدود السحب",error:"LIMIT_CHECK_ERROR"}}if(x<i)return{success:!1,newCashBalance:x,newWalletBalances:b,message:`رصيد غير كافي في صندوق النقدية. الرصيد المتاح: ${x} جنيه، المبلغ المطلوب: ${i} جنيه`,error:"INSUFFICIENT_CASH_BALANCE"};const W=x-i,S={...b},p=t?g.find(h=>h.id===t):g.find(h=>h.isDefault)||g[0];if(p){const h=S[p.id]||0;S[p.id]=h+i}else return{success:!1,newCashBalance:x,newWalletBalances:b,message:"لا توجد محافظ متاحة لإضافة المبلغ إليها",error:"NO_WALLETS_AVAILABLE"};if(t)try{const h=vs.updateUsage(t,i,"withdraw");m.nonBlockingUsageUpdate?h.catch(N=>console.error("خطأ في تحديث استخدام المحفظة:",N)):await h}catch(h){console.error("خطأ في تحديث استخدام المحفظة:",h)}return{success:!0,newCashBalance:W,newWalletBalances:S,message:`تم السحب بنجاح. تم إضافة ${i} جنيه إلى محفظة ${(p==null?void 0:p.name)||""}`}}static validateOperation(m,i){return m<=0?{valid:!1,error:"المبلغ يجب أن يكون أكبر من الصفر"}:!i||i.length===0?{valid:!1,error:"لا توجد محافظ متاحة"}:{valid:!0}}static calculateTotalWalletBalance(m){return Object.values(m).reduce((i,x)=>i+Math.max(x,0),0)}static deductFromWalletsAddToCash(m,i,x,b){return this.processTransfer({amount:m,currentCashBalance:i,currentWalletBalances:x,wallets:b})}static deductFromWalletsAddToCashDeposit(m,i,x,b){return this.processDeposit({amount:m,currentCashBalance:i,currentWalletBalances:x,wallets:b})}static deductFromCashAddToWallets(m,i,x,b){return this.processWithdraw({amount:m,currentCashBalance:i,currentWalletBalances:x,wallets:b})}static applyTransactionResult(m,i,x){m.success&&(i(m.newCashBalance),x(m.newWalletBalances))}static validateTransaction(m,i,x,b){if(m<=0)return{isValid:!1,error:"المبلغ يجب أن يكون أكبر من الصفر"};if(i==="transfer"){const g=this.calculateTotalWalletBalance(b);if(g<m)return{isValid:!1,error:`الرصيد المتاح في المحافظ (${g} جنيه) غير كافي للمبلغ المطلوب (${m} جنيه)`}}else if(i==="withdraw"){if(x<m)return{isValid:!1,error:`الرصيد المتاح في صندوق النقدية (${x} جنيه) غير كافي للمبلغ المطلوب (${m} جنيه)`}}else if(i==="deposit"){const g=this.calculateTotalWalletBalance(b);if(g<m)return{isValid:!1,error:`الرصيد المتاح في المحافظ (${g} جنيه) غير كافي للمبلغ المطلوب (${m} جنيه)`}}return{isValid:!0}}static getDeductionPreview(m,i,x){const b=[];let g=m;for(const t of x){if(g<=0)break;const W=i[t.id]||0,S=Math.min(Math.max(W,0),g);S>0&&(b.push({walletId:t.id,walletName:t.name,currentBalance:W,deductedAmount:S,newBalance:W-S}),g-=S)}return b}}let Na=null;function Fd(){const l=window;if(!Na){const m=l.AudioContext||l.webkitAudioContext;Na=new m}return Na.state==="suspended"&&Na.resume(),Na}function Ed(l,m,i){const x=i/1e3,b=Math.floor(l.sampleRate*x),g=l.createBuffer(1,b,l.sampleRate),t=g.getChannelData(0);for(let h=0;h<b;h++)t[h]=(Math.random()*2-1)*.6;const W=l.createBufferSource();W.buffer=g;const S=l.createBiquadFilter();S.type="highpass",S.frequency.value=1500,S.Q.value=.7;const p=l.createGain();p.gain.setValueAtTime(1e-4,m),p.gain.exponentialRampToValueAtTime(.4,m+.015),p.gain.exponentialRampToValueAtTime(1e-4,m+x),W.connect(S),S.connect(p),p.connect(l.destination),W.start(m),W.stop(m+x+.01)}function Md(l,m,i,x,b,g="triangle"){const t=l.createOscillator(),W=l.createGain();t.type=g;const S=b/1e3;t.frequency.setValueAtTime(i,m),t.frequency.linearRampToValueAtTime(x,m+S),W.gain.setValueAtTime(1e-4,m),W.gain.exponentialRampToValueAtTime(.25,m+.02),W.gain.exponentialRampToValueAtTime(1e-4,m+S),t.connect(W),W.connect(l.destination),t.start(m),t.stop(m+S+.02)}function Bd(){try{const l=Fd(),m=l.currentTime;Ed(l,m,90),Md(l,m+.12,1900,1100,180,"sawtooth")}catch{}}function Ld(l){if(!l)return!1;const i=l.replace(/[^0-9٠-٩]/g,"").replace(/[٠-٩]/g,x=>"0123456789"["٠١٢٣٤٥٦٧٨٩".indexOf(x)]);return/^(010|011|012|015)[0-9]{8}$/.test(i)}async function $d(l,m,i){const x=new AbortController,b=Math.max(0,(i==null?void 0:i.timeoutMs)??15e3),g=setTimeout(()=>x.abort(),b);try{const t="https://importantly-nonpulsative-dalilah.ngrok-free.dev/sendUSSD",W=JSON.stringify({device:l,code:m}),S=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json","ngrok-skip-browser-warning":"true"},body:W,signal:x.signal});clearTimeout(g);const p=await S.text();let h;try{h=JSON.parse(p)}catch{h={success:S.ok,message:p}}return{success:!!(h!=null&&h.success)||S.ok,message:(h==null?void 0:h.message)||(S.ok?"تم إرسال الكود عبر GET":"فشل الطلب"),statusCode:S.status}}catch(t){clearTimeout(g);const W=(t==null?void 0:t.name)==="AbortError";return{success:!1,message:W?"انتهت المهلة، تأكد أن الجسر يعمل":"تعذر الاتصال بـ Cashy Bridge عبر ngrok (POST)",statusCode:W?408:void 0}}}async function Rd(l){const m=l.deviceId??"R5CN504731B",i=String(l.receiver||"").replace(/\D/g,""),x=Math.round(Number(l.amount||0)),b=String(l.pin||"").replace(/\D/g,""),g=b?`*9*7*${i}*${x}*${b}#`:`*9*7*${i}*${x}#`;return $d(m,g,{timeoutMs:l.timeoutMs})}const $m=()=>{var Dl,Cl,Il,Tl;console.log("🔥 UserDashboardPage component is loading...");const{toast:l}=cs(),m=a.useRef(null),[i,x]=a.useState(0),b=async()=>{var n,o,d;const s="alkaptin678678@gmail.com",r=(o=(n=Al.currentUser)==null?void 0:n.email)==null?void 0:o.toLowerCase();if(!r||r!==s){l({title:"قيد التطوير",description:"هذه الميزة غير متاحة حالياً."});return}if(!Ja||!Ka||!qa){l({title:"بيانات ناقصة",description:"أدخل رقم الموبايل، الشركة والمبلغ",variant:"destructive"});return}try{al(!0);const f=await((d=Al.currentUser)==null?void 0:d.getIdToken()),v=await fetch("/api/topup",{method:"POST",headers:{"Content-Type":"application/json",...f?{Authorization:`Bearer ${f}`}:{}},body:JSON.stringify({phone:Ja,countryCode:"EG",operator:Ka,amount:Number(qa),useLocalAmount:!0})}),j=await v.json().catch(()=>({}));v.ok&&(j!=null&&j.success)?(l({title:"تم الشحن",description:(j==null?void 0:j.message)||"تم تنفيذ عملية الشحن بنجاح"}),Jr(!1),Xn(""),el(""),tl("")):l({title:"فشل الشحن",description:(j==null?void 0:j.message)||"حدث خطأ أثناء طلب الشحن",variant:"destructive"})}catch(f){console.error("Topup request error:",f),l({title:"خطأ غير متوقع",description:"تعذّر تنفيذ عملية الشحن. حاول لاحقاً.",variant:"destructive"})}finally{al(!1)}},{signOut:g,user:t,profile:W}=ys(),S=((t==null?void 0:t.email)||"").toLowerCase()==="vodafonecash00@gmail.com",p=ic(),h=$l(),{isShiftActive:N,shiftUser:y}=Ia(),{shopName:F}=oc(),z=cc(),[Z,L]=a.useState(!1),[D,U]=a.useState(!1);console.log("🔥 UserDashboardPage - user:",t?"exists":"null");const[H,$]=a.useState(!0),[C,_]=a.useState(!0),[ae,ee]=a.useState(!1),[fe,J]=a.useState(!1),[A,ne]=a.useState(""),[q,ie]=a.useState(""),[Pe,Ve]=a.useState(""),[It,_e]=a.useState([]),[$t,st]=a.useState(!1),[lt,At]=a.useState(null),[Ye,We]=a.useState("");a.useState(!1);const[Tt,wt]=a.useState(!1),[Ft,ft]=a.useState(!1),[St,Rt]=a.useState(!1),[Ht,ds]=a.useState(""),[Et,P]=a.useState(""),[re,pe]=a.useState([]),[Oe,Ie]=a.useState(!1),[ze,M]=a.useState(0),[le,K]=a.useState(!1),[Ne,Le]=a.useState(null),[ts,vt]=a.useState(!1),[$e,ut]=a.useState(""),[He,zt]=a.useState(""),[u,E]=a.useState(""),[Y,ce]=a.useState(!1),[oe,Fe]=a.useState(""),[Te,we]=a.useState(""),[Je,it]=a.useState(""),[ot,Ge]=a.useState(""),[xt,Pt]=a.useState(null),[Ns,Vs]=a.useState(!1),[Ys,ks]=a.useState(!1),[B,ge]=a.useState(!1),[ke,at]=a.useState(""),[Ke,Jt]=a.useState(""),[Ot,na]=a.useState(""),Gt=s=>{const r="٠١٢٣٤٥٦٧٨٩",n="۰۱۲۳۴۵۶۷۸۹";return(s||"").split("").map(o=>{const d=r.indexOf(o);if(d>-1)return String(d);const f=n.indexOf(o);return f>-1?String(f):o}).join("")},xr=s=>{const r=Gt(s||"").replace(/\D/g,"");return r?r.startsWith("201")&&r.length===12?"0"+r.slice(2):r.startsWith("00201")&&r.length===14?"0"+r.slice(4):(r.startsWith("01")&&r.length===11,r):""},wn=async()=>{try{const s=await fetch("/api/pending_sms");if(!s.ok)throw new Error("فشل الاتصال بواجهة /api/pending_sms");const r=await s.json();if(!Array.isArray(r)||r.length===0){l({title:"مفيش رسائل جديدة",description:"لا توجد SMS معلقة حالياً"});return}const n=r[0]||{},o=n.msisdn||n.address||"",d=xr(o);if(d){const j=d.replace(/\D/g,""),T=ye.find(I=>Gt(I.phone||"").replace(/\D/g,"")===j);if(T){Hs(T.id),ut(T.phone);try{const I=`selectedWallet_${(t==null?void 0:t.uid)||"default"}`;localStorage.setItem(I,T.id)}catch{}}}const f=n.amount??n.value??n.amountEgp??"";let v="";if(typeof f=="number")v=String(f);else if(typeof f=="string"&&f.trim()!==""){const j=parseFloat(Gt(f).replace(/[^0-9.]/g,""));Number.isNaN(j)||(v=String(j))}else if(n.message||n.body){const T=Gt(String(n.message||n.body)).match(/([0-9]+(?:\.[0-9]+)?)/);T&&(v=T[1])}E(v||""),pr("withdraw"),l({title:"تم الملء تلقائياً",description:"تم اختيار المحفظة وإدخال المبلغ من آخر SMS"})}catch(s){l({title:"فشل جلب الرسائل",description:(s==null?void 0:s.message)||"خطأ غير معروف",variant:"destructive"})}},[se,Ee]=a.useState(()=>{try{const s=localStorage.getItem("commissionMode")||localStorage.getItem("commissionMode_default");return s?s==="add":!0}catch{return!0}}),[X,pr]=a.useState("transfer"),[bt,ws]=a.useState([]),[ms,gr]=a.useState("all");a.useEffect(()=>{try{if(localStorage.setItem("commissionMode",se?"add":"deduct"),t!=null&&t.uid){const s=`commissionMode_${t.uid}`;localStorage.setItem(s,se?"add":"deduct")}}catch{}},[se,t==null?void 0:t.uid]),a.useEffect(()=>{try{const s=t!=null&&t.uid?localStorage.getItem(`commissionMode_${t.uid}`):null,r=localStorage.getItem("commissionMode"),n=localStorage.getItem("commissionMode_default"),o=s??r??n;o&&Ee(o==="add")}catch{}},[t==null?void 0:t.uid]);const[fr,la]=a.useState(!1),[Di,Ci]=a.useState(null),Ta=et.useRef(""),Sn=et.useRef(0);a.useEffect(()=>{const s=r=>{if(fr)return;const n=Date.now();if(r.key==="Enter"){const o=(Ta.current||"").trim();Ta.current="",o&&(Ci(o),la(!0));return}r.key.length===1&&(n-(Sn.current||0)>100&&(Ta.current=""),Ta.current+=r.key,Sn.current=n)};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[fr]);const[Ii,Ti]=a.useState(!1),[ki,Ud]=a.useState(null),[te,Hs]=a.useState("");a.useEffect(()=>{if(!Y)return;const s=Ss(),r=parseFloat(u||"0")||0;let n=0;if(X==="transfer"){if((s==null?void 0:s.defaultTransferCommission)!=null){const d=Number(s.defaultTransferCommission)||0;n=Math.round(d*r/1e3*100)/100}else{const d=Ke&&Ke.trim()!==""?parseFloat(Ke):0;n=Math.max(0,d)}const o=r+n;we((o||0).toString())}else{if((s==null?void 0:s.defaultWithdrawCommission)!=null){const d=Number(s.defaultWithdrawCommission)||0;n=Math.round(d*r/1e3*100)/100}else{const d=ke&&ke.trim()!==""?parseFloat(ke):Math.round(r*.01*100)/100;n=Math.max(0,d)}const o=se?r:Math.max(0,Math.round((r-n)*100)/100);we((o||0).toString())}},[Y,u,Ke,ke,te,se,X]);const Ss=()=>{var r,n;let s=ye.find(o=>o.id===te);if(!s)try{const o=localStorage.getItem(Zs());if(o){const d=JSON.parse(o);if(Array.isArray(d)&&d.length>0){const v=localStorage.getItem(`selectedWallet_${(t==null?void 0:t.uid)||"default"}`)||((r=d.find(j=>j.isDefault))==null?void 0:r.id)||((n=d[0])==null?void 0:n.id);s=d.find(j=>j.id===v)}}}catch{}return s};a.useLayoutEffect(()=>{try{const s=`wallets_${(t==null?void 0:t.uid)||"default"}`;let r=localStorage.getItem(s);if(!r){const n=Object.keys(localStorage).find(o=>o.startsWith("wallets_"));n&&(r=localStorage.getItem(n)||null)}if(r){const n=JSON.parse(r);if(Array.isArray(n)&&n.length>0){hs(n);const o=`selectedWallet_${(t==null?void 0:t.uid)||"default"}`,d=localStorage.getItem(o),f=d&&n.find(v=>v.id===d)||n.find(v=>v.isDefault)||n[0];f&&(Hs(f.id),ut(f.phone))}}}catch(s){console.error("تهيئة فورية للمحافظ من التخزين المحلي فشلت:",s)}},[]),a.useEffect(()=>{console.log("🔍 selectedWallet state changed to:",te)},[te]),a.useEffect(()=>{jo()},[]),a.useEffect(()=>{wo()},[]);const[ye,hs]=a.useState(()=>{try{const s=Object.keys(localStorage).find(n=>n.startsWith("wallets_")),r=s?localStorage.getItem(s):null;if(r){const n=JSON.parse(r);if(Array.isArray(n))return n}}catch{}return[]}),[Dn,Ai]=a.useState(""),Cn=(()=>{const s=Dn.replace(/\D/g,"");return s?ye.filter(r=>(r.phone||"").replace(/\D/g,"").includes(s)):ye})(),[Pi,_d]=a.useState(null),[Oi,In]=a.useState(!1),[Wi,ka]=a.useState(!1),[Fi,Ei]=a.useState(null);a.useState([]),a.useState([]);const[Mi,ia]=a.useState(!1),[vr,Tn]=a.useState("daily"),[Bi,kn]=a.useState(!1),[Li,br]=a.useState(!1),[An,As]=a.useState([]),$i=async s=>{try{const r=bt.find(o=>o.id===s);if(!r||!t)return;const n=bt.filter(o=>o.id!==s);ws(n);try{await De.removeUserTransaction(t.uid,s),await rr.permanentlyDeleteTransaction(s,t.uid)}catch(o){console.warn("تعذر الحذف النهائي من قواعد البيانات أثناء حذف الإيصال:",o)}try{const o=dt(),d=ct(),f=localStorage.getItem(o),v=localStorage.getItem(d);let j=f?parseFloat(f):Qe,T=v?JSON.parse(v):{...je};const I=r.amount||r.transferredAmount||r.withdrawnAmount||r.withdrawnAmountDetailed||0;if(r.type==="send"&&(r.fromWallet||te)){j-=r.commission||0;const Q=r.fromWallet||te;T[Q]=(T[Q]||0)+I}else if(r.type==="withdraw"&&(r.fromWallet||te)){j+=I,j-=r.commission||0;const Q=r.fromWallet||te;T[Q]=Math.max(0,(T[Q]||0)-I)}pt(j),Ze(T),localStorage.setItem(o,j.toString()),localStorage.setItem(d,JSON.stringify(T));const w={cashBalance:j,walletBalances:T,lastUpdated:new Date().toISOString()},O=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(O,JSON.stringify(w)),t!=null&&t.uid?De.updateUserData(t.uid,w).then(()=>{localStorage.removeItem(O),be(!1)}).catch(Q=>{console.warn("تعذر حفظ الأرصدة في Firebase بعد الحذف، تم الاحتفاظ محليًا:",Q),be(!0)}):be(!0)}catch(o){console.warn("تعذر عكس تأثير الأرصدة بعد الحذف:",o)}try{const o=r.fromWallet||te,d=await vs.getWalletLimits(t.uid,o);if(d){const f=r.amount||r.transferredAmount||r.withdrawnAmount||r.withdrawnAmountDetailed||0,v={...d};r.type==="send"?(v.dailyTransferUsed=Math.max(0,(d.dailyTransferUsed||0)-f),v.monthlyTransferUsed=Math.max(0,(d.monthlyTransferUsed||0)-f)):(v.dailyWithdrawUsed=Math.max(0,(d.dailyWithdrawUsed||0)-f),v.monthlyWithdrawUsed=Math.max(0,(d.monthlyWithdrawUsed||0)-f)),await vs.updateWalletLimits(t.uid,o,v)}}catch(o){console.warn("تعذر تحديث حدود المحفظة بعد الحذف:",o)}try{qt.removeTransactionEffects(r,t.uid)}catch(o){console.warn("تعذر تحديث التقارير بعد الحذف:",o)}l({title:"تم الحذف نهائيًا",description:"تم حذف الإيصال نهائيًا وعكس تأثيراته على الأرصدة والحدود والتقارير."}),ka(!1)}catch(r){console.error("خطأ أثناء حذف الإيصال:",r),l({title:"خطأ في حذف الإيصال",description:"حدث خطأ غير متوقع أثناء الحذف.",variant:"destructive"})}},Ri=async s=>{try{if(!bt.find(n=>n.id===s)||!t)return;await aa(ls(ht,"userTransactions",s),{status:"completed",confirmedAt:new Date}),ws(n=>n.map(o=>o.id===s?{...o,status:"completed"}:o)),l({title:"تم الإكمال",description:"تم وسم المعاملة كمكتملة."}),ka(!1)}catch(r){console.error("خطأ أثناء إكمال الإيصال:",r),l({title:"فشل الإكمال",description:"حدث خطأ غير متوقع أثناء تحديث الحالة.",variant:"destructive"})}},[Pn,Ui]=a.useState(""),On=Dd(Pn,300),[Aa,Wn]=a.useState(""),[Pa,Fn]=a.useState(""),[Ds,zd]=a.useState(""),[yr,Gs]=a.useState(!1),[En,oa]=a.useState(!1),[_i,Oa]=a.useState(!1),[yt,jr]=a.useState(null),[ca,zi]=a.useState(null),[Mn,Bn]=a.useState(!1),[Ji,Nr]=a.useState(!1),[Ki,Wa]=a.useState(!1),[qi,Fa]=a.useState(!1),[Vi,Ea]=a.useState(!1),[Yi,Ln]=a.useState(!0),[da,Hi]=a.useState(!1),[Gi,Ma]=a.useState(!1),[Qi,$n]=a.useState(()=>{try{const s=t!=null&&t.uid?`dailyReportsLockEnabled_${t==null?void 0:t.uid}`:"dailyReportsLockEnabled";return(localStorage.getItem(s)??localStorage.getItem("dailyReportsLockEnabled"))==="true"}catch{return!1}}),[Zi,wr]=a.useState(!1);a.useEffect(()=>{try{const s=t!=null&&t.uid?`dailyReportsLockEnabled_${t==null?void 0:t.uid}`:"dailyReportsLockEnabled",r=localStorage.getItem(s)??localStorage.getItem("dailyReportsLockEnabled");$n(r==="true")}catch{}},[t==null?void 0:t.uid]);const[Xi,Ba]=a.useState(!1),[eo,ma]=a.useState(!1),[Wt,Qt]=a.useState([]),[Sr,Rn]=a.useState(""),[Dr,Un]=a.useState(""),[Cr,_n]=a.useState(""),[ve,Ir]=a.useState(null),[to,ha]=a.useState(!1);a.useState(!1);const[so,Tr]=a.useState(!1),[zn,kr]=a.useState(""),[ao,ua]=a.useState(!1),[ro,Ar]=a.useState(!1),[us,Pr]=a.useState([]),[Or,Jn]=a.useState(""),[Wr,Kn]=a.useState(""),[Fr,qn]=a.useState(""),[Vn,Yn]=a.useState(""),[no,La]=a.useState(!1),[Er,Mr]=a.useState(null),[Ut,xa]=a.useState(null),[$a,Br]=a.useState(""),[lo,Qs]=a.useState(!1),[Hn,Ra]=a.useState(0),[ss,Ps]=a.useState(null),[Os,Lr]=a.useState(""),[Re,io]=a.useState(null),xs=async s=>{try{const r=JSON.stringify(s);localStorage.setItem(rl(),r);try{localStorage.setItem(ll(),r)}catch{}t!=null&&t.uid&&De.updateUserData(t.uid,{debts:s}).catch(()=>be(!0))}catch(r){console.error("خطأ في حفظ الديون:",r)}},oo=async()=>{try{const s=rl(),r=ll(),n=localStorage.getItem(s),o=localStorage.getItem(r),d=v=>{if(!v)return null;try{const j=JSON.parse(v);return Array.isArray(j)?j.map(T=>{var I;return{...T,createdAt:(I=T.createdAt)!=null&&I.toDate?T.createdAt.toDate():new Date(T.createdAt),partialPayments:Array.isArray(T.partialPayments)?T.partialPayments.map(w=>{var O;return{amount:Number(w.amount)||0,paidAt:(O=w.paidAt)!=null&&O.toDate?w.paidAt.toDate():new Date(w.paidAt)}}):[]}}):[]}catch(j){return console.warn("فشل في تحليل ديون localStorage:",j),null}};let f=d(n);if(!f||f.length===0){const v=d(o);if(v&&v.length>0&&(f=v,Qt(v),t!=null&&t.uid))try{await xs(v),localStorage.removeItem(r)}catch(j){console.warn("تعذر ترحيل الديون من المفتاح الافتراضي:",j)}}if(f&&f.length>0&&Qt(f),t!=null&&t.uid)try{const v=await nr(ls(ht,"users",t.uid));if(v.exists()){const j=v.data(),T=j.debts&&Array.isArray(j.debts)?j.debts.map(O=>{var Q;return{...O,createdAt:(Q=O.createdAt)!=null&&Q.toDate?O.createdAt.toDate():new Date(O.createdAt),partialPayments:Array.isArray(O.partialPayments)?O.partialPayments.map(k=>{var G;return{amount:Number(k.amount)||0,paidAt:(G=k.paidAt)!=null&&G.toDate?k.paidAt.toDate():new Date(k.paidAt)}}):[]}}):[],I=f&&f.length>0?f:T;Qt(I);try{localStorage.setItem(s,JSON.stringify(I))}catch{}(I.length!==T.length||I.some(O=>{const Q=T.find(k=>k.id===O.id);return!Q||Q.amount!==O.amount||Q.status!==O.status||(Q.paidAmount??0)!==(O.paidAmount??0)}))&&await De.updateUserData(t.uid,{debts:I})}else f&&f.length>0&&await De.saveUserData(t.uid,{debts:f})}catch(v){console.warn("تعذر تحميل الديون من Firebase، الاعتماد على المحلي:",v)}}catch(s){console.error("خطأ في تحميل الديون:",s)}},co=async()=>{if(t!=null&&t.uid){console.log("🔄 إعادة فحص حالة المستخدم...");try{await new Promise(r=>setTimeout(r,500));const s=await nr(ls(ht,"users",t.uid));if(s.exists()){const n=s.data().isActive===!0,o=await wa.checkTrialValidity(t.uid),d=o.isValid&&!o.isExpired;console.log("📊 حالة المستخدم:",{isActive:n,isOnTrial:d,hoursRemaining:o.hoursRemaining}),$(n||d),Ie(d),M(o.hoursRemaining),K(o.hasUsedTrial),ft(!n&&!d),console.log("✅ تم تحديث حالة المستخدم بنجاح:",{userIsActive:n||d,isOnFreeTrial:d})}}catch(s){console.error("خطأ في إعادة فحص حالة المستخدم:",s)}}},mo=async()=>{console.log("🎉 تم بدء التجربة المجانية، إعادة فحص حالة المستخدم..."),await co()},ho=async()=>{if(t!=null&&t.uid)try{vt(!0);const s=await yn(t.uid);Le(s)}catch(s){console.error("خطأ في جلب بيانات الاشتراك:",s)}finally{vt(!1)}};a.useState(!1);const[uo,$r]=a.useState(!1),[Qe,pt]=a.useState(0),[je,Ze]=a.useState({}),[xo,Gn]=a.useState(!1),[po,Qn]=a.useState(!1),[go,Rr]=a.useState(!1),[fo,Ua]=a.useState(!1),[Zn,Ur]=a.useState(""),[vo,_r]=a.useState(!1),[bo,_a]=a.useState(!1),[zr,za]=a.useState(""),[yo,Jr]=a.useState(!1),[Ja,Xn]=a.useState(""),[Ka,el]=a.useState(""),[qa,tl]=a.useState(""),[sl,al]=a.useState(!1),ct=()=>`walletBalances_${(t==null?void 0:t.uid)||"default"}`,dt=()=>`cashBalance_${(t==null?void 0:t.uid)||"default"}`,rl=()=>`debts_${(t==null?void 0:t.uid)||"default"}`,nl=()=>`customers_${(t==null?void 0:t.uid)||"default"}`,ll=()=>"debts_default",il=()=>`shopExpenses_${(t==null?void 0:t.uid)||"default"}`,jo=()=>{try{const s=localStorage.getItem(il());if(s){const r=JSON.parse(s);_e(r.map(n=>({...n,createdAt:new Date(n.createdAt)})))}}catch(s){console.error("خطأ أثناء تحميل مصروفات المحل من التخزين:",s)}},No=async s=>{try{localStorage.setItem(il(),JSON.stringify(s)),_e(s)}catch(r){console.error("خطأ أثناء حفظ مصروفات المحل في التخزين:",r)}},ol=()=>`deficiencies_${(t==null?void 0:t.uid)||"default"}`,wo=()=>{try{const s=localStorage.getItem(ol());if(s){const r=JSON.parse(s);pe(r.map(n=>({...n,createdAt:new Date(n.createdAt)})))}}catch(s){console.error("خطأ أثناء تحميل النواقص من التخزين:",s)}},Kr=async s=>{try{localStorage.setItem(ol(),JSON.stringify(s)),pe(s)}catch(r){console.error("خطأ أثناء حفظ النواقص في التخزين:",r)}},So=async s=>{try{localStorage.setItem(nl(),JSON.stringify(s)),Pr(s),t!=null&&t.uid&&await De.updateUserData(t.uid,{customers:s})}catch(r){console.error("خطأ أثناء حفظ العملاء في التخزين:",r)}},Do=async()=>{try{if(t!=null&&t.uid){const r=await nr(ls(ht,"users",t.uid));if(r.exists()){const n=r.data();if(n.customers&&Array.isArray(n.customers)){const o=n.customers.map(d=>{var f;return{...d,createdAt:(f=d.createdAt)!=null&&f.toDate?d.createdAt.toDate():new Date(d.createdAt)}});Pr(o);return}}}const s=localStorage.getItem(nl());if(s){const r=JSON.parse(s);Pr(r.map(n=>({...n,createdAt:new Date(n.createdAt)})))}}catch(s){console.error("خطأ أثناء تحميل العملاء من التخزين:",s)}},pa=()=>`transactions_${(t==null?void 0:t.uid)||"default"}`,ga=()=>`deletedTransactions_${(t==null?void 0:t.uid)||"default"}`,Zs=()=>`wallets_${(t==null?void 0:t.uid)||"default"}`,Ws=()=>`selectedWallet_${(t==null?void 0:t.uid)||"default"}`,qr=()=>{try{const s=Zs(),r=localStorage.getItem(s);if(r){const n=JSON.parse(r);if(Array.isArray(n)&&n.length>0)return n}}catch(s){console.warn("loadWalletsFromLocalWithMigration failed:",s)}return null},Vr=s=>{try{const r=Ws(),n=localStorage.getItem(r);if(n&&s.find(o=>o.id===n))return n}catch{}return null},[Yr,Va]=a.useState(""),[Mt,cl]=a.useState(""),as=et.useMemo(()=>{const s=Ne;if(!s)return!1;const r=dc(s),n=s.planType??s.plan??null,o=typeof n=="string"?n.toLowerCase():null,d=o==="monthly"||o==="quarterly"||o==="yearly"||o==="lifetime"||n===fs.MONTHLY||n===fs.QUARTERLY||n===fs.YEARLY||n===fs.LIFETIME;return r&&d},[Ne]),Ae=et.useMemo(()=>{const s=Ne;if(!s)return!1;const r=s.planType??s.plan??null,n=typeof r=="string"?r.toLowerCase():null;return r===fs.ZERO||n==="zero"},[Ne]),Co=()=>{if(!as){l({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}L(!0)};a.useState(!1);const[Io,To]=a.useState(!1),[ko,Ao]=a.useState(!1),[Po,Oo]=a.useState(!1),[Wo,Ya]=a.useState(!1),[Ha,Hr]=a.useState(""),[Gr,Qr]=a.useState(""),[dl,ml]=a.useState(!1),[Fo,Ga]=a.useState(!1),[hl,Zr]=a.useState(""),[ul,Xr]=a.useState(""),[xl,pl]=a.useState(!1),gl=async()=>{if(t!=null&&t.uid)try{const s=`userData_${t.uid}`,r=localStorage.getItem(s);if(r){const n=JSON.parse(r);console.log("🔄 مزامنة البيانات المحلية مع Firebase...",n);const o={lastSynced:new Date().toISOString()};typeof n.cashBalance=="number"&&(o.cashBalance=n.cashBalance),n.walletBalances&&typeof n.walletBalances=="object"&&(o.walletBalances=n.walletBalances),await De.updateUserData(t.uid,o),localStorage.removeItem(s),be(!1),console.log("✅ تمت المزامنة بنجاح وحذف البيانات المحلية")}else console.log("لا توجد بيانات محلية تحتاج للمزامنة")}catch(s){console.error("❌ فشل في مزامنة البيانات:",s),l({title:"فشل في المزامنة",description:"حدث خطأ أثناء مزامنة البيانات مع الخادم",variant:"destructive"})}},fl=t!=null&&t.uid?`recentTransactionsResetAt:${t.uid}`:null,en=et.useMemo(()=>{if(!fl)return null;try{const s=localStorage.getItem(fl);return s?new Date(s):null}catch{return null}},[t==null?void 0:t.uid]),vl=et.useMemo(()=>{const s=bt||[];return en?s.filter(r=>new Date(r.createdAt)>=en):s},[bt,en]),bl=et.useCallback(()=>{let s=vl;const r=On.trim();if(r&&(s=s.filter(n=>n.senderPhone&&n.senderPhone.includes(r)||n.receiverPhone&&n.receiverPhone.includes(r))),Aa){const n=new Date(Aa);s=s.filter(o=>{const d=new Date(o.createdAt);if(Pa){const[f,v]=Pa.split(":"),j=new Date(n);j.setHours(parseInt(f),parseInt(v),0,0);const T=new Date(j);return T.setHours(T.getHours()+1),d>=j&&d<T}else return d.toDateString()===n.toDateString()})}try{s=[...s].sort((n,o)=>{const d=new Date(n.createdAt||0).getTime();return new Date(o.createdAt||0).getTime()-d})}catch{}return s},[vl,On,Aa,Pa]),[Eo,Qa]=a.useState(!1),[yl,Za]=a.useState(""),[Mo,Xa]=a.useState(!1),[tn,sn]=a.useState(""),[Bo,be]=a.useState(!1);ye.reduce((s,r)=>s+(je[r.id]||0),0);const Lo=s=>Yt.verifyMasterPin(s),an=s=>Yt.verifyMasterPin(s);a.useEffect(()=>{if(!(t!=null&&t.uid))return;console.log("🚀 استعادة البيانات من localStorage عند تحميل الصفحة للمستخدم:",t.uid);const s=`walletBalances_${t.uid}`,r=localStorage.getItem(s);if(r)try{const d=JSON.parse(r);console.log("📱 استعادة أرصدة المحافظ من localStorage:",d),Ze(d)}catch(d){console.error("خطأ في قراءة أرصدة المحافظ من localStorage:",d)}const n=`cashBalance_${t.uid}`;let o=localStorage.getItem(n);if(!o){const d=`userCashBalance_${t.uid}`,f=localStorage.getItem(d);if(f){o=f;try{localStorage.setItem(n,f),localStorage.removeItem(d)}catch{}}}if(o){const d=parseFloat(o);console.log("💰 استعادة رصيد الدرج النقدي من localStorage:",d),pt(d)}},[t==null?void 0:t.uid]);const jl=async()=>{try{if(!te)return;const s=await vs.autoResetLimitsIfNeeded(te);io(s)}catch(s){console.error("خطأ في جلب حدود المحفظة المختارة:",s)}};a.useEffect(()=>{jl()},[te]),a.useEffect(()=>{const s=r=>{var n;(n=r==null?void 0:r.detail)!=null&&n.walletId&&r.detail.walletId===te&&jl()};return window.addEventListener("walletLimitsUpdated",s),()=>window.removeEventListener("walletLimitsUpdated",s)},[te]),a.useEffect(()=>{if(p.state){if(console.log("Location state:",p.state),p.state.openDebtDialog&&(Ae?l({title:"غير متاح",description:"الديون/الأجل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):ma(!0),window.history.replaceState({},document.title)),p.state.openSalesDialog&&(Ae?l({title:"غير متاح",description:"بيانات المبيعات غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):la(!0),window.history.replaceState({},document.title)),p.state.openMaintenanceDialog&&(Ae?l({title:"غير متاح",description:"الصيانة غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Fa(!0),window.history.replaceState({},document.title)),p.state.openCreditCardsDialog&&(console.log("Opening credit cards dialog"),Ae?l({title:"غير متاح",description:"كروت الائتمان غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Wa(!0),window.history.replaceState({},document.title)),p.state.openShopExpensesDialog&&(Ae?l({title:"غير متاح",description:"مصروفات المحل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Yt.hasMasterPin()?J(!0):ee(!0),window.history.replaceState({},document.title)),p.state.openDeficienciesDialog&&(Ae?l({title:"غير متاح",description:"النواقص غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Rt(!0),window.history.replaceState({},document.title)),p.state.openTransactionSection){const s=document.getElementById("transaction-section");s&&s.scrollIntoView({behavior:"smooth"}),p.state.transactionType&&pr(p.state.transactionType),p.state.startNewTransaction&&(zt(""),E(""),at(""),Jt(""),console.log("🔒 Starting new transaction without changing wallet selection")),p.state.focusWalletSelection&&setTimeout(()=>{const r=document.querySelector('[data-testid="wallet-select"]');r&&r.focus()},500),window.history.replaceState({},document.title)}p.state.openCashierShiftModal&&(as?L(!0):l({title:"غير متاح",description:"وردية الكاشير متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"}),window.history.replaceState({},document.title)),p.state.openMachineDailyDialog&&(as?Ea(!0):l({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"}),window.history.replaceState({},document.title))}},[p.state,ye]),a.useEffect(()=>{var s;if(t!=null&&t.uid)try{const r=qr();if(r&&r.length>0){hs(r);const n=Vr(r)||localStorage.getItem(Ws()),o=n&&r.find(d=>d.id===n)?n:(s=r[0])==null?void 0:s.id;o&&!te&&fa(o,"localStorageHydration")}}catch(r){console.error("خطأ في تهيئة المحافظ من التخزين المحلي:",r)}},[t==null?void 0:t.uid]),a.useEffect(()=>{p.pathname==="/user/dashboard"&&sessionStorage.getItem("previousPath")==="/user/add-wallet"&&(console.log("🔄 Returned from wallet addition page - reloading wallets"),er(),sessionStorage.removeItem("previousPath")),sessionStorage.setItem("previousPath",p.pathname)},[p.pathname,t==null?void 0:t.uid]),a.useEffect(()=>{if(!(t!=null&&t.uid))return;console.log("🔥 Setting up real-time user activation listener for:",t.uid);const s=ls(ht,"users",t.uid),r=mc(s,n=>{if(n.exists()){const o=n.data(),d=o.isActive===!0;console.log("🔥 Real-time user status update:",{userId:t.uid,isActive:d,subscription:o.subscription}),d&&!H?(console.log("🎉 User activated! Redirecting to dashboard..."),$(!0),ft(!1),_(!1)):!d&&H&&(console.log("❌ User deactivated! Showing activation modal..."),$(!1),ft(!0))}},n=>{console.error("❌ Error in real-time user listener:",n)});return()=>{console.log("🔥 Cleaning up real-time user listener"),r()}},[t==null?void 0:t.uid,H]),a.useEffect(()=>{if(!(t!=null&&t.uid))return;const s=n=>{const{userId:o}=n.detail;o===t.uid&&(console.log("🎉 Subscription activation event received for current user!"),$(!0),ft(!1),_(!1),setTimeout(()=>{console.log("✅ User activation completed - data updated")},1e3))},r=n=>{const{userId:o,isActive:d}=n.detail;o===t.uid&&(console.log("🔄 User subscription update event received:",{userId:o,isActive:d}),d&&!H&&($(!0),ft(!1),_(!1),setTimeout(()=>{console.log("✅ User subscription updated - data refreshed")},1e3)))};return window.addEventListener("subscriptionActivated",s),window.addEventListener("userSubscriptionUpdated",r),()=>{window.removeEventListener("subscriptionActivated",s),window.removeEventListener("userSubscriptionUpdated",r)}},[t==null?void 0:t.uid,H]),a.useEffect(()=>{const s=r=>{var f;const n=r.target,o=(f=n==null?void 0:n.tagName)==null?void 0:f.toLowerCase();if(!(o==="input"||o==="textarea"||o==="select"||((n==null?void 0:n.isContentEditable)??!1))&&!(r.ctrlKey||r.altKey||r.metaKey)&&!r.repeat){if(Ae&&r.key>="1"&&r.key<="9"){r.preventDefault();return}switch(r.key){case"1":break;case"2":Nr(!0);break;case"3":Ae?l({title:"غير متاح",description:"كروت الائتمان غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Wa(!0);break;case"4":as?L(!0):l({title:"غير متاح",description:"وردية الكاشير متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});break;case"5":Ae?l({title:"غير متاح",description:"بيانات المبيعات غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):la(!0);break;case"6":Ae?l({title:"غير متاح",description:"الديون/الأجل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):ma(!0);break;case"7":Ae?l({title:"غير متاح",description:"الصيانة غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Fa(!0);break;case"8":as?Ea(!0):l({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});break;case"9":Ae?l({title:"غير متاح",description:"مصروفات المحل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Yt.hasMasterPin()?J(!0):ee(!0);break}}};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[Ae,as]),a.useEffect(()=>{console.log("🔥 useEffect loadUserData started",{user:t==null?void 0:t.uid,isCheckingActivation:C}),(async()=>{try{if(!(t!=null&&t.uid)){console.log("🔥 No user UID, setting isCheckingActivation to false"),_(!1);return}let o=!1;const d=`userData_${t==null?void 0:t.uid}`,f=localStorage.getItem(d);if(f)try{const w=JSON.parse(f);w.walletBalances&&(Ze(w.walletBalances),o=!0,console.log("⚡ تحميل فوري لأرصدة المحافظ من بيانات المستخدم:",w.walletBalances))}catch(w){console.error("خطأ في قراءة بيانات المستخدم من localStorage:",w)}if(!o){const w=localStorage.getItem(ct());if(w)try{const O=JSON.parse(w);Ze(O),o=!0,console.log("⚡ تحميل فوري لأرصدة المحافظ من النسخة الاحتياطية:",O)}catch(O){console.error("خطأ في قراءة أرصدة المحافظ من localStorage:",O)}}if(!o){const O=Object.keys(localStorage).filter(Q=>Q.startsWith("walletBalances_backup_")).sort().reverse();for(const Q of O)try{const k=localStorage.getItem(Q);if(k){const G=JSON.parse(k);Ze(G),o=!0,console.log("⚡ تحميل فوري لأرصدة المحافظ من النسخة الاحتياطية بالتوقيت:",G);break}}catch(k){console.error("خطأ في قراءة النسخة الاحتياطية:",k);continue}}let v=localStorage.getItem(dt());if(!v&&(t!=null&&t.uid)){const w=`userCashBalance_${t.uid}`,O=localStorage.getItem(w);if(O){v=O;try{localStorage.setItem(dt(),O),localStorage.removeItem(w)}catch{}}}v&&(pt(parseFloat(v)),console.log("⚡ تحميل فوري لرصيد الدرج النقدي من localStorage:",v));try{const w=await nr(ls(ht,"users",t.uid));if(w.exists()){const Q=w.data().isActive===!0,k=await wa.checkTrialValidity(t.uid),G=k.isValid&&!k.isExpired;$(Q||G),Ie(G),M(k.hoursRemaining),K(k.hasUsedTrial),ft(!Q&&!G),console.log("📊 حالة المستخدم:",{isActive:Q,isOnTrial:G,hoursRemaining:k.hoursRemaining,hasUsedTrial:k.hasUsedTrial})}else $(!1),ft(!0)}catch(w){console.error("خطأ في فحص حالة تفعيل المستخدم:",w),$(!1),ft(!0)}finally{_(!1)}console.log("🔄 بدء تحميل بيانات المستخدم من Firebase...",{userId:t==null?void 0:t.uid});const j=localStorage.getItem(d);let T=!1;if(j)try{const w=JSON.parse(j),O=new Date(w.lastUpdated);(new Date().getTime()-O.getTime())/(1e3*60)<1&&(T=!0,console.log("⚡ توجد تغييرات محلية حديثة (أقل من دقيقة)، تجنب إعادة التحميل من Firebase"),w.walletBalances&&Ze(w.walletBalances),w.cashBalance!==void 0&&pt(w.cashBalance))}catch(w){console.error("خطأ في قراءة البيانات المحلية:",w)}if(j&&!T)try{const w=JSON.parse(j),O=new Date(w.lastUpdated);(new Date().getTime()-O.getTime())/(1e3*60)>10&&(console.log("🗑️ حذف البيانات المحلية القديمة (أكثر من 10 دقائق)"),localStorage.removeItem(d))}catch(w){console.error("خطأ في حذف البيانات المحلية القديمة:",w)}if(!T&&(t!=null&&t.uid)){const w=await De.getUserData(t.uid);if(console.log("📥 البيانات المحملة من Firebase:",w),w){const O=(w==null?void 0:w.walletBalances)||{},Q=w!=null&&w.lastUpdated?new Date(w.lastUpdated):null;let k=null,G=null;try{const Se=localStorage.getItem(d);Se&&(k=JSON.parse(Se),k!=null&&k.lastUpdated&&(G=new Date(k.lastUpdated)))}catch(Se){console.error("خطأ في قراءة بيانات النسخة المحلية للمقارنة:",Se)}if(!!(G&&(!Q||G>Q))&&(k!=null&&k.walletBalances)){console.log("⚖️ تفضيل الأرصدة المحلية الأحدث على Firebase"),Ze(k.walletBalances);try{localStorage.setItem(ct(),JSON.stringify(k.walletBalances))}catch{}try{await De.updateUserData(t.uid,{walletBalances:k.walletBalances,lastUpdated:G.toISOString()})}catch(Se){console.error("فشل مزامنة الأرصدة المحلية الأحدث إلى Firebase:",Se),be(!0)}}else{console.log("🏛️ اعتماد Firebase كمصدر الحقيقة لأرصدة المحافظ"),Ze(O);try{localStorage.setItem(ct(),JSON.stringify(O))}catch{}}if((w==null?void 0:w.cashBalance)!==void 0){console.log("💰 تحميل رصيد الدرج النقدي من Firebase:",w.cashBalance),pt(w.cashBalance);try{localStorage.setItem(dt(),w.cashBalance.toString())}catch{}}try{const Se=t!=null&&t.uid?await rr.getDeletedTransactionsByUser(t.uid):[];if(Se&&Se.length>0)As(Se),console.log("🗑️ تم تحميل المعاملات المحذوفة من Firebase:",Se.length);else{const mt=localStorage.getItem(ga());if(mt)try{const Me=JSON.parse(mt);As(Me),console.log("🗑️ تم تحميل المعاملات المحذوفة من localStorage:",Me.length)}catch(Me){console.error("خطأ في قراءة المعاملات المحذوفة من localStorage:",Me)}}}catch(Se){console.error("خطأ في تحميل المعاملات المحذوفة من Firebase:",Se);const mt=localStorage.getItem(ga());if(mt)try{const Me=JSON.parse(mt);As(Me),console.log("🗑️ تم تحميل المعاملات المحذوفة من localStorage (fallback):",Me.length)}catch(Me){console.error("خطأ في قراءة المعاملات المحذوفة من localStorage:",Me)}}}else{console.log("⚠️ لا توجد بيانات مستخدم في Firebase، محاولة استعادة من localStorage");const O=localStorage.getItem(ct());if(O)try{const k=JSON.parse(O);console.log("📱 استعادة أرصدة المحافظ من localStorage:",k),Ze(k)}catch(k){console.error("خطأ في قراءة أرصدة المحافظ من localStorage:",k)}let Q=localStorage.getItem(dt());if(!Q&&(t!=null&&t.uid)){const k=`userCashBalance_${t.uid}`,G=localStorage.getItem(k);if(G){Q=G;try{localStorage.setItem(dt(),G),localStorage.removeItem(k)}catch{}}}Q&&(pt(parseFloat(Q)),console.log("💰 استعادة رصيد الدرج النقدي من localStorage:",Q));try{const k=t!=null&&t.uid?await rr.getDeletedTransactionsByUser(t.uid):[];if(k&&k.length>0)As(k),console.log("🗑️ تم تحميل المعاملات المحذوفة من Firebase:",k.length);else{const G=localStorage.getItem(ga());if(G)try{const qe=JSON.parse(G);As(qe),console.log("🗑️ تم تحميل المعاملات المحذوفة من localStorage:",qe.length)}catch(qe){console.error("خطأ في قراءة المعاملات المحذوفة من localStorage:",qe)}}}catch(k){console.error("خطأ في تحميل المعاملات المحذوفة من Firebase:",k);const G=localStorage.getItem(ga());if(G)try{const qe=JSON.parse(G);As(qe),console.log("🗑️ تم تحميل المعاملات المحذوفة من localStorage (fallback):",qe.length)}catch(qe){console.error("خطأ في قراءة المعاملات المحذوفة من localStorage:",qe)}}}}console.log("🔄 بدء تحميل المحافظ من Firebase...");try{const w=await Is.getByMerchantId((t==null?void 0:t.uid)||"");if(w&&w.length>0){console.log("✅ تم العثور على محافظ في Firebase:",w.length);const O=w.map(G=>({id:G.id,name:G.label||"محفظة بدون اسم",phone:G.msisdn,isDefault:!1,monthlyWithdrawalLimit:G.monthlyWithdrawalLimit??G.withdrawLimit??2e5,monthlyTransferLimit:G.monthlyTransferLimit??G.transferLimit??2e5,defaultTransferCommission:G.defaultTransferCommission!=null?Number(G.defaultTransferCommission):null,defaultWithdrawCommission:G.defaultWithdrawCommission!=null?Number(G.defaultWithdrawCommission):null}));hs(O),localStorage.setItem(Zs(),JSON.stringify(O));const Q=localStorage.getItem(Ws());let k=null;Q&&O.find(G=>G.id===Q)?k=O.find(G=>G.id===Q):k=O[0],k&&(Hs(k.id),ut(k.phone)),console.log("🔄 تم تحديث المحافظ من Firebase وحفظها في localStorage")}else{console.log("⚠️ لا توجد محافظ في Firebase، محاولة التحميل من localStorage...");const O=qr();if(O&&O.length>0)try{console.log("📱 تم العثور على محافظ محلية بعد الهجرة:",O.length),hs(O);const Q=Vr(O)||localStorage.getItem(Ws());let k=null;Q&&O.find(G=>G.id===Q)?k=O.find(G=>G.id===Q):k=O.find(G=>G.isDefault)||O[0],k&&(Hs(k.id),ut(k.phone))}catch(Q){console.error("خطأ في معالجة المحافظ بعد الهجرة:",Q)}else console.log("⚠️ لا توجد محافظ محلية، لن نقوم بإنشاء محافظ افتراضية."),hs([])}}catch(w){console.error("خطأ في تحميل المحافظ من Firebase:",w);const O=qr();if(O&&O.length>0)try{console.log("📱 استخدام المحافظ من localStorage بعد الهجرة:",O.length),hs(O);const Q=Vr(O)||localStorage.getItem(Ws());let k=null;Q&&O.find(G=>G.id===Q)?k=O.find(G=>G.id===Q):k=O.find(G=>G.isDefault)||O[0],k&&(Hs(k.id),ut(k.phone))}catch(Q){console.error("خطأ في قراءة المحافظ من localStorage بعد الهجرة:",Q),hs([])}else console.log("⚠️ لا توجد محافظ محلية، لن يتم إنشاء محافظ افتراضية"),hs([])}const I=t!=null&&t.uid?await De.getUserTransactions(t.uid):[];if(I&&I.length>0){console.log("📊 تم تحميل المعاملات من Firebase:",I.length);const w=I.map(k=>({...k,createdAt:new Date(k.createdAt),senderPhone:k.senderMsisdn||k.senderPhone||"",receiverPhone:k.receiverMsisdn||k.receiverPhone||"",type:k.txnType==="send"?"send":k.txnType==="receive"?"withdraw":k.type||"withdraw",status:k.status==="confirmed"?"completed":k.status||"completed"})),O=An.map(k=>k.id||k.originalTransactionId),Q=w.filter(k=>!O.includes(k.id));console.log("✅ تم فلترة المعاملات المحذوفة:",{total:I.length,deleted:O.length,active:Q.length}),ws(Q)}await gl()}catch(o){console.error("خطأ في تحميل بيانات المستخدم من Firebase:",o);let d=localStorage.getItem(dt());if(!d&&(t!=null&&t.uid)){const v=`userCashBalance_${t.uid}`,j=localStorage.getItem(v);if(j){d=j;try{localStorage.setItem(dt(),j),localStorage.removeItem(v)}catch{}}}d&&pt(parseFloat(d));const f=localStorage.getItem(ct());if(f)try{const v=JSON.parse(f);Ze(v),console.log("📱 تم استعادة أرصدة المحافظ من localStorage:",v)}catch(v){console.error("خطأ في قراءة أرصدة المحافظ من localStorage:",v)}}})().then(async()=>{await r(),await n()});const r=async()=>{try{for(const o of ye)await Wc.autoResetLimitsIfNeeded(o.phone)}catch(o){console.error("خطأ في التصفير التلقائي للحدود:",o)}},n=async()=>{try{const o=qt.getReportsData(t==null?void 0:t.uid);if((o.lastDailyResetDate?qt.shouldResetDailyReports(o.lastDailyResetDate):!1)&&(t!=null&&t.uid)&&o.lastDailyResetDate){const v=new Date(o.lastDailyResetDate),j=v.toDateString();let T=bt.filter(Se=>new Date(Se.createdAt).toDateString()===j&&Se.status==="completed");const I=qt.filterVisibleTransactions(T,"daily",t==null?void 0:t.uid),w=I.length,O=I.reduce((Se,mt)=>Se+mt.amount,0),Q=I.filter(va).reduce((Se,mt)=>{const Me=mt.withdrawnAmount!==void 0?mt.withdrawnAmount:mt.amount;return Se+Me},0),k=I.filter(ba).reduce((Se,mt)=>{const Me=mt.sentAmount!==void 0?mt.sentAmount:mt.amount;return Se+Me},0),G=I.reduce((Se,mt)=>Se+qt.calculateTransactionProfit(mt),0),qe=new Date(v).toISOString().slice(0,10);await zl.add({userId:t.uid,reportDate:qe,totalTransactions:w,totalAmount:Number(O.toFixed(2)),totalWithdrawn:Number(Q.toFixed(2)),totalSent:Number(k.toFixed(2)),profit:Number(G.toFixed(2)),walletId:null}),l({title:"تم أرشفة تقارير اليوم",description:qe})}const f=qt.autoResetReportsIfNeeded(t==null?void 0:t.uid);(f.dailyReset||f.monthlyReset)&&console.log("تم التصفير التلقائي:",f)}catch(o){console.error("خطأ في التصفير التلقائي للتقارير:",o)}};ho(),oo(),Do(),console.log("🔥 useEffect loadUserData completed")},[t==null?void 0:t.uid]);const er=async()=>{var s;if(t!=null&&t.uid)try{const r=await Is.getByMerchantId(t.uid);if(r&&r.length>0){const n=r.map(o=>({id:o.id,name:o.label||"محفظة بدون اسم",phone:o.msisdn,isDefault:!1,monthlyWithdrawalLimit:o.monthlyWithdrawalLimit??o.withdrawLimit??2e5,monthlyTransferLimit:o.monthlyTransferLimit??o.transferLimit??2e5,defaultTransferCommission:o.defaultTransferCommission!=null?Number(o.defaultTransferCommission):void 0,defaultWithdrawCommission:o.defaultWithdrawCommission!=null?Number(o.defaultWithdrawCommission):void 0}));if(hs(n),localStorage.setItem(Zs(),JSON.stringify(n)),t!=null&&t.uid){const o=localStorage.getItem(Ws());if(!!(te&&n.find(f=>f.id===te)))console.log("🔒 Preserving current wallet selection:",te);else{const v=(o&&n.find(j=>j.id===o)?o:null)||((s=n[0])==null?void 0:s.id);v&&(console.log("🔄 Fixing invalid wallet selection:",v),fa(v))}}console.log("🔄 تم تحديث المحافظ من Firebase:",n.length)}}catch(r){console.error("خطأ في تحميل المحافظ من Firebase:",r)}};a.useEffect(()=>{const s=p.pathname;sessionStorage.getItem("previousPath")==="/user/add-wallet"&&s==="/user/dashboard"&&(console.log("🔄 Returning from add wallet page - reloading wallets"),console.log("🔒 Current wallet before add-wallet return reload:",te),er(),sessionStorage.removeItem("previousPath")),sessionStorage.setItem("previousPath",s)},[p.pathname,t==null?void 0:t.uid]),a.useEffect(()=>{const s=()=>{console.log("🔄 Window focused - reloading wallets"),console.log("🔒 Current wallet before focus reload:",te),er().then(()=>{console.log("🔒 Wallet preserved after focus reload:",te)})};return window.addEventListener("focus",s),()=>{window.removeEventListener("focus",s)}},[t==null?void 0:t.uid,te,ye]);const fa=(s,r="unknown")=>{console.log(`🎯 setWalletSelection called from ${r} with walletId:`,s),console.log("🔍 Previous selectedWallet:",te),Hs(s);const n=ye.find(o=>o.id===s);n&&(ut(n.phone),console.log("✅ Wallet set successfully:",s,"Phone:",n.phone)),t!=null&&t.uid&&(localStorage.setItem(Ws(),s),console.log("💾 Saved wallet to localStorage:",s))},$o=s=>{if(s==="__add_wallet"){h("/user/add-wallet");return}if(s==="__view_wallets"){ge(!0);return}fa(s,"handleWalletChange")},tr=s=>{console.log("🔄 handleTransactionTypeChange called with type:",s),console.log("🔍 Current selectedWallet before change:",te),console.log("🔍 Available wallets count:",ye.length),pr(s),zt(""),E(""),at(""),Jt(""),console.log("✅ Transaction type changed to:",s,"- Wallet selection preserved:",te),setTimeout(()=>{const r=document.getElementById("transaction-section");r&&r.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})},100)};a.useEffect(()=>{const s=r=>{const n=r.target;if(!!n&&(n.tagName==="INPUT"||n.tagName==="TEXTAREA"||n.tagName==="SELECT"||n.isContentEditable)||(r.key==="ArrowLeft"?(r.preventDefault(),tr("withdraw")):r.key==="ArrowRight"&&(r.preventDefault(),tr("transfer"))),r.key==="Enter"){const d=X==="transfer"?"transferSubmitButton":"withdrawSubmitButton",f=document.getElementById(d);f&&!f.disabled&&(r.preventDefault(),f.click())}};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[X]);const Ro=s=>{Ei((n=>({id:n.id,type:n.type==="send"?"transfer":"withdraw",sender_msisdn:n.senderPhone,receiver_msisdn:n.receiverPhone,amount:n.amount,commission:n.commission||0,fee:(n==null?void 0:n.fee)??0,status:n.status==="failed"?"failed":n.status==="completed"?"completed":"pending",createdAt:new Date(n.createdAt).toISOString(),updatedAt:new Date(n.createdAt).toISOString(),shopName:F??(W==null?void 0:W.shopName)??(t==null?void 0:t.displayName)??"المحل",cashierName:(n==null?void 0:n.cashierName)??null,commissionMode:(n==null?void 0:n.commissionMode)??(n.type==="send"||se?"add":"deduct"),totalCharged:(n==null?void 0:n.totalCharged)??(n.type==="send"?Number(n.amount||0)+Number(n.commission||0)+Number((n==null?void 0:n.fee)||0):se?Number(n.amount||0)+Number(n.commission||0):Number(n.amount||0))}))(s)),ka(!0)},Uo=async s=>{if(!(t!=null&&t.uid)){l({title:"خطأ في المصادقة",description:"يجب تسجيل الدخول أولاً لحذف المعاملات",variant:"destructive"});return}const r=bt.find(n=>n.id===s);if(!r){l({title:"خطأ في الحذف",description:"لم يتم العثور على المعاملة المطلوب حذفها",variant:"destructive"});return}try{console.log("🗑️ بدء عملية حذف المعاملة:",s),console.log("🔄 حذف المعاملة نهائياً من Firebase...",{transactionId:r.id,userId:t.uid,transactionData:r}),await De.removeUserTransaction(t.uid,r.id),console.log("✅ تم حذف المعاملة نهائياً من Firebase userTransactions");try{await rr.saveDeletedTransaction({...r,userId:t.uid,originalTransactionId:r.id,deletedAt:new Date().toISOString()}),console.log("✅ تم حفظ المعاملة في سجل المحذوفات مع تاريخ الحذف")}catch(d){console.warn("⚠️ فشل في حفظ المعاملة في سجل المحذوفات، لكن الحذف من Firebase نجح:",d)}const n=[...An,r],o=bt.filter(d=>d.id!==s);As(n),ws(o),In(!1),localStorage.setItem(ga(),JSON.stringify(n)),localStorage.setItem(pa(),JSON.stringify(o)),console.log("✅ تم تحديث البيانات المحلية بنجاح بعد الحذف من Firebase");try{let d=localStorage.getItem(dt());if(!d&&(t!=null&&t.uid)){const T=`userCashBalance_${t.uid}`,I=localStorage.getItem(T);if(I){d=I;try{localStorage.setItem(dt(),I),localStorage.removeItem(T)}catch{}}}const f=localStorage.getItem(ct());let v=d?parseFloat(d):0,j=f?JSON.parse(f):{};if(r.type==="send"){const T=r.commission||0;v-=T;const I=r.fromWallet||Object.keys(j)[0];if(I){const w=j[I]||0;j[I]=w+r.amount}}else if(r.type==="withdraw"){const T=r.commission||0;v+=r.amount,v-=T;const I=r.fromWallet||Object.keys(j)[0];if(I){const w=j[I]||0;j[I]=Math.max(0,w-r.amount)}}localStorage.setItem(dt(),v.toString()),localStorage.setItem(ct(),JSON.stringify(j))}catch(d){console.warn("فشل عكس تأثير الأرصدة محليًا بعد الحذف:",d)}try{const d=r.fromWallet;if(d){const{walletDailyLimitsService:f}=await Cs(async()=>{const{walletDailyLimitsService:j}=await import("./walletDailyLimitsService-Dzg49hMn.js");return{walletDailyLimitsService:j}},__vite__mapDeps([2,0,1])),v=await f.getWalletLimits(d);if(v){const j=r.type==="send",T={updatedAt:(await Cs(async()=>{const{serverTimestamp:k}=await import("./index-Bc0KmgLq.js").then(G=>G.a$);return{serverTimestamp:k}},__vite__mapDeps([0,1]))).serverTimestamp()};j?(T.dailyTransferUsed=Math.max(0,(v.dailyTransferUsed||0)-r.amount),T.monthlyTransferUsed=Math.max(0,(v.monthlyTransferUsed||0)-r.amount)):(T.dailyWithdrawUsed=Math.max(0,(v.dailyWithdrawUsed||0)-r.amount),T.monthlyWithdrawUsed=Math.max(0,(v.monthlyWithdrawUsed||0)-r.amount));const{doc:I,setDoc:w}=await Cs(async()=>{const{doc:k,setDoc:G}=await import("./index-Bc0KmgLq.js").then(qe=>qe.a$);return{doc:k,setDoc:G}},__vite__mapDeps([0,1])),{db:O}=await Cs(async()=>{const{db:k}=await import("./index-Bc0KmgLq.js").then(G=>G.b0);return{db:k}},__vite__mapDeps([0,1])),Q=I(O,"walletLimits",d);await w(Q,T,{merge:!0})}}}catch(d){console.warn("فشل استرجاع حدود المحفظة بعد الحذف:",d)}try{const{ProfitService:d}=await Cs(async()=>{const{ProfitService:I}=await import("./profitService-WOL_cZ8K.js");return{ProfitService:I}},__vite__mapDeps([3,4])),{ReportsService:f}=await Cs(async()=>{const{ReportsService:I}=await import("./reportsService-Bp1Io21u.js");return{ReportsService:I}},[]),j={txnType:r.type==="send"?"send":"receive",amount:r.amount,commission:r.commission||0,createdAt:r.createdAt,status:"confirmed"},T=d.calculateProfitFromTransaction(j);T>0&&d.addProfit(-T,t.uid);try{f.removeTransactionEffects(r,t.uid)}catch{}}catch(d){console.warn("فشل تحديث الأرباح/التقارير بعد الحذف:",d)}l({title:"تم حذف المعاملة نهائياً",description:"تم حذف المعاملة نهائياً من النظام. يمكنك العثور عليها في قائمة المحذوفات"})}catch(n){console.error("❌ خطأ في حذف المعاملة من Firebase:",n);let o="فشل في حذف المعاملة من الخادم. يرجى المحاولة مرة أخرى";n instanceof Error&&(n.message.includes("network")||n.message.includes("offline")?o="مشكلة في الاتصال بالإنترنت. تحقق من الاتصال وحاول مرة أخرى":n.message.includes("permission")||n.message.includes("unauthorized")?o="ليس لديك صلاحية لحذف هذه المعاملة":n.message.includes("not-found")&&(o="المعاملة غير موجودة أو تم حذفها مسبقاً")),l({title:"خطأ في الحذف",description:o,variant:"destructive"})}},va=s=>{const r=s.type,n=s.txnType;return r==="withdraw"||r==="withdrawal"||r==="receive"||n==="receive"},ba=s=>{const r=s.type,n=s.txnType;return r==="send"||r==="transfer"||n==="send"},sr=(s,r)=>{const n=new Date().toDateString();let o=bt.filter(I=>new Date(I.createdAt).toDateString()===n&&I.status==="completed");Ds&&Ds.trim()!==""&&(o=o.filter(I=>I.senderPhone&&I.senderPhone.includes(Ds)||I.receiverPhone&&I.receiverPhone.includes(Ds)));const d=qt.filterVisibleTransactions(o,"daily",t==null?void 0:t.uid),f=d.length,v=d.reduce((I,w)=>I+w.amount,0),j=d.filter(va).reduce((I,w)=>{const O=w.withdrawnAmount!==void 0?w.withdrawnAmount:w.amount;return I+O},0),T=d.filter(ba).reduce((I,w)=>{const O=w.sentAmount!==void 0?w.sentAmount:w.amount;return I+O},0);return{totalTransactions:f,totalAmount:v,totalWithdrawn:j,totalSent:T}},ya=s=>{const r=new Date().getMonth(),n=new Date().getFullYear();let o=bt.filter(I=>{const w=new Date(I.createdAt);return w.getMonth()===r&&w.getFullYear()===n&&I.status==="completed"});Ds&&Ds.trim()!==""&&(o=o.filter(I=>I.senderPhone&&I.senderPhone.includes(Ds)||I.receiverPhone&&I.receiverPhone.includes(Ds)));const d=qt.filterVisibleTransactions(o,"monthly",t==null?void 0:t.uid),f=d.length,v=d.reduce((I,w)=>I+w.amount,0),j=d.filter(va).reduce((I,w)=>{const O=w.withdrawnAmount!==void 0?w.withdrawnAmount:w.amount;return I+O},0),T=d.filter(ba).reduce((I,w)=>{const O=w.sentAmount!==void 0?w.sentAmount:w.amount;return I+O},0);return{totalTransactions:f,totalAmount:v,totalWithdrawn:j,totalSent:T}},Nl=s=>{const r=new Date().getMonth(),n=new Date().getFullYear(),o=bt.filter(v=>{const j=new Date(v.createdAt);return j.getMonth()===r&&j.getFullYear()===n&&v.status==="completed"&&v.fromWallet===s}),d=o.filter(va).reduce((v,j)=>{const T=j.withdrawnAmount||j.amount;return v+T},0),f=o.filter(ba).reduce((v,j)=>{const T=j.sentAmount||j.amount;return v+T},0);return{totalWithdrawn:d,totalTransferred:f}},_o=s=>{const r=new Date,n=r.getDate(),o=r.getMonth(),d=r.getFullYear(),f=bt.filter(T=>{const I=new Date(T.createdAt);return I.getDate()===n&&I.getMonth()===o&&I.getFullYear()===d&&T.status==="completed"&&T.fromWallet===s}),v=f.filter(va).reduce((T,I)=>{const w=I.withdrawnAmount||I.amount;return T+w},0),j=f.filter(ba).reduce((T,I)=>{const w=I.sentAmount||I.amount;return T+w},0);return{totalWithdrawn:v,totalTransferred:j}};ya(),a.useEffect(()=>{const s=localStorage.getItem(pa());if(s){const n=JSON.parse(s).map(o=>({...o,createdAt:new Date(o.createdAt)}));ws(n)}},[]),a.useEffect(()=>{bt.length>0&&localStorage.setItem(pa(),JSON.stringify(bt))},[bt]);const wl=async()=>{Bd(),console.log("🔄 بدء عملية التحويل/السحب"),console.log("📊 البيانات المدخلة:",{senderPhone:$e,receiverPhone:He,amount:u,transactionType:X});const s=()=>{X==="transfer"?Gs(!0):oa(!0)},r=()=>{X==="transfer"?Gs(!1):oa(!1)};if(s(),!$e||!u){console.log("❌ خطأ: بيانات ناقصة"),l({title:"خطأ في البيانات",description:"يرجى ملء جميع الحقول المطلوبة",variant:"destructive"}),r();return}if(X==="transfer"&&!He&&!S){console.log("❌ خطأ: رقم المستقبل مفقود"),l({title:"خطأ في البيانات",description:"يرجى إدخال رقم المستقبل",variant:"destructive"}),r();return}if(X==="transfer"&&!S&&!Ld(He)){l({title:"رقم المستقبل غير صالح",description:"اكتب رقم صحيح مكون من 11 رقم ويبدأ بـ 015 أو 010 أو 012 أو 011",variant:"destructive"}),r();return}const n=parseFloat(u);if(console.log("💰 المبلغ المحول:",n),n<=0){console.log("❌ خطأ: مبلغ غير صحيح"),l({title:"خطأ في المبلغ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"}),r();return}if(Ae)try{const de=new Date,Xe=de.getFullYear(),Kt=String(de.getMonth()+1).padStart(2,"0"),jt=String(de.getDate()).padStart(2,"0"),gs=`zeroPlanDailyConfirmCount:${(t==null?void 0:t.uid)||"default"}:${Xe}-${Kt}-${jt}`,Zt=localStorage.getItem(gs);if((Zt&&parseInt(Zt,10)||0)>=10){l({title:"حد التأكيد اليومي",description:"باقة زيرو تسمح بـ 10 تأكيدات تحويل/سحب يومياً فقط.",variant:"destructive"}),r();return}}catch(de){console.warn("فشل قراءة عداد تأكيدات باقة زيرو من التخزين المحلي:",de)}const o=ye.find(de=>de.id===te);if(!o){l({title:"خطأ في المحفظة",description:"يرجى اختيار محفظة صحيحة",variant:"destructive"}),r();return}const d=Nl(te);if(console.log("📈 فحص الحدود الشهرية للمحفظة المختارة"),console.log("📊 الإحصائيات الشهرية للمحفظة:",{walletId:te,walletName:o.name,currentWithdrawn:d.totalWithdrawn,currentTransferred:d.totalTransferred,withdrawalLimit:o.monthlyWithdrawalLimit,transferLimit:o.monthlyTransferLimit}),X==="withdraw"){if(console.log("🏧 فحص حد السحب الشهري للمحفظة"),console.log(`💸 المسحوب حالياً من المحفظة: ${d.totalWithdrawn}, المبلغ الجديد: ${n}, الحد الأقصى: ${o.monthlyWithdrawalLimit}`),d.totalWithdrawn+n>o.monthlyWithdrawalLimit){console.log("❌ تجاوز حد السحب الشهري للمحفظة"),l({title:"تجاوز حد السحب الشهري",description:`لا يمكن سحب أكثر من ${o.monthlyWithdrawalLimit} جنيه شهرياً من محفظة ${o.name}`,variant:"destructive"}),r();return}}else if(console.log("💸 فحص حد التحويل الشهري للمحفظة"),console.log(`📤 المحول حالياً من المحفظة: ${d.totalTransferred}, المبلغ الجديد: ${n}, الحد الأقصى: ${o.monthlyTransferLimit}`),d.totalTransferred+n>o.monthlyTransferLimit){console.log("❌ تجاوز حد التحويل الشهري للمحفظة"),l({title:"تجاوز حد التحويل الشهري",description:`لا يمكن تحويل أكثر من ${o.monthlyTransferLimit} جنيه شهرياً من محفظة ${o.name}`,variant:"destructive"}),r();return}const f=(W==null?void 0:W.shopName)||(t==null?void 0:t.displayName)||"محل كاشي لينك",v={id:Date.now().toString(),type:X==="transfer"?"send":X==="deposit"?"deposit":"withdraw",senderPhone:$e,receiverPhone:X==="transfer"?He:$e,amount:n,status:"completed",createdAt:new Date,withdrawnAmount:X==="withdraw"?n:void 0,sentAmount:X==="transfer"?n:void 0,depositedAmount:void 0,fromWallet:te,senderNumber:$e,senderName:$e,shopName:(o==null?void 0:o.name)||"المحفظة الرئيسية",transferredAmount:X==="transfer"?n:void 0,receiverNumber:X==="transfer"?He:void 0,withdrawnAmountDetailed:X==="withdraw"?n:void 0,depositedAmountDetailed:void 0,merchantShopName:f,transactionReference:`TXN-${Date.now()}`,commission:0,notes:X==="transfer"?`تحويل من ${$e} إلى ${He}`:`سحب نقدي من محفظة ${$e}`};N&&(y!=null&&y.name||y!=null&&y.username)&&(v.cashierName=(y==null?void 0:y.name)||(y==null?void 0:y.username));const j=ta.validateTransaction(n,X,Qe,je);if(!j.isValid){l({title:"خطأ في العملية",description:j.error,variant:"destructive"}),r();return}j.warning&&l({title:"تحذير",description:j.warning,variant:"destructive"});let T;if(X==="transfer")if((o==null?void 0:o.defaultTransferCommission)!=null){const de=Number(o.defaultTransferCommission)||0;T=Math.round(de*n/1e3*100)/100}else Ke&&Ke.trim()!==""?T=Math.max(0,parseFloat(Ke)):T=0;else if((o==null?void 0:o.defaultWithdrawCommission)!=null){const de=Number(o.defaultWithdrawCommission)||0;T=Math.round(de*n/1e3*100)/100}else ke&&ke.trim()!==""?T=Math.max(0,parseFloat(ke)):T=Math.round(n*.01*100)/100;if(v.commission=T,X!=="transfer"&&!se&&T>=n){l({title:"خطأ في العمولة",description:"العمولة أكبر من أو تساوي المبلغ المدخل",variant:"destructive"}),r();return}const I=X==="transfer"||se?n:Math.round((n-T)*100)/100;v.amount=I,v.withdrawnAmount=X==="withdraw"?I:void 0,v.sentAmount=X==="transfer"?I:void 0,v.transferredAmount=X==="transfer"?I:void 0,v.withdrawnAmountDetailed=X==="withdraw"?I:void 0;let w;const O=X==="transfer"&&!!xt,Q=X==="withdraw"&&!!xt,k=O||Q;let G=null;const qe=Gt($e||"").replace(/\D/g,""),Se=Gt(He||"").replace(/\D/g,""),mt=X==="transfer"&&(qe.startsWith("010")&&(Se.startsWith("011")||Se.startsWith("012")||Se.startsWith("015"))||qe.startsWith("012")&&Se.startsWith("010")||qe.startsWith("011")&&Se.startsWith("010")||qe.startsWith("015")&&Se.startsWith("010")),Me=mt?Math.max(0,parseFloat(Ot||"0")):0,nn=Math.round(T*100)/100;if(v.commission=nn,mt&&!k&&Me<=0){l({title:"خطأ",description:"أدخل رسوم التحويل لعمليات 010 → 011/012/015 أو 012 → 010 أو 011 → 010 أو 015 → 010",variant:"destructive"}),r();return}if(X==="transfer"&&!k){const de=Number(je[te]||0),Xe=Number(I)+Number(Me);if(de<Xe){l({title:"رصيد المحفظة غير كافٍ",description:`الرصيد الحالي ${de} لا يكفي لخصم ${Xe}`,variant:"destructive"}),r();return}}if(k)if(O){const de=ta.validateTransaction(I,"transfer",Qe,je);de.isValid?w={success:!0,newCashBalance:Qe,newWalletBalances:je}:w={success:!1,newCashBalance:Qe,newWalletBalances:je,message:de.error||"رصيد غير كافٍ للتحويل المؤجل",error:"INSUFFICIENT_WALLET_BALANCE"}}else w={success:!0,newCashBalance:Qe,newWalletBalances:je};else X==="transfer"?w=await ta.processTransfer({amount:I,currentCashBalance:Qe,currentWalletBalances:je,wallets:ye,selectedWalletId:te,skipRemoteLimitsCheck:!0,nonBlockingUsageUpdate:!0}):w=await ta.processWithdraw({amount:I,currentCashBalance:Qe,currentWalletBalances:je,wallets:ye,selectedWalletId:te,skipRemoteLimitsCheck:!0,nonBlockingUsageUpdate:!0});if(!w.success){l({title:"فشل في العملية",description:w.error||w.message,variant:"destructive"}),r();return}let Xs=k?Qe:w.newCashBalance,ps=k?je:w.newWalletBalances;if(!k&&X==="transfer"&&Me>0){const de=Number(ps[te]||0);ps={...ps,[te]:Math.round((de-Number(Me))*100)/100}}if(k&&Q){const de=ye.find(jt=>jt.id===te)??ye.find(jt=>jt.isDefault)??ye[0],Xe=(de==null?void 0:de.id)||te;if(Xe!==te)try{fa(Xe)}catch{}const Kt=Number(je[Xe]||0);ps={...je,[Xe]:Math.round((Kt+Number(I))*100)/100};try{const jt=`walletEffectsAppliedOnCreation_${(t==null?void 0:t.uid)||"default"}`,gs=localStorage.getItem(jt),Zt=gs?JSON.parse(gs):[];v!=null&&v.id&&!Zt.includes(v.id)&&(Zt.push(v.id),localStorage.setItem(jt,JSON.stringify(Zt)))}catch{}}if(k&&O){const de=ye.find(jt=>jt.id===te)??ye.find(jt=>jt.isDefault)??ye[0],Xe=(de==null?void 0:de.id)||te;if(Xe!==te)try{fa(Xe)}catch{}const Kt=Number(je[Xe]||0);ps={...je,[Xe]:Math.round((Kt-Number(I)-Number(Me))*100)/100}}if((O||Q)&&xt&&!Ns){const de={id:`DEBT-${Date.now()}`,debtorName:xt.debtorName,amount:xt.amount,reason:xt.notes||"",customerId:xt.customerId,mobile:xt.mobile,status:"pending",createdAt:new Date};G=de.id;const Xe=[de,...Wt];Qt(Xe);try{await xs(Xe)}catch(Kt){console.error("⚠️ فشل حفظ الدين المؤجل محلياً:",Kt)}l({title:"تم إضافة الدين",description:"أضيف إلى إيصالات الديون حتى يتم السداد",variant:"default"})}if(!k){const de=Math.max(0,Number(T))+Math.max(0,Number(Me));de>0&&(Xs=Math.round((Xs+de)*100)/100,console.log(`💰 تم إضافة عمولة/رسوم ${de} جنيه لدرج النقدية`))}if(console.log("⚡ تحديث الواجهة فوراً..."),pt(Xs),Ze(ps),k&&(v.status="pending"),ws(de=>[v,...de]),Ae)try{const de=new Date,Xe=de.getFullYear(),Kt=String(de.getMonth()+1).padStart(2,"0"),jt=String(de.getDate()).padStart(2,"0"),gs=`zeroPlanDailyConfirmCount:${(t==null?void 0:t.uid)||"default"}:${Xe}-${Kt}-${jt}`,Zt=localStorage.getItem(gs),ar=Zt&&parseInt(Zt,10)||0;localStorage.setItem(gs,String(ar+1))}catch{}if(localStorage.setItem(dt(),Xs.toString()),localStorage.setItem(ct(),JSON.stringify(ps)),(async()=>{try{console.log("🔄 بدء حفظ المعاملة في Firebase في الخلفية...");const de={shopId:(W==null?void 0:W.shopId)||(t==null?void 0:t.uid)||"default-shop",lineId:te||"default-line",merchantUserId:(t==null?void 0:t.uid)||null,provider:"vodafone_cash",txnType:X==="transfer"?"send":"receive",amount:I,commission:nn,fee:Me,profit:0,senderMsisdn:$e,receiverMsisdn:X==="transfer"?He:$e,note:X==="transfer"?`تحويل من ${$e} إلى ${He}`:`سحب ${I} جنيه من ${(o==null?void 0:o.name)||"المحفظة الرئيسية"}`,status:k?"pending":"confirmed",linkedDebtId:G||void 0,createdBy:(t==null?void 0:t.uid)||null,walletEffectAppliedOnCreation:!!(k&&Q)},Xe={...de,status:k?"pending":"completed",commissionMode:X==="transfer"||se?"add":"deduct",totalCharged:X==="transfer"?I+nn+Me:se?I+T:I,walletEffectAppliedOnCreation:!!(k&&Q),createdAt:new Date},{ProfitService:Kt}=await Cs(async()=>{const{ProfitService:ar}=await import("./profitService-WOL_cZ8K.js");return{ProfitService:ar}},__vite__mapDeps([3,4])),jt=Kt.calculateProfitFromTransaction(Xe);jt>0&&(Kt.addProfit(jt,t==null?void 0:t.uid),console.log("✅ تم إضافة الربح:",jt,"جنيه")),await Promise.all([...t!=null&&t.uid?[De.updateUserData(t.uid,{cashBalance:Xs,walletBalances:ps,lastUpdated:new Date().toISOString()})]:[],ur.create(de),...t!=null&&t.uid?[De.saveUserTransaction(t.uid,{...Xe,transactionType:X,fromWallet:te,toWallet:X==="transfer"?O?null:"cash":null,cashierName:N&&((y==null?void 0:y.name)||(y==null?void 0:y.username))||"الحساب الرئيسي",linkedDebtId:G||void 0,description:`${X==="transfer"?"تحويل":"سحب"} ${I} من ${te} ${X==="transfer"?O?"":"إلى الدرج النقدي":""} — عمولة: ${T} (${X==="transfer"||se?"مضافة":"مخصومة"})${Me>0?` — رسوم: ${Me}`:""}${k?" — دين مؤجل (قيد المراجعة)":""}`})]:[]]),console.log("✅ تم حفظ جميع البيانات في Firebase بنجاح");const gs=`userData_${t==null?void 0:t.uid}`,Zt={cashBalance:Xs,walletBalances:ps,lastUpdated:new Date().toISOString()};localStorage.setItem(gs,JSON.stringify(Zt))}catch(de){console.error("❌ خطأ في حفظ المعاملة في Firebase (في الخلفية):",de),l({title:"تحذير",description:"تم تنفيذ العملية محلياً، لكن فشلت المزامنة مع الخادم. ستتم المحاولة مرة أخرى تلقائياً.",variant:"destructive"})}})(),X==="transfer"){Gs(!0);const de=Number(n)+Number(T)+Math.max(0,Number(Me));jr({type:"transfer",amount:Math.max(0,Math.round(de*100)/100)}),zi({receiver:He,amount:n}),Oa(!0),setTimeout(()=>{Gs(!1)},2e3)}else{oa(!0);const de=se?Number(n):Math.max(0,Math.round((Number(n)-Number(T))*100)/100);jr({type:"withdraw",amount:Math.max(0,Math.round(de*100)/100)}),Oa(!0),setTimeout(()=>{oa(!1)},2e3)}zt(""),E(""),Pt(null),Fe(""),we(""),it(""),Vs(!1)},rn=et.useMemo(()=>new Intl.DateTimeFormat("ar-EG"),[]),zo=et.useMemo(()=>new Intl.DateTimeFormat("ar-EG",{hour:"2-digit",minute:"2-digit"}),[]),Jo=et.useMemo(()=>{try{return Wt.reduce((s,r)=>{const n=Number(r.paidAmount||0),o=Math.max(0,Number(r.amount||0)-n);return s+o},0)}catch{return 0}},[Wt]),Sl=et.useMemo(()=>bl().filter(r=>ms==="all"?!0:ms==="send"?r.type==="send":ms==="receive"?r.type==="receive":ms==="withdraw"?r.type==="withdraw":ms!=="deleted"),[bl,ms]),Ko=()=>{if(vr==="daily"){const s=qt.resetReportsManually("daily",bt,t==null?void 0:t.uid);ia(!1),l({title:"تم تصفير المعاملات اليومية",description:`تم إخفاء ${s.length} معاملة من تقارير اليوم (الحدود لم تتأثر)`})}else{const s=qt.resetReportsManually("monthly",bt,t==null?void 0:t.uid);ia(!1),l({title:"تم تصفير المعاملات الشهرية",description:`تم إخفاء ${s.length} معاملة من تقارير الشهر (الحدود لم تتأثر)`})}},qo=()=>vr==="daily"?"تصفير المعاملات اليومية":"تصفير المعاملات الشهرية",Vo=()=>vr==="daily"?"أدخل الرقم السري الرئيسي لتصفير جميع معاملات اليوم":"أدخل الرقم السري الرئيسي لتصفير جميع معاملات الشهر",Yo=s=>{cl(s),Rr(!0)},Ho=s=>{pt(s),localStorage.setItem(dt(),s.toString()),Gn(!1),l({title:"تم تحديث الرصيد النقدي",description:`تم تحديث الرصيد النقدي إلى ${s} جنيه`})},Go=async s=>{var v;if(!Mt){console.warn("لا يوجد معرف محفظة محدد لتعديل الرصيد");return}const r={...je,[Mt]:s};Ze(r);const n=new Date().toISOString(),o={walletBalances:r,lastUpdated:n},d=`userData_${t==null?void 0:t.uid}`;try{localStorage.setItem(d,JSON.stringify(o)),localStorage.setItem(ct(),JSON.stringify(r)),localStorage.setItem(`walletBalances_backup_${n}`,JSON.stringify(r))}catch{}try{t!=null&&t.uid&&await De.updateUserData(t.uid,o)}catch(j){console.error("خطأ أثناء حفظ رصيد المحفظة في Firebase:",j)}Qn(!1);const f=((v=ye.find(j=>j.id===Mt))==null?void 0:v.name)||"المحفظة";l({title:"تم تحديث رصيد المحفظة",description:`تم تحديث رصيد ${f} إلى ${s.toLocaleString()} جنيه`})},Qo=async s=>{var r;if(console.log("💰 بدء تحديث رصيد المحفظة"),console.log("📊 معرف المحفظة المحررة:",Mt),console.log("💵 المبلغ المضاف/المخصوم:",s),Mt){const n=je[Mt]||0;console.log("💰 الرصيد الحالي:",n);const o=n+s;console.log("💰 الرصيد الجديد:",o);const d={...je,[Mt]:o};console.log("📊 الأرصدة المحدثة:",d),Ze(d);const f=new Date().toISOString(),v={walletBalances:d,lastUpdated:f},j=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(j,JSON.stringify(v)),localStorage.setItem(ct(),JSON.stringify(d)),localStorage.setItem(`walletBalances_backup_${f}`,JSON.stringify(d));try{if(t!=null&&t.uid){console.log("🔄 حفظ البيانات في Firebase...");try{await De.updateUserData(t.uid,v),console.log("✅ تم حفظ الأرصدة في Firebase بنجاح"),setTimeout(()=>{localStorage.removeItem(j),console.log("🧹 تم حذف النسخة المحلية المؤقتة بعد دقيقة واحدة")},6e4)}catch(O){console.error("❌ فشل في حفظ البيانات في Firebase:",O),be(!0)}}else console.log("⚠️ المستخدم غير مسجل دخول، حفظ في localStorage"),localStorage.setItem(ct(),JSON.stringify(d));const T=((r=ye.find(O=>O.id===Mt))==null?void 0:r.name)||"المحفظة",I=s>0?"إضافة":"خصم",w=Math.abs(s);l({title:`تم ${I} مبلغ ${I==="إضافة"?"إلى":"من"} رصيد المحفظة`,description:`تم ${I} ${w} جنيه ${I==="إضافة"?"إلى":"من"} رصيد ${T}. الرصيد الجديد: ${o.toLocaleString()} جنيه`})}catch(T){if(console.error("❌ فشل في حفظ البيانات في Firebase:",T),localStorage.setItem(ct(),JSON.stringify(d)),t!=null&&t.uid){const I=`userData_${t.uid}`,w={walletBalances:d,lastUpdated:new Date().toISOString()};localStorage.setItem(I,JSON.stringify(w)),be(!0)}l({title:"تم حفظ البيانات محلياً",description:"تم حفظ التغييرات محلياً وسيتم مزامنتها مع الخادم لاحقاً",variant:"default"})}}else console.log("❌ لا يوجد معرف محفظة للتحرير");setTimeout(()=>{const o=Object.keys(localStorage).filter(d=>d.startsWith("walletBalances_backup_")).sort();o.length>5&&o.slice(0,o.length-5).forEach(f=>{localStorage.removeItem(f),console.log("🗑️ حذف النسخة الاحتياطية القديمة:",f)})},5e3),Rr(!1),cl("")};return console.log("🔥 UserDashboardPage - Render conditions:",{isCheckingActivation:C,isUserActive:H,showActivationModal:Ft}),!C&&!H?(console.log("🔥 UserDashboardPage - Showing activation modal"),e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center",children:e.jsx(Fl,{isOpen:!0,onClose:()=>{}})})):C?(console.log("🔥 UserDashboardPage - Showing loading screen"),e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center",children:e.jsx("div",{className:"text-center",children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"w-3 h-3 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 animate-bounce",style:{animationDelay:"0ms"}}),e.jsx("span",{className:"w-3 h-3 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 animate-bounce",style:{animationDelay:"150ms"}}),e.jsx("span",{className:"w-3 h-3 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 animate-bounce",style:{animationDelay:"300ms"}})]})})})):(console.log("🔥 UserDashboardPage - Rendering main dashboard"),e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-gray-50 via-blue-50/30 to-indigo-50/20 px-2 sm:px-4 py-2 sm:py-4 relative overflow-hidden",children:[e.jsxs("div",{className:"absolute inset-0 overflow-hidden pointer-events-none",children:[e.jsx("div",{className:"absolute top-10 sm:top-20 left-2 sm:left-10 w-32 sm:w-72 h-32 sm:h-72 bg-blue-400/8 rounded-full blur-3xl"}),e.jsx("div",{className:"absolute bottom-10 sm:bottom-20 right-2 sm:right-10 w-40 sm:w-96 h-40 sm:h-96 bg-purple-400/8 rounded-full blur-3xl",style:{animationDelay:"2s"}}),e.jsx("div",{className:"absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-36 sm:w-80 h-36 sm:h-80 bg-indigo-400/5 rounded-full blur-3xl",style:{animationDelay:"4s"}})]}),e.jsxs("div",{className:"max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-3 sm:gap-6 relative z-10",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-2 sm:space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 sm:grid-cols-2 sm:gap-3 fade-in-up",children:[!da&&e.jsxs(tt,{className:"bg-gradient-to-br from-purple-50 via-purple-25 to-white border border-purple-200/60 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 group relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-purple-500/5 to-purple-600/3 opacity-0 group-hover:opacity-100 transition-opacity duration-300"}),e.jsx("div",{className:"absolute top-0 right-0 w-20 sm:w-32 h-20 sm:h-32 bg-gradient-to-br from-purple-300/15 to-transparent rounded-full -translate-y-8 sm:-translate-y-16 translate-x-8 sm:translate-x-16 group-hover:scale-110 transition-transform duration-300"}),e.jsx(Dt,{className:"pb-2 sm:pb-1 lg:pb-1 px-3 sm:px-3 lg:px-2 pt-3 sm:pt-2 lg:pt-1 relative z-10",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Lt,{className:"text-xs font-bold text-purple-800 flex items-center gap-1.5 sm:gap-1",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"w-2.5 sm:w-2 h-2.5 sm:h-2 bg-gradient-to-r from-purple-500 to-purple-600 rounded-full shadow-sm"}),e.jsx("div",{className:"absolute inset-0 w-2.5 sm:w-2 h-2.5 sm:h-2 bg-purple-400 rounded-full opacity-60 animate-pulse"})]}),e.jsx("span",{className:"text-xs",children:"الشهر"})]}),e.jsxs("div",{className:"flex items-center gap-1 sm:gap-1",children:[e.jsx("div",{className:"hidden"}),e.jsx(c,{size:"sm",variant:"ghost",onClick:()=>{Tn("monthly"),ia(!0)},className:"h-7 w-7 sm:h-6 sm:w-6 p-0 bg-gradient-to-r from-purple-100 to-purple-200 text-purple-700 hover:from-purple-200 hover:to-purple-300 hover:text-purple-800 rounded-lg sm:rounded-md transition-all duration-300 hover:scale-105 shadow-sm hover:shadow-md",title:"تصفير معاملات الشهر",children:e.jsx(_t,{className:"h-3 w-3 sm:h-2.5 sm:w-2.5"})}),e.jsx("div",{className:"p-1.5 sm:p-1 bg-gradient-to-r from-purple-100 to-purple-200 rounded-lg sm:rounded-md",children:e.jsx(ja,{className:"h-3 w-3 sm:h-2.5 sm:w-2.5 text-purple-600"})})]})]})}),!da&&e.jsxs(rt,{className:"space-y-0.5 sm:space-y-1 lg:space-y-0 pt-0 px-2 sm:px-3 lg:px-2 pb-1.5 sm:pb-2 lg:pb-1 relative z-10",children:[e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-purple-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-purple-700",children:"عدد المعاملات:"}),e.jsx("span",{className:"font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:ya().totalTransactions})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-purple-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-purple-700",children:"إجمالي المبالغ:"}),e.jsx("span",{className:"font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:ya().totalAmount.toFixed(2)})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-purple-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-purple-700",children:"المسحوب:"}),e.jsx("span",{className:"font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:ya().totalWithdrawn.toFixed(2)})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-purple-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-purple-700",children:"المرسل:"}),e.jsx("span",{className:"font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:ya().totalSent.toFixed(2)})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-purple-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-purple-700",children:"الأرباح:"}),e.jsx(Id,{userId:t==null?void 0:t.uid,transactions:bt})]})]}),Yi&&e.jsx("div",{className:"absolute inset-0 z-20 bg-yellow-100/60 backdrop-blur-sm rounded-xl border border-yellow-300/70 flex items-center justify-center p-0 pointer-events-auto",children:e.jsxs(c,{size:"sm",variant:"ghost",onClick:async()=>{if(Ae){l({title:"غير متاح",description:"تقارير الشهر غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"});return}Ma(!0)},className:"px-2.5 py-1 rounded-full bg-gradient-to-r from-yellow-300 to-yellow-400 text-black hover:from-yellow-400 hover:to-yellow-500 shadow-md flex items-center gap-1 text-[11px] font-semibold",title:"عرض تقارير الشهر (يتطلب الرقم السري)",children:[e.jsx("span",{children:"عرض تقارير الشهر"}),e.jsx(Ue,{className:"h-2.5 w-2.5"})]})})]}),e.jsx(Xt,{open:Gi,onOpenChange:Ma,mode:"verify",title:"الرقم السري لفتح تقارير الشهر",description:"لا يمكن الاطلاع على إحصائيات الشهر إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{if(Ae){l({title:"غير متاح",description:"تقارير الشهر غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}),Ma(!1),Ln(!0);return}Ln(!1),Ma(!1)},userId:t==null?void 0:t.uid}),e.jsxs(tt,{className:"bg-gradient-to-br from-blue-50 via-blue-25 to-white border border-blue-200/60 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 group relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/5 to-blue-600/3 opacity-0 group-hover:opacity-100 transition-opacity duration-300"}),e.jsx("div",{className:"absolute top-0 right-0 w-20 sm:w-32 h-20 sm:h-32 bg-gradient-to-br from-blue-300/15 to-transparent rounded-full -translate-y-8 sm:-translate-y-16 translate-x-8 sm:translate-x-16 group-hover:scale-110 transition-transform duration-300"}),e.jsx(Dt,{className:"pb-2 sm:pb-3 lg:pb-1 px-3 sm:px-4 lg:px-2 pt-3 sm:pt-4 lg:pt-1 relative z-10",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Lt,{className:"text-sm sm:text-base font-bold text-blue-800 flex items-center gap-1.5 sm:gap-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"w-2.5 sm:w-3 h-2.5 sm:h-3 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full shadow-sm"}),e.jsx("div",{className:"absolute inset-0 w-2.5 sm:w-3 h-2.5 sm:h-3 bg-blue-400 rounded-full opacity-60 animate-pulse"})]}),e.jsx("span",{className:"text-xs sm:text-sm",children:"اليوم"})]}),e.jsxs("div",{className:"flex items-center gap-1 sm:gap-1.5",children:[e.jsx(c,{size:"sm",variant:"ghost",onClick:()=>{Tn("daily"),ia(!0)},className:"h-7 w-7 sm:h-8 sm:w-8 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded-lg transition-all duration-300 hover:scale-105 shadow-sm hover:shadow-md",title:"تصفير معاملات اليوم",children:e.jsx(_t,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"})}),e.jsx(c,{size:"sm",variant:"ghost",onClick:()=>br(!0),className:"h-7 w-7 sm:h-8 sm:w-8 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded-lg transition-all duration-300 hover:scale-105 shadow-sm hover:shadow-md",title:"أرشيف التقارير اليومية",children:e.jsx(Jc,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"})}),e.jsx(c,{size:"sm",variant:"ghost",onClick:()=>Hi(s=>!s),className:"h-7 w-7 sm:h-8 sm:w-8 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded-lg transition-all duration-300 hover:scale-105 shadow-sm hover:shadow-md",title:da?"توسيع اليوم والشهر":"طي اليوم والشهر",children:da?e.jsx(jn,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"}):e.jsx(Kl,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"})}),e.jsx("div",{className:"p-1.5 sm:p-2 bg-gradient-to-r from-blue-100 to-blue-200 rounded-lg",children:e.jsx(ja,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5 text-blue-600"})})]})]})}),!da&&e.jsxs(rt,{className:"space-y-0 pt-0 px-2 pb-1 relative z-10",children:[e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-blue-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-blue-700",children:"عدد المعاملات:"}),e.jsx("span",{className:"font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:sr().totalTransactions})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-blue-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-blue-700",children:"إجمالي المبالغ:"}),e.jsx("span",{className:"font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:sr().totalAmount.toFixed(2)})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-blue-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-blue-700",children:"المسحوب:"}),e.jsx("span",{className:"font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:sr().totalWithdrawn.toFixed(2)})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-blue-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-blue-700",children:"المرسل:"}),e.jsx("span",{className:"font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:sr().totalSent.toFixed(2)})]}),e.jsxs("div",{className:"flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-white/70 to-blue-50/70 rounded-sm sm:rounded-lg hover:from-white/90 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"text-xs font-semibold text-blue-700",children:"الأرباح:"}),e.jsx(Ad,{userId:t==null?void 0:t.uid})]})]}),Qi&&e.jsx("div",{className:"absolute inset-0 z-20 bg-yellow-100/60 backdrop-blur-sm rounded-xl border border-yellow-300/70 flex items-center justify-center p-0 pointer-events-auto",children:e.jsxs(c,{size:"sm",variant:"ghost",onClick:()=>wr(!0),className:"px-2.5 py-1 rounded-full bg-gradient-to-r from-yellow-300 to-yellow-400 text-black hover:from-yellow-400 hover:to-yellow-500 shadow-md flex items-center gap-1 text-[11px] font-semibold",title:"عرض تقارير اليوم (يتطلب الرقم السري)",children:[e.jsx("span",{children:"عرض تقارير اليوم"}),e.jsx(Ue,{className:"h-2.5 w-2.5"})]})})]}),e.jsx(Xt,{open:Zi,onOpenChange:wr,mode:"verify",title:"الرقم السري لفتح تقارير اليوم",description:"لا يمكن الاطلاع على تقارير اليوم إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{$n(!1),wr(!1)},userId:t==null?void 0:t.uid})]}),e.jsxs(tt,{className:"bg-white border-2 border-gray-200/50 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 group relative overflow-hidden   transform fade-in-up mb-6",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-emerald-500/5 via-blue-500/5 to-emerald-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-200"}),e.jsx("div",{className:"absolute top-0 left-0 w-40 h-40 bg-gradient-to-br from-emerald-300/10 to-transparent rounded-full -translate-y-20 -translate-x-20 group-hover:scale-150 transition-transform duration-200"}),e.jsx("div",{className:"absolute bottom-0 right-0 w-40 h-40 bg-gradient-to-br from-blue-300/10 to-transparent rounded-full translate-y-20 translate-x-20 group-hover:scale-150 transition-transform duration-200"}),e.jsx(rt,{className:"p-3 relative z-10",children:e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"bg-emerald-50 border-2 border-emerald-200/50 p-1 rounded-xl shadow-lg hover:shadow-md transition-all duration-200 group/cash relative overflow-hidden ",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-emerald-500/10 to-transparent opacity-0 group-hover/cash:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex items-center justify-between relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-emerald-100 to-emerald-200 rounded-lg shadow-sm",children:e.jsx(nt,{className:"h-1.5 w-1.5 text-emerald-600"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] font-bold text-emerald-800",children:"الفلوس النقدية"}),e.jsxs("span",{className:"text-[10px] font-extrabold text-emerald-700 bg-gradient-to-r from-emerald-100 to-emerald-200 px-1 py-0.5 rounded-lg shadow-sm",children:[Qe.toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(c,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-green-100 to-green-200 text-green-700 hover:from-green-200 hover:to-green-300 hover:text-green-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>Ya(!0),children:e.jsx(kt,{className:"h-2 w-2"})}),e.jsx(c,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800 rounded-xl transition-all duration-300  hover:rotate-12 shadow-md hover:shadow-lg",onClick:()=>Xa(!0),children:e.jsx(_t,{className:"h-2 w-2"})})]})]})]}),e.jsxs("div",{className:"bg-blue-50 border-2 border-blue-200/50 p-1 rounded-xl shadow-lg hover:shadow-md transition-all duration-200 group/wallet relative overflow-hidden ",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/10 to-transparent opacity-0 group-hover/wallet:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex items-center justify-between relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-blue-100 to-blue-200 rounded-lg shadow-sm",children:e.jsx(is,{className:"h-1.5 w-1.5 text-blue-600"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] font-bold text-blue-800",children:"الأرصدة علي المحافظ"}),e.jsxs("span",{className:"text-[10px] font-extrabold text-blue-700 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-lg shadow-sm",children:[Object.values(je).reduce((s,r)=>s+r,0).toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(c,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-green-100 to-green-200 text-green-700 hover:from-green-200 hover:to-green-300 hover:text-green-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>Ga(!0),title:"إضافة أموال لإجمالي المحفظة",children:e.jsx(kt,{className:"h-2 w-2"})}),e.jsx(c,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800 rounded-xl transition-all duration-300  hover:rotate-12 shadow-md hover:shadow-lg",onClick:()=>{Qa(!0),Za("")},title:"تصفير إجمالي المحفظة",children:e.jsx(_t,{className:"h-2 w-2"})})]})]})]}),e.jsxs("div",{className:"col-span-2 sm:col-span-1 bg-indigo-50 border-2 border-indigo-200/50 p-1 rounded-xl shadow-lg hover:shadow-md transition-all duration-200 group/selwallet relative overflow-hidden ",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-indigo-500/10 to-transparent opacity-0 group-hover/selwallet:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex items-center justify-between relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-indigo-100 to-indigo-200 rounded-lg shadow-sm",children:e.jsx(is,{className:"h-1.5 w-1.5 text-indigo-600"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] font-bold text-indigo-800",children:"رصيد المحفظه"}),e.jsxs("span",{className:"text-[10px] font-extrabold text-indigo-700 bg-gradient-to-r from-indigo-100 to-indigo-200 px-1 py-0.5 rounded-lg shadow-sm",children:[(te&&je[te]||0).toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(c,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-green-100 to-green-200 text-green-700 hover:from-green-200 hover:to-green-300 hover:text-green-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>{if(!te){l({title:"اختر محفظة",description:"يرجى اختيار محفظة من اختيار المحافظ بالأعلى أولاً",variant:"destructive"});return}Yo(te)},title:"إضافة/خصم إلى رصيد المحفظة المختارة",children:e.jsx(kt,{className:"h-2 w-2"})}),e.jsx(c,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800 rounded-xl transition-all duration-300  hover:rotate-12 shadow-md hover:shadow-lg",onClick:()=>{if(!te){l({title:"اختر محفظة",description:"يرجى اختيار محفظة لتصفير رصيدها فقط",variant:"destructive"});return}Ua(!0)},title:"تصفير رصيد المحفظة المختارة",children:e.jsx(_t,{className:"h-2 w-2"})})]})]})]})]})})]}),e.jsxs(tt,{className:"bg-gradient-to-br from-gray-50 via-white to-slate-50 border border-gray-200/60 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 group relative overflow-hidden fade-in-up",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-gray-500/5 to-slate-600/3 opacity-0 group-hover:opacity-100 transition-opacity duration-300"}),e.jsxs(Dt,{className:"pb-2 px-4 pt-4 relative z-10",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Lt,{className:"text-sm font-bold flex items-center gap-2 text-gray-800",children:[!z&&e.jsx("div",{className:"p-1.5 sm:p-2 bg-gradient-to-r from-gray-100 to-slate-200 rounded-lg",children:e.jsx(ja,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5 text-gray-600"})}),e.jsx("span",{className:"bg-gradient-to-r from-gray-600 to-slate-600 bg-clip-text text-transparent",children:"المعاملات الأخيرة"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[!z&&e.jsxs("div",{className:"flex items-center gap-0.5 bg-gray-50 rounded px-1 py-0.5 border border-gray-200 hover:border-blue-300 transition-all duration-200 group relative overflow-hidden max-w-[140px] md:max-w-[220px]",children:[e.jsx(Sc,{className:"h-2 w-2 text-gray-400 group-hover:text-blue-600 transition-colors"}),e.jsx(R,{placeholder:"بحث...",value:Pn,onChange:s=>Ui(s.target.value),className:"h-3 text-[8px] border-0 bg-transparent focus:ring-0 focus:outline-none text-gray-700 placeholder:text-gray-400"})]}),!z&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-green-600 mb-1",children:"شحن"}),e.jsx(c,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-green-50 text-green-600 hover:bg-green-100 border border-green-200 ring-3 ring-green-300 transition-all duration-200 hover:scale-105",onClick:()=>{l({title:"قيد التطوير",description:"هذه الميزة غير متاحة حالياً."})},title:"شحن الرصيد",children:e.jsx(Ca,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"حاسبة"}),e.jsx(c,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105",onClick:()=>Nr(!0),title:"آلة حاسبة",children:e.jsx(Ql,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"كروت"}),e.jsx(c,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105",onClick:()=>{Ae?l({title:"غير متاح",description:"كروت الائتمان غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Wa(!0)},title:"كروت الائتمان",children:e.jsx(Ca,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-blue-600 mb-1",children:"الوردية"}),e.jsx(c,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-blue-50 text-blue-600 hover:bg-blue-100 border border-blue-200 ring-3 ring-blue-300 transition-all duration-200 hover:scale-105",onClick:Co,title:N&&(y!=null&&y.name||y!=null&&y.username)?`بروفيل الوردية: ${(y==null?void 0:y.name)||(y==null?void 0:y.username)}`:"وردية الكاشير",children:e.jsx(fn,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"المبيعات"}),e.jsx(c,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105",onClick:()=>{Ae?l({title:"غير متاح",description:"بيانات المبيعات غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):la(!0)},title:"بيانات المبيعات",children:e.jsx(kc,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsxs("div",{className:"flex items-center gap-1 mb-1",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600",children:"الديون"}),Wt.filter(s=>s.status==="pending").length>0&&e.jsx("span",{className:"h-4 w-4 rounded-full bg-red-600 text-white text-[10px] flex items-center justify-center ring-2 ring-white",children:Wt.filter(s=>s.status==="pending").length})]}),e.jsx(c,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105",onClick:()=>{Ae?l({title:"غير متاح",description:"إدارة الديون/الأجل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):ma(!0)},title:"الديون",children:e.jsx(hc,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-amber-700 mb-1",children:"الصيانة"}),e.jsx(c,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-amber-50 text-amber-700 hover:bg-amber-100 border border-amber-200 ring-3 ring-amber-300 transition-all duration-200 hover:scale-105",onClick:()=>{Ae?l({title:"غير متاح",description:"الصيانة غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Fa(!0)},title:"الصيانة",children:e.jsx(uc,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-yellow-500 mb-1",children:"المكنة"}),e.jsx(c,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-violet-50 text-violet-700 hover:bg-violet-100 border border-violet-200 ring-3 ring-violet-300 transition-all duration-200 hover:scale-105",onClick:()=>{as?Ea(!0):l({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"})},title:"يومية المكنة",children:e.jsx(ei,{className:"h-5 w-5 text-yellow-500"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-orange-600 mb-1",children:"مصروفات"}),e.jsx(c,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-orange-50 text-orange-600 hover:bg-orange-100 border border-orange-200 ring-3 ring-orange-300 transition-all duration-200 hover:scale-105",onClick:()=>{Ae?l({title:"غير متاح",description:"مصروفات المحل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Yt.hasMasterPin()?J(!0):ee(!0)},title:"مصروفات المحل",children:e.jsx(cr,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-rose-600 mb-1",children:"النواقص"}),e.jsx(c,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-rose-50 text-rose-600 hover:bg-rose-100 border border-rose-200 ring-3 ring-rose-300 transition-all duration-200 hover:scale-105",onClick:()=>{Ae?l({title:"غير متاح",description:"النواقص غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Rt(!0)},title:"النواقص",children:e.jsx(xc,{className:"h-5 w-5"})})]})]})]})]}),!z&&e.jsx("div",{className:"mt-2 w-full",children:e.jsxs("div",{className:"flex items-center justify-center gap-3 bg-gray-50 rounded-md p-3 border border-gray-200",children:[e.jsx(c,{variant:"ghost",size:"sm",className:`h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${ms==="send"?"bg-green-600 text-white border-green-600":"text-green-700 border-green-300 hover:bg-green-50"}`,onClick:()=>gr("send"),title:"تصفية التحويل",children:"التحويل"}),e.jsx(c,{variant:"ghost",size:"sm",className:`h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${ms==="withdraw"?"bg-red-600 text-white border-red-600":"text-red-700 border-red-300 hover:bg-red-50"}`,onClick:()=>gr("withdraw"),title:"تصفية السحب",children:"السحب"}),e.jsx(c,{variant:"ghost",size:"sm",className:`h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${ms==="all"?"bg-green-600 text-white border-green-600":"text-green-700 border-green-300 hover:bg-green-50"}`,onClick:()=>gr("all"),title:"عرض الكل",children:"الكل"}),e.jsxs("div",{className:"relative ml-1",children:[e.jsxs(c,{variant:"ghost",size:"sm",className:"h-8 px-3 text-[12px] rounded-full border bg-red-50 text-red-700 border-red-300 hover:bg-red-100",onClick:()=>_r(!0),title:"تصفير المعاملات الأخيرة",children:[e.jsx(_t,{className:"h-3.5 w-3.5 mr-1"}),"تصفير"]}),(t==null?void 0:t.uid)&&localStorage.getItem(`recentTransactionsResetAt:${t.uid}`)&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 h-2 w-2 rounded-full bg-red-500 ring-2 ring-white"})]})]})})]}),e.jsx(rt,{className:"space-y-2 pt-0 px-4 pb-4 relative z-10",children:Sl.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(ja,{className:"h-12 w-12 mx-auto mb-2 text-gray-300"}),e.jsx("p",{className:"text-sm",children:"لا توجد معاملات حتى الآن"})]}):e.jsx("div",{className:"max-h-[210px] overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400 transition-colors",children:e.jsx("div",{className:"space-y-2 pr-2",children:Sl.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gradient-to-r from-white/70 to-gray-50/70 rounded-lg hover:from-white/90 hover:to-gray-50/90 transition-all duration-300 border border-gray-100/60 cursor-pointer hover:shadow-sm",onClick:()=>Ro(s),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[s.status==="completed"&&e.jsx(_s,{className:"h-4 w-4 text-green-500"}),s.status==="pending"&&e.jsx(zs,{className:"h-4 w-4 text-yellow-500"}),s.status==="failed"&&e.jsx(Nn,{className:"h-4 w-4 text-red-500"})]}),e.jsxs("div",{children:[(()=>{const r=(s==null?void 0:s.type)==="report"||((s==null?void 0:s.title)||"").includes("إيصال تسليم وردية");return e.jsx("p",{className:"font-medium text-sm text-gray-800",children:r?"إيصال تسليم وردية":(s.type==="send"?"تحويل":"سحب")+` - ${s.amount.toLocaleString()} جنيه`})})(),e.jsxs("p",{className:"text-[10px] text-gray-700",children:["تمت بواسطة: ",(s==null?void 0:s.cashierName)??"الحساب الرئيسي"]}),(()=>{const r=(s==null?void 0:s.type)==="report"||((s==null?void 0:s.title)||"").includes("إيصال تسليم وردية");return e.jsx("p",{className:"text-xs text-gray-500",children:r?`تم التسليم إلى: ${s.receiverPhone}`:`من ${s.senderPhone}${s.type==="send"?` إلى ${s.receiverPhone}`:""}`})})(),e.jsxs("p",{className:"text-xs text-gray-400",children:[rn.format(s.createdAt instanceof Date?s.createdAt:new Date(s.createdAt))," - ",zo.format(s.createdAt instanceof Date?s.createdAt:new Date(s.createdAt))]})]})]}),e.jsx(Nt,{variant:s.status==="completed"?"default":s.status==="pending"?"secondary":"destructive",className:"text-xs",children:s.status==="completed"?"مكتمل":s.status==="pending"?"قيد المعالجة":"فشل"})]},s.id))})})})]})]}),e.jsx(Ac,{isOpen:Wi,onClose:()=>ka(!1),transaction:Fi,onPrint:()=>window.print(),onDelete:$i,onComplete:Ri}),e.jsxs("div",{className:"space-y-1 fade-in-right w-full lg:w-5/6 mx-auto",children:[e.jsxs(tt,{id:"transaction-section",className:"bg-gradient-to-br from-white via-blue-50/30 to-indigo-50/50 border border-blue-200/40 rounded-lg shadow-lg hover:shadow-lg transition-all duration-200 group relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/5 via-indigo-500/3 to-purple-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-200"}),e.jsx("div",{className:"absolute top-0 right-0 w-32 h-32 sm:w-28 sm:h-28 lg:w-20 lg:h-20 bg-gradient-to-bl from-blue-400/10 to-transparent rounded-full  "}),e.jsx("div",{className:"absolute bottom-0 left-0 w-24 h-24 bg-gradient-to-tr from-indigo-400/10 to-transparent rounded-full  ",style:{animationDelay:"1s"}}),e.jsx(Dt,{className:"sticky top-0 z-20 bg-white/80 backdrop-blur supports-[backdrop-filter]:bg-white/60 pb-0.5 px-3 pt-1 lg:pt-0.5 lg:pb-0.5 lg:px-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Lt,{className:"text-sm font-bold flex items-center gap-2 text-gray-800",children:[e.jsxs("div",{className:"relative",children:[e.jsx(_s,{className:"h-1 w-1 text-emerald-500 "}),e.jsx("div",{className:"absolute inset-0 h-1 w-1 bg-emerald-400 rounded-full opacity-20 "})]}),e.jsx("span",{className:"bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent",children:"إجراء معاملة جديدة"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[Oe&&e.jsx("div",{className:"hidden md:flex items-center gap-1 bg-gradient-to-r from-emerald-50 to-green-50 hover:from-emerald-100 hover:to-green-100 border border-emerald-200 text-emerald-800 text-sm transition-all duration-300 hover:scale-105 h-9 px-3 rounded-xl shadow-sm",children:e.jsxs("span",{className:"text-sm font-semibold whitespace-nowrap",children:["تجربة: ",ze," ",ze>=3&&ze<=10?"ساعات":ze===2?"ساعتين":"ساعة"]})}),e.jsxs("div",{className:"hidden md:flex items-center gap-2 bg-gradient-to-r from-gray-50 to-slate-50 hover:from-gray-100 hover:to-slate-100 border border-gray-200 transition-all duration-300 hover:scale-105 h-9 px-3 rounded-xl shadow-sm",children:[e.jsx(id,{}),e.jsx(Ec,{})]})]}),Bo&&e.jsxs(c,{variant:"outline",size:"sm",className:"hidden flex items-center gap-1.5 sm:gap-2 bg-gradient-to-r from-cyan-50 to-blue-50 hover:from-cyan-100 hover:to-blue-100 border-cyan-200 text-cyan-800 text-xs sm:text-sm transition-all duration-300 hover:scale-105 hover:shadow-lg h-10 sm:h-12 px-4 sm:px-5 rounded-xl min-w-[44px] touch-manipulation",onClick:gl,title:"مزامنة البيانات المحفوظة محلياً مع الخادم",children:[e.jsx(Kc,{className:"h-3.5 w-3.5 sm:h-4 sm:w-4 animate-spin"}),e.jsx("span",{className:"text-xs sm:text-sm font-semibold whitespace-nowrap",children:"مزامنة"})]})]})}),e.jsxs(rt,{ref:m,className:"space-y-1 px-2 pb-2 relative z-10 transition-transform duration-200 ease-out will-change-transform",style:{transform:i?`translateY(${i}px)`:void 0},onFocusCapture:s=>{const r=s.target;if(!((r==null?void 0:r.id)==="transferExtraFeeInput")){x(0);return}const o=document.getElementById("transferSubmitButton");if(o){const d=o.getBoundingClientRect(),f=window.innerHeight;if(d.bottom>f){const v=d.bottom-f,j=Math.min(v,220);x(-j)}else x(0)}else x(0)},onBlurCapture:s=>{s.currentTarget.contains(s.relatedTarget)||x(0)},children:[e.jsxs("div",{className:"grid grid-cols-2 gap-0.5 p-0.5 bg-gradient-to-r from-gray-50 to-slate-50 rounded-xl border border-gray-200/50 fade-in-up w-full lg:w-5/6 mx-auto ",children:[e.jsxs(c,{variant:X==="transfer"?"default":"ghost",onClick:()=>tr("transfer"),className:`text-xs font-semibold transition-all duration-300 hover:scale-105 h-7 rounded-lg px-2 ${X==="transfer"?"bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg hover:shadow-md hover:from-blue-600 hover:to-indigo-700":"text-gray-600 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 hover:text-blue-700 hover:border-blue-200"}`,children:[e.jsx(ja,{className:"h-1 w-1 mr-1"}),"تحويل"]}),e.jsxs(c,{variant:X==="withdraw"?"default":"ghost",onClick:()=>tr("withdraw"),className:`text-xs font-semibold transition-all duration-300 hover:scale-105 h-7 rounded-lg px-2 ${X==="withdraw"?"bg-gradient-to-r from-emerald-500 to-green-600 text-white shadow-lg hover:shadow-md hover:from-emerald-600 hover:to-green-700":"text-gray-600 hover:bg-gradient-to-r hover:from-emerald-50 hover:to-green-50 hover:text-emerald-700 hover:border-emerald-200"}`,children:[e.jsx(mr,{className:"h-1 w-1 mr-1"}),"سحب"]})]}),e.jsxs("div",{className:"fade-in-up",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("label",{className:"text-sm font-semibold text-gray-700 block flex items-center gap-2",children:[e.jsx(is,{className:"h-1 w-1 text-blue-600"}),"اختيار المحفظة"]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsxs(c,{variant:"ghost",size:"sm",className:"h-6 rounded-md px-2 text-[10px] bg-emerald-50 text-emerald-700 hover:bg-emerald-100 border border-emerald-200",onClick:()=>h("/user/add-wallet"),title:"إضافة محفظة",children:[e.jsx(kt,{className:"h-3 w-3 mr-1"}),"إضافة محفظة"]}),e.jsxs(c,{variant:"ghost",size:"sm",className:"h-6 rounded-md px-2 text-[10px] bg-indigo-50 text-indigo-700 hover:bg-indigo-100 border border-indigo-200",onClick:()=>ge(!0),title:"المحافظ",children:[e.jsx(is,{className:"h-3 w-3 mr-1"}),"المحافظ"]})]})]}),ye.length>0?e.jsxs(Es,{value:te,onValueChange:$o,children:[e.jsx(Ms,{"data-testid":"wallet-select",className:"w-full h-12 text-sm bg-gradient-to-r from-white to-gray-50 border-2 border-gray-200 hover:border-blue-400 focus:border-blue-500 rounded-xl transition-all duration-300 hover:shadow-md focus:shadow-lg",children:e.jsx(Bs,{placeholder:"اختر محفظة للمعاملة",className:"text-gray-600"})}),e.jsxs(Ls,{className:"rounded-xl border-2 border-gray-200 shadow-md z-[9999]",children:[e.jsx("div",{"data-fixed-header":"true",className:"sticky top-0 z-10 bg-white p-2 border-b border-gray-200",children:e.jsx(R,{value:Dn,onChange:s=>Ai(s.target.value),placeholder:"ابحث برقم المحفظة",className:"h-6 text-xs"})}),e.jsx("div",{className:"pr-1",children:Cn.length===0?e.jsx("div",{className:"text-xs text-gray-500 p-2",children:"لا توجد نتائج مطابقة"}):Cn.map(s=>e.jsx(rs,{value:s.id,className:"rounded-lg hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 transition-all duration-200",children:e.jsxs("div",{className:"flex items-center gap-1 py-1 w-full justify-between",children:[e.jsx("div",{className:"p-1 bg-gradient-to-r from-blue-100 to-indigo-100 rounded-lg",children:e.jsx(is,{className:"h-1 w-1 text-blue-600"})}),e.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-sm font-medium text-gray-800",children:s.name}),e.jsxs("span",{className:"text-[10px] text-gray-500",children:["(",s.phone,")"]})]}),s.isDefault&&e.jsx(Nt,{variant:"secondary",className:"text-[10px] bg-gradient-to-r from-emerald-100 to-green-100 text-emerald-700 border-emerald-200",children:"افتراضي"})]}),e.jsx("div",{className:"ml-auto flex flex-col items-end gap-1"})]})},s.id))})]})]}):e.jsx("div",{className:"rounded-xl border-2 border-dashed border-gray-200 bg-gray-50 px-3 py-3 text-xs text-gray-600",children:"لا توجد محافظ حتى الآن. اضغط “إضافة محفظة” لإضافة أول محفظة."})]}),e.jsx(me,{open:Ys,onOpenChange:ks,children:e.jsxs(he,{className:"sm:max-w-3xl w-[95vw] sm:w-auto max-h-[80vh] overflow-y-auto",children:[e.jsx(ue,{children:e.jsx(xe,{children:"عرض المحافظ"})}),e.jsx("div",{className:"mt-2",children:e.jsx(Fc,{showAddButton:!1,showUsageBars:!1,showLimitCards:!1,showEditButton:!0})})]})}),e.jsx(Xt,{open:B,onOpenChange:ge,mode:"verify",title:"الرقم السري لفتح المحافظ",description:"أدخل الرقم السري الرئيسي لعرض وإدارة المحافظ",onSuccess:()=>{ge(!1),ks(!0)},userId:t==null?void 0:t.uid}),te&&ye.length>0&&(()=>{const s=ye.find(Se=>Se.id===te),r=Nl(te),n=_o(te),o=(Re==null?void 0:Re.monthlyWithdrawLimit)??(s==null?void 0:s.monthlyWithdrawalLimit)??2e5,d=(Re==null?void 0:Re.monthlyTransferLimit)??(s==null?void 0:s.monthlyTransferLimit)??2e5,f=r.totalWithdrawn??(Re==null?void 0:Re.monthlyWithdrawUsed)??0,v=r.totalTransferred??(Re==null?void 0:Re.monthlyTransferUsed)??0,j=(Re==null?void 0:Re.dailyWithdrawLimit)??1e5,T=(Re==null?void 0:Re.dailyTransferLimit)??6e4,I=n.totalWithdrawn??(Re==null?void 0:Re.dailyWithdrawUsed)??0,w=n.totalTransferred??(Re==null?void 0:Re.dailyTransferUsed)??0,O=parseFloat(u||"0")||0,Q=f+(X==="withdraw"?O:0),k=v+(X==="transfer"?O:0),G=I+(X==="withdraw"?O:0),qe=w+(X==="transfer"?O:0);return s?e.jsxs("div",{className:"fade-in-up mb-2 space-y-2",children:[e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-1 rounded-md border border-gray-200 shadow-sm hover:shadow-md transition-all duration-300",children:[e.jsxs("div",{className:"text-[10px] text-gray-600 font-medium mb-1 text-center",children:["الحدود الشهرية: ",s.name]}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-red-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-red-400 to-red-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(Q/Math.max(o,1)*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-blue-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-400 to-blue-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(k/Math.max(d,1)*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-[10px] text-red-600 font-medium",children:["متبقي سحب: ",Math.max(o-Q,0).toLocaleString("en-US")," جنيه"]}),e.jsxs("div",{className:"text-[10px] text-blue-600 font-medium",children:["متبقي تحويل: ",Math.max(d-k,0).toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-1 rounded-md border border-gray-200 shadow-sm hover:shadow-md transition-all duration-300",children:[e.jsxs("div",{className:"text-[10px] text-gray-600 font-medium mb-1 text-center",children:["الحدود اليومية: ",s.name]}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-orange-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-orange-400 to-orange-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(G/Math.max(j,1)*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-green-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-green-400 to-green-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(qe/Math.max(T,1)*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-[10px] text-orange-600 font-medium",children:["متبقي سحب يومي: ",Math.max(j-G,0).toLocaleString("en-US")," جنيه"]}),e.jsxs("div",{className:"text-[10px] text-green-600 font-medium",children:["متبقي تحويل يومي: ",Math.max(T-qe,0).toLocaleString("en-US")," جنيه"]})]})]})]}):null})(),X==="transfer"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المرسل"}),e.jsxs("div",{className:"relative",children:[e.jsx(bs,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(R,{value:$e,onChange:s=>ut(s.target.value),onKeyDown:s=>{if(s.key==="Enter"){const r=document.getElementById("receiverPhoneInput");if(r)r.focus();else{const n=document.getElementById("amountInput");n==null||n.focus()}}},placeholder:"01030302038",className:"pl-10 h-10 text-sm transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]})]}),!S&&e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المستقبل"}),e.jsxs("div",{className:"relative",children:[e.jsx(bs,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(R,{id:"receiverPhoneInput",value:He,onChange:s=>{zt(s.target.value),yr&&Gs(!1)},onKeyDown:s=>{if(s.key==="Enter"){const r=document.getElementById("amountInput");r==null||r.focus()}},inputMode:"numeric",maxLength:11,placeholder:"أدخل رقم المستقبل",className:"pl-10 h-10 text-sm transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المستقبل"}),e.jsxs("div",{className:"relative",children:[e.jsx(bs,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(R,{value:te&&((Dl=ye.find(s=>s.id===te))==null?void 0:Dl.phone)||"",readOnly:!0,placeholder:"اختر محفظة أولاً",className:"pl-10 h-10 text-sm bg-gray-50 transition-all duration-300"})]})]}),X==="transfer"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"المبلغ (جنيه)"}),e.jsxs("div",{className:"relative flex items-center gap-2",children:[e.jsx(nt,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(R,{id:"amountInput",value:u,onChange:s=>{E(s.target.value),yr&&Gs(!1)},onKeyDown:s=>{if(s.key==="Enter"){const r=document.getElementById("transferCommissionInput");if(r)r.focus();else{const n=document.getElementById("quickDebtButton");n==null||n.focus()}}},placeholder:"أدخل المبلغ",type:"number",className:"pl-10 h-10 text-sm transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),xt?e.jsxs("div",{className:"mt-2 text-xs text-green-700 bg-green-50 border border-green-200 rounded px-2 py-1 flex items-center gap-2",children:[e.jsxs("span",{children:["تم إدخال تفاصيل الأجل لـ ",xt.debtorName," بمبلغ ",xt.amount," جنيه"]}),e.jsx(c,{type:"button",variant:"ghost",size:"sm",className:"h-6 px-2",onClick:()=>Pt(null),children:"إلغاء"})]}):null]}),(()=>{if(S)return null;const s=Ss();return s&&s.defaultTransferCommission!=null?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة التحويل (تلقائية)"}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["سيتم تطبيق عمولة التحويل الافتراضية لكل ألف: ",s==null?void 0:s.defaultTransferCommission," جنيه لكل ألف"]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(c,{id:"quickDebtButton",type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const n=Ss(),o=(n==null?void 0:n.defaultTransferCommission)!=null?Number(n.defaultTransferCommission):0,d=parseFloat(u||"0")||0,f=Math.round((o||0)*d/1e3*100)/100,v=d+f;we((v||0).toString()),Ae?l({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):ce(!0)},children:"أجل"}),e.jsx(c,{type:"button",variant:"outline",size:"icon",className:"hidden",title:se?"العمولة تُضاف":"العمولة تُخصم",children:se?e.jsx(kt,{className:"h-4 w-4 text-green-600"}):e.jsx(Us,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"hidden",children:se?"العمولة تُضاف":"العمولة تُخصم"})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة التحويل على العملية (جنيه)"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(nt,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-orange-500"}),e.jsx(R,{id:"transferCommissionInput",value:Ke,onChange:n=>Jt(n.target.value),placeholder:"أدخل عمولة التحويل",type:"number",className:"pl-10 h-10 text-sm transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),e.jsx(c,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const n=Ss(),o=parseFloat(u||"0")||0;let d=0;if((n==null?void 0:n.defaultTransferCommission)!=null){const v=Number(n.defaultTransferCommission)||0;d=Math.round(v*o/1e3*100)/100}else{const v=Ke&&Ke.trim()!==""?parseFloat(Ke):0;d=Math.max(0,v)}const f=o+d;we((f||0).toString()),Ae?l({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):ce(!0)},children:"أجل"}),e.jsx(c,{type:"button",variant:"outline",size:"icon",className:"hidden",title:se?"العمولة تُضاف":"العمولة تُخصم",children:se?e.jsx(kt,{className:"h-4 w-4 text-green-600"}):e.jsx(Us,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"hidden",children:se?"العمولة تُضاف":"العمولة تُخصم"})]}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"يمكنك إدخال عمولة العملية الإجمالية (اختياري)"})]})})(),(()=>{const s=Gt($e||"").replace(/\D/g,""),r=Gt(He||"").replace(/\D/g,"");return X==="transfer"&&(s.startsWith("010")&&(r.startsWith("011")||r.startsWith("012")||r.startsWith("015"))||s.startsWith("012")&&r.startsWith("010")||s.startsWith("011")&&r.startsWith("010")||s.startsWith("015")&&r.startsWith("010"))?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رسوم التحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(nt,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-orange-500"}),e.jsx(R,{id:"transferExtraFeeInput",value:Ot,onChange:o=>na(o.target.value),placeholder:"أدخل رسوم التحويل",type:"number",className:"pl-10 h-10 text-sm transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),e.jsx("div",{className:"hidden",children:"تُخصم من المحفظة وتضاف للدرج — لعمليات 010 → 011/012/015 أو 012 → 010 أو 011 → 010 أو 015 → 010"})]}):null})(),e.jsx("div",{className:"sticky bottom-0 z-10 pt-2 bg-white/80 backdrop-blur supports-[backdrop-filter]:bg-white/60",children:e.jsx(c,{id:"transferSubmitButton",onClick:wl,className:"w-full font-medium h-10 text-sm btn-bounce hover-glow transition-all duration-300 bg-blue-600 hover:bg-blue-700 text-white",children:yr?"تم التحويل بنجاح":"تأكيد التحويل"})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"مبلغ السحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(mr,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-green-500"}),e.jsx(R,{id:"amountInput",value:u,onChange:s=>{E(s.target.value),En&&oa(!1)},onKeyDown:s=>{if(s.key==="Enter"){const r=document.getElementById("manualWithdrawCommissionInput");if(r)r.focus();else{const n=document.getElementById("withdrawSubmitButton");n==null||n.focus()}}},placeholder:"أدخل مبلغ السحب",type:"number",className:"pl-10 h-10 text-sm transition-all duration-300 hover:border-blue-400 focus:border-blue-500"}),e.jsx("div",{className:"mt-2",children:e.jsx(c,{id:"prefillBtn",type:"button",variant:"outline",size:"sm",onClick:wn,children:"Use latest SMS"})})]})]}),(()=>{const s=Ss();return s&&s.defaultWithdrawCommission!=null?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة السحب (تلقائية)"}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["سيتم تطبيق عمولة السحب الافتراضية لكل ألف: ",s==null?void 0:s.defaultWithdrawCommission," جنيه لكل ألف"]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(c,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const n=Ss(),o=parseFloat(u||"0")||0,d=(n==null?void 0:n.defaultWithdrawCommission)!=null&&Number(n.defaultWithdrawCommission)||0,f=Math.round(d*o/1e3*100)/100,v=se?o+f:o;we((v||0).toString()),Ae?l({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):ce(!0)},children:"أجل"}),e.jsx(c,{type:"button",variant:"outline",size:"icon",className:"h-8 w-8",onClick:()=>Ee(n=>!n),title:se?"العمولة تُضاف إلى الدين":"العمولة تُخصم من الدين",children:se?e.jsx(kt,{className:"h-4 w-4"}):e.jsx(Us,{className:"h-4 w-4"})}),e.jsx("span",{className:"text-xs text-gray-600",children:se?"العمولة تُضاف":"العمولة تُخصم"})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة السحب على العملية (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(nt,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-orange-500"}),e.jsx(R,{id:"manualWithdrawCommissionInput",value:ke,onChange:n=>at(n.target.value),onKeyDown:n=>{if(n.key==="Enter"){const o=document.getElementById("withdrawSubmitButton");o==null||o.focus()}},placeholder:"أدخل العمولة المطلوبة",type:"number",className:"pl-10 h-10 text-sm transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"أدخل العمولة الإجمالية لإتمام عملية السحب"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(c,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const n=Ss(),o=parseFloat(u||"0")||0;let d=0;if((n==null?void 0:n.defaultWithdrawCommission)!=null){const v=Number(n.defaultWithdrawCommission)||0;d=Math.round(v*o/1e3*100)/100}else{const v=ke&&ke.trim()!==""?parseFloat(ke):Math.round(o*.01*100)/100;d=Math.max(0,v)}const f=se?o+d:o;we((f||0).toString()),Ae?l({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):ce(!0)},children:"أجل"}),e.jsx(c,{type:"button",variant:"outline",size:"icon",title:se?"العمولة تُضاف":"العمولة تُخصم",onClick:()=>Ee(n=>!n),children:se?e.jsx(kt,{className:"h-4 w-4 text-green-600"}):e.jsx(Us,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"text-xs text-gray-600",children:se?"العمولة تُضاف":"العمولة تُخصم"})]})]})})(),e.jsx("div",{className:"sticky bottom-0 z-10 pt-2 bg-white/80 backdrop-blur supports-[backdrop-filter]:bg-white/60",children:e.jsx(c,{id:"withdrawSubmitButton",onClick:wl,className:"w-full font-medium h-10 text-sm btn-bounce hover-glow transition-all duration-300 bg-green-600 hover:bg-green-700 text-white",children:En?"تم السحب بنجاح":"تأكيد السحب"})})]}),e.jsx(me,{open:Y,onOpenChange:ce,children:e.jsxs(he,{children:[e.jsxs(ue,{children:[e.jsx(xe,{children:"تحويل مؤجل"}),e.jsx(Vt,{children:"أدخل بيانات صاحب الدين والمبلغ والملاحظات ثم اضغط حفظ"})]}),e.jsxs("div",{className:"space-y-3",children:[us&&us.length>0?e.jsxs("div",{children:[e.jsx(V,{children:"اختيار عميل"}),e.jsxs(Es,{value:ot,onValueChange:s=>{Ge(s);const r=us.find(n=>n.id===s);r&&Fe(r.name)},children:[e.jsx(Ms,{className:"w-full",children:e.jsx(Bs,{placeholder:"اختر عميل"})}),e.jsx(Ls,{children:us.map(s=>e.jsxs(rs,{value:s.id,children:[s.name,s.mobile?` — ${s.mobile}`:""]},s.id))})]})]}):e.jsx("div",{className:"text-xs text-gray-500",children:"لا يوجد عملاء مُسجلين حالياً. يمكنك إضافة عميل من نافذة الديون."}),e.jsxs("div",{children:[e.jsx(V,{htmlFor:"quickDebtName",children:"اسم صاحب الدين"}),e.jsx(R,{id:"quickDebtName",value:oe,onChange:s=>Fe(s.target.value),placeholder:"اكتب الاسم"})]}),e.jsxs("div",{children:[e.jsx(V,{htmlFor:"quickDebtAmount",children:"المبلغ (محسوب تلقائياً)"}),e.jsx(R,{id:"quickDebtAmount",type:"number",value:Te,readOnly:!0,placeholder:"المبلغ + عمولة التحويل"})]}),e.jsxs("div",{children:[e.jsx(V,{htmlFor:"quickDebtNotes",children:"ملاحظات"}),e.jsx(R,{id:"quickDebtNotes",value:Je,onChange:s=>it(s.target.value),placeholder:"اكتب ملاحظات (اختياري)"})]})]}),e.jsx(Ce,{children:e.jsx(c,{type:"button",onClick:()=>{const s=Ss(),r=parseFloat((u||"").toString())||0;let n=0;if(X==="transfer")if((s==null?void 0:s.defaultTransferCommission)!=null){const f=Number(s.defaultTransferCommission)||0;n=Math.round(f*r/1e3*100)/100}else{const f=Ke&&Ke.trim()!==""?parseFloat(Ke):0;n=Math.max(0,f)}else if((s==null?void 0:s.defaultWithdrawCommission)!=null){const f=Number(s.defaultWithdrawCommission)||0;n=Math.round(f*r/1e3*100)/100}else{const f=ke&&ke.trim()!==""?parseFloat(ke):Math.round(r*.01*100)/100;n=Math.max(0,f)}let o=0;if(X==="withdraw"?o=se?r:Math.max(0,Math.round((r-n)*100)/100):o=Math.max(0,Math.round((r+n)*100)/100),!oe||isNaN(o)||o<=0){l({title:"خطأ في بيانات الأجل",description:"يرجى إدخال الاسم والمبلغ بشكل صحيح",variant:"destructive"});return}const d=us.find(f=>f.id===ot);Pt({debtorName:oe,amount:o,notes:Je,customerId:ot||void 0,mobile:d==null?void 0:d.mobile}),Vs(!1),ce(!1),l({title:"تم حفظ بيانات الأجل",description:"سيتم إضافة الدين عند تأكيد العملية",variant:"default"})},children:"حفظ"})})]})})]})]}),e.jsx(tt,{className:"bg-gradient-to-br from-red-50 to-red-100 border-red-200 fade-in-up card-float",children:e.jsxs(rt,{className:"p-3 text-center",children:[e.jsx("div",{className:"text-red-600 font-medium text-[10px] mb-1",children:"⚠️ تحذير من التحويل"}),e.jsx("div",{className:"text-[10px] text-red-700",children:"لا يمكن إلغاء أي عملية بعد تأكيدها للمحافظة على الأمان"})]})})]})]}),e.jsx(ed,{isOpen:Ii,onClose:()=>Ti(!1),initialEditingWallet:ki,onWalletUpdate:async()=>{try{await er()}catch(s){console.error("Error reloading wallets after update:",s)}}}),e.jsx(td,{isOpen:Oi,onClose:()=>In(!1),transaction:Pi,onDelete:Uo}),e.jsx(Xt,{open:Mi,onOpenChange:ia,onSuccess:Ko,title:qo(),description:Vo(),mode:"verify"}),e.jsx(Ol,{open:Li,onOpenChange:br,onSuccess:()=>{br(!1),kn(!0)},title:"حماية أرشيف التقارير اليومية",description:"أدخل كلمة مرور تسجيل الدخول للوصول إلى الأرشيف"}),e.jsx(Pd,{open:Bi,onOpenChange:kn,userId:t==null?void 0:t.uid}),e.jsx(Wl,{open:xo,onOpenChange:Gn,onSuccess:Ho,title:"تعديل الرصيد النقدي في الدرج",description:"أدخل الرقم السري والمبلغ الجديد لتعديل الرصيد النقدي في الدرج",currentBalance:Qe,balanceLabel:"الرصيد النقدي",userId:t==null?void 0:t.uid}),e.jsx(Wl,{open:po,onOpenChange:Qn,onSuccess:Go,title:"تعديل رصيد المحفظة",description:"أدخل الرقم السري والمبلغ الجديد لتعديل رصيد المحفظة",currentBalance:Mt&&je[Mt]||0,balanceLabel:`رصيد ${((Cl=ye.find(s=>s.id===Mt))==null?void 0:Cl.name)||"المحفظة"}`,userId:t==null?void 0:t.uid}),e.jsx(nd,{open:go,onOpenChange:Rr,onSuccess:Qo,title:"إضافة أو خصم مبلغ من رصيد المحفظة",description:"أدخل الرقم السري والمبلغ المراد إضافته أو خصمه من رصيد المحفظة",currentBalance:Mt&&je[Mt]||0,balanceLabel:`رصيد ${((Il=ye.find(s=>s.id===Mt))==null?void 0:Il.name)||"المحفظة"}`,userId:t==null?void 0:t.uid}),e.jsx(sd,{open:Io,onOpenChange:To,userId:t==null?void 0:t.uid}),e.jsx(ad,{open:ko,onOpenChange:Ao,userId:t==null?void 0:t.uid}),e.jsx(rd,{open:Po,onOpenChange:Oo}),e.jsx(me,{open:bo,onOpenChange:_a,children:e.jsxs(he,{className:"sm:max-w-md",children:[e.jsx(ue,{children:e.jsx(xe,{className:"text-right",children:"تعديل الدرج النقدية"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(V,{htmlFor:"amount",className:"text-right block",children:"المبلغ"}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx(R,{id:"amount",type:"number",placeholder:"أدخل المبلغ",value:zr,onChange:s=>za(s.target.value),className:"text-right flex-1",dir:"rtl",min:"0"}),e.jsxs("div",{className:"flex gap-1",children:[e.jsxs(c,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white px-3 py-2",onClick:()=>{if(!an(Yr)){l({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}const s=parseFloat(zr);if(isNaN(s)||s<=0){l({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const r=Qe+s;pt(r);const n={cashBalance:r,lastUpdated:new Date().toISOString()},o=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(o,JSON.stringify(n)),t!=null&&t.uid?De.updateUserData(t.uid,n).then(()=>{console.log("✅ تم حفظ رصيد الدرج النقدي في Firebase بنجاح"),localStorage.removeItem(o),be(!1)}).catch(d=>{console.error("❌ خطأ في حفظ الرصيد في Firebase:",d),be(!0)}):be(!0),l({title:"تم بنجاح",description:`تم إضافة ${s} جنيه إلى الدرج النقدية وحفظه في السحابة`}),_a(!1),za(""),Va("")},children:[e.jsx(kt,{className:"h-1 w-1 mr-1"}),"إضافة"]}),e.jsxs(c,{type:"button",size:"sm",className:"bg-red-600 hover:bg-red-700 text-white px-3 py-2",onClick:()=>{if(!an(Yr)){l({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}const s=parseFloat(zr);if(isNaN(s)||s<=0){l({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const r=Qe-s;pt(r);const n={cashBalance:r,lastUpdated:new Date().toISOString()},o=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(o,JSON.stringify(n)),t!=null&&t.uid?De.updateUserData(t.uid,n).then(()=>{console.log("✅ تم حفظ رصيد الدرج النقدي في Firebase بنجاح"),localStorage.removeItem(o),be(!1)}).catch(d=>{console.error("❌ خطأ في حفظ الرصيد في Firebase:",d),be(!0)}):be(!0),l({title:"تم بنجاح",description:`تم خصم ${s} جنيه من الدرج النقدية وحفظه في السحابة`}),_a(!1),za(""),Va("")},children:[e.jsx(Us,{className:"h-1 w-1 mr-1"}),"خصم"]})]})]}),e.jsxs("p",{className:"text-[10px] text-gray-500 text-right",children:["الرصيد الحالي: ",Qe.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(V,{htmlFor:"pin",className:"text-right block",children:"الرقم السري"}),e.jsx(R,{id:"pin",type:"password",placeholder:"أدخل الرقم السري",value:Yr,onChange:s=>Va(s.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsx(Ce,{className:"flex gap-2",children:e.jsx(c,{variant:"outline",onClick:()=>{_a(!1),za(""),Va("")},children:"إلغاء"})})]})}),e.jsx(me,{open:Eo,onOpenChange:Qa,children:e.jsxs(he,{className:"sm:max-w-md",children:[e.jsx(ue,{children:e.jsx(xe,{className:"text-right text-red-600",children:"تصفير إجمالي المحفظة"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-red-50 rounded-lg border border-red-200",children:[e.jsx("p",{className:"text-red-800 font-medium mb-2",children:"تحذير!"}),e.jsx("p",{className:"text-red-700 text-sm",children:"سيتم تصفير جميع أرصدة المحافظ إلى صفر. هذا الإجراء لا يمكن التراجع عنه."}),e.jsxs("p",{className:"text-red-600 text-sm mt-2",children:["الرصيد الحالي: ",Object.values(je).reduce((s,r)=>s+r,0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(V,{htmlFor:"resetWalletTotalPin",className:"text-right block",children:"الرقم السري الرئيسي"}),e.jsx(R,{id:"resetWalletTotalPin",type:"password",placeholder:"أدخل الرقم السري الرئيسي",value:yl,onChange:s=>Za(s.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsxs(Ce,{className:"flex gap-2",children:[e.jsx(c,{variant:"outline",onClick:()=>{Qa(!1),Za("")},children:"إلغاء"}),e.jsx(c,{variant:"destructive",onClick:async()=>{if(!await Yt.verifyMasterPin(yl,t==null?void 0:t.uid)){l({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}try{const r={};Object.keys(je).forEach(f=>{r[f]=0}),Ze(r),localStorage.setItem(ct(),JSON.stringify(r)),Qa(!1),Za("");const n=new Date().toISOString(),o={walletBalances:r,lastUpdated:n},d=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(d,JSON.stringify(o)),t!=null&&t.uid?De.updateUserData(t.uid,o).then(()=>{localStorage.removeItem(d),be(!1)}).catch(f=>{console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",f),be(!0),l({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):be(!0),setTimeout(()=>{Ze({...r})},100)}catch(r){console.error("خطأ في تصفير أرصدة المحافظ:",r),l({title:"خطأ",description:"حدث خطأ أثناء تصفير المحافظ",variant:"destructive"})}},children:"تصفير المحفظة"})]})]})}),e.jsx(me,{open:fo,onOpenChange:Ua,children:e.jsxs(he,{className:"sm:max-w-md",children:[e.jsx(ue,{children:e.jsx(xe,{className:"text-right text-red-600",children:"تصفير رصيد المحفظة المختارة"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-red-50 rounded-lg border border-red-200",children:[e.jsx("p",{className:"text-red-800 font-medium mb-2",children:"تحذير!"}),e.jsx("p",{className:"text-red-700 text-sm",children:"سيتم تصفير رصيد المحفظة المحددة إلى صفر. هذا الإجراء لا يمكن التراجع عنه."}),e.jsxs("p",{className:"text-red-600 text-sm mt-2",children:["المحفظة: ",((Tl=ye.find(s=>s.id===te))==null?void 0:Tl.name)||te]}),e.jsxs("p",{className:"text-red-600 text-sm",children:["الرصيد الحالي: ",(te&&je[te]?je[te]:0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(V,{htmlFor:"resetSelectedWalletPin",className:"text-right block",children:"الرقم السري الرئيسي"}),e.jsx(R,{id:"resetSelectedWalletPin",type:"password",autoComplete:"off",placeholder:"أدخل الرقم السري الرئيسي",value:Zn,onChange:s=>Ur(s.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsxs(Ce,{className:"flex gap-2",children:[e.jsx(c,{variant:"outline",onClick:()=>{Ua(!1),Ur("")},children:"إلغاء"}),e.jsx(c,{variant:"destructive",onClick:async()=>{var r;if(!te){l({title:"اختر محفظة",description:"يرجى اختيار محفظة أولاً",variant:"destructive"});return}if(!await Yt.verifyMasterPin(Zn,t==null?void 0:t.uid)){l({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}try{const n={...je};n[te]=0,Ze(n),localStorage.setItem(ct(),JSON.stringify(n)),Ua(!1),Ur("");const o=new Date().toISOString(),d={walletBalances:n,lastUpdated:o},f=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(f,JSON.stringify(d)),t!=null&&t.uid?De.updateUserData(t.uid,d).then(()=>{localStorage.removeItem(f),be(!1)}).catch(v=>{console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",v),be(!0),l({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):be(!0),l({title:"تم التصفير بنجاح",description:`تم تصفير رصيد المحفظة ${((r=ye.find(v=>v.id===te))==null?void 0:r.name)||te}`})}catch(n){console.error("خطأ في تصفير رصيد المحفظة المختارة:",n),l({title:"خطأ",description:"حدث خطأ أثناء تصفير رصيد المحفظة المختارة",variant:"destructive"})}},children:"تصفير المحفظة"})]})]})}),e.jsx(me,{open:Fo,onOpenChange:Ga,children:e.jsxs(he,{className:"sm:max-w-md",children:[e.jsx(ue,{children:e.jsxs(xe,{className:"text-right text-green-600 flex items-center gap-2 justify-end",children:[e.jsx(kt,{className:"h-4 w-4"}),"إضافة أموال لإجمالي المحفظة"]})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-green-50 rounded-lg border border-green-200",children:[e.jsx("p",{className:"text-green-800 font-medium mb-2",children:"إضافة أموال"}),e.jsx("p",{className:"text-green-700 text-sm",children:"سيتم إضافة المبلغ المحدد إلى إجمالي المحفظة بشكل متناسب على جميع المحافظ."}),e.jsxs("p",{className:"text-green-600 text-sm mt-2",children:["الرصيد الحالي: ",Object.values(je).reduce((s,r)=>s+r,0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"addWalletTotalAmount",className:"text-right block",children:"المبلغ المراد إضافته"}),e.jsx(R,{id:"addWalletTotalAmount",type:"number",placeholder:"أدخل المبلغ",value:hl,onChange:s=>Zr(s.target.value),className:"text-right",dir:"rtl"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"addWalletTotalPin",className:"text-right block",children:"الرقم السري للتأكيد"}),e.jsx(R,{id:"addWalletTotalPin",type:"password",autoComplete:"off",placeholder:"أدخل الرقم السري",value:ul,onChange:s=>Xr(s.target.value),className:"text-right",dir:"rtl"})]})]})]}),e.jsxs(Ce,{className:"flex gap-2",children:[e.jsx(c,{variant:"outline",onClick:()=>{Ga(!1),Zr(""),Xr("")},children:"إلغاء"}),e.jsx(c,{variant:"default",className:"bg-green-600 hover:bg-green-700",disabled:xl,onClick:async()=>{const s=parseFloat(hl);if(!s||s<=0){l({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}if(!Lo(ul)){l({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}pl(!0);try{const r=Object.values(je).reduce((n,o)=>n+o,0);if(r===0){const n=Object.keys(je),o=s/n.length,d={};n.forEach(f=>{d[f]=o}),Ze(d),localStorage.setItem(ct(),JSON.stringify(d)),t!=null&&t.uid?await De.updateUserData(t.uid,{walletBalances:d,lastUpdated:new Date().toISOString()}):be(!0)}else{const n={};Object.entries(je).forEach(([o,d])=>{const f=d/r,v=s*f;n[o]=d+v}),Ze(n),localStorage.setItem(ct(),JSON.stringify(n)),t!=null&&t.uid?await De.updateUserData(t.uid,{walletBalances:n,lastUpdated:new Date().toISOString()}):be(!0)}setTimeout(()=>{Ze(n=>({...n}))},100),Ga(!1),Zr(""),Xr("")}catch(r){console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",r),l({title:"خطأ",description:"حدث خطأ أثناء حفظ البيانات",variant:"destructive"})}finally{pl(!1)}},children:xl?"جاري الإضافة...":"إضافة الأموال"})]})]})}),e.jsx(me,{open:Mo,onOpenChange:Xa,children:e.jsxs(he,{className:"sm:max-w-[425px]",children:[e.jsx(ue,{children:e.jsxs(xe,{className:"text-red-600 flex items-center gap-2",children:[e.jsx(_t,{className:"h-1 w-1"}),"تصفير الرصيد النقدي"]})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-3",children:e.jsx("p",{className:"text-sm text-red-700",children:"⚠️ تحذير: سيتم تصفير الرصيد النقدي في الدرج إلى صفر. هذا الإجراء لا يمكن التراجع عنه."})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(V,{htmlFor:"resetCashPin",children:"الرقم السري الرئيسي"}),e.jsx(R,{id:"resetCashPin",type:"password",autoComplete:"off",placeholder:"أدخل الرقم السري الرئيسي",value:tn,onChange:s=>sn(s.target.value)})]})]}),e.jsxs(Ce,{children:[e.jsx(c,{variant:"outline",onClick:()=>{Xa(!1),sn("")},children:"إلغاء"}),e.jsx(c,{variant:"destructive",onClick:async()=>{if(!tn){l({title:"خطأ",description:"يرجى إدخال الرقم السري",variant:"destructive"});return}if(!await Yt.verifyMasterPin(tn,t==null?void 0:t.uid)){l({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}try{pt(0),Xa(!1),sn("");const r={cashBalance:0,lastUpdated:new Date().toISOString()};localStorage.setItem(dt(),"0");const n=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(n,JSON.stringify(r)),t!=null&&t.uid?De.updateUserData(t.uid,r).then(()=>{localStorage.removeItem(n),be(!1)}).catch(o=>{console.error("خطأ في حفظ الرصيد في Firebase:",o),be(!0),l({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):be(!0)}catch(r){console.error("خطأ في تصفير الرصيد النقدي:",r),l({title:"خطأ",description:"حدث خطأ أثناء تصفير الرصيد النقدي",variant:"destructive"})}},children:"تصفير الرصيد"})]})]})}),e.jsx(me,{open:Wo,onOpenChange:Ya,children:e.jsxs(he,{className:"sm:max-w-[425px]",children:[e.jsx(ue,{children:e.jsxs(xe,{className:"text-green-600 flex items-center gap-2",children:[e.jsx(kt,{className:"h-4 w-4"}),"إضافة أموال للدرج"]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-3",children:e.jsx("p",{className:"text-sm text-green-700",children:"💰 سيتم إضافة المبلغ المحدد إلى الرصيد النقدي في الدرج"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"addCashAmount",children:"المبلغ المراد إضافته"}),e.jsx(R,{id:"addCashAmount",type:"number",placeholder:"أدخل المبلغ",value:Ha,onChange:s=>Hr(s.target.value),min:"0",step:"0.01"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"addCashPin",children:"الرقم السري لدرج النقدية"}),e.jsx(R,{id:"addCashPin",type:"password",placeholder:"أدخل الرقم السري",value:Gr,onChange:s=>Qr(s.target.value)})]})]}),e.jsxs(Ce,{children:[e.jsx(c,{variant:"outline",onClick:()=>{Ya(!1),Hr(""),Qr("")},children:"إلغاء"}),e.jsx(c,{variant:"default",className:"bg-green-600 hover:bg-green-700",disabled:dl,onClick:async()=>{if(!Ha||parseFloat(Ha)<=0){l({title:"خطأ",description:"يرجى إدخال مبلغ صحيح أكبر من صفر",variant:"destructive"});return}if(!Gr){l({title:"خطأ",description:"يرجى إدخال الرقم السري",variant:"destructive"});return}if(!an(Gr)){l({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}ml(!0);try{const s=parseFloat(Ha),r=Qe+s;pt(r),localStorage.setItem(dt(),r.toString());const n={cashBalance:r,lastUpdated:new Date().toISOString()},o=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(o,JSON.stringify(n)),t!=null&&t.uid?(await De.updateUserData(t.uid,n),localStorage.removeItem(o),be(!1)):be(!0),Ya(!1),Hr(""),Qr("")}catch(s){console.error("خطأ في حفظ الرصيد في Firebase:",s),pt(Qe),localStorage.setItem("cashBalance",Qe.toString()),l({title:"خطأ",description:"حدث خطأ أثناء حفظ البيانات، يرجى المحاولة مرة أخرى",variant:"destructive"})}finally{ml(!1)}},children:dl?"جاري الإضافة...":"إضافة الأموال"})]})]})}),e.jsx(me,{open:uo,onOpenChange:$r,children:e.jsxs(he,{className:"sm:max-w-md",children:[e.jsx(ue,{children:e.jsx(xe,{className:"text-right",children:"اختيار التاريخ والوقت للبحث"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(V,{htmlFor:"search-date",className:"text-right block",children:"التاريخ"}),e.jsx(R,{id:"search-date",type:"date",value:Aa,onChange:s=>Wn(s.target.value),className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(V,{htmlFor:"search-time",className:"text-right block",children:"الوقت (اختياري)"}),e.jsx(R,{id:"search-time",type:"time",value:Pa,onChange:s=>Fn(s.target.value),className:"text-right",placeholder:"اختر الوقت للبحث في ساعة محددة"}),e.jsx("p",{className:"text-[10px] text-gray-500 text-right",children:"إذا لم تختر وقتاً محدداً، سيتم البحث في كامل اليوم"})]})]}),e.jsxs(Ce,{className:"flex justify-between",children:[e.jsx(c,{variant:"outline",onClick:()=>{Wn(""),Fn(""),$r(!1)},children:"مسح"}),e.jsx(c,{onClick:()=>$r(!1),children:"تطبيق"})]})]})}),e.jsx(Fl,{isOpen:Ft&&!C,onClose:()=>ft(!1),onTrialStarted:mo}),e.jsx(od,{isOpen:Ji,onClose:()=>Nr(!1)}),e.jsx(cd,{isOpen:fr,onClose:()=>la(!1),initialBarcode:Di}),e.jsx(Pc,{isOpen:Ki,onClose:()=>Wa(!1)}),e.jsx(Oc,{open:qi,onOpenChange:Fa}),e.jsx(Sd,{open:Vi,onOpenChange:s=>{if(s&&!as){l({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});return}Ea(s)}}),e.jsx(Od,{open:Z,onOpenChange:s=>{if(s&&!as){l({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}L(s)}}),e.jsx(Wd,{open:D,onOpenChange:s=>{if(s&&!as){l({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}U(s)}}),e.jsx(me,{open:yo,onOpenChange:s=>{if(s){l({title:"قيد التطوير",description:"هذه الميزة غير متاحة حالياً."});return}Jr(!1)},children:e.jsxs(he,{dir:"rtl",className:"sm:max-w-md w-[95vw] sm:w-auto rounded-2xl border border-emerald-200 shadow-xl bg-gradient-to-br from-white via-green-50 to-emerald-50 backdrop-blur-md data-[state=open]:animate-in data-[state=open]:fade-in-0 data-[state=open]:zoom-in-90 data-[state=open]:slide-in-from-bottom-8 duration-300",children:[e.jsxs(ue,{children:[e.jsx(xe,{className:"text-right text-green-700",children:"شحن رصيد الموبايل"}),e.jsx(Vt,{className:"text-right text-gray-600",children:"أدخل البيانات ثم اضغط تأكيد"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx(V,{htmlFor:"topupPhone",className:"text-right block",children:"رقم الموبايل"}),e.jsx(R,{id:"topupPhone",value:Ja,onChange:s=>Xn(s.target.value),placeholder:"010xxxxxxx",className:"text-right"})]}),e.jsxs("div",{children:[e.jsx(V,{className:"text-right block",children:"شركة التشغيل"}),e.jsxs(Es,{value:Ka,onValueChange:el,children:[e.jsx(Ms,{className:"text-right",children:e.jsx(Bs,{placeholder:"اختر الشركة"})}),e.jsxs(Ls,{children:[e.jsx(rs,{value:"vodafone",children:"فودافون"}),e.jsx(rs,{value:"orange",children:"أورنج"}),e.jsx(rs,{value:"etisalat",children:"اتصالات"}),e.jsx(rs,{value:"we",children:"WE"})]})]})]}),e.jsxs("div",{children:[e.jsx(V,{htmlFor:"topupAmount",className:"text-right block",children:"المبلغ بالجنيه"}),e.jsx(R,{id:"topupAmount",type:"number",value:qa,onChange:s=>tl(s.target.value?Number(s.target.value):""),placeholder:"50",className:"text-right"})]})]}),e.jsxs(Ce,{className:"flex gap-2 justify-between",children:[e.jsx(c,{variant:"outline",onClick:()=>Jr(!1),className:"border-gray-300",children:"إلغاء"}),e.jsx(c,{onClick:b,disabled:sl||!Ja||!Ka||!qa,className:"bg-emerald-600 hover:bg-emerald-700 text-white",children:sl?"جارٍ التنفيذ...":"تأكيد الشحن"})]})]})}),e.jsx(Xt,{open:eo,onOpenChange:ma,mode:"verify",title:"الرقم السري الرئيسي لفتح الديون",description:"أدخل الرقم السري الرئيسي لفتح صفحة الديون",onSuccess:()=>{ma(!1),Ba(!0)}}),e.jsx(Ol,{open:vo,onOpenChange:_r,title:"تأكيد كلمة المرور لتصفير المعاملات الأخيرة",description:"لن يتم حذف الإيصالات؛ سنبدأ القائمة من الآن.",onSuccess:()=>{try{t!=null&&t.uid&&(localStorage.setItem(`recentTransactionsResetAt:${t.uid}`,new Date().toISOString()),l({title:"تم التصفير",description:"تم بدء قائمة المعاملات من الآن."}))}catch{}_r(!1)}}),e.jsx(Xt,{open:fe,onOpenChange:J,mode:"verify",title:"الرقم السري لفتح مصروفات المحل",description:"أدخل الرقم السري الرئيسي لفتح نافذة مصروفات المحل",onSuccess:()=>{J(!1),ee(!0)}}),e.jsx(me,{open:Xi,onOpenChange:Ba,children:e.jsxs(he,{className:"sm:max-w-[425px]",children:[e.jsxs(ue,{className:"flex items-center justify-between",children:[e.jsx(xe,{className:"text-right",children:"إدارة الديون"}),e.jsxs("div",{className:"flex items-center gap-1 text-orange-700",children:[e.jsx(Vc,{className:"h-4 w-4"}),e.jsxs("span",{className:"text-xs font-bold",children:[Jo," جنيه"]})]})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(V,{htmlFor:"debtorName",className:"text-right col-span-1",children:"اسم المديون"}),e.jsx(R,{id:"debtorName",value:Sr,onChange:s=>Rn(s.target.value),className:"col-span-3 text-right",placeholder:"أدخل اسم المديون"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(V,{htmlFor:"debtAmount",className:"text-right col-span-1",children:"المبلغ"}),e.jsx(R,{id:"debtAmount",type:"number",value:Dr,onChange:s=>Un(s.target.value),className:"col-span-3 text-right",placeholder:"أدخل المبلغ"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(V,{htmlFor:"debtReason",className:"text-right col-span-1",children:"سبب الدين"}),e.jsx(R,{id:"debtReason",value:Cr,onChange:s=>_n(s.target.value),className:"col-span-3 text-right",placeholder:"أدخل سبب الدين"})]})]}),e.jsx(Ce,{children:e.jsx(c,{onClick:()=>{if(Sr&&Dr&&Cr){const s={id:Date.now().toString(),debtorName:Sr,amount:parseFloat(Dr),reason:Cr,status:"pending",createdAt:new Date,paidAmount:0,partialPayments:[]};Mr(s),La(!0)}else l({title:"بيانات غير مكتملة",description:"يرجى إدخال الاسم والمبلغ والسبب",variant:"destructive"})},className:"bg-orange-500 hover:bg-orange-600",children:"حفظ"})}),e.jsx("div",{className:"mt-2",children:e.jsx(c,{variant:"outline",className:"w-full",onClick:()=>ua(!0),children:"إيصالات الديون"})}),e.jsx("div",{className:"mt-2",children:e.jsx(c,{variant:"outline",className:"w-full",onClick:()=>Ar(!0),children:"إضافة عميل"})})]})}),e.jsx(me,{open:ao,onOpenChange:ua,children:e.jsxs(he,{className:"sm:max-w-[520px]",children:[e.jsxs(ue,{children:[e.jsx(xe,{className:"text-right",children:"إيصالات الديون"}),e.jsx(Vt,{className:"text-right",children:"اختر دينًا لعرض إيصاله بالتفصيل"})]}),Wt.length>0?e.jsx("div",{className:"max-h-64 overflow-y-auto space-y-2",children:Wt.map(s=>e.jsx("div",{onClick:()=>{Ir(s),ha(!0),ua(!1),Ba(!1)},className:"p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium",children:s.debtorName}),e.jsx("p",{className:"text-sm text-gray-600",children:s.reason}),e.jsx("p",{className:"text-sm text-gray-500",children:rn.format(s.createdAt instanceof Date?s.createdAt:new Date(s.createdAt))})]}),e.jsxs("div",{className:"text-left",children:[e.jsxs("p",{className:"font-bold text-lg",children:[s.amount," جنيه"]}),e.jsx(Nt,{variant:s.status==="paid"?"default":"secondary",className:s.status==="paid"?"bg-green-500":"bg-yellow-500",children:s.status==="paid"?"مدفوع":"قيد المراجعة"})]})]})},s.id))}):e.jsx("div",{className:"text-center text-sm text-gray-500",children:"لا توجد ديون مسجلة"}),e.jsxs(Ce,{className:"flex justify-between mt-3",children:[e.jsx(c,{variant:"destructive",onClick:async()=>{try{if(!Wt||Wt.length===0){l({title:"لا توجد ديون",description:"القائمة فارغة بالفعل."});return}if(!window.confirm("هل تريد حذف كل إيصالات الديون؟ هذا الإجراء لا يمكن التراجع عنه."))return;const r=[];Qt(r),Ir(null),await xs(r),l({title:"تم حذف كل إيصالات الديون",description:"تم تفريغ القائمة بالكامل."}),ua(!1)}catch(s){console.error("تعذر حذف كل إيصالات الديون:",s),l({title:"فشل الحذف",description:"حدث خطأ أثناء الحذف، حاول مرة أخرى.",variant:"destructive"})}},children:"حذف كل الإيصالات"}),e.jsx(c,{variant:"outline",onClick:()=>ua(!1),children:"إغلاق"})]})]})}),e.jsx(me,{open:ro,onOpenChange:Ar,children:e.jsxs(he,{className:"sm:max-w-[480px]",children:[e.jsxs(ue,{children:[e.jsx(xe,{className:"text-right",children:"إضافة عميل"}),e.jsx(Vt,{className:"text-right",children:"أدخل بيانات العميل ثم يمكنك تسجيل مبلغ دين عليه"})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(V,{htmlFor:"customerName",className:"text-right col-span-1",children:"اسم العميل"}),e.jsx(R,{id:"customerName",value:Or,onChange:s=>Jn(s.target.value),className:"col-span-3 text-right",placeholder:"اكتب اسم العميل"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(V,{htmlFor:"customerMobile",className:"text-right col-span-1",children:"رقم الموبايل"}),e.jsx(R,{id:"customerMobile",value:Wr,onChange:s=>Kn(s.target.value),className:"col-span-3 text-right",placeholder:"اكتب رقم الموبايل"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(c,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{if(!Or||!Wr){l({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم العميل ورقم الموبايل",variant:"destructive"});return}const s={id:Date.now().toString(),name:Or.trim(),mobile:Wr.trim(),createdAt:new Date},r=[s,...us];await So(r),Jn(""),Kn(""),l({title:"تمت إضافة العميل",description:`تم إضافة ${s.name}`})},children:"إضافة"})}),e.jsxs("div",{className:"border-t pt-4 space-y-3",children:[e.jsx(V,{className:"text-right block",children:"إضافة مبلغ على عميل"}),us.length>0?e.jsxs("div",{className:"space-y-3",children:[e.jsxs(Es,{value:Fr,onValueChange:qn,children:[e.jsx(Ms,{className:"w-full",children:e.jsx(Bs,{placeholder:"اختر عميل"})}),e.jsx(Ls,{children:us.map(s=>e.jsxs(rs,{value:s.id,children:[s.name," — ",s.mobile]},s.id))})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(V,{htmlFor:"customerDebtAmount",className:"text-right col-span-1",children:"المبلغ"}),e.jsx(R,{id:"customerDebtAmount",type:"number",value:Vn,onChange:s=>Yn(s.target.value),className:"col-span-3 text-right",placeholder:"أدخل المبلغ"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(c,{className:"bg-orange-600 hover:bg-orange-700",onClick:async()=>{const s=parseFloat(Vn);if(!Fr){l({title:"اختر عميل",description:"يرجى اختيار عميل أولاً",variant:"destructive"});return}if(isNaN(s)||s<=0){l({title:"قيمة غير صحيحة",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const r=us.find(d=>d.id===Fr);if(!r)return;const n={id:Date.now().toString(),debtorName:r.name,customerId:r.id,mobile:r.mobile,amount:Number(s.toFixed(2)),reason:"دين عميل",status:"pending",createdAt:new Date,paidAmount:0,partialPayments:[]},o=[...Wt,n];Qt(o),await xs(o),qn(""),Yn(""),l({title:"تم تسجيل المبلغ على العميل",description:`تمت إضافة ${n.amount} جنيه للعميل ${r.name}`})},children:"إضافة المبلغ"})})]}):e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد عملاء مسجلين. أضف عميلًا أولاً."})]})]}),e.jsx(Ce,{className:"flex justify-end",children:e.jsx(c,{variant:"outline",onClick:()=>Ar(!1),children:"إغلاق"})})]})}),e.jsx(me,{open:ae,onOpenChange:ee,children:e.jsxs(he,{className:"sm:max-w-[520px]",children:[e.jsxs(ue,{children:[e.jsx(xe,{className:"text-right",children:"مصروفات المحل"}),e.jsx(Vt,{className:"text-right",children:"أدخل تفاصيل المصروف ثم اختر مصدر الخصم."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(V,{htmlFor:"expenseName",className:"text-right col-span-1",children:"اسم المصروف"}),e.jsx(R,{id:"expenseName",value:A,onChange:s=>ne(s.target.value),className:"col-span-3 text-right",placeholder:"مثال: كهرباء، صيانة، مشتريات"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(V,{htmlFor:"expenseAmount",className:"text-right col-span-1",children:"تمن المصروف"}),e.jsx(R,{id:"expenseAmount",type:"number",value:q,onChange:s=>ie(s.target.value),className:"col-span-3 text-right",placeholder:"0.00"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(V,{htmlFor:"expenseNotes",className:"text-right col-span-1",children:"ملاحظات"}),e.jsx(R,{id:"expenseNotes",value:Pe,onChange:s=>Ve(s.target.value),className:"col-span-3 text-right",placeholder:"معلومات إضافية إن وجدت"})]})]}),e.jsxs(Ce,{className:"flex justify-between",children:[e.jsx(c,{className:"bg-orange-600 hover:bg-orange-700",onClick:()=>{if(!A||!q){l({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم المصروف وقيمته",variant:"destructive"});return}st(!0)},children:"إضافة مصروف"}),e.jsx(c,{variant:"outline",onClick:()=>wt(!0),children:"إيصالات المصاريف"})]})]})}),e.jsx(me,{open:Tt,onOpenChange:wt,children:e.jsxs(he,{className:"sm:max-w-[420px]",dir:"rtl",children:[e.jsxs(ue,{children:[e.jsx(xe,{className:"text-right",children:"إيصالات المصاريف"}),e.jsx(Vt,{className:"text-right",children:"آخر المصاريف المسجلة"})]}),It.length>0?e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:It.map(s=>e.jsx("div",{className:"p-2 border rounded-lg bg-white hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium text-sm",children:s.name}),e.jsx("p",{className:"text-[11px] text-gray-600",children:s.notes||"بدون ملاحظات"}),e.jsx("p",{className:"text-[10px] text-gray-500",children:new Date(s.createdAt).toLocaleString("ar-EG")})]}),e.jsxs("div",{className:"text-left",children:[e.jsxs("p",{className:"font-bold text-sm",children:[s.amount," جنيه"]}),e.jsx(Nt,{variant:"secondary",className:s.source==="cash"?"bg-blue-100 text-blue-700":"bg-purple-100 text-purple-700",children:s.source==="cash"?"من النقدية":`من المحفظة${s.walletId?` (${s.walletId})`:""}`})]})]})},s.id))}):e.jsx("p",{className:"text-sm text-gray-500 text-center",children:"لا توجد مصاريف مسجلة بعد"})]})}),e.jsx(me,{open:$t,onOpenChange:st,children:e.jsxs(he,{className:"sm:max-w-[480px]",children:[e.jsx(ue,{children:e.jsx(xe,{className:"text-right",children:"اختيار مصدر خصم المصروف"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600 text-right",children:"اختر هل تريد خصم مبلغ المصروف من الرصيد النقدي في الدرج أم من إحدى المحافظ."}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsx(c,{variant:lt==="cash"?"default":"outline",className:lt==="cash"?"bg-blue-600 hover:bg-blue-700 text-white":"",onClick:()=>At("cash"),children:"الفلوس النقدية"}),e.jsx(c,{variant:lt==="wallet"?"default":"outline",className:lt==="wallet"?"bg-purple-600 hover:bg-purple-700 text-white":"",onClick:()=>At("wallet"),children:"أرصدة المحافظ"})]}),lt==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{className:"text-right block",children:"اختر المحفظة للخصم"}),e.jsxs(Es,{value:Ye,onValueChange:We,children:[e.jsx(Ms,{className:"w-full",children:e.jsx(Bs,{placeholder:"اختر محفظة"})}),e.jsx(Ls,{children:ye.map(s=>e.jsx(rs,{value:s.id,children:s.phone||s.name||s.id},s.id))})]})]})]}),e.jsxs(Ce,{className:"flex justify-between",children:[e.jsx(c,{variant:"outline",onClick:()=>{st(!1),At(null),We("")},children:"إلغاء"}),e.jsx(c,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{const s=Number(q);if(isNaN(s)||s<=0){l({title:"قيمة غير صحيحة",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}if(!lt){l({title:"اختر مصدر الخصم",description:"يرجى اختيار النقدية أو المحفظة",variant:"destructive"});return}try{if(lt==="cash"){const o=Number((Qe-s).toFixed(2));pt(o),localStorage.setItem(dt(),o.toString());const d={cashBalance:o,lastUpdated:new Date().toISOString()},f=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(f,JSON.stringify(d)),t!=null&&t.uid?(await De.updateUserData(t.uid,d),localStorage.removeItem(f),be(!1)):be(!0)}else if(lt==="wallet"){if(!Ye){l({title:"اختر محفظة",description:"يرجى اختيار محفظة للخصم",variant:"destructive"});return}const o=je[Ye]||0,d=Number((o-s).toFixed(2)),f={...je,[Ye]:d};Ze(f);const v=new Date().toISOString(),j={walletBalances:f,lastUpdated:v},T=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(T,JSON.stringify(j)),localStorage.setItem(ct(),JSON.stringify(f)),localStorage.setItem(`walletBalances_backup_${v}`,JSON.stringify(f)),t!=null&&t.uid&&await De.updateUserData(t.uid,j)}}catch(o){console.error("خطأ أثناء تحديث الأرصدة عند حفظ المصروف:",o)}const r={id:Date.now().toString(),name:A,amount:s,notes:Pe,source:lt,walletId:lt==="wallet"?Ye:void 0,createdAt:new Date},n=[...It,r];await No(n),ne(""),ie(""),Ve(""),At(null),We(""),st(!1),ee(!0),wt(!0),l({title:"تم إضافة المصروف",description:lt==="cash"?"تم الخصم من النقدية":"تم الخصم من أرصدة المحافظ"})},children:"تأكيد الخصم"})]})]})}),e.jsx(me,{open:St,onOpenChange:Rt,children:e.jsxs(he,{className:"sm:max-w-[520px]",children:[e.jsxs(ue,{children:[e.jsx(xe,{className:"text-right",children:"النواقص"}),e.jsx(Vt,{className:"text-right",children:"سجل العناصر الناقصة التي تحتاج شراء وتابع حالتها."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(V,{htmlFor:"deficiencyName",className:"text-right col-span-1",children:"اسم العنصر"}),e.jsx(R,{id:"deficiencyName",value:Ht,onChange:s=>ds(s.target.value),className:"col-span-3 text-right",placeholder:"مثال: سكر، زيت، مناديل"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(V,{htmlFor:"deficiencyQuantity",className:"text-right col-span-1",children:"الكمية"}),e.jsx(R,{id:"deficiencyQuantity",type:"number",value:Et,onChange:s=>P(s.target.value),className:"col-span-3 text-right",placeholder:"1"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(c,{className:"bg-rose-600 hover:bg-rose-700",onClick:()=>{if(Ae){l({title:"غير متاح",description:"النواقص غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"});return}const s=parseInt(Et||"1",10);if(!Ht){l({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم العنصر",variant:"destructive"});return}if(isNaN(s)||s<=0){l({title:"كمية غير صحيحة",description:"يرجى إدخال كمية صحيحة",variant:"destructive"});return}const r={id:Date.now().toString(),name:Ht,quantity:s,status:"pending",createdAt:new Date};pe(n=>{const o=[...n,r];return Kr(o),o}),ds(""),P(""),l({title:"تمت الإضافة",description:"تمت إضافة العنصر إلى قائمة النواقص"})},children:"إضافة للنواقص"})}),re.length>0?e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:re.map(s=>e.jsx("div",{className:"p-2 border rounded-lg bg-white hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium text-sm",children:s.name}),e.jsxs("p",{className:"text-[11px] text-gray-600",children:["الكمية: ",s.quantity]}),e.jsx("p",{className:"text-[10px] text-gray-500",children:new Date(s.createdAt).toLocaleString("ar-EG")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Nt,{variant:"secondary",className:s.status==="pending"?"bg-rose-100 text-rose-700":"bg-green-100 text-green-700",children:s.status==="pending"?"قيد الشراء":"تم الشراء"}),e.jsx(c,{variant:"outline",className:s.status==="pending"?"text-green-700 border-green-300 hover:bg-green-50":"text-rose-700 border-rose-300 hover:bg-rose-50",onClick:()=>{pe(r=>{const n=r.map(o=>o.id===s.id?{...o,status:o.status==="pending"?"purchased":"pending"}:o);return Kr(n),n})},title:s.status==="pending"?"تم الشراء":"إلغاء الشراء",children:s.status==="pending"?"تم الشراء":"إلغاء الشراء"}),e.jsx(c,{variant:"outline",className:"text-red-700 border-red-300 hover:bg-red-50",onClick:()=>{pe(r=>{const n=r.filter(o=>o.id!==s.id);return Kr(n),n})},title:"حذف",children:"حذف"})]})]})},s.id))}):e.jsx("p",{className:"text-sm text-gray-500 text-center",children:"لا توجد عناصر مسجلة في النواقص"})]}),e.jsx(Ce,{className:"flex justify-end",children:e.jsx(c,{variant:"outline",onClick:()=>Rt(!1),children:"إغلاق"})})]})}),e.jsx(me,{open:no,onOpenChange:La,children:e.jsxs(he,{className:"sm:max-w-[480px]",children:[e.jsx(ue,{children:e.jsx(xe,{className:"text-right",children:"اختيار مصدر خصم الدين"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600 text-right",children:"اختر هل تريد خصم مبلغ الدين من الرصيد النقدي في الدرج أم من إحدى المحافظ أو تسجيله بدون خصم."}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsx(c,{variant:Ut==="cash"?"default":"outline",className:Ut==="cash"?"bg-blue-600 hover:bg-blue-700 text-white":"",onClick:()=>xa("cash"),children:"الفلوس النقدية"}),e.jsx(c,{variant:Ut==="wallet"?"default":"outline",className:Ut==="wallet"?"bg-purple-600 hover:bg-purple-700 text-white":"",onClick:()=>xa("wallet"),children:"أرصدة المحافظ"}),e.jsx(c,{variant:Ut==="none"?"default":"outline",className:Ut==="none"?"bg-gray-600 hover:bg-gray-700 text-white":"",onClick:()=>xa("none"),children:"بدون خصم"})]}),Ut==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{className:"text-right block",children:"اختر المحفظة للخصم"}),e.jsxs(Es,{value:$a,onValueChange:Br,children:[e.jsx(Ms,{className:"w-full",children:e.jsx(Bs,{placeholder:"اختر محفظة"})}),e.jsx(Ls,{children:ye.map(s=>e.jsx(rs,{value:s.id,children:s.phone||s.name||s.id},s.id))})]})]})]}),e.jsxs(Ce,{className:"flex justify-between",children:[e.jsx(c,{variant:"outline",onClick:()=>{La(!1),Mr(null),xa(null),Br("")},children:"إلغاء"}),e.jsx(c,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{if(!Er)return;const s=Number(Er.amount);if(!Ut){l({title:"اختر مصدر الخصم",description:"يرجى اختيار النقدية أو المحفظة",variant:"destructive"});return}try{if(Ut==="cash"){const n=Number((Qe-s).toFixed(2));pt(n),localStorage.setItem(dt(),n.toString());const o=new Date().toISOString(),d={cashBalance:n,lastUpdated:o},f=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(f,JSON.stringify(d)),t!=null&&t.uid?await De.updateUserData(t.uid,d).then(()=>{localStorage.removeItem(f),be(!1)}).catch(()=>{be(!0)}):be(!0)}else if(Ut==="wallet"){if(!$a){l({title:"اختر محفظة",description:"يرجى اختيار محفظة للخصم",variant:"destructive"});return}const n=je[$a]||0,o=Number((n-s).toFixed(2)),d={...je,[$a]:o};Ze(d);const f=new Date().toISOString(),v={walletBalances:d,lastUpdated:f},j=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(j,JSON.stringify(v)),localStorage.setItem(ct(),JSON.stringify(d)),localStorage.setItem(`walletBalances_backup_${f}`,JSON.stringify(d)),t!=null&&t.uid&&await De.updateUserData(t.uid,v)}}catch(n){console.error("خطأ أثناء تحديث الأرصدة عند حفظ الدين:",n)}const r=[...Wt,Er];Qt(r),await xs(r),Rn(""),Un(""),_n(""),Ba(!1),La(!1),Mr(null),xa(null),Br(""),l(Ut==="none"?{title:"تم حفظ الدين بدون خصم",description:"لم يتم الخصم من الدرج أو المحافظ"}:{title:"تم حفظ الدين وخصم المبلغ",description:Ut==="cash"?`تم خصم ${s} من الرصيد النقدي`:`تم خصم ${s} من رصيد المحفظة`})},children:"تأكيد الخصم وحفظ الدين"})]})]})}),e.jsx(me,{open:to,onOpenChange:ha,children:e.jsxs(he,{className:"sm:max-w-[425px] z-[60]",children:[e.jsx(ue,{children:e.jsx(xe,{className:"text-right",children:"إيصال الدين"})}),ve&&e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"text-center border-b pb-4",children:[e.jsx("h2",{className:"text-xl font-bold",children:"إيصال دين"}),e.jsx("p",{className:"text-sm text-gray-500",children:rn.format(ve.createdAt instanceof Date?ve.createdAt:new Date(ve.createdAt))})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"اسم المديون:"}),e.jsx("span",{children:ve.debtorName})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"المبلغ:"}),e.jsxs("span",{className:"font-bold text-lg",children:[ve.amount," جنيه"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"سبب الدين:"}),e.jsx("span",{children:ve.reason})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"الحالة:"}),e.jsx(Nt,{variant:ve.status==="paid"?"default":"secondary",className:ve.status==="paid"?"bg-green-500":"bg-yellow-500",children:ve.status==="paid"?"مدفوع":"مؤجل"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"المبلغ المتبقي:"}),e.jsxs("span",{className:"font-bold text-lg",children:[Math.max(0,Number(ve.amount||0)-Number(ve.paidAmount||0))," جنيه"]})]}),ve.paidAmount?e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"إجمالي المدفوع:"}),e.jsxs("span",{className:"text-green-700",children:[ve.paidAmount," جنيه"]})]}):null,e.jsxs("div",{className:"mt-3 p-3 border rounded-lg bg-gray-50",children:[so?e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"partialAmount",className:"text-right block",children:"المبلغ المراد دفعه"}),e.jsx(R,{id:"partialAmount",type:"number",value:zn,onChange:s=>kr(s.target.value),className:"text-right",placeholder:"أدخل المبلغ"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(c,{variant:"outline",onClick:()=>{Tr(!1),kr("")},children:"إلغاء"}),e.jsx(c,{className:"bg-blue-600 hover:bg-blue-700",onClick:async()=>{const s=parseFloat(zn);if(!ve||isNaN(s)||s<=0){l({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const r=Math.max(0,Number(ve.amount||0)-Number(ve.paidAmount||0));if(s>r){l({title:"مبلغ زائد",description:"المبلغ المدفوع أكبر من المتبقي",variant:"destructive"});return}const n=Number(((ve.paidAmount||0)+s).toFixed(2)),o=n>=Number(ve.amount||0),d={...ve,amount:Number(ve.amount||0),paidAmount:n,status:o?"paid":"pending",partialPayments:[...ve.partialPayments||[],{amount:s,paidAt:new Date}]},f=Wt.map(v=>v.id===ve.id?d:v);Qt(f),Ir(d),await xs(f);try{d.status==="paid"&&(t!=null&&t.uid)&&(async()=>{const v=$s(ns(ht,"userTransactions"),Bt("userId","==",t.uid),Bt("linkedDebtId","==",ve.id),Bt("status","==","pending")),j=await Rs(v);await Promise.allSettled(j.docs.map(T=>aa(T.ref,{status:"completed",confirmedAt:new Date})))})().catch(v=>console.error("تعذر تحديث حالة المعاملات المرتبطة بالدين:",v))}catch(v){console.error("تعذر تجهيز تحديث حالة المعاملات المرتبطة:",v)}try{const v=pa(),j=localStorage.getItem(v);if(j){const I=(JSON.parse(j)||[]).map(w=>(w==null?void 0:w.linkedDebtId)===ve.id&&(w==null?void 0:w.status)==="pending"?{...w,status:"completed",confirmedAt:new Date}:w);localStorage.setItem(v,JSON.stringify(I)),ws(w=>w.map(O=>(O==null?void 0:O.linkedDebtId)===ve.id&&(O==null?void 0:O.status)==="pending"?{...O,status:"completed",confirmedAt:new Date}:O))}}catch(v){console.warn("فشل تحديث حالة المعاملات المرتبطة محلياً بعد سداد الدين:",v)}Ra(s),Ps("cash"),Qs(!0),Tr(!1),kr(""),l({title:"تم تسجيل دفع جزء",description:`تم دفع ${s} جنيه بتاريخ ${new Date().toLocaleString("ar-EG")}`})},children:"دفع"})]})]}):e.jsx(c,{variant:"outline",className:"w-full",onClick:()=>Tr(!0),children:"دفع جزء"}),ve.partialPayments&&ve.partialPayments.length>0&&e.jsxs("div",{className:"mt-3 text-xs text-gray-600",children:[e.jsx("p",{className:"font-medium mb-1",children:"سجل الدفعات الجزئية:"}),e.jsx("div",{className:"space-y-1 max-h-24 overflow-y-auto",children:ve.partialPayments.map((s,r)=>e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{children:["دفع: ",s.amount," جنيه"]}),e.jsx("span",{children:new Date(s.paidAt).toLocaleString("ar-EG")})]},r))})]})]})]})]}),e.jsxs(Ce,{className:"flex gap-2 justify-center",children:[e.jsx(c,{onClick:async()=>{if(ve){const s=Wt.map(r=>r.id===ve.id?{...r,status:"pending"}:r);Qt(s),await xs(s),ha(!1),l({title:"تم تحديث حالة الدين",description:"تم تعيين الدين كمؤجل"})}},variant:"outline",className:"bg-yellow-500 hover:bg-yellow-600 text-white",children:"مؤجل"}),e.jsx(c,{onClick:async()=>{if(ve){const r=Math.max(0,Number(ve.amount||0)-Number(ve.paidAmount||0)),n=Wt.map(o=>o.id===ve.id?{...o,amount:Number(o.amount||0),paidAmount:Number(((o.paidAmount||0)+r).toFixed(2)),status:"paid",partialPayments:[...o.partialPayments||[],...r>0?[{amount:r,paidAt:new Date}]:[]]}:o);Qt(n),r>0&&(Ra(r),Ps("cash"),Qs(!0)),await xs(n);try{t!=null&&t.uid&&(ve!=null&&ve.id)&&(async()=>{const o=$s(ns(ht,"userTransactions"),Bt("userId","==",t.uid),Bt("linkedDebtId","==",ve.id),Bt("status","==","pending")),d=await Rs(o);await Promise.allSettled(d.docs.map(f=>aa(f.ref,{status:"completed",confirmedAt:new Date})))})().catch(o=>console.error("تعذر تحديث حالة المعاملات المرتبطة بالدين:",o))}catch(o){console.error("تعذر تجهيز تحديث حالة المعاملات المرتبطة:",o)}try{const o=pa(),d=localStorage.getItem(o);if(d){const v=(JSON.parse(d)||[]).map(j=>(j==null?void 0:j.linkedDebtId)===ve.id&&(j==null?void 0:j.status)==="pending"?{...j,status:"completed",confirmedAt:new Date}:j);localStorage.setItem(o,JSON.stringify(v)),ws(j=>j.map(T=>(T==null?void 0:T.linkedDebtId)===ve.id&&(T==null?void 0:T.status)==="pending"?{...T,status:"completed",confirmedAt:new Date}:T))}}catch(o){console.warn("فشل تحديث حالة المعاملات المرتبطة محلياً بعد سداد الدين:",o)}ha(!1),l({title:"تم تحديث حالة الدين",description:"تم تعيين الدين كمدفوع"})}},className:"bg-green-500 hover:bg-green-600",children:"مدفوع"}),e.jsx(c,{onClick:async()=>{if(ve){const s=Wt.filter(r=>r.id!==ve.id);Qt(s),await xs(s),ha(!1),l({title:"تم حذف الدين",description:"تم حذف الدين بنجاح"})}},variant:"destructive",children:"حذف"})]})]})}),e.jsx(me,{open:lo,onOpenChange:Qs,children:e.jsxs(he,{className:"sm:max-w-[425px]",children:[e.jsxs(ue,{children:[e.jsx(xe,{className:"text-right",children:"اختيار إضافة مبلغ السداد"}),e.jsx(Vt,{className:"text-right",children:"هل تريد إضافة مبلغ السداد إلى الفلوس النقدية أم إلى إحدى المحافظ؟"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(c,{variant:ss==="cash"?"default":"outline",className:ss==="cash"?"bg-blue-600 text-white":"",onClick:()=>Ps("cash"),children:"الفلوس النقدية"}),e.jsx(c,{variant:ss==="wallet"?"default":"outline",className:ss==="wallet"?"bg-blue-600 text-white":"",onClick:()=>Ps("wallet"),children:"أرصدة المحافظ"}),e.jsx(c,{variant:ss==="none"?"default":"outline",className:ss==="none"?"bg-gray-600 text-white":"",onClick:()=>Ps("none"),children:"بدون إضافة"})]}),ss==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-right",children:"اختر المحفظة"}),e.jsxs("select",{className:"w-full border rounded p-2 text-right",value:Os,onChange:s=>Lr(s.target.value),children:[e.jsx("option",{value:"",children:"— اختر محفظة —"}),ye&&ye.length>0?ye.map(s=>e.jsx("option",{value:s.id,children:s.phone||s.name||s.id},s.id)):Object.keys(je||{}).map(s=>{var r,n,o,d,f,v;return e.jsx("option",{value:s,children:((r=ye.find(j=>j.id===s))==null?void 0:r.phone)||((o=(n=JSON.parse(localStorage.getItem(Zs())||"[]"))==null?void 0:n.find(j=>j.id===s))==null?void 0:o.phone)||((f=(d=JSON.parse(localStorage.getItem(Zs())||"[]"))==null?void 0:d.find(j=>j.id===s))==null?void 0:f.name)||((v=ye.find(j=>j.id===s))==null?void 0:v.name)||s},s)})]})]}),e.jsxs("div",{className:"text-right text-sm text-gray-600",children:["المبلغ المراد إضافته: ",e.jsxs("span",{className:"font-bold",children:[Hn," جنيه"]})]})]}),e.jsxs(Ce,{className:"flex justify-end",children:[e.jsx(c,{variant:"outline",onClick:()=>{Qs(!1),Ra(0),Ps(null),Lr("")},children:"إلغاء"}),e.jsx(c,{onClick:async()=>{var s,r;try{const n=Hn;if(!n||n<=0){Qs(!1);return}if(ss==="cash"){const o=Qe+n;pt(o),localStorage.setItem(dt(),o.toString());const d={cashBalance:o,lastUpdated:new Date().toISOString()},f=`userData_${t==null?void 0:t.uid}`;localStorage.setItem(f,JSON.stringify(d)),t!=null&&t.uid?(De.updateUserData(t.uid,d).catch(()=>be(!0)),localStorage.removeItem(f),be(!1)):be(!0),l({title:"تمت إضافة مبلغ السداد",description:`تمت إضافة ${n} جنيه إلى الفلوس النقدية`})}else if(ss==="wallet"){if(!Os){l({title:"اختر محفظة أولاً",description:"يرجى اختيار المحفظة لإضافة مبلغ السداد إليها",variant:"destructive"});return}const o={...je,[Os]:(je[Os]||0)+n};Ze(o);const d=(Qe||0)-n;pt(d),localStorage.setItem(dt(),d.toString());const f=new Date().toISOString(),v={walletBalances:o,cashBalance:d,lastUpdated:f},j=`userData_${t==null?void 0:t.uid}`;if(localStorage.setItem(j,JSON.stringify(v)),localStorage.setItem(ct(),JSON.stringify(o)),localStorage.setItem(`walletBalances_backup_${f}`,JSON.stringify(o)),t!=null&&t.uid){De.updateUserData(t.uid,v).catch(()=>be(!0));try{localStorage.removeItem(j)}catch{}be(!1)}else be(!0);l({title:"تمت إضافة مبلغ السداد",description:`تمت إضافة ${n} جنيه إلى المحفظة ${((s=ye.find(T=>T.id===Os))==null?void 0:s.phone)||((r=ye.find(T=>T.id===Os))==null?void 0:r.name)||Os} وتم خصم نفس المبلغ من درج النقدية`})}else if(ss==="none"){const o=(Qe||0)-n;pt(o),localStorage.setItem(dt(),o.toString());const d={cashBalance:o,lastUpdated:new Date().toISOString()},f=`userData_${t==null?void 0:t.uid}`;if(localStorage.setItem(f,JSON.stringify(d)),t!=null&&t.uid){De.updateUserData(t.uid,d).catch(()=>be(!0));try{localStorage.removeItem(f)}catch{}be(!1)}else be(!0);l({title:"تم تسجيل السداد",description:`تم خصم ${n} جنيه من درج النقدية بدون إضافة للمحافظ`})}else{l({title:"اختر مصدر الإضافة",description:"يرجى اختيار إضافة المبلغ إلى النقدية أو المحفظة",variant:"destructive"});return}}catch(n){console.error("خطأ أثناء إضافة مبلغ السداد:",n),l({title:"حدث خطأ",description:"تعذر إضافة مبلغ السداد، حاول مرة أخرى",variant:"destructive"})}finally{Qs(!1),Ra(0),Ps(null),Lr("")}},className:"bg-green-600 hover:bg-green-700",children:"تأكيد الإضافة"})]})]})}),e.jsx(me,{open:_i,onOpenChange:Oa,children:e.jsxs(he,{hideClose:!0,className:"sm:max-w-[420px] w-[90vw] rounded-2xl bg-gradient-to-br from-white via-indigo-50 to-blue-50 shadow-2xl border border-indigo-100",children:[e.jsxs(ue,{children:[e.jsx(xe,{className:"text-right text-2xl font-bold",children:(yt==null?void 0:yt.type)==="transfer"?"مبلغ يجب استلامه":"مبلغ يجب تسليمه"}),e.jsx(Vt,{className:"text-right text-gray-600",children:(yt==null?void 0:yt.type)==="transfer"?"هذا هو المبلغ الواجب استلامه من العميل بعد التأكيد.":"هذا هو المبلغ الواجب تسليمه للعميل بعد التأكيد."})]}),e.jsxs("div",{className:"py-4 flex flex-col items-center gap-2",children:[e.jsxs("div",{className:"text-4xl font-extrabold text-blue-700 tracking-wider",children:[yt==null?void 0:yt.amount," جنيه"]}),e.jsx("div",{className:"text-sm text-gray-500 text-right w-full",children:(yt==null?void 0:yt.type)==="transfer"?"المبلغ المعروض شامل عمولة التحويل.":se?"العمولة مضافة ولا تؤثر على قيمة التسليم.":"العمولة مخصومة من المبلغ المسلّم للعميل."})]}),e.jsxs(Ce,{className:"flex justify-end gap-2",children:[(yt==null?void 0:yt.type)==="transfer"&&e.jsx(c,{variant:"outline",onClick:async()=>{if(!ca||!ca.receiver||!ca.amount){l({title:"بيانات غير مكتملة",description:"تأكد من إدخال رقم المستقبل والمبلغ قبل الإرسال",variant:"destructive"});return}Bn(!0);try{(await Rd({receiver:ca.receiver,amount:ca.amount,deviceId:"R5CN504731B"})).success&&l({title:"✅ تم إرسال كود التحويل إلى الموبايل بنجاح"})}catch{}finally{Bn(!1)}},disabled:Mn,children:Mn?"جارٍ إرسال USSD...":"إرسال كود التحويل"}),e.jsx(c,{onClick:()=>{Oa(!1),jr(null)},className:"bg-green-600 hover:bg-green-700 text-white",children:(yt==null?void 0:yt.type)==="transfer"?"تم الاستلام":"تم التسليم"})]})]})})]}))};export{$m as default};
