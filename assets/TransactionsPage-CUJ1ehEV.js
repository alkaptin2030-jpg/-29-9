const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./dailyOperationCountService-CGiiympf.js","./index-5EflPS7Y.js","./index-DTUj2xQR.css","./walletDailyLimitsService-Byppxers.js","./profitService-B_O8unCh.js"])))=>i.map(i=>d[i]);
import{J as is,r as m,a6 as ls,j as t,a1 as cs,a3 as Te,a4 as Ee,as as ds,Y as Ge,u as bt,B as T,p as mt,C as ze,aD as y,z as we,ar as ms,a as us,R as _e,aE as ps,ab as hs,v as Q,f as k,w as Me,q as B,e as z,an as M,g as ee,aF as xs,ay as V,aG as ne,_ as fs,aa as Le,K as te,I as We,aq as ut,aH as gs,aI as bs,d as Fe,aJ as pt,a9 as J,O as Be}from"./index-5EflPS7Y.js";import{C as vs,a as ys,b as js,d as Ns}from"./card-DXPppts9.js";import{D as Ue,a as $e,b as Ve,c as qe,e as ws}from"./dialog-CY7KVlhj.js";import{u as Ts,S as Cs,a as Ds,b as As,c as Ss,d as je}from"./select-3q_346E_.js";import{B as Ne}from"./badge-DZ4fmRLR.js";import{c as vt,R as Rs,I as Ps}from"./index-BCcWEWHS.js";import{u as ks}from"./Combination-vrlhZqzc.js";import{A as ht,a as xt,C as Is,b as Os,f as L,M as Es,c as _s,R as Ms}from"./MaintenanceDialog-xOpK61Iw.js";import{M as yt,P as Ls}from"./MasterPinDialog-DQOde7Hj.js";import{r as ft,P as oe}from"./profitService-B_O8unCh.js";import{D as Ws}from"./dollar-sign-Cmw8CMzs.js";import{C as jt}from"./calendar-BU1uXyDN.js";import{A as Fs}from"./arrow-left-BVSspWOA.js";import{S as Bs}from"./separator-CyutvTNL.js";import{T as gt}from"./progress-CZ6HS10G.js";import{C as zs}from"./circle-x-BJ7R2vQm.js";import{C as Us}from"./circle-check-big-DzztOUK9.js";import"./index-R9UGA7TY.js";import"./whatsappService-e_9Fvgqq.js";import"./download-BQPqh6Fo.js";import"./label-BbMWBagC.js";import"./circle-alert-L2Owt6-y.js";import"./shield-Aq4l2F3b.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $s=is("BatteryCharging",[["path",{d:"M15 7h1a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2h-2",key:"1sdynx"}],["path",{d:"M6 7H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h1",key:"1gkd3k"}],["path",{d:"m11 7-3 5h4l-3 5",key:"b4a64w"}],["line",{x1:"22",x2:"22",y1:"11",y2:"13",key:"4dh1rd"}]]);var Ce="Tabs",[Vs]=cs(Ce,[vt]),Nt=vt(),[qs,Xe]=Vs(Ce),wt=m.forwardRef((h,s)=>{const{__scopeTabs:x,value:f,onValueChange:A,defaultValue:S,orientation:C="horizontal",dir:W,activationMode:j="automatic",...I}=h,D=Ts(W),[N,_]=ls({prop:f,onChange:A,defaultProp:S??"",caller:Ce});return t.jsx(qs,{scope:x,baseId:ks(),value:N,onValueChange:_,orientation:C,dir:D,activationMode:j,children:t.jsx(Te.div,{dir:D,"data-orientation":C,...I,ref:s})})});wt.displayName=Ce;var Tt="TabsList",Ct=m.forwardRef((h,s)=>{const{__scopeTabs:x,loop:f=!0,...A}=h,S=Xe(Tt,x),C=Nt(x);return t.jsx(Rs,{asChild:!0,...C,orientation:S.orientation,dir:S.dir,loop:f,children:t.jsx(Te.div,{role:"tablist","aria-orientation":S.orientation,...A,ref:s})})});Ct.displayName=Tt;var Dt="TabsTrigger",At=m.forwardRef((h,s)=>{const{__scopeTabs:x,value:f,disabled:A=!1,...S}=h,C=Xe(Dt,x),W=Nt(x),j=Pt(C.baseId,f),I=kt(C.baseId,f),D=f===C.value;return t.jsx(Ps,{asChild:!0,...W,focusable:!A,active:D,children:t.jsx(Te.button,{type:"button",role:"tab","aria-selected":D,"aria-controls":I,"data-state":D?"active":"inactive","data-disabled":A?"":void 0,disabled:A,id:j,...S,ref:s,onMouseDown:Ee(h.onMouseDown,N=>{!A&&N.button===0&&N.ctrlKey===!1?C.onValueChange(f):N.preventDefault()}),onKeyDown:Ee(h.onKeyDown,N=>{[" ","Enter"].includes(N.key)&&C.onValueChange(f)}),onFocus:Ee(h.onFocus,()=>{const N=C.activationMode!=="manual";!D&&!A&&N&&C.onValueChange(f)})})})});At.displayName=Dt;var St="TabsContent",Rt=m.forwardRef((h,s)=>{const{__scopeTabs:x,value:f,forceMount:A,children:S,...C}=h,W=Xe(St,x),j=Pt(W.baseId,f),I=kt(W.baseId,f),D=f===W.value,N=m.useRef(D);return m.useEffect(()=>{const _=requestAnimationFrame(()=>N.current=!1);return()=>cancelAnimationFrame(_)},[]),t.jsx(ds,{present:A||D,children:({present:_})=>t.jsx(Te.div,{"data-state":D?"active":"inactive","data-orientation":W.orientation,role:"tabpanel","aria-labelledby":j,hidden:!_,id:I,tabIndex:0,...C,ref:s,style:{...h.style,animationDuration:N.current?"0s":void 0},children:_&&S})})});Rt.displayName=St;function Pt(h,s){return`${h}-trigger-${s}`}function kt(h,s){return`${h}-content-${s}`}var Gs=wt,It=Ct,Ot=At,Et=Rt;const Xs=Gs,_t=m.forwardRef(({className:h,...s},x)=>t.jsx(It,{ref:x,className:Ge("inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",h),...s}));_t.displayName=It.displayName;const ie=m.forwardRef(({className:h,...s},x)=>t.jsx(Ot,{ref:x,className:Ge("inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm",h),...s}));ie.displayName=Ot.displayName;const le=m.forwardRef(({className:h,...s},x)=>t.jsx(Et,{ref:x,className:Ge("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",h),...s}));le.displayName=Et.displayName;const Js=({userId:h,transactions:s=[]})=>{const[x,f]=m.useState(!1),[A,S]=m.useState(!1),[C,W]=m.useState(!1),[j,I]=m.useState({dailyWithdraw:0,dailyTransfer:0,monthlyWithdraw:0,monthlyTransfer:0,lastUpdated:new Date}),{userSubscription:D}=bt();m.useEffect(()=>{h&&x&&C&&Y()},[h,x,C]);const N=g=>`${g.toFixed(2)} ج.م`,_=async()=>{try{const g=(D==null?void 0:D.subscription)||null,R=(g==null?void 0:g.planType)??(g==null?void 0:g.plan)??null,F=typeof R=="string"?R.toLowerCase():null;if(R===we.ZERO||F==="zero"||F==="0"||R===0)return!0}catch{}try{if(h){const g=await ms(h),R=(g==null?void 0:g.planType)??(g==null?void 0:g.plan)??null,F=typeof R=="string"?R.toLowerCase():null;if(R===we.ZERO||F==="zero"||F==="0"||R===0)return!0}}catch{}return!1},se=async()=>{try{if(await _()){y({title:"الخطة زيرو",description:"عرض إجمالي الأرباح غير متاح في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}catch{}S(!0)},De=async()=>{try{if(await _()){y({title:"الخطة زيرو",description:"عرض إجمالي الأرباح غير متاح في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"}),S(!1);return}}catch{}W(!0),f(!0),S(!1)},Y=async()=>{if(h)try{if(Array.isArray(s)&&s.length>0){const R=new Date,F=R.getMonth(),Ae=R.getFullYear(),q=ft.filterVisibleTransactions(s,"daily",h),ce=ft.filterVisibleTransactions(s,"monthly",h);let U=0,de=0,$=0,me=0;q.forEach(O=>{const Z=new Date(O.createdAt),H=String(O.status||"confirmed").toLowerCase();if(Z.toDateString()!==R.toDateString()||H!=="completed"&&H!=="confirmed")return;const G=(O.type||O.txnType||"").toLowerCase(),E={type:G==="withdrawal"?"withdraw":G,amount:Number(O.amount||0),commission:O.commission};E.type==="withdraw"?U+=oe.calculateProfitFromTransaction(E):(E.type==="send"||E.type==="receive"||E.type==="transfer")&&(de+=oe.calculateProfitFromTransaction(E))}),ce.forEach(O=>{const Z=new Date(O.createdAt),H=String(O.status||"confirmed").toLowerCase();if(Z.getMonth()!==F||Z.getFullYear()!==Ae||H!=="completed"&&H!=="confirmed")return;const G=(O.type||O.txnType||"").toLowerCase(),E={type:G==="withdrawal"?"withdraw":G,amount:Number(O.amount||0),commission:O.commission};E.type==="withdraw"?$+=oe.calculateProfitFromTransaction(E):(E.type==="send"||E.type==="receive"||E.type==="transfer")&&(me+=oe.calculateProfitFromTransaction(E))}),I({dailyWithdraw:Math.round(U*100)/100,dailyTransfer:Math.round(de*100)/100,monthlyWithdraw:Math.round($*100)/100,monthlyTransfer:Math.round(me*100)/100,lastUpdated:new Date});return}const g=oe.getWithdrawTransferProfits(h);I({dailyWithdraw:g.dailyWithdrawProfit||0,dailyTransfer:g.dailyTransferProfit||0,monthlyWithdraw:g.monthlyWithdrawProfit||0,monthlyTransfer:g.monthlyTransferProfit||0,lastUpdated:new Date})}catch(g){console.error("Error loading total profits:",g)}};return t.jsxs(t.Fragment,{children:[t.jsx(T,{size:"sm",variant:"ghost",onClick:se,className:"h-2 w-2 p-0 bg-gradient-to-r from-blue-100 to-purple-200 text-purple-700 hover:from-blue-200 hover:to-purple-300 hover:text-purple-800 rounded transition-all duration-300 hover:scale-110 shadow-sm hover:shadow-md",title:"عرض إجمالي الأرباح",children:t.jsx(mt,{className:"h-1.5 w-1.5"})}),t.jsx(Ue,{open:x,onOpenChange:f,children:t.jsxs($e,{className:"max-w-[240px] mx-auto bg-white border border-gray-200 shadow-md rounded sm:max-w-[220px] sm:bg-gradient-to-br sm:from-purple-50 sm:to-white sm:border-2 sm:border-purple-200 sm:shadow-2xl sm:rounded-2xl",children:[t.jsx(Ve,{className:"text-center pb-0 border-b-0 sm:pb-2 sm:border-b sm:border-purple-200",children:t.jsxs(qe,{className:"text-xs font-bold text-purple-800 flex items-center justify-center gap-1 mb-0 leading-tight tracking-tight sm:text-xs sm:gap-1 sm:mb-0 sm:leading-normal sm:tracking-normal",children:[t.jsx(Ws,{className:"h-2 w-2 text-purple-600 sm:h-3 sm:w-3"}),"إجمالي الأرباح (فوري)"]})}),t.jsxs("div",{className:"space-y-1 py-1 sm:space-y-2 sm:py-2",children:[t.jsxs("div",{className:"bg-blue-50 p-1 rounded border border-blue-200 sm:bg-gradient-to-r sm:from-blue-50 sm:to-blue-100 sm:p-2 sm:rounded-xl sm:shadow-sm",children:[t.jsxs("div",{className:"flex items-center justify-between mb-1",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(ze,{className:"h-2 w-2 text-blue-600"}),t.jsx("span",{className:"text-[10px] font-semibold text-blue-800",children:"يومي"})]}),t.jsx("span",{className:"text-[10px] font-bold text-blue-900",children:N((j.dailyWithdraw??0)+(j.dailyTransfer??0))})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-1",children:[t.jsxs("div",{className:"flex items-center justify-between bg-red-50 p-0.5 rounded border border-red-200",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(ht,{className:"h-2 w-2 text-red-600"}),t.jsx("span",{className:"text-[10px] text-red-800",children:"سحب"})]}),t.jsx("span",{className:"text-[10px] font-bold text-red-700",children:N(j.dailyWithdraw)})]}),t.jsxs("div",{className:"flex items-center justify-between bg-green-50 p-0.5 rounded border border-green-200",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(xt,{className:"h-2 w-2 text-green-600"}),t.jsx("span",{className:"text-[10px] text-green-800",children:"تحويل"})]}),t.jsx("span",{className:"text-[10px] font-bold text-green-700",children:N(j.dailyTransfer)})]})]})]}),t.jsxs("div",{className:"bg-purple-50 p-1 rounded border border-purple-200 sm:bg-gradient-to-r sm:from-purple-50 sm:to-purple-100 sm:p-2 sm:rounded-xl sm:shadow-sm",children:[t.jsxs("div",{className:"flex items-center justify-between mb-1",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(jt,{className:"h-2 w-2 text-purple-600"}),t.jsx("span",{className:"text-[10px] font-semibold text-purple-800",children:"شهري"})]}),t.jsx("span",{className:"text-[10px] font-bold text-purple-900",children:N((j.monthlyWithdraw??0)+(j.monthlyTransfer??0))})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-1",children:[t.jsxs("div",{className:"flex items-center justify-between bg-red-50 p-0.5 rounded border border-red-200",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(ht,{className:"h-2 w-2 text-red-600"}),t.jsx("span",{className:"text-[10px] text-red-800",children:"سحب"})]}),t.jsx("span",{className:"text-[10px] font-bold text-red-700",children:N(j.monthlyWithdraw)})]}),t.jsxs("div",{className:"flex items-center justify-between bg-blue-50 p-0.5 rounded border border-blue-200",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(xt,{className:"h-2 w-2 text-blue-600"}),t.jsx("span",{className:"text-[10px] text-blue-800",children:"تحويل"})]}),t.jsx("span",{className:"text-[10px] font-bold text-blue-700",children:N(j.monthlyTransfer)})]})]})]})]}),!C&&t.jsx("div",{className:"absolute inset-0 bg-yellow-200/70 backdrop-blur-sm flex items-center justify-center rounded sm:rounded-2xl border border-yellow-300 pointer-events-auto",children:t.jsx(T,{size:"sm",variant:"ghost",onClick:()=>S(!0),className:"p-2 bg-yellow-300/80 text-yellow-900 hover:bg-yellow-400/90 rounded-full shadow-sm hover:shadow-md transition-all duration-300",title:"إدخال الرقم السري الرئيسي",children:t.jsx(mt,{className:"h-4 w-4"})})}),t.jsx("div",{className:"flex justify-center pt-1 border-t-0 sm:pt-2 sm:border-t sm:border-purple-200",children:t.jsx(T,{onClick:()=>f(!1),className:"bg-purple-600 hover:bg-purple-700 text-white px-4 py-1 rounded-xl text-xs sm:bg-gradient-to-r sm:from-purple-600 sm:to-purple-700 sm:hover:from-purple-700 sm:hover:to-purple-800 sm:px-4 sm:py-1 sm:rounded-xl sm:shadow-lg sm:hover:shadow-xl sm:transition-all sm:duration-300",children:"إغلاق"})})]})}),t.jsx(yt,{open:A,onOpenChange:S,onSuccess:De,description:"لا يمكن الاطلاع على إجمالي الأرباح إلا بإدخال الرقم السري الرئيسي"})]})},Ys=h=>t.jsx(Js,{...h}),ya=()=>{var it,lt,ct,dt;const h=us(),{user:s,profile:x,userSubscription:f}=bt(),A=_e.useMemo(()=>{var l,n,r,a;const e=((l=f==null?void 0:f.subscription)==null?void 0:l.planType)??((n=f==null?void 0:f.subscription)==null?void 0:n.plan)??((r=x==null?void 0:x.subscription)==null?void 0:r.planType)??((a=x==null?void 0:x.subscription)==null?void 0:a.plan)??null;return e===we.ZERO||String(e).toLowerCase()==="zero"},[(it=f==null?void 0:f.subscription)==null?void 0:it.planType,(lt=f==null?void 0:f.subscription)==null?void 0:lt.plan,(ct=x==null?void 0:x.subscription)==null?void 0:ct.planType,(dt=x==null?void 0:x.subscription)==null?void 0:dt.plan]),{shopName:S}=ps(),{isShiftActive:C,shiftUser:W}=hs(),[j,I]=m.useState([]),[D,N]=m.useState([]),[_,se]=m.useState(new Set),[De,Y]=m.useState(!1),[g,R]=m.useState(null),[F,Ae]=m.useState("all"),[q,ce]=m.useState(""),[U,de]=m.useState(""),[$,me]=m.useState(""),[O,Z]=m.useState(!1),[H,G]=m.useState(!1),[E,Mt]=m.useState(!1),[Zs,Lt]=m.useState(!1),[Wt,Se]=m.useState(!1),[Ft,Je]=m.useState(!1),[Bt,Ye]=m.useState(!1),[zt,Re]=m.useState(!1),[Ut,$t]=m.useState(null),[Vt,ue]=m.useState(!1),[K,pe]=m.useState({keepLastCount:30,intervalDays:7,lastResetAt:null});m.useEffect(()=>{(async()=>{if(s!=null&&s.uid)try{const l=await V.getUserData(s.uid),n=(l==null?void 0:l.recentReset)||{},r=Number(n==null?void 0:n.keepLastCount)>0?Number(n.keepLastCount):30,a=Number(n==null?void 0:n.intervalDays)>0?Number(n.intervalDays):7,o=c=>c instanceof Date?c:typeof(c==null?void 0:c.toDate)=="function"?c.toDate():c?new Date(String(c)):null,u=n!=null&&n.lastResetAt?o(n.lastResetAt):null,i=new Date;!u||i.getTime()-u.getTime()>=a*24*60*60*1e3?(await V.updateUserData(s.uid,{recentReset:{keepLastCount:r,intervalDays:a,lastResetAt:i}}),pe({keepLastCount:r,intervalDays:a,lastResetAt:i})):pe({keepLastCount:r,intervalDays:a,lastResetAt:u})}catch{pe({keepLastCount:30,intervalDays:7,lastResetAt:null})}})()},[s==null?void 0:s.uid]);const[qt,he]=m.useState(!1),[xe,Ze]=m.useState(""),[ae,He]=m.useState(""),[fe,Ke]=m.useState(""),[Qe,et]=m.useState(!1),[tt,ge]=m.useState(0);m.useEffect(()=>{if(!(s!=null&&s.uid)){ge(0);return}const e=Q(k,"users",s.uid),l=Me(e,n=>{try{const r=n.exists()?n.data():{},o=(Array.isArray(r==null?void 0:r.debts)?r.debts:[]).filter(u=>(u==null?void 0:u.status)==="pending"&&(Number(u==null?void 0:u.amount)||0)>0).length;ge(o)}catch{ge(0)}},n=>{console.warn("فشل الاشتراك في ديون المستخدم من Firestore:",n),ge(0)});return()=>l()},[s==null?void 0:s.uid]),m.useEffect(()=>{Gt(),Xt()},[s]),m.useEffect(()=>{(async()=>{try{if(!(s!=null&&s.uid)){se(new Set);return}const e=B(z(k,"deletedTransactions"),M("userId","==",s.uid),M("permanent","==",!0)),n=(await ee(e)).docs.flatMap(r=>{const a=r.data();return[a.originalTransactionId,a.transactionId,a.reference,r.id].filter(Boolean).map(String)});se(new Set(n))}catch{se(new Set)}})()},[s==null?void 0:s.uid]),m.useEffect(()=>{(async()=>{try{if(!(s!=null&&s.uid))return;const l=new Date;if(l.getDate()!==1)return;const n=`${l.getFullYear()}-${l.getMonth()+1}`,r=`lastMonthlyDbCleanup:${s.uid}`;if(localStorage.getItem(r)===n)return;const o=new Date(l.getFullYear(),l.getMonth(),1,0,0,0,0),u=c=>c instanceof Date?c:typeof(c==null?void 0:c.toDate)=="function"?c.toDate():new Date(String(c));let i=[];try{const c=B(z(k,"userTransactions"),M("userId","==",s.uid),M("createdAt","<",o));i=(await ee(c)).docs}catch{const c=B(z(k,"userTransactions"),M("userId","==",s.uid));i=(await ee(c)).docs.filter(b=>{var v;return u((v=b.data())==null?void 0:v.createdAt)<o})}await Promise.allSettled(i.map(c=>pt(c.ref)));let d=[];try{const c=B(z(k,"transactions"),M("userId","==",s.uid),M("createdAt","<",o));d=(await ee(c)).docs}catch{const c=B(z(k,"transactions"),M("userId","==",s.uid));d=(await ee(c)).docs.filter(b=>{var v;return u((v=b.data())==null?void 0:v.createdAt)<o})}await Promise.allSettled(d.map(c=>pt(c.ref)));try{localStorage.setItem(r,n)}catch{}console.log("✅ تنظيف شهري (TransactionsPage):",{userTransactionsDeleted:i.length,globalTransactionsDeleted:d.length,monthStart:o})}catch(l){console.error("فشل التنظيف الشهري التلقائي (TransactionsPage):",l)}})()},[s==null?void 0:s.uid]),m.useEffect(()=>{if(!(s!=null&&s.uid))return;let e=null,l=!1;const n=a=>{const u=a.map(i=>{const d=i.data(),c=d==null?void 0:d.createdAt,p=c!=null&&c.toDate?c.toDate():c instanceof Date?c:new Date(c);return{id:i.id,...d,createdAt:p}}).filter(i=>(i==null?void 0:i.status)!=="cancelled"&&!(i!=null&&i.isDeleted)).filter(i=>!((i==null?void 0:i.type)==="report"||((i==null?void 0:i.title)||"").includes("إيصال تسليم وردية"))).sort((i,d)=>{const c=i.createdAt?new Date(i.createdAt).getTime():0;return(d.createdAt?new Date(d.createdAt).getTime():0)-c}).filter(i=>{const d=String(i.id||""),c=String(i.transactionId||""),p=String(i.reference||i.transactionReference||"");return!_.has(d)&&(!c||!_.has(c))&&(!p||!_.has(p))});I(u.map(ke))},r=()=>{const a=B(z(k,"userTransactions"),M("userId","==",s.uid));e=Me(a,o=>{try{n(o.docs)}catch(u){console.error("خطأ في معالجة بيانات الاشتراك الاحتياطي:",u)}},o=>{console.error("خطأ في الاشتراك الاحتياطي لمعاملات المستخدم:",o)})};(async()=>{try{const a=B(z(k,"userTransactions"),M("userId","==",s.uid)),o=await xs(a);if(o&&o.docs&&o.docs.length>0)try{n(o.docs)}catch{}}catch{}})();try{const a=B(z(k,"userTransactions"),M("userId","==",s.uid));e=Me(a,{includeMetadataChanges:!0},o=>{try{n(o.docs)}catch(u){console.error("خطأ في معالجة بيانات الاشتراك:",u)}},o=>{if(console.error("خطأ في الاشتراك لمعاملات المستخدم:",o),!l){l=!0;try{e&&e()}catch{}r()}})}catch(a){console.error("فشل إعداد الاشتراك الفوري لمعاملات المستخدم، بدء السقوط الاحتياطي:",a),r()}return()=>{try{e&&e()}catch{}}},[s==null?void 0:s.uid]);const Gt=async()=>{try{if(!s)return;const e=await V.getUserTransactions(s.uid);let l=[];try{const o=B(z(k,"deletedTransactions"),M("userId","==",s.uid),M("permanent","==",!0));l=(await ee(o)).docs.flatMap(i=>{const d=i.data();return[d.originalTransactionId,d.transactionId,d.reference,i.id].filter(Boolean).map(String)})}catch{}const n=new Set(l),a=e.map(o=>({...o,createdAt:o.createdAt instanceof Date?o.createdAt:new Date(o.createdAt)})).filter(o=>!((o==null?void 0:o.type)==="report"||((o==null?void 0:o.title)||"").includes("إيصال تسليم وردية"))).filter(o=>{const u=String(o.id||""),i=String(o.transactionId||""),d=String(o.reference||o.transactionReference||"");return!n.has(u)&&(!i||!n.has(i))&&(!d||!n.has(d))});I(a.map(ke))}catch(e){console.error("خطأ في تحميل معاملات المستخدم من Firestore:",e),y({title:"فشل جلب معاملات المستخدم",description:"قد تكون المشكلة صلاحيات Firestore أو اتصال الشبكة. سيتم عرض المتاح محليًا إن وُجد. جرّب تسجيل الدخول مجددًا أو افتح صفحة اختبار المصادقة.",variant:"destructive"})}},Xt=async()=>{try{if(!s)return;const l=(await ne.getDeletedTransactionsByUser(s.uid)).map(n=>({...n,createdAt:n.createdAt instanceof Date?n.createdAt:new Date(n.createdAt)}));N(l.map(ke))}catch(e){console.error("خطأ في تحميل المعاملات المحذوفة من Firestore:",e),y({title:"فشل جلب المعاملات المحذوفة",description:"تحقق من الصلاحيات والاتصال. يمكن مراجعة صفحة اختبار المصادقة للتشخيص.",variant:"destructive"})}},re=_e.useMemo(()=>{const e=K.keepLastCount??30;return[...j].sort((n,r)=>r.createdAt.getTime()-n.createdAt.getTime()).slice(0,e)},[j,K.keepLastCount]),Jt=_e.useMemo(()=>Math.max(0,((j==null?void 0:j.length)||0)-(K.keepLastCount||30)),[j==null?void 0:j.length,K.keepLastCount]),st=re.filter(e=>{const l=!q||e.senderPhone.includes(q)||e.receiverPhone.includes(q),n=!U||e.createdAt.toDateString()===new Date(U).toDateString(),r=!$||e.createdAt.toTimeString().startsWith($);return l&&n&&r}),be=(e,l)=>{switch(e){case"completed":return t.jsx(Us,{className:`h-4 w-4 ${l==="withdraw"?"text-red-500":"text-green-500"}`});case"pending":return t.jsx(ze,{className:"h-4 w-4 text-yellow-500"});case"cancelled":return t.jsx(zs,{className:"h-4 w-4 text-red-500"});default:return t.jsx(ze,{className:"h-4 w-4 text-gray-500"})}},Pe=e=>{switch(e){case"completed":return"مكتمل";case"pending":return"قيد المراجعة";case"cancelled":return"ملغي";default:return"غير معروف"}},ke=e=>{const l=((e==null?void 0:e.status)??"").toString().toLowerCase(),n=l==="confirmed"||l==="success"||l==="completed"?"completed":l==="failed"||l==="error"||l==="cancelled"||l==="canceled"?"cancelled":"pending",a=((e==null?void 0:e.type)??(e==null?void 0:e.txnType)??"").toString().toLowerCase()==="withdraw"?"withdraw":"send",o=(e==null?void 0:e.senderPhone)??(e==null?void 0:e.senderMsisdn)??(e==null?void 0:e.sender_msisdn)??(e==null?void 0:e.sender)??(e==null?void 0:e.from)??"",u=(e==null?void 0:e.receiverPhone)??(e==null?void 0:e.receiverMsisdn)??(e==null?void 0:e.receiver_msisdn)??(e==null?void 0:e.receiver)??(e==null?void 0:e.to)??"",i=e==null?void 0:e.createdAt,d=i instanceof Date?i:i!=null&&i.toDate?i.toDate():new Date(i);return{id:e==null?void 0:e.id,senderPhone:o||"غير معروف",receiverPhone:u||"غير معروف",amount:Number((e==null?void 0:e.amount)??0),status:n,type:a,createdAt:d,commission:(e==null?void 0:e.commission)??void 0,withdrawnAmount:(e==null?void 0:e.withdrawnAmount)??void 0,sentAmount:(e==null?void 0:e.sentAmount)??void 0,fromWallet:(e==null?void 0:e.fromWallet)??(e==null?void 0:e.walletId)??void 0,cashierName:(e==null?void 0:e.cashierName)??(e==null?void 0:e.createdByName)??(e==null?void 0:e.cashier)??void 0,commissionMode:(e==null?void 0:e.commissionMode)??(e==null?void 0:e.commission_mode)??void 0,totalCharged:(e==null?void 0:e.totalCharged)??void 0,walletEffectAppliedOnCreation:(e==null?void 0:e.walletEffectAppliedOnCreation)??(e==null?void 0:e.effectsAppliedOnCreation)??(e==null?void 0:e.effectAppliedOnCreation)??!1,fee:(e==null?void 0:e.fee)??void 0}},Yt=e=>({id:e.id,type:e.type==="send"?"transfer":"withdraw",sender_msisdn:e.senderPhone,receiver_msisdn:e.receiverPhone,amount:e.amount,commission:e.commission||0,status:e.status==="cancelled"?"failed":e.status,createdAt:e.createdAt.toISOString(),updatedAt:e.createdAt.toISOString(),shopName:S??(x==null?void 0:x.shopName)??(s==null?void 0:s.displayName)??"المحل",cashierName:(e==null?void 0:e.cashierName)??null,commissionMode:(e==null?void 0:e.commissionMode)??void 0,totalCharged:(e==null?void 0:e.totalCharged)??void 0,fee:(e==null?void 0:e.fee)??void 0,note:(e==null?void 0:e.note)??(e==null?void 0:e.notes)??void 0}),Ie=e=>{const l=Yt(e);$t(l),Re(!0)},Zt=e=>{R(e),Y(!0)},Ht=async()=>{g&&(await Kt(g.id),Y(!1),R(null))},Kt=async e=>{try{const l=D.find(a=>a.id===e);if(!l||!s)return;const n=await V.saveUserTransaction(s.uid,{...l,userId:s.uid,status:"completed",cashierName:l.cashierName??"الحساب الرئيسي"});await ne.permanentlyDeleteTransaction(e,s.uid);const r={...l,id:n};I(a=>[...a,r]),N(a=>a.filter(o=>o.id!==e)),y({title:"تم الاسترجاع",description:"تم استرجاع الإيصال إلى حسابك."})}catch(l){console.error("خطأ في استرجاع المعاملة من Firestore:",l),y({title:"فشل الاسترجاع",description:"تحقق من الاتصال ثم أعد المحاولة.",variant:"destructive"})}},Qt=async e=>{try{if(!s)return;N(l=>l.filter(n=>n.id!==e)),await ne.permanentlyDeleteTransaction(e,s.uid),await V.removeUserTransaction(s.uid,e),y({title:"تم الحذف نهائيًا",description:"الإيصال لن يعود بعد التحديث."})}catch(l){console.error("فشل الحذف النهائي للمعاملة:",l),y({title:"خطأ في الحذف النهائي",description:"تحقق من الاتصال ثم أعد المحاولة.",variant:"destructive"})}},at=async e=>{var l,n,r;try{const a=j.find(p=>p.id===e);if(!a||!s)return;try{if(((l=f==null?void 0:f.subscription)==null?void 0:l.planType)===we.ZERO){const{dailyOperationCountService:b}=await J(async()=>{const{dailyOperationCountService:P}=await import("./dailyOperationCountService-CGiiympf.js");return{dailyOperationCountService:P}},__vite__mapDeps([0,1,2]),import.meta.url),v=a.type==="send"?"transfer":"withdraw";if(!(await b.checkAndIncrement(s.uid,v,5)).allowed){y({title:"تم بلوغ حد باقة الزيرو",description:"مسموح بحد أقصى 5 تأكيدات يوميًا للتحويل/السحب. جرّب غدًا أو قم بالترقية.",variant:"destructive"});return}}}catch(p){console.warn("تعذر التحقق من حد التأكيد اليومي:",p)}const o=await Le.getById(s.uid);if(!(o!=null&&o.shopId))throw new Error("لا يمكن تحديد معرف المتجر (shopId) للمستخدم");const u=Q(k,"dashboardData",o.shopId),i=await te(u);let d=i.exists()?Number(((n=i.data())==null?void 0:n.cashBalance)||0):0,c=i.exists()?((r=i.data())==null?void 0:r.walletBalances)||{}:{};if(a.type==="withdraw"){const p=a.fromWallet||Object.keys(c)[0],b=Number(a.withdrawnAmount??a.amount??0),v=Number(a.commission??0);if(!!!(a!=null&&a.walletEffectAppliedOnCreation)&&p&&b>0){const P=c[p]||0;c[p]=P+b}d=d-b+v,await Be(u,{cashBalance:d,walletBalances:c})}await Be(Q(k,"userTransactions",e),{status:"completed",confirmedAt:new Date}),I(p=>p.map(b=>b.id===e?{...b,status:"completed"}:b)),y({title:"تم الإكمال",description:"تم وسم المعاملة كمكتملة."}),Re(!1)}catch(a){console.error("خطأ في إكمال المعاملة:",a),y({title:"فشل الإكمال",description:"تحقق من الاتصال ثم أعد المحاولة.",variant:"destructive"})}},rt=async e=>{var l,n;try{const r=j.find(a=>a.id===e);if(!r||!s)return;I(a=>a.filter(o=>o.id!==e)),N(a=>[{...r},...a]);try{let a={};try{const d=await te(Q(k,"userTransactions",e));a=d.exists()?d.data():{}}catch{}const o=e,u=String((a==null?void 0:a.transactionId)||(r==null?void 0:r.transactionId)||o),i=String((a==null?void 0:a.reference)||(a==null?void 0:a.transactionReference)||(r==null?void 0:r.reference)||(r==null?void 0:r.transactionReference)||"");await V.removeUserTransaction(s.uid,e),await ne.saveDeletedTransaction({...r,userId:s.uid,originalTransactionId:e,transactionId:u,reference:i||void 0,permanent:!0});try{await ne.permanentlyDeleteTransaction(e,s.uid)}catch{}}catch(a){console.warn("تعذر الحذف النهائي من قواعد البيانات في هذه الخطوة، سيتم الحذف من لائحة المحذوفات عند التنفيذ اليدوي للحذف النهائي:",a)}try{const a=await Le.getById(s.uid);if(!(a!=null&&a.shopId))throw new Error("لا يمكن تحديد معرف المتجر (shopId) للمستخدم");const o=Q(k,"dashboardData",a.shopId),u=await te(o);let i=u.exists()?Number(((l=u.data())==null?void 0:l.cashBalance)||0):0,d=u.exists()?((n=u.data())==null?void 0:n.walletBalances)||{}:{};const c=Number(r.withdrawnAmount??r.amount??0),p=Number(r.commission??0),b=r.fromWallet||Object.keys(d)[0],v=!!(r!=null&&r.walletEffectAppliedOnCreation);if(r.type==="send"){const w=Number(r.fee??0),P=p+w;if(i-=P,b&&c>0){const X=d[b]||0;d[b]=X+c}}else if(r.type==="withdraw"){if(r.status==="completed"){if(i=i+c-p,b&&c>0){const w=d[b]||0;d[b]=w-c}}else if(b&&v&&c>0){const w=d[b]||0;d[b]=w-c}}await Be(o,{cashBalance:i,walletBalances:d})}catch(a){console.warn("فشل عكس تأثير الأرصدة محليًا:",a)}try{const a=r.fromWallet;if(a){const{walletDailyLimitsService:o}=await J(async()=>{const{walletDailyLimitsService:i}=await import("./walletDailyLimitsService-Byppxers.js");return{walletDailyLimitsService:i}},__vite__mapDeps([3,1,2]),import.meta.url),u=await o.getWalletLimits(a);if(u){const i=r.type==="send",d={updatedAt:(await J(async()=>{const{serverTimestamp:w}=await import("./index-5EflPS7Y.js").then(P=>P.bg);return{serverTimestamp:w}},__vite__mapDeps([1,2]),import.meta.url)).serverTimestamp()};i?(d.dailyTransferUsed=Math.max(0,(u.dailyTransferUsed||0)-r.amount),d.monthlyTransferUsed=Math.max(0,(u.monthlyTransferUsed||0)-r.amount)):(d.dailyWithdrawUsed=Math.max(0,(u.dailyWithdrawUsed||0)-r.amount),d.monthlyWithdrawUsed=Math.max(0,(u.monthlyWithdrawUsed||0)-r.amount));const{doc:c,setDoc:p}=await J(async()=>{const{doc:w,setDoc:P}=await import("./index-5EflPS7Y.js").then(X=>X.bg);return{doc:w,setDoc:P}},__vite__mapDeps([1,2]),import.meta.url),{db:b}=await J(async()=>{const{db:w}=await import("./index-5EflPS7Y.js").then(P=>P.bh);return{db:w}},__vite__mapDeps([1,2]),import.meta.url),v=c(b,"walletLimits",a);await p(v,d,{merge:!0})}}}catch(a){console.warn("فشل استرجاع حدود المحفظة:",a)}try{const{ProfitService:a}=await J(async()=>{const{ProfitService:c}=await import("./profitService-B_O8unCh.js").then(p=>p.p);return{ProfitService:c}},__vite__mapDeps([4,1,2]),import.meta.url),{ReportsService:o}=await J(async()=>{const{ReportsService:c}=await import("./profitService-B_O8unCh.js").then(p=>p.a);return{ReportsService:c}},__vite__mapDeps([4,1,2]),import.meta.url),i={txnType:r.type==="send"?"send":"receive",amount:r.amount,commission:r.commission||0,createdAt:r.createdAt,status:"confirmed"},d=a.calculateProfitFromTransaction(i);d>0&&a.addProfit(-d,s.uid);try{o.removeTransactionEffects(r,s.uid)}catch{}}catch(a){console.warn("فشل تحديث التقارير/الأرباح بعد الحذف:",a)}}catch(r){console.error("خطأ أثناء حذف الإيصال:",r)}},nt=m.useRef(!1),ot=fs();m.useEffect(()=>{!(new URLSearchParams(ot.search).get("autoTestBalances")==="1")||nt.current||(nt.current=!0,(async()=>{var n,r,a,o,u,i;try{if(!s)return;const d=await Le.getById(s.uid);if(!(d!=null&&d.shopId)){console.warn("autoTest: لا يوجد shopId للمستخدم، سيتم إيقاف الاختبار.");return}const c=Q(k,"dashboardData",d.shopId),p=await te(c),b=p.exists()?Number(((n=p.data())==null?void 0:n.cashBalance)||0):0,v=p.exists()?((r=p.data())==null?void 0:r.walletBalances)||{}:{},w=Object.keys(v)[0]||void 0,P=100,X=5,Oe=await V.saveUserTransaction(s.uid,{senderPhone:"auto-test-sender",receiverPhone:"auto-test-receiver",amount:P,status:"pending",type:"withdraw",createdAt:new Date,reference:`AUTO-${Date.now()}`,commission:X,withdrawnAmount:P,fromWallet:w,cashierName:"AutoTest",commissionMode:"add",totalCharged:P+X,walletEffectAppliedOnCreation:!1});console.log("autoTest: تم إنشاء إيصال سحب تجريبي:",Oe),await at(Oe);const ve=await te(c),ts=ve.exists()?Number(((a=ve.data())==null?void 0:a.cashBalance)||0):0,ss=ve.exists()?((o=ve.data())==null?void 0:o.walletBalances)||{}:{},as=b-P+X,rs=w?Number(v[w]||0)+P:void 0;console.log("autoTest: توقع الدرج بعد الإكمال:",as,"فعلي:",ts),w&&console.log("autoTest: توقع المحفظة بعد الإكمال:",rs,"فعلي:",ss[w]),await rt(Oe);const ye=await te(c),ns=ye.exists()?Number(((u=ye.data())==null?void 0:u.cashBalance)||0):0,os=ye.exists()?((i=ye.data())==null?void 0:i.walletBalances)||{}:{};console.log("autoTest: تحقق نهائي — الدرج قبل/بعد الحذف:",b,ns),w&&console.log("autoTest: تحقق نهائي — المحفظة قبل/بعد الحذف:",v[w]||0,os[w]||0),y({title:"اختبار الأرصدة (Firestore فقط)",description:"تم إنشاء/إكمال/حذف إيصال تجريبي والتحقق من الأرصدة.",variant:"default"})}catch(d){console.error("autoTest: فشل اختبار الأرصدة:",d),y({title:"فشل اختبار الأرصدة",description:"تحقق من الاتصال ووجود shopId والمحافظ في Firestore.",variant:"destructive"})}})())},[ot.search,s]);const es=async()=>{var n,r,a;const e="alkaptin678678@gmail.com",l=(r=(n=Fe.currentUser)==null?void 0:n.email)==null?void 0:r.toLowerCase();if(!l||l!==e){y({title:"قيد الإنشاء",description:"ميزة الشحن متاحة لهذا الحساب فقط حالياً."});return}if(!xe||!ae||!fe){y({title:"بيانات ناقصة",description:"يرجى إدخال رقم وشركة والمبلغ",variant:"destructive"});return}et(!0);try{const u={vodafone_eg:"Vodafone",orange_eg:"Orange",etisalat_eg:"Etisalat",we_eg:"WE"}[ae]??ae,i=new AbortController,d=setTimeout(()=>i.abort(),15e3),c=await((a=Fe.currentUser)==null?void 0:a.getIdToken()),p=await fetch("/api/topup",{method:"POST",headers:{"Content-Type":"application/json",...c?{Authorization:`Bearer ${c}`}:{}},body:JSON.stringify({phone:xe,countryCode:"EG",operator:u,amount:Number(fe),useLocalAmount:!0}),signal:i.signal});clearTimeout(d);const b=await p.text();let v;try{v=JSON.parse(b)}catch{v={success:!1,message:b||"فشل قراءة استجابة الخادم"}}p.ok&&(v!=null&&v.success)?(y({title:"تم الشحن",description:(v==null?void 0:v.message)||"تم تنفيذ عملية الشحن بنجاح"}),he(!1),Ze(""),He(""),Ke("")):y({title:"فشل الشحن",description:(v==null?void 0:v.message)||"حدث خطأ أثناء طلب الشحن",variant:"destructive"})}catch(o){console.error("Topup request error:",o),(o==null?void 0:o.name)==="AbortError"?y({title:"انتهت المهلة",description:"الخادم لم يستجب في الوقت المحدد. تأكد أن السيرفر يعمل.",variant:"destructive"}):y({title:"خطأ في الاتصال",description:"تعذر الاتصال بالخادم. حاول لاحقاً.",variant:"destructive"})}finally{et(!1)}};return t.jsxs("div",{className:"fixed inset-0 overscroll-y-none overflow-y-auto bg-background p-4",children:[t.jsxs("div",{className:"max-w-4xl mx-auto",children:[t.jsxs("div",{className:"flex items-center gap-4 mb-6",children:[t.jsxs(T,{variant:"ghost",size:"sm",onClick:()=>h("/user/dashboard"),className:"flex items-center gap-2 text-gray-600 hover:text-gray-800",children:[t.jsx(Fs,{className:"h-4 w-4"}),"العودة"]}),t.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:"المعاملات"})]}),t.jsxs(vs,{className:"card-modern fade-in-up",children:[t.jsxs(ys,{className:"pb-2 px-3 pt-3",children:[t.jsx(js,{className:"text-sm font-bold",children:"المعاملات الأخيرة"}),t.jsxs("div",{className:"flex items-center gap-0.5 mt-1 relative",children:[t.jsxs("div",{className:"flex items-center gap-0.5 flex-1 bg-gray-50 rounded px-1 py-0.5 border border-gray-200 hover:border-blue-300 transition-all duration-200 group relative overflow-hidden max-w-[140px] md:max-w-[220px]",children:[t.jsx(Bs,{className:"h-2 w-2 text-gray-400 group-hover:text-blue-600 transition-colors"}),t.jsx(We,{placeholder:"بحث...",value:q,onChange:e=>ce(e.target.value),className:"h-3 text-[8px] border-0 bg-transparent focus:ring-0 focus:outline-none text-gray-700 placeholder:text-gray-400"})]}),t.jsxs("div",{className:"hidden md:flex items-center gap-1",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(Ys,{userId:s==null?void 0:s.uid,transactions:j}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"أرباح"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(T,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 rounded bg-emerald-50 text-emerald-600 hover:bg-emerald-100 border border-emerald-200 hover:border-emerald-300 transition-all duration-200 hover:scale-105",onClick:()=>{y({title:"قيد الإنشاء",description:"هذه الميزة قيد الإنشاء حالياً."})},title:"نافذة شحن سريعة",children:t.jsx(ut,{className:"h-2.5 w-2.5"})}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"شحن"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(T,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 rounded bg-blue-50 text-blue-600 hover:bg-blue-100 border border-blue-200 hover:border-blue-300 transition-all duration-200 hover:scale-105",onClick:()=>Z(!0),title:"آلة حاسبة",children:t.jsx(Is,{className:"h-2.5 w-2.5"})}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"حاسبة"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(T,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 rounded bg-green-50 text-green-600 hover:bg-green-100 border border-green-200 hover:border-green-300 transition-all duration-200 hover:scale-105",onClick:()=>{if(A){y({title:"الخطة الحالية لا تسمح",description:"بيانات المبيعات غير متاحة في خطة زيرو. قم بالترقية."});return}G(!0)},title:"بيانات المبيعات",children:t.jsx(Os,{className:"h-2.5 w-2.5"})}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"مبيعات"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsxs(T,{variant:"ghost",size:"sm",className:`h-5 w-5 p-0 rounded border transition-all duration-200 hover:scale-105 ${U||$?"bg-purple-100 text-purple-600 border-purple-300":"bg-purple-50 text-purple-600 hover:bg-purple-100 border-purple-200 hover:border-purple-300"}`,onClick:()=>Mt(!0),title:"اختيار التاريخ",children:[t.jsx(jt,{className:"h-2.5 w-2.5"}),(U||$)&&t.jsx("div",{className:"absolute -top-0.5 -right-0.5 h-1 w-1 bg-purple-500 rounded-full"})]}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"تاريخ"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(T,{variant:"ghost",size:"sm",className:"relative h-5 w-5 p-0 rounded bg-orange-50 text-orange-600 hover:bg-orange-100 border border-orange-200 hover:border-orange-300 transition-all duration-200 hover:scale-105",onClick:()=>{if(A){y({title:"الخطة الحالية لا تسمح",description:"إدارة الديون غير متاحة في خطة زيرو. قم بالترقية."});return}Se(!0)},title:"إدارة الديون",children:t.jsxs("div",{className:"relative inline-flex items-center justify-center h-full w-full",children:[t.jsx(gs,{className:"h-2.5 w-2.5"}),tt>0&&t.jsx("div",{className:"absolute -top-1 -right-1 z-10 min-w-[12px] h-[12px] px-[2px] bg-red-600 text-white rounded-full text-[8px] leading-[12px] flex items-center justify-center pointer-events-none ring-1 ring-white",children:tt})]})}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"ديون"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(T,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 rounded bg-amber-50 text-amber-700 hover:bg-amber-100 border border-amber-200 hover:border-amber-300 transition-all duration-200 hover:scale-105",onClick:()=>{if(A){y({title:"الخطة الحالية لا تسمح",description:"الصيانة غير متاحة في خطة زيرو. قم بالترقية."});return}Ye(!0)},title:"الصيانة",children:t.jsx(bs,{className:"h-2.5 w-2.5"})}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"صيانه"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(T,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 rounded bg-violet-50 text-violet-600 hover:bg-violet-100 border border-violet-200 hover:border-violet-300 transition-all duration-200 hover:scale-105",onClick:()=>{h("/user/dashboard",{state:{openCashierShiftModal:!0}})},title:"يومية المكنة",children:t.jsx($s,{className:"h-2.5 w-2.5"})}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"المكنة"})]}),t.jsxs("div",{className:"hidden sm:flex items-center gap-1",children:[t.jsx(T,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 rounded bg-indigo-50 text-indigo-600 hover:bg-indigo-100 border border-indigo-200 hover:border-indigo-300 transition-all duration-200 hover:scale-105",onClick:()=>{if(A){y({title:"الخطة الحالية لا تسمح",description:"الفيز الائتمانية غير متاحة في خطة زيرو. قم بالترقية."});return}Je(!0)},title:"الفيز الائتمانية",children:t.jsx(ut,{className:"h-2.5 w-2.5"})}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"فيز"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsxs(T,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 rounded bg-red-50 text-red-600 hover:bg-red-100 border border-red-200 hover:border-red-300 transition-all duration-200 hover:scale-105 relative",onClick:()=>{ue(!0)},title:"تصفير المعاملات الأخيرة",children:[t.jsx(gt,{className:"h-2.5 w-2.5"}),Jt>0&&t.jsx("div",{className:"absolute -top-0.5 -right-0.5 h-1 w-1 bg-red-500 rounded-full"})]}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"تصفير"})]}),(q||U||$)&&t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(T,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 rounded bg-red-50 text-red-500 hover:bg-red-100 border border-red-200 hover:border-red-300 transition-all duration-200 hover:scale-105",onClick:()=>{ce(""),de(""),me("")},title:"مسح",children:t.jsx("span",{className:"text-[10px] font-bold",children:"×"})}),t.jsx("span",{className:"text-[10px] font-bold text-gray-700",children:"مسح"})]})]})]})]}),t.jsx(Ns,{className:"px-3 pb-3",children:t.jsxs(Xs,{value:F,onValueChange:Ae,className:"w-full",children:[t.jsxs(_t,{className:"hidden sm:grid w-full grid-cols-4 h-10 text-sm bg-gradient-to-r from-gray-50 via-blue-50/30 to-purple-50/30 border border-gray-200/60 rounded-md p-1 shadow-sm relative overflow-hidden",children:[t.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-blue-500/5 via-purple-500/5 to-pink-500/5 opacity-0 hover:opacity-100 transition-all duration-200"}),t.jsxs(ie,{value:"all",className:"text-sm relative z-10 rounded transition-all duration-300  data-[state=active]:bg-gradient-to-r data-[state=active]:from-blue-500 data-[state=active]:to-blue-600 data-[state=active]:text-white data-[state=active]:shadow-md data-[state=active]:shadow-blue-200/50 hover:bg-blue-50/80 hover:text-blue-700 group",children:[t.jsx("span",{className:"relative z-10",children:"الكل"}),t.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-blue-500/10 to-purple-500/10 opacity-0 group-hover:opacity-100 transition-all duration-300 rounded"})]}),t.jsxs(ie,{value:"send",className:"text-sm relative z-10 rounded transition-all duration-300  data-[state=active]:bg-gradient-to-r data-[state=active]:from-green-500 data-[state=active]:to-emerald-600 data-[state=active]:text-white data-[state=active]:shadow-md data-[state=active]:shadow-green-200/50 hover:bg-green-50/80 hover:text-green-700 group",children:[t.jsx("span",{className:"relative z-10",children:"مرسل"}),t.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-green-500/10 to-emerald-500/10 opacity-0 group-hover:opacity-100 transition-all duration-300 rounded"})]}),t.jsxs(ie,{value:"withdraw",className:"text-sm relative z-10 rounded transition-all duration-300  data-[state=active]:bg-gradient-to-r data-[state=active]:from-orange-500 data-[state=active]:to-amber-600 data-[state=active]:text-white data-[state=active]:shadow-md data-[state=active]:shadow-orange-200/50 hover:bg-orange-50/80 hover:text-orange-700 group",children:[t.jsx("span",{className:"relative z-10",children:"سحب"}),t.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-orange-500/10 to-amber-500/10 opacity-0 group-hover:opacity-100 transition-all duration-300 rounded"})]}),t.jsxs(ie,{value:"deleted",className:"text-sm relative z-10 rounded transition-all duration-300  data-[state=active]:bg-gradient-to-r data-[state=active]:from-red-500 data-[state=active]:to-rose-600 data-[state=active]:text-white data-[state=active]:shadow-md data-[state=active]:shadow-red-200/50 hover:bg-red-50/80 hover:text-red-700 group",children:[t.jsx("span",{className:"relative z-10",children:"محذوف"}),t.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-red-500/10 to-rose-500/10 opacity-0 group-hover:opacity-100 transition-all duration-300 rounded"})]})]}),t.jsx(le,{value:"all",className:"mt-2 receipts-list",children:st.length===0?t.jsx("div",{className:"text-center py-4 text-gray-500 fade-in-up tab-stagger-item text-[10px]",children:"لا توجد معاملات محفوظة بعد"}):t.jsx("div",{className:"space-y-1 fade-in-up tab-content-smooth max-h-[600px] overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400",children:st.map((e,l)=>t.jsxs("div",{className:"receipts-row flex items-center justify-between p-3 bg-white rounded-lg border hover:shadow-md cursor-pointer transition-all duration-200",onClick:()=>Ie(e),children:[t.jsxs("div",{className:"flex items-center gap-1",children:[be(e.status,e.type),t.jsxs("div",{children:[t.jsx("p",{className:`font-medium text-sm ${e.type==="withdraw"?"text-red-700":"text-green-700"}`,children:e.type==="withdraw"?e.receiverPhone:`${e.senderPhone} → ${e.receiverPhone}`}),e.type==="withdraw"&&t.jsxs(t.Fragment,{children:[t.jsxs("p",{className:"text-sm font-semibold text-red-600",children:[L(e.amount)," جنيه"]}),t.jsxs("p",{className:"text-xs text-red-600",children:["عمولة: ",L(e.commission||0)," جنيه"]})]}),t.jsxs("p",{className:`text-[10px] ${e.type==="withdraw"?"text-red-700":"text-green-700"}`,children:["تمت بواسطة: ",e.cashierName??"الحساب الرئيسي"]}),t.jsx("p",{className:`text-sm ${e.type==="withdraw"?"text-red-500":"text-green-600"}`,children:e.createdAt.toLocaleString("en-GB")})]})]}),t.jsxs("div",{className:"text-right",children:[e.type!=="withdraw"&&t.jsxs("p",{className:"font-bold text-sm text-green-700",children:[L(e.amount)," جنيه"]}),e.withdrawnAmount&&t.jsxs("p",{className:"text-sm text-red-600",children:["مسحوب: ",L(e.withdrawnAmount)," جنيه"]}),e.sentAmount&&t.jsxs("p",{className:"text-sm text-green-600",children:["مرسل: ",L(e.sentAmount)," جنيه"]}),t.jsx(Ne,{variant:e.status==="completed"?"default":"secondary",className:`text-sm ${e.status==="completed"?e.type==="withdraw"?"bg-red-100 text-red-800 border-red-300":e.type==="send"?"bg-green-100 text-green-800 border-green-300":"":e.type==="withdraw"?"bg-red-100 text-red-800":""}`,children:e.type==="withdraw"?"سحب":Pe(e.status)})]})]},e.id))})}),t.jsx(le,{value:"send",className:"mt-2 receipts-list",children:re.filter(e=>e.type==="send").length===0?t.jsx("div",{className:"text-center py-4 text-gray-500 fade-in-up tab-stagger-item text-[10px]",children:"لا توجد معاملات إرسال محفوظة بعد"}):t.jsx("div",{className:"space-y-1 fade-in-up tab-content-smooth max-h-[600px] overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400",children:re.filter(e=>e.type==="send").map((e,l)=>t.jsxs("div",{className:"receipts-row flex items-center justify-between p-3 rounded-lg border cursor-pointer transition-all duration-200",onClick:()=>Ie(e),children:[t.jsxs("div",{className:"flex items-center gap-1",children:[be(e.status,e.type),t.jsxs("div",{children:[t.jsxs("p",{className:"font-medium text-sm text-green-700",children:[e.senderPhone," → ",e.receiverPhone]}),t.jsxs("p",{className:"text-[10px] text-green-700",children:["تمت بواسطة: ",e.cashierName??"الحساب الرئيسي"]}),t.jsx("p",{className:"text-sm text-green-600",children:e.createdAt.toLocaleString("ar-EG")})]})]}),t.jsxs("div",{className:"text-right",children:[t.jsxs("p",{className:"font-bold text-sm text-green-700",children:[L(e.amount)," جنيه"]}),e.sentAmount&&t.jsxs("p",{className:"text-sm text-green-600",children:["مرسل: ",L(e.sentAmount)," جنيه"]}),t.jsx(Ne,{variant:e.status==="completed"?"default":"secondary",className:`text-sm ${e.status==="completed"?"bg-green-100 text-green-800 border-green-300":""}`,children:Pe(e.status)})]})]},e.id))})}),t.jsx(le,{value:"withdraw",className:"mt-2 receipts-list",children:re.filter(e=>e.type==="withdraw").length===0?t.jsx("div",{className:"text-center py-4 text-gray-500 fade-in-up tab-stagger-item text-[10px]",children:"لا توجد معاملات سحب محفوظة بعد"}):t.jsx("div",{className:"space-y-1 max-h-[600px] overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400",children:re.filter(e=>e.type==="withdraw").map((e,l)=>t.jsxs("div",{className:"receipts-row flex items-center justify-between p-3 rounded-lg border cursor-pointer",onClick:()=>Ie(e),children:[t.jsxs("div",{className:"flex items-center gap-1",children:[be(e.status,e.type),t.jsxs("div",{children:[t.jsx("p",{className:"font-medium text-sm text-red-700",children:e.receiverPhone}),t.jsxs("p",{className:"text-[10px] text-red-700",children:["تمت بواسطة: ",e.cashierName??"الحساب الرئيسي"]}),t.jsx("p",{className:"text-sm text-red-500",children:e.createdAt.toLocaleString("ar-EG")})]})]}),t.jsxs("div",{className:"text-right",children:[t.jsxs("p",{className:"font-bold text-sm text-red-700",children:[L(e.amount)," جنيه"]}),e.withdrawnAmount&&t.jsxs("p",{className:"text-sm text-red-600",children:["مسحوب: ",L(e.withdrawnAmount)," جنيه"]}),t.jsx(Ne,{variant:e.status==="completed"?"default":"secondary",className:`text-sm ${e.status==="completed"?"bg-red-100 text-red-800 border-red-300":"bg-red-100 text-red-800"}`,children:Pe(e.status)})]})]},e.id))})}),t.jsx(le,{value:"deleted",className:"mt-2",children:D.length===0?t.jsx("div",{className:"text-center py-4 text-gray-500 fade-in-up tab-stagger-item text-[10px]",children:"لا توجد معاملات محذوفة"}):t.jsx("div",{className:"space-y-1 max-h-[600px] overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400",children:D.map((e,l)=>t.jsxs("div",{className:"receipts-row flex items-center justify-between p-3 rounded-lg border",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[be(e.status,e.type),t.jsxs("div",{children:[t.jsx("p",{className:"font-medium text-sm text-red-700",children:e.type==="withdraw"?e.receiverPhone:`${e.senderPhone} → ${e.receiverPhone}`}),e.type==="withdraw"&&t.jsxs(t.Fragment,{children:[t.jsxs("p",{className:"text-sm font-semibold text-red-600",children:[L(e.amount)," جنيه"]}),t.jsxs("p",{className:"text-xs text-orange-500",children:["عمولة: ",L(e.commission||0)," جنيه"]})]}),t.jsxs("p",{className:"text-[10px] text-red-700",children:["تمت بواسطة: ",e.cashierName??"الحساب الرئيسي"]}),t.jsx("p",{className:"text-sm text-red-500",children:e.createdAt.toLocaleString("ar-EG")})]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("div",{className:"text-right mr-2",children:[e.type!=="withdraw"&&t.jsxs("p",{className:"font-bold text-sm text-red-700",children:[L(e.amount)," جنيه"]}),t.jsx(Ne,{variant:"secondary",className:"text-[10px] bg-red-100 text-red-800",children:"محذوف"})]}),t.jsx(T,{variant:"ghost",size:"sm",className:"text-green-600 hover:bg-green-100 h-10 sm:h-12 px-4 sm:px-5 min-w-[44px] touch-manipulation",onClick:()=>Zt(e),children:t.jsx("span",{className:"text-xs sm:text-sm",children:"استرجاع"})}),t.jsx(T,{variant:"ghost",size:"sm",className:"text-red-600 hover:bg-red-100 h-10 sm:h-12 px-3 sm:px-4 min-w-[44px] touch-manipulation",onClick:()=>Qt(e.id),children:t.jsx(gt,{className:"h-4 w-4 sm:h-5 sm:w-5"})})]})]},e.id))})})]})})]}),t.jsx(Es,{open:Bt,onOpenChange:Ye})]}),t.jsx(_s,{isOpen:Ft,onClose:()=>Je(!1)}),t.jsx(yt,{open:Wt,onOpenChange:Se,mode:"verify",title:"الرقم السري الرئيسي لفتح الديون",description:"أدخل الرقم السري الرئيسي لفتح صفحة الديون",onSuccess:()=>{Se(!1),Lt(!0)}}),t.jsx(Ls,{open:Vt,onOpenChange:ue,title:"تأكيد كلمة المرور لتصفير المعاملات الأخيرة",description:"سيتم حذف كل المعاملات السابقة نهائيًا من حسابك وFirebase.",onSuccess:async()=>{try{if(!(s!=null&&s.uid)){ue(!1);return}const e=new Date,l=n=>n instanceof Date?n:typeof(n==null?void 0:n.toDate)=="function"?n.toDate():new Date(String(n));await V.updateUserData(s.uid,{recentReset:{keepLastCount:K.keepLastCount??30,intervalDays:K.intervalDays??7,lastResetAt:e}}),pe(n=>({...n,lastResetAt:e})),y({title:"تم إخفاء المعاملات السابقة",description:"تم إخفاء كل الإيصالات الأقدم من وقت التصفير من العرض بدون التأثير على التقارير اليومية/الشهرية أو الحدود."})}catch(e){console.error("فشل تنفيذ التصفير النهائي:",e),y({title:"فشل التصفير",description:"تحقق من الاتصال ثم أعد المحاولة.",variant:"destructive"})}finally{ue(!1)}}}),t.jsx(Ue,{open:qt,onOpenChange:e=>{var l,n;if(e){const r="alkaptin678678@gmail.com",a=(n=(l=Fe.currentUser)==null?void 0:l.email)==null?void 0:n.toLowerCase();if(!a||a!==r){y({title:"قيد الإنشاء",description:"هذه الميزة قيد الإنشاء حالياً."});return}he(!0)}else he(!1)},children:t.jsxs($e,{dir:"rtl",className:"sm:max-w-md",children:[t.jsx(Ve,{children:t.jsx(qe,{children:"شحن رصيد الموبايل"})}),t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-right mb-1",children:"رقم الموبايل"}),t.jsx(We,{value:xe,onChange:e=>Ze(e.target.value),placeholder:"01XXXXXXXXX",dir:"ltr"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-right mb-1",children:"الشركة"}),t.jsxs(Cs,{value:ae,onValueChange:He,children:[t.jsx(Ds,{className:"w-full",children:t.jsx(As,{placeholder:"اختر الشركة"})}),t.jsxs(Ss,{children:[t.jsx(je,{value:"vodafone_eg",children:"فودافون"}),t.jsx(je,{value:"orange_eg",children:"أورنج"}),t.jsx(je,{value:"etisalat_eg",children:"اتصالات"}),t.jsx(je,{value:"we_eg",children:"WE"})]})]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-right mb-1",children:"المبلغ بالجنيه"}),t.jsx(We,{type:"number",min:1,value:fe,onChange:e=>Ke(e.target.value?Number(e.target.value):""),placeholder:"50"})]}),t.jsxs("div",{className:"flex items-center justify-between gap-2 pt-2",children:[t.jsx(T,{variant:"outline",onClick:()=>he(!1),children:"إلغاء"}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(T,{variant:"secondary",onClick:()=>h("/topup"),children:"صفحة الشحن الكاملة"}),t.jsx(T,{onClick:es,disabled:Qe||!xe||!ae||!fe,children:Qe?"جارٍ التنفيذ...":"تأكيد الشحن"})]})]})]})]})}),t.jsx(Ue,{open:De,onOpenChange:Y,children:t.jsxs($e,{className:"sm:max-w-[460px]",children:[t.jsxs(Ve,{children:[t.jsx(qe,{children:"تأكيد استرجاع الإيصال"}),t.jsx(ws,{children:"سيتم إعادة الإيصال إلى قائمة المعاملات الحالية."})]}),g&&t.jsxs("div",{className:"mt-2 space-y-2 text-sm",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"المبلغ"}),t.jsxs("span",{className:"font-bold",children:[g.amount," جنيه"]})]}),g.type==="withdraw"?t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"العميل"}),t.jsx("span",{className:"font-medium",children:g.receiverPhone})]}):t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"من → إلى"}),t.jsxs("span",{className:"font-medium",children:[g.senderPhone," → ",g.receiverPhone]})]}),t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"الكاشير"}),t.jsx("span",{className:"font-medium",children:g.cashierName??"الحساب الرئيسي"})]}),t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"التاريخ"}),t.jsx("span",{className:"font-medium",children:g.createdAt.toLocaleString("ar-EG")})]})]}),t.jsxs("div",{className:"flex items-center justify-between gap-2 pt-3",children:[t.jsx(T,{variant:"outline",onClick:()=>{Y(!1),R(null)},children:"إلغاء"}),t.jsx(T,{onClick:Ht,children:"تأكيد الاسترجاع"})]})]})}),t.jsx(Ms,{isOpen:zt,onClose:()=>Re(!1),transaction:Ut,onPrint:()=>window.print(),onDelete:rt,onComplete:at})]})};export{ya as default};
