import{w as C,k as y,g as h,v as S,t as U}from"./index-DrngOFvF.js";import{g as E,r as M,u as R,a as B}from"./index.esm-BCAJqCIY.js";const s=["siteContent","appDownloads"],g="appDownloadsCache";async function L(){try{const e=await C(y(h,s[0],s[1]));if(e.exists()){const a=e.data();try{localStorage.setItem(g,JSON.stringify(a))}catch{}return a}return{}}catch(e){const a=(e==null?void 0:e.message)||"";((e==null?void 0:e.code)||"")==="permission-denied"||a.includes("Missing or insufficient permissions")?console.warn("⚠️ Cannot read app downloads (unauth/public). Using cached or empty.",e):console.error("❌ Error loading app downloads:",e);try{const o=localStorage.getItem(g);if(o)return JSON.parse(o)}catch{}return{}}}async function $(e,a,i,o,d,l=12e4){const D=E(),T=e.name.replace(/[^a-zA-Z0-9_.-]/g,"_"),A=`public/apps/${a}/${Date.now()}_${T}`,p=M(D,A);return new Promise((_,n)=>{const u=R(p,e);let m=!1;const w=setTimeout(()=>{m=!0;try{u.cancel()}catch{}n(new Error("Upload timed out"))},l);u.on("state_changed",t=>{const r=Math.round(t.bytesTransferred/t.totalBytes*100);d&&d(r)},t=>{clearTimeout(w),n(t)},async()=>{try{if(clearTimeout(w),m)return;const t=await B(p),r={updatedAt:S(),updatedBy:i||"admin"};a==="android"?(r.androidUrl=t,o&&(r.androidVersion=o)):(r.pcUrl=t,o&&(r.pcVersion=o));const P=Math.min(Math.max(2e4,Math.floor(l/10)),6e4),O=U(y(h,s[0],s[1]),r,{merge:!0});let f=!1;const b=new Promise(c=>setTimeout(()=>{f=!0,c()},P));try{await Promise.race([O,b])}catch(c){console.warn("⚠️ Firestore write error, proceeding with URL only:",c)}f&&console.warn("⚠️ Firestore update timed out; تم رفع الملف، لكن لم يتم تحديث معلومات الإصدار في قاعدة البيانات بعد."),_(t)}catch(t){n(t)}})})}export{L as getAppDownloads,$ as uploadAppBinaryResumable};
