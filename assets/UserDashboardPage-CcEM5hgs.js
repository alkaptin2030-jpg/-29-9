const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-CMr4Oi63.js","./index-BOMJnd04.css","./dailyOperationCountService-Bn7ZiDM3.js","./walletDailyLimitsService-0xjNslf8.js","./profitService-DZQLszRg.js"])))=>i.map(i=>d[i]);
var sm=Object.defineProperty;var am=(i,u,c)=>u in i?sm(i,u,{enumerable:!0,configurable:!0,writable:!0,value:c}):i[u]=c;var Di=(i,u,c)=>am(i,typeof u!="symbol"?u+"":u,c);import{O as Ys,m as rm,n as nm,u as Hs,r as n,c as Es,j as e,B as h,am as Us,ao as jr,bc as bn,bd as oo,a7 as vr,C as ia,S as ms,a as jo,w as Wt,an as ls,I as z,ai as So,av as Do,a8 as Nt,be as pn,U as ki,A as im,R as Je,E as rs,v as Oa,aI as ka,y as Qe,i as H,K as ks,s as lt,f as za,Z as Pa,P as va,q as st,h as Te,al as ke,k as ct,Y as Co,z as Os,p as _s,F as br,G as lm,aa as Sr,aQ as wn,l as mn,ap as Fi,Q as Vs,aw as Me,aW as hs,a2 as Io,_ as om,a1 as cm,bf as dm,W as _a,bg as Ao,aP as co,aV as To,bh as mm,ab as hm,bi as xr,H as um,ah as xm,ae as pr,aT as pm,aU as gm,b8 as mo,M as fm,aS as gr,ac as ho,bj as uo,aO as ym,bk as vm}from"./index-CMr4Oi63.js";import{C as Tt,a as es,b as us,d as Ft}from"./card-OPazuP08.js";import{B as qt}from"./badge-BE93kY55.js";import{S as xa,a as pa,b as ga,c as fa,d as Bs,e as wr,f as un}from"./select-BNThciT7.js";import{D as ge,a as fe,b as ye,c as ve,f as bm,e as is,d as dt,g as Po,R as wm,P as Nm,W as jm,C as Sm,T as Dm,h as Cm,i as ko,O as Im,j as Am}from"./dialog-BqmsXYmq.js";import{L as X}from"./label-B7SL5F9X.js";import{M as as,a as os,P as Tm}from"./MasterPinDialog-D1NM4cce.js";import{walletDailyLimitsService as Ks}from"./walletDailyLimitsService-0xjNslf8.js";import{W as Js}from"./wallet-DvkjPJj2.js";import{S as Oo,a as Pm}from"./star-DWj6_sar.js";import{S as _o}from"./square-pen-btHO99iB.js";import{T as Xt,P as xo}from"./progress-BgUXyrzN.js";import{P as na}from"./phone-eS4UHcQk.js";import{A as Eo}from"./arrow-left-Bz3Pvwao.js";import{a as Oi,S as km}from"./separator-DckENC5w.js";import{C as ba}from"./calendar-BYCE6wLZ.js";import{C as gn}from"./chart-column-BolFQOz2.js";import{D as $t}from"./dollar-sign-H3syPBeb.js";import{A as hn,P as Om}from"./ProfileIcon-pzfAvfqG.js";import{C as Ea}from"./circle-alert-3uX3buCB.js";import{C as fn}from"./circle-x-CWSqtEpz.js";import{C as wa}from"./circle-check-big-CFmkrR2f.js";import{f as Cs,P as _m,C as Fo,a as Wi,A as yn,b as po,I as Em,R as Fm,c as Wm,M as Mm}from"./MaintenanceDialog-BUgYt8vg.js";import{S as Wo}from"./store-BobsStL1.js";import{r as ds,P as ya}from"./profitService-DZQLszRg.js";import{a as Rm,E as $m}from"./broadcastService-IEn20a7V.js";import{B as go,T as Lm}from"./textarea-f8Kbujph.js";import{D as Bm,a as Um,b as zm,c as qm,d as Vm}from"./dropdown-menu-SeZtQJVy.js";import{S as Ci}from"./shield-DFDtw70V.js";import{G as Jm}from"./gift-Bhk0Us-z.js";import{W as Km}from"./WalletsManagement-BLya_4kn.js";import{P as Ym,w as Hm}from"./walletSelectionPinService-UPCoqhIa.js";import{R as Gm}from"./refresh-cw-CBZOsUna.js";import"./Combination-TjOtKNsl.js";import"./index-DoNR_1Mu.js";import"./avatars-DXQj4TBc.js";import"./whatsappService-xAazA0rf.js";import"./download-BD1sYLif.js";import"./index-CeFZWSbA.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Qm=Ys("Award",[["path",{d:"m15.477 12.89 1.515 8.526a.5.5 0 0 1-.81.47l-3.58-2.687a1 1 0 0 0-1.197 0l-3.586 2.686a.5.5 0 0 1-.81-.469l1.514-8.526",key:"1yiouv"}],["circle",{cx:"12",cy:"8",r:"6",key:"1vp47v"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fo=Ys("Banknote",[["rect",{width:"20",height:"12",x:"2",y:"6",rx:"2",key:"9lu3g6"}],["circle",{cx:"12",cy:"12",r:"2",key:"1c9p78"}],["path",{d:"M6 12h.01M18 12h.01",key:"113zkx"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Zm=Ys("BookOpen",[["path",{d:"M12 7v14",key:"1akyts"}],["path",{d:"M3 18a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h5a4 4 0 0 1 4 4 4 4 0 0 1 4-4h5a1 1 0 0 1 1 1v13a1 1 0 0 1-1 1h-6a3 3 0 0 0-3 3 3 3 0 0 0-3-3z",key:"ruj8y"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Mo=Ys("Building",[["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",ry:"2",key:"76otgf"}],["path",{d:"M9 22v-4h6v4",key:"r93iot"}],["path",{d:"M8 6h.01",key:"1dz90k"}],["path",{d:"M16 6h.01",key:"1x0f13"}],["path",{d:"M12 6h.01",key:"1vi96p"}],["path",{d:"M12 10h.01",key:"1nrarc"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M16 10h.01",key:"1m94wz"}],["path",{d:"M16 14h.01",key:"1gbofw"}],["path",{d:"M8 10h.01",key:"19clt8"}],["path",{d:"M8 14h.01",key:"6423bh"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const vn=Ys("IdCard",[["path",{d:"M16 10h2",key:"8sgtl7"}],["path",{d:"M16 14h2",key:"epxaof"}],["path",{d:"M6.17 15a3 3 0 0 1 5.66 0",key:"n6f512"}],["circle",{cx:"9",cy:"11",r:"2",key:"yxgjnd"}],["rect",{x:"2",y:"5",width:"20",height:"14",rx:"2",key:"qneu4z"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _i=Ys("Info",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ii=Ys("ListChecks",[["path",{d:"m3 17 2 2 4-4",key:"1jhpwq"}],["path",{d:"m3 7 2 2 4-4",key:"1obspn"}],["path",{d:"M13 6h8",key:"15sg57"}],["path",{d:"M13 12h8",key:"h98zly"}],["path",{d:"M13 18h8",key:"oe0vm4"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Xm=Ys("Notebook",[["path",{d:"M2 6h4",key:"aawbzj"}],["path",{d:"M2 10h4",key:"l0bgd4"}],["path",{d:"M2 14h4",key:"1gsvsf"}],["path",{d:"M2 18h4",key:"1bu2t1"}],["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",key:"1nb95v"}],["path",{d:"M16 2v20",key:"rotuqe"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const yr=Ys("Package",[["path",{d:"M11 21.73a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73z",key:"1a0edw"}],["path",{d:"M12 22V12",key:"d0xqtd"}],["path",{d:"m3.3 7 7.703 4.734a2 2 0 0 0 1.994 0L20.7 7",key:"yx3hmr"}],["path",{d:"m7.5 4.27 9 5.15",key:"1c824w"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xn=Ys("TrendingDown",[["polyline",{points:"22 17 13.5 8.5 8.5 13.5 2 7",key:"1r2t7k"}],["polyline",{points:"16 17 22 17 22 11",key:"11uiuu"}]]),eh=async(i={})=>{try{return(await rm(nm,"getLastTransactions")(i)).data}catch(u){throw console.error("Error getting last transactions:",u),u.code==="functions/unauthenticated"?new Error("يجب تسجيل الدخول للوصول إلى المعاملات"):u.code==="functions/invalid-argument"?new Error("بيانات الاستعلام غير صالحة: "+u.message):u.code==="functions/permission-denied"?new Error("ليس لديك صلاحية للوصول إلى هذه المعاملات: "+u.message):new Error("حدث خطأ أثناء جلب المعاملات: "+(u.message||"خطأ غير معروف"))}},th=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],sh=({isOpen:i,onClose:u,onWalletSelect:c,onEditWallet:g,onDeleteWallet:v})=>{const{user:D}=Hs(),[s,C]=n.useState([]),[$,S]=n.useState(!1),[T,O]=n.useState([]),[y,N]=n.useState(!1),{toast:P}=Es(),J=async(_,W)=>{const he=new Date().getMonth(),ne=new Date().getFullYear(),xe=W.filter(Ce=>{const Le=new Date(Ce.createdAt);return Le.getMonth()===he&&Le.getFullYear()===ne&&(Ce.lineId===_||Ce.fromWallet===_)}),ie=Ce=>{const Le=Ce.type;return Ce.txnType==="receive"||Le==="withdraw"||Le==="withdrawal"||Le==="receive"},te=Ce=>{const Le=Ce.type;return Ce.txnType==="send"||Le==="send"||Le==="transfer"},Oe=xe.filter(ie).reduce((Ce,Le)=>{const Ue=Le.withdrawnAmount!==void 0?Le.withdrawnAmount:Le.amount;return Ce+(Ue||0)},0),Re=xe.filter(te).reduce((Ce,Le)=>{const Ue=Le.sentAmount!==void 0?Le.sentAmount:Le.amount;return Ce+(Ue||0)},0);return{withdrawalUsage:Oe,transferUsage:Re}},F=_=>{const W=new Date().toISOString().split("T")[0],he=_.lastResetDate;if(!he)return{..._,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:W};const ne=new Date(he),xe=new Date;return ne.getMonth()!==xe.getMonth()||ne.getFullYear()!==xe.getFullYear()?{..._,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:W}:_};n.useEffect(()=>{if(!(D!=null&&D.uid)||!i)return;(async()=>{N(!0);try{const W=await Us.getByMerchantId(D.uid),he=await bn.getByUserId(D.uid),xe=(await Promise.all(W.map(async ie=>{const{withdrawalUsage:te,transferUsage:Oe}=await J(ie.id,he),Re=await Ks.getWalletLimits(ie.id);return{id:ie.id,name:ie.label||"محفظة بدون اسم",phone:ie.msisdn,nationalId:ie.nationalId||"",isDefault:!1,isActive:ie.isActive===!0,monthlyWithdrawalLimit:(Re==null?void 0:Re.monthlyWithdrawLimit)??ie.withdrawLimit??2e5,monthlyTransferLimit:(Re==null?void 0:Re.monthlyTransferLimit)??ie.transferLimit??2e5,monthlyWithdrawalUsage:(Re==null?void 0:Re.monthlyWithdrawUsed)??te??0,monthlyTransferUsage:(Re==null?void 0:Re.monthlyTransferUsed)??Oe??0,lastResetDate:new Date().toISOString().split("T")[0],walletProvider:ie.walletProvider||""}}))).map(F);C(xe)}catch(W){console.error("Error loading wallets:",W),P({title:"فشل جلب بيانات المحافظ",description:"قد تكون المشكلة بسبب الصلاحيات أو الاتصال. سيتم عرض البيانات المحلية إن وُجدت. جرّب تسجيل الدخول مجددًا أو افتح صفحة اختبار المصادقة من القائمة.",variant:"destructive"})}finally{N(!1)}})()},[D==null?void 0:D.uid,i]);const G=_=>th.find(W=>W.id===_),Z=(_,W)=>W>0?Math.min(_/W*100,100):0,re=_=>new Intl.NumberFormat("ar-EG").format(_);return e.jsx(ge,{open:i,onOpenChange:u,children:e.jsxs(fe,{className:"max-w-6xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(ye,{className:"pb-4",children:[e.jsxs(ve,{className:"flex items-center gap-2 text-lg",children:[e.jsx(Js,{className:"h-5 w-5"}),"الاطلاع على جميع المحافظ",e.jsxs(qt,{variant:"secondary",className:"mr-2",children:[s.length," محفظة"]})]}),e.jsx("div",{className:"flex items-center gap-2 mt-2",children:$?e.jsxs(e.Fragment,{children:[e.jsx(h,{size:"sm",onClick:async()=>{try{if(!(D!=null&&D.uid))return;const _=s.map(W=>Us.update(W.id,{isActive:T.includes(W.id)}));await Promise.all(_),C(W=>W.map(he=>({...he,isActive:T.includes(he.id)}))),S(!1),P({title:"تم تفعيل المحافظ",description:"فقط المحافظ المحددة ستظهر في الاختيار الخارجي"});try{window.dispatchEvent(new CustomEvent("wallets:activation-updated"))}catch{}}catch(_){console.error("Error activating wallets:",_),P({title:"فشل التفعيل",description:"تعذر تفعيل المحافظ المحددة",variant:"destructive"})}},className:"h-7",children:"تفعيل المحافظ"}),e.jsx(h,{variant:"ghost",size:"sm",onClick:()=>{S(!1),O([])},className:"h-7",children:"إلغاء"})]}):e.jsx(h,{variant:"outline",size:"sm",onClick:()=>S(!0),className:"h-7",children:"تحديد المحافظ"})})]}),y?e.jsx("div",{className:"flex justify-center items-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-600",children:"جاري تحميل المحافظ..."})]})}):s.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Js,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"لا توجد محافظ مضافة حتى الآن"})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:s.map(_=>{const W=G(_.walletProvider||"");Z(_.monthlyWithdrawalUsage||0,_.monthlyWithdrawalLimit),Z(_.monthlyTransferUsage||0,_.monthlyTransferLimit);const he=T.includes(_.id),ne=$?`cursor-pointer transition-shadow border-2 ${he?"border-blue-500 shadow-lg":"hover:border-blue-300"}`:"cursor-pointer hover:shadow-lg transition-shadow border-2 hover:border-blue-300";return e.jsxs(Tt,{className:ne,onClick:()=>{$?O(xe=>xe.includes(_.id)?xe.filter(ie=>ie!==_.id):[...xe,_.id]):c(_)},children:[e.jsx(es,{className:"pb-3",children:e.jsxs(us,{className:"flex items-center justify-between text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(jr,{className:"h-4 w-4"}),e.jsx("span",{children:_.name})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[_.isActive&&e.jsx(qt,{variant:"default",className:"text-xs",children:"نشطة"}),_.isDefault&&e.jsxs(qt,{variant:"default",className:"text-xs",children:[e.jsx(Oo,{className:"h-3 w-3 mr-1"}),"افتراضية"]}),e.jsx(h,{variant:"ghost",size:"sm",onClick:xe=>{xe.stopPropagation(),g==null||g(_)},className:"h-7 px-2",children:e.jsx(_o,{className:"h-4 w-4"})}),e.jsx(h,{variant:"ghost",size:"sm",onClick:xe=>{xe.stopPropagation(),v==null||v(_.id)},className:"h-7 px-2 text-destructive hover:text-destructive",children:e.jsx(Xt,{className:"h-4 w-4"})})]})]})}),e.jsxs(Ft,{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(na,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"font-mono",children:_.phone})]}),_.nationalId&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(vn,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"font-mono",children:_.nationalId})]}),W&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Mo,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{children:W.name})]})]}),(()=>{const xe=_.monthlyWithdrawalLimit,ie=_.monthlyTransferLimit,te=_.monthlyWithdrawalUsage||0,Oe=_.monthlyTransferUsage||0,Re=Math.max(xe-te,0),Ce=Math.max(ie-Oe,0);return e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-2 rounded-md border border-gray-200 shadow-sm space-y-2",children:[e.jsxs("div",{className:"text-xs text-gray-600 font-medium text-center",children:["الحدود الشهرية: ",(W==null?void 0:W.name)||_.walletProvider," - ",_.phone]}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-red-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-red-400 to-red-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(te/Math.max(xe,1)*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-blue-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-400 to-blue-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(Oe/Math.max(ie,1)*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-1",children:[e.jsxs("div",{className:"text-xs text-red-600 font-medium",children:["متبقي سحب: ",re(Re)," جنيه"]}),e.jsxs("div",{className:"text-xs text-blue-600 font-medium",children:["متبقي تحويل: ",re(Ce)," جنيه"]})]})]})})(),e.jsx(h,{variant:"outline",size:"sm",className:"w-full text-xs",onClick:xe=>{xe.stopPropagation(),c(_)},children:"عرض التفاصيل الكاملة"})]})]},_.id)})}),e.jsx("div",{className:"flex justify-end pt-4 border-t",children:e.jsxs(h,{onClick:u,variant:"outline",children:[e.jsx(Eo,{className:"h-4 w-4 mr-2"}),"إغلاق"]})})]})})},ah=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],rh=({wallet:i,isOpen:u,onClose:c,onBack:g})=>{const{user:v}=Hs(),[D,s]=n.useState([]),[C,$]=n.useState(!1),[S,T]=n.useState("month"),{toast:O}=Es();if(n.useEffect(()=>{if(!i||!(v!=null&&v.uid)||!u)return;(async()=>{$(!0);try{const et=(await bn.getByUserId(v.uid)).filter(se=>se.walletId===i.id).sort((se,pe)=>new Date(pe.createdAt).getTime()-new Date(se.createdAt).getTime());s(et)}catch(de){console.error("Error loading transactions:",de),O({title:"فشل جلب معاملات المحفظة",description:"قد تكون المشكلة بسبب صلاحيات Firestore أو الاتصال. تم عرض ما أمكن محليًا. جرّب تسجيل الدخول مجددًا أو صفحة اختبار المصادقة.",variant:"destructive"})}finally{$(!1)}})()},[i,v==null?void 0:v.uid,u]),!i)return null;const y=Q=>ah.find(de=>de.id===Q),N=(Q,de)=>de>0?Math.min(Q/de*100,100):0,P=Q=>new Intl.NumberFormat("ar-EG").format(Q),J=Q=>new Date(Q).toLocaleDateString("ar-EG",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}),G=(()=>{const Q=new Date;let de;switch(S){case"week":de=new Date(Q.getTime()-7*24*60*60*1e3);break;case"month":de=new Date(Q.getFullYear(),Q.getMonth(),1);break;default:return D}return D.filter(et=>new Date(et.createdAt)>=de)})(),Z=Q=>{const de=Q.type,et=Q.txnType;return de==="withdraw"||de==="withdrawal"||de==="receive"||et==="receive"},re=Q=>{const de=Q.type,et=Q.txnType;return de==="send"||de==="transfer"||et==="send"},_=G.filter(Q=>Z(Q)&&Q.status==="completed").reduce((Q,de)=>{const et=de.withdrawnAmount!==void 0?de.withdrawnAmount:de.amount;return Q+(et||0)},0),W=G.filter(Q=>re(Q)&&Q.status==="completed").reduce((Q,de)=>{const et=de.sentAmount!==void 0?de.sentAmount:de.amount;return Q+(et||0)},0),he=G.filter(Q=>Q.type==="deposit"&&Q.status==="completed").reduce((Q,de)=>Q+de.amount,0),ne=G.filter(Q=>Q.status==="completed"),xe=ne.length,ie=ne.reduce((Q,de)=>{if(Z(de)){const et=de.withdrawnAmount??de.receivedAmount??de.amount??0;return Q+oo(Number(et)||0,"receive")}if(re(de)){const et=de.sentAmount??de.transferredAmount??de.amount??0;return Q+oo(Number(et)||0,"send")}return Q},0),te=y(i.walletProvider||""),Oe=N(i.monthlyWithdrawalUsage||0,i.monthlyWithdrawalLimit),Re=N(i.monthlyTransferUsage||0,i.monthlyTransferLimit),Ce=Q=>{switch(Q){case"withdrawal":return e.jsx(xn,{className:"h-4 w-4 text-red-500"});case"transfer":return e.jsx(vr,{className:"h-4 w-4 text-blue-500"});case"deposit":return e.jsx($t,{className:"h-4 w-4 text-green-500"});default:return e.jsx(hn,{className:"h-4 w-4 text-gray-500"})}},Le=Q=>{switch(Q){case"completed":return e.jsx(wa,{className:"h-4 w-4 text-green-500"});case"pending":return e.jsx(ia,{className:"h-4 w-4 text-yellow-500"});case"failed":return e.jsx(fn,{className:"h-4 w-4 text-red-500"});default:return e.jsx(Ea,{className:"h-4 w-4 text-gray-500"})}},Ue=Q=>{switch(Q){case"withdrawal":return"سحب";case"transfer":return"تحويل";case"deposit":return"إيداع";default:return"معاملة"}},at=Q=>{switch(Q){case"completed":return"مكتملة";case"pending":return"قيد الانتظار";case"failed":return"فاشلة";default:return"غير محدد"}};return e.jsx(ge,{open:u,onOpenChange:c,children:e.jsxs(fe,{className:"max-w-6xl max-h-[90vh] overflow-y-auto",children:[e.jsx(ye,{className:"pb-4",children:e.jsxs(ve,{className:"flex items-center gap-2 text-lg",children:[e.jsx(jr,{className:"h-5 w-5"}),"تفاصيل المحفظة: ",i.name,i.isDefault&&e.jsxs(qt,{variant:"default",className:"mr-2",children:[e.jsx(Oo,{className:"h-3 w-3 mr-1"}),"افتراضية"]})]})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-1 space-y-4",children:[e.jsxs(Tt,{children:[e.jsx(es,{children:e.jsxs(us,{className:"text-sm flex items-center gap-2",children:[e.jsx(vn,{className:"h-4 w-4"}),"المعلومات الأساسية"]})}),e.jsxs(Ft,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(na,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-mono",children:i.phone})]}),i.nationalId&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(vn,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-mono",children:i.nationalId})]}),te&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Mo,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{children:te.name})]}),e.jsxs("div",{className:"text-xs text-gray-600 pr-6",children:[e.jsxs("div",{children:["المالك: ",te.ownerName]}),e.jsxs("div",{className:"font-mono",children:["الرقم القومي: ",te.nationalId]})]})]}),i.lastResetDate&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(ba,{className:"h-4 w-4 text-gray-500"}),e.jsxs("span",{children:["آخر إعادة تعيين: ",new Date(i.lastResetDate).toLocaleDateString("ar-EG")]})]})]})]}),e.jsxs(Tt,{children:[e.jsx(es,{children:e.jsxs(us,{className:"text-sm flex items-center gap-2",children:[e.jsx(gn,{className:"h-4 w-4"}),"حدود الاستخدام الشهري"]})}),e.jsxs(Ft,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(xn,{className:"h-3 w-3 text-red-500"}),"السحب الشهري"]}),e.jsxs("span",{className:"font-mono",children:[P(i.monthlyWithdrawalUsage||0)," / ",P(i.monthlyWithdrawalLimit)]})]}),e.jsx(xo,{value:Oe,className:"h-2"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["متبقي: ",P(i.monthlyWithdrawalLimit-(i.monthlyWithdrawalUsage||0))," جنيه"]})]}),e.jsx(Oi,{}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(vr,{className:"h-3 w-3 text-green-500"}),"التحويل الشهري"]}),e.jsxs("span",{className:"font-mono",children:[P(i.monthlyTransferUsage||0)," / ",P(i.monthlyTransferLimit)]})]}),e.jsx(xo,{value:Re,className:"h-2"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["متبقي: ",P(i.monthlyTransferLimit-(i.monthlyTransferUsage||0))," جنيه"]})]})]})]})]}),e.jsxs("div",{className:"lg:col-span-2 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-5 gap-4",children:[e.jsx(Tt,{children:e.jsxs(Ft,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(xn,{className:"h-5 w-5 text-red-500"})}),e.jsx("div",{className:"text-lg font-bold",children:P(_)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي السحب"})]})}),e.jsx(Tt,{children:e.jsxs(Ft,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(vr,{className:"h-5 w-5 text-blue-500"})}),e.jsx("div",{className:"text-lg font-bold",children:P(W)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي التحويل"})]})}),e.jsx(Tt,{children:e.jsxs(Ft,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx($t,{className:"h-5 w-5 text-green-500"})}),e.jsx("div",{className:"text-lg font-bold",children:P(he)}),e.jsx("div",{className:"text-xs text-gray-600",children:"إجمالي الإيداع"})]})}),e.jsx(Tt,{children:e.jsxs(Ft,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(gn,{className:"h-5 w-5 text-emerald-600"})}),e.jsx("div",{className:"text-lg font-bold",children:P(ie)}),e.jsx("div",{className:"text-xs text-gray-600",children:"أرباح الفترة"})]})}),e.jsx(Tt,{children:e.jsxs(Ft,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx(hn,{className:"h-5 w-5 text-purple-600"})}),e.jsx("div",{className:"text-lg font-bold",children:P(xe)}),e.jsx("div",{className:"text-xs text-gray-600",children:"عدد العمليات"})]})})]}),e.jsxs(Tt,{children:[e.jsx(es,{children:e.jsxs(us,{className:"text-sm flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(hn,{className:"h-4 w-4"}),"سجل المعاملات"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(h,{size:"sm",variant:S==="week"?"default":"outline",onClick:()=>T("week"),className:"text-xs",children:"أسبوع"}),e.jsx(h,{size:"sm",variant:S==="month"?"default":"outline",onClick:()=>T("month"),className:"text-xs",children:"شهر"}),e.jsx(h,{size:"sm",variant:S==="all"?"default":"outline",onClick:()=>T("all"),className:"text-xs",children:"الكل"})]})]})}),e.jsx(Ft,{children:C?e.jsx("div",{className:"flex justify-center items-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-600",children:"جاري تحميل المعاملات..."})]})}):G.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(hn,{className:"h-8 w-8 text-gray-400 mx-auto mb-2"}),e.jsx("p",{className:"text-gray-600",children:"لا توجد معاملات في هذه الفترة"})]}):e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:G.map(Q=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[Ce(Q.type),e.jsxs("div",{children:[e.jsxs("div",{className:"text-sm font-medium",children:[Ue(Q.type)," - ",P(Q.amount)," جنيه"]}),e.jsx("div",{className:"text-xs text-gray-600",children:J(Q.createdAt)}),Q.description&&e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:Q.description})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[Le(Q.status),e.jsx("span",{className:"text-xs",children:at(Q.status)})]})]},Q.id))})})]})]})]}),e.jsxs("div",{className:"flex justify-between pt-4 border-t",children:[e.jsxs(h,{onClick:g,variant:"outline",children:[e.jsx(Eo,{className:"h-4 w-4 mr-2"}),"العودة للمحافظ"]}),e.jsx(h,{onClick:c,variant:"outline",children:"إغلاق"})]})]})})},Ai=[{id:"vodafone",name:"فودافون كاش",ownerName:"أحمد محمد علي",nationalId:"29012345678901"},{id:"etisalat",name:"اتصالات كاش",ownerName:"فاطمة حسن محمود",nationalId:"28506789012345"},{id:"orange",name:"أورنج كاش",ownerName:"محمد أحمد السيد",nationalId:"29309876543210"},{id:"we_pay",name:"وي باي",ownerName:"نورا عبد الرحمن",nationalId:"29112345678901"},{id:"smart_wallet",name:"سمارت ولت",ownerName:"خالد محمد عبد الله",nationalId:"28809876543210"},{id:"access_pay",name:"أكسس باي",ownerName:"مريم أحمد حسن",nationalId:"29456789012345"},{id:"insta_pay",name:"انستا باي",ownerName:"عمر سعد محمد",nationalId:"29012345678901"}],nh=({isOpen:i,onClose:u,onWalletUpdate:c,initialEditingWallet:g})=>{const{toast:v}=Es(),{user:D,userSubscription:s}=Hs();(()=>{var Ie,it;const M=((Ie=s==null?void 0:s.subscription)==null?void 0:Ie.planType)??((it=s==null?void 0:s.subscription)==null?void 0:it.plan)??(s==null?void 0:s.planType)??(s==null?void 0:s.plan)??null,me=typeof M=="string"?String(M).trim().toLowerCase():null;return M===ms.TAHWEELA||me==="tahweela"||me==="تحويله"})();const C=jo(),[$,S]=n.useState([]),[T,O]=n.useState(!1),[y,N]=n.useState(null),[P,J]=n.useState(""),[F,G]=n.useState(""),[Z,re]=n.useState(""),[_,W]=n.useState(""),[he,ne]=n.useState("200000"),[xe,ie]=n.useState("200000"),[te,Oe]=n.useState("100000"),[Re,Ce]=n.useState("60000"),[Le,Ue]=n.useState(!1),[at,Q]=n.useState(null),[de,et]=n.useState(!1),[se,pe]=n.useState(!1),[ht,Yt]=n.useState(!1),[Lt,Vt]=n.useState(null),je=()=>`wallets_${(D==null?void 0:D.uid)||"default"}`;n.useEffect(()=>{g&&(N(g),O(!0),J(g.name||""),G(g.phone||""),re(g.nationalId||""),W(g.walletProvider||""),ne((g.monthlyWithdrawalLimit||2e5).toString()),ie((g.monthlyTransferLimit||2e5).toString()),Oe((g.dailyWithdrawalLimit||1e5).toString()),Ce((g.dailyTransferLimit||6e4).toString()),Ue(!!g.isDefault))},[g]);const Ke=M=>{const me=new Date,Ie=me.getMonth(),it=me.getFullYear();if(!M.lastResetDate)return{...M,monthlyWithdrawalUsage:M.monthlyWithdrawalUsage||0,monthlyTransferUsage:M.monthlyTransferUsage||0,lastResetDate:me.toISOString().split("T")[0]};const ot=new Date(M.lastResetDate),Pt=ot.getMonth(),kt=ot.getFullYear();return Ie!==Pt||it!==kt?{...M,monthlyWithdrawalUsage:0,monthlyTransferUsage:0,lastResetDate:me.toISOString().split("T")[0]}:M},rt=async(M,me)=>{const Ie=new Date().getMonth(),it=new Date().getFullYear(),ot=me.filter(wt=>{const Ze=new Date(wt.createdAt);return Ze.getMonth()===Ie&&Ze.getFullYear()===it&&wt.lineId===M}),Pt=ot.filter(wt=>wt.txnType==="receive").reduce((wt,Ze)=>wt+(Ze.amount||0),0),kt=ot.filter(wt=>wt.txnType==="send").reduce((wt,Ze)=>wt+(Ze.amount||0),0);return{withdrawalUsage:Pt,transferUsage:kt}},ue=async(M,me)=>{const Ie=new Date,it=Ie.getDate(),ot=Ie.getMonth(),Pt=Ie.getFullYear(),kt=me.filter(Ot=>{const St=new Date(Ot.createdAt);return St.getDate()===it&&St.getMonth()===ot&&St.getFullYear()===Pt&&Ot.lineId===M}),wt=kt.filter(Ot=>Ot.txnType==="receive").reduce((Ot,St)=>Ot+(St.amount||0),0),Ze=kt.filter(Ot=>Ot.txnType==="send").reduce((Ot,St)=>Ot+(St.amount||0),0);return{withdrawalUsage:wt,transferUsage:Ze}};n.useEffect(()=>{(async()=>{if(!(D!=null&&D.uid)){console.log("No user authenticated, skipping wallet loading"),et(!1);return}console.log("Loading wallets for user:",D.uid),et(!0);try{const{auth:me}=await Nt(async()=>{const{auth:Ze}=await import("./index-CMr4Oi63.js").then(Ot=>Ot.bp);return{auth:Ze}},__vite__mapDeps([0,1]),import.meta.url);let Ie=0;const it=5;for(;!me.currentUser&&Ie<it;)console.log(`Waiting for auth state... attempt ${Ie+1}`),await new Promise(Ze=>setTimeout(Ze,1e3)),Ie++;if(!me.currentUser)throw console.error("User not authenticated in Firebase Auth after retries"),new Error("not authenticated");console.log("Firebase Auth User:",me.currentUser.uid),console.log("Context User:",D.uid),console.log("Fetching wallets from Firebase...");const ot=await Us.getByMerchantId(D.uid);console.log("Fetched wallets:",ot),console.log("Fetching transactions from Firebase...");const Pt=await bn.getByUserId(D.uid);console.log("Fetched transactions:",Pt);const wt=(await Promise.all(ot.map(async Ze=>{const{withdrawalUsage:Ot,transferUsage:St}=await rt(Ze.id,Pt),{withdrawalUsage:Jt,transferUsage:Bt}=await ue(Ze.id,Pt);return{id:Ze.id,name:Ze.label||"محفظة بدون اسم",phone:Ze.msisdn,isDefault:!1,monthlyWithdrawalLimit:Ze.withdrawLimit||2e5,monthlyTransferLimit:Ze.transferLimit||2e5,dailyWithdrawalLimit:Ze.dailyWithdrawLimit||1e5,dailyTransferLimit:Ze.dailyTransferLimit||6e4,monthlyWithdrawalUsage:Ot,monthlyTransferUsage:St,dailyWithdrawalUsage:Jt,dailyTransferUsage:Bt,lastResetDate:new Date().toISOString().split("T")[0],defaultTransferCommission:Ze.defaultTransferCommission!=null?Number(Ze.defaultTransferCommission):null,defaultWithdrawCommission:Ze.defaultWithdrawCommission!=null?Number(Ze.defaultWithdrawCommission):null}}))).map(Ke);S(wt),console.log("Wallets loaded successfully:",wt)}catch(me){console.error("Error loading wallets:",me),S([])}finally{et(!1)}})()},[D==null?void 0:D.uid]);const nt=()=>{J(""),G(""),re(""),W(""),ne("200000"),ie("200000"),Oe("100000"),Ce("60000"),Ue(!1),N(null),O(!1)},q=async()=>{if(!P.trim()||!F.trim()||!_.trim()){v({title:"خطأ",description:"يرجى ملء جميع الحقول المطلوبة",variant:"destructive"});return}if(!(D!=null&&D.uid)){v({title:"خطأ",description:"يجب تسجيل الدخول أولاً",variant:"destructive"});return}et(!0);try{if(y){await Us.update(y.id,{label:P.trim(),msisdn:F.trim(),withdrawLimit:parseInt(he),transferLimit:parseInt(xe),dailyWithdrawLimit:parseInt(te),dailyTransferLimit:parseInt(Re)}),await Ks.setLimits(y.id,{dailyTransferLimit:parseInt(Re||"0"),dailyWithdrawLimit:parseInt(te||"0"),monthlyTransferLimit:parseInt(xe||"0"),monthlyWithdrawLimit:parseInt(he||"0")});const M=$.map(me=>me.id===y.id?{...me,name:P.trim(),phone:F.trim(),nationalId:Z.trim(),walletProvider:_,monthlyWithdrawalLimit:parseInt(he),monthlyTransferLimit:parseInt(xe),dailyWithdrawalLimit:parseInt(te),dailyTransferLimit:parseInt(Re)}:me);S(M),localStorage.setItem(je(),JSON.stringify(M)),v({title:"تم التحديث",description:"تم تحديث المحفظة بنجاح"})}else{const M={merchantUserId:D.uid,provider:_,msisdn:F.trim(),label:P.trim(),isActive:!0,dailyLimit:2e5,monthlyLimit:2e5,withdrawLimit:parseInt(he),transferLimit:parseInt(xe),dailyTransferLimit:parseInt(Re),dailyWithdrawLimit:parseInt(te),dailyUsage:0,monthlyUsage:0,transferUsage:0,withdrawUsage:0},me=await Us.create(M);await Ks.setLimits(me,{dailyTransferLimit:parseInt(Re||"0"),dailyWithdrawLimit:parseInt(te||"0"),monthlyTransferLimit:parseInt(xe||"0"),monthlyWithdrawLimit:parseInt(he||"0")});const Ie=new Date().toISOString().split("T")[0],it={id:me,name:P.trim(),phone:F.trim(),nationalId:Z.trim(),walletProvider:_,isDefault:Le,monthlyWithdrawalLimit:parseInt(he),monthlyTransferLimit:parseInt(xe),dailyWithdrawalLimit:parseInt(te),dailyTransferLimit:parseInt(Re),monthlyWithdrawalUsage:0,monthlyTransferUsage:0,dailyWithdrawalUsage:0,dailyTransferUsage:0,lastResetDate:Ie,defaultTransferCommission:null,defaultWithdrawCommission:null},ot=[...$,it];S(ot),localStorage.setItem(je(),JSON.stringify(ot)),v({title:"تم الإنشاء",description:"تم إنشاء المحفظة بنجاح"})}c&&c(),nt(),O(!1),N(null)}catch(M){console.error("Error saving wallet:",M),v({title:"خطأ",description:"حدث خطأ أثناء حفظ المحفظة",variant:"destructive"})}finally{et(!1)}},xt=M=>{N(M),J(M.name),G(M.phone),re(M.nationalId||""),W(M.walletProvider||""),ne(M.monthlyWithdrawalLimit.toString()),ie(M.monthlyTransferLimit.toString()),Ue(M.isDefault),O(!0)},vt=async M=>{const me=$.find(Ie=>Ie.id===M);if(me!=null&&me.isDefault){v({title:"تحذير",description:"لا يمكن حذف المحفظة الافتراضية",variant:"destructive"});return}if(!(D!=null&&D.uid)){v({title:"خطأ",description:"يجب تسجيل الدخول أولاً",variant:"destructive"});return}et(!0);try{await Us.delete(M);const Ie=$.filter(it=>it.id!==M);S(Ie),localStorage.setItem(je(),JSON.stringify(Ie)),c&&c(),v({title:"تم الحذف",description:"تم حذف المحفظة بنجاح"})}catch(Ie){console.error("Error deleting wallet:",Ie),v({title:"خطأ",description:"حدث خطأ أثناء حذف المحفظة",variant:"destructive"})}finally{et(!1)}},bt=M=>{const me=$.map(Ie=>({...Ie,isDefault:Ie.id===M}));S(me),localStorage.setItem(je(),JSON.stringify(me)),c&&c(),v({title:"تم تحديث المحفظة الافتراضية",description:"تم تعيين المحفظة كافتراضية بنجاح"})};return e.jsxs(ge,{open:i,onOpenChange:u,children:[e.jsxs(fe,{className:"max-w-4xl max-h-[80vh] overflow-y-auto",children:[e.jsx(ye,{className:"pb-2",children:e.jsxs(ve,{className:"flex items-center gap-1 text-sm",children:[e.jsx(Js,{className:"h-3 w-3"}),"إدارة المحافظ"]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h3",{className:"text-sm font-semibold",children:["المحافظ المتاحة (",$.length,")"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(h,{onClick:()=>{Yt(!0)},className:"flex items-center gap-1 h-6 px-2 text-xs",size:"sm",variant:"outline",children:[e.jsx(Wt,{className:"h-3 w-3"}),"الاطلاع على المحافظ"]}),e.jsxs(h,{onClick:()=>{u(),C("/user/add-wallet")},className:"flex items-center gap-1 h-6 px-2 text-xs",size:"sm",children:[e.jsx(ls,{className:"h-3 w-3"}),"إضافة محفظة جديدة"]})]})]}),(T||y)&&e.jsxs(Tt,{className:"border-2 border-blue-200 bg-blue-50",children:[e.jsx(es,{className:"pb-1",children:e.jsx(us,{className:"text-sm",children:y?"تعديل المحفظة":"إضافة محفظة جديدة"})}),e.jsxs(Ft,{className:"space-y-2 pt-1",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"شركة المحفظة"}),e.jsx("div",{className:"flex gap-1 items-center",children:e.jsxs(xa,{value:_,onValueChange:W,children:[e.jsx(pa,{className:"h-6 text-xs flex-1",children:e.jsx(ga,{placeholder:"اختر شركة المحفظة"})}),e.jsx(fa,{children:Ai.map(M=>e.jsx(Bs,{value:M.id,className:"text-xs",children:e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsx("span",{children:M.name}),e.jsx("button",{type:"button",className:"h-4 w-4 p-0 ml-2 flex items-center justify-center hover:bg-blue-100 rounded",onClick:me=>{me.preventDefault(),me.stopPropagation(),Q(M.id)},children:e.jsx(_i,{className:"h-3 w-3 text-blue-500 hover:text-blue-700"})})]})},M.id))})]})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"اسم المحفظة"}),e.jsx(z,{value:P,onChange:M=>J(M.target.value),placeholder:"مثال: محفظة العمل",className:"h-6 text-xs"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"رقم الهاتف"}),e.jsxs("div",{className:"relative",children:[e.jsx(na,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(z,{value:F,onChange:M=>G(M.target.value),placeholder:"01030302038",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الرقم القومي للخط"}),e.jsxs("div",{className:"relative",children:[e.jsx(vn,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(z,{value:Z,onChange:M=>re(M.target.value),placeholder:"29012345678901",maxLength:14,className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد الشهري للسحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx($t,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(z,{type:"number",value:he,onChange:M=>ne(M.target.value),placeholder:"200000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد الشهري للتحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx($t,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),e.jsx(z,{type:"number",value:xe,onChange:M=>ie(M.target.value),placeholder:"200000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد اليومي للسحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(xn,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-red-400"}),e.jsx(z,{type:"number",value:te,onChange:M=>Oe(M.target.value),placeholder:"100000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-700 mb-1 block",children:"الحد اليومي للتحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(vr,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-blue-400"}),e.jsx(z,{type:"number",value:Re,onChange:M=>Ce(M.target.value),placeholder:"60000",className:"pl-6 h-6 text-xs"})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",id:"isDefault",checked:Le,onChange:M=>Ue(M.target.checked),className:"rounded w-3 h-3"}),e.jsx("label",{htmlFor:"isDefault",className:"text-xs font-medium text-gray-700",children:"تعيين كمحفظة افتراضية"})]}),e.jsx("div",{className:"border-t pt-2 mt-2",children:e.jsxs("div",{className:"flex items-center gap-1 mb-2",children:[e.jsx(So,{className:"h-3 w-3 text-gray-600"}),e.jsx("label",{className:"text-xs font-medium text-gray-700",children:"إعدادات العمولة"})]})}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(h,{onClick:q,className:"flex-1 h-6 text-xs",size:"sm",children:y?"تحديث المحفظة":"إضافة المحفظة"}),e.jsx(h,{variant:"outline",onClick:nt,className:"h-6 text-xs",size:"sm",children:"إلغاء"})]})]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2",children:$.map(M=>{var me;return e.jsxs(Tt,{className:`${M.isDefault?"border-green-300 bg-green-50":""}`,children:[e.jsx(es,{className:"pb-1",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(us,{className:"text-sm flex items-center gap-1",children:[e.jsx(Js,{className:"h-3 w-3"}),M.name]}),M.isDefault&&e.jsx(qt,{variant:"default",className:"bg-green-600 text-xs px-1 py-0",children:"افتراضية"})]})}),e.jsxs(Ft,{className:"space-y-1 pt-0",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(na,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{className:"text-xs",children:M.phone})]}),M.walletProvider&&e.jsx("div",{className:"text-xs text-blue-600 mt-1",children:((me=Ai.find(Ie=>Ie.id===M.walletProvider))==null?void 0:me.name)||M.walletProvider}),e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-2 rounded-md border border-gray-200 shadow-sm space-y-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-gray-600 mb-1",children:"الحدود الشهرية"}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-red-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-red-400 to-red-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((M.monthlyWithdrawalUsage||0)/M.monthlyWithdrawalLimit*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-blue-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-400 to-blue-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((M.monthlyTransferUsage||0)/M.monthlyTransferLimit*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-xs text-red-600 font-medium",children:["متبقي سحب: ",Math.max(M.monthlyWithdrawalLimit-(M.monthlyWithdrawalUsage||0),0)," جنيه"]}),e.jsxs("div",{className:"text-xs text-blue-600 font-medium",children:["متبقي تحويل: ",Math.max(M.monthlyTransferLimit-(M.monthlyTransferUsage||0),0)," جنيه"]})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-gray-600 mb-1",children:"الحدود اليومية"}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-orange-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-orange-400 to-orange-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((M.dailyWithdrawalUsage||0)/M.dailyWithdrawalLimit*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-green-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-green-400 to-green-600 h-1 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min((M.dailyTransferUsage||0)/M.dailyTransferLimit*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify بين items-center mt-0.5",children:[e.jsxs("div",{className:"text-xs text-orange-600 font-medium",children:["متبقي سحب يومي: ",Math.max(M.dailyWithdrawalLimit-(M.dailyWithdrawalUsage||0),0)," جنيه"]}),e.jsxs("div",{className:"text-xs text-green-600 font-medium",children:["متبقي تحويل يومي: ",Math.max(M.dailyTransferLimit-(M.dailyTransferUsage||0),0)," جنيه"]})]})]})]}),e.jsxs("div",{className:"flex gap-1 pt-1",children:[e.jsxs(h,{size:"sm",variant:"outline",onClick:()=>xt(M),className:"flex-1 h-5 text-xs px-1",children:[e.jsx(_o,{className:"h-2 w-2 mr-0.5"}),"تعديل"]}),!M.isDefault&&e.jsxs(e.Fragment,{children:[e.jsx(h,{size:"sm",variant:"outline",onClick:()=>bt(M.id),className:"flex-1 h-5 text-xs px-1",children:"جعلها افتراضية"}),e.jsx(h,{size:"sm",variant:"destructive",onClick:()=>vt(M.id),className:"h-5 px-1",children:e.jsx(Xt,{className:"h-2 w-2"})})]})]})]})]},M.id)})}),$.length===0&&e.jsx("div",{className:"text-center py-4 text-gray-500 text-xs",children:"لا توجد محافظ متاحة. قم بإضافة محفظة جديدة للبدء."})]}),at&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-800",children:"معلومات صاحب المحفظة"}),e.jsx("button",{onClick:()=>Q(null),className:"h-8 w-8 p-0 flex items-center justify-center hover:bg-gray-100 rounded-full transition-colors",children:e.jsx(Do,{className:"h-4 w-4 text-gray-500"})})]}),(()=>{const M=Ai.find(me=>me.id===at);return M?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-center mb-6",children:e.jsx("div",{className:"bg-blue-100 p-3 rounded-lg inline-block",children:e.jsx("h4",{className:"font-bold text-blue-700 text-lg",children:M.name})})}),e.jsx("div",{className:"bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-200",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-white p-3 rounded-lg shadow-sm",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full mr-2"}),e.jsx("span",{className:"font-semibold text-gray-700",children:"اسم صاحب المحفظة:"})]}),e.jsx("p",{className:"text-gray-900 font-medium text-lg mr-4",children:M.ownerName})]}),e.jsxs("div",{className:"bg-white p-3 rounded-lg shadow-sm",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full mr-2"}),e.jsx("span",{className:"font-semibold text-gray-700",children:"الرقم القومي:"})]}),e.jsx("p",{className:"text-gray-900 font-mono text-lg mr-4 tracking-wider",children:M.nationalId})]})]})}),e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 p-3 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(_i,{className:"h-4 w-4 text-yellow-600 mr-2"}),e.jsx("span",{className:"text-sm text-yellow-800 font-medium",children:"هذه البيانات مسجلة رسمياً في النظام لهذه المحفظة"})]})})]}):null})()]})})]}),e.jsx(as,{open:ht,onOpenChange:Yt,mode:"verify",title:"إدخال الرقم السري الرئيسي",description:"لا يمكن الاطلاع على المحافظ إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{Yt(!1),pe(!0)}}),e.jsx(sh,{isOpen:se,onClose:()=>pe(!1),onWalletSelect:M=>{Vt(M),pe(!1)},onEditWallet:M=>{C(`/user/add-wallet?edit=1&id=${M.id}`),pe(!1)},onDeleteWallet:async M=>{try{if(await Us.delete(M),S(me=>{const Ie=me.filter(it=>it.id!==M);try{localStorage.setItem(je(),JSON.stringify(Ie))}catch(it){console.error("Failed to update localStorage wallets after delete:",it)}return Ie}),c)try{await c()}catch(me){console.error("onWalletUpdate callback failed:",me)}}catch(me){console.error("Error deleting wallet:",me)}}}),e.jsx(rh,{wallet:Lt,isOpen:!!Lt,onClose:()=>Vt(null),onBack:()=>{Vt(null),pe(!0)}})]})},ih=({isOpen:i,onClose:u,transaction:c,onDelete:g})=>{if(!c)return null;const v=S=>{switch(S){case"completed":return e.jsx(wa,{className:"h-5 w-5 text-green-500"});case"pending":return e.jsx(ia,{className:"h-5 w-5 text-yellow-500"});case"failed":return e.jsx(fn,{className:"h-5 w-5 text-red-500"});default:return e.jsx(ia,{className:"h-5 w-5 text-gray-500"})}},D=S=>{switch(S){case"completed":return"مكتملة";case"pending":return"قيد الانتظار";case"failed":return"فاشلة";default:return"غير معروف"}},s=S=>{switch(S){case"withdraw":return"سحب";case"send":return"إرسال";case"receive":return"استقبال";default:return"تحويل"}},C=()=>{const S=!!c.senderNumber,T=!!c.senderName,O=S?"الرقم المرسل:":T?"الرقم الراسل:":"رقم المحفظة:",y=S?c.senderNumber:T?c.senderName:c.senderPhone,N=`
      <div style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 500px; margin: 0 auto; padding: 30px; background: #fff;">
        <!-- Header -->
        <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #2563eb; padding-bottom: 20px;">
          <h1 style="color: #2563eb; margin-bottom: 5px; font-size: 28px;">إيصال المعاملة</h1>
          <p style="color: #666; font-size: 16px; margin: 0;">رقم المرجع: ${c.transactionReference||c.id}</p>
          <p style="color: #888; font-size: 14px; margin: 5px 0 0 0;">${new Date().toLocaleString("ar-EG")}</p>
        </div>
        
        <!-- Shop Info -->
        <div style="background: #f8fafc; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
          <h3 style="color: #1e293b; margin: 0 0 15px 0; font-size: 18px;">معلومات المحل</h3>
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span style="font-weight: 600; color: #475569;">اسم المحل:</span>
            <span style="color: #1e293b;">${c.merchantShopName||c.shopName||"غير محدد"}</span>
          </div>
        </div>
        
        <!-- Transaction Details -->
        <div style="background: #fff; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
          <h3 style="color: #1e293b; margin: 0 0 15px 0; font-size: 18px;">تفاصيل المعاملة</h3>
          
          <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
            <span style="font-weight: 600; color: #475569;">نوع المعاملة:</span>
            <span style="color: #2563eb; font-weight: 600;">${s(c.type)}</span>
          </div>
          
          <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
            <span style="font-weight: 600; color: #475569;">الحالة:</span>
            <span style="color: ${c.status==="completed"?"#16a34a":c.status==="pending"?"#ca8a04":"#dc2626"}; font-weight: 600;">
              ${D(c.status)}
            </span>
          </div>

          ${c!=null&&c.cashierName?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الكاشير:</span>
              <span style="color: #1e293b;">${c.cashierName}</span>
            </div>
          `:""}
          
          ${c.type!=="withdraw"?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">${O}</span>
              <span style="color: #1e293b;">${y}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الرقم المستقبل:</span>
              <span style="color: #1e293b;">${c.receiverNumber||c.receiverPhone}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">المبلغ المحول:</span>
              <span style="color: #2563eb; font-weight: bold; font-size: 16px;">${Cs(c.transferredAmount||c.amount)} جنيه</span>
            </div>
          `:`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">رقم المحفظة:</span>
              <span style="color: #1e293b;">${c.senderPhone}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">المبلغ المسحوب:</span>
              <span style="color: #dc2626; font-weight: bold; font-size: 16px;">${Cs(c.withdrawnAmountDetailed||c.withdrawnAmount||c.amount)} جنيه</span>
            </div>
          `}
          
          ${c.commission?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">العمولة:</span>
              <span style="color: #f59e0b; font-weight: 600;">${Cs(c.commission||0)} جنيه</span>
            </div>
          `:""}
          ${c!=null&&c.fee&&Number(c.fee)>0?`
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
              <span style="font-weight: 600; color: #475569;">الرسوم:</span>
              <span style="color: #64748b; font-weight: 600;">${Cs(c.fee||0)} جنيه</span>
            </div>
          `:""}
          
          <div style="display: flex; justify-content: space-between; padding: 8px 0;">
            <span style="font-weight: 600; color: #475569;">التاريخ والوقت:</span>
            <span style="color: #1e293b;">${c.createdAt.toLocaleString("ar-EG")}</span>
          </div>
        </div>
        
        <!-- Total Amount -->
        <div style="background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); border-radius: 12px; padding: 20px; margin-bottom: 20px; text-align: center;">
          <h3 style="color: white; margin: 0 0 10px 0; font-size: 16px;">إجمالي المبلغ</h3>
          <p style="color: white; font-size: 24px; font-weight: bold; margin: 0;">
            ${c.type==="withdraw"?"-":""}${Cs(c.amount)} جنيه
          </p>
        </div>
        
        
        
        
        <!-- Footer -->
        <div style="text-align: center; color: #64748b; font-size: 12px; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
          <p style="margin: 0 0 5px 0;">شكراً لاستخدام خدماتنا</p>
          <p style="margin: 0;">تم إنشاء الإيصال في: ${new Date().toLocaleString("ar-EG")}</p>
        </div>
      </div>
    `,P=window.open("","_blank");P&&(P.document.write(`
        <html>
          <head>
            <title>إيصال المعاملة - ${c.transactionReference||c.id}</title>
            <meta charset="UTF-8">
            <style>
              body { 
                margin: 0; 
                padding: 20px; 
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: #f8fafc;
              }
              @media print {
                body { 
                  margin: 0; 
                  background: white;
                }
              }
            </style>
          </head>
          <body>
            ${N}
          </body>
        </html>
      `),P.document.close(),P.print())},$=()=>{window.confirm("هل أنت متأكد من حذف هذه المعاملة؟ لا يمكن التراجع عن هذا الإجراء.")&&(g(c.id),u())};return e.jsx(ge,{open:i,onOpenChange:u,children:e.jsxs(fe,{className:"w-[92vw] sm:w-auto sm:max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx(ye,{children:e.jsxs(ve,{className:"flex items-center gap-2 text-xl",children:[e.jsx(pn,{className:"h-6 w-6 text-blue-600"}),"إيصال المعاملة المفصل"]})}),e.jsxs("div",{className:"space-y-6",children:[e.jsx(Tt,{className:"bg-gradient-to-r from-blue-50 to-indigo-50 border-blue-200",children:e.jsxs(es,{className:"text-center pb-2",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 mb-2",children:[v(c.status),e.jsx(qt,{variant:c.status==="completed"?"default":"secondary",className:"text-sm",children:D(c.status)})]}),e.jsxs("h3",{className:"text-2xl font-bold text-blue-600",children:[c.type==="withdraw"?"-":"",Cs(c.amount)," جنيه"]}),e.jsxs("p",{className:"text-sm text-gray-600",children:["رقم المرجع: ",c.transactionReference||c.id]})]})}),e.jsxs(Tt,{children:[e.jsx(es,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Wo,{className:"h-5 w-5 text-green-600"}),e.jsx("h4",{className:"font-semibold text-lg",children:"معلومات المحل"})]})}),e.jsxs(Ft,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"اسم المحل:"}),e.jsx("span",{className:"text-gray-900",children:c.merchantShopName||c.shopName||"غير محدد"})]}),(c==null?void 0:c.cashierName)&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"الكاشير:"}),e.jsx("span",{className:"text-gray-900",children:c.cashierName})]})]})]}),e.jsxs(Tt,{children:[e.jsx(es,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(jr,{className:"h-5 w-5 text-blue-600"}),e.jsx("h4",{className:"font-semibold text-lg",children:"تفاصيل المعاملة"})]})}),e.jsx(Ft,{className:"space-y-3",children:e.jsxs("div",{className:"grid grid-cols-1 gap-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-blue-700",children:"نوع المعاملة:"}),e.jsx(qt,{variant:"outline",className:"bg-blue-100 text-blue-800",children:s(c.type)})]}),c.type!=="withdraw"?e.jsxs(e.Fragment,{children:[(()=>{const S=!!c.senderNumber,T=!!c.senderName,O=S?"الرقم المرسل:":T?"الرقم الراسل:":"رقم المحفظة:",y=S?c.senderNumber:T?c.senderName:c.senderPhone,N=S?ki:na;return e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(N,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:O})]}),e.jsx("span",{className:"text-gray-900 font-mono",children:y})]})})(),e.jsx("div",{className:"flex items-center justify-center p-2",children:e.jsx(im,{className:"h-6 w-6 text-blue-500"})}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-green-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ki,{className:"h-4 w-4 text-green-500"}),e.jsx("span",{className:"font-medium text-green-700",children:"الرقم المستقبل:"})]}),e.jsx("span",{className:"text-green-900 font-mono",children:c.receiverNumber||c.receiverPhone})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx($t,{className:"h-4 w-4 text-blue-500"}),e.jsx("span",{className:"font-medium text-blue-700",children:"المبلغ المحول:"})]}),e.jsxs("span",{className:"text-blue-900 font-bold text-lg",children:[Cs(c.transferredAmount||c.amount)," جنيه"]})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(na,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:"رقم المحفظة:"})]}),e.jsx("span",{className:"text-gray-900 font-mono",children:c.senderPhone})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-red-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx($t,{className:"h-4 w-4 text-red-500"}),e.jsx("span",{className:"font-medium text-red-700",children:"المبلغ المسحوب:"})]}),e.jsxs("span",{className:"text-red-900 font-bold text-lg",children:[Cs(c.withdrawnAmountDetailed||c.withdrawnAmount||c.amount)," جنيه"]})]})]}),c.commission&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-yellow-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-yellow-700",children:"العمولة:"}),e.jsxs("span",{className:"text-yellow-900 font-semibold",children:[c.commission," جنيه"]})]}),(c==null?void 0:c.fee)&&Number(c.fee)>0&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"الرسوم:"}),e.jsxs("span",{className:"text-gray-900 font-semibold",children:[c.fee," جنيه"]})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ba,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:"التاريخ والوقت:"})]}),e.jsx("span",{className:"text-gray-900",children:c.createdAt.toLocaleString("ar-EG")})]})]})})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs(h,{onClick:C,className:"flex-1 bg-blue-600 hover:bg-blue-700 text-white",size:"lg",children:[e.jsx(_m,{className:"h-5 w-5 mr-2"}),"طباعة الإيصال"]}),e.jsxs(h,{onClick:$,variant:"destructive",className:"flex-1",size:"lg",children:[e.jsx(Xt,{className:"h-5 w-5 mr-2"}),"حذف المعاملة"]})]}),e.jsx(h,{onClick:u,variant:"outline",className:"w-full",size:"lg",children:"إغلاق الإيصال"})]})]})})};function yo({open:i,onOpenChange:u,onSuccess:c,title:g,description:v,currentBalance:D,balanceLabel:s,userId:C}){const[$,S]=n.useState(""),[T,O]=n.useState(D.toString()),[y,N]=n.useState(!1),[P,J]=n.useState(""),[F,G]=n.useState(!1),Z=async _=>{_.preventDefault(),J(""),G(!0);try{const W=parseFloat(T);if(isNaN(W)||W<0){J("يرجى إدخال مبلغ صحيح"),G(!1);return}await os.hasMasterPin(C)?await os.verifyMasterPin($,C)?(c(W),u(!1),S(""),O("")):J("الرقم السري غير صحيح"):J("لم يتم تعيين رقم سري رئيسي. يرجى تعيين رقم سري رئيسي أولاً من إعدادات التطبيق")}catch{J("حدث خطأ أثناء التحقق من الرقم السري")}finally{G(!1)}},re=()=>{S(""),O(D.toString()),J(""),u(!1)};return Je.useEffect(()=>{i&&O(D.toString())},[D,i]),e.jsx(ge,{open:i,onOpenChange:re,children:e.jsxs(fe,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ye,{children:e.jsxs(ve,{className:"flex items-center gap-2 text-right",children:[e.jsx($t,{className:"h-5 w-5"}),g]})}),e.jsxs("form",{onSubmit:Z,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:v}),e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg",children:[e.jsxs(X,{className:"text-sm font-medium text-gray-700",children:[s," الحالي"]}),e.jsxs("div",{className:"text-lg font-bold text-gray-900 mt-1",children:[D.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"newAmount",className:"text-right",children:"المبلغ الجديد"}),e.jsx(z,{id:"newAmount",type:"number",step:"0.01",min:"0",value:T,onChange:_=>O(_.target.value),placeholder:"أدخل المبلغ الجديد",className:"text-right",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"pin",className:"text-right",children:"الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(z,{id:"pin",type:y?"text":"password",value:$,onChange:_=>S(_.target.value),placeholder:"أدخل الرقم السري",className:"text-right pr-10",required:!0}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>N(!y),children:y?e.jsx(rs,{className:"h-4 w-4"}):e.jsx(Wt,{className:"h-4 w-4"})})]})]}),P&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-red-600 bg-red-50 p-2 rounded",children:[e.jsx(Ea,{className:"h-4 w-4"}),P]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(h,{type:"button",variant:"outline",onClick:re,className:"flex-1",children:"إلغاء"}),e.jsx(h,{type:"submit",disabled:F||!$||!T,className:"flex-1",children:F?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"جاري التحديث..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Oa,{className:"h-4 w-4 mr-2"}),"تحديث الرصيد"]})})]})]})]})})}class Nr{static getSecretKey(u){return u?`${this.SECRET_KEY_BASE}_${u}`:this.SECRET_KEY_BASE}static setSecretPin(u,c){const g=btoa(u);this.secretCache.set(this.getSecretKey(c),g)}static hasSecretPin(u){return this.secretCache.has(this.getSecretKey(u))}static verifySecretPin(u,c){const g=this.secretCache.get(this.getSecretKey(c));if(!g)return!1;try{return atob(g)===u}catch{return!1}}static clearSecretPin(u){this.secretCache.delete(this.getSecretKey(u))}}Di(Nr,"SECRET_KEY_BASE","dashboard_secret_pin"),Di(Nr,"secretCache",new Map);function lh({open:i,onOpenChange:u,userId:c}){const[g,v]=n.useState(""),[D,s]=n.useState(""),[C,$]=n.useState(""),[S,T]=n.useState(!1),[O,y]=n.useState(!1),[N,P]=n.useState(!1),[J,F]=n.useState(""),[G,Z]=n.useState(!1),{toast:re}=Es(),_=Nr.hasSecretPin(c),W=async ne=>{ne.preventDefault(),F(""),Z(!0);try{if(!D||D.length<4){F("يجب أن يكون الرقم السري 4 أرقام على الأقل"),Z(!1);return}if(D!==C){F("الرقم السري الجديد وتأكيده غير متطابقين"),Z(!1);return}if(_){if(!g){F("يرجى إدخال الرقم السري الحالي"),Z(!1);return}if(!Nr.verifySecretPin(g,c)){F("الرقم السري الحالي غير صحيح"),Z(!1);return}}Nr.setSecretPin(D,c),re({title:_?"تم تغيير الرقم السري":"تم تعيين الرقم السري",description:_?"تم تغيير الرقم السري بنجاح":"تم تعيين الرقم السري بنجاح"}),he()}catch{F("حدث خطأ أثناء حفظ الرقم السري")}finally{Z(!1)}},he=()=>{v(""),s(""),$(""),F(""),T(!1),y(!1),P(!1),u(!1)};return e.jsx(ge,{open:i,onOpenChange:he,children:e.jsxs(fe,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ye,{children:e.jsxs(ve,{className:"flex items-center gap-2 text-right",children:[e.jsx(So,{className:"h-5 w-5"}),_?"تغيير الرقم السري":"تعيين الرقم السري"]})}),e.jsxs("form",{onSubmit:W,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:_?"أدخل الرقم السري الحالي والرقم السري الجديد لتغييره":"أدخل الرقم السري الجديد الذي تريد استخدامه في عمليات التعديل"}),_&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي"}),e.jsxs("div",{className:"relative",children:[e.jsx(z,{id:"currentPin",type:S?"text":"password",autoComplete:"off",value:g,onChange:ne=>v(ne.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>T(!S),children:S?e.jsx(rs,{className:"h-4 w-4"}):e.jsx(Wt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(z,{id:"newPin",type:O?"text":"password",autoComplete:"off",value:D,onChange:ne=>s(ne.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>y(!O),children:O?e.jsx(rs,{className:"h-4 w-4"}):e.jsx(Wt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(z,{id:"confirmPin",type:N?"text":"password",autoComplete:"off",value:C,onChange:ne=>$(ne.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>P(!N),children:N?e.jsx(rs,{className:"h-4 w-4"}):e.jsx(Wt,{className:"h-4 w-4"})})]})]}),J&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(Ea,{className:"h-4 w-4"}),J]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(h,{type:"submit",disabled:G,className:"flex-1",children:[e.jsx(Oa,{className:"h-4 w-4 mr-2"}),G?"جاري الحفظ...":_?"تغيير الرقم السري":"تعيين الرقم السري"]}),e.jsx(h,{type:"button",variant:"outline",onClick:he,disabled:G,children:"إلغاء"})]})]})]})})}const Ti=new Map;function oh({open:i,onOpenChange:u,userId:c}){const[g,v]=n.useState(""),[D,s]=n.useState(""),[C,$]=n.useState(""),[S,T]=n.useState(!1),[O,y]=n.useState(!1),[N,P]=n.useState(!1),[J,F]=n.useState(""),[G,Z]=n.useState(!1),{toast:re}=Es(),_=c?`cash_drawer_pin_${c}`:"cash_drawer_pin",W=()=>Ti.has(_),he=te=>{const Oe=Ti.get(_);if(!Oe)return!1;try{return atob(Oe)===te}catch{return!1}},ne=te=>{const Oe=btoa(te);Ti.set(_,Oe)},xe=async te=>{te.preventDefault(),F(""),Z(!0);try{if(!D||D.length<4){F("يجب أن يكون الرقم السري 4 أرقام على الأقل"),Z(!1);return}if(D!==C){F("الرقم السري الجديد وتأكيده غير متطابقين"),Z(!1);return}if(W()){if(!g){F("يرجى إدخال الرقم السري الحالي لدرج النقدية"),Z(!1);return}if(!he(g)){F("الرقم السري الحالي لدرج النقدية غير صحيح"),Z(!1);return}}ne(D),re({title:W()?"تم تغيير رقم درج النقدية":"تم تعيين رقم درج النقدية",description:W()?"تم تغيير الرقم السري لدرج النقدية بنجاح":"تم تعيين الرقم السري لدرج النقدية بنجاح"}),ie()}catch{F("حدث خطأ أثناء حفظ الرقم السري لدرج النقدية")}finally{Z(!1)}},ie=()=>{v(""),s(""),$(""),F(""),T(!1),y(!1),P(!1),u(!1)};return e.jsx(ge,{open:i,onOpenChange:ie,children:e.jsxs(fe,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ye,{children:e.jsxs(ve,{className:"flex items-center gap-2 text-right",children:[e.jsx($t,{className:"h-5 w-5 text-green-600"}),W()?"تغيير رقم درج النقدية":"تعيين رقم درج النقدية"]})}),e.jsxs("form",{onSubmit:xe,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:W()?"أدخل الرقم السري الحالي والرقم السري الجديد لدرج النقدية":"أدخل الرقم السري الجديد الذي تريد استخدامه لحماية درج النقدية"}),W()&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي لدرج النقدية"}),e.jsxs("div",{className:"relative",children:[e.jsx(z,{id:"currentPin",type:S?"text":"password",autoComplete:"off",value:g,onChange:te=>v(te.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>T(!S),children:S?e.jsx(rs,{className:"h-4 w-4"}):e.jsx(Wt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد لدرج النقدية"}),e.jsxs("div",{className:"relative",children:[e.jsx(z,{id:"newPin",type:O?"text":"password",autoComplete:"off",value:D,onChange:te=>s(te.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>y(!O),children:O?e.jsx(rs,{className:"h-4 w-4"}):e.jsx(Wt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(z,{id:"confirmPin",type:N?"text":"password",autoComplete:"off",value:C,onChange:te=>$(te.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>P(!N),children:N?e.jsx(rs,{className:"h-4 w-4"}):e.jsx(Wt,{className:"h-4 w-4"})})]})]}),J&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(Ea,{className:"h-4 w-4"}),J]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(h,{type:"submit",disabled:G,className:"flex-1 bg-green-600 hover:bg-green-700",children:[e.jsx(Oa,{className:"h-4 w-4 mr-2"}),G?"جاري الحفظ...":W()?"تغيير رقم درج النقدية":"تعيين رقم درج النقدية"]}),e.jsx(h,{type:"button",variant:"outline",onClick:ie,disabled:G,children:"إلغاء"})]})]}),e.jsx("div",{className:"text-xs text-gray-500 text-center mt-2",children:"💰 هذا الرقم السري خاص بحماية درج النقدية فقط"})]})})}const Pi=new Map;function ch({open:i,onOpenChange:u,userId:c}){const[g,v]=n.useState(""),[D,s]=n.useState(""),[C,$]=n.useState(""),[S,T]=n.useState(!1),[O,y]=n.useState(!1),[N,P]=n.useState(!1),[J,F]=n.useState(""),[G,Z]=n.useState(!1),{toast:re}=Es(),_=c?`wallet_total_pin_${c}`:"wallet_total_pin",W=()=>Pi.has(_),he=te=>{const Oe=Pi.get(_);if(!Oe)return!1;try{return atob(Oe)===te}catch{return!1}},ne=te=>{const Oe=btoa(te);Pi.set(_,Oe)},xe=async te=>{te.preventDefault(),F(""),Z(!0);try{if(!D||D.length<4){F("يجب أن يكون الرقم السري 4 أرقام على الأقل"),Z(!1);return}if(D!==C){F("الرقم السري الجديد وتأكيده غير متطابقين"),Z(!1);return}if(W()){if(!g){F("يرجى إدخال الرقم السري الحالي لإجمالي المحفظة"),Z(!1);return}if(!he(g)){F("الرقم السري الحالي لإجمالي المحفظة غير صحيح"),Z(!1);return}}ne(D),re({title:W()?"تم تغيير رقم إجمالي المحفظة":"تم تعيين رقم إجمالي المحفظة",description:W()?"تم تغيير الرقم السري لإجمالي المحفظة بنجاح":"تم تعيين الرقم السري لإجمالي المحفظة بنجاح"}),ie()}catch{F("حدث خطأ أثناء حفظ الرقم السري لإجمالي المحفظة")}finally{Z(!1)}},ie=()=>{v(""),s(""),$(""),F(""),T(!1),y(!1),P(!1),u(!1)};return e.jsx(ge,{open:i,onOpenChange:ie,children:e.jsxs(fe,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ye,{children:e.jsxs(ve,{className:"flex items-center gap-2 text-right",children:[e.jsx(Js,{className:"h-5 w-5 text-blue-600"}),W()?"تغيير رقم إجمالي المحفظة":"تعيين رقم إجمالي المحفظة"]})}),e.jsxs("form",{onSubmit:xe,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:W()?"أدخل الرقم السري الحالي والرقم السري الجديد لإجمالي المحفظة":"أدخل الرقم السري الجديد الذي تريد استخدامه لحماية إجمالي المحفظة"}),W()&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"currentPin",className:"text-right block",children:"الرقم السري الحالي لإجمالي المحفظة"}),e.jsxs("div",{className:"relative",children:[e.jsx(z,{id:"currentPin",type:S?"text":"password",autoComplete:"off",value:g,onChange:te=>v(te.target.value),placeholder:"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>T(!S),children:S?e.jsx(rs,{className:"h-4 w-4"}):e.jsx(Wt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"newPin",className:"text-right block",children:"الرقم السري الجديد لإجمالي المحفظة"}),e.jsxs("div",{className:"relative",children:[e.jsx(z,{id:"newPin",type:O?"text":"password",autoComplete:"off",value:D,onChange:te=>s(te.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>y(!O),children:O?e.jsx(rs,{className:"h-4 w-4"}):e.jsx(Wt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(z,{id:"confirmPin",type:N?"text":"password",autoComplete:"off",value:C,onChange:te=>$(te.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>P(!N),children:N?e.jsx(rs,{className:"h-4 w-4"}):e.jsx(Wt,{className:"h-4 w-4"})})]})]}),J&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(Ea,{className:"h-4 w-4"}),J]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(h,{type:"submit",disabled:G,className:"flex-1 bg-blue-600 hover:bg-blue-700",children:[e.jsx(Oa,{className:"h-4 w-4 mr-2"}),G?"جاري الحفظ...":W()?"تغيير رقم إجمالي المحفظة":"تعيين رقم إجمالي المحفظة"]}),e.jsx(h,{type:"button",variant:"outline",onClick:ie,disabled:G,children:"إلغاء"})]})]}),e.jsx("div",{className:"text-xs text-gray-500 text-center mt-2",children:"💼 هذا الرقم السري خاص بحماية إجمالي المحفظة فقط"})]})})}function dh({open:i,onOpenChange:u,onSuccess:c,title:g,description:v,currentBalance:D,balanceLabel:s,userId:C}){const[$,S]=n.useState(""),[T,O]=n.useState(""),[y,N]=n.useState("add"),[P,J]=n.useState(!1),[F,G]=n.useState(""),[Z,re]=n.useState(!1),[_,W]=n.useState(!1);n.useEffect(()=>{let ie=!0;return(async()=>{const te=await os.hasMasterPin(C);ie&&W(te)})(),()=>{ie=!1}},[C,i]);const he=async ie=>{ie.preventDefault(),G(""),re(!0);try{const te=parseFloat(T);if(isNaN(te)||te<=0){G("يرجى إدخال مبلغ صحيح أكبر من صفر"),re(!1);return}if(y==="subtract"&&te>D){G("لا يمكن خصم مبلغ أكبر من الرصيد الحالي"),re(!1);return}if(_)if(await os.verifyMasterPin($,C)){const Re=y==="add"?te:-te;ne(),c(Re)}else G("الرقم السري غير صحيح");else G("لم يتم تعيين الرقم السري الرئيسي. يرجى تعيينه من إعدادات البروفيل أولاً")}catch{G("حدث خطأ أثناء التحقق من الرقم السري")}finally{re(!1)}},ne=()=>{S(""),O(""),N("add"),G(""),u(!1)},xe=()=>{const ie=parseFloat(T)||0;return y==="add"?D+ie:D-ie};return e.jsx(ge,{open:i,onOpenChange:ne,children:e.jsxs(fe,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ye,{children:e.jsxs(ve,{className:"flex items-center gap-2 text-right",children:[y==="add"?e.jsx(ls,{className:"h-5 w-5 text-green-600"}):e.jsx(ka,{className:"h-5 w-5 text-red-600"}),g]})}),e.jsxs("form",{onSubmit:he,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground text-right",children:v}),e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg",children:[e.jsxs(X,{className:"text-sm font-medium text-gray-700",children:[s," الحالي"]}),e.jsxs("div",{className:"text-lg font-bold text-gray-900 mt-1",children:[D.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{className:"text-right",children:"نوع العملية"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(h,{type:"button",variant:y==="add"?"default":"outline",onClick:()=>N("add"),className:"flex-1 flex items-center gap-2",children:[e.jsx(ls,{className:"h-4 w-4"}),"إضافة"]}),e.jsxs(h,{type:"button",variant:y==="subtract"?"default":"outline",onClick:()=>N("subtract"),className:"flex-1 flex items-center gap-2",children:[e.jsx(ka,{className:"h-4 w-4"}),"خصم"]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(X,{htmlFor:"amount",className:"text-right",children:["المبلغ المراد ",y==="add"?"إضافته":"خصمه"]}),e.jsx(z,{id:"amount",type:"number",step:"0.01",min:"0.01",value:T,onChange:ie=>O(ie.target.value),placeholder:`أدخل المبلغ المراد ${y==="add"?"إضافته":"خصمه"}`,className:"text-right",required:!0})]}),T&&!isNaN(parseFloat(T))&&e.jsxs("div",{className:`p-3 rounded-lg ${y==="add"?"bg-green-50 border border-green-200":"bg-red-50 border border-red-200"}`,children:[e.jsx(X,{className:"text-sm font-medium text-gray-700",children:"الرصيد الجديد المتوقع"}),e.jsxs("div",{className:`text-lg font-bold mt-1 ${y==="add"?"text-green-700":"text-red-700"}`,children:[xe().toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"pin",className:"text-right",children:"الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(z,{id:"pin",type:P?"text":"password",autoComplete:"off",value:$,onChange:ie=>S(ie.target.value),placeholder:"أدخل الرقم السري",className:"text-right pr-10",required:!0}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>J(!P),children:P?e.jsx(rs,{className:"h-4 w-4"}):e.jsx(Wt,{className:"h-4 w-4"})})]})]}),F&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-red-600 bg-red-50 p-2 rounded",children:[e.jsx(Ea,{className:"h-4 w-4"}),F]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(h,{type:"button",variant:"outline",onClick:ne,className:"flex-1",children:"إلغاء"}),e.jsx(h,{type:"submit",disabled:Z||!$||!T,className:`flex-1 ${y==="add"?"bg-green-600 hover:bg-green-700":"bg-red-600 hover:bg-red-700"}`,children:Z?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"جاري التحديث..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Oa,{className:"h-4 w-4 mr-2"}),y==="add"?"إضافة المبلغ":"خصم المبلغ"]})})]})]})]})})}const vo={BASE_URL:"./",DEV:!1,MODE:"production",PROD:!0,SSR:!1,VITE_APP_VERSION:"0.0.0",VITE_DEV_MODE:"true",VITE_ENABLE_OFFLINE_PERSISTENCE:"false",VITE_FIREBASE_API_KEY:"AIzaSyA33RTf43u2QE2OsK1RepQHSKrSet9ZI0s",VITE_FIREBASE_APP_ID:"1:483702062341:web:b1ff06ad175cb7ae428b6c",VITE_FIREBASE_AUTH_DOMAIN:"voda-c6abd.firebaseapp.com",VITE_FIREBASE_AUTH_EMULATOR_URL:"http://localhost:9099",VITE_FIREBASE_FIRESTORE_EMULATOR_HOST:"localhost:8080",VITE_FIREBASE_FUNCTIONS_EMULATOR_HOST:"localhost:5001",VITE_FIREBASE_MEASUREMENT_ID:"G-CV6QGH7G7P",VITE_FIREBASE_MESSAGING_SENDER_ID:"483702062341",VITE_FIREBASE_PROJECT_ID:"voda-c6abd",VITE_FIREBASE_STORAGE_BUCKET:"voda-c6abd.appspot.com",VITE_FORCE_HASH_ROUTER:"true",VITE_SHOP_ID:"demo-shop-001",VITE_SHOP_NAME:"محل كاشي لينك التجريبي",VITE_SHOW_ENV_BANNER:"true",VITE_USE_EMULATORS:"false",VITE_USE_FIREBASE_EMULATOR:"false"},ua=i=>typeof i=="string"&&i.trim().length>0,mh={getCurrentMonthId(){const i=new Date;return`${i.getFullYear()}-${String(i.getMonth()+1).padStart(2,"0")}`},async getWalletUsage(i){var u;try{if(!ua(i))return console.error("Error getting wallet usage: invalid walletId",i),null;const c=Qe(H,"walletLimits",i),g=await va(c);if(g.exists()){const D=g.data();return{walletId:i,used_transfer:D.monthlyTransferUsed??D.used_transfer??0,used_withdraw:D.monthlyWithdrawUsed??D.used_withdraw??0,monthly_limit:D.monthlyLimit??D.monthlyTransferLimit??D.monthlyWithdrawLimit??2e5,last_reset:D.lastMonthlyReset??D.last_reset??null,updatedAt:D.updatedAt||Pa.now()}}const v={walletId:i,used_transfer:0,used_withdraw:0,monthly_limit:2e5,last_reset:null,updatedAt:Pa.now()};return await ks(c,{monthlyTransferUsed:0,monthlyWithdrawUsed:0,monthlyTransferLimit:2e5,monthlyWithdrawLimit:2e5,lastMonthlyReset:null,updatedAt:lt(),ownerId:(u=za.currentUser)==null?void 0:u.uid}),v}catch(c){return console.error("Error getting wallet usage:",c),{walletId:i,used_transfer:0,used_withdraw:0,monthly_limit:2e5,last_reset:null,updatedAt:Pa.now()}}},shouldResetLimits(i){const u=new Date,c=u.getDate();if(!i)return!0;if(c===1){const g=i.toDate(),v=u.getMonth(),D=u.getFullYear();return g.getMonth()!==v||g.getFullYear()!==D}return!1},async autoResetLimitsIfNeeded(i){try{if(!ua(i))return console.error("خطأ في التصفير التلقائي للحدود: walletId غير صالح",i),!1;typeof import.meta<"u";const u=await this.getWalletUsage(i);return u&&this.shouldResetLimits(u.last_reset)?(console.log(`🔄 تصفير تلقائي للحدود للمحفظة ${i} - اليوم الأول من الشهر`),await this.resetWalletUsage(i)):!1}catch(u){return console.error("خطأ في التصفير التلقائي للحدود:",u),!1}},async resetWalletUsage(i){try{if(!ua(i))return console.error("خطأ في تصفير استخدام المحفظة: walletId غير صالح",i),!1;const u=Qe(H,"walletLimits",i);return await ks(u,{monthlyTransferUsed:0,monthlyWithdrawUsed:0,lastMonthlyReset:lt(),updatedAt:lt()},{merge:!0}),console.log(`🔄 تم تصفير استخدام المحفظة ${i} بنجاح`),!0}catch(u){return console.error("خطأ في تصفير استخدام المحفظة:",u),!1}},async calculateUsageFromTransactions(i){var u,c;try{if(!ua(i))return console.error("خطأ في حساب الاستخدام من المعاملات: walletId غير صالح",i),{used_transfer:0,used_withdraw:0};const g=Qe(H,"walletLimits",i),v=new Date;let D=Pa.fromDate(new Date(v.getFullYear(),v.getMonth(),1));try{const T=await va(g);D=T.exists()?((u=T.data())==null?void 0:u.lastMonthlyReset)??((c=T.data())==null?void 0:c.last_reset)??D:D}catch{}const s=st(Te(H,"tx"),ke("uid","==",i),...D?[ke("createdAt",">=",D)]:[]),C=await ct(s);let $=0,S=0;return C.forEach(T=>{const O=T.data();O.status==="completed"&&(O.type==="transfer"?$+=O.amount:O.type==="withdraw"&&(S+=O.amount))}),{used_transfer:$,used_withdraw:S}}catch(g){return console.error("خطأ في حساب الاستخدام من المعاملات:",g),{used_transfer:0,used_withdraw:0}}},async getWalletUsageWithRefresh(i){var u,c;try{if(!ua(i))return console.error("خطأ في الحصول على الاستخدام مع التحديث: walletId غير صالح",i),null;typeof import.meta<"u";const g=await this.getWalletUsage(i);if(!g){const D=await this.calculateUsageFromTransactions(i),s=Qe(H,"walletLimits",i);try{await ks(s,{monthlyTransferUsed:D.used_transfer,monthlyWithdrawUsed:D.used_withdraw,updatedAt:lt(),ownerId:(u=za.currentUser)==null?void 0:u.uid},{merge:!0})}catch{}return{walletId:i,used_transfer:D.used_transfer,used_withdraw:D.used_withdraw,monthly_limit:2e5,last_reset:null,updatedAt:Pa.now()}}const v=await this.calculateUsageFromTransactions(i);if(g.used_transfer!==v.used_transfer||g.used_withdraw!==v.used_withdraw){const D=Qe(H,"walletLimits",i);try{await ks(D,{monthlyTransferUsed:v.used_transfer,monthlyWithdrawUsed:v.used_withdraw,updatedAt:lt(),ownerId:(c=za.currentUser)==null?void 0:c.uid},{merge:!0})}catch{}return await this.getWalletUsage(i)}return g}catch(g){return console.error("خطأ في الحصول على الاستخدام مع التحديث:",g),{walletId:i,used_transfer:0,used_withdraw:0,monthly_limit:2e5,last_reset:null,updatedAt:Pa.now()}}},calculateRemaining(i){return{remainingTransfer:Math.max(0,i.monthly_limit-i.used_transfer),remainingWithdraw:Math.max(0,i.monthly_limit-i.used_withdraw)}},async canPerformOperation(i,u,c){try{if(!ua(i))return console.error("Error checking operation limits: invalid walletId",i),{canPerform:!1,message:"walletId غير صالح"};const g=await this.getWalletUsageWithRefresh(i);if(!g)return{canPerform:!1,message:"لا يمكن العثور على بيانات الاستخدام للمحفظة"};const v=this.calculateRemaining(g);return c==="transfer"&&u>v.remainingTransfer?{canPerform:!1,message:`تجاوز حد التحويل المسموح. المتبقي: ${v.remainingTransfer.toLocaleString()} ج.م من أصل ${g.monthly_limit.toLocaleString()} ج.م`,remaining:v.remainingTransfer}:c==="withdraw"&&u>v.remainingWithdraw?{canPerform:!1,message:`تجاوز حد السحب المسموح. المتبقي: ${v.remainingWithdraw.toLocaleString()} ج.م من أصل ${g.monthly_limit.toLocaleString()} ج.م`,remaining:v.remainingWithdraw}:{canPerform:!0}}catch(g){return console.error("Error checking operation limits:",g),{canPerform:!1,message:"خطأ في التحقق من الحدود"}}},async updateUsage(i,u,c){var g;try{if(!ua(i))throw new Error("walletId غير صالح");const v=await this.getWalletUsageWithRefresh(i);if(!v)throw new Error("لا يمكن العثور على بيانات الاستخدام للمحفظة");const D=await this.canPerformOperation(i,u,c);if(!D.canPerform)throw new Error(D.message||"لا يمكن إجراء العملية");const s=c==="transfer"?v.used_transfer+u:v.used_transfer,C=c==="withdraw"?v.used_withdraw+u:v.used_withdraw,$=Qe(H,"walletLimits",v.walletId);try{await ks($,{monthlyTransferUsed:s,monthlyWithdrawUsed:C,updatedAt:lt(),ownerId:(g=za.currentUser)==null?void 0:g.uid},{merge:!0})}catch{}let S=await this.getWalletUsageWithRefresh(i);return S||(S={walletId:i,used_transfer:s,used_withdraw:C,monthly_limit:v.monthly_limit,last_reset:v.last_reset,updatedAt:Pa.now()}),S}catch(v){throw console.error("Error updating wallet usage:",v),v}},async resetWalletUsageManually(i){try{if(!ua(i))throw new Error("walletId غير صالح");const u=Qe(H,"walletLimits",i),c={walletId:i,used_transfer:0,used_withdraw:0,monthly_limit:0,last_reset:null,updatedAt:new Date};return ks(u,{monthlyTransferUsed:0,monthlyWithdrawUsed:0,lastMonthlyReset:lt(),updatedAt:lt()},{merge:!0}).catch(g=>{console.error("خطأ في حفظ تصفير الاستخدام في Firebase:",g)}),console.log(`✅ تم تصفير استخدام المحفظة ${i} بنجاح`),c}catch(u){throw console.error("Error resetting wallet usage:",u),u}},async getAllWalletsUsage(i){try{const c=(await Us.getByMerchantId(i)).map(v=>this.getWalletUsageWithRefresh(v.id));return(await Promise.all(c)).filter(v=>v!==null)}catch(u){return console.error("Error getting all wallets usage:",u),[]}}};function hh(i){return i?`readBroadcastIds_${i}`:"readBroadcastIds_guest"}function uh({className:i}){const{user:u,profile:c,isSubscriptionActive:g}=Hs(),v=Co(),[D,s]=n.useState([]),[C,$]=n.useState(new Set),[S,T]=n.useState(!1),[O,y]=n.useState(""),[N,P]=n.useState(!1),[J,F]=n.useState(null),[G,Z]=n.useState("none"),[re,_]=n.useState(null),[W,he]=n.useState(!1);n.useRef(new Set),n.useRef(!1);const ne=n.useRef(null),xe=n.useRef(null);n.useRef(null);const[ie,te]=n.useState({position:"fixed",top:0,left:0,zIndex:1e4}),Oe=!1,Re=n.useMemo(()=>{const se=["global"];return u!=null&&u.uid&&se.push(`user:${u.uid}`),c!=null&&c.shopId&&se.push(`shop:${c.shopId}`),se},[u==null?void 0:u.uid,c==null?void 0:c.shopId]),Ce=hh(u==null?void 0:u.uid),Le=n.useMemo(()=>{var ht;const se=(ht=v==null?void 0:v.pathname)==null?void 0:ht.includes("/user/pending-approval");return!!(u!=null&&u.uid)&&!se},[u==null?void 0:u.uid,v==null?void 0:v.pathname]);n.useEffect(()=>{try{const se=localStorage.getItem(Ce);if(se){const pe=JSON.parse(se);Array.isArray(pe)&&$(new Set(pe.filter(Boolean)))}else $(new Set)}catch(se){console.warn("Failed to load read ids",se),$(new Set)}},[Ce]),n.useEffect(()=>{if(!Le){s([]);return}const se=Rm(Re,pe=>{s(pe)});return()=>se()},[Re,Le]),n.useEffect(()=>{},[D]),n.useEffect(()=>()=>{ne.current&&clearTimeout(ne.current)},[]);const Ue=D.reduce((se,pe)=>se+(pe.id&&!C.has(pe.id)?1:0),0),at=se=>{if(!se||C.has(se))return;const pe=new Set(C);pe.add(se),$(pe);try{localStorage.setItem(Ce,JSON.stringify(Array.from(pe)))}catch{}},Q=()=>{const se=D.map(ht=>ht.id).filter(Boolean),pe=new Set(C);se.forEach(ht=>pe.add(ht)),$(pe);try{localStorage.setItem(Ce,JSON.stringify(Array.from(pe)))}catch{}},de=(se,pe)=>{se&&window.open(se,"_blank"),pe&&at(pe)};n.useEffect(()=>{},[W]);const et=async()=>{if(!(u!=null&&u.uid)){alert("يرجى تسجيل الدخول لإرسال الطلب.");return}const se=O.trim();if(!se){alert("يرجى كتابة سبب طلب التحدث.");return}try{P(!0),F(null);const pe=c!=null&&c.fullName&&c.fullName.trim()?c.fullName.trim():u.email?u.email.split("@")[0]:"مستخدم",ht=(c==null?void 0:c.phone)||null;await _s(Te(H,"waiting_list"),{userId:u.uid,name:pe,phone:ht,reason:se,status:"pending",createdAt:lt()}),F("تم إرسال طلبك إلى قائمة الانتظار بنجاح ✅"),y(""),setTimeout(()=>T(!1),900)}catch(pe){console.error("فشل إرسال طلب قائمة الانتظار:",pe),alert("حدث خطأ أثناء إرسال الطلب. حاول مرة أخرى.")}finally{P(!1)}};return n.useEffect(()=>{if(!(u!=null&&u.uid)){Z("none");return}let se=null;try{const pe=st(Te(H,"waiting_list"),ke("userId","==",u.uid));se=Os(pe,ht=>{const Yt=ht.docs.map(je=>({id:je.id,...je.data()})).sort((je,Ke)=>{var nt,q,xt,vt,bt,M;const rt=((q=(nt=je==null?void 0:je.createdAt)==null?void 0:nt.toMillis)==null?void 0:q.call(nt))??((xt=je==null?void 0:je.createdAt)==null?void 0:xt.seconds)*1e3??0;return(((bt=(vt=Ke==null?void 0:Ke.createdAt)==null?void 0:vt.toMillis)==null?void 0:bt.call(vt))??((M=Ke==null?void 0:Ke.createdAt)==null?void 0:M.seconds)*1e3??0)-rt});if(Yt.length===0){Z("none");return}const Lt=Yt[0],Vt=(Lt==null?void 0:Lt.contacted)===!0||(Lt==null?void 0:Lt.status)==="contacted";Z(Vt?"contacted":"pending")})}catch(pe){console.warn("⚠️ فشل الاشتراك في waiting_list للمستخدم:",pe),Z("none")}return()=>{se&&se()}},[u==null?void 0:u.uid]),Le?e.jsxs("div",{className:`relative inline-flex items-center gap-2 ${i||""}`,ref:xe,children:[e.jsxs(Bm,{onOpenChange:se=>{se&&Ue>0&&Q()},children:[e.jsx(Um,{asChild:!0,children:e.jsx(h,{variant:"ghost",className:"relative h-8 w-8 rounded-full p-0 hover:bg-transparent focus:ring-1 focus:ring-primary focus:ring-offset-1 transition-all",title:"الإشعارات",children:e.jsxs("div",{className:"relative h-8 w-8 rounded-full bg-primary/10 flex items-center justify-center border border-border shadow-sm hover:shadow-md",children:[e.jsx(go,{className:"h-4 w-4 text-primary"}),Ue>0&&e.jsx("span",{className:"absolute -top-1 -right-1 min-w-[18px] h-[18px] px-1 rounded-full bg-red-500 text-white text-[10px] font-bold flex items-center justify-center shadow",children:Ue})]})})}),e.jsxs(zm,{className:"w-80",align:"end",forceMount:!0,children:[e.jsxs(qm,{className:"flex items-center justify-between",children:[e.jsx("span",{children:"الإشعارات"}),D.length>0&&e.jsxs(h,{variant:"outline",size:"sm",className:"h-7 text-xs",onClick:Q,children:[e.jsx(wa,{className:"h-3 w-3 mr-1"}),"تمييز الكل كمقروء"]})]}),e.jsx(Vm,{}),D.length===0?e.jsx("div",{className:"p-3 text-sm text-muted-foreground",children:"لا توجد إشعارات حالياً"}):e.jsx("div",{className:"max-h-64 overflow-y-auto pr-1",children:D.map(se=>{const pe=se.id?!C.has(se.id):!1;return e.jsx("div",{className:`px-2 py-2 rounded-md ${pe?"bg-primary/5":""}`,children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(go,{className:`h-4 w-4 ${pe?"text-primary":"text-muted-foreground"}`}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-sm font-medium",children:se.title||"إشعار"}),e.jsx("div",{className:"text-xs text-muted-foreground whitespace-pre-line",children:se.message}),se.linkUrl&&e.jsxs(h,{variant:"link",className:"px-0 h-6 text-xs",onClick:()=>de(se.linkUrl,se.id),children:["فتح الرابط ",e.jsx($m,{className:"h-3 w-3 ml-1"})]})]}),pe?e.jsx(h,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>at(se.id),title:"تمييز كمقروء",children:e.jsx(wa,{className:"h-4 w-4 text-primary"})}):e.jsx(h,{variant:"ghost",size:"icon",className:"h-6 w-6",disabled:!0,title:"مقروء",children:e.jsx(wa,{className:"h-4 w-4 text-muted-foreground"})})]})},se.id)})})]})]}),e.jsxs(ge,{open:S,onOpenChange:T,children:[e.jsx(bm,{asChild:!0,children:e.jsx(h,{variant:"ghost",size:"icon",className:"h-8 w-8 rounded-full hover:bg-transparent focus:ring-1 focus:ring-primary/60 focus:ring-offset-1",title:"قائمة الانتظار",children:e.jsx(ia,{className:`h-4 w-4 ${G==="pending"?"text-red-600":G==="contacted"?"text-green-600":"text-muted-foreground"}`})})}),e.jsxs(fe,{className:"max-w-md border border-purple-200/50 shadow-xl bg-gradient-to-br from-purple-50 to-blue-50",children:[e.jsxs(ye,{children:[e.jsx(ve,{children:"طلب التحدث"}),e.jsx(is,{children:"يرجى كتابة سبب طلب التحدث ليصل للإدارة في قسم قائمة الانتظار."})]}),e.jsxs("div",{className:"grid gap-3",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"سبب الطلب"}),e.jsx(Lm,{value:O,onChange:se=>y(se.target.value),placeholder:"اكتب سبب طلب التحدث هنا...",className:"min-h-[120px] text-right"}),J&&e.jsx("div",{className:"text-sm text-green-700 bg-green-50 border border-green-200 rounded-md p-2",children:J})]}),e.jsxs(dt,{children:[e.jsx(h,{variant:"outline",onClick:()=>T(!1),disabled:N,children:"إلغاء"}),e.jsx(h,{onClick:et,disabled:N,className:"bg-gradient-to-r from-green-600 to-emerald-600 text-white",children:N?"جارٍ الإرسال...":"إرسال"})]})]})]}),Oe]}):null}const bo=({isOpen:i,onClose:u,onTrialStarted:c})=>{const{user:g}=Hs(),[v,D]=n.useState(!1),[s,C]=n.useState(!1),[$,S]=n.useState(""),[T,O]=n.useState(24);n.useEffect(()=>{const P=async()=>{if(g!=null&&g.uid){const F=await br.getTrialData(g.uid);C(F.hasUsedFreeTrial)}},J=async()=>{try{const F=await br.getTrialDurationHours();O(F)}catch{}};i&&(P(),J())},[i,g]);const y=async()=>{if(g!=null&&g.uid){D(!0);try{const P=await br.startFreeTrial(g.uid);P.success?(S(P.message),window.location.href="/user/dashboard"):S(P.message||"تعذر تفعيل التجربة المجانية")}catch{S("حدث خطأ أثناء تفعيل التجربة المجانية")}finally{D(!1)}}},N=async()=>{if(g!=null&&g.uid){D(!0);try{await lm(g.uid,ms.ZERO,g.uid),window.location.href="/user/dashboard"}catch{S("حدث خطأ أثناء تفعيل باقة الزيرو")}finally{D(!1)}}};return e.jsxs(e.Fragment,{children:[i&&e.jsx("div",{className:"fixed inset-0 z-40",style:{background:"rgba(0, 0, 0, 0.15)",pointerEvents:"auto"}}),e.jsx(ge,{open:i,onOpenChange:()=>{},children:e.jsxs(fe,{className:"sm:max-w-lg z-50 border-0 shadow-2xl",style:{position:"fixed",top:"50%",left:"50%",transform:"translate(-50%, -50%)",pointerEvents:"auto",background:"linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 0.95) 100%)",borderRadius:"20px",border:"1px solid rgba(255, 255, 255, 0.3)"},children:[e.jsxs(ye,{className:"text-center pb-0 pt-0",children:[e.jsx("div",{className:"flex justify-center mb-1",children:e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-0 rounded-full",style:{background:"linear-gradient(135deg, #f59e0b, #d97706)",filter:"blur(8px)",opacity:.3}}),e.jsx("div",{className:"relative bg-gradient-to-br from-orange-400 to-orange-600 p-2 rounded-full",children:e.jsx(Ci,{className:"h-12 w-12 text-white"})})]})}),e.jsx(ve,{className:"text-2xl font-bold bg-gradient-to-r from-gray-800 to-gray-600 bg-clip-text text-transparent text-center mt-0 mb-0 leading-tight",children:"تفعيل الحساب مطلوب"})]}),e.jsxs("div",{className:"text-center pt-6 pb-0 px-2",children:[e.jsxs("div",{className:"bg-gradient-to-r from-orange-50 to-amber-50 rounded-xl p-6 mb-6 border border-orange-100",children:[e.jsx("p",{className:"text-gray-700 text-lg leading-relaxed font-medium",children:"حسابك في انتظار التفعيل من قبل المسؤول"}),e.jsx("p",{className:"text-sm font-semibold text-orange-700 mt-3 mb-3 bg-orange-100 p-3 rounded-lg border border-orange-200",children:"للتفعيل السريع: تواصل مع الإدارة عبر واتساب فقط على الرقم التالي"}),e.jsxs("div",{className:"bg-green-50 p-4 rounded-lg border border-green-200 mt-3",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"text-base font-bold text-green-700",children:"واتساب الإدارة:"}),e.jsx("a",{href:"https://wa.me/201000392539",target:"_blank",rel:"noopener noreferrer",className:"text-lg font-bold text-green-600 hover:text-green-700 underline",children:"01000392539"})]}),e.jsx("p",{className:"text-sm text-green-600 mt-2 text-center",children:"اضغط على الرقم للتواصل المباشر عبر واتساب"})]})]}),!s&&e.jsxs("div",{className:"bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-4 mb-4 border border-green-200",children:[e.jsxs("div",{className:"flex items-center justify-center mb-2",children:[e.jsx(Ci,{className:"h-5 w-5 text-green-600 ml-2"}),e.jsx("span",{className:"text-green-700 font-semibold",children:"باقة الزيرو المجانية الدائمة"})]}),e.jsx("p",{className:"text-green-600 text-sm text-center",children:"فعل باقة الزيرو الان واستمتع ب 10 عمليات سحب وتحويل يوميا"})]}),$&&e.jsx("div",{className:`rounded-xl p-4 mb-4 text-center ${$.includes("تم تفعيل")?"bg-green-50 border border-green-200 text-green-700":"bg-red-50 border border-red-200 text-red-700"}`,children:e.jsx("p",{className:"font-medium",children:$})}),e.jsxs("div",{className:"flex items-center justify-center space-x-2 text-sm text-gray-500 mb-0",children:[e.jsxs("div",{className:"flex space-x-1",children:[e.jsx("div",{className:"w-2 h-2 bg-orange-400 rounded-full animate-pulse"}),e.jsx("div",{className:"w-2 h-2 bg-orange-400 rounded-full animate-pulse",style:{animationDelay:"0.2s"}}),e.jsx("div",{className:"w-2 h-2 bg-orange-400 rounded-full animate-pulse",style:{animationDelay:"0.4s"}})]}),e.jsx("span",{className:"mr-2",children:"في انتظار التفعيل"})]})]}),e.jsxs("div",{className:"flex flex-col space-y-3 pb-2",children:[!s&&!$.includes("تم تفعيل")&&e.jsxs(e.Fragment,{children:[e.jsxs(h,{onClick:y,disabled:v,className:"w-full max-w-2xl mx-auto relative bg-gradient-to-r from-blue-600 to-indigo-600 hover:brightness-110 text-white px-10 py-4 rounded-2xl font-bold text-xl ring-2 ring-blue-300 ring-offset-1 shadow-2xl hover:shadow-3xl transition-all duration-500 transform hover:scale-110 hover:-translate-y-1 disabled:opacity-50 disabled:cursor-not-allowed overflow-hidden group focus-visible:outline-none focus-visible:ring-4 focus-visible:ring-blue-300",style:{boxShadow:"0 15px 35px rgba(59, 130, 246, 0.4), 0 5px 15px rgba(0, 0, 0, 0.1)"},children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-white/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"}),e.jsx("div",{className:"absolute -top-1 -left-1 w-3 h-3 bg-yellow-400 rounded-full animate-ping"}),e.jsx("div",{className:"absolute -top-1 -right-1 w-2 h-2 bg-green-400 rounded-full animate-pulse"}),v?e.jsxs("div",{className:"flex items-center relative z-10",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-white ml-3"}),e.jsx("span",{className:"bg-gradient-to-r from-white to-gray-100 bg-clip-text text-transparent",children:"جاري التفعيل..."})]}):e.jsxs("div",{className:"flex items-center relative z-10",children:[e.jsx(Jm,{className:"h-6 w-6 ml-3 animate-bounce"}),e.jsx("span",{className:"bg-gradient-to-r from-white to-gray-100 bg-clip-text text-transparent",children:`التجربة المجانية لمدة ${T} ${T>=3&&T<=10?"ساعات":T===2?"ساعتين":"ساعة"}`})]})]}),e.jsxs(h,{onClick:N,disabled:v,className:"w-full max-w-2xl mx-auto relative bg-gradient-to-r from-green-600 to-emerald-600 hover:brightness-110 text-white px-10 py-4 rounded-2xl font-bold text-xl ring-2 ring-emerald-300 ring-offset-1 shadow-2xl hover:shadow-3xl transition-all duration-500 transform hover:scale-110 hover:-translate-y-1 disabled:opacity-50 disabled:cursor-not-allowed overflow-hidden group focus-visible:outline-none focus-visible:ring-4 focus-visible:ring-emerald-300",style:{boxShadow:"0 15px 35px rgba(99, 102, 241, 0.4), 0 5px 15px rgba(0, 0, 0, 0.1)"},children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-white/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"}),e.jsx("div",{className:"absolute -top-1 -left-1 w-3 h-3 bg-yellow-400 rounded-full animate-ping"}),e.jsx("div",{className:"absolute -top-1 -right-1 w-2 h-2 bg-green-400 rounded-full animate-pulse"}),v?e.jsxs("div",{className:"flex items-center relative z-10",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-white ml-3"}),e.jsx("span",{className:"bg-gradient-to-r from-white to-gray-100 bg-clip-text text-transparent",children:"جاري التفعيل..."})]}):e.jsxs("div",{className:"flex items-center relative z-10",children:[e.jsx(Ci,{className:"h-6 w-6 ml-3 animate-bounce"}),e.jsx("span",{className:"bg-gradient-to-r from-white to-gray-100 bg-clip-text text-transparent",children:"فعّل باقة الزيرو الآن"})]})]})]}),e.jsx(h,{onClick:u,variant:"outline",className:"border-2 border-gray-300 hover:border-gray-400 text-gray-700 hover:text-gray-800 px-10 py-3 rounded-xl font-semibold text-lg transition-all duration-300 transform hover:scale-105",children:s?"فهمت":"إغلاق"})]})]})})]})};function xh({isOpen:i,onClose:u}){const[c,g]=n.useState("0"),[v,D]=n.useState(null),[s,C]=n.useState(null),[$,S]=n.useState(!1),T=_=>{$?(g(_),S(!1)):g(c==="0"?_:c+_)},O=_=>{const W=parseFloat(c);if(v===null)D(W);else if(s){const ne=y(v||0,W,s);g(String(ne)),D(ne)}S(!0),C(_)},y=(_,W,he)=>{switch(he){case"+":return _+W;case"-":return _-W;case"×":return _*W;case"÷":return W===0?0:_/W;case"=":return W;default:return W}},N=()=>{const _=parseFloat(c);if(v!==null&&s){const W=y(v,_,s);g(String(W)),D(null),C(null),S(!0)}},P=()=>{g("0"),D(null),C(null),S(!1)},J=()=>{g("0")},F=()=>{$?(g("0."),S(!1)):c.indexOf(".")===-1&&g(c+".")},G=()=>{c!=="0"&&g(c.charAt(0)==="-"?c.slice(1):"-"+c)},Z=()=>{const _=parseFloat(c);g(String(_/100))},re=_=>{const W=_.key;_.preventDefault(),W>="0"&&W<="9"?T(W):W==="+"?O("+"):W==="-"?O("-"):W==="*"?O("×"):W==="/"?O("÷"):W==="Enter"||W==="="?N():W==="Escape"||W==="c"||W==="C"?P():W==="Backspace"?J():W==="."?F():W==="%"&&Z()};return n.useEffect(()=>(i?document.addEventListener("keydown",re):document.removeEventListener("keydown",re),()=>{document.removeEventListener("keydown",re)}),[i,c,v,s,$]),e.jsx(ge,{open:i,onOpenChange:_=>!_&&u(),children:e.jsxs(fe,{className:"sm:max-w-md",children:[e.jsx(ye,{children:e.jsxs(ve,{className:"flex items-center gap-2 text-right",children:[e.jsx(Fo,{className:"h-5 w-5"}),"آلة حاسبة"]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-gray-900 text-white p-4 rounded-lg text-right",children:e.jsx("div",{className:"text-3xl font-mono font-bold min-h-[3rem] flex items-center justify-end overflow-hidden",children:c})}),e.jsxs("div",{className:"grid grid-cols-4 gap-2",children:[e.jsx(h,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:P,children:"AC"}),e.jsx(h,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:J,children:"CE"}),e.jsx(h,{variant:"outline",className:"h-12 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:Z,children:"%"}),e.jsx(h,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>O("÷"),children:"÷"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>T("7"),children:"7"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>T("8"),children:"8"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>T("9"),children:"9"}),e.jsx(h,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>O("×"),children:"×"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>T("4"),children:"4"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>T("5"),children:"5"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>T("6"),children:"6"}),e.jsx(h,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>O("-"),children:"-"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>T("1"),children:"1"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>T("2"),children:"2"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:()=>T("3"),children:"3"}),e.jsx(h,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:()=>O("+"),children:"+"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50 col-span-2",onClick:()=>T("0"),children:"0"}),e.jsx(h,{variant:"outline",className:"h-12 text-lg font-semibold bg-white hover:bg-gray-50",onClick:F,children:"."}),e.jsx(h,{variant:"outline",className:"h-12 text-sm font-semibold bg-orange-500 text-white hover:bg-orange-600",onClick:N,children:"="})]}),e.jsx(h,{variant:"outline",className:"w-full h-10 text-sm font-semibold bg-gray-100 hover:bg-gray-200",onClick:G,children:"+/-"})]})]})})}function ph({isOpen:i,onClose:u,initialBarcode:c}){const[g,v]=n.useState([]),[D,s]=n.useState({productName:"",price:"",wholesalePrice:"",quantity:"",barcode:"",serialNumber:""}),[C,$]=n.useState(!1),[S,T]=n.useState(null),{toast:O}=Es(),{user:y,profile:N}=Hs(),{isShiftActive:P,shiftUser:J}=Sr(),{shopId:F}=wn(),[G,Z]=n.useState([]),[re,_]=n.useState({}),[W,he]=n.useState({}),[ne,xe]=n.useState({}),[ie,te]=n.useState(""),[Oe,Re]=n.useState(!1),[Ce,Le]=n.useState({}),[Ue,at]=n.useState(!1),[Q,de]=n.useState(!0),[et,se]=n.useState(!1),pe=Je.useRef(""),ht=Je.useRef(0),[Yt,Lt]=n.useState(0),[Vt,je]=n.useState(0),[Ke,rt]=n.useState(!1),[ue,nt]=n.useState(!0),[q,xt]=n.useState(!1),[vt,bt]=n.useState(!0),[M,me]=n.useState(!0),[Ie,it]=n.useState({}),[ot,Pt]=n.useState(!1),[kt,wt]=n.useState("التحقق قبل العملية"),[Ze,Ot]=n.useState("أدخل الرقم السري الرئيسي للمتابعة"),St=Je.useRef(null),Jt=(d,E,p)=>{wt(d),Ot(E),St.current=p,Pt(!0)},[Bt,Is]=n.useState(""),bs=n.useMemo(()=>{const d=Bt.trim().toLowerCase();return d?G.filter(E=>E.name.toLowerCase().includes(d)):G},[G,Bt]),zs=()=>new Date().toISOString().split("T")[0];n.useEffect(()=>{i&&(y!=null&&y.uid)&&(A(),ue||be())},[i,y==null?void 0:y.uid,ue]),n.useEffect(()=>{if(!(!i||!(y!=null&&y.uid)))try{const d=zs(),E=new Intl.DateTimeFormat("en-CA",{timeZone:"Africa/Cairo"}).format(new Date),p=U=>{try{const we=U.docs.map(_e=>{const Ve=_e.data();return{id:String(Ve.clientId||_e.id),productName:String(Ve.productName||""),price:Number(Ve.sellingPrice||0),wholesalePrice:typeof Ve.wholesalePrice=="number"?Ve.wholesalePrice:Number(Ve.wholesalePrice||0),quantity:Number(Ve.quantity||0),date:String(Ve.date||d),time:String(Ve.time||""),performedByType:Ve.performedByType||void 0,performedByName:Ve.performedByName||void 0,performedByUsername:Ve.performedByUsername||null,serialNumber:Ve.serialNumber||void 0,barcode:Ve.barcode||void 0,firestoreId:_e.id}}).filter(_e=>{const Ve=String((_e==null?void 0:_e.date)||"").slice(0,10);return Ve===d||Ve===E}),Ne=(g||[]).filter(_e=>!_e.firestoreId),ce={};[...we,...Ne].forEach(_e=>{ce[_e.id]=_e});const $e=Object.values(ce);ee($e)}catch{}};let k;try{const U=F||(N==null?void 0:N.shopId)||null,K=st(Te(H,"dailySales"),ke("userId","==",y.uid),...U?[ke("shopId","==",U)]:[]);k=Os(K,p,()=>{try{k&&k()}catch{}const we=st(Te(H,"users",y.uid,"dailySales"),...U?[ke("shopId","==",U)]:[]);k=Os(we,p)})}catch{const U=F||(N==null?void 0:N.shopId)||null,K=st(Te(H,"users",y.uid,"dailySales"),...U?[ke("shopId","==",U)]:[]);k=Os(K,p)}return()=>{try{k&&k()}catch{}}}catch{}},[i,y==null?void 0:y.uid]),n.useEffect(()=>{if(!i)return;const d=E=>{const p=Date.now();if(E.key==="Enter"){const k=(pe.current||"").trim();pe.current="",k&&Gs(k);return}E.key.length===1&&(p-(ht.current||0)>100&&(pe.current=""),pe.current+=E.key,ht.current=p)};return window.addEventListener("keydown",d),()=>window.removeEventListener("keydown",d)},[i,G]),n.useEffect(()=>{i&&c&&Gs(c)},[i,c]);const Fs=async()=>{if(y!=null&&y.uid)try{const d=N==null?void 0:N.shopId;let E,p=[];if(d){const k=st(Te(H,"products"),ke("shopId","==",d),ke("userId","==",y.uid));if(E=await ct(k),p=E.docs.map(U=>({id:U.id,name:String(U.data().name??""),sellingPrice:Number(U.data().sellingPrice??0),wholesalePrice:Number(U.data().wholesalePrice??0),quantity:Number(U.data().quantity??0),barcode:String(U.data().barcode??""),serialNumber:String(U.data().serialNumber??"")})),p.length===0){const U=st(Te(H,"products"),ke("userId","==",y.uid)),we=(await ct(U)).docs.map(Ne=>({id:Ne.id,name:String(Ne.data().name??""),sellingPrice:Number(Ne.data().sellingPrice??0),wholesalePrice:Number(Ne.data().wholesalePrice??0),quantity:Number(Ne.data().quantity??0),barcode:String(Ne.data().barcode??""),serialNumber:String(Ne.data().serialNumber??"")}));we.length>0&&(p=we,O({title:"تم استرجاع المنتجات",description:"عثرنا على منتجات محفوظة لك خارج المتجر الحالي وقمنا بعرضها."}))}}else{const k=st(Te(H,"products"),ke("userId","==",y.uid));E=await ct(k),p=E.docs.map(U=>({id:U.id,name:String(U.data().name??""),sellingPrice:Number(U.data().sellingPrice??0),wholesalePrice:Number(U.data().wholesalePrice??0),quantity:Number(U.data().quantity??0),barcode:String(U.data().barcode??""),serialNumber:String(U.data().serialNumber??"")}))}if(Z(p),N!=null&&N.shopId&&p.length>0){const k=p.filter(U=>{const K=((E==null?void 0:E.docs)||[]).find(Ne=>Ne.id===U.id);return!(!!K&&!!K.data().shopId)});if(k.length>0)try{await Promise.all(k.map(U=>Vs(Qe(H,"products",U.id),{shopId:N.shopId,updatedAt:lt()}))),O({title:"تم ترتيب المنتجات",description:"تم ربط بعض المنتجات غير المربوطة بمتجرك الحالي تلقائياً."})}catch(U){console.warn("تعذّر ترحيل shopId لبعض المنتجات:",U)}}}catch(d){console.error("Error loading shop products:",d)}};n.useEffect(()=>{i&&(y!=null&&y.uid)&&(Fs(),be(),A(),B())},[i,y==null?void 0:y.uid,N==null?void 0:N.shopId]);const ws=()=>{const d=new Date,E=d.getFullYear(),p=String(d.getMonth()+1).padStart(2,"0"),k=String(d.getDate()).padStart(2,"0");return`${E}-${p}-${k}`},A=()=>{if(!(y!=null&&y.uid)){console.log("No user authenticated, cannot load sales data");return}const d=F||(N==null?void 0:N.shopId)||"main",E=`salesData_all_${y.uid}_${d}`,p=localStorage.getItem(E);if(p)try{v(JSON.parse(p));return}catch{}const k=ws(),U=`salesData_${y.uid}_${d}_${k}`,K=localStorage.getItem(U);if(K){const $e=JSON.parse(K);v($e);try{localStorage.setItem(E,JSON.stringify($e))}catch{}return}const we=new Date().toISOString().split("T")[0],Ne=`salesData_${y.uid}_${d}_${we}`,ce=localStorage.getItem(Ne);if(ce){const $e=JSON.parse(ce);v($e);try{localStorage.setItem(U,ce),localStorage.setItem(E,ce)}catch{}return}Se()},ee=d=>{if(!(y!=null&&y.uid)){console.log("No user authenticated, cannot save sales data");return}const E=F||(N==null?void 0:N.shopId)||"main",p=ws(),k=`salesData_${y.uid}_${E}_${p}`,U=`salesData_all_${y.uid}_${E}`;localStorage.setItem(k,JSON.stringify(d));try{const K=localStorage.getItem(U),we=K?JSON.parse(K):[],Ne={};[...Array.isArray(we)?we:[],...d].forEach(ce=>{Ne[ce.id]=ce}),localStorage.setItem(U,JSON.stringify(Object.values(Ne)))}catch{}v(d)},oe=d=>{if(!(y!=null&&y.uid)){console.log("No user authenticated, cannot save sales data");return}const E=F||(N==null?void 0:N.shopId)||"main",p=`salesData_all_${y.uid}_${E}`;try{const k=localStorage.getItem(p),U=k?JSON.parse(k):[],K={};[...Array.isArray(U)?U:[],...d].forEach(we=>{K[we.id]=we}),localStorage.setItem(p,JSON.stringify(Object.values(K)))}catch{}v(d)},Se=async()=>{if(y!=null&&y.uid)try{const d=F||(N==null?void 0:N.shopId)||null,E=new Date().toISOString().split("T")[0],p=new Intl.DateTimeFormat("en-CA",{timeZone:"Africa/Cairo"}).format(new Date);let k,U;try{const $e=st(Te(H,"dailySales"),ke("userId","==",y.uid),...d?[ke("shopId","==",d)]:[]);k=await ct($e)}catch{}try{const $e=st(Te(H,"users",y.uid,"dailySales"),...d?[ke("shopId","==",d)]:[]);U=await ct($e)}catch{}const we=[...k?k.docs:[],...U?U.docs:[]].map($e=>{const _e=$e.data();return{id:String(_e.clientId||$e.id),firestoreId:$e.id,productName:String(_e.productName||""),price:Number(_e.sellingPrice||0),wholesalePrice:_e.wholesalePrice!==void 0?Number(_e.wholesalePrice):null,quantity:Number(_e.quantity||0),date:String(_e.date||E),time:String(_e.time||""),serialNumber:_e.serialNumber||void 0,barcode:_e.barcode||void 0,performedByType:_e.performedByType||void 0,performedByName:_e.performedByName||void 0,performedByUsername:_e.performedByUsername||void 0}}),Ne={};[...g,...we].forEach($e=>{Ne[$e.id]=$e});const ce=Object.values(Ne);oe(ce)}catch{}},be=async()=>{if(y!=null&&y.uid)try{const d=new Date,E=new Date(d.getFullYear(),d.getMonth(),1),p=new Date(d.getFullYear(),d.getMonth()+1,0),k=_e=>_e.toISOString().split("T")[0],U=k(E),K=k(p),we=F||(N==null?void 0:N.shopId)||null;let Ne;try{const _e=st(Te(H,"dailySales"),ke("userId","==",y.uid),...we?[ke("shopId","==",we)]:[]);Ne=await ct(_e)}catch{const _e=st(Te(H,"users",y.uid,"dailySales"),...we?[ke("shopId","==",we)]:[]);Ne=await ct(_e)}let ce=0,$e=0;Ne.forEach(_e=>{const Ve=_e.data(),gt=String(Ve.date??"").slice(0,10);if(gt>=U&&gt<=K){const ze=Number(Ve.sellingPrice??0),mt=Number(Ve.quantity??0),_t=Number(Ve.profit??(Number(Ve.sellingPrice??0)-Number(Ve.wholesalePrice??0))*mt);ce+=ze*mt,$e+=_t}}),Lt(ce),je($e)}catch(d){console.error("Error loading monthly stats:",d)}},Fe=async d=>{if(!(y!=null&&y.uid))return null;try{const E=((d.price??0)-(d.wholesalePrice??0))*(d.quantity??0),p=P&&J?"cashier":"admin",k=p==="cashier"?(J==null?void 0:J.name)||"كاشير":(N==null?void 0:N.fullName)||(y==null?void 0:y.displayName)||"الحساب الرئيسي",U=p==="cashier"&&(J==null?void 0:J.username)||null,K=await _s(Te(H,"dailySales"),{userId:y.uid,clientId:d.id,productName:d.productName,quantity:d.quantity,wholesalePrice:d.wholesalePrice??null,sellingPrice:d.price,profit:E,date:d.date,time:d.time,performedByType:p,performedByName:k,performedByUsername:U,serialNumber:d.serialNumber??null,barcode:d.barcode??null,...N!=null&&N.shopId?{shopId:N.shopId}:F?{shopId:F}:{},createdAt:lt()});try{await ks(Qe(H,"users",y.uid,"dailySales",K.id),{userId:y.uid,clientId:d.id,productName:d.productName,quantity:d.quantity,wholesalePrice:d.wholesalePrice??null,sellingPrice:d.price,profit:E,date:d.date,time:d.time,performedByType:p,performedByName:k,performedByUsername:U,serialNumber:d.serialNumber??null,barcode:d.barcode??null,...N!=null&&N.shopId?{shopId:N.shopId}:F?{shopId:F}:{},createdAt:lt()})}catch{}return K.id}catch{try{const E=await _s(Te(H,"users",y.uid,"dailySales"),{userId:y.uid,clientId:d.id,productName:d.productName,quantity:d.quantity,wholesalePrice:d.wholesalePrice??null,sellingPrice:d.price,profit,date:d.date,time:d.time,performedByType,performedByName,performedByUsername,serialNumber:d.serialNumber??null,barcode:d.barcode??null,...N!=null&&N.shopId?{shopId:N.shopId}:F?{shopId:F}:{},createdAt:lt()});try{await ks(Qe(H,"dailySales",E.id),{userId:y.uid,clientId:d.id,productName:d.productName,quantity:d.quantity,wholesalePrice:d.wholesalePrice??null,sellingPrice:d.price,profit,date:d.date,time:d.time,performedByType,performedByName,performedByUsername,serialNumber:d.serialNumber??null,barcode:d.barcode??null,...N!=null&&N.shopId?{shopId:N.shopId}:F?{shopId:F}:{},createdAt:lt()})}catch{}return E.id}catch(E){return console.error("Error saving sale:",E),null}}},Xe=()=>{const d=F||(N==null?void 0:N.shopId)||"main";return`cashBalance_${(y==null?void 0:y.uid)||"default"}_${d}`},B=async()=>{if(!(y!=null&&y.uid))return;const d=g.filter(E=>!E.firestoreId);if(d.length!==0)for(const E of d)try{let p;try{const U=st(Te(H,"dailySales"),ke("userId","==",y.uid),ke("clientId","==",E.id),mn(1));p=await ct(U)}catch{const U=st(Te(H,"users",y.uid,"dailySales"),ke("clientId","==",E.id),mn(1));p=await ct(U)}if(!p.empty){const U=p.docs[0].id,K=g.map(we=>we.id===E.id?{...we,firestoreId:U}:we);ee(K);continue}const k=await Fe(E);if(k){const U=g.map(K=>K.id===E.id?{...K,firestoreId:k}:K);ee(U)}}catch{}},qe=async d=>{try{if(y!=null&&y.uid)try{const ce=Te(H,"deficiencies"),$e=await _s(ce,{shopId:(N==null?void 0:N.shopId)||y.uid||"default-shop",name:d,quantity:1,status:"pending",createdAt:lt()});try{const _e=`deficiencies_${(N==null?void 0:N.shopId)||(y==null?void 0:y.uid)||"default-shop"}`,Ve=localStorage.getItem(_e),gt=Ve?JSON.parse(Ve):[],ze=Array.isArray(gt)?gt:[],mt=ze.some(Ws=>String((Ws==null?void 0:Ws.id)||"")===$e.id),_t={id:$e.id,name:d,quantity:1,status:"pending",createdAt:new Date().toISOString()},Ut=mt?ze:[...ze,_t];localStorage.setItem(_e,JSON.stringify(Ut))}catch{}O({title:"تمت الإضافة للنواقص",description:`المنتج ${d} نفد من المخزون وتمت إضافته للنواقص`});return}catch(ce){console.warn("Failed to add deficiency to Firestore, falling back to local storage:",ce)}const E=`deficiencies_${(N==null?void 0:N.shopId)||(y==null?void 0:y.uid)||"default-shop"}`,p=localStorage.getItem(E),k=p?JSON.parse(p):[],U=Array.isArray(k)?k:[];if(U.some(ce=>String((ce==null?void 0:ce.name)||"").trim()===d&&String((ce==null?void 0:ce.status)||"pending")==="pending"))return;const we={id:Date.now().toString(),name:d,quantity:1,status:"pending",createdAt:new Date().toISOString()},Ne=[...U,we];localStorage.setItem(E,JSON.stringify(Ne)),O({title:"تمت الإضافة للنواقص",description:`المنتج ${d} نفد من المخزون وتمت إضافته للنواقص`})}catch(E){console.error("Error adding deficiency for out-of-stock:",E)}},Y=async d=>{const E=re[d.id]||"",p=parseInt(E);if(isNaN(p)||p<=0){O({title:"كمية غير صالحة",description:"أدخل كمية صحيحة للبيـع",variant:"destructive"});return}if(p>d.quantity){O({title:"كمية أكبر من المتاح",description:"الكمية المطلوب بيعها تتجاوز المخزون المتاح",variant:"destructive"});return}const k=new Date,U=P&&J?"cashier":"admin",K=U==="cashier"?(J==null?void 0:J.name)||"كاشير":(N==null?void 0:N.fullName)||(y==null?void 0:y.displayName)||"الحساب الرئيسي",we=U==="cashier"&&(J==null?void 0:J.username)||null,Ne=(d.serialNumber||"").trim(),ce=Ie[d.id]||"",$e=parseFloat(ce),_e=!isNaN($e)&&$e>0?$e:d.sellingPrice,Ve={id:Date.now().toString(),productName:d.name,price:_e,wholesalePrice:d.wholesalePrice,quantity:p,date:k.toISOString().split("T")[0],time:k.toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit"}),performedByType:U,performedByName:K,performedByUsername:we,serialNumber:Ne||void 0,barcode:d.barcode};try{const gt=await Fe(Ve),ze=gt?{...Ve,firestoreId:gt}:Ve;ee([...g,ze]);const mt=d.quantity-p;await Vs(Qe(H,"products",d.id),{quantity:mt,updatedAt:lt()}),Z(_t=>_t.map(Ut=>Ut.id===d.id?{...Ut,quantity:mt}:Ut)),_(_t=>({..._t,[d.id]:""})),it(_t=>({..._t,[d.id]:""})),mt===0&&qe(d.name);try{const _t=_e*p,Ut=Xe(),Ws=localStorage.getItem(Ut),Na=(Ws?parseFloat(Ws):0)+_t;localStorage.setItem(Ut,Na.toString());const Gt=`userData_${y==null?void 0:y.uid}`,ca={cashBalance:Na,lastUpdated:new Date().toISOString()};localStorage.setItem(Gt,JSON.stringify(ca)),y!=null&&y.uid&&Me.updateUserData(y.uid,ca).catch(()=>{})}catch(_t){console.warn("تعذر تحديث رصيد الدرج النقدي بعد البيع:",_t)}O({title:"تم البيع",description:`تم بيع ${p} قطعة من ${d.name}`})}catch(gt){console.error("Error selling product:",gt),O({title:"فشل البيع",description:"تعذّر تنفيذ عملية البيع",variant:"destructive"})}},pt=async d=>{if(!(y!=null&&y.uid))return;if(P){O({title:"غير مسموح في وضع الكاشير",description:"لا يمكن حذف إيصالات البيع أثناء الورديه",variant:"destructive"});return}window.confirm(`هل تريد حذف إيصال بيع للمنتج "${d.productName}"؟ سيتم عكس المخزون والرصيد.`)&&Jt("تأكيد حذف إيصال بيع","أدخل الرقم السري الرئيسي لحذف الإيصال وعكس الآثار",async()=>{try{try{const p=(d.price??0)*(d.quantity??0),k=Xe(),U=localStorage.getItem(k),we=(U?parseFloat(U):0)-p;localStorage.setItem(k,we.toString());const Ne=`userData_${y==null?void 0:y.uid}`,ce={cashBalance:we,lastUpdated:new Date().toISOString()};localStorage.setItem(Ne,JSON.stringify(ce)),y!=null&&y.uid&&Me.updateUserData(y.uid,ce).catch(()=>{})}catch(p){console.warn("تعذر عكس رصيد الدرج النقدي عند حذف الإيصال:",p)}try{const p=G.find(k=>d.barcode&&k.barcode===d.barcode||k.name===d.productName);if(p){const k=(p.quantity||0)+(d.quantity||0);await Vs(Qe(H,"products",p.id),{quantity:k,updatedAt:lt()}),Z(U=>U.map(K=>K.id===p.id?{...K,quantity:k}:K))}}catch(p){console.warn("تعذر عكس المخزون عند حذف الإيصال:",p)}try{if(d.firestoreId){try{await hs(Qe(H,"dailySales",d.firestoreId))}catch{}try{await hs(Qe(H,"users",y.uid,"dailySales",d.firestoreId))}catch{}}else{let p;try{const k=st(Te(H,"dailySales"),ke("userId","==",y.uid),ke("date","==",d.date),ke("productName","==",d.productName),mn(5));p=await ct(k)}catch{const k=st(Te(H,"users",y.uid,"dailySales"),ke("date","==",d.date),ke("productName","==",d.productName),mn(5));p=await ct(k)}if(!p.empty){const k=p.docs.find(U=>{const K=U.data();return Number((K==null?void 0:K.sellingPrice)??0)===Number(d.price??0)&&Number((K==null?void 0:K.quantity)??0)===Number(d.quantity??0)&&String((K==null?void 0:K.time)??"")===String(d.time??"")})||p.docs[0];k&&await hs(k.ref)}}}catch(p){console.warn("تعذر حذف سجل البيع من Firestore:",p)}try{const p=ws(),k=`salesData_${y.uid}_${p}`,U=`salesData_all_${y.uid}`,K=g.filter($e=>$e.id!==d.id);localStorage.setItem(k,JSON.stringify(K));const we=localStorage.getItem(U),Ne=we?JSON.parse(we):[],ce=(Array.isArray(Ne)?Ne:[]).filter($e=>($e==null?void 0:$e.id)!==d.id);localStorage.setItem(U,JSON.stringify(ce)),v(K)}catch(p){console.warn("تعذر تحديث التخزين المحلي بعد الحذف:",p)}try{ue||await be()}catch{}O({title:"تم حذف الإيصال",description:`تم حذف إيصال بيع للمنتج ${d.productName} وتم عكس الآثار`})}catch(p){console.error("Error deleting sale:",p),O({title:"فشل حذف الإيصال",description:"تعذّر حذف إيصال البيع",variant:"destructive"})}})},jt=async d=>{try{_(E=>({...E,[d.id]:"1"})),await Y(d)}catch(E){console.error("Error selling by barcode:",E)}},Dt=async d=>{if(P){O({title:"غير مسموح في وضع الكاشير",description:"لا يمكن إضافة قطع أثناء الورديه",variant:"destructive"});return}const E=W[d.id]||"",p=parseInt(E);if(isNaN(p)||p<=0){O({title:"كمية غير صالحة",description:"أدخل كمية صحيحة للإضافة",variant:"destructive"});return}Jt("تأكيد إضافة قطع","لا يمكن إضافة قطع إلا بإدخال الرقم السري الرئيسي",async()=>{try{const k=d.quantity+p;await Vs(Qe(H,"products",d.id),{quantity:k,updatedAt:lt()}),Z(U=>U.map(K=>K.id===d.id?{...K,quantity:k}:K)),he(U=>({...U,[d.id]:""})),O({title:"تمت الإضافة",description:`تمت إضافة ${p} قطعة إلى ${d.name}`})}catch(k){console.error("Error adding pieces:",k),O({title:"فشل الإضافة",description:"تعذّر إضافة الكمية إلى المخزون",variant:"destructive"})}})},ts=async d=>{if(!(y!=null&&y.uid))return;if(P){O({title:"غير مسموح في وضع الكاشير",description:"لا يمكن حذف المنتجات أثناء الورديه",variant:"destructive"});return}window.confirm(`هل تريد حذف المنتج "${d.name}"؟`)&&Jt("تأكيد حذف منتج","لا يمكن حذف المنتجات إلا بإدخال الرقم السري الرئيسي",async()=>{try{await hs(Qe(H,"products",d.id)),Z(p=>p.filter(k=>k.id!==d.id)),O({title:"تم الحذف",description:`تم حذف المنتج ${d.name}`})}catch(p){console.error("Error deleting product:",p),O({title:"فشل الحذف",description:"تعذّر حذف المنتج",variant:"destructive"})}})},Ht=async()=>{try{if(!(y!=null&&y.uid)){O({title:"خطأ",description:"غير مسجّل دخول",variant:"destructive"});return}if(P){O({title:"غير مسموح في وضع الكاشير",description:"لا يمكن إضافة منتجات أثناء الورديه",variant:"destructive"});return}const d=D.productName.trim(),E=parseFloat(D.price),p=parseFloat(D.wholesalePrice||"0"),k=parseInt(D.quantity);if(!d||isNaN(E)||isNaN(k)){O({title:"بيانات غير مكتملة",description:"أدخل اسم المنتج والسعر والكمية",variant:"destructive"});return}const U={name:d,sellingPrice:E,wholesalePrice:isNaN(p)?0:p,quantity:isNaN(k)?0:k,userId:y.uid,createdAt:lt(),updatedAt:lt()},K=(D.barcode||"").trim();K&&(U.barcode=K);const we=(D.serialNumber||"").trim();we&&(U.serialNumber=we),N!=null&&N.shopId&&(U.shopId=N.shopId);const Ne=await _s(Te(H,"products"),U);Z(ce=>[{id:Ne.id,name:d,sellingPrice:E,wholesalePrice:isNaN(p)?0:p,quantity:isNaN(k)?0:k,barcode:(D.barcode||"").trim()||"",serialNumber:(D.serialNumber||"").trim()||""},...ce]),s({productName:"",price:"",wholesalePrice:"",quantity:"",barcode:"",serialNumber:""}),O({title:"تمت الإضافة",description:`تم إضافة المنتج ${d} بنجاح`})}catch(d){console.error("createProduct error",d),O({title:"فشل الإضافة",description:"تعذّر إضافة المنتج. حاول مجددًا",variant:"destructive"})}},Gs=async d=>{const E=(d||"").trim();if(!E)return;const p=G.find(k=>(k.barcode||"")===E);if(!p){O({title:"باركود غير معروف",description:"لم يتم العثور على منتج بهذا الباركود"});return}await jt(p)},oa=()=>{const d=Object.entries(Ce).map(([ce,$e])=>{const _e=Number($e),Ve=G.find(gt=>gt.id===ce);return!Ve||!_e||_e<=0?null:{name:Ve.name,qty:_e,price:Ve.sellingPrice,total:_e*Ve.sellingPrice}}).filter(Boolean);if(d.length===0){O({title:"لم يتم اختيار منتجات",description:"فعّل وضع الفاتورة واختر منتجات وكميات للطباعة"});return}const E=(N==null?void 0:N.shopName)||(y==null?void 0:y.displayName)||"المحل",p=(N==null?void 0:N.phone)||(y==null?void 0:y.phoneNumber)||"",k=d.reduce((ce,$e)=>ce+$e.total,0),U=new Date().toLocaleString("ar-EG"),K=d.map(ce=>`
        <tr>
          <td style="border:1px solid #ddd;padding:6px">${ce.name}</td>
          <td style="border:1px solid #ddd;padding:6px;text-align:center">${ce.qty}</td>
          <td style="border:1px solid #ddd;padding:6px;text-align:center">${Kt(ce.price)}</td>
          <td style="border:1px solid #ddd;padding:6px;text-align:center;font-weight:bold;color:#0a7">${Kt(ce.total)}</td>
        </tr>
      `).join(""),we=`
      <html>
        <head>
          <meta charset="utf-8" />
          <title>فاتورة</title>
          <style>
            body { font-family: Tahoma, Arial, sans-serif; direction: rtl; }
            .header { text-align: center; margin-bottom: 12px; }
            .header h2 { margin: 0; }
            .meta { text-align: center; color: #555; margin-bottom: 8px; }
            table { width: 100%; border-collapse: collapse; }
            .total { text-align: left; font-weight: bold; margin-top: 10px; }
          </style>
        </head>
        <body>
          <div class="header">
            <h2>${E}</h2>
            ${p?`<div class="meta">رقم التليفون: ${p}</div>`:""}
            <div class="meta">التاريخ: ${U}</div>
          </div>
          <table>
            <thead>
              <tr>
                <th style="border:1px solid #ddd;padding:6px">المنتج</th>
                <th style="border:1px solid #ddd;padding:6px">الكمية</th>
                <th style="border:1px solid #ddd;padding:6px">السعر</th>
                <th style="border:1px solid #ddd;padding:6px">الإجمالي</th>
              </tr>
            </thead>
            <tbody>
              ${K}
            </tbody>
          </table>
          <div class="total">الإجمالي الكلي: ${Kt(k)}</div>
        </body>
      </html>
    `,Ne=window.open("","_blank");Ne&&(Ne.document.write(we),Ne.document.close(),Ne.focus(),Ne.print(),Ne.close())};return e.jsxs(ge,{open:i,onOpenChange:u,children:[e.jsxs(fe,{className:"max-w-none w-[100vw] md:w-[100vw] lg:w-[100vw] max-h-[85vh] md:h-[100dvh] md:max-h-[100dvh] p-0 overflow-y-auto",children:[e.jsx(ye,{className:"px-3 md:px-6 py-3 md:py-4 border-b bg-gradient-to-r from-blue-50 to-purple-50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 md:gap-3",children:[e.jsx("div",{className:"p-1.5 md:p-2 bg-blue-100 rounded-lg",children:e.jsx(gn,{className:"h-5 w-5 md:h-6 md:w-6 text-blue-600"})}),e.jsxs("div",{children:[e.jsx(ve,{className:"text-lg md:text-xl font-bold text-gray-800",children:"📊 بيانات المبيعات اليومية"}),e.jsxs("p",{className:"text-xs md:text-sm text-gray-600 mt-1 hidden sm:block",children:["إدارة وتتبع مبيعات اليوم - ",new Date().toLocaleDateString("ar-EG")]})]})]}),e.jsxs("div",{className:"flex items-center gap-1 md:gap-2",children:[e.jsx(h,{variant:"outline",size:"sm",onClick:()=>B(),className:"text-xs md:text-sm",children:"استرجاع الإيصالات"}),e.jsx(h,{variant:"ghost",size:"sm",onClick:u,className:"h-8 w-8 md:h-9 md:w-9",children:e.jsx(Do,{className:"h-4 w-4"})})]})]})}),e.jsxs("div",{className:"flex flex-col md:flex-row h-full",dir:"rtl",children:[e.jsxs("div",{className:"w-full md:w-72 lg:w-80 bg-white/50 border-r",children:[e.jsxs("div",{className:"p-3 md:p-4 border-b bg-white/30",children:[e.jsxs("h3",{className:"font-semibold text-gray-800 mb-3 flex items-center gap-2 text-sm md:text-base",children:[e.jsx($t,{className:"h-4 w-4 text-green-600"}),"ملخص المبيعات"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 md:gap-3",children:[e.jsxs("div",{className:"bg-blue-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-blue-600",children:Kt(g.reduce((d,E)=>d+E.price*E.quantity,0))}),e.jsx("div",{className:"text-xs md:text-sm text-blue-600",children:"إجمالي المبيعات"})]}),e.jsxs("div",{className:"relative bg-green-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsxs("div",{className:Q?"filter blur-sm pointer-events-none":"",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-green-600",children:Kt(g.reduce((d,E)=>d+(E.price-(E.wholesalePrice??0))*E.quantity,0))}),e.jsx("div",{className:"text-xs md:text-sm text-green-600",children:"إجمالي الأرباح"})]}),Q&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>se(!0),className:"bg-white/80 hover:bg-white text-green-700 border border-green-200",children:"عرض الأرباح"})})]}),e.jsxs("div",{className:"bg-yellow-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-yellow-600",children:Ua(G.length)}),e.jsx("div",{className:"text-xs md:text-sm text-yellow-600",children:"عدد المنتجات"})]}),e.jsxs("div",{className:"bg-purple-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-purple-600",children:Ua(g.length)}),e.jsx("div",{className:"text-xs md:text-sm text-purple-600",children:"عدد المبيعات"})]})]}),e.jsxs("div",{className:"relative mb-2",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-1 md:gap-2 text-xs md:text-sm font-semibold text-indigo-700",children:[e.jsx(ba,{className:"h-3 w-3 md:h-4 md:w-4"}),e.jsx(gn,{className:"h-3 w-3 md:h-4 md:w-4"}),e.jsx("span",{children:"تقارير الشهر"})]}),e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>xt(d=>!d),className:"h-6 w-6 p-0 rounded-full",title:q?"إظهار التقارير":"إخفاء التقارير",children:q?e.jsx(wr,{className:"h-4 w-4"}):e.jsx(un,{className:"h-4 w-4"})})]}),e.jsx("div",{className:q?"overflow-hidden max-h-0 transition-[max-height] duration-300":"overflow-hidden transition-[max-height] duration-300 max-h-[400px]",children:e.jsxs("div",{className:ue?"grid grid-cols-2 gap-2 md:gap-4 filter blur-sm pointer-events-none":"grid grid-cols-2 gap-2 md:gap-4",children:[e.jsxs("div",{className:"bg-indigo-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-indigo-600",children:Kt(Yt)}),e.jsx("div",{className:"text-xs md:text-sm text-indigo-600",children:"مبيعات الشهر"})]}),e.jsxs("div",{className:"bg-pink-50 p-1 md:p-2 rounded-lg text-center",children:[e.jsx("div",{className:"text-base md:text-lg font-bold text-pink-600",children:Kt(Vt)}),e.jsx("div",{className:"text-xs md:text-sm text-pink-600",children:"أرباح الشهر"})]})]})}),!q&&ue&&e.jsx("div",{className:"absolute left-0 right-0 top-7 md:top-10 bottom-0 flex items-center justify-center rounded-lg bg-yellow-100/60",children:e.jsxs(h,{size:"sm",variant:"ghost",onClick:async()=>{try{if(await isZeroPlan()){O({title:"الخطة زيرو",description:"التقارير الشهرية غير متاحة في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}catch{}rt(!0)},className:"flex items-center gap-2 bg-yellow-200/70 hover:bg-yellow-300 text-yellow-900 px-3 py-2 rounded-xl shadow-md hover:shadow-lg transition-all btn-monthly-reports",title:"عرض تقارير الشهر",children:[e.jsx(Wt,{className:"h-5 w-5 md:h-7 md:w-7"}),e.jsx("span",{className:"text-xs md:text-sm",children:"عرض تقارير الشهر"})]})})]})]}),e.jsxs("div",{className:"p-3 md:p-4 border-b bg-white/30",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("h3",{className:"font-semibold text-gray-800 flex items-center gap-2 text-sm md:text-base",children:[e.jsx(yr,{className:"h-4 w-4 text-indigo-600"}),"إحصائيات المنتجات"]}),e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>bt(d=>!d),className:"h-6 w-6 p-0 rounded-full",title:vt?"إظهار القسم":"إخفاء القسم",children:vt?e.jsx(wr,{className:"h-4 w-4"}):e.jsx(un,{className:"h-4 w-4"})})]}),e.jsx("div",{className:vt?"overflow-hidden max-h-0 transition-[max-height] duration-300":"overflow-hidden transition-[max-height] duration-300 max-h-[400px]"})]}),e.jsxs("div",{className:"p-3 md:p-4 flex-1 hidden md:block",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("h3",{className:"font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(_i,{className:"h-4 w-4 text-blue-600"}),"نصائح للمبيعات"]}),e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>me(d=>!d),className:"h-6 w-6 p-0 rounded-full",title:M?"إظهار القسم":"إخفاء القسم",children:M?e.jsx(wr,{className:"h-4 w-4"}):e.jsx(un,{className:"h-4 w-4"})})]}),e.jsx("div",{className:M?"overflow-hidden max-h-0 transition-[max-height] duration-300":"overflow-hidden transition-[max-height] duration-300 max-h-[400px]"})]})]}),e.jsx("div",{className:"flex-1 overflow-y-visible transition-all duration-300 ease-in-out",children:e.jsxs("div",{className:"p-3 md:p-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 md:mb-6 gap-2",children:[e.jsxs("h2",{className:"text-base md:text-lg font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(Zm,{className:"h-4 w-4 md:h-5 md:w-5 text-blue-600"}),"سجل المبيعات (",g.length," عنصر)"]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs md:text-sm text-gray-600",children:[e.jsx(ba,{className:"h-3 w-3 md:h-4 md:w-4"}),e.jsx("span",{className:"hidden sm:inline",children:new Date().toLocaleDateString("ar-EG")}),e.jsx(ia,{className:"h-3 w-3 md:h-4 md:w-4 ml-2"}),e.jsx("span",{children:new Date().toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit"})})]})]}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-3 md:p-4 mb-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("h3",{className:"text-sm md:text-base font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(ls,{className:"h-4 w-4 text-emerald-600"}),"إضافة منتج جديد"]}),e.jsxs(h,{size:"sm",variant:"ghost",className:"h-8",onClick:()=>{if(P){O({title:"غير مسموح في وضع الكاشير",description:"لا يمكن إضافة منتج أثناء الورديه",variant:"destructive"});return}Jt("فتح نموذج إضافة منتج","أدخل الرقم السري الرئيسي لفتح نموذج الإضافة",()=>$(!0))},children:[e.jsx(ls,{className:"h-4 w-4 text-emerald-600"}),"إضافة منتج"]})]}),C&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx(X,{htmlFor:"new-product-name",className:"text-xs md:text-sm",children:"اسم المنتج"}),e.jsx(z,{id:"new-product-name",value:D.productName,onChange:d=>s(E=>({...E,productName:d.target.value})),placeholder:"أدخل اسم المنتج"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx(X,{htmlFor:"new-product-price",className:"text-xs md:text-sm",children:"سعر البيع (ج.م)"}),e.jsx(z,{type:"number",id:"new-product-price",value:D.price,onChange:d=>s(E=>({...E,price:d.target.value})),placeholder:"0.00"})]}),e.jsxs("div",{children:[e.jsx(X,{htmlFor:"new-product-wholesale",className:"text-xs md:text-sm",children:"سعر الجملة (ج.م)"}),e.jsx(z,{type:"number",id:"new-product-wholesale",value:D.wholesalePrice||"",onChange:d=>s(E=>({...E,wholesalePrice:d.target.value})),placeholder:"0.00"})]})]}),e.jsxs("div",{children:[e.jsx(X,{htmlFor:"new-product-qty",className:"text-xs md:text-sm",children:"الكمية"}),e.jsx(z,{type:"number",id:"new-product-qty",value:D.quantity,onChange:d=>s(E=>({...E,quantity:d.target.value})),placeholder:"1"})]}),e.jsxs("div",{children:[e.jsx(X,{htmlFor:"new-product-barcode",className:"text-xs md:text-sm",children:"باركود المنتج (اختياري)"}),e.jsx(z,{id:"new-product-barcode",value:D.barcode||"",onChange:d=>s(E=>({...E,barcode:d.target.value})),placeholder:"أدخل/امسح الباركود"})]}),e.jsxs("div",{children:[e.jsx(X,{htmlFor:"new-product-serial",className:"text-xs md:text-sm",children:"سيريال الجهاز (اختياري)"}),e.jsx(z,{id:"new-product-serial",value:D.serialNumber||"",onChange:d=>s(E=>({...E,serialNumber:d.target.value})),placeholder:"أدخل سيريال الجهاز"})]}),e.jsx(h,{className:"h-9 w-full md:w-auto bg-indigo-600 hover:bg-indigo-700 text-white",onClick:Ht,children:"إضافة المنتج"})]})]}),e.jsx("div",{id:"shop-products-section",className:"bg-white rounded-lg border border-gray-200 overflow-hidden mb-4",children:e.jsxs("div",{className:"mb-4",children:[e.jsxs("h3",{className:"text-sm md:text-base font-semibold text-gray-800 mb-2 flex items-center gap-2",children:[e.jsx(yr,{className:"h-4 w-4 text-green-600"}),"منتجات المحل"]}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(h,{variant:Oe?"default":"outline",size:"sm",onClick:()=>Re(d=>!d),children:Oe?"وضع الفاتورة: مفعل":"تفعيل وضع الفاتورة"}),e.jsx(h,{size:"sm",className:"bg-indigo-600 hover:bg-indigo-700 text-white",disabled:Object.keys(Ce).filter(d=>(Ce[d]||0)>0).length===0,onClick:oa,children:"طباعة فاتورة"})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(z,{value:Bt,onChange:d=>Is(d.target.value),placeholder:"ابحث عن منتج...",className:"h-9 w-full md:w-72 text-sm","aria-label":"البحث عن منتج من منتجات المحل"}),e.jsx(z,{value:ie,onChange:d=>te(d.target.value),onKeyDown:async d=>{if(d.key!=="Enter")return;const E=ie.trim();E&&(await Gs(E),te(""))},placeholder:"مرّر ماسح الباركود هنا (اختياري)",className:"h-9 w-full md:w-64 text-sm","aria-label":"مسح الباركود لإضافة المنتج تلقائياً"}),Bt&&e.jsx(h,{variant:"ghost",size:"sm",className:"h-9",onClick:()=>Is(""),children:"مسح"})]}),e.jsx("div",{className:"overflow-x-auto border border-gray-200 rounded-lg hidden md:block",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"المنتج"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"سعر البيع"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("span",{children:"سعر الجملة"}),e.jsx(h,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>at(d=>!d),"aria-label":Ue?"إخفاء سعر الجملة":"إظهار سعر الجملة",children:Ue?e.jsx(rs,{className:"h-4 w-4"}):e.jsx(Wt,{className:"h-4 w-4"})})]})}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"المتاح"}),e.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-700",children:"بيع"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:bs.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"px-3 py-3 text-center text-gray-500",children:G.length===0?"لا توجد منتجات بعد، أضف منتجاً من النموذج أعلاه":"لا توجد نتائج مطابقة للبحث"})}):bs.map(d=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-3 py-2 font-medium text-gray-900",children:d.name}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:Kt(d.sellingPrice)}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:e.jsx("span",{className:Ue?"":"blur-sm select-none",children:Kt(d.wholesalePrice)})}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:Ua(d.quantity)}),e.jsx("td",{className:"px-3 py-2",children:e.jsxs("div",{className:"flex items-center gap-2 flex-nowrap",children:[e.jsx(z,{value:re[d.id]||"",onChange:E=>_(p=>({...p,[d.id]:E.target.value})),type:"number",placeholder:"عدد القطع للبيع",className:"h-8 w-28 text-sm"}),e.jsx(z,{value:Ie[d.id]||"",onChange:E=>it(p=>({...p,[d.id]:E.target.value})),type:"number",placeholder:"سعر بيع اختياري",className:"h-8 w-32 text-sm","aria-label":`سعر بيع اختياري لـ ${d.name}`}),e.jsx(h,{size:"sm",className:"h-8 min-w-[64px] bg-indigo-600 hover:bg-indigo-700 text-white",onClick:()=>Y(d),children:"بيع"}),Oe&&e.jsx(z,{value:Ce[d.id]??"",onChange:E=>{const p=parseInt(E.target.value||"0");Le(k=>({...k,[d.id]:isNaN(p)?0:p}))},type:"number",placeholder:"كمية للفاتورة",className:"h-8 w-24 text-sm"}),e.jsx(z,{value:W[d.id]||"",onChange:E=>he(p=>({...p,[d.id]:E.target.value})),type:"number",placeholder:"عدد للإضافة",className:"h-8 w-28 text-sm",disabled:P}),e.jsxs("div",{className:"inline-flex items-center gap-2 flex-nowrap",children:[e.jsx(h,{size:"sm",variant:"outline",className:"h-8 whitespace-nowrap",onClick:()=>Dt(d),disabled:P,title:P?"غير مسموح في وضع الكاشير":void 0,children:"إضافة قطع جديدة"}),e.jsx(h,{size:"sm",variant:"destructive",className:"h-8",onClick:()=>ts(d),title:"حذف المنتج",disabled:P,children:e.jsx(Xt,{className:"h-4 w-4"})})]})]})})]},d.id))})]})}),e.jsx("div",{className:"block md:hidden space-y-3",children:bs.length===0?e.jsx("div",{className:"text-center text-gray-500 text-sm",children:G.length===0?"لا توجد منتجات بعد، أضف منتجاً من النموذج أعلاه":"لا توجد نتائج مطابقة للبحث"}):bs.map(d=>e.jsxs("div",{className:"bg-white rounded-xl p-3 border border-gray-200 shadow-sm",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"font-semibold text-gray-900 text-sm break-words",children:d.name}),e.jsx(h,{size:"sm",variant:"destructive",className:"h-8 min-w-[44px] touch-manipulation",onClick:()=>ts(d),title:"حذف المنتج",disabled:P,children:e.jsx(Xt,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-2 text-xs text-gray-700",children:[e.jsx("div",{className:"text-gray-600",children:"سعر البيع"}),e.jsx("div",{className:"text-right font-medium",children:Kt(d.sellingPrice)}),e.jsxs("div",{className:"text-gray-600 inline-flex items-center gap-1",children:[e.jsx("span",{children:"سعر الجملة"}),e.jsx(h,{variant:"ghost",size:"icon",className:"h-5 w-5",onClick:()=>at(E=>!E),"aria-label":Ue?"إخفاء سعر الجملة":"إظهار سعر الجملة",children:Ue?e.jsx(rs,{className:"h-4 w-4"}):e.jsx(Wt,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"text-right font-medium",children:e.jsx("span",{className:Ue?"":"blur-sm select-none",children:Kt(d.wholesalePrice)})}),e.jsx("div",{className:"text-gray-600",children:"المتاح"}),e.jsx("div",{className:"text-right font-medium",children:Ua(d.quantity)})]}),e.jsxs("div",{className:"mt-3 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(z,{value:re[d.id]||"",onChange:E=>_(p=>({...p,[d.id]:E.target.value})),type:"number",placeholder:"عدد القطع للبيع",className:"h-9 flex-1 text-sm","aria-label":`عدد القطع للبيع لـ ${d.name}`}),e.jsx(z,{value:Ie[d.id]||"",onChange:E=>it(p=>({...p,[d.id]:E.target.value})),type:"number",placeholder:"سعر بيع اختياري",className:"h-9 w-28 text-sm","aria-label":`سعر بيع اختياري لـ ${d.name}`}),e.jsx(h,{size:"sm",className:"h-9 min-w-[64px] bg-indigo-600 hover:bg-indigo-700 text-white",onClick:()=>Y(d),children:"بيع"})]}),Oe&&e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(z,{value:Ce[d.id]??"",onChange:E=>{const p=parseInt(E.target.value||"0");Le(k=>({...k,[d.id]:isNaN(p)?0:p}))},type:"number",placeholder:"كمية للفاتورة",className:"h-9 flex-1 text-sm","aria-label":`كمية للفاتورة لـ ${d.name}`})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(z,{value:W[d.id]||"",onChange:E=>he(p=>({...p,[d.id]:E.target.value})),type:"number",placeholder:"عدد للإضافة",className:"h-9 flex-1 text-sm","aria-label":`عدد القطع للإضافة لـ ${d.name}`,disabled:P}),e.jsx(h,{size:"sm",variant:"outline",className:"h-9 min-w-[64px]",onClick:()=>Dt(d),disabled:P,title:P?"غير مسموح في وضع الكاشير":void 0,children:"إضافة"})]})]})]},d.id))})]})}),g.length===0?e.jsxs("div",{className:"text-center py-8 md:py-12",children:[e.jsx("div",{className:"w-16 h-16 md:w-24 md:h-24 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center",children:e.jsx(yr,{className:"h-8 w-8 md:h-12 md:w-12 text-gray-400"})}),e.jsx("h3",{className:"text-base md:text-lg font-medium text-gray-900 mb-2",children:"لا توجد مبيعات اليوم"}),e.jsx("p",{className:"text-sm text-gray-500",children:"ابدأ ببيع منتج من القائمة أعلاه"})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"block md:hidden",children:e.jsx("div",{className:"max-h-[70vh] overflow-y-auto space-y-3 p-3",children:g.map(d=>e.jsxs("div",{className:"bg-white rounded-xl p-4 border border-gray-200 shadow-sm",children:[e.jsx("div",{className:"mb-3",children:e.jsx("h4",{className:"font-semibold text-gray-900 text-base break-words",children:d.productName})}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-2 text-sm text-gray-700",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx($t,{className:"h-4 w-4 text-blue-600"}),e.jsx("span",{className:"text-gray-600",children:"سعر البيع"})]}),e.jsx("div",{className:"text-right font-medium",children:Kt(d.price)}),typeof d.wholesalePrice=="number"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx($t,{className:"h-4 w-4 text-indigo-600"}),e.jsxs("span",{className:"text-gray-600 inline-flex items-center gap-1",children:["سعر الجملة",e.jsx(h,{variant:"ghost",size:"icon",className:"h-5 w-5",onClick:()=>at(E=>!E),"aria-label":Ue?"إخفاء سعر الجملة":"إظهار سعر الجملة",children:Ue?e.jsx(rs,{className:"h-4 w-4"}):e.jsx(Wt,{className:"h-4 w-4"})})]})]}),e.jsx("div",{className:"text-right font-medium",children:e.jsx("span",{className:Ue?"":"blur-sm select-none",children:Kt(d.wholesalePrice)})})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(yr,{className:"h-4 w-4 text-emerald-600"}),e.jsx("span",{className:"text-gray-600",children:"الكمية"})]}),e.jsx("div",{className:"text-right font-medium",children:Ua(d.quantity)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(vr,{className:"h-4 w-4 text-purple-600"}),e.jsx("span",{className:"text-gray-600",children:"الربح"})]}),e.jsx("div",{className:"text-right font-semibold text-purple-700",children:Kt(((d.price??0)-(d.wholesalePrice??0))*(d.quantity??0))}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx($t,{className:"h-4 w-4 text-green-600"}),e.jsx("span",{className:"text-gray-600",children:"الإجمالي"})]}),e.jsx("div",{className:"text-right font-bold text-green-700",children:Kt(d.price*d.quantity)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Qm,{className:"h-4 w-4 text-amber-600"}),e.jsx("span",{className:"text-gray-600",children:"المنفذ"})]}),e.jsx("div",{className:"text-right text-gray-700",children:d.performedByName??"-"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ba,{className:"h-4 w-4 text-blue-600"}),e.jsx("span",{className:"text-gray-600",children:"التاريخ"})]}),e.jsx("div",{className:"text-right text-gray-600",children:wo(d.date)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ia,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"text-gray-600",children:"الوقت"})]}),e.jsx("div",{className:"text-right text-gray-600",children:d.time})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-end gap-2",children:[e.jsx(h,{size:"sm",variant:"outline",onClick:()=>pt(d),disabled:P,title:P?"غير مسموح في وضع الكاشير":"مرتجع",className:"h-8 border-red-300 text-red-600 hover:bg-red-50",children:"مرتجع"}),e.jsxs(h,{size:"sm",variant:"destructive",onClick:()=>pt(d),disabled:P,title:P?"غير مسموح في وضع الكاشير":"حذف الإيصال",className:"h-8",children:[e.jsx(Xt,{className:"h-4 w-4"}),e.jsx("span",{className:"ml-1",children:"حذف الإيصال"})]})]})]},d.id))})}),e.jsx("div",{className:"hidden md:block overflow-x-auto max-h-96 overflow-y-auto scrollbar-thin scrollbar-thumb-green-300 scrollbar-track-green-100 hover:scrollbar-thumb-green-400",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"المنتج"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"سعر البيع (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("span",{children:"سعر الجملة (ج.م)"}),e.jsx(h,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>at(d=>!d),"aria-label":Ue?"إخفاء سعر الجملة":"إظهار سعر الجملة",children:Ue?e.jsx(rs,{className:"h-4 w-4"}):e.jsx(Wt,{className:"h-4 w-4"})})]})}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الكمية"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الإجمالي (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الربح (ج.م)"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"التاريخ"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"الوقت"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"المنفذ"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"إجراءات"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:g.map((d,E)=>e.jsxs("tr",{className:E%2===0?"bg-white":"bg-gray-50/50",children:[e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-gray-900",children:d.productName}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:Kt(d.price)}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:typeof d.wholesalePrice=="number"?e.jsx("span",{className:Ue?"":"blur-sm select-none",children:Kt(d.wholesalePrice)}):"-"}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:Ua(d.quantity)}),e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-green-600",children:Kt(d.price*d.quantity)}),e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-purple-600",children:Kt(((d.price??0)-(d.wholesalePrice??0))*(d.quantity??0))}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-500",children:wo(d.date)}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-500",children:d.time}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:d.performedByName??"-"}),e.jsx("td",{className:"px-4 py-3 text-sm text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(h,{size:"sm",variant:"outline",onClick:()=>pt(d),disabled:P,title:P?"غير مسموح في وضع الكاشير":"مرتجع",className:"h-8 border-red-300 text-red-600 hover:bg-red-50",children:"مرتجع"}),e.jsx(h,{size:"sm",variant:"destructive",onClick:()=>pt(d),disabled:P,title:P?"غير مسموح في وضع الكاشير":"حذف الإيصال",className:"h-8",children:e.jsx(Xt,{className:"h-4 w-4"})})]})})]},d.id))})]})})]})]})})]})]}),e.jsx(as,{open:et,onOpenChange:se,mode:"verify",title:"قفل إجمالي الأرباح",description:"أدخل الرقم السري الرئيسي لعرض إجمالي الأرباح",onSuccess:()=>{de(!1),se(!1)}}),e.jsx(as,{open:Ke,onOpenChange:rt,mode:"verify",title:"قفل إحصائيات الشهر",description:"لا يمكن الاطلاع على تقارير الشهر إلا بإدخال الرقم السري الرئيسي",onSuccess:async()=>{try{const d=y==null?void 0:y.uid;if(d){const E=await Fi(d),p=(E==null?void 0:E.planType)??(E==null?void 0:E.plan)??null,k=typeof p=="string"?p.toLowerCase():null;if(p===ms.ZERO||k==="zero"){O({title:"الخطة زيرو",description:"التقارير الشهرية غير متاحة في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}}catch{}nt(!1),rt(!1),be()}}),e.jsx(as,{open:ot,onOpenChange:Pt,mode:"verify",title:kt,description:Ze,onSuccess:()=>{const d=St.current;St.current=null,Pt(!1),d&&d()}})]})}const Ua=i=>new Intl.NumberFormat("ar-EG").format(Number(i||0)),Kt=i=>`${new Intl.NumberFormat("ar-EG",{minimumFractionDigits:2,maximumFractionDigits:2}).format(Number(i||0))} ج.م`,wo=i=>{try{const u=new Date(i);return isNaN(u.getTime())?new Date(`${i}T00:00:00`).toLocaleDateString("ar-EG"):u.toLocaleDateString("ar-EG")}catch{return i}},gh=({open:i,onOpenChange:u,userId:c,cashBalance:g,walletBalances:v,transactions:D})=>{const[s,C]=Je.useState(0),[$,S]=Je.useState(0),[T,O]=Je.useState(0),[y,N]=Je.useState(0),[P,J]=Je.useState(g||0),[F,G]=Je.useState(!1),[Z,re]=Je.useState(null),{toast:_}=Es(),{shopId:W}=wn()||{},[he,ne]=Je.useState(!1),[xe,ie]=Je.useState(""),[te,Oe]=Je.useState(!1),[Re,Ce]=Je.useState(!1),[Le,Ue]=Je.useState(""),at=()=>`cashBalance_${c||"default"}_${W||"main"}`,Q=()=>`cashBalance_${c||"default"}`,de=je=>`${new Intl.NumberFormat("ar-EG").format(Number(je||0))} جنيه`;Je.useEffect(()=>{const je=async()=>{try{if(!c){C(0);return}const ue=new Date,nt=ue.getFullYear(),q=String(ue.getMonth()+1).padStart(2,"0"),xt=String(ue.getDate()).padStart(2,"0"),vt=`${nt}-${q}-${xt}`;let bt;try{const me=st(Te(H,"dailySales"),ke("userId","==",c),...W?[ke("shopId","==",W)]:[],ke("date","==",vt));bt=await ct(me)}catch{const me=st(Te(H,"users",c,"dailySales"),...W?[ke("shopId","==",W)]:[],ke("date","==",vt));bt=await ct(me)}let M=0;bt.forEach(me=>{const Ie=me.data(),it=Number(Ie.sellingPrice??0),ot=Number(Ie.quantity??0);it>0&&ot>0&&(M+=it*ot)}),C(M)}catch(ue){console.warn("فشل تحميل مبيعات الإكسسوار لليوم:",ue)}},Ke=async()=>{try{if(!c){setMaintenanceProfitToday(0);return}const ue=new Date,nt=new Date(ue.getFullYear(),ue.getMonth(),ue.getDate(),0,0,0,0),q=new Date(ue.getFullYear(),ue.getMonth(),ue.getDate(),23,59,59,999);let xt;try{const bt=st(Te(H,"maintenance_items"),ke("userId","==",c),ke("status","==","completed"));xt=await ct(bt)}catch{xt=await ct(st(Te(H,"maintenance_items"),ke("userId","==",c)))}let vt=0;xt.forEach(bt=>{var Ie,it;const M=bt.data();if((M.status||"in_progress")!=="completed")return;const me=(it=(Ie=M.completedAt)==null?void 0:Ie.toDate)==null?void 0:it.call(Ie);if(me&&me.getTime()>=nt.getTime()&&me.getTime()<=q.getTime()){const ot=Number(M.repairPrice||0);Number.isFinite(ot)&&ot>0&&(vt+=ot)}}),O(Math.max(0,vt))}catch(ue){console.warn("فشل تحميل إجمالي فلوس الصيانة لليوم:",ue)}},rt=async()=>{try{if(!c){S(0);return}const ue=await Me.getUserData(c),nt=new Date().toISOString().slice(0,10),q=(ue==null?void 0:ue.dailyReceipts)||{};q!=null&&q.date&&String(q.date).slice(0,10)===nt?(S(Number(q.accessory||0)),N(Number(q.maintenance||0))):(S(0),N(0));try{const xt=localStorage.getItem(Q()),vt=localStorage.getItem(at()),bt=xt??vt;bt!=null?J(Number(bt)||0):J(Number((ue==null?void 0:ue.cashBalance)||g||0))}catch{J(Number((ue==null?void 0:ue.cashBalance)||g||0))}}catch{S(0),N(0)}};i&&(je(),Ke(),rt())},[i,c,D,g,W]),Je.useEffect(()=>{const je=Ke=>{var rt;try{const ue=Number((rt=Ke==null?void 0:Ke.detail)==null?void 0:rt.value);if(Number.isFinite(ue))J(ue);else{const nt=localStorage.getItem(Q()),q=localStorage.getItem(at()),xt=nt??q;xt!=null&&J(parseFloat(xt)||0)}}catch{const ue=localStorage.getItem(Q()),nt=localStorage.getItem(at()),q=ue??nt;q!=null&&J(parseFloat(q)||0)}};return window.addEventListener("cashBalanceChanged",je),()=>window.removeEventListener("cashBalanceChanged",je)},[i,c,W]);const et=Math.max(0,Number(s)-Number($)),se=Math.max(0,Number(T)-Number(y)),pe=async je=>{if(!c)return;const Ke=new Date().toISOString().slice(0,10);try{const rt=je==="accessory"?et:se;if(rt<=0){_({title:"لا يوجد مبلغ لتأكيد استلامه",variant:"default"});return}const ue=Math.max(0,Number(P)-rt);J(ue),je==="accessory"?S(nt=>nt+rt):N(nt=>nt+rt),await Me.updateUserData(c,{cashBalance:ue,dailyReceipts:{date:Ke,accessory:je==="accessory"?$+rt:$,maintenance:je==="maintenance"?y+rt:y}});try{localStorage.setItem(`cashBalance_${c}`,String(ue)),localStorage.setItem(at(),String(ue))}catch{}try{window.dispatchEvent(new CustomEvent("cashBalanceChanged",{detail:{value:ue}}))}catch{}_({title:"تم الاستلام",description:`تم خصم ${rt.toFixed(2)} من الدرج وتصفير بند ${je==="accessory"?"الإكسسوار":"الصيانة"}`})}catch{_({title:"خطأ",description:"تعذر تنفيذ عملية تم الاستلام",variant:"destructive"})}},ht=()=>{ie(""),Ue(""),ne(!0)},Yt=()=>{if(!xe.trim()){_({title:"سبب الخصم مطلوب",variant:"destructive"});return}ne(!1),Oe(!0)},Lt=()=>{Oe(!1),Ce(!0)},Vt=async()=>{try{if(!c)return;const je=Math.max(0,Number(Le||0));if(!Number.isFinite(je)||je<=0){_({title:"مبلغ غير صالح",description:"أدخل مبلغ خصم صحيح أكبر من الصفر",variant:"destructive"});return}const Ke=Math.max(0,Number(P)-je);J(Ke),await Me.updateUserData(c,{cashBalance:Ke});try{localStorage.setItem(`cashBalance_${c}`,String(Ke))}catch{}try{localStorage.setItem(at(),String(Ke))}catch{}const rt={title:"ايصال خصم من الفلوس النقديه",type:"cash_deduction",amount:je,status:"completed",createdAt:new Date,note:xe,cashierName:"الحساب الرئيسي"};try{await Me.saveUserTransaction(c,rt)}catch{}_({title:"تم الخصم",description:`تم خصم ${je.toFixed(2)} من الدرج`}),Ce(!1),Ue(""),ie("")}catch{_({title:"فشل الخصم",description:"تعذر تنفيذ عملية الخصم",variant:"destructive"})}};return e.jsx(ge,{open:i,onOpenChange:u,children:e.jsxs(fe,{className:"sm:max-w-lg animate-in fade-in-90 zoom-in-95 slide-in-from-top-4",dir:"rtl",children:[e.jsx(ye,{children:e.jsxs(ve,{className:"flex items-center gap-2 text-right",children:[e.jsx($t,{className:"h-5 w-5 text-emerald-600"}),"تفاصيل الفلوس النقدية"]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between bg-amber-50 border border-amber-200 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-amber-800 font-bold text-sm",children:[e.jsx($t,{className:"h-4 w-4"}),"مجموع الفلوس النقدية (الدرج)"]}),e.jsx("div",{className:"text-amber-700 font-extrabold text-sm",children:de(P)})]}),e.jsxs("div",{className:"flex items-center justify-between bg-blue-50 border border-blue-200 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-blue-800 font-bold text-sm",children:[e.jsx(yr,{className:"h-4 w-4"}),"فلوس الإكسسوار (اليوم)"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-blue-700 font-extrabold text-sm",children:de(et)}),e.jsx(h,{size:"sm",variant:"ghost",className:"h-6 px-2 rounded-lg bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800",onClick:()=>{re("accessory"),G(!0)},children:"تم الاستلام"})]})]}),e.jsxs("div",{className:"flex items-center justify-between bg-emerald-50 border border-emerald-200 rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-emerald-800 font-bold text-sm",children:[e.jsx(Wi,{className:"h-4 w-4"}),"فلوس الصيانة (اليوم)"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-emerald-700 font-extrabold text-sm",children:de(se)}),e.jsx(h,{size:"sm",variant:"ghost",className:"h-6 px-2 rounded-lg bg-gradient-to-r from-emerald-100 to-emerald-200 text-emerald-700 hover:from-emerald-200 hover:to-emerald-300 hover:text-emerald-800",onClick:()=>{re("maintenance"),G(!0)},children:"تم الاستلام"})]})]}),e.jsxs("div",{className:"flex items-center justify-between bg-red-50 border border-red-200 rounded-lg p-2",children:[e.jsx("div",{className:"flex items-center gap-2 text-red-800 font-bold text-sm",children:"خصم فلوس من الفلوس النقديه"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(h,{size:"sm",variant:"ghost",className:"h-6 px-2 rounded-lg bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800",onClick:ht,children:"خصم"})})]})]}),e.jsx(as,{open:F,onOpenChange:G,mode:"verify",title:"تأكيد الرقم السري لعملية تم الاستلام",description:"يرجى إدخال الرقم السري الرئيسي لتأكيد استلام المبلغ",onSuccess:()=>{Z&&(pe(Z),re(null)),G(!1)}}),e.jsx(ge,{open:he,onOpenChange:ne,children:e.jsxs(fe,{className:"sm:max-w-sm",children:[e.jsx(ye,{children:e.jsx(ve,{children:"سبب الخصم"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"deduct-reason",children:"اكتب سبب الخصم"}),e.jsx(z,{id:"deduct-reason",value:xe,onChange:je=>ie(je.target.value),placeholder:"سبب الخصم"})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-3",children:[e.jsx(h,{variant:"outline",onClick:()=>ne(!1),children:"إلغاء"}),e.jsx(h,{onClick:Yt,className:"bg-red-600 hover:bg-red-700",children:"متابعة"})]})]})}),e.jsx(as,{open:te,onOpenChange:Oe,mode:"verify",title:"تأكيد الرقم السري لعملية الخصم",description:"يرجى إدخال الرقم السري الرئيسي لمتابعة الخصم",onSuccess:Lt}),e.jsx(ge,{open:Re,onOpenChange:Ce,children:e.jsxs(fe,{className:"sm:max-w-sm",children:[e.jsx(ye,{children:e.jsx(ve,{children:"مبلغ الخصم"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"deduct-amount",children:"أدخل مبلغ الخصم"}),e.jsx(z,{id:"deduct-amount",type:"number",value:Le,onChange:je=>Ue(je.target.value),placeholder:"0.00"})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-3",children:[e.jsx(h,{variant:"outline",onClick:()=>Ce(!1),children:"إلغاء"}),e.jsx(h,{onClick:Vt,className:"bg-red-600 hover:bg-red-700",children:"تأكيد الخصم"})]})]})})]})})};function Ro({size:i=24,className:u,...c}){return e.jsxs("svg",{width:i,height:i,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",className:u,...c,children:[e.jsx("rect",{x:"5",y:"2.5",width:"14",height:"19",rx:"2.5",stroke:"currentColor",strokeWidth:"1.5"}),e.jsx("rect",{x:"7",y:"4.5",width:"10",height:"5.5",rx:"1",stroke:"currentColor",strokeWidth:"1.2"}),e.jsx("path",{d:"M9.5 11.5h5",stroke:"currentColor",strokeWidth:"1.4",strokeLinecap:"round"}),e.jsx("circle",{cx:"8.5",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"12",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"15.5",cy:"14",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"8.5",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"12",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("circle",{cx:"15.5",cy:"17",r:"0.9",stroke:"currentColor",strokeWidth:"1"}),e.jsx("rect",{x:"8",y:"19",width:"9",height:"1.8",rx:"0.6",stroke:"currentColor",strokeWidth:"1"})]})}var $o="AlertDialog",[fh]=om($o,[Po]),la=Po(),Lo=i=>{const{__scopeAlertDialog:u,...c}=i,g=la(u);return e.jsx(wm,{...g,...c,modal:!0})};Lo.displayName=$o;var yh="AlertDialogTrigger",vh=n.forwardRef((i,u)=>{const{__scopeAlertDialog:c,...g}=i,v=la(c);return e.jsx(Am,{...v,...g,ref:u})});vh.displayName=yh;var bh="AlertDialogPortal",Bo=i=>{const{__scopeAlertDialog:u,...c}=i,g=la(u);return e.jsx(Nm,{...g,...c})};Bo.displayName=bh;var wh="AlertDialogOverlay",Uo=n.forwardRef((i,u)=>{const{__scopeAlertDialog:c,...g}=i,v=la(c);return e.jsx(Im,{...v,...g,ref:u})});Uo.displayName=wh;var Va="AlertDialogContent",[Nh,jh]=fh(Va),Sh=dm("AlertDialogContent"),zo=n.forwardRef((i,u)=>{const{__scopeAlertDialog:c,children:g,...v}=i,D=la(c),s=n.useRef(null),C=Io(u,s),$=n.useRef(null);return e.jsx(jm,{contentName:Va,titleName:qo,docsSlug:"alert-dialog",children:e.jsx(Nh,{scope:c,cancelRef:$,children:e.jsxs(Sm,{role:"alertdialog",...D,...v,ref:C,onOpenAutoFocus:cm(v.onOpenAutoFocus,S=>{var T;S.preventDefault(),(T=$.current)==null||T.focus({preventScroll:!0})}),onPointerDownOutside:S=>S.preventDefault(),onInteractOutside:S=>S.preventDefault(),children:[e.jsx(Sh,{children:g}),e.jsx(Ch,{contentRef:s})]})})})});zo.displayName=Va;var qo="AlertDialogTitle",Vo=n.forwardRef((i,u)=>{const{__scopeAlertDialog:c,...g}=i,v=la(c);return e.jsx(Dm,{...v,...g,ref:u})});Vo.displayName=qo;var Jo="AlertDialogDescription",Ko=n.forwardRef((i,u)=>{const{__scopeAlertDialog:c,...g}=i,v=la(c);return e.jsx(Cm,{...v,...g,ref:u})});Ko.displayName=Jo;var Dh="AlertDialogAction",Yo=n.forwardRef((i,u)=>{const{__scopeAlertDialog:c,...g}=i,v=la(c);return e.jsx(ko,{...v,...g,ref:u})});Yo.displayName=Dh;var Ho="AlertDialogCancel",Go=n.forwardRef((i,u)=>{const{__scopeAlertDialog:c,...g}=i,{cancelRef:v}=jh(Ho,c),D=la(c),s=Io(u,v);return e.jsx(ko,{...D,...g,ref:s})});Go.displayName=Ho;var Ch=({contentRef:i})=>{const u=`\`${Va}\` requires a description for the component to be accessible for screen reader users.

You can add a description to the \`${Va}\` by passing a \`${Jo}\` component as a child, which also benefits sighted users by adding visible context to the dialog.

Alternatively, you can use your own component as a description by assigning it an \`id\` and passing the same value to the \`aria-describedby\` prop in \`${Va}\`. If the description is confusing or duplicative for sighted users, you can use the \`@radix-ui/react-visually-hidden\` primitive as a wrapper around your description component.

For more information, see https://radix-ui.com/primitives/docs/components/alert-dialog`;return n.useEffect(()=>{var g;document.getElementById((g=i.current)==null?void 0:g.getAttribute("aria-describedby"))||console.warn(u)},[u,i]),null},Ih=Lo,Ah=Bo,Qo=Uo,Zo=zo,Xo=Yo,ec=Go,tc=Vo,sc=Ko;const Th=Ih,Ph=Ah,ac=n.forwardRef(({className:i,...u},c)=>e.jsx(Qo,{className:_a("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",i),...u,ref:c}));ac.displayName=Qo.displayName;const rc=n.forwardRef(({className:i,...u},c)=>e.jsxs(Ph,{children:[e.jsx(ac,{}),e.jsx(Zo,{ref:c,className:_a("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",i),...u})]}));rc.displayName=Zo.displayName;const nc=({className:i,...u})=>e.jsx("div",{className:_a("flex flex-col space-y-2 text-center sm:text-left",i),...u});nc.displayName="AlertDialogHeader";const ic=n.forwardRef(({className:i,...u},c)=>e.jsx(tc,{ref:c,className:_a("text-lg font-semibold",i),...u}));ic.displayName=tc.displayName;const lc=n.forwardRef(({className:i,...u},c)=>e.jsx(sc,{ref:c,className:_a("text-sm text-muted-foreground",i),...u}));lc.displayName=sc.displayName;const Ei=n.forwardRef(({className:i,...u},c)=>e.jsx(Xo,{ref:c,className:_a(Ao(),i),...u}));Ei.displayName=Xo.displayName;const oc=n.forwardRef(({className:i,...u},c)=>e.jsx(ec,{ref:c,className:_a(Ao({variant:"outline"}),"mt-2 sm:mt-0",i),...u}));oc.displayName=ec.displayName;const At=i=>{try{return i.toLocaleString("en-US",{maximumFractionDigits:2})}catch{return String(i)}},No=i=>{try{return(i?new Date(i):new Date).toLocaleString("en-GB",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}catch{return new Date().toISOString()}},aa="machine_daily_opening_values",ra="machine_daily_opening_snapshot";function kh({open:i,onOpenChange:u}){const{toast:c}=Es(),{shiftUser:g}=Sr(),{shopId:v,shopName:D}=wn(),s=()=>{try{const A=Object.keys(localStorage||{}).filter(ee=>ee.startsWith("selectedShopId_"));for(const ee of A){const oe=localStorage.getItem(ee);if(oe)return oe}return null}catch{return null}};n.useEffect(()=>{try{if(i){const A=document.body.style.overflow;document.body.setAttribute("data-prev-overflow",A),document.body.style.overflow="hidden"}else{const A=document.body.getAttribute("data-prev-overflow")||"";document.body.style.overflow=A,document.body.removeAttribute("data-prev-overflow")}}catch{}return()=>{try{const A=document.body.getAttribute("data-prev-overflow")||"";document.body.style.overflow=A,document.body.removeAttribute("data-prev-overflow")}catch{}}},[i]);const[C,$]=n.useState(""),[S,T]=n.useState(""),[O,y]=n.useState(""),[N,P]=n.useState(null),[J,F]=n.useState(null),[G,Z]=n.useState(null),[re,_]=n.useState(null),[W,he]=n.useState(!1),[ne,xe]=n.useState(!1),[ie,te]=n.useState(""),[Oe,Re]=n.useState(""),[Ce,Le]=n.useState(null),[Ue,at]=n.useState([]),[Q,de]=n.useState([]),[et,se]=n.useState(!1),[pe,ht]=n.useState(""),[Yt,Lt]=n.useState(""),[Vt,je]=n.useState(!1),[Ke,rt]=n.useState(null),[ue,nt]=n.useState([]),[q,xt]=n.useState(null),[vt,bt]=n.useState(""),[M,me]=n.useState(!1),[Ie,it]=n.useState(!1);n.useEffect(()=>{if(i)try{const A=q?`${aa}_${q}`:aa,ee=q?`${ra}_${q}`:ra,oe=localStorage.getItem(A);if(oe){const be=JSON.parse(oe);typeof(be==null?void 0:be.openingBase)=="number"&&P(be.openingBase),typeof(be==null?void 0:be.openingAir)=="number"&&F(be.openingAir),typeof(be==null?void 0:be.drawerCash)=="number"&&Z(be.drawerCash)}else P(null),F(null),Z(null);const Se=localStorage.getItem(ee);if(Se){const be=JSON.parse(Se);typeof(be==null?void 0:be.openingBase)=="number"&&typeof(be==null?void 0:be.openingAir)=="number"?_({openingBase:be.openingBase,openingAir:be.openingAir,drawerCash:be.drawerCash||0}):_(null)}else _(null)}catch{}},[i,q]),n.useEffect(()=>{(async()=>{try{const A=v||s();if(!i||!A)return;const{getDocs:ee}=await Nt(async()=>{const{getDocs:Fe}=await import("./index-CMr4Oi63.js").then(Xe=>Xe.bo);return{getDocs:Fe}},__vite__mapDeps([0,1]),import.meta.url),oe=Te(H,"shops",A,"machines"),be=(await ee(st(oe))).docs.map(Fe=>({id:Fe.id,name:String(Fe.data().name||"ماكينة")}));nt(be);try{const Fe=localStorage.getItem(`machineDaily_selected_${A}`);Fe&&be.some(B=>B.id===Fe)?xt(Fe):!q&&be.length>0&&(xt(be[0].id),localStorage.setItem(`machineDaily_selected_${A}`,be[0].id))}catch{}}catch(A){console.error("Load machines error:",A)}})()},[i,v]);const ot=n.useMemo(()=>(g==null?void 0:g.displayName)||(g==null?void 0:g.name)||(g==null?void 0:g.username)||void 0,[g]),Pt=n.useMemo(()=>Q.reduce((A,ee)=>A+(ee.profit||0),0),[Q]),kt=n.useMemo(()=>Q.reduce((A,ee)=>A+(ee.wholesalePrice||0),0),[Q]),wt=async()=>{try{const A=v||s();if(A&&q){const ee=Te(H,"shops",A,"machines",q,"transfers"),oe=await ct(st(ee));await Promise.all(oe.docs.map(Se=>hs(Se.ref)));try{localStorage.setItem(`machineDaily_transfers_${A}_${q}`,JSON.stringify([]))}catch{}}}catch{}de([]),c({title:"تم حذف الإيصالات",description:"تم مسح كل إيصالات التحويل."})},Ze=async()=>{try{const A=v||s();if(A&&q){const ee=Te(H,"shops",A,"machines",q,"deliveries"),oe=await ct(st(ee));await Promise.all(oe.docs.map(Se=>hs(Se.ref)));try{localStorage.setItem(`machineDaily_deliveries_${A}_${q}`,JSON.stringify([]))}catch{}}}catch{}at([]),c({title:"تم حذف الإيصالات",description:"تم مسح كل إيصالات الماكينة."})},Ot=A=>{at(ee=>ee.filter(oe=>oe.id!==A)),c({title:"تم حذف الإيصال",description:"تم إزالة إيصال الماكينة المحدد."})},St=()=>{P(null),F(null),Z(null),_(null),$(""),T(""),y("");try{const A=q?`${aa}_${q}`:aa,ee=q?`${ra}_${q}`:ra;localStorage.removeItem(A),localStorage.removeItem(ee)}catch{}c({title:"تم التصفير",description:"يمكنك الآن إدخال رصيد افتتاحي جديد."})},Jt=async()=>{var Se;const A=parseFloat(C||"0"),ee=parseFloat(S||"0"),oe=parseFloat(O||"0");if(isNaN(A)||isNaN(ee)||isNaN(oe)){c({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة للرصيد الافتتاحي وفلوس الدرج.",variant:"destructive"});return}if(A<0||ee<0||oe<0){c({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}P(A),F(ee),Z(oe);try{const be=q?`${aa}_${q}`:aa,Fe=q?`${ra}_${q}`:ra;localStorage.setItem(be,JSON.stringify({openingBase:A,openingAir:ee,drawerCash:oe})),localStorage.setItem(Fe,JSON.stringify({openingBase:A,openingAir:ee,drawerCash:oe})),_({openingBase:A,openingAir:ee,drawerCash:oe});const Xe=v||s();if(Xe&&q){const B=Qe(H,"shops",Xe,"machines",q);await ks(B,{name:((Se=ue.find(qe=>qe.id===q))==null?void 0:Se.name)||"ماكينة",openingBase:A,openingAir:ee,drawerCash:oe,cashierName:ot,shopName:D||null,updatedAt:lt()},{merge:!0})}}catch{}c({title:"تم تسجيل البيانات",description:`الافتتاحي الأساسي: ${At(A)}، الهواء: ${At(ee)}، فلوس الدرج: ${At(oe)}`})},Bt=()=>{if(N==null||J==null){c({title:"سجل الرصيد الافتتاحي أولاً",description:'يرجى الضغط على زر "إضافة" بعد إدخال الافتتاحي.'});return}xe(!0)},Is=()=>{const A=parseFloat(ie||"0"),ee=parseFloat(Oe||"0");if(isNaN(A)||isNaN(ee)){c({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة لرصيد التسليم.",variant:"destructive"});return}if(A<0||ee<0){c({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}const oe=(re==null?void 0:re.openingBase)??(N||0),Se=(re==null?void 0:re.openingAir)??(J||0),be=oe+Se,Xe=A+ee-be;Le(Xe);const B={id:`${Date.now()}`,openingBase:oe,openingAir:Se,deliveryBase:A,deliveryAir:ee,netResult:Xe,createdAt:new Date().toISOString(),cashierName:ot,requiredDrawerNoProfit:Xe<0?Math.round(-Xe*100)/100:0};(async()=>{try{const qe=v||s();qe&&q&&(await _s(Te(H,"shops",qe,"machines",q,"deliveries"),{cashierName:ot,openingBase:oe,openingAir:Se,deliveryBase:A,deliveryAir:ee,netResult:Xe,createdAt:lt()}),await ks(Qe(H,"shops",qe,"machines",q),{lastDeliveryAt:lt(),updatedAt:lt()},{merge:!0}))}catch(qe){console.error("Persist delivery error:",qe)}})(),at(qe=>[B,...qe]);try{const qe=v||s(),Y=qe&&q?`machineDaily_deliveries_${qe}_${q}`:`machineDaily_deliveries_${q}`,pt=localStorage.getItem(Y),jt=pt?JSON.parse(pt):[],Dt=[B,...Array.isArray(jt)?jt:[]];localStorage.setItem(Y,JSON.stringify(Dt))}catch{}c({title:"تم إنشاء إيصال تسليم",description:`الناتج النهائي: ${At(Xe)}`})},bs=()=>{const A=parseFloat(pe||"0"),ee=parseFloat(Yt||"0");if(!Number.isFinite(A)||!Number.isFinite(ee)){c({title:"قيمة غير صالحة",description:"يرجى إدخال أرقام صحيحة لسعر الجملة وسعر التجزئة.",variant:"destructive"});return}if(A<0||ee<0){c({title:"قيمة سالبة",description:"لا يمكن إدخال قيم سالبة.",variant:"destructive"});return}if(N==null||J==null){c({title:"سجل الرصيد الافتتاحي أولاً",description:'يرجى إدخال الرصيد الأساسي ورصيد الهواء ثم الضغط "إضافة".'});return}const oe=Math.round((ee-A)*100)/100;rt({wholesalePrice:A,retailPrice:ee,profit:oe}),je(!0)},zs=async A=>{if(!Ke)return;const ee={id:`transfer_${Date.now()}`,wholesalePrice:Ke.wholesalePrice,retailPrice:Ke.retailPrice,profit:Ke.profit,createdAt:new Date().toISOString(),cashierName:ot,deductFrom:A},oe=Ke.wholesalePrice,Se=N??0,be=J??0,Fe=G??0;if(oe>(A==="base"?Se:be)){c({title:"رصيد غير كافٍ",description:"لا يوجد رصيد كافٍ للخصم بسعر الجملة.",variant:"destructive"});return}const B=A==="base"?Math.round((Se-oe)*100)/100:Se,qe=A==="air"?Math.round((be-oe)*100)/100:be,Y=Ke.retailPrice+Ke.wholesalePrice,pt=Math.round((Fe+Y)*100)/100;P(B),F(qe),Z(pt);try{const jt=q?`${aa}_${q}`:aa,Dt=q?`${ra}_${q}`:ra;localStorage.setItem(jt,JSON.stringify({openingBase:B,openingAir:qe,drawerCash:pt})),localStorage.setItem(Dt,JSON.stringify({openingBase:B,openingAir:qe,drawerCash:pt}));const ts=v||s();if(ts&&q){const Ht=Qe(H,"shops",ts,"machines",q);await ks(Ht,{openingBase:B,openingAir:qe,drawerCash:pt,cashierName:ot,updatedAt:lt()},{merge:!0}),await _s(Te(H,"shops",ts,"machines",q,"transfers"),{wholesalePrice:Ke.wholesalePrice,retailPrice:Ke.retailPrice,profit:Ke.profit,deductFrom:A,cashierName:ot,createdAt:lt()})}}catch{}de(jt=>[ee,...jt]);try{const jt=v||s(),Dt=jt&&q?`machineDaily_transfers_${jt}_${q}`:"machineDaily_transfers",ts=localStorage.getItem(Dt),Ht=ts?JSON.parse(ts):[],Gs=[ee,...Array.isArray(Ht)?Ht:[]];localStorage.setItem(Dt,JSON.stringify(Gs))}catch{}se(!1),ht(""),Lt(""),rt(null),je(!1),c({title:"تم تسجيل تحويل",description:`الربح الفوري: ${At(ee.profit)} | خصم المخزون: -${At(oe)} (${A==="base"?"الأساسي":"الهواء"}) | درج: +${At(Y)}`})},Fs=()=>{$(""),T(""),xe(!1),te(""),Re(""),Le(null)};n.useEffect(()=>{const A=v||s();if(!(!i||!A||!q))try{const ee=Te(H,"shops",A,"machines",q,"transfers"),oe=Os(ee,async Se=>{const Fe=[...Se.docs.map(Xe=>{var pt,jt;const B=Xe.data(),qe=(jt=(pt=B==null?void 0:B.createdAt)==null?void 0:pt.toDate)!=null&&jt.call(pt)?B.createdAt.toDate():new Date,Y=B==null?void 0:B.deductFrom;return{id:Xe.id,wholesalePrice:Number((B==null?void 0:B.wholesalePrice)||0),retailPrice:Number((B==null?void 0:B.retailPrice)||0),profit:Number((B==null?void 0:B.profit)??(Number((B==null?void 0:B.retailPrice)||0)-Number((B==null?void 0:B.wholesalePrice)||0)||0)),createdAt:qe.toISOString(),cashierName:(B==null?void 0:B.cashierName)||void 0,deductFrom:Y==="base"||Y==="air"?Y:void 0}})].sort((Xe,B)=>{const qe=new Date(Xe.createdAt).getTime();return new Date(B.createdAt).getTime()-qe});if(Fe.length>0){de(Fe),me(!0);try{localStorage.setItem(`machineDaily_transfers_${A}_${q}`,JSON.stringify(Fe))}catch{}}else if(M){de([]);try{localStorage.setItem(`machineDaily_transfers_${A}_${q}`,JSON.stringify([]))}catch{}}});return()=>{try{oe()}catch{}}}catch{}},[i,v,q,M]),n.useEffect(()=>{const A=v||s();if(!(!i||!A||!q))try{const ee=Te(H,"shops",A,"machines",q,"deliveries"),oe=Os(ee,Se=>{const Fe=[...Se.docs.map(Xe=>{var Y,pt;const B=Xe.data(),qe=(pt=(Y=B==null?void 0:B.createdAt)==null?void 0:Y.toDate)!=null&&pt.call(Y)?B.createdAt.toDate():new Date;return{id:Xe.id,openingBase:Number((B==null?void 0:B.openingBase)||0),openingAir:Number((B==null?void 0:B.openingAir)||0),deliveryBase:Number((B==null?void 0:B.deliveryBase)||0),deliveryAir:Number((B==null?void 0:B.deliveryAir)||0),netResult:typeof(B==null?void 0:B.netResult)=="number"?Number(B.netResult):Math.round((Number((B==null?void 0:B.deliveryBase)||0)+Number((B==null?void 0:B.deliveryAir)||0)-(Number((B==null?void 0:B.openingBase)||0)+Number((B==null?void 0:B.openingAir)||0)))*100)/100,createdAt:qe.toISOString(),cashierName:(B==null?void 0:B.cashierName)||void 0,requiredDrawerNoProfit:typeof(B==null?void 0:B.requiredDrawerNoProfit)=="number"?B.requiredDrawerNoProfit:void 0}})].sort((Xe,B)=>new Date(B.createdAt).getTime()-new Date(Xe.createdAt).getTime());if(Fe.length>0){at(Fe),it(!0);try{localStorage.setItem(`machineDaily_deliveries_${A}_${q}`,JSON.stringify(Fe))}catch{}}else if(Ie){at([]);try{localStorage.setItem(`machineDaily_deliveries_${A}_${q}`,JSON.stringify([]))}catch{}}});return()=>{try{oe()}catch{}}}catch{}},[i,v,q,Ie]),n.useEffect(()=>{if(!(!i||!q))try{const A=v||s(),ee=A?`machineDaily_deliveries_${A}_${q}`:`machineDaily_deliveries_${q}`,oe=localStorage.getItem(ee);if(oe){const Se=JSON.parse(oe);Array.isArray(Se)&&Se.length>0&&at(Se)}(async()=>{try{const Se=v||s();if(!Se)return;const be=Te(H,"shops",Se,"machines",q,"deliveries"),B=[...(await ct(st(be))).docs.map(qe=>{var jt,Dt;const Y=qe.data(),pt=(Dt=(jt=Y==null?void 0:Y.createdAt)==null?void 0:jt.toDate)!=null&&Dt.call(jt)?Y.createdAt.toDate():new Date;return{id:qe.id,openingBase:Number((Y==null?void 0:Y.openingBase)||0),openingAir:Number((Y==null?void 0:Y.openingAir)||0),deliveryBase:Number((Y==null?void 0:Y.deliveryBase)||0),deliveryAir:Number((Y==null?void 0:Y.deliveryAir)||0),netResult:typeof(Y==null?void 0:Y.netResult)=="number"?Number(Y.netResult):Math.round((Number((Y==null?void 0:Y.deliveryBase)||0)+Number((Y==null?void 0:Y.deliveryAir)||0)-(Number((Y==null?void 0:Y.openingBase)||0)+Number((Y==null?void 0:Y.openingAir)||0)))*100)/100,createdAt:pt.toISOString(),cashierName:(Y==null?void 0:Y.cashierName)||void 0,requiredDrawerNoProfit:typeof(Y==null?void 0:Y.requiredDrawerNoProfit)=="number"?Y.requiredDrawerNoProfit:void 0}})].sort((qe,Y)=>new Date(Y.createdAt).getTime()-new Date(qe.createdAt).getTime());if(B.length>0){at(B);try{localStorage.setItem(`machineDaily_deliveries_${Se}_${q}`,JSON.stringify(B))}catch{}}}catch{}})()}catch{}},[i,v,q]),n.useEffect(()=>{if(!(!i||!q))try{const A=v||s(),ee=A?`machineDaily_transfers_${A}_${q}`:`machineDaily_transfers_${q}`,oe=localStorage.getItem(ee);if(oe){const Se=JSON.parse(oe);Array.isArray(Se)&&Se.length>0&&de(Se)}(async()=>{try{const Se=v||s();if(!Se)return;const be=Te(H,"shops",Se,"machines",q,"transfers"),B=[...(await ct(st(be))).docs.map(qe=>{var Dt,ts;const Y=qe.data(),pt=(ts=(Dt=Y==null?void 0:Y.createdAt)==null?void 0:Dt.toDate)!=null&&ts.call(Dt)?Y.createdAt.toDate():new Date,jt=Y==null?void 0:Y.deductFrom;return{id:qe.id,wholesalePrice:Number((Y==null?void 0:Y.wholesalePrice)||0),retailPrice:Number((Y==null?void 0:Y.retailPrice)||0),profit:Number((Y==null?void 0:Y.profit)??(Number((Y==null?void 0:Y.retailPrice)||0)-Number((Y==null?void 0:Y.wholesalePrice)||0)||0)),createdAt:pt.toISOString(),cashierName:(Y==null?void 0:Y.cashierName)||void 0,deductFrom:jt==="base"||jt==="air"?jt:void 0}})].sort((qe,Y)=>new Date(Y.createdAt).getTime()-new Date(qe.createdAt).getTime());if(B.length>0){de(B);try{localStorage.setItem(`machineDaily_transfers_${Se}_${q}`,JSON.stringify(B))}catch{}}}catch{}})()}catch{}},[i,v,q]);const ws=A=>{A||Fs(),u(A)};return e.jsxs(ge,{open:i,onOpenChange:ws,children:[e.jsxs(fe,{className:"w-screen h-[100vh] overflow-hidden rounded-none p-0 flex flex-col dark:bg-[#121212]",children:[e.jsxs(ye,{className:"sticky top-0 bg-white dark:bg-[#0F0F0F] z-20 border-b border-gray-200 dark:border-[#333] px-4 py-3",children:[e.jsx(ve,{className:"flex items-center justify-between text-right",children:e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(Ro,{className:"h-5 w-5 text-yellow-500"}),"يومية المكنة"]})}),e.jsx(is,{className:"text-right",children:'أدخل الرصيد الافتتاحي، ثم في نهاية اليوم قم بإدخال رصيد التسليم لإنشاء إيصال منظم باسم "إيصالات ماكينة".'})]}),e.jsxs("div",{className:"px-4 py-3 overflow-y-auto flex-1 grid grid-cols-1 gap-6",children:[e.jsxs(Tt,{children:[e.jsx(es,{className:"pb-2",children:e.jsxs(us,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-right",children:"اختيار ماكينة"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(h,{variant:"destructive",onClick:async()=>{try{if(!v||!q)return;const A=Qe(H,"shops",v,"machines",q);try{const oe=await ct(Te(H,"shops",v,"machines",q,"transfers"));await Promise.all(oe.docs.map(Se=>hs(Se.ref)))}catch{}try{const oe=await ct(Te(H,"shops",v,"machines",q,"deliveries"));await Promise.all(oe.docs.map(Se=>hs(Se.ref)))}catch{}await hs(A),nt(oe=>oe.filter(Se=>Se.id!==q));const ee=ue.find(oe=>oe.id!==q);xt(ee?ee.id:null);try{const oe=`${aa}_${q}`,Se=`${ra}_${q}`;localStorage.removeItem(oe),localStorage.removeItem(Se)}catch{}c({title:"تم حذف الماكينة",description:"تمت الإزالة نهائيًا."})}catch{c({title:"فشل الحذف",description:"تعذر حذف الماكينة.",variant:"destructive"})}},disabled:!q,title:"حذف الماكينة",children:e.jsx(Xt,{className:"h-4 w-4"})})})]})}),e.jsx(Ft,{className:"space-y-3",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 items-end",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الماكينة الحالية"}),e.jsxs(xa,{value:q??"",onValueChange:A=>{xt(A);try{const ee=v||s();ee&&localStorage.setItem(`machineDaily_selected_${ee}`,A)}catch{}},children:[e.jsx(pa,{className:"text-right",children:e.jsx(ga,{placeholder:"اختر ماكينة"})}),e.jsx(fa,{children:ue.map(A=>e.jsx(Bs,{value:A.id,children:A.name},A.id))})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-2",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"إنشاء ماكينة جديدة"}),e.jsx(z,{value:vt,onChange:A=>bt(A.target.value),placeholder:"اسم الماكينة",className:"text-right"})]}),e.jsx("div",{className:"flex justify-end md:justify-start",children:e.jsx(h,{onClick:async()=>{try{if(!v){c({title:"لا يوجد محل",description:"يرجى التأكد من تحميل بيانات المحل.",variant:"destructive"});return}const A=(vt||"").trim();if(!A){c({title:"اسم الماكينة مطلوب",description:"أدخل اسم للماكينة الجديدة.",variant:"destructive"});return}const ee=await _s(Te(H,"shops",v,"machines"),{name:A,shopId:v,createdAt:lt(),updatedAt:lt(),isActive:!0}),oe={id:ee.id,name:A};nt(Se=>[oe,...Se]),xt(ee.id),bt(""),c({title:"تم إنشاء ماكينة",description:`تمت إضافة ${A}`})}catch(A){console.error("Create machine error:",A),c({title:"خطأ في الإنشاء",description:"تعذر إنشاء الماكينة.",variant:"destructive"})}},className:"bg-violet-600 hover:bg-violet-700",children:"إضافة"})})]})]})})]}),e.jsxs(Tt,{children:[e.jsx(es,{className:"pb-2",children:e.jsxs(us,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-right",children:"الرصيد الافتتاحي"}),e.jsx(h,{variant:"ghost",size:"sm",onClick:()=>he(A=>!A),className:"flex items-center gap-1",children:e.jsx(wr,{className:`h-4 w-4 transition-transform ${W?"rotate-180":""}`})})]})}),e.jsxs("div",{className:"flex items-center justify-between px-6",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(h,{variant:"outline",onClick:()=>se(!0),disabled:N==null||J==null,className:"border-violet-300 text-violet-700",children:"تحويل"})}),N!=null&&J!=null&&e.jsxs(qt,{className:"bg-violet-100 text-violet-700 border border-violet-200",children:["تم التسجيل: أساسي ",At(N)," | هواء ",At(J)," | درج ",At(G??0)]})]}),e.jsxs(Ft,{className:`space-y-4 ${W?"":"hidden"}`,children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الرصيد الأساسي"}),e.jsx(z,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:C,onChange:A=>$(A.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"رصيد الهواء"}),e.jsx(z,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:S,onChange:A=>T(A.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"فلوس الدرج"}),e.jsx(z,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:O,onChange:A=>y(A.target.value),placeholder:"0.00",className:"text-right"})]})]}),e.jsxs("div",{className:"flex items-center justify-end",children:[e.jsx(h,{variant:"outline",className:"mr-2",onClick:St,children:"تصفير"}),e.jsx(h,{onClick:Jt,className:"bg-violet-600 hover:bg-violet-700",children:"إضافة"})]})]})]}),e.jsxs(Tt,{children:[e.jsx(es,{className:"pb-2",children:e.jsxs(us,{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-right",children:"إيصالات تحويل"}),e.jsxs(qt,{className:"bg-green-100 text-green-700 border border-green-200",children:["ربح: ",At(Pt)]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(h,{variant:"outline",size:"sm",onClick:wt,className:"border-red-300 text-red-700 hover:bg-red-50",children:"حذف الإيصالات"}),e.jsx(pn,{className:"h-4 w-4 text-gray-500"})]})]})}),e.jsx(Ft,{className:"space-y-3",children:Q.length===0?e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد تحويلات مسجلة."}):e.jsx("div",{className:"space-y-3 max-h-52 overflow-y-auto pr-1",children:Q.map(A=>e.jsxs("div",{className:"rounded-lg border p-3 grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"سعر الجملة"}),e.jsx("p",{className:"text-sm",children:At(A.wholesalePrice)})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"سعر التجزئة"}),e.jsx("p",{className:"text-sm",children:At(A.retailPrice)})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"الربح الفوري"}),e.jsx("p",{className:"text-sm text-green-700",children:At(A.profit)}),A.deductFrom&&e.jsx("div",{className:"mt-1",children:e.jsxs("span",{className:"text-[11px] bg-violet-100 text-violet-700 border border-violet-200 rounded px-2 py-0.5",children:["الخصم من: ",A.deductFrom==="base"?"الأساسي":"الهواء"]})}),e.jsxs("div",{className:"flex items-center justify-end gap-2 text-xs text-gray-500",children:[e.jsx(ba,{className:"h-3 w-3"}),e.jsx("span",{children:No(A.createdAt)}),A.cashierName&&e.jsxs(e.Fragment,{children:[e.jsx(Oi,{orientation:"vertical",className:"h-3"}),e.jsxs("span",{children:["الكاشير: ",A.cashierName]})]})]})]})]},A.id))})})]}),e.jsxs(Tt,{children:[e.jsx(es,{className:"pb-2",children:e.jsx(us,{className:"text-right",children:"نهاية اليوم"})}),e.jsx(Ft,{className:"space-y-4",children:ne?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"الرصيد الأساسي الحالي"}),e.jsx(z,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:ie,onChange:A=>te(A.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"رصيد الهواء الحالي"}),e.jsx(z,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:Oe,onChange:A=>Re(A.target.value),placeholder:"0.00",className:"text-right"})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(h,{variant:"secondary",onClick:()=>xe(!1),children:"إلغاء"}),e.jsx(h,{onClick:Is,className:"bg-green-600 hover:bg-green-700",children:"تسليم"})]}),Ce!=null&&e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{className:"text-right",children:e.jsxs(qt,{className:Ce>=0?"bg-green-100 text-green-700 border border-green-200":"bg-red-100 text-red-700 border border-red-200",children:["الناتج النهائي: ",At(Ce)]})}),e.jsxs("div",{className:"mt-2 flex items-center justify-end gap-2",children:[e.jsxs(qt,{className:"bg-blue-100 text-blue-700 border border-blue-200",children:["المجموع النهائي: ",At(parseFloat(ie||"0")+parseFloat(Oe||"0"))]}),e.jsxs(qt,{className:"bg-amber-100 text-amber-700 border border-amber-200",children:["مطلوب من الدرج (بدون أرباح): ",At(kt)]})]})]})]}):e.jsx("div",{className:"flex justify-end",children:e.jsx(h,{variant:"outline",onClick:Bt,className:"border-violet-300 text-violet-700",children:"تسليم يومية"})})})]}),e.jsxs(Tt,{children:[e.jsx(es,{className:"pb-2",children:e.jsxs(us,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-right",children:"إيصالات ماكينة"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(h,{variant:"outline",size:"sm",onClick:Ze,className:"border-red-300 text-red-700 hover:bg-red-50",children:"حذف الإيصالات"}),e.jsx(pn,{className:"h-4 w-4 text-gray-500"})]})]})}),e.jsx(Ft,{className:"space-y-3",children:Ue.length===0?e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد إيصالات حتى الآن."}):e.jsx("div",{className:"space-y-3",children:Ue.map(A=>e.jsxs("div",{className:"rounded-lg border p-3 grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"الافتتاحي"}),e.jsxs("p",{className:"text-sm",children:["أساسي: ",At(A.openingBase)]}),e.jsxs("p",{className:"text-sm",children:["هواء: ",At(A.openingAir)]})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"التسليم"}),e.jsxs("p",{className:"text-sm",children:["أساسي: ",At(A.deliveryBase)]}),e.jsxs("p",{className:"text-sm",children:["هواء: ",At(A.deliveryAir)]})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsx("div",{className:"flex items-center justify-end",children:e.jsxs(h,{variant:"outline",size:"sm",onClick:()=>Ot(A.id),className:"border-red-300 text-red-700 hover:bg-red-50",children:[e.jsx(Xt,{className:"h-3 w-3 mr-1"})," حذف"]})}),e.jsx("p",{className:"text-xs text-gray-500",children:"النتيجة"}),e.jsx("p",{className:`text-sm ${A.netResult>=0?"text-green-700":"text-red-700"}`,children:At(A.netResult)}),e.jsxs("div",{className:"mt-1 flex items-center justify-end gap-2",children:[e.jsxs("span",{className:"text-[11px] bg-blue-100 text-blue-700 border border-blue-200 rounded px-2 py-0.5",children:["المجموع النهائي: ",At(A.deliveryBase+A.deliveryAir)]}),typeof A.requiredDrawerNoProfit=="number"&&e.jsxs("span",{className:"text-[11px] bg-amber-100 text-amber-700 border border-amber-200 rounded px-2 py-0.5",children:["مطلوب من الدرج (بدون أرباح): ",At(A.requiredDrawerNoProfit||0)]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2 text-xs text-gray-500",children:[e.jsx(ba,{className:"h-3 w-3"}),e.jsx("span",{children:No(A.createdAt)}),A.cashierName&&e.jsxs(e.Fragment,{children:[e.jsx(Oi,{orientation:"vertical",className:"h-3"}),e.jsxs("span",{children:["الكاشير: ",A.cashierName]})]})]})]})]},A.id))})})]})]}),e.jsxs(dt,{className:"sticky bottom-0 bg-white dark:bg-[#0F0F0F] z-20 border-t border-gray-200 dark:border-[#333] px-4 py-3 flex items-center justify-between",children:[e.jsx(h,{variant:"outline",onClick:()=>ws(!1),children:"إغلاق"}),e.jsxs("div",{className:"text-xs text-gray-500 flex items-center gap-1",children:[e.jsx(ia,{className:"h-3 w-3"}),e.jsx("span",{children:"يسجل التاريخ والوقت تلقائياً لكل إيصال"})]})]})]}),e.jsx(ge,{open:et,onOpenChange:se,children:e.jsxs(fe,{className:"sm:max-w-sm",children:[e.jsx(ye,{children:e.jsx(ve,{children:"تحويل رصيد"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"سعر الجملة"}),e.jsx(z,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:pe,onChange:A=>ht(A.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium block text-right",children:"سعر التجزئة"}),e.jsx(z,{inputMode:"decimal",type:"number",min:0,step:"0.01",value:Yt,onChange:A=>Lt(A.target.value),placeholder:"0.00",className:"text-right"})]}),e.jsx("div",{className:"text-right",children:e.jsxs(qt,{className:"bg-green-100 text-green-700 border border-green-200",children:["الربح الفوري: ",At(parseFloat(Yt||"0")-parseFloat(pe||"0")||0)]})})]}),e.jsxs(dt,{className:"flex items-center justify-end gap-2",children:[e.jsx(h,{variant:"secondary",onClick:()=>se(!1),children:"إلغاء"}),e.jsx(h,{onClick:bs,className:"bg-violet-600 hover:bg-violet-700",children:"تحويل"})]})]})}),e.jsx(Th,{open:Vt,onOpenChange:je,children:e.jsxs(rc,{children:[e.jsxs(nc,{children:[e.jsx(ic,{children:"اختيار مصدر الخصم"}),e.jsx(lc,{children:"هل يتم الخصم من الرصيد الأساسي أم من رصيد الهواء؟"})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2 mt-4",children:[e.jsx(oc,{onClick:()=>je(!1),children:"رجوع"}),e.jsx(Ei,{className:"bg-emerald-600 hover:bg-emerald-700 text-white",onClick:()=>zs("base"),children:"خصم من الأساسي"}),e.jsx(Ei,{className:"bg-blue-600 hover:bg-blue-700 text-white",onClick:()=>zs("air"),children:"خصم من الهواء"})]})]})})]})}function Oh(i,u=300){const[c,g]=Je.useState(i);return Je.useEffect(()=>{const v=setTimeout(()=>g(i),u);return()=>clearTimeout(v)},[i,u]),c}const _h=({userId:i,transactions:u})=>{const[c,g]=n.useState(!1),[v,D]=n.useState(!1),[s,C]=n.useState(!1),[$,S]=n.useState({monthlyWithdrawalProfit:0,monthlyTransferProfit:0,lastUpdated:new Date}),{userSubscription:T}=Hs();n.useEffect(()=>{i&&c&&s&&O()},[i,c,s]);const O=async()=>{if(i)try{if(Array.isArray(u)&&u.length>0){const G=new Date,Z=G.getMonth(),re=G.getFullYear(),_=ds.filterVisibleTransactions(u,"monthly",i);let W=0,he=0;_.forEach(ne=>{const xe=new Date(ne.createdAt),ie=String(ne.status||"confirmed").toLowerCase();if(xe.getMonth()!==Z||xe.getFullYear()!==re||ie!=="completed"&&ie!=="confirmed")return;const te=(ne.type||ne.txnType||"").toLowerCase(),Oe={type:te==="withdrawal"?"withdraw":te,amount:Number(ne.amount||0),commission:ne.commission};Oe.type==="withdraw"?W+=ya.calculateProfitFromTransaction(Oe):(Oe.type==="send"||Oe.type==="receive"||Oe.type==="transfer")&&(he+=ya.calculateProfitFromTransaction(Oe))}),S({monthlyWithdrawalProfit:Math.round(W*100)/100,monthlyTransferProfit:Math.round(he*100)/100,lastUpdated:new Date});return}const F=ya.getWithdrawTransferProfits(i);S({monthlyWithdrawalProfit:F.monthlyWithdrawProfit||0,monthlyTransferProfit:F.monthlyTransferProfit||0,lastUpdated:new Date})}catch(F){console.error("Error loading profit data:",F)}},y=F=>`${F.toFixed(2)} ج.م`,N=async()=>{try{const F=(T==null?void 0:T.subscription)||null,G=(F==null?void 0:F.planType)??(F==null?void 0:F.plan)??null,Z=typeof G=="string"?G.toLowerCase():null;if(G===ms.ZERO||Z==="zero"||Z==="0"||G===0)return!0}catch{}try{if(i){const F=await Fi(i),G=(F==null?void 0:F.planType)??(F==null?void 0:F.plan)??null,Z=typeof G=="string"?G.toLowerCase():null;if(G===ms.ZERO||Z==="zero"||Z==="0"||G===0)return!0}}catch{}return!1},P=async()=>{try{if(await N()){co({title:"الخطة زيرو",description:"عرض الأرباح الشهرية غير متاح في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"});return}}catch{}D(!0)},J=async()=>{try{if(await N()){co({title:"الخطة زيرو",description:"عرض الأرباح الشهرية غير متاح في خطة زيرو. قم بالترقية للوصول إلى التقارير.",variant:"destructive"}),D(!1);return}}catch{}C(!0),g(!0),D(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(h,{size:"sm",variant:"ghost",onClick:P,className:"h-2 w-2 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded transition-all duration-300 hover:scale-110 shadow-sm hover:shadow-md",title:"عرض الأرباح الشهرية",children:e.jsx(Wt,{className:"h-1.5 w-1.5"})}),e.jsx(ge,{open:c,onOpenChange:g,children:e.jsxs(fe,{className:"max-w-[220px] mx-auto bg-white border border-gray-200 shadow-md rounded sm:max-w-[180px] sm:bg-gradient-to-br sm:from-purple-50 sm:to-white sm:border-2 sm:border-purple-200 sm:shadow-2xl sm:rounded-2xl",children:[e.jsx(ye,{className:"text-center pb-0 border-b-0 sm:pb-2 sm:border-b sm:border-purple-200",children:e.jsxs(ve,{className:"text-xs font-bold text-purple-800 flex items-center justify-center gap-0 mb-0 leading-tight tracking-tight sm:text-xs sm:gap-1 sm:mb-0 sm:leading-normal sm:tracking-normal",children:[e.jsx(ba,{className:"h-2 w-2 text-purple-600 sm:h-3 sm:w-3"}),"شهري"]})}),e.jsx("div",{className:"py-0 sm:py-3",children:e.jsxs("div",{className:"rounded-xl border border-purple-300 bg-white overflow-hidden",children:[e.jsx("div",{className:"p-2 sm:p-3 bg-red-50 border-b border-purple-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(yn,{className:"h-3 w-3 text-red-600"}),e.jsx("span",{className:"font-medium text-red-800 text-xs",children:"سحب"})]}),e.jsx("span",{className:"font-bold text-sm text-red-900 bg-white px-2 py-0.5 rounded",children:y($.monthlyWithdrawalProfit)})]})}),e.jsx("div",{className:"p-2 sm:p-3 bg-blue-50 border-b border-purple-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Wi,{className:"h-3 w-3 text-blue-600"}),e.jsx("span",{className:"font-medium text-blue-800 text-xs",children:"تحويل"})]}),e.jsx("span",{className:"font-bold text-sm text-blue-900 bg-white px-2 py-0.5 rounded",children:y($.monthlyTransferProfit)})]})}),e.jsx("div",{className:"p-2 sm:p-3 bg-purple-50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx($t,{className:"h-3 w-3 text-purple-600"}),e.jsx("span",{className:"font-medium text-purple-800 text-xs",children:"إجمالي"})]}),e.jsx("span",{className:"font-bold text-sm text-purple-900 bg-white px-2 py-0.5 rounded",children:y($.monthlyWithdrawalProfit+$.monthlyTransferProfit)})]})})]})}),!s&&e.jsx("div",{className:"absolute inset-0 bg-yellow-200/70 backdrop-blur-sm flex items-center justify-center rounded sm:rounded-2xl border border-yellow-300 pointer-events-auto",children:e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>D(!0),className:"p-2 bg-yellow-300/80 text-yellow-900 hover:bg-yellow-400/90 rounded-full shadow-sm hover:shadow-md transition-all duration-300",title:"إدخال الرقم السري الرئيسي",children:e.jsx(Wt,{className:"h-4 w-4"})})}),e.jsx("div",{className:"flex justify-center pt-0 border-t-0 sm:pt-2 sm:border-t sm:border-purple-200",children:e.jsx(h,{onClick:()=>g(!1),className:"bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-xl text-sm sm:bg-gradient-to-r sm:from-purple-600 sm:to-purple-700 sm:hover:from-purple-700 sm:hover:to-purple-800 sm:px-4 sm:py-1 sm:rounded-xl sm:shadow-lg sm:hover:shadow-xl sm:transition-all sm:duration-300",children:"إغلاق"})})]})}),e.jsx(as,{open:v,onOpenChange:D,onSuccess:J,description:"لا يمكن الاطلاع على الأرباح الشهرية إلا بإدخال الرقم السري الرئيسي"})]})},Eh=i=>e.jsx(_h,{...i});function Fh({open:i,onOpenChange:u,onSuccess:c,userId:g}){const[v,D]=n.useState(""),[s,C]=n.useState(""),[$,S]=n.useState(!1),[T,O]=n.useState(!1),[y,N]=n.useState(""),[P,J]=n.useState(!1),[F,G]=n.useState(!1),{toast:Z}=Es();n.useEffect(()=>{let W=!0;return(async()=>{const he=await os.hasMasterPin(g);W&&G(he)})(),()=>{W=!1}},[g,i]);const re=()=>{D(""),C(""),N(""),S(!1),O(!1),u(!1)},_=async W=>{W.preventDefault(),N(""),J(!0);try{if(F){if(!await os.verifyMasterPin(v,g)){N("الرقم السري غير صحيح"),J(!1);return}}else{if(v.length<4){N("يجب أن يكون الرقم السري 4 أرقام على الأقل"),J(!1);return}if(v!==s){N("الرقم السري غير متطابق"),J(!1);return}if(!await os.createMasterPin(v,g)){N("تعذر إنشاء الرقم السري الرئيسي"),J(!1);return}}Z({title:"نجح العملية",description:F?"تم التحقق من الرقم السري الرئيسي بنجاح":"تم إنشاء الرقم السري الرئيسي بنجاح"}),c(),re()}catch{N("حدث خطأ أثناء معالجة الرقم السري")}finally{J(!1)}};return e.jsx(ge,{open:i,onOpenChange:u,children:e.jsxs(fe,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ye,{children:e.jsxs(ve,{className:"flex items-center gap-2 text-lg font-semibold",children:[e.jsx(Oa,{className:"h-5 w-5 text-green-600"}),F?"أدخل الرقم السري الرئيسي":"إنشاء الرقم السري الرئيسي"]})}),e.jsxs("form",{onSubmit:_,className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-gray-600 bg-blue-50 p-3 rounded-lg",children:F?"أدخل الرقم السري الرئيسي لعرض بيانات الأرباح":"قم بإنشاء الرقم السري الرئيسي لحماية بيانات الأرباح. يمكنك تغييره لاحقاً من إعدادات البروفيل."}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"pin",children:F?"الرقم السري الرئيسي":"الرقم السري الرئيسي الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(z,{id:"pin",type:$?"text":"password",value:v,onChange:W=>D(W.target.value),placeholder:F?"أدخل الرقم السري":"أدخل رقم سري جديد (4 أرقام على الأقل)",className:"pr-10",dir:"ltr",autoComplete:"off",required:!0}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>S(!$),children:$?e.jsx(rs,{className:"h-4 w-4"}):e.jsx(Wt,{className:"h-4 w-4"})})]})]}),!F&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"confirmPin",children:"تأكيد الرقم السري"}),e.jsxs("div",{className:"relative",children:[e.jsx(z,{id:"confirmPin",type:T?"text":"password",value:s,onChange:W=>C(W.target.value),placeholder:"أعد إدخال الرقم السري",className:"pr-10",dir:"ltr",autoComplete:"off",required:!0}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>O(!T),children:T?e.jsx(rs,{className:"h-4 w-4"}):e.jsx(Wt,{className:"h-4 w-4"})})]})]}),y&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(Ea,{className:"h-4 w-4"}),y]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(h,{type:"submit",disabled:P,className:"flex-1 bg-green-600 hover:bg-green-700",children:[e.jsx(Oa,{className:"h-4 w-4 mr-2"}),P?"جاري المعالجة...":F?"عرض الأرباح":"إنشاء وعرض الأرباح"]}),e.jsx(h,{type:"button",variant:"outline",onClick:re,disabled:P,children:"إلغاء"})]})]})]})})}const Wh=({userId:i,transactions:u})=>{const[c,g]=n.useState(!1),[v,D]=n.useState(!1),[s,C]=n.useState(!1),[$,S]=n.useState({dailyWithdrawalProfit:0,dailyTransferProfit:0,lastUpdated:new Date});n.useEffect(()=>{i&&c&&s&&T()},[i,c,s,u]);const T=async()=>{if(i)try{if(Array.isArray(u)&&u.length>0){const J=new Date,F=ds.filterVisibleTransactions(u,"daily",i);let G=0,Z=0;F.forEach(re=>{const _=new Date(re.createdAt),W=String(re.status||"confirmed").toLowerCase();if(_.toDateString()!==J.toDateString()||W!=="completed"&&W!=="confirmed")return;const he=(re.type||re.txnType||"").toLowerCase(),ne={type:he==="withdrawal"?"withdraw":he,amount:Number(re.amount||0),commission:re.commission};ne.type==="withdraw"?G+=ya.calculateProfitFromTransaction(ne):(ne.type==="send"||ne.type==="receive"||ne.type==="transfer")&&(Z+=ya.calculateProfitFromTransaction(ne))}),S({dailyWithdrawalProfit:Math.round(G*100)/100,dailyTransferProfit:Math.round(Z*100)/100,lastUpdated:new Date});try{ya.updateProfitsFromTransactions(u,i)}catch{}return}const P=ya.getWithdrawTransferProfits(i);S({dailyWithdrawalProfit:P.dailyWithdrawProfit||0,dailyTransferProfit:P.dailyTransferProfit||0,lastUpdated:new Date})}catch(P){console.error("Error loading profit data:",P)}},O=P=>`${P.toFixed(2)} ج.م`,y=()=>{ya.hasProfitPin(i),D(!0)},N=()=>{C(!0),g(!0),D(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(h,{size:"sm",variant:"ghost",onClick:y,className:"h-2 w-2 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded transition-all duration-300 hover:scale-110 shadow-sm hover:shadow-md",title:"عرض الأرباح اليومية",children:e.jsx(Wt,{className:"h-1.5 w-1.5"})}),e.jsx(ge,{open:c,onOpenChange:g,children:e.jsxs(fe,{className:"max-w-[220px] mx-auto bg-white border border-gray-200 shadow-md rounded sm:max-w-[180px] sm:bg-gradient-to-br sm:from-blue-50 sm:to-white sm:border-2 sm:border-blue-200 sm:shadow-2xl sm:rounded-2xl",children:[e.jsx(ye,{className:"text-center pb-0 border-b-0 sm:pb-2 sm:border-b sm:border-blue-200",children:e.jsxs(ve,{className:"text-xs font-bold text-blue-800 flex items-center justify-center gap-0 mb-0 leading-tight tracking-tight sm:text-sm sm:gap-1 sm:mb-0 sm:leading-normal sm:tracking-normal",children:[e.jsx($t,{className:"h-2 w-2 text-blue-600 sm:h-3 sm:w-3"}),"يومي"]})}),e.jsx("div",{className:"py-0 sm:py-3",children:e.jsxs("div",{className:"rounded-xl border border-blue-300 bg-white overflow-hidden",children:[e.jsx("div",{className:"p-2 sm:p-3 bg-red-50 border-b border-blue-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(yn,{className:"h-3 w-3 text-red-600"}),e.jsx("span",{className:"font-medium text-red-800 text-xs",children:"سحب"})]}),e.jsx("span",{className:"font-bold text-sm text-red-900 bg-white px-2 py-0.5 rounded",children:O($.dailyWithdrawalProfit)})]})}),e.jsx("div",{className:"p-2 sm:p-3 bg-green-50 border-b border-blue-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Wi,{className:"h-3 w-3 text-green-600"}),e.jsx("span",{className:"font-medium text-green-800 text-xs",children:"تحويل"})]}),e.jsx("span",{className:"font-bold text-sm text-green-900 bg-white px-2 py-0.5 rounded",children:O($.dailyTransferProfit)})]})}),e.jsx("div",{className:"p-2 sm:p-3 bg-blue-50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx($t,{className:"h-3 w-3 text-blue-600"}),e.jsx("span",{className:"font-medium text-blue-800 text-xs",children:"إجمالي"})]}),e.jsx("span",{className:"font-bold text-sm text-blue-900 bg-white px-2 py-0.5 rounded",children:O($.dailyWithdrawalProfit+$.dailyTransferProfit)})]})})]})}),e.jsx("div",{className:"flex justify-center pt-0 border-t-0 sm:pt-2 sm:border-t sm:border-blue-200",children:e.jsx(h,{onClick:()=>g(!1),className:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-xl text-sm sm:bg-gradient-to-r sm:from-blue-600 sm:to-blue-700 sm:hover:from-blue-700 sm:hover:to-blue-800 sm:px-4 sm:py-1 sm:rounded-xl sm:shadow-lg sm:hover:shadow-xl sm:transition-all sm:duration-300 sm:text-xs",children:"إغلاق"})})]})}),e.jsx(Fh,{open:v,onOpenChange:D,onSuccess:N,userId:i})]})},Mh=i=>e.jsx(Wh,{...i}),Rh=({open:i,onOpenChange:u})=>{var E;const{shiftUser:c,isShiftActive:g,shiftStartAt:v,setShiftUser:D,startShift:s,endShift:C}=Sr(),{userSubscription:$,user:S,signIn:T,profile:O}=Hs(),{toast:y}=Es(),[N,P]=n.useState((c==null?void 0:c.name)||""),[J,F]=n.useState((c==null?void 0:c.username)||""),[G,Z]=n.useState(""),[re,_]=n.useState(!1),[W,he]=n.useState(null),[ne,xe]=n.useState(""),[ie,te]=n.useState(""),[Oe,Re]=n.useState(!1),[Ce,Le]=n.useState(null),[Ue,at]=n.useState(""),[Q,de]=n.useState(""),[et,se]=n.useState(!1),[pe,ht]=n.useState(!1),[Yt,Lt]=n.useState({totalTransfers:0,totalWithdrawals:0}),[Vt,je]=n.useState(null),[Ke,rt]=n.useState(""),[ue,nt]=n.useState(""),[q,xt]=n.useState(0),[vt,bt]=n.useState({}),[M,me]=n.useState(0),[Ie,it]=n.useState(0),[ot,Pt]=n.useState({}),[kt,wt]=n.useState(""),[Ze,Ot]=n.useState(!1),St=()=>`cashierUsers_${(S==null?void 0:S.uid)||"default"}`,[Jt,Bt]=n.useState(()=>{try{let p=localStorage.getItem(St());if(!p){const k=localStorage.getItem("cashierUsers");k&&(p=k)}return p?JSON.parse(p):[]}catch{return[]}});n.useEffect(()=>{(async()=>{try{if(!(S!=null&&S.uid))return;const p=Qe(H,"profiles",S.uid,"cashierUsers","list"),k=await va(p);if(k.exists()){const U=k.data(),K=Array.isArray(U==null?void 0:U.users)?U.users:[];K&&K.length>0&&Bt(K)}}catch{}})()},[S==null?void 0:S.uid]),n.useEffect(()=>{if(!(S!=null&&S.uid))return;const p=Qe(H,"profiles",S.uid,"cashierUsers","list"),k=Os(p,U=>{try{if(U.exists()){const K=U.data(),we=Array.isArray(K==null?void 0:K.users)?K.users:[];if(we&&we.length>0)Bt(we);else try{const Ne=localStorage.getItem(St()),ce=Ne?JSON.parse(Ne):[];Bt(ce)}catch{Bt([])}}}catch{}},U=>{console.warn("cashierUsers realtime subscription error:",U)});return()=>k()},[S==null?void 0:S.uid]);const Is=(E=$==null?void 0:$.subscription)==null?void 0:E.planType,bs=Is==="yearly"?2:Is==="lifetime"?4:Number.POSITIVE_INFINITY;n.useEffect(()=>{try{localStorage.setItem(St(),JSON.stringify(Jt));try{localStorage.removeItem("cashierUsers")}catch{}}catch{}(async()=>{try{if(!(S!=null&&S.uid))return;const p=Qe(H,"profiles",S.uid,"cashierUsers","list");await ks(p,{users:Jt},{merge:!0})}catch{}})()},[Jt]);const[zs,Fs]=n.useState(!1),[ws,A]=n.useState(""),[ee,oe]=n.useState(null),[Se,be]=n.useState([]),[Fe,Xe]=n.useState(!1),[B,qe]=n.useState(null),[Y,pt]=n.useState(!1),[jt,Dt]=n.useState(!1),ts=p=>{const k=(c==null?void 0:c.username)===p;let U=!1;try{U=localStorage.getItem("lastHandoverToAdmin")==="true"}catch{}if(k&&!(k&&!g&&(kt==="الأدمن الرئيسي"||U))){y({title:"لا يمكن الحذف",description:"لا يمكنك حذف مستخدم الوردية أثناء كونها نشطة أو قبل تسليمها للأدمن الرئيسي"});return}const Ne=`هل أنت متأكد من حذف المستخدم ${p}؟

هذا الإجراء لا يمكن التراجع عنه.`;window.confirm(Ne)&&(Bt(ce=>ce.filter($e=>$e.username!==p)),k&&D(null),y({title:"تم حذف المستخدم",description:p}))},Ht=()=>{if(!N.trim()||!J.trim()||!G.trim())return;if(Jt.length>=bs){y({title:"وصلت الحد الأقصى للمستخدمين",description:`هذه الباقة تسمح بإضافة ${Number.isFinite(bs)?bs:"عدد غير محدود"} كاشير فقط`,variant:"destructive"});return}const p={name:N.trim(),username:J.trim(),password:G.trim()};Bt(k=>[p,...k]),P(""),F(""),Z("")},Gs=()=>{_(!0),he(null),Le(null),at(""),de("")},oa=async()=>{try{let p=[];try{S!=null&&S.uid&&(p=await Me.getUserTransactions(S.uid))}catch{}if(!p||p.length===0)try{const ze=await eh({merchantUserId:S==null?void 0:S.uid,limit:200});p=(ze==null?void 0:ze.transactions)||[]}catch{}const k=v?new Date(v):null,U=new Date,K=ze=>{const mt=ze.type,_t=ze.txnType;return mt==="withdraw"||mt==="withdrawal"||mt==="receive"||_t==="receive"},we=ze=>{const mt=ze.type,_t=ze.txnType;return mt==="send"||mt==="transfer"||_t==="send"},Ne=ze=>{if(!ze)return null;if(ze instanceof Date)return ze;try{const mt=new Date(ze);return Number.isNaN(mt.getTime())?null:mt}catch{return null}},ce=ze=>{const mt=Ne(ze.createdAt||ze.created_at||ze.timestamp);return!mt||k&&mt<k?!1:mt<=U},$e=ze=>ze==="completed"||ze==="confirmed",_e=p.filter(ze=>$e(ze.status)&&ce(ze)),Ve=_e.filter(ze=>K(ze)).reduce((ze,mt)=>{const _t=mt.withdrawnAmount??mt.receivedAmount??mt.amount??0;return ze+(Number(_t)||0)},0);return{totalTransfers:_e.filter(ze=>we(ze)).reduce((ze,mt)=>{const _t=mt.sentAmount??mt.transferredAmount??mt.amount??0;return ze+(Number(_t)||0)},0),totalWithdrawals:Ve}}catch{return{totalTransfers:0,totalWithdrawals:0}}};n.useEffect(()=>{if(pe){try{const p=localStorage.getItem("shiftInitialReceivedDrawerFunds");p!==null&&nt(p)}catch{}try{const p=localStorage.getItem("shiftInitialReceivedWalletBalancesTotal");if(p!==null){const k=parseFloat(p);xt(Number.isFinite(k)?k:0)}}catch{}}},[pe]),n.useEffect(()=>{if(!i&&!Fe)return;(async()=>{try{const U=((S!=null&&S.uid?await Me.getUserTransactions(S.uid):[])||[]).filter(K=>(K==null?void 0:K.type)==="report"||((K==null?void 0:K.title)||"").includes("إيصال تسليم وردية"));U.sort((K,we)=>{const Ne=new Date(K.createdAt||0).getTime();return new Date(we.createdAt||0).getTime()-Ne}),be(U)}catch{be([])}})()},[i,pe,Fe,S==null?void 0:S.uid]);const d=async(p,k,U)=>{try{let K=0,we=0;try{const ce=parseFloat(localStorage.getItem("shiftInitialReceivedDrawerFunds")||"0");K=Number.isFinite(ce)?ce:0}catch{}try{const ce=parseFloat(localStorage.getItem("shiftInitialReceivedWalletBalancesTotal")||"0");we=Number.isFinite(ce)?ce:0}catch{}const Ne={id:`shift_receipt_${Date.now()}`,type:"report",senderPhone:(c==null?void 0:c.username)||"cashier",receiverPhone:kt||"admin",amount:0,status:"completed",createdAt:new Date().toISOString(),title:"إيصال تسليم وردية",cashierName:(c==null?void 0:c.name)||(c==null?void 0:c.username)||null,deficit:k,deficitAmount:k?U:0,shiftStartAt:v,receivedDrawerFunds:K,receivedWalletBalancesTotal:we,receivedWalletBalances:vt,deliveredDrawerFunds:M||0,deliveredWalletBalancesTotal:Ie||0,deliveredWalletBalances:ot,shiftProfit:Math.round(((M||0)+(Ie||0)-(K+we))*100)/100};S!=null&&S.uid&&await Me.saveUserTransaction(S.uid,Ne),be(ce=>[Ne,...ce||[]])}catch{}};return e.jsxs(e.Fragment,{children:[e.jsx(ge,{open:i,onOpenChange:u,children:e.jsxs(fe,{className:"sm:max-w-md",children:[e.jsx(ye,{children:e.jsx(ve,{children:g?"تسليم الورديه والخروج":"إضافة مستخدم وردية"})}),g?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsx("div",{className:"text-sm",children:"المستخدم الحالي للوردية:"}),e.jsxs("div",{className:"font-semibold text-sm",children:[c==null?void 0:c.name," (",c==null?void 0:c.username,")"]})]}),e.jsx("div",{className:"text-xs text-gray-600",children:'لإنهاء الوردية والخروج، اضغط "تسليم الورديه والخروج" وسيُطلب الرقم السري.'})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-xs text-gray-600",children:'لاستكمال إضافة مستخدم جديد اضغط الزر أسفل "إضافة مستخدم جديد" لفتح النموذج.'}),Jt.length>0&&e.jsxs("div",{className:"mt-4 border-t pt-3",children:[e.jsx("div",{className:"text-sm font-medium mb-2",children:"المستخدمون المسجلون"}),e.jsx("div",{className:"space-y-2 max-h-48 overflow-auto",children:Jt.map((p,k)=>e.jsxs("div",{className:"flex items-center justify-between rounded border px-3 py-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:p.name}),e.jsx("div",{className:"text-xs text-gray-500",children:p.username})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(h,{size:"sm",className:"w-full sm:w-auto",onClick:()=>{oe(p),Fs(!0)},children:"دخول"}),e.jsx(h,{size:"sm",className:"w-full sm:w-auto",variant:"destructive",onClick:()=>ts(p.username),children:"حذف"})]})]},k))})]})]}),e.jsx(dt,{className:"flex flex-wrap gap-2 justify-between",children:g?e.jsx("div",{className:"flex flex-wrap gap-2",children:e.jsx(h,{className:"w-full sm:w-auto",variant:"destructive",onClick:Gs,children:"تسليم الورديه والخروج"})}):e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(h,{className:"w-full sm:w-auto",onClick:()=>Dt(!0),children:"إضافة مستخدم جديد"}),e.jsx(h,{className:"w-full sm:w-auto",variant:"outline",onClick:()=>Xe(!0),children:"إيصالات التسليم"})]})})]})}),e.jsx(ge,{open:jt,onOpenChange:Dt,children:e.jsxs(fe,{className:"sm:max-w-md",children:[e.jsx(ye,{children:e.jsx(ve,{children:"إضافة مستخدم جديد"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(X,{className:"mb-1 block",children:"الاسم"}),e.jsx(z,{value:N,onChange:p=>P(p.target.value),placeholder:"أدخل الاسم"})]}),e.jsxs("div",{children:[e.jsx(X,{className:"mb-1 block",children:"اسم المستخدم"}),e.jsx(z,{value:J,onChange:p=>F(p.target.value),placeholder:"أدخل اسم المستخدم"})]}),e.jsxs("div",{children:[e.jsx(X,{className:"mb-1 block",children:"الرقم السري"}),e.jsx(z,{type:"password",autoComplete:"new-password",value:G,onChange:p=>Z(p.target.value),placeholder:"أدخل الرقم السري"})]}),e.jsx("div",{className:"text-xs text-gray-500",children:"المستخدم يمكنه: التحويل، السحب، اختيار المحفظة فقط."})]}),e.jsxs(dt,{className:"flex gap-2 justify-between",children:[e.jsx(h,{variant:"secondary",onClick:()=>{Dt(!1)},children:"إلغاء"}),e.jsx(h,{onClick:()=>{!N.trim()||!J.trim()||!G.trim()||(Ht(),Dt(!1))},children:"حفظ المستخدم"})]})]})}),e.jsx(ge,{open:Fe,onOpenChange:Xe,children:e.jsxs(fe,{className:"sm:max-w-lg",children:[e.jsx(ye,{children:e.jsx(ve,{children:"إيصالات التسليم"})}),Se.length===0?e.jsx("div",{className:"text-xs text-gray-600",children:"لا توجد إيصالات تسليم محفوظة بعد."}):e.jsx("div",{className:"space-y-2 max-h-[60vh] overflow-auto",children:Se.map(p=>e.jsxs("div",{className:"rounded border px-3 py-2 cursor-pointer hover:bg-gray-50",onClick:()=>{qe(p),pt(!0)},children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm font-semibold",children:new Date(p.createdAt).toLocaleString("ar-EG")}),e.jsxs("div",{className:"text-xs text-gray-500",children:["إلى: ",p.receiverPhone]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-1",children:[e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مسلّمة: ",p.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مسلّمة (إجمالي): ",p.deliveredWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مستلمة: ",p.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مستلمة (إجمالي): ",p.receivedWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مسلّمة: ",p.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مسلّمة (إجمالي): ",p.deliveredWalletBalancesTotal??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية مستلمة: ",p.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["محافظ مستلمة (إجمالي): ",p.receivedWalletBalancesTotal??0]}),e.jsxs("div",{className:["text-xs",(p.shiftProfit??(p.deliveredDrawerFunds??0)+(p.deliveredWalletBalancesTotal??0)-(p.receivedDrawerFunds??0)-(p.receivedWalletBalancesTotal??0))>=0?"text-green-700":"text-red-700"].join(" "),children:["أرباح الوردية: ",p.shiftProfit??(p.deliveredDrawerFunds??0)+(p.deliveredWalletBalancesTotal??0)-(p.receivedDrawerFunds??0)-(p.receivedWalletBalancesTotal??0)]})]}),p.deficit&&e.jsxs("div",{className:"text-xs text-red-600 mt-1",children:["عجز: ",p.deficitAmount??0]})]},p.id))}),e.jsx(dt,{className:"flex gap-2 justify-between",children:e.jsx(h,{variant:"secondary",onClick:()=>Xe(!1),children:"إغلاق"})})]})}),e.jsx(ge,{open:Y,onOpenChange:pt,children:e.jsxs(fe,{className:"sm:max-w-md",children:[e.jsx(ye,{children:e.jsx(ve,{children:"إيصال تسليم وردية"})}),B?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsxs("div",{className:"text-sm",children:["التاريخ: ",new Date(B.createdAt).toLocaleString("ar-EG")]}),e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["تم التسليم إلى: ",B.receiverPhone]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"المستلم عند الدخول"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية: ",B.receivedDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["أرصدة المحافظ (إجمالي): ",B.receivedWalletBalancesTotal??0]})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"المسلّم عند الخروج"}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نقدية: ",B.deliveredDrawerFunds??0]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["أرصدة المحافظ (إجمالي): ",B.deliveredWalletBalancesTotal??0]})]})]}),B.deficit&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2 text-red-600",children:"عجز"}),e.jsxs("div",{className:"text-xs text-red-600",children:["المبلغ: ",B.deficitAmount??0]})]}),B.receivedWalletBalances&&Object.keys(B.receivedWalletBalances).length>0&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"تفصيل المحافظ المستلمة"}),e.jsx("div",{className:"space-y-1",children:Object.entries(B.receivedWalletBalances).map(([p,k])=>e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-gray-600",children:p}),e.jsx("span",{className:"font-semibold",children:k})]},p))})]}),B.deliveredWalletBalances&&Object.keys(B.deliveredWalletBalances).length>0&&e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"تفصيل المحافظ المسلّمة"}),e.jsx("div",{className:"space-y-1",children:Object.entries(B.deliveredWalletBalances).map(([p,k])=>e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-gray-600",children:p}),e.jsx("span",{className:"font-semibold",children:k})]},p))})]})]}):e.jsx("div",{className:"text-xs text-gray-600",children:"لا يوجد تقرير محدد للعرض."}),e.jsx(dt,{className:"flex gap-2 justify-between",children:e.jsx(h,{variant:"secondary",onClick:()=>pt(!1),children:"إغلاق"})})]})}),e.jsx(ge,{open:zs,onOpenChange:Fs,children:e.jsxs(fe,{className:"sm:max-w-md",children:[e.jsx(ye,{children:e.jsx(ve,{children:"أدخل الرقم السري للدخول"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm",children:ee?`${ee.name} (${ee.username})`:""}),e.jsx(z,{type:"password",autoComplete:"off",value:ws,onChange:p=>A(p.target.value),placeholder:"أدخل الرقم السري"})]}),e.jsxs(dt,{className:"flex gap-2 justify-between",children:[e.jsx(h,{variant:"secondary",onClick:()=>{A(""),oe(null),Fs(!1)},children:"إلغاء"}),e.jsx(h,{onClick:()=>{if(ee){if(ws.trim()!==ee.password){y({title:"خطأ في الرقم السري",description:"الرقم السري للكاشير غير صحيح",variant:"destructive"});return}D({name:ee.name,username:ee.username}),A(""),Fs(!1),u(!1),s(),Ot(!0)}},children:"دخول الورديه"})]})]})}),e.jsx(ge,{open:Ze,onOpenChange:Ot,children:e.jsxs(fe,{className:"sm:max-w-md",children:[e.jsx(ye,{children:e.jsx(ve,{children:"تسجيل أرصدة البداية والنقدية"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(X,{className:"mb-1 block",children:"الفلوس النقدية المستلمة عند الدخول"}),e.jsx(z,{type:"number",value:ue,onChange:p=>nt(p.target.value),placeholder:"أدخل قيمة النقدية في الدرج عند بداية الورديه"})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(X,{className:"mb-1 block",children:"أرصدة المحافظ المستلمة (إجمالي) عند الدخول"}),e.jsx(z,{type:"number",value:Number.isFinite(q)?q:0,onChange:p=>{const k=parseFloat(p.target.value);xt(Number.isFinite(k)?k:0)},placeholder:"أدخل إجمالي أرصدة المحافظ عند بداية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"يمكن إضافة التفصيل لاحقاً إن لزم، المهم تسجيل الإجمالي."})]})]}),e.jsx(dt,{className:"flex gap-2 justify-between",children:e.jsx(h,{onClick:()=>{const p=parseFloat(ue),k=q,U=Number.isFinite(p)&&p>=0,K=Number.isFinite(k)&&k>=0;if(!U||!K){y({title:"يرجى إدخال قيم صحيحة",description:"أدخل قيمًا رقمية غير سالبة للنقدية ولإجمالي أرصدة المحافظ",variant:"destructive"});return}try{localStorage.setItem("shiftInitialReceivedDrawerFunds",String(p)),localStorage.setItem("shiftInitialReceivedWalletBalancesTotal",String(k))}catch{}y({title:"تم تسجيل أرصدة البداية",description:"سُجّل إجمالي النقدية وأرصدة المحافظ لبداية الورديه"}),Ot(!1)},children:"تأكيد وحفظ"})})]})}),e.jsx(ge,{open:re,onOpenChange:p=>{p&&_(!0)},children:e.jsxs(fe,{className:"sm:max-w-md",hideClose:!0,disableOutsideClose:!0,disableEscClose:!0,children:[e.jsx(ye,{children:e.jsx(ve,{children:"تسليم الورديه والخروج"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(h,{variant:W==="toUser"?"default":"secondary",onClick:()=>he("toUser"),children:"تسليم إلى مستخدم آخر"}),e.jsx(h,{variant:W==="toAdmin"?"default":"secondary",onClick:()=>he("toAdmin"),children:"تسليم إلى الأدمن الرئيسي"})]}),W==="toUser"&&e.jsxs("div",{className:"space-y-3",children:[Jt.length===0?e.jsx("div",{className:"text-sm text-gray-600",children:"لا يوجد مستخدمون مسجلون. قم بإضافة مستخدم أولاً."}):e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"اختر المستخدم الذي سيتسلم الورديه"}),e.jsx("div",{className:"space-y-2 max-h-40 overflow-auto",children:Jt.map((p,k)=>e.jsxs("div",{className:`flex items-center justify-between rounded border px-3 py-2 cursor-pointer ${(Ce==null?void 0:Ce.username)===p.username?"bg-indigo-50 border-indigo-200":""}`,onClick:()=>Le(p),children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:p.name}),e.jsx("div",{className:"text-xs text-gray-500",children:p.username})]}),e.jsx("span",{className:"text-xs text-gray-400",children:"اختيار"})]},k))})]}),e.jsxs("div",{children:[e.jsx(X,{className:"mb-1 block",children:"كلمة سر المستخدم المحدد"}),e.jsx(z,{type:"password",autoComplete:"off",value:Ue,onChange:p=>at(p.target.value),placeholder:"أدخل كلمة السر"})]}),Q&&e.jsx("div",{className:"text-xs text-red-600",children:Q})]}),W==="toAdmin"&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm text-gray-600",children:"أدخل كلمة مرور الحساب الرئيسي لتسليم الورديه والخروج إلى الأدمن."}),e.jsx(z,{type:"password",autoComplete:"off",value:ne,onChange:p=>xe(p.target.value),placeholder:"كلمة المرور"}),ie&&e.jsx("div",{className:"text-xs text-red-600",children:ie})]})]}),e.jsx(dt,{className:"flex gap-2 justify-between",children:e.jsx(h,{disabled:et||!W,onClick:async()=>{if(W){se(!0);try{const p=await oa();if(W==="toUser"){if(!Ce){de("يرجى اختيار المستخدم أولاً"),se(!1);return}if(Ue.trim()!==Ce.password){de("كلمة السر غير صحيحة"),se(!1);return}C(),D({name:Ce.name,username:Ce.username}),s(),wt(`${Ce.name} (${Ce.username})`);try{localStorage.setItem("lastHandoverToAdmin","false")}catch{}_(!1),he(null),Le(null),at(""),de(""),u(!1),Lt(p),je(null),rt(""),ht(!0)}else if(W==="toAdmin"){te("");const k=(S==null?void 0:S.email)||"";if(!k){te("لا يوجد بريد للمستخدم الرئيسي للتحقق"),se(!1);return}const{error:U}=await T(k,ne);if(U){te("كلمة المرور غير صحيحة"),se(!1);return}C(),D(null);try{localStorage.setItem("lastHandoverToAdmin","true")}catch{}xe(""),_(!1),u(!1),wt("الأدمن الرئيسي"),Lt(p),je(null),rt(""),ht(!0)}}catch{de("حدث خطأ أثناء التسليم، حاول مرة أخرى")}finally{se(!1)}}},children:"تأكيد التسليم"})})]})}),e.jsx(ge,{open:pe,onOpenChange:ht,children:e.jsxs(fe,{className:"sm:max-w-lg",hideClose:!0,disableOutsideClose:!0,disableEscClose:!0,children:[e.jsx(ye,{children:e.jsx(ve,{children:"تقرير تسليم الورديه والخروج"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 rounded border bg-gray-50",children:[e.jsxs("div",{className:"text-sm",children:["تم تسليم الورديه إلى: ",e.jsx("span",{className:"font-semibold",children:kt})]}),v&&e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["بداية الورديه: ",new Date(v).toLocaleString("ar-EG")]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["نهاية الورديه: ",new Date().toLocaleString("ar-EG")]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(X,{className:"mb-1 block",children:"الفلوس النقدية المستلمة"}),e.jsx(z,{type:"number",value:ue,readOnly:!0,disabled:!0,placeholder:"قيمة مسجلة عند بداية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"قيمة غير قابلة للتعديل؛ تُسجّل عند الدخول."})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(X,{className:"mb-1 block",children:"أرصدة المحافظ المستلمة (إجمالي)"}),e.jsx(z,{type:"number",value:q,readOnly:!0,disabled:!0,placeholder:"إجمالي مسجل عند بداية الورديه"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(X,{className:"mb-1 block",children:"الفلوس النقدية المسلمة"}),e.jsx(z,{type:"number",value:M,onChange:p=>{const k=parseFloat(p.target.value);me(Number.isFinite(k)?k:0)},placeholder:"أدخل قيمة النقدية المسلمة عند نهاية الورديه"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"ادخال يدوي لقيمة النقدية المسلّمة عند نهاية الورديه"})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx(X,{className:"mb-1 block",children:"أرصدة المحافظ المسلمة (إجمالي)"}),e.jsx(z,{type:"number",value:Ie,onChange:p=>{const k=parseFloat(p.target.value);it(Number.isFinite(k)?k:0)},placeholder:"أدخل إجمالي أرصدة المحافظ المسلّمة"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"يمكنك إدخال الإجمالي يدوياً؛ التفصيل يُحفظ إن لزم"})]})]}),e.jsxs("div",{className:"rounded border p-3",children:[e.jsx("div",{className:"text-sm font-semibold mb-1",children:"أرباح الوردية"}),e.jsx("div",{className:["text-sm",(M??0)+(Ie??0)-((parseFloat(ue||"0")||0)+(q??0))>=0?"text-green-700":"text-red-700"].join(" "),children:Math.round(((M??0)+(Ie??0)-((parseFloat(ue||"0")||0)+(q??0)))*100)/100}),e.jsx("div",{className:"text-xs text-gray-600",children:"محسوبة: (المسلّم − المستلم) للنقدية + المحافظ"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"هل يوجد عجز؟"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(h,{variant:Vt==="no"?"default":"secondary",onClick:()=>je("no"),children:"لا"}),e.jsx(h,{variant:Vt==="yes"?"default":"secondary",onClick:()=>je("yes"),children:"نعم"})]}),Vt==="yes"&&e.jsxs("div",{children:[e.jsx(X,{className:"mb-1 block",children:"مبلغ العجز"}),e.jsx(z,{type:"number",value:Ke,onChange:p=>rt(p.target.value),placeholder:"أدخل مبلغ العجز"})]})]})]}),e.jsx(dt,{className:"flex gap-2 justify-between",children:e.jsx(h,{onClick:()=>{const p=Vt==="yes",k=parseFloat(Ke)||0;(async()=>await d(Yt,p,k))(),y({title:"تم إضافة إيصال تسليم الورديه",description:"أُضيف الإيصال إلى المعاملات الأخيرة بعنوان إيصال تسليم وردية"}),ht(!1)},children:"تأكيد وحفظ الإيصال"})})]})})]})},$h=({open:i,onOpenChange:u})=>{const{shiftUser:c,endShift:g,setShiftUser:v}=Sr(),[D,s]=n.useState(""),[C,$]=n.useState(""),[S,T]=n.useState([]),{user:O}=Hs();n.useEffect(()=>{(async()=>{try{if(O!=null&&O.uid){const N=Qe(H,"profiles",O.uid,"cashierUsers","list"),P=await va(N);if(P.exists()){const J=P.data(),F=Array.isArray(J==null?void 0:J.users)?J.users:[];if(F&&F.length>0){T(F);return}}}}catch{}try{const N=`cashierUsers_${(O==null?void 0:O.uid)||"default"}`;let P=localStorage.getItem(N);if(!P){const J=localStorage.getItem("cashierUsers");J&&(P=J)}T(P?JSON.parse(P):[])}catch{T([])}})()},[i,O==null?void 0:O.uid]),n.useEffect(()=>{if(!i||!(O!=null&&O.uid))return;const N=Qe(H,"profiles",O.uid,"cashierUsers","list"),P=Os(N,J=>{if(J.exists()){const F=J.data(),G=Array.isArray(F==null?void 0:F.users)?F.users:[];if(G&&G.length>0)T(G);else try{const Z=`cashierUsers_${(O==null?void 0:O.uid)||"default"}`;let re=localStorage.getItem(Z);if(!re){const _=localStorage.getItem("cashierUsers");_&&(re=_)}T(re?JSON.parse(re):[])}catch{T([])}}},J=>{console.warn("ShiftProfileDialog cashierUsers snapshot error:",J)});return()=>P()},[i,O==null?void 0:O.uid]);const y=async()=>{if($(""),!c)return;const N=S.find(P=>P.username===c.username);if(!N){$("لا يوجد مستخدم مطابق لهذه الوردية");return}if(D.trim()!==N.password){$("الرقم السري غير صحيح");return}g(),v(null),s(""),u(!1)};return e.jsx(ge,{open:i,onOpenChange:N=>{s(""),$(""),u(N)},children:e.jsxs(fe,{className:"sm:max-w-md",children:[e.jsx(ye,{children:e.jsx(ve,{children:"بروفيل الوردية"})}),c?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"rounded-lg border p-3 bg-gradient-to-r from-blue-50 to-indigo-50",children:[e.jsx("div",{className:"text-sm font-semibold text-gray-800",children:c.name}),e.jsx("div",{className:"text-xs text-gray-600",children:c.username})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{className:"block",children:"أدخل الرقم السري لتسليم الوردية"}),e.jsx(z,{type:"password",value:D,onChange:N=>s(N.target.value),placeholder:"الرقم السري للمستخدم",dir:"ltr"}),C&&e.jsx("div",{className:"text-red-600 text-xs",children:C})]})]}):e.jsx("div",{className:"text-sm text-gray-600",children:"لا يوجد مستخدم وردية نشط حالياً"}),e.jsxs(dt,{className:"flex justify-between",children:[e.jsx(h,{variant:"outline",onClick:()=>u(!1),children:"إغلاق"}),e.jsx(h,{onClick:y,disabled:!c,children:"تسليم الوردية"})]})]})})},Lh=({open:i,onOpenChange:u})=>e.jsx(ge,{open:i,onOpenChange:u,children:e.jsxs(fe,{className:"sm:max-w-lg rounded-2xl",children:[e.jsxs(ye,{children:[e.jsxs(ve,{className:"text-right flex items-center gap-2 justify-end",children:[e.jsx(Ii,{className:"w-5 h-5"}),"سجل التغييرات الأخيرة"]}),e.jsx(is,{className:"text-right",children:"هذه أبرز التحسينات التي تمت مؤخرًا في الواجهة."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(To,{className:"w-5 h-5 text-amber-600 mt-1"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold",children:"تحسين نافذة تعديل المديونية"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"استبدال نافذة الإدخال القديمة (prompt) بحوار أنيق لإدخال المبلغ مع تأكيد."})]})]}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Pm,{className:"w-5 h-5 text-violet-600 mt-1"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold",children:"تحديث شاشة التحميل"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:'تغيير النص إلى "صلي علي النبي" مع خط عربي جميل ونبض لطيف.'})]})]}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Ii,{className:"w-5 h-5 text-green-600 mt-1"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold",children:"بطاقات الأرباح وعدد العمليات"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"إضافة بطاقات عرض أرباح الفترة الحالية وعدد العمليات في تفاصيل المحفظة."})]})]}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Ii,{className:"w-5 h-5 text-blue-600 mt-1"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold",children:"إصلاح تمرير نافذة اليومية"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"منع تمرير الصفحة الخلفية عند فتح نافذة اليومية لراحة الاستخدام."})]})]})]}),e.jsx("div",{className:"flex justify-end gap-2 mt-6",children:e.jsx(h,{variant:"secondary",onClick:()=>u(!1),children:"إغلاق"})})]})});class qa{static async processTransfer(u){const{amount:c,currentCashBalance:g,currentWalletBalances:v,wallets:D,selectedWalletId:s}=u;if(c<=0)return{success:!1,newCashBalance:g,newWalletBalances:v,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(s&&!u.skipRemoteLimitsCheck)try{const T=await Ks.canPerformOperation(s,c,"transfer");if(!T.canPerform)return{success:!1,newCashBalance:g,newWalletBalances:v,message:T.message||"تم تجاوز الحد الأقصى",error:"LIMIT_EXCEEDED"}}catch(T){return console.error("خطأ في التحقق من حدود التحويل:",T),{success:!1,newCashBalance:g,newWalletBalances:v,message:"خطأ في التحقق من حدود التحويل",error:"LIMIT_CHECK_ERROR"}}if(c<=0)return{success:!1,newCashBalance:g,newWalletBalances:v,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(s){const T=Math.max(v[s]||0,0);if(T<c){const O=D.find(y=>y.id===s);return{success:!1,newCashBalance:g,newWalletBalances:v,message:`رصيد غير كافي في المحفظة${O?` ${O.name}`:""}. المتاح: ${T} جنيه، المطلوب: ${c} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"}}}else{const T=qa.calculateTotalWalletBalance(v);if(T<c)return{success:!1,newCashBalance:g,newWalletBalances:v,message:`رصيد غير كافي في المحافظ. الرصيد المتاح: ${T} جنيه، المبلغ المطلوب: ${c} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"}}const C={...v};if(s){const T=C[s]||0;C[s]=T-c}else{let T=c;for(const O of D){if(T<=0)break;const y=Math.max(C[O.id]||0,0),N=Math.min(y,T);N>0&&(C[O.id]=(C[O.id]||0)-N,T-=N)}}const $=g+c;if(s)try{const T=Ks.updateUsage(s,c,"transfer");u.nonBlockingUsageUpdate?T.catch(O=>console.error("خطأ في تحديث استخدام المحفظة:",O)):await T}catch(T){console.error("خطأ في تحديث استخدام المحفظة:",T)}let S="تم التحويل بنجاح";if(s){const T=C[s]||0;T<0&&(S=`تم التحويل بنجاح مع تحذير: رصيد محفظة ${s} أصبح ${T} جنيه.`)}return{success:!0,newCashBalance:$,newWalletBalances:C,message:S}}static processDeposit(u){const{amount:c,currentCashBalance:g,currentWalletBalances:v,wallets:D}=u;if(c<=0)return{success:!1,newCashBalance:g,newWalletBalances:v,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};const s=this.calculateTotalWalletBalance(v);if(s<c)return{success:!1,newCashBalance:g,newWalletBalances:v,message:`رصيد غير كافي في المحافظ. الرصيد المتاح: ${s} جنيه، المبلغ المطلوب: ${c} جنيه`,error:"INSUFFICIENT_WALLET_BALANCE"};const C=g+c,$={...v};let S=c;const T=D.find(y=>y.isDefault);if(T&&$[T.id]>=S)$[T.id]-=S,S=0;else for(const y of D){if(S<=0)break;const N=$[y.id]||0;if(N>0){const P=Math.min(N,S);$[y.id]=N-P,S-=P}}const O=S>0?`تم الإيداع جزئياً. تم إيداع ${c-S} جنيه في صندوق النقدية`:`تم الإيداع بنجاح. تم إضافة ${c} جنيه إلى صندوق النقدية`;return{success:!0,newCashBalance:C,newWalletBalances:$,message:O}}static async processWithdraw(u){const{amount:c,currentCashBalance:g,currentWalletBalances:v,wallets:D,selectedWalletId:s}=u;if(c<=0)return{success:!1,newCashBalance:g,newWalletBalances:v,message:"المبلغ يجب أن يكون أكبر من الصفر",error:"INVALID_AMOUNT"};if(s&&!u.skipRemoteLimitsCheck)try{const T=await Ks.canPerformOperation(s,c,"withdraw");if(!T.canPerform)return{success:!1,newCashBalance:g,newWalletBalances:v,message:T.message||"تم تجاوز الحد الأقصى",error:"LIMIT_EXCEEDED"}}catch(T){return console.error("خطأ في التحقق من حدود السحب:",T),{success:!1,newCashBalance:g,newWalletBalances:v,message:"خطأ في التحقق من حدود السحب",error:"LIMIT_CHECK_ERROR"}}if(g<c)return{success:!1,newCashBalance:g,newWalletBalances:v,message:`رصيد غير كافي في صندوق النقدية. الرصيد المتاح: ${g} جنيه، المبلغ المطلوب: ${c} جنيه`,error:"INSUFFICIENT_CASH_BALANCE"};const C=g-c,$={...v},S=s?D.find(T=>T.id===s):D.find(T=>T.isDefault)||D[0];if(S){const T=$[S.id]||0;$[S.id]=T+c}else return{success:!1,newCashBalance:g,newWalletBalances:v,message:"لا توجد محافظ متاحة لإضافة المبلغ إليها",error:"NO_WALLETS_AVAILABLE"};if(s)try{const T=Ks.updateUsage(s,c,"withdraw");u.nonBlockingUsageUpdate?T.catch(O=>console.error("خطأ في تحديث استخدام المحفظة:",O)):await T}catch(T){console.error("خطأ في تحديث استخدام المحفظة:",T)}return{success:!0,newCashBalance:C,newWalletBalances:$,message:`تم السحب بنجاح. تم إضافة ${c} جنيه إلى محفظة ${(S==null?void 0:S.name)||""}`}}static validateOperation(u,c){return u<=0?{valid:!1,error:"المبلغ يجب أن يكون أكبر من الصفر"}:!c||c.length===0?{valid:!1,error:"لا توجد محافظ متاحة"}:{valid:!0}}static calculateTotalWalletBalance(u){return Object.values(u).reduce((c,g)=>c+Math.max(g,0),0)}static deductFromWalletsAddToCash(u,c,g,v){return this.processTransfer({amount:u,currentCashBalance:c,currentWalletBalances:g,wallets:v})}static deductFromWalletsAddToCashDeposit(u,c,g,v){return this.processDeposit({amount:u,currentCashBalance:c,currentWalletBalances:g,wallets:v})}static deductFromCashAddToWallets(u,c,g,v){return this.processWithdraw({amount:u,currentCashBalance:c,currentWalletBalances:g,wallets:v})}static applyTransactionResult(u,c,g){u.success&&(c(u.newCashBalance),g(u.newWalletBalances))}static validateTransaction(u,c,g,v){if(u<=0)return{isValid:!1,error:"المبلغ يجب أن يكون أكبر من الصفر"};if(c==="transfer"){const D=this.calculateTotalWalletBalance(v);if(D<u)return{isValid:!1,error:`الرصيد المتاح في المحافظ (${D} جنيه) غير كافي للمبلغ المطلوب (${u} جنيه)`}}else if(c==="withdraw"){if(g<u)return{isValid:!1,error:`الرصيد المتاح في صندوق النقدية (${g} جنيه) غير كافي للمبلغ المطلوب (${u} جنيه)`}}else if(c==="deposit"){const D=this.calculateTotalWalletBalance(v);if(D<u)return{isValid:!1,error:`الرصيد المتاح في المحافظ (${D} جنيه) غير كافي للمبلغ المطلوب (${u} جنيه)`}}return{isValid:!0}}static getDeductionPreview(u,c,g){const v=[];let D=u;for(const s of g){if(D<=0)break;const C=c[s.id]||0,$=Math.min(Math.max(C,0),D);$>0&&(v.push({walletId:s.id,walletName:s.name,currentBalance:C,deductedAmount:$,newBalance:C-$}),D-=$)}return v}}let fr=null;function Bh(){const i=window;if(!fr){const u=i.AudioContext||i.webkitAudioContext;fr=new u}return fr.state==="suspended"&&fr.resume(),fr}function Uh(i,u,c){const g=c/1e3,v=Math.floor(i.sampleRate*g),D=i.createBuffer(1,v,i.sampleRate),s=D.getChannelData(0);for(let T=0;T<v;T++)s[T]=(Math.random()*2-1)*.6;const C=i.createBufferSource();C.buffer=D;const $=i.createBiquadFilter();$.type="highpass",$.frequency.value=1500,$.Q.value=.7;const S=i.createGain();S.gain.setValueAtTime(1e-4,u),S.gain.exponentialRampToValueAtTime(.4,u+.015),S.gain.exponentialRampToValueAtTime(1e-4,u+g),C.connect($),$.connect(S),S.connect(i.destination),C.start(u),C.stop(u+g+.01)}function zh(i,u,c,g,v,D="triangle"){const s=i.createOscillator(),C=i.createGain();s.type=D;const $=v/1e3;s.frequency.setValueAtTime(c,u),s.frequency.linearRampToValueAtTime(g,u+$),C.gain.setValueAtTime(1e-4,u),C.gain.exponentialRampToValueAtTime(.25,u+.02),C.gain.exponentialRampToValueAtTime(1e-4,u+$),s.connect(C),C.connect(i.destination),s.start(u),s.stop(u+$+.02)}function qh(){try{const i=Bh(),u=i.currentTime;Uh(i,u,90),zh(i,u+.12,1900,1100,180,"sawtooth")}catch{}}function Vh(i){if(!i)return!1;const c=i.replace(/[^0-9٠-٩]/g,"").replace(/[٠-٩]/g,g=>"0123456789"["٠١٢٣٤٥٦٧٨٩".indexOf(g)]);return/^(010|011|012|015)[0-9]{8}$/.test(c)}function Jh({userId:i}){const[u,c]=Je.useState(null),[g,v]=Je.useState("");return null}const Hu=()=>{var so,ao,ro,no,io,lo;console.log("🔥 UserDashboardPage component is loading...");const{toast:i}=Es(),u=n.useRef(null),[c,g]=n.useState(0),v=async()=>{var r,l,o;const t="alkaptin678678@gmail.com",a=(l=(r=za.currentUser)==null?void 0:r.email)==null?void 0:l.toLowerCase();if(!a||a!==t){i({title:"قيد التطوير",description:"هذه الميزة غير متاحة حالياً."});return}if(!qr||!Vr||!Jr){i({title:"بيانات ناقصة",description:"أدخل رقم الموبايل، الشركة والمبلغ",variant:"destructive"});return}try{El(!0);const m=await((o=za.currentUser)==null?void 0:o.getIdToken()),x=await fetch("/api/topup",{method:"POST",headers:{"Content-Type":"application/json",...m?{Authorization:`Bearer ${m}`}:{}},body:JSON.stringify({phone:qr,countryCode:"EG",operator:Vr,amount:Number(Jr),useLocalAmount:!0})}),f=await x.json().catch(()=>({}));x.ok&&(f!=null&&f.success)?(i({title:"تم الشحن",description:(f==null?void 0:f.message)||"تم تنفيذ عملية الشحن بنجاح"}),ci(!1),Pl(""),kl(""),Ol("")):i({title:"فشل الشحن",description:(f==null?void 0:f.message)||"حدث خطأ أثناء طلب الشحن",variant:"destructive"})}catch(m){console.error("Topup request error:",m),i({title:"خطأ غير متوقع",description:"تعذّر تنفيذ عملية الشحن. حاول لاحقاً.",variant:"destructive"})}finally{El(!1)}},{signOut:D,user:s,profile:C}=Hs(),$=((s==null?void 0:s.email)||"").toLowerCase()==="vodafonecash00@gmail.com",S=Co(),T=jo(),O=mm(),{isShiftActive:y,shiftUser:N}=Sr(),{shopId:P,shopName:J}=wn(),F=hm();(()=>{try{return!!window.electronAPI||typeof navigator<"u"&&navigator.userAgent.toLowerCase().includes("electron")||typeof window<"u"&&window.location&&window.location.protocol==="file:"}catch{return!1}})();const[G,Z]=n.useState(!1),[re,_]=n.useState(!1),[W,he]=n.useState(!1),[ne,xe]=n.useState(!1),[ie,te]=n.useState([]),[Oe,Re]=n.useState(""),[Ce,Le]=n.useState(""),[Ue,at]=n.useState(""),[Q,de]=n.useState(""),[et,se]=n.useState(!1),[pe,ht]=n.useState(!1),[Yt,Lt]=n.useState(null),[Vt,je]=n.useState(""),[Ke,rt]=n.useState(""),[ue,nt]=n.useState(!1);n.useEffect(()=>{const t=O==null?void 0:O.shopId;if(t&&(s!=null&&s.uid))try{const a=`selectedShopId_${s.uid}`;localStorage.setItem(a,String(t)),window.dispatchEvent(new Event("selectedShopIdChanged"))}catch{}},[O==null?void 0:O.shopId,s==null?void 0:s.uid]);const[q,xt]=n.useState([]),[vt,bt]=n.useState(()=>{try{return localStorage.getItem("cashySelectedDevice")||null}catch{return null}}),M=t=>!!(t&&q.some(a=>a.id===t));async function me(){const t=window.electronAPI,a=vt||"";if(!t||typeof t.sendUssd!="function")return null;if(!a)return i({title:"الجهاز غير محدد",description:"اتصل بالموبايل أولاً ثم اختر الجهاز من القائمة",variant:"destructive"}),null;if(M(a))return a;try{const m=q.find(x=>x&&x.id&&!String(x.id).includes(":"));if(m&&m.id)return bt(m.id),m.id}catch{}const r=a.includes(":")?a.split(":").slice(0,2).join(":"):"";if(r&&typeof t.connectWifi=="function"){try{await t.connectWifi(r)}catch{}if(await new Promise(m=>setTimeout(m,250)),M(a))return a}const l=a.split(":")[0],o=q.find(m=>(m.id.startsWith(l)||m.id.includes(l))&&m.id.includes(":"));if(o!=null&&o.id){const m=o.id.split(":").slice(0,2).join(":");if(!M(o.id)&&typeof t.connectWifi=="function"){try{await t.connectWifi(m)}catch{}await new Promise(x=>setTimeout(x,250))}if(M(o.id))return bt(o.id),o.id}return i({title:"الجهاز غير متصل",description:"فعّل Wireless debugging أو استخدم اتصال Wi‑Fi ثم أعد المحاولة",variant:"destructive"}),null}n.useEffect(()=>{const t=window.electronAPI;t&&typeof t.onAdbDevices=="function"&&t.onAdbDevices(a=>{var o;const r=Array.isArray(a)?a:[];xt(r);const l=(()=>{try{return localStorage.getItem("cashySelectedDevice")||""}catch{return""}})();l&&r.some(m=>m.id===l)?bt(l):(o=r[0])!=null&&o.id?bt(m=>m||r[0].id):bt(null)})},[]);function Ie(t,a){try{const r=ss==null?void 0:ss(),l=(r==null?void 0:r.phone)||"";if(!l){i({title:"يجب اختيار محفظة",description:"اختر محفظة المُرسل أولاً",variant:"destructive"});return}vm(l,t,a),i({title:"تم إرسال كود التحويل",description:"تم تنفيذ الاتصال مباشرة على الهاتف"}),Da(!1),Ma(!1)}catch(r){const l=(r==null?void 0:r.message)||"تعذر إرسال الكود — تحقق من البيانات";throw i({title:"فشل الإرسال",description:l,variant:"destructive"}),r}}const it=async()=>{var r;if(!gs||!gs.receiver||!gs.amount){i({title:"بيانات غير مكتملة",description:"تأكد من إدخال رقم المستقبل والمبلغ قبل الإرسال",variant:"destructive"});return}const t=String(gs.receiver),a=Math.round(Number(gs.amount));Ca(!0);try{if((r=ho)!=null&&r.isNativePlatform&&ho.getPlatform()==="android"){const o=ss==null?void 0:ss(),m=(o==null?void 0:o.phone)||"";if(!m){i({title:"يجب اختيار محفظة",description:"اختر محفظة المُرسل أولاً",variant:"destructive"}),Ca(!1);return}const x=uo(m,t,a);if(!x){i({title:"رقم غير مدعوم",description:"تحقق من بداية الرقم 010/011/012/015",variant:"destructive"}),Ca(!1);return}ym(x),i({title:"تم إرسال كود التحويل",description:"تم تنفيذ الاتصال مباشرة على الهاتف"}),Da(!1),Ma(!1);return}const l=window.electronAPI;if(l&&typeof l.sendUssd=="function"&&vt){const o=ss==null?void 0:ss(),m=(o==null?void 0:o.phone)||"";if(!m){i({title:"يجب اختيار محفظة",description:"اختر محفظة المُرسل أولاً",variant:"destructive"}),Ca(!1);return}const x=await me();if(!x){Ca(!1);return}const f=uo(m,t,a);if(!f){i({title:"رقم غير مدعوم",description:"تحقق من بداية الرقم 010/011/012/015",variant:"destructive"}),Ca(!1);return}try{const I=typeof l.pickSimAutomatically=="function"?await l.pickSimAutomatically(x,m):{deviceId:x,slot:0},w=`${I.deviceId}:sim${I.slot}`;Mc(w),await l.sendUssd(w,f)}catch{try{await l.sendUssd(x,f)}catch(w){const j=x.includes(":")?x.split(":").slice(0,2).join(":"):"";if(j&&typeof l.connectWifi=="function")await l.connectWifi(j),await l.sendUssd(x,f);else throw w}}i({title:"تم إرسال كود التحويل",description:"تم التنفيذ بنجاح"}),Da(!1),Ma(!0)}else Ie(t,a)}catch(l){const o=l&&l.message?l.message:"حدث خطأ غير متوقع أثناء الإرسال";i({title:"خطأ أثناء الإرسال",description:`الجهاز: ${nl||vt||"غير معروف"} — ${o}`,variant:"destructive"})}finally{Ca(!1)}},ot=async(t,a)=>{const r=window.electronAPI;try{if(r&&typeof r.enterPin=="function"&&t){await r.enterPin(t,a),Ma(!1);return}const l=String((C==null?void 0:C.bridgeLink)||"").trim(),o=String((C==null?void 0:C.bridgeDeviceId)||"").trim()||void 0;if(!l){i({title:"الرابط غير مُعدّ",description:"احفظ رابط الجسر أولاً",variant:"destructive"});return}const m=String((gs==null?void 0:gs.receiver)||Ns||"").replace(/\D/g,""),x=Math.max(1,Math.round(Number((gs==null?void 0:gs.amount)||Gt||0))||0),f=String(a||"").replace(/\D/g,""),w=(j=>{let R=(j||"").trim();return R=R.replace(/\/+$/,""),/^https?:\/\//i.test(R)||(R=`https://${R}`),R})(l);Ma(!1)}catch(l){const o=(l==null?void 0:l.message)||"حدث خطأ أثناء إدخال الرقم السري";i({title:"فشل الإدخال",description:o,variant:"destructive"})}};console.log("🔥 UserDashboardPage - user:",s?"exists":"null");const[Pt,kt]=n.useState(!0),[wt,Ze]=n.useState(!0),[Ot,St]=n.useState(!1),[Jt,Bt]=n.useState(!1),[Is,bs]=n.useState(""),[zs,Fs]=n.useState(""),[ws,A]=n.useState(""),[ee,oe]=n.useState([]),[Se,be]=n.useState(!1),[Fe,Xe]=n.useState(null),[B,qe]=n.useState(""),[Y,pt]=n.useState(!1),[jt,Dt]=n.useState(!1),[ts,Ht]=n.useState(!1),[Gs,oa]=n.useState(!1),[d,E]=n.useState(""),[p,k]=n.useState(""),[U,K]=n.useState([]),[we,Ne]=n.useState(!1),[ce,$e]=n.useState(0),[_e,Ve]=n.useState(!1),[gt,ze]=n.useState(null),[mt,_t]=n.useState(!1),[Ut,Ws]=n.useState(""),[Ns,Na]=n.useState(""),[Gt,ca]=n.useState(""),[ja,Mi]=n.useState(""),[Nn,Fa]=n.useState(!1),[jn,Sn]=n.useState(""),[cc,Sa]=n.useState(""),[Ri,$i]=n.useState(""),[Dn,dc]=n.useState(""),[Ms,Cn]=n.useState(null),[mc,Li]=n.useState(!1),[hc,Bi]=n.useState(!1),[uc,Dr]=n.useState(!1),[xc,In]=n.useState(!1),[Ui,An]=n.useState(null),[xs,Tn]=n.useState(""),[ps,Pn]=n.useState(""),[zi,pc]=n.useState(""),[gc,Cr]=n.useState(!1),[Kh,Yh]=n.useState(null),[As,qi]=n.useState(null),Ir=t=>{const a="٠١٢٣٤٥٦٧٨٩",r="۰۱۲۳۴۵۶۷۸۹";return(t||"").split("").map(l=>{const o=a.indexOf(l);if(o>-1)return String(o);const m=r.indexOf(l);return m>-1?String(m):l}).join("")},[ut,kn]=n.useState(()=>{try{const t=localStorage.getItem("commissionMode")||localStorage.getItem("commissionMode_default");return t?t==="add":!0}catch{return!0}}),[le,Vi]=n.useState("transfer"),[ft,Qs]=n.useState([]),[Zs,On]=n.useState("all");n.useEffect(()=>{try{if(localStorage.setItem("commissionMode",ut?"add":"deduct"),s!=null&&s.uid){const t=`commissionMode_${s.uid}`;localStorage.setItem(t,ut?"add":"deduct")}}catch{}},[ut,s==null?void 0:s.uid]),n.useEffect(()=>{try{const t=s!=null&&s.uid?localStorage.getItem(`commissionMode_${s.uid}`):null,a=localStorage.getItem("commissionMode"),r=localStorage.getItem("commissionMode_default"),l=t??a??r;l&&kn(l==="add")}catch{}},[s==null?void 0:s.uid]);const[_n,Ja]=n.useState(!1),[fc,yc]=n.useState(null),Ar=Je.useRef(""),Ji=Je.useRef(0);n.useEffect(()=>{const t=a=>{var l;if(_n)return;try{const o=document.activeElement;if(o){const m=(l=o.tagName)==null?void 0:l.toLowerCase();if(m==="input"||m==="textarea"||m==="select"||m==="button"||o.isContentEditable===!0)return}}catch{}const r=Date.now();if(a.key==="Enter"){const o=(Ar.current||"").trim();Ar.current="",o&&(yc(o),Ja(!0));return}a.key.length===1&&(r-(Ji.current||0)>100&&(Ar.current=""),Ar.current+=a.key,Ji.current=r)};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[_n]);const[vc,bc]=n.useState(!1),[wc,Hh]=n.useState(null),[ae,En]=n.useState("");n.useEffect(()=>{if(!Nn)return;const t=ss(),a=parseFloat(Gt||"0")||0;let r=0;if(le==="transfer"){if((t==null?void 0:t.defaultTransferCommission)!=null){const o=Number(t.defaultTransferCommission)||0;r=Math.round(o*a/1e3*100)/100}else{const o=ps&&ps.trim()!==""?parseFloat(ps):0;r=Math.max(0,o)}const l=a+r;Sa((l||0).toString())}else{if((t==null?void 0:t.defaultWithdrawCommission)!=null){const o=Number(t.defaultWithdrawCommission)||0;r=Math.round(o*a/1e3*100)/100}else{const o=xs&&xs.trim()!==""?parseFloat(xs):Math.round(a*.01*100)/100;r=Math.max(0,o)}const l=ut?a:Math.max(0,Math.round((a-r)*100)/100);Sa((l||0).toString())}},[Nn,Gt,ps,xs,ae,ut,le]);const ss=()=>{var a,r;let t=Ye.find(l=>l.id===ae);if(!t)try{const l=localStorage.getItem(gi());if(l){const o=JSON.parse(l);if(Array.isArray(o)&&o.length>0){const x=localStorage.getItem(`selectedWallet_${(s==null?void 0:s.uid)||"default"}`)||((a=o.find(f=>f.isDefault))==null?void 0:a.id)||((r=o[0])==null?void 0:r.id);t=o.find(f=>f.id===x)}}}catch{}return t};n.useLayoutEffect(()=>{try{const t=`wallets_${(s==null?void 0:s.uid)||"default"}`;let a=localStorage.getItem(t);if(!a){const r=Object.keys(localStorage).find(l=>l.startsWith("wallets_"));r&&(a=localStorage.getItem(r)||null)}if(a){const r=JSON.parse(a);if(Array.isArray(r)&&r.length>0){Ka(r);const l=`selectedWallet_${(s==null?void 0:s.uid)||"default"}`,o=localStorage.getItem(l),m=o&&r.find(x=>x.id===o)||r.find(x=>x.isDefault)||r[0];m&&(En(m.id),Ws(m.phone))}}}catch(t){console.error("تهيئة فورية للمحافظ من التخزين المحلي فشلت:",t)}},[]),n.useEffect(()=>{console.log("🔍 selectedWallet state changed to:",ae)},[ae]),n.useEffect(()=>{Rl()},[s==null?void 0:s.uid]),n.useEffect(()=>{Sd()},[]);const[Ye,Ka]=n.useState(()=>{try{const t=Object.keys(localStorage).find(r=>r.startsWith("wallets_")),a=t?localStorage.getItem(t):null;if(a){const r=JSON.parse(a);if(Array.isArray(r))return r}}catch{}return[]}),[Ki,Nc]=n.useState(""),Yi=(()=>{const t=Ki.replace(/\D/g,"");return t?Ye.filter(a=>(a.phone||"").replace(/\D/g,"").includes(t)):Ye})(),[jc,Gh]=n.useState(null),[Sc,Hi]=n.useState(!1),[Dc,Tr]=n.useState(!1),[Cc,Ic]=n.useState(null),[Qh,Ac]=n.useState([]),[Zh,Xh]=n.useState([]),[Tc,Ya]=n.useState(!1),[Fn,Gi]=n.useState("daily"),[Pr,Ha]=n.useState([]),[Qi,Pc]=n.useState(!1),da=Je.useRef(new Set),Zi=async t=>{try{if(!s)return;const a=Ds(),r=Ss(),l=localStorage.getItem(a),o=localStorage.getItem(r);let m=l?parseFloat(l):Ct,x=o?JSON.parse(o):{...He};const f=Number(t.withdrawnAmount??t.sentAmount??t.transferredAmount??t.amount??0);if(t.type==="send"&&(t.fromWallet||ae)){m-=f;const j=t.fromWallet||ae;x[j]=(x[j]||0)+f}else if(t.type==="withdraw"&&(t.fromWallet||ae)){m+=f;const j=t.fromWallet||ae;x[j]=Math.max(0,(x[j]||0)-f)}zt(m),ns(x),localStorage.setItem(a,m.toString()),localStorage.setItem(r,JSON.stringify(x));const I={cashBalance:m,walletBalances:x,lastUpdated:new Date().toISOString()},w=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(w,JSON.stringify(I));try{await Me.updateUserData(s.uid,I),localStorage.removeItem(w),Be(!1)}catch(j){console.warn("تعذر حفظ الأرصدة في Firebase بعد الحذف (مزامنة تلقائية):",j),Be(!0)}try{const j=t.fromWallet||ae,R=await Ks.getWalletLimits(s.uid,j);if(R){const L={...R};t.type==="send"?(L.dailyTransferUsed=Math.max(0,(R.dailyTransferUsed||0)-f),L.monthlyTransferUsed=Math.max(0,(R.monthlyTransferUsed||0)-f)):(L.dailyWithdrawUsed=Math.max(0,(R.dailyWithdrawUsed||0)-f),L.monthlyWithdrawUsed=Math.max(0,(R.monthlyWithdrawUsed||0)-f)),await Ks.updateWalletLimits(s.uid,j,L)}}catch(j){console.warn("تعذر تحديث حدود المحفظة بعد الحذف (مزامنة):",j)}try{ds.removeTransactionEffects(t,s.uid)}catch(j){console.warn("تعذر تحديث التقارير بعد الحذف (مزامنة):",j)}}catch(a){console.warn("خطأ أثناء تطبيق تأثيرات الحذف محليًا:",a)}},kc=async t=>{try{const a=ft.find(x=>x.id===t);if(!a||!s)return;const r=String(t),l=String((a==null?void 0:a.transactionId)||(a==null?void 0:a.reference)||""),o=da.current.has(r)||l&&da.current.has(l),m=ft.filter(x=>x.id!==t);Qs(m);try{await Me.removeUserTransaction(s.uid,t),await gr.permanentlyDeleteTransaction(t,s.uid)}catch(x){console.warn("تعذر الحذف النهائي من قواعد البيانات أثناء حذف الإيصال:",x)}if(!o){da.current.add(r),l&&da.current.add(l),await Zi(a);try{s!=null&&s.uid&&Me.removeLocalReceiptById(s.uid,t)}catch{}}i({title:"تم الحذف نهائيًا",description:"تم حذف الإيصال نهائيًا وعكس تأثيراته على الأرصدة والحدود والتقارير."}),Tr(!1)}catch(a){console.error("خطأ أثناء حذف الإيصال:",a),i({title:"خطأ في حذف الإيصال",description:"حدث خطأ غير متوقع أثناء الحذف.",variant:"destructive"})}},Oc=async t=>{var a;try{const r=ft.find(l=>l.id===t);if(!r||!s)return;try{const l=(a=gt==null?void 0:gt.subscription)==null?void 0:a.planType;if(l===ms.ZERO){const{dailyOperationCountService:o}=await Nt(async()=>{const{dailyOperationCountService:f}=await import("./dailyOperationCountService-Bn7ZiDM3.js");return{dailyOperationCountService:f}},__vite__mapDeps([2,0,1]),import.meta.url),m=r.type==="send"?"transfer":"withdraw";if(!(await o.checkAndIncrement(s.uid,m,5)).allowed){i({title:"تم بلوغ حد باقة الزيرو",description:"مسموح بحد أقصى 5 تأكيدات يوميًا للتحويل/السحب. جرّب غدًا أو قم بالترقية.",variant:"destructive"});return}}else if(l===ms.TAHWEELA){const{dailyOperationCountService:o}=await Nt(async()=>{const{dailyOperationCountService:f}=await import("./dailyOperationCountService-Bn7ZiDM3.js");return{dailyOperationCountService:f}},__vite__mapDeps([2,0,1]),import.meta.url),m=r.type==="send"?"transfer":"withdraw";if(!(await o.checkAndIncrementCombined(s.uid,m,40)).allowed){i({title:"تم بلوغ حد باقة تحويله",description:"هذه الباقة تسمح بحد أقصى 40 عملية تحويل/سحب يومياً.",variant:"destructive"});return}}}catch(l){console.warn("تعذر التحقق من حد التأكيد اليومي:",l)}await Vs(Qe(H,"userTransactions",t),{status:"completed",confirmedAt:new Date}),Qs(l=>l.map(o=>o.id===t?{...o,status:"completed"}:o)),i({title:"تم الإكمال",description:"تم وسم المعاملة كمكتملة."}),Tr(!1)}catch(r){console.error("خطأ أثناء إكمال الإيصال:",r),i({title:"فشل الإكمال",description:"حدث خطأ غير متوقع أثناء تحديث الحالة.",variant:"destructive"})}};n.useEffect(()=>{if(s)try{const t=st(Te(H,"deletedTransactions"),ke("userId","==",s.uid)),a=Os(t,r=>{r.docChanges().forEach(l=>{if(l.type!=="added")return;const o=l.doc.data(),m=String((o==null?void 0:o.originalTransactionId)||""),x=String((o==null?void 0:o.transactionId)||""),f=String((o==null?void 0:o.reference)||""),I=m||x||f||String(l.doc.id);I&&(da.current.has(I)||(da.current.add(I),Qs(w=>{const j=w.find(L=>L.id===m);return j?((async()=>await Zi(j))(),w.filter(L=>L.id!==m)):w})))})},r=>{console.warn("فشل الاشتراك في deletedTransactions:",r)});return()=>a()}catch(t){console.warn("تعذر إنشاء مستمع deletedTransactions:",t)}},[s==null?void 0:s.uid]),n.useEffect(()=>{if(s)try{const t=Qe(H,"users",s.uid),a=Os(t,async r=>{if(!r.exists())return;const l=r.data();if(l!=null&&l.reportsData)try{await ds.syncReportsDataFromFirebase(s.uid),Ac(hr())}catch(o){console.warn("تعذر مزامنة reportsData من السحابة:",o)}},r=>{console.warn("فشل الاشتراك في users.reportsData:",r)});return()=>a()}catch(t){console.warn("تعذر إنشاء مستمع users.reportsData:",t)}},[s==null?void 0:s.uid]);const[Xi,_c]=n.useState(""),el=Oh(Xi,300),[kr,tl]=n.useState(""),[Or,sl]=n.useState(""),[Xs,eu]=n.useState(""),[Wn,Wa]=n.useState(!1),[al,Ga]=n.useState(!1),[Ec,Da]=n.useState(!1),[Qt,Mn]=n.useState(null),[gs,Fc]=n.useState(null),[rl,Ca]=n.useState(!1),[Wc,Ma]=n.useState(!1),[nl,Mc]=n.useState(""),[Rc,Rn]=n.useState(!1),il=!1,[$c,_r]=n.useState(!1),[Lc,ll]=n.useState(!1),[Bc,Er]=n.useState(!1),[Uc,Fr]=n.useState(!1),[zc,Wr]=n.useState(!1),[qc,ol]=n.useState(!0),[Qa,Vc]=n.useState(!1),[Jc,Mr]=n.useState(!1),[Kc,cl]=n.useState(()=>{try{const t=s!=null&&s.uid?`dailyReportsLockEnabled_${s==null?void 0:s.uid}`:"dailyReportsLockEnabled";return(localStorage.getItem(t)??localStorage.getItem("dailyReportsLockEnabled"))==="true"}catch{return!1}}),[Yc,$n]=n.useState(!1);n.useEffect(()=>{try{const t=s!=null&&s.uid?`dailyReportsLockEnabled_${s==null?void 0:s.uid}`:"dailyReportsLockEnabled",a=localStorage.getItem(t)??localStorage.getItem("dailyReportsLockEnabled");cl(a==="true")}catch{}},[s==null?void 0:s.uid]);const[Hc,Ra]=n.useState(!1),[Gc,Ln]=n.useState(!1),[Qc,dl]=n.useState(()=>{try{const t=s==null?void 0:s.uid,a=t?`debtsPinRequired_${t}`:"debtsPinRequired";return(localStorage.getItem(a)??localStorage.getItem("debtsPinRequired"))==="true"}catch{return!1}}),[Zc,ml]=n.useState(!1),[hl,Xc]=n.useState(null),[Rt,fs]=n.useState([]),[Bn,ul]=n.useState(""),[Un,xl]=n.useState(""),[zn,pl]=n.useState(""),[De,Za]=n.useState(null),[ed,ma]=n.useState(!1),[td,Xa]=n.useState(!1),[Ia,gl]=n.useState(null),[fl,qn]=n.useState(""),[Rr,yl]=n.useState(null),[tu,su]=n.useState(!1),[sd,Vn]=n.useState(!1),[vl,Jn]=n.useState(""),[Kn,er]=n.useState(!1),[bl,Yn]=n.useState(1),ad=F?10:20,Hn=Je.useMemo(()=>Rt.slice(0,bl*ad),[Rt,bl]);n.useEffect(()=>{Kn&&Yn(1)},[Kn]);const Gn=async()=>{if(yt){i({title:"غير متاح",description:"إدارة الديون/الأجل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"});return}try{const t=await os.hasMasterPin(s==null?void 0:s.uid);Qc&&t?Ln(!0):Ra(!0)}catch{Ra(!0)}};n.useEffect(()=>{try{const t=s==null?void 0:s.uid,a=t?`debtsPinRequired_${t}`:"debtsPinRequired",r=localStorage.getItem(a)??localStorage.getItem("debtsPinRequired");(r==="true"||r==="false")&&dl(r==="true")}catch{}},[s==null?void 0:s.uid]);const[rd,Qn]=n.useState(!1),[ea,Zn]=n.useState([]),[Xn,wl]=n.useState(""),[ei,Nl]=n.useState(""),[ti,jl]=n.useState(""),[Sl,Dl]=n.useState(""),[nd,tr]=n.useState(!1),[$a,si]=n.useState(null),[ys,sr]=n.useState(null),[$r,ai]=n.useState(""),[id,La]=n.useState(!1),[Cl,Lr]=n.useState(0),[js,ha]=n.useState(null),[Aa,ri]=n.useState(""),[tt,ld]=n.useState(null),Ts=async t=>{try{const a=JSON.stringify(t);localStorage.setItem(Kr(),a);try{localStorage.setItem(Ml(),a)}catch{}try{localStorage.setItem(hi(),Date.now().toString())}catch{}s!=null&&s.uid&&Me.updateUserData(s.uid,{debts:t}).then(()=>{try{localStorage.removeItem(`debts_unsynced_${s.uid}`)}catch{}}).catch(()=>{Be(!0);try{localStorage.setItem(`debts_unsynced_${s.uid}`,"true")}catch{}})}catch(a){console.error("خطأ في حفظ الديون:",a)}},od=async()=>{try{const t=Kr(),a=Ml(),r=hi(),l=localStorage.getItem(t),o=localStorage.getItem(a),m=localStorage.getItem(r),x=m?Number(m):0,f=w=>{if(!w)return null;try{const j=JSON.parse(w);return Array.isArray(j)?j.map(R=>{var L;return{...R,createdAt:(L=R.createdAt)!=null&&L.toDate?R.createdAt.toDate():new Date(R.createdAt),partialPayments:Array.isArray(R.partialPayments)?R.partialPayments.map(V=>{var Pe;return{amount:Number(V.amount)||0,paidAt:(Pe=V.paidAt)!=null&&Pe.toDate?V.paidAt.toDate():new Date(V.paidAt)}}):[]}}):[]}catch(j){return console.warn("فشل في تحليل ديون localStorage:",j),null}};let I=f(l);if(!I||I.length===0){const w=f(o);if(w&&w.length>0&&(I=w,fs(w),s!=null&&s.uid))try{await Ts(w),localStorage.removeItem(a)}catch(j){console.warn("تعذر ترحيل الديون من المفتاح الافتراضي:",j)}}if(I&&I.length>0&&fs(I),s!=null&&s.uid)try{const w=`debts_unsynced_${s.uid}`,j=localStorage.getItem(w)==="true",R=await va(Qe(H,"users",s.uid));if(R.exists()){const L=R.data(),V=L.debts&&Array.isArray(L.debts)?L.debts.map(Ae=>{var We;return{...Ae,createdAt:(We=Ae.createdAt)!=null&&We.toDate?Ae.createdAt.toDate():new Date(Ae.createdAt),partialPayments:Array.isArray(Ae.partialPayments)?Ae.partialPayments.map(Ps=>{var Rs;return{amount:Number(Ps.amount)||0,paidAt:(Rs=Ps.paidAt)!=null&&Rs.toDate?Ps.paidAt.toDate():new Date(Ps.paidAt)}}):[]}}):[],Pe=x&&Date.now()-x<12e4,Ge=j||Pe?I||[]:V&&V.length>0?V:I||[];fs(Ge);try{localStorage.setItem(t,JSON.stringify(Ge))}catch{}((V==null?void 0:V.length)||0)===0&&((Ge==null?void 0:Ge.length)||0)>0&&await Me.updateUserData(s.uid,{debts:Ge})}else I&&I.length>0&&await Me.saveUserData(s.uid,{debts:I})}catch(w){console.warn("تعذر تحميل الديون من Firebase، الاعتماد على المحلي:",w)}}catch(t){console.error("خطأ في تحميل الديون:",t)}};n.useEffect(()=>{try{window.exportDebts=()=>{try{return JSON.stringify(Rt||[])}catch{return"[]"}},window.importDebts=async t=>{try{const a=JSON.parse(t);if(!Array.isArray(a))throw new Error("صيغة غير صحيحة — يجب أن تكون مصفوفة");return await Ts(a),{ok:!0,count:a.length}}catch(a){return console.error("فشل استيراد الديون:",a),{ok:!1,error:String(a)}}},window.fixWalletsForCurrentUser=async t=>{try{if(!(s!=null&&s.uid))throw new Error("يجب تسجيل الدخول أولاً");return await(await Nt(async()=>{const{merchantWalletService:r}=await import("./index-CMr4Oi63.js").then(l=>l.bq);return{merchantWalletService:r}},__vite__mapDeps([0,1]),import.meta.url)).merchantWalletService.reassignByMsisdns(t,s.uid)}catch(a){return console.error("فشل إصلاح المحافظ للمستخدم الحالي:",a),{updated:0,failed:(t==null?void 0:t.length)||0,error:String(a)}}}}catch{}},[Rt,s==null?void 0:s.uid]),n.useEffect(()=>{if(!(s!=null&&s.uid))return;const t=Qe(H,"users",s.uid),a=Os(t,r=>{if(!r.exists())return;const l=r.data(),o=Array.isArray(l==null?void 0:l.debts)?l.debts:[],m=`debts_unsynced_${s.uid}`,x=localStorage.getItem(m)==="true",f=localStorage.getItem(hi()),I=f?Number(f):0,w=I&&Date.now()-I<12e4;if(!(x||w))try{const j=o.map(R=>{var L;return{...R,createdAt:(L=R.createdAt)!=null&&L.toDate?R.createdAt.toDate():new Date(R.createdAt),partialPayments:Array.isArray(R.partialPayments)?R.partialPayments.map(V=>{var Pe;return{amount:Number(V.amount)||0,paidAt:(Pe=V.paidAt)!=null&&Pe.toDate?V.paidAt.toDate():new Date(V.paidAt)}}):[]}});fs(j);try{localStorage.setItem(Kr(),JSON.stringify(j))}catch{}}catch(j){console.warn("تعذر تحليل الديون من التحديثات الحية:",j)}},r=>{console.warn("خطأ في الاشتراك الحي لديون المستخدم:",r)});return()=>a()},[s==null?void 0:s.uid]);const cd=async()=>{if(s!=null&&s.uid){console.log("🔄 إعادة فحص حالة المستخدم...");try{await new Promise(a=>setTimeout(a,500));const t=await va(Qe(H,"users",s.uid));if(t.exists()){const r=t.data().isActive===!0,l=await br.checkTrialValidity(s.uid),o=l.isValid&&!l.isExpired;console.log("📊 حالة المستخدم:",{isActive:r,isOnTrial:o,hoursRemaining:l.hoursRemaining}),kt(r||o),Ne(o),$e(l.hoursRemaining),Ve(l.hasUsedTrial),Ht(!r&&!o),console.log("✅ تم تحديث حالة المستخدم بنجاح:",{userIsActive:r||o,isOnFreeTrial:o})}}catch(t){console.error("خطأ في إعادة فحص حالة المستخدم:",t)}}},dd=async()=>{console.log("🎉 تم بدء التجربة المجانية، إعادة فحص حالة المستخدم..."),await cd()},md=async()=>{if(s!=null&&s.uid)try{_t(!0);const t=await Fi(s.uid);ze(t)}catch(t){console.error("خطأ في جلب بيانات الاشتراك:",t)}finally{_t(!1)}},[au,ru]=n.useState(!1),[hd,ni]=n.useState(!1),[Ct,zt]=n.useState(0),[He,ns]=n.useState({}),[ud,Il]=n.useState(!1),[xd,Al]=n.useState(!1),[pd,ii]=n.useState(!1),[gd,Br]=n.useState(!1),[Tl,li]=n.useState(""),[fd,ar]=n.useState(!1),[yd,Ur]=n.useState(!1),[oi,zr]=n.useState(""),[vd,ci]=n.useState(!1),[qr,Pl]=n.useState(""),[Vr,kl]=n.useState(""),[Jr,Ol]=n.useState(""),[_l,El]=n.useState(!1),[di,mi]=n.useState(!1),[bd,Fl]=n.useState(!1),[Wl,wd]=n.useState([]);n.useEffect(()=>{(async()=>{try{if(!(s!=null&&s.uid)||!di)return;try{await xr.trimToMaxCount(s.uid,30)}catch{}const t=await xr.getByUser(s.uid,30);wd(t)}catch{}})()},[s==null?void 0:s.uid,di]);const Ss=()=>{const t=P||(C==null?void 0:C.shopId)||"main";return`walletBalances_${(s==null?void 0:s.uid)||"default"}_${t}`},Ds=()=>{const t=P||(C==null?void 0:C.shopId)||"main";return`cashBalance_${(s==null?void 0:s.uid)||"default"}_${t}`},Kr=()=>{const t=P||(C==null?void 0:C.shopId)||"main";return`debts_${(s==null?void 0:s.uid)||"default"}_${t}`},Nd=()=>{const t=P||(C==null?void 0:C.shopId)||"main";return`customers_${(s==null?void 0:s.uid)||"default"}_${t}`},Ml=()=>`debts_default_${P||(C==null?void 0:C.shopId)||"main"}`,hi=()=>{const t=P||(C==null?void 0:C.shopId)||"main";return`debts_last_write_${(s==null?void 0:s.uid)||"default"}_${t}`},ui=()=>`shopExpenses_${P||(C==null?void 0:C.shopId)||(s==null?void 0:s.uid)||"default"}`,Rl=()=>{try{const t=localStorage.getItem(ui());if(t){const a=JSON.parse(t);oe(a.map(r=>({...r,createdAt:new Date(r.createdAt)})))}}catch(t){console.error("خطأ أثناء تحميل مصروفات المحل من التخزين:",t)}},$l=async t=>{try{localStorage.setItem(ui(),JSON.stringify(t)),oe(t)}catch(a){console.error("خطأ أثناء حفظ مصروفات المحل في التخزين:",a)}},jd=async t=>{try{const a=ee.filter(r=>r.id!==t);await $l(a);try{if(s!=null&&s.uid&&t){const{doc:r,deleteDoc:l}=await Nt(async()=>{const{doc:x,deleteDoc:f}=await import("./index-CMr4Oi63.js").then(I=>I.bo);return{doc:x,deleteDoc:f}},__vite__mapDeps([0,1]),import.meta.url),{db:o}=await Nt(async()=>{const{db:x}=await import("./index-CMr4Oi63.js").then(f=>f.bp);return{db:x}},__vite__mapDeps([0,1]),import.meta.url),m=r(o,"shop_expenses",t);await l(m)}}catch(r){console.warn("تعذر حذف المصروف من السحابة الآن، تم الحذف محليًا وسيبقى مخزّنًا دون هذا الإيصال:",r)}i({title:"تم الحذف",description:"تم حذف إيصال المصروف نهائيًا."})}catch(a){console.error("خطأ أثناء الحذف النهائي لإيصال المصروف:",a),i({title:"فشل الحذف",description:"تعذر حذف الإيصال. حاول مرة أخرى.",variant:"destructive"})}};Je.useEffect(()=>{let t;return(async()=>{try{if(!(s!=null&&s.uid)){Rl();return}const{collection:a,query:r,where:l,onSnapshot:o}=await Nt(async()=>{const{collection:I,query:w,where:j,onSnapshot:R}=await import("./index-CMr4Oi63.js").then(L=>L.bo);return{collection:I,query:w,where:j,onSnapshot:R}},__vite__mapDeps([0,1]),import.meta.url),{db:m}=await Nt(async()=>{const{db:I}=await import("./index-CMr4Oi63.js").then(w=>w.bp);return{db:I}},__vite__mapDeps([0,1]),import.meta.url),x=P||(C==null?void 0:C.shopId),f=x?r(a(m,"shop_expenses"),l("shopId","==",x)):r(a(m,"shop_expenses"),l("userId","==",s.uid));t=o(f,async I=>{const j=I.docs.map(R=>{var Pe;const L=R.data(),V=(Pe=L.createdAt)!=null&&Pe.toDate?L.createdAt.toDate():L.createdAt?new Date(L.createdAt):new Date;return{id:R.id,name:String(L.name||""),amount:Number(L.amount||0),notes:L.notes?String(L.notes):void 0,source:L.source==="wallet"?"wallet":"cash",walletId:L.walletId?String(L.walletId):void 0,createdAt:V}}).sort((R,L)=>L.createdAt.getTime()-R.createdAt.getTime());oe(j);try{localStorage.setItem(ui(),JSON.stringify(j))}catch{}})}catch(a){console.error("خطأ في مزامنة مصروفات المحل من Firestore:",a)}})(),()=>t==null?void 0:t()},[s==null?void 0:s.uid,C==null?void 0:C.shopId,P]);const Yr=()=>`deficiencies_${P||(C==null?void 0:C.shopId)||(s==null?void 0:s.uid)||"default-shop"}`,Sd=()=>{try{const t=Yr(),a=`deficiencies_${(s==null?void 0:s.uid)||"default"}`;if(a!==t){const l=localStorage.getItem(a),o=localStorage.getItem(t);if(l)try{const m=JSON.parse(l)||[],x=o?JSON.parse(o):[],f=Array.isArray(x)?[...x]:[],I=(w,j)=>w.some(R=>(R==null?void 0:R.id)&&(j==null?void 0:j.id)&&String(R.id)===String(j.id)||String((R==null?void 0:R.name)||"")===String((j==null?void 0:j.name)||"")&&String((R==null?void 0:R.status)||"pending")===String((j==null?void 0:j.status)||"pending"));if(Array.isArray(m))for(const w of m)I(f,w)||f.push(w);localStorage.setItem(t,JSON.stringify(f));try{localStorage.removeItem(a)}catch{}}catch{}}const r=localStorage.getItem(t);if(r){const l=JSON.parse(r);K(l.map(o=>({...o,createdAt:new Date(o.createdAt)})))}}catch(t){console.error("خطأ أثناء تحميل النواقص من التخزين:",t)}},xi=async t=>{try{localStorage.setItem(Yr(),JSON.stringify(t)),K(t)}catch(a){console.error("خطأ أثناء حفظ النواقص في التخزين:",a)}};Je.useEffect(()=>{let t;return(async()=>{try{if(!(s!=null&&s.uid))return;const{collection:a,query:r,where:l,orderBy:o,onSnapshot:m}=await Nt(async()=>{const{collection:w,query:j,where:R,orderBy:L,onSnapshot:V}=await import("./index-CMr4Oi63.js").then(Pe=>Pe.bo);return{collection:w,query:j,where:R,orderBy:L,onSnapshot:V}},__vite__mapDeps([0,1]),import.meta.url),{db:x}=await Nt(async()=>{const{db:w}=await import("./index-CMr4Oi63.js").then(j=>j.bp);return{db:w}},__vite__mapDeps([0,1]),import.meta.url),f=P||(C==null?void 0:C.shopId)||s.uid||"default-shop",I=r(a(x,"deficiencies"),l("shopId","==",f),o("createdAt","desc"));t=m(I,async w=>{const j=w.docs.map(R=>{var Pe;const L=R.data(),V=(Pe=L.createdAt)!=null&&Pe.toDate?L.createdAt.toDate():L.createdAt?new Date(L.createdAt):new Date;return{id:R.id,name:String(L.name||""),quantity:Number(L.quantity||1),status:L.status==="purchased"?"purchased":"pending",createdAt:V}});K(j);try{localStorage.setItem(Yr(),JSON.stringify(j))}catch{}},w=>{console.warn("فشل الاشتراك في النواقص من Firestore:",w)})}catch(a){console.warn("فشل إعداد مزامنة النواقص من Firestore:",a)}})(),()=>{try{t&&t()}catch{}}},[s==null?void 0:s.uid,C==null?void 0:C.shopId,P]);const Dd=async t=>{try{localStorage.setItem(Nd(),JSON.stringify(t)),Zn(t),s!=null&&s.uid&&await Me.updateUserData(s.uid,{customers:t})}catch(a){console.error("خطأ أثناء حفظ العملاء في التخزين:",a)}},Cd=async()=>{try{if(s!=null&&s.uid){const t=await va(Qe(H,"users",s.uid));if(t.exists()){const a=t.data();if(a.customers&&Array.isArray(a.customers)){const r=a.customers.map(l=>{var o;return{...l,createdAt:(o=l.createdAt)!=null&&o.toDate?l.createdAt.toDate():new Date(l.createdAt)}});Zn(r);return}}}Zn([])}catch(t){console.error("خطأ أثناء تحميل العملاء من Firestore:",t)}},pi=()=>{const t=P||(C==null?void 0:C.shopId)||"main";return`transactions_${(s==null?void 0:s.uid)||"default"}_${t}`},gi=()=>{const t=P||(C==null?void 0:C.shopId)||"main";return`wallets_${(s==null?void 0:s.uid)||"default"}_${t}`},fi=()=>{const t=P||(C==null?void 0:C.shopId)||"main";return`selectedWallet_${(s==null?void 0:s.uid)||"default"}_${t}`};n.useEffect(()=>{let t;return(async()=>{try{if(!(s!=null&&s.uid))return;const{collection:a,query:r,where:l,orderBy:o,limit:m,onSnapshot:x}=await Nt(async()=>{const{collection:w,query:j,where:R,orderBy:L,limit:V,onSnapshot:Pe}=await import("./index-CMr4Oi63.js").then(It=>It.bo);return{collection:w,query:j,where:R,orderBy:L,limit:V,onSnapshot:Pe}},__vite__mapDeps([0,1]),import.meta.url),{db:f}=await Nt(async()=>{const{db:w}=await import("./index-CMr4Oi63.js").then(j=>j.bp);return{db:w}},__vite__mapDeps([0,1]),import.meta.url),I=r(a(f,"userTransactions"),l("userId","==",s.uid),o("createdAt","desc"),m(100));t=x(I,w=>{Qi||Pc(!0);const R=w.docs.map(Ae=>{var cs;const We=Ae.data(),Ps=(cs=We.createdAt)!=null&&cs.toDate?We.createdAt.toDate():new Date(We.createdAt),Rs=We.txnType==="send"?"send":We.txnType==="receive"?"withdraw":We.type||"withdraw",$s=We.status==="confirmed"?"completed":We.status||"completed",cn=We.senderMsisdn||We.senderPhone||"",Ee=We.receiverMsisdn||We.receiverPhone||"",Et=Number(We.amount??We.transferredAmount??We.withdrawnAmount??0);return{id:Ae.id,...We,type:Rs,status:$s,senderPhone:cn,receiverPhone:Ee,amount:Et,createdAt:Ps}}).filter(Ae=>!((Ae==null?void 0:Ae.type)==="report"||String((Ae==null?void 0:Ae.title)||"").includes("إيصال تسليم وردية"))),L=new Set((Pr||[]).map(Ae=>String(Ae.id||Ae.originalTransactionId||""))),V=R.filter(Ae=>!L.has(String(Ae.id||""))),Pe=Ae=>{var We;return String(Ae.transactionId||Ae.id||Ae.reference||((We=Ae.receipt)==null?void 0:We.reference)||`${new Date(Ae.createdAt).getTime()}`)},It=new Set,Ge=[];for(const Ae of V){const We=Pe(Ae);It.has(We)||(It.add(We),Ge.push(Ae))}Qs(Ge)})}catch{}})(),()=>{try{t&&t()}catch{}}},[s==null?void 0:s.uid,Pr.length]);const[yi,Hr]=n.useState(""),[vs,Ll]=n.useState(""),qs=Je.useMemo(()=>{const t=gt;if(!t)return!1;const a=um(t),r=t.planType??t.plan??null,l=typeof r=="string"?r.toLowerCase():null,o=l==="monthly"||l==="quarterly"||l==="yearly"||l==="lifetime"||r===ms.MONTHLY||r===ms.QUARTERLY||r===ms.YEARLY||r===ms.LIFETIME;return a&&o},[gt]),yt=Je.useMemo(()=>{var l,o;const t=gt;if(!t)return!1;const a=((l=t.subscription)==null?void 0:l.planType)??((o=t.subscription)==null?void 0:o.plan)??t.planType??t.plan??null,r=typeof a=="string"?a.toLowerCase():null;return a===ms.ZERO||r==="zero"},[gt]),Mt=Je.useMemo(()=>{var l,o;const t=gt;if(!t)return!1;const a=((l=t.subscription)==null?void 0:l.planType)??((o=t.subscription)==null?void 0:o.plan)??t.planType??t.plan??null,r=typeof a=="string"?String(a).trim().toLowerCase():null;return a===ms.TAHWEELA||r==="tahweela"||r==="تحويله"},[gt]),Id=()=>{if(!qs){i({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}Z(!0)},[nu,iu]=n.useState(!1),[Ad,Td]=n.useState(!1),[Pd,kd]=n.useState(!1),[Od,_d]=n.useState(!1),[Ed,rr]=n.useState(!1),[Ta,Gr]=n.useState(""),[nr,Qr]=n.useState(""),[Bl,Zr]=n.useState(!1),[ir,lr]=n.useState(null),[vi,Xr]=n.useState(""),[Fd,Ul]=n.useState(!1),[lu,ou]=n.useState(!1),[Wd,en]=n.useState(!1),[zl,bi]=n.useState(""),[ql,wi]=n.useState(""),[Vl,Jl]=n.useState(!1),Kl=async()=>{if(s!=null&&s.uid)try{const t=`userData_${s.uid}`,a=localStorage.getItem(t),r=`debts_unsynced_${s.uid}`,l=localStorage.getItem(Kr()),o=localStorage.getItem(r)==="true";if(a){const m=JSON.parse(a);console.log("🔄 مزامنة البيانات المحلية مع Firebase...",m);const x={lastSynced:new Date().toISOString()};typeof m.cashBalance=="number"&&(x.cashBalance=m.cashBalance),m.walletBalances&&typeof m.walletBalances=="object"&&(x.walletBalances=m.walletBalances),await Me.updateUserData(s.uid,x),localStorage.removeItem(t),Be(!1),console.log("✅ تمت المزامنة بنجاح وحذف البيانات المحلية")}else console.log("لا توجد بيانات محلية تحتاج للمزامنة");if(o&&l)try{const m=JSON.parse(l)||[];await Me.updateUserData(s.uid,{debts:m});try{localStorage.removeItem(r)}catch{}Be(!1),console.log("✅ تمت مزامنة الديون مع Firebase")}catch(m){console.error("❌ فشل مزامنة الديون:",m),Be(!0)}}catch(t){console.error("❌ فشل في مزامنة البيانات:",t),i({title:"فشل في المزامنة",description:"حدث خطأ أثناء مزامنة البيانات مع الخادم",variant:"destructive"})}},[Ba,tn]=n.useState({keepLastCount:30,intervalDays:7,lastResetAt:null});n.useEffect(()=>{(async()=>{if(s!=null&&s.uid)try{const a=await Me.getUserData(s.uid),r=(a==null?void 0:a.recentReset)||{},l=Number(r==null?void 0:r.keepLastCount)>0?Number(r.keepLastCount):30,o=Number(r==null?void 0:r.intervalDays)>0?Number(r.intervalDays):7,m=w=>w instanceof Date?w:typeof(w==null?void 0:w.toDate)=="function"?w.toDate():w?new Date(String(w)):null,x=r!=null&&r.lastResetAt?m(r.lastResetAt):null,f=new Date;!x||f.getTime()-x.getTime()>=o*24*60*60*1e3?(await Me.updateUserData(s.uid,{recentReset:{keepLastCount:l,intervalDays:o,lastResetAt:f}}),tn({keepLastCount:l,intervalDays:o,lastResetAt:f})):tn({keepLastCount:l,intervalDays:o,lastResetAt:x})}catch{tn({keepLastCount:30,intervalDays:7,lastResetAt:null})}})()},[s==null?void 0:s.uid]);const Yl=Je.useMemo(()=>{const t=ft||[],a=Ba.keepLastCount??30;return[...t].sort((l,o)=>{const m=x=>x instanceof Date?x:typeof(x==null?void 0:x.toDate)=="function"?x.toDate():new Date(String(x));return m(o.createdAt).getTime()-m(l.createdAt).getTime()}).slice(0,a)},[ft,Ba.keepLastCount]),Md=Je.useMemo(()=>Math.max(0,((ft==null?void 0:ft.length)||0)-(Ba.keepLastCount||30)),[ft==null?void 0:ft.length,Ba.keepLastCount]),Hl=Je.useCallback(()=>{let t=Yl;const a=el.trim();if(a&&(t=t.filter(r=>r.senderPhone&&r.senderPhone.includes(a)||r.receiverPhone&&r.receiverPhone.includes(a))),kr){const r=new Date(kr);t=t.filter(l=>{const o=new Date(l.createdAt);if(Or){const[m,x]=Or.split(":"),f=new Date(r);f.setHours(parseInt(m),parseInt(x),0,0);const I=new Date(f);return I.setHours(I.getHours()+1),o>=f&&o<I}else return o.toDateString()===r.toDateString()})}try{t=[...t].sort((r,l)=>{const o=new Date(r.createdAt||0).getTime();return new Date(l.createdAt||0).getTime()-o})}catch{}return t},[Yl,el,kr,Or]),[Rd,sn]=n.useState(!1),[Gl,an]=n.useState(""),[$d,rn]=n.useState(!1),[Ni,ji]=n.useState(""),[Ld,Be]=n.useState(!1);Ye.reduce((t,a)=>t+(He[a.id]||0),0);const Bd=async t=>await os.verifyMasterPin(t,s==null?void 0:s.uid),nn=async t=>await os.verifyMasterPin(t,s==null?void 0:s.uid);n.useEffect(()=>{if(!(s!=null&&s.uid))return;console.log("🚀 استعادة البيانات من localStorage عند تحميل الصفحة للمستخدم:",s.uid);const t=`walletBalances_${s.uid}`,a=localStorage.getItem(t);if(a)try{const o=JSON.parse(a);console.log("📱 استعادة أرصدة المحافظ من localStorage:",o),ns(o)}catch(o){console.error("خطأ في قراءة أرصدة المحافظ من localStorage:",o)}const r=`cashBalance_${s.uid}`;let l=localStorage.getItem(r);if(!l){const o=`userCashBalance_${s.uid}`,m=localStorage.getItem(o);if(m){l=m;try{localStorage.setItem(r,m),localStorage.removeItem(o)}catch{}}}if(l){const o=parseFloat(l);console.log("💰 استعادة رصيد الدرج النقدي من localStorage:",o),zt(o)}},[s==null?void 0:s.uid]),n.useEffect(()=>{const t=a=>{var r;try{const l=Number((r=a==null?void 0:a.detail)==null?void 0:r.value);if(Number.isFinite(l))zt(l);else{const o=localStorage.getItem(Ds());o!=null&&zt(parseFloat(o)||0)}}catch{const l=localStorage.getItem(Ds());l!=null&&zt(parseFloat(l)||0)}};return window.addEventListener("cashBalanceChanged",t),()=>window.removeEventListener("cashBalanceChanged",t)},[s==null?void 0:s.uid,P,C==null?void 0:C.shopId]);const Ql=async()=>{try{if(!ae)return;const t=await Ks.autoResetLimitsIfNeeded(ae);ld(t)}catch(t){console.error("خطأ في جلب حدود المحفظة المختارة:",t)}};n.useEffect(()=>{Ql()},[ae]),n.useEffect(()=>{const t=a=>{var r;(r=a==null?void 0:a.detail)!=null&&r.walletId&&a.detail.walletId===ae&&Ql()};return window.addEventListener("walletLimitsUpdated",t),()=>window.removeEventListener("walletLimitsUpdated",t)},[ae]),n.useEffect(()=>{if(S.state){if(console.log("Location state:",S.state),S.state.openDebtDialog&&(Gn(),window.history.replaceState({},document.title)),S.state.openSalesDialog&&(yt||Mt?i({title:"غير متاح",description:"بيانات المبيعات غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ja(!0),window.history.replaceState({},document.title)),S.state.openMaintenanceDialog&&(yt||Mt?i({title:"غير متاح",description:"الصيانة غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Fr(!0),window.history.replaceState({},document.title)),S.state.openCreditCardsDialog&&(console.log("Opening credit cards dialog"),yt||Mt?i({title:"غير متاح",description:"كروت الائتمان غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Er(!0),window.history.replaceState({},document.title)),S.state.openShopExpensesDialog&&(yt||Mt?i({title:"غير متاح",description:"مصروفات المحل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):os.hasMasterPin()?Bt(!0):St(!0),window.history.replaceState({},document.title)),S.state.openDeficienciesDialog&&(yt||Mt?i({title:"غير متاح",description:"النواقص غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):oa(!0),window.history.replaceState({},document.title)),S.state.openInstallment&&(yt||Mt?i({title:"غير متاح",description:"إدارة التقسيط غير متاحة في هذه الخطة.",variant:"destructive"}):_r(!0),window.history.replaceState({},document.title)),S.state.openTransactionSection){const t=document.getElementById("transaction-section");t&&t.scrollIntoView({behavior:"smooth"}),S.state.transactionType&&Vi(S.state.transactionType),S.state.startNewTransaction&&(Na(""),ca(""),Tn(""),Pn(""),console.log("🔒 Starting new transaction without changing wallet selection")),S.state.focusWalletSelection&&setTimeout(()=>{const a=document.querySelector('[data-testid="wallet-select"]');a&&a.focus()},500),window.history.replaceState({},document.title)}S.state.openCashierShiftModal&&(!qs||Mt?i({title:"غير متاح",description:"وردية الكاشير متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"}):Z(!0),window.history.replaceState({},document.title)),S.state.openMachineDailyDialog&&(!qs||Mt?i({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"}):Wr(!0),window.history.replaceState({},document.title))}},[S.state,Ye,Mt]),n.useEffect(()=>{S.pathname==="/user/dashboard"&&sessionStorage.getItem("previousPath")==="/user/add-wallet"&&(console.log("🔄 Returned from wallet addition page - reloading wallets"),or(),sessionStorage.removeItem("previousPath")),sessionStorage.setItem("previousPath",S.pathname)},[S.pathname,s==null?void 0:s.uid]),n.useEffect(()=>{if(!(s!=null&&s.uid))return;console.log("🔥 Setting up real-time user activation listener for:",s.uid);const t=Qe(H,"users",s.uid),a=Os(t,r=>{if(r.exists()){const l=r.data(),o=l.isActive===!0;console.log("🔥 Real-time user status update:",{userId:s.uid,isActive:o,subscription:l.subscription}),o&&!Pt?(console.log("🎉 User activated! Redirecting to dashboard..."),kt(!0),Ht(!1),Ze(!1)):!o&&Pt&&(console.log("❌ User deactivated! Showing activation modal..."),kt(!1),Ht(!0))}},r=>{console.error("❌ Error in real-time user listener:",r)});return()=>{console.log("🔥 Cleaning up real-time user listener"),a()}},[s==null?void 0:s.uid,Pt]),n.useEffect(()=>{if(!(s!=null&&s.uid))return;const t=r=>{const{userId:l}=r.detail;l===s.uid&&(console.log("🎉 Subscription activation event received for current user!"),kt(!0),Ht(!1),Ze(!1),setTimeout(()=>{console.log("✅ User activation completed - data updated")},1e3))},a=r=>{const{userId:l,isActive:o}=r.detail;l===s.uid&&(console.log("🔄 User subscription update event received:",{userId:l,isActive:o}),o&&!Pt&&(kt(!0),Ht(!1),Ze(!1),setTimeout(()=>{console.log("✅ User subscription updated - data refreshed")},1e3)))};return window.addEventListener("subscriptionActivated",t),window.addEventListener("userSubscriptionUpdated",a),()=>{window.removeEventListener("subscriptionActivated",t),window.removeEventListener("userSubscriptionUpdated",a)}},[s==null?void 0:s.uid,Pt]),n.useEffect(()=>{const t=a=>{var m;const r=a.target,l=(m=r==null?void 0:r.tagName)==null?void 0:m.toLowerCase();if(!(l==="input"||l==="textarea"||l==="select"||((r==null?void 0:r.isContentEditable)??!1))&&!(a.ctrlKey||a.altKey||a.metaKey)&&!a.repeat){if((yt||Mt)&&a.key>="1"&&a.key<="9"){a.preventDefault();return}switch(a.key){case"1":break;case"2":Rn(!0);break;case"3":yt||Mt?i({title:"غير متاح",description:"كروت الائتمان غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Er(!0);break;case"4":qs?Z(!0):i({title:"غير متاح",description:"وردية الكاشير متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});break;case"5":yt||Mt?i({title:"غير متاح",description:"بيانات المبيعات غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Ja(!0);break;case"6":Gn();break;case"7":yt||Mt?i({title:"غير متاح",description:"الصيانة غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):Fr(!0);break;case"8":qs?Wr(!0):i({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});break;case"9":yt||Mt?i({title:"غير متاح",description:"مصروفات المحل غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}):os.hasMasterPin()?Bt(!0):St(!0);break}}};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[yt,Mt,qs]),n.useEffect(()=>{console.log("🔥 useEffect loadUserData started",{user:s==null?void 0:s.uid,isCheckingActivation:wt}),(async()=>{try{if(!(s!=null&&s.uid)){console.log("🔥 No user UID, setting isCheckingActivation to false"),Ze(!1);return}try{const m=await va(Qe(H,"users",s.uid));if(m.exists()){const f=m.data().isActive===!0,I=await br.checkTrialValidity(s.uid),w=I.isValid&&!I.isExpired;kt(f||w),Ne(w),$e(I.hoursRemaining),Ve(I.hasUsedTrial),Ht(!f&&!w),console.log("📊 حالة المستخدم:",{isActive:f,isOnTrial:w,hoursRemaining:I.hoursRemaining,hasUsedTrial:I.hasUsedTrial})}else kt(!1),Ht(!0)}catch(m){console.error("خطأ في فحص حالة تفعيل المستخدم:",m),kt(!1),Ht(!0)}finally{Ze(!1)}if(console.log("🔄 بدء تحميل بيانات المستخدم من Firebase...",{userId:s==null?void 0:s.uid}),s!=null&&s.uid){const m=await Me.getUserData(s.uid);if(console.log("📥 البيانات المحملة من Firebase:",m),m){const x=(m==null?void 0:m.walletBalances)||{};console.log("🏛️ اعتماد Firebase كمصدر الحقيقة لأرصدة المحافظ"),ns(x),(m==null?void 0:m.cashBalance)!==void 0&&(console.log("💰 تحميل رصيد الدرج النقدي من Firebase:",m.cashBalance),zt(m.cashBalance));try{const f=s!=null&&s.uid?await gr.getDeletedTransactionsByUser(s.uid):[];Ha(f||[]),console.log("🗑️ تم تحميل المعاملات المحذوفة من Firebase:",(f==null?void 0:f.length)||0)}catch(f){console.error("خطأ في تحميل المعاملات المحذوفة من Firebase:",f),Ha([])}}else{console.log("⚠️ لا توجد بيانات مستخدم في Firebase، سيتم استخدام قيم افتراضية بدون localStorage"),ns({});try{const x=s!=null&&s.uid?await gr.getDeletedTransactionsByUser(s.uid):[];Ha(x||[])}catch{Ha([])}}}console.log("🔄 بدء تحميل المحافظ من Firebase...");try{const m=await Us.getByMerchantId((s==null?void 0:s.uid)||"");if(m&&m.length>0){console.log("✅ تم العثور على محافظ في Firebase:",m.length);const f=m.filter(j=>j.isActive===!0).map(j=>({id:j.id,name:j.label||"محفظة بدون اسم",phone:j.msisdn,isDefault:!1,monthlyWithdrawalLimit:j.monthlyWithdrawalLimit??j.withdrawLimit??2e5,monthlyTransferLimit:j.monthlyTransferLimit??j.transferLimit??2e5,defaultTransferCommission:j.defaultTransferCommission!=null?Number(j.defaultTransferCommission):null,defaultWithdrawCommission:j.defaultWithdrawCommission!=null?Number(j.defaultWithdrawCommission):null}));Ka(f);const I=localStorage.getItem(fi());let w=null;I&&f.find(j=>j.id===I)?w=f.find(j=>j.id===I):w=f[0],w&&(En(w.id),Ws(w.phone)),console.log("🔄 تم تحديث المحافظ من Firebase وحفظها في localStorage")}else console.log("⚠️ لا توجد محافظ في Firebase. سيتم عرض قائمة فارغة بدون أي استرجاع محلي."),Ka([])}catch(m){console.error("خطأ في تحميل المحافظ من Firebase:",m),Ka([])}const o=s!=null&&s.uid?await Me.getUserTransactions(s.uid):[];if(o&&o.length>0){console.log("📊 تم تحميل المعاملات من Firebase:",o.length);const m=o.map(j=>({...j,createdAt:new Date(j.createdAt),senderPhone:j.senderMsisdn||j.senderPhone||"",receiverPhone:j.receiverMsisdn||j.receiverPhone||"",type:j.txnType==="send"?"send":j.txnType==="receive"?"withdraw":j.type||"withdraw",status:j.status==="confirmed"?"completed":j.status||"completed"})),x=Pr.map(j=>j.id||j.originalTransactionId);let f=[];try{const j=st(Te(H,"deletedTransactions"),ke("userId","==",(s==null?void 0:s.uid)||""),ke("permanent","==",!0));f=(await ct(j)).docs.map(L=>{const V=L.data();return String(V.originalTransactionId||V.transactionId||L.id||"")}).filter(Boolean)}catch{}const I=new Set(f),w=m.filter(j=>{var Ge;const R=String(j.id||""),L=String(j.transactionId||""),V=String(j.reference||j.transactionReference||((Ge=j.receipt)==null?void 0:Ge.reference)||""),Pe=x.includes(R),It=I.has(R)||L&&I.has(L);return!Pe&&!It});console.log("✅ تم فلترة المعاملات المحذوفة:",{total:o.length,deleted:x.length,active:w.length});{const j=V=>{var Pe;return String((V==null?void 0:V.transactionId)||(V==null?void 0:V.id)||`${(V==null?void 0:V.transactionReference)||((Pe=V==null?void 0:V.receipt)==null?void 0:Pe.reference)||"ref"}-${new Date((V==null?void 0:V.createdAt)||0).getTime()}`)},R=new Set,L=[];for(const V of w){const Pe=j(V);R.has(Pe)||(R.add(Pe),L.push(V))}Qi||Qs(L)}}await Kl()}catch(o){console.error("خطأ في تحميل بيانات المستخدم من Firebase:",o)}})().then(async()=>{await l(),await a(),await r()});const a=async()=>{try{if(!(s!=null&&s.uid))return;const o=await Us.getByMerchantId(s.uid);await Promise.all(o.map(m=>mh.autoResetLimitsIfNeeded(m.id)))}catch(o){console.error("خطأ في التصفير التلقائي للحدود:",o)}},r=async()=>{try{await ds.syncReportsDataFromFirebase(s==null?void 0:s.uid);const o=ds.getReportsData(s==null?void 0:s.uid);if((o.lastDailyResetDate?ds.shouldResetDailyReports(o.lastDailyResetDate):!1)&&(s!=null&&s.uid)&&o.lastDailyResetDate){const f=new Date(o.lastDailyResetDate),I=f.toDateString(),w=ft.filter(Ge=>new Date(Ge.createdAt).toDateString()===I&&Ge.status==="completed"),j=w.length,R=w.reduce((Ge,Ae)=>Ge+Ae.amount,0),L=w.filter(dr).reduce((Ge,Ae)=>{const We=Ae.withdrawnAmount!==void 0?Ae.withdrawnAmount:Ae.amount;return Ge+We},0),V=w.filter(mr).reduce((Ge,Ae)=>{const We=Ae.sentAmount!==void 0?Ae.sentAmount:Ae.amount;return Ge+We},0),Pe=w.reduce((Ge,Ae)=>Ge+ds.calculateTransactionProfit(Ae),0),It=new Date(f).toISOString().slice(0,10);await xr.add({userId:s.uid,reportDate:It,totalTransactions:j,totalAmount:Number(R.toFixed(2)),totalWithdrawn:Number(L.toFixed(2)),totalSent:Number(V.toFixed(2)),profit:Number(Pe.toFixed(2)),walletId:null})}const x=ds.autoResetReportsIfNeeded(s==null?void 0:s.uid);(x.dailyReset||x.monthlyReset)&&console.log("تم التصفير التلقائي:",x)}catch(o){console.error("خطأ في التصفير التلقائي للتقارير:",o)}},l=async()=>{try{if(!(s!=null&&s.uid))return;const o=new Date;if(o.getDate()!==1)return;const m=`${o.getFullYear()}-${o.getMonth()+1}`,x=`lastMonthlyDbCleanup:${s.uid}`;if(localStorage.getItem(x)===m)return;const I=new Date(o.getFullYear(),o.getMonth(),1,0,0,0,0),w=L=>L instanceof Date?L:typeof(L==null?void 0:L.toDate)=="function"?L.toDate():new Date(String(L));let j=[];try{const L=st(Te(H,"userTransactions"),ke("userId","==",s.uid),ke("createdAt","<",I));j=(await ct(L)).docs}catch{const L=st(Te(H,"userTransactions"),ke("userId","==",s.uid));j=(await ct(L)).docs.filter(Pe=>{var It;return w((It=Pe.data())==null?void 0:It.createdAt)<I})}await Promise.allSettled(j.map(L=>hs(L.ref)));let R=[];try{const L=st(Te(H,"transactions"),ke("userId","==",s.uid),ke("createdAt","<",I));R=(await ct(L)).docs}catch{const L=st(Te(H,"transactions"),ke("userId","==",s.uid));R=(await ct(L)).docs.filter(Pe=>{var It;return w((It=Pe.data())==null?void 0:It.createdAt)<I})}await Promise.allSettled(R.map(L=>hs(L.ref)));try{localStorage.setItem(x,m)}catch{}console.log("✅ تم تنظيف قاعدة البيانات شهريًا (Firebase فقط):",{userTransactionsDeleted:j.length,globalTransactionsDeleted:R.length,monthStart:I})}catch(o){console.error("فشل التنظيف الشهري التلقائي لقاعدة البيانات:",o)}};md(),od(),Cd(),console.log("🔥 useEffect loadUserData completed")},[s==null?void 0:s.uid]);const or=async()=>{var t;if(s!=null&&s.uid)try{const a=await Us.getByMerchantId(s.uid);if(a&&a.length>0){const l=a.filter(o=>o.isActive===!0).map(o=>({id:o.id,name:o.label||"محفظة بدون اسم",phone:o.msisdn,isDefault:!1,monthlyWithdrawalLimit:o.monthlyWithdrawalLimit??o.withdrawLimit??2e5,monthlyTransferLimit:o.monthlyTransferLimit??o.transferLimit??2e5,defaultTransferCommission:o.defaultTransferCommission!=null?Number(o.defaultTransferCommission):void 0,defaultWithdrawCommission:o.defaultWithdrawCommission!=null?Number(o.defaultWithdrawCommission):void 0}));if(Ka(l),s!=null&&s.uid){const o=localStorage.getItem(fi());if(!!(ae&&l.find(x=>x.id===ae)))console.log("🔒 Preserving current wallet selection:",ae);else{const f=(o&&l.find(I=>I.id===o)?o:null)||((t=l[0])==null?void 0:t.id);f&&(console.log("🔄 Fixing invalid wallet selection:",f),cr(f))}}console.log("🔄 تم تحديث المحافظ من Firebase:",l.length)}}catch(a){console.error("خطأ في تحميل المحافظ من Firebase:",a)}};n.useEffect(()=>{const t=S.pathname;sessionStorage.getItem("previousPath")==="/user/add-wallet"&&t==="/user/dashboard"&&(console.log("🔄 Returning from add wallet page - reloading wallets"),console.log("🔒 Current wallet before add-wallet return reload:",ae),or(),sessionStorage.removeItem("previousPath")),sessionStorage.setItem("previousPath",t)},[S.pathname,s==null?void 0:s.uid]),n.useEffect(()=>{const t=()=>{console.log("🔄 Window focused - reloading wallets"),console.log("🔒 Current wallet before focus reload:",ae),or().then(()=>{console.log("🔒 Wallet preserved after focus reload:",ae)})};return window.addEventListener("focus",t),()=>{window.removeEventListener("focus",t)}},[s==null?void 0:s.uid,ae,Ye]);const cr=(t,a="unknown")=>{console.log(`🎯 setWalletSelection called from ${a} with walletId:`,t),console.log("🔍 Previous selectedWallet:",ae),En(t);const r=Ye.find(l=>l.id===t);r&&(Ws(r.phone),console.log("✅ Wallet set successfully:",t,"Phone:",r.phone)),s!=null&&s.uid&&(localStorage.setItem(fi(),t),console.log("💾 Saved wallet to localStorage:",t))};n.useEffect(()=>{const t=()=>{or()};try{window.addEventListener("wallets:activation-updated",t)}catch{}return()=>{try{window.removeEventListener("wallets:activation-updated",t)}catch{}}},[s==null?void 0:s.uid]);const Ud=t=>{if(t==="__add_wallet"){T("/user/add-wallet");return}if(t==="__view_wallets"){Dr(!0);return}Hm.isEnabled(s==null?void 0:s.uid)?(An(t),In(!0)):cr(t,"walletSelectionNoPin")},ln=t=>{console.log("🔄 handleTransactionTypeChange called with type:",t),console.log("🔍 Current selectedWallet before change:",ae),console.log("🔍 Available wallets count:",Ye.length),Vi(t),Na(""),ca(""),Tn(""),Pn(""),console.log("✅ Transaction type changed to:",t,"- Wallet selection preserved:",ae),setTimeout(()=>{const a=document.getElementById("transaction-section");a&&a.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})},100)};n.useEffect(()=>{const t=a=>{const r=a.target;if(!!r&&(r.tagName==="INPUT"||r.tagName==="TEXTAREA"||r.tagName==="SELECT"||r.isContentEditable)||(a.key==="ArrowLeft"?(a.preventDefault(),ln("withdraw")):a.key==="ArrowRight"&&(a.preventDefault(),ln("transfer"))),a.key==="Enter"){const o=le==="transfer"?"transferSubmitButton":"withdrawSubmitButton",m=document.getElementById(o);m&&!m.disabled&&(a.preventDefault(),m.click())}};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[le]);const Zl=t=>{Ic((r=>({id:r.id,type:r.type==="send"?"transfer":"withdraw",sender_msisdn:r.senderPhone,receiver_msisdn:r.receiverPhone,amount:r.amount,commission:r.commission||0,fee:(r==null?void 0:r.fee)??0,status:r.status==="failed"?"failed":r.status==="completed"?"completed":"pending",createdAt:new Date(r.createdAt).toISOString(),updatedAt:new Date(r.createdAt).toISOString(),shopName:J??(C==null?void 0:C.shopName)??(s==null?void 0:s.displayName)??"المحل",cashierName:(r==null?void 0:r.cashierName)??null,commissionMode:(r==null?void 0:r.commissionMode)??(r.type==="send"||ut?"add":"deduct"),totalCharged:(r==null?void 0:r.totalCharged)??(r.type==="send"?Number(r.amount||0)+Number(r.commission||0)+Number((r==null?void 0:r.fee)||0):ut?Number(r.amount||0)+Number(r.commission||0):Number(r.amount||0)),note:(r==null?void 0:r.note)??(r==null?void 0:r.notes)??void 0}))(t)),Tr(!0)},zd=async t=>{var o;if(!(s!=null&&s.uid)){i({title:"خطأ في المصادقة",description:"يجب تسجيل الدخول أولاً لحذف المعاملات",variant:"destructive"});return}const a=ft.find(m=>m.id===t);if(!a){i({title:"خطأ في الحذف",description:"لم يتم العثور على المعاملة المطلوب حذفها",variant:"destructive"});return}const r=String(t),l=String((a==null?void 0:a.transactionId)||(a==null?void 0:a.reference)||"");da.current.add(r),l&&da.current.add(l);try{console.log("🗑️ بدء عملية حذف المعاملة:",t),console.log("🔄 حذف المعاملة نهائياً من Firebase...",{transactionId:a.id,userId:s.uid,transactionData:a}),await Me.removeUserTransaction(s.uid,a.id),console.log("✅ تم حذف المعاملة نهائياً من Firebase userTransactions");try{await gr.saveDeletedTransaction({...a,userId:s.uid,originalTransactionId:a.id,transactionId:a.transactionId||a.id,reference:a.reference||a.transactionReference||((o=a.receipt)==null?void 0:o.reference),deletedAt:new Date().toISOString(),permanent:!0}),console.log("✅ تم حفظ المعاملة في سجل المحذوفات مع تاريخ الحذف")}catch(f){console.warn("⚠️ فشل في حفظ المعاملة في سجل المحذوفات، لكن الحذف من Firebase نجح:",f)}try{await gr.permanentlyDeleteTransaction(a.id,s.uid)}catch(f){console.warn("⚠️ فشل وسم الحذف النهائي أو التنظيف الإضافي:",f)}const m=[...Pr,a],x=ft.filter(f=>f.id!==t);Ha(m),Qs(x),Hi(!1),console.log("✅ تم تحديث الحالة بعد الحذف من Firebase (بدون نسخ محلية)");try{const f=a.fromWallet;if(f){const{walletDailyLimitsService:I}=await Nt(async()=>{const{walletDailyLimitsService:j}=await import("./walletDailyLimitsService-0xjNslf8.js");return{walletDailyLimitsService:j}},__vite__mapDeps([3,0,1]),import.meta.url),w=await I.getWalletLimits(f);if(w){const j=a.type==="send",R={updatedAt:(await Nt(async()=>{const{serverTimestamp:Ge}=await import("./index-CMr4Oi63.js").then(Ae=>Ae.bo);return{serverTimestamp:Ge}},__vite__mapDeps([0,1]),import.meta.url)).serverTimestamp()};j?(R.dailyTransferUsed=Math.max(0,(w.dailyTransferUsed||0)-a.amount),R.monthlyTransferUsed=Math.max(0,(w.monthlyTransferUsed||0)-a.amount)):(R.dailyWithdrawUsed=Math.max(0,(w.dailyWithdrawUsed||0)-a.amount),R.monthlyWithdrawUsed=Math.max(0,(w.monthlyWithdrawUsed||0)-a.amount));const{doc:L,setDoc:V}=await Nt(async()=>{const{doc:Ge,setDoc:Ae}=await import("./index-CMr4Oi63.js").then(We=>We.bo);return{doc:Ge,setDoc:Ae}},__vite__mapDeps([0,1]),import.meta.url),{db:Pe}=await Nt(async()=>{const{db:Ge}=await import("./index-CMr4Oi63.js").then(Ae=>Ae.bp);return{db:Ge}},__vite__mapDeps([0,1]),import.meta.url),It=L(Pe,"walletLimits",f);await V(It,R,{merge:!0})}}}catch(f){console.warn("فشل استرجاع حدود المحفظة بعد الحذف:",f)}try{const{ProfitService:f}=await Nt(async()=>{const{ProfitService:L}=await import("./profitService-DZQLszRg.js").then(V=>V.p);return{ProfitService:L}},__vite__mapDeps([4,0,1]),import.meta.url),{ReportsService:I}=await Nt(async()=>{const{ReportsService:L}=await import("./profitService-DZQLszRg.js").then(V=>V.a);return{ReportsService:L}},__vite__mapDeps([4,0,1]),import.meta.url),j={txnType:a.type==="send"?"send":"receive",amount:a.amount,commission:a.commission||0,createdAt:a.createdAt,status:"confirmed"},R=f.calculateProfitFromTransaction(j);R>0&&f.addProfit(-R,s.uid);try{I.removeTransactionEffects(a,s.uid)}catch{}}catch(f){console.warn("فشل تحديث الأرباح/التقارير بعد الحذف:",f)}i({title:"تم حذف المعاملة نهائياً",description:"تم حذف المعاملة نهائياً من النظام. يمكنك العثور عليها في قائمة المحذوفات"})}catch(m){console.error("❌ خطأ في حذف المعاملة من Firebase:",m);let x="فشل في حذف المعاملة من الخادم. يرجى المحاولة مرة أخرى";m instanceof Error&&(m.message.includes("network")||m.message.includes("offline")?x="مشكلة في الاتصال بالإنترنت. تحقق من الاتصال وحاول مرة أخرى":m.message.includes("permission")||m.message.includes("unauthorized")?x="ليس لديك صلاحية لحذف هذه المعاملة":m.message.includes("not-found")&&(x="المعاملة غير موجودة أو تم حذفها مسبقاً")),i({title:"خطأ في الحذف",description:x,variant:"destructive"})}},dr=t=>{const a=t.type,r=t.txnType;return a==="withdraw"||a==="withdrawal"||a==="receive"||r==="receive"},mr=t=>{const a=t.type,r=t.txnType;return a==="send"||a==="transfer"||r==="send"},hr=(t,a)=>{const r=new Date().toDateString();let l=ft.filter(w=>new Date(w.createdAt).toDateString()===r&&w.status==="completed");Xs&&Xs.trim()!==""&&(l=l.filter(w=>w.senderPhone&&w.senderPhone.includes(Xs)||w.receiverPhone&&w.receiverPhone.includes(Xs)));const o=ds.filterVisibleTransactions(l,"daily",s==null?void 0:s.uid),m=o.length,x=o.reduce((w,j)=>w+j.amount,0),f=o.filter(dr).reduce((w,j)=>{const R=j.withdrawnAmount!==void 0?j.withdrawnAmount:j.amount;return w+R},0),I=o.filter(mr).reduce((w,j)=>{const R=j.sentAmount!==void 0?j.sentAmount:j.amount;return w+R},0);return{totalTransactions:m,totalAmount:x,totalWithdrawn:f,totalSent:I}},ur=t=>{const a=new Date().getMonth(),r=new Date().getFullYear();let l=ft.filter(w=>{const j=new Date(w.createdAt);return j.getMonth()===a&&j.getFullYear()===r&&w.status==="completed"});Xs&&Xs.trim()!==""&&(l=l.filter(w=>w.senderPhone&&w.senderPhone.includes(Xs)||w.receiverPhone&&w.receiverPhone.includes(Xs)));const o=ds.filterVisibleTransactions(l,"monthly",s==null?void 0:s.uid),m=o.length,x=o.reduce((w,j)=>w+j.amount,0),f=o.filter(dr).reduce((w,j)=>{const R=j.withdrawnAmount!==void 0?j.withdrawnAmount:j.amount;return w+R},0),I=o.filter(mr).reduce((w,j)=>{const R=j.sentAmount!==void 0?j.sentAmount:j.amount;return w+R},0);return{totalTransactions:m,totalAmount:x,totalWithdrawn:f,totalSent:I}},qd=t=>{const a=new Date().getMonth(),r=new Date().getFullYear(),l=ft.filter(x=>{const f=new Date(x.createdAt);return f.getMonth()===a&&f.getFullYear()===r&&x.status==="completed"&&x.fromWallet===t}),o=l.filter(dr).reduce((x,f)=>{const I=f.withdrawnAmount||f.amount;return x+I},0),m=l.filter(mr).reduce((x,f)=>{const I=f.sentAmount||f.amount;return x+I},0);return{totalWithdrawn:o,totalTransferred:m}},Vd=t=>{const a=new Date,r=a.getDate(),l=a.getMonth(),o=a.getFullYear(),m=ft.filter(I=>{const w=new Date(I.createdAt);return w.getDate()===r&&w.getMonth()===l&&w.getFullYear()===o&&I.status==="completed"&&I.fromWallet===t}),x=m.filter(dr).reduce((I,w)=>{const j=w.withdrawnAmount||w.amount;return I+j},0),f=m.filter(mr).reduce((I,w)=>{const j=w.sentAmount||w.amount;return I+j},0);return{totalWithdrawn:x,totalTransferred:f}},Xl=Je.useMemo(()=>ur(),[ft,ae,Xs]);Xl.totalWithdrawn,Xl.totalSent;const ta=Je.useMemo(()=>qd(ae),[ft,ae]);n.useEffect(()=>{try{if(!ae||Ye.length===0)return;const t=Ye.find(V=>V.id===ae);if(!t)return;const a=(tt==null?void 0:tt.monthlyWithdrawLimit)??(t==null?void 0:t.monthlyWithdrawalLimit)??2e5,r=(tt==null?void 0:tt.monthlyTransferLimit)??(t==null?void 0:t.monthlyTransferLimit)??2e5,l=parseFloat(Gt||"0")||0,o=(ta==null?void 0:ta.totalWithdrawn)??(tt==null?void 0:tt.monthlyWithdrawUsed)??0,m=(ta==null?void 0:ta.totalTransferred)??(tt==null?void 0:tt.monthlyTransferUsed)??0,x=o+(le==="withdraw"?l:0),f=m+(le==="transfer"?l:0),I=.85,w=Math.floor(Math.max(a,1)*I),j=Math.floor(Math.max(r,1)*I),R=(()=>{const V=new Date;return`${V.getFullYear()}-${String(V.getMonth()+1).padStart(2,"0")}`})(),L=`monthlyLimitWarnShown:${ae}:${R}`;if(x>=w){const V=`${L}:withdraw`;if(!(localStorage.getItem(V)==="true")){qi({type:"withdraw",used:x,limit:a,walletName:t.name}),Cr(!0);try{localStorage.setItem(V,"true")}catch{}return}}if(f>=j){const V=`${L}:transfer`;if(!(localStorage.getItem(V)==="true")){qi({type:"transfer",used:f,limit:r,walletName:t.name}),Cr(!0);try{localStorage.setItem(V,"true")}catch{}return}}}catch{}},[ae,Ye,tt,ta,le,Gt]);const eo=async()=>{qh(),console.log("🔄 بدء عملية التحويل/السحب"),console.log("📊 البيانات المدخلة:",{senderPhone:Ut,receiverPhone:Ns,amount:Gt,transactionType:le});const t=()=>{le==="transfer"?Wa(!0):Ga(!0)},a=()=>{le==="transfer"?Wa(!1):Ga(!1)};if(t(),!Ut||!Gt){console.log("❌ خطأ: بيانات ناقصة"),i({title:"خطأ في البيانات",description:"يرجى ملء جميع الحقول المطلوبة",variant:"destructive"}),a();return}if(le==="transfer"&&!Ns&&!$){console.log("❌ خطأ: رقم المستقبل مفقود"),i({title:"خطأ في البيانات",description:"يرجى إدخال رقم المستقبل",variant:"destructive"}),a();return}if(le==="transfer"&&!$&&!Vh(Ns)){i({title:"رقم المستقبل غير صالح",description:"اكتب رقم صحيح مكون من 11 رقم ويبدأ بـ 015 أو 010 أو 012 أو 011",variant:"destructive"}),a();return}const r=parseFloat(Gt);if(console.log("💰 المبلغ المحول:",r),r<=0){console.log("❌ خطأ: مبلغ غير صحيح"),i({title:"خطأ في المبلغ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"}),a();return}if(yt)try{const Ee=new Date,Et=Ee.getFullYear(),cs=String(Ee.getMonth()+1).padStart(2,"0"),Zt=String(Ee.getDate()).padStart(2,"0"),sa=`zeroPlanDailyConfirmCount:${(s==null?void 0:s.uid)||"default"}:${Et}-${cs}-${Zt}`,Ls=localStorage.getItem(sa);if((Ls&&parseInt(Ls,10)||0)>=10){i({title:"حد التأكيد اليومي",description:"باقة زيرو تسمح بـ 10 تأكيدات تحويل/سحب يومياً فقط.",variant:"destructive"}),a();return}}catch(Ee){console.warn("فشل قراءة عداد تأكيدات باقة زيرو من التخزين المحلي:",Ee)}const l=Ye.find(Ee=>Ee.id===ae);if(!l){i({title:"خطأ في المحفظة",description:"يرجى اختيار محفظة صحيحة",variant:"destructive"}),a();return}const o=ta;if(console.log("📈 فحص الحدود الشهرية للمحفظة المختارة"),console.log("📊 الإحصائيات الشهرية للمحفظة:",{walletId:ae,walletName:l.name,currentWithdrawn:o.totalWithdrawn,currentTransferred:o.totalTransferred,withdrawalLimit:l.monthlyWithdrawalLimit,transferLimit:l.monthlyTransferLimit}),le==="withdraw"){if(console.log("🏧 فحص حد السحب الشهري للمحفظة"),console.log(`💸 المسحوب حالياً من المحفظة: ${o.totalWithdrawn}, المبلغ الجديد: ${r}, الحد الأقصى: ${l.monthlyWithdrawalLimit}`),o.totalWithdrawn+r>l.monthlyWithdrawalLimit){console.log("❌ تجاوز حد السحب الشهري للمحفظة"),i({title:"تجاوز حد السحب الشهري",description:`لا يمكن سحب أكثر من ${l.monthlyWithdrawalLimit} جنيه شهرياً من محفظة ${l.name}`,variant:"destructive"}),a();return}}else if(console.log("💸 فحص حد التحويل الشهري للمحفظة"),console.log(`📤 المحول حالياً من المحفظة: ${o.totalTransferred}, المبلغ الجديد: ${r}, الحد الأقصى: ${l.monthlyTransferLimit}`),o.totalTransferred+r>l.monthlyTransferLimit){console.log("❌ تجاوز حد التحويل الشهري للمحفظة"),i({title:"تجاوز حد التحويل الشهري",description:`لا يمكن تحويل أكثر من ${l.monthlyTransferLimit} جنيه شهرياً من محفظة ${l.name}`,variant:"destructive"}),a();return}const m=(C==null?void 0:C.shopName)||(s==null?void 0:s.displayName)||"محل كاشي لينك",x={id:Date.now().toString(),type:le==="transfer"?"send":le==="deposit"?"deposit":"withdraw",senderPhone:Ut,receiverPhone:le==="transfer"?Ns:Ut,amount:r,status:"completed",createdAt:new Date,withdrawnAmount:le==="withdraw"?r:void 0,sentAmount:le==="transfer"?r:void 0,depositedAmount:void 0,fromWallet:ae,senderNumber:Ut,senderName:Ut,shopName:(l==null?void 0:l.name)||"المحفظة الرئيسية",transferredAmount:le==="transfer"?r:void 0,receiverNumber:le==="transfer"?Ns:void 0,withdrawnAmountDetailed:le==="withdraw"?r:void 0,depositedAmountDetailed:void 0,merchantShopName:m,transactionReference:`TXN-${Date.now()}`,commission:0,notes:le==="transfer"?void 0:ja&&ja.trim()!==""?ja.trim():void 0};y&&(N!=null&&N.name||N!=null&&N.username)&&(x.cashierName=(N==null?void 0:N.name)||(N==null?void 0:N.username));const f=qa.validateTransaction(r,le,Ct,He);if(!f.isValid){i({title:"خطأ في العملية",description:f.error,variant:"destructive"}),a();return}f.warning&&i({title:"تحذير",description:f.warning,variant:"destructive"});let I;if(le==="transfer")if((l==null?void 0:l.defaultTransferCommission)!=null){const Ee=Number(l.defaultTransferCommission)||0;I=Math.round(Ee*r/1e3*100)/100}else ps&&ps.trim()!==""?I=Math.max(0,parseFloat(ps)):I=0;else if((l==null?void 0:l.defaultWithdrawCommission)!=null){const Ee=Number(l.defaultWithdrawCommission)||0;I=Math.round(Ee*r/1e3*100)/100}else xs&&xs.trim()!==""?I=Math.max(0,parseFloat(xs)):I=Math.round(r*.01*100)/100;if(x.commission=I,le!=="transfer"&&!ut&&I>=r){i({title:"خطأ في العمولة",description:"العمولة أكبر من أو تساوي المبلغ المدخل",variant:"destructive"}),a();return}const w=le==="transfer"||ut?r:Math.round((r-I)*100)/100;x.amount=w,x.withdrawnAmount=le==="withdraw"?w:void 0,x.sentAmount=le==="transfer"?w:void 0,x.transferredAmount=le==="transfer"?w:void 0,x.withdrawnAmountDetailed=le==="withdraw"?w:void 0;let j;const R=le==="transfer"&&!!Ms,L=le==="withdraw"&&!!Ms,V=R||L;let Pe=null;const It=Ir(Ut||"").replace(/\D/g,""),Ge=Ir(Ns||"").replace(/\D/g,""),Ae=le==="transfer"&&(It.startsWith("010")&&(Ge.startsWith("011")||Ge.startsWith("012")||Ge.startsWith("015"))||It.startsWith("012")&&Ge.startsWith("010")||It.startsWith("011")&&Ge.startsWith("010")||It.startsWith("015")&&Ge.startsWith("010")),We=Ae?Math.max(0,parseFloat(zi||"0")):0,Ps=Math.round(I*100)/100;if(x.commission=Ps,x.fee=We,x.totalCharged=le==="transfer"?Number(w)+Number(Ps)+Number(We):ut?Number(w)+Number(Ps):Number(w),Ae&&!V&&We<=0){i({title:"خطأ",description:"أدخل رسوم التحويل لعمليات 010 → 011/012/015 أو 012 → 010 أو 011 → 010 أو 015 → 010",variant:"destructive"}),a();return}if(le==="transfer"&&!V){const Ee=Number(He[ae]||0),Et=Number(w)+Number(We);if(Ee<Et){i({title:"رصيد المحفظة غير كافٍ",description:`الرصيد الحالي ${Ee} لا يكفي لخصم ${Et}`,variant:"destructive"}),a();return}}if(V)if(R){const Ee=qa.validateTransaction(w,"transfer",Ct,He);Ee.isValid?j={success:!0,newCashBalance:Ct,newWalletBalances:He}:j={success:!1,newCashBalance:Ct,newWalletBalances:He,message:Ee.error||"رصيد غير كافٍ للتحويل المؤجل",error:"INSUFFICIENT_WALLET_BALANCE"}}else j={success:!0,newCashBalance:Ct,newWalletBalances:He};else le==="transfer"?j=await qa.processTransfer({amount:w,currentCashBalance:Ct,currentWalletBalances:He,wallets:Ye,selectedWalletId:ae,skipRemoteLimitsCheck:!1,nonBlockingUsageUpdate:!0}):j=await qa.processWithdraw({amount:w,currentCashBalance:Ct,currentWalletBalances:He,wallets:Ye,selectedWalletId:ae,skipRemoteLimitsCheck:!1,nonBlockingUsageUpdate:!0});if(!j.success){i({title:"فشل في العملية",description:j.error||j.message,variant:"destructive"}),a();return}let Rs=V?Ct:j.newCashBalance,$s=V?He:j.newWalletBalances;if(!V&&le==="transfer"&&We>0){const Ee=Number($s[ae]||0);$s={...$s,[ae]:Math.round((Ee-Number(We))*100)/100}}if(V&&L){const Ee=Ye.find(Zt=>Zt.id===ae)??Ye.find(Zt=>Zt.isDefault)??Ye[0],Et=(Ee==null?void 0:Ee.id)||ae;if(Et!==ae)try{cr(Et)}catch{}const cs=Number(He[Et]||0);$s={...He,[Et]:Math.round((cs+Number(w))*100)/100};try{const Zt=`walletEffectsAppliedOnCreation_${(s==null?void 0:s.uid)||"default"}`,sa=localStorage.getItem(Zt),Ls=sa?JSON.parse(sa):[];x!=null&&x.id&&!Ls.includes(x.id)&&(Ls.push(x.id),localStorage.setItem(Zt,JSON.stringify(Ls)))}catch{}}if(V&&R){const Ee=Ye.find(Zt=>Zt.id===ae)??Ye.find(Zt=>Zt.isDefault)??Ye[0],Et=(Ee==null?void 0:Ee.id)||ae;if(Et!==ae)try{cr(Et)}catch{}const cs=Number(He[Et]||0);$s={...He,[Et]:Math.round((cs-Number(w)-Number(We))*100)/100}}if((R||L)&&Ms&&!mc){const Ee={id:`DEBT-${Date.now()}`,debtorName:Ms.debtorName,amount:Ms.amount,reason:Ms.notes||"",customerId:Ms.customerId,mobile:Ms.mobile,status:"pending",createdAt:new Date};Pe=Ee.id;const Et=[Ee,...Rt];fs(Et);try{await Ts(Et)}catch(cs){console.error("⚠️ فشل حفظ الدين المؤجل محلياً:",cs)}i({title:"تم إضافة الدين",description:"أضيف إلى إيصالات الديون حتى يتم السداد",variant:"default"})}if(!V){const Ee=Math.max(0,Number(I))+Math.max(0,Number(We));Ee>0&&(Rs=Math.round((Rs+Ee)*100)/100,console.log(`💰 تم إضافة عمولة/رسوم ${Ee} جنيه لدرج النقدية`))}console.log("⚡ تحديث الواجهة فوراً بدون حجب باستخدام startTransition...");const cn=[x,...ft];Je.startTransition(()=>{zt(Rs),ns($s),V&&(x.status="pending"),Qs(cn)});try{setTimeout(()=>{try{localStorage.setItem(pi(),JSON.stringify(cn))}catch{}},0)}catch{}if(yt)try{const Ee=new Date,Et=Ee.getFullYear(),cs=String(Ee.getMonth()+1).padStart(2,"0"),Zt=String(Ee.getDate()).padStart(2,"0"),sa=`zeroPlanDailyConfirmCount:${(s==null?void 0:s.uid)||"default"}:${Et}-${cs}-${Zt}`,Ls=localStorage.getItem(sa),dn=Ls&&parseInt(Ls,10)||0;localStorage.setItem(sa,String(dn+1))}catch{}if(setTimeout(()=>{try{localStorage.setItem(Ds(),Rs.toString()),localStorage.setItem(Ss(),JSON.stringify($s))}catch{}},0),(async()=>{try{console.log("🔄 بدء حفظ المعاملة في Firebase في الخلفية...");const Ee={shopId:P||(C==null?void 0:C.shopId)||(s==null?void 0:s.uid)||"default-shop",lineId:ae||"default-line",merchantUserId:(s==null?void 0:s.uid)||null,provider:"vodafone_cash",txnType:le==="transfer"?"send":"receive",amount:w,commission:Ps,fee:We,profit:0,senderMsisdn:Ut,receiverMsisdn:le==="transfer"?Ns:Ut,note:le==="transfer"?void 0:ja&&ja.trim()!==""?ja.trim():void 0,status:V?"pending":"confirmed",linkedDebtId:Pe||void 0,createdBy:(s==null?void 0:s.uid)||null,walletEffectAppliedOnCreation:!!(V&&L)},Et={...Ee,status:V?"pending":"completed",commissionMode:le==="transfer"||ut?"add":"deduct",totalCharged:le==="transfer"?w+Ps+We:ut?w+I:w,walletEffectAppliedOnCreation:!!(V&&L),sentAmount:le==="transfer"?w:void 0,transferredAmount:le==="transfer"?w:void 0,withdrawnAmount:le==="withdraw"?w:void 0,createdAt:new Date},{ProfitService:cs}=await Nt(async()=>{const{ProfitService:em}=await import("./profitService-DZQLszRg.js").then(tm=>tm.p);return{ProfitService:em}},__vite__mapDeps([4,0,1]),import.meta.url),Zt=cs.calculateProfitFromTransaction(Et);Zt>0&&(cs.addProfit(Zt,s==null?void 0:s.uid),console.log("✅ تم إضافة الربح:",Zt,"جنيه"));const sa=await bn.create(Ee);await Promise.all([...s!=null&&s.uid?[Me.updateUserData(s.uid,{cashBalance:Rs,walletBalances:$s,lastUpdated:new Date().toISOString()})]:[],...s!=null&&s.uid?[Me.saveUserTransaction(s.uid,{...Et,transactionType:le,fromWallet:ae,toWallet:le==="transfer"?R?null:"cash":null,cashierName:y&&((N==null?void 0:N.name)||(N==null?void 0:N.username))||"الحساب الرئيسي",linkedDebtId:Pe||void 0,transactionId:sa,description:`${le==="transfer"?"تحويل":"سحب"} ${w} من ${ae} ${le==="transfer"?R?"":"إلى الدرج النقدي":""} — عمولة: ${I} (${le==="transfer"||ut?"مضافة":"مخصومة"})${We>0?` — رسوم: ${We}`:""}${V?" — دين مؤجل (قيد المراجعة)":""}`})]:[]]),console.log("✅ تم حفظ جميع البيانات في Firebase بنجاح");const Ls=`userData_${s==null?void 0:s.uid}`,dn={cashBalance:Rs,walletBalances:$s,lastUpdated:new Date().toISOString()};localStorage.setItem(Ls,JSON.stringify(dn))}catch(Ee){console.error("❌ خطأ في حفظ المعاملة في Firebase (في الخلفية):",Ee),i({title:"تحذير",description:"تم تنفيذ العملية محلياً، لكن فشلت المزامنة مع الخادم. ستتم المحاولة مرة أخرى تلقائياً.",variant:"destructive"})}})(),le==="transfer"){Wa(!0);const Ee=Number(r)+Number(I)+Math.max(0,Number(We));Mn({type:"transfer",amount:Math.max(0,Math.round(Ee*100)/100)}),Fc({receiver:Ns,amount:r}),Da(!0),setTimeout(()=>{Wa(!1)},2e3)}else{Ga(!0);const Ee=ut?Number(r):Math.max(0,Math.round((Number(r)-Number(I))*100)/100);Mn({type:"withdraw",amount:Math.max(0,Math.round(Ee*100)/100)}),Da(!0),setTimeout(()=>{Ga(!1)},2e3)}Na(""),ca(""),Mi(""),Cn(null),Sn(""),Sa(""),$i(""),Li(!1)},on=Je.useMemo(()=>new Intl.DateTimeFormat("ar-EG"),[]),to=Je.useMemo(()=>new Intl.DateTimeFormat("ar-EG",{hour:"2-digit",minute:"2-digit"}),[]),Jd=Je.useMemo(()=>{try{return Rt.reduce((t,a)=>{const r=Number(a.paidAmount||0),l=Math.max(0,Number(a.amount||0)-r);return t+l},0)}catch{return 0}},[Rt]),Si=Je.useMemo(()=>Hl().filter(a=>Zs==="all"?!0:Zs==="send"?a.type==="send":Zs==="receive"?a.type==="receive":Zs==="withdraw"?a.type==="withdraw":Zs!=="deleted"),[Hl,Zs]),Kd=()=>{if(Fn==="daily"){const t=ds.resetReportsManually("daily",ft,s==null?void 0:s.uid);Ya(!1),i({title:"تم تصفير المعاملات اليومية",description:`تم إخفاء ${t.length} معاملة من تقارير اليوم (الحدود لم تتأثر)`})}else{const t=ds.resetReportsManually("monthly",ft,s==null?void 0:s.uid);Ya(!1),i({title:"تم تصفير المعاملات الشهرية",description:`تم إخفاء ${t.length} معاملة من تقارير الشهر (الحدود لم تتأثر)`})}},Yd=()=>Fn==="daily"?"تصفير المعاملات اليومية":"تصفير المعاملات الشهرية",Hd=()=>Fn==="daily"?"أدخل الرقم السري الرئيسي لتصفير جميع معاملات اليوم":"أدخل الرقم السري الرئيسي لتصفير جميع معاملات الشهر",Gd=t=>{Ll(t),ii(!0)},Qd=t=>{zt(t),localStorage.setItem(Ds(),t.toString()),Il(!1),i({title:"تم تحديث الرصيد النقدي",description:`تم تحديث الرصيد النقدي إلى ${t} جنيه`})},Zd=async t=>{var x;if(!vs){console.warn("لا يوجد معرف محفظة محدد لتعديل الرصيد");return}const a={...He,[vs]:t};ns(a);const r=new Date().toISOString(),l={walletBalances:a,lastUpdated:r},o=`userData_${s==null?void 0:s.uid}`;try{localStorage.setItem(o,JSON.stringify(l)),localStorage.setItem(Ss(),JSON.stringify(a)),localStorage.setItem(`walletBalances_backup_${r}`,JSON.stringify(a))}catch{}try{s!=null&&s.uid&&await Me.updateUserData(s.uid,l)}catch(f){console.error("خطأ أثناء حفظ رصيد المحفظة في Firebase:",f)}Al(!1);const m=((x=Ye.find(f=>f.id===vs))==null?void 0:x.name)||"المحفظة";i({title:"تم تحديث رصيد المحفظة",description:`تم تحديث رصيد ${m} إلى ${t.toLocaleString()} جنيه`})},Xd=async t=>{var a;if(console.log("💰 بدء تحديث رصيد المحفظة"),console.log("📊 معرف المحفظة المحررة:",vs),console.log("💵 المبلغ المضاف/المخصوم:",t),vs){const r=He[vs]||0;console.log("💰 الرصيد الحالي:",r);const l=r+t;console.log("💰 الرصيد الجديد:",l);const o={...He,[vs]:l};console.log("📊 الأرصدة المحدثة:",o),ns(o);const m=new Date().toISOString(),x={walletBalances:o,lastUpdated:m},f=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(f,JSON.stringify(x)),localStorage.setItem(Ss(),JSON.stringify(o)),localStorage.setItem(`walletBalances_backup_${m}`,JSON.stringify(o));try{if(s!=null&&s.uid){console.log("🔄 حفظ البيانات في Firebase...");try{await Me.updateUserData(s.uid,x),console.log("✅ تم حفظ الأرصدة في Firebase بنجاح"),setTimeout(()=>{localStorage.removeItem(f),console.log("🧹 تم حذف النسخة المحلية المؤقتة بعد دقيقة واحدة")},6e4)}catch(R){console.error("❌ فشل في حفظ البيانات في Firebase:",R),Be(!0)}}else console.log("⚠️ المستخدم غير مسجل دخول، حفظ في localStorage"),localStorage.setItem(Ss(),JSON.stringify(o));const I=((a=Ye.find(R=>R.id===vs))==null?void 0:a.name)||"المحفظة",w=t>0?"إضافة":"خصم",j=Math.abs(t);i({title:`تم ${w} مبلغ ${w==="إضافة"?"إلى":"من"} رصيد المحفظة`,description:`تم ${w} ${j} جنيه ${w==="إضافة"?"إلى":"من"} رصيد ${I}. الرصيد الجديد: ${l.toLocaleString()} جنيه`})}catch(I){if(console.error("❌ فشل في حفظ البيانات في Firebase:",I),localStorage.setItem(Ss(),JSON.stringify(o)),s!=null&&s.uid){const w=`userData_${s.uid}`,j={walletBalances:o,lastUpdated:new Date().toISOString()};localStorage.setItem(w,JSON.stringify(j)),Be(!0)}i({title:"تم حفظ البيانات محلياً",description:"تم حفظ التغييرات محلياً وسيتم مزامنتها مع الخادم لاحقاً",variant:"default"})}}else console.log("❌ لا يوجد معرف محفظة للتحرير");setTimeout(()=>{const l=Object.keys(localStorage).filter(o=>o.startsWith("walletBalances_backup_")).sort();l.length>5&&l.slice(0,l.length-5).forEach(m=>{localStorage.removeItem(m),console.log("🗑️ حذف النسخة الاحتياطية القديمة:",m)})},5e3),ii(!1),Ll("")};return console.log("🔥 UserDashboardPage - Render conditions:",{isCheckingActivation:wt,isUserActive:Pt,showActivationModal:ts}),!wt&&!Pt?(console.log("🔥 UserDashboardPage - Showing activation modal"),e.jsx("div",{className:"user-dashboard min-h-screen bg-background flex items-center justify-center",children:e.jsx(bo,{isOpen:!0,onClose:()=>{}})})):wt?(console.log("🔥 UserDashboardPage - Showing loading screen"),e.jsx(xm,{})):(console.log("🔥 UserDashboardPage - Rendering main dashboard"),e.jsxs("div",{className:"user-dashboard min-h-screen px-2 sm:px-4 py-2 sm:py-4 relative bg-gray-50 bg-[radial-gradient(140%_140%_at_10%_10%,#f3f4f6_0%,#e5e7eb_45%,#d1d5db_100%)]",children:[e.jsx(Jh,{userId:s==null?void 0:s.uid}),e.jsxs("div",{className:"max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-3 sm:gap-6 relative z-10",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-2 sm:space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 sm:grid-cols-2 sm:gap-3 fade-in-up",children:[!Qa&&e.jsxs(Tt,{className:"monthly-stats-card bg-gradient-to-br from-purple-50 via-purple-25 to-white border border-purple-200/60 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 group relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-purple-500/5 to-purple-600/3 opacity-0 group-hover:opacity-100 transition-opacity duration-300"}),e.jsx("div",{className:"absolute top-0 right-0 w-20 sm:w-32 h-20 sm:h-32 bg-gradient-to-br from-purple-300/15 to-transparent rounded-full -translate-y-8 sm:-translate-y-16 translate-x-8 sm:translate-x-16 group-hover:scale-110 transition-transform duration-300"}),e.jsx(es,{className:"monthly-stats-header pb-2 sm:pb-1 lg:pb-1 px-3 sm:px-3 lg:px-2 pt-3 sm:pt-2 lg:pt-1 relative z-10",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(us,{className:"text-xs font-bold text-purple-800 flex items-center gap-1.5 sm:gap-1",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"w-2.5 sm:w-2 h-2.5 sm:h-2 bg-gradient-to-r from-purple-500 to-purple-600 rounded-full shadow-sm"}),e.jsx("div",{className:"absolute inset-0 w-2.5 sm:w-2 h-2.5 sm:h-2 bg-purple-400 rounded-full opacity-60 animate-pulse"})]}),e.jsx("span",{className:"text-xs",children:"الشهر"})]}),e.jsxs("div",{className:"flex items-center gap-1 sm:gap-1",children:[e.jsx("div",{className:"hidden"}),e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>{Gi("monthly"),Ya(!0)},className:"monthly-stat-action h-7 w-7 sm:h-6 sm:w-6 p-0 bg-gradient-to-r from-purple-100 to-purple-200 text-purple-700 hover:from-purple-200 hover:to-purple-300 hover:text-purple-800 rounded-lg sm:rounded-md transition-all duration-300 hover:scale-105 shadow-sm hover:shadow-md",title:"تصفير معاملات الشهر",children:e.jsx(Xt,{className:"h-3 w-3 sm:h-2.5 sm:w-2.5"})}),e.jsx("div",{className:"monthly-stat-action p-1.5 sm:p-1 bg-gradient-to-r from-purple-100 to-purple-200 rounded-lg sm:rounded-md",children:e.jsx(pr,{className:"h-3 w-3 sm:h-2.5 sm:w-2.5 text-purple-600"})})]})]})}),!Qa&&e.jsxs(Ft,{className:"space-y-0.5 sm:space-y-1 lg:space-y-0 pt-0 px-2 sm:px-3 lg:px-2 pb-1.5 sm:pb-2 lg:pb-1 relative z-10",children:[e.jsxs("div",{className:"stat-row stat-row--monthly flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-purple-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"stat-label stat-label--monthly text-xs font-semibold text-purple-700",children:"عدد المعاملات:"}),e.jsx("span",{className:"stat-value stat-value--monthly font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:ur().totalTransactions})]}),e.jsxs("div",{className:"stat-row stat-row--monthly flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-purple-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"stat-label stat-label--monthly text-xs font-semibold text-purple-700",children:"إجمالي المبالغ:"}),e.jsx("span",{className:"stat-value stat-value--monthly font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:ur().totalAmount.toFixed(2)})]}),e.jsxs("div",{className:"stat-row stat-row--monthly flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-purple-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"stat-label stat-label--monthly text-xs font-semibold text-purple-700",children:"المسحوب:"}),e.jsx("span",{className:"stat-value stat-value--monthly font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:ur().totalWithdrawn.toFixed(2)})]}),e.jsxs("div",{className:"stat-row stat-row--monthly flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-purple-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"stat-label stat-label--monthly text-xs font-semibold text-purple-700",children:"المرسل:"}),e.jsx("span",{className:"stat-value stat-value--monthly font-bold text-xs text-purple-900 bg-gradient-to-r from-purple-100 to-purple-200 px-1 py-0.5 rounded-sm sm:rounded-lg shadow-sm",children:ur().totalSent.toFixed(2)})]}),e.jsxs("div",{className:"stat-row stat-row--monthly flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-purple-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-purple-50/90 transition-all duration-300 border border-purple-100/60",children:[e.jsx("span",{className:"stat-label stat-label--monthly text-xs font-semibold text-purple-700",children:"الأرباح:"}),e.jsx(Eh,{userId:s==null?void 0:s.uid,transactions:ft})]})]}),qc&&e.jsx("div",{className:"monthly-overlay absolute inset-0 z-20 bg-yellow-100/60 backdrop-blur-sm rounded-xl border border-yellow-300/70 flex items-center justify-center p-0 pointer-events-auto",children:e.jsxs(h,{size:"sm",variant:"ghost",onClick:async()=>{if(yt){i({title:"غير متاح",description:"تقارير الشهر غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"});return}Mr(!0)},className:"px-2.5 py-1 rounded-full bg-gradient-to-r from-yellow-500 to-yellow-600 text-black hover:from-yellow-600 hover:to-yellow-700 shadow-md flex items-center gap-1 text-[11px] font-semibold",title:"عرض تقارير الشهر (يتطلب الرقم السري)",children:[e.jsx("span",{children:"عرض تقارير الشهر"}),e.jsx(Wt,{className:"h-2.5 w-2.5"})]})})]}),e.jsx(as,{open:Jc,onOpenChange:Mr,mode:"verify",title:"الرقم السري لفتح تقارير الشهر",description:"لا يمكن الاطلاع على إحصائيات الشهر إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{if(yt){i({title:"غير متاح",description:"تقارير الشهر غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"}),Mr(!1),ol(!0);return}ol(!1),Mr(!1)},userId:s==null?void 0:s.uid}),((so=gt==null?void 0:gt.subscription)==null?void 0:so.planType)!==ms.TAHWEELA&&e.jsxs(Tt,{className:"daily-stats-card bg-gradient-to-br from-blue-50 via-blue-25 to-white border border-blue-200/60 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 group relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/5 to-blue-600/3 opacity-0 group-hover:opacity-100 transition-opacity duration-300"}),e.jsx("div",{className:"absolute top-0 right-0 w-20 sm:w-32 h-20 sm:h-32 bg-gradient-to-br from-blue-300/15 to-transparent rounded-full -translate-y-8 sm:-translate-y-16 translate-x-8 sm:translate-x-16 group-hover:scale-110 transition-transform duration-300"}),e.jsx(es,{className:"daily-stats-header pb-2 sm:pb-3 lg:pb-1 px-3 sm:px-4 lg:px-2 pt-3 sm:pt-4 lg:pt-1 relative z-10",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(us,{className:"text-sm sm:text-base font-bold text-blue-800 flex items-center gap-1.5 sm:gap-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"w-2.5 sm:w-3 h-2.5 sm:h-3 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full shadow-sm"}),e.jsx("div",{className:"absolute inset-0 w-2.5 sm:w-3 h-2.5 sm:h-3 bg-blue-400 rounded-full opacity-60 animate-pulse"})]}),e.jsx("span",{className:"text-xs sm:text-sm",children:"اليوم"})]}),e.jsxs("div",{className:"flex items-center gap-1 sm:gap-1.5",children:[e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>{Gi("daily"),Ya(!0)},className:"daily-stat-action h-7 w-7 sm:h-8 sm:w-8 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded-lg transition-all duration-300 hover:scale-105 shadow-sm hover:shadow-md",title:"تصفير معاملات اليوم",children:e.jsx(Xt,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"})}),e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>Vc(t=>!t),className:"daily-stat-action h-7 w-7 sm:h-8 sm:w-8 p-0 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 hover:from-blue-200 hover:to-blue-300 hover:text-blue-800 rounded-lg transition-all duration-300 hover:scale-105 shadow-sm hover:shadow-md",title:Qa?"توسيع اليوم والشهر":"طي اليوم والشهر",children:Qa?e.jsx(wr,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"}):e.jsx(un,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5"})}),e.jsx("div",{className:"p-1.5 sm:p-2 bg-gradient-to-r from-blue-100 to-blue-200 rounded-lg",children:e.jsx(pr,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5 text-blue-600"})})]})]})}),!Qa&&e.jsxs(Ft,{className:"space-y-0 pt-0 px-2 pb-1 relative z-10",children:[e.jsxs("div",{className:"stat-row flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-blue-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"stat-label text-xs font-semibold text-blue-700",children:"عدد المعاملات:"}),e.jsx("span",{className:"stat-value font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:hr().totalTransactions})]}),e.jsxs("div",{className:"stat-row flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-blue-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"stat-label text-xs font-semibold text-blue-700",children:"إجمالي المبالغ:"}),e.jsx("span",{className:"stat-value font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:hr().totalAmount.toFixed(2)})]}),e.jsxs("div",{className:"stat-row flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-blue-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"stat-label text-xs font-semibold text-blue-700",children:"المسحوب:"}),e.jsx("span",{className:"stat-value font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:hr().totalWithdrawn.toFixed(2)})]}),e.jsxs("div",{className:"stat-row flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from_gray-100 to-blue-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"stat-label text-xs font-semibold text-blue-700",children:"المرسل:"}),e.jsx("span",{className:"stat-value font-bold text-xs text-blue-900 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-sm shadow-sm",children:hr().totalSent.toFixed(2)})]}),e.jsxs("div",{className:"stat-row flex justify-between items-center p-0.5 sm:p-1 lg:p-0.5 bg-gradient-to-r from-gray-100 to-blue-50/80 rounded-sm sm:rounded-lg hover:from-gray-200 hover:to-blue-50/90 transition-all duration-300 border border-blue-100/60",children:[e.jsx("span",{className:"stat-label text-xs font-semibold text-blue-700",children:"الأرباح:"}),e.jsx(Mh,{userId:s==null?void 0:s.uid,transactions:ft})]})]}),Kc&&e.jsx("div",{className:"absolute inset-0 z-20 bg-yellow-100/60 backdrop-blur-sm rounded-xl border border-yellow-300/70 flex items-center justify-center p-0 pointer-events-auto",children:e.jsxs(h,{size:"sm",variant:"ghost",onClick:()=>$n(!0),className:"px-2.5 py-1 rounded-full bg-gradient-to-r from-yellow-300 to-yellow-400 text-black hover:from-yellow-400 hover:to-yellow-500 shadow-md flex items-center gap-1 text-[11px] font-semibold",title:"عرض تقارير اليوم (يتطلب الرقم السري)",children:[e.jsx("span",{children:"عرض تقارير اليوم"}),e.jsx(Wt,{className:"h-2.5 w-2.5"})]})})]}),e.jsx(as,{open:Yc,onOpenChange:$n,mode:"verify",title:"الرقم السري لفتح تقارير اليوم",description:"لا يمكن الاطلاع على تقارير اليوم إلا بإدخال الرقم السري الرئيسي",onSuccess:()=>{cl(!1),$n(!1)},userId:s==null?void 0:s.uid})]}),e.jsxs(Tt,{className:"balance-bar bg-white border-2 border-gray-200/50 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 group relative overflow-hidden   transform fade-in-up mb-6",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-emerald-500/5 via-blue-500/5 to-emerald-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-200"}),e.jsx("div",{className:"absolute top-0 left-0 w-40 h-40 bg-gradient-to-br from-emerald-300/10 to-transparent rounded-full -translate-y-20 -translate-x-20 group-hover:scale-150 transition-transform duration-200"}),e.jsx("div",{className:"absolute bottom-0 right-0 w-40 h-40 bg-gradient-to-br from-blue-300/10 to-transparent rounded-full translate-y-20 translate-x-20 group-hover:scale-150 transition-transform duration-200"}),e.jsx(Ft,{className:"p-3 relative z-10",children:e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"bg-emerald-50 border-2 border-emerald-200/50 p-1 rounded-xl shadow-lg hover:shadow-md transition-all duration-200 group/cash relative overflow-hidden ",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-emerald-500/10 to-transparent opacity-0 group-hover/cash:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex items-center justify-between relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-emerald-100 to-emerald-200 rounded-lg shadow-sm",children:e.jsx($t,{className:"h-1.5 w-1.5 text-emerald-600"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] font-bold text-emerald-800",children:"الفلوس النقدية"}),e.jsxs("span",{className:"text-[10px] font-extrabold text-emerald-700 bg-gradient-to-r from-emerald-100 to-emerald-200 px-1 py-0.5 rounded-lg shadow-sm",children:[Ct.toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(h,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-green-100 to-green-200 text-green-700 hover:from-green-200 hover:to-green-300 hover:text-green-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>rr(!0),children:e.jsx(ls,{className:"h-2 w-2"})}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-emerald-100 to-emerald-200 text-emerald-700 hover:from-emerald-200 hover:to-emerald-300 hover:text-emerald-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>Ul(!0),title:"تفاصيل الفلوس النقدية",children:e.jsx(fo,{className:"h-2 w-2"})}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800 rounded-xl transition-all duration-300  hover:rotate-12 shadow-md hover:shadow-lg",onClick:()=>rn(!0),children:e.jsx(Xt,{className:"h-2 w-2"})})]})]})]}),e.jsxs("div",{className:"bg-blue-50 border-2 border-blue-200/50 p-1 rounded-xl shadow-lg hover:shadow-md transition-all duration-200 group/wallet relative overflow-hidden ",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/10 to-transparent opacity-0 group-hover/wallet:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex items-center justify-between relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-blue-100 to-blue-200 rounded-lg shadow-sm",children:e.jsx(Js,{className:"h-1.5 w-1.5 text-blue-600"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] font-bold text-blue-800",children:"الأرصدة علي المحافظ"}),e.jsxs("span",{className:"text-[10px] font-extrabold text-blue-700 bg-gradient-to-r from-blue-100 to-blue-200 px-1 py-0.5 rounded-lg shadow-sm",children:[Object.values(He).reduce((t,a)=>t+a,0).toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(h,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-green-100 to-green-200 text-green-700 hover:from-green-200 hover:to-green-300 hover:text-green-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>en(!0),title:"إضافة أموال لإجمالي المحفظة",children:e.jsx(ls,{className:"h-2 w-2"})}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800 rounded-xl transition-all duration-300  hover:rotate-12 shadow-md hover:shadow-lg",onClick:()=>{sn(!0),an("")},title:"تصفير إجمالي المحفظة",children:e.jsx(Xt,{className:"h-2 w-2"})})]})]})]}),e.jsxs("div",{className:"col-span-2 sm:col-span-1 bg-indigo-50 border-2 border-indigo-200/50 p-1 rounded-xl shadow-lg hover:shadow-md transition-all duration-200 group/selwallet relative overflow-hidden ",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-indigo-500/10 to-transparent opacity-0 group-hover/selwallet:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"flex items-center justify-between relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("div",{className:"p-0.5 bg-gradient-to-r from-indigo-100 to-indigo-200 rounded-lg shadow-sm",children:e.jsx(Js,{className:"h-1.5 w-1.5 text-indigo-600"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] font-bold text-indigo-800",children:"رصيد المحفظه"}),e.jsxs("span",{className:"text-[10px] font-extrabold text-indigo-700 bg-gradient-to-r from-indigo-100 to-indigo-200 px-1 py-0.5 rounded-lg shadow-sm",children:[(ae&&He[ae]||0).toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(h,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-green-100 to-green-200 text-green-700 hover:from-green-200 hover:to-green-300 hover:text-green-800 rounded-xl transition-all duration-300 hover:scale-110 shadow-md hover:shadow-lg",onClick:()=>{if(!ae){i({title:"اختر محفظة",description:"يرجى اختيار محفظة من اختيار المحافظ بالأعلى أولاً",variant:"destructive"});return}Gd(ae)},title:"إضافة/خصم إلى رصيد المحفظة المختارة",children:e.jsx(ls,{className:"h-2 w-2"})}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 bg-gradient-to-r from-red-100 to-red-200 text-red-700 hover:from-red-200 hover:to-red-300 hover:text-red-800 rounded-xl transition-all duration-300  hover:rotate-12 shadow-md hover:shadow-lg",onClick:()=>{if(!ae){i({title:"اختر محفظة",description:"يرجى اختيار محفظة لتصفير رصيدها فقط",variant:"destructive"});return}Br(!0)},title:"تصفير رصيد المحفظة المختارة",children:e.jsx(Xt,{className:"h-2 w-2"})})]})]})]})]})})]}),e.jsxs(Tt,{className:"bg-gradient-to-br from-gray-50 via-white to-slate-50 border border-gray-200/60 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 group relative overflow-hidden fade-in-up",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-gray-500/5 to-slate-600/3 opacity-0 group-hover:opacity-100 transition-opacity duration-300"}),e.jsxs(es,{className:`pb-2 px-4 pt-4 relative z-10 ${F?"sticky top-0 z-20 bg-white/90 backdrop-blur supports-[backdrop-filter]:bg-white/60":""}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(us,{className:"text-sm font-bold flex items-center gap-2 text-gray-800",children:[!F&&e.jsx("div",{className:"p-1.5 sm:p-2 bg-gradient-to-r from-gray-100 to-slate-200 rounded-lg",children:e.jsx(pr,{className:"h-3 w-3 sm:h-3.5 sm:w-3.5 text-gray-600"})}),e.jsx("span",{className:"bg-gradient-to-r from-gray-600 to-slate-600 bg-clip-text text-transparent",children:"المعاملات الأخيرة"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[!F&&e.jsxs("div",{className:"flex items-center gap-0.5 bg-gray-50 rounded px-1 py-0.5 border border-gray-200 hover:border-blue-300 transition-all duration-200 group relative overflow-hidden max-w-[140px] md:max-w-[220px]",children:[e.jsx(km,{className:"h-2 w-2 text-gray-400 group-hover:text-blue-600 transition-colors"}),e.jsx(z,{placeholder:"بحث...",value:Xi,onChange:t=>_c(t.target.value),className:"h-3 text-[8px] border-0 bg-transparent focus:ring-0 focus:outline-none text-gray-700 placeholder:text-gray-400"})]}),!F&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"تقسيط"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>{if(yt||Mt){i({title:"غير متاح",description:"إدارة التقسيط غير متاحة في هذه الخطة.",variant:"destructive"});return}_r(!0)},title:"إدارة التقسيط",children:e.jsx(pm,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-green-600 mb-1",children:"شحن"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-green-50 text-green-600 hover:bg-green-100 border border-green-200 ring-3 ring-green-300 transition-all duration-200 hover:scale-105 active:bg-green-600 active:text-white active:border-green-600",onClick:()=>{i({title:"قيد التطوير",description:"هذه الميزة غير متاحة حالياً."})},title:"شحن الرصيد",children:e.jsx(jr,{className:"h-5 w-5 text-green-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"حاسبة"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>Rn(!0),title:"آلة حاسبة",children:e.jsx(Fo,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"كروت"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>{yt||Mt?i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):Er(!0)},title:"كروت الائتمان",children:e.jsx(jr,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-blue-600 mb-1",children:"تقاريرك"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-blue-50 text-blue-600 hover:bg-blue-100 border border-blue-200 ring-3 ring-blue-300 transition-all duration-200 hover:scale-105 active:bg-blue-600 active:text-white active:border-blue-600",onClick:()=>{if(yt||Mt){i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"});return}Fl(!0)},title:"تقاريرك",children:e.jsx(Xm,{className:"h-5 w-5 text-blue-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-blue-600 mb-1",children:"الوردية"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-blue-50 text-blue-600 hover:bg-blue-100 border border-blue-200 ring-3 ring-blue-300 transition-all duration-200 hover:scale-105 active:bg-blue-600 active:text-white active:border-blue-600",onClick:Id,title:y&&(N!=null&&N.name||N!=null&&N.username)?`بروفيل الوردية: ${(N==null?void 0:N.name)||(N==null?void 0:N.username)}`:"وردية الكاشير",children:e.jsx(ki,{className:"h-5 w-5 text-blue-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600 mb-1",children:"المبيعات"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>{yt||Mt?i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):Ja(!0)},title:"بيانات المبيعات",children:e.jsx(po,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"text-[10px] font-semibold text-purple-600",children:"الديون"}),Rt.filter(t=>t.status==="pending").length>0&&e.jsx("span",{className:"h-4 w-4 rounded-full bg-red-600 text-white text-[10px] flex items-center justify-center ring-2 ring-white",children:Rt.filter(t=>t.status==="pending").length})]}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 ring-3 ring-purple-300 transition-all duration-200 hover:scale-105 active:bg-purple-600 active:text-white active:border-purple-600",onClick:()=>{Gn()},title:"الديون",children:e.jsx(gm,{className:"h-5 w-5 text-purple-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-amber-700 mb-1",children:"الصيانة"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-amber-50 text-amber-700 hover:bg-amber-100 border border-amber-200 ring-3 ring-amber-300 transition-all duration-200 hover:scale-105 active:bg-amber-600 active:text-white active:border-amber-600",onClick:()=>{yt||Mt?i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):Fr(!0)},title:"الصيانة",children:e.jsx(To,{className:"h-5 w-5 text-amber-700"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-yellow-500 mb-1",children:"المكنة"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-violet-50 text-violet-700 hover:bg-violet-100 border border-violet-200 ring-3 ring-violet-300 transition-all duration-200 hover:scale-105 active:bg-violet-700 active:text-white active:border-violet-700",onClick:()=>{!qs||Mt?i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):Wr(!0)},title:"يومية المكنة",children:e.jsx(Ro,{className:"h-5 w-5 text-yellow-500"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-orange-600 mb-1",children:"مصروفات"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-orange-50 text-orange-600 hover:bg-orange-100 border border-orange-200 ring-3 ring-orange-300 transition-all duration-200 hover:scale-105 active:bg-orange-600 active:text-white active:border-orange-600",onClick:()=>{yt||Mt?i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):os.hasMasterPin()?Bt(!0):St(!0)},title:"مصروفات المحل",children:e.jsx(pn,{className:"h-5 w-5 text-orange-600"})})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-semibold text-rose-600 mb-1",children:"النواقص"}),e.jsx(h,{variant:"ghost",size:"sm",className:"h-10 w-10 p-0 rounded-full bg-rose-50 text-rose-600 hover:bg-rose-100 border border-rose-200 ring-3 ring-rose-300 transition-all duration-200 hover:scale-105 active:bg-rose-600 active:text-white active:border-rose-600",onClick:()=>{yt||Mt?i({title:"غير متاح",description:"هذه الميزة غير متاحة في هذه الخطة.",variant:"destructive"}):oa(!0)},title:"النواقص",children:e.jsx(mo,{className:"h-5 w-5 text-rose-600"})})]})]})]})]}),!F&&e.jsx("div",{className:"mt-2 w-full",children:e.jsxs("div",{className:"filters-bar flex items-center justify-center gap-3 bg-gray-50 rounded-md p-3 border border-gray-200",children:[e.jsx(h,{variant:"ghost",size:"sm",className:`btn-filter-send h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${Zs==="send"?"bg-green-600 text-white border-green-600":"text-green-700 border-green-300 hover:bg-green-50"}`,onClick:()=>On("send"),title:"تصفية التحويل",children:"التحويل"}),e.jsx(h,{variant:"ghost",size:"sm",className:`btn-filter-withdraw h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${Zs==="withdraw"?"bg-red-600 text-white border-red-600":"text-red-700 border-red-300 hover:bg-red-50"}`,onClick:()=>On("withdraw"),title:"تصفية السحب",children:"السحب"}),e.jsx(h,{variant:"ghost",size:"sm",className:`btn-filter-all h-8 px-4 text-[12px] min-w-[96px] rounded-full border ${Zs==="all"?"bg-green-600 text-white border-green-600":"text-green-700 border-green-300 hover:bg-green-50"}`,onClick:()=>On("all"),title:"عرض الكل",children:"الكل"}),e.jsxs("div",{className:"relative ml-1",children:[e.jsxs(h,{variant:"ghost",size:"sm",className:"h-8 px-3 text-[12px] rounded-full border bg-red-50 text-red-700 border-red-300 hover:bg-red-100",onClick:()=>ar(!0),title:"تصفير المعاملات الأخيرة",children:[e.jsx(Xt,{className:"h-3.5 w-3.5 mr-1"}),"تصفير"]}),Md>0&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 h-2 w-2 rounded-full bg-red-500 ring-2 ring-white"})]})]})})]}),e.jsx(as,{open:$c,onOpenChange:_r,mode:"verify",title:"فتح إدارة التقسيط",description:"أدخل الرقم السري الرئيسي للوصول إلى إدارة التقسيط",onSuccess:()=>{_r(!1),ll(!0)}}),e.jsx(Em,{open:Lc,onOpenChange:ll}),il,e.jsxs(Ft,{className:"space-y-2 pt-0 px-4 pb-4 relative z-10",children:[Si.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(pr,{className:"h-12 w-12 mx-auto mb-2 text-gray-300"}),e.jsx("p",{className:"text-sm",children:"لا توجد معاملات حتى الآن"})]}):F?e.jsx("div",{className:"overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400 transition-colors max-h-[310px]",children:e.jsx("div",{className:"space-y-2 pr-2",children:Si.map(t=>e.jsxs("div",{className:"receipts-row flex items-center justify-between p-3 rounded-lg border cursor-pointer transition-all duration-200",onClick:()=>Zl(t),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[t.status==="completed"&&e.jsx(wa,{className:`h-4 w-4 ${t.type==="withdraw"?"text-red-500":"text-green-500"}`}),t.status==="pending"&&e.jsx(ia,{className:"h-4 w-4 text-yellow-500"}),t.status==="failed"&&e.jsx(fn,{className:"h-4 w-4 text-red-500"})]}),e.jsxs("div",{children:[(()=>{const a=(t==null?void 0:t.type)==="report"||((t==null?void 0:t.title)||"").includes("إيصال تسليم وردية"),r=((t==null?void 0:t.title)||"").includes("إيصال إضافة نقدية");return e.jsx("p",{className:`font-medium text-sm ${a||r?"text-gray-800":t.type==="send"?"text-green-700":"text-red-700"}`,children:a?"إيصال تسليم وردية":r?`إيصال إضافة نقدية - ${Cs(t.amount)} جنيه`:(t.type==="send"?"تحويل":"سحب")+` - ${Cs(t.amount)} جنيه`})})(),e.jsxs("p",{className:"text-[10px] text-gray-700",children:["تمت بواسطة: ",(t==null?void 0:t.cashierName)??"الحساب الرئيسي"]}),(()=>{const a=(t==null?void 0:t.type)==="report"||((t==null?void 0:t.title)||"").includes("إيصال تسليم وردية"),r=((t==null?void 0:t.title)||"").includes("إيصال إضافة نقدية");return e.jsx("p",{className:`text-xs ${a||r?"text-gray-500":t.type==="send"?"text-green-600":"text-red-500"}`,children:a?`تم التسليم إلى: ${t.receiverPhone}`:r?t.notes?`ملاحظة: ${t.notes}`:"تمت إضافة نقدية للدرج":`من ${t.senderPhone}${t.type==="send"?` إلى ${t.receiverPhone}`:""}`})})(),e.jsxs("p",{className:"text-xs text-gray-400",children:[on.format(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt))," - ",to.format(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt))]})]})]}),e.jsx(qt,{variant:t.status==="completed"?"default":t.status==="pending"?"secondary":"destructive",className:`text-xs ${t.status==="completed"?t.type==="withdraw"?"bg-red-100 text-red-700 border-red-300":t.type==="send"?"bg-green-100 text-green-700 border-green-300":"":""}`,children:t.status==="completed"?"مكتمل":t.status==="pending"?"قيد المعالجة":"فشل"})]},t.id))})}):e.jsx("div",{className:"overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400 transition-colors max-h-[calc(100dvh-300px)]",children:e.jsx("div",{className:"space-y-2 pr-2",children:Si.map(t=>e.jsxs("div",{className:"receipts-row flex items-center justify-between p-3 rounded-lg border cursor-pointer transition-all duration-200",onClick:()=>Zl(t),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[t.status==="completed"&&e.jsx(wa,{className:`h-4 w-4 ${t.type==="withdraw"?"text-red-500":"text-green-500"}`}),t.status==="pending"&&e.jsx(ia,{className:"h-4 w-4 text-yellow-500"}),t.status==="failed"&&e.jsx(fn,{className:"h-4 w-4 text-red-500"})]}),e.jsxs("div",{children:[(()=>{const a=(t==null?void 0:t.type)==="report"||((t==null?void 0:t.title)||"").includes("إيصال تسليم وردية"),r=((t==null?void 0:t.title)||"").includes("إيصال إضافة نقدية");return e.jsx("p",{className:`font-medium text-sm ${a||r?"text-gray-800":t.type==="send"?"text-green-700":"text-red-700"}`,children:a?"إيصال تسليم وردية":r?`إيصال إضافة نقدية - ${Cs(t.amount)} جنيه`:(t.type==="send"?"تحويل":"سحب")+` - ${Cs(t.amount)} جنيه`})})(),e.jsxs("p",{className:"text-[10px] text-gray-700",children:["تمت بواسطة: ",(t==null?void 0:t.cashierName)??"الحساب الرئيسي"]}),(()=>{const a=(t==null?void 0:t.type)==="report"||((t==null?void 0:t.title)||"").includes("إيصال تسليم وردية"),r=((t==null?void 0:t.title)||"").includes("إيصال إضافة نقدية");return e.jsx("p",{className:`text-xs ${a||r?"text-gray-500":t.type==="send"?"text-green-600":"text-red-500"}`,children:a?`تم التسليم إلى: ${t.receiverPhone}`:r?t.notes?`ملاحظة: ${t.notes}`:"تمت إضافة نقدية للدرج":`من ${t.senderPhone}${t.type==="send"?` إلى ${t.receiverPhone}`:""}`})})(),e.jsxs("p",{className:"text-xs text-gray-400",children:[on.format(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt))," - ",to.format(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt))]})]})]}),e.jsx(qt,{variant:t.status==="completed"?"default":t.status==="pending"?"secondary":"destructive",className:`text-xs ${t.status==="completed"?t.type==="withdraw"?"bg-red-100 text-red-700 border-red-300":t.type==="send"?"bg-green-100 text-green-700 border-green-300":"":""}`,children:t.status==="completed"?"مكتمل":t.status==="pending"?"قيد المعالجة":"فشل"})]},t.id))})}),F&&e.jsxs("div",{className:"mt-2 flex justify-end",children:[e.jsxs(h,{variant:"ghost",size:"sm",className:"h-7 px-2 text-[11px] rounded-full border bg-red-50 text-red-700 border-red-300 hover:bg-red-100",onClick:()=>ar(!0),title:"تصفير المعاملات الأخيرة",children:[e.jsx(Xt,{className:"h-3 w-3 mr-1"}),"تصفير"]}),(s==null?void 0:s.uid)&&localStorage.getItem(`recentTransactionsResetAt:${s.uid}`)&&e.jsx("span",{className:"inline-block h-1.5 w-1.5 rounded-full bg-red-500 ml-1 align-middle"})]})]})]})]}),e.jsx(Fm,{isOpen:Dc,onClose:()=>Tr(!1),transaction:Cc,onPrint:()=>window.print(),onDelete:kc,onComplete:Oc}),e.jsxs("div",{className:"space-y-1 fade-in-right w-full lg:w-[92%] xl:w-[95%] mx-auto",children:[e.jsxs(Tt,{id:"transaction-section",className:"bg-gradient-to-br from-white via-blue-50/30 to-indigo-50/50 border border-blue-200/40 rounded-lg shadow-lg hover:shadow-lg transition-all duration-200 group relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/5 via-indigo-500/3 to-purple-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-200"}),e.jsx("div",{className:"absolute top-0 right-0 w-32 h-32 sm:w-28 sm:h-28 lg:w-20 lg:h-20 bg-gradient-to-bl from-blue-400/10 to-transparent rounded-full  "}),e.jsx("div",{className:"absolute bottom-0 left-0 w-24 h-24 bg-gradient-to-tr from-indigo-400/10 to-transparent rounded-full  ",style:{animationDelay:"1s"}}),e.jsx(es,{className:"sticky top-0 z-20 bg-white/80 backdrop-blur supports-[backdrop-filter]:bg-white/60 pb-0.5 px-3 pt-1 lg:pt-0.5 lg:pb-0.5 lg:px-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(us,{className:"text-sm font-bold flex items-center gap-2 text-gray-800",children:[e.jsxs("div",{className:"relative",children:[e.jsx(wa,{className:"h-1 w-1 text-emerald-500 "}),e.jsx("div",{className:"absolute inset-0 h-1 w-1 bg-emerald-400 rounded-full opacity-20 "})]}),e.jsx("span",{className:"bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent",children:"إجراء معاملة جديدة"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[we&&e.jsx("div",{className:"hidden md:flex items-center gap-1 bg-gradient-to-r from-emerald-50 to-green-50 hover:from-emerald-100 hover:to-green-100 border border-emerald-200 text-emerald-800 text-sm transition-all duration-300 hover:scale-105 h-9 px-3 rounded-xl shadow-sm",children:e.jsxs("span",{className:"text-sm font-semibold whitespace-nowrap",children:["تجربة: ",ce," ",ce>=3&&ce<=10?"ساعات":ce===2?"ساعتين":"ساعة"]})}),e.jsxs("div",{className:"top-icons-bar hidden md:flex items-center gap-2 bg-gradient-to-r from-gray-50 to-slate-50 hover:from-gray-100 hover:to-slate-100 border border-gray-200 transition-all duration-300 hover:scale-105 h-9 px-3 rounded-xl shadow-sm",children:[e.jsx(uh,{}),e.jsx(h,{variant:"ghost",size:"icon",className:"h-8 w-8",title:"إدارة الفروع",onClick:()=>{i({title:"قيد التطوير",description:"الميزة غير متاحة حالياً"})},children:e.jsx(Wo,{className:"h-5 w-5"})}),e.jsx(Om,{})]})]}),Ld&&e.jsxs(h,{variant:"outline",size:"sm",className:"hidden flex items-center gap-1.5 sm:gap-2 bg-gradient-to-r from-cyan-50 to-blue-50 hover:from-cyan-100 hover:to-blue-100 border-cyan-200 text-cyan-800 text-xs sm:text-sm transition-all duration-300 hover:scale-105 hover:shadow-lg h-10 sm:h-12 px-4 sm:px-5 rounded-xl min-w-[44px] touch-manipulation",onClick:Kl,title:"مزامنة البيانات المحفوظة محلياً مع الخادم",children:[e.jsx(Gm,{className:"h-3.5 w-3.5 sm:h-4 sm:w-4 animate-spin"}),e.jsx("span",{className:"text-xs sm:text-sm font-semibold whitespace-nowrap",children:"مزامنة"})]})]})}),e.jsx(ge,{open:ne,onOpenChange:xe,children:e.jsxs(fe,{className:"sm:max-w-lg",children:[e.jsxs(ye,{children:[e.jsx(ve,{children:"إدارة الفروع"}),e.jsx(is,{children:"أضف فروع جديدة وأدِر الدخول لكل فرع"}),e.jsx("div",{className:"flex items-center justify-end gap-2 mt-2",children:e.jsx(h,{variant:"outline",size:"sm",onClick:()=>{try{const t=s!=null&&s.uid?`selectedShopId_${s.uid}`:"selectedShopId";localStorage.removeItem(t);try{window.dispatchEvent(new Event("selectedShopIdChanged"))}catch{}i({title:"تم الخروج من الفرع"}),T(`/branch/${String(b.shopId)}/dashboard`)}catch{}},children:"الخروج من الفرع"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx(X,{children:"اسم المدير"}),e.jsx(z,{value:Oe,onChange:t=>Re(t.target.value),placeholder:"اكتب اسم المدير"})]}),e.jsxs("div",{children:[e.jsx(X,{children:"اسم الفرع"}),e.jsx(z,{value:Ce,onChange:t=>Le(t.target.value),placeholder:"اكتب اسم الفرع"})]}),e.jsxs("div",{children:[e.jsx(X,{children:"اسم المستخدم للدخول"}),e.jsx(z,{value:Ue,onChange:t=>at(t.target.value),placeholder:"مثال: branch1"})]}),e.jsxs("div",{children:[e.jsx(X,{children:"كلمة السر"}),e.jsx(z,{type:"password",value:Q,onChange:t=>de(t.target.value),placeholder:"••••••"})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(h,{variant:"outline",onClick:()=>{Re(""),Le(""),at(""),de("")},children:"مسح"}),e.jsx(h,{className:"bg-indigo-600 hover:bg-indigo-700",disabled:et,onClick:async()=>{if(!(s!=null&&s.uid))return;const t=Oe.trim(),a=Ce.trim(),r=Ue.trim(),l=Q.trim();if(!t||!a||!r||!l){i({title:"يرجى ملء جميع الحقول"});return}try{se(!0);let o="";try{o=(await _s(Te(H,"shops"),{name:a,ownerId:s.uid,createdAt:lt(),updatedAt:lt(),isActive:!0})).id}catch{o=(await _s(Te(H,"users",s.uid,"shops"),{name:a,ownerId:s.uid,createdAt:lt(),updatedAt:lt(),isActive:!0})).id}const m=x=>{try{return btoa(unescape(encodeURIComponent(x)))}catch{return btoa(x)}};try{await _s(Te(H,"branches"),{ownerId:s.uid,shopId:o,branchName:a,managerName:t,loginUsername:r,passwordEncoded:m(l),createdAt:lt()})}catch{await _s(Te(H,"users",s.uid,"branches"),{ownerId:s.uid,shopId:o,branchName:a,managerName:t,loginUsername:r,passwordEncoded:m(l),createdAt:lt()})}try{const x=st(Te(H,"branches"),ke("ownerId","==",s.uid));let I=(await ct(x)).docs.map(w=>({id:w.id,...w.data()}));if(I.length===0){const w=st(Te(H,"users",s.uid,"branches"));I=(await ct(w)).docs.map(R=>({id:R.id,...R.data()}))}te(I)}catch{try{const x=st(Te(H,"users",s.uid,"branches")),I=(await ct(x)).docs.map(w=>({id:w.id,...w.data()}));te(I)}catch{}}Re(""),Le(""),at(""),de(""),i({title:"تم إضافة الفرع بنجاح"})}catch{i({title:"تعذّر إضافة الفرع"})}finally{se(!1)}},children:"إضافة فرع"})]}),e.jsxs("div",{className:"border-t pt-3",children:[e.jsx("h4",{className:"text-sm font-semibold mb-2",children:"الفروع الحالية"}),et?e.jsx("div",{className:"text-sm text-gray-500",children:"جارٍ التحميل..."}):ie.length===0?e.jsx("div",{className:"text-sm text-gray-500",children:"لا يوجد فروع بعد"}):e.jsx("div",{className:"space-y-2",children:ie.map(t=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded-lg bg-white",children:[e.jsxs("div",{className:"text-sm",children:[e.jsx("div",{className:"font-medium",children:t.branchName}),e.jsxs("div",{className:"text-gray-600",children:["مدير: ",t.managerName]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(h,{size:"sm",className:"bg-blue-600 hover:bg-blue-700",onClick:()=>{Lt(t),je(String(t.loginUsername||"")),rt(""),ht(!0)},children:"دخول الفرع"}),e.jsx(h,{size:"sm",variant:"destructive",onClick:async()=>{if(confirm("هل أنت متأكد من حذف الفرع؟ سيتم حذف بيانات الفرع المرتبطة."))try{try{await hs(Qe(H,"branches",t.id))}catch{}try{await hs(Qe(H,"users",(s==null?void 0:s.uid)||"","branches",t.id))}catch{}if(t.shopId){try{await hs(Qe(H,"shops",String(t.shopId)))}catch{}try{await hs(Qe(H,"users",(s==null?void 0:s.uid)||"","shops",String(t.shopId)))}catch{}}te(a=>a.filter(r=>r.id!==t.id)),i({title:"تم حذف الفرع"})}catch{i({title:"تعذّر حذف الفرع"})}},children:"حذف الفرع"})]})]},t.id))})]})]})]})}),e.jsx(ge,{open:pe,onOpenChange:ht,children:e.jsxs(fe,{className:"sm:max-w-md",children:[e.jsxs(ye,{children:[e.jsx(ve,{children:"دخول الفرع"}),e.jsx(is,{children:"أدخل بيانات الدخول للفرع المحدد"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx(X,{children:"اسم المستخدم"}),e.jsx(z,{value:Vt,onChange:t=>je(t.target.value),placeholder:"اسم المستخدم"})]}),e.jsxs("div",{children:[e.jsx(X,{children:"كلمة السر"}),e.jsx(z,{type:"password",value:Ke,onChange:t=>rt(t.target.value),placeholder:"••••••"})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(h,{variant:"outline",onClick:()=>{je(""),rt("")},children:"مسح"}),e.jsx(h,{className:"bg-blue-600 hover:bg-blue-700",disabled:ue,onClick:async()=>{const t=Yt;if(!t){ht(!1);return}const a=String(t.loginUsername||"");let r="";try{const m=String(t.passwordEncoded||"");r=m?decodeURIComponent(escape(atob(m))):""}catch{try{r=t.passwordEncoded?atob(String(t.passwordEncoded)):""}catch{r=""}}const l=Vt.trim(),o=Ke.trim();if(!l||!o){i({title:"يرجى إدخال اسم المستخدم وكلمة السر"});return}if(l!==a||o!==r){i({title:"بيانات الدخول غير صحيحة",variant:"destructive"});return}try{nt(!0);const m=s!=null&&s.uid?`selectedShopId_${s.uid}`:"selectedShopId";localStorage.setItem(m,String(t.shopId)),i({title:"تم الدخول إلى الفرع",description:String(t.branchName||"")}),ht(!1),xe(!1),T("/user/dashboard")}catch{}nt(!1)},children:"دخول"})]})]})]})}),e.jsxs(Ft,{ref:u,className:"space-y-1 px-2 pb-2 relative z-10 transition-transform duration-200 ease-out will-change-transform",style:{transform:c?`translateY(${c}px)`:void 0},onFocusCapture:t=>{const a=t.target;if(!((a==null?void 0:a.id)==="transferExtraFeeInput")){g(0);return}const l=document.getElementById("transferSubmitButton");if(l){const o=l.getBoundingClientRect(),m=window.innerHeight;if(o.bottom>m){const x=o.bottom-m,f=Math.min(x,220);g(-f)}else g(0)}else g(0)},onBlurCapture:t=>{t.currentTarget.contains(t.relatedTarget)||g(0)},children:[e.jsxs("div",{className:"transaction-type-tabs grid grid-cols-2 gap-0.5 p-0.5 bg-gradient-to-r from-gray-50 to-slate-50 rounded-xl border border-gray-200/50 fade-in-up w-full lg:w-[92%] xl:w-[95%] mx-auto ",children:[e.jsxs(h,{variant:le==="transfer"?"default":"ghost",onClick:()=>ln("transfer"),className:`text-xs font-semibold transition-all duration-300 hover:scale-105 h-7 rounded-lg px-2 ${le==="transfer"?"bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg hover:shadow-md hover:from-blue-600 hover:to-indigo-700":"text-gray-600 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 hover:text-blue-700 hover:border-blue-200"}`,children:[e.jsx(pr,{className:"h-1 w-1 mr-1"}),"تحويل"]}),e.jsxs(h,{variant:le==="withdraw"?"default":"ghost",onClick:()=>ln("withdraw"),className:`text-xs font-semibold transition-all duration-300 hover:scale-105 h-7 rounded-lg px-2 ${le==="withdraw"?"bg-gradient-to-r from-emerald-500 to-green-600 text-white shadow-lg hover:shadow-md hover:from-emerald-600 hover:to-green-700":"text-gray-600 hover:bg-gradient-to-r hover:from-emerald-50 hover:to-green-50 hover:text-emerald-700 hover:border-emerald-200"}`,children:[e.jsx(yn,{className:"h-1 w-1 mr-1"}),"سحب"]})]}),e.jsxs("div",{className:"fade-in-up",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("label",{className:"text-sm font-semibold text-gray-700 block flex items-center gap-2",children:[e.jsx(Js,{className:"h-1 w-1 text-blue-600"}),"اختيار المحفظة"]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsxs(h,{variant:"ghost",size:"sm",className:"h-6 rounded-md px-2 text-[10px] bg-emerald-50 text-emerald-700 hover:bg-emerald-100 border border-emerald-200",onClick:()=>T("/user/add-wallet"),title:"إضافة محفظة",children:[e.jsx(ls,{className:"h-3 w-3 mr-1"}),"إضافة محفظة"]}),e.jsxs(h,{variant:"ghost",size:"sm",className:"h-6 rounded-md px-2 text-[10px] bg-indigo-50 text-indigo-700 hover:bg-indigo-100 border border-indigo-200",onClick:()=>{Dr(!0)},title:"المحافظ",children:[e.jsx(Js,{className:"h-3 w-3 mr-1"}),"المحافظ"]})]})]}),Ye.length>0?e.jsxs(xa,{value:ae,onValueChange:Ud,children:[e.jsx(pa,{"data-testid":"wallet-select",className:"selected-number-card w-full h-12 text-sm bg-gradient-to-r from-white to-gray-50 border-2 border-gray-200 hover:border-blue-400 focus:border-blue-500 rounded-xl transition-all duration-300 hover:shadow-md focus:shadow-lg",children:e.jsx(ga,{placeholder:"اختر محفظة للمعاملة",className:"text-gray-600"})}),e.jsxs(fa,{className:"rounded-xl border-2 border-gray-200 shadow-md z-[9999]",children:[e.jsx("div",{"data-fixed-header":"true",className:"sticky top-0 z-10 bg-white p-2 border-b border-gray-200",children:e.jsx(z,{value:Ki,onChange:t=>Nc(t.target.value),placeholder:"ابحث برقم المحفظة",className:"h-6 text-xs"})}),e.jsx("div",{className:"pr-1",children:Yi.length===0?e.jsx("div",{className:"text-xs text-gray-500 p-2",children:"لا توجد نتائج مطابقة"}):Yi.map(t=>e.jsx(Bs,{value:t.id,className:"rounded-lg hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 transition-all duration-200",children:e.jsxs("div",{className:"flex items-center gap-1 py-1 w-full justify-between",children:[e.jsx("div",{className:"p-1 bg-gradient-to-r from-blue-100 to-indigo-100 rounded-lg",children:e.jsx(Js,{className:"h-1 w-1 text-blue-600"})}),e.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"text-sm font-medium text-gray-800",children:t.name}),e.jsxs("span",{className:"text-sm font-semibold text-red-600",children:["(",t.phone,")"]})]}),t.isDefault&&e.jsx(qt,{variant:"secondary",className:"text-[10px] bg-gradient-to-r from-emerald-100 to-green-100 text-emerald-700 border-emerald-200",children:"افتراضي"})]}),e.jsx("div",{className:"ml-auto flex flex-col items-end gap-1"})]})},t.id))})]})]}):e.jsx("div",{className:"rounded-xl border-2 border-dashed border-gray-200 bg-gray-50 px-3 py-3 text-xs text-gray-600",children:"لا توجد محافظ حتى الآن. اضغط “إضافة محفظة” لإضافة أول محفظة."})]}),e.jsx(ge,{open:hc,onOpenChange:Bi,children:e.jsxs(fe,{className:"sm:max-w-3xl w-[95vw] sm:w-auto max-h-[80vh] overflow-y-auto",children:[e.jsx(ye,{children:e.jsx(ve,{children:"عرض المحافظ"})}),e.jsx("div",{className:"mt-2",children:e.jsx(Km,{showAddButton:!1,showUsageBars:!1,showLimitCards:!1,showEditButton:!0})})]})}),e.jsx(as,{open:uc,onOpenChange:Dr,mode:"verify",title:"الرقم السري لفتح المحافظ",description:"أدخل الرقم السري الرئيسي لعرض وإدارة المحافظ",onSuccess:()=>{Dr(!1),Bi(!0)},userId:s==null?void 0:s.uid}),e.jsx(as,{open:xc,onOpenChange:t=>{In(t),t||An(null)},mode:"verify",title:"تأكيد تغيير المحفظة",description:"أدخل الرقم السري الرئيسي لتغيير المحفظة المختارة",onSuccess:()=>{Ui&&(cr(Ui,"walletSelectionPin"),An(null)),In(!1)},userId:s==null?void 0:s.uid}),e.jsx(ge,{open:gc,onOpenChange:Cr,children:e.jsxs(fe,{className:"sm:max-w-md",children:[e.jsx(ye,{children:e.jsxs(ve,{className:"flex items-center gap-2 text-red-700",children:[e.jsx(mo,{className:"h-5 w-5 text-red-600"}),"تحذير حد شهري للمحفظة"]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"p-3 rounded-md border bg-red-50 border-red-200",children:[e.jsxs("p",{className:"text-sm text-red-800",children:["المحفظة: ",e.jsx("span",{className:"font-semibold",children:(As==null?void 0:As.walletName)||""})]}),e.jsxs("p",{className:"text-sm text-red-800",children:["الاستخدام الشهري (",(As==null?void 0:As.type)==="withdraw"?"سحب":"تحويل","):",e.jsxs("span",{className:"font-mono",children:[" ",Number((As==null?void 0:As.used)||0).toLocaleString("en-US")," "]})," جنيه"]}),e.jsxs("p",{className:"text-sm text-red-800",children:["الحد الشهري: ",e.jsx("span",{className:"font-mono",children:Number((As==null?void 0:As.limit)||0).toLocaleString("en-US")})," جنيه"]}),e.jsx("p",{className:"text-sm font-semibold text-red-900 mt-1",children:"تم الوصول إلى 85% من الحد الشهري — يرجى الحذر قبل الاستمرار."})]}),e.jsx("div",{className:"flex justify-end gap-2",children:e.jsx(h,{variant:"outline",onClick:()=>Cr(!1),children:"حسناً"})})]})]})}),ae&&Ye.length>0&&(()=>{var Ae;const t=Ye.find(We=>We.id===ae),a=ta,r=Vd(ae),l=(tt==null?void 0:tt.monthlyWithdrawLimit)??(t==null?void 0:t.monthlyWithdrawalLimit)??2e5,o=(tt==null?void 0:tt.monthlyTransferLimit)??(t==null?void 0:t.monthlyTransferLimit)??2e5,m=a.totalWithdrawn??(tt==null?void 0:tt.monthlyWithdrawUsed)??0,x=a.totalTransferred??(tt==null?void 0:tt.monthlyTransferUsed)??0,f=((Ae=gt==null?void 0:gt.subscription)==null?void 0:Ae.planType)===ms.TAHWEELA,I=f?0:(tt==null?void 0:tt.dailyWithdrawLimit)??1e5,w=f?0:(tt==null?void 0:tt.dailyTransferLimit)??6e4,j=f?0:r.totalWithdrawn??(tt==null?void 0:tt.dailyWithdrawUsed)??0,R=f?0:r.totalTransferred??(tt==null?void 0:tt.dailyTransferUsed)??0,L=parseFloat(Gt||"0")||0,V=m+(le==="withdraw"?L:0),Pe=x+(le==="transfer"?L:0),It=j+(le==="withdraw"?L:0),Ge=R+(le==="transfer"?L:0);return t?e.jsxs("div",{className:"fade-in-up mb-2 space-y-2",children:[e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-1 rounded-md border border-gray-200 shadow-sm hover:shadow-md transition-all duration-300",children:[e.jsxs("div",{className:"text-[10px] text-gray-600 font-medium mb-1 text-center",children:["الحدود الشهرية: ",t.name]}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-red-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-red-400 to-red-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(V/Math.max(l,1)*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-blue-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-400 to-blue-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(Pe/Math.max(o,1)*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-[10px] text-red-600 font-medium",children:["متبقي سحب: ",Math.max(l-V,0).toLocaleString("en-US")," جنيه"]}),e.jsxs("div",{className:"text-[10px] text-blue-600 font-medium",children:["متبقي تحويل: ",Math.max(o-Pe,0).toLocaleString("en-US")," جنيه"]})]})]}),e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 p-1 rounded-md border border-gray-200 shadow-sm hover:shadow-md transition-all duration-300",children:[e.jsxs("div",{className:"text-[10px] text-gray-600 font-medium mb-1 text-center",children:["الحدود اليومية: ",t.name]}),e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-1 overflow-hidden flex",children:[e.jsx("div",{className:"w-1/2 bg-orange-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-orange-400 to-orange-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(It/Math.max(I,1)*100,100)}%`}})}),e.jsx("div",{className:"w-1/2 bg-green-200 relative",children:e.jsx("div",{className:"bg-gradient-to-r from-green-400 to-green-600 h-1 transition-all duration-200 ease-out shadow-sm",style:{width:`${Math.min(Ge/Math.max(w,1)*100,100)}%`}})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-0.5",children:[e.jsxs("div",{className:"text-[10px] text-orange-600 font-medium",children:["متبقي سحب يومي: ",Math.max(I-It,0).toLocaleString("en-US")," جنيه"]}),e.jsxs("div",{className:"text-[10px] text-green-600 font-medium",children:["متبقي تحويل يومي: ",Math.max(w-Ge,0).toLocaleString("en-US")," جنيه"]})]})]})]}):null})(),le==="transfer"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المرسل"}),e.jsxs("div",{className:"relative",children:[e.jsx(na,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(z,{value:Ut,onChange:t=>Ws(t.target.value),onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("receiverPhoneInput");if(a)a.focus();else{const r=document.getElementById("amountInput");r==null||r.focus()}}},placeholder:"01030302038",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]})]}),!$&&e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المستقبل"}),e.jsxs("div",{className:"relative",children:[e.jsx(na,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(z,{id:"receiverPhoneInput",value:Ns,onChange:t=>{Na(t.target.value),Wn&&Wa(!1)},onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("amountInput");a==null||a.focus()}},inputMode:"numeric",maxLength:11,placeholder:"أدخل رقم المستقبل",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رقم المستقبل"}),e.jsxs("div",{className:"relative",children:[e.jsx(na,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(z,{value:ae&&((ao=Ye.find(t=>t.id===ae))==null?void 0:ao.phone)||"",readOnly:!0,placeholder:"اختر محفظة أولاً",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base bg-gray-50 transition-all duration-300"})]})]}),le==="transfer"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"المبلغ (جنيه)"}),e.jsxs("div",{className:"relative flex items-center gap-2",children:[e.jsx($t,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(z,{id:"amountInput",value:Gt,onChange:t=>{ca(t.target.value),Wn&&Wa(!1)},onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("transferCommissionInput");if(a)a.focus();else{const r=document.getElementById("quickDebtButton");r==null||r.focus()}}},placeholder:"أدخل المبلغ",type:"number",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),Ms?e.jsxs("div",{className:"mt-2 text-xs text-green-700 bg-green-50 border border-green-200 rounded px-2 py-1 flex items-center gap-2",children:[e.jsxs("span",{children:["تم إدخال تفاصيل الأجل لـ ",Ms.debtorName," بمبلغ ",Ms.amount," جنيه"]}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"h-6 px-2",onClick:()=>Cn(null),children:"إلغاء"})]}):null]}),(()=>{if($)return null;const t=ss();return t&&t.defaultTransferCommission!=null?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة التحويل (تلقائية)"}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["سيتم تطبيق عمولة التحويل الافتراضية لكل ألف: ",t==null?void 0:t.defaultTransferCommission," جنيه لكل ألف"]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(h,{id:"quickDebtButton",type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const r=ss(),l=(r==null?void 0:r.defaultTransferCommission)!=null?Number(r.defaultTransferCommission):0,o=parseFloat(Gt||"0")||0,m=Math.round((l||0)*o/1e3*100)/100,x=o+m;Sa((x||0).toString()),yt?i({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):Fa(!0)},children:"أجل"}),e.jsx(h,{type:"button",variant:"outline",size:"icon",className:"hidden",title:ut?"العمولة تُضاف":"العمولة تُخصم",children:ut?e.jsx(ls,{className:"h-4 w-4 text-green-600"}):e.jsx(ka,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"hidden",children:ut?"العمولة تُضاف":"العمولة تُخصم"})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة التحويل على العملية (جنيه)"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx($t,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-orange-500"}),e.jsx(z,{id:"transferCommissionInput",value:ps,onChange:r=>Pn(r.target.value),placeholder:"أدخل عمولة التحويل",type:"number",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),e.jsx(h,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const r=ss(),l=parseFloat(Gt||"0")||0;let o=0;if((r==null?void 0:r.defaultTransferCommission)!=null){const x=Number(r.defaultTransferCommission)||0;o=Math.round(x*l/1e3*100)/100}else{const x=ps&&ps.trim()!==""?parseFloat(ps):0;o=Math.max(0,x)}const m=l+o;Sa((m||0).toString()),yt?i({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):Fa(!0)},children:"أجل"}),e.jsx(h,{type:"button",variant:"outline",size:"icon",className:"hidden",title:ut?"العمولة تُضاف":"العمولة تُخصم",children:ut?e.jsx(ls,{className:"h-4 w-4 text-green-600"}):e.jsx(ka,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"hidden",children:ut?"العمولة تُضاف":"العمولة تُخصم"})]}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"يمكنك إدخال عمولة العملية الإجمالية (اختياري)"})]})})(),(()=>{const t=Ir(Ut||"").replace(/\D/g,""),a=Ir(Ns||"").replace(/\D/g,"");return le==="transfer"&&(t.startsWith("010")&&(a.startsWith("011")||a.startsWith("012")||a.startsWith("015"))||t.startsWith("012")&&a.startsWith("010")||t.startsWith("011")&&a.startsWith("010")||t.startsWith("015")&&a.startsWith("010"))?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"رسوم التحويل (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx($t,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-orange-500"}),e.jsx(z,{id:"transferExtraFeeInput",value:zi,onChange:l=>pc(l.target.value),placeholder:"أدخل رسوم التحويل",type:"number",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),e.jsx("div",{className:"hidden",children:"تُخصم من المحفظة وتضاف للدرج — لعمليات 010 → 011/012/015 أو 012 → 010 أو 011 → 010 أو 015 → 010"})]}):null})(),e.jsx("div",{className:"sticky bottom-0 z-10 pt-2 bg-white/80 backdrop-blur supports-[backdrop-filter]:bg-white/60",children:e.jsx(h,{id:"transferSubmitButton",onClick:eo,className:"btn-transfer-confirm w-full font-medium h-11 lg:h-12 text-sm lg:text-base btn-bounce hover-glow transition-all duration-300 text-white",children:Wn?"تم التحويل بنجاح":"تأكيد التحويل"})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"مبلغ السحب (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx(yn,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-green-500"}),e.jsx(z,{id:"amountInput",value:Gt,onChange:t=>{ca(t.target.value),al&&Ga(!1)},onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("manualWithdrawCommissionInput");if(a)a.focus();else{const r=document.getElementById("withdrawSubmitButton");r==null||r.focus()}}},placeholder:"أدخل مبلغ السحب",type:"number",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]})]}),(()=>{const t=ss();return t&&t.defaultWithdrawCommission!=null?e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة السحب (تلقائية)"}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["سيتم تطبيق عمولة السحب الافتراضية لكل ألف: ",t==null?void 0:t.defaultWithdrawCommission," جنيه لكل ألف"]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(h,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const r=ss(),l=parseFloat(Gt||"0")||0,o=(r==null?void 0:r.defaultWithdrawCommission)!=null&&Number(r.defaultWithdrawCommission)||0,m=Math.round(o*l/1e3*100)/100,x=ut?l+m:l;Sa((x||0).toString()),yt?i({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):Fa(!0)},children:"أجل"}),e.jsx(h,{type:"button",variant:"outline",size:"icon",className:"h-8 w-8",onClick:()=>kn(r=>!r),title:ut?"العمولة تُضاف إلى الدين":"العمولة تُخصم من الدين",children:ut?e.jsx(ls,{className:"h-4 w-4"}):e.jsx(ka,{className:"h-4 w-4"})}),e.jsx("span",{className:"text-xs text-gray-600",children:ut?"العمولة تُضاف":"العمولة تُخصم"})]})]}):e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"عمولة السحب على العملية (جنيه)"}),e.jsxs("div",{className:"relative",children:[e.jsx($t,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-orange-500"}),e.jsx(z,{id:"manualWithdrawCommissionInput",value:xs,onChange:r=>Tn(r.target.value),onKeyDown:r=>{if(r.key==="Enter"){const l=document.getElementById("withdrawSubmitButton");l==null||l.focus()}},placeholder:"أدخل العمولة المطلوبة",type:"number",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"أدخل العمولة الإجمالية لإتمام عملية السحب"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(h,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",onClick:()=>{const r=ss(),l=parseFloat(Gt||"0")||0;let o=0;if((r==null?void 0:r.defaultWithdrawCommission)!=null){const x=Number(r.defaultWithdrawCommission)||0;o=Math.round(x*l/1e3*100)/100}else{const x=xs&&xs.trim()!==""?parseFloat(xs):Math.round(l*.01*100)/100;o=Math.max(0,x)}const m=ut?l+o:l;Sa((m||0).toString()),yt?i({title:"غير متاح",description:"الأجل السريع غير متاح في خطة زيرو. قم بالترقية.",variant:"destructive"}):Fa(!0)},children:"أجل"}),e.jsx(h,{type:"button",variant:"outline",size:"icon",title:ut?"العمولة تُضاف":"العمولة تُخصم",onClick:()=>kn(r=>!r),children:ut?e.jsx(ls,{className:"h-4 w-4 text-green-600"}):e.jsx(ka,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"text-xs text-gray-600",children:ut?"العمولة تُضاف":"العمولة تُخصم"})]})]})})(),(C==null?void 0:C.showWithdrawNote)&&e.jsxs("div",{className:"fade-in-up",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"ملاحظة السحب (اختياري)"}),e.jsxs("div",{className:"relative",children:[e.jsx(fm,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-1 w-1 text-gray-400"}),e.jsx(z,{id:"withdrawNoteInput",value:ja,onChange:t=>Mi(t.target.value),onKeyDown:t=>{if(t.key==="Enter"){const a=document.getElementById("withdrawSubmitButton");a==null||a.focus()}},placeholder:"أدخل ملاحظة للسحب (اختياري)",className:"pl-10 h-10 md:h-11 lg:h-12 text-sm lg:text-base transition-all duration-300 hover:border-blue-400 focus:border-blue-500"})]})]}),e.jsx("div",{className:"sticky bottom-0 z-10 pt-2 bg-white/80 backdrop-blur supports-[backdrop-filter]:bg-white/60",children:e.jsx(h,{id:"withdrawSubmitButton",onClick:eo,className:"w-full font-medium h-11 lg:h-12 text-sm lg:text-base btn-bounce hover-glow transition-all duration-300 bg-green-600 hover:bg-green-700 text-white",children:al?"تم السحب بنجاح":"تأكيد السحب"})})]}),e.jsx(ge,{open:Nn,onOpenChange:Fa,children:e.jsxs(fe,{children:[e.jsxs(ye,{children:[e.jsx(ve,{children:"تحويل مؤجل"}),e.jsx(is,{children:"أدخل بيانات صاحب الدين والمبلغ والملاحظات ثم اضغط حفظ"})]}),e.jsxs("div",{className:"space-y-3",children:[ea&&ea.length>0?e.jsxs("div",{children:[e.jsx(X,{children:"اختيار عميل"}),e.jsxs(xa,{value:Dn,onValueChange:t=>{dc(t);const a=ea.find(r=>r.id===t);a&&Sn(a.name)},children:[e.jsx(pa,{className:"w-full",children:e.jsx(ga,{placeholder:"اختر عميل"})}),e.jsx(fa,{children:ea.map(t=>e.jsxs(Bs,{value:t.id,children:[t.name,t.mobile?` — ${t.mobile}`:""]},t.id))})]})]}):e.jsx("div",{className:"text-xs text-gray-500",children:"لا يوجد عملاء مُسجلين حالياً. يمكنك إضافة عميل من نافذة الديون."}),e.jsxs("div",{children:[e.jsx(X,{htmlFor:"quickDebtName",children:"اسم صاحب الدين"}),e.jsx(z,{id:"quickDebtName",value:jn,onChange:t=>Sn(t.target.value),placeholder:"اكتب الاسم"})]}),e.jsxs("div",{children:[e.jsx(X,{htmlFor:"quickDebtAmount",children:"المبلغ (محسوب تلقائياً)"}),e.jsx(z,{id:"quickDebtAmount",type:"number",value:cc,readOnly:!0,placeholder:"المبلغ + عمولة التحويل"})]}),e.jsxs("div",{children:[e.jsx(X,{htmlFor:"quickDebtNotes",children:"ملاحظات"}),e.jsx(z,{id:"quickDebtNotes",value:Ri,onChange:t=>$i(t.target.value),placeholder:"اكتب ملاحظات (اختياري)"})]})]}),e.jsx(dt,{children:e.jsx(h,{type:"button",variant:"default",className:"bg-green-600 text-white hover:bg-green-700",onClick:()=>{const t=ss(),a=parseFloat((Gt||"").toString())||0;let r=0;if(le==="transfer")if((t==null?void 0:t.defaultTransferCommission)!=null){const m=Number(t.defaultTransferCommission)||0;r=Math.round(m*a/1e3*100)/100}else{const m=ps&&ps.trim()!==""?parseFloat(ps):0;r=Math.max(0,m)}else if((t==null?void 0:t.defaultWithdrawCommission)!=null){const m=Number(t.defaultWithdrawCommission)||0;r=Math.round(m*a/1e3*100)/100}else{const m=xs&&xs.trim()!==""?parseFloat(xs):Math.round(a*.01*100)/100;r=Math.max(0,m)}let l=0;if(le==="withdraw"?l=ut?a:Math.max(0,Math.round((a-r)*100)/100):l=Math.max(0,Math.round((a+r)*100)/100),!jn||isNaN(l)||l<=0){i({title:"خطأ في بيانات الأجل",description:"يرجى إدخال الاسم والمبلغ بشكل صحيح",variant:"destructive"});return}const o=ea.find(m=>m.id===Dn);Cn({debtorName:jn,amount:l,notes:Ri,customerId:Dn||void 0,mobile:o==null?void 0:o.mobile}),Li(!1),Fa(!1),i({title:"تم حفظ بيانات الأجل",description:"سيتم إضافة الدين عند تأكيد العملية",variant:"default"})},children:"حفظ"})})]})})]})]}),e.jsx(Tt,{className:"bg-gradient-to-br from-red-50 to-red-100 border-red-200 fade-in-up card-float",children:e.jsxs(Ft,{className:"p-3 text-center",children:[e.jsx("div",{className:"text-red-600 font-medium text-[10px] mb-1",children:"⚠️ تحذير من التحويل"}),e.jsx("div",{className:"text-[10px] text-red-700",children:"لا يمكن إلغاء أي عملية بعد تأكيدها للمحافظة على الأمان"})]})})]})]}),e.jsx(nh,{isOpen:vc,onClose:()=>bc(!1),initialEditingWallet:wc,onWalletUpdate:async()=>{try{await or()}catch(t){console.error("Error reloading wallets after update:",t)}}}),e.jsx(ih,{isOpen:Sc,onClose:()=>Hi(!1),transaction:jc,onDelete:zd}),e.jsx(as,{open:Tc,onOpenChange:Ya,onSuccess:Kd,title:Yd(),description:Hd(),mode:"verify"}),e.jsx(yo,{open:ud,onOpenChange:Il,onSuccess:Qd,title:"تعديل الرصيد النقدي في الدرج",description:"أدخل الرقم السري والمبلغ الجديد لتعديل الرصيد النقدي في الدرج",currentBalance:Ct,balanceLabel:"الرصيد النقدي",userId:s==null?void 0:s.uid}),e.jsx(yo,{open:xd,onOpenChange:Al,onSuccess:Zd,title:"تعديل رصيد المحفظة",description:"أدخل الرقم السري والمبلغ الجديد لتعديل رصيد المحفظة",currentBalance:vs&&He[vs]||0,balanceLabel:`رصيد ${((ro=Ye.find(t=>t.id===vs))==null?void 0:ro.name)||"المحفظة"}`,userId:s==null?void 0:s.uid}),e.jsx(dh,{open:pd,onOpenChange:ii,onSuccess:Xd,title:"إضافة أو خصم مبلغ من رصيد المحفظة",description:"أدخل الرقم السري والمبلغ المراد إضافته أو خصمه من رصيد المحفظة",currentBalance:vs&&He[vs]||0,balanceLabel:`رصيد ${((no=Ye.find(t=>t.id===vs))==null?void 0:no.name)||"المحفظة"}`,userId:s==null?void 0:s.uid}),e.jsx(lh,{open:Ad,onOpenChange:Td,userId:s==null?void 0:s.uid}),e.jsx(oh,{open:Pd,onOpenChange:kd,userId:s==null?void 0:s.uid}),e.jsx(ch,{open:Od,onOpenChange:_d}),e.jsx(ge,{open:yd,onOpenChange:Ur,children:e.jsxs(fe,{className:"sm:max-w-md",children:[e.jsx(ye,{children:e.jsx(ve,{className:"text-right",children:"تعديل الدرج النقدية"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(X,{htmlFor:"amount",className:"text-right block",children:"المبلغ"}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx(z,{id:"amount",type:"number",placeholder:"أدخل المبلغ",value:oi,onChange:t=>zr(t.target.value),className:"text-right flex-1",dir:"rtl",min:"0"}),e.jsxs("div",{className:"flex gap-1",children:[e.jsxs(h,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 text-white px-3 py-2",onClick:async()=>{if(!await nn(yi)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}const t=parseFloat(oi);if(isNaN(t)||t<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const a=Ct+t;zt(a);const r={cashBalance:a,lastUpdated:new Date().toISOString()},l=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(l,JSON.stringify(r)),s!=null&&s.uid?Me.updateUserData(s.uid,r).then(()=>{console.log("✅ تم حفظ رصيد الدرج النقدي في Firebase بنجاح"),localStorage.removeItem(l),Be(!1)}).catch(o=>{console.error("❌ خطأ في حفظ الرصيد في Firebase:",o),Be(!0)}):Be(!0),i({title:"تم بنجاح",description:`تم إضافة ${t} جنيه إلى الدرج النقدية وحفظه في السحابة`}),Ur(!1),zr(""),Hr("")},children:[e.jsx(ls,{className:"h-1 w-1 mr-1"}),"إضافة"]}),e.jsxs(h,{type:"button",size:"sm",className:"bg-red-600 hover:bg-red-700 text-white px-3 py-2",onClick:async()=>{if(!await nn(yi)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}const t=parseFloat(oi);if(isNaN(t)||t<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const a=Ct-t;zt(a);const r={cashBalance:a,lastUpdated:new Date().toISOString()},l=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(l,JSON.stringify(r)),s!=null&&s.uid?Me.updateUserData(s.uid,r).then(()=>{console.log("✅ تم حفظ رصيد الدرج النقدي في Firebase بنجاح"),localStorage.removeItem(l),Be(!1)}).catch(o=>{console.error("❌ خطأ في حفظ الرصيد في Firebase:",o),Be(!0)}):Be(!0),i({title:"تم بنجاح",description:`تم خصم ${t} جنيه من الدرج النقدية وحفظه في السحابة`}),Ur(!1),zr(""),Hr("")},children:[e.jsx(ka,{className:"h-1 w-1 mr-1"}),"خصم"]})]})]}),e.jsxs("p",{className:"text-[10px] text-gray-500 text-right",children:["الرصيد الحالي: ",Ct.toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(X,{htmlFor:"pin",className:"text-right block",children:"الرقم السري"}),e.jsx(z,{id:"pin",type:"password",placeholder:"أدخل الرقم السري",value:yi,onChange:t=>Hr(t.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsx(dt,{className:"flex gap-2",children:e.jsx(h,{variant:"outline",onClick:()=>{Ur(!1),zr(""),Hr("")},children:"إلغاء"})})]})}),e.jsx(ge,{open:Rd,onOpenChange:sn,children:e.jsxs(fe,{className:"sm:max-w-md",children:[e.jsx(ye,{children:e.jsx(ve,{className:"text-right text-red-600",children:"تصفير إجمالي المحفظة"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-red-50 rounded-lg border border-red-200",children:[e.jsx("p",{className:"text-red-800 font-medium mb-2",children:"تحذير!"}),e.jsx("p",{className:"text-red-700 text-sm",children:"سيتم تصفير جميع أرصدة المحافظ إلى صفر. هذا الإجراء لا يمكن التراجع عنه."}),e.jsxs("p",{className:"text-red-600 text-sm mt-2",children:["الرصيد الحالي: ",Object.values(He).reduce((t,a)=>t+a,0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(X,{htmlFor:"resetWalletTotalPin",className:"text-right block",children:"الرقم السري الرئيسي"}),e.jsx(z,{id:"resetWalletTotalPin",type:"password",placeholder:"أدخل الرقم السري الرئيسي",value:Gl,onChange:t=>an(t.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsxs(dt,{className:"flex gap-2",children:[e.jsx(h,{variant:"outline",onClick:()=>{sn(!1),an("")},children:"إلغاء"}),e.jsx(h,{variant:"destructive",onClick:async()=>{if(!await os.verifyMasterPin(Gl,s==null?void 0:s.uid)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}try{const a={};Object.keys(He).forEach(m=>{a[m]=0}),ns(a),localStorage.setItem(Ss(),JSON.stringify(a)),sn(!1),an("");const r=new Date().toISOString(),l={walletBalances:a,lastUpdated:r},o=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(o,JSON.stringify(l)),s!=null&&s.uid?Me.updateUserData(s.uid,l).then(()=>{localStorage.removeItem(o),Be(!1)}).catch(m=>{console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",m),Be(!0),i({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):Be(!0),setTimeout(()=>{ns({...a})},100)}catch(a){console.error("خطأ في تصفير أرصدة المحافظ:",a),i({title:"خطأ",description:"حدث خطأ أثناء تصفير المحافظ",variant:"destructive"})}},children:"تصفير المحفظة"})]})]})}),e.jsx(ge,{open:gd,onOpenChange:Br,children:e.jsxs(fe,{className:"sm:max-w-md",children:[e.jsx(ye,{children:e.jsx(ve,{className:"text-right text-red-600",children:"تصفير رصيد المحفظة المختارة"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-red-50 rounded-lg border border-red-200",children:[e.jsx("p",{className:"text-red-800 font-medium mb-2",children:"تحذير!"}),e.jsx("p",{className:"text-red-700 text-sm",children:"سيتم تصفير رصيد المحفظة المحددة إلى صفر. هذا الإجراء لا يمكن التراجع عنه."}),e.jsxs("p",{className:"text-red-600 text-sm mt-2",children:["المحفظة: ",((io=Ye.find(t=>t.id===ae))==null?void 0:io.name)||ae]}),e.jsxs("p",{className:"text-red-600 text-sm",children:["الرصيد الحالي: ",(ae&&He[ae]?He[ae]:0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(X,{htmlFor:"resetSelectedWalletPin",className:"text-right block",children:"الرقم السري الرئيسي"}),e.jsx(z,{id:"resetSelectedWalletPin",type:"password",autoComplete:"off",placeholder:"أدخل الرقم السري الرئيسي",value:Tl,onChange:t=>li(t.target.value),className:"text-right",dir:"rtl"})]})]}),e.jsxs(dt,{className:"flex gap-2",children:[e.jsx(h,{variant:"outline",onClick:()=>{Br(!1),li("")},children:"إلغاء"}),e.jsx(h,{variant:"destructive",onClick:async()=>{var a;if(!ae){i({title:"اختر محفظة",description:"يرجى اختيار محفظة أولاً",variant:"destructive"});return}if(!await os.verifyMasterPin(Tl,s==null?void 0:s.uid)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}try{const r={...He};r[ae]=0,ns(r),localStorage.setItem(Ss(),JSON.stringify(r)),Br(!1),li("");const l=new Date().toISOString(),o={walletBalances:r,lastUpdated:l},m=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(m,JSON.stringify(o)),s!=null&&s.uid?Me.updateUserData(s.uid,o).then(()=>{localStorage.removeItem(m),Be(!1)}).catch(x=>{console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",x),Be(!0),i({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):Be(!0),i({title:"تم التصفير بنجاح",description:`تم تصفير رصيد المحفظة ${((a=Ye.find(x=>x.id===ae))==null?void 0:a.name)||ae}`})}catch(r){console.error("خطأ في تصفير رصيد المحفظة المختارة:",r),i({title:"خطأ",description:"حدث خطأ أثناء تصفير رصيد المحفظة المختارة",variant:"destructive"})}},children:"تصفير المحفظة"})]})]})}),e.jsx(ge,{open:Wd,onOpenChange:en,children:e.jsxs(fe,{className:"sm:max-w-md",children:[e.jsx(ye,{children:e.jsxs(ve,{className:"text-right text-green-600 flex items-center gap-2 justify-end",children:[e.jsx(ls,{className:"h-4 w-4"}),"إضافة أموال لإجمالي المحفظة"]})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"text-center p-4 bg-green-50 rounded-lg border border-green-200",children:[e.jsx("p",{className:"text-green-800 font-medium mb-2",children:"إضافة أموال"}),e.jsx("p",{className:"text-green-700 text-sm",children:"سيتم إضافة المبلغ المحدد إلى إجمالي المحفظة بشكل متناسب على جميع المحافظ."}),e.jsxs("p",{className:"text-green-600 text-sm mt-2",children:["الرصيد الحالي: ",Object.values(He).reduce((t,a)=>t+a,0).toLocaleString()," جنيه"]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"addWalletTotalAmount",className:"text-right block",children:"المبلغ المراد إضافته"}),e.jsx(z,{id:"addWalletTotalAmount",type:"number",placeholder:"أدخل المبلغ",value:zl,onChange:t=>bi(t.target.value),className:"text-right",dir:"rtl"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"addWalletTotalPin",className:"text-right block",children:"الرقم السري للتأكيد"}),e.jsx(z,{id:"addWalletTotalPin",type:"password",autoComplete:"off",placeholder:"أدخل الرقم السري",value:ql,onChange:t=>wi(t.target.value),className:"text-right",dir:"rtl"})]})]})]}),e.jsxs(dt,{className:"flex gap-2",children:[e.jsx(h,{variant:"outline",onClick:()=>{en(!1),bi(""),wi("")},children:"إلغاء"}),e.jsx(h,{variant:"default",className:"bg-green-600 hover:bg-green-700",disabled:Vl,onClick:async()=>{const t=parseFloat(zl);if(!t||t<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}if(!await Bd(ql)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}Jl(!0);try{const a=Object.values(He).reduce((r,l)=>r+l,0);if(a===0){const r=Object.keys(He),l=t/r.length,o={};r.forEach(m=>{o[m]=l}),ns(o),localStorage.setItem(Ss(),JSON.stringify(o)),s!=null&&s.uid?await Me.updateUserData(s.uid,{walletBalances:o,lastUpdated:new Date().toISOString()}):Be(!0)}else{const r={};Object.entries(He).forEach(([l,o])=>{const m=o/a,x=t*m;r[l]=o+x}),ns(r),localStorage.setItem(Ss(),JSON.stringify(r)),s!=null&&s.uid?await Me.updateUserData(s.uid,{walletBalances:r,lastUpdated:new Date().toISOString()}):Be(!0)}setTimeout(()=>{ns(r=>({...r}))},100),en(!1),bi(""),wi("")}catch(a){console.error("خطأ في حفظ أرصدة المحافظ في Firebase:",a),i({title:"خطأ",description:"حدث خطأ أثناء حفظ البيانات",variant:"destructive"})}finally{Jl(!1)}},children:Vl?"جاري الإضافة...":"إضافة الأموال"})]})]})}),e.jsx(ge,{open:$d,onOpenChange:rn,children:e.jsxs(fe,{className:"sm:max-w-[425px]",children:[e.jsx(ye,{children:e.jsxs(ve,{className:"text-red-600 flex items-center gap-2",children:[e.jsx(Xt,{className:"h-1 w-1"}),"تصفير الرصيد النقدي"]})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-3",children:e.jsx("p",{className:"text-sm text-red-700",children:"⚠️ تحذير: سيتم تصفير الرصيد النقدي في الدرج إلى صفر. هذا الإجراء لا يمكن التراجع عنه."})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(X,{htmlFor:"resetCashPin",children:"الرقم السري الرئيسي"}),e.jsx(z,{id:"resetCashPin",type:"password",autoComplete:"off",placeholder:"أدخل الرقم السري الرئيسي",value:Ni,onChange:t=>ji(t.target.value)})]})]}),e.jsxs(dt,{children:[e.jsx(h,{variant:"outline",onClick:()=>{rn(!1),ji("")},children:"إلغاء"}),e.jsx(h,{variant:"destructive",onClick:async()=>{if(!Ni){i({title:"خطأ",description:"يرجى إدخال الرقم السري",variant:"destructive"});return}if(!await os.verifyMasterPin(Ni,s==null?void 0:s.uid)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}try{zt(0),rn(!1),ji("");const a={cashBalance:0,lastUpdated:new Date().toISOString()};localStorage.setItem(Ds(),"0");const r=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(r,JSON.stringify(a)),s!=null&&s.uid?Me.updateUserData(s.uid,a).then(()=>{localStorage.removeItem(r),Be(!1)}).catch(l=>{console.error("خطأ في حفظ الرصيد في Firebase:",l),Be(!0),i({title:"تنبيه",description:"تم التصفير محلياً، سيتم المزامنة مع الخادم قريباً",variant:"default"})}):Be(!0)}catch(a){console.error("خطأ في تصفير الرصيد النقدي:",a),i({title:"خطأ",description:"حدث خطأ أثناء تصفير الرصيد النقدي",variant:"destructive"})}},children:"تصفير الرصيد"})]})]})}),e.jsx(gh,{open:Fd,onOpenChange:Ul,userId:s==null?void 0:s.uid,cashBalance:Ct,walletBalances:He,transactions:ft}),e.jsx(ge,{open:Ed,onOpenChange:rr,children:e.jsxs(fe,{className:"sm:max-w-[425px]",children:[e.jsx(ye,{children:e.jsxs(ve,{className:"text-green-600 flex items-center gap-2",children:[e.jsx(ls,{className:"h-4 w-4"}),"إضافة أموال للدرج"]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-3",children:e.jsx("p",{className:"text-sm text-green-700",children:"💰 سيتم إضافة المبلغ المحدد إلى الرصيد النقدي في الدرج"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"addCashAmount",children:"المبلغ المراد إضافته"}),e.jsx(z,{id:"addCashAmount",type:"number",placeholder:"أدخل المبلغ",value:Ta,onChange:t=>Gr(t.target.value),min:"0",step:"0.01"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{className:"text-right",children:"هل تريد إضافة ملاحظة؟"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(h,{type:"button",variant:ir==="yes"?"default":"outline",onClick:()=>lr("yes"),className:"flex-1",children:"نعم"}),e.jsx(h,{type:"button",variant:ir==="no"?"default":"outline",onClick:async()=>{if(lr("no"),!Ta||parseFloat(Ta)<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح أكبر من صفر",variant:"destructive"});return}if(!nr){i({title:"خطأ",description:"يرجى إدخال الرقم السري",variant:"destructive"});return}if(!await nn(nr)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}Zr(!0);try{const t=parseFloat(Ta),a=Ct+t;zt(a),localStorage.setItem(Ds(),a.toString());const r={cashBalance:a,lastUpdated:new Date().toISOString()},l=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(l,JSON.stringify(r));const o=`CASHADD-${(s==null?void 0:s.uid)||"anon"}-${Date.now()}`;rr(!1),Gr(""),Qr(""),lr(null),Xr("");const m=[];if(s!=null&&s.uid){m.push(Me.updateUserData(s.uid,r).then(()=>{localStorage.removeItem(l),Be(!1)}).catch(()=>{Be(!0)}));const x={txnType:"receive",amount:t,status:"confirmed",senderMsisdn:"إضافة نقدية",receiverMsisdn:"",reference:o,title:"إيصال إضافة نقدية",merchantUserId:s.uid,createdBy:s.uid,shopId:(C==null?void 0:C.shopId)||void 0};m.push(Me.saveUserTransaction(s.uid,x));const f=C==null?void 0:C.shopId;if(f){const I=Qe(H,"dashboardData",f);m.push(Vs(I,{cashBalance:a}))}}Promise.allSettled(m).then(()=>{}).catch(()=>{})}catch{zt(Ct),localStorage.setItem("cashBalance",Ct.toString()),i({title:"خطأ",description:"حدث خطأ أثناء حفظ البيانات، يرجى المحاولة مرة أخرى",variant:"destructive"})}finally{Zr(!1)}},className:"flex-1",children:"لا"})]})]}),ir==="yes"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"addCashNote",children:"الملاحظة"}),e.jsx(z,{id:"addCashNote",type:"text",placeholder:"اكتب الملاحظة",value:vi,onChange:t=>Xr(t.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"addCashPin",children:"الرقم السري لدرج النقدية"}),e.jsx(z,{id:"addCashPin",type:"password",placeholder:"أدخل الرقم السري",value:nr,onChange:t=>Qr(t.target.value)})]})]}),e.jsxs(dt,{children:[e.jsx(h,{variant:"outline",onClick:()=>{rr(!1),Gr(""),Qr(""),lr(null),Xr("")},children:"إلغاء"}),e.jsx(h,{variant:"default",className:"bg-green-600 hover:bg-green-700",disabled:Bl,onClick:async()=>{if(!Ta||parseFloat(Ta)<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح أكبر من صفر",variant:"destructive"});return}if(!nr){i({title:"خطأ",description:"يرجى إدخال الرقم السري",variant:"destructive"});return}if(!await nn(nr)){i({title:"خطأ",description:"الرقم السري غير صحيح",variant:"destructive"});return}if(ir==="yes"&&vi.trim().length===0){i({title:"تنبيه",description:"أدخل الملاحظة أو اختر لا",variant:"destructive"});return}Zr(!0);try{const t=parseFloat(Ta),a=Ct+t;zt(a),localStorage.setItem(Ds(),a.toString());const r={cashBalance:a,lastUpdated:new Date().toISOString()},l=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(l,JSON.stringify(r));const o=`CASHADD-${(s==null?void 0:s.uid)||"anon"}-${Date.now()}`;rr(!1),Gr(""),Qr(""),lr(null),Xr("");const m=[];if(s!=null&&s.uid){m.push(Me.updateUserData(s.uid,r).then(()=>{localStorage.removeItem(l),Be(!1)}).catch(()=>{Be(!0)}));const x={txnType:"receive",amount:t,status:"confirmed",senderMsisdn:"إضافة نقدية",receiverMsisdn:"",reference:o,note:ir==="yes"?vi.trim():void 0,title:"إيصال إضافة نقدية",merchantUserId:s.uid,createdBy:s.uid,shopId:(C==null?void 0:C.shopId)||void 0};m.push(Me.saveUserTransaction(s.uid,x));const f=C==null?void 0:C.shopId;if(f){const I=Qe(H,"dashboardData",f);m.push(Vs(I,{cashBalance:a}))}}Promise.allSettled(m).then(()=>{}).catch(()=>{})}catch{zt(Ct),localStorage.setItem("cashBalance",Ct.toString()),i({title:"خطأ",description:"حدث خطأ أثناء حفظ البيانات، يرجى المحاولة مرة أخرى",variant:"destructive"})}finally{Zr(!1)}},children:Bl?"جاري الإضافة...":"إضافة الأموال"})]})]})}),e.jsx(ge,{open:hd,onOpenChange:ni,children:e.jsxs(fe,{className:"sm:max-w-md",children:[e.jsx(ye,{children:e.jsx(ve,{className:"text-right",children:"اختيار التاريخ والوقت للبحث"})}),e.jsxs("div",{className:"space-y-1 py-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(X,{htmlFor:"search-date",className:"text-right block",children:"التاريخ"}),e.jsx(z,{id:"search-date",type:"date",value:kr,onChange:t=>tl(t.target.value),className:"text-right"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(X,{htmlFor:"search-time",className:"text-right block",children:"الوقت (اختياري)"}),e.jsx(z,{id:"search-time",type:"time",value:Or,onChange:t=>sl(t.target.value),className:"text-right",placeholder:"اختر الوقت للبحث في ساعة محددة"}),e.jsx("p",{className:"text-[10px] text-gray-500 text-right",children:"إذا لم تختر وقتاً محدداً، سيتم البحث في كامل اليوم"})]})]}),e.jsxs(dt,{className:"flex justify-between",children:[e.jsx(h,{variant:"outline",onClick:()=>{tl(""),sl(""),ni(!1)},children:"مسح"}),e.jsx(h,{onClick:()=>ni(!1),children:"تطبيق"})]})]})}),e.jsx(bo,{isOpen:ts&&!wt,onClose:()=>Ht(!1),onTrialStarted:dd}),e.jsx(xh,{isOpen:Rc,onClose:()=>Rn(!1)}),e.jsx(ph,{isOpen:_n,onClose:()=>Ja(!1),initialBarcode:fc}),e.jsx(Wm,{isOpen:Bc,onClose:()=>Er(!1)}),e.jsx(Mm,{open:Uc,onOpenChange:Fr}),e.jsx(kh,{open:zc,onOpenChange:t=>{if(t&&!qs){i({title:"غير متاح",description:"يومية المكنة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة.",variant:"destructive"});return}Wr(t)}}),e.jsx(Rh,{open:G,onOpenChange:t=>{if(t&&!qs){i({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}Z(t)}}),e.jsx($h,{open:re,onOpenChange:t=>{if(t&&!qs){i({title:"غير متاح",description:"هذه الميزة متاحة للاشتراكات: شهري، ربع سنوي، سنوي، ومدى الحياة. يرجى تفعيل اشتراكك.",variant:"destructive"});return}_(t)}}),e.jsx(as,{open:bd,onOpenChange:Fl,onSuccess:()=>mi(!0),title:"تقاريرك",description:"أدخل الرقم السري الرئيسي للوصول إلى تقاريرك",mode:"verify"}),e.jsx(ge,{open:di,onOpenChange:mi,children:e.jsxs(fe,{className:"sm:max-w-xl",children:[e.jsxs(ye,{children:[e.jsxs(ve,{className:"flex items-center gap-2",children:[e.jsx(po,{className:"h-4 w-4 text-blue-600"}),"تقارير اليوم"]}),e.jsx(is,{children:"ملخص معاملات اليوم محفوظ لآخر 30 يومًا مع أرشفة في السحابة"})]}),e.jsxs("div",{className:"space-y-4",children:[(()=>{const t=new Date().toDateString(),a=ft.filter(f=>{const I=new Date(f.createdAt).toDateString(),w=String(f.status||"completed").toLowerCase();return I===t&&(w==="completed"||w==="confirmed")}),r=a.length,l=a.reduce((f,I)=>f+Number(I.amount||0),0),o=a.filter(f=>f.type==="withdraw").reduce((f,I)=>f+Number(I.amount||0),0),m=a.filter(f=>f.type==="send").reduce((f,I)=>f+Number(I.amount||0),0),x=a.reduce((f,I)=>f+Number(ds.calculateTransactionProfit(I)||0),0);return e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded-lg p-3 bg-gradient-to-r from-blue-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-blue-700",children:"عدد المعاملات"}),e.jsx("div",{className:"text-lg font-bold text-blue-800",children:r})]}),e.jsxs("div",{className:"rounded-lg p-3 bg-gradient-to-r from-indigo-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-indigo-700",children:"إجمالي المبالغ"}),e.jsx("div",{className:"text-lg font-bold text-indigo-800",children:Number(l).toFixed(2)})]}),e.jsxs("div",{className:"rounded-lg p-3 bg-gradient-to-r from-red-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-red-700",children:"المبالغ المسحوبة"}),e.jsx("div",{className:"text-lg font-bold text-red-800",children:Number(o).toFixed(2)})]}),e.jsxs("div",{className:"rounded-lg p-3 bg-gradient-to-r from-green-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-green-700",children:"المبالغ المرسلة"}),e.jsx("div",{className:"text-lg font-bold text-green-800",children:Number(m).toFixed(2)})]}),e.jsxs("div",{className:"col-span-2 rounded-lg p-3 bg-gradient-to-r from-amber-50 to-slate-100 border",children:[e.jsx("div",{className:"text-xs text-amber-700",children:"الأرباح"}),e.jsx("div",{className:"text-lg font-bold text-amber-800",children:Number(x).toFixed(2)})]})]})})(),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(h,{variant:"default",onClick:async()=>{try{if(!(s!=null&&s.uid))return;const t=new Date,a=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),l=String(t.getDate()).padStart(2,"0"),o=`${a}-${r}-${l}`,m=t.toDateString(),x=ft.filter(L=>{const V=new Date(L.createdAt).toDateString(),Pe=String(L.status||"completed").toLowerCase();return V===m&&(Pe==="completed"||Pe==="confirmed")}),f=x.length,I=x.reduce((L,V)=>L+Number(V.amount||0),0),w=x.filter(L=>L.type==="withdraw").reduce((L,V)=>L+Number(V.amount||0),0),j=x.filter(L=>L.type==="send").reduce((L,V)=>L+Number(V.amount||0),0),R=x.reduce((L,V)=>L+Number(ds.calculateTransactionProfit(V)||0),0);await xr.add({userId:s.uid,reportDate:o,totalTransactions:f,totalAmount:Number(I.toFixed(2)),totalWithdrawn:Number(w.toFixed(2)),totalSent:Number(j.toFixed(2)),profit:Number(R.toFixed(2)),walletId:null});try{await xr.trimToMaxCount(s.uid,30)}catch{}i({title:"تم الأرشفة",description:`تم حفظ تقرير ${o}`})}catch{i({title:"فشل الأرشفة",description:"تعذر حفظ التقرير",variant:"destructive"})}},children:"أرشفة اليوم"}),e.jsx(h,{variant:"outline",onClick:()=>mi(!1),children:"إغلاق"})]}),e.jsx("div",{className:"mt-2 border-t pt-2",children:e.jsx("div",{className:"space-y-2 max-h-[40vh] overflow-auto",children:Wl.length===0?e.jsx("div",{className:"text-xs text-muted-foreground",children:"لا توجد تقارير محفوظة"}):Wl.map(t=>e.jsxs("div",{className:"border rounded-md p-2 bg-gradient-to-r from-white/80 to-blue-50/70",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{className:"font-bold text-blue-800",children:t.reportDate}),e.jsxs("div",{className:"text-xs text-blue-700",children:["عدد المعاملات: ",t.totalTransactions]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-1",children:[e.jsxs("div",{className:"text-xs text-blue-800",children:["إجمالي المبالغ: ",e.jsx("span",{className:"font-semibold",children:Number(t.totalAmount).toFixed(2)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["المسحوب: ",e.jsx("span",{className:"font-semibold",children:Number(t.totalWithdrawn).toFixed(2)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["المرسل: ",e.jsx("span",{className:"font-semibold",children:Number(t.totalSent).toFixed(2)})]}),e.jsxs("div",{className:"text-xs text-blue-800",children:["الربح: ",e.jsx("span",{className:"font-semibold",children:Number(t.profit??0).toFixed(2)})]})]})]},t.id||`${t.userId}-${t.reportDate}`))})})]})]})}),e.jsx(ge,{open:vd,onOpenChange:t=>{if(t){i({title:"قيد التطوير",description:"هذه الميزة غير متاحة حالياً."});return}ci(!1)},children:e.jsxs(fe,{dir:"rtl",className:"sm:max-w-md w-[95vw] sm:w-auto rounded-2xl border border-emerald-200 shadow-xl bg-gradient-to-br from-white via-green-50 to-emerald-50 backdrop-blur-md data-[state=open]:animate-in data-[state=open]:fade-in-0 data-[state=open]:zoom-in-90 data-[state=open]:slide-in-from-bottom-8 duration-300",children:[e.jsxs(ye,{children:[e.jsx(ve,{className:"text-right text-green-700",children:"شحن رصيد الموبايل"}),e.jsx(is,{className:"text-right text-gray-600",children:"أدخل البيانات ثم اضغط تأكيد"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx(X,{htmlFor:"topupPhone",className:"text-right block",children:"رقم الموبايل"}),e.jsx(z,{id:"topupPhone",value:qr,onChange:t=>Pl(t.target.value),placeholder:"010xxxxxxx",className:"text-right"})]}),e.jsxs("div",{children:[e.jsx(X,{className:"text-right block",children:"شركة التشغيل"}),e.jsxs(xa,{value:Vr,onValueChange:kl,children:[e.jsx(pa,{className:"text-right",children:e.jsx(ga,{placeholder:"اختر الشركة"})}),e.jsxs(fa,{children:[e.jsx(Bs,{value:"vodafone",children:"فودافون"}),e.jsx(Bs,{value:"orange",children:"أورنج"}),e.jsx(Bs,{value:"etisalat",children:"اتصالات"}),e.jsx(Bs,{value:"we",children:"WE"})]})]})]}),e.jsxs("div",{children:[e.jsx(X,{htmlFor:"topupAmount",className:"text-right block",children:"المبلغ بالجنيه"}),e.jsx(z,{id:"topupAmount",type:"number",value:Jr,onChange:t=>Ol(t.target.value?Number(t.target.value):""),placeholder:"50",className:"text-right"})]})]}),e.jsxs(dt,{className:"flex gap-2 justify-between",children:[e.jsx(h,{variant:"outline",onClick:()=>ci(!1),className:"border-gray-300",children:"إلغاء"}),e.jsx(h,{onClick:v,disabled:_l||!qr||!Vr||!Jr,className:"bg-emerald-600 hover:bg-emerald-700 text-white",children:_l?"جارٍ التنفيذ...":"تأكيد الشحن"})]})]})}),e.jsx(as,{open:Gc,onOpenChange:Ln,mode:"verify",title:"الرقم السري الرئيسي لفتح الديون",description:"أدخل الرقم السري الرئيسي لفتح صفحة الديون",onSuccess:()=>{Ln(!1),Ra(!0)}}),e.jsx(as,{open:Zc,onOpenChange:ml,mode:"verify",title:"تأكيد تغيير طلب الرقم السري للديون",description:"أدخل الرقم السري الرئيسي لتفعيل أو إلغاء طلب الرقم السري عند فتح الديون",onSuccess:async()=>{if(hl!==null){const t=hl;dl(t);try{const a=s==null?void 0:s.uid,r=a?`debtsPinRequired_${a}`:"debtsPinRequired";localStorage.setItem(r,String(t)),a&&await Me.updateUserData(a,{debtsPinRequired:t})}catch{}i({title:t?"تم تفعيل طلب الرقم السري للديون":"تم إلغاء طلب الرقم السري للديون",description:t?"سيُطلب الرقم السري الرئيسي عند فتح نافذة الديون.":"يمكن فتح نافذة الديون بدون طلب الرقم السري."})}Xc(null),ml(!1)}}),e.jsx(Tm,{open:fd,onOpenChange:ar,title:"تأكيد كلمة المرور لتصفير المعاملات الأخيرة",description:"سيتم حذف كل المعاملات السابقة نهائيًا من حسابك وFirebase.",onSuccess:async()=>{try{if(!(s!=null&&s.uid)){ar(!1);return}const t=new Date,a=l=>l instanceof Date?l:typeof(l==null?void 0:l.toDate)=="function"?l.toDate():new Date(String(l)),r=ft.filter(l=>a(l.createdAt)<t);await Me.updateUserData(s.uid,{recentReset:{keepLastCount:Ba.keepLastCount??30,intervalDays:Ba.intervalDays??7,lastResetAt:t}}),tn(l=>({...l,lastResetAt:t})),i({title:"تم إخفاء المعاملات السابقة",description:"تم إخفاء كل الإيصالات الأقدم من وقت التصفير من العرض بدون التأثير على تقارير اليوم/الشهر أو الحدود."})}catch(t){console.error("فشل تنفيذ التصفير النهائي:",t),i({title:"فشل التصفير",description:"تحقق من الاتصال ثم أعد المحاولة.",variant:"destructive"})}finally{ar(!1)}}}),e.jsx(as,{open:Jt,onOpenChange:Bt,mode:"verify",title:"الرقم السري لفتح مصروفات المحل",description:"أدخل الرقم السري الرئيسي لفتح نافذة مصروفات المحل",onSuccess:()=>{Bt(!1),St(!0)}}),e.jsx(ge,{open:Hc,onOpenChange:Ra,children:e.jsxs(fe,{className:"sm:max-w-[425px]",children:[e.jsxs(ye,{className:"flex items-center justify-between",children:[e.jsx(ve,{className:"text-right",children:"إدارة الديون"}),e.jsxs("div",{className:"flex items-center gap-1 text-orange-700",children:[e.jsx(fo,{className:"h-4 w-4"}),e.jsxs("span",{className:"text-xs font-bold",children:[Jd," جنيه"]})]})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(X,{htmlFor:"debtorName",className:"text-right col-span-1",children:"اسم المديون"}),e.jsx(z,{id:"debtorName",value:Bn,onChange:t=>ul(t.target.value),className:"col-span-3 text-right",placeholder:"أدخل اسم المديون"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(X,{htmlFor:"debtAmount",className:"text-right col-span-1",children:"المبلغ"}),e.jsx(z,{id:"debtAmount",type:"number",value:Un,onChange:t=>xl(t.target.value),className:"col-span-3 text-right",placeholder:"أدخل المبلغ"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(X,{htmlFor:"debtReason",className:"text-right col-span-1",children:"سبب الدين"}),e.jsx(z,{id:"debtReason",value:zn,onChange:t=>pl(t.target.value),className:"col-span-3 text-right",placeholder:"أدخل سبب الدين"})]})]}),e.jsx(dt,{children:e.jsx(h,{onClick:()=>{if(Bn&&Un&&zn){const t={id:Date.now().toString(),debtorName:Bn,amount:parseFloat(Un),reason:zn,status:"pending",createdAt:new Date,paidAmount:0,partialPayments:[]};si(t),tr(!0)}else i({title:"بيانات غير مكتملة",description:"يرجى إدخال الاسم والمبلغ والسبب",variant:"destructive"})},className:"bg-orange-500 hover:bg-orange-600",children:"حفظ"})}),e.jsx("div",{className:"mt-2",children:e.jsx(h,{variant:"outline",className:"w-full",onClick:()=>er(!0),children:"إيصالات الديون"})}),e.jsx("div",{className:"mt-2",children:e.jsx(h,{variant:"outline",className:"w-full",onClick:()=>Qn(!0),children:"إضافة عميل"})})]})}),e.jsx(ge,{open:Kn,onOpenChange:er,children:e.jsxs(fe,{className:"sm:max-w-[520px]",children:[e.jsxs(ye,{children:[e.jsx(ve,{className:"text-right",children:"إيصالات الديون"}),e.jsx(is,{className:"text-right",children:"اختر دينًا لعرض إيصاله بالتفصيل"})]}),Rt.length>0?e.jsxs("div",{className:"max-h-64 overflow-y-auto space-y-2",onScroll:t=>{const a=t.currentTarget;Hn.length<Rt.length&&a.scrollTop+a.clientHeight>=a.scrollHeight-50&&Yn(r=>r+1)},children:[Hn.map(t=>e.jsx("div",{onClick:()=>{Za(t),ma(!0),er(!1),Ra(!1)},className:"p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium",children:t.debtorName}),e.jsx("p",{className:"text-sm text-gray-600",children:t.reason}),e.jsx("p",{className:"text-sm text-gray-500",children:on.format(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt))})]}),e.jsxs("div",{className:"text-left",children:[e.jsxs("p",{className:"font-bold text-lg",children:[t.amount," جنيه"]}),e.jsx(qt,{variant:t.status==="paid"?"default":"secondary",className:t.status==="paid"?"bg-green-500":"bg-yellow-500",children:t.status==="paid"?"مدفوع":"قيد المراجعة"})]})]})},t.id)),Hn.length<Rt.length&&e.jsx("div",{className:"flex justify-center pt-1",children:e.jsx(h,{variant:"outline",size:"sm",onClick:()=>Yn(t=>t+1),children:"تحميل المزيد"})})]}):e.jsx("div",{className:"text-center text-sm text-gray-500",children:"لا توجد ديون مسجلة"}),e.jsxs(dt,{className:"flex justify-between mt-3",children:[e.jsx(h,{variant:"destructive",onClick:async()=>{try{if(!Rt||Rt.length===0){i({title:"لا توجد ديون",description:"القائمة فارغة بالفعل."});return}if(!window.confirm("هل تريد حذف كل إيصالات الديون؟ هذا الإجراء لا يمكن التراجع عنه."))return;const a=[];fs(a),Za(null),await Ts(a),i({title:"تم حذف كل إيصالات الديون",description:"تم تفريغ القائمة بالكامل."}),er(!1)}catch(t){console.error("تعذر حذف كل إيصالات الديون:",t),i({title:"فشل الحذف",description:"حدث خطأ أثناء الحذف، حاول مرة أخرى.",variant:"destructive"})}},children:"حذف كل الإيصالات"}),e.jsx(h,{variant:"outline",onClick:()=>er(!1),children:"إغلاق"})]})]})}),e.jsx(ge,{open:rd,onOpenChange:Qn,children:e.jsxs(fe,{className:"sm:max-w-[480px]",children:[e.jsxs(ye,{children:[e.jsx(ve,{className:"text-right",children:"إضافة عميل"}),e.jsx(is,{className:"text-right",children:"أدخل بيانات العميل ثم يمكنك تسجيل مبلغ دين عليه"})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(X,{htmlFor:"customerName",className:"text-right col-span-1",children:"اسم العميل"}),e.jsx(z,{id:"customerName",value:Xn,onChange:t=>wl(t.target.value),className:"col-span-3 text-right",placeholder:"اكتب اسم العميل"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(X,{htmlFor:"customerMobile",className:"text-right col-span-1",children:"رقم الموبايل"}),e.jsx(z,{id:"customerMobile",value:ei,onChange:t=>Nl(t.target.value),className:"col-span-3 text-right",placeholder:"اكتب رقم الموبايل"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(h,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{if(!Xn||!ei){i({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم العميل ورقم الموبايل",variant:"destructive"});return}const t={id:Date.now().toString(),name:Xn.trim(),mobile:ei.trim(),createdAt:new Date},a=[t,...ea];await Dd(a),wl(""),Nl(""),i({title:"تمت إضافة العميل",description:`تم إضافة ${t.name}`})},children:"إضافة"})}),e.jsxs("div",{className:"border-t pt-4 space-y-3",children:[e.jsx(X,{className:"text-right block",children:"إضافة مبلغ على عميل"}),ea.length>0?e.jsxs("div",{className:"space-y-3",children:[e.jsxs(xa,{value:ti,onValueChange:jl,children:[e.jsx(pa,{className:"w-full",children:e.jsx(ga,{placeholder:"اختر عميل"})}),e.jsx(fa,{children:ea.map(t=>e.jsxs(Bs,{value:t.id,children:[t.name," — ",t.mobile]},t.id))})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(X,{htmlFor:"customerDebtAmount",className:"text-right col-span-1",children:"المبلغ"}),e.jsx(z,{id:"customerDebtAmount",type:"number",value:Sl,onChange:t=>Dl(t.target.value),className:"col-span-3 text-right",placeholder:"أدخل المبلغ"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(h,{className:"bg-orange-600 hover:bg-orange-700",onClick:async()=>{const t=parseFloat(Sl);if(!ti){i({title:"اختر عميل",description:"يرجى اختيار عميل أولاً",variant:"destructive"});return}if(isNaN(t)||t<=0){i({title:"قيمة غير صحيحة",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const a=ea.find(o=>o.id===ti);if(!a)return;const r={id:Date.now().toString(),debtorName:a.name,customerId:a.id,mobile:a.mobile,amount:Number(t.toFixed(2)),reason:"دين عميل",status:"pending",createdAt:new Date,paidAmount:0,partialPayments:[]},l=[...Rt,r];fs(l),await Ts(l),jl(""),Dl(""),i({title:"تم تسجيل المبلغ على العميل",description:`تمت إضافة ${r.amount} جنيه للعميل ${a.name}`})},children:"إضافة المبلغ"})})]}):e.jsx("p",{className:"text-sm text-gray-500 text-right",children:"لا توجد عملاء مسجلين. أضف عميلًا أولاً."})]})]}),e.jsx(dt,{className:"flex justify-end",children:e.jsx(h,{variant:"outline",onClick:()=>Qn(!1),children:"إغلاق"})})]})}),e.jsx(ge,{open:Ot,onOpenChange:St,children:e.jsxs(fe,{className:"sm:max-w-[520px]",children:[e.jsxs(ye,{children:[e.jsx(ve,{className:"text-right",children:"مصروفات المحل"}),e.jsx(is,{className:"text-right",children:"أدخل تفاصيل المصروف ثم اختر مصدر الخصم."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(X,{htmlFor:"expenseName",className:"text-right col-span-1",children:"اسم المصروف"}),e.jsx(z,{id:"expenseName",value:Is,onChange:t=>bs(t.target.value),className:"col-span-3 text-right",placeholder:"مثال: كهرباء، صيانة، مشتريات"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(X,{htmlFor:"expenseAmount",className:"text-right col-span-1",children:"تمن المصروف"}),e.jsx(z,{id:"expenseAmount",type:"number",value:zs,onChange:t=>Fs(t.target.value),className:"col-span-3 text-right",placeholder:"0.00"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(X,{htmlFor:"expenseNotes",className:"text-right col-span-1",children:"ملاحظات"}),e.jsx(z,{id:"expenseNotes",value:ws,onChange:t=>A(t.target.value),className:"col-span-3 text-right",placeholder:"معلومات إضافية إن وجدت"})]})]}),e.jsxs(dt,{className:"flex justify-between",children:[e.jsx(h,{className:"bg-orange-600 hover:bg-orange-700",onClick:()=>{if(!Is||!zs){i({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم المصروف وقيمته",variant:"destructive"});return}be(!0)},children:"إضافة مصروف"}),e.jsx(h,{variant:"outline",onClick:()=>Dt(!0),children:"إيصالات المصاريف"})]})]})}),e.jsx(ge,{open:jt,onOpenChange:Dt,children:e.jsxs(fe,{className:"sm:max-w-[420px]",dir:"rtl",children:[e.jsxs(ye,{children:[e.jsx(ve,{className:"text-right",children:"إيصالات المصاريف"}),e.jsx(is,{className:"text-right",children:"آخر المصاريف المسجلة"})]}),ee.length>0?e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:ee.map(t=>e.jsx("div",{className:"p-2 border rounded-lg bg-white hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium text-sm",children:t.name}),e.jsx("p",{className:"text-[11px] text-gray-600",children:t.notes||"بدون ملاحظات"}),e.jsx("p",{className:"text-[10px] text-gray-500",children:new Date(t.createdAt).toLocaleString("ar-EG")})]}),e.jsxs("div",{className:"text-left flex items-start gap-2",children:[e.jsxs("div",{className:"text-left",children:[e.jsxs("p",{className:"font-bold text-sm",children:[t.amount," جنيه"]}),e.jsx(qt,{variant:"secondary",className:t.source==="cash"?"bg-blue-100 text-blue-700":"bg-purple-100 text-purple-700",children:t.source==="cash"?"من النقدية":`من المحفظة${t.walletId?` (${t.walletId})`:""}`})]}),e.jsxs(h,{variant:"destructive",size:"sm",className:"shrink-0",onClick:()=>jd(t.id),title:"حذف نهائي",children:[e.jsx(Xt,{className:"w-4 h-4 ml-1"}),"حذف"]})]})]})},t.id))}):e.jsx("p",{className:"text-sm text-gray-500 text-center",children:"لا توجد مصاريف مسجلة بعد"})]})}),e.jsx(ge,{open:Se,onOpenChange:be,children:e.jsxs(fe,{className:"sm:max-w-[480px]",children:[e.jsx(ye,{children:e.jsx(ve,{className:"text-right",children:"اختيار مصدر خصم المصروف"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600 text-right",children:"اختر هل تريد خصم مبلغ المصروف من الرصيد النقدي في الدرج أم من إحدى المحافظ."}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsx(h,{variant:Fe==="cash"?"default":"outline",className:Fe==="cash"?"bg-blue-600 hover:bg-blue-700 text-white":"",onClick:()=>Xe("cash"),children:"الفلوس النقدية"}),e.jsx(h,{variant:Fe==="wallet"?"default":"outline",className:Fe==="wallet"?"bg-purple-600 hover:bg-purple-700 text-white":"",onClick:()=>Xe("wallet"),children:"أرصدة المحافظ"}),e.jsx(h,{variant:Fe==="fawry"?"default":"outline",className:Fe==="fawry"?"bg-amber-600 hover:bg-amber-700 text-white":"",onClick:()=>Xe("fawry"),children:"فوري"})]}),Fe==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{className:"text-right block",children:"اختر المحفظة للخصم"}),e.jsxs(xa,{value:B,onValueChange:qe,children:[e.jsx(pa,{className:"w-full",children:e.jsx(ga,{placeholder:"اختر محفظة"})}),e.jsx(fa,{children:Ye.map(t=>e.jsx(Bs,{value:t.id,children:t.phone||t.name||t.id},t.id))})]})]})]}),e.jsxs(dt,{className:"flex justify-between",children:[e.jsx(h,{variant:"outline",onClick:()=>{be(!1),Xe(null),qe("")},children:"إلغاء"}),e.jsx(h,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{const t=Number(zs);if(isNaN(t)||t<=0){i({title:"قيمة غير صحيحة",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}if(!Fe){i({title:"اختر مصدر الخصم",description:"يرجى اختيار النقدية أو المحفظة",variant:"destructive"});return}try{if(Fe==="cash"){const o=Number((Ct-t).toFixed(2));zt(o),localStorage.setItem(Ds(),o.toString());const m={cashBalance:o,lastUpdated:new Date().toISOString()},x=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(x,JSON.stringify(m)),s!=null&&s.uid?(await Me.updateUserData(s.uid,m),localStorage.removeItem(x),Be(!1)):Be(!0)}else if(Fe==="wallet"){if(!B){i({title:"اختر محفظة",description:"يرجى اختيار محفظة للخصم",variant:"destructive"});return}const o=He[B]||0,m=Number((o-t).toFixed(2)),x={...He,[B]:m};ns(x);const f=new Date().toISOString(),I={walletBalances:x,lastUpdated:f},w=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(w,JSON.stringify(I)),localStorage.setItem(Ss(),JSON.stringify(x)),localStorage.setItem(`walletBalances_backup_${f}`,JSON.stringify(x)),s!=null&&s.uid&&await Me.updateUserData(s.uid,I)}}catch(o){console.error("خطأ أثناء تحديث الأرصدة عند حفظ المصروف:",o)}let a=Date.now().toString();try{if(s!=null&&s.uid){const{addDoc:o,collection:m,serverTimestamp:x}=await Nt(async()=>{const{addDoc:w,collection:j,serverTimestamp:R}=await import("./index-CMr4Oi63.js").then(L=>L.bo);return{addDoc:w,collection:j,serverTimestamp:R}},__vite__mapDeps([0,1]),import.meta.url),{db:f}=await Nt(async()=>{const{db:w}=await import("./index-CMr4Oi63.js").then(j=>j.bp);return{db:w}},__vite__mapDeps([0,1]),import.meta.url);a=(await o(m(f,"shop_expenses"),{userId:s.uid,shopId:P||(C==null?void 0:C.shopId)||s.uid||"default-shop",name:Is,amount:t,notes:ws||"",source:Fe,walletId:Fe==="wallet"?B:null,createdAt:x()})).id}}catch(o){console.error("خطأ أثناء حفظ المصروف في Firestore:",o)}const r={id:a,name:Is,amount:t,notes:ws,source:Fe,walletId:Fe==="wallet"?B:void 0,createdAt:new Date},l=[...ee,r];await $l(l),bs(""),Fs(""),A(""),Xe(null),qe(""),be(!1),St(!0),Dt(!0),i({title:"تم إضافة المصروف",description:Fe==="cash"?"تم الخصم من النقدية":Fe==="wallet"?"تم الخصم من أرصدة المحافظ":"تم تسجيل الدفع عبر فوري"})},children:"تأكيد الخصم"})]})]})}),e.jsx(ge,{open:Gs,onOpenChange:oa,children:e.jsxs(fe,{className:"sm:max-w-[520px]",children:[e.jsxs(ye,{children:[e.jsx(ve,{className:"text-right",children:"النواقص"}),e.jsx(is,{className:"text-right",children:"سجل العناصر الناقصة التي تحتاج شراء وتابع حالتها."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(X,{htmlFor:"deficiencyName",className:"text-right col-span-1",children:"اسم العنصر"}),e.jsx(z,{id:"deficiencyName",value:d,onChange:t=>E(t.target.value),className:"col-span-3 text-right",placeholder:"مثال: سكر، زيت، مناديل"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(X,{htmlFor:"deficiencyQuantity",className:"text-right col-span-1",children:"الكمية"}),e.jsx(z,{id:"deficiencyQuantity",type:"number",value:p,onChange:t=>k(t.target.value),className:"col-span-3 text-right",placeholder:"1"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(h,{className:"bg-rose-600 hover:bg-rose-700",onClick:()=>{if(yt){i({title:"غير متاح",description:"النواقص غير متاحة في خطة زيرو. قم بالترقية.",variant:"destructive"});return}const t=parseInt(p||"1",10);if(!d){i({title:"بيانات غير مكتملة",description:"يرجى إدخال اسم العنصر",variant:"destructive"});return}if(isNaN(t)||t<=0){i({title:"كمية غير صحيحة",description:"يرجى إدخال كمية صحيحة",variant:"destructive"});return}(async()=>{if(s!=null&&s.uid)try{const{collection:r,addDoc:l,serverTimestamp:o}=await Nt(async()=>{const{collection:f,addDoc:I,serverTimestamp:w}=await import("./index-CMr4Oi63.js").then(j=>j.bo);return{collection:f,addDoc:I,serverTimestamp:w}},__vite__mapDeps([0,1]),import.meta.url),{db:m}=await Nt(async()=>{const{db:f}=await import("./index-CMr4Oi63.js").then(I=>I.bp);return{db:f}},__vite__mapDeps([0,1]),import.meta.url),x=await l(r(m,"deficiencies"),{userId:s.uid,shopId:P||(C==null?void 0:C.shopId)||s.uid||"default-shop",name:d,quantity:t,status:"pending",createdAt:o()});try{const f=Yr(),I=localStorage.getItem(f),w=I?JSON.parse(I):[],j=Array.isArray(w)?w:[],R=j.some(Pe=>String((Pe==null?void 0:Pe.id)||"")===x.id),L={id:x.id,name:d,quantity:t,status:"pending",createdAt:new Date().toISOString()},V=R?j:[...j,L];localStorage.setItem(f,JSON.stringify(V))}catch{}E(""),k(""),i({title:"تمت الإضافة",description:"تمت إضافة العنصر إلى قائمة النواقص"});return}catch(r){console.warn("فشل حفظ النواقص إلى Firestore، سيُستخدم التخزين المحلي:",r)}const a={id:Date.now().toString(),name:d,quantity:t,status:"pending",createdAt:new Date};K(r=>{const l=[...r,a];return xi(l),l}),E(""),k(""),i({title:"تمت الإضافة",description:"تمت إضافة العنصر إلى قائمة النواقص"})})()},children:"إضافة للنواقص"})}),U.length>0?e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:U.map(t=>e.jsx("div",{className:"p-2 border rounded-lg bg-white hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium text-sm",children:t.name}),e.jsxs("p",{className:"text-[11px] text-gray-600",children:["الكمية: ",t.quantity]}),e.jsx("p",{className:"text-[10px] text-gray-500",children:new Date(t.createdAt).toLocaleString("ar-EG")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(qt,{variant:"secondary",className:t.status==="pending"?"bg-rose-100 text-rose-700":"bg-green-100 text-green-700",children:t.status==="pending"?"قيد الشراء":"تم الشراء"}),e.jsx(h,{variant:"outline",className:t.status==="pending"?"text-green-700 border-green-300 hover:bg-green-50":"text-rose-700 border-rose-300 hover:bg-rose-50",onClick:()=>{(async()=>{const a=t.status==="pending"?"purchased":"pending";if(s!=null&&s.uid)try{const{doc:r,updateDoc:l,serverTimestamp:o}=await Nt(async()=>{const{doc:x,updateDoc:f,serverTimestamp:I}=await import("./index-CMr4Oi63.js").then(w=>w.bo);return{doc:x,updateDoc:f,serverTimestamp:I}},__vite__mapDeps([0,1]),import.meta.url),{db:m}=await Nt(async()=>{const{db:x}=await import("./index-CMr4Oi63.js").then(f=>f.bp);return{db:x}},__vite__mapDeps([0,1]),import.meta.url);await l(r(m,"deficiencies",t.id),{status:a,updatedAt:o()});return}catch(r){console.warn("فشل تحديث حالة النواقص على Firestore، استخدام التخزين المحلي:",r)}K(r=>{const l=r.map(o=>o.id===t.id?{...o,status:a}:o);return xi(l),l})})()},title:t.status==="pending"?"تم الشراء":"إلغاء الشراء",children:t.status==="pending"?"تم الشراء":"إلغاء الشراء"}),e.jsx(h,{variant:"outline",className:"text-red-700 border-red-300 hover:bg-red-50",onClick:()=>{(async()=>{if(s!=null&&s.uid)try{const{doc:a,deleteDoc:r}=await Nt(async()=>{const{doc:o,deleteDoc:m}=await import("./index-CMr4Oi63.js").then(x=>x.bo);return{doc:o,deleteDoc:m}},__vite__mapDeps([0,1]),import.meta.url),{db:l}=await Nt(async()=>{const{db:o}=await import("./index-CMr4Oi63.js").then(m=>m.bp);return{db:o}},__vite__mapDeps([0,1]),import.meta.url);await r(a(l,"deficiencies",t.id));return}catch(a){console.warn("فشل حذف عنصر النواقص من Firestore، استخدام التخزين المحلي:",a)}K(a=>{const r=a.filter(l=>l.id!==t.id);return xi(r),r})})()},title:"حذف",children:"حذف"})]})]})},t.id))}):e.jsx("p",{className:"text-sm text-gray-500 text-center",children:"لا توجد عناصر مسجلة في النواقص"})]}),e.jsx(dt,{className:"flex justify-end",children:e.jsx(h,{variant:"outline",onClick:()=>oa(!1),children:"إغلاق"})})]})}),e.jsx(ge,{open:nd,onOpenChange:tr,children:e.jsxs(fe,{className:"sm:max-w-[480px]",children:[e.jsx(ye,{children:e.jsx(ve,{className:"text-right",children:"اختيار مصدر خصم الدين"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600 text-right",children:"اختر هل تريد خصم مبلغ الدين من الرصيد النقدي في الدرج أم من إحدى المحافظ أو تسجيله بدون خصم."}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsx(h,{variant:ys==="cash"?"default":"outline",className:ys==="cash"?"bg-blue-600 hover:bg-blue-700 text-white":"",onClick:()=>sr("cash"),children:"الفلوس النقدية"}),e.jsx(h,{variant:ys==="wallet"?"default":"outline",className:ys==="wallet"?"bg-purple-600 hover:bg-purple-700 text-white":"",onClick:()=>sr("wallet"),children:"أرصدة المحافظ"}),e.jsx(h,{variant:ys==="none"?"default":"outline",className:ys==="none"?"bg-gray-600 hover:bg-gray-700 text-white":"",onClick:()=>sr("none"),children:"بدون خصم"})]}),ys==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{className:"text-right block",children:"اختر المحفظة للخصم"}),e.jsxs(xa,{value:$r,onValueChange:ai,children:[e.jsx(pa,{className:"w-full",children:e.jsx(ga,{placeholder:"اختر محفظة"})}),e.jsx(fa,{children:Ye.map(t=>e.jsx(Bs,{value:t.id,children:t.phone||t.name||t.id},t.id))})]})]})]}),e.jsxs(dt,{className:"flex justify-between",children:[e.jsx(h,{variant:"outline",onClick:()=>{tr(!1),si(null),sr(null),ai("")},children:"إلغاء"}),e.jsx(h,{className:"bg-green-600 hover:bg-green-700",onClick:async()=>{const t=!!Rr&&!$a,a=Number(t?Rr.delta:($a==null?void 0:$a.amount)||0);if(!ys){i({title:"اختر مصدر الخصم",description:"يرجى اختيار النقدية أو المحفظة",variant:"destructive"});return}try{if(ys==="cash"){const r=Number((Ct-a).toFixed(2));zt(r),localStorage.setItem(Ds(),r.toString());const l=new Date().toISOString(),o={cashBalance:r,lastUpdated:l},m=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(m,JSON.stringify(o)),s!=null&&s.uid?await Me.updateUserData(s.uid,o).then(()=>{localStorage.removeItem(m),Be(!1)}).catch(()=>{Be(!0)}):Be(!0)}else if(ys==="wallet"){if(!$r){i({title:"اختر محفظة",description:"يرجى اختيار محفظة للخصم",variant:"destructive"});return}const r=He[$r]||0,l=Number((r-a).toFixed(2)),o={...He,[$r]:l};ns(o);const m=new Date().toISOString(),x={walletBalances:o,lastUpdated:m},f=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(f,JSON.stringify(x)),localStorage.setItem(Ss(),JSON.stringify(o)),localStorage.setItem(`walletBalances_backup_${m}`,JSON.stringify(o)),s!=null&&s.uid&&await Me.updateUserData(s.uid,x)}}catch(r){console.error("خطأ أثناء تحديث الأرصدة عند حفظ/تعديل الدين:",r)}if(t){if(!De)return;const r=Number(De.amount||0),l=Number(De.paidAmount||0),o=Number(Rr.delta||0);if(Rr.type==="decrease"){const m=Math.max(l,r-o);if(m===r)i({title:"لا يمكن الإنقاص أكثر",description:"المبلغ لا يمكن أن يقل عن المدفوع."});else{const x=l>=m,f={...De,amount:Number(m.toFixed(2)),status:x?"paid":"pending"},I=Rt.map(w=>w.id===De.id?f:w);fs(I),Za(f),await Ts(I);try{x&&(s!=null&&s.uid)&&(async()=>{const w=st(Te(H,"userTransactions"),ke("userId","==",s.uid),ke("linkedDebtId","==",De.id),ke("status","==","pending")),j=await ct(w);await Promise.allSettled(j.docs.map(R=>Vs(R.ref,{status:"completed",confirmedAt:new Date})))})().catch(w=>console.error("تعذر تحديث حالة المعاملات المرتبطة بالدين بعد الإنقاص:",w))}catch(w){console.error("تعذر تجهيز تحديث حالة المعاملات المرتبطة بعد الإنقاص:",w)}i({title:"تم إنقاص المبلغ",description:`المبلغ الجديد: ${m} جنيه`})}}else{const m=r+o,x=l>=m,f={...De,amount:Number(m.toFixed(2)),status:x?"paid":"pending"},I=Rt.map(w=>w.id===De.id?f:w);fs(I),Za(f),await Ts(I),i({title:"تم زيادة المبلغ",description:`المبلغ الجديد: ${m} جنيه`})}}else if($a){const r=[...Rt,$a];fs(r),await Ts(r)}ul(""),xl(""),pl(""),Ra(!1),tr(!1),si(null),yl(null),sr(null),ai(""),i({title:t?"تم تطبيق الخصم وتعديل الدين":ys==="none"?"تم حفظ الدين بدون خصم":"تم حفظ الدين وخصم المبلغ",description:ys==="none"?"لم يتم الخصم من الدرج أو المحافظ":ys==="cash"?`تم خصم ${a} من الرصيد النقدي`:`تم خصم ${a} من رصيد المحفظة`})},children:"تأكيد الخصم"})]})]})}),e.jsx(ge,{open:ed,onOpenChange:ma,children:e.jsxs(fe,{className:"sm:max-w-[425px]",children:[e.jsx(ye,{children:e.jsx(ve,{className:"text-right",children:"إيصال الدين"})}),De&&e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"text-center border-b pb-4",children:[e.jsx("h2",{className:"text-xl font-bold",children:"إيصال دين"}),e.jsx("p",{className:"text-sm text-gray-500",children:on.format(De.createdAt instanceof Date?De.createdAt:new Date(De.createdAt))})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"اسم المديون:"}),e.jsx("span",{children:De.debtorName})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"font-medium",children:"المبلغ:"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(h,{variant:"outline",className:"h-8 w-8 p-0","aria-label":"إنقاص الدين",onClick:()=>{gl("decrease"),qn(""),ma(!1),Xa(!0)},children:"−"}),e.jsxs("span",{className:"font-bold text-lg",children:[De.amount," جنيه"]}),e.jsx(h,{variant:"outline",className:"h-8 w-8 p-0","aria-label":"زيادة الدين",onClick:()=>{gl("increase"),qn(""),ma(!1),Xa(!0)},children:"+"})]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"سبب الدين:"}),e.jsx("span",{children:De.reason})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"الحالة:"}),e.jsx(qt,{variant:De.status==="paid"?"default":"secondary",className:De.status==="paid"?"bg-green-500":"bg-yellow-500",children:De.status==="paid"?"مدفوع":"مؤجل"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"المبلغ المتبقي:"}),e.jsxs("span",{className:"font-bold text-lg",children:[Math.max(0,Number(De.amount||0)-Number(De.paidAmount||0))," جنيه"]})]}),De.paidAmount?e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"إجمالي المدفوع:"}),e.jsxs("span",{className:"text-green-700",children:[De.paidAmount," جنيه"]})]}):null,e.jsxs("div",{className:"mt-3 p-3 border rounded-lg bg-gray-50",children:[sd?e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"partialAmount",className:"text-right block",children:"المبلغ المراد دفعه"}),e.jsx(z,{id:"partialAmount",type:"number",value:vl,onChange:t=>Jn(t.target.value),className:"text-right",placeholder:"أدخل المبلغ"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(h,{variant:"outline",onClick:()=>{Vn(!1),Jn("")},children:"إلغاء"}),e.jsx(h,{className:"bg-blue-600 hover:bg-blue-700",onClick:async()=>{const t=parseFloat(vl);if(!De||isNaN(t)||t<=0){i({title:"خطأ",description:"يرجى إدخال مبلغ صحيح",variant:"destructive"});return}const a=Math.max(0,Number(De.amount||0)-Number(De.paidAmount||0));if(t>a){i({title:"مبلغ زائد",description:"المبلغ المدفوع أكبر من المتبقي",variant:"destructive"});return}const r=Number(((De.paidAmount||0)+t).toFixed(2)),l=r>=Number(De.amount||0),o={...De,amount:Number(De.amount||0),paidAmount:r,status:l?"paid":"pending",partialPayments:[...De.partialPayments||[],{amount:t,paidAt:new Date}]},m=Rt.map(x=>x.id===De.id?o:x);fs(m),Za(o),await Ts(m);try{o.status==="paid"&&(s!=null&&s.uid)&&(async()=>{const x=st(Te(H,"userTransactions"),ke("userId","==",s.uid),ke("linkedDebtId","==",De.id),ke("status","==","pending")),f=await ct(x);await Promise.allSettled(f.docs.map(I=>Vs(I.ref,{status:"completed",confirmedAt:new Date})))})().catch(x=>console.error("تعذر تحديث حالة المعاملات المرتبطة بالدين:",x))}catch(x){console.error("تعذر تجهيز تحديث حالة المعاملات المرتبطة:",x)}try{const x=pi(),f=localStorage.getItem(x);if(f){const w=(JSON.parse(f)||[]).map(j=>(j==null?void 0:j.linkedDebtId)===De.id&&(j==null?void 0:j.status)==="pending"?{...j,status:"completed",confirmedAt:new Date}:j);localStorage.setItem(x,JSON.stringify(w)),Qs(j=>j.map(R=>(R==null?void 0:R.linkedDebtId)===De.id&&(R==null?void 0:R.status)==="pending"?{...R,status:"completed",confirmedAt:new Date}:R))}}catch(x){console.warn("فشل تحديث حالة المعاملات المرتبطة محلياً بعد سداد الدين:",x)}Lr(t),ha("cash"),La(!0),Vn(!1),Jn(""),i({title:"تم تسجيل دفع جزء",description:`تم دفع ${t} جنيه بتاريخ ${new Date().toLocaleString("ar-EG")}`})},children:"دفع"})]})]}):e.jsx(h,{variant:"outline",className:"w-full",onClick:()=>Vn(!0),children:"دفع جزء"}),De.partialPayments&&De.partialPayments.length>0&&e.jsxs("div",{className:"mt-3 text-xs text-gray-600",children:[e.jsx("p",{className:"font-medium mb-1",children:"سجل الدفعات الجزئية:"}),e.jsx("div",{className:"space-y-1 max-h-24 overflow-y-auto",children:De.partialPayments.map((t,a)=>e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{children:["دفع: ",t.amount," جنيه"]}),e.jsx("span",{children:new Date(t.paidAt).toLocaleString("ar-EG")})]},a))})]})]})]})]}),e.jsxs(dt,{className:"flex gap-2 justify-center",children:[e.jsx(h,{onClick:async()=>{if(De){const t=Rt.map(a=>a.id===De.id?{...a,status:"pending"}:a);fs(t),await Ts(t),ma(!1),i({title:"تم تحديث حالة الدين",description:"تم تعيين الدين كمؤجل"})}},variant:"outline",className:"bg-yellow-500 hover:bg-yellow-600 text-white",children:"مؤجل"}),e.jsx(h,{onClick:async()=>{if(De){const a=Math.max(0,Number(De.amount||0)-Number(De.paidAmount||0)),r=Rt.map(l=>l.id===De.id?{...l,amount:Number(l.amount||0),paidAmount:Number(((l.paidAmount||0)+a).toFixed(2)),status:"paid",partialPayments:[...l.partialPayments||[],...a>0?[{amount:a,paidAt:new Date}]:[]]}:l);fs(r),a>0&&(Lr(a),ha("cash"),La(!0)),await Ts(r);try{s!=null&&s.uid&&(De!=null&&De.id)&&(async()=>{const l=st(Te(H,"userTransactions"),ke("userId","==",s.uid),ke("linkedDebtId","==",De.id),ke("status","==","pending")),o=await ct(l);await Promise.allSettled(o.docs.map(m=>Vs(m.ref,{status:"completed",confirmedAt:new Date})))})().catch(l=>console.error("تعذر تحديث حالة المعاملات المرتبطة بالدين:",l))}catch(l){console.error("تعذر تجهيز تحديث حالة المعاملات المرتبطة:",l)}try{const l=pi(),o=localStorage.getItem(l);if(o){const x=(JSON.parse(o)||[]).map(f=>(f==null?void 0:f.linkedDebtId)===De.id&&(f==null?void 0:f.status)==="pending"?{...f,status:"completed",confirmedAt:new Date}:f);localStorage.setItem(l,JSON.stringify(x)),Qs(f=>f.map(I=>(I==null?void 0:I.linkedDebtId)===De.id&&(I==null?void 0:I.status)==="pending"?{...I,status:"completed",confirmedAt:new Date}:I))}}catch(l){console.warn("فشل تحديث حالة المعاملات المرتبطة محلياً بعد سداد الدين:",l)}ma(!1),i({title:"تم تحديث حالة الدين",description:"تم تعيين الدين كمدفوع"})}},className:"bg-green-500 hover:bg-green-600",children:"مدفوع"}),e.jsx(h,{onClick:async()=>{if(De){const t=Rt.filter(a=>a.id!==De.id);fs(t),await Ts(t),ma(!1),i({title:"تم حذف الدين",description:"تم حذف الدين بنجاح"})}},variant:"destructive",children:"حذف"})]})]})}),e.jsx(ge,{open:td,onOpenChange:Xa,children:e.jsxs(fe,{className:"sm:max-w-md rounded-2xl shadow-elegant border border-gray-200",children:[e.jsxs(ye,{children:[e.jsx(ve,{className:`text-right ${Ia==="decrease"?"text-red-600":"text-green-600"}`,children:Ia==="decrease"?"إنقاص مبلغ الدين":Ia==="increase"?"زيادة مبلغ الدين":"تعديل مبلغ الدين"}),e.jsxs(is,{className:"text-right",children:["أدخل المبلغ ثم اضغط تأكيد لإتمام ",Ia==="decrease"?"الإنقاص":"الزيادة","."]})]}),e.jsxs("div",{className:"grid gap-4 py-2",children:[e.jsx(X,{htmlFor:"debtAdjustAmount",className:"text-right",children:"المبلغ (جنيه)"}),e.jsx(z,{id:"debtAdjustAmount",type:"number",placeholder:"0.00",value:fl,onChange:t=>qn(t.target.value)}),De&&e.jsxs("div",{className:"text-right text-sm text-muted-foreground",children:["المبلغ الحالي: ",e.jsx("span",{className:"font-semibold",children:Number(De.amount||0).toFixed(2)})," جنيه"]})]}),e.jsxs(dt,{className:"flex gap-2",children:[e.jsx(h,{variant:"secondary",onClick:()=>{Xa(!1),ma(!0)},children:"إلغاء"}),e.jsx(h,{className:Ia==="decrease"?"bg-red-600 hover:bg-red-700":"bg-green-600 hover:bg-green-700",onClick:async()=>{try{if(!De||!Ia)return;const t=Number(parseFloat(fl||"0").toFixed(2));if(!t||isNaN(t)||t<=0){i({title:"قيمة غير صالحة",description:"يرجى إدخال مبلغ أكبر من صفر",variant:"destructive"});return}yl({debtId:De.id,delta:t,type:Ia}),Xa(!1),tr(!0)}catch(t){console.error("فشل تجهيز تعديل مبلغ الدين:",t),i({title:"خطأ",description:"تعذّر تجهيز تعديل مبلغ الدين",variant:"destructive"})}},children:"تأكيد"})]})]})}),e.jsx(ge,{open:id,onOpenChange:La,children:e.jsxs(fe,{className:"sm:max-w-[480px]",children:[e.jsxs(ye,{children:[e.jsx(ve,{className:"text-right",children:"اختيار إضافة مبلغ السداد"}),e.jsx(is,{className:"text-right",children:"هل تريد إضافة مبلغ السداد إلى الفلوس النقدية أم إلى إحدى المحافظ؟"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex flex-wrap gap-2 justify-center",children:[e.jsx(h,{variant:js==="cash"?"default":"outline",className:js==="cash"?"bg-blue-600 text-white":"",size:"sm",onClick:()=>ha("cash"),children:"الفلوس النقدية"}),e.jsx(h,{variant:js==="wallet"?"default":"outline",className:js==="wallet"?"bg-blue-600 text-white":"",size:"sm",onClick:()=>ha("wallet"),children:"أرصدة المحافظ"}),e.jsx(h,{variant:js==="fawry"?"default":"outline",className:js==="fawry"?"bg-amber-600 text-white":"",size:"sm",onClick:()=>ha("fawry"),children:"فوري"}),e.jsx(h,{variant:js==="none"?"default":"outline",className:js==="none"?"bg-gray-600 text-white":"",size:"sm",onClick:()=>ha("none"),children:"بدون إضافة"})]}),js==="wallet"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-right",children:"اختر المحفظة"}),e.jsxs("select",{className:"w-full border rounded p-2 text-right",value:Aa,onChange:t=>ri(t.target.value),children:[e.jsx("option",{value:"",children:"— اختر محفظة —"}),Ye&&Ye.length>0?Ye.map(t=>e.jsx("option",{value:t.id,children:t.phone||t.name||t.id},t.id)):Object.keys(He||{}).map(t=>{var a,r,l,o,m,x;return e.jsx("option",{value:t,children:((a=Ye.find(f=>f.id===t))==null?void 0:a.phone)||((l=(r=JSON.parse(localStorage.getItem(gi())||"[]"))==null?void 0:r.find(f=>f.id===t))==null?void 0:l.phone)||((m=(o=JSON.parse(localStorage.getItem(gi())||"[]"))==null?void 0:o.find(f=>f.id===t))==null?void 0:m.name)||((x=Ye.find(f=>f.id===t))==null?void 0:x.name)||t},t)})]})]}),e.jsxs("div",{className:"text-right text-sm text-gray-600",children:["المبلغ المراد إضافته: ",e.jsxs("span",{className:"font-bold",children:[Cl," جنيه"]})]})]}),e.jsxs(dt,{className:"flex flex-wrap justify-between gap-2",children:[e.jsx(h,{variant:"outline",onClick:()=>{La(!1),Lr(0),ha(null),ri("")},children:"إلغاء"}),e.jsx(h,{onClick:async()=>{var t,a;try{const r=Cl;if(!r||r<=0){La(!1);return}if(js==="cash"){const l=Ct+r;zt(l),localStorage.setItem(Ds(),l.toString());const o={cashBalance:l,lastUpdated:new Date().toISOString()},m=`userData_${s==null?void 0:s.uid}`;localStorage.setItem(m,JSON.stringify(o)),s!=null&&s.uid?(Me.updateUserData(s.uid,o).catch(()=>Be(!0)),localStorage.removeItem(m),Be(!1)):Be(!0),i({title:"تمت إضافة مبلغ السداد",description:`تمت إضافة ${r} جنيه إلى الفلوس النقدية`})}else if(js==="wallet"){if(!Aa){i({title:"اختر محفظة أولاً",description:"يرجى اختيار المحفظة لإضافة مبلغ السداد إليها",variant:"destructive"});return}const l={...He,[Aa]:(He[Aa]||0)+r};ns(l);const o=(Ct||0)-r;zt(o),localStorage.setItem(Ds(),o.toString());const m=new Date().toISOString(),x={walletBalances:l,cashBalance:o,lastUpdated:m},f=`userData_${s==null?void 0:s.uid}`;if(localStorage.setItem(f,JSON.stringify(x)),localStorage.setItem(Ss(),JSON.stringify(l)),localStorage.setItem(`walletBalances_backup_${m}`,JSON.stringify(l)),s!=null&&s.uid){Me.updateUserData(s.uid,x).catch(()=>Be(!0));try{localStorage.removeItem(f)}catch{}Be(!1)}else Be(!0);i({title:"تمت إضافة مبلغ السداد",description:`تمت إضافة ${r} جنيه إلى المحفظة ${((t=Ye.find(I=>I.id===Aa))==null?void 0:t.phone)||((a=Ye.find(I=>I.id===Aa))==null?void 0:a.name)||Aa} وتم خصم نفس المبلغ من درج النقدية`})}else if(js==="none"){const l=(Ct||0)-r;zt(l),localStorage.setItem(Ds(),l.toString());const o={cashBalance:l,lastUpdated:new Date().toISOString()},m=`userData_${s==null?void 0:s.uid}`;if(localStorage.setItem(m,JSON.stringify(o)),s!=null&&s.uid){Me.updateUserData(s.uid,o).catch(()=>Be(!0));try{localStorage.removeItem(m)}catch{}Be(!1)}else Be(!0);i({title:"تم تسجيل السداد",description:`تم خصم ${r} جنيه من درج النقدية بدون إضافة للمحافظ`})}else if(js==="fawry")i({title:"تم تسجيل سداد عبر فوري",description:`تم تسجيل ${r} جنيه كسداد عبر فوري بدون تعديل الأرصدة`});else{i({title:"اختر مصدر الإضافة",description:"يرجى اختيار إضافة المبلغ إلى النقدية أو المحفظة",variant:"destructive"});return}}catch(r){console.error("خطأ أثناء إضافة مبلغ السداد:",r),i({title:"حدث خطأ",description:"تعذر إضافة مبلغ السداد، حاول مرة أخرى",variant:"destructive"})}finally{La(!1),Lr(0),ha(null),ri("")}},className:"bg-green-600 hover:bg-green-700",children:"تأكيد الإضافة"})]})]})}),e.jsx(ge,{open:Ec,onOpenChange:Da,children:e.jsxs(fe,{hideClose:!0,className:"post-confirm-card sm:max-w-[420px] w-[90vw] rounded-2xl bg-gradient-to-br from-white via-indigo-50 to-blue-50 shadow-2xl border border-indigo-100",children:[e.jsxs(ye,{children:[e.jsx(ve,{className:"text-right text-2xl font-bold",children:(Qt==null?void 0:Qt.type)==="transfer"?"مبلغ يجب استلامه":"مبلغ يجب تسليمه"}),e.jsx(is,{className:"text-right text-gray-600",children:(Qt==null?void 0:Qt.type)==="transfer"?"هذا هو المبلغ الواجب استلامه من العميل بعد التأكيد.":"هذا هو المبلغ الواجب تسليمه للعميل بعد التأكيد."})]}),e.jsxs("div",{className:"py-3 flex flex-col items-center gap-1.5",children:[e.jsxs("div",{className:"text-xl sm:text-2xl font-bold text-blue-700 tracking-wide",children:[Cs((Qt==null?void 0:Qt.amount)||0)," جنيه"]}),e.jsx("div",{className:"text-sm text-gray-500 text-right w-full",children:(Qt==null?void 0:Qt.type)==="transfer"?"المبلغ المعروض شامل عمولة التحويل.":ut?"العمولة مضافة ولا تؤثر على قيمة التسليم.":"العمولة مخصومة من المبلغ المسلّم للعميل."})]}),e.jsxs(dt,{className:"flex justify-end gap-2",children:[(Qt==null?void 0:Qt.type)==="transfer"&&e.jsx(h,{variant:"outline",id:"sendCodeBtn",onClick:it,disabled:rl,className:"btn-transfer-confirm",children:rl?"جارٍ الإرسال...":"إرسال كود التحويل"}),e.jsx(h,{onClick:()=>{Da(!1),Mn(null)},className:"bg-green-600 hover:bg-green-700 text-white",children:(Qt==null?void 0:Qt.type)==="transfer"?"تم الاستلام":"تم التسليم"})]})]})}),e.jsx(Ym,{open:Wc,onClose:()=>Ma(!1),onSubmit:ot,deviceId:nl||vt||"",recipientMsisdn:String(le==="transfer"?(gs==null?void 0:gs.receiver)||Ns||"":((lo=Ye.find(t=>t.id===ae))==null?void 0:lo.phone)||"").replace(/\D/g,"")}),e.jsx(Lh,{open:W,onOpenChange:he}),il]}))};export{Hu as default};
