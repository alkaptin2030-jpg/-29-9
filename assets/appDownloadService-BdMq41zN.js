import{K as Z,v as g,f as y,w as j,Q as q,T as G,V as X,W as h,s as O,H as E}from"./index-Bp5r4OnK.js";var C,b;const V=(b=(C=import.meta)==null?void 0:C.env)==null?void 0:b.VITE_ANDROID_DOWNLOAD_URL;var B,v;const u=(v=(B=import.meta)==null?void 0:B.env)==null?void 0:v.VITE_PC_DOWNLOAD_URL;var L,k;const f=(k=(L=import.meta)==null?void 0:L.env)==null?void 0:k.VITE_PC32_DOWNLOAD_URL;var x,D;const U=(D=(x=import.meta)==null?void 0:x.env)==null?void 0:D.VITE_ANDROID_VERSION;var J,W;const a=(W=(J=import.meta)==null?void 0:J.env)==null?void 0:W.VITE_PC_VERSION;var F,H;const m=(H=(F=import.meta)==null?void 0:F.env)==null?void 0:H.VITE_PC32_VERSION;function t(e){if(e)try{const r=(e.split("?")[0].split("#")[0].split("/").pop()||"").match(/v?(\d+\.\d+(?:\.\d+)?)/i);return r==null?void 0:r[1]}catch{return}}function or(e){if(e)try{const s=e.match(/drive\.google\.com\/file\/d\/([^/]+)\//),r=e.match(/drive\.google\.com\/open\?id=([^&]+)/),o=(s==null?void 0:s[1])||(r==null?void 0:r[1]);return o?`https://drive.google.com/uc?export=download&id=${o}`:(/drive\.google\.com\/uc\?/.test(e),e)}catch{return e}}const l=["siteContent","appDownloads"],P=["siteContent","desktop_updates"],_="appDownloadsCache";function nr(){try{const s=localStorage.getItem(_);if(s){const r=JSON.parse(s),o={androidUrl:(r==null?void 0:r.androidUrl)||V,pcUrl:(r==null?void 0:r.pcUrl)||u,pc32Url:(r==null?void 0:r.pc32Url)||f,androidVersion:(r==null?void 0:r.androidVersion)||U,pcVersion:(r==null?void 0:r.pcVersion)||a,pc32Version:(r==null?void 0:r.pc32Version)||m,updatedAt:r==null?void 0:r.updatedAt,updatedBy:r==null?void 0:r.updatedBy};return o.pcVersion||(o.pcVersion=t(o.pcUrl)),o.androidVersion||(o.androidVersion=t(o.androidUrl)),o.pc32Version||(o.pc32Version=t(o.pc32Url)),o}}catch{}const e={androidUrl:V,pcUrl:u,pc32Url:f,androidVersion:U,pcVersion:a,pc32Version:m};return e.pcVersion||(e.pcVersion=t(e.pcUrl)),e.androidVersion||(e.androidVersion=t(e.androidUrl)),e.pc32Version||(e.pc32Version=t(e.pc32Url)),e}async function er(){try{const e=await Z(g(y,l[0],l[1]));if(e.exists()){const r=e.data();try{localStorage.setItem(_,JSON.stringify(r))}catch{}const o={androidUrl:(r==null?void 0:r.androidUrl)||V,pcUrl:(r==null?void 0:r.pcUrl)||u,pc32Url:(r==null?void 0:r.pc32Url)||f,androidVersion:(r==null?void 0:r.androidVersion)||U,pcVersion:(r==null?void 0:r.pcVersion)||a,pc32Version:(r==null?void 0:r.pc32Version)||m,updatedAt:r==null?void 0:r.updatedAt,updatedBy:r==null?void 0:r.updatedBy};return o.pcVersion||(o.pcVersion=t(o.pcUrl)),o.androidVersion||(o.androidVersion=t(o.androidUrl)),o.pc32Version||(o.pc32Version=t(o.pc32Url)),o}const s={androidUrl:V,pcUrl:u,pc32Url:f,androidVersion:U,pcVersion:a,pc32Version:m};return s.pcVersion||(s.pcVersion=t(s.pcUrl)),s.androidVersion||(s.androidVersion=t(s.androidUrl)),s.pc32Version||(s.pc32Version=t(s.pc32Url)),s}catch(e){const s=(e==null?void 0:e.message)||"";((e==null?void 0:e.code)||"")==="permission-denied"||s.includes("Missing or insufficient permissions")?console.warn("⚠️ Cannot read app downloads (unauth/public). Using cached or empty.",e):console.error("❌ Error loading app downloads:",e);try{const i=localStorage.getItem(_);if(i){const n=JSON.parse(i),p={androidUrl:(n==null?void 0:n.androidUrl)||V,pcUrl:(n==null?void 0:n.pcUrl)||u,pc32Url:(n==null?void 0:n.pc32Url)||f,androidVersion:(n==null?void 0:n.androidVersion)||U,pcVersion:(n==null?void 0:n.pcVersion)||a,pc32Version:(n==null?void 0:n.pc32Version)||m,updatedAt:n==null?void 0:n.updatedAt,updatedBy:n==null?void 0:n.updatedBy};return p.pcVersion||(p.pcVersion=t(p.pcUrl)),p.androidVersion||(p.androidVersion=t(p.androidUrl)),p.pc32Version||(p.pc32Version=t(p.pc32Url)),p}}catch{}const o={androidUrl:V,pcUrl:u,pc32Url:f,androidVersion:U,pcVersion:a,pc32Version:m};return o.pcVersion||(o.pcVersion=t(o.pcUrl)),o.androidVersion||(o.androidVersion=t(o.androidUrl)),o.pc32Version||(o.pc32Version=t(o.pc32Url)),o}}function ir(e){try{const s=g(y,l[0],l[1]);return j(s,o=>{const i=(o.exists()?o.data():{})||{},n={androidUrl:(i==null?void 0:i.androidUrl)||V,pcUrl:(i==null?void 0:i.pcUrl)||u,pc32Url:(i==null?void 0:i.pc32Url)||f,androidVersion:(i==null?void 0:i.androidVersion)||U,pcVersion:(i==null?void 0:i.pcVersion)||a,pc32Version:(i==null?void 0:i.pc32Version)||m,updatedAt:i==null?void 0:i.updatedAt,updatedBy:i==null?void 0:i.updatedBy};n.pcVersion||(n.pcVersion=t(n.pcUrl)),n.androidVersion||(n.androidVersion=t(n.androidUrl)),n.pc32Version||(n.pc32Version=t(n.pc32Url));try{localStorage.setItem(_,JSON.stringify(n))}catch{}e(n)},o=>{console.warn("listenAppDownloads error; falling back to cache",o);try{const i=localStorage.getItem(_);i&&e(JSON.parse(i))}catch{}})}catch{return()=>{}}}async function sr(e,s,r,o,i,n=12e4){const p=q(),$=e.name.replace(/[^a-zA-Z0-9_.-]/g,"_"),K=`public/apps/${s}/${Date.now()}_${$}`,N=G(p,K);return new Promise((M,w)=>{const I=X(N,e);let R=!1;const S=setTimeout(()=>{R=!0;try{I.cancel()}catch{}w(new Error("Upload timed out"))},n);I.on("state_changed",c=>{const d=Math.round(c.bytesTransferred/c.totalBytes*100);i&&i(d)},c=>{clearTimeout(S),w(c)},async()=>{try{if(clearTimeout(S),R)return;const c=await h(N),d={updatedAt:O(),updatedBy:r||"admin"};s==="android"?(d.androidUrl=c,o&&(d.androidVersion=o)):s==="pc"?(d.pcUrl=c,o&&(d.pcVersion=o)):(d.pc32Url=c,o&&(d.pc32Version=o));const z=Math.min(Math.max(2e4,Math.floor(n/10)),6e4),Q=E(g(y,l[0],l[1]),d,{merge:!0});let T=!1;const Y=new Promise(A=>setTimeout(()=>{T=!0,A()},z));try{await Promise.race([Q,Y])}catch(A){console.warn("⚠️ Firestore write error, proceeding with URL only:",A)}T&&console.warn("⚠️ Firestore update timed out; تم رفع الملف، لكن لم يتم تحديث معلومات الإصدار في قاعدة البيانات بعد."),M(c)}catch(c){w(c)}})})}async function tr(e,s){const r={};Object.entries(e||{}).forEach(([i,n])=>{n!==void 0&&(r[i]=n)});const o={...r,updatedAt:O(),updatedBy:s||"admin"};await E(g(y,l[0],l[1]),o,{merge:!0})}async function pr(e,s){const r={};Object.entries(e||{}).forEach(([i,n])=>{n!==void 0&&(r[i]=n)});const o={...r,updatedAt:O(),updatedBy:s||"admin"};await E(g(y,P[0],P[1]),o,{merge:!0})}export{er as getAppDownloads,nr as getCachedOrEnvAppDownloads,ir as listenAppDownloads,or as resolveDownloadUrl,tr as setAppDownloadLinks,pr as setDesktopUpdateInfo,sr as uploadAppBinaryResumable};
