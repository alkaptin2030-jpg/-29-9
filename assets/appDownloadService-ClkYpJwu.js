import{K as Y,v as y,f as _,w as Z,Q as q,T as G,V as X,W as j,s as F,H as $}from"./index-B6U9UJBf.js";var S,T;const V=(T=(S=import.meta)==null?void 0:S.env)==null?void 0:T.VITE_ANDROID_DOWNLOAD_URL;var P,C;const u=(C=(P=import.meta)==null?void 0:P.env)==null?void 0:C.VITE_PC_DOWNLOAD_URL;var b,v;const U=(v=(b=import.meta)==null?void 0:b.env)==null?void 0:v.VITE_PC32_DOWNLOAD_URL;var B,L;const f=(L=(B=import.meta)==null?void 0:B.env)==null?void 0:L.VITE_ANDROID_VERSION;var k,x;const m=(x=(k=import.meta)==null?void 0:k.env)==null?void 0:x.VITE_PC_VERSION;var J,W;const a=(W=(J=import.meta)==null?void 0:J.env)==null?void 0:W.VITE_PC32_VERSION;function t(e){if(e)try{const r=(e.split("?")[0].split("#")[0].split("/").pop()||"").match(/v?(\d+\.\d+(?:\.\d+)?)/i);return r==null?void 0:r[1]}catch{return}}function rr(e){if(e)try{const s=e.match(/drive\.google\.com\/file\/d\/([^/]+)\//),r=e.match(/drive\.google\.com\/open\?id=([^&]+)/),o=(s==null?void 0:s[1])||(r==null?void 0:r[1]);return o?`https://drive.google.com/uc?export=download&id=${o}`:(/drive\.google\.com\/uc\?/.test(e),e)}catch{return e}}const l=["siteContent","appDownloads"],g="appDownloadsCache";function or(){try{const s=localStorage.getItem(g);if(s){const r=JSON.parse(s),o={androidUrl:(r==null?void 0:r.androidUrl)||V,pcUrl:(r==null?void 0:r.pcUrl)||u,pc32Url:(r==null?void 0:r.pc32Url)||U,androidVersion:(r==null?void 0:r.androidVersion)||f,pcVersion:(r==null?void 0:r.pcVersion)||m,pc32Version:(r==null?void 0:r.pc32Version)||a,updatedAt:r==null?void 0:r.updatedAt,updatedBy:r==null?void 0:r.updatedBy};return o.pcVersion||(o.pcVersion=t(o.pcUrl)),o.androidVersion||(o.androidVersion=t(o.androidUrl)),o.pc32Version||(o.pc32Version=t(o.pc32Url)),o}}catch{}const e={androidUrl:V,pcUrl:u,pc32Url:U,androidVersion:f,pcVersion:m,pc32Version:a};return e.pcVersion||(e.pcVersion=t(e.pcUrl)),e.androidVersion||(e.androidVersion=t(e.androidUrl)),e.pc32Version||(e.pc32Version=t(e.pc32Url)),e}async function nr(){try{const e=await Y(y(_,l[0],l[1]));if(e.exists()){const r=e.data();try{localStorage.setItem(g,JSON.stringify(r))}catch{}const o={androidUrl:(r==null?void 0:r.androidUrl)||V,pcUrl:(r==null?void 0:r.pcUrl)||u,pc32Url:(r==null?void 0:r.pc32Url)||U,androidVersion:(r==null?void 0:r.androidVersion)||f,pcVersion:(r==null?void 0:r.pcVersion)||m,pc32Version:(r==null?void 0:r.pc32Version)||a,updatedAt:r==null?void 0:r.updatedAt,updatedBy:r==null?void 0:r.updatedBy};return o.pcVersion||(o.pcVersion=t(o.pcUrl)),o.androidVersion||(o.androidVersion=t(o.androidUrl)),o.pc32Version||(o.pc32Version=t(o.pc32Url)),o}const s={androidUrl:V,pcUrl:u,pc32Url:U,androidVersion:f,pcVersion:m,pc32Version:a};return s.pcVersion||(s.pcVersion=t(s.pcUrl)),s.androidVersion||(s.androidVersion=t(s.androidUrl)),s.pc32Version||(s.pc32Version=t(s.pc32Url)),s}catch(e){const s=(e==null?void 0:e.message)||"";((e==null?void 0:e.code)||"")==="permission-denied"||s.includes("Missing or insufficient permissions")?console.warn("⚠️ Cannot read app downloads (unauth/public). Using cached or empty.",e):console.error("❌ Error loading app downloads:",e);try{const i=localStorage.getItem(g);if(i){const n=JSON.parse(i),p={androidUrl:(n==null?void 0:n.androidUrl)||V,pcUrl:(n==null?void 0:n.pcUrl)||u,pc32Url:(n==null?void 0:n.pc32Url)||U,androidVersion:(n==null?void 0:n.androidVersion)||f,pcVersion:(n==null?void 0:n.pcVersion)||m,pc32Version:(n==null?void 0:n.pc32Version)||a,updatedAt:n==null?void 0:n.updatedAt,updatedBy:n==null?void 0:n.updatedBy};return p.pcVersion||(p.pcVersion=t(p.pcUrl)),p.androidVersion||(p.androidVersion=t(p.androidUrl)),p.pc32Version||(p.pc32Version=t(p.pc32Url)),p}}catch{}const o={androidUrl:V,pcUrl:u,pc32Url:U,androidVersion:f,pcVersion:m,pc32Version:a};return o.pcVersion||(o.pcVersion=t(o.pcUrl)),o.androidVersion||(o.androidVersion=t(o.androidUrl)),o.pc32Version||(o.pc32Version=t(o.pc32Url)),o}}function er(e){try{const s=y(_,l[0],l[1]);return Z(s,o=>{const i=(o.exists()?o.data():{})||{},n={androidUrl:(i==null?void 0:i.androidUrl)||V,pcUrl:(i==null?void 0:i.pcUrl)||u,pc32Url:(i==null?void 0:i.pc32Url)||U,androidVersion:(i==null?void 0:i.androidVersion)||f,pcVersion:(i==null?void 0:i.pcVersion)||m,pc32Version:(i==null?void 0:i.pc32Version)||a,updatedAt:i==null?void 0:i.updatedAt,updatedBy:i==null?void 0:i.updatedBy};n.pcVersion||(n.pcVersion=t(n.pcUrl)),n.androidVersion||(n.androidVersion=t(n.androidUrl)),n.pc32Version||(n.pc32Version=t(n.pc32Url));try{localStorage.setItem(g,JSON.stringify(n))}catch{}e(n)},o=>{console.warn("listenAppDownloads error; falling back to cache",o);try{const i=localStorage.getItem(g);i&&e(JSON.parse(i))}catch{}})}catch{return()=>{}}}async function ir(e,s,r,o,i,n=12e4){const p=q(),H=e.name.replace(/[^a-zA-Z0-9_.-]/g,"_"),M=`public/apps/${s}/${Date.now()}_${H}`,O=G(p,M);return new Promise((K,w)=>{const N=X(O,e);let E=!1;const R=setTimeout(()=>{E=!0;try{N.cancel()}catch{}w(new Error("Upload timed out"))},n);N.on("state_changed",c=>{const d=Math.round(c.bytesTransferred/c.totalBytes*100);i&&i(d)},c=>{clearTimeout(R),w(c)},async()=>{try{if(clearTimeout(R),E)return;const c=await j(O),d={updatedAt:F(),updatedBy:r||"admin"};s==="android"?(d.androidUrl=c,o&&(d.androidVersion=o)):s==="pc"?(d.pcUrl=c,o&&(d.pcVersion=o)):(d.pc32Url=c,o&&(d.pc32Version=o));const z=Math.min(Math.max(2e4,Math.floor(n/10)),6e4),D=$(y(_,l[0],l[1]),d,{merge:!0});let I=!1;const Q=new Promise(A=>setTimeout(()=>{I=!0,A()},z));try{await Promise.race([D,Q])}catch(A){console.warn("⚠️ Firestore write error, proceeding with URL only:",A)}I&&console.warn("⚠️ Firestore update timed out; تم رفع الملف، لكن لم يتم تحديث معلومات الإصدار في قاعدة البيانات بعد."),K(c)}catch(c){w(c)}})})}async function sr(e,s){const r={};Object.entries(e||{}).forEach(([i,n])=>{n!==void 0&&(r[i]=n)});const o={...r,updatedAt:F(),updatedBy:s||"admin"};await $(y(_,l[0],l[1]),o,{merge:!0})}export{nr as getAppDownloads,or as getCachedOrEnvAppDownloads,er as listenAppDownloads,rr as resolveDownloadUrl,sr as setAppDownloadLinks,ir as uploadAppBinaryResumable};
