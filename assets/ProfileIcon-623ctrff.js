import{J as se,r as o,j as e,a1 as ye,a3 as V,a7 as Ce,a$ as K,Y as z,u as te,c as ae,I as F,B as j,E as T,p as G,aB as ke,aC as Ee,b4 as Ae,a as Ie,ab as Le,M as De,ai as Ue,ae as Me}from"./index-BaJ4CYlQ.js";import{L as Oe,D as Re,a as _e,b as Fe,c as Te,d as $,e as U}from"./dropdown-menu-C2FHz94g.js";import{D as re,a as ne,b as oe,c as ie,e as Ge,d as $e}from"./dialog-Dficjy7S.js";import{L as B}from"./label-BUMa-ycB.js";import{M as Be}from"./MasterPinDialog-CaA8A3a3.js";import{g as We}from"./avatars-DDgW7Iin.js";import{S as Ke}from"./shield-BUfn1tuF.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ns=se("Activity",[["path",{d:"M22 12h-2.48a2 2 0 0 0-1.93 1.46l-2.35 8.36a.25.25 0 0 1-.48 0L9.24 2.18a.25.25 0 0 0-.48 0l-2.35 8.36A2 2 0 0 1 4.49 12H2",key:"169zse"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ve=se("CloudDownload",[["path",{d:"M12 13v8l-4-4",key:"1f5nwf"}],["path",{d:"m12 21 4-4",key:"1lfcce"}],["path",{d:"M4.393 15.269A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.436 8.284",key:"ui1hmy"}]]);var ce={exports:{}},le={};/**
 * @license React
 * use-sync-external-store-shim.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var k=o;function ze(r,t){return r===t&&(r!==0||1/r===1/t)||r!==r&&t!==t}var He=typeof Object.is=="function"?Object.is:ze,Ye=k.useState,qe=k.useEffect,Je=k.useLayoutEffect,Xe=k.useDebugValue;function Qe(r,t){var s=t(),c=Ye({inst:{value:s,getSnapshot:t}}),n=c[0].inst,i=c[1];return Je(function(){n.value=s,n.getSnapshot=t,W(n)&&i({inst:n})},[r,s,t]),qe(function(){return W(n)&&i({inst:n}),r(function(){W(n)&&i({inst:n})})},[r]),Xe(s),s}function W(r){var t=r.getSnapshot;r=r.value;try{var s=t();return!He(r,s)}catch{return!0}}function Ze(r,t){return t()}var es=typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"?Ze:Qe;le.useSyncExternalStore=k.useSyncExternalStore!==void 0?k.useSyncExternalStore:es;ce.exports=le;var ss=ce.exports;function ts(){return ss.useSyncExternalStore(as,()=>!0,()=>!1)}function as(){return()=>{}}var H="Avatar",[rs]=ye(H),[ns,de]=rs(H),ue=o.forwardRef((r,t)=>{const{__scopeAvatar:s,...c}=r,[n,i]=o.useState("idle");return e.jsx(ns,{scope:s,imageLoadingStatus:n,onImageLoadingStatusChange:i,children:e.jsx(V.span,{...c,ref:t})})});ue.displayName=H;var he="AvatarImage",me=o.forwardRef((r,t)=>{const{__scopeAvatar:s,src:c,onLoadingStatusChange:n=()=>{},...i}=r,x=de(he,s),w=os(c,i),f=Ce(u=>{n(u),x.onImageLoadingStatusChange(u)});return K(()=>{w!=="idle"&&f(w)},[w,f]),w==="loaded"?e.jsx(V.img,{...i,ref:t,src:c}):null});me.displayName=he;var fe="AvatarFallback",we=o.forwardRef((r,t)=>{const{__scopeAvatar:s,delayMs:c,...n}=r,i=de(fe,s),[x,w]=o.useState(c===void 0);return o.useEffect(()=>{if(c!==void 0){const f=window.setTimeout(()=>w(!0),c);return()=>window.clearTimeout(f)}},[c]),x&&i.imageLoadingStatus!=="loaded"?e.jsx(V.span,{...n,ref:t}):null});we.displayName=fe;function ee(r,t){return r?t?(r.src!==t&&(r.src=t),r.complete&&r.naturalWidth>0?"loaded":"loading"):"error":"idle"}function os(r,{referrerPolicy:t,crossOrigin:s}){const c=ts(),n=o.useRef(null),i=c?(n.current||(n.current=new window.Image),n.current):null,[x,w]=o.useState(()=>ee(i,r));return K(()=>{w(ee(i,r))},[i,r]),K(()=>{const f=A=>()=>{w(A)};if(!i)return;const u=f("loaded"),b=f("error");return i.addEventListener("load",u),i.addEventListener("error",b),t&&(i.referrerPolicy=t),typeof s=="string"&&(i.crossOrigin=s),()=>{i.removeEventListener("load",u),i.removeEventListener("error",b)}},[i,s,t]),x}var ge=ue,xe=me,pe=we;const ve=o.forwardRef(({className:r,...t},s)=>e.jsx(ge,{ref:s,className:z("relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",r),...t}));ve.displayName=ge.displayName;const je=o.forwardRef(({className:r,...t},s)=>e.jsx(xe,{ref:s,className:z("aspect-square h-full w-full",r),...t}));je.displayName=xe.displayName;const Ne=o.forwardRef(({className:r,...t},s)=>e.jsx(pe,{ref:s,className:z("flex h-full w-full items-center justify-center rounded-full bg-muted",r),...t}));Ne.displayName=pe.displayName;function is({open:r,onOpenChange:t}){const{user:s}=te(),{toast:c}=ae(),[n,i]=o.useState(!1),[x,w]=o.useState(!1),[f,u]=o.useState(!1),[b,A]=o.useState(!1),[Y,y]=o.useState(!1),[q,C]=o.useState(!1),[g,I]=o.useState({currentPassword:"",newPassword:"",confirmPassword:""}),[l,p]=o.useState({currentPassword:"",newPassword:"",confirmPassword:""}),M=()=>{const d={currentPassword:"",newPassword:"",confirmPassword:""};return g.currentPassword||(d.currentPassword="كلمة المرور الحالية مطلوبة"),g.newPassword?g.newPassword.length<6&&(d.newPassword="كلمة المرور يجب أن تكون 6 أحرف على الأقل"):d.newPassword="كلمة المرور الجديدة مطلوبة",g.confirmPassword?g.newPassword!==g.confirmPassword&&(d.confirmPassword="كلمات المرور غير متطابقة"):d.confirmPassword="تأكيد كلمة المرور مطلوب",p(d),!Object.values(d).some(h=>h!=="")},L=async d=>{if(d.preventDefault(),!(!M()||!s||!s.email)){i(!0);try{const h=ke.credential(s.email,g.currentPassword);await Ee(s,h),C(!0),y(!0),c({title:"تأكيد الهوية",description:"أدخل الرقم السري الرئيسي لتأكيد تغيير كلمة المرور"})}catch(h){console.error("خطأ في تغيير كلمة المرور:",h);let N="حدث خطأ أثناء تغيير كلمة المرور";if(h.code==="auth/wrong-password"){p(S=>({...S,currentPassword:"كلمة المرور الحالية غير صحيحة"}));return}else if(h.code==="auth/weak-password"){p(S=>({...S,newPassword:"كلمة المرور ضعيفة جداً"}));return}else h.code==="auth/requires-recent-login"&&(N="يجب تسجيل الدخول مرة أخرى لتغيير كلمة المرور");c({title:"خطأ في تغيير كلمة المرور",description:N,variant:"destructive"})}finally{i(!1)}}},O=async()=>{if(s){i(!0);try{await Ae(s,g.newPassword),c({title:"تم تغيير كلمة المرور بنجاح",description:"تم تحديث كلمة المرور الخاصة بك بنجاح"}),I({currentPassword:"",newPassword:"",confirmPassword:""}),p({currentPassword:"",newPassword:"",confirmPassword:""}),y(!1),C(!1),t(!1)}catch(d){console.error("خطأ في تحديث كلمة المرور:",d);let h="حدث خطأ أثناء تغيير كلمة المرور";d.code==="auth/requires-recent-login"&&(h="انتهت جلسة المصادقة. يرجى إعادة إدخال كلمة المرور الحالية"),c({title:"خطأ في تغيير كلمة المرور",description:h,variant:"destructive"})}finally{i(!1)}}},v=d=>h=>{I(N=>({...N,[d]:h.target.value})),l[d]&&p(N=>({...N,[d]:""}))},E=()=>{I({currentPassword:"",newPassword:"",confirmPassword:""}),p({currentPassword:"",newPassword:"",confirmPassword:""}),y(!1),C(!1),t(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(re,{open:r,onOpenChange:E,children:e.jsxs(ne,{className:"sm:max-w-[425px]",children:[e.jsxs(oe,{children:[e.jsx(ie,{children:"تغيير كلمة المرور"}),e.jsx(Ge,{children:"أدخل كلمة المرور الحالية وكلمة المرور الجديدة لتحديث حسابك"})]}),e.jsxs("form",{onSubmit:L,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(B,{htmlFor:"currentPassword",children:"كلمة المرور الحالية"}),e.jsxs("div",{className:"relative",children:[e.jsx(F,{id:"currentPassword",type:x?"text":"password",value:g.currentPassword,onChange:v("currentPassword"),className:l.currentPassword?"border-red-500":"",autoComplete:"off",disabled:n}),e.jsx(j,{type:"button",variant:"ghost",size:"sm",className:"absolute right-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>w(!x),disabled:n,children:x?e.jsx(T,{className:"h-4 w-4"}):e.jsx(G,{className:"h-4 w-4"})})]}),l.currentPassword&&e.jsx("p",{className:"text-sm text-red-500",children:l.currentPassword})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(B,{htmlFor:"newPassword",children:"كلمة المرور الجديدة"}),e.jsxs("div",{className:"relative",children:[e.jsx(F,{id:"newPassword",type:f?"text":"password",value:g.newPassword,onChange:v("newPassword"),className:l.newPassword?"border-red-500":"",autoComplete:"new-password",disabled:n}),e.jsx(j,{type:"button",variant:"ghost",size:"sm",className:"absolute right-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>u(!f),disabled:n,children:f?e.jsx(T,{className:"h-4 w-4"}):e.jsx(G,{className:"h-4 w-4"})})]}),l.newPassword&&e.jsx("p",{className:"text-sm text-red-500",children:l.newPassword})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(B,{htmlFor:"confirmPassword",children:"تأكيد كلمة المرور الجديدة"}),e.jsxs("div",{className:"relative",children:[e.jsx(F,{id:"confirmPassword",type:b?"text":"password",value:g.confirmPassword,onChange:v("confirmPassword"),className:l.confirmPassword?"border-red-500":"",autoComplete:"new-password",disabled:n}),e.jsx(j,{type:"button",variant:"ghost",size:"sm",className:"absolute right-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>A(!b),disabled:n,children:b?e.jsx(T,{className:"h-4 w-4"}):e.jsx(G,{className:"h-4 w-4"})})]}),l.confirmPassword&&e.jsx("p",{className:"text-sm text-red-500",children:l.confirmPassword})]}),e.jsxs($e,{children:[e.jsx(j,{type:"button",variant:"outline",onClick:E,disabled:n,children:"إلغاء"}),e.jsxs(j,{type:"submit",disabled:n,children:[n&&e.jsx(Oe,{className:"mr-2 h-4 w-4 animate-spin"}),"تغيير كلمة المرور"]})]})]})]})}),e.jsx(Be,{open:Y&&q,onOpenChange:d=>{y(d),d||C(!1)},mode:"verify",title:"التحقق من الرقم السري الرئيسي",description:"لا يمكن تغيير كلمة المرور إلا بعد التحقق من الرقم السري الرئيسي",onSuccess:O,onCancel:()=>{y(!1),C(!1)}})]})}const cs="cashy.google.accessToken",ls="cashy.google.email",ds="cashy.google.expiresAt";function us(){try{const r=localStorage.getItem(cs),t=localStorage.getItem(ls),s=localStorage.getItem(ds),c=s?Number(s):null;return{token:r,email:t,expiresAt:c}}catch{return{token:null,email:null,expiresAt:null}}}async function hs(r,t,s){try{const c=await fetch("/user/google-backup-token",{method:"POST",headers:{"Content-Type":"application/json","X-USER-ID":r},body:JSON.stringify({email:t,refresh_token:s})}),n=await c.json().catch(()=>({}));return!!(c.ok&&(n!=null&&n.ok))}catch{return!1}}function Ps({className:r}){const{user:t,profile:s,signOut:c,updateUserProfile:n}=te(),i=Ie(),[x,w]=o.useState(!1),{isShiftActive:f}=Le(),{toast:u}=ae(),[b,A]=o.useState(!1),[Y,y]=o.useState(!1),[q,C]=o.useState(!1),[{token:g},I]=o.useState(()=>us()),l=typeof window<"u"?window.electronAPI:void 0,p=!!l,[M,L]=o.useState(!1),[O,v]=o.useState(!1),[E,d]=o.useState(""),[h,N]=o.useState(""),[S,R]=o.useState(0),[_,D]=o.useState(!1);o.useEffect(()=>{if(!(!p||!l))try{l.onUpdateAvailable(a=>{var m,P;L(!0),d(String(((m=a==null?void 0:a.info)==null?void 0:m.version)||"")),N(String(((P=a==null?void 0:a.info)==null?void 0:P.notes)||"")),v(!0)}),l.onUpdateDownloaded(a=>{var m,P;L(!0),d(String(((m=a==null?void 0:a.info)==null?void 0:m.version)||"")),N(String(((P=a==null?void 0:a.info)==null?void 0:P.notes)||"")),D(!1),R(100),v(!0)}),l.onUpdateError(a=>{try{u({title:"فشل التحديث",description:String((a==null?void 0:a.message)||(a==null?void 0:a.code)||"تعذر التحميل"),variant:"destructive"})}catch{}}),typeof l.onUpdateProgress=="function"&&l.onUpdateProgress(a=>{const m=(a==null?void 0:a.percent)==null?0:Number(a.percent);D(!0),R(Math.max(0,Math.min(100,isNaN(m)?0:m))),v(!0)}),l.checkUpdate()}catch{}},[p,l]);const J=async()=>{try{if(l){try{await l.checkUpdate()}catch{}v(!0),D(!0),R(0);const a=await l.downloadUpdate();if(typeof a=="string"&&a.startsWith("err:")){try{u({title:"فشل التحديث",description:a.slice(4),variant:"destructive"})}catch{}D(!1)}else if(a==="noop")try{u({title:"لا يوجد تحديث",description:"لا تتوفر نسخة أحدث حالياً."})}catch{}else if(a==="manual")try{u({title:"جارٍ تنزيل التحديث",description:"سيظهر زر التحديث بعد اكتمال التنزيل."})}catch{}else if(a==="autoUpdater")try{u({title:"تنزيل تلقائي",description:"سيتم تطبيق التحديث تلقائياً بواسطة النظام."})}catch{}}}catch(a){try{u({title:"فشل التحديث",description:(a==null?void 0:a.message)||"حدث خطأ أثناء التنزيل",variant:"destructive"})}catch{}}},Pe=async()=>{try{if(l){const a=await l.applyUpdate();if(typeof a=="string"&&a.startsWith("err:"))try{u({title:"فشل تطبيق التحديث",description:a.slice(4),variant:"destructive"})}catch{}}}catch(a){try{u({title:"فشل تطبيق التحديث",description:(a==null?void 0:a.message)||"حدث خطأ أثناء تطبيق التحديث",variant:"destructive"})}catch{}}},be=()=>s!=null&&s.fullName?s==null?void 0:s.fullName.split(" ").map(a=>a.charAt(0)).join("").toUpperCase().slice(0,2):t.email?t.email.charAt(0).toUpperCase():"U",X=s!=null&&s.avatarId?We(s.avatarId):null;if(o.useEffect(()=>{console.log("Profile updated in ProfileIcon:",s==null?void 0:s.avatarId)},[s==null?void 0:s.avatarId]),o.useEffect(()=>{const a=async m=>{try{if(!(m!=null&&m.data)||typeof m.data!="object"||m.origin!=="https://cashy.link")return;const{type:P,email:Q,refresh_token:Z}=m.data||{};P==="cashy_oauth_token"&&(t!=null&&t.uid)&&Q&&Z&&await hs(t.uid,String(Q),String(Z))&&u({title:"تم ربط جوجل",description:"تم حفظ توكن النسخ الاحتياطي عبر الخادم."})}catch{}};return window.addEventListener("message",a),()=>window.removeEventListener("message",a)},[t==null?void 0:t.uid]),!t)return null;const Se=async()=>{try{await c(),i("/user/login",{replace:!0})}catch(a){console.error("خطأ في تسجيل الخروج:",a);try{i("/user/login",{replace:!0})}catch{}}};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[p&&e.jsxs(j,{type:"button",onClick:J,title:"تحديث التطبيق",className:"relative inline-flex items-center justify-center w-9 h-9 rounded-md bg-transparent text-blue-600 hover:bg-blue-500/10 focus:outline-none dark:text-blue-400 dark:hover:bg-blue-400/10",variant:"ghost",children:[e.jsx(Ve,{className:"w-5 h-5"}),M&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 inline-block w-2 h-2 rounded-full bg-red-500"})]}),e.jsxs(Re,{children:[e.jsx(_e,{asChild:!0,children:e.jsx(j,{variant:"ghost",disabled:f,title:f?"غير متاح أثناء وجود وردية كاشير نشطة":void 0,className:`relative h-8 w-8 rounded-full p-0 hover:bg-transparent focus:ring-1 focus:ring-primary focus:ring-offset-1 transition-all duration-200 disabled:opacity-60 disabled:cursor-not-allowed ${r}`,children:e.jsx(ve,{className:"h-8 w-8 border border-border shadow-sm hover:shadow-md transition-all duration-200 hover:scale-105 bg-white",children:X?e.jsx("div",{className:"w-full h-full flex items-center justify-center bg-white dark:bg-neutral-900/20 rounded-full overflow-hidden",children:e.jsx("div",{className:"w-full h-full flex items-center justify-center scale-[2.5]",children:X.component})}):e.jsxs(e.Fragment,{children:[e.jsx(je,{src:t.photoURL||void 0,alt:(s==null?void 0:s.fullName)||t.email||"المستخدم",className:"object-cover"}),e.jsx(Ne,{className:"bg-white text-gray-900 font-semibold text-lg border-0",children:be()})]})})})}),e.jsxs(Fe,{className:"w-64",align:"end",forceMount:!0,children:[e.jsx(Te,{className:"font-normal",children:e.jsxs("div",{className:"flex flex-col space-y-1",children:[e.jsx("p",{className:"text-sm font-medium leading-none",children:(s==null?void 0:s.fullName)||"المستخدم"}),e.jsx("p",{className:"text-xs leading-none text-muted-foreground",children:t.email}),(s==null?void 0:s.role)&&e.jsxs("p",{className:"text-xs leading-none text-muted-foreground",children:["الدور: ",s.role==="staff"?"مدير":s.role==="merchant"?"تاجر":"مستخدم"]})]})}),e.jsx($,{}),e.jsxs(U,{onClick:async()=>{try{await n({showWithdrawNote:!((s==null?void 0:s.showWithdrawNote)??!0)})}catch{}},className:"cursor-pointer",children:[e.jsx(De,{className:"mr-2 h-4 w-4"}),e.jsx("span",{children:(s==null?void 0:s.showWithdrawNote)??!0?"إخفاء خانة ملاحظة السحب":"إظهار خانة ملاحظة السحب"})]}),e.jsx($,{}),e.jsxs(U,{onClick:()=>i("/profile-settings"),className:"cursor-pointer",children:[e.jsx(Ue,{className:"mr-2 h-4 w-4"}),e.jsx("span",{children:"إعدادات البروفيل"})]}),((s==null?void 0:s.role)==="admin"||(s==null?void 0:s.role)==="staff")&&e.jsxs(U,{onClick:()=>i("/admin"),className:"cursor-pointer",children:[e.jsx(Ke,{className:"mr-2 h-4 w-4"}),e.jsx("span",{children:"لوحة الإدارة"})]}),e.jsx($,{}),e.jsxs(U,{onClick:Se,className:"cursor-pointer text-red-600 focus:text-red-600",children:[e.jsx(Me,{className:"mr-2 h-4 w-4"}),e.jsx("span",{children:"تسجيل الخروج"})]})]})]})]}),p&&e.jsx(re,{open:O,onOpenChange:v,children:e.jsxs(ne,{className:"sm:max-w-md",children:[e.jsx(oe,{children:e.jsx(ie,{children:"يوجد تحديث جديد للبرنامج"})}),e.jsx("div",{className:"text-sm",children:_?"جارٍ تنزيل التحديث...":"هل ترغب في تنزيله الآن؟"}),E&&e.jsxs("div",{className:"mt-2 text-xs",children:["الإصدار الجديد: ",e.jsxs("span",{className:"font-semibold",children:["v",E]})]}),h&&e.jsx("div",{className:"mt-2 text-xs text-muted-foreground whitespace-pre-line",children:h}),_&&e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{className:"w-full h-2 bg-gray-200 rounded",children:e.jsx("div",{className:"h-2 bg-blue-600 rounded",style:{width:`${S}%`}})}),e.jsxs("div",{className:"mt-1 text-xs text-muted-foreground",children:[Math.round(S),"%"]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2 mt-3",children:[e.jsx(j,{variant:"outline",onClick:()=>v(!1),children:"إلغاء"}),!_&&e.jsx(j,{className:"bg-blue-600 hover:bg-blue-700",onClick:J,children:"بدء التنزيل"}),S>=100&&e.jsx(j,{className:"bg-green-600 hover:bg-green-700",onClick:Pe,children:"تحديث الآن"})]})]})}),e.jsx(is,{open:x,onOpenChange:w})]})}export{Ns as A,Ps as P};
