import{J as X,r as o,j as e,a2 as je,a4 as $,a8 as Ne,a$ as B,Z as K,u as Z,c as Q,I as R,B as j,E as _,p as U,aB as Pe,aC as Se,b4 as be,a as ye,ac as Ce,M as ke,aj as Ee,af as Ae}from"./index-CRTRtp5n.js";import{L as Ie,D as Le,a as De,b as Me,c as Oe,d as F,e as D}from"./dropdown-menu-BSiXoF6l.js";import{D as ee,a as se,b as te,c as ae,e as Re,d as _e}from"./dialog-01iWrO8X.js";import{L as T}from"./label-CdFvUt-8.js";import{M as Ue}from"./MasterPinDialog-C0ewEeVK.js";import{g as Fe}from"./avatars-BvGfB2nO.js";import{S as Te}from"./shield-DeV9RBuc.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const gs=X("Activity",[["path",{d:"M22 12h-2.48a2 2 0 0 0-1.93 1.46l-2.35 8.36a.25.25 0 0 1-.48 0L9.24 2.18a.25.25 0 0 0-.48 0l-2.35 8.36A2 2 0 0 1 4.49 12H2",key:"169zse"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ge=X("CloudDownload",[["path",{d:"M12 13v8l-4-4",key:"1f5nwf"}],["path",{d:"m12 21 4-4",key:"1lfcce"}],["path",{d:"M4.393 15.269A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.436 8.284",key:"ui1hmy"}]]);var re={exports:{}},ne={};/**
 * @license React
 * use-sync-external-store-shim.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var C=o;function Be(a,t){return a===t&&(a!==0||1/a===1/t)||a!==a&&t!==t}var $e=typeof Object.is=="function"?Object.is:Be,Ke=C.useState,Ve=C.useEffect,We=C.useLayoutEffect,ze=C.useDebugValue;function He(a,t){var s=t(),i=Ke({inst:{value:s,getSnapshot:t}}),r=i[0].inst,n=i[1];return We(function(){r.value=s,r.getSnapshot=t,G(r)&&n({inst:r})},[a,s,t]),Ve(function(){return G(r)&&n({inst:r}),a(function(){G(r)&&n({inst:r})})},[a]),ze(s),s}function G(a){var t=a.getSnapshot;a=a.value;try{var s=t();return!$e(a,s)}catch{return!0}}function qe(a,t){return t()}var Ye=typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"?qe:He;ne.useSyncExternalStore=C.useSyncExternalStore!==void 0?C.useSyncExternalStore:Ye;re.exports=ne;var Je=re.exports;function Xe(){return Je.useSyncExternalStore(Ze,()=>!0,()=>!1)}function Ze(){return()=>{}}var V="Avatar",[Qe]=je(V),[es,oe]=Qe(V),ie=o.forwardRef((a,t)=>{const{__scopeAvatar:s,...i}=a,[r,n]=o.useState("idle");return e.jsx(es,{scope:s,imageLoadingStatus:r,onImageLoadingStatusChange:n,children:e.jsx($.span,{...i,ref:t})})});ie.displayName=V;var ce="AvatarImage",le=o.forwardRef((a,t)=>{const{__scopeAvatar:s,src:i,onLoadingStatusChange:r=()=>{},...n}=a,g=oe(ce,s),f=ss(i,n),m=Ne(p=>{r(p),g.onImageLoadingStatusChange(p)});return B(()=>{f!=="idle"&&m(f)},[f,m]),f==="loaded"?e.jsx($.img,{...n,ref:t,src:i}):null});le.displayName=ce;var de="AvatarFallback",ue=o.forwardRef((a,t)=>{const{__scopeAvatar:s,delayMs:i,...r}=a,n=oe(de,s),[g,f]=o.useState(i===void 0);return o.useEffect(()=>{if(i!==void 0){const m=window.setTimeout(()=>f(!0),i);return()=>window.clearTimeout(m)}},[i]),g&&n.imageLoadingStatus!=="loaded"?e.jsx($.span,{...r,ref:t}):null});ue.displayName=de;function J(a,t){return a?t?(a.src!==t&&(a.src=t),a.complete&&a.naturalWidth>0?"loaded":"loading"):"error":"idle"}function ss(a,{referrerPolicy:t,crossOrigin:s}){const i=Xe(),r=o.useRef(null),n=i?(r.current||(r.current=new window.Image),r.current):null,[g,f]=o.useState(()=>J(n,a));return B(()=>{f(J(n,a))},[n,a]),B(()=>{const m=A=>()=>{f(A)};if(!n)return;const p=m("loaded"),P=m("error");return n.addEventListener("load",p),n.addEventListener("error",P),t&&(n.referrerPolicy=t),typeof s=="string"&&(n.crossOrigin=s),()=>{n.removeEventListener("load",p),n.removeEventListener("error",P)}},[n,s,t]),g}var me=ie,fe=le,he=ue;const we=o.forwardRef(({className:a,...t},s)=>e.jsx(me,{ref:s,className:K("relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",a),...t}));we.displayName=me.displayName;const ge=o.forwardRef(({className:a,...t},s)=>e.jsx(fe,{ref:s,className:K("aspect-square h-full w-full",a),...t}));ge.displayName=fe.displayName;const xe=o.forwardRef(({className:a,...t},s)=>e.jsx(he,{ref:s,className:K("flex h-full w-full items-center justify-center rounded-full bg-muted",a),...t}));xe.displayName=he.displayName;function ts({open:a,onOpenChange:t}){const{user:s}=Z(),{toast:i}=Q(),[r,n]=o.useState(!1),[g,f]=o.useState(!1),[m,p]=o.useState(!1),[P,A]=o.useState(!1),[W,b]=o.useState(!1),[z,y]=o.useState(!1),[w,I]=o.useState({currentPassword:"",newPassword:"",confirmPassword:""}),[d,x]=o.useState({currentPassword:"",newPassword:"",confirmPassword:""}),M=()=>{const l={currentPassword:"",newPassword:"",confirmPassword:""};return w.currentPassword||(l.currentPassword="كلمة المرور الحالية مطلوبة"),w.newPassword?w.newPassword.length<6&&(l.newPassword="كلمة المرور يجب أن تكون 6 أحرف على الأقل"):l.newPassword="كلمة المرور الجديدة مطلوبة",w.confirmPassword?w.newPassword!==w.confirmPassword&&(l.confirmPassword="كلمات المرور غير متطابقة"):l.confirmPassword="تأكيد كلمة المرور مطلوب",x(l),!Object.values(l).some(u=>u!=="")},L=async l=>{if(l.preventDefault(),!(!M()||!s||!s.email)){n(!0);try{const u=Pe.credential(s.email,w.currentPassword);await Se(s,u),y(!0),b(!0),i({title:"تأكيد الهوية",description:"أدخل الرقم السري الرئيسي لتأكيد تغيير كلمة المرور"})}catch(u){console.error("خطأ في تغيير كلمة المرور:",u);let v="حدث خطأ أثناء تغيير كلمة المرور";if(u.code==="auth/wrong-password"){x(E=>({...E,currentPassword:"كلمة المرور الحالية غير صحيحة"}));return}else if(u.code==="auth/weak-password"){x(E=>({...E,newPassword:"كلمة المرور ضعيفة جداً"}));return}else u.code==="auth/requires-recent-login"&&(v="يجب تسجيل الدخول مرة أخرى لتغيير كلمة المرور");i({title:"خطأ في تغيير كلمة المرور",description:v,variant:"destructive"})}finally{n(!1)}}},O=async()=>{if(s){n(!0);try{await be(s,w.newPassword),i({title:"تم تغيير كلمة المرور بنجاح",description:"تم تحديث كلمة المرور الخاصة بك بنجاح"}),I({currentPassword:"",newPassword:"",confirmPassword:""}),x({currentPassword:"",newPassword:"",confirmPassword:""}),b(!1),y(!1),t(!1)}catch(l){console.error("خطأ في تحديث كلمة المرور:",l);let u="حدث خطأ أثناء تغيير كلمة المرور";l.code==="auth/requires-recent-login"&&(u="انتهت جلسة المصادقة. يرجى إعادة إدخال كلمة المرور الحالية"),i({title:"خطأ في تغيير كلمة المرور",description:u,variant:"destructive"})}finally{n(!1)}}},S=l=>u=>{I(v=>({...v,[l]:u.target.value})),d[l]&&x(v=>({...v,[l]:""}))},k=()=>{I({currentPassword:"",newPassword:"",confirmPassword:""}),x({currentPassword:"",newPassword:"",confirmPassword:""}),b(!1),y(!1),t(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(ee,{open:a,onOpenChange:k,children:e.jsxs(se,{className:"sm:max-w-[425px]",children:[e.jsxs(te,{children:[e.jsx(ae,{children:"تغيير كلمة المرور"}),e.jsx(Re,{children:"أدخل كلمة المرور الحالية وكلمة المرور الجديدة لتحديث حسابك"})]}),e.jsxs("form",{onSubmit:L,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(T,{htmlFor:"currentPassword",children:"كلمة المرور الحالية"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"currentPassword",type:g?"text":"password",value:w.currentPassword,onChange:S("currentPassword"),className:d.currentPassword?"border-red-500":"",autoComplete:"off",disabled:r}),e.jsx(j,{type:"button",variant:"ghost",size:"sm",className:"absolute right-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>f(!g),disabled:r,children:g?e.jsx(_,{className:"h-4 w-4"}):e.jsx(U,{className:"h-4 w-4"})})]}),d.currentPassword&&e.jsx("p",{className:"text-sm text-red-500",children:d.currentPassword})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(T,{htmlFor:"newPassword",children:"كلمة المرور الجديدة"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"newPassword",type:m?"text":"password",value:w.newPassword,onChange:S("newPassword"),className:d.newPassword?"border-red-500":"",autoComplete:"new-password",disabled:r}),e.jsx(j,{type:"button",variant:"ghost",size:"sm",className:"absolute right-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>p(!m),disabled:r,children:m?e.jsx(_,{className:"h-4 w-4"}):e.jsx(U,{className:"h-4 w-4"})})]}),d.newPassword&&e.jsx("p",{className:"text-sm text-red-500",children:d.newPassword})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(T,{htmlFor:"confirmPassword",children:"تأكيد كلمة المرور الجديدة"}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{id:"confirmPassword",type:P?"text":"password",value:w.confirmPassword,onChange:S("confirmPassword"),className:d.confirmPassword?"border-red-500":"",autoComplete:"new-password",disabled:r}),e.jsx(j,{type:"button",variant:"ghost",size:"sm",className:"absolute right-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>A(!P),disabled:r,children:P?e.jsx(_,{className:"h-4 w-4"}):e.jsx(U,{className:"h-4 w-4"})})]}),d.confirmPassword&&e.jsx("p",{className:"text-sm text-red-500",children:d.confirmPassword})]}),e.jsxs(_e,{children:[e.jsx(j,{type:"button",variant:"outline",onClick:k,disabled:r,children:"إلغاء"}),e.jsxs(j,{type:"submit",disabled:r,children:[r&&e.jsx(Ie,{className:"mr-2 h-4 w-4 animate-spin"}),"تغيير كلمة المرور"]})]})]})]})}),e.jsx(Ue,{open:W&&z,onOpenChange:l=>{b(l),l||y(!1)},mode:"verify",title:"التحقق من الرقم السري الرئيسي",description:"لا يمكن تغيير كلمة المرور إلا بعد التحقق من الرقم السري الرئيسي",onSuccess:O,onCancel:()=>{b(!1),y(!1)}})]})}const as="cashy.google.accessToken",rs="cashy.google.email",ns="cashy.google.expiresAt";function os(){try{const a=localStorage.getItem(as),t=localStorage.getItem(rs),s=localStorage.getItem(ns),i=s?Number(s):null;return{token:a,email:t,expiresAt:i}}catch{return{token:null,email:null,expiresAt:null}}}async function is(a,t,s){try{const i=await fetch("/user/google-backup-token",{method:"POST",headers:{"Content-Type":"application/json","X-USER-ID":a},body:JSON.stringify({email:t,refresh_token:s})}),r=await i.json().catch(()=>({}));return!!(i.ok&&(r!=null&&r.ok))}catch{return!1}}function xs({className:a}){const{user:t,profile:s,signOut:i,updateUserProfile:r}=Z(),n=ye(),[g,f]=o.useState(!1),{isShiftActive:m}=Ce(),{toast:p}=Q(),[P,A]=o.useState(!1),[W,b]=o.useState(!1),[z,y]=o.useState(!1),[{token:w},I]=o.useState(()=>os()),d=typeof window<"u"?window.electronAPI:void 0,x=!!d,[M,L]=o.useState(!1),[O,S]=o.useState(!1),[k,l]=o.useState(""),[u,v]=o.useState("");o.useEffect(()=>{if(!(!x||!d))try{d.onUpdateAvailable(c=>{var h,N;L(!0),l(String(((h=c==null?void 0:c.info)==null?void 0:h.version)||"")),v(String(((N=c==null?void 0:c.info)==null?void 0:N.notes)||""))}),d.onUpdateDownloaded(c=>{var h,N;L(!0),l(String(((h=c==null?void 0:c.info)==null?void 0:h.version)||"")),v(String(((N=c==null?void 0:c.info)==null?void 0:N.notes)||""))}),d.checkUpdate()}catch{}},[x,d]);const E=async()=>{try{d&&await d.downloadAndInstallUpdate()}catch{}},pe=()=>s!=null&&s.fullName?s==null?void 0:s.fullName.split(" ").map(c=>c.charAt(0)).join("").toUpperCase().slice(0,2):t.email?t.email.charAt(0).toUpperCase():"U",H=s!=null&&s.avatarId?Fe(s.avatarId):null;if(o.useEffect(()=>{console.log("Profile updated in ProfileIcon:",s==null?void 0:s.avatarId)},[s==null?void 0:s.avatarId]),o.useEffect(()=>{const c=async h=>{try{if(!(h!=null&&h.data)||typeof h.data!="object"||h.origin!=="https://cashy.link")return;const{type:N,email:q,refresh_token:Y}=h.data||{};N==="cashy_oauth_token"&&(t!=null&&t.uid)&&q&&Y&&await is(t.uid,String(q),String(Y))&&p({title:"تم ربط جوجل",description:"تم حفظ توكن النسخ الاحتياطي عبر الخادم."})}catch{}};return window.addEventListener("message",c),()=>window.removeEventListener("message",c)},[t==null?void 0:t.uid]),!t)return null;const ve=async()=>{try{await i(),n("/user/login",{replace:!0})}catch(c){console.error("خطأ في تسجيل الخروج:",c);try{n("/user/login",{replace:!0})}catch{}}};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[x&&e.jsxs(j,{type:"button",onClick:()=>S(!0),title:"تحديث التطبيق",className:"relative inline-flex items-center justify-center w-9 h-9 rounded-md bg-transparent text-blue-600 hover:bg-blue-500/10 focus:outline-none dark:text-blue-400 dark:hover:bg-blue-400/10",variant:"ghost",children:[e.jsx(Ge,{className:"w-5 h-5"}),M&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 inline-block w-2 h-2 rounded-full bg-red-500"})]}),e.jsxs(Le,{children:[e.jsx(De,{asChild:!0,children:e.jsx(j,{variant:"ghost",disabled:m,title:m?"غير متاح أثناء وجود وردية كاشير نشطة":void 0,className:`relative h-8 w-8 rounded-full p-0 hover:bg-transparent focus:ring-1 focus:ring-primary focus:ring-offset-1 transition-all duration-200 disabled:opacity-60 disabled:cursor-not-allowed ${a}`,children:e.jsx(we,{className:"h-8 w-8 border border-border shadow-sm hover:shadow-md transition-all duration-200 hover:scale-105 bg-white",children:H?e.jsx("div",{className:"w-full h-full flex items-center justify-center bg-white dark:bg-neutral-900/20 rounded-full overflow-hidden",children:e.jsx("div",{className:"w-full h-full flex items-center justify-center scale-[2.5]",children:H.component})}):e.jsxs(e.Fragment,{children:[e.jsx(ge,{src:t.photoURL||void 0,alt:(s==null?void 0:s.fullName)||t.email||"المستخدم",className:"object-cover"}),e.jsx(xe,{className:"bg-white text-gray-900 font-semibold text-lg border-0",children:pe()})]})})})}),e.jsxs(Me,{className:"w-64",align:"end",forceMount:!0,children:[e.jsx(Oe,{className:"font-normal",children:e.jsxs("div",{className:"flex flex-col space-y-1",children:[e.jsx("p",{className:"text-sm font-medium leading-none",children:(s==null?void 0:s.fullName)||"المستخدم"}),e.jsx("p",{className:"text-xs leading-none text-muted-foreground",children:t.email}),(s==null?void 0:s.role)&&e.jsxs("p",{className:"text-xs leading-none text-muted-foreground",children:["الدور: ",s.role==="staff"?"مدير":s.role==="merchant"?"تاجر":"مستخدم"]})]})}),e.jsx(F,{}),e.jsxs(D,{onClick:async()=>{try{await r({showWithdrawNote:!((s==null?void 0:s.showWithdrawNote)??!0)})}catch{}},className:"cursor-pointer",children:[e.jsx(ke,{className:"mr-2 h-4 w-4"}),e.jsx("span",{children:(s==null?void 0:s.showWithdrawNote)??!0?"إخفاء خانة ملاحظة السحب":"إظهار خانة ملاحظة السحب"})]}),e.jsx(F,{}),e.jsxs(D,{onClick:()=>n("/profile-settings"),className:"cursor-pointer",children:[e.jsx(Ee,{className:"mr-2 h-4 w-4"}),e.jsx("span",{children:"إعدادات البروفيل"})]}),((s==null?void 0:s.role)==="admin"||(s==null?void 0:s.role)==="staff")&&e.jsxs(D,{onClick:()=>n("/admin"),className:"cursor-pointer",children:[e.jsx(Te,{className:"mr-2 h-4 w-4"}),e.jsx("span",{children:"لوحة الإدارة"})]}),e.jsx(F,{}),e.jsxs(D,{onClick:ve,className:"cursor-pointer text-red-600 focus:text-red-600",children:[e.jsx(Ae,{className:"mr-2 h-4 w-4"}),e.jsx("span",{children:"تسجيل الخروج"})]})]})]})]}),x&&e.jsx(ee,{open:O,onOpenChange:S,children:e.jsxs(se,{className:"sm:max-w-md",children:[e.jsx(te,{children:e.jsx(ae,{children:"يوجد تحديث جديد للبرنامج"})}),e.jsx("div",{className:"text-sm",children:"هل ترغب في تنزيله الآن؟"}),k&&e.jsxs("div",{className:"mt-2 text-xs",children:["الإصدار الجديد: ",e.jsxs("span",{className:"font-semibold",children:["v",k]})]}),u&&e.jsx("div",{className:"mt-2 text-xs text-muted-foreground whitespace-pre-line",children:u}),e.jsxs("div",{className:"flex items-center justify-end gap-2 mt-3",children:[e.jsx(j,{variant:"outline",onClick:()=>S(!1),children:"إلغاء"}),e.jsx(j,{className:"bg-blue-600 hover:bg-blue-700",onClick:E,children:"تنزيل وتحديث"})]})]})}),e.jsx(ts,{open:g,onOpenChange:f})]})}export{gs as A,xs as P};
