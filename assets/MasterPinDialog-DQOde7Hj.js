import{s as L,H as oe,v as H,f as $,O as fe,ay as he,K as de,c as I,r as c,j as e,n as ee,I as O,B as p,d as ue,aB as me,aC as xe,u as ge,E as _,p as B}from"./index-5EflPS7Y.js";import{L as K}from"./label-BbMWBagC.js";import{D as te,a as se,b as ae,c as re,e as pe,d as ye}from"./dialog-CY7KVlhj.js";import{S as ve}from"./shield-Aq4l2F3b.js";import{C as je}from"./circle-alert-L2Owt6-y.js";const X="master_pin";let g=new Map;function P(i){return i?`${X}_${i}`:X}async function we(i){try{const t=await he.getUserData(i),s=(t==null?void 0:t.security)&&t.security.masterPin||(t==null?void 0:t.masterPin)||null;return typeof s=="string"&&s.length>0?s:null}catch{try{const t=H($,"users",i),s=await de(t);if(s.exists()){const a=s.data(),r=(a==null?void 0:a.security)&&a.security.masterPin||(a==null?void 0:a.masterPin)||null;return typeof r=="string"&&r.length>0?r:null}}catch{}return null}}function Z(i){try{const t=localStorage.getItem(P(i));return t&&t.length>0?t:null}catch{return null}}async function V(i,t){try{const s={security:{masterPin:t||null,masterPinUpdatedAt:L()},updatedAt:L()};await oe(H($,"users",i),s,{merge:!0})}catch{try{await fe(H($,"users",i),{security:{masterPin:t||null,masterPinUpdatedAt:L()},updatedAt:L()})}catch{}}}function k(i,t){try{const s=P(i);t?localStorage.setItem(s,t):localStorage.removeItem(s)}catch{}}class w{static async hasMasterPin(t){const s=P(t);if(g.has(s)){const r=g.get(s);return r!==""&&r!=null}const a=Z(t);if(a)return g.set(s,a),!0;if(t){const r=Z(void 0);if(r){g.set(s,r),k(t,r);try{k(void 0,null)}catch{}return await V(t,r),!0}}if(t){const r=await we(t);if(r){g.set(s,r),k(t,r);try{k(void 0,null)}catch{}return!0}}return!1}static async createMasterPin(t,s){try{if(!t||t.length<4)return!1;const a=btoa(t),r=P(s);return g.set(r,a),k(s,a),s&&await V(s,a),!0}catch(a){return console.error("Error creating master PIN:",a),!1}}static async verifyMasterPin(t,s){try{const a=P(s);if(!await this.hasMasterPin(s))return!1;const r=g.get(a);return r?atob(r)===t:!1}catch(a){return console.error("Error verifying master PIN:",a),!1}}static async changeMasterPin(t,s,a){try{return await this.verifyMasterPin(t,a)?await this.createMasterPin(s,a):!1}catch(r){return console.error("Error changing master PIN:",r),!1}}static async deleteMasterPin(t){try{const s=P(t);return g.delete(s),k(t,null),t&&await V(t,null),!0}catch(s){return console.error("Error deleting master PIN:",s),!1}}static async getMasterPin(t){try{const s=P(t);if(!await this.hasMasterPin(t))return null;const a=g.get(s);return a?atob(a):null}catch(s){return console.error("Error getting master PIN:",s),null}}}const Pe=({open:i,onOpenChange:t,title:s="تأكيد كلمة المرور",description:a="أدخل كلمة مرور تسجيل الدخول للمتابعة",onSuccess:r})=>{const{toast:n}=I(),[u,N]=c.useState(""),[o,y]=c.useState(!1),[b,m]=c.useState(null),M=async()=>{m(null);try{const l=ue.currentUser;if(!l||!l.email){m("لا يوجد مستخدم مسجل حالياً. يرجى تسجيل الدخول أولاً.");return}y(!0);const v=me.credential(l.email,u);await xe(l,v),y(!1),N(""),n({title:"تم التأكيد",description:"تم التحقق من كلمة المرور بنجاح"}),r(),t&&t(!1)}catch(l){console.error("إعادة التحقق بكلمة المرور فشلت:",l),y(!1);const v=(l==null?void 0:l.code)||"";m(v==="auth/wrong-password"?"كلمة المرور غير صحيحة. حاول مرة أخرى.":v==="auth/too-many-requests"?"تمت محاولات كثيرة. يرجى الانتظار قليلاً ثم المحاولة.":"حدث خطأ أثناء التحقق. حاول مرة أخرى.")}},E=l=>{t&&t(l),l||(N(""),m(null),y(!1))};return e.jsx(te,{open:i,onOpenChange:E,children:e.jsxs(se,{className:"sm:max-w-[400px]",children:[e.jsxs(ae,{children:[e.jsx(re,{className:"text-right",children:s}),e.jsx(pe,{className:"text-right",children:a})]}),e.jsxs("div",{className:"grid gap-4 py-2",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-2",children:[e.jsx("label",{htmlFor:"password",className:"text-right col-span-1 text-sm",children:"كلمة المرور"}),e.jsxs("div",{className:"col-span-3 relative",children:[e.jsx(ee,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx(O,{id:"password",type:"password",value:u,onChange:l=>N(l.target.value),placeholder:"نفس كلمة مرور تسجيل الدخول",autoComplete:"off"})]})]}),b&&e.jsx("div",{className:"text-red-600 text-xs text-right",children:b})]}),e.jsxs(ye,{className:"flex justify-end gap-2",children:[e.jsx(p,{variant:"outline",onClick:()=>E(!1),disabled:o,children:"إلغاء"}),e.jsx(p,{onClick:M,disabled:o||!u,children:o?"جاري التحقق...":"تأكيد"})]})]})})},Ee=({open:i,onOpenChange:t,onSuccess:s,title:a="الرقم السري الرئيسي",description:r="رقم سري موحد لإدارة جميع عناصر الموقع",mode:n="verify"})=>{const[u,N]=c.useState(""),[o,y]=c.useState(""),[b,m]=c.useState(""),[M,E]=c.useState(!1),[l,v]=c.useState(!1),[U,q]=c.useState(!1),[W,f]=c.useState(""),[Y,h]=c.useState(!1),{toast:R}=I(),{user:T,profile:C}=ge(),x=T==null?void 0:T.uid,[j,ne]=c.useState(!1),[S,ie]=c.useState(!1),G=(C==null?void 0:C.role)==="admin"||(C==null?void 0:C.role)==="staff",[le,F]=c.useState(!1),[z,J]=c.useState(!1);c.useEffect(()=>{let d=!0;return i&&(async()=>{try{const Q=await w.hasMasterPin(x);d&&ne(Q)}catch{}})(),()=>{d=!1}},[x,i]);const ce=async d=>{d.preventDefault(),f(""),h(!0);try{if(n==="verify"){if(!u){f("يرجى إدخال الرقم السري الرئيسي"),h(!1);return}if(!await w.verifyMasterPin(u,x)){f("الرقم السري غير صحيح"),h(!1);return}R({title:"تم التأكيد",description:"تم التحقق من الرقم السري بنجاح"}),s==null||s(),D()}else if(n==="create"){if(!o||o.length<4){f("يجب أن يكون الرقم السري الجديد 4 أرقام على الأقل"),h(!1);return}if(o!==b){f("الرقم السري الجديد وتأكيده غير متطابقين"),h(!1);return}if(!await w.createMasterPin(o,x)){f("تعذر إنشاء الرقم السري الرئيسي"),h(!1);return}R({title:"تم تعيين الرقم السري الرئيسي",description:"تم تعيين الرقم السري الرئيسي بنجاح"}),s==null||s(),D()}else if(n==="change"){if(!x){f("لا يمكن تغيير الرقم السري قبل تحميل حساب المستخدم. الرجاء إعادة المحاولة بعد تسجيل الدخول أو انتظار التحميل."),h(!1);return}if(j&&!S&&!z){if(!u){f("يرجى إدخال الرقم السري الحالي أو تأكيد كلمة الدخول"),h(!1);return}if(!await w.verifyMasterPin(u,x)){f("الرقم السري الحالي غير صحيح"),h(!1);return}}if(!o||o.length<4){f("يجب أن يكون الرقم السري الجديد 4 أرقام على الأقل"),h(!1);return}if(o!==b){f("الرقم السري الجديد وتأكيده غير متطابقين"),h(!1);return}if(!(j?S&&G?await w.createMasterPin(o,x):await w.changeMasterPin(u,o,x):await w.createMasterPin(o,x))){f("تعذر تغيير الرقم السري الرئيسي"),h(!1);return}R({title:j?S?"تم إعادة تعيين الرقم السري الرئيسي":"تم تغيير الرقم السري الرئيسي":"تم تعيين الرقم السري الرئيسي",description:j?S?"تمت إعادة التعيين بدون الحاجة للرقم الحالي (صلاحية إدارية)":"تم تغيير الرقم السري الرئيسي بنجاح":"تم تعيين الرقم السري الرئيسي بنجاح"}),s==null||s(),D()}}catch{f("حدث خطأ أثناء معالجة الرقم السري")}finally{h(!1)}},D=()=>{N(""),y(""),m(""),f(""),E(!1),v(!1),q(!1),J(!1),F(!1),t(!1)};return e.jsx(te,{open:i,onOpenChange:D,children:e.jsxs(se,{className:"sm:max-w-md",dir:"rtl",children:[e.jsx(ae,{children:e.jsxs(re,{className:"flex items-center gap-2 text-center justify-center",children:[e.jsx(ve,{className:"h-5 w-5 text-blue-600"}),a]})}),e.jsx("div",{className:"text-center text-sm text-gray-600 mb-4",children:r}),e.jsxs("form",{onSubmit:ce,className:"space-y-4",children:[(n==="verify"||n==="change"&&j)&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(K,{htmlFor:"currentPin",className:"text-right block",children:n==="verify"?"الرقم السري الرئيسي":"الرقم السري الحالي"}),e.jsxs("div",{className:"relative",children:[e.jsx(O,{id:"currentPin",type:M?"text":"password",autoComplete:"off",value:u,onChange:d=>N(d.target.value),placeholder:n==="verify"?"أدخل الرقم السري الرئيسي":"أدخل الرقم السري الحالي",className:"pr-10",dir:"ltr",disabled:n==="change"&&z}),e.jsx(p,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>E(!M),children:M?e.jsx(_,{className:"h-4 w-4"}):e.jsx(B,{className:"h-4 w-4"})})]}),n==="change"&&j&&G&&e.jsxs("div",{className:"text-xs text-gray-600 mt-2 flex items-center justify-between",children:[e.jsx("span",{children:"نسيت الرقم السري؟"}),e.jsx(p,{type:"button",variant:"outline",size:"sm",className:"h-7 px-2",onClick:()=>{ie(d=>!d)},children:S?"إلغاء إعادة التعيين الإدارية":"إعادة تعيين بدون الرقم الحالي"})]}),n==="change"&&j&&e.jsxs("div",{className:"text-xs text-gray-600 mt-2 flex items-center justify-between",children:[e.jsx("span",{children:"لا تعرف الرقم الحالي؟ يمكنك تأكيد بكلمة الدخول"}),e.jsx(p,{type:"button",variant:"secondary",size:"sm",className:"h-7 px-2",onClick:()=>F(!0),children:"تأكيد بكلمة الدخول"})]}),n==="change"&&z&&e.jsx("div",{className:"text-[11px] text-green-600",children:"تم التحقق من كلمة الدخول — يمكنك المتابعة بدون الرقم الحالي"})]}),(n==="create"||n==="change")&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(K,{htmlFor:"newPin",className:"text-right block",children:n==="create"?"الرقم السري الرئيسي الجديد":"الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(O,{id:"newPin",type:l?"text":"password",autoComplete:"off",value:o,onChange:d=>y(d.target.value),placeholder:"أدخل الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(p,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>v(!l),children:l?e.jsx(_,{className:"h-4 w-4"}):e.jsx(B,{className:"h-4 w-4"})})]})]}),(n==="create"||n==="change")&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(K,{htmlFor:"confirmPin",className:"text-right block",children:"تأكيد الرقم السري الجديد"}),e.jsxs("div",{className:"relative",children:[e.jsx(O,{id:"confirmPin",type:U?"text":"password",autoComplete:"off",value:b,onChange:d=>m(d.target.value),placeholder:"أعد إدخال الرقم السري الجديد",className:"pr-10",dir:"ltr"}),e.jsx(p,{type:"button",variant:"ghost",size:"sm",className:"absolute left-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>q(!U),children:U?e.jsx(_,{className:"h-4 w-4"}):e.jsx(B,{className:"h-4 w-4"})})]})]}),W&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm bg-red-50 p-3 rounded-lg",children:[e.jsx(je,{className:"h-4 w-4"}),W]}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx(p,{type:"button",variant:"outline",onClick:D,className:"flex-1",children:"إلغاء"}),e.jsx(p,{type:"submit",disabled:Y,className:"flex-1 bg-blue-600 hover:bg-blue-700",children:Y?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"جاري المعالجة..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ee,{className:"h-4 w-4 mr-2"}),n==="verify"?"تحقق":n==="create"?"إنشاء":"تغيير"]})})]})]}),e.jsx(Pe,{open:le,onOpenChange:F,title:"تأكيد بكلمة دخول الحساب",description:"أدخل كلمة المرور المستخدمة لتسجيل الدخول للسماح بتغيير الرقم السري",onSuccess:()=>{J(!0),F(!1),f("")}})]})})};export{Ee as M,Pe as P,w as a};
