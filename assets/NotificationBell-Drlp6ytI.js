import{J as H,r as l,j as s,a2 as lt,a4 as je,a8 as dt,a$ as he,Z as ke,u as Se,c as Me,I as ne,B as y,E as oe,p as ie,aB as ut,aC as ft,b4 as mt,b5 as Le,b6 as ht,ay as ae,ao as pe,b7 as ge,ae as pt,a as gt,ac as wt,M as xt,aj as vt,af as yt,d as J,$ as jt,q as kt,e as Re,f as _e,an as St,w as bt,C as Nt,k as At,s as Pt}from"./index-Bk7WpSNT.js";import{L as Ct,D as we,a as xe,b as ve,c as ye,d as Q,e as U}from"./dropdown-menu-BA-GiD_j.js";import{D as be,a as Ne,b as Ae,c as Pe,e as Be,d as Fe,f as It}from"./dialog-BkD4Us5y.js";import{L as ce}from"./label-D23p4byo.js";import{M as Dt}from"./MasterPinDialog-Dh4NdYvu.js";import{g as Tt}from"./avatars-G9Kqs6Mc.js";import{R as Et}from"./refresh-cw-B5021kgo.js";import{S as Lt}from"./shield-mj0kRabk.js";import{a as Rt,E as _t}from"./broadcastService-fareK3t5.js";import{B as Oe,T as Ot}from"./textarea-BtAnBPC_.js";import{C as le}from"./circle-check-big-CdOBj4Nx.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Is=H("Activity",[["path",{d:"M22 12h-2.48a2 2 0 0 0-1.93 1.46l-2.35 8.36a.25.25 0 0 1-.48 0L9.24 2.18a.25.25 0 0 0-.48 0l-2.35 8.36A2 2 0 0 1 4.49 12H2",key:"169zse"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ut=H("CloudDownload",[["path",{d:"M12 13v8l-4-4",key:"1f5nwf"}],["path",{d:"m12 21 4-4",key:"1lfcce"}],["path",{d:"M4.393 15.269A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.436 8.284",key:"ui1hmy"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Mt=H("CloudUpload",[["path",{d:"M12 13v8",key:"1l5pq0"}],["path",{d:"M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242",key:"1pljnt"}],["path",{d:"m8 17 4-4 4 4",key:"1quai1"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Bt=H("Cloud",[["path",{d:"M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z",key:"p7xjir"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ft=H("LogIn",[["path",{d:"M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4",key:"u53s6r"}],["polyline",{points:"10 17 15 12 10 7",key:"1ail0h"}],["line",{x1:"15",x2:"3",y1:"12",y2:"12",key:"v6grx8"}]]);var $e={exports:{}},Ge={};/**
 * @license React
 * use-sync-external-store-shim.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var q=l;function $t(a,t){return a===t&&(a!==0||1/a===1/t)||a!==a&&t!==t}var Gt=typeof Object.is=="function"?Object.is:$t,zt=q.useState,qt=q.useEffect,Wt=q.useLayoutEffect,Jt=q.useDebugValue;function Kt(a,t){var e=t(),o=zt({inst:{value:e,getSnapshot:t}}),r=o[0].inst,n=o[1];return Wt(function(){r.value=e,r.getSnapshot=t,de(r)&&n({inst:r})},[a,e,t]),qt(function(){return de(r)&&n({inst:r}),a(function(){de(r)&&n({inst:r})})},[a]),Jt(e),e}function de(a){var t=a.getSnapshot;a=a.value;try{var e=t();return!Gt(a,e)}catch{return!0}}function Vt(a,t){return t()}var Qt=typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"?Vt:Kt;Ge.useSyncExternalStore=q.useSyncExternalStore!==void 0?q.useSyncExternalStore:Qt;$e.exports=Ge;var Ht=$e.exports;function Xt(){return Ht.useSyncExternalStore(Yt,()=>!0,()=>!1)}function Yt(){return()=>{}}var Ce="Avatar",[Zt]=lt(Ce),[es,ze]=Zt(Ce),qe=l.forwardRef((a,t)=>{const{__scopeAvatar:e,...o}=a,[r,n]=l.useState("idle");return s.jsx(es,{scope:e,imageLoadingStatus:r,onImageLoadingStatusChange:n,children:s.jsx(je.span,{...o,ref:t})})});qe.displayName=Ce;var We="AvatarImage",Je=l.forwardRef((a,t)=>{const{__scopeAvatar:e,src:o,onLoadingStatusChange:r=()=>{},...n}=a,u=ze(We,e),c=ts(o,n),f=dt(p=>{r(p),u.onImageLoadingStatusChange(p)});return he(()=>{c!=="idle"&&f(c)},[c,f]),c==="loaded"?s.jsx(je.img,{...n,ref:t,src:o}):null});Je.displayName=We;var Ke="AvatarFallback",Ve=l.forwardRef((a,t)=>{const{__scopeAvatar:e,delayMs:o,...r}=a,n=ze(Ke,e),[u,c]=l.useState(o===void 0);return l.useEffect(()=>{if(o!==void 0){const f=window.setTimeout(()=>c(!0),o);return()=>window.clearTimeout(f)}},[o]),u&&n.imageLoadingStatus!=="loaded"?s.jsx(je.span,{...r,ref:t}):null});Ve.displayName=Ke;function Ue(a,t){return a?t?(a.src!==t&&(a.src=t),a.complete&&a.naturalWidth>0?"loaded":"loading"):"error":"idle"}function ts(a,{referrerPolicy:t,crossOrigin:e}){const o=Xt(),r=l.useRef(null),n=o?(r.current||(r.current=new window.Image),r.current):null,[u,c]=l.useState(()=>Ue(n,a));return he(()=>{c(Ue(n,a))},[n,a]),he(()=>{const f=A=>()=>{c(A)};if(!n)return;const p=f("loaded"),k=f("error");return n.addEventListener("load",p),n.addEventListener("error",k),t&&(n.referrerPolicy=t),typeof e=="string"&&(n.crossOrigin=e),()=>{n.removeEventListener("load",p),n.removeEventListener("error",k)}},[n,e,t]),u}var Qe=qe,He=Je,Xe=Ve;const Ye=l.forwardRef(({className:a,...t},e)=>s.jsx(Qe,{ref:e,className:ke("relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",a),...t}));Ye.displayName=Qe.displayName;const Ze=l.forwardRef(({className:a,...t},e)=>s.jsx(He,{ref:e,className:ke("aspect-square h-full w-full",a),...t}));Ze.displayName=He.displayName;const et=l.forwardRef(({className:a,...t},e)=>s.jsx(Xe,{ref:e,className:ke("flex h-full w-full items-center justify-center rounded-full bg-muted",a),...t}));et.displayName=Xe.displayName;function ss({open:a,onOpenChange:t}){const{user:e}=Se(),{toast:o}=Me(),[r,n]=l.useState(!1),[u,c]=l.useState(!1),[f,p]=l.useState(!1),[k,A]=l.useState(!1),[T,x]=l.useState(!1),[L,P]=l.useState(!1),[v,S]=l.useState({currentPassword:"",newPassword:"",confirmPassword:""}),[g,N]=l.useState({currentPassword:"",newPassword:"",confirmPassword:""}),X=()=>{const w={currentPassword:"",newPassword:"",confirmPassword:""};return v.currentPassword||(w.currentPassword="كلمة المرور الحالية مطلوبة"),v.newPassword?v.newPassword.length<6&&(w.newPassword="كلمة المرور يجب أن تكون 6 أحرف على الأقل"):w.newPassword="كلمة المرور الجديدة مطلوبة",v.confirmPassword?v.newPassword!==v.confirmPassword&&(w.confirmPassword="كلمات المرور غير متطابقة"):w.confirmPassword="تأكيد كلمة المرور مطلوب",N(w),!Object.values(w).some(j=>j!=="")},M=async w=>{if(w.preventDefault(),!(!X()||!e||!e.email)){n(!0);try{const j=ut.credential(e.email,v.currentPassword);await ft(e,j),P(!0),x(!0),o({title:"تأكيد الهوية",description:"أدخل الرقم السري الرئيسي لتأكيد تغيير كلمة المرور"})}catch(j){console.error("خطأ في تغيير كلمة المرور:",j);let C="حدث خطأ أثناء تغيير كلمة المرور";if(j.code==="auth/wrong-password"){N(R=>({...R,currentPassword:"كلمة المرور الحالية غير صحيحة"}));return}else if(j.code==="auth/weak-password"){N(R=>({...R,newPassword:"كلمة المرور ضعيفة جداً"}));return}else j.code==="auth/requires-recent-login"&&(C="يجب تسجيل الدخول مرة أخرى لتغيير كلمة المرور");o({title:"خطأ في تغيير كلمة المرور",description:C,variant:"destructive"})}finally{n(!1)}}},Y=async()=>{if(e){n(!0);try{await mt(e,v.newPassword),o({title:"تم تغيير كلمة المرور بنجاح",description:"تم تحديث كلمة المرور الخاصة بك بنجاح"}),S({currentPassword:"",newPassword:"",confirmPassword:""}),N({currentPassword:"",newPassword:"",confirmPassword:""}),x(!1),P(!1),t(!1)}catch(w){console.error("خطأ في تحديث كلمة المرور:",w);let j="حدث خطأ أثناء تغيير كلمة المرور";w.code==="auth/requires-recent-login"&&(j="انتهت جلسة المصادقة. يرجى إعادة إدخال كلمة المرور الحالية"),o({title:"خطأ في تغيير كلمة المرور",description:j,variant:"destructive"})}finally{n(!1)}}},I=w=>j=>{S(C=>({...C,[w]:j.target.value})),g[w]&&N(C=>({...C,[w]:""}))},_=()=>{S({currentPassword:"",newPassword:"",confirmPassword:""}),N({currentPassword:"",newPassword:"",confirmPassword:""}),x(!1),P(!1),t(!1)};return s.jsxs(s.Fragment,{children:[s.jsx(be,{open:a,onOpenChange:_,children:s.jsxs(Ne,{className:"sm:max-w-[425px]",children:[s.jsxs(Ae,{children:[s.jsx(Pe,{children:"تغيير كلمة المرور"}),s.jsx(Be,{children:"أدخل كلمة المرور الحالية وكلمة المرور الجديدة لتحديث حسابك"})]}),s.jsxs("form",{onSubmit:M,className:"space-y-4",children:[s.jsxs("div",{className:"space-y-2",children:[s.jsx(ce,{htmlFor:"currentPassword",children:"كلمة المرور الحالية"}),s.jsxs("div",{className:"relative",children:[s.jsx(ne,{id:"currentPassword",type:u?"text":"password",value:v.currentPassword,onChange:I("currentPassword"),className:g.currentPassword?"border-red-500":"",autoComplete:"off",disabled:r}),s.jsx(y,{type:"button",variant:"ghost",size:"sm",className:"absolute right-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>c(!u),disabled:r,children:u?s.jsx(oe,{className:"h-4 w-4"}):s.jsx(ie,{className:"h-4 w-4"})})]}),g.currentPassword&&s.jsx("p",{className:"text-sm text-red-500",children:g.currentPassword})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(ce,{htmlFor:"newPassword",children:"كلمة المرور الجديدة"}),s.jsxs("div",{className:"relative",children:[s.jsx(ne,{id:"newPassword",type:f?"text":"password",value:v.newPassword,onChange:I("newPassword"),className:g.newPassword?"border-red-500":"",autoComplete:"new-password",disabled:r}),s.jsx(y,{type:"button",variant:"ghost",size:"sm",className:"absolute right-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>p(!f),disabled:r,children:f?s.jsx(oe,{className:"h-4 w-4"}):s.jsx(ie,{className:"h-4 w-4"})})]}),g.newPassword&&s.jsx("p",{className:"text-sm text-red-500",children:g.newPassword})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(ce,{htmlFor:"confirmPassword",children:"تأكيد كلمة المرور الجديدة"}),s.jsxs("div",{className:"relative",children:[s.jsx(ne,{id:"confirmPassword",type:k?"text":"password",value:v.confirmPassword,onChange:I("confirmPassword"),className:g.confirmPassword?"border-red-500":"",autoComplete:"new-password",disabled:r}),s.jsx(y,{type:"button",variant:"ghost",size:"sm",className:"absolute right-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>A(!k),disabled:r,children:k?s.jsx(oe,{className:"h-4 w-4"}):s.jsx(ie,{className:"h-4 w-4"})})]}),g.confirmPassword&&s.jsx("p",{className:"text-sm text-red-500",children:g.confirmPassword})]}),s.jsxs(Fe,{children:[s.jsx(y,{type:"button",variant:"outline",onClick:_,disabled:r,children:"إلغاء"}),s.jsxs(y,{type:"submit",disabled:r,children:[r&&s.jsx(Ct,{className:"mr-2 h-4 w-4 animate-spin"}),"تغيير كلمة المرور"]})]})]})]})}),s.jsx(Dt,{open:T&&L,onOpenChange:w=>{x(w),w||P(!1)},mode:"verify",title:"التحقق من الرقم السري الرئيسي",description:"لا يمكن تغيير كلمة المرور إلا بعد التحقق من الرقم السري الرئيسي",onSuccess:Y,onCancel:()=>{x(!1),P(!1)}})]})}const tt="cashy.google.accessToken",st="cashy.google.email",at="cashy.google.expiresAt";function rt(a,t,e){try{localStorage.setItem(tt,a),t&&localStorage.setItem(st,t);const o=e??Math.floor(Date.now()/1e3)+3500;localStorage.setItem(at,String(o))}catch{}}function D(){try{const a=localStorage.getItem(tt),t=localStorage.getItem(st),e=localStorage.getItem(at),o=e?Number(e):null;return{token:a,email:t,expiresAt:o}}catch{return{token:null,email:null,expiresAt:null}}}function nt(){const{token:a,expiresAt:t}=D();return a?t?Math.floor(Date.now()/1e3)<t-30:!0:!1}async function K(a){var t;try{const e=new Le;e.addScope("https://www.googleapis.com/auth/drive.file"),e.addScope("https://www.googleapis.com/auth/userinfo.email"),e.setCustomParameters({prompt:"consent",access_type:"offline",include_granted_scopes:"true"});const o=await ht(a,e),r=Le.credentialFromResult(o),n=(r==null?void 0:r.accessToken)||null,u=((t=o.user)==null?void 0:t.email)||void 0;return n?(rt(n,u),{ok:!0,email:u}):{ok:!1,error:"تعذر الحصول على توكن الوصول من جوجل"}}catch(e){return{ok:!1,error:(e==null?void 0:e.message)||"فشل تسجيل الدخول بجوجل"}}}function as(){return new Promise((a,t)=>{var o,r;if((r=(o=window.google)==null?void 0:o.accounts)!=null&&r.oauth2){a();return}const e=document.createElement("script");e.src="https://accounts.google.com/gsi/client",e.async=!0,e.onload=()=>a(),e.onerror=()=>t(new Error("فشل تحميل مكتبة Google Identity Services")),document.head.appendChild(e)})}async function V(a){var t;try{await as();const e=window.google;if(!((t=e==null?void 0:e.accounts)!=null&&t.oauth2))return{ok:!1,error:"مكتبة Google غير متاحة"};const o="https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.email",n=await new Promise((c,f)=>{const p=e.accounts.oauth2.initTokenClient({client_id:a,scope:o,callback:x=>{x!=null&&x.access_token?c(String(x.access_token)):f(new Error("تعذر الحصول على access token"))},prompt:"consent"});try{p.requestAccessToken({prompt:"consent"})}catch(x){f(x)}const A=setTimeout(()=>{f(new Error("انتهت المهلة أثناء طلب رمز الوصول من جوجل"))},12e3),T=x=>L=>{clearTimeout(A),x(L)};c=T(c),f=T(f)});let u;try{const f=await(await fetch("https://www.googleapis.com/oauth2/v3/userinfo",{headers:{Authorization:`Bearer ${n}`}})).json().catch(()=>({}));f!=null&&f.email&&(u=String(f.email))}catch{}return rt(n,u),{ok:!0,email:u}}catch(e){return{ok:!1,error:(e==null?void 0:e.message)||"فشل تسجيل الدخول بجوجل"}}}async function ue(a){try{return!!window.open("https://cashy.link/api/google/oauth2/start","cashy_google_oauth","width=600,height=650,menubar=no,toolbar=no")}catch{return!1}}async function fe(a,t=2e4,e=1500){const o=Date.now();for(;Date.now()-o<t;){const r=await rs(a);if(r&&r.refresh_token)return!0;await new Promise(n=>setTimeout(n,e))}return!1}async function rs(a){try{const t=new AbortController,e=setTimeout(()=>t.abort(),6e3),o=await fetch("https://cashy.link/api/google/oauth2/token",{method:"GET",headers:{"Content-Type":"application/json",...a?{"X-USER-ID":a}:{}},credentials:"include",signal:t.signal}).finally(()=>clearTimeout(e)),r=await o.json().catch(()=>({}));if(o.ok&&(r!=null&&r.ok)&&(r!=null&&r.refresh_token)&&(r!=null&&r.email))return{refresh_token:String(r.refresh_token),email:String(r.email)}}catch{}for(const t of["/api/google/oauth2/token","/user/google-backup-token"])try{const e=new AbortController,o=setTimeout(()=>e.abort(),5e3),r=await fetch(t,{method:"GET",headers:{"Content-Type":"application/json",...a?{"X-USER-ID":a}:{}},signal:e.signal}).finally(()=>clearTimeout(o)),n=await r.json().catch(()=>({}));if(r.ok&&(n!=null&&n.ok)&&(n!=null&&n.refresh_token)&&(n!=null&&n.email))return{refresh_token:String(n.refresh_token),email:String(n.email)}}catch{}return null}async function ot(a){const t={Authorization:`Bearer ${a}`},o=`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent("name='Cashy Backup' and mimeType='application/vnd.google-apps.folder' and trashed=false")}&fields=files(id,name)`,n=await(await fetch(o,{headers:t})).json().catch(()=>({})),u=Array.isArray(n==null?void 0:n.files)?n.files[0]:null;if(u!=null&&u.id)return String(u.id);const f=await(await fetch("https://www.googleapis.com/drive/v3/files",{method:"POST",headers:{...t,"Content-Type":"application/json"},body:JSON.stringify({name:"Cashy Backup",mimeType:"application/vnd.google-apps.folder"})})).json().catch(()=>({}));return f!=null&&f.id?String(f.id):null}async function ns(a,t){const e={Authorization:`Bearer ${a}`},r=`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(`'${t}' in parents and trashed=false`)}&orderBy=modifiedTime desc&fields=files(id,name,modifiedTime,createdTime)`,u=await(await fetch(r,{headers:e})).json().catch(()=>({})),c=Array.isArray(u==null?void 0:u.files)?u.files[0]:null;return c!=null&&c.id?{id:String(c.id),name:String(c.name)}:null}async function os(a,t,e,o){const r={name:e,parents:[t]},n="foo_bar_baz_"+Math.random().toString(16).slice(2),u=`\r
--${n}\r
`,c=`\r
--${n}--`,f=u+`Content-Type: application/json; charset=UTF-8\r
\r
`+JSON.stringify(r)+u+`Content-Type: application/json\r
\r
`+JSON.stringify(o)+c;return(await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart",{method:"POST",headers:{Authorization:`Bearer ${a}`,"Content-Type":`multipart/related; boundary=${n}`},body:f})).ok}async function is(a,t){const e=`https://www.googleapis.com/drive/v3/files/${t}?alt=media`,o=await fetch(e,{headers:{Authorization:`Bearer ${a}`}});if(!o.ok)return null;const r=await o.text();try{return JSON.parse(r)}catch{return null}}function me(){const a={};try{for(let t=0;t<localStorage.length;t++){const e=localStorage.key(t);if(!e)continue;const o=localStorage.getItem(e);a[e]=o}}catch{}return{platform:pt.getPlatform(),ts:new Date().toISOString(),localStorage:a}}function cs(a){try{const t=a==null?void 0:a.localStorage;if(t&&typeof t=="object"){for(const[e,o]of Object.entries(t))localStorage.setItem(String(e),String(o??""));return!0}}catch{}return!1}async function ls(a){if(!nt())return{ok:!1,error:"يرجى تسجيل الدخول بجوجل أولاً"};const t=D().token,e=await ot(t);if(!e)return{ok:!1,error:"فشل إنشاء/إيجاد مجلد التطبيق"};const o=await ms(a),r=`cashy-backup-${new Date().toISOString().replace(/[.:]/g,"-")}.json`;return await os(t,e,r,o)?{ok:!0}:{ok:!1,error:"فشل رفع الملف"}}async function ds(a){if(!nt())return{ok:!1,error:"يرجى تسجيل الدخول بجوجل أولاً"};const t=D().token,e=await ot(t);if(!e)return{ok:!1,error:"فشل إيجاد مجلد التطبيق"};const o=await ns(t,e);if(!(o!=null&&o.id))return{ok:!1,error:"لا توجد نسخة احتياطية"};const r=await is(t,o.id);if(!r)return{ok:!1,error:"فشل تنزيل النسخة"};const n=cs(r),u=await ps(a,r);return n&&u?{ok:!0}:{ok:!1,error:"فشل الاسترجاع"}}async function us(a,t,e){try{const o=await fetch("/user/google-backup-token",{method:"POST",headers:{"Content-Type":"application/json","X-USER-ID":a},body:JSON.stringify({email:t,refresh_token:e})}),r=await o.json().catch(()=>({}));return!!(o.ok&&(r!=null&&r.ok))}catch{return!1}}function fs(a){return a instanceof Date?a.toISOString():a}function G(a){if(a==null)return a;if(Array.isArray(a))return a.map(G);if(typeof a=="object"){const t={};for(const[e,o]of Object.entries(a))o instanceof Date?t[e]=fs(o):t[e]=G(o);return t}return a}async function ms(a){if(!a)return{version:2,ts:new Date().toISOString(),userId:null,local:me()};try{const[t,e,o,r]=await Promise.all([ae.getUserData(a),pe.getByMerchantId(a),ae.getUserTransactions(a),ge.getByUser(a,500)]);return{version:2,ts:new Date().toISOString(),userId:a,local:me(),firestore:{userData:G(t),wallets:G(e),userTransactions:G(o),dailyReportsArchive:G(r)}}}catch{return{version:2,ts:new Date().toISOString(),userId:a,local:me(),firestore:null,error:"تعذر جمع بعض بيانات Firestore"}}}function hs(a){if(typeof a=="string"){const t=new Date(a);if(!isNaN(t.getTime()))return t}return a}function z(a){if(a==null)return a;if(Array.isArray(a))return a.map(z);if(typeof a=="object"){const t={};for(const[e,o]of Object.entries(a))t[e]=o instanceof Date?o:hs(z(o));return t}return a}async function ps(a,t){try{if(!a)return!1;const e=t==null?void 0:t.firestore;if(!(e&&typeof e=="object"))return!0;if(e.userData){const r=z(e.userData);try{await ae.saveUserData(a,r)}catch{}}if(Array.isArray(e.wallets))try{const r=await pe.getByMerchantId(a),n=new Set(r.map(u=>`${u.provider}|${u.msisdn}`));for(const u of e.wallets){const c=z(u),f=`${c.provider}|${c.msisdn}`;n.has(f)||await pe.create({merchantUserId:a,provider:c.provider,msisdn:c.msisdn,label:c.label??void 0,isActive:c.isActive??!0,dailyLimit:Number(c.dailyLimit??0),monthlyLimit:Number(c.monthlyLimit??0),transferLimit:Number(c.transferLimit??2e5),withdrawLimit:Number(c.withdrawLimit??2e5),transferUsage:Number(c.transferUsage??0),withdrawUsage:Number(c.withdrawUsage??0),dailyTransferLimit:c.dailyTransferLimit??void 0,dailyWithdrawLimit:c.dailyWithdrawLimit??void 0,defaultTransferCommission:c.defaultTransferCommission??null,defaultWithdrawCommission:c.defaultWithdrawCommission??null})}}catch{}if(Array.isArray(e.userTransactions))try{for(const r of e.userTransactions){const n=z(r);await ae.saveUserTransaction(a,n)}}catch{}if(Array.isArray(e.dailyReportsArchive))try{const r=await ge.getByUser(a,1e3),n=new Set(r.map(u=>`${u.reportDate}|${u.walletId??"null"}`));for(const u of e.dailyReportsArchive){const c=z(u),f=`${c.reportDate}|${c.walletId??"null"}`;n.has(f)||await ge.add({userId:a,reportDate:String(c.reportDate),totalTransactions:Number(c.totalTransactions||0),totalAmount:Number(c.totalAmount||0),totalWithdrawn:Number(c.totalWithdrawn||0),totalSent:Number(c.totalSent||0),profit:c.profit!==void 0?Number(c.profit):void 0,walletId:c.walletId??null})}}catch{}return!0}catch{return!1}}function Ds({className:a}){const{user:t,profile:e,signOut:o,updateUserProfile:r}=Se(),n=gt(),[u,c]=l.useState(!1),{isShiftActive:f}=wt(),{toast:p}=Me(),[k,A]=l.useState(!1),[T,x]=l.useState(!1),[L,P]=l.useState(!1),[{token:v},S]=l.useState(()=>D()),g=typeof window<"u"?window.electronAPI:void 0,N=!!g,[X,M]=l.useState(!1),[Y,I]=l.useState(!1),[_,w]=l.useState(""),[j,C]=l.useState("");l.useEffect(()=>{if(!(!N||!g))try{g.onUpdateAvailable(m=>{var i,d;M(!0),w(String(((i=m==null?void 0:m.info)==null?void 0:i.version)||"")),C(String(((d=m==null?void 0:m.info)==null?void 0:d.notes)||""))}),g.onUpdateDownloaded(m=>{var i,d;M(!0),w(String(((i=m==null?void 0:m.info)==null?void 0:i.version)||"")),C(String(((d=m==null?void 0:m.info)==null?void 0:d.notes)||""))}),g.checkUpdate()}catch{}},[N,g]);const R=async()=>{try{g&&await g.downloadAndInstallUpdate()}catch{}},B=()=>e!=null&&e.fullName?e==null?void 0:e.fullName.split(" ").map(m=>m.charAt(0)).join("").toUpperCase().slice(0,2):t.email?t.email.charAt(0).toUpperCase():"U",F=e!=null&&e.avatarId?Tt(e.avatarId):null;if(l.useEffect(()=>{console.log("Profile updated in ProfileIcon:",e==null?void 0:e.avatarId)},[e==null?void 0:e.avatarId]),l.useEffect(()=>{const m=async i=>{try{if(!(i!=null&&i.data)||typeof i.data!="object"||i.origin!=="https://cashy.link")return;const{type:d,email:h,refresh_token:b}=i.data||{};d==="cashy_oauth_token"&&(t!=null&&t.uid)&&h&&b&&await us(t.uid,String(h),String(b))&&p({title:"تم ربط جوجل",description:"تم حفظ توكن النسخ الاحتياطي عبر الخادم."})}catch{}};return window.addEventListener("message",m),()=>window.removeEventListener("message",m)},[t==null?void 0:t.uid]),!t)return null;const W=async()=>{try{await o(),n("/user/login",{replace:!0})}catch(m){console.error("خطأ في تسجيل الخروج:",m);try{n("/user/login",{replace:!0})}catch{}}},Z=async()=>{if(t!=null&&t.uid)try{if(A(!0),!v)if(await ue()){if(!await fe(t.uid,2e4,1500)){const h=await V("483702062341-bhdprmoot8rto79jmjvkijdl7pbz28b.apps.googleusercontent.com");if(!h.ok){const b=await K(J);if(!b.ok){p({title:"فشل تسجيل الدخول",description:b.error||h.error||"يرجى التسجيل بجوجل أولاً.",variant:"destructive"});return}}S(D())}}else{const d=await V("483702062341-bhdprmoot8rto79jmjvkijdl7pbz28b.apps.googleusercontent.com");if(!d.ok){const h=await K(J);if(!h.ok){p({title:"فشل تسجيل الدخول",description:h.error||d.error||"يرجى التسجيل بجوجل أولاً.",variant:"destructive"});return}}S(D())}const m=await ls(t.uid);m.ok?p({title:"تم النسخ الاحتياطي",description:"تم حفظ بياناتك إلى Google Drive بنجاح."}):p({title:"فشل النسخ الاحتياطي",description:m.error||"حدث خطأ أثناء النسخ الاحتياطي.",variant:"destructive"})}catch{p({title:"خطأ غير متوقع",description:"تعذر إكمال النسخ الاحتياطي.",variant:"destructive"})}finally{A(!1)}},ee=async()=>{if(t!=null&&t.uid)try{if(x(!0),!v)if(await ue()){if(!await fe(t.uid,2e4,1500)){const h=await V("483702062341-bhdprmoot8rto79jmjvkijdl7pbz28b.apps.googleusercontent.com");if(!h.ok){const b=await K(J);if(!b.ok){p({title:"فشل تسجيل الدخول",description:b.error||h.error||"يرجى التسجيل بجوجل أولاً.",variant:"destructive"});return}}S(D())}}else{const d=await V("483702062341-bhdprmoot8rto79jmjvkijdl7pbz28b.apps.googleusercontent.com");if(!d.ok){const h=await K(J);if(!h.ok){p({title:"فشل تسجيل الدخول",description:h.error||d.error||"يرجى التسجيل بجوجل أولاً.",variant:"destructive"});return}}S(D())}const m=await ds(t.uid);m.ok?p({title:"تم الاسترجاع",description:"تم استرجاع بياناتك بنجاح من Google Drive."}):p({title:"فشل الاسترجاع",description:m.error||"حدث خطأ أثناء الاسترجاع.",variant:"destructive"})}catch{p({title:"خطأ غير متوقع",description:"تعذر إكمال الاسترجاع.",variant:"destructive"})}finally{x(!1)}},re=async()=>{try{P(!0);const m=await ue();let i=!1;if(m&&(t!=null&&t.uid)&&(i=await fe(t.uid,2e4,1500)),i){p({title:"تم ربط جوجل",description:"تم تفعيل النسخ الاحتياطي عبر الخادم"});return}const d=await V("483702062341-bhdprmoot8rto79jmjvkijdl7pbz28b.apps.googleusercontent.com");if(d.ok){const h=D();S(h),p({title:"تم ربط جوجل",description:"تم تفعيل النسخ الاحتياطي على Google Drive"})}else{const h=await K(J);if(h.ok){const b=D();S(b),p({title:"تم ربط جوجل",description:"تم تفعيل النسخ الاحتياطي على Google Drive"})}else p({title:"فشل ربط جوجل",description:h.error||d.error||"حدث خطأ أثناء تسجيل الدخول بجوجل.",variant:"destructive"})}}catch{p({title:"خطأ غير متوقع",description:"تعذر إكمال تسجيل الدخول بجوجل.",variant:"destructive"})}finally{P(!1)}};return s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs(we,{children:[s.jsx(xe,{asChild:!0,children:s.jsx(y,{variant:"ghost",size:"icon",disabled:f,title:f?"غير متاح أثناء وجود وردية كاشير نشطة":"نسخ احتياطي على Google Drive",className:"h-8 w-8 rounded-full p-0 hover:bg-transparent focus:ring-1 focus:ring-primary focus:ring-offset-1 transition-all duration-200 disabled:opacity-60 disabled:cursor-not-allowed",children:s.jsx(Bt,{className:"h-4 w-4"})})}),s.jsxs(ve,{className:"w-72",align:"end",forceMount:!0,children:[s.jsx(ye,{className:"font-normal",children:s.jsxs("div",{className:"flex flex-col space-y-1",children:[s.jsx("p",{className:"text-sm font-medium leading-none",children:"نسخ احتياطي على Google Drive"}),!v&&s.jsx("p",{className:"text-xs leading-none text-muted-foreground",children:"لا يوجد ربط بحساب جوجل، يرجى تسجيل الدخول أولاً."})]})}),s.jsx(Q,{}),s.jsxs(U,{onClick:re,className:"cursor-pointer",disabled:L,children:[s.jsx(Ft,{className:"mr-2 h-4 w-4"}),s.jsx("span",{children:"تسجيل الدخول بجوجل للنسخ الاحتياطي"})]}),s.jsxs(U,{onClick:Z,className:"cursor-pointer",disabled:k,children:[s.jsx(Mt,{className:"mr-2 h-4 w-4"}),s.jsx("span",{children:"عمل نسخة احتياطية"})]}),s.jsxs(U,{onClick:ee,className:"cursor-pointer",disabled:T,children:[s.jsx(Et,{className:"mr-2 h-4 w-4"}),s.jsx("span",{children:"استرجاع البيانات"})]})]})]}),N&&s.jsxs(y,{type:"button",onClick:()=>I(!0),title:"تحديث التطبيق",className:"relative inline-flex items-center justify-center w-9 h-9 rounded-md bg-transparent text-blue-600 hover:bg-blue-500/10 focus:outline-none dark:text-blue-400 dark:hover:bg-blue-400/10",variant:"ghost",children:[s.jsx(Ut,{className:"w-5 h-5"}),X&&s.jsx("span",{className:"absolute -top-0.5 -right-0.5 inline-block w-2 h-2 rounded-full bg-red-500"})]}),s.jsxs(we,{children:[s.jsx(xe,{asChild:!0,children:s.jsx(y,{variant:"ghost",disabled:f,title:f?"غير متاح أثناء وجود وردية كاشير نشطة":void 0,className:`relative h-8 w-8 rounded-full p-0 hover:bg-transparent focus:ring-1 focus:ring-primary focus:ring-offset-1 transition-all duration-200 disabled:opacity-60 disabled:cursor-not-allowed ${a}`,children:s.jsx(Ye,{className:"h-8 w-8 border border-border shadow-sm hover:shadow-md transition-all duration-200 hover:scale-105 bg-white",children:F?s.jsx("div",{className:"w-full h-full flex items-center justify-center bg-white dark:bg-neutral-900/20 rounded-full overflow-hidden",children:s.jsx("div",{className:"w-full h-full flex items-center justify-center scale-[2.5]",children:F.component})}):s.jsxs(s.Fragment,{children:[s.jsx(Ze,{src:t.photoURL||void 0,alt:(e==null?void 0:e.fullName)||t.email||"المستخدم",className:"object-cover"}),s.jsx(et,{className:"bg-white text-gray-900 font-semibold text-lg border-0",children:B()})]})})})}),s.jsxs(ve,{className:"w-64",align:"end",forceMount:!0,children:[s.jsx(ye,{className:"font-normal",children:s.jsxs("div",{className:"flex flex-col space-y-1",children:[s.jsx("p",{className:"text-sm font-medium leading-none",children:(e==null?void 0:e.fullName)||"المستخدم"}),s.jsx("p",{className:"text-xs leading-none text-muted-foreground",children:t.email}),(e==null?void 0:e.role)&&s.jsxs("p",{className:"text-xs leading-none text-muted-foreground",children:["الدور: ",e.role==="staff"?"مدير":e.role==="merchant"?"تاجر":"مستخدم"]})]})}),s.jsx(Q,{}),s.jsxs(U,{onClick:async()=>{try{await r({showWithdrawNote:!((e==null?void 0:e.showWithdrawNote)??!0)})}catch{}},className:"cursor-pointer",children:[s.jsx(xt,{className:"mr-2 h-4 w-4"}),s.jsx("span",{children:(e==null?void 0:e.showWithdrawNote)??!0?"إخفاء خانة ملاحظة السحب":"إظهار خانة ملاحظة السحب"})]}),s.jsx(Q,{}),s.jsxs(U,{onClick:()=>n("/profile-settings"),className:"cursor-pointer",children:[s.jsx(vt,{className:"mr-2 h-4 w-4"}),s.jsx("span",{children:"إعدادات البروفيل"})]}),((e==null?void 0:e.role)==="admin"||(e==null?void 0:e.role)==="staff")&&s.jsxs(U,{onClick:()=>n("/admin"),className:"cursor-pointer",children:[s.jsx(Lt,{className:"mr-2 h-4 w-4"}),s.jsx("span",{children:"لوحة الإدارة"})]}),s.jsx(Q,{}),s.jsxs(U,{onClick:W,className:"cursor-pointer text-red-600 focus:text-red-600",children:[s.jsx(yt,{className:"mr-2 h-4 w-4"}),s.jsx("span",{children:"تسجيل الخروج"})]})]})]})]}),N&&s.jsx(be,{open:Y,onOpenChange:I,children:s.jsxs(Ne,{className:"sm:max-w-md",children:[s.jsx(Ae,{children:s.jsx(Pe,{children:"يوجد تحديث جديد للبرنامج"})}),s.jsx("div",{className:"text-sm",children:"هل ترغب في تنزيله الآن؟"}),_&&s.jsxs("div",{className:"mt-2 text-xs",children:["الإصدار الجديد: ",s.jsxs("span",{className:"font-semibold",children:["v",_]})]}),j&&s.jsx("div",{className:"mt-2 text-xs text-muted-foreground whitespace-pre-line",children:j}),s.jsxs("div",{className:"flex items-center justify-end gap-2 mt-3",children:[s.jsx(y,{variant:"outline",onClick:()=>I(!1),children:"إلغاء"}),s.jsx(y,{className:"bg-blue-600 hover:bg-blue-700",onClick:R,children:"تنزيل وتحديث"})]})]})}),s.jsx(ss,{open:u,onOpenChange:c})]})}function gs(a){return a?`readBroadcastIds_${a}`:"readBroadcastIds_guest"}function Ts({className:a}){const{user:t,profile:e,isSubscriptionActive:o}=Se(),r=jt(),[n,u]=l.useState([]),[c,f]=l.useState(new Set),[p,k]=l.useState(!1),[A,T]=l.useState(""),[x,L]=l.useState(!1),[P,v]=l.useState(null),[S,g]=l.useState("none"),[N,X]=l.useState(null),[M,Y]=l.useState(!1);l.useRef(new Set),l.useRef(!1);const I=l.useRef(null),_=l.useRef(null);l.useRef(null);const[w,j]=l.useState({position:"fixed",top:0,left:0,zIndex:1e4}),C=!1,R=l.useMemo(()=>{const i=["global"];return t!=null&&t.uid&&i.push(`user:${t.uid}`),e!=null&&e.shopId&&i.push(`shop:${e.shopId}`),i},[t==null?void 0:t.uid,e==null?void 0:e.shopId]),B=gs(t==null?void 0:t.uid),F=l.useMemo(()=>{var h;const i=(h=r==null?void 0:r.pathname)==null?void 0:h.includes("/user/pending-approval");return!!(t!=null&&t.uid)&&!i},[t==null?void 0:t.uid,r==null?void 0:r.pathname]);l.useEffect(()=>{try{const i=localStorage.getItem(B);if(i){const d=JSON.parse(i);Array.isArray(d)&&f(new Set(d.filter(Boolean)))}else f(new Set)}catch(i){console.warn("Failed to load read ids",i),f(new Set)}},[B]),l.useEffect(()=>{if(!F){u([]);return}const i=Rt(R,d=>{u(d)});return()=>i()},[R,F]),l.useEffect(()=>{},[n]),l.useEffect(()=>()=>{I.current&&clearTimeout(I.current)},[]);const W=n.reduce((i,d)=>i+(d.id&&!c.has(d.id)?1:0),0),Z=i=>{if(!i||c.has(i))return;const d=new Set(c);d.add(i),f(d);try{localStorage.setItem(B,JSON.stringify(Array.from(d)))}catch{}},ee=()=>{const i=n.map(h=>h.id).filter(Boolean),d=new Set(c);i.forEach(h=>d.add(h)),f(d);try{localStorage.setItem(B,JSON.stringify(Array.from(d)))}catch{}},re=(i,d)=>{i&&window.open(i,"_blank"),d&&Z(d)};l.useEffect(()=>{},[M]);const m=async()=>{if(!(t!=null&&t.uid)){alert("يرجى تسجيل الدخول لإرسال الطلب.");return}const i=A.trim();if(!i){alert("يرجى كتابة سبب طلب التحدث.");return}try{L(!0),v(null);const d=e!=null&&e.fullName&&e.fullName.trim()?e.fullName.trim():t.email?t.email.split("@")[0]:"مستخدم",h=(e==null?void 0:e.phone)||null;await At(Re(_e,"waiting_list"),{userId:t.uid,name:d,phone:h,reason:i,status:"pending",createdAt:Pt()}),v("تم إرسال طلبك إلى قائمة الانتظار بنجاح ✅"),T(""),setTimeout(()=>k(!1),900)}catch(d){console.error("فشل إرسال طلب قائمة الانتظار:",d),alert("حدث خطأ أثناء إرسال الطلب. حاول مرة أخرى.")}finally{L(!1)}};return l.useEffect(()=>{if(!(t!=null&&t.uid)){g("none");return}let i=null;try{const d=kt(Re(_e,"waiting_list"),St("userId","==",t.uid));i=bt(d,h=>{const b=h.docs.map(E=>({id:E.id,...E.data()})).sort((E,$)=>{var te,Ie,De,se,Te,Ee;const ct=((Ie=(te=E==null?void 0:E.createdAt)==null?void 0:te.toMillis)==null?void 0:Ie.call(te))??((De=E==null?void 0:E.createdAt)==null?void 0:De.seconds)*1e3??0;return(((Te=(se=$==null?void 0:$.createdAt)==null?void 0:se.toMillis)==null?void 0:Te.call(se))??((Ee=$==null?void 0:$.createdAt)==null?void 0:Ee.seconds)*1e3??0)-ct});if(b.length===0){g("none");return}const O=b[0],it=(O==null?void 0:O.contacted)===!0||(O==null?void 0:O.status)==="contacted";g(it?"contacted":"pending")})}catch(d){console.warn("⚠️ فشل الاشتراك في waiting_list للمستخدم:",d),g("none")}return()=>{i&&i()}},[t==null?void 0:t.uid]),F?s.jsxs("div",{className:`relative inline-flex items-center gap-2 ${a||""}`,ref:_,children:[s.jsxs(we,{onOpenChange:i=>{i&&W>0&&ee()},children:[s.jsx(xe,{asChild:!0,children:s.jsx(y,{variant:"ghost",className:"relative h-8 w-8 rounded-full p-0 hover:bg-transparent focus:ring-1 focus:ring-primary focus:ring-offset-1 transition-all",title:"الإشعارات",children:s.jsxs("div",{className:"relative h-8 w-8 rounded-full bg-primary/10 flex items-center justify-center border border-border shadow-sm hover:shadow-md",children:[s.jsx(Oe,{className:"h-4 w-4 text-primary"}),W>0&&s.jsx("span",{className:"absolute -top-1 -right-1 min-w-[18px] h-[18px] px-1 rounded-full bg-red-500 text-white text-[10px] font-bold flex items-center justify-center shadow",children:W})]})})}),s.jsxs(ve,{className:"w-80",align:"end",forceMount:!0,children:[s.jsxs(ye,{className:"flex items-center justify-between",children:[s.jsx("span",{children:"الإشعارات"}),n.length>0&&s.jsxs(y,{variant:"outline",size:"sm",className:"h-7 text-xs",onClick:ee,children:[s.jsx(le,{className:"h-3 w-3 mr-1"}),"تمييز الكل كمقروء"]})]}),s.jsx(Q,{}),n.length===0?s.jsx("div",{className:"p-3 text-sm text-muted-foreground",children:"لا توجد إشعارات حالياً"}):s.jsx("div",{className:"max-h-64 overflow-y-auto pr-1",children:n.map(i=>{const d=i.id?!c.has(i.id):!1;return s.jsx("div",{className:`px-2 py-2 rounded-md ${d?"bg-primary/5":""}`,children:s.jsxs("div",{className:"flex items-start gap-2",children:[s.jsx(Oe,{className:`h-4 w-4 ${d?"text-primary":"text-muted-foreground"}`}),s.jsxs("div",{className:"flex-1",children:[s.jsx("div",{className:"text-sm font-medium",children:i.title||"إشعار"}),s.jsx("div",{className:"text-xs text-muted-foreground whitespace-pre-line",children:i.message}),i.linkUrl&&s.jsxs(y,{variant:"link",className:"px-0 h-6 text-xs",onClick:()=>re(i.linkUrl,i.id),children:["فتح الرابط ",s.jsx(_t,{className:"h-3 w-3 ml-1"})]})]}),d?s.jsx(y,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>Z(i.id),title:"تمييز كمقروء",children:s.jsx(le,{className:"h-4 w-4 text-primary"})}):s.jsx(y,{variant:"ghost",size:"icon",className:"h-6 w-6",disabled:!0,title:"مقروء",children:s.jsx(le,{className:"h-4 w-4 text-muted-foreground"})})]})},i.id)})})]})]}),s.jsxs(be,{open:p,onOpenChange:k,children:[s.jsx(It,{asChild:!0,children:s.jsx(y,{variant:"ghost",size:"icon",className:"h-8 w-8 rounded-full hover:bg-transparent focus:ring-1 focus:ring-primary/60 focus:ring-offset-1",title:"قائمة الانتظار",children:s.jsx(Nt,{className:`h-4 w-4 ${S==="pending"?"text-red-600":S==="contacted"?"text-green-600":"text-muted-foreground"}`})})}),s.jsxs(Ne,{className:"max-w-md border border-purple-200/50 shadow-xl bg-gradient-to-br from-purple-50 to-blue-50",children:[s.jsxs(Ae,{children:[s.jsx(Pe,{children:"طلب التحدث"}),s.jsx(Be,{children:"يرجى كتابة سبب طلب التحدث ليصل للإدارة في قسم قائمة الانتظار."})]}),s.jsxs("div",{className:"grid gap-3",children:[s.jsx("label",{className:"text-sm font-medium text-gray-700",children:"سبب الطلب"}),s.jsx(Ot,{value:A,onChange:i=>T(i.target.value),placeholder:"اكتب سبب طلب التحدث هنا...",className:"min-h-[120px] text-right"}),P&&s.jsx("div",{className:"text-sm text-green-700 bg-green-50 border border-green-200 rounded-md p-2",children:P})]}),s.jsxs(Fe,{children:[s.jsx(y,{variant:"outline",onClick:()=>k(!1),disabled:x,children:"إلغاء"}),s.jsx(y,{onClick:m,disabled:x,className:"bg-gradient-to-r from-green-600 to-emerald-600 text-white",children:x?"جارٍ الإرسال...":"إرسال"})]})]})]}),C]}):null}export{Is as A,Ts as N,Ds as P};
